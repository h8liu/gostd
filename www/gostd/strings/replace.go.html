<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>strings</h2>
<ul>
<li><a href="/gostd/strings/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/strings/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/strings/reader.go.html">reader.go</a></li>
<li><a href="/gostd/strings/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/strings/replace.go.html" class="current">replace.go</a></li>
<li><a href="/gostd/strings/replace_test.go.html">replace_test.go</a></li>
<li><a href="/gostd/strings/search.go.html">search.go</a></li>
<li><a href="/gostd/strings/search_test.go.html">search_test.go</a></li>
<li><a href="/gostd/strings/strings.go.html">strings.go</a></li>
<li><a href="/gostd/strings/strings_decl.go.html">strings_decl.go</a></li>
<li><a href="/gostd/strings/strings_test.go.html">strings_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2333870">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2333925">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2333979">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2334030">package</span>&nbsp;<span class="ident" id="2334038">strings</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2334047">import</span>&nbsp;<span class="string" id="2334054">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2334060">//&nbsp;Replacer&nbsp;replaces&nbsp;a&nbsp;list&nbsp;of&nbsp;strings&nbsp;with&nbsp;replacements.</span><br>
<span class="lineno">10</span><span class="comment" id="2334118">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="2334175">type</span>&nbsp;<span class="ident" id="2334180">Replacer</span>&nbsp;<span class="keyword" id="2334189">struct</span>&nbsp;<span class="op" id="2334196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2334199">r</span>&nbsp;<span class="ident" id="2334201">replacer</span><br>
<span class="lineno"></span><span class="op" id="2334210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="2334213">//&nbsp;replacer&nbsp;is&nbsp;the&nbsp;interface&nbsp;that&nbsp;a&nbsp;replacement&nbsp;algorithm&nbsp;needs&nbsp;to&nbsp;implement.</span><br>
<span class="lineno"></span><span class="keyword" id="2334291">type</span>&nbsp;<span class="ident" id="2334296">replacer</span>&nbsp;<span class="keyword" id="2334305">interface</span>&nbsp;<span class="op" id="2334315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2334318">Replace</span><span class="op" id="2334325">(</span><span class="ident" id="2334326">s</span>&nbsp;<span class="builtintype" id="2334328">string</span><span class="op" id="2334334">)</span>&nbsp;<span class="builtintype" id="2334336">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2334344">WriteString</span><span class="op" id="2334355">(</span><span class="ident" id="2334356">w</span>&nbsp;<span class="ident" id="2334358">io</span><span class="op" id="2334360">.</span><span class="ident" id="2334361">Writer</span><span class="op" id="2334367">,</span>&nbsp;<span class="ident" id="2334369">s</span>&nbsp;<span class="builtintype" id="2334371">string</span><span class="op" id="2334377">)</span>&nbsp;<span class="op" id="2334379">(</span><span class="ident" id="2334380">n</span>&nbsp;<span class="builtintype" id="2334382">int</span><span class="op" id="2334385">,</span>&nbsp;<span class="ident" id="2334387">err</span>&nbsp;<span class="builtintype" id="2334391">error</span><span class="op" id="2334396">)</span><br>
<span class="lineno"></span><span class="op" id="2334398">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="2334401">//&nbsp;NewReplacer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Replacer&nbsp;from&nbsp;a&nbsp;list&nbsp;of&nbsp;old,&nbsp;new&nbsp;string&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="comment" id="2334477">//&nbsp;Replacements&nbsp;are&nbsp;performed&nbsp;in&nbsp;order,&nbsp;without&nbsp;overlapping&nbsp;matches.</span><br>
<span class="lineno"></span><span class="keyword" id="2334546">func</span>&nbsp;<span class="ident" id="2334551">NewReplacer</span><span class="op" id="2334562">(</span><span class="ident" id="2334563">oldnew</span>&nbsp;<span class="op" id="2334570">...</span><span class="builtintype" id="2334573">string</span><span class="op" id="2334579">)</span>&nbsp;<span class="op" id="2334581">*</span><span class="ident" id="2334582">Replacer</span>&nbsp;<span class="op" id="2334591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2334594">if</span>&nbsp;<span class="builtinfunc" id="2334597">len</span><span class="op" id="2334600">(</span><span class="ident" id="2334601">oldnew</span><span class="op" id="2334607">)</span><span class="op" id="2334608">%</span><span class="num" id="2334609">2</span>&nbsp;<span class="op" id="2334611">==</span>&nbsp;<span class="num" id="2334614">1</span>&nbsp;<span class="op" id="2334616">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2334620">panic</span><span class="op" id="2334625">(</span><span class="string" id="2334626">&#34;strings.NewReplacer:&nbsp;odd&nbsp;argument&nbsp;count&#34;</span><span class="op" id="2334667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2334670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2334674">if</span>&nbsp;<span class="builtinfunc" id="2334677">len</span><span class="op" id="2334680">(</span><span class="ident" id="2334681">oldnew</span><span class="op" id="2334687">)</span>&nbsp;<span class="op" id="2334689">==</span>&nbsp;<span class="num" id="2334692">2</span>&nbsp;<span class="op" id="2334694">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2334697">len</span><span class="op" id="2334700">(</span><span class="ident" id="2334701">oldnew</span><span class="op" id="2334707">[</span><span class="num" id="2334708">0</span><span class="op" id="2334709">]</span><span class="op" id="2334710">)</span>&nbsp;<span class="op" id="2334712">&gt;</span>&nbsp;<span class="num" id="2334714">1</span>&nbsp;<span class="op" id="2334716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2334720">return</span>&nbsp;<span class="op" id="2334727">&amp;</span><span class="ident" id="2334728">Replacer</span><span class="op" id="2334736">{</span><span class="ident" id="2334737">r</span><span class="op" id="2334738">:</span>&nbsp;<span class="ident" id="2334740">makeSingleStringReplacer</span><span class="op" id="2334764">(</span><span class="ident" id="2334765">oldnew</span><span class="op" id="2334771">[</span><span class="num" id="2334772">0</span><span class="op" id="2334773">]</span><span class="op" id="2334774">,</span>&nbsp;<span class="ident" id="2334776">oldnew</span><span class="op" id="2334782">[</span><span class="num" id="2334783">1</span><span class="op" id="2334784">]</span><span class="op" id="2334785">)</span><span class="op" id="2334786">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2334789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2334793">allNewBytes</span>&nbsp;<span class="op" id="2334805">:=</span>&nbsp;<span class="builtintype" id="2334808">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2334814">for</span>&nbsp;<span class="ident" id="2334818">i</span>&nbsp;<span class="op" id="2334820">:=</span>&nbsp;<span class="num" id="2334823">0</span><span class="op" id="2334824">;</span>&nbsp;<span class="ident" id="2334826">i</span>&nbsp;<span class="op" id="2334828">&lt;</span>&nbsp;<span class="builtinfunc" id="2334830">len</span><span class="op" id="2334833">(</span><span class="ident" id="2334834">oldnew</span><span class="op" id="2334840">)</span><span class="op" id="2334841">;</span>&nbsp;<span class="ident" id="2334843">i</span>&nbsp;<span class="op" id="2334845">+=</span>&nbsp;<span class="num" id="2334848">2</span>&nbsp;<span class="op" id="2334850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2334854">if</span>&nbsp;<span class="builtinfunc" id="2334857">len</span><span class="op" id="2334860">(</span><span class="ident" id="2334861">oldnew</span><span class="op" id="2334867">[</span><span class="ident" id="2334868">i</span><span class="op" id="2334869">]</span><span class="op" id="2334870">)</span>&nbsp;<span class="op" id="2334872">!=</span>&nbsp;<span class="num" id="2334875">1</span>&nbsp;<span class="op" id="2334877">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2334882">return</span>&nbsp;<span class="op" id="2334889">&amp;</span><span class="ident" id="2334890">Replacer</span><span class="op" id="2334898">{</span><span class="ident" id="2334899">r</span><span class="op" id="2334900">:</span>&nbsp;<span class="ident" id="2334902">makeGenericReplacer</span><span class="op" id="2334921">(</span><span class="ident" id="2334922">oldnew</span><span class="op" id="2334928">)</span><span class="op" id="2334929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2334933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2334937">if</span>&nbsp;<span class="builtinfunc" id="2334940">len</span><span class="op" id="2334943">(</span><span class="ident" id="2334944">oldnew</span><span class="op" id="2334950">[</span><span class="ident" id="2334951">i</span><span class="op" id="2334952">+</span><span class="num" id="2334953">1</span><span class="op" id="2334954">]</span><span class="op" id="2334955">)</span>&nbsp;<span class="op" id="2334957">!=</span>&nbsp;<span class="num" id="2334960">1</span>&nbsp;<span class="op" id="2334962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2334967">allNewBytes</span>&nbsp;<span class="op" id="2334979">=</span>&nbsp;<span class="builtintype" id="2334981">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2334989">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2334992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2334996">if</span>&nbsp;<span class="ident" id="2334999">allNewBytes</span>&nbsp;<span class="op" id="2335011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2335015">r</span>&nbsp;<span class="op" id="2335017">:=</span>&nbsp;<span class="ident" id="2335020">byteReplacer</span><span class="op" id="2335032">{</span><span class="op" id="2335033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2335037">for</span>&nbsp;<span class="ident" id="2335041">i</span>&nbsp;<span class="op" id="2335043">:=</span>&nbsp;<span class="keyword" id="2335046">range</span>&nbsp;<span class="ident" id="2335052">r</span>&nbsp;<span class="op" id="2335054">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2335059">r</span><span class="op" id="2335060">[</span><span class="ident" id="2335061">i</span><span class="op" id="2335062">]</span>&nbsp;<span class="op" id="2335064">=</span>&nbsp;<span class="builtintype" id="2335066">byte</span><span class="op" id="2335070">(</span><span class="ident" id="2335071">i</span><span class="op" id="2335072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2335076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2335080">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2335139">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2335186">for</span>&nbsp;<span class="ident" id="2335190">i</span>&nbsp;<span class="op" id="2335192">:=</span>&nbsp;<span class="builtinfunc" id="2335195">len</span><span class="op" id="2335198">(</span><span class="ident" id="2335199">oldnew</span><span class="op" id="2335205">)</span>&nbsp;<span class="op" id="2335207">-</span>&nbsp;<span class="num" id="2335209">2</span><span class="op" id="2335210">;</span>&nbsp;<span class="ident" id="2335212">i</span>&nbsp;<span class="op" id="2335214">&gt;=</span>&nbsp;<span class="num" id="2335217">0</span><span class="op" id="2335218">;</span>&nbsp;<span class="ident" id="2335220">i</span>&nbsp;<span class="op" id="2335222">-=</span>&nbsp;<span class="num" id="2335225">2</span>&nbsp;<span class="op" id="2335227">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2335232">o</span>&nbsp;<span class="op" id="2335234">:=</span>&nbsp;<span class="ident" id="2335237">oldnew</span><span class="op" id="2335243">[</span><span class="ident" id="2335244">i</span><span class="op" id="2335245">]</span><span class="op" id="2335246">[</span><span class="num" id="2335247">0</span><span class="op" id="2335248">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2335253">n</span>&nbsp;<span class="op" id="2335255">:=</span>&nbsp;<span class="ident" id="2335258">oldnew</span><span class="op" id="2335264">[</span><span class="ident" id="2335265">i</span><span class="op" id="2335266">+</span><span class="num" id="2335267">1</span><span class="op" id="2335268">]</span><span class="op" id="2335269">[</span><span class="num" id="2335270">0</span><span class="op" id="2335271">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2335276">r</span><span class="op" id="2335277">[</span><span class="ident" id="2335278">o</span><span class="op" id="2335279">]</span>&nbsp;<span class="op" id="2335281">=</span>&nbsp;<span class="ident" id="2335283">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2335287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2335291">return</span>&nbsp;<span class="op" id="2335298">&amp;</span><span class="ident" id="2335299">Replacer</span><span class="op" id="2335307">{</span><span class="ident" id="2335308">r</span><span class="op" id="2335309">:</span>&nbsp;<span class="op" id="2335311">&amp;</span><span class="ident" id="2335312">r</span><span class="op" id="2335313">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2335316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2335320">r</span>&nbsp;<span class="op" id="2335322">:=</span>&nbsp;<span class="ident" id="2335325">byteStringReplacer</span><span class="op" id="2335343">{</span><span class="op" id="2335344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2335347">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2335405">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2335451">for</span>&nbsp;<span class="ident" id="2335455">i</span>&nbsp;<span class="op" id="2335457">:=</span>&nbsp;<span class="builtinfunc" id="2335460">len</span><span class="op" id="2335463">(</span><span class="ident" id="2335464">oldnew</span><span class="op" id="2335470">)</span>&nbsp;<span class="op" id="2335472">-</span>&nbsp;<span class="num" id="2335474">2</span><span class="op" id="2335475">;</span>&nbsp;<span class="ident" id="2335477">i</span>&nbsp;<span class="op" id="2335479">&gt;=</span>&nbsp;<span class="num" id="2335482">0</span><span class="op" id="2335483">;</span>&nbsp;<span class="ident" id="2335485">i</span>&nbsp;<span class="op" id="2335487">-=</span>&nbsp;<span class="num" id="2335490">2</span>&nbsp;<span class="op" id="2335492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2335496">o</span>&nbsp;<span class="op" id="2335498">:=</span>&nbsp;<span class="ident" id="2335501">oldnew</span><span class="op" id="2335507">[</span><span class="ident" id="2335508">i</span><span class="op" id="2335509">]</span><span class="op" id="2335510">[</span><span class="num" id="2335511">0</span><span class="op" id="2335512">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2335516">n</span>&nbsp;<span class="op" id="2335518">:=</span>&nbsp;<span class="ident" id="2335521">oldnew</span><span class="op" id="2335527">[</span><span class="ident" id="2335528">i</span><span class="op" id="2335529">+</span><span class="num" id="2335530">1</span><span class="op" id="2335531">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2335535">r</span><span class="op" id="2335536">[</span><span class="ident" id="2335537">o</span><span class="op" id="2335538">]</span>&nbsp;<span class="op" id="2335540">=</span>&nbsp;<span class="op" id="2335542">[</span><span class="op" id="2335543">]</span><span class="builtintype" id="2335544">byte</span><span class="op" id="2335548">(</span><span class="ident" id="2335549">n</span><span class="op" id="2335550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2335553">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2335556">return</span>&nbsp;<span class="op" id="2335563">&amp;</span><span class="ident" id="2335564">Replacer</span><span class="op" id="2335572">{</span><span class="ident" id="2335573">r</span><span class="op" id="2335574">:</span>&nbsp;<span class="op" id="2335576">&amp;</span><span class="ident" id="2335577">r</span><span class="op" id="2335578">}</span><br>
<span class="lineno"></span><span class="op" id="2335580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2335583">//&nbsp;Replace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;s&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2335647">func</span>&nbsp;<span class="op" id="2335652">(</span><span class="ident" id="2335653">r</span>&nbsp;<span class="op" id="2335655">*</span><span class="ident" id="2335656">Replacer</span><span class="op" id="2335664">)</span>&nbsp;<span class="ident" id="2335666">Replace</span><span class="op" id="2335673">(</span><span class="ident" id="2335674">s</span>&nbsp;<span class="builtintype" id="2335676">string</span><span class="op" id="2335682">)</span>&nbsp;<span class="builtintype" id="2335684">string</span>&nbsp;<span class="op" id="2335691">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2335694">return</span>&nbsp;<span class="ident" id="2335701">r</span><span class="op" id="2335702">.</span><span class="ident" id="2335703">r</span><span class="op" id="2335704">.</span><span class="ident" id="2335705">Replace</span><span class="op" id="2335712">(</span><span class="ident" id="2335713">s</span><span class="op" id="2335714">)</span><br>
<span class="lineno"></span><span class="op" id="2335716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2335719">//&nbsp;WriteString&nbsp;writes&nbsp;s&nbsp;to&nbsp;w&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2335781">func</span>&nbsp;<span class="op" id="2335786">(</span><span class="ident" id="2335787">r</span>&nbsp;<span class="op" id="2335789">*</span><span class="ident" id="2335790">Replacer</span><span class="op" id="2335798">)</span>&nbsp;<span class="ident" id="2335800">WriteString</span><span class="op" id="2335811">(</span><span class="ident" id="2335812">w</span>&nbsp;<span class="ident" id="2335814">io</span><span class="op" id="2335816">.</span><span class="ident" id="2335817">Writer</span><span class="op" id="2335823">,</span>&nbsp;<span class="ident" id="2335825">s</span>&nbsp;<span class="builtintype" id="2335827">string</span><span class="op" id="2335833">)</span>&nbsp;<span class="op" id="2335835">(</span><span class="ident" id="2335836">n</span>&nbsp;<span class="builtintype" id="2335838">int</span><span class="op" id="2335841">,</span>&nbsp;<span class="ident" id="2335843">err</span>&nbsp;<span class="builtintype" id="2335847">error</span><span class="op" id="2335852">)</span>&nbsp;<span class="op" id="2335854">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2335857">return</span>&nbsp;<span class="ident" id="2335864">r</span><span class="op" id="2335865">.</span><span class="ident" id="2335866">r</span><span class="op" id="2335867">.</span><span class="ident" id="2335868">WriteString</span><span class="op" id="2335879">(</span><span class="ident" id="2335880">w</span><span class="op" id="2335881">,</span>&nbsp;<span class="ident" id="2335883">s</span><span class="op" id="2335884">)</span><br>
<span class="lineno"></span><span class="op" id="2335886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2335889">//&nbsp;trieNode&nbsp;is&nbsp;a&nbsp;node&nbsp;in&nbsp;a&nbsp;lookup&nbsp;trie&nbsp;for&nbsp;prioritized&nbsp;key/value&nbsp;pairs.&nbsp;Keys</span><br>
<span class="lineno"></span><span class="comment" id="2335966">//&nbsp;and&nbsp;values&nbsp;may&nbsp;be&nbsp;empty.&nbsp;For&nbsp;example,&nbsp;the&nbsp;trie&nbsp;containing&nbsp;keys&nbsp;&#34;ax&#34;,&nbsp;&#34;ay&#34;,</span><br>
<span class="lineno">80</span><span class="comment" id="2336044">//&nbsp;&#34;bcbc&#34;,&nbsp;&#34;x&#34;&nbsp;and&nbsp;&#34;xy&#34;&nbsp;could&nbsp;have&nbsp;eight&nbsp;nodes:</span><br>
<span class="lineno"></span><span class="comment" id="2336092">//</span><br>
<span class="lineno"></span><span class="comment" id="2336095">//&nbsp;&nbsp;n0&nbsp;&nbsp;-</span><br>
<span class="lineno"></span><span class="comment" id="2336105">//&nbsp;&nbsp;n1&nbsp;&nbsp;a-</span><br>
<span class="lineno"></span><span class="comment" id="2336116">//&nbsp;&nbsp;n2&nbsp;&nbsp;.x+</span><br>
<span class="lineno">85</span><span class="comment" id="2336128">//&nbsp;&nbsp;n3&nbsp;&nbsp;.y+</span><br>
<span class="lineno"></span><span class="comment" id="2336140">//&nbsp;&nbsp;n4&nbsp;&nbsp;b-</span><br>
<span class="lineno"></span><span class="comment" id="2336151">//&nbsp;&nbsp;n5&nbsp;&nbsp;.cbc+</span><br>
<span class="lineno"></span><span class="comment" id="2336165">//&nbsp;&nbsp;n6&nbsp;&nbsp;x+</span><br>
<span class="lineno"></span><span class="comment" id="2336176">//&nbsp;&nbsp;n7&nbsp;&nbsp;.y+</span><br>
<span class="lineno">90</span><span class="comment" id="2336188">//</span><br>
<span class="lineno"></span><span class="comment" id="2336191">//&nbsp;n0&nbsp;is&nbsp;the&nbsp;root&nbsp;node,&nbsp;and&nbsp;its&nbsp;children&nbsp;are&nbsp;n1,&nbsp;n4&nbsp;and&nbsp;n6;&nbsp;n1&#39;s&nbsp;children&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="2336269">//&nbsp;n2&nbsp;and&nbsp;n3;&nbsp;n4&#39;s&nbsp;child&nbsp;is&nbsp;n5;&nbsp;n6&#39;s&nbsp;child&nbsp;is&nbsp;n7.&nbsp;Nodes&nbsp;n0,&nbsp;n1&nbsp;and&nbsp;n4&nbsp;(marked</span><br>
<span class="lineno"></span><span class="comment" id="2336347">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;-&#34;)&nbsp;are&nbsp;partial&nbsp;keys,&nbsp;and&nbsp;nodes&nbsp;n2,&nbsp;n3,&nbsp;n5,&nbsp;n6&nbsp;and&nbsp;n7</span><br>
<span class="lineno"></span><span class="comment" id="2336421">//&nbsp;(marked&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;)&nbsp;are&nbsp;complete&nbsp;keys.</span><br>
<span class="lineno">95</span><span class="keyword" id="2336472">type</span>&nbsp;<span class="ident" id="2336477">trieNode</span>&nbsp;<span class="keyword" id="2336486">struct</span>&nbsp;<span class="op" id="2336493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2336496">//&nbsp;value&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s&nbsp;key/value&nbsp;pair.&nbsp;It&nbsp;is&nbsp;empty&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2336569">//&nbsp;this&nbsp;node&nbsp;is&nbsp;not&nbsp;a&nbsp;complete&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2336606">value</span>&nbsp;<span class="builtintype" id="2336612">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2336620">//&nbsp;priority&nbsp;is&nbsp;the&nbsp;priority&nbsp;(higher&nbsp;is&nbsp;more&nbsp;important)&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2336695">//&nbsp;key/value&nbsp;pair;&nbsp;keys&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;matched&nbsp;shortest-&nbsp;or&nbsp;longest-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2336770">//&nbsp;first.&nbsp;Priority&nbsp;is&nbsp;positive&nbsp;if&nbsp;this&nbsp;node&nbsp;is&nbsp;a&nbsp;complete&nbsp;key,&nbsp;and&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2336843">//&nbsp;otherwise.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;positive/zero&nbsp;priorities&nbsp;are&nbsp;marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2336916">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;&nbsp;or&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2336948">priority</span>&nbsp;<span class="builtintype" id="2336957">int</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2336963">//&nbsp;A&nbsp;trie&nbsp;node&nbsp;may&nbsp;have&nbsp;zero,&nbsp;one&nbsp;or&nbsp;more&nbsp;child&nbsp;nodes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337019">//&nbsp;&nbsp;*&nbsp;if&nbsp;the&nbsp;remaining&nbsp;fields&nbsp;are&nbsp;zero,&nbsp;there&nbsp;are&nbsp;no&nbsp;children.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337083">//&nbsp;&nbsp;*&nbsp;if&nbsp;prefix&nbsp;and&nbsp;next&nbsp;are&nbsp;non-zero,&nbsp;there&nbsp;is&nbsp;one&nbsp;child&nbsp;in&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337151">//&nbsp;&nbsp;*&nbsp;if&nbsp;table&nbsp;is&nbsp;non-zero,&nbsp;it&nbsp;defines&nbsp;all&nbsp;the&nbsp;children.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337209">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337213">//&nbsp;Prefixes&nbsp;are&nbsp;preferred&nbsp;over&nbsp;tables&nbsp;when&nbsp;there&nbsp;is&nbsp;one&nbsp;child,&nbsp;but&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337285">//&nbsp;root&nbsp;node&nbsp;always&nbsp;uses&nbsp;a&nbsp;table&nbsp;for&nbsp;lookup&nbsp;efficiency.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337343">//&nbsp;prefix&nbsp;is&nbsp;the&nbsp;difference&nbsp;in&nbsp;keys&nbsp;between&nbsp;this&nbsp;trie&nbsp;node&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337417">//&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;node&nbsp;n4&nbsp;has&nbsp;prefix&nbsp;&#34;cbc&#34;&nbsp;and&nbsp;n4&#39;s&nbsp;next&nbsp;node&nbsp;is&nbsp;n5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337494">//&nbsp;Node&nbsp;n5&nbsp;has&nbsp;no&nbsp;children&nbsp;and&nbsp;so&nbsp;has&nbsp;zero&nbsp;prefix,&nbsp;next&nbsp;and&nbsp;table&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2337569">prefix</span>&nbsp;<span class="builtintype" id="2337576">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2337584">next</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2337591">*</span><span class="ident" id="2337592">trieNode</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337603">//&nbsp;table&nbsp;is&nbsp;a&nbsp;lookup&nbsp;table&nbsp;indexed&nbsp;by&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;key,&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337674">//&nbsp;remapping&nbsp;that&nbsp;byte&nbsp;through&nbsp;genericReplacer.mapping&nbsp;to&nbsp;create&nbsp;a&nbsp;dense</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337748">//&nbsp;index.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;the&nbsp;keys&nbsp;only&nbsp;use&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;,&nbsp;&#39;c&#39;,&nbsp;&#39;x&#39;&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337822">//&nbsp;&#39;y&#39;,&nbsp;which&nbsp;remap&nbsp;to&nbsp;0,&nbsp;1,&nbsp;2,&nbsp;3&nbsp;and&nbsp;4.&nbsp;All&nbsp;other&nbsp;bytes&nbsp;remap&nbsp;to&nbsp;5,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337896">//&nbsp;genericReplacer.tableSize&nbsp;will&nbsp;be&nbsp;5.&nbsp;Node&nbsp;n0&#39;s&nbsp;table&nbsp;will&nbsp;be</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2337961">//&nbsp;[]*trieNode{&nbsp;0:n1,&nbsp;1:n4,&nbsp;3:n6&nbsp;},&nbsp;where&nbsp;the&nbsp;0,&nbsp;1&nbsp;and&nbsp;3&nbsp;are&nbsp;the&nbsp;remapped</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2338036">//&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;&nbsp;and&nbsp;&#39;x&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2338058">table</span>&nbsp;<span class="op" id="2338064">[</span><span class="op" id="2338065">]</span><span class="op" id="2338066">*</span><span class="ident" id="2338067">trieNode</span><br>
<span class="lineno"></span><span class="op" id="2338076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2338079">func</span>&nbsp;<span class="op" id="2338084">(</span><span class="ident" id="2338085">t</span>&nbsp;<span class="op" id="2338087">*</span><span class="ident" id="2338088">trieNode</span><span class="op" id="2338096">)</span>&nbsp;<span class="ident" id="2338098">add</span><span class="op" id="2338101">(</span><span class="ident" id="2338102">key</span><span class="op" id="2338105">,</span>&nbsp;<span class="ident" id="2338107">val</span>&nbsp;<span class="builtintype" id="2338111">string</span><span class="op" id="2338117">,</span>&nbsp;<span class="ident" id="2338119">priority</span>&nbsp;<span class="builtintype" id="2338128">int</span><span class="op" id="2338131">,</span>&nbsp;<span class="ident" id="2338133">r</span>&nbsp;<span class="op" id="2338135">*</span><span class="ident" id="2338136">genericReplacer</span><span class="op" id="2338151">)</span>&nbsp;<span class="op" id="2338153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2338156">if</span>&nbsp;<span class="ident" id="2338159">key</span>&nbsp;<span class="op" id="2338163">==</span>&nbsp;<span class="string" id="2338166">&#34;&#34;</span>&nbsp;<span class="op" id="2338169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2338173">if</span>&nbsp;<span class="ident" id="2338176">t</span><span class="op" id="2338177">.</span><span class="ident" id="2338178">priority</span>&nbsp;<span class="op" id="2338187">==</span>&nbsp;<span class="num" id="2338190">0</span>&nbsp;<span class="op" id="2338192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2338197">t</span><span class="op" id="2338198">.</span><span class="ident" id="2338199">value</span>&nbsp;<span class="op" id="2338205">=</span>&nbsp;<span class="ident" id="2338207">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2338214">t</span><span class="op" id="2338215">.</span><span class="ident" id="2338216">priority</span>&nbsp;<span class="op" id="2338225">=</span>&nbsp;<span class="ident" id="2338227">priority</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2338238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2338242">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2338250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2338254">if</span>&nbsp;<span class="ident" id="2338257">t</span><span class="op" id="2338258">.</span><span class="ident" id="2338259">prefix</span>&nbsp;<span class="op" id="2338266">!=</span>&nbsp;<span class="string" id="2338269">&#34;&#34;</span>&nbsp;<span class="op" id="2338272">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2338276">//&nbsp;Need&nbsp;to&nbsp;split&nbsp;the&nbsp;prefix&nbsp;among&nbsp;multiple&nbsp;nodes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2338328">var</span>&nbsp;<span class="ident" id="2338332">n</span>&nbsp;<span class="builtintype" id="2338334">int</span>&nbsp;<span class="comment" id="2338338">//&nbsp;length&nbsp;of&nbsp;the&nbsp;longest&nbsp;common&nbsp;prefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2338379">for</span>&nbsp;<span class="op" id="2338383">;</span>&nbsp;<span class="ident" id="2338385">n</span>&nbsp;<span class="op" id="2338387">&lt;</span>&nbsp;<span class="builtinfunc" id="2338389">len</span><span class="op" id="2338392">(</span><span class="ident" id="2338393">t</span><span class="op" id="2338394">.</span><span class="ident" id="2338395">prefix</span><span class="op" id="2338401">)</span>&nbsp;<span class="op" id="2338403">&amp;&amp;</span>&nbsp;<span class="ident" id="2338406">n</span>&nbsp;<span class="op" id="2338408">&lt;</span>&nbsp;<span class="builtinfunc" id="2338410">len</span><span class="op" id="2338413">(</span><span class="ident" id="2338414">key</span><span class="op" id="2338417">)</span><span class="op" id="2338418">;</span>&nbsp;<span class="ident" id="2338420">n</span><span class="op" id="2338421">++</span>&nbsp;<span class="op" id="2338424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2338429">if</span>&nbsp;<span class="ident" id="2338432">t</span><span class="op" id="2338433">.</span><span class="ident" id="2338434">prefix</span><span class="op" id="2338440">[</span><span class="ident" id="2338441">n</span><span class="op" id="2338442">]</span>&nbsp;<span class="op" id="2338444">!=</span>&nbsp;<span class="ident" id="2338447">key</span><span class="op" id="2338450">[</span><span class="ident" id="2338451">n</span><span class="op" id="2338452">]</span>&nbsp;<span class="op" id="2338454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2338460">break</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2338469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2338473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2338477">if</span>&nbsp;<span class="ident" id="2338480">n</span>&nbsp;<span class="op" id="2338482">==</span>&nbsp;<span class="builtinfunc" id="2338485">len</span><span class="op" id="2338488">(</span><span class="ident" id="2338489">t</span><span class="op" id="2338490">.</span><span class="ident" id="2338491">prefix</span><span class="op" id="2338497">)</span>&nbsp;<span class="op" id="2338499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2338504">t</span><span class="op" id="2338505">.</span><span class="ident" id="2338506">next</span><span class="op" id="2338510">.</span><span class="ident" id="2338511">add</span><span class="op" id="2338514">(</span><span class="ident" id="2338515">key</span><span class="op" id="2338518">[</span><span class="ident" id="2338519">n</span><span class="op" id="2338520">:</span><span class="op" id="2338521">]</span><span class="op" id="2338522">,</span>&nbsp;<span class="ident" id="2338524">val</span><span class="op" id="2338527">,</span>&nbsp;<span class="ident" id="2338529">priority</span><span class="op" id="2338537">,</span>&nbsp;<span class="ident" id="2338539">r</span><span class="op" id="2338540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2338544">}</span>&nbsp;<span class="keyword" id="2338546">else</span>&nbsp;<span class="keyword" id="2338551">if</span>&nbsp;<span class="ident" id="2338554">n</span>&nbsp;<span class="op" id="2338556">==</span>&nbsp;<span class="num" id="2338559">0</span>&nbsp;<span class="op" id="2338561">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2338566">//&nbsp;First&nbsp;byte&nbsp;differs,&nbsp;start&nbsp;a&nbsp;new&nbsp;lookup&nbsp;table&nbsp;here.&nbsp;Looking&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2338634">//&nbsp;what&nbsp;is&nbsp;currently&nbsp;t.prefix[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;prefixNode,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2338699">//&nbsp;looking&nbsp;up&nbsp;key[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;keyNode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2338745">var</span>&nbsp;<span class="ident" id="2338749">prefixNode</span>&nbsp;<span class="op" id="2338760">*</span><span class="ident" id="2338761">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2338773">if</span>&nbsp;<span class="builtinfunc" id="2338776">len</span><span class="op" id="2338779">(</span><span class="ident" id="2338780">t</span><span class="op" id="2338781">.</span><span class="ident" id="2338782">prefix</span><span class="op" id="2338788">)</span>&nbsp;<span class="op" id="2338790">==</span>&nbsp;<span class="num" id="2338793">1</span>&nbsp;<span class="op" id="2338795">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2338801">prefixNode</span>&nbsp;<span class="op" id="2338812">=</span>&nbsp;<span class="ident" id="2338814">t</span><span class="op" id="2338815">.</span><span class="ident" id="2338816">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2338824">}</span>&nbsp;<span class="keyword" id="2338826">else</span>&nbsp;<span class="op" id="2338831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2338837">prefixNode</span>&nbsp;<span class="op" id="2338848">=</span>&nbsp;<span class="op" id="2338850">&amp;</span><span class="ident" id="2338851">trieNode</span><span class="op" id="2338859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2338866">prefix</span><span class="op" id="2338872">:</span>&nbsp;<span class="ident" id="2338874">t</span><span class="op" id="2338875">.</span><span class="ident" id="2338876">prefix</span><span class="op" id="2338882">[</span><span class="num" id="2338883">1</span><span class="op" id="2338884">:</span><span class="op" id="2338885">]</span><span class="op" id="2338886">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2338893">next</span><span class="op" id="2338897">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2338901">t</span><span class="op" id="2338902">.</span><span class="ident" id="2338903">next</span><span class="op" id="2338907">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2338913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2338918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2338923">keyNode</span>&nbsp;<span class="op" id="2338931">:=</span>&nbsp;<span class="builtinfunc" id="2338934">new</span><span class="op" id="2338937">(</span><span class="ident" id="2338938">trieNode</span><span class="op" id="2338946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2338951">t</span><span class="op" id="2338952">.</span><span class="ident" id="2338953">table</span>&nbsp;<span class="op" id="2338959">=</span>&nbsp;<span class="builtinfunc" id="2338961">make</span><span class="op" id="2338965">(</span><span class="op" id="2338966">[</span><span class="op" id="2338967">]</span><span class="op" id="2338968">*</span><span class="ident" id="2338969">trieNode</span><span class="op" id="2338977">,</span>&nbsp;<span class="ident" id="2338979">r</span><span class="op" id="2338980">.</span><span class="ident" id="2338981">tableSize</span><span class="op" id="2338990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2338995">t</span><span class="op" id="2338996">.</span><span class="ident" id="2338997">table</span><span class="op" id="2339002">[</span><span class="ident" id="2339003">r</span><span class="op" id="2339004">.</span><span class="ident" id="2339005">mapping</span><span class="op" id="2339012">[</span><span class="ident" id="2339013">t</span><span class="op" id="2339014">.</span><span class="ident" id="2339015">prefix</span><span class="op" id="2339021">[</span><span class="num" id="2339022">0</span><span class="op" id="2339023">]</span><span class="op" id="2339024">]</span><span class="op" id="2339025">]</span>&nbsp;<span class="op" id="2339027">=</span>&nbsp;<span class="ident" id="2339029">prefixNode</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339043">t</span><span class="op" id="2339044">.</span><span class="ident" id="2339045">table</span><span class="op" id="2339050">[</span><span class="ident" id="2339051">r</span><span class="op" id="2339052">.</span><span class="ident" id="2339053">mapping</span><span class="op" id="2339060">[</span><span class="ident" id="2339061">key</span><span class="op" id="2339064">[</span><span class="num" id="2339065">0</span><span class="op" id="2339066">]</span><span class="op" id="2339067">]</span><span class="op" id="2339068">]</span>&nbsp;<span class="op" id="2339070">=</span>&nbsp;<span class="ident" id="2339072">keyNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339083">t</span><span class="op" id="2339084">.</span><span class="ident" id="2339085">prefix</span>&nbsp;<span class="op" id="2339092">=</span>&nbsp;<span class="string" id="2339094">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339100">t</span><span class="op" id="2339101">.</span><span class="ident" id="2339102">next</span>&nbsp;<span class="op" id="2339107">=</span>&nbsp;<span class="builtintype" id="2339109">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339116">keyNode</span><span class="op" id="2339123">.</span><span class="ident" id="2339124">add</span><span class="op" id="2339127">(</span><span class="ident" id="2339128">key</span><span class="op" id="2339131">[</span><span class="num" id="2339132">1</span><span class="op" id="2339133">:</span><span class="op" id="2339134">]</span><span class="op" id="2339135">,</span>&nbsp;<span class="ident" id="2339137">val</span><span class="op" id="2339140">,</span>&nbsp;<span class="ident" id="2339142">priority</span><span class="op" id="2339150">,</span>&nbsp;<span class="ident" id="2339152">r</span><span class="op" id="2339153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2339157">}</span>&nbsp;<span class="keyword" id="2339159">else</span>&nbsp;<span class="op" id="2339164">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2339169">//&nbsp;Insert&nbsp;new&nbsp;node&nbsp;after&nbsp;the&nbsp;common&nbsp;section&nbsp;of&nbsp;the&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339231">next</span>&nbsp;<span class="op" id="2339236">:=</span>&nbsp;<span class="op" id="2339239">&amp;</span><span class="ident" id="2339240">trieNode</span><span class="op" id="2339248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339254">prefix</span><span class="op" id="2339260">:</span>&nbsp;<span class="ident" id="2339262">t</span><span class="op" id="2339263">.</span><span class="ident" id="2339264">prefix</span><span class="op" id="2339270">[</span><span class="ident" id="2339271">n</span><span class="op" id="2339272">:</span><span class="op" id="2339273">]</span><span class="op" id="2339274">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339280">next</span><span class="op" id="2339284">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2339288">t</span><span class="op" id="2339289">.</span><span class="ident" id="2339290">next</span><span class="op" id="2339294">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2339299">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339304">t</span><span class="op" id="2339305">.</span><span class="ident" id="2339306">prefix</span>&nbsp;<span class="op" id="2339313">=</span>&nbsp;<span class="ident" id="2339315">t</span><span class="op" id="2339316">.</span><span class="ident" id="2339317">prefix</span><span class="op" id="2339323">[</span><span class="op" id="2339324">:</span><span class="ident" id="2339325">n</span><span class="op" id="2339326">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339331">t</span><span class="op" id="2339332">.</span><span class="ident" id="2339333">next</span>&nbsp;<span class="op" id="2339338">=</span>&nbsp;<span class="ident" id="2339340">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339348">next</span><span class="op" id="2339352">.</span><span class="ident" id="2339353">add</span><span class="op" id="2339356">(</span><span class="ident" id="2339357">key</span><span class="op" id="2339360">[</span><span class="ident" id="2339361">n</span><span class="op" id="2339362">:</span><span class="op" id="2339363">]</span><span class="op" id="2339364">,</span>&nbsp;<span class="ident" id="2339366">val</span><span class="op" id="2339369">,</span>&nbsp;<span class="ident" id="2339371">priority</span><span class="op" id="2339379">,</span>&nbsp;<span class="ident" id="2339381">r</span><span class="op" id="2339382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2339386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2339389">}</span>&nbsp;<span class="keyword" id="2339391">else</span>&nbsp;<span class="keyword" id="2339396">if</span>&nbsp;<span class="ident" id="2339399">t</span><span class="op" id="2339400">.</span><span class="ident" id="2339401">table</span>&nbsp;<span class="op" id="2339407">!=</span>&nbsp;<span class="builtintype" id="2339410">nil</span>&nbsp;<span class="op" id="2339414">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2339418">//&nbsp;Insert&nbsp;into&nbsp;existing&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339451">m</span>&nbsp;<span class="op" id="2339453">:=</span>&nbsp;<span class="ident" id="2339456">r</span><span class="op" id="2339457">.</span><span class="ident" id="2339458">mapping</span><span class="op" id="2339465">[</span><span class="ident" id="2339466">key</span><span class="op" id="2339469">[</span><span class="num" id="2339470">0</span><span class="op" id="2339471">]</span><span class="op" id="2339472">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2339476">if</span>&nbsp;<span class="ident" id="2339479">t</span><span class="op" id="2339480">.</span><span class="ident" id="2339481">table</span><span class="op" id="2339486">[</span><span class="ident" id="2339487">m</span><span class="op" id="2339488">]</span>&nbsp;<span class="op" id="2339490">==</span>&nbsp;<span class="builtintype" id="2339493">nil</span>&nbsp;<span class="op" id="2339497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339502">t</span><span class="op" id="2339503">.</span><span class="ident" id="2339504">table</span><span class="op" id="2339509">[</span><span class="ident" id="2339510">m</span><span class="op" id="2339511">]</span>&nbsp;<span class="op" id="2339513">=</span>&nbsp;<span class="builtinfunc" id="2339515">new</span><span class="op" id="2339518">(</span><span class="ident" id="2339519">trieNode</span><span class="op" id="2339527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2339531">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339535">t</span><span class="op" id="2339536">.</span><span class="ident" id="2339537">table</span><span class="op" id="2339542">[</span><span class="ident" id="2339543">m</span><span class="op" id="2339544">]</span><span class="op" id="2339545">.</span><span class="ident" id="2339546">add</span><span class="op" id="2339549">(</span><span class="ident" id="2339550">key</span><span class="op" id="2339553">[</span><span class="num" id="2339554">1</span><span class="op" id="2339555">:</span><span class="op" id="2339556">]</span><span class="op" id="2339557">,</span>&nbsp;<span class="ident" id="2339559">val</span><span class="op" id="2339562">,</span>&nbsp;<span class="ident" id="2339564">priority</span><span class="op" id="2339572">,</span>&nbsp;<span class="ident" id="2339574">r</span><span class="op" id="2339575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2339578">}</span>&nbsp;<span class="keyword" id="2339580">else</span>&nbsp;<span class="op" id="2339585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339589">t</span><span class="op" id="2339590">.</span><span class="ident" id="2339591">prefix</span>&nbsp;<span class="op" id="2339598">=</span>&nbsp;<span class="ident" id="2339600">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339606">t</span><span class="op" id="2339607">.</span><span class="ident" id="2339608">next</span>&nbsp;<span class="op" id="2339613">=</span>&nbsp;<span class="builtinfunc" id="2339615">new</span><span class="op" id="2339618">(</span><span class="ident" id="2339619">trieNode</span><span class="op" id="2339627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339631">t</span><span class="op" id="2339632">.</span><span class="ident" id="2339633">next</span><span class="op" id="2339637">.</span><span class="ident" id="2339638">add</span><span class="op" id="2339641">(</span><span class="string" id="2339642">&#34;&#34;</span><span class="op" id="2339644">,</span>&nbsp;<span class="ident" id="2339646">val</span><span class="op" id="2339649">,</span>&nbsp;<span class="ident" id="2339651">priority</span><span class="op" id="2339659">,</span>&nbsp;<span class="ident" id="2339661">r</span><span class="op" id="2339662">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2339665">}</span><br>
<span class="lineno"></span><span class="op" id="2339667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2339670">func</span>&nbsp;<span class="op" id="2339675">(</span><span class="ident" id="2339676">r</span>&nbsp;<span class="op" id="2339678">*</span><span class="ident" id="2339679">genericReplacer</span><span class="op" id="2339694">)</span>&nbsp;<span class="ident" id="2339696">lookup</span><span class="op" id="2339702">(</span><span class="ident" id="2339703">s</span>&nbsp;<span class="builtintype" id="2339705">string</span><span class="op" id="2339711">,</span>&nbsp;<span class="ident" id="2339713">ignoreRoot</span>&nbsp;<span class="builtintype" id="2339724">bool</span><span class="op" id="2339728">)</span>&nbsp;<span class="op" id="2339730">(</span><span class="ident" id="2339731">val</span>&nbsp;<span class="builtintype" id="2339735">string</span><span class="op" id="2339741">,</span>&nbsp;<span class="ident" id="2339743">keylen</span>&nbsp;<span class="builtintype" id="2339750">int</span><span class="op" id="2339753">,</span>&nbsp;<span class="ident" id="2339755">found</span>&nbsp;<span class="builtintype" id="2339761">bool</span><span class="op" id="2339765">)</span>&nbsp;<span class="op" id="2339767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2339770">//&nbsp;Iterate&nbsp;down&nbsp;the&nbsp;trie&nbsp;to&nbsp;the&nbsp;end,&nbsp;and&nbsp;grab&nbsp;the&nbsp;value&nbsp;and&nbsp;keylen&nbsp;with</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2339843">//&nbsp;the&nbsp;highest&nbsp;priority.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339869">bestPriority</span>&nbsp;<span class="op" id="2339882">:=</span>&nbsp;<span class="num" id="2339885">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339888">node</span>&nbsp;<span class="op" id="2339893">:=</span>&nbsp;<span class="op" id="2339896">&amp;</span><span class="ident" id="2339897">r</span><span class="op" id="2339898">.</span><span class="ident" id="2339899">root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2339905">n</span>&nbsp;<span class="op" id="2339907">:=</span>&nbsp;<span class="num" id="2339910">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2339913">for</span>&nbsp;<span class="ident" id="2339917">node</span>&nbsp;<span class="op" id="2339922">!=</span>&nbsp;<span class="builtintype" id="2339925">nil</span>&nbsp;<span class="op" id="2339929">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2339933">if</span>&nbsp;<span class="ident" id="2339936">node</span><span class="op" id="2339940">.</span><span class="ident" id="2339941">priority</span>&nbsp;<span class="op" id="2339950">&gt;</span>&nbsp;<span class="ident" id="2339952">bestPriority</span>&nbsp;<span class="op" id="2339965">&amp;&amp;</span>&nbsp;<span class="op" id="2339968">!</span><span class="op" id="2339969">(</span><span class="ident" id="2339970">ignoreRoot</span>&nbsp;<span class="op" id="2339981">&amp;&amp;</span>&nbsp;<span class="ident" id="2339984">node</span>&nbsp;<span class="op" id="2339989">==</span>&nbsp;<span class="op" id="2339992">&amp;</span><span class="ident" id="2339993">r</span><span class="op" id="2339994">.</span><span class="ident" id="2339995">root</span><span class="op" id="2339999">)</span>&nbsp;<span class="op" id="2340001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340006">bestPriority</span>&nbsp;<span class="op" id="2340019">=</span>&nbsp;<span class="ident" id="2340021">node</span><span class="op" id="2340025">.</span><span class="ident" id="2340026">priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340038">val</span>&nbsp;<span class="op" id="2340042">=</span>&nbsp;<span class="ident" id="2340044">node</span><span class="op" id="2340048">.</span><span class="ident" id="2340049">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340058">keylen</span>&nbsp;<span class="op" id="2340065">=</span>&nbsp;<span class="ident" id="2340067">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340072">found</span>&nbsp;<span class="op" id="2340078">=</span>&nbsp;<span class="builtintype" id="2340080">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2340087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2340092">if</span>&nbsp;<span class="ident" id="2340095">s</span>&nbsp;<span class="op" id="2340097">==</span>&nbsp;<span class="string" id="2340100">&#34;&#34;</span>&nbsp;<span class="op" id="2340103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2340108">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2340116">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2340120">if</span>&nbsp;<span class="ident" id="2340123">node</span><span class="op" id="2340127">.</span><span class="ident" id="2340128">table</span>&nbsp;<span class="op" id="2340134">!=</span>&nbsp;<span class="builtintype" id="2340137">nil</span>&nbsp;<span class="op" id="2340141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340146">index</span>&nbsp;<span class="op" id="2340152">:=</span>&nbsp;<span class="ident" id="2340155">r</span><span class="op" id="2340156">.</span><span class="ident" id="2340157">mapping</span><span class="op" id="2340164">[</span><span class="ident" id="2340165">s</span><span class="op" id="2340166">[</span><span class="num" id="2340167">0</span><span class="op" id="2340168">]</span><span class="op" id="2340169">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2340174">if</span>&nbsp;<span class="builtintype" id="2340177">int</span><span class="op" id="2340180">(</span><span class="ident" id="2340181">index</span><span class="op" id="2340186">)</span>&nbsp;<span class="op" id="2340188">==</span>&nbsp;<span class="ident" id="2340191">r</span><span class="op" id="2340192">.</span><span class="ident" id="2340193">tableSize</span>&nbsp;<span class="op" id="2340203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2340209">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2340218">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340223">node</span>&nbsp;<span class="op" id="2340228">=</span>&nbsp;<span class="ident" id="2340230">node</span><span class="op" id="2340234">.</span><span class="ident" id="2340235">table</span><span class="op" id="2340240">[</span><span class="ident" id="2340241">index</span><span class="op" id="2340246">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340251">s</span>&nbsp;<span class="op" id="2340253">=</span>&nbsp;<span class="ident" id="2340255">s</span><span class="op" id="2340256">[</span><span class="num" id="2340257">1</span><span class="op" id="2340258">:</span><span class="op" id="2340259">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340264">n</span><span class="op" id="2340265">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2340270">}</span>&nbsp;<span class="keyword" id="2340272">else</span>&nbsp;<span class="keyword" id="2340277">if</span>&nbsp;<span class="ident" id="2340280">node</span><span class="op" id="2340284">.</span><span class="ident" id="2340285">prefix</span>&nbsp;<span class="op" id="2340292">!=</span>&nbsp;<span class="string" id="2340295">&#34;&#34;</span>&nbsp;<span class="op" id="2340298">&amp;&amp;</span>&nbsp;<span class="ident" id="2340301">HasPrefix</span><span class="op" id="2340310">(</span><span class="ident" id="2340311">s</span><span class="op" id="2340312">,</span>&nbsp;<span class="ident" id="2340314">node</span><span class="op" id="2340318">.</span><span class="ident" id="2340319">prefix</span><span class="op" id="2340325">)</span>&nbsp;<span class="op" id="2340327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340332">n</span>&nbsp;<span class="op" id="2340334">+=</span>&nbsp;<span class="builtinfunc" id="2340337">len</span><span class="op" id="2340340">(</span><span class="ident" id="2340341">node</span><span class="op" id="2340345">.</span><span class="ident" id="2340346">prefix</span><span class="op" id="2340352">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340357">s</span>&nbsp;<span class="op" id="2340359">=</span>&nbsp;<span class="ident" id="2340361">s</span><span class="op" id="2340362">[</span><span class="builtinfunc" id="2340363">len</span><span class="op" id="2340366">(</span><span class="ident" id="2340367">node</span><span class="op" id="2340371">.</span><span class="ident" id="2340372">prefix</span><span class="op" id="2340378">)</span><span class="op" id="2340379">:</span><span class="op" id="2340380">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340385">node</span>&nbsp;<span class="op" id="2340390">=</span>&nbsp;<span class="ident" id="2340392">node</span><span class="op" id="2340396">.</span><span class="ident" id="2340397">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2340404">}</span>&nbsp;<span class="keyword" id="2340406">else</span>&nbsp;<span class="op" id="2340411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2340416">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2340424">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2340427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2340430">return</span><br>
<span class="lineno"></span><span class="op" id="2340437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2340440">//&nbsp;genericReplacer&nbsp;is&nbsp;the&nbsp;fully&nbsp;generic&nbsp;algorithm.</span><br>
<span class="lineno">230</span><span class="comment" id="2340491">//&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;fallback&nbsp;when&nbsp;nothing&nbsp;faster&nbsp;can&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="2340551">type</span>&nbsp;<span class="ident" id="2340556">genericReplacer</span>&nbsp;<span class="keyword" id="2340572">struct</span>&nbsp;<span class="op" id="2340579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340582">root</span>&nbsp;<span class="ident" id="2340587">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2340597">//&nbsp;tableSize&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;trie&nbsp;node&#39;s&nbsp;lookup&nbsp;table.&nbsp;It&nbsp;is&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2340671">//&nbsp;of&nbsp;unique&nbsp;key&nbsp;bytes.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340696">tableSize</span>&nbsp;<span class="builtintype" id="2340706">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2340711">//&nbsp;mapping&nbsp;maps&nbsp;from&nbsp;key&nbsp;bytes&nbsp;to&nbsp;a&nbsp;dense&nbsp;index&nbsp;for&nbsp;trieNode.table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340780">mapping</span>&nbsp;<span class="op" id="2340788">[</span><span class="num" id="2340789">256</span><span class="op" id="2340792">]</span><span class="builtintype" id="2340793">byte</span><br>
<span class="lineno"></span><span class="op" id="2340798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="2340801">func</span>&nbsp;<span class="ident" id="2340806">makeGenericReplacer</span><span class="op" id="2340825">(</span><span class="ident" id="2340826">oldnew</span>&nbsp;<span class="op" id="2340833">[</span><span class="op" id="2340834">]</span><span class="builtintype" id="2340835">string</span><span class="op" id="2340841">)</span>&nbsp;<span class="op" id="2340843">*</span><span class="ident" id="2340844">genericReplacer</span>&nbsp;<span class="op" id="2340860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340863">r</span>&nbsp;<span class="op" id="2340865">:=</span>&nbsp;<span class="builtinfunc" id="2340868">new</span><span class="op" id="2340871">(</span><span class="ident" id="2340872">genericReplacer</span><span class="op" id="2340887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2340890">//&nbsp;Find&nbsp;each&nbsp;byte&nbsp;used,&nbsp;then&nbsp;assign&nbsp;them&nbsp;each&nbsp;an&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2340947">for</span>&nbsp;<span class="ident" id="2340951">i</span>&nbsp;<span class="op" id="2340953">:=</span>&nbsp;<span class="num" id="2340956">0</span><span class="op" id="2340957">;</span>&nbsp;<span class="ident" id="2340959">i</span>&nbsp;<span class="op" id="2340961">&lt;</span>&nbsp;<span class="builtinfunc" id="2340963">len</span><span class="op" id="2340966">(</span><span class="ident" id="2340967">oldnew</span><span class="op" id="2340973">)</span><span class="op" id="2340974">;</span>&nbsp;<span class="ident" id="2340976">i</span>&nbsp;<span class="op" id="2340978">+=</span>&nbsp;<span class="num" id="2340981">2</span>&nbsp;<span class="op" id="2340983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2340987">key</span>&nbsp;<span class="op" id="2340991">:=</span>&nbsp;<span class="ident" id="2340994">oldnew</span><span class="op" id="2341000">[</span><span class="ident" id="2341001">i</span><span class="op" id="2341002">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2341006">for</span>&nbsp;<span class="ident" id="2341010">j</span>&nbsp;<span class="op" id="2341012">:=</span>&nbsp;<span class="num" id="2341015">0</span><span class="op" id="2341016">;</span>&nbsp;<span class="ident" id="2341018">j</span>&nbsp;<span class="op" id="2341020">&lt;</span>&nbsp;<span class="builtinfunc" id="2341022">len</span><span class="op" id="2341025">(</span><span class="ident" id="2341026">key</span><span class="op" id="2341029">)</span><span class="op" id="2341030">;</span>&nbsp;<span class="ident" id="2341032">j</span><span class="op" id="2341033">++</span>&nbsp;<span class="op" id="2341036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2341041">r</span><span class="op" id="2341042">.</span><span class="ident" id="2341043">mapping</span><span class="op" id="2341050">[</span><span class="ident" id="2341051">key</span><span class="op" id="2341054">[</span><span class="ident" id="2341055">j</span><span class="op" id="2341056">]</span><span class="op" id="2341057">]</span>&nbsp;<span class="op" id="2341059">=</span>&nbsp;<span class="num" id="2341061">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2341065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2341068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2341072">for</span>&nbsp;<span class="ident" id="2341076">_</span><span class="op" id="2341077">,</span>&nbsp;<span class="ident" id="2341079">b</span>&nbsp;<span class="op" id="2341081">:=</span>&nbsp;<span class="keyword" id="2341084">range</span>&nbsp;<span class="ident" id="2341090">r</span><span class="op" id="2341091">.</span><span class="ident" id="2341092">mapping</span>&nbsp;<span class="op" id="2341100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2341104">r</span><span class="op" id="2341105">.</span><span class="ident" id="2341106">tableSize</span>&nbsp;<span class="op" id="2341116">+=</span>&nbsp;<span class="builtintype" id="2341119">int</span><span class="op" id="2341122">(</span><span class="ident" id="2341123">b</span><span class="op" id="2341124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2341127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2341131">var</span>&nbsp;<span class="ident" id="2341135">index</span>&nbsp;<span class="builtintype" id="2341141">byte</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2341147">for</span>&nbsp;<span class="ident" id="2341151">i</span><span class="op" id="2341152">,</span>&nbsp;<span class="ident" id="2341154">b</span>&nbsp;<span class="op" id="2341156">:=</span>&nbsp;<span class="keyword" id="2341159">range</span>&nbsp;<span class="ident" id="2341165">r</span><span class="op" id="2341166">.</span><span class="ident" id="2341167">mapping</span>&nbsp;<span class="op" id="2341175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2341179">if</span>&nbsp;<span class="ident" id="2341182">b</span>&nbsp;<span class="op" id="2341184">==</span>&nbsp;<span class="num" id="2341187">0</span>&nbsp;<span class="op" id="2341189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2341194">r</span><span class="op" id="2341195">.</span><span class="ident" id="2341196">mapping</span><span class="op" id="2341203">[</span><span class="ident" id="2341204">i</span><span class="op" id="2341205">]</span>&nbsp;<span class="op" id="2341207">=</span>&nbsp;<span class="builtintype" id="2341209">byte</span><span class="op" id="2341213">(</span><span class="ident" id="2341214">r</span><span class="op" id="2341215">.</span><span class="ident" id="2341216">tableSize</span><span class="op" id="2341225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2341229">}</span>&nbsp;<span class="keyword" id="2341231">else</span>&nbsp;<span class="op" id="2341236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2341241">r</span><span class="op" id="2341242">.</span><span class="ident" id="2341243">mapping</span><span class="op" id="2341250">[</span><span class="ident" id="2341251">i</span><span class="op" id="2341252">]</span>&nbsp;<span class="op" id="2341254">=</span>&nbsp;<span class="ident" id="2341256">index</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2341265">index</span><span class="op" id="2341270">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2341275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2341278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2341281">//&nbsp;Ensure&nbsp;root&nbsp;node&nbsp;uses&nbsp;a&nbsp;lookup&nbsp;table&nbsp;(for&nbsp;performance).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2341341">r</span><span class="op" id="2341342">.</span><span class="ident" id="2341343">root</span><span class="op" id="2341347">.</span><span class="ident" id="2341348">table</span>&nbsp;<span class="op" id="2341354">=</span>&nbsp;<span class="builtinfunc" id="2341356">make</span><span class="op" id="2341360">(</span><span class="op" id="2341361">[</span><span class="op" id="2341362">]</span><span class="op" id="2341363">*</span><span class="ident" id="2341364">trieNode</span><span class="op" id="2341372">,</span>&nbsp;<span class="ident" id="2341374">r</span><span class="op" id="2341375">.</span><span class="ident" id="2341376">tableSize</span><span class="op" id="2341385">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2341389">for</span>&nbsp;<span class="ident" id="2341393">i</span>&nbsp;<span class="op" id="2341395">:=</span>&nbsp;<span class="num" id="2341398">0</span><span class="op" id="2341399">;</span>&nbsp;<span class="ident" id="2341401">i</span>&nbsp;<span class="op" id="2341403">&lt;</span>&nbsp;<span class="builtinfunc" id="2341405">len</span><span class="op" id="2341408">(</span><span class="ident" id="2341409">oldnew</span><span class="op" id="2341415">)</span><span class="op" id="2341416">;</span>&nbsp;<span class="ident" id="2341418">i</span>&nbsp;<span class="op" id="2341420">+=</span>&nbsp;<span class="num" id="2341423">2</span>&nbsp;<span class="op" id="2341425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2341429">r</span><span class="op" id="2341430">.</span><span class="ident" id="2341431">root</span><span class="op" id="2341435">.</span><span class="ident" id="2341436">add</span><span class="op" id="2341439">(</span><span class="ident" id="2341440">oldnew</span><span class="op" id="2341446">[</span><span class="ident" id="2341447">i</span><span class="op" id="2341448">]</span><span class="op" id="2341449">,</span>&nbsp;<span class="ident" id="2341451">oldnew</span><span class="op" id="2341457">[</span><span class="ident" id="2341458">i</span><span class="op" id="2341459">+</span><span class="num" id="2341460">1</span><span class="op" id="2341461">]</span><span class="op" id="2341462">,</span>&nbsp;<span class="builtinfunc" id="2341464">len</span><span class="op" id="2341467">(</span><span class="ident" id="2341468">oldnew</span><span class="op" id="2341474">)</span><span class="op" id="2341475">-</span><span class="ident" id="2341476">i</span><span class="op" id="2341477">,</span>&nbsp;<span class="ident" id="2341479">r</span><span class="op" id="2341480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2341483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2341486">return</span>&nbsp;<span class="ident" id="2341493">r</span><br>
<span class="lineno">270</span><span class="op" id="2341495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2341498">type</span>&nbsp;<span class="ident" id="2341503">appendSliceWriter</span>&nbsp;<span class="op" id="2341521">[</span><span class="op" id="2341522">]</span><span class="builtintype" id="2341523">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2341529">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;to&nbsp;satisfy&nbsp;io.Writer.</span><br>
<span class="lineno">275</span><span class="keyword" id="2341581">func</span>&nbsp;<span class="op" id="2341586">(</span><span class="ident" id="2341587">w</span>&nbsp;<span class="op" id="2341589">*</span><span class="ident" id="2341590">appendSliceWriter</span><span class="op" id="2341607">)</span>&nbsp;<span class="ident" id="2341609">Write</span><span class="op" id="2341614">(</span><span class="ident" id="2341615">p</span>&nbsp;<span class="op" id="2341617">[</span><span class="op" id="2341618">]</span><span class="builtintype" id="2341619">byte</span><span class="op" id="2341623">)</span>&nbsp;<span class="op" id="2341625">(</span><span class="builtintype" id="2341626">int</span><span class="op" id="2341629">,</span>&nbsp;<span class="builtintype" id="2341631">error</span><span class="op" id="2341636">)</span>&nbsp;<span class="op" id="2341638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2341641">*</span><span class="ident" id="2341642">w</span>&nbsp;<span class="op" id="2341644">=</span>&nbsp;<span class="builtinfunc" id="2341646">append</span><span class="op" id="2341652">(</span><span class="op" id="2341653">*</span><span class="ident" id="2341654">w</span><span class="op" id="2341655">,</span>&nbsp;<span class="ident" id="2341657">p</span><span class="op" id="2341658">...</span><span class="op" id="2341661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2341664">return</span>&nbsp;<span class="builtinfunc" id="2341671">len</span><span class="op" id="2341674">(</span><span class="ident" id="2341675">p</span><span class="op" id="2341676">)</span><span class="op" id="2341677">,</span>&nbsp;<span class="builtintype" id="2341679">nil</span><br>
<span class="lineno"></span><span class="op" id="2341683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="2341686">//&nbsp;WriteString&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;without&nbsp;string-&gt;[]byte-&gt;string&nbsp;allocations.</span><br>
<span class="lineno"></span><span class="keyword" id="2341766">func</span>&nbsp;<span class="op" id="2341771">(</span><span class="ident" id="2341772">w</span>&nbsp;<span class="op" id="2341774">*</span><span class="ident" id="2341775">appendSliceWriter</span><span class="op" id="2341792">)</span>&nbsp;<span class="ident" id="2341794">WriteString</span><span class="op" id="2341805">(</span><span class="ident" id="2341806">s</span>&nbsp;<span class="builtintype" id="2341808">string</span><span class="op" id="2341814">)</span>&nbsp;<span class="op" id="2341816">(</span><span class="builtintype" id="2341817">int</span><span class="op" id="2341820">,</span>&nbsp;<span class="builtintype" id="2341822">error</span><span class="op" id="2341827">)</span>&nbsp;<span class="op" id="2341829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2341832">*</span><span class="ident" id="2341833">w</span>&nbsp;<span class="op" id="2341835">=</span>&nbsp;<span class="builtinfunc" id="2341837">append</span><span class="op" id="2341843">(</span><span class="op" id="2341844">*</span><span class="ident" id="2341845">w</span><span class="op" id="2341846">,</span>&nbsp;<span class="ident" id="2341848">s</span><span class="op" id="2341849">...</span><span class="op" id="2341852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2341855">return</span>&nbsp;<span class="builtinfunc" id="2341862">len</span><span class="op" id="2341865">(</span><span class="ident" id="2341866">s</span><span class="op" id="2341867">)</span><span class="op" id="2341868">,</span>&nbsp;<span class="builtintype" id="2341870">nil</span><br>
<span class="lineno"></span><span class="op" id="2341874">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="2341877">type</span>&nbsp;<span class="ident" id="2341882">stringWriterIface</span>&nbsp;<span class="keyword" id="2341900">interface</span>&nbsp;<span class="op" id="2341910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2341913">WriteString</span><span class="op" id="2341924">(</span><span class="builtintype" id="2341925">string</span><span class="op" id="2341931">)</span>&nbsp;<span class="op" id="2341933">(</span><span class="builtintype" id="2341934">int</span><span class="op" id="2341937">,</span>&nbsp;<span class="builtintype" id="2341939">error</span><span class="op" id="2341944">)</span><br>
<span class="lineno"></span><span class="op" id="2341946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="2341949">type</span>&nbsp;<span class="ident" id="2341954">stringWriter</span>&nbsp;<span class="keyword" id="2341967">struct</span>&nbsp;<span class="op" id="2341974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2341977">w</span>&nbsp;<span class="ident" id="2341979">io</span><span class="op" id="2341981">.</span><span class="ident" id="2341982">Writer</span><br>
<span class="lineno"></span><span class="op" id="2341989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2341992">func</span>&nbsp;<span class="op" id="2341997">(</span><span class="ident" id="2341998">w</span>&nbsp;<span class="ident" id="2342000">stringWriter</span><span class="op" id="2342012">)</span>&nbsp;<span class="ident" id="2342014">WriteString</span><span class="op" id="2342025">(</span><span class="ident" id="2342026">s</span>&nbsp;<span class="builtintype" id="2342028">string</span><span class="op" id="2342034">)</span>&nbsp;<span class="op" id="2342036">(</span><span class="builtintype" id="2342037">int</span><span class="op" id="2342040">,</span>&nbsp;<span class="builtintype" id="2342042">error</span><span class="op" id="2342047">)</span>&nbsp;<span class="op" id="2342049">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2342052">return</span>&nbsp;<span class="ident" id="2342059">w</span><span class="op" id="2342060">.</span><span class="ident" id="2342061">w</span><span class="op" id="2342062">.</span><span class="ident" id="2342063">Write</span><span class="op" id="2342068">(</span><span class="op" id="2342069">[</span><span class="op" id="2342070">]</span><span class="builtintype" id="2342071">byte</span><span class="op" id="2342075">(</span><span class="ident" id="2342076">s</span><span class="op" id="2342077">)</span><span class="op" id="2342078">)</span><br>
<span class="lineno"></span><span class="op" id="2342080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2342083">func</span>&nbsp;<span class="ident" id="2342088">getStringWriter</span><span class="op" id="2342103">(</span><span class="ident" id="2342104">w</span>&nbsp;<span class="ident" id="2342106">io</span><span class="op" id="2342108">.</span><span class="ident" id="2342109">Writer</span><span class="op" id="2342115">)</span>&nbsp;<span class="ident" id="2342117">stringWriterIface</span>&nbsp;<span class="op" id="2342135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2342138">sw</span><span class="op" id="2342140">,</span>&nbsp;<span class="ident" id="2342142">ok</span>&nbsp;<span class="op" id="2342145">:=</span>&nbsp;<span class="ident" id="2342148">w</span><span class="op" id="2342149">.</span><span class="op" id="2342150">(</span><span class="ident" id="2342151">stringWriterIface</span><span class="op" id="2342168">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2342171">if</span>&nbsp;<span class="op" id="2342174">!</span><span class="ident" id="2342175">ok</span>&nbsp;<span class="op" id="2342178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2342182">sw</span>&nbsp;<span class="op" id="2342185">=</span>&nbsp;<span class="ident" id="2342187">stringWriter</span><span class="op" id="2342199">{</span><span class="ident" id="2342200">w</span><span class="op" id="2342201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2342204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2342207">return</span>&nbsp;<span class="ident" id="2342214">sw</span><br>
<span class="lineno"></span><span class="op" id="2342217">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="2342220">func</span>&nbsp;<span class="op" id="2342225">(</span><span class="ident" id="2342226">r</span>&nbsp;<span class="op" id="2342228">*</span><span class="ident" id="2342229">genericReplacer</span><span class="op" id="2342244">)</span>&nbsp;<span class="ident" id="2342246">Replace</span><span class="op" id="2342253">(</span><span class="ident" id="2342254">s</span>&nbsp;<span class="builtintype" id="2342256">string</span><span class="op" id="2342262">)</span>&nbsp;<span class="builtintype" id="2342264">string</span>&nbsp;<span class="op" id="2342271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2342274">buf</span>&nbsp;<span class="op" id="2342278">:=</span>&nbsp;<span class="builtinfunc" id="2342281">make</span><span class="op" id="2342285">(</span><span class="ident" id="2342286">appendSliceWriter</span><span class="op" id="2342303">,</span>&nbsp;<span class="num" id="2342305">0</span><span class="op" id="2342306">,</span>&nbsp;<span class="builtinfunc" id="2342308">len</span><span class="op" id="2342311">(</span><span class="ident" id="2342312">s</span><span class="op" id="2342313">)</span><span class="op" id="2342314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2342317">r</span><span class="op" id="2342318">.</span><span class="ident" id="2342319">WriteString</span><span class="op" id="2342330">(</span><span class="op" id="2342331">&amp;</span><span class="ident" id="2342332">buf</span><span class="op" id="2342335">,</span>&nbsp;<span class="ident" id="2342337">s</span><span class="op" id="2342338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2342341">return</span>&nbsp;<span class="builtintype" id="2342348">string</span><span class="op" id="2342354">(</span><span class="ident" id="2342355">buf</span><span class="op" id="2342358">)</span><br>
<span class="lineno">310</span><span class="op" id="2342360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2342363">func</span>&nbsp;<span class="op" id="2342368">(</span><span class="ident" id="2342369">r</span>&nbsp;<span class="op" id="2342371">*</span><span class="ident" id="2342372">genericReplacer</span><span class="op" id="2342387">)</span>&nbsp;<span class="ident" id="2342389">WriteString</span><span class="op" id="2342400">(</span><span class="ident" id="2342401">w</span>&nbsp;<span class="ident" id="2342403">io</span><span class="op" id="2342405">.</span><span class="ident" id="2342406">Writer</span><span class="op" id="2342412">,</span>&nbsp;<span class="ident" id="2342414">s</span>&nbsp;<span class="builtintype" id="2342416">string</span><span class="op" id="2342422">)</span>&nbsp;<span class="op" id="2342424">(</span><span class="ident" id="2342425">n</span>&nbsp;<span class="builtintype" id="2342427">int</span><span class="op" id="2342430">,</span>&nbsp;<span class="ident" id="2342432">err</span>&nbsp;<span class="builtintype" id="2342436">error</span><span class="op" id="2342441">)</span>&nbsp;<span class="op" id="2342443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2342446">sw</span>&nbsp;<span class="op" id="2342449">:=</span>&nbsp;<span class="ident" id="2342452">getStringWriter</span><span class="op" id="2342467">(</span><span class="ident" id="2342468">w</span><span class="op" id="2342469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2342472">var</span>&nbsp;<span class="ident" id="2342476">last</span><span class="op" id="2342480">,</span>&nbsp;<span class="ident" id="2342482">wn</span>&nbsp;<span class="builtintype" id="2342485">int</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2342490">var</span>&nbsp;<span class="ident" id="2342494">prevMatchEmpty</span>&nbsp;<span class="builtintype" id="2342509">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2342515">for</span>&nbsp;<span class="ident" id="2342519">i</span>&nbsp;<span class="op" id="2342521">:=</span>&nbsp;<span class="num" id="2342524">0</span><span class="op" id="2342525">;</span>&nbsp;<span class="ident" id="2342527">i</span>&nbsp;<span class="op" id="2342529">&lt;=</span>&nbsp;<span class="builtinfunc" id="2342532">len</span><span class="op" id="2342535">(</span><span class="ident" id="2342536">s</span><span class="op" id="2342537">)</span><span class="op" id="2342538">;</span>&nbsp;<span class="op" id="2342540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2342544">//&nbsp;Fast&nbsp;path:&nbsp;s[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;prefix&nbsp;of&nbsp;any&nbsp;pattern.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2342597">if</span>&nbsp;<span class="ident" id="2342600">i</span>&nbsp;<span class="op" id="2342602">!=</span>&nbsp;<span class="builtinfunc" id="2342605">len</span><span class="op" id="2342608">(</span><span class="ident" id="2342609">s</span><span class="op" id="2342610">)</span>&nbsp;<span class="op" id="2342612">&amp;&amp;</span>&nbsp;<span class="ident" id="2342615">r</span><span class="op" id="2342616">.</span><span class="ident" id="2342617">root</span><span class="op" id="2342621">.</span><span class="ident" id="2342622">priority</span>&nbsp;<span class="op" id="2342631">==</span>&nbsp;<span class="num" id="2342634">0</span>&nbsp;<span class="op" id="2342636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2342641">index</span>&nbsp;<span class="op" id="2342647">:=</span>&nbsp;<span class="builtintype" id="2342650">int</span><span class="op" id="2342653">(</span><span class="ident" id="2342654">r</span><span class="op" id="2342655">.</span><span class="ident" id="2342656">mapping</span><span class="op" id="2342663">[</span><span class="ident" id="2342664">s</span><span class="op" id="2342665">[</span><span class="ident" id="2342666">i</span><span class="op" id="2342667">]</span><span class="op" id="2342668">]</span><span class="op" id="2342669">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2342674">if</span>&nbsp;<span class="ident" id="2342677">index</span>&nbsp;<span class="op" id="2342683">==</span>&nbsp;<span class="ident" id="2342686">r</span><span class="op" id="2342687">.</span><span class="ident" id="2342688">tableSize</span>&nbsp;<span class="op" id="2342698">||</span>&nbsp;<span class="ident" id="2342701">r</span><span class="op" id="2342702">.</span><span class="ident" id="2342703">root</span><span class="op" id="2342707">.</span><span class="ident" id="2342708">table</span><span class="op" id="2342713">[</span><span class="ident" id="2342714">index</span><span class="op" id="2342719">]</span>&nbsp;<span class="op" id="2342721">==</span>&nbsp;<span class="builtintype" id="2342724">nil</span>&nbsp;<span class="op" id="2342728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2342734">i</span><span class="op" id="2342735">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2342742">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2342754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2342758">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2342763">//&nbsp;Ignore&nbsp;the&nbsp;empty&nbsp;match&nbsp;iff&nbsp;the&nbsp;previous&nbsp;loop&nbsp;found&nbsp;the&nbsp;empty&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2342836">val</span><span class="op" id="2342839">,</span>&nbsp;<span class="ident" id="2342841">keylen</span><span class="op" id="2342847">,</span>&nbsp;<span class="ident" id="2342849">match</span>&nbsp;<span class="op" id="2342855">:=</span>&nbsp;<span class="ident" id="2342858">r</span><span class="op" id="2342859">.</span><span class="ident" id="2342860">lookup</span><span class="op" id="2342866">(</span><span class="ident" id="2342867">s</span><span class="op" id="2342868">[</span><span class="ident" id="2342869">i</span><span class="op" id="2342870">:</span><span class="op" id="2342871">]</span><span class="op" id="2342872">,</span>&nbsp;<span class="ident" id="2342874">prevMatchEmpty</span><span class="op" id="2342888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2342892">prevMatchEmpty</span>&nbsp;<span class="op" id="2342907">=</span>&nbsp;<span class="ident" id="2342909">match</span>&nbsp;<span class="op" id="2342915">&amp;&amp;</span>&nbsp;<span class="ident" id="2342918">keylen</span>&nbsp;<span class="op" id="2342925">==</span>&nbsp;<span class="num" id="2342928">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2342932">if</span>&nbsp;<span class="ident" id="2342935">match</span>&nbsp;<span class="op" id="2342941">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2342946">wn</span><span class="op" id="2342948">,</span>&nbsp;<span class="ident" id="2342950">err</span>&nbsp;<span class="op" id="2342954">=</span>&nbsp;<span class="ident" id="2342956">sw</span><span class="op" id="2342958">.</span><span class="ident" id="2342959">WriteString</span><span class="op" id="2342970">(</span><span class="ident" id="2342971">s</span><span class="op" id="2342972">[</span><span class="ident" id="2342973">last</span><span class="op" id="2342977">:</span><span class="ident" id="2342978">i</span><span class="op" id="2342979">]</span><span class="op" id="2342980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2342985">n</span>&nbsp;<span class="op" id="2342987">+=</span>&nbsp;<span class="ident" id="2342990">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2342996">if</span>&nbsp;<span class="ident" id="2342999">err</span>&nbsp;<span class="op" id="2343003">!=</span>&nbsp;<span class="builtintype" id="2343006">nil</span>&nbsp;<span class="op" id="2343010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2343016">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2343026">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343031">wn</span><span class="op" id="2343033">,</span>&nbsp;<span class="ident" id="2343035">err</span>&nbsp;<span class="op" id="2343039">=</span>&nbsp;<span class="ident" id="2343041">sw</span><span class="op" id="2343043">.</span><span class="ident" id="2343044">WriteString</span><span class="op" id="2343055">(</span><span class="ident" id="2343056">val</span><span class="op" id="2343059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343064">n</span>&nbsp;<span class="op" id="2343066">+=</span>&nbsp;<span class="ident" id="2343069">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2343075">if</span>&nbsp;<span class="ident" id="2343078">err</span>&nbsp;<span class="op" id="2343082">!=</span>&nbsp;<span class="builtintype" id="2343085">nil</span>&nbsp;<span class="op" id="2343089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2343095">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2343105">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343110">i</span>&nbsp;<span class="op" id="2343112">+=</span>&nbsp;<span class="ident" id="2343115">keylen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343125">last</span>&nbsp;<span class="op" id="2343130">=</span>&nbsp;<span class="ident" id="2343132">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2343137">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2343148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343152">i</span><span class="op" id="2343153">++</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2343157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2343160">if</span>&nbsp;<span class="ident" id="2343163">last</span>&nbsp;<span class="op" id="2343168">!=</span>&nbsp;<span class="builtinfunc" id="2343171">len</span><span class="op" id="2343174">(</span><span class="ident" id="2343175">s</span><span class="op" id="2343176">)</span>&nbsp;<span class="op" id="2343178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343182">wn</span><span class="op" id="2343184">,</span>&nbsp;<span class="ident" id="2343186">err</span>&nbsp;<span class="op" id="2343190">=</span>&nbsp;<span class="ident" id="2343192">sw</span><span class="op" id="2343194">.</span><span class="ident" id="2343195">WriteString</span><span class="op" id="2343206">(</span><span class="ident" id="2343207">s</span><span class="op" id="2343208">[</span><span class="ident" id="2343209">last</span><span class="op" id="2343213">:</span><span class="op" id="2343214">]</span><span class="op" id="2343215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343219">n</span>&nbsp;<span class="op" id="2343221">+=</span>&nbsp;<span class="ident" id="2343224">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2343228">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2343231">return</span><br>
<span class="lineno"></span><span class="op" id="2343238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2343241">//&nbsp;singleStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;there&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="2343318">//&nbsp;one&nbsp;string&nbsp;to&nbsp;replace&nbsp;(and&nbsp;that&nbsp;string&nbsp;has&nbsp;more&nbsp;than&nbsp;one&nbsp;byte).</span><br>
<span class="lineno">355</span><span class="keyword" id="2343385">type</span>&nbsp;<span class="ident" id="2343390">singleStringReplacer</span>&nbsp;<span class="keyword" id="2343411">struct</span>&nbsp;<span class="op" id="2343418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343421">finder</span>&nbsp;<span class="op" id="2343428">*</span><span class="ident" id="2343429">stringFinder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2343443">//&nbsp;value&nbsp;is&nbsp;the&nbsp;new&nbsp;string&nbsp;that&nbsp;replaces&nbsp;that&nbsp;pattern&nbsp;when&nbsp;it&#39;s&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343515">value</span>&nbsp;<span class="builtintype" id="2343521">string</span><br>
<span class="lineno"></span><span class="op" id="2343528">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="2343531">func</span>&nbsp;<span class="ident" id="2343536">makeSingleStringReplacer</span><span class="op" id="2343560">(</span><span class="ident" id="2343561">pattern</span>&nbsp;<span class="builtintype" id="2343569">string</span><span class="op" id="2343575">,</span>&nbsp;<span class="ident" id="2343577">value</span>&nbsp;<span class="builtintype" id="2343583">string</span><span class="op" id="2343589">)</span>&nbsp;<span class="op" id="2343591">*</span><span class="ident" id="2343592">singleStringReplacer</span>&nbsp;<span class="op" id="2343613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2343616">return</span>&nbsp;<span class="op" id="2343623">&amp;</span><span class="ident" id="2343624">singleStringReplacer</span><span class="op" id="2343644">{</span><span class="ident" id="2343645">finder</span><span class="op" id="2343651">:</span>&nbsp;<span class="ident" id="2343653">makeStringFinder</span><span class="op" id="2343669">(</span><span class="ident" id="2343670">pattern</span><span class="op" id="2343677">)</span><span class="op" id="2343678">,</span>&nbsp;<span class="ident" id="2343680">value</span><span class="op" id="2343685">:</span>&nbsp;<span class="ident" id="2343687">value</span><span class="op" id="2343692">}</span><br>
<span class="lineno"></span><span class="op" id="2343694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="keyword" id="2343697">func</span>&nbsp;<span class="op" id="2343702">(</span><span class="ident" id="2343703">r</span>&nbsp;<span class="op" id="2343705">*</span><span class="ident" id="2343706">singleStringReplacer</span><span class="op" id="2343726">)</span>&nbsp;<span class="ident" id="2343728">Replace</span><span class="op" id="2343735">(</span><span class="ident" id="2343736">s</span>&nbsp;<span class="builtintype" id="2343738">string</span><span class="op" id="2343744">)</span>&nbsp;<span class="builtintype" id="2343746">string</span>&nbsp;<span class="op" id="2343753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2343756">var</span>&nbsp;<span class="ident" id="2343760">buf</span>&nbsp;<span class="op" id="2343764">[</span><span class="op" id="2343765">]</span><span class="builtintype" id="2343766">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343772">i</span><span class="op" id="2343773">,</span>&nbsp;<span class="ident" id="2343775">matched</span>&nbsp;<span class="op" id="2343783">:=</span>&nbsp;<span class="num" id="2343786">0</span><span class="op" id="2343787">,</span>&nbsp;<span class="builtintype" id="2343789">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2343796">for</span>&nbsp;<span class="op" id="2343800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343804">match</span>&nbsp;<span class="op" id="2343810">:=</span>&nbsp;<span class="ident" id="2343813">r</span><span class="op" id="2343814">.</span><span class="ident" id="2343815">finder</span><span class="op" id="2343821">.</span><span class="ident" id="2343822">next</span><span class="op" id="2343826">(</span><span class="ident" id="2343827">s</span><span class="op" id="2343828">[</span><span class="ident" id="2343829">i</span><span class="op" id="2343830">:</span><span class="op" id="2343831">]</span><span class="op" id="2343832">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2343836">if</span>&nbsp;<span class="ident" id="2343839">match</span>&nbsp;<span class="op" id="2343845">==</span>&nbsp;<span class="op" id="2343848">-</span><span class="num" id="2343849">1</span>&nbsp;<span class="op" id="2343851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2343856">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2343864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343868">matched</span>&nbsp;<span class="op" id="2343876">=</span>&nbsp;<span class="builtintype" id="2343878">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343885">buf</span>&nbsp;<span class="op" id="2343889">=</span>&nbsp;<span class="builtinfunc" id="2343891">append</span><span class="op" id="2343897">(</span><span class="ident" id="2343898">buf</span><span class="op" id="2343901">,</span>&nbsp;<span class="ident" id="2343903">s</span><span class="op" id="2343904">[</span><span class="ident" id="2343905">i</span><span class="op" id="2343906">:</span><span class="ident" id="2343907">i</span><span class="op" id="2343908">+</span><span class="ident" id="2343909">match</span><span class="op" id="2343914">]</span><span class="op" id="2343915">...</span><span class="op" id="2343918">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343922">buf</span>&nbsp;<span class="op" id="2343926">=</span>&nbsp;<span class="builtinfunc" id="2343928">append</span><span class="op" id="2343934">(</span><span class="ident" id="2343935">buf</span><span class="op" id="2343938">,</span>&nbsp;<span class="ident" id="2343940">r</span><span class="op" id="2343941">.</span><span class="ident" id="2343942">value</span><span class="op" id="2343947">...</span><span class="op" id="2343950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2343954">i</span>&nbsp;<span class="op" id="2343956">+=</span>&nbsp;<span class="ident" id="2343959">match</span>&nbsp;<span class="op" id="2343965">+</span>&nbsp;<span class="builtinfunc" id="2343967">len</span><span class="op" id="2343970">(</span><span class="ident" id="2343971">r</span><span class="op" id="2343972">.</span><span class="ident" id="2343973">finder</span><span class="op" id="2343979">.</span><span class="ident" id="2343980">pattern</span><span class="op" id="2343987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2343990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2343993">if</span>&nbsp;<span class="op" id="2343996">!</span><span class="ident" id="2343997">matched</span>&nbsp;<span class="op" id="2344005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344009">return</span>&nbsp;<span class="ident" id="2344016">s</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2344019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2344022">buf</span>&nbsp;<span class="op" id="2344026">=</span>&nbsp;<span class="builtinfunc" id="2344028">append</span><span class="op" id="2344034">(</span><span class="ident" id="2344035">buf</span><span class="op" id="2344038">,</span>&nbsp;<span class="ident" id="2344040">s</span><span class="op" id="2344041">[</span><span class="ident" id="2344042">i</span><span class="op" id="2344043">:</span><span class="op" id="2344044">]</span><span class="op" id="2344045">...</span><span class="op" id="2344048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344051">return</span>&nbsp;<span class="builtintype" id="2344058">string</span><span class="op" id="2344064">(</span><span class="ident" id="2344065">buf</span><span class="op" id="2344068">)</span><br>
<span class="lineno"></span><span class="op" id="2344070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="2344073">func</span>&nbsp;<span class="op" id="2344078">(</span><span class="ident" id="2344079">r</span>&nbsp;<span class="op" id="2344081">*</span><span class="ident" id="2344082">singleStringReplacer</span><span class="op" id="2344102">)</span>&nbsp;<span class="ident" id="2344104">WriteString</span><span class="op" id="2344115">(</span><span class="ident" id="2344116">w</span>&nbsp;<span class="ident" id="2344118">io</span><span class="op" id="2344120">.</span><span class="ident" id="2344121">Writer</span><span class="op" id="2344127">,</span>&nbsp;<span class="ident" id="2344129">s</span>&nbsp;<span class="builtintype" id="2344131">string</span><span class="op" id="2344137">)</span>&nbsp;<span class="op" id="2344139">(</span><span class="ident" id="2344140">n</span>&nbsp;<span class="builtintype" id="2344142">int</span><span class="op" id="2344145">,</span>&nbsp;<span class="ident" id="2344147">err</span>&nbsp;<span class="builtintype" id="2344151">error</span><span class="op" id="2344156">)</span>&nbsp;<span class="op" id="2344158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2344161">sw</span>&nbsp;<span class="op" id="2344164">:=</span>&nbsp;<span class="ident" id="2344167">getStringWriter</span><span class="op" id="2344182">(</span><span class="ident" id="2344183">w</span><span class="op" id="2344184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344187">var</span>&nbsp;<span class="ident" id="2344191">i</span><span class="op" id="2344192">,</span>&nbsp;<span class="ident" id="2344194">wn</span>&nbsp;<span class="builtintype" id="2344197">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344202">for</span>&nbsp;<span class="op" id="2344206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2344210">match</span>&nbsp;<span class="op" id="2344216">:=</span>&nbsp;<span class="ident" id="2344219">r</span><span class="op" id="2344220">.</span><span class="ident" id="2344221">finder</span><span class="op" id="2344227">.</span><span class="ident" id="2344228">next</span><span class="op" id="2344232">(</span><span class="ident" id="2344233">s</span><span class="op" id="2344234">[</span><span class="ident" id="2344235">i</span><span class="op" id="2344236">:</span><span class="op" id="2344237">]</span><span class="op" id="2344238">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344242">if</span>&nbsp;<span class="ident" id="2344245">match</span>&nbsp;<span class="op" id="2344251">==</span>&nbsp;<span class="op" id="2344254">-</span><span class="num" id="2344255">1</span>&nbsp;<span class="op" id="2344257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344262">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2344270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2344274">wn</span><span class="op" id="2344276">,</span>&nbsp;<span class="ident" id="2344278">err</span>&nbsp;<span class="op" id="2344282">=</span>&nbsp;<span class="ident" id="2344284">sw</span><span class="op" id="2344286">.</span><span class="ident" id="2344287">WriteString</span><span class="op" id="2344298">(</span><span class="ident" id="2344299">s</span><span class="op" id="2344300">[</span><span class="ident" id="2344301">i</span>&nbsp;<span class="op" id="2344303">:</span>&nbsp;<span class="ident" id="2344305">i</span><span class="op" id="2344306">+</span><span class="ident" id="2344307">match</span><span class="op" id="2344312">]</span><span class="op" id="2344313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2344317">n</span>&nbsp;<span class="op" id="2344319">+=</span>&nbsp;<span class="ident" id="2344322">wn</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344327">if</span>&nbsp;<span class="ident" id="2344330">err</span>&nbsp;<span class="op" id="2344334">!=</span>&nbsp;<span class="builtintype" id="2344337">nil</span>&nbsp;<span class="op" id="2344341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344346">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2344355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2344359">wn</span><span class="op" id="2344361">,</span>&nbsp;<span class="ident" id="2344363">err</span>&nbsp;<span class="op" id="2344367">=</span>&nbsp;<span class="ident" id="2344369">sw</span><span class="op" id="2344371">.</span><span class="ident" id="2344372">WriteString</span><span class="op" id="2344383">(</span><span class="ident" id="2344384">r</span><span class="op" id="2344385">.</span><span class="ident" id="2344386">value</span><span class="op" id="2344391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2344395">n</span>&nbsp;<span class="op" id="2344397">+=</span>&nbsp;<span class="ident" id="2344400">wn</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344405">if</span>&nbsp;<span class="ident" id="2344408">err</span>&nbsp;<span class="op" id="2344412">!=</span>&nbsp;<span class="builtintype" id="2344415">nil</span>&nbsp;<span class="op" id="2344419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344424">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2344433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2344437">i</span>&nbsp;<span class="op" id="2344439">+=</span>&nbsp;<span class="ident" id="2344442">match</span>&nbsp;<span class="op" id="2344448">+</span>&nbsp;<span class="builtinfunc" id="2344450">len</span><span class="op" id="2344453">(</span><span class="ident" id="2344454">r</span><span class="op" id="2344455">.</span><span class="ident" id="2344456">finder</span><span class="op" id="2344462">.</span><span class="ident" id="2344463">pattern</span><span class="op" id="2344470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2344473">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2344476">wn</span><span class="op" id="2344478">,</span>&nbsp;<span class="ident" id="2344480">err</span>&nbsp;<span class="op" id="2344484">=</span>&nbsp;<span class="ident" id="2344486">sw</span><span class="op" id="2344488">.</span><span class="ident" id="2344489">WriteString</span><span class="op" id="2344500">(</span><span class="ident" id="2344501">s</span><span class="op" id="2344502">[</span><span class="ident" id="2344503">i</span><span class="op" id="2344504">:</span><span class="op" id="2344505">]</span><span class="op" id="2344506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2344509">n</span>&nbsp;<span class="op" id="2344511">+=</span>&nbsp;<span class="ident" id="2344514">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344518">return</span><br>
<span class="lineno"></span><span class="op" id="2344525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="2344528">//&nbsp;byteReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the&nbsp;&#34;old&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2344597">//&nbsp;and&nbsp;&#34;new&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2344641">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;bytes&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="2344702">type</span>&nbsp;<span class="ident" id="2344707">byteReplacer</span>&nbsp;<span class="op" id="2344720">[</span><span class="num" id="2344721">256</span><span class="op" id="2344724">]</span><span class="builtintype" id="2344725">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="keyword" id="2344731">func</span>&nbsp;<span class="op" id="2344736">(</span><span class="ident" id="2344737">r</span>&nbsp;<span class="op" id="2344739">*</span><span class="ident" id="2344740">byteReplacer</span><span class="op" id="2344752">)</span>&nbsp;<span class="ident" id="2344754">Replace</span><span class="op" id="2344761">(</span><span class="ident" id="2344762">s</span>&nbsp;<span class="builtintype" id="2344764">string</span><span class="op" id="2344770">)</span>&nbsp;<span class="builtintype" id="2344772">string</span>&nbsp;<span class="op" id="2344779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344782">var</span>&nbsp;<span class="ident" id="2344786">buf</span>&nbsp;<span class="op" id="2344790">[</span><span class="op" id="2344791">]</span><span class="builtintype" id="2344792">byte</span>&nbsp;<span class="comment" id="2344797">//&nbsp;lazily&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344818">for</span>&nbsp;<span class="ident" id="2344822">i</span>&nbsp;<span class="op" id="2344824">:=</span>&nbsp;<span class="num" id="2344827">0</span><span class="op" id="2344828">;</span>&nbsp;<span class="ident" id="2344830">i</span>&nbsp;<span class="op" id="2344832">&lt;</span>&nbsp;<span class="builtinfunc" id="2344834">len</span><span class="op" id="2344837">(</span><span class="ident" id="2344838">s</span><span class="op" id="2344839">)</span><span class="op" id="2344840">;</span>&nbsp;<span class="ident" id="2344842">i</span><span class="op" id="2344843">++</span>&nbsp;<span class="op" id="2344846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2344850">b</span>&nbsp;<span class="op" id="2344852">:=</span>&nbsp;<span class="ident" id="2344855">s</span><span class="op" id="2344856">[</span><span class="ident" id="2344857">i</span><span class="op" id="2344858">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344862">if</span>&nbsp;<span class="ident" id="2344865">r</span><span class="op" id="2344866">[</span><span class="ident" id="2344867">b</span><span class="op" id="2344868">]</span>&nbsp;<span class="op" id="2344870">!=</span>&nbsp;<span class="ident" id="2344873">b</span>&nbsp;<span class="op" id="2344875">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344880">if</span>&nbsp;<span class="ident" id="2344883">buf</span>&nbsp;<span class="op" id="2344887">==</span>&nbsp;<span class="builtintype" id="2344890">nil</span>&nbsp;<span class="op" id="2344894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2344900">buf</span>&nbsp;<span class="op" id="2344904">=</span>&nbsp;<span class="op" id="2344906">[</span><span class="op" id="2344907">]</span><span class="builtintype" id="2344908">byte</span><span class="op" id="2344912">(</span><span class="ident" id="2344913">s</span><span class="op" id="2344914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2344919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2344924">buf</span><span class="op" id="2344927">[</span><span class="ident" id="2344928">i</span><span class="op" id="2344929">]</span>&nbsp;<span class="op" id="2344931">=</span>&nbsp;<span class="ident" id="2344933">r</span><span class="op" id="2344934">[</span><span class="ident" id="2344935">b</span><span class="op" id="2344936">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2344940">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2344943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344946">if</span>&nbsp;<span class="ident" id="2344949">buf</span>&nbsp;<span class="op" id="2344953">==</span>&nbsp;<span class="builtintype" id="2344956">nil</span>&nbsp;<span class="op" id="2344960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344964">return</span>&nbsp;<span class="ident" id="2344971">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2344974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2344977">return</span>&nbsp;<span class="builtintype" id="2344984">string</span><span class="op" id="2344990">(</span><span class="ident" id="2344991">buf</span><span class="op" id="2344994">)</span><br>
<span class="lineno">430</span><span class="op" id="2344996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2344999">func</span>&nbsp;<span class="op" id="2345004">(</span><span class="ident" id="2345005">r</span>&nbsp;<span class="op" id="2345007">*</span><span class="ident" id="2345008">byteReplacer</span><span class="op" id="2345020">)</span>&nbsp;<span class="ident" id="2345022">WriteString</span><span class="op" id="2345033">(</span><span class="ident" id="2345034">w</span>&nbsp;<span class="ident" id="2345036">io</span><span class="op" id="2345038">.</span><span class="ident" id="2345039">Writer</span><span class="op" id="2345045">,</span>&nbsp;<span class="ident" id="2345047">s</span>&nbsp;<span class="builtintype" id="2345049">string</span><span class="op" id="2345055">)</span>&nbsp;<span class="op" id="2345057">(</span><span class="ident" id="2345058">n</span>&nbsp;<span class="builtintype" id="2345060">int</span><span class="op" id="2345063">,</span>&nbsp;<span class="ident" id="2345065">err</span>&nbsp;<span class="builtintype" id="2345069">error</span><span class="op" id="2345074">)</span>&nbsp;<span class="op" id="2345076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2345079">//&nbsp;TODO(bradfitz):&nbsp;use&nbsp;io.WriteString&nbsp;with&nbsp;slices&nbsp;of&nbsp;s,&nbsp;avoiding&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2345157">bufsize</span>&nbsp;<span class="op" id="2345165">:=</span>&nbsp;<span class="num" id="2345168">32</span>&nbsp;<span class="op" id="2345171">&lt;&lt;</span>&nbsp;<span class="num" id="2345174">10</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2345178">if</span>&nbsp;<span class="builtinfunc" id="2345181">len</span><span class="op" id="2345184">(</span><span class="ident" id="2345185">s</span><span class="op" id="2345186">)</span>&nbsp;<span class="op" id="2345188">&lt;</span>&nbsp;<span class="ident" id="2345190">bufsize</span>&nbsp;<span class="op" id="2345198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2345202">bufsize</span>&nbsp;<span class="op" id="2345210">=</span>&nbsp;<span class="builtinfunc" id="2345212">len</span><span class="op" id="2345215">(</span><span class="ident" id="2345216">s</span><span class="op" id="2345217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2345220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2345223">buf</span>&nbsp;<span class="op" id="2345227">:=</span>&nbsp;<span class="builtinfunc" id="2345230">make</span><span class="op" id="2345234">(</span><span class="op" id="2345235">[</span><span class="op" id="2345236">]</span><span class="builtintype" id="2345237">byte</span><span class="op" id="2345241">,</span>&nbsp;<span class="ident" id="2345243">bufsize</span><span class="op" id="2345250">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2345254">for</span>&nbsp;<span class="builtinfunc" id="2345258">len</span><span class="op" id="2345261">(</span><span class="ident" id="2345262">s</span><span class="op" id="2345263">)</span>&nbsp;<span class="op" id="2345265">&gt;</span>&nbsp;<span class="num" id="2345267">0</span>&nbsp;<span class="op" id="2345269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2345273">ncopy</span>&nbsp;<span class="op" id="2345279">:=</span>&nbsp;<span class="builtinfunc" id="2345282">copy</span><span class="op" id="2345286">(</span><span class="ident" id="2345287">buf</span><span class="op" id="2345290">,</span>&nbsp;<span class="ident" id="2345292">s</span><span class="op" id="2345293">[</span><span class="op" id="2345294">:</span><span class="op" id="2345295">]</span><span class="op" id="2345296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2345300">s</span>&nbsp;<span class="op" id="2345302">=</span>&nbsp;<span class="ident" id="2345304">s</span><span class="op" id="2345305">[</span><span class="ident" id="2345306">ncopy</span><span class="op" id="2345311">:</span><span class="op" id="2345312">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2345316">for</span>&nbsp;<span class="ident" id="2345320">i</span><span class="op" id="2345321">,</span>&nbsp;<span class="ident" id="2345323">b</span>&nbsp;<span class="op" id="2345325">:=</span>&nbsp;<span class="keyword" id="2345328">range</span>&nbsp;<span class="ident" id="2345334">buf</span><span class="op" id="2345337">[</span><span class="op" id="2345338">:</span><span class="ident" id="2345339">ncopy</span><span class="op" id="2345344">]</span>&nbsp;<span class="op" id="2345346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2345351">buf</span><span class="op" id="2345354">[</span><span class="ident" id="2345355">i</span><span class="op" id="2345356">]</span>&nbsp;<span class="op" id="2345358">=</span>&nbsp;<span class="ident" id="2345360">r</span><span class="op" id="2345361">[</span><span class="ident" id="2345362">b</span><span class="op" id="2345363">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2345367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2345371">wn</span><span class="op" id="2345373">,</span>&nbsp;<span class="ident" id="2345375">err</span>&nbsp;<span class="op" id="2345379">:=</span>&nbsp;<span class="ident" id="2345382">w</span><span class="op" id="2345383">.</span><span class="ident" id="2345384">Write</span><span class="op" id="2345389">(</span><span class="ident" id="2345390">buf</span><span class="op" id="2345393">[</span><span class="op" id="2345394">:</span><span class="ident" id="2345395">ncopy</span><span class="op" id="2345400">]</span><span class="op" id="2345401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2345405">n</span>&nbsp;<span class="op" id="2345407">+=</span>&nbsp;<span class="ident" id="2345410">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2345415">if</span>&nbsp;<span class="ident" id="2345418">err</span>&nbsp;<span class="op" id="2345422">!=</span>&nbsp;<span class="builtintype" id="2345425">nil</span>&nbsp;<span class="op" id="2345429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2345434">return</span>&nbsp;<span class="ident" id="2345441">n</span><span class="op" id="2345442">,</span>&nbsp;<span class="ident" id="2345444">err</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2345450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2345453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2345456">return</span>&nbsp;<span class="ident" id="2345463">n</span><span class="op" id="2345464">,</span>&nbsp;<span class="builtintype" id="2345466">nil</span><br>
<span class="lineno"></span><span class="op" id="2345470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="2345473">//&nbsp;byteStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2345542">//&nbsp;&#34;old&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes&nbsp;but&nbsp;the&nbsp;&#34;new&#34;&nbsp;values&nbsp;vary&nbsp;in&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="2345616">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;byte&nbsp;slices&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="2345683">//&nbsp;A&nbsp;nil&nbsp;[]byte&nbsp;means&nbsp;that&nbsp;the&nbsp;old&nbsp;byte&nbsp;should&nbsp;not&nbsp;be&nbsp;replaced.</span><br>
<span class="lineno"></span><span class="keyword" id="2345747">type</span>&nbsp;<span class="ident" id="2345752">byteStringReplacer</span>&nbsp;<span class="op" id="2345771">[</span><span class="num" id="2345772">256</span><span class="op" id="2345775">]</span><span class="op" id="2345776">[</span><span class="op" id="2345777">]</span><span class="builtintype" id="2345778">byte</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="2345784">func</span>&nbsp;<span class="op" id="2345789">(</span><span class="ident" id="2345790">r</span>&nbsp;<span class="op" id="2345792">*</span><span class="ident" id="2345793">byteStringReplacer</span><span class="op" id="2345811">)</span>&nbsp;<span class="ident" id="2345813">Replace</span><span class="op" id="2345820">(</span><span class="ident" id="2345821">s</span>&nbsp;<span class="builtintype" id="2345823">string</span><span class="op" id="2345829">)</span>&nbsp;<span class="builtintype" id="2345831">string</span>&nbsp;<span class="op" id="2345838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2345841">newSize</span>&nbsp;<span class="op" id="2345849">:=</span>&nbsp;<span class="builtinfunc" id="2345852">len</span><span class="op" id="2345855">(</span><span class="ident" id="2345856">s</span><span class="op" id="2345857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2345860">anyChanges</span>&nbsp;<span class="op" id="2345871">:=</span>&nbsp;<span class="builtintype" id="2345874">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2345881">for</span>&nbsp;<span class="ident" id="2345885">i</span>&nbsp;<span class="op" id="2345887">:=</span>&nbsp;<span class="num" id="2345890">0</span><span class="op" id="2345891">;</span>&nbsp;<span class="ident" id="2345893">i</span>&nbsp;<span class="op" id="2345895">&lt;</span>&nbsp;<span class="builtinfunc" id="2345897">len</span><span class="op" id="2345900">(</span><span class="ident" id="2345901">s</span><span class="op" id="2345902">)</span><span class="op" id="2345903">;</span>&nbsp;<span class="ident" id="2345905">i</span><span class="op" id="2345906">++</span>&nbsp;<span class="op" id="2345909">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2345913">b</span>&nbsp;<span class="op" id="2345915">:=</span>&nbsp;<span class="ident" id="2345918">s</span><span class="op" id="2345919">[</span><span class="ident" id="2345920">i</span><span class="op" id="2345921">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2345925">if</span>&nbsp;<span class="ident" id="2345928">r</span><span class="op" id="2345929">[</span><span class="ident" id="2345930">b</span><span class="op" id="2345931">]</span>&nbsp;<span class="op" id="2345933">!=</span>&nbsp;<span class="builtintype" id="2345936">nil</span>&nbsp;<span class="op" id="2345940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2345945">anyChanges</span>&nbsp;<span class="op" id="2345956">=</span>&nbsp;<span class="builtintype" id="2345958">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2345966">//&nbsp;The&nbsp;-1&nbsp;is&nbsp;because&nbsp;we&nbsp;are&nbsp;replacing&nbsp;1&nbsp;byte&nbsp;with&nbsp;len(r[b])&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346036">newSize</span>&nbsp;<span class="op" id="2346044">+=</span>&nbsp;<span class="builtinfunc" id="2346047">len</span><span class="op" id="2346050">(</span><span class="ident" id="2346051">r</span><span class="op" id="2346052">[</span><span class="ident" id="2346053">b</span><span class="op" id="2346054">]</span><span class="op" id="2346055">)</span>&nbsp;<span class="op" id="2346057">-</span>&nbsp;<span class="num" id="2346059">1</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2346063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2346066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346069">if</span>&nbsp;<span class="op" id="2346072">!</span><span class="ident" id="2346073">anyChanges</span>&nbsp;<span class="op" id="2346084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346088">return</span>&nbsp;<span class="ident" id="2346095">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2346098">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346101">buf</span>&nbsp;<span class="op" id="2346105">:=</span>&nbsp;<span class="builtinfunc" id="2346108">make</span><span class="op" id="2346112">(</span><span class="op" id="2346113">[</span><span class="op" id="2346114">]</span><span class="builtintype" id="2346115">byte</span><span class="op" id="2346119">,</span>&nbsp;<span class="ident" id="2346121">newSize</span><span class="op" id="2346128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346131">bi</span>&nbsp;<span class="op" id="2346134">:=</span>&nbsp;<span class="ident" id="2346137">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346142">for</span>&nbsp;<span class="ident" id="2346146">i</span>&nbsp;<span class="op" id="2346148">:=</span>&nbsp;<span class="num" id="2346151">0</span><span class="op" id="2346152">;</span>&nbsp;<span class="ident" id="2346154">i</span>&nbsp;<span class="op" id="2346156">&lt;</span>&nbsp;<span class="builtinfunc" id="2346158">len</span><span class="op" id="2346161">(</span><span class="ident" id="2346162">s</span><span class="op" id="2346163">)</span><span class="op" id="2346164">;</span>&nbsp;<span class="ident" id="2346166">i</span><span class="op" id="2346167">++</span>&nbsp;<span class="op" id="2346170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346174">b</span>&nbsp;<span class="op" id="2346176">:=</span>&nbsp;<span class="ident" id="2346179">s</span><span class="op" id="2346180">[</span><span class="ident" id="2346181">i</span><span class="op" id="2346182">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346186">if</span>&nbsp;<span class="ident" id="2346189">r</span><span class="op" id="2346190">[</span><span class="ident" id="2346191">b</span><span class="op" id="2346192">]</span>&nbsp;<span class="op" id="2346194">!=</span>&nbsp;<span class="builtintype" id="2346197">nil</span>&nbsp;<span class="op" id="2346201">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346206">n</span>&nbsp;<span class="op" id="2346208">:=</span>&nbsp;<span class="builtinfunc" id="2346211">copy</span><span class="op" id="2346215">(</span><span class="ident" id="2346216">bi</span><span class="op" id="2346218">,</span>&nbsp;<span class="ident" id="2346220">r</span><span class="op" id="2346221">[</span><span class="ident" id="2346222">b</span><span class="op" id="2346223">]</span><span class="op" id="2346224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346229">bi</span>&nbsp;<span class="op" id="2346232">=</span>&nbsp;<span class="ident" id="2346234">bi</span><span class="op" id="2346236">[</span><span class="ident" id="2346237">n</span><span class="op" id="2346238">:</span><span class="op" id="2346239">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2346243">}</span>&nbsp;<span class="keyword" id="2346245">else</span>&nbsp;<span class="op" id="2346250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346255">bi</span><span class="op" id="2346257">[</span><span class="num" id="2346258">0</span><span class="op" id="2346259">]</span>&nbsp;<span class="op" id="2346261">=</span>&nbsp;<span class="ident" id="2346263">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346268">bi</span>&nbsp;<span class="op" id="2346271">=</span>&nbsp;<span class="ident" id="2346273">bi</span><span class="op" id="2346275">[</span><span class="num" id="2346276">1</span><span class="op" id="2346277">:</span><span class="op" id="2346278">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2346282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2346285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346288">return</span>&nbsp;<span class="builtintype" id="2346295">string</span><span class="op" id="2346301">(</span><span class="ident" id="2346302">buf</span><span class="op" id="2346305">)</span><br>
<span class="lineno"></span><span class="op" id="2346307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="keyword" id="2346310">func</span>&nbsp;<span class="op" id="2346315">(</span><span class="ident" id="2346316">r</span>&nbsp;<span class="op" id="2346318">*</span><span class="ident" id="2346319">byteStringReplacer</span><span class="op" id="2346337">)</span>&nbsp;<span class="ident" id="2346339">WriteString</span><span class="op" id="2346350">(</span><span class="ident" id="2346351">w</span>&nbsp;<span class="ident" id="2346353">io</span><span class="op" id="2346355">.</span><span class="ident" id="2346356">Writer</span><span class="op" id="2346362">,</span>&nbsp;<span class="ident" id="2346364">s</span>&nbsp;<span class="builtintype" id="2346366">string</span><span class="op" id="2346372">)</span>&nbsp;<span class="op" id="2346374">(</span><span class="ident" id="2346375">n</span>&nbsp;<span class="builtintype" id="2346377">int</span><span class="op" id="2346380">,</span>&nbsp;<span class="ident" id="2346382">err</span>&nbsp;<span class="builtintype" id="2346386">error</span><span class="op" id="2346391">)</span>&nbsp;<span class="op" id="2346393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346396">sw</span>&nbsp;<span class="op" id="2346399">:=</span>&nbsp;<span class="ident" id="2346402">getStringWriter</span><span class="op" id="2346417">(</span><span class="ident" id="2346418">w</span><span class="op" id="2346419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346422">last</span>&nbsp;<span class="op" id="2346427">:=</span>&nbsp;<span class="num" id="2346430">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346433">for</span>&nbsp;<span class="ident" id="2346437">i</span>&nbsp;<span class="op" id="2346439">:=</span>&nbsp;<span class="num" id="2346442">0</span><span class="op" id="2346443">;</span>&nbsp;<span class="ident" id="2346445">i</span>&nbsp;<span class="op" id="2346447">&lt;</span>&nbsp;<span class="builtinfunc" id="2346449">len</span><span class="op" id="2346452">(</span><span class="ident" id="2346453">s</span><span class="op" id="2346454">)</span><span class="op" id="2346455">;</span>&nbsp;<span class="ident" id="2346457">i</span><span class="op" id="2346458">++</span>&nbsp;<span class="op" id="2346461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346465">b</span>&nbsp;<span class="op" id="2346467">:=</span>&nbsp;<span class="ident" id="2346470">s</span><span class="op" id="2346471">[</span><span class="ident" id="2346472">i</span><span class="op" id="2346473">]</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346477">if</span>&nbsp;<span class="ident" id="2346480">r</span><span class="op" id="2346481">[</span><span class="ident" id="2346482">b</span><span class="op" id="2346483">]</span>&nbsp;<span class="op" id="2346485">==</span>&nbsp;<span class="builtintype" id="2346488">nil</span>&nbsp;<span class="op" id="2346492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346497">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2346508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346512">if</span>&nbsp;<span class="ident" id="2346515">last</span>&nbsp;<span class="op" id="2346520">!=</span>&nbsp;<span class="ident" id="2346523">i</span>&nbsp;<span class="op" id="2346525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346530">nw</span><span class="op" id="2346532">,</span>&nbsp;<span class="ident" id="2346534">err</span>&nbsp;<span class="op" id="2346538">:=</span>&nbsp;<span class="ident" id="2346541">sw</span><span class="op" id="2346543">.</span><span class="ident" id="2346544">WriteString</span><span class="op" id="2346555">(</span><span class="ident" id="2346556">s</span><span class="op" id="2346557">[</span><span class="ident" id="2346558">last</span><span class="op" id="2346562">:</span><span class="ident" id="2346563">i</span><span class="op" id="2346564">]</span><span class="op" id="2346565">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346570">n</span>&nbsp;<span class="op" id="2346572">+=</span>&nbsp;<span class="ident" id="2346575">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346581">if</span>&nbsp;<span class="ident" id="2346584">err</span>&nbsp;<span class="op" id="2346588">!=</span>&nbsp;<span class="builtintype" id="2346591">nil</span>&nbsp;<span class="op" id="2346595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346601">return</span>&nbsp;<span class="ident" id="2346608">n</span><span class="op" id="2346609">,</span>&nbsp;<span class="ident" id="2346611">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2346618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2346622">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346626">last</span>&nbsp;<span class="op" id="2346631">=</span>&nbsp;<span class="ident" id="2346633">i</span>&nbsp;<span class="op" id="2346635">+</span>&nbsp;<span class="num" id="2346637">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346641">nw</span><span class="op" id="2346643">,</span>&nbsp;<span class="ident" id="2346645">err</span>&nbsp;<span class="op" id="2346649">:=</span>&nbsp;<span class="ident" id="2346652">w</span><span class="op" id="2346653">.</span><span class="ident" id="2346654">Write</span><span class="op" id="2346659">(</span><span class="ident" id="2346660">r</span><span class="op" id="2346661">[</span><span class="ident" id="2346662">b</span><span class="op" id="2346663">]</span><span class="op" id="2346664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346668">n</span>&nbsp;<span class="op" id="2346670">+=</span>&nbsp;<span class="ident" id="2346673">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346678">if</span>&nbsp;<span class="ident" id="2346681">err</span>&nbsp;<span class="op" id="2346685">!=</span>&nbsp;<span class="builtintype" id="2346688">nil</span>&nbsp;<span class="op" id="2346692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346697">return</span>&nbsp;<span class="ident" id="2346704">n</span><span class="op" id="2346705">,</span>&nbsp;<span class="ident" id="2346707">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2346713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2346716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346719">if</span>&nbsp;<span class="ident" id="2346722">last</span>&nbsp;<span class="op" id="2346727">!=</span>&nbsp;<span class="builtinfunc" id="2346730">len</span><span class="op" id="2346733">(</span><span class="ident" id="2346734">s</span><span class="op" id="2346735">)</span>&nbsp;<span class="op" id="2346737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346741">var</span>&nbsp;<span class="ident" id="2346745">nw</span>&nbsp;<span class="builtintype" id="2346748">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346754">nw</span><span class="op" id="2346756">,</span>&nbsp;<span class="ident" id="2346758">err</span>&nbsp;<span class="op" id="2346762">=</span>&nbsp;<span class="ident" id="2346764">sw</span><span class="op" id="2346766">.</span><span class="ident" id="2346767">WriteString</span><span class="op" id="2346778">(</span><span class="ident" id="2346779">s</span><span class="op" id="2346780">[</span><span class="ident" id="2346781">last</span><span class="op" id="2346785">:</span><span class="op" id="2346786">]</span><span class="op" id="2346787">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2346791">n</span>&nbsp;<span class="op" id="2346793">+=</span>&nbsp;<span class="ident" id="2346796">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2346800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2346803">return</span><br>
<span class="lineno"></span><span class="op" id="2346810">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
