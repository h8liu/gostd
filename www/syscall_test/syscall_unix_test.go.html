<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">syscall_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;os&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Tests&nbsp;that&nbsp;below&nbsp;functions,&nbsp;structures&nbsp;and&nbsp;constants&nbsp;are&nbsp;consistent</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;on&nbsp;all&nbsp;Unix-like&nbsp;systems.</span><br>
<span class="lineno">25</span><span class="keyword">func</span>&nbsp;<span class="ident">_</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;program&nbsp;scheduling&nbsp;priority&nbsp;functions&nbsp;and&nbsp;constants</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Setpriority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Getpriority</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">PRIO_USER</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">PRIO_PROCESS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">PRIO_PGRP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;termios&nbsp;constants</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">TCIFLUSH</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">TCIOFLUSH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">TCOFLUSH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;fcntl&nbsp;file&nbsp;locking&nbsp;structure&nbsp;and&nbsp;constants</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Flock_t</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Type</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;<span class="builtintype">int16</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Whence</span><span class="op">:</span>&nbsp;<span class="builtintype">int16</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Start</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Len</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Pid</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">F_GETLK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">F_SETLK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">F_SETLKW</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;TestFcntlFlock&nbsp;tests&nbsp;whether&nbsp;the&nbsp;file&nbsp;locking&nbsp;structure&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;calling&nbsp;convention&nbsp;of&nbsp;each&nbsp;kernel.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestFcntlFlock</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">filepath</span><span class="op">.</span><span class="ident">Join</span><span class="op">(</span><span class="ident">os</span><span class="op">.</span><span class="ident">TempDir</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="string">&#34;TestFcntlFlock&#34;</span><span class="op">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fd</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Open</span><span class="op">(</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">O_CREAT</span><span class="op">|</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">O_RDWR</span><span class="op">|</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">O_CLOEXEC</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Open&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Unlink</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="ident">fd</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">flock</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Flock_t</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Type</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">F_RDLCK</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Start</span><span class="op">:</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">Len</span><span class="op">:</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">Whence</span><span class="op">:</span>&nbsp;<span class="num">1</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">FcntlFlock</span><span class="op">(</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">fd</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">F_GETLK</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">flock</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;FcntlFlock&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment">//&nbsp;TestPassFD&nbsp;tests&nbsp;passing&nbsp;a&nbsp;file&nbsp;descriptor&nbsp;over&nbsp;a&nbsp;Unix&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;This&nbsp;test&nbsp;involved&nbsp;both&nbsp;a&nbsp;parent&nbsp;and&nbsp;child&nbsp;process.&nbsp;The&nbsp;parent</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;process&nbsp;is&nbsp;invoked&nbsp;as&nbsp;a&nbsp;normal&nbsp;test,&nbsp;with&nbsp;&#34;go&nbsp;test&#34;,&nbsp;which&nbsp;then</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;runs&nbsp;the&nbsp;child&nbsp;process&nbsp;by&nbsp;running&nbsp;the&nbsp;current&nbsp;test&nbsp;binary&nbsp;with&nbsp;args</span><br>
<span class="lineno">85</span><span class="comment">//&nbsp;&#34;-test.run=^TestPassFD$&#34;&nbsp;and&nbsp;an&nbsp;environment&nbsp;variable&nbsp;used&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;that&nbsp;the&nbsp;test&nbsp;should&nbsp;become&nbsp;the&nbsp;child&nbsp;process&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestPassFD</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;dragonfly&#34;</span><span class="op">:</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO(jsing):&nbsp;Figure&nbsp;out&nbsp;why&nbsp;sendmsg&nbsp;is&nbsp;returning&nbsp;EINVAL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skip</span><span class="op">(</span><span class="string">&#34;skipping&nbsp;test&nbsp;on&nbsp;dragonfly&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;solaris&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO(aram):&nbsp;Figure&nbsp;out&nbsp;why&nbsp;ReadMsgUnix&nbsp;is&nbsp;returning&nbsp;empty&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skip</span><span class="op">(</span><span class="string">&#34;skipping&nbsp;test&nbsp;on&nbsp;solaris,&nbsp;see&nbsp;issue&nbsp;7402&#34;</span><span class="op">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">os</span><span class="op">.</span><span class="ident">Getenv</span><span class="op">(</span><span class="string">&#34;GO_WANT_HELPER_PROCESS&#34;</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;1&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">passFDChild</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tempDir</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ioutil</span><span class="op">.</span><span class="ident">TempDir</span><span class="op">(</span><span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;TestPassFD&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatal</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">os</span><span class="op">.</span><span class="ident">RemoveAll</span><span class="op">(</span><span class="ident">tempDir</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fds</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Socketpair</span><span class="op">(</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_LOCAL</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">SOCK_STREAM</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Socketpair:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="ident">fds</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="ident">fds</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">writeFile</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">os</span><span class="op">.</span><span class="ident">NewFile</span><span class="op">(</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">fds</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="string">&#34;child-writes&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">readFile</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">os</span><span class="op">.</span><span class="ident">NewFile</span><span class="op">(</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">fds</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="string">&#34;parent-reads&#34;</span><span class="op">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">writeFile</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">readFile</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cmd</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">exec</span><span class="op">.</span><span class="ident">Command</span><span class="op">(</span><span class="ident">os</span><span class="op">.</span><span class="ident">Args</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="string">&#34;-test.run=^TestPassFD$&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;--&#34;</span><span class="op">,</span>&nbsp;<span class="ident">tempDir</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cmd</span><span class="op">.</span><span class="ident">Env</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><span class="string">&#34;GO_WANT_HELPER_PROCESS=1&#34;</span><span class="op">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cmd</span><span class="op">.</span><span class="ident">ExtraFiles</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="op">*</span><span class="ident">os</span><span class="op">.</span><span class="ident">File</span><span class="op">{</span><span class="ident">writeFile</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">cmd</span><span class="op">.</span><span class="ident">CombinedOutput</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">out</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;child&nbsp;process:&nbsp;%q,&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">out</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">net</span><span class="op">.</span><span class="ident">FileConn</span><span class="op">(</span><span class="ident">readFile</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;FileConn:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uc</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">net</span><span class="op">.</span><span class="ident">UnixConn</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;unexpected&nbsp;FileConn&nbsp;type;&nbsp;expected&nbsp;UnixConn,&nbsp;got&nbsp;%T&#34;</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="num">32</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;expect&nbsp;1&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">oob</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="num">32</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;expect&nbsp;24&nbsp;bytes</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">closeUnix</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">AfterFunc</span><span class="op">(</span><span class="num">5</span><span class="op">*</span><span class="ident">time</span><span class="op">.</span><span class="ident">Second</span><span class="op">,</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Logf</span><span class="op">(</span><span class="string">&#34;timeout&nbsp;reading&nbsp;from&nbsp;unix&nbsp;socket&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uc</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">oobn</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">uc</span><span class="op">.</span><span class="ident">ReadMsgUnix</span><span class="op">(</span><span class="ident">buf</span><span class="op">,</span>&nbsp;<span class="ident">oob</span><span class="op">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">closeUnix</span><span class="op">.</span><span class="ident">Stop</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">scms</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">ParseSocketControlMessage</span><span class="op">(</span><span class="ident">oob</span><span class="op">[</span><span class="op">:</span><span class="ident">oobn</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ParseSocketControlMessage:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">scms</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;expected&nbsp;1&nbsp;SocketControlMessage;&nbsp;got&nbsp;scms&nbsp;=&nbsp;%#v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">scms</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">scm</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">scms</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gotFds</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">ParseUnixRights</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">scm</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;syscall.ParseUnixRights:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">gotFds</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;wanted&nbsp;1&nbsp;fd;&nbsp;got&nbsp;%#v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">gotFds</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">os</span><span class="op">.</span><span class="ident">NewFile</span><span class="op">(</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">gotFds</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="string">&#34;fd-from-child&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">got</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ioutil</span><span class="op">.</span><span class="ident">ReadAll</span><span class="op">(</span><span class="ident">f</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">want</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="string">&#34;Hello&nbsp;from&nbsp;child&nbsp;process!\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="ident">got</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">want</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;child&nbsp;process&nbsp;ReadAll:&nbsp;%q,&nbsp;%v;&nbsp;want&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">got</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="ident">want</span><span class="op">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;passFDChild&nbsp;is&nbsp;the&nbsp;child&nbsp;process&nbsp;used&nbsp;by&nbsp;TestPassFD.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">passFDChild</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">os</span><span class="op">.</span><span class="ident">Exit</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Look&nbsp;for&nbsp;our&nbsp;fd.&nbsp;It&nbsp;should&nbsp;be&nbsp;fd&nbsp;3,&nbsp;but&nbsp;we&nbsp;work&nbsp;around&nbsp;an&nbsp;fd&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;bug&nbsp;here&nbsp;(http://golang.org/issue/2603)&nbsp;to&nbsp;let&nbsp;it&nbsp;be&nbsp;elsewhere.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">uc</span>&nbsp;<span class="op">*</span><span class="ident">net</span><span class="op">.</span><span class="ident">UnixConn</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">fd</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uintptr</span><span class="op">(</span><span class="num">3</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">fd</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">10</span><span class="op">;</span>&nbsp;<span class="ident">fd</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">os</span><span class="op">.</span><span class="ident">NewFile</span><span class="op">(</span><span class="ident">fd</span><span class="op">,</span>&nbsp;<span class="string">&#34;unix-conn&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">netc</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">net</span><span class="op">.</span><span class="ident">FileConn</span><span class="op">(</span><span class="ident">f</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">uc</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">netc</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">net</span><span class="op">.</span><span class="ident">UnixConn</span><span class="op">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">uc</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Println</span><span class="op">(</span><span class="string">&#34;failed&nbsp;to&nbsp;find&nbsp;unix&nbsp;fd&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Make&nbsp;a&nbsp;file&nbsp;f&nbsp;to&nbsp;send&nbsp;to&nbsp;our&nbsp;parent&nbsp;process&nbsp;on&nbsp;uc.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;make&nbsp;it&nbsp;in&nbsp;tempDir,&nbsp;which&nbsp;our&nbsp;parent&nbsp;will&nbsp;clean&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">flag</span><span class="op">.</span><span class="ident">Parse</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tempDir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">flag</span><span class="op">.</span><span class="ident">Arg</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ioutil</span><span class="op">.</span><span class="ident">TempFile</span><span class="op">(</span><span class="ident">tempDir</span><span class="op">,</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Printf</span><span class="op">(</span><span class="string">&#34;TempFile:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="string">&#34;Hello&nbsp;from&nbsp;child&nbsp;process!\n&#34;</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">.</span><span class="ident">Seek</span><span class="op">(</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rights</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">UnixRights</span><span class="op">(</span><span class="builtintype">int</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">Fd</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dummyByte</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="string">&#34;x&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">oobn</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">uc</span><span class="op">.</span><span class="ident">WriteMsgUnix</span><span class="op">(</span><span class="ident">dummyByte</span><span class="op">,</span>&nbsp;<span class="ident">rights</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Printf</span><span class="op">(</span><span class="string">&#34;WriteMsgUnix:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">oobn</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">rights</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Printf</span><span class="op">(</span><span class="string">&#34;WriteMsgUnix&nbsp;=&nbsp;%d,&nbsp;%d;&nbsp;want&nbsp;1,&nbsp;%d&#34;</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">oobn</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">rights</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span><span class="comment">//&nbsp;TestUnixRightsRoundtrip&nbsp;tests&nbsp;that&nbsp;UnixRights,&nbsp;ParseSocketControlMessage,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;and&nbsp;ParseUnixRights&nbsp;are&nbsp;able&nbsp;to&nbsp;successfully&nbsp;round-trip&nbsp;lists&nbsp;of&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestUnixRightsRoundtrip</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">testCases</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">[</span><span class="op">...</span><span class="op">]</span><span class="op">[</span><span class="op">]</span><span class="op">[</span><span class="op">]</span><span class="builtintype">int</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="op">{</span><span class="num">42</span><span class="op">}</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="op">{</span><span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">}</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="op">{</span><span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">}</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="op">{</span><span class="op">}</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="op">{</span><span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="op">{</span><span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="op">{</span><span class="num">7</span><span class="op">}</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">testCase</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">testCases</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">fds</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">testCase</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Last&nbsp;assignment&nbsp;to&nbsp;n&nbsp;wins</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">CmsgLen</span><span class="op">(</span><span class="num">4</span><span class="op">*</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">fds</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">UnixRights</span><span class="op">(</span><span class="ident">fds</span><span class="op">...</span><span class="op">)</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Truncate&nbsp;b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">[</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">scms</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">ParseSocketControlMessage</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ParseSocketControlMessage:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">scms</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">testCase</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;expected&nbsp;%v&nbsp;SocketControlMessage;&nbsp;got&nbsp;scms&nbsp;=&nbsp;%#v&#34;</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">testCase</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">scms</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">scm</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">scms</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gotFds</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">ParseUnixRights</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">scm</span><span class="op">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ParseUnixRights:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wantFds</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">testCase</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">gotFds</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wantFds</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;expected&nbsp;%v&nbsp;fds,&nbsp;got&nbsp;%#v&#34;</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wantFds</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">gotFds</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span><span class="op">,</span>&nbsp;<span class="ident">fd</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">gotFds</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fd</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">wantFds</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;expected&nbsp;fd&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wantFds</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">fd</span><span class="op">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestRlimit</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">rlimit</span><span class="op">,</span>&nbsp;<span class="ident">zero</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Rlimit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Getrlimit</span><span class="op">(</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">RLIMIT_NOFILE</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">rlimit</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Getrlimit:&nbsp;save&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">zero</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">rlimit</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Getrlimit:&nbsp;save&nbsp;failed:&nbsp;got&nbsp;zero&nbsp;value&nbsp;%#v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">rlimit</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">set</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">rlimit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">set</span><span class="op">.</span><span class="ident">Cur</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">set</span><span class="op">.</span><span class="ident">Max</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Setrlimit</span><span class="op">(</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">RLIMIT_NOFILE</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">set</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Setrlimit:&nbsp;set&nbsp;failed:&nbsp;%#v&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">set</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">get</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Rlimit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Getrlimit</span><span class="op">(</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">RLIMIT_NOFILE</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">get</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Getrlimit:&nbsp;get&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">set</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">rlimit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">set</span><span class="op">.</span><span class="ident">Cur</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">set</span><span class="op">.</span><span class="ident">Max</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">set</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">get</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Seems&nbsp;like&nbsp;Darwin&nbsp;requires&nbsp;some&nbsp;privilege&nbsp;to</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;increase&nbsp;the&nbsp;soft&nbsp;limit&nbsp;of&nbsp;rlimit&nbsp;sandbox,&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Setrlimit&nbsp;never&nbsp;reports&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;darwin&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Rlimit:&nbsp;change&nbsp;failed:&nbsp;wanted&nbsp;%#v&nbsp;got&nbsp;%#v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">set</span><span class="op">,</span>&nbsp;<span class="ident">get</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Setrlimit</span><span class="op">(</span><span class="ident">syscall</span><span class="op">.</span><span class="ident">RLIMIT_NOFILE</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">rlimit</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Setrlimit:&nbsp;restore&nbsp;failed:&nbsp;%#v&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">rlimit</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestSeekFailure</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">Seek</span><span class="op">(</span><span class="op">-</span><span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Seek(-1,&nbsp;0,&nbsp;0)&nbsp;did&nbsp;not&nbsp;fail&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">str</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">err</span><span class="op">.</span><span class="ident">Error</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;used&nbsp;to&nbsp;crash&nbsp;on&nbsp;Linux</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Logf</span><span class="op">(</span><span class="string">&#34;Seek:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">str</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">str</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Seek(-1,&nbsp;0,&nbsp;0)&nbsp;return&nbsp;error&nbsp;with&nbsp;empty&nbsp;message&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
