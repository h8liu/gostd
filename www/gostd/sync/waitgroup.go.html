<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html" class="current">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1456185">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1456240">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1456294">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1456345">package</span>&nbsp;<span class="ident" id="1456353">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1456359">import</span>&nbsp;<span class="op" id="1456366">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1456369">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1456384">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1456393">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1456396">//&nbsp;A&nbsp;WaitGroup&nbsp;waits&nbsp;for&nbsp;a&nbsp;collection&nbsp;of&nbsp;goroutines&nbsp;to&nbsp;finish.</span><br>
<span class="lineno"></span><span class="comment" id="1456459">//&nbsp;The&nbsp;main&nbsp;goroutine&nbsp;calls&nbsp;Add&nbsp;to&nbsp;set&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1456512">//&nbsp;goroutines&nbsp;to&nbsp;wait&nbsp;for.&nbsp;&nbsp;Then&nbsp;each&nbsp;of&nbsp;the&nbsp;goroutines</span><br>
<span class="lineno">15</span><span class="comment" id="1456568">//&nbsp;runs&nbsp;and&nbsp;calls&nbsp;Done&nbsp;when&nbsp;finished.&nbsp;&nbsp;At&nbsp;the&nbsp;same&nbsp;time,</span><br>
<span class="lineno"></span><span class="comment" id="1456625">//&nbsp;Wait&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;block&nbsp;until&nbsp;all&nbsp;goroutines&nbsp;have&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="1456690">type</span>&nbsp;<span class="ident" id="1456695">WaitGroup</span>&nbsp;<span class="keyword" id="1456705">struct</span>&nbsp;<span class="op" id="1456712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1456715">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1456723">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1456730">counter</span>&nbsp;<span class="builtintype" id="1456738">int32</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1456745">waiters</span>&nbsp;<span class="builtintype" id="1456753">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1456760">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1456768">*</span><span class="builtintype" id="1456769">uint32</span><br>
<span class="lineno"></span><span class="op" id="1456776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1456779">//&nbsp;WaitGroup&nbsp;creates&nbsp;a&nbsp;new&nbsp;semaphore&nbsp;each&nbsp;time&nbsp;the&nbsp;old&nbsp;semaphore</span><br>
<span class="lineno">25</span><span class="comment" id="1456844">//&nbsp;is&nbsp;released.&nbsp;This&nbsp;is&nbsp;to&nbsp;avoid&nbsp;the&nbsp;following&nbsp;race:</span><br>
<span class="lineno"></span><span class="comment" id="1456897">//</span><br>
<span class="lineno"></span><span class="comment" id="1456900">//&nbsp;G1:&nbsp;Add(1)</span><br>
<span class="lineno"></span><span class="comment" id="1456914">//&nbsp;G1:&nbsp;go&nbsp;G2()</span><br>
<span class="lineno"></span><span class="comment" id="1456929">//&nbsp;G1:&nbsp;Wait()&nbsp;//&nbsp;Context&nbsp;switch&nbsp;after&nbsp;Unlock()&nbsp;and&nbsp;before&nbsp;Semacquire().</span><br>
<span class="lineno">30</span><span class="comment" id="1457001">//&nbsp;G2:&nbsp;Done()&nbsp;//&nbsp;Release&nbsp;semaphore:&nbsp;sema&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.&nbsp;G1&nbsp;doesn&#39;t&nbsp;run&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="1457082">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;Finds&nbsp;counter&nbsp;==&nbsp;0,&nbsp;waiters&nbsp;==&nbsp;0,&nbsp;doesn&#39;t&nbsp;block.</span><br>
<span class="lineno"></span><span class="comment" id="1457148">//&nbsp;G3:&nbsp;Add(1)&nbsp;//&nbsp;Makes&nbsp;counter&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1457199">//&nbsp;G3:&nbsp;go&nbsp;G4()</span><br>
<span class="lineno"></span><span class="comment" id="1457214">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;G1&nbsp;still&nbsp;hasn&#39;t&nbsp;run,&nbsp;G3&nbsp;finds&nbsp;sema&nbsp;==&nbsp;1,&nbsp;unblocked!&nbsp;Bug.</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1457289">//&nbsp;Add&nbsp;adds&nbsp;delta,&nbsp;which&nbsp;may&nbsp;be&nbsp;negative,&nbsp;to&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="comment" id="1457357">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;becomes&nbsp;zero,&nbsp;all&nbsp;goroutines&nbsp;blocked&nbsp;on&nbsp;Wait&nbsp;are&nbsp;released.</span><br>
<span class="lineno"></span><span class="comment" id="1457434">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;goes&nbsp;negative,&nbsp;Add&nbsp;panics.</span><br>
<span class="lineno"></span><span class="comment" id="1457479">//</span><br>
<span class="lineno">40</span><span class="comment" id="1457482">//&nbsp;Note&nbsp;that&nbsp;calls&nbsp;with&nbsp;a&nbsp;positive&nbsp;delta&nbsp;that&nbsp;occur&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="1457559">//&nbsp;must&nbsp;happen&nbsp;before&nbsp;a&nbsp;Wait.&nbsp;Calls&nbsp;with&nbsp;a&nbsp;negative&nbsp;delta,&nbsp;or&nbsp;calls&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1457634">//&nbsp;positive&nbsp;delta&nbsp;that&nbsp;start&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;greater&nbsp;than&nbsp;zero,&nbsp;may&nbsp;happen</span><br>
<span class="lineno"></span><span class="comment" id="1457713">//&nbsp;at&nbsp;any&nbsp;time.</span><br>
<span class="lineno"></span><span class="comment" id="1457729">//&nbsp;Typically&nbsp;this&nbsp;means&nbsp;the&nbsp;calls&nbsp;to&nbsp;Add&nbsp;should&nbsp;execute&nbsp;before&nbsp;the&nbsp;statement</span><br>
<span class="lineno">45</span><span class="comment" id="1457806">//&nbsp;creating&nbsp;the&nbsp;goroutine&nbsp;or&nbsp;other&nbsp;event&nbsp;to&nbsp;be&nbsp;waited&nbsp;for.</span><br>
<span class="lineno"></span><span class="comment" id="1457865">//&nbsp;See&nbsp;the&nbsp;WaitGroup&nbsp;example.</span><br>
<span class="lineno"></span><span class="keyword" id="1457895">func</span>&nbsp;<span class="op" id="1457900">(</span><span class="ident" id="1457901">wg</span>&nbsp;<span class="op" id="1457904">*</span><span class="ident" id="1457905">WaitGroup</span><span class="op" id="1457914">)</span>&nbsp;<span class="ident" id="1457916">Add</span><span class="op" id="1457919">(</span><span class="ident" id="1457920">delta</span>&nbsp;<span class="builtintype" id="1457926">int</span><span class="op" id="1457929">)</span>&nbsp;<span class="op" id="1457931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457934">if</span>&nbsp;<span class="ident" id="1457937">raceenabled</span>&nbsp;<span class="op" id="1457949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457953">_</span>&nbsp;<span class="op" id="1457955">=</span>&nbsp;<span class="ident" id="1457957">wg</span><span class="op" id="1457959">.</span><span class="ident" id="1457960">m</span><span class="op" id="1457961">.</span><span class="ident" id="1457962">state</span>&nbsp;<span class="comment" id="1457968">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457997">if</span>&nbsp;<span class="ident" id="1458000">delta</span>&nbsp;<span class="op" id="1458006">&lt;</span>&nbsp;<span class="num" id="1458008">0</span>&nbsp;<span class="op" id="1458010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458015">//&nbsp;Synchronize&nbsp;decrements&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458055">raceReleaseMerge</span><span class="op" id="1458071">(</span><span class="ident" id="1458072">unsafe</span><span class="op" id="1458078">.</span><span class="ident" id="1458079">Pointer</span><span class="op" id="1458086">(</span><span class="ident" id="1458087">wg</span><span class="op" id="1458089">)</span><span class="op" id="1458090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458098">raceDisable</span><span class="op" id="1458109">(</span><span class="op" id="1458110">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458114">defer</span>&nbsp;<span class="ident" id="1458120">raceEnable</span><span class="op" id="1458130">(</span><span class="op" id="1458131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458137">v</span>&nbsp;<span class="op" id="1458139">:=</span>&nbsp;<span class="ident" id="1458142">atomic</span><span class="op" id="1458148">.</span><span class="ident" id="1458149">AddInt32</span><span class="op" id="1458157">(</span><span class="op" id="1458158">&amp;</span><span class="ident" id="1458159">wg</span><span class="op" id="1458161">.</span><span class="ident" id="1458162">counter</span><span class="op" id="1458169">,</span>&nbsp;<span class="builtintype" id="1458171">int32</span><span class="op" id="1458176">(</span><span class="ident" id="1458177">delta</span><span class="op" id="1458182">)</span><span class="op" id="1458183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458186">if</span>&nbsp;<span class="ident" id="1458189">raceenabled</span>&nbsp;<span class="op" id="1458201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458205">if</span>&nbsp;<span class="ident" id="1458208">delta</span>&nbsp;<span class="op" id="1458214">&gt;</span>&nbsp;<span class="num" id="1458216">0</span>&nbsp;<span class="op" id="1458218">&amp;&amp;</span>&nbsp;<span class="ident" id="1458221">v</span>&nbsp;<span class="op" id="1458223">==</span>&nbsp;<span class="builtintype" id="1458226">int32</span><span class="op" id="1458231">(</span><span class="ident" id="1458232">delta</span><span class="op" id="1458237">)</span>&nbsp;<span class="op" id="1458239">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458244">//&nbsp;The&nbsp;first&nbsp;increment&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458302">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;as&nbsp;a&nbsp;read,&nbsp;because&nbsp;there&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458359">//&nbsp;several&nbsp;concurrent&nbsp;wg.counter&nbsp;transitions&nbsp;from&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458415">raceRead</span><span class="op" id="1458423">(</span><span class="ident" id="1458424">unsafe</span><span class="op" id="1458430">.</span><span class="ident" id="1458431">Pointer</span><span class="op" id="1458438">(</span><span class="op" id="1458439">&amp;</span><span class="ident" id="1458440">wg</span><span class="op" id="1458442">.</span><span class="ident" id="1458443">sema</span><span class="op" id="1458447">)</span><span class="op" id="1458448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458452">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458458">if</span>&nbsp;<span class="ident" id="1458461">v</span>&nbsp;<span class="op" id="1458463">&lt;</span>&nbsp;<span class="num" id="1458465">0</span>&nbsp;<span class="op" id="1458467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1458471">panic</span><span class="op" id="1458476">(</span><span class="string" id="1458477">&#34;sync:&nbsp;negative&nbsp;WaitGroup&nbsp;counter&#34;</span><span class="op" id="1458511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458517">if</span>&nbsp;<span class="ident" id="1458520">v</span>&nbsp;<span class="op" id="1458522">&gt;</span>&nbsp;<span class="num" id="1458524">0</span>&nbsp;<span class="op" id="1458526">||</span>&nbsp;<span class="ident" id="1458529">atomic</span><span class="op" id="1458535">.</span><span class="ident" id="1458536">LoadInt32</span><span class="op" id="1458545">(</span><span class="op" id="1458546">&amp;</span><span class="ident" id="1458547">wg</span><span class="op" id="1458549">.</span><span class="ident" id="1458550">waiters</span><span class="op" id="1458557">)</span>&nbsp;<span class="op" id="1458559">==</span>&nbsp;<span class="num" id="1458562">0</span>&nbsp;<span class="op" id="1458564">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458568">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458579">wg</span><span class="op" id="1458581">.</span><span class="ident" id="1458582">m</span><span class="op" id="1458583">.</span><span class="ident" id="1458584">Lock</span><span class="op" id="1458588">(</span><span class="op" id="1458589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458592">if</span>&nbsp;<span class="ident" id="1458595">atomic</span><span class="op" id="1458601">.</span><span class="ident" id="1458602">LoadInt32</span><span class="op" id="1458611">(</span><span class="op" id="1458612">&amp;</span><span class="ident" id="1458613">wg</span><span class="op" id="1458615">.</span><span class="ident" id="1458616">counter</span><span class="op" id="1458623">)</span>&nbsp;<span class="op" id="1458625">==</span>&nbsp;<span class="num" id="1458628">0</span>&nbsp;<span class="op" id="1458630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458634">for</span>&nbsp;<span class="ident" id="1458638">i</span>&nbsp;<span class="op" id="1458640">:=</span>&nbsp;<span class="builtintype" id="1458643">int32</span><span class="op" id="1458648">(</span><span class="num" id="1458649">0</span><span class="op" id="1458650">)</span><span class="op" id="1458651">;</span>&nbsp;<span class="ident" id="1458653">i</span>&nbsp;<span class="op" id="1458655">&lt;</span>&nbsp;<span class="ident" id="1458657">wg</span><span class="op" id="1458659">.</span><span class="ident" id="1458660">waiters</span><span class="op" id="1458667">;</span>&nbsp;<span class="ident" id="1458669">i</span><span class="op" id="1458670">++</span>&nbsp;<span class="op" id="1458673">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458678">runtime_Semrelease</span><span class="op" id="1458696">(</span><span class="ident" id="1458697">wg</span><span class="op" id="1458699">.</span><span class="ident" id="1458700">sema</span><span class="op" id="1458704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458712">wg</span><span class="op" id="1458714">.</span><span class="ident" id="1458715">waiters</span>&nbsp;<span class="op" id="1458723">=</span>&nbsp;<span class="num" id="1458725">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458729">wg</span><span class="op" id="1458731">.</span><span class="ident" id="1458732">sema</span>&nbsp;<span class="op" id="1458737">=</span>&nbsp;<span class="ident" id="1458739">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458744">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458747">wg</span><span class="op" id="1458749">.</span><span class="ident" id="1458750">m</span><span class="op" id="1458751">.</span><span class="ident" id="1458752">Unlock</span><span class="op" id="1458758">(</span><span class="op" id="1458759">)</span><br>
<span class="lineno"></span><span class="op" id="1458761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1458764">//&nbsp;Done&nbsp;decrements&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="1458806">func</span>&nbsp;<span class="op" id="1458811">(</span><span class="ident" id="1458812">wg</span>&nbsp;<span class="op" id="1458815">*</span><span class="ident" id="1458816">WaitGroup</span><span class="op" id="1458825">)</span>&nbsp;<span class="ident" id="1458827">Done</span><span class="op" id="1458831">(</span><span class="op" id="1458832">)</span>&nbsp;<span class="op" id="1458834">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458837">wg</span><span class="op" id="1458839">.</span><span class="ident" id="1458840">Add</span><span class="op" id="1458843">(</span><span class="op" id="1458844">-</span><span class="num" id="1458845">1</span><span class="op" id="1458846">)</span><br>
<span class="lineno"></span><span class="op" id="1458848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1458851">//&nbsp;Wait&nbsp;blocks&nbsp;until&nbsp;the&nbsp;WaitGroup&nbsp;counter&nbsp;is&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="1458903">func</span>&nbsp;<span class="op" id="1458908">(</span><span class="ident" id="1458909">wg</span>&nbsp;<span class="op" id="1458912">*</span><span class="ident" id="1458913">WaitGroup</span><span class="op" id="1458922">)</span>&nbsp;<span class="ident" id="1458924">Wait</span><span class="op" id="1458928">(</span><span class="op" id="1458929">)</span>&nbsp;<span class="op" id="1458931">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458934">if</span>&nbsp;<span class="ident" id="1458937">raceenabled</span>&nbsp;<span class="op" id="1458949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458953">_</span>&nbsp;<span class="op" id="1458955">=</span>&nbsp;<span class="ident" id="1458957">wg</span><span class="op" id="1458959">.</span><span class="ident" id="1458960">m</span><span class="op" id="1458961">.</span><span class="ident" id="1458962">state</span>&nbsp;<span class="comment" id="1458968">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458997">raceDisable</span><span class="op" id="1459008">(</span><span class="op" id="1459009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459015">if</span>&nbsp;<span class="ident" id="1459018">atomic</span><span class="op" id="1459024">.</span><span class="ident" id="1459025">LoadInt32</span><span class="op" id="1459034">(</span><span class="op" id="1459035">&amp;</span><span class="ident" id="1459036">wg</span><span class="op" id="1459038">.</span><span class="ident" id="1459039">counter</span><span class="op" id="1459046">)</span>&nbsp;<span class="op" id="1459048">==</span>&nbsp;<span class="num" id="1459051">0</span>&nbsp;<span class="op" id="1459053">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459057">if</span>&nbsp;<span class="ident" id="1459060">raceenabled</span>&nbsp;<span class="op" id="1459072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459077">raceEnable</span><span class="op" id="1459087">(</span><span class="op" id="1459088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459093">raceAcquire</span><span class="op" id="1459104">(</span><span class="ident" id="1459105">unsafe</span><span class="op" id="1459111">.</span><span class="ident" id="1459112">Pointer</span><span class="op" id="1459119">(</span><span class="ident" id="1459120">wg</span><span class="op" id="1459122">)</span><span class="op" id="1459123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459131">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459142">wg</span><span class="op" id="1459144">.</span><span class="ident" id="1459145">m</span><span class="op" id="1459146">.</span><span class="ident" id="1459147">Lock</span><span class="op" id="1459151">(</span><span class="op" id="1459152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459155">w</span>&nbsp;<span class="op" id="1459157">:=</span>&nbsp;<span class="ident" id="1459160">atomic</span><span class="op" id="1459166">.</span><span class="ident" id="1459167">AddInt32</span><span class="op" id="1459175">(</span><span class="op" id="1459176">&amp;</span><span class="ident" id="1459177">wg</span><span class="op" id="1459179">.</span><span class="ident" id="1459180">waiters</span><span class="op" id="1459187">,</span>&nbsp;<span class="num" id="1459189">1</span><span class="op" id="1459190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459193">//&nbsp;This&nbsp;code&nbsp;is&nbsp;racing&nbsp;with&nbsp;the&nbsp;unlocked&nbsp;path&nbsp;in&nbsp;Add&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459254">//&nbsp;The&nbsp;code&nbsp;above&nbsp;modifies&nbsp;counter&nbsp;and&nbsp;then&nbsp;reads&nbsp;waiters.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459314">//&nbsp;We&nbsp;must&nbsp;modify&nbsp;waiters&nbsp;and&nbsp;then&nbsp;read&nbsp;counter&nbsp;(the&nbsp;opposite&nbsp;order)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459384">//&nbsp;to&nbsp;avoid&nbsp;missing&nbsp;an&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459413">if</span>&nbsp;<span class="ident" id="1459416">atomic</span><span class="op" id="1459422">.</span><span class="ident" id="1459423">LoadInt32</span><span class="op" id="1459432">(</span><span class="op" id="1459433">&amp;</span><span class="ident" id="1459434">wg</span><span class="op" id="1459436">.</span><span class="ident" id="1459437">counter</span><span class="op" id="1459444">)</span>&nbsp;<span class="op" id="1459446">==</span>&nbsp;<span class="num" id="1459449">0</span>&nbsp;<span class="op" id="1459451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459455">atomic</span><span class="op" id="1459461">.</span><span class="ident" id="1459462">AddInt32</span><span class="op" id="1459470">(</span><span class="op" id="1459471">&amp;</span><span class="ident" id="1459472">wg</span><span class="op" id="1459474">.</span><span class="ident" id="1459475">waiters</span><span class="op" id="1459482">,</span>&nbsp;<span class="op" id="1459484">-</span><span class="num" id="1459485">1</span><span class="op" id="1459486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459490">if</span>&nbsp;<span class="ident" id="1459493">raceenabled</span>&nbsp;<span class="op" id="1459505">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459510">raceEnable</span><span class="op" id="1459520">(</span><span class="op" id="1459521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459526">raceAcquire</span><span class="op" id="1459537">(</span><span class="ident" id="1459538">unsafe</span><span class="op" id="1459544">.</span><span class="ident" id="1459545">Pointer</span><span class="op" id="1459552">(</span><span class="ident" id="1459553">wg</span><span class="op" id="1459555">)</span><span class="op" id="1459556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459561">raceDisable</span><span class="op" id="1459572">(</span><span class="op" id="1459573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459581">wg</span><span class="op" id="1459583">.</span><span class="ident" id="1459584">m</span><span class="op" id="1459585">.</span><span class="ident" id="1459586">Unlock</span><span class="op" id="1459592">(</span><span class="op" id="1459593">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459597">if</span>&nbsp;<span class="ident" id="1459600">raceenabled</span>&nbsp;<span class="op" id="1459612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459617">raceEnable</span><span class="op" id="1459627">(</span><span class="op" id="1459628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459636">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459644">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459647">if</span>&nbsp;<span class="ident" id="1459650">raceenabled</span>&nbsp;<span class="op" id="1459662">&amp;&amp;</span>&nbsp;<span class="ident" id="1459665">w</span>&nbsp;<span class="op" id="1459667">==</span>&nbsp;<span class="num" id="1459670">1</span>&nbsp;<span class="op" id="1459672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459676">//&nbsp;Wait&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;the&nbsp;first&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459727">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;is&nbsp;as&nbsp;a&nbsp;write&nbsp;to&nbsp;race&nbsp;with&nbsp;the&nbsp;read&nbsp;in&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459795">//&nbsp;As&nbsp;a&nbsp;consequence,&nbsp;can&nbsp;do&nbsp;the&nbsp;write&nbsp;only&nbsp;for&nbsp;the&nbsp;first&nbsp;waiter,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459862">//&nbsp;otherwise&nbsp;concurrent&nbsp;Waits&nbsp;will&nbsp;race&nbsp;with&nbsp;each&nbsp;other.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459921">raceWrite</span><span class="op" id="1459930">(</span><span class="ident" id="1459931">unsafe</span><span class="op" id="1459937">.</span><span class="ident" id="1459938">Pointer</span><span class="op" id="1459945">(</span><span class="op" id="1459946">&amp;</span><span class="ident" id="1459947">wg</span><span class="op" id="1459949">.</span><span class="ident" id="1459950">sema</span><span class="op" id="1459954">)</span><span class="op" id="1459955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459961">if</span>&nbsp;<span class="ident" id="1459964">wg</span><span class="op" id="1459966">.</span><span class="ident" id="1459967">sema</span>&nbsp;<span class="op" id="1459972">==</span>&nbsp;<span class="ident" id="1459975">nil</span>&nbsp;<span class="op" id="1459979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459983">wg</span><span class="op" id="1459985">.</span><span class="ident" id="1459986">sema</span>&nbsp;<span class="op" id="1459991">=</span>&nbsp;<span class="builtinfunc" id="1459993">new</span><span class="op" id="1459996">(</span><span class="builtintype" id="1459997">uint32</span><span class="op" id="1460003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1460006">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460009">s</span>&nbsp;<span class="op" id="1460011">:=</span>&nbsp;<span class="ident" id="1460014">wg</span><span class="op" id="1460016">.</span><span class="ident" id="1460017">sema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460023">wg</span><span class="op" id="1460025">.</span><span class="ident" id="1460026">m</span><span class="op" id="1460027">.</span><span class="ident" id="1460028">Unlock</span><span class="op" id="1460034">(</span><span class="op" id="1460035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460038">runtime_Semacquire</span><span class="op" id="1460056">(</span><span class="ident" id="1460057">s</span><span class="op" id="1460058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1460061">if</span>&nbsp;<span class="ident" id="1460064">raceenabled</span>&nbsp;<span class="op" id="1460076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460080">raceEnable</span><span class="op" id="1460090">(</span><span class="op" id="1460091">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460095">raceAcquire</span><span class="op" id="1460106">(</span><span class="ident" id="1460107">unsafe</span><span class="op" id="1460113">.</span><span class="ident" id="1460114">Pointer</span><span class="op" id="1460121">(</span><span class="ident" id="1460122">wg</span><span class="op" id="1460124">)</span><span class="op" id="1460125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1460128">}</span><br>
<span class="lineno"></span><span class="op" id="1460130">}</span>
</div>
</body>
</html>
