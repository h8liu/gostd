<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html" class="current">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6936337">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6936392">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6936446">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6936497">//&nbsp;Tests&nbsp;for&nbsp;package&nbsp;cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6936523">package</span>&nbsp;<span class="ident" id="6936531">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6936536">import</span>&nbsp;<span class="op" id="6936543">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936546">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936555">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936562">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936568">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936575">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936587">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936608">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936614">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936625">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936642">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936653">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936664">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936675">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6936686">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6936693">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6936696">func</span>&nbsp;<span class="ident" id="6936701">newRequest</span><span class="op" id="6936711">(</span><span class="ident" id="6936712">httpreq</span>&nbsp;<span class="builtintype" id="6936720">string</span><span class="op" id="6936726">)</span>&nbsp;<span class="op" id="6936728">*</span><span class="ident" id="6936729">http</span><span class="op" id="6936733">.</span><span class="ident" id="6936734">Request</span>&nbsp;<span class="op" id="6936742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6936745">buf</span>&nbsp;<span class="op" id="6936749">:=</span>&nbsp;<span class="ident" id="6936752">bufio</span><span class="op" id="6936757">.</span><span class="ident" id="6936758">NewReader</span><span class="op" id="6936767">(</span><span class="ident" id="6936768">strings</span><span class="op" id="6936775">.</span><span class="ident" id="6936776">NewReader</span><span class="op" id="6936785">(</span><span class="ident" id="6936786">httpreq</span><span class="op" id="6936793">)</span><span class="op" id="6936794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6936797">req</span><span class="op" id="6936800">,</span>&nbsp;<span class="ident" id="6936802">err</span>&nbsp;<span class="op" id="6936806">:=</span>&nbsp;<span class="ident" id="6936809">http</span><span class="op" id="6936813">.</span><span class="ident" id="6936814">ReadRequest</span><span class="op" id="6936825">(</span><span class="ident" id="6936826">buf</span><span class="op" id="6936829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6936832">if</span>&nbsp;<span class="ident" id="6936835">err</span>&nbsp;<span class="op" id="6936839">!=</span>&nbsp;<span class="ident" id="6936842">nil</span>&nbsp;<span class="op" id="6936846">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6936850">panic</span><span class="op" id="6936855">(</span><span class="string" id="6936856">&#34;cgi:&nbsp;bogus&nbsp;http&nbsp;request&nbsp;in&nbsp;test:&nbsp;&#34;</span>&nbsp;<span class="op" id="6936892">+</span>&nbsp;<span class="ident" id="6936894">httpreq</span><span class="op" id="6936901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6936904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6936907">req</span><span class="op" id="6936910">.</span><span class="ident" id="6936911">RemoteAddr</span>&nbsp;<span class="op" id="6936922">=</span>&nbsp;<span class="string" id="6936924">&#34;1.2.3.4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6936935">return</span>&nbsp;<span class="ident" id="6936942">req</span><br>
<span class="lineno"></span><span class="op" id="6936946">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="6936949">func</span>&nbsp;<span class="ident" id="6936954">runCgiTest</span><span class="op" id="6936964">(</span><span class="ident" id="6936965">t</span>&nbsp;<span class="op" id="6936967">*</span><span class="ident" id="6936968">testing</span><span class="op" id="6936975">.</span><span class="ident" id="6936976">T</span><span class="op" id="6936977">,</span>&nbsp;<span class="ident" id="6936979">h</span>&nbsp;<span class="op" id="6936981">*</span><span class="ident" id="6936982">Handler</span><span class="op" id="6936989">,</span>&nbsp;<span class="ident" id="6936991">httpreq</span>&nbsp;<span class="builtintype" id="6936999">string</span><span class="op" id="6937005">,</span>&nbsp;<span class="ident" id="6937007">expectedMap</span>&nbsp;<span class="keyword" id="6937019">map</span><span class="op" id="6937022">[</span><span class="builtintype" id="6937023">string</span><span class="op" id="6937029">]</span><span class="builtintype" id="6937030">string</span><span class="op" id="6937036">)</span>&nbsp;<span class="op" id="6937038">*</span><span class="ident" id="6937039">httptest</span><span class="op" id="6937047">.</span><span class="ident" id="6937048">ResponseRecorder</span>&nbsp;<span class="op" id="6937065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937068">rw</span>&nbsp;<span class="op" id="6937071">:=</span>&nbsp;<span class="ident" id="6937074">httptest</span><span class="op" id="6937082">.</span><span class="ident" id="6937083">NewRecorder</span><span class="op" id="6937094">(</span><span class="op" id="6937095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937098">req</span>&nbsp;<span class="op" id="6937102">:=</span>&nbsp;<span class="ident" id="6937105">newRequest</span><span class="op" id="6937115">(</span><span class="ident" id="6937116">httpreq</span><span class="op" id="6937123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937126">h</span><span class="op" id="6937127">.</span><span class="ident" id="6937128">ServeHTTP</span><span class="op" id="6937137">(</span><span class="ident" id="6937138">rw</span><span class="op" id="6937140">,</span>&nbsp;<span class="ident" id="6937142">req</span><span class="op" id="6937145">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6937149">//&nbsp;Make&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;the&nbsp;test&nbsp;map&nbsp;that&nbsp;the&nbsp;CGI&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937207">m</span>&nbsp;<span class="op" id="6937209">:=</span>&nbsp;<span class="builtinfunc" id="6937212">make</span><span class="op" id="6937216">(</span><span class="keyword" id="6937217">map</span><span class="op" id="6937220">[</span><span class="builtintype" id="6937221">string</span><span class="op" id="6937227">]</span><span class="builtintype" id="6937228">string</span><span class="op" id="6937234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937237">m</span><span class="op" id="6937238">[</span><span class="string" id="6937239">&#34;_body&#34;</span><span class="op" id="6937246">]</span>&nbsp;<span class="op" id="6937248">=</span>&nbsp;<span class="ident" id="6937250">rw</span><span class="op" id="6937252">.</span><span class="ident" id="6937253">Body</span><span class="op" id="6937257">.</span><span class="ident" id="6937258">String</span><span class="op" id="6937264">(</span><span class="op" id="6937265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937268">linesRead</span>&nbsp;<span class="op" id="6937278">:=</span>&nbsp;<span class="num" id="6937281">0</span><br>
<span class="lineno">45</span><span class="ident" id="6937283">readlines</span><span class="op" id="6937292">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937295">for</span>&nbsp;<span class="op" id="6937299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937303">line</span><span class="op" id="6937307">,</span>&nbsp;<span class="ident" id="6937309">err</span>&nbsp;<span class="op" id="6937313">:=</span>&nbsp;<span class="ident" id="6937316">rw</span><span class="op" id="6937318">.</span><span class="ident" id="6937319">Body</span><span class="op" id="6937323">.</span><span class="ident" id="6937324">ReadString</span><span class="op" id="6937334">(</span><span class="string" id="6937335">&#39;\n&#39;</span><span class="op" id="6937339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937343">switch</span>&nbsp;<span class="op" id="6937350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937354">case</span>&nbsp;<span class="ident" id="6937359">err</span>&nbsp;<span class="op" id="6937363">==</span>&nbsp;<span class="ident" id="6937366">io</span><span class="op" id="6937368">.</span><span class="ident" id="6937369">EOF</span><span class="op" id="6937372">:</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937377">break</span>&nbsp;<span class="ident" id="6937383">readlines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937395">case</span>&nbsp;<span class="ident" id="6937400">err</span>&nbsp;<span class="op" id="6937404">!=</span>&nbsp;<span class="ident" id="6937407">nil</span><span class="op" id="6937410">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937415">t</span><span class="op" id="6937416">.</span><span class="ident" id="6937417">Fatalf</span><span class="op" id="6937423">(</span><span class="string" id="6937424">&#34;unexpected&nbsp;error&nbsp;reading&nbsp;from&nbsp;CGI:&nbsp;%v&#34;</span><span class="op" id="6937463">,</span>&nbsp;<span class="ident" id="6937465">err</span><span class="op" id="6937468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6937472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937476">linesRead</span><span class="op" id="6937485">++</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937490">trimmedLine</span>&nbsp;<span class="op" id="6937502">:=</span>&nbsp;<span class="ident" id="6937505">strings</span><span class="op" id="6937512">.</span><span class="ident" id="6937513">TrimRight</span><span class="op" id="6937522">(</span><span class="ident" id="6937523">line</span><span class="op" id="6937527">,</span>&nbsp;<span class="string" id="6937529">&#34;\r\n&#34;</span><span class="op" id="6937535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937539">split</span>&nbsp;<span class="op" id="6937545">:=</span>&nbsp;<span class="ident" id="6937548">strings</span><span class="op" id="6937555">.</span><span class="ident" id="6937556">SplitN</span><span class="op" id="6937562">(</span><span class="ident" id="6937563">trimmedLine</span><span class="op" id="6937574">,</span>&nbsp;<span class="string" id="6937576">&#34;=&#34;</span><span class="op" id="6937579">,</span>&nbsp;<span class="num" id="6937581">2</span><span class="op" id="6937582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937586">if</span>&nbsp;<span class="builtinfunc" id="6937589">len</span><span class="op" id="6937592">(</span><span class="ident" id="6937593">split</span><span class="op" id="6937598">)</span>&nbsp;<span class="op" id="6937600">!=</span>&nbsp;<span class="num" id="6937603">2</span>&nbsp;<span class="op" id="6937605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937610">t</span><span class="op" id="6937611">.</span><span class="ident" id="6937612">Fatalf</span><span class="op" id="6937618">(</span><span class="string" id="6937619">&#34;Unexpected&nbsp;%d&nbsp;parts&nbsp;from&nbsp;invalid&nbsp;line&nbsp;number&nbsp;%v:&nbsp;%q;&nbsp;existing&nbsp;map=%v&#34;</span><span class="op" id="6937689">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6937695">len</span><span class="op" id="6937698">(</span><span class="ident" id="6937699">split</span><span class="op" id="6937704">)</span><span class="op" id="6937705">,</span>&nbsp;<span class="ident" id="6937707">linesRead</span><span class="op" id="6937716">,</span>&nbsp;<span class="ident" id="6937718">line</span><span class="op" id="6937722">,</span>&nbsp;<span class="ident" id="6937724">m</span><span class="op" id="6937725">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6937729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937733">m</span><span class="op" id="6937734">[</span><span class="ident" id="6937735">split</span><span class="op" id="6937740">[</span><span class="num" id="6937741">0</span><span class="op" id="6937742">]</span><span class="op" id="6937743">]</span>&nbsp;<span class="op" id="6937745">=</span>&nbsp;<span class="ident" id="6937747">split</span><span class="op" id="6937752">[</span><span class="num" id="6937753">1</span><span class="op" id="6937754">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6937757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937761">for</span>&nbsp;<span class="ident" id="6937765">key</span><span class="op" id="6937768">,</span>&nbsp;<span class="ident" id="6937770">expected</span>&nbsp;<span class="op" id="6937779">:=</span>&nbsp;<span class="keyword" id="6937782">range</span>&nbsp;<span class="ident" id="6937788">expectedMap</span>&nbsp;<span class="op" id="6937800">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937804">got</span>&nbsp;<span class="op" id="6937808">:=</span>&nbsp;<span class="ident" id="6937811">m</span><span class="op" id="6937812">[</span><span class="ident" id="6937813">key</span><span class="op" id="6937816">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937820">if</span>&nbsp;<span class="ident" id="6937823">key</span>&nbsp;<span class="op" id="6937827">==</span>&nbsp;<span class="string" id="6937830">&#34;cwd&#34;</span>&nbsp;<span class="op" id="6937836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6937841">//&nbsp;For&nbsp;Windows.&nbsp;golang.org/issue/4645.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937883">fi1</span><span class="op" id="6937886">,</span>&nbsp;<span class="ident" id="6937888">_</span>&nbsp;<span class="op" id="6937890">:=</span>&nbsp;<span class="ident" id="6937893">os</span><span class="op" id="6937895">.</span><span class="ident" id="6937896">Stat</span><span class="op" id="6937900">(</span><span class="ident" id="6937901">got</span><span class="op" id="6937904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937909">fi2</span><span class="op" id="6937912">,</span>&nbsp;<span class="ident" id="6937914">_</span>&nbsp;<span class="op" id="6937916">:=</span>&nbsp;<span class="ident" id="6937919">os</span><span class="op" id="6937921">.</span><span class="ident" id="6937922">Stat</span><span class="op" id="6937926">(</span><span class="ident" id="6937927">expected</span><span class="op" id="6937935">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937940">if</span>&nbsp;<span class="ident" id="6937943">os</span><span class="op" id="6937945">.</span><span class="ident" id="6937946">SameFile</span><span class="op" id="6937954">(</span><span class="ident" id="6937955">fi1</span><span class="op" id="6937958">,</span>&nbsp;<span class="ident" id="6937960">fi2</span><span class="op" id="6937963">)</span>&nbsp;<span class="op" id="6937965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6937971">got</span>&nbsp;<span class="op" id="6937975">=</span>&nbsp;<span class="ident" id="6937977">expected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6937989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6937993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6937997">if</span>&nbsp;<span class="ident" id="6938000">got</span>&nbsp;<span class="op" id="6938004">!=</span>&nbsp;<span class="ident" id="6938007">expected</span>&nbsp;<span class="op" id="6938016">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938021">t</span><span class="op" id="6938022">.</span><span class="ident" id="6938023">Errorf</span><span class="op" id="6938029">(</span><span class="string" id="6938030">&#34;for&nbsp;key&nbsp;%q&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6938062">,</span>&nbsp;<span class="ident" id="6938064">key</span><span class="op" id="6938067">,</span>&nbsp;<span class="ident" id="6938069">got</span><span class="op" id="6938072">,</span>&nbsp;<span class="ident" id="6938074">expected</span><span class="op" id="6938082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6938086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6938089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938092">return</span>&nbsp;<span class="ident" id="6938099">rw</span><br>
<span class="lineno"></span><span class="op" id="6938102">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="6938105">var</span>&nbsp;<span class="ident" id="6938109">cgiTested</span><span class="op" id="6938118">,</span>&nbsp;<span class="ident" id="6938120">cgiWorks</span>&nbsp;<span class="builtintype" id="6938129">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6938135">func</span>&nbsp;<span class="ident" id="6938140">check</span><span class="op" id="6938145">(</span><span class="ident" id="6938146">t</span>&nbsp;<span class="op" id="6938148">*</span><span class="ident" id="6938149">testing</span><span class="op" id="6938156">.</span><span class="ident" id="6938157">T</span><span class="op" id="6938158">)</span>&nbsp;<span class="op" id="6938160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938163">if</span>&nbsp;<span class="op" id="6938166">!</span><span class="ident" id="6938167">cgiTested</span>&nbsp;<span class="op" id="6938177">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938181">cgiTested</span>&nbsp;<span class="op" id="6938191">=</span>&nbsp;<span class="builtintype" id="6938193">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938200">cgiWorks</span>&nbsp;<span class="op" id="6938209">=</span>&nbsp;<span class="ident" id="6938211">exec</span><span class="op" id="6938215">.</span><span class="ident" id="6938216">Command</span><span class="op" id="6938223">(</span><span class="string" id="6938224">&#34;./testdata/test.cgi&#34;</span><span class="op" id="6938245">)</span><span class="op" id="6938246">.</span><span class="ident" id="6938247">Run</span><span class="op" id="6938250">(</span><span class="op" id="6938251">)</span>&nbsp;<span class="op" id="6938253">==</span>&nbsp;<span class="ident" id="6938256">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6938261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6938264">if</span>&nbsp;<span class="op" id="6938267">!</span><span class="ident" id="6938268">cgiWorks</span>&nbsp;<span class="op" id="6938277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6938281">//&nbsp;No&nbsp;Perl&nbsp;on&nbsp;Windows,&nbsp;needed&nbsp;by&nbsp;test.cgi</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6938325">//&nbsp;TODO:&nbsp;make&nbsp;the&nbsp;child&nbsp;process&nbsp;be&nbsp;Go,&nbsp;not&nbsp;Perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938376">t</span><span class="op" id="6938377">.</span><span class="ident" id="6938378">Skip</span><span class="op" id="6938382">(</span><span class="string" id="6938383">&#34;Skipping&nbsp;test:&nbsp;test.cgi&nbsp;failed.&#34;</span><span class="op" id="6938416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6938419">}</span><br>
<span class="lineno"></span><span class="op" id="6938421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6938424">func</span>&nbsp;<span class="ident" id="6938429">TestCGIBasicGet</span><span class="op" id="6938444">(</span><span class="ident" id="6938445">t</span>&nbsp;<span class="op" id="6938447">*</span><span class="ident" id="6938448">testing</span><span class="op" id="6938455">.</span><span class="ident" id="6938456">T</span><span class="op" id="6938457">)</span>&nbsp;<span class="op" id="6938459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938462">check</span><span class="op" id="6938467">(</span><span class="ident" id="6938468">t</span><span class="op" id="6938469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938472">h</span>&nbsp;<span class="op" id="6938474">:=</span>&nbsp;<span class="op" id="6938477">&amp;</span><span class="ident" id="6938478">Handler</span><span class="op" id="6938485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938489">Path</span><span class="op" id="6938493">:</span>&nbsp;<span class="string" id="6938495">&#34;testdata/test.cgi&#34;</span><span class="op" id="6938514">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938518">Root</span><span class="op" id="6938522">:</span>&nbsp;<span class="string" id="6938524">&#34;/test.cgi&#34;</span><span class="op" id="6938535">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6938538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6938541">expectedMap</span>&nbsp;<span class="op" id="6938553">:=</span>&nbsp;<span class="keyword" id="6938556">map</span><span class="op" id="6938559">[</span><span class="builtintype" id="6938560">string</span><span class="op" id="6938566">]</span><span class="builtintype" id="6938567">string</span><span class="op" id="6938573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6938577">&#34;test&#34;</span><span class="op" id="6938583">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6938602">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="6938613">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6938617">&#34;param-a&#34;</span><span class="op" id="6938626">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6938642">&#34;b&#34;</span><span class="op" id="6938645">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6938649">&#34;param-foo&#34;</span><span class="op" id="6938660">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6938674">&#34;bar&#34;</span><span class="op" id="6938679">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6938683">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="6938706">:</span>&nbsp;<span class="string" id="6938708">&#34;CGI/1.1&#34;</span><span class="op" id="6938717">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6938721">&#34;env-HTTP_HOST&#34;</span><span class="op" id="6938736">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6938746">&#34;example.com&#34;</span><span class="op" id="6938759">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6938763">&#34;env-PATH_INFO&#34;</span><span class="op" id="6938778">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6938788">&#34;&#34;</span><span class="op" id="6938790">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6938794">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6938812">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6938819">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="6938832">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6938836">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="6938853">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6938861">&#34;1.2.3.4&#34;</span><span class="op" id="6938870">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6938874">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="6938891">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6938899">&#34;1.2.3.4&#34;</span><span class="op" id="6938908">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6938912">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="6938932">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6938937">&#34;GET&#34;</span><span class="op" id="6938942">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6938946">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6938963">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6938971">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="6938994">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6938998">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6939019">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6939023">&#34;testdata/test.cgi&#34;</span><span class="op" id="6939042">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6939046">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6939063">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6939071">&#34;/test.cgi&#34;</span><span class="op" id="6939082">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6939086">&#34;env-SERVER_NAME&#34;</span><span class="op" id="6939103">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6939111">&#34;example.com&#34;</span><span class="op" id="6939124">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6939128">&#34;env-SERVER_PORT&#34;</span><span class="op" id="6939145">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6939153">&#34;80&#34;</span><span class="op" id="6939157">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6939161">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="6939182">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6939186">&#34;go&#34;</span><span class="op" id="6939190">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6939193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939196">replay</span>&nbsp;<span class="op" id="6939203">:=</span>&nbsp;<span class="ident" id="6939206">runCgiTest</span><span class="op" id="6939216">(</span><span class="ident" id="6939217">t</span><span class="op" id="6939218">,</span>&nbsp;<span class="ident" id="6939220">h</span><span class="op" id="6939221">,</span>&nbsp;<span class="string" id="6939223">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6939282">,</span>&nbsp;<span class="ident" id="6939284">expectedMap</span><span class="op" id="6939295">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6939299">if</span>&nbsp;<span class="ident" id="6939302">expected</span><span class="op" id="6939310">,</span>&nbsp;<span class="ident" id="6939312">got</span>&nbsp;<span class="op" id="6939316">:=</span>&nbsp;<span class="string" id="6939319">&#34;text/html&#34;</span><span class="op" id="6939330">,</span>&nbsp;<span class="ident" id="6939332">replay</span><span class="op" id="6939338">.</span><span class="ident" id="6939339">Header</span><span class="op" id="6939345">(</span><span class="op" id="6939346">)</span><span class="op" id="6939347">.</span><span class="ident" id="6939348">Get</span><span class="op" id="6939351">(</span><span class="string" id="6939352">&#34;Content-Type&#34;</span><span class="op" id="6939366">)</span><span class="op" id="6939367">;</span>&nbsp;<span class="ident" id="6939369">got</span>&nbsp;<span class="op" id="6939373">!=</span>&nbsp;<span class="ident" id="6939376">expected</span>&nbsp;<span class="op" id="6939385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939389">t</span><span class="op" id="6939390">.</span><span class="ident" id="6939391">Errorf</span><span class="op" id="6939397">(</span><span class="string" id="6939398">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6939437">,</span>&nbsp;<span class="ident" id="6939439">got</span><span class="op" id="6939442">,</span>&nbsp;<span class="ident" id="6939444">expected</span><span class="op" id="6939452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6939455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6939458">if</span>&nbsp;<span class="ident" id="6939461">expected</span><span class="op" id="6939469">,</span>&nbsp;<span class="ident" id="6939471">got</span>&nbsp;<span class="op" id="6939475">:=</span>&nbsp;<span class="string" id="6939478">&#34;X-Test-Value&#34;</span><span class="op" id="6939492">,</span>&nbsp;<span class="ident" id="6939494">replay</span><span class="op" id="6939500">.</span><span class="ident" id="6939501">Header</span><span class="op" id="6939507">(</span><span class="op" id="6939508">)</span><span class="op" id="6939509">.</span><span class="ident" id="6939510">Get</span><span class="op" id="6939513">(</span><span class="string" id="6939514">&#34;X-Test-Header&#34;</span><span class="op" id="6939529">)</span><span class="op" id="6939530">;</span>&nbsp;<span class="ident" id="6939532">got</span>&nbsp;<span class="op" id="6939536">!=</span>&nbsp;<span class="ident" id="6939539">expected</span>&nbsp;<span class="op" id="6939548">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939552">t</span><span class="op" id="6939553">.</span><span class="ident" id="6939554">Errorf</span><span class="op" id="6939560">(</span><span class="string" id="6939561">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6939601">,</span>&nbsp;<span class="ident" id="6939603">got</span><span class="op" id="6939606">,</span>&nbsp;<span class="ident" id="6939608">expected</span><span class="op" id="6939616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6939619">}</span><br>
<span class="lineno"></span><span class="op" id="6939621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6939624">func</span>&nbsp;<span class="ident" id="6939629">TestCGIBasicGetAbsPath</span><span class="op" id="6939651">(</span><span class="ident" id="6939652">t</span>&nbsp;<span class="op" id="6939654">*</span><span class="ident" id="6939655">testing</span><span class="op" id="6939662">.</span><span class="ident" id="6939663">T</span><span class="op" id="6939664">)</span>&nbsp;<span class="op" id="6939666">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939669">check</span><span class="op" id="6939674">(</span><span class="ident" id="6939675">t</span><span class="op" id="6939676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939679">pwd</span><span class="op" id="6939682">,</span>&nbsp;<span class="ident" id="6939684">err</span>&nbsp;<span class="op" id="6939688">:=</span>&nbsp;<span class="ident" id="6939691">os</span><span class="op" id="6939693">.</span><span class="ident" id="6939694">Getwd</span><span class="op" id="6939699">(</span><span class="op" id="6939700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6939703">if</span>&nbsp;<span class="ident" id="6939706">err</span>&nbsp;<span class="op" id="6939710">!=</span>&nbsp;<span class="ident" id="6939713">nil</span>&nbsp;<span class="op" id="6939717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939721">t</span><span class="op" id="6939722">.</span><span class="ident" id="6939723">Fatalf</span><span class="op" id="6939729">(</span><span class="string" id="6939730">&#34;getwd&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6939747">,</span>&nbsp;<span class="ident" id="6939749">err</span><span class="op" id="6939752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6939755">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939758">h</span>&nbsp;<span class="op" id="6939760">:=</span>&nbsp;<span class="op" id="6939763">&amp;</span><span class="ident" id="6939764">Handler</span><span class="op" id="6939771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939775">Path</span><span class="op" id="6939779">:</span>&nbsp;<span class="ident" id="6939781">pwd</span>&nbsp;<span class="op" id="6939785">+</span>&nbsp;<span class="string" id="6939787">&#34;/testdata/test.cgi&#34;</span><span class="op" id="6939807">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939811">Root</span><span class="op" id="6939815">:</span>&nbsp;<span class="string" id="6939817">&#34;/test.cgi&#34;</span><span class="op" id="6939828">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6939831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6939834">expectedMap</span>&nbsp;<span class="op" id="6939846">:=</span>&nbsp;<span class="keyword" id="6939849">map</span><span class="op" id="6939852">[</span><span class="builtintype" id="6939853">string</span><span class="op" id="6939859">]</span><span class="builtintype" id="6939860">string</span><span class="op" id="6939866">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6939870">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6939887">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6939893">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="6939916">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6939920">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6939941">:</span>&nbsp;<span class="ident" id="6939943">pwd</span>&nbsp;<span class="op" id="6939947">+</span>&nbsp;<span class="string" id="6939949">&#34;/testdata/test.cgi&#34;</span><span class="op" id="6939969">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6939973">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6939990">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6939996">&#34;/test.cgi&#34;</span><span class="op" id="6940007">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6940010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6940013">runCgiTest</span><span class="op" id="6940023">(</span><span class="ident" id="6940024">t</span><span class="op" id="6940025">,</span>&nbsp;<span class="ident" id="6940027">h</span><span class="op" id="6940028">,</span>&nbsp;<span class="string" id="6940030">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6940089">,</span>&nbsp;<span class="ident" id="6940091">expectedMap</span><span class="op" id="6940102">)</span><br>
<span class="lineno">145</span><span class="op" id="6940104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6940107">func</span>&nbsp;<span class="ident" id="6940112">TestPathInfo</span><span class="op" id="6940124">(</span><span class="ident" id="6940125">t</span>&nbsp;<span class="op" id="6940127">*</span><span class="ident" id="6940128">testing</span><span class="op" id="6940135">.</span><span class="ident" id="6940136">T</span><span class="op" id="6940137">)</span>&nbsp;<span class="op" id="6940139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6940142">check</span><span class="op" id="6940147">(</span><span class="ident" id="6940148">t</span><span class="op" id="6940149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6940152">h</span>&nbsp;<span class="op" id="6940154">:=</span>&nbsp;<span class="op" id="6940157">&amp;</span><span class="ident" id="6940158">Handler</span><span class="op" id="6940165">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6940169">Path</span><span class="op" id="6940173">:</span>&nbsp;<span class="string" id="6940175">&#34;testdata/test.cgi&#34;</span><span class="op" id="6940194">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6940198">Root</span><span class="op" id="6940202">:</span>&nbsp;<span class="string" id="6940204">&#34;/test.cgi&#34;</span><span class="op" id="6940215">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6940218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6940221">expectedMap</span>&nbsp;<span class="op" id="6940233">:=</span>&nbsp;<span class="keyword" id="6940236">map</span><span class="op" id="6940239">[</span><span class="builtintype" id="6940240">string</span><span class="op" id="6940246">]</span><span class="builtintype" id="6940247">string</span><span class="op" id="6940253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6940257">&#34;param-a&#34;</span><span class="op" id="6940266">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6940280">&#34;b&#34;</span><span class="op" id="6940283">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6940287">&#34;env-PATH_INFO&#34;</span><span class="op" id="6940302">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6940310">&#34;/extrapath&#34;</span><span class="op" id="6940322">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6940326">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6940344">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6940349">&#34;a=b&#34;</span><span class="op" id="6940354">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6940358">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6940375">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6940381">&#34;/test.cgi/extrapath?a=b&#34;</span><span class="op" id="6940406">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6940410">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6940431">:</span>&nbsp;<span class="string" id="6940433">&#34;testdata/test.cgi&#34;</span><span class="op" id="6940452">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6940456">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6940473">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6940479">&#34;/test.cgi&#34;</span><span class="op" id="6940490">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6940493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6940496">runCgiTest</span><span class="op" id="6940506">(</span><span class="ident" id="6940507">t</span><span class="op" id="6940508">,</span>&nbsp;<span class="ident" id="6940510">h</span><span class="op" id="6940511">,</span>&nbsp;<span class="string" id="6940513">&#34;GET&nbsp;/test.cgi/extrapath?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6940574">,</span>&nbsp;<span class="ident" id="6940576">expectedMap</span><span class="op" id="6940587">)</span><br>
<span class="lineno"></span><span class="op" id="6940589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6940592">func</span>&nbsp;<span class="ident" id="6940597">TestPathInfoDirRoot</span><span class="op" id="6940616">(</span><span class="ident" id="6940617">t</span>&nbsp;<span class="op" id="6940619">*</span><span class="ident" id="6940620">testing</span><span class="op" id="6940627">.</span><span class="ident" id="6940628">T</span><span class="op" id="6940629">)</span>&nbsp;<span class="op" id="6940631">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6940634">check</span><span class="op" id="6940639">(</span><span class="ident" id="6940640">t</span><span class="op" id="6940641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6940644">h</span>&nbsp;<span class="op" id="6940646">:=</span>&nbsp;<span class="op" id="6940649">&amp;</span><span class="ident" id="6940650">Handler</span><span class="op" id="6940657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6940661">Path</span><span class="op" id="6940665">:</span>&nbsp;<span class="string" id="6940667">&#34;testdata/test.cgi&#34;</span><span class="op" id="6940686">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6940690">Root</span><span class="op" id="6940694">:</span>&nbsp;<span class="string" id="6940696">&#34;/myscript/&#34;</span><span class="op" id="6940708">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6940711">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6940714">expectedMap</span>&nbsp;<span class="op" id="6940726">:=</span>&nbsp;<span class="keyword" id="6940729">map</span><span class="op" id="6940732">[</span><span class="builtintype" id="6940733">string</span><span class="op" id="6940739">]</span><span class="builtintype" id="6940740">string</span><span class="op" id="6940746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6940750">&#34;env-PATH_INFO&#34;</span><span class="op" id="6940765">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6940773">&#34;bar&#34;</span><span class="op" id="6940778">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6940782">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6940800">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6940805">&#34;a=b&#34;</span><span class="op" id="6940810">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6940814">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6940831">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6940837">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="6940856">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6940860">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6940881">:</span>&nbsp;<span class="string" id="6940883">&#34;testdata/test.cgi&#34;</span><span class="op" id="6940902">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6940906">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6940923">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6940929">&#34;/myscript/&#34;</span><span class="op" id="6940941">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6940944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6940947">runCgiTest</span><span class="op" id="6940957">(</span><span class="ident" id="6940958">t</span><span class="op" id="6940959">,</span>&nbsp;<span class="ident" id="6940961">h</span><span class="op" id="6940962">,</span>&nbsp;<span class="string" id="6940964">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6941019">,</span>&nbsp;<span class="ident" id="6941021">expectedMap</span><span class="op" id="6941032">)</span><br>
<span class="lineno"></span><span class="op" id="6941034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6941037">func</span>&nbsp;<span class="ident" id="6941042">TestDupHeaders</span><span class="op" id="6941056">(</span><span class="ident" id="6941057">t</span>&nbsp;<span class="op" id="6941059">*</span><span class="ident" id="6941060">testing</span><span class="op" id="6941067">.</span><span class="ident" id="6941068">T</span><span class="op" id="6941069">)</span>&nbsp;<span class="op" id="6941071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941074">check</span><span class="op" id="6941079">(</span><span class="ident" id="6941080">t</span><span class="op" id="6941081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941084">h</span>&nbsp;<span class="op" id="6941086">:=</span>&nbsp;<span class="op" id="6941089">&amp;</span><span class="ident" id="6941090">Handler</span><span class="op" id="6941097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941101">Path</span><span class="op" id="6941105">:</span>&nbsp;<span class="string" id="6941107">&#34;testdata/test.cgi&#34;</span><span class="op" id="6941126">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6941129">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941132">expectedMap</span>&nbsp;<span class="op" id="6941144">:=</span>&nbsp;<span class="keyword" id="6941147">map</span><span class="op" id="6941150">[</span><span class="builtintype" id="6941151">string</span><span class="op" id="6941157">]</span><span class="builtintype" id="6941158">string</span><span class="op" id="6941164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941168">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6941185">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6941191">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="6941210">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941214">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6941235">:</span>&nbsp;<span class="string" id="6941237">&#34;testdata/test.cgi&#34;</span><span class="op" id="6941256">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941260">&#34;env-HTTP_COOKIE&#34;</span><span class="op" id="6941277">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6941283">&#34;nom=NOM;&nbsp;yum=YUM&#34;</span><span class="op" id="6941301">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941305">&#34;env-HTTP_X_FOO&#34;</span><span class="op" id="6941321">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6941328">&#34;val1,&nbsp;val2&#34;</span><span class="op" id="6941340">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6941343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941346">runCgiTest</span><span class="op" id="6941356">(</span><span class="ident" id="6941357">t</span><span class="op" id="6941358">,</span>&nbsp;<span class="ident" id="6941360">h</span><span class="op" id="6941361">,</span>&nbsp;<span class="string" id="6941363">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\n&#34;</span><span class="op" id="6941397">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941401">&#34;Cookie:&nbsp;nom=NOM\n&#34;</span><span class="op" id="6941420">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941424">&#34;Cookie:&nbsp;yum=YUM\n&#34;</span><span class="op" id="6941443">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941447">&#34;X-Foo:&nbsp;val1\n&#34;</span><span class="op" id="6941462">+</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941466">&#34;X-Foo:&nbsp;val2\n&#34;</span><span class="op" id="6941481">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941485">&#34;Host:&nbsp;example.com\n\n&#34;</span><span class="op" id="6941508">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941512">expectedMap</span><span class="op" id="6941523">)</span><br>
<span class="lineno"></span><span class="op" id="6941525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="6941528">func</span>&nbsp;<span class="ident" id="6941533">TestPathInfoNoRoot</span><span class="op" id="6941551">(</span><span class="ident" id="6941552">t</span>&nbsp;<span class="op" id="6941554">*</span><span class="ident" id="6941555">testing</span><span class="op" id="6941562">.</span><span class="ident" id="6941563">T</span><span class="op" id="6941564">)</span>&nbsp;<span class="op" id="6941566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941569">check</span><span class="op" id="6941574">(</span><span class="ident" id="6941575">t</span><span class="op" id="6941576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941579">h</span>&nbsp;<span class="op" id="6941581">:=</span>&nbsp;<span class="op" id="6941584">&amp;</span><span class="ident" id="6941585">Handler</span><span class="op" id="6941592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941596">Path</span><span class="op" id="6941600">:</span>&nbsp;<span class="string" id="6941602">&#34;testdata/test.cgi&#34;</span><span class="op" id="6941621">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941625">Root</span><span class="op" id="6941629">:</span>&nbsp;<span class="string" id="6941631">&#34;&#34;</span><span class="op" id="6941633">,</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6941636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941639">expectedMap</span>&nbsp;<span class="op" id="6941651">:=</span>&nbsp;<span class="keyword" id="6941654">map</span><span class="op" id="6941657">[</span><span class="builtintype" id="6941658">string</span><span class="op" id="6941664">]</span><span class="builtintype" id="6941665">string</span><span class="op" id="6941671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941675">&#34;env-PATH_INFO&#34;</span><span class="op" id="6941690">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6941698">&#34;/bar&#34;</span><span class="op" id="6941704">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941708">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6941726">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6941731">&#34;a=b&#34;</span><span class="op" id="6941736">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941740">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6941757">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6941763">&#34;/bar?a=b&#34;</span><span class="op" id="6941773">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941777">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6941798">:</span>&nbsp;<span class="string" id="6941800">&#34;testdata/test.cgi&#34;</span><span class="op" id="6941819">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6941823">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6941840">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6941846">&#34;/&#34;</span><span class="op" id="6941849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6941852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941855">runCgiTest</span><span class="op" id="6941865">(</span><span class="ident" id="6941866">t</span><span class="op" id="6941867">,</span>&nbsp;<span class="ident" id="6941869">h</span><span class="op" id="6941870">,</span>&nbsp;<span class="string" id="6941872">&#34;GET&nbsp;/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6941918">,</span>&nbsp;<span class="ident" id="6941920">expectedMap</span><span class="op" id="6941931">)</span><br>
<span class="lineno"></span><span class="op" id="6941933">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6941936">func</span>&nbsp;<span class="ident" id="6941941">TestCGIBasicPost</span><span class="op" id="6941957">(</span><span class="ident" id="6941958">t</span>&nbsp;<span class="op" id="6941960">*</span><span class="ident" id="6941961">testing</span><span class="op" id="6941968">.</span><span class="ident" id="6941969">T</span><span class="op" id="6941970">)</span>&nbsp;<span class="op" id="6941972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941975">check</span><span class="op" id="6941980">(</span><span class="ident" id="6941981">t</span><span class="op" id="6941982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6941985">postReq</span>&nbsp;<span class="op" id="6941993">:=</span>&nbsp;<span class="string" id="6941996">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno">220</span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Content-Length:&nbsp;15<br>
<span class="lineno"></span><br>
<span class="lineno"></span>postfoo=postbar`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6942129">h</span>&nbsp;<span class="op" id="6942131">:=</span>&nbsp;<span class="op" id="6942134">&amp;</span><span class="ident" id="6942135">Handler</span><span class="op" id="6942142">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6942146">Path</span><span class="op" id="6942150">:</span>&nbsp;<span class="string" id="6942152">&#34;testdata/test.cgi&#34;</span><span class="op" id="6942171">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6942175">Root</span><span class="op" id="6942179">:</span>&nbsp;<span class="string" id="6942181">&#34;/test.cgi&#34;</span><span class="op" id="6942192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6942195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6942198">expectedMap</span>&nbsp;<span class="op" id="6942210">:=</span>&nbsp;<span class="keyword" id="6942213">map</span><span class="op" id="6942216">[</span><span class="builtintype" id="6942217">string</span><span class="op" id="6942223">]</span><span class="builtintype" id="6942224">string</span><span class="op" id="6942230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6942234">&#34;test&#34;</span><span class="op" id="6942240">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6942256">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="6942267">,</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6942271">&#34;param-postfoo&#34;</span><span class="op" id="6942286">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6942293">&#34;postbar&#34;</span><span class="op" id="6942302">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6942306">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="6942326">:</span>&nbsp;<span class="string" id="6942328">&#34;POST&#34;</span><span class="op" id="6942334">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6942338">&#34;env-CONTENT_LENGTH&#34;</span><span class="op" id="6942358">:</span>&nbsp;<span class="string" id="6942360">&#34;15&#34;</span><span class="op" id="6942364">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6942368">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6942385">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6942390">&#34;/test.cgi?a=b&#34;</span><span class="op" id="6942405">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6942408">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6942411">runCgiTest</span><span class="op" id="6942421">(</span><span class="ident" id="6942422">t</span><span class="op" id="6942423">,</span>&nbsp;<span class="ident" id="6942425">h</span><span class="op" id="6942426">,</span>&nbsp;<span class="ident" id="6942428">postReq</span><span class="op" id="6942435">,</span>&nbsp;<span class="ident" id="6942437">expectedMap</span><span class="op" id="6942448">)</span><br>
<span class="lineno"></span><span class="op" id="6942450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6942453">func</span>&nbsp;<span class="ident" id="6942458">chunk</span><span class="op" id="6942463">(</span><span class="ident" id="6942464">s</span>&nbsp;<span class="builtintype" id="6942466">string</span><span class="op" id="6942472">)</span>&nbsp;<span class="builtintype" id="6942474">string</span>&nbsp;<span class="op" id="6942481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6942484">return</span>&nbsp;<span class="ident" id="6942491">fmt</span><span class="op" id="6942494">.</span><span class="ident" id="6942495">Sprintf</span><span class="op" id="6942502">(</span><span class="string" id="6942503">&#34;%x\r\n%s\r\n&#34;</span><span class="op" id="6942517">,</span>&nbsp;<span class="builtinfunc" id="6942519">len</span><span class="op" id="6942522">(</span><span class="ident" id="6942523">s</span><span class="op" id="6942524">)</span><span class="op" id="6942525">,</span>&nbsp;<span class="ident" id="6942527">s</span><span class="op" id="6942528">)</span><br>
<span class="lineno">240</span><span class="op" id="6942530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6942533">//&nbsp;The&nbsp;CGI&nbsp;spec&nbsp;doesn&#39;t&nbsp;allow&nbsp;chunked&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="6942581">func</span>&nbsp;<span class="ident" id="6942586">TestCGIPostChunked</span><span class="op" id="6942604">(</span><span class="ident" id="6942605">t</span>&nbsp;<span class="op" id="6942607">*</span><span class="ident" id="6942608">testing</span><span class="op" id="6942615">.</span><span class="ident" id="6942616">T</span><span class="op" id="6942617">)</span>&nbsp;<span class="op" id="6942619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6942622">check</span><span class="op" id="6942627">(</span><span class="ident" id="6942628">t</span><span class="op" id="6942629">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6942632">postReq</span>&nbsp;<span class="op" id="6942640">:=</span>&nbsp;<span class="string" id="6942643">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno"></span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Transfer-Encoding:&nbsp;chunked<br>
<span class="lineno"></span><br>
<span class="lineno">250</span>`</span>&nbsp;<span class="op" id="6942768">+</span>&nbsp;<span class="ident" id="6942770">chunk</span><span class="op" id="6942775">(</span><span class="string" id="6942776">&#34;postfoo&#34;</span><span class="op" id="6942785">)</span>&nbsp;<span class="op" id="6942787">+</span>&nbsp;<span class="ident" id="6942789">chunk</span><span class="op" id="6942794">(</span><span class="string" id="6942795">&#34;=&#34;</span><span class="op" id="6942798">)</span>&nbsp;<span class="op" id="6942800">+</span>&nbsp;<span class="ident" id="6942802">chunk</span><span class="op" id="6942807">(</span><span class="string" id="6942808">&#34;postbar&#34;</span><span class="op" id="6942817">)</span>&nbsp;<span class="op" id="6942819">+</span>&nbsp;<span class="ident" id="6942821">chunk</span><span class="op" id="6942826">(</span><span class="string" id="6942827">&#34;&#34;</span><span class="op" id="6942829">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6942833">h</span>&nbsp;<span class="op" id="6942835">:=</span>&nbsp;<span class="op" id="6942838">&amp;</span><span class="ident" id="6942839">Handler</span><span class="op" id="6942846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6942850">Path</span><span class="op" id="6942854">:</span>&nbsp;<span class="string" id="6942856">&#34;testdata/test.cgi&#34;</span><span class="op" id="6942875">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6942879">Root</span><span class="op" id="6942883">:</span>&nbsp;<span class="string" id="6942885">&#34;/test.cgi&#34;</span><span class="op" id="6942896">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6942899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6942902">expectedMap</span>&nbsp;<span class="op" id="6942914">:=</span>&nbsp;<span class="keyword" id="6942917">map</span><span class="op" id="6942920">[</span><span class="builtintype" id="6942921">string</span><span class="op" id="6942927">]</span><span class="builtintype" id="6942928">string</span><span class="op" id="6942934">{</span><span class="op" id="6942935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6942938">resp</span>&nbsp;<span class="op" id="6942943">:=</span>&nbsp;<span class="ident" id="6942946">runCgiTest</span><span class="op" id="6942956">(</span><span class="ident" id="6942957">t</span><span class="op" id="6942958">,</span>&nbsp;<span class="ident" id="6942960">h</span><span class="op" id="6942961">,</span>&nbsp;<span class="ident" id="6942963">postReq</span><span class="op" id="6942970">,</span>&nbsp;<span class="ident" id="6942972">expectedMap</span><span class="op" id="6942983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6942986">if</span>&nbsp;<span class="ident" id="6942989">got</span><span class="op" id="6942992">,</span>&nbsp;<span class="ident" id="6942994">expected</span>&nbsp;<span class="op" id="6943003">:=</span>&nbsp;<span class="ident" id="6943006">resp</span><span class="op" id="6943010">.</span><span class="ident" id="6943011">Code</span><span class="op" id="6943015">,</span>&nbsp;<span class="ident" id="6943017">http</span><span class="op" id="6943021">.</span><span class="ident" id="6943022">StatusBadRequest</span><span class="op" id="6943038">;</span>&nbsp;<span class="ident" id="6943040">got</span>&nbsp;<span class="op" id="6943044">!=</span>&nbsp;<span class="ident" id="6943047">expected</span>&nbsp;<span class="op" id="6943056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943060">t</span><span class="op" id="6943061">.</span><span class="ident" id="6943062">Fatalf</span><span class="op" id="6943068">(</span><span class="string" id="6943069">&#34;Expected&nbsp;%v&nbsp;response&nbsp;code&nbsp;from&nbsp;chunked&nbsp;request&nbsp;body;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6943130">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943135">expected</span><span class="op" id="6943143">,</span>&nbsp;<span class="ident" id="6943145">got</span><span class="op" id="6943148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6943151">}</span><br>
<span class="lineno"></span><span class="op" id="6943153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6943156">func</span>&nbsp;<span class="ident" id="6943161">TestRedirect</span><span class="op" id="6943173">(</span><span class="ident" id="6943174">t</span>&nbsp;<span class="op" id="6943176">*</span><span class="ident" id="6943177">testing</span><span class="op" id="6943184">.</span><span class="ident" id="6943185">T</span><span class="op" id="6943186">)</span>&nbsp;<span class="op" id="6943188">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943191">check</span><span class="op" id="6943196">(</span><span class="ident" id="6943197">t</span><span class="op" id="6943198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943201">h</span>&nbsp;<span class="op" id="6943203">:=</span>&nbsp;<span class="op" id="6943206">&amp;</span><span class="ident" id="6943207">Handler</span><span class="op" id="6943214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943218">Path</span><span class="op" id="6943222">:</span>&nbsp;<span class="string" id="6943224">&#34;testdata/test.cgi&#34;</span><span class="op" id="6943243">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943247">Root</span><span class="op" id="6943251">:</span>&nbsp;<span class="string" id="6943253">&#34;/test.cgi&#34;</span><span class="op" id="6943264">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6943267">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943270">rec</span>&nbsp;<span class="op" id="6943274">:=</span>&nbsp;<span class="ident" id="6943277">runCgiTest</span><span class="op" id="6943287">(</span><span class="ident" id="6943288">t</span><span class="op" id="6943289">,</span>&nbsp;<span class="ident" id="6943291">h</span><span class="op" id="6943292">,</span>&nbsp;<span class="string" id="6943294">&#34;GET&nbsp;/test.cgi?loc=http://foo.com/&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6943361">,</span>&nbsp;<span class="ident" id="6943363">nil</span><span class="op" id="6943366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6943369">if</span>&nbsp;<span class="ident" id="6943372">e</span><span class="op" id="6943373">,</span>&nbsp;<span class="ident" id="6943375">g</span>&nbsp;<span class="op" id="6943377">:=</span>&nbsp;<span class="num" id="6943380">302</span><span class="op" id="6943383">,</span>&nbsp;<span class="ident" id="6943385">rec</span><span class="op" id="6943388">.</span><span class="ident" id="6943389">Code</span><span class="op" id="6943393">;</span>&nbsp;<span class="ident" id="6943395">e</span>&nbsp;<span class="op" id="6943397">!=</span>&nbsp;<span class="ident" id="6943400">g</span>&nbsp;<span class="op" id="6943402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943406">t</span><span class="op" id="6943407">.</span><span class="ident" id="6943408">Errorf</span><span class="op" id="6943414">(</span><span class="string" id="6943415">&#34;expected&nbsp;status&nbsp;code&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6943448">,</span>&nbsp;<span class="ident" id="6943450">e</span><span class="op" id="6943451">,</span>&nbsp;<span class="ident" id="6943453">g</span><span class="op" id="6943454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6943457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6943460">if</span>&nbsp;<span class="ident" id="6943463">e</span><span class="op" id="6943464">,</span>&nbsp;<span class="ident" id="6943466">g</span>&nbsp;<span class="op" id="6943468">:=</span>&nbsp;<span class="string" id="6943471">&#34;http://foo.com/&#34;</span><span class="op" id="6943488">,</span>&nbsp;<span class="ident" id="6943490">rec</span><span class="op" id="6943493">.</span><span class="ident" id="6943494">Header</span><span class="op" id="6943500">(</span><span class="op" id="6943501">)</span><span class="op" id="6943502">.</span><span class="ident" id="6943503">Get</span><span class="op" id="6943506">(</span><span class="string" id="6943507">&#34;Location&#34;</span><span class="op" id="6943517">)</span><span class="op" id="6943518">;</span>&nbsp;<span class="ident" id="6943520">e</span>&nbsp;<span class="op" id="6943522">!=</span>&nbsp;<span class="ident" id="6943525">g</span>&nbsp;<span class="op" id="6943527">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943531">t</span><span class="op" id="6943532">.</span><span class="ident" id="6943533">Errorf</span><span class="op" id="6943539">(</span><span class="string" id="6943540">&#34;expected&nbsp;Location&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6943580">,</span>&nbsp;<span class="ident" id="6943582">e</span><span class="op" id="6943583">,</span>&nbsp;<span class="ident" id="6943585">g</span><span class="op" id="6943586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6943589">}</span><br>
<span class="lineno"></span><span class="op" id="6943591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6943594">func</span>&nbsp;<span class="ident" id="6943599">TestInternalRedirect</span><span class="op" id="6943619">(</span><span class="ident" id="6943620">t</span>&nbsp;<span class="op" id="6943622">*</span><span class="ident" id="6943623">testing</span><span class="op" id="6943630">.</span><span class="ident" id="6943631">T</span><span class="op" id="6943632">)</span>&nbsp;<span class="op" id="6943634">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943637">check</span><span class="op" id="6943642">(</span><span class="ident" id="6943643">t</span><span class="op" id="6943644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943647">baseHandler</span>&nbsp;<span class="op" id="6943659">:=</span>&nbsp;<span class="ident" id="6943662">http</span><span class="op" id="6943666">.</span><span class="ident" id="6943667">HandlerFunc</span><span class="op" id="6943678">(</span><span class="keyword" id="6943679">func</span><span class="op" id="6943683">(</span><span class="ident" id="6943684">rw</span>&nbsp;<span class="ident" id="6943687">http</span><span class="op" id="6943691">.</span><span class="ident" id="6943692">ResponseWriter</span><span class="op" id="6943706">,</span>&nbsp;<span class="ident" id="6943708">req</span>&nbsp;<span class="op" id="6943712">*</span><span class="ident" id="6943713">http</span><span class="op" id="6943717">.</span><span class="ident" id="6943718">Request</span><span class="op" id="6943725">)</span>&nbsp;<span class="op" id="6943727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943731">fmt</span><span class="op" id="6943734">.</span><span class="ident" id="6943735">Fprintf</span><span class="op" id="6943742">(</span><span class="ident" id="6943743">rw</span><span class="op" id="6943745">,</span>&nbsp;<span class="string" id="6943747">&#34;basepath=%s\n&#34;</span><span class="op" id="6943762">,</span>&nbsp;<span class="ident" id="6943764">req</span><span class="op" id="6943767">.</span><span class="ident" id="6943768">URL</span><span class="op" id="6943771">.</span><span class="ident" id="6943772">Path</span><span class="op" id="6943776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943780">fmt</span><span class="op" id="6943783">.</span><span class="ident" id="6943784">Fprintf</span><span class="op" id="6943791">(</span><span class="ident" id="6943792">rw</span><span class="op" id="6943794">,</span>&nbsp;<span class="string" id="6943796">&#34;remoteaddr=%s\n&#34;</span><span class="op" id="6943813">,</span>&nbsp;<span class="ident" id="6943815">req</span><span class="op" id="6943818">.</span><span class="ident" id="6943819">RemoteAddr</span><span class="op" id="6943829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6943832">}</span><span class="op" id="6943833">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943836">h</span>&nbsp;<span class="op" id="6943838">:=</span>&nbsp;<span class="op" id="6943841">&amp;</span><span class="ident" id="6943842">Handler</span><span class="op" id="6943849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943853">Path</span><span class="op" id="6943857">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6943874">&#34;testdata/test.cgi&#34;</span><span class="op" id="6943893">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943897">Root</span><span class="op" id="6943901">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6943918">&#34;/test.cgi&#34;</span><span class="op" id="6943929">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943933">PathLocationHandler</span><span class="op" id="6943952">:</span>&nbsp;<span class="ident" id="6943954">baseHandler</span><span class="op" id="6943965">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6943968">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6943971">expectedMap</span>&nbsp;<span class="op" id="6943983">:=</span>&nbsp;<span class="keyword" id="6943986">map</span><span class="op" id="6943989">[</span><span class="builtintype" id="6943990">string</span><span class="op" id="6943996">]</span><span class="builtintype" id="6943997">string</span><span class="op" id="6944003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6944007">&#34;basepath&#34;</span><span class="op" id="6944017">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6944021">&#34;/foo&#34;</span><span class="op" id="6944027">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6944031">&#34;remoteaddr&#34;</span><span class="op" id="6944043">:</span>&nbsp;<span class="string" id="6944045">&#34;1.2.3.4&#34;</span><span class="op" id="6944054">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6944057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944060">runCgiTest</span><span class="op" id="6944070">(</span><span class="ident" id="6944071">t</span><span class="op" id="6944072">,</span>&nbsp;<span class="ident" id="6944074">h</span><span class="op" id="6944075">,</span>&nbsp;<span class="string" id="6944077">&#34;GET&nbsp;/test.cgi?loc=/foo&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6944133">,</span>&nbsp;<span class="ident" id="6944135">expectedMap</span><span class="op" id="6944146">)</span><br>
<span class="lineno">295</span><span class="op" id="6944148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6944151">//&nbsp;TestCopyError&nbsp;tests&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;process&nbsp;if&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying</span><br>
<span class="lineno"></span><span class="comment" id="6944227">//&nbsp;its&nbsp;output.&nbsp;(for&nbsp;example,&nbsp;from&nbsp;the&nbsp;client&nbsp;having&nbsp;gone&nbsp;away)</span><br>
<span class="lineno"></span><span class="keyword" id="6944290">func</span>&nbsp;<span class="ident" id="6944295">TestCopyError</span><span class="op" id="6944308">(</span><span class="ident" id="6944309">t</span>&nbsp;<span class="op" id="6944311">*</span><span class="ident" id="6944312">testing</span><span class="op" id="6944319">.</span><span class="ident" id="6944320">T</span><span class="op" id="6944321">)</span>&nbsp;<span class="op" id="6944323">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944326">check</span><span class="op" id="6944331">(</span><span class="ident" id="6944332">t</span><span class="op" id="6944333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6944336">if</span>&nbsp;<span class="ident" id="6944339">runtime</span><span class="op" id="6944346">.</span><span class="ident" id="6944347">GOOS</span>&nbsp;<span class="op" id="6944352">==</span>&nbsp;<span class="string" id="6944355">&#34;windows&#34;</span>&nbsp;<span class="op" id="6944365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944369">t</span><span class="op" id="6944370">.</span><span class="ident" id="6944371">Skipf</span><span class="op" id="6944376">(</span><span class="string" id="6944377">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6944398">,</span>&nbsp;<span class="ident" id="6944400">runtime</span><span class="op" id="6944407">.</span><span class="ident" id="6944408">GOOS</span><span class="op" id="6944412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6944415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944418">h</span>&nbsp;<span class="op" id="6944420">:=</span>&nbsp;<span class="op" id="6944423">&amp;</span><span class="ident" id="6944424">Handler</span><span class="op" id="6944431">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944435">Path</span><span class="op" id="6944439">:</span>&nbsp;<span class="string" id="6944441">&#34;testdata/test.cgi&#34;</span><span class="op" id="6944460">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944464">Root</span><span class="op" id="6944468">:</span>&nbsp;<span class="string" id="6944470">&#34;/test.cgi&#34;</span><span class="op" id="6944481">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6944484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944487">ts</span>&nbsp;<span class="op" id="6944490">:=</span>&nbsp;<span class="ident" id="6944493">httptest</span><span class="op" id="6944501">.</span><span class="ident" id="6944502">NewServer</span><span class="op" id="6944511">(</span><span class="ident" id="6944512">h</span><span class="op" id="6944513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6944516">defer</span>&nbsp;<span class="ident" id="6944522">ts</span><span class="op" id="6944524">.</span><span class="ident" id="6944525">Close</span><span class="op" id="6944530">(</span><span class="op" id="6944531">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944535">conn</span><span class="op" id="6944539">,</span>&nbsp;<span class="ident" id="6944541">err</span>&nbsp;<span class="op" id="6944545">:=</span>&nbsp;<span class="ident" id="6944548">net</span><span class="op" id="6944551">.</span><span class="ident" id="6944552">Dial</span><span class="op" id="6944556">(</span><span class="string" id="6944557">&#34;tcp&#34;</span><span class="op" id="6944562">,</span>&nbsp;<span class="ident" id="6944564">ts</span><span class="op" id="6944566">.</span><span class="ident" id="6944567">Listener</span><span class="op" id="6944575">.</span><span class="ident" id="6944576">Addr</span><span class="op" id="6944580">(</span><span class="op" id="6944581">)</span><span class="op" id="6944582">.</span><span class="ident" id="6944583">String</span><span class="op" id="6944589">(</span><span class="op" id="6944590">)</span><span class="op" id="6944591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6944594">if</span>&nbsp;<span class="ident" id="6944597">err</span>&nbsp;<span class="op" id="6944601">!=</span>&nbsp;<span class="ident" id="6944604">nil</span>&nbsp;<span class="op" id="6944608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944612">t</span><span class="op" id="6944613">.</span><span class="ident" id="6944614">Fatal</span><span class="op" id="6944619">(</span><span class="ident" id="6944620">err</span><span class="op" id="6944623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6944626">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944629">req</span><span class="op" id="6944632">,</span>&nbsp;<span class="ident" id="6944634">_</span>&nbsp;<span class="op" id="6944636">:=</span>&nbsp;<span class="ident" id="6944639">http</span><span class="op" id="6944643">.</span><span class="ident" id="6944644">NewRequest</span><span class="op" id="6944654">(</span><span class="string" id="6944655">&#34;GET&#34;</span><span class="op" id="6944660">,</span>&nbsp;<span class="string" id="6944662">&#34;http://example.com/test.cgi?bigresponse=1&#34;</span><span class="op" id="6944705">,</span>&nbsp;<span class="ident" id="6944707">nil</span><span class="op" id="6944710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944713">err</span>&nbsp;<span class="op" id="6944717">=</span>&nbsp;<span class="ident" id="6944719">req</span><span class="op" id="6944722">.</span><span class="ident" id="6944723">Write</span><span class="op" id="6944728">(</span><span class="ident" id="6944729">conn</span><span class="op" id="6944733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6944736">if</span>&nbsp;<span class="ident" id="6944739">err</span>&nbsp;<span class="op" id="6944743">!=</span>&nbsp;<span class="ident" id="6944746">nil</span>&nbsp;<span class="op" id="6944750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944754">t</span><span class="op" id="6944755">.</span><span class="ident" id="6944756">Fatalf</span><span class="op" id="6944762">(</span><span class="string" id="6944763">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="6944774">,</span>&nbsp;<span class="ident" id="6944776">err</span><span class="op" id="6944779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6944782">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944786">res</span><span class="op" id="6944789">,</span>&nbsp;<span class="ident" id="6944791">err</span>&nbsp;<span class="op" id="6944795">:=</span>&nbsp;<span class="ident" id="6944798">http</span><span class="op" id="6944802">.</span><span class="ident" id="6944803">ReadResponse</span><span class="op" id="6944815">(</span><span class="ident" id="6944816">bufio</span><span class="op" id="6944821">.</span><span class="ident" id="6944822">NewReader</span><span class="op" id="6944831">(</span><span class="ident" id="6944832">conn</span><span class="op" id="6944836">)</span><span class="op" id="6944837">,</span>&nbsp;<span class="ident" id="6944839">req</span><span class="op" id="6944842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6944845">if</span>&nbsp;<span class="ident" id="6944848">err</span>&nbsp;<span class="op" id="6944852">!=</span>&nbsp;<span class="ident" id="6944855">nil</span>&nbsp;<span class="op" id="6944859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944863">t</span><span class="op" id="6944864">.</span><span class="ident" id="6944865">Fatalf</span><span class="op" id="6944871">(</span><span class="string" id="6944872">&#34;ReadResponse:&nbsp;%v&#34;</span><span class="op" id="6944890">,</span>&nbsp;<span class="ident" id="6944892">err</span><span class="op" id="6944895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6944898">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944902">pidstr</span>&nbsp;<span class="op" id="6944909">:=</span>&nbsp;<span class="ident" id="6944912">res</span><span class="op" id="6944915">.</span><span class="ident" id="6944916">Header</span><span class="op" id="6944922">.</span><span class="ident" id="6944923">Get</span><span class="op" id="6944926">(</span><span class="string" id="6944927">&#34;X-CGI-Pid&#34;</span><span class="op" id="6944938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6944941">if</span>&nbsp;<span class="ident" id="6944944">pidstr</span>&nbsp;<span class="op" id="6944951">==</span>&nbsp;<span class="string" id="6944954">&#34;&#34;</span>&nbsp;<span class="op" id="6944957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6944961">t</span><span class="op" id="6944962">.</span><span class="ident" id="6944963">Fatalf</span><span class="op" id="6944969">(</span><span class="string" id="6944970">&#34;expected&nbsp;an&nbsp;X-CGI-Pid&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="6945012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6945015">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945018">pid</span><span class="op" id="6945021">,</span>&nbsp;<span class="ident" id="6945023">err</span>&nbsp;<span class="op" id="6945027">:=</span>&nbsp;<span class="ident" id="6945030">strconv</span><span class="op" id="6945037">.</span><span class="ident" id="6945038">Atoi</span><span class="op" id="6945042">(</span><span class="ident" id="6945043">pidstr</span><span class="op" id="6945049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6945052">if</span>&nbsp;<span class="ident" id="6945055">err</span>&nbsp;<span class="op" id="6945059">!=</span>&nbsp;<span class="ident" id="6945062">nil</span>&nbsp;<span class="op" id="6945066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945070">t</span><span class="op" id="6945071">.</span><span class="ident" id="6945072">Fatalf</span><span class="op" id="6945078">(</span><span class="string" id="6945079">&#34;invalid&nbsp;X-CGI-Pid&nbsp;value&#34;</span><span class="op" id="6945104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6945107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6945111">var</span>&nbsp;<span class="ident" id="6945115">buf</span>&nbsp;<span class="op" id="6945119">[</span><span class="num" id="6945120">5000</span><span class="op" id="6945124">]</span><span class="builtintype" id="6945125">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945131">n</span><span class="op" id="6945132">,</span>&nbsp;<span class="ident" id="6945134">err</span>&nbsp;<span class="op" id="6945138">:=</span>&nbsp;<span class="ident" id="6945141">io</span><span class="op" id="6945143">.</span><span class="ident" id="6945144">ReadFull</span><span class="op" id="6945152">(</span><span class="ident" id="6945153">res</span><span class="op" id="6945156">.</span><span class="ident" id="6945157">Body</span><span class="op" id="6945161">,</span>&nbsp;<span class="ident" id="6945163">buf</span><span class="op" id="6945166">[</span><span class="op" id="6945167">:</span><span class="op" id="6945168">]</span><span class="op" id="6945169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6945172">if</span>&nbsp;<span class="ident" id="6945175">err</span>&nbsp;<span class="op" id="6945179">!=</span>&nbsp;<span class="ident" id="6945182">nil</span>&nbsp;<span class="op" id="6945186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945190">t</span><span class="op" id="6945191">.</span><span class="ident" id="6945192">Fatalf</span><span class="op" id="6945198">(</span><span class="string" id="6945199">&#34;ReadFull:&nbsp;%d&nbsp;bytes,&nbsp;%v&#34;</span><span class="op" id="6945223">,</span>&nbsp;<span class="ident" id="6945225">n</span><span class="op" id="6945226">,</span>&nbsp;<span class="ident" id="6945228">err</span><span class="op" id="6945231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6945234">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945238">childRunning</span>&nbsp;<span class="op" id="6945251">:=</span>&nbsp;<span class="keyword" id="6945254">func</span><span class="op" id="6945258">(</span><span class="op" id="6945259">)</span>&nbsp;<span class="builtintype" id="6945261">bool</span>&nbsp;<span class="op" id="6945266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6945270">return</span>&nbsp;<span class="ident" id="6945277">isProcessRunning</span><span class="op" id="6945293">(</span><span class="ident" id="6945294">t</span><span class="op" id="6945295">,</span>&nbsp;<span class="ident" id="6945297">pid</span><span class="op" id="6945300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6945303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6945307">if</span>&nbsp;<span class="op" id="6945310">!</span><span class="ident" id="6945311">childRunning</span><span class="op" id="6945323">(</span><span class="op" id="6945324">)</span>&nbsp;<span class="op" id="6945326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945330">t</span><span class="op" id="6945331">.</span><span class="ident" id="6945332">Fatalf</span><span class="op" id="6945338">(</span><span class="string" id="6945339">&#34;pre-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;running&#34;</span><span class="op" id="6945385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6945388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945391">conn</span><span class="op" id="6945395">.</span><span class="ident" id="6945396">Close</span><span class="op" id="6945401">(</span><span class="op" id="6945402">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945406">tries</span>&nbsp;<span class="op" id="6945412">:=</span>&nbsp;<span class="num" id="6945415">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6945418">for</span>&nbsp;<span class="ident" id="6945422">tries</span>&nbsp;<span class="op" id="6945428">&lt;</span>&nbsp;<span class="num" id="6945430">25</span>&nbsp;<span class="op" id="6945433">&amp;&amp;</span>&nbsp;<span class="ident" id="6945436">childRunning</span><span class="op" id="6945448">(</span><span class="op" id="6945449">)</span>&nbsp;<span class="op" id="6945451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945455">time</span><span class="op" id="6945459">.</span><span class="ident" id="6945460">Sleep</span><span class="op" id="6945465">(</span><span class="num" id="6945466">50</span>&nbsp;<span class="op" id="6945469">*</span>&nbsp;<span class="ident" id="6945471">time</span><span class="op" id="6945475">.</span><span class="ident" id="6945476">Millisecond</span>&nbsp;<span class="op" id="6945488">*</span>&nbsp;<span class="ident" id="6945490">time</span><span class="op" id="6945494">.</span><span class="ident" id="6945495">Duration</span><span class="op" id="6945503">(</span><span class="ident" id="6945504">tries</span><span class="op" id="6945509">)</span><span class="op" id="6945510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945514">tries</span><span class="op" id="6945519">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6945523">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6945526">if</span>&nbsp;<span class="ident" id="6945529">childRunning</span><span class="op" id="6945541">(</span><span class="op" id="6945542">)</span>&nbsp;<span class="op" id="6945544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945548">t</span><span class="op" id="6945549">.</span><span class="ident" id="6945550">Fatalf</span><span class="op" id="6945556">(</span><span class="string" id="6945557">&#34;post-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;gone&#34;</span><span class="op" id="6945601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6945604">}</span><br>
<span class="lineno"></span><span class="op" id="6945606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword" id="6945609">func</span>&nbsp;<span class="ident" id="6945614">TestDirUnix</span><span class="op" id="6945625">(</span><span class="ident" id="6945626">t</span>&nbsp;<span class="op" id="6945628">*</span><span class="ident" id="6945629">testing</span><span class="op" id="6945636">.</span><span class="ident" id="6945637">T</span><span class="op" id="6945638">)</span>&nbsp;<span class="op" id="6945640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945643">check</span><span class="op" id="6945648">(</span><span class="ident" id="6945649">t</span><span class="op" id="6945650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6945653">if</span>&nbsp;<span class="ident" id="6945656">runtime</span><span class="op" id="6945663">.</span><span class="ident" id="6945664">GOOS</span>&nbsp;<span class="op" id="6945669">==</span>&nbsp;<span class="string" id="6945672">&#34;windows&#34;</span>&nbsp;<span class="op" id="6945682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945686">t</span><span class="op" id="6945687">.</span><span class="ident" id="6945688">Skipf</span><span class="op" id="6945693">(</span><span class="string" id="6945694">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6945715">,</span>&nbsp;<span class="ident" id="6945717">runtime</span><span class="op" id="6945724">.</span><span class="ident" id="6945725">GOOS</span><span class="op" id="6945729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6945732">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945735">cwd</span><span class="op" id="6945738">,</span>&nbsp;<span class="ident" id="6945740">_</span>&nbsp;<span class="op" id="6945742">:=</span>&nbsp;<span class="ident" id="6945745">os</span><span class="op" id="6945747">.</span><span class="ident" id="6945748">Getwd</span><span class="op" id="6945753">(</span><span class="op" id="6945754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945757">h</span>&nbsp;<span class="op" id="6945759">:=</span>&nbsp;<span class="op" id="6945762">&amp;</span><span class="ident" id="6945763">Handler</span><span class="op" id="6945770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945774">Path</span><span class="op" id="6945778">:</span>&nbsp;<span class="string" id="6945780">&#34;testdata/test.cgi&#34;</span><span class="op" id="6945799">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945803">Root</span><span class="op" id="6945807">:</span>&nbsp;<span class="string" id="6945809">&#34;/test.cgi&#34;</span><span class="op" id="6945820">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945824">Dir</span><span class="op" id="6945827">:</span>&nbsp;&nbsp;<span class="ident" id="6945830">cwd</span><span class="op" id="6945833">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6945836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945839">expectedMap</span>&nbsp;<span class="op" id="6945851">:=</span>&nbsp;<span class="keyword" id="6945854">map</span><span class="op" id="6945857">[</span><span class="builtintype" id="6945858">string</span><span class="op" id="6945864">]</span><span class="builtintype" id="6945865">string</span><span class="op" id="6945871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6945875">&#34;cwd&#34;</span><span class="op" id="6945880">:</span>&nbsp;<span class="ident" id="6945882">cwd</span><span class="op" id="6945885">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6945888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945891">runCgiTest</span><span class="op" id="6945901">(</span><span class="ident" id="6945902">t</span><span class="op" id="6945903">,</span>&nbsp;<span class="ident" id="6945905">h</span><span class="op" id="6945906">,</span>&nbsp;<span class="string" id="6945908">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6945955">,</span>&nbsp;<span class="ident" id="6945957">expectedMap</span><span class="op" id="6945968">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945972">cwd</span><span class="op" id="6945975">,</span>&nbsp;<span class="ident" id="6945977">_</span>&nbsp;<span class="op" id="6945979">=</span>&nbsp;<span class="ident" id="6945981">os</span><span class="op" id="6945983">.</span><span class="ident" id="6945984">Getwd</span><span class="op" id="6945989">(</span><span class="op" id="6945990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6945993">cwd</span>&nbsp;<span class="op" id="6945997">=</span>&nbsp;<span class="ident" id="6945999">filepath</span><span class="op" id="6946007">.</span><span class="ident" id="6946008">Join</span><span class="op" id="6946012">(</span><span class="ident" id="6946013">cwd</span><span class="op" id="6946016">,</span>&nbsp;<span class="string" id="6946018">&#34;testdata&#34;</span><span class="op" id="6946028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946031">h</span>&nbsp;<span class="op" id="6946033">=</span>&nbsp;<span class="op" id="6946035">&amp;</span><span class="ident" id="6946036">Handler</span><span class="op" id="6946043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946047">Path</span><span class="op" id="6946051">:</span>&nbsp;<span class="string" id="6946053">&#34;testdata/test.cgi&#34;</span><span class="op" id="6946072">,</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946076">Root</span><span class="op" id="6946080">:</span>&nbsp;<span class="string" id="6946082">&#34;/test.cgi&#34;</span><span class="op" id="6946093">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6946096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946099">expectedMap</span>&nbsp;<span class="op" id="6946111">=</span>&nbsp;<span class="keyword" id="6946113">map</span><span class="op" id="6946116">[</span><span class="builtintype" id="6946117">string</span><span class="op" id="6946123">]</span><span class="builtintype" id="6946124">string</span><span class="op" id="6946130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6946134">&#34;cwd&#34;</span><span class="op" id="6946139">:</span>&nbsp;<span class="ident" id="6946141">cwd</span><span class="op" id="6946144">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6946147">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946150">runCgiTest</span><span class="op" id="6946160">(</span><span class="ident" id="6946161">t</span><span class="op" id="6946162">,</span>&nbsp;<span class="ident" id="6946164">h</span><span class="op" id="6946165">,</span>&nbsp;<span class="string" id="6946167">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6946214">,</span>&nbsp;<span class="ident" id="6946216">expectedMap</span><span class="op" id="6946227">)</span><br>
<span class="lineno"></span><span class="op" id="6946229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6946232">func</span>&nbsp;<span class="ident" id="6946237">TestDirWindows</span><span class="op" id="6946251">(</span><span class="ident" id="6946252">t</span>&nbsp;<span class="op" id="6946254">*</span><span class="ident" id="6946255">testing</span><span class="op" id="6946262">.</span><span class="ident" id="6946263">T</span><span class="op" id="6946264">)</span>&nbsp;<span class="op" id="6946266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6946269">if</span>&nbsp;<span class="ident" id="6946272">runtime</span><span class="op" id="6946279">.</span><span class="ident" id="6946280">GOOS</span>&nbsp;<span class="op" id="6946285">!=</span>&nbsp;<span class="string" id="6946288">&#34;windows&#34;</span>&nbsp;<span class="op" id="6946298">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946302">t</span><span class="op" id="6946303">.</span><span class="ident" id="6946304">Skip</span><span class="op" id="6946308">(</span><span class="string" id="6946309">&#34;Skipping&nbsp;windows&nbsp;specific&nbsp;test.&#34;</span><span class="op" id="6946342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6946345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946349">cgifile</span><span class="op" id="6946356">,</span>&nbsp;<span class="ident" id="6946358">_</span>&nbsp;<span class="op" id="6946360">:=</span>&nbsp;<span class="ident" id="6946363">filepath</span><span class="op" id="6946371">.</span><span class="ident" id="6946372">Abs</span><span class="op" id="6946375">(</span><span class="string" id="6946376">&#34;testdata/test.cgi&#34;</span><span class="op" id="6946395">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6946399">var</span>&nbsp;<span class="ident" id="6946403">perl</span>&nbsp;<span class="builtintype" id="6946408">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6946416">var</span>&nbsp;<span class="ident" id="6946420">err</span>&nbsp;<span class="builtintype" id="6946424">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946431">perl</span><span class="op" id="6946435">,</span>&nbsp;<span class="ident" id="6946437">err</span>&nbsp;<span class="op" id="6946441">=</span>&nbsp;<span class="ident" id="6946443">exec</span><span class="op" id="6946447">.</span><span class="ident" id="6946448">LookPath</span><span class="op" id="6946456">(</span><span class="string" id="6946457">&#34;perl&#34;</span><span class="op" id="6946463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6946466">if</span>&nbsp;<span class="ident" id="6946469">err</span>&nbsp;<span class="op" id="6946473">!=</span>&nbsp;<span class="ident" id="6946476">nil</span>&nbsp;<span class="op" id="6946480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946484">t</span><span class="op" id="6946485">.</span><span class="ident" id="6946486">Skip</span><span class="op" id="6946490">(</span><span class="string" id="6946491">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="6946523">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6946526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946529">perl</span><span class="op" id="6946533">,</span>&nbsp;<span class="ident" id="6946535">_</span>&nbsp;<span class="op" id="6946537">=</span>&nbsp;<span class="ident" id="6946539">filepath</span><span class="op" id="6946547">.</span><span class="ident" id="6946548">Abs</span><span class="op" id="6946551">(</span><span class="ident" id="6946552">perl</span><span class="op" id="6946556">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946560">cwd</span><span class="op" id="6946563">,</span>&nbsp;<span class="ident" id="6946565">_</span>&nbsp;<span class="op" id="6946567">:=</span>&nbsp;<span class="ident" id="6946570">os</span><span class="op" id="6946572">.</span><span class="ident" id="6946573">Getwd</span><span class="op" id="6946578">(</span><span class="op" id="6946579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946582">h</span>&nbsp;<span class="op" id="6946584">:=</span>&nbsp;<span class="op" id="6946587">&amp;</span><span class="ident" id="6946588">Handler</span><span class="op" id="6946595">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946599">Path</span><span class="op" id="6946603">:</span>&nbsp;<span class="ident" id="6946605">perl</span><span class="op" id="6946609">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946613">Root</span><span class="op" id="6946617">:</span>&nbsp;<span class="string" id="6946619">&#34;/test.cgi&#34;</span><span class="op" id="6946630">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946634">Dir</span><span class="op" id="6946637">:</span>&nbsp;&nbsp;<span class="ident" id="6946640">cwd</span><span class="op" id="6946643">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946647">Args</span><span class="op" id="6946651">:</span>&nbsp;<span class="op" id="6946653">[</span><span class="op" id="6946654">]</span><span class="builtintype" id="6946655">string</span><span class="op" id="6946661">{</span><span class="ident" id="6946662">cgifile</span><span class="op" id="6946669">}</span><span class="op" id="6946670">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946674">Env</span><span class="op" id="6946677">:</span>&nbsp;&nbsp;<span class="op" id="6946680">[</span><span class="op" id="6946681">]</span><span class="builtintype" id="6946682">string</span><span class="op" id="6946688">{</span><span class="string" id="6946689">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="6946708">+</span>&nbsp;<span class="ident" id="6946710">cgifile</span><span class="op" id="6946717">}</span><span class="op" id="6946718">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6946721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946724">expectedMap</span>&nbsp;<span class="op" id="6946736">:=</span>&nbsp;<span class="keyword" id="6946739">map</span><span class="op" id="6946742">[</span><span class="builtintype" id="6946743">string</span><span class="op" id="6946749">]</span><span class="builtintype" id="6946750">string</span><span class="op" id="6946756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6946760">&#34;cwd&#34;</span><span class="op" id="6946765">:</span>&nbsp;<span class="ident" id="6946767">cwd</span><span class="op" id="6946770">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6946773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946776">runCgiTest</span><span class="op" id="6946786">(</span><span class="ident" id="6946787">t</span><span class="op" id="6946788">,</span>&nbsp;<span class="ident" id="6946790">h</span><span class="op" id="6946791">,</span>&nbsp;<span class="string" id="6946793">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6946840">,</span>&nbsp;<span class="ident" id="6946842">expectedMap</span><span class="op" id="6946853">)</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6946857">//&nbsp;If&nbsp;not&nbsp;specify&nbsp;Dir&nbsp;on&nbsp;windows,&nbsp;working&nbsp;directory&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6946920">//&nbsp;base&nbsp;directory&nbsp;of&nbsp;perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6946948">cwd</span><span class="op" id="6946951">,</span>&nbsp;<span class="ident" id="6946953">_</span>&nbsp;<span class="op" id="6946955">=</span>&nbsp;<span class="ident" id="6946957">filepath</span><span class="op" id="6946965">.</span><span class="ident" id="6946966">Split</span><span class="op" id="6946971">(</span><span class="ident" id="6946972">perl</span><span class="op" id="6946976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6946979">if</span>&nbsp;<span class="ident" id="6946982">cwd</span>&nbsp;<span class="op" id="6946986">!=</span>&nbsp;<span class="string" id="6946989">&#34;&#34;</span>&nbsp;<span class="op" id="6946992">&amp;&amp;</span>&nbsp;<span class="ident" id="6946995">cwd</span><span class="op" id="6946998">[</span><span class="builtinfunc" id="6946999">len</span><span class="op" id="6947002">(</span><span class="ident" id="6947003">cwd</span><span class="op" id="6947006">)</span><span class="op" id="6947007">-</span><span class="num" id="6947008">1</span><span class="op" id="6947009">]</span>&nbsp;<span class="op" id="6947011">==</span>&nbsp;<span class="ident" id="6947014">filepath</span><span class="op" id="6947022">.</span><span class="ident" id="6947023">Separator</span>&nbsp;<span class="op" id="6947033">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947037">cwd</span>&nbsp;<span class="op" id="6947041">=</span>&nbsp;<span class="ident" id="6947043">cwd</span><span class="op" id="6947046">[</span><span class="op" id="6947047">:</span><span class="builtinfunc" id="6947048">len</span><span class="op" id="6947051">(</span><span class="ident" id="6947052">cwd</span><span class="op" id="6947055">)</span><span class="op" id="6947056">-</span><span class="num" id="6947057">1</span><span class="op" id="6947058">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6947061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947064">h</span>&nbsp;<span class="op" id="6947066">=</span>&nbsp;<span class="op" id="6947068">&amp;</span><span class="ident" id="6947069">Handler</span><span class="op" id="6947076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947080">Path</span><span class="op" id="6947084">:</span>&nbsp;<span class="ident" id="6947086">perl</span><span class="op" id="6947090">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947094">Root</span><span class="op" id="6947098">:</span>&nbsp;<span class="string" id="6947100">&#34;/test.cgi&#34;</span><span class="op" id="6947111">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947115">Args</span><span class="op" id="6947119">:</span>&nbsp;<span class="op" id="6947121">[</span><span class="op" id="6947122">]</span><span class="builtintype" id="6947123">string</span><span class="op" id="6947129">{</span><span class="ident" id="6947130">cgifile</span><span class="op" id="6947137">}</span><span class="op" id="6947138">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947142">Env</span><span class="op" id="6947145">:</span>&nbsp;&nbsp;<span class="op" id="6947148">[</span><span class="op" id="6947149">]</span><span class="builtintype" id="6947150">string</span><span class="op" id="6947156">{</span><span class="string" id="6947157">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="6947176">+</span>&nbsp;<span class="ident" id="6947178">cgifile</span><span class="op" id="6947185">}</span><span class="op" id="6947186">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6947189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947192">expectedMap</span>&nbsp;<span class="op" id="6947204">=</span>&nbsp;<span class="keyword" id="6947206">map</span><span class="op" id="6947209">[</span><span class="builtintype" id="6947210">string</span><span class="op" id="6947216">]</span><span class="builtintype" id="6947217">string</span><span class="op" id="6947223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6947227">&#34;cwd&#34;</span><span class="op" id="6947232">:</span>&nbsp;<span class="ident" id="6947234">cwd</span><span class="op" id="6947237">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6947240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947243">runCgiTest</span><span class="op" id="6947253">(</span><span class="ident" id="6947254">t</span><span class="op" id="6947255">,</span>&nbsp;<span class="ident" id="6947257">h</span><span class="op" id="6947258">,</span>&nbsp;<span class="string" id="6947260">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6947307">,</span>&nbsp;<span class="ident" id="6947309">expectedMap</span><span class="op" id="6947320">)</span><br>
<span class="lineno"></span><span class="op" id="6947322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6947325">func</span>&nbsp;<span class="ident" id="6947330">TestEnvOverride</span><span class="op" id="6947345">(</span><span class="ident" id="6947346">t</span>&nbsp;<span class="op" id="6947348">*</span><span class="ident" id="6947349">testing</span><span class="op" id="6947356">.</span><span class="ident" id="6947357">T</span><span class="op" id="6947358">)</span>&nbsp;<span class="op" id="6947360">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947363">cgifile</span><span class="op" id="6947370">,</span>&nbsp;<span class="ident" id="6947372">_</span>&nbsp;<span class="op" id="6947374">:=</span>&nbsp;<span class="ident" id="6947377">filepath</span><span class="op" id="6947385">.</span><span class="ident" id="6947386">Abs</span><span class="op" id="6947389">(</span><span class="string" id="6947390">&#34;testdata/test.cgi&#34;</span><span class="op" id="6947409">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6947413">var</span>&nbsp;<span class="ident" id="6947417">perl</span>&nbsp;<span class="builtintype" id="6947422">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6947430">var</span>&nbsp;<span class="ident" id="6947434">err</span>&nbsp;<span class="builtintype" id="6947438">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947445">perl</span><span class="op" id="6947449">,</span>&nbsp;<span class="ident" id="6947451">err</span>&nbsp;<span class="op" id="6947455">=</span>&nbsp;<span class="ident" id="6947457">exec</span><span class="op" id="6947461">.</span><span class="ident" id="6947462">LookPath</span><span class="op" id="6947470">(</span><span class="string" id="6947471">&#34;perl&#34;</span><span class="op" id="6947477">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6947480">if</span>&nbsp;<span class="ident" id="6947483">err</span>&nbsp;<span class="op" id="6947487">!=</span>&nbsp;<span class="ident" id="6947490">nil</span>&nbsp;<span class="op" id="6947494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947498">t</span><span class="op" id="6947499">.</span><span class="ident" id="6947500">Skipf</span><span class="op" id="6947505">(</span><span class="string" id="6947506">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="6947538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6947541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947544">perl</span><span class="op" id="6947548">,</span>&nbsp;<span class="ident" id="6947550">_</span>&nbsp;<span class="op" id="6947552">=</span>&nbsp;<span class="ident" id="6947554">filepath</span><span class="op" id="6947562">.</span><span class="ident" id="6947563">Abs</span><span class="op" id="6947566">(</span><span class="ident" id="6947567">perl</span><span class="op" id="6947571">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947575">cwd</span><span class="op" id="6947578">,</span>&nbsp;<span class="ident" id="6947580">_</span>&nbsp;<span class="op" id="6947582">:=</span>&nbsp;<span class="ident" id="6947585">os</span><span class="op" id="6947587">.</span><span class="ident" id="6947588">Getwd</span><span class="op" id="6947593">(</span><span class="op" id="6947594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947597">h</span>&nbsp;<span class="op" id="6947599">:=</span>&nbsp;<span class="op" id="6947602">&amp;</span><span class="ident" id="6947603">Handler</span><span class="op" id="6947610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947614">Path</span><span class="op" id="6947618">:</span>&nbsp;<span class="ident" id="6947620">perl</span><span class="op" id="6947624">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947628">Root</span><span class="op" id="6947632">:</span>&nbsp;<span class="string" id="6947634">&#34;/test.cgi&#34;</span><span class="op" id="6947645">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947649">Dir</span><span class="op" id="6947652">:</span>&nbsp;&nbsp;<span class="ident" id="6947655">cwd</span><span class="op" id="6947658">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947662">Args</span><span class="op" id="6947666">:</span>&nbsp;<span class="op" id="6947668">[</span><span class="op" id="6947669">]</span><span class="builtintype" id="6947670">string</span><span class="op" id="6947676">{</span><span class="ident" id="6947677">cgifile</span><span class="op" id="6947684">}</span><span class="op" id="6947685">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947689">Env</span><span class="op" id="6947692">:</span>&nbsp;<span class="op" id="6947694">[</span><span class="op" id="6947695">]</span><span class="builtintype" id="6947696">string</span><span class="op" id="6947702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6947707">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="6947726">+</span>&nbsp;<span class="ident" id="6947728">cgifile</span><span class="op" id="6947735">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6947740">&#34;REQUEST_URI=/foo/bar&#34;</span><span class="op" id="6947762">}</span><span class="op" id="6947763">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6947766">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947769">expectedMap</span>&nbsp;<span class="op" id="6947781">:=</span>&nbsp;<span class="keyword" id="6947784">map</span><span class="op" id="6947787">[</span><span class="builtintype" id="6947788">string</span><span class="op" id="6947794">]</span><span class="builtintype" id="6947795">string</span><span class="op" id="6947801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6947805">&#34;cwd&#34;</span><span class="op" id="6947810">:</span>&nbsp;<span class="ident" id="6947812">cwd</span><span class="op" id="6947815">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6947819">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6947840">:</span>&nbsp;<span class="ident" id="6947842">cgifile</span><span class="op" id="6947849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6947853">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6947870">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6947876">&#34;/foo/bar&#34;</span><span class="op" id="6947886">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6947889">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6947892">runCgiTest</span><span class="op" id="6947902">(</span><span class="ident" id="6947903">t</span><span class="op" id="6947904">,</span>&nbsp;<span class="ident" id="6947906">h</span><span class="op" id="6947907">,</span>&nbsp;<span class="string" id="6947909">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6947956">,</span>&nbsp;<span class="ident" id="6947958">expectedMap</span><span class="op" id="6947969">)</span><br>
<span class="lineno"></span><span class="op" id="6947971">}</span>
</div>
</body>
</html>
