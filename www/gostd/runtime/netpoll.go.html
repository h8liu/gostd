<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1558477">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1558532">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1558586">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1558637">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1558715">package</span>&nbsp;<span class="ident" id="1558723">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1558732">import</span>&nbsp;<span class="string" id="1558739">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1558749">//&nbsp;Integrated&nbsp;network&nbsp;poller&nbsp;(platform-independent&nbsp;part).</span><br>
<span class="lineno"></span><span class="comment" id="1558807">//&nbsp;A&nbsp;particular&nbsp;implementation&nbsp;(epoll/kqueue)&nbsp;must&nbsp;define&nbsp;the&nbsp;following&nbsp;functions:</span><br>
<span class="lineno"></span><span class="comment" id="1558890">//&nbsp;func&nbsp;netpollinit()&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;initialize&nbsp;the&nbsp;poller</span><br>
<span class="lineno"></span><span class="comment" id="1558942">//&nbsp;func&nbsp;netpollopen(fd&nbsp;uintptr,&nbsp;pd&nbsp;*pollDesc)&nbsp;int32&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;arm&nbsp;edge-triggered&nbsp;notifications</span><br>
<span class="lineno">15</span><span class="comment" id="1559033">//&nbsp;and&nbsp;associate&nbsp;fd&nbsp;with&nbsp;pd.</span><br>
<span class="lineno"></span><span class="comment" id="1559062">//&nbsp;An&nbsp;implementation&nbsp;must&nbsp;call&nbsp;the&nbsp;following&nbsp;function&nbsp;to&nbsp;denote&nbsp;that&nbsp;the&nbsp;pd&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="comment" id="1559148">//&nbsp;func&nbsp;netpollready(gpp&nbsp;**g,&nbsp;pd&nbsp;*pollDesc,&nbsp;mode&nbsp;int32)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1559205">//&nbsp;pollDesc&nbsp;contains&nbsp;2&nbsp;binary&nbsp;semaphores,&nbsp;rg&nbsp;and&nbsp;wg,&nbsp;to&nbsp;park&nbsp;reader&nbsp;and&nbsp;writer</span><br>
<span class="lineno">20</span><span class="comment" id="1559284">//&nbsp;goroutines&nbsp;respectively.&nbsp;The&nbsp;semaphore&nbsp;can&nbsp;be&nbsp;in&nbsp;the&nbsp;following&nbsp;states:</span><br>
<span class="lineno"></span><span class="comment" id="1559358">//&nbsp;pdReady&nbsp;-&nbsp;io&nbsp;readiness&nbsp;notification&nbsp;is&nbsp;pending;</span><br>
<span class="lineno"></span><span class="comment" id="1559409">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;goroutine&nbsp;consumes&nbsp;the&nbsp;notification&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1559490">//&nbsp;pdWait&nbsp;-&nbsp;a&nbsp;goroutine&nbsp;prepares&nbsp;to&nbsp;park&nbsp;on&nbsp;the&nbsp;semaphore,&nbsp;but&nbsp;not&nbsp;yet&nbsp;parked;</span><br>
<span class="lineno"></span><span class="comment" id="1559569">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;goroutine&nbsp;commits&nbsp;to&nbsp;park&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;G&nbsp;pointer,</span><br>
<span class="lineno">25</span><span class="comment" id="1559647">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;io&nbsp;notification&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY,</span><br>
<span class="lineno"></span><span class="comment" id="1559733">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1559815">//&nbsp;G&nbsp;pointer&nbsp;-&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;blocked&nbsp;on&nbsp;the&nbsp;semaphore;</span><br>
<span class="lineno"></span><span class="comment" id="1559873">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io&nbsp;notification&nbsp;or&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY&nbsp;or&nbsp;nil&nbsp;respectively</span><br>
<span class="lineno"></span><span class="comment" id="1559968">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;unparks&nbsp;the&nbsp;goroutine.</span><br>
<span class="lineno">30</span><span class="comment" id="1560010">//&nbsp;nil&nbsp;-&nbsp;nothing&nbsp;of&nbsp;the&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="1560041">const</span>&nbsp;<span class="op" id="1560047">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1560050">pdReady</span>&nbsp;<span class="builtintype" id="1560058">uintptr</span>&nbsp;<span class="op" id="1560066">=</span>&nbsp;<span class="num" id="1560068">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1560071">pdWait</span>&nbsp;&nbsp;<span class="builtintype" id="1560079">uintptr</span>&nbsp;<span class="op" id="1560087">=</span>&nbsp;<span class="num" id="1560089">2</span><br>
<span class="lineno"></span><span class="op" id="1560091">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1560094">const</span>&nbsp;<span class="ident" id="1560100">pollBlockSize</span>&nbsp;<span class="op" id="1560114">=</span>&nbsp;<span class="num" id="1560116">4</span>&nbsp;<span class="op" id="1560118">*</span>&nbsp;<span class="num" id="1560120">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1560126">//&nbsp;Network&nbsp;poller&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="1560156">type</span>&nbsp;<span class="ident" id="1560161">pollDesc</span>&nbsp;<span class="keyword" id="1560170">struct</span>&nbsp;<span class="op" id="1560177">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1560180">link</span>&nbsp;<span class="op" id="1560185">*</span><span class="ident" id="1560186">pollDesc</span>&nbsp;<span class="comment" id="1560195">//&nbsp;in&nbsp;pollcache,&nbsp;protected&nbsp;by&nbsp;pollcache.lock</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1560242">//&nbsp;The&nbsp;lock&nbsp;protects&nbsp;pollOpen,&nbsp;pollSetDeadline,&nbsp;pollUnblock&nbsp;and&nbsp;deadlineimpl&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1560332">//&nbsp;This&nbsp;fully&nbsp;covers&nbsp;seq,&nbsp;rt&nbsp;and&nbsp;wt&nbsp;variables.&nbsp;fd&nbsp;is&nbsp;constant&nbsp;throughout&nbsp;the&nbsp;PollDesc&nbsp;lifetime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1560429">//&nbsp;pollReset,&nbsp;pollWait,&nbsp;pollWaitCanceled&nbsp;and&nbsp;runtime·netpollready&nbsp;(IO&nbsp;readiness&nbsp;notification)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1560525">//&nbsp;proceed&nbsp;w/o&nbsp;taking&nbsp;the&nbsp;lock.&nbsp;So&nbsp;closing,&nbsp;rg,&nbsp;rd,&nbsp;wg&nbsp;and&nbsp;wd&nbsp;are&nbsp;manipulated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1560604">//&nbsp;in&nbsp;a&nbsp;lock-free&nbsp;way&nbsp;by&nbsp;all&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1560646">//&nbsp;NOTE(dvyukov):&nbsp;the&nbsp;following&nbsp;code&nbsp;uses&nbsp;uintptr&nbsp;to&nbsp;store&nbsp;*g&nbsp;(rg/wg),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1560718">//&nbsp;that&nbsp;will&nbsp;blow&nbsp;up&nbsp;when&nbsp;GC&nbsp;starts&nbsp;moving&nbsp;objects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1560771">lock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1560779">mutex</span>&nbsp;<span class="comment" id="1560785">//&nbsp;protectes&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1560820">fd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1560828">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1560837">closing</span>&nbsp;<span class="builtintype" id="1560845">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1560851">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1560859">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560874">//&nbsp;protects&nbsp;from&nbsp;stale&nbsp;timers&nbsp;and&nbsp;ready&nbsp;notifications</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1560929">rg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1560937">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1560952">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;read&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1560999">rt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561007">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561022">//&nbsp;read&nbsp;deadline&nbsp;timer&nbsp;(set&nbsp;if&nbsp;rt.f&nbsp;!=&nbsp;nil)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561067">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561075">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561090">//&nbsp;read&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561108">wg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1561116">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561131">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;write&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561179">wt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561187">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561202">//&nbsp;write&nbsp;deadline&nbsp;timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561227">wd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561235">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1561250">//&nbsp;write&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561269">user</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1561277">unsafe</span><span class="op" id="1561283">.</span><span class="ident" id="1561284">Pointer</span>&nbsp;<span class="comment" id="1561292">//&nbsp;user&nbsp;settable&nbsp;cookie</span><br>
<span class="lineno">60</span><span class="op" id="1561316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1561319">type</span>&nbsp;<span class="ident" id="1561324">pollCache</span>&nbsp;<span class="keyword" id="1561334">struct</span>&nbsp;<span class="op" id="1561341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561344">lock</span>&nbsp;&nbsp;<span class="ident" id="1561350">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561357">first</span>&nbsp;<span class="op" id="1561363">*</span><span class="ident" id="1561364">pollDesc</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561374">//&nbsp;PollDesc&nbsp;objects&nbsp;must&nbsp;be&nbsp;type-stable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561416">//&nbsp;because&nbsp;we&nbsp;can&nbsp;get&nbsp;ready&nbsp;notification&nbsp;from&nbsp;epoll/kqueue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561476">//&nbsp;after&nbsp;the&nbsp;descriptor&nbsp;is&nbsp;closed/reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561519">//&nbsp;Stale&nbsp;notifications&nbsp;are&nbsp;detected&nbsp;using&nbsp;seq&nbsp;variable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561576">//&nbsp;seq&nbsp;is&nbsp;incremented&nbsp;when&nbsp;deadlines&nbsp;are&nbsp;changed&nbsp;or&nbsp;descriptor&nbsp;is&nbsp;reused.</span><br>
<span class="lineno">70</span><span class="op" id="1561650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1561653">var</span>&nbsp;<span class="ident" id="1561657">pollcache</span>&nbsp;<span class="ident" id="1561667">pollCache</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1561678">func</span>&nbsp;<span class="ident" id="1561683">netpollServerInit</span><span class="op" id="1561700">(</span><span class="op" id="1561701">)</span>&nbsp;<span class="op" id="1561703">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561706">onM</span><span class="op" id="1561709">(</span><span class="ident" id="1561710">netpollinit</span><span class="op" id="1561721">)</span><br>
<span class="lineno"></span><span class="op" id="1561723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1561726">func</span>&nbsp;<span class="ident" id="1561731">netpollOpen</span><span class="op" id="1561742">(</span><span class="ident" id="1561743">fd</span>&nbsp;<span class="builtintype" id="1561746">uintptr</span><span class="op" id="1561753">)</span>&nbsp;<span class="op" id="1561755">(</span><span class="op" id="1561756">*</span><span class="ident" id="1561757">pollDesc</span><span class="op" id="1561765">,</span>&nbsp;<span class="builtintype" id="1561767">int</span><span class="op" id="1561770">)</span>&nbsp;<span class="op" id="1561772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561775">pd</span>&nbsp;<span class="op" id="1561778">:=</span>&nbsp;<span class="ident" id="1561781">pollcache</span><span class="op" id="1561790">.</span><span class="ident" id="1561791">alloc</span><span class="op" id="1561796">(</span><span class="op" id="1561797">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561800">lock</span><span class="op" id="1561804">(</span><span class="op" id="1561805">&amp;</span><span class="ident" id="1561806">pd</span><span class="op" id="1561808">.</span><span class="ident" id="1561809">lock</span><span class="op" id="1561813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1561816">if</span>&nbsp;<span class="ident" id="1561819">pd</span><span class="op" id="1561821">.</span><span class="ident" id="1561822">wg</span>&nbsp;<span class="op" id="1561825">!=</span>&nbsp;<span class="num" id="1561828">0</span>&nbsp;<span class="op" id="1561830">&amp;&amp;</span>&nbsp;<span class="ident" id="1561833">pd</span><span class="op" id="1561835">.</span><span class="ident" id="1561836">wg</span>&nbsp;<span class="op" id="1561839">!=</span>&nbsp;<span class="ident" id="1561842">pdReady</span>&nbsp;<span class="op" id="1561850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561854">gothrow</span><span class="op" id="1561861">(</span><span class="string" id="1561862">&#34;netpollOpen:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1561909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1561912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1561915">if</span>&nbsp;<span class="ident" id="1561918">pd</span><span class="op" id="1561920">.</span><span class="ident" id="1561921">rg</span>&nbsp;<span class="op" id="1561924">!=</span>&nbsp;<span class="num" id="1561927">0</span>&nbsp;<span class="op" id="1561929">&amp;&amp;</span>&nbsp;<span class="ident" id="1561932">pd</span><span class="op" id="1561934">.</span><span class="ident" id="1561935">rg</span>&nbsp;<span class="op" id="1561938">!=</span>&nbsp;<span class="ident" id="1561941">pdReady</span>&nbsp;<span class="op" id="1561949">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561953">gothrow</span><span class="op" id="1561960">(</span><span class="string" id="1561961">&#34;netpollOpen:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1562007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562013">pd</span><span class="op" id="1562015">.</span><span class="ident" id="1562016">fd</span>&nbsp;<span class="op" id="1562019">=</span>&nbsp;<span class="ident" id="1562021">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562025">pd</span><span class="op" id="1562027">.</span><span class="ident" id="1562028">closing</span>&nbsp;<span class="op" id="1562036">=</span>&nbsp;<span class="builtintype" id="1562038">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562045">pd</span><span class="op" id="1562047">.</span><span class="ident" id="1562048">seq</span><span class="op" id="1562051">++</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562055">pd</span><span class="op" id="1562057">.</span><span class="ident" id="1562058">rg</span>&nbsp;<span class="op" id="1562061">=</span>&nbsp;<span class="num" id="1562063">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562066">pd</span><span class="op" id="1562068">.</span><span class="ident" id="1562069">rd</span>&nbsp;<span class="op" id="1562072">=</span>&nbsp;<span class="num" id="1562074">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562077">pd</span><span class="op" id="1562079">.</span><span class="ident" id="1562080">wg</span>&nbsp;<span class="op" id="1562083">=</span>&nbsp;<span class="num" id="1562085">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562088">pd</span><span class="op" id="1562090">.</span><span class="ident" id="1562091">wd</span>&nbsp;<span class="op" id="1562094">=</span>&nbsp;<span class="num" id="1562096">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562099">unlock</span><span class="op" id="1562105">(</span><span class="op" id="1562106">&amp;</span><span class="ident" id="1562107">pd</span><span class="op" id="1562109">.</span><span class="ident" id="1562110">lock</span><span class="op" id="1562114">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562118">var</span>&nbsp;<span class="ident" id="1562122">errno</span>&nbsp;<span class="builtintype" id="1562128">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562135">onM</span><span class="op" id="1562138">(</span><span class="keyword" id="1562139">func</span><span class="op" id="1562143">(</span><span class="op" id="1562144">)</span>&nbsp;<span class="op" id="1562146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562150">errno</span>&nbsp;<span class="op" id="1562156">=</span>&nbsp;<span class="ident" id="1562158">netpollopen</span><span class="op" id="1562169">(</span><span class="ident" id="1562170">fd</span><span class="op" id="1562172">,</span>&nbsp;<span class="ident" id="1562174">pd</span><span class="op" id="1562176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562179">}</span><span class="op" id="1562180">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562183">return</span>&nbsp;<span class="ident" id="1562190">pd</span><span class="op" id="1562192">,</span>&nbsp;<span class="builtintype" id="1562194">int</span><span class="op" id="1562197">(</span><span class="ident" id="1562198">errno</span><span class="op" id="1562203">)</span><br>
<span class="lineno"></span><span class="op" id="1562205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1562208">func</span>&nbsp;<span class="ident" id="1562213">netpollClose</span><span class="op" id="1562225">(</span><span class="ident" id="1562226">pd</span>&nbsp;<span class="op" id="1562229">*</span><span class="ident" id="1562230">pollDesc</span><span class="op" id="1562238">)</span>&nbsp;<span class="op" id="1562240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562243">if</span>&nbsp;<span class="op" id="1562246">!</span><span class="ident" id="1562247">pd</span><span class="op" id="1562249">.</span><span class="ident" id="1562250">closing</span>&nbsp;<span class="op" id="1562258">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562262">gothrow</span><span class="op" id="1562269">(</span><span class="string" id="1562270">&#34;netpollClose:&nbsp;close&nbsp;w/o&nbsp;unblock&#34;</span><span class="op" id="1562303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562309">if</span>&nbsp;<span class="ident" id="1562312">pd</span><span class="op" id="1562314">.</span><span class="ident" id="1562315">wg</span>&nbsp;<span class="op" id="1562318">!=</span>&nbsp;<span class="num" id="1562321">0</span>&nbsp;<span class="op" id="1562323">&amp;&amp;</span>&nbsp;<span class="ident" id="1562326">pd</span><span class="op" id="1562328">.</span><span class="ident" id="1562329">wg</span>&nbsp;<span class="op" id="1562332">!=</span>&nbsp;<span class="ident" id="1562335">pdReady</span>&nbsp;<span class="op" id="1562343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562347">gothrow</span><span class="op" id="1562354">(</span><span class="string" id="1562355">&#34;netpollClose:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1562406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562409">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562412">if</span>&nbsp;<span class="ident" id="1562415">pd</span><span class="op" id="1562417">.</span><span class="ident" id="1562418">rg</span>&nbsp;<span class="op" id="1562421">!=</span>&nbsp;<span class="num" id="1562424">0</span>&nbsp;<span class="op" id="1562426">&amp;&amp;</span>&nbsp;<span class="ident" id="1562429">pd</span><span class="op" id="1562431">.</span><span class="ident" id="1562432">rg</span>&nbsp;<span class="op" id="1562435">!=</span>&nbsp;<span class="ident" id="1562438">pdReady</span>&nbsp;<span class="op" id="1562446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562450">gothrow</span><span class="op" id="1562457">(</span><span class="string" id="1562458">&#34;netpollClose:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1562508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562514">onM</span><span class="op" id="1562517">(</span><span class="keyword" id="1562518">func</span><span class="op" id="1562522">(</span><span class="op" id="1562523">)</span>&nbsp;<span class="op" id="1562525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562529">netpollclose</span><span class="op" id="1562541">(</span><span class="builtintype" id="1562542">uintptr</span><span class="op" id="1562549">(</span><span class="ident" id="1562550">pd</span><span class="op" id="1562552">.</span><span class="ident" id="1562553">fd</span><span class="op" id="1562555">)</span><span class="op" id="1562556">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562559">}</span><span class="op" id="1562560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562563">pollcache</span><span class="op" id="1562572">.</span><span class="ident" id="1562573">free</span><span class="op" id="1562577">(</span><span class="ident" id="1562578">pd</span><span class="op" id="1562580">)</span><br>
<span class="lineno"></span><span class="op" id="1562582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1562585">func</span>&nbsp;<span class="op" id="1562590">(</span><span class="ident" id="1562591">c</span>&nbsp;<span class="op" id="1562593">*</span><span class="ident" id="1562594">pollCache</span><span class="op" id="1562603">)</span>&nbsp;<span class="ident" id="1562605">free</span><span class="op" id="1562609">(</span><span class="ident" id="1562610">pd</span>&nbsp;<span class="op" id="1562613">*</span><span class="ident" id="1562614">pollDesc</span><span class="op" id="1562622">)</span>&nbsp;<span class="op" id="1562624">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562627">lock</span><span class="op" id="1562631">(</span><span class="op" id="1562632">&amp;</span><span class="ident" id="1562633">c</span><span class="op" id="1562634">.</span><span class="ident" id="1562635">lock</span><span class="op" id="1562639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562642">pd</span><span class="op" id="1562644">.</span><span class="ident" id="1562645">link</span>&nbsp;<span class="op" id="1562650">=</span>&nbsp;<span class="ident" id="1562652">c</span><span class="op" id="1562653">.</span><span class="ident" id="1562654">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562661">c</span><span class="op" id="1562662">.</span><span class="ident" id="1562663">first</span>&nbsp;<span class="op" id="1562669">=</span>&nbsp;<span class="ident" id="1562671">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562675">unlock</span><span class="op" id="1562681">(</span><span class="op" id="1562682">&amp;</span><span class="ident" id="1562683">c</span><span class="op" id="1562684">.</span><span class="ident" id="1562685">lock</span><span class="op" id="1562689">)</span><br>
<span class="lineno"></span><span class="op" id="1562691">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="1562694">func</span>&nbsp;<span class="ident" id="1562699">netpollReset</span><span class="op" id="1562711">(</span><span class="ident" id="1562712">pd</span>&nbsp;<span class="op" id="1562715">*</span><span class="ident" id="1562716">pollDesc</span><span class="op" id="1562724">,</span>&nbsp;<span class="ident" id="1562726">mode</span>&nbsp;<span class="builtintype" id="1562731">int</span><span class="op" id="1562734">)</span>&nbsp;<span class="builtintype" id="1562736">int</span>&nbsp;<span class="op" id="1562740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562743">err</span>&nbsp;<span class="op" id="1562747">:=</span>&nbsp;<span class="ident" id="1562750">netpollcheckerr</span><span class="op" id="1562765">(</span><span class="ident" id="1562766">pd</span><span class="op" id="1562768">,</span>&nbsp;<span class="builtintype" id="1562770">int32</span><span class="op" id="1562775">(</span><span class="ident" id="1562776">mode</span><span class="op" id="1562780">)</span><span class="op" id="1562781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562784">if</span>&nbsp;<span class="ident" id="1562787">err</span>&nbsp;<span class="op" id="1562791">!=</span>&nbsp;<span class="num" id="1562794">0</span>&nbsp;<span class="op" id="1562796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562800">return</span>&nbsp;<span class="ident" id="1562807">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562815">if</span>&nbsp;<span class="ident" id="1562818">mode</span>&nbsp;<span class="op" id="1562823">==</span>&nbsp;<span class="string" id="1562826">&#39;r&#39;</span>&nbsp;<span class="op" id="1562830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562834">pd</span><span class="op" id="1562836">.</span><span class="ident" id="1562837">rg</span>&nbsp;<span class="op" id="1562840">=</span>&nbsp;<span class="num" id="1562842">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562845">}</span>&nbsp;<span class="keyword" id="1562847">else</span>&nbsp;<span class="keyword" id="1562852">if</span>&nbsp;<span class="ident" id="1562855">mode</span>&nbsp;<span class="op" id="1562860">==</span>&nbsp;<span class="string" id="1562863">&#39;w&#39;</span>&nbsp;<span class="op" id="1562867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562871">pd</span><span class="op" id="1562873">.</span><span class="ident" id="1562874">wg</span>&nbsp;<span class="op" id="1562877">=</span>&nbsp;<span class="num" id="1562879">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562885">return</span>&nbsp;<span class="num" id="1562892">0</span><br>
<span class="lineno"></span><span class="op" id="1562894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1562897">func</span>&nbsp;<span class="ident" id="1562902">netpollWait</span><span class="op" id="1562913">(</span><span class="ident" id="1562914">pd</span>&nbsp;<span class="op" id="1562917">*</span><span class="ident" id="1562918">pollDesc</span><span class="op" id="1562926">,</span>&nbsp;<span class="ident" id="1562928">mode</span>&nbsp;<span class="builtintype" id="1562933">int</span><span class="op" id="1562936">)</span>&nbsp;<span class="builtintype" id="1562938">int</span>&nbsp;<span class="op" id="1562942">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562945">err</span>&nbsp;<span class="op" id="1562949">:=</span>&nbsp;<span class="ident" id="1562952">netpollcheckerr</span><span class="op" id="1562967">(</span><span class="ident" id="1562968">pd</span><span class="op" id="1562970">,</span>&nbsp;<span class="builtintype" id="1562972">int32</span><span class="op" id="1562977">(</span><span class="ident" id="1562978">mode</span><span class="op" id="1562982">)</span><span class="op" id="1562983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562986">if</span>&nbsp;<span class="ident" id="1562989">err</span>&nbsp;<span class="op" id="1562993">!=</span>&nbsp;<span class="num" id="1562996">0</span>&nbsp;<span class="op" id="1562998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563002">return</span>&nbsp;<span class="ident" id="1563009">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1563017">//&nbsp;As&nbsp;for&nbsp;now&nbsp;only&nbsp;Solaris&nbsp;uses&nbsp;level-triggered&nbsp;IO.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563070">if</span>&nbsp;<span class="ident" id="1563073">GOOS</span>&nbsp;<span class="op" id="1563078">==</span>&nbsp;<span class="string" id="1563081">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1563091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563095">onM</span><span class="op" id="1563098">(</span><span class="keyword" id="1563099">func</span><span class="op" id="1563103">(</span><span class="op" id="1563104">)</span>&nbsp;<span class="op" id="1563106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563111">netpollarm</span><span class="op" id="1563121">(</span><span class="ident" id="1563122">pd</span><span class="op" id="1563124">,</span>&nbsp;<span class="ident" id="1563126">mode</span><span class="op" id="1563130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563134">}</span><span class="op" id="1563135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563138">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563141">for</span>&nbsp;<span class="op" id="1563145">!</span><span class="ident" id="1563146">netpollblock</span><span class="op" id="1563158">(</span><span class="ident" id="1563159">pd</span><span class="op" id="1563161">,</span>&nbsp;<span class="builtintype" id="1563163">int32</span><span class="op" id="1563168">(</span><span class="ident" id="1563169">mode</span><span class="op" id="1563173">)</span><span class="op" id="1563174">,</span>&nbsp;<span class="builtintype" id="1563176">false</span><span class="op" id="1563181">)</span>&nbsp;<span class="op" id="1563183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563187">err</span>&nbsp;<span class="op" id="1563191">=</span>&nbsp;<span class="ident" id="1563193">netpollcheckerr</span><span class="op" id="1563208">(</span><span class="ident" id="1563209">pd</span><span class="op" id="1563211">,</span>&nbsp;<span class="builtintype" id="1563213">int32</span><span class="op" id="1563218">(</span><span class="ident" id="1563219">mode</span><span class="op" id="1563223">)</span><span class="op" id="1563224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563228">if</span>&nbsp;<span class="ident" id="1563231">err</span>&nbsp;<span class="op" id="1563235">!=</span>&nbsp;<span class="num" id="1563238">0</span>&nbsp;<span class="op" id="1563240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563245">return</span>&nbsp;<span class="ident" id="1563252">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563258">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1563262">//&nbsp;Can&nbsp;happen&nbsp;if&nbsp;timeout&nbsp;has&nbsp;fired&nbsp;and&nbsp;unblocked&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1563317">//&nbsp;but&nbsp;before&nbsp;we&nbsp;had&nbsp;a&nbsp;chance&nbsp;to&nbsp;run,&nbsp;timeout&nbsp;has&nbsp;been&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1563381">//&nbsp;Pretend&nbsp;it&nbsp;has&nbsp;not&nbsp;happened&nbsp;and&nbsp;retry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563427">return</span>&nbsp;<span class="num" id="1563434">0</span><br>
<span class="lineno">160</span><span class="op" id="1563436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1563439">func</span>&nbsp;<span class="ident" id="1563444">netpollWaitCanceled</span><span class="op" id="1563463">(</span><span class="ident" id="1563464">pd</span>&nbsp;<span class="op" id="1563467">*</span><span class="ident" id="1563468">pollDesc</span><span class="op" id="1563476">,</span>&nbsp;<span class="ident" id="1563478">mode</span>&nbsp;<span class="builtintype" id="1563483">int</span><span class="op" id="1563486">)</span>&nbsp;<span class="op" id="1563488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1563491">//&nbsp;This&nbsp;function&nbsp;is&nbsp;used&nbsp;only&nbsp;on&nbsp;windows&nbsp;after&nbsp;a&nbsp;failed&nbsp;attempt&nbsp;to&nbsp;cancel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1563566">//&nbsp;a&nbsp;pending&nbsp;async&nbsp;IO&nbsp;operation.&nbsp;Wait&nbsp;for&nbsp;ioready,&nbsp;ignore&nbsp;closing&nbsp;or&nbsp;timeouts.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563646">for</span>&nbsp;<span class="op" id="1563650">!</span><span class="ident" id="1563651">netpollblock</span><span class="op" id="1563663">(</span><span class="ident" id="1563664">pd</span><span class="op" id="1563666">,</span>&nbsp;<span class="builtintype" id="1563668">int32</span><span class="op" id="1563673">(</span><span class="ident" id="1563674">mode</span><span class="op" id="1563678">)</span><span class="op" id="1563679">,</span>&nbsp;<span class="builtintype" id="1563681">true</span><span class="op" id="1563685">)</span>&nbsp;<span class="op" id="1563687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563690">}</span><br>
<span class="lineno"></span><span class="op" id="1563692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1563695">func</span>&nbsp;<span class="ident" id="1563700">netpollSetDeadline</span><span class="op" id="1563718">(</span><span class="ident" id="1563719">pd</span>&nbsp;<span class="op" id="1563722">*</span><span class="ident" id="1563723">pollDesc</span><span class="op" id="1563731">,</span>&nbsp;<span class="ident" id="1563733">d</span>&nbsp;<span class="ident" id="1563735">int64</span><span class="op" id="1563740">,</span>&nbsp;<span class="ident" id="1563742">mode</span>&nbsp;<span class="builtintype" id="1563747">int</span><span class="op" id="1563750">)</span>&nbsp;<span class="op" id="1563752">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563755">lock</span><span class="op" id="1563759">(</span><span class="op" id="1563760">&amp;</span><span class="ident" id="1563761">pd</span><span class="op" id="1563763">.</span><span class="ident" id="1563764">lock</span><span class="op" id="1563768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563771">if</span>&nbsp;<span class="ident" id="1563774">pd</span><span class="op" id="1563776">.</span><span class="ident" id="1563777">closing</span>&nbsp;<span class="op" id="1563785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563789">unlock</span><span class="op" id="1563795">(</span><span class="op" id="1563796">&amp;</span><span class="ident" id="1563797">pd</span><span class="op" id="1563799">.</span><span class="ident" id="1563800">lock</span><span class="op" id="1563804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563808">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563816">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563819">pd</span><span class="op" id="1563821">.</span><span class="ident" id="1563822">seq</span><span class="op" id="1563825">++</span>&nbsp;<span class="comment" id="1563828">//&nbsp;invalidate&nbsp;current&nbsp;timers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1563858">//&nbsp;Reset&nbsp;current&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563884">if</span>&nbsp;<span class="ident" id="1563887">pd</span><span class="op" id="1563889">.</span><span class="ident" id="1563890">rt</span><span class="op" id="1563892">.</span><span class="ident" id="1563893">f</span>&nbsp;<span class="op" id="1563895">!=</span>&nbsp;<span class="ident" id="1563898">nil</span>&nbsp;<span class="op" id="1563902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563906">deltimer</span><span class="op" id="1563914">(</span><span class="op" id="1563915">&amp;</span><span class="ident" id="1563916">pd</span><span class="op" id="1563918">.</span><span class="ident" id="1563919">rt</span><span class="op" id="1563921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563925">pd</span><span class="op" id="1563927">.</span><span class="ident" id="1563928">rt</span><span class="op" id="1563930">.</span><span class="ident" id="1563931">f</span>&nbsp;<span class="op" id="1563933">=</span>&nbsp;<span class="ident" id="1563935">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563943">if</span>&nbsp;<span class="ident" id="1563946">pd</span><span class="op" id="1563948">.</span><span class="ident" id="1563949">wt</span><span class="op" id="1563951">.</span><span class="ident" id="1563952">f</span>&nbsp;<span class="op" id="1563954">!=</span>&nbsp;<span class="ident" id="1563957">nil</span>&nbsp;<span class="op" id="1563961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563965">deltimer</span><span class="op" id="1563973">(</span><span class="op" id="1563974">&amp;</span><span class="ident" id="1563975">pd</span><span class="op" id="1563977">.</span><span class="ident" id="1563978">wt</span><span class="op" id="1563980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563984">pd</span><span class="op" id="1563986">.</span><span class="ident" id="1563987">wt</span><span class="op" id="1563989">.</span><span class="ident" id="1563990">f</span>&nbsp;<span class="op" id="1563992">=</span>&nbsp;<span class="ident" id="1563994">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563999">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1564002">//&nbsp;Setup&nbsp;new&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1564024">if</span>&nbsp;<span class="ident" id="1564027">d</span>&nbsp;<span class="op" id="1564029">!=</span>&nbsp;<span class="num" id="1564032">0</span>&nbsp;<span class="op" id="1564034">&amp;&amp;</span>&nbsp;<span class="ident" id="1564037">d</span>&nbsp;<span class="op" id="1564039">&lt;=</span>&nbsp;<span class="ident" id="1564042">nanotime</span><span class="op" id="1564050">(</span><span class="op" id="1564051">)</span>&nbsp;<span class="op" id="1564053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564057">d</span>&nbsp;<span class="op" id="1564059">=</span>&nbsp;<span class="op" id="1564061">-</span><span class="num" id="1564062">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1564065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1564068">if</span>&nbsp;<span class="ident" id="1564071">mode</span>&nbsp;<span class="op" id="1564076">==</span>&nbsp;<span class="string" id="1564079">&#39;r&#39;</span>&nbsp;<span class="op" id="1564083">||</span>&nbsp;<span class="ident" id="1564086">mode</span>&nbsp;<span class="op" id="1564091">==</span>&nbsp;<span class="string" id="1564094">&#39;r&#39;</span><span class="op" id="1564097">+</span><span class="string" id="1564098">&#39;w&#39;</span>&nbsp;<span class="op" id="1564102">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564106">pd</span><span class="op" id="1564108">.</span><span class="ident" id="1564109">rd</span>&nbsp;<span class="op" id="1564112">=</span>&nbsp;<span class="ident" id="1564114">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1564117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1564120">if</span>&nbsp;<span class="ident" id="1564123">mode</span>&nbsp;<span class="op" id="1564128">==</span>&nbsp;<span class="string" id="1564131">&#39;w&#39;</span>&nbsp;<span class="op" id="1564135">||</span>&nbsp;<span class="ident" id="1564138">mode</span>&nbsp;<span class="op" id="1564143">==</span>&nbsp;<span class="string" id="1564146">&#39;r&#39;</span><span class="op" id="1564149">+</span><span class="string" id="1564150">&#39;w&#39;</span>&nbsp;<span class="op" id="1564154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564158">pd</span><span class="op" id="1564160">.</span><span class="ident" id="1564161">wd</span>&nbsp;<span class="op" id="1564164">=</span>&nbsp;<span class="ident" id="1564166">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1564169">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1564172">if</span>&nbsp;<span class="ident" id="1564175">pd</span><span class="op" id="1564177">.</span><span class="ident" id="1564178">rd</span>&nbsp;<span class="op" id="1564181">&gt;</span>&nbsp;<span class="num" id="1564183">0</span>&nbsp;<span class="op" id="1564185">&amp;&amp;</span>&nbsp;<span class="ident" id="1564188">pd</span><span class="op" id="1564190">.</span><span class="ident" id="1564191">rd</span>&nbsp;<span class="op" id="1564194">==</span>&nbsp;<span class="ident" id="1564197">pd</span><span class="op" id="1564199">.</span><span class="ident" id="1564200">wd</span>&nbsp;<span class="op" id="1564203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564207">pd</span><span class="op" id="1564209">.</span><span class="ident" id="1564210">rt</span><span class="op" id="1564212">.</span><span class="ident" id="1564213">f</span>&nbsp;<span class="op" id="1564215">=</span>&nbsp;<span class="ident" id="1564217">netpollDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564235">pd</span><span class="op" id="1564237">.</span><span class="ident" id="1564238">rt</span><span class="op" id="1564240">.</span><span class="ident" id="1564241">when</span>&nbsp;<span class="op" id="1564246">=</span>&nbsp;<span class="ident" id="1564248">pd</span><span class="op" id="1564250">.</span><span class="ident" id="1564251">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1564256">//&nbsp;Copy&nbsp;current&nbsp;seq&nbsp;into&nbsp;the&nbsp;timer&nbsp;arg.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1564298">//&nbsp;Timer&nbsp;func&nbsp;will&nbsp;check&nbsp;the&nbsp;seq&nbsp;against&nbsp;current&nbsp;descriptor&nbsp;seq,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1564365">//&nbsp;if&nbsp;they&nbsp;differ&nbsp;the&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564433">pd</span><span class="op" id="1564435">.</span><span class="ident" id="1564436">rt</span><span class="op" id="1564438">.</span><span class="ident" id="1564439">arg</span>&nbsp;<span class="op" id="1564443">=</span>&nbsp;<span class="ident" id="1564445">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564450">pd</span><span class="op" id="1564452">.</span><span class="ident" id="1564453">rt</span><span class="op" id="1564455">.</span><span class="ident" id="1564456">seq</span>&nbsp;<span class="op" id="1564460">=</span>&nbsp;<span class="ident" id="1564462">pd</span><span class="op" id="1564464">.</span><span class="ident" id="1564465">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564471">addtimer</span><span class="op" id="1564479">(</span><span class="op" id="1564480">&amp;</span><span class="ident" id="1564481">pd</span><span class="op" id="1564483">.</span><span class="ident" id="1564484">rt</span><span class="op" id="1564486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1564489">}</span>&nbsp;<span class="keyword" id="1564491">else</span>&nbsp;<span class="op" id="1564496">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1564500">if</span>&nbsp;<span class="ident" id="1564503">pd</span><span class="op" id="1564505">.</span><span class="ident" id="1564506">rd</span>&nbsp;<span class="op" id="1564509">&gt;</span>&nbsp;<span class="num" id="1564511">0</span>&nbsp;<span class="op" id="1564513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564518">pd</span><span class="op" id="1564520">.</span><span class="ident" id="1564521">rt</span><span class="op" id="1564523">.</span><span class="ident" id="1564524">f</span>&nbsp;<span class="op" id="1564526">=</span>&nbsp;<span class="ident" id="1564528">netpollReadDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564551">pd</span><span class="op" id="1564553">.</span><span class="ident" id="1564554">rt</span><span class="op" id="1564556">.</span><span class="ident" id="1564557">when</span>&nbsp;<span class="op" id="1564562">=</span>&nbsp;<span class="ident" id="1564564">pd</span><span class="op" id="1564566">.</span><span class="ident" id="1564567">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564573">pd</span><span class="op" id="1564575">.</span><span class="ident" id="1564576">rt</span><span class="op" id="1564578">.</span><span class="ident" id="1564579">arg</span>&nbsp;<span class="op" id="1564583">=</span>&nbsp;<span class="ident" id="1564585">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564591">pd</span><span class="op" id="1564593">.</span><span class="ident" id="1564594">rt</span><span class="op" id="1564596">.</span><span class="ident" id="1564597">seq</span>&nbsp;<span class="op" id="1564601">=</span>&nbsp;<span class="ident" id="1564603">pd</span><span class="op" id="1564605">.</span><span class="ident" id="1564606">seq</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564613">addtimer</span><span class="op" id="1564621">(</span><span class="op" id="1564622">&amp;</span><span class="ident" id="1564623">pd</span><span class="op" id="1564625">.</span><span class="ident" id="1564626">rt</span><span class="op" id="1564628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1564632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1564636">if</span>&nbsp;<span class="ident" id="1564639">pd</span><span class="op" id="1564641">.</span><span class="ident" id="1564642">wd</span>&nbsp;<span class="op" id="1564645">&gt;</span>&nbsp;<span class="num" id="1564647">0</span>&nbsp;<span class="op" id="1564649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564654">pd</span><span class="op" id="1564656">.</span><span class="ident" id="1564657">wt</span><span class="op" id="1564659">.</span><span class="ident" id="1564660">f</span>&nbsp;<span class="op" id="1564662">=</span>&nbsp;<span class="ident" id="1564664">netpollWriteDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564688">pd</span><span class="op" id="1564690">.</span><span class="ident" id="1564691">wt</span><span class="op" id="1564693">.</span><span class="ident" id="1564694">when</span>&nbsp;<span class="op" id="1564699">=</span>&nbsp;<span class="ident" id="1564701">pd</span><span class="op" id="1564703">.</span><span class="ident" id="1564704">wd</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564710">pd</span><span class="op" id="1564712">.</span><span class="ident" id="1564713">wt</span><span class="op" id="1564715">.</span><span class="ident" id="1564716">arg</span>&nbsp;<span class="op" id="1564720">=</span>&nbsp;<span class="ident" id="1564722">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564728">pd</span><span class="op" id="1564730">.</span><span class="ident" id="1564731">wt</span><span class="op" id="1564733">.</span><span class="ident" id="1564734">seq</span>&nbsp;<span class="op" id="1564738">=</span>&nbsp;<span class="ident" id="1564740">pd</span><span class="op" id="1564742">.</span><span class="ident" id="1564743">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564750">addtimer</span><span class="op" id="1564758">(</span><span class="op" id="1564759">&amp;</span><span class="ident" id="1564760">pd</span><span class="op" id="1564762">.</span><span class="ident" id="1564763">wt</span><span class="op" id="1564765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1564769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1564772">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1564775">//&nbsp;If&nbsp;we&nbsp;set&nbsp;the&nbsp;new&nbsp;deadline&nbsp;in&nbsp;the&nbsp;past,&nbsp;unblock&nbsp;currently&nbsp;pending&nbsp;IO&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1564856">var</span>&nbsp;<span class="ident" id="1564860">rg</span><span class="op" id="1564862">,</span>&nbsp;<span class="ident" id="1564864">wg</span>&nbsp;<span class="op" id="1564867">*</span><span class="ident" id="1564868">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564871">atomicstorep</span><span class="op" id="1564883">(</span><span class="ident" id="1564884">unsafe</span><span class="op" id="1564890">.</span><span class="ident" id="1564891">Pointer</span><span class="op" id="1564898">(</span><span class="op" id="1564899">&amp;</span><span class="ident" id="1564900">wg</span><span class="op" id="1564902">)</span><span class="op" id="1564903">,</span>&nbsp;<span class="ident" id="1564905">nil</span><span class="op" id="1564908">)</span>&nbsp;<span class="comment" id="1564910">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;stores&nbsp;to&nbsp;rd/wd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1564994">if</span>&nbsp;<span class="ident" id="1564997">pd</span><span class="op" id="1564999">.</span><span class="ident" id="1565000">rd</span>&nbsp;<span class="op" id="1565003">&lt;</span>&nbsp;<span class="num" id="1565005">0</span>&nbsp;<span class="op" id="1565007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565011">rg</span>&nbsp;<span class="op" id="1565014">=</span>&nbsp;<span class="ident" id="1565016">netpollunblock</span><span class="op" id="1565030">(</span><span class="ident" id="1565031">pd</span><span class="op" id="1565033">,</span>&nbsp;<span class="string" id="1565035">&#39;r&#39;</span><span class="op" id="1565038">,</span>&nbsp;<span class="builtintype" id="1565040">false</span><span class="op" id="1565045">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565051">if</span>&nbsp;<span class="ident" id="1565054">pd</span><span class="op" id="1565056">.</span><span class="ident" id="1565057">wd</span>&nbsp;<span class="op" id="1565060">&lt;</span>&nbsp;<span class="num" id="1565062">0</span>&nbsp;<span class="op" id="1565064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565068">wg</span>&nbsp;<span class="op" id="1565071">=</span>&nbsp;<span class="ident" id="1565073">netpollunblock</span><span class="op" id="1565087">(</span><span class="ident" id="1565088">pd</span><span class="op" id="1565090">,</span>&nbsp;<span class="string" id="1565092">&#39;w&#39;</span><span class="op" id="1565095">,</span>&nbsp;<span class="builtintype" id="1565097">false</span><span class="op" id="1565102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565108">unlock</span><span class="op" id="1565114">(</span><span class="op" id="1565115">&amp;</span><span class="ident" id="1565116">pd</span><span class="op" id="1565118">.</span><span class="ident" id="1565119">lock</span><span class="op" id="1565123">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565126">if</span>&nbsp;<span class="ident" id="1565129">rg</span>&nbsp;<span class="op" id="1565132">!=</span>&nbsp;<span class="ident" id="1565135">nil</span>&nbsp;<span class="op" id="1565139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565143">goready</span><span class="op" id="1565150">(</span><span class="ident" id="1565151">rg</span><span class="op" id="1565153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565159">if</span>&nbsp;<span class="ident" id="1565162">wg</span>&nbsp;<span class="op" id="1565165">!=</span>&nbsp;<span class="ident" id="1565168">nil</span>&nbsp;<span class="op" id="1565172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565176">goready</span><span class="op" id="1565183">(</span><span class="ident" id="1565184">wg</span><span class="op" id="1565186">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565189">}</span><br>
<span class="lineno"></span><span class="op" id="1565191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1565194">func</span>&nbsp;<span class="ident" id="1565199">netpollUnblock</span><span class="op" id="1565213">(</span><span class="ident" id="1565214">pd</span>&nbsp;<span class="op" id="1565217">*</span><span class="ident" id="1565218">pollDesc</span><span class="op" id="1565226">)</span>&nbsp;<span class="op" id="1565228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565231">lock</span><span class="op" id="1565235">(</span><span class="op" id="1565236">&amp;</span><span class="ident" id="1565237">pd</span><span class="op" id="1565239">.</span><span class="ident" id="1565240">lock</span><span class="op" id="1565244">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565247">if</span>&nbsp;<span class="ident" id="1565250">pd</span><span class="op" id="1565252">.</span><span class="ident" id="1565253">closing</span>&nbsp;<span class="op" id="1565261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565265">gothrow</span><span class="op" id="1565272">(</span><span class="string" id="1565273">&#34;netpollUnblock:&nbsp;already&nbsp;closing&#34;</span><span class="op" id="1565306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565312">pd</span><span class="op" id="1565314">.</span><span class="ident" id="1565315">closing</span>&nbsp;<span class="op" id="1565323">=</span>&nbsp;<span class="builtintype" id="1565325">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565331">pd</span><span class="op" id="1565333">.</span><span class="ident" id="1565334">seq</span><span class="op" id="1565337">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565341">var</span>&nbsp;<span class="ident" id="1565345">rg</span><span class="op" id="1565347">,</span>&nbsp;<span class="ident" id="1565349">wg</span>&nbsp;<span class="op" id="1565352">*</span><span class="ident" id="1565353">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565356">atomicstorep</span><span class="op" id="1565368">(</span><span class="ident" id="1565369">unsafe</span><span class="op" id="1565375">.</span><span class="ident" id="1565376">Pointer</span><span class="op" id="1565383">(</span><span class="op" id="1565384">&amp;</span><span class="ident" id="1565385">rg</span><span class="op" id="1565387">)</span><span class="op" id="1565388">,</span>&nbsp;<span class="ident" id="1565390">nil</span><span class="op" id="1565393">)</span>&nbsp;<span class="comment" id="1565395">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;closing&nbsp;and&nbsp;read&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565480">rg</span>&nbsp;<span class="op" id="1565483">=</span>&nbsp;<span class="ident" id="1565485">netpollunblock</span><span class="op" id="1565499">(</span><span class="ident" id="1565500">pd</span><span class="op" id="1565502">,</span>&nbsp;<span class="string" id="1565504">&#39;r&#39;</span><span class="op" id="1565507">,</span>&nbsp;<span class="builtintype" id="1565509">false</span><span class="op" id="1565514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565517">wg</span>&nbsp;<span class="op" id="1565520">=</span>&nbsp;<span class="ident" id="1565522">netpollunblock</span><span class="op" id="1565536">(</span><span class="ident" id="1565537">pd</span><span class="op" id="1565539">,</span>&nbsp;<span class="string" id="1565541">&#39;w&#39;</span><span class="op" id="1565544">,</span>&nbsp;<span class="builtintype" id="1565546">false</span><span class="op" id="1565551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565554">if</span>&nbsp;<span class="ident" id="1565557">pd</span><span class="op" id="1565559">.</span><span class="ident" id="1565560">rt</span><span class="op" id="1565562">.</span><span class="ident" id="1565563">f</span>&nbsp;<span class="op" id="1565565">!=</span>&nbsp;<span class="ident" id="1565568">nil</span>&nbsp;<span class="op" id="1565572">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565576">deltimer</span><span class="op" id="1565584">(</span><span class="op" id="1565585">&amp;</span><span class="ident" id="1565586">pd</span><span class="op" id="1565588">.</span><span class="ident" id="1565589">rt</span><span class="op" id="1565591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565595">pd</span><span class="op" id="1565597">.</span><span class="ident" id="1565598">rt</span><span class="op" id="1565600">.</span><span class="ident" id="1565601">f</span>&nbsp;<span class="op" id="1565603">=</span>&nbsp;<span class="ident" id="1565605">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565613">if</span>&nbsp;<span class="ident" id="1565616">pd</span><span class="op" id="1565618">.</span><span class="ident" id="1565619">wt</span><span class="op" id="1565621">.</span><span class="ident" id="1565622">f</span>&nbsp;<span class="op" id="1565624">!=</span>&nbsp;<span class="ident" id="1565627">nil</span>&nbsp;<span class="op" id="1565631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565635">deltimer</span><span class="op" id="1565643">(</span><span class="op" id="1565644">&amp;</span><span class="ident" id="1565645">pd</span><span class="op" id="1565647">.</span><span class="ident" id="1565648">wt</span><span class="op" id="1565650">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565654">pd</span><span class="op" id="1565656">.</span><span class="ident" id="1565657">wt</span><span class="op" id="1565659">.</span><span class="ident" id="1565660">f</span>&nbsp;<span class="op" id="1565662">=</span>&nbsp;<span class="ident" id="1565664">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565672">unlock</span><span class="op" id="1565678">(</span><span class="op" id="1565679">&amp;</span><span class="ident" id="1565680">pd</span><span class="op" id="1565682">.</span><span class="ident" id="1565683">lock</span><span class="op" id="1565687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565690">if</span>&nbsp;<span class="ident" id="1565693">rg</span>&nbsp;<span class="op" id="1565696">!=</span>&nbsp;<span class="ident" id="1565699">nil</span>&nbsp;<span class="op" id="1565703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565707">goready</span><span class="op" id="1565714">(</span><span class="ident" id="1565715">rg</span><span class="op" id="1565717">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565723">if</span>&nbsp;<span class="ident" id="1565726">wg</span>&nbsp;<span class="op" id="1565729">!=</span>&nbsp;<span class="ident" id="1565732">nil</span>&nbsp;<span class="op" id="1565736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565740">goready</span><span class="op" id="1565747">(</span><span class="ident" id="1565748">wg</span><span class="op" id="1565750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565753">}</span><br>
<span class="lineno"></span><span class="op" id="1565755">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="1565758">func</span>&nbsp;<span class="ident" id="1565763">netpollfd</span><span class="op" id="1565772">(</span><span class="ident" id="1565773">pd</span>&nbsp;<span class="op" id="1565776">*</span><span class="ident" id="1565777">pollDesc</span><span class="op" id="1565785">)</span>&nbsp;<span class="builtintype" id="1565787">uintptr</span>&nbsp;<span class="op" id="1565795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565798">return</span>&nbsp;<span class="ident" id="1565805">pd</span><span class="op" id="1565807">.</span><span class="ident" id="1565808">fd</span><br>
<span class="lineno"></span><span class="op" id="1565811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1565814">func</span>&nbsp;<span class="ident" id="1565819">netpolluser</span><span class="op" id="1565830">(</span><span class="ident" id="1565831">pd</span>&nbsp;<span class="op" id="1565834">*</span><span class="ident" id="1565835">pollDesc</span><span class="op" id="1565843">)</span>&nbsp;<span class="op" id="1565845">*</span><span class="ident" id="1565846">unsafe</span><span class="op" id="1565852">.</span><span class="ident" id="1565853">Pointer</span>&nbsp;<span class="op" id="1565861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565864">return</span>&nbsp;<span class="op" id="1565871">&amp;</span><span class="ident" id="1565872">pd</span><span class="op" id="1565874">.</span><span class="ident" id="1565875">user</span><br>
<span class="lineno"></span><span class="op" id="1565880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1565883">func</span>&nbsp;<span class="ident" id="1565888">netpollclosing</span><span class="op" id="1565902">(</span><span class="ident" id="1565903">pd</span>&nbsp;<span class="op" id="1565906">*</span><span class="ident" id="1565907">pollDesc</span><span class="op" id="1565915">)</span>&nbsp;<span class="builtintype" id="1565917">bool</span>&nbsp;<span class="op" id="1565922">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565925">return</span>&nbsp;<span class="ident" id="1565932">pd</span><span class="op" id="1565934">.</span><span class="ident" id="1565935">closing</span><br>
<span class="lineno"></span><span class="op" id="1565943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1565946">func</span>&nbsp;<span class="ident" id="1565951">netpolllock</span><span class="op" id="1565962">(</span><span class="ident" id="1565963">pd</span>&nbsp;<span class="op" id="1565966">*</span><span class="ident" id="1565967">pollDesc</span><span class="op" id="1565975">)</span>&nbsp;<span class="op" id="1565977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565980">lock</span><span class="op" id="1565984">(</span><span class="op" id="1565985">&amp;</span><span class="ident" id="1565986">pd</span><span class="op" id="1565988">.</span><span class="ident" id="1565989">lock</span><span class="op" id="1565993">)</span><br>
<span class="lineno">280</span><span class="op" id="1565995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1565998">func</span>&nbsp;<span class="ident" id="1566003">netpollunlock</span><span class="op" id="1566016">(</span><span class="ident" id="1566017">pd</span>&nbsp;<span class="op" id="1566020">*</span><span class="ident" id="1566021">pollDesc</span><span class="op" id="1566029">)</span>&nbsp;<span class="op" id="1566031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566034">unlock</span><span class="op" id="1566040">(</span><span class="op" id="1566041">&amp;</span><span class="ident" id="1566042">pd</span><span class="op" id="1566044">.</span><span class="ident" id="1566045">lock</span><span class="op" id="1566049">)</span><br>
<span class="lineno"></span><span class="op" id="1566051">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="1566054">//&nbsp;make&nbsp;pd&nbsp;ready,&nbsp;newly&nbsp;runnable&nbsp;goroutines&nbsp;(if&nbsp;any)&nbsp;are&nbsp;returned&nbsp;in&nbsp;rg/wg</span><br>
<span class="lineno"></span><span class="keyword" id="1566129">func</span>&nbsp;<span class="ident" id="1566134">netpollready</span><span class="op" id="1566146">(</span><span class="ident" id="1566147">gpp</span>&nbsp;<span class="op" id="1566151">*</span><span class="op" id="1566152">*</span><span class="ident" id="1566153">g</span><span class="op" id="1566154">,</span>&nbsp;<span class="ident" id="1566156">pd</span>&nbsp;<span class="op" id="1566159">*</span><span class="ident" id="1566160">pollDesc</span><span class="op" id="1566168">,</span>&nbsp;<span class="ident" id="1566170">mode</span>&nbsp;<span class="builtintype" id="1566175">int32</span><span class="op" id="1566180">)</span>&nbsp;<span class="op" id="1566182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566185">var</span>&nbsp;<span class="ident" id="1566189">rg</span><span class="op" id="1566191">,</span>&nbsp;<span class="ident" id="1566193">wg</span>&nbsp;<span class="op" id="1566196">*</span><span class="ident" id="1566197">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566200">if</span>&nbsp;<span class="ident" id="1566203">mode</span>&nbsp;<span class="op" id="1566208">==</span>&nbsp;<span class="string" id="1566211">&#39;r&#39;</span>&nbsp;<span class="op" id="1566215">||</span>&nbsp;<span class="ident" id="1566218">mode</span>&nbsp;<span class="op" id="1566223">==</span>&nbsp;<span class="string" id="1566226">&#39;r&#39;</span><span class="op" id="1566229">+</span><span class="string" id="1566230">&#39;w&#39;</span>&nbsp;<span class="op" id="1566234">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566238">rg</span>&nbsp;<span class="op" id="1566241">=</span>&nbsp;<span class="ident" id="1566243">netpollunblock</span><span class="op" id="1566257">(</span><span class="ident" id="1566258">pd</span><span class="op" id="1566260">,</span>&nbsp;<span class="string" id="1566262">&#39;r&#39;</span><span class="op" id="1566265">,</span>&nbsp;<span class="builtintype" id="1566267">true</span><span class="op" id="1566271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1566274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566277">if</span>&nbsp;<span class="ident" id="1566280">mode</span>&nbsp;<span class="op" id="1566285">==</span>&nbsp;<span class="string" id="1566288">&#39;w&#39;</span>&nbsp;<span class="op" id="1566292">||</span>&nbsp;<span class="ident" id="1566295">mode</span>&nbsp;<span class="op" id="1566300">==</span>&nbsp;<span class="string" id="1566303">&#39;r&#39;</span><span class="op" id="1566306">+</span><span class="string" id="1566307">&#39;w&#39;</span>&nbsp;<span class="op" id="1566311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566315">wg</span>&nbsp;<span class="op" id="1566318">=</span>&nbsp;<span class="ident" id="1566320">netpollunblock</span><span class="op" id="1566334">(</span><span class="ident" id="1566335">pd</span><span class="op" id="1566337">,</span>&nbsp;<span class="string" id="1566339">&#39;w&#39;</span><span class="op" id="1566342">,</span>&nbsp;<span class="builtintype" id="1566344">true</span><span class="op" id="1566348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1566351">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566354">if</span>&nbsp;<span class="ident" id="1566357">rg</span>&nbsp;<span class="op" id="1566360">!=</span>&nbsp;<span class="ident" id="1566363">nil</span>&nbsp;<span class="op" id="1566367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566371">rg</span><span class="op" id="1566373">.</span><span class="ident" id="1566374">schedlink</span>&nbsp;<span class="op" id="1566384">=</span>&nbsp;<span class="op" id="1566386">*</span><span class="ident" id="1566387">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1566393">*</span><span class="ident" id="1566394">gpp</span>&nbsp;<span class="op" id="1566398">=</span>&nbsp;<span class="ident" id="1566400">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1566404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566407">if</span>&nbsp;<span class="ident" id="1566410">wg</span>&nbsp;<span class="op" id="1566413">!=</span>&nbsp;<span class="ident" id="1566416">nil</span>&nbsp;<span class="op" id="1566420">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566424">wg</span><span class="op" id="1566426">.</span><span class="ident" id="1566427">schedlink</span>&nbsp;<span class="op" id="1566437">=</span>&nbsp;<span class="op" id="1566439">*</span><span class="ident" id="1566440">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1566446">*</span><span class="ident" id="1566447">gpp</span>&nbsp;<span class="op" id="1566451">=</span>&nbsp;<span class="ident" id="1566453">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1566457">}</span><br>
<span class="lineno"></span><span class="op" id="1566459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="keyword" id="1566462">func</span>&nbsp;<span class="ident" id="1566467">netpollcheckerr</span><span class="op" id="1566482">(</span><span class="ident" id="1566483">pd</span>&nbsp;<span class="op" id="1566486">*</span><span class="ident" id="1566487">pollDesc</span><span class="op" id="1566495">,</span>&nbsp;<span class="ident" id="1566497">mode</span>&nbsp;<span class="builtintype" id="1566502">int32</span><span class="op" id="1566507">)</span>&nbsp;<span class="builtintype" id="1566509">int</span>&nbsp;<span class="op" id="1566513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566516">if</span>&nbsp;<span class="ident" id="1566519">pd</span><span class="op" id="1566521">.</span><span class="ident" id="1566522">closing</span>&nbsp;<span class="op" id="1566530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566534">return</span>&nbsp;<span class="num" id="1566541">1</span>&nbsp;<span class="comment" id="1566543">//&nbsp;errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1566558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566561">if</span>&nbsp;<span class="op" id="1566564">(</span><span class="ident" id="1566565">mode</span>&nbsp;<span class="op" id="1566570">==</span>&nbsp;<span class="string" id="1566573">&#39;r&#39;</span>&nbsp;<span class="op" id="1566577">&amp;&amp;</span>&nbsp;<span class="ident" id="1566580">pd</span><span class="op" id="1566582">.</span><span class="ident" id="1566583">rd</span>&nbsp;<span class="op" id="1566586">&lt;</span>&nbsp;<span class="num" id="1566588">0</span><span class="op" id="1566589">)</span>&nbsp;<span class="op" id="1566591">||</span>&nbsp;<span class="op" id="1566594">(</span><span class="ident" id="1566595">mode</span>&nbsp;<span class="op" id="1566600">==</span>&nbsp;<span class="string" id="1566603">&#39;w&#39;</span>&nbsp;<span class="op" id="1566607">&amp;&amp;</span>&nbsp;<span class="ident" id="1566610">pd</span><span class="op" id="1566612">.</span><span class="ident" id="1566613">wd</span>&nbsp;<span class="op" id="1566616">&lt;</span>&nbsp;<span class="num" id="1566618">0</span><span class="op" id="1566619">)</span>&nbsp;<span class="op" id="1566621">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566625">return</span>&nbsp;<span class="num" id="1566632">2</span>&nbsp;<span class="comment" id="1566634">//&nbsp;errTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1566649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566652">return</span>&nbsp;<span class="num" id="1566659">0</span><br>
<span class="lineno"></span><span class="op" id="1566661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="keyword" id="1566664">func</span>&nbsp;<span class="ident" id="1566669">netpollblockcommit</span><span class="op" id="1566687">(</span><span class="ident" id="1566688">gp</span>&nbsp;<span class="op" id="1566691">*</span><span class="ident" id="1566692">g</span><span class="op" id="1566693">,</span>&nbsp;<span class="ident" id="1566695">gpp</span>&nbsp;<span class="ident" id="1566699">unsafe</span><span class="op" id="1566705">.</span><span class="ident" id="1566706">Pointer</span><span class="op" id="1566713">)</span>&nbsp;<span class="builtintype" id="1566715">bool</span>&nbsp;<span class="op" id="1566720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566723">return</span>&nbsp;<span class="ident" id="1566730">casuintptr</span><span class="op" id="1566740">(</span><span class="op" id="1566741">(</span><span class="op" id="1566742">*</span><span class="builtintype" id="1566743">uintptr</span><span class="op" id="1566750">)</span><span class="op" id="1566751">(</span><span class="ident" id="1566752">gpp</span><span class="op" id="1566755">)</span><span class="op" id="1566756">,</span>&nbsp;<span class="ident" id="1566758">pdWait</span><span class="op" id="1566764">,</span>&nbsp;<span class="builtintype" id="1566766">uintptr</span><span class="op" id="1566773">(</span><span class="ident" id="1566774">unsafe</span><span class="op" id="1566780">.</span><span class="ident" id="1566781">Pointer</span><span class="op" id="1566788">(</span><span class="ident" id="1566789">gp</span><span class="op" id="1566791">)</span><span class="op" id="1566792">)</span><span class="op" id="1566793">)</span><br>
<span class="lineno"></span><span class="op" id="1566795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1566798">//&nbsp;returns&nbsp;true&nbsp;if&nbsp;IO&nbsp;is&nbsp;ready,&nbsp;or&nbsp;false&nbsp;if&nbsp;timedout&nbsp;or&nbsp;closed</span><br>
<span class="lineno">320</span><span class="comment" id="1566861">//&nbsp;waitio&nbsp;-&nbsp;wait&nbsp;only&nbsp;for&nbsp;completed&nbsp;IO,&nbsp;ignore&nbsp;errors</span><br>
<span class="lineno"></span><span class="keyword" id="1566915">func</span>&nbsp;<span class="ident" id="1566920">netpollblock</span><span class="op" id="1566932">(</span><span class="ident" id="1566933">pd</span>&nbsp;<span class="op" id="1566936">*</span><span class="ident" id="1566937">pollDesc</span><span class="op" id="1566945">,</span>&nbsp;<span class="ident" id="1566947">mode</span>&nbsp;<span class="builtintype" id="1566952">int32</span><span class="op" id="1566957">,</span>&nbsp;<span class="ident" id="1566959">waitio</span>&nbsp;<span class="builtintype" id="1566966">bool</span><span class="op" id="1566970">)</span>&nbsp;<span class="builtintype" id="1566972">bool</span>&nbsp;<span class="op" id="1566977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566980">gpp</span>&nbsp;<span class="op" id="1566984">:=</span>&nbsp;<span class="op" id="1566987">&amp;</span><span class="ident" id="1566988">pd</span><span class="op" id="1566990">.</span><span class="ident" id="1566991">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566995">if</span>&nbsp;<span class="ident" id="1566998">mode</span>&nbsp;<span class="op" id="1567003">==</span>&nbsp;<span class="string" id="1567006">&#39;w&#39;</span>&nbsp;<span class="op" id="1567010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567014">gpp</span>&nbsp;<span class="op" id="1567018">=</span>&nbsp;<span class="op" id="1567020">&amp;</span><span class="ident" id="1567021">pd</span><span class="op" id="1567023">.</span><span class="ident" id="1567024">wg</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1567032">//&nbsp;set&nbsp;the&nbsp;gpp&nbsp;semaphore&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567066">for</span>&nbsp;<span class="op" id="1567070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567074">old</span>&nbsp;<span class="op" id="1567078">:=</span>&nbsp;<span class="op" id="1567081">*</span><span class="ident" id="1567082">gpp</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567088">if</span>&nbsp;<span class="ident" id="1567091">old</span>&nbsp;<span class="op" id="1567095">==</span>&nbsp;<span class="ident" id="1567098">pdReady</span>&nbsp;<span class="op" id="1567106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567111">*</span><span class="ident" id="1567112">gpp</span>&nbsp;<span class="op" id="1567116">=</span>&nbsp;<span class="num" id="1567118">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567123">return</span>&nbsp;<span class="builtintype" id="1567130">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567141">if</span>&nbsp;<span class="ident" id="1567144">old</span>&nbsp;<span class="op" id="1567148">!=</span>&nbsp;<span class="num" id="1567151">0</span>&nbsp;<span class="op" id="1567153">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567158">gothrow</span><span class="op" id="1567165">(</span><span class="string" id="1567166">&#34;netpollblock:&nbsp;double&nbsp;wait&#34;</span><span class="op" id="1567193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567201">if</span>&nbsp;<span class="ident" id="1567204">casuintptr</span><span class="op" id="1567214">(</span><span class="ident" id="1567215">gpp</span><span class="op" id="1567218">,</span>&nbsp;<span class="num" id="1567220">0</span><span class="op" id="1567221">,</span>&nbsp;<span class="ident" id="1567223">pdWait</span><span class="op" id="1567229">)</span>&nbsp;<span class="op" id="1567231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567236">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567244">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1567251">//&nbsp;need&nbsp;to&nbsp;recheck&nbsp;error&nbsp;states&nbsp;after&nbsp;setting&nbsp;gpp&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1567310">//&nbsp;this&nbsp;is&nbsp;necessary&nbsp;because&nbsp;runtime_pollUnblock/runtime_pollSetDeadline/deadlineimpl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1567397">//&nbsp;do&nbsp;the&nbsp;opposite:&nbsp;store&nbsp;to&nbsp;closing/rd/wd,&nbsp;membarrier,&nbsp;load&nbsp;of&nbsp;rg/wg</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567468">if</span>&nbsp;<span class="ident" id="1567471">waitio</span>&nbsp;<span class="op" id="1567478">||</span>&nbsp;<span class="ident" id="1567481">netpollcheckerr</span><span class="op" id="1567496">(</span><span class="ident" id="1567497">pd</span><span class="op" id="1567499">,</span>&nbsp;<span class="ident" id="1567501">mode</span><span class="op" id="1567505">)</span>&nbsp;<span class="op" id="1567507">==</span>&nbsp;<span class="num" id="1567510">0</span>&nbsp;<span class="op" id="1567512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567516">f</span>&nbsp;<span class="op" id="1567518">:=</span>&nbsp;<span class="ident" id="1567521">netpollblockcommit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567542">gopark</span><span class="op" id="1567548">(</span><span class="op" id="1567549">*</span><span class="op" id="1567550">*</span><span class="op" id="1567551">(</span><span class="op" id="1567552">*</span><span class="op" id="1567553">*</span><span class="ident" id="1567554">unsafe</span><span class="op" id="1567560">.</span><span class="ident" id="1567561">Pointer</span><span class="op" id="1567568">)</span><span class="op" id="1567569">(</span><span class="ident" id="1567570">unsafe</span><span class="op" id="1567576">.</span><span class="ident" id="1567577">Pointer</span><span class="op" id="1567584">(</span><span class="op" id="1567585">&amp;</span><span class="ident" id="1567586">f</span><span class="op" id="1567587">)</span><span class="op" id="1567588">)</span><span class="op" id="1567589">,</span>&nbsp;<span class="ident" id="1567591">unsafe</span><span class="op" id="1567597">.</span><span class="ident" id="1567598">Pointer</span><span class="op" id="1567605">(</span><span class="ident" id="1567606">gpp</span><span class="op" id="1567609">)</span><span class="op" id="1567610">,</span>&nbsp;<span class="string" id="1567612">&#34;IO&nbsp;wait&#34;</span><span class="op" id="1567621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1567627">//&nbsp;be&nbsp;careful&nbsp;to&nbsp;not&nbsp;lose&nbsp;concurrent&nbsp;READY&nbsp;notification</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567684">old</span>&nbsp;<span class="op" id="1567688">:=</span>&nbsp;<span class="ident" id="1567691">xchguintptr</span><span class="op" id="1567702">(</span><span class="ident" id="1567703">gpp</span><span class="op" id="1567706">,</span>&nbsp;<span class="num" id="1567708">0</span><span class="op" id="1567709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567712">if</span>&nbsp;<span class="ident" id="1567715">old</span>&nbsp;<span class="op" id="1567719">&gt;</span>&nbsp;<span class="ident" id="1567721">pdWait</span>&nbsp;<span class="op" id="1567728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567732">gothrow</span><span class="op" id="1567739">(</span><span class="string" id="1567740">&#34;netpollblock:&nbsp;corrupted&nbsp;state&#34;</span><span class="op" id="1567771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567777">return</span>&nbsp;<span class="ident" id="1567784">old</span>&nbsp;<span class="op" id="1567788">==</span>&nbsp;<span class="ident" id="1567791">pdReady</span><br>
<span class="lineno">355</span><span class="op" id="1567799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1567802">func</span>&nbsp;<span class="ident" id="1567807">netpollunblock</span><span class="op" id="1567821">(</span><span class="ident" id="1567822">pd</span>&nbsp;<span class="op" id="1567825">*</span><span class="ident" id="1567826">pollDesc</span><span class="op" id="1567834">,</span>&nbsp;<span class="ident" id="1567836">mode</span>&nbsp;<span class="builtintype" id="1567841">int32</span><span class="op" id="1567846">,</span>&nbsp;<span class="ident" id="1567848">ioready</span>&nbsp;<span class="builtintype" id="1567856">bool</span><span class="op" id="1567860">)</span>&nbsp;<span class="op" id="1567862">*</span><span class="ident" id="1567863">g</span>&nbsp;<span class="op" id="1567865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567868">gpp</span>&nbsp;<span class="op" id="1567872">:=</span>&nbsp;<span class="op" id="1567875">&amp;</span><span class="ident" id="1567876">pd</span><span class="op" id="1567878">.</span><span class="ident" id="1567879">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567883">if</span>&nbsp;<span class="ident" id="1567886">mode</span>&nbsp;<span class="op" id="1567891">==</span>&nbsp;<span class="string" id="1567894">&#39;w&#39;</span>&nbsp;<span class="op" id="1567898">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567902">gpp</span>&nbsp;<span class="op" id="1567906">=</span>&nbsp;<span class="op" id="1567908">&amp;</span><span class="ident" id="1567909">pd</span><span class="op" id="1567911">.</span><span class="ident" id="1567912">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567920">for</span>&nbsp;<span class="op" id="1567924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567928">old</span>&nbsp;<span class="op" id="1567932">:=</span>&nbsp;<span class="op" id="1567935">*</span><span class="ident" id="1567936">gpp</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567942">if</span>&nbsp;<span class="ident" id="1567945">old</span>&nbsp;<span class="op" id="1567949">==</span>&nbsp;<span class="ident" id="1567952">pdReady</span>&nbsp;<span class="op" id="1567960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567965">return</span>&nbsp;<span class="ident" id="1567972">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567982">if</span>&nbsp;<span class="ident" id="1567985">old</span>&nbsp;<span class="op" id="1567989">==</span>&nbsp;<span class="num" id="1567992">0</span>&nbsp;<span class="op" id="1567994">&amp;&amp;</span>&nbsp;<span class="op" id="1567997">!</span><span class="ident" id="1567998">ioready</span>&nbsp;<span class="op" id="1568006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1568011">//&nbsp;Only&nbsp;set&nbsp;READY&nbsp;for&nbsp;ioready.&nbsp;runtime_pollWait</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1568062">//&nbsp;will&nbsp;check&nbsp;for&nbsp;timeout/cancel&nbsp;before&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568114">return</span>&nbsp;<span class="ident" id="1568121">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568131">var</span>&nbsp;<span class="builtinfunc" id="1568135">new</span>&nbsp;<span class="builtintype" id="1568139">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568149">if</span>&nbsp;<span class="ident" id="1568152">ioready</span>&nbsp;<span class="op" id="1568160">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1568165">new</span>&nbsp;<span class="op" id="1568169">=</span>&nbsp;<span class="ident" id="1568171">pdReady</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568185">if</span>&nbsp;<span class="ident" id="1568188">casuintptr</span><span class="op" id="1568198">(</span><span class="ident" id="1568199">gpp</span><span class="op" id="1568202">,</span>&nbsp;<span class="ident" id="1568204">old</span><span class="op" id="1568207">,</span>&nbsp;<span class="builtinfunc" id="1568209">new</span><span class="op" id="1568212">)</span>&nbsp;<span class="op" id="1568214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568219">if</span>&nbsp;<span class="ident" id="1568222">old</span>&nbsp;<span class="op" id="1568226">==</span>&nbsp;<span class="ident" id="1568229">pdReady</span>&nbsp;<span class="op" id="1568237">||</span>&nbsp;<span class="ident" id="1568240">old</span>&nbsp;<span class="op" id="1568244">==</span>&nbsp;<span class="ident" id="1568247">pdWait</span>&nbsp;<span class="op" id="1568254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568260">old</span>&nbsp;<span class="op" id="1568264">=</span>&nbsp;<span class="num" id="1568266">0</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568276">return</span>&nbsp;<span class="op" id="1568283">(</span><span class="op" id="1568284">*</span><span class="ident" id="1568285">g</span><span class="op" id="1568286">)</span><span class="op" id="1568287">(</span><span class="ident" id="1568288">unsafe</span><span class="op" id="1568294">.</span><span class="ident" id="1568295">Pointer</span><span class="op" id="1568302">(</span><span class="ident" id="1568303">old</span><span class="op" id="1568306">)</span><span class="op" id="1568307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568314">}</span><br>
<span class="lineno"></span><span class="op" id="1568316">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="keyword" id="1568319">func</span>&nbsp;<span class="ident" id="1568324">netpolldeadlineimpl</span><span class="op" id="1568343">(</span><span class="ident" id="1568344">pd</span>&nbsp;<span class="op" id="1568347">*</span><span class="ident" id="1568348">pollDesc</span><span class="op" id="1568356">,</span>&nbsp;<span class="ident" id="1568358">seq</span>&nbsp;<span class="builtintype" id="1568362">uintptr</span><span class="op" id="1568369">,</span>&nbsp;<span class="ident" id="1568371">read</span><span class="op" id="1568375">,</span>&nbsp;<span class="ident" id="1568377">write</span>&nbsp;<span class="builtintype" id="1568383">bool</span><span class="op" id="1568387">)</span>&nbsp;<span class="op" id="1568389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568392">lock</span><span class="op" id="1568396">(</span><span class="op" id="1568397">&amp;</span><span class="ident" id="1568398">pd</span><span class="op" id="1568400">.</span><span class="ident" id="1568401">lock</span><span class="op" id="1568405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1568408">//&nbsp;Seq&nbsp;arg&nbsp;is&nbsp;seq&nbsp;when&nbsp;the&nbsp;timer&nbsp;was&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1568451">//&nbsp;If&nbsp;it&#39;s&nbsp;stale,&nbsp;ignore&nbsp;the&nbsp;timer&nbsp;event.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568494">if</span>&nbsp;<span class="ident" id="1568497">seq</span>&nbsp;<span class="op" id="1568501">!=</span>&nbsp;<span class="ident" id="1568504">pd</span><span class="op" id="1568506">.</span><span class="ident" id="1568507">seq</span>&nbsp;<span class="op" id="1568511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1568515">//&nbsp;The&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568568">unlock</span><span class="op" id="1568574">(</span><span class="op" id="1568575">&amp;</span><span class="ident" id="1568576">pd</span><span class="op" id="1568578">.</span><span class="ident" id="1568579">lock</span><span class="op" id="1568583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568587">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568595">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568598">var</span>&nbsp;<span class="ident" id="1568602">rg</span>&nbsp;<span class="op" id="1568605">*</span><span class="ident" id="1568606">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568609">if</span>&nbsp;<span class="ident" id="1568612">read</span>&nbsp;<span class="op" id="1568617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568621">if</span>&nbsp;<span class="ident" id="1568624">pd</span><span class="op" id="1568626">.</span><span class="ident" id="1568627">rd</span>&nbsp;<span class="op" id="1568630">&lt;=</span>&nbsp;<span class="num" id="1568633">0</span>&nbsp;<span class="op" id="1568635">||</span>&nbsp;<span class="ident" id="1568638">pd</span><span class="op" id="1568640">.</span><span class="ident" id="1568641">rt</span><span class="op" id="1568643">.</span><span class="ident" id="1568644">f</span>&nbsp;<span class="op" id="1568646">==</span>&nbsp;<span class="ident" id="1568649">nil</span>&nbsp;<span class="op" id="1568653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568658">gothrow</span><span class="op" id="1568665">(</span><span class="string" id="1568666">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;read&nbsp;deadline&#34;</span><span class="op" id="1568715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568719">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568723">pd</span><span class="op" id="1568725">.</span><span class="ident" id="1568726">rd</span>&nbsp;<span class="op" id="1568729">=</span>&nbsp;<span class="op" id="1568731">-</span><span class="num" id="1568732">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568736">atomicstorep</span><span class="op" id="1568748">(</span><span class="ident" id="1568749">unsafe</span><span class="op" id="1568755">.</span><span class="ident" id="1568756">Pointer</span><span class="op" id="1568763">(</span><span class="op" id="1568764">&amp;</span><span class="ident" id="1568765">pd</span><span class="op" id="1568767">.</span><span class="ident" id="1568768">rt</span><span class="op" id="1568770">.</span><span class="ident" id="1568771">f</span><span class="op" id="1568772">)</span><span class="op" id="1568773">,</span>&nbsp;<span class="ident" id="1568775">nil</span><span class="op" id="1568778">)</span>&nbsp;<span class="comment" id="1568780">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;rd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568858">rg</span>&nbsp;<span class="op" id="1568861">=</span>&nbsp;<span class="ident" id="1568863">netpollunblock</span><span class="op" id="1568877">(</span><span class="ident" id="1568878">pd</span><span class="op" id="1568880">,</span>&nbsp;<span class="string" id="1568882">&#39;r&#39;</span><span class="op" id="1568885">,</span>&nbsp;<span class="builtintype" id="1568887">false</span><span class="op" id="1568892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568898">var</span>&nbsp;<span class="ident" id="1568902">wg</span>&nbsp;<span class="op" id="1568905">*</span><span class="ident" id="1568906">g</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568909">if</span>&nbsp;<span class="ident" id="1568912">write</span>&nbsp;<span class="op" id="1568918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568922">if</span>&nbsp;<span class="ident" id="1568925">pd</span><span class="op" id="1568927">.</span><span class="ident" id="1568928">wd</span>&nbsp;<span class="op" id="1568931">&lt;=</span>&nbsp;<span class="num" id="1568934">0</span>&nbsp;<span class="op" id="1568936">||</span>&nbsp;<span class="ident" id="1568939">pd</span><span class="op" id="1568941">.</span><span class="ident" id="1568942">wt</span><span class="op" id="1568944">.</span><span class="ident" id="1568945">f</span>&nbsp;<span class="op" id="1568947">==</span>&nbsp;<span class="ident" id="1568950">nil</span>&nbsp;<span class="op" id="1568954">&amp;&amp;</span>&nbsp;<span class="op" id="1568957">!</span><span class="ident" id="1568958">read</span>&nbsp;<span class="op" id="1568963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568968">gothrow</span><span class="op" id="1568975">(</span><span class="string" id="1568976">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;write&nbsp;deadline&#34;</span><span class="op" id="1569026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1569030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569034">pd</span><span class="op" id="1569036">.</span><span class="ident" id="1569037">wd</span>&nbsp;<span class="op" id="1569040">=</span>&nbsp;<span class="op" id="1569042">-</span><span class="num" id="1569043">1</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569047">atomicstorep</span><span class="op" id="1569059">(</span><span class="ident" id="1569060">unsafe</span><span class="op" id="1569066">.</span><span class="ident" id="1569067">Pointer</span><span class="op" id="1569074">(</span><span class="op" id="1569075">&amp;</span><span class="ident" id="1569076">pd</span><span class="op" id="1569078">.</span><span class="ident" id="1569079">wt</span><span class="op" id="1569081">.</span><span class="ident" id="1569082">f</span><span class="op" id="1569083">)</span><span class="op" id="1569084">,</span>&nbsp;<span class="ident" id="1569086">nil</span><span class="op" id="1569089">)</span>&nbsp;<span class="comment" id="1569091">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;wd&nbsp;and&nbsp;load&nbsp;of&nbsp;wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569169">wg</span>&nbsp;<span class="op" id="1569172">=</span>&nbsp;<span class="ident" id="1569174">netpollunblock</span><span class="op" id="1569188">(</span><span class="ident" id="1569189">pd</span><span class="op" id="1569191">,</span>&nbsp;<span class="string" id="1569193">&#39;w&#39;</span><span class="op" id="1569196">,</span>&nbsp;<span class="builtintype" id="1569198">false</span><span class="op" id="1569203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1569206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569209">unlock</span><span class="op" id="1569215">(</span><span class="op" id="1569216">&amp;</span><span class="ident" id="1569217">pd</span><span class="op" id="1569219">.</span><span class="ident" id="1569220">lock</span><span class="op" id="1569224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1569227">if</span>&nbsp;<span class="ident" id="1569230">rg</span>&nbsp;<span class="op" id="1569233">!=</span>&nbsp;<span class="ident" id="1569236">nil</span>&nbsp;<span class="op" id="1569240">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569244">goready</span><span class="op" id="1569251">(</span><span class="ident" id="1569252">rg</span><span class="op" id="1569254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1569257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1569260">if</span>&nbsp;<span class="ident" id="1569263">wg</span>&nbsp;<span class="op" id="1569266">!=</span>&nbsp;<span class="ident" id="1569269">nil</span>&nbsp;<span class="op" id="1569273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569277">goready</span><span class="op" id="1569284">(</span><span class="ident" id="1569285">wg</span><span class="op" id="1569287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1569290">}</span><br>
<span class="lineno">420</span><span class="op" id="1569292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1569295">func</span>&nbsp;<span class="ident" id="1569300">netpollDeadline</span><span class="op" id="1569315">(</span><span class="ident" id="1569316">arg</span>&nbsp;<span class="keyword" id="1569320">interface</span><span class="op" id="1569329">{</span><span class="op" id="1569330">}</span><span class="op" id="1569331">,</span>&nbsp;<span class="ident" id="1569333">seq</span>&nbsp;<span class="builtintype" id="1569337">uintptr</span><span class="op" id="1569344">)</span>&nbsp;<span class="op" id="1569346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569349">netpolldeadlineimpl</span><span class="op" id="1569368">(</span><span class="ident" id="1569369">arg</span><span class="op" id="1569372">.</span><span class="op" id="1569373">(</span><span class="op" id="1569374">*</span><span class="ident" id="1569375">pollDesc</span><span class="op" id="1569383">)</span><span class="op" id="1569384">,</span>&nbsp;<span class="ident" id="1569386">seq</span><span class="op" id="1569389">,</span>&nbsp;<span class="builtintype" id="1569391">true</span><span class="op" id="1569395">,</span>&nbsp;<span class="builtintype" id="1569397">true</span><span class="op" id="1569401">)</span><br>
<span class="lineno"></span><span class="op" id="1569403">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="1569406">func</span>&nbsp;<span class="ident" id="1569411">netpollReadDeadline</span><span class="op" id="1569430">(</span><span class="ident" id="1569431">arg</span>&nbsp;<span class="keyword" id="1569435">interface</span><span class="op" id="1569444">{</span><span class="op" id="1569445">}</span><span class="op" id="1569446">,</span>&nbsp;<span class="ident" id="1569448">seq</span>&nbsp;<span class="builtintype" id="1569452">uintptr</span><span class="op" id="1569459">)</span>&nbsp;<span class="op" id="1569461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569464">netpolldeadlineimpl</span><span class="op" id="1569483">(</span><span class="ident" id="1569484">arg</span><span class="op" id="1569487">.</span><span class="op" id="1569488">(</span><span class="op" id="1569489">*</span><span class="ident" id="1569490">pollDesc</span><span class="op" id="1569498">)</span><span class="op" id="1569499">,</span>&nbsp;<span class="ident" id="1569501">seq</span><span class="op" id="1569504">,</span>&nbsp;<span class="builtintype" id="1569506">true</span><span class="op" id="1569510">,</span>&nbsp;<span class="builtintype" id="1569512">false</span><span class="op" id="1569517">)</span><br>
<span class="lineno"></span><span class="op" id="1569519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="keyword" id="1569522">func</span>&nbsp;<span class="ident" id="1569527">netpollWriteDeadline</span><span class="op" id="1569547">(</span><span class="ident" id="1569548">arg</span>&nbsp;<span class="keyword" id="1569552">interface</span><span class="op" id="1569561">{</span><span class="op" id="1569562">}</span><span class="op" id="1569563">,</span>&nbsp;<span class="ident" id="1569565">seq</span>&nbsp;<span class="builtintype" id="1569569">uintptr</span><span class="op" id="1569576">)</span>&nbsp;<span class="op" id="1569578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569581">netpolldeadlineimpl</span><span class="op" id="1569600">(</span><span class="ident" id="1569601">arg</span><span class="op" id="1569604">.</span><span class="op" id="1569605">(</span><span class="op" id="1569606">*</span><span class="ident" id="1569607">pollDesc</span><span class="op" id="1569615">)</span><span class="op" id="1569616">,</span>&nbsp;<span class="ident" id="1569618">seq</span><span class="op" id="1569621">,</span>&nbsp;<span class="builtintype" id="1569623">false</span><span class="op" id="1569628">,</span>&nbsp;<span class="builtintype" id="1569630">true</span><span class="op" id="1569634">)</span><br>
<span class="lineno"></span><span class="op" id="1569636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1569639">func</span>&nbsp;<span class="op" id="1569644">(</span><span class="ident" id="1569645">c</span>&nbsp;<span class="op" id="1569647">*</span><span class="ident" id="1569648">pollCache</span><span class="op" id="1569657">)</span>&nbsp;<span class="ident" id="1569659">alloc</span><span class="op" id="1569664">(</span><span class="op" id="1569665">)</span>&nbsp;<span class="op" id="1569667">*</span><span class="ident" id="1569668">pollDesc</span>&nbsp;<span class="op" id="1569677">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569680">lock</span><span class="op" id="1569684">(</span><span class="op" id="1569685">&amp;</span><span class="ident" id="1569686">c</span><span class="op" id="1569687">.</span><span class="ident" id="1569688">lock</span><span class="op" id="1569692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1569695">if</span>&nbsp;<span class="ident" id="1569698">c</span><span class="op" id="1569699">.</span><span class="ident" id="1569700">first</span>&nbsp;<span class="op" id="1569706">==</span>&nbsp;<span class="ident" id="1569709">nil</span>&nbsp;<span class="op" id="1569713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1569717">const</span>&nbsp;<span class="ident" id="1569723">pdSize</span>&nbsp;<span class="op" id="1569730">=</span>&nbsp;<span class="ident" id="1569732">unsafe</span><span class="op" id="1569738">.</span><span class="ident" id="1569739">Sizeof</span><span class="op" id="1569745">(</span><span class="ident" id="1569746">pollDesc</span><span class="op" id="1569754">{</span><span class="op" id="1569755">}</span><span class="op" id="1569756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569760">n</span>&nbsp;<span class="op" id="1569762">:=</span>&nbsp;<span class="ident" id="1569765">pollBlockSize</span>&nbsp;<span class="op" id="1569779">/</span>&nbsp;<span class="ident" id="1569781">pdSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1569790">if</span>&nbsp;<span class="ident" id="1569793">n</span>&nbsp;<span class="op" id="1569795">==</span>&nbsp;<span class="num" id="1569798">0</span>&nbsp;<span class="op" id="1569800">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569805">n</span>&nbsp;<span class="op" id="1569807">=</span>&nbsp;<span class="num" id="1569809">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1569813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1569817">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;non-GC&nbsp;memory&nbsp;because&nbsp;can&nbsp;be&nbsp;referenced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1569873">//&nbsp;only&nbsp;from&nbsp;epoll/kqueue&nbsp;internals.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569912">mem</span>&nbsp;<span class="op" id="1569916">:=</span>&nbsp;<span class="ident" id="1569919">persistentalloc</span><span class="op" id="1569934">(</span><span class="ident" id="1569935">n</span><span class="op" id="1569936">*</span><span class="ident" id="1569937">pdSize</span><span class="op" id="1569943">,</span>&nbsp;<span class="num" id="1569945">0</span><span class="op" id="1569946">,</span>&nbsp;<span class="op" id="1569948">&amp;</span><span class="ident" id="1569949">memstats</span><span class="op" id="1569957">.</span><span class="ident" id="1569958">other_sys</span><span class="op" id="1569967">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1569971">for</span>&nbsp;<span class="ident" id="1569975">i</span>&nbsp;<span class="op" id="1569977">:=</span>&nbsp;<span class="builtintype" id="1569980">uintptr</span><span class="op" id="1569987">(</span><span class="num" id="1569988">0</span><span class="op" id="1569989">)</span><span class="op" id="1569990">;</span>&nbsp;<span class="ident" id="1569992">i</span>&nbsp;<span class="op" id="1569994">&lt;</span>&nbsp;<span class="ident" id="1569996">n</span><span class="op" id="1569997">;</span>&nbsp;<span class="ident" id="1569999">i</span><span class="op" id="1570000">++</span>&nbsp;<span class="op" id="1570003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1570008">pd</span>&nbsp;<span class="op" id="1570011">:=</span>&nbsp;<span class="op" id="1570014">(</span><span class="op" id="1570015">*</span><span class="ident" id="1570016">pollDesc</span><span class="op" id="1570024">)</span><span class="op" id="1570025">(</span><span class="ident" id="1570026">add</span><span class="op" id="1570029">(</span><span class="ident" id="1570030">mem</span><span class="op" id="1570033">,</span>&nbsp;<span class="ident" id="1570035">i</span><span class="op" id="1570036">*</span><span class="ident" id="1570037">pdSize</span><span class="op" id="1570043">)</span><span class="op" id="1570044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1570049">pd</span><span class="op" id="1570051">.</span><span class="ident" id="1570052">link</span>&nbsp;<span class="op" id="1570057">=</span>&nbsp;<span class="ident" id="1570059">c</span><span class="op" id="1570060">.</span><span class="ident" id="1570061">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1570070">c</span><span class="op" id="1570071">.</span><span class="ident" id="1570072">first</span>&nbsp;<span class="op" id="1570078">=</span>&nbsp;<span class="ident" id="1570080">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1570085">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1570088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1570091">pd</span>&nbsp;<span class="op" id="1570094">:=</span>&nbsp;<span class="ident" id="1570097">c</span><span class="op" id="1570098">.</span><span class="ident" id="1570099">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1570106">c</span><span class="op" id="1570107">.</span><span class="ident" id="1570108">first</span>&nbsp;<span class="op" id="1570114">=</span>&nbsp;<span class="ident" id="1570116">pd</span><span class="op" id="1570118">.</span><span class="ident" id="1570119">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1570125">unlock</span><span class="op" id="1570131">(</span><span class="op" id="1570132">&amp;</span><span class="ident" id="1570133">c</span><span class="op" id="1570134">.</span><span class="ident" id="1570135">lock</span><span class="op" id="1570139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1570142">return</span>&nbsp;<span class="ident" id="1570149">pd</span><br>
<span class="lineno">455</span><span class="op" id="1570152">}</span>
</div>
</body>
</html>
