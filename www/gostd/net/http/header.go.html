<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3011275">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3011331">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3011385">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3011436">package</span>&nbsp;<span class="ident" id="3011444">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3011450">import</span>&nbsp;<span class="op" id="3011457">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3011460">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3011466">&#34;net/textproto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3011483">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3011491">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3011502">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3011510">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3011517">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3011520">var</span>&nbsp;<span class="ident" id="3011524">raceEnabled</span>&nbsp;<span class="op" id="3011536">=</span>&nbsp;<span class="builtintype" id="3011538">false</span>&nbsp;<span class="comment" id="3011544">//&nbsp;set&nbsp;by&nbsp;race.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3011563">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="3011625">type</span>&nbsp;<span class="ident" id="3011630">Header</span>&nbsp;<span class="keyword" id="3011637">map</span><span class="op" id="3011640">[</span><span class="builtintype" id="3011641">string</span><span class="op" id="3011647">]</span><span class="op" id="3011648">[</span><span class="op" id="3011649">]</span><span class="builtintype" id="3011650">string</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="3011658">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;key,&nbsp;value&nbsp;pair&nbsp;to&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="3011705">//&nbsp;It&nbsp;appends&nbsp;to&nbsp;any&nbsp;existing&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3011763">func</span>&nbsp;<span class="op" id="3011768">(</span><span class="ident" id="3011769">h</span>&nbsp;<span class="ident" id="3011771">Header</span><span class="op" id="3011777">)</span>&nbsp;<span class="ident" id="3011779">Add</span><span class="op" id="3011782">(</span><span class="ident" id="3011783">key</span><span class="op" id="3011786">,</span>&nbsp;<span class="ident" id="3011788">value</span>&nbsp;<span class="builtintype" id="3011794">string</span><span class="op" id="3011800">)</span>&nbsp;<span class="op" id="3011802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3011805">textproto</span><span class="op" id="3011814">.</span><span class="ident" id="3011815">MIMEHeader</span><span class="op" id="3011825">(</span><span class="ident" id="3011826">h</span><span class="op" id="3011827">)</span><span class="op" id="3011828">.</span><span class="ident" id="3011829">Add</span><span class="op" id="3011832">(</span><span class="ident" id="3011833">key</span><span class="op" id="3011836">,</span>&nbsp;<span class="ident" id="3011838">value</span><span class="op" id="3011843">)</span><br>
<span class="lineno">25</span><span class="op" id="3011845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3011848">//&nbsp;Set&nbsp;sets&nbsp;the&nbsp;header&nbsp;entries&nbsp;associated&nbsp;with&nbsp;key&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3011902">//&nbsp;the&nbsp;single&nbsp;element&nbsp;value.&nbsp;&nbsp;It&nbsp;replaces&nbsp;any&nbsp;existing</span><br>
<span class="lineno"></span><span class="comment" id="3011957">//&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno">30</span><span class="keyword" id="3011988">func</span>&nbsp;<span class="op" id="3011993">(</span><span class="ident" id="3011994">h</span>&nbsp;<span class="ident" id="3011996">Header</span><span class="op" id="3012002">)</span>&nbsp;<span class="ident" id="3012004">Set</span><span class="op" id="3012007">(</span><span class="ident" id="3012008">key</span><span class="op" id="3012011">,</span>&nbsp;<span class="ident" id="3012013">value</span>&nbsp;<span class="builtintype" id="3012019">string</span><span class="op" id="3012025">)</span>&nbsp;<span class="op" id="3012027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3012030">textproto</span><span class="op" id="3012039">.</span><span class="ident" id="3012040">MIMEHeader</span><span class="op" id="3012050">(</span><span class="ident" id="3012051">h</span><span class="op" id="3012052">)</span><span class="op" id="3012053">.</span><span class="ident" id="3012054">Set</span><span class="op" id="3012057">(</span><span class="ident" id="3012058">key</span><span class="op" id="3012061">,</span>&nbsp;<span class="ident" id="3012063">value</span><span class="op" id="3012068">)</span><br>
<span class="lineno"></span><span class="op" id="3012070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3012073">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno">35</span><span class="comment" id="3012132">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3012199">//&nbsp;To&nbsp;access&nbsp;multiple&nbsp;values&nbsp;of&nbsp;a&nbsp;key,&nbsp;access&nbsp;the&nbsp;map&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="3012262">//&nbsp;with&nbsp;CanonicalHeaderKey.</span><br>
<span class="lineno"></span><span class="keyword" id="3012290">func</span>&nbsp;<span class="op" id="3012295">(</span><span class="ident" id="3012296">h</span>&nbsp;<span class="ident" id="3012298">Header</span><span class="op" id="3012304">)</span>&nbsp;<span class="ident" id="3012306">Get</span><span class="op" id="3012309">(</span><span class="ident" id="3012310">key</span>&nbsp;<span class="builtintype" id="3012314">string</span><span class="op" id="3012320">)</span>&nbsp;<span class="builtintype" id="3012322">string</span>&nbsp;<span class="op" id="3012329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012332">return</span>&nbsp;<span class="ident" id="3012339">textproto</span><span class="op" id="3012348">.</span><span class="ident" id="3012349">MIMEHeader</span><span class="op" id="3012359">(</span><span class="ident" id="3012360">h</span><span class="op" id="3012361">)</span><span class="op" id="3012362">.</span><span class="ident" id="3012363">Get</span><span class="op" id="3012366">(</span><span class="ident" id="3012367">key</span><span class="op" id="3012370">)</span><br>
<span class="lineno">40</span><span class="op" id="3012372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3012375">//&nbsp;get&nbsp;is&nbsp;like&nbsp;Get,&nbsp;but&nbsp;key&nbsp;must&nbsp;already&nbsp;be&nbsp;in&nbsp;CanonicalHeaderKey&nbsp;form.</span><br>
<span class="lineno"></span><span class="keyword" id="3012447">func</span>&nbsp;<span class="op" id="3012452">(</span><span class="ident" id="3012453">h</span>&nbsp;<span class="ident" id="3012455">Header</span><span class="op" id="3012461">)</span>&nbsp;<span class="ident" id="3012463">get</span><span class="op" id="3012466">(</span><span class="ident" id="3012467">key</span>&nbsp;<span class="builtintype" id="3012471">string</span><span class="op" id="3012477">)</span>&nbsp;<span class="builtintype" id="3012479">string</span>&nbsp;<span class="op" id="3012486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012489">if</span>&nbsp;<span class="ident" id="3012492">v</span>&nbsp;<span class="op" id="3012494">:=</span>&nbsp;<span class="ident" id="3012497">h</span><span class="op" id="3012498">[</span><span class="ident" id="3012499">key</span><span class="op" id="3012502">]</span><span class="op" id="3012503">;</span>&nbsp;<span class="builtinfunc" id="3012505">len</span><span class="op" id="3012508">(</span><span class="ident" id="3012509">v</span><span class="op" id="3012510">)</span>&nbsp;<span class="op" id="3012512">&gt;</span>&nbsp;<span class="num" id="3012514">0</span>&nbsp;<span class="op" id="3012516">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012520">return</span>&nbsp;<span class="ident" id="3012527">v</span><span class="op" id="3012528">[</span><span class="num" id="3012529">0</span><span class="op" id="3012530">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3012533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012536">return</span>&nbsp;<span class="string" id="3012543">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3012546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3012549">//&nbsp;Del&nbsp;deletes&nbsp;the&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3012596">func</span>&nbsp;<span class="op" id="3012601">(</span><span class="ident" id="3012602">h</span>&nbsp;<span class="ident" id="3012604">Header</span><span class="op" id="3012610">)</span>&nbsp;<span class="ident" id="3012612">Del</span><span class="op" id="3012615">(</span><span class="ident" id="3012616">key</span>&nbsp;<span class="builtintype" id="3012620">string</span><span class="op" id="3012626">)</span>&nbsp;<span class="op" id="3012628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3012631">textproto</span><span class="op" id="3012640">.</span><span class="ident" id="3012641">MIMEHeader</span><span class="op" id="3012651">(</span><span class="ident" id="3012652">h</span><span class="op" id="3012653">)</span><span class="op" id="3012654">.</span><span class="ident" id="3012655">Del</span><span class="op" id="3012658">(</span><span class="ident" id="3012659">key</span><span class="op" id="3012662">)</span><br>
<span class="lineno"></span><span class="op" id="3012664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3012667">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="3012708">func</span>&nbsp;<span class="op" id="3012713">(</span><span class="ident" id="3012714">h</span>&nbsp;<span class="ident" id="3012716">Header</span><span class="op" id="3012722">)</span>&nbsp;<span class="ident" id="3012724">Write</span><span class="op" id="3012729">(</span><span class="ident" id="3012730">w</span>&nbsp;<span class="ident" id="3012732">io</span><span class="op" id="3012734">.</span><span class="ident" id="3012735">Writer</span><span class="op" id="3012741">)</span>&nbsp;<span class="builtintype" id="3012743">error</span>&nbsp;<span class="op" id="3012749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012752">return</span>&nbsp;<span class="ident" id="3012759">h</span><span class="op" id="3012760">.</span><span class="ident" id="3012761">WriteSubset</span><span class="op" id="3012772">(</span><span class="ident" id="3012773">w</span><span class="op" id="3012774">,</span>&nbsp;<span class="ident" id="3012776">nil</span><span class="op" id="3012779">)</span><br>
<span class="lineno"></span><span class="op" id="3012781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3012784">func</span>&nbsp;<span class="op" id="3012789">(</span><span class="ident" id="3012790">h</span>&nbsp;<span class="ident" id="3012792">Header</span><span class="op" id="3012798">)</span>&nbsp;<span class="ident" id="3012800">clone</span><span class="op" id="3012805">(</span><span class="op" id="3012806">)</span>&nbsp;<span class="ident" id="3012808">Header</span>&nbsp;<span class="op" id="3012815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3012818">h2</span>&nbsp;<span class="op" id="3012821">:=</span>&nbsp;<span class="builtinfunc" id="3012824">make</span><span class="op" id="3012828">(</span><span class="ident" id="3012829">Header</span><span class="op" id="3012835">,</span>&nbsp;<span class="builtinfunc" id="3012837">len</span><span class="op" id="3012840">(</span><span class="ident" id="3012841">h</span><span class="op" id="3012842">)</span><span class="op" id="3012843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012846">for</span>&nbsp;<span class="ident" id="3012850">k</span><span class="op" id="3012851">,</span>&nbsp;<span class="ident" id="3012853">vv</span>&nbsp;<span class="op" id="3012856">:=</span>&nbsp;<span class="keyword" id="3012859">range</span>&nbsp;<span class="ident" id="3012865">h</span>&nbsp;<span class="op" id="3012867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3012871">vv2</span>&nbsp;<span class="op" id="3012875">:=</span>&nbsp;<span class="builtinfunc" id="3012878">make</span><span class="op" id="3012882">(</span><span class="op" id="3012883">[</span><span class="op" id="3012884">]</span><span class="builtintype" id="3012885">string</span><span class="op" id="3012891">,</span>&nbsp;<span class="builtinfunc" id="3012893">len</span><span class="op" id="3012896">(</span><span class="ident" id="3012897">vv</span><span class="op" id="3012899">)</span><span class="op" id="3012900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3012904">copy</span><span class="op" id="3012908">(</span><span class="ident" id="3012909">vv2</span><span class="op" id="3012912">,</span>&nbsp;<span class="ident" id="3012914">vv</span><span class="op" id="3012916">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3012920">h2</span><span class="op" id="3012922">[</span><span class="ident" id="3012923">k</span><span class="op" id="3012924">]</span>&nbsp;<span class="op" id="3012926">=</span>&nbsp;<span class="ident" id="3012928">vv2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3012933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012936">return</span>&nbsp;<span class="ident" id="3012943">h2</span><br>
<span class="lineno"></span><span class="op" id="3012946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3012949">var</span>&nbsp;<span class="ident" id="3012953">timeFormats</span>&nbsp;<span class="op" id="3012965">=</span>&nbsp;<span class="op" id="3012967">[</span><span class="op" id="3012968">]</span><span class="builtintype" id="3012969">string</span><span class="op" id="3012975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3012978">TimeFormat</span><span class="op" id="3012988">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3012991">time</span><span class="op" id="3012995">.</span><span class="ident" id="3012996">RFC850</span><span class="op" id="3013002">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3013005">time</span><span class="op" id="3013009">.</span><span class="ident" id="3013010">ANSIC</span><span class="op" id="3013015">,</span><br>
<span class="lineno"></span><span class="op" id="3013017">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="3013020">//&nbsp;ParseTime&nbsp;parses&nbsp;a&nbsp;time&nbsp;header&nbsp;(such&nbsp;as&nbsp;the&nbsp;Date:&nbsp;header),</span><br>
<span class="lineno"></span><span class="comment" id="3013082">//&nbsp;trying&nbsp;each&nbsp;of&nbsp;the&nbsp;three&nbsp;formats&nbsp;allowed&nbsp;by&nbsp;HTTP/1.1:</span><br>
<span class="lineno"></span><span class="comment" id="3013139">//&nbsp;TimeFormat,&nbsp;time.RFC850,&nbsp;and&nbsp;time.ANSIC.</span><br>
<span class="lineno"></span><span class="keyword" id="3013183">func</span>&nbsp;<span class="ident" id="3013188">ParseTime</span><span class="op" id="3013197">(</span><span class="ident" id="3013198">text</span>&nbsp;<span class="builtintype" id="3013203">string</span><span class="op" id="3013209">)</span>&nbsp;<span class="op" id="3013211">(</span><span class="ident" id="3013212">t</span>&nbsp;<span class="ident" id="3013214">time</span><span class="op" id="3013218">.</span><span class="ident" id="3013219">Time</span><span class="op" id="3013223">,</span>&nbsp;<span class="ident" id="3013225">err</span>&nbsp;<span class="builtintype" id="3013229">error</span><span class="op" id="3013234">)</span>&nbsp;<span class="op" id="3013236">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3013239">for</span>&nbsp;<span class="ident" id="3013243">_</span><span class="op" id="3013244">,</span>&nbsp;<span class="ident" id="3013246">layout</span>&nbsp;<span class="op" id="3013253">:=</span>&nbsp;<span class="keyword" id="3013256">range</span>&nbsp;<span class="ident" id="3013262">timeFormats</span>&nbsp;<span class="op" id="3013274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3013278">t</span><span class="op" id="3013279">,</span>&nbsp;<span class="ident" id="3013281">err</span>&nbsp;<span class="op" id="3013285">=</span>&nbsp;<span class="ident" id="3013287">time</span><span class="op" id="3013291">.</span><span class="ident" id="3013292">Parse</span><span class="op" id="3013297">(</span><span class="ident" id="3013298">layout</span><span class="op" id="3013304">,</span>&nbsp;<span class="ident" id="3013306">text</span><span class="op" id="3013310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3013314">if</span>&nbsp;<span class="ident" id="3013317">err</span>&nbsp;<span class="op" id="3013321">==</span>&nbsp;<span class="ident" id="3013324">nil</span>&nbsp;<span class="op" id="3013328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3013333">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3013342">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3013345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3013348">return</span><br>
<span class="lineno"></span><span class="op" id="3013355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3013358">var</span>&nbsp;<span class="ident" id="3013362">headerNewlineToSpace</span>&nbsp;<span class="op" id="3013383">=</span>&nbsp;<span class="ident" id="3013385">strings</span><span class="op" id="3013392">.</span><span class="ident" id="3013393">NewReplacer</span><span class="op" id="3013404">(</span><span class="string" id="3013405">&#34;\n&#34;</span><span class="op" id="3013409">,</span>&nbsp;<span class="string" id="3013411">&#34;&nbsp;&#34;</span><span class="op" id="3013414">,</span>&nbsp;<span class="string" id="3013416">&#34;\r&#34;</span><span class="op" id="3013420">,</span>&nbsp;<span class="string" id="3013422">&#34;&nbsp;&#34;</span><span class="op" id="3013425">)</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="3013428">type</span>&nbsp;<span class="ident" id="3013433">writeStringer</span>&nbsp;<span class="keyword" id="3013447">interface</span>&nbsp;<span class="op" id="3013457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3013460">WriteString</span><span class="op" id="3013471">(</span><span class="builtintype" id="3013472">string</span><span class="op" id="3013478">)</span>&nbsp;<span class="op" id="3013480">(</span><span class="builtintype" id="3013481">int</span><span class="op" id="3013484">,</span>&nbsp;<span class="builtintype" id="3013486">error</span><span class="op" id="3013491">)</span><br>
<span class="lineno"></span><span class="op" id="3013493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3013496">//&nbsp;stringWriter&nbsp;implements&nbsp;WriteString&nbsp;on&nbsp;a&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3013548">type</span>&nbsp;<span class="ident" id="3013553">stringWriter</span>&nbsp;<span class="keyword" id="3013566">struct</span>&nbsp;<span class="op" id="3013573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3013576">w</span>&nbsp;<span class="ident" id="3013578">io</span><span class="op" id="3013580">.</span><span class="ident" id="3013581">Writer</span><br>
<span class="lineno"></span><span class="op" id="3013588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="3013591">func</span>&nbsp;<span class="op" id="3013596">(</span><span class="ident" id="3013597">w</span>&nbsp;<span class="ident" id="3013599">stringWriter</span><span class="op" id="3013611">)</span>&nbsp;<span class="ident" id="3013613">WriteString</span><span class="op" id="3013624">(</span><span class="ident" id="3013625">s</span>&nbsp;<span class="builtintype" id="3013627">string</span><span class="op" id="3013633">)</span>&nbsp;<span class="op" id="3013635">(</span><span class="ident" id="3013636">n</span>&nbsp;<span class="builtintype" id="3013638">int</span><span class="op" id="3013641">,</span>&nbsp;<span class="ident" id="3013643">err</span>&nbsp;<span class="builtintype" id="3013647">error</span><span class="op" id="3013652">)</span>&nbsp;<span class="op" id="3013654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3013657">return</span>&nbsp;<span class="ident" id="3013664">w</span><span class="op" id="3013665">.</span><span class="ident" id="3013666">w</span><span class="op" id="3013667">.</span><span class="ident" id="3013668">Write</span><span class="op" id="3013673">(</span><span class="op" id="3013674">[</span><span class="op" id="3013675">]</span><span class="builtintype" id="3013676">byte</span><span class="op" id="3013680">(</span><span class="ident" id="3013681">s</span><span class="op" id="3013682">)</span><span class="op" id="3013683">)</span><br>
<span class="lineno"></span><span class="op" id="3013685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3013688">type</span>&nbsp;<span class="ident" id="3013693">keyValues</span>&nbsp;<span class="keyword" id="3013703">struct</span>&nbsp;<span class="op" id="3013710">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3013713">key</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3013720">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3013728">values</span>&nbsp;<span class="op" id="3013735">[</span><span class="op" id="3013736">]</span><span class="builtintype" id="3013737">string</span><br>
<span class="lineno"></span><span class="op" id="3013744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3013747">//&nbsp;A&nbsp;headerSorter&nbsp;implements&nbsp;sort.Interface&nbsp;by&nbsp;sorting&nbsp;a&nbsp;[]keyValues</span><br>
<span class="lineno">110</span><span class="comment" id="3013816">//&nbsp;by&nbsp;key.&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;pointer,&nbsp;so&nbsp;it&nbsp;can&nbsp;fit&nbsp;in&nbsp;a&nbsp;sort.Interface</span><br>
<span class="lineno"></span><span class="comment" id="3013885">//&nbsp;interface&nbsp;value&nbsp;without&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3013924">type</span>&nbsp;<span class="ident" id="3013929">headerSorter</span>&nbsp;<span class="keyword" id="3013942">struct</span>&nbsp;<span class="op" id="3013949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3013952">kvs</span>&nbsp;<span class="op" id="3013956">[</span><span class="op" id="3013957">]</span><span class="ident" id="3013958">keyValues</span><br>
<span class="lineno"></span><span class="op" id="3013968">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="3013971">func</span>&nbsp;<span class="op" id="3013976">(</span><span class="ident" id="3013977">s</span>&nbsp;<span class="op" id="3013979">*</span><span class="ident" id="3013980">headerSorter</span><span class="op" id="3013992">)</span>&nbsp;<span class="ident" id="3013994">Len</span><span class="op" id="3013997">(</span><span class="op" id="3013998">)</span>&nbsp;<span class="builtintype" id="3014000">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3014014">{</span>&nbsp;<span class="keyword" id="3014016">return</span>&nbsp;<span class="builtinfunc" id="3014023">len</span><span class="op" id="3014026">(</span><span class="ident" id="3014027">s</span><span class="op" id="3014028">.</span><span class="ident" id="3014029">kvs</span><span class="op" id="3014032">)</span>&nbsp;<span class="op" id="3014034">}</span><br>
<span class="lineno"></span><span class="keyword" id="3014036">func</span>&nbsp;<span class="op" id="3014041">(</span><span class="ident" id="3014042">s</span>&nbsp;<span class="op" id="3014044">*</span><span class="ident" id="3014045">headerSorter</span><span class="op" id="3014057">)</span>&nbsp;<span class="ident" id="3014059">Swap</span><span class="op" id="3014063">(</span><span class="ident" id="3014064">i</span><span class="op" id="3014065">,</span>&nbsp;<span class="ident" id="3014067">j</span>&nbsp;<span class="builtintype" id="3014069">int</span><span class="op" id="3014072">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3014079">{</span>&nbsp;<span class="ident" id="3014081">s</span><span class="op" id="3014082">.</span><span class="ident" id="3014083">kvs</span><span class="op" id="3014086">[</span><span class="ident" id="3014087">i</span><span class="op" id="3014088">]</span><span class="op" id="3014089">,</span>&nbsp;<span class="ident" id="3014091">s</span><span class="op" id="3014092">.</span><span class="ident" id="3014093">kvs</span><span class="op" id="3014096">[</span><span class="ident" id="3014097">j</span><span class="op" id="3014098">]</span>&nbsp;<span class="op" id="3014100">=</span>&nbsp;<span class="ident" id="3014102">s</span><span class="op" id="3014103">.</span><span class="ident" id="3014104">kvs</span><span class="op" id="3014107">[</span><span class="ident" id="3014108">j</span><span class="op" id="3014109">]</span><span class="op" id="3014110">,</span>&nbsp;<span class="ident" id="3014112">s</span><span class="op" id="3014113">.</span><span class="ident" id="3014114">kvs</span><span class="op" id="3014117">[</span><span class="ident" id="3014118">i</span><span class="op" id="3014119">]</span>&nbsp;<span class="op" id="3014121">}</span><br>
<span class="lineno"></span><span class="keyword" id="3014123">func</span>&nbsp;<span class="op" id="3014128">(</span><span class="ident" id="3014129">s</span>&nbsp;<span class="op" id="3014131">*</span><span class="ident" id="3014132">headerSorter</span><span class="op" id="3014144">)</span>&nbsp;<span class="ident" id="3014146">Less</span><span class="op" id="3014150">(</span><span class="ident" id="3014151">i</span><span class="op" id="3014152">,</span>&nbsp;<span class="ident" id="3014154">j</span>&nbsp;<span class="builtintype" id="3014156">int</span><span class="op" id="3014159">)</span>&nbsp;<span class="builtintype" id="3014161">bool</span>&nbsp;<span class="op" id="3014166">{</span>&nbsp;<span class="keyword" id="3014168">return</span>&nbsp;<span class="ident" id="3014175">s</span><span class="op" id="3014176">.</span><span class="ident" id="3014177">kvs</span><span class="op" id="3014180">[</span><span class="ident" id="3014181">i</span><span class="op" id="3014182">]</span><span class="op" id="3014183">.</span><span class="ident" id="3014184">key</span>&nbsp;<span class="op" id="3014188">&lt;</span>&nbsp;<span class="ident" id="3014190">s</span><span class="op" id="3014191">.</span><span class="ident" id="3014192">kvs</span><span class="op" id="3014195">[</span><span class="ident" id="3014196">j</span><span class="op" id="3014197">]</span><span class="op" id="3014198">.</span><span class="ident" id="3014199">key</span>&nbsp;<span class="op" id="3014203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="3014206">var</span>&nbsp;<span class="ident" id="3014210">headerSorterPool</span>&nbsp;<span class="op" id="3014227">=</span>&nbsp;<span class="ident" id="3014229">sync</span><span class="op" id="3014233">.</span><span class="ident" id="3014234">Pool</span><span class="op" id="3014238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3014241">New</span><span class="op" id="3014244">:</span>&nbsp;<span class="keyword" id="3014246">func</span><span class="op" id="3014250">(</span><span class="op" id="3014251">)</span>&nbsp;<span class="keyword" id="3014253">interface</span><span class="op" id="3014262">{</span><span class="op" id="3014263">}</span>&nbsp;<span class="op" id="3014265">{</span>&nbsp;<span class="keyword" id="3014267">return</span>&nbsp;<span class="builtinfunc" id="3014274">new</span><span class="op" id="3014277">(</span><span class="ident" id="3014278">headerSorter</span><span class="op" id="3014290">)</span>&nbsp;<span class="op" id="3014292">}</span><span class="op" id="3014293">,</span><br>
<span class="lineno"></span><span class="op" id="3014295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3014298">//&nbsp;sortedKeyValues&nbsp;returns&nbsp;h&#39;s&nbsp;keys&nbsp;sorted&nbsp;in&nbsp;the&nbsp;returned&nbsp;kvs</span><br>
<span class="lineno">125</span><span class="comment" id="3014361">//&nbsp;slice.&nbsp;The&nbsp;headerSorter&nbsp;used&nbsp;to&nbsp;sort&nbsp;is&nbsp;also&nbsp;returned,&nbsp;for&nbsp;possible</span><br>
<span class="lineno"></span><span class="comment" id="3014432">//&nbsp;return&nbsp;to&nbsp;headerSorterCache.</span><br>
<span class="lineno"></span><span class="keyword" id="3014464">func</span>&nbsp;<span class="op" id="3014469">(</span><span class="ident" id="3014470">h</span>&nbsp;<span class="ident" id="3014472">Header</span><span class="op" id="3014478">)</span>&nbsp;<span class="ident" id="3014480">sortedKeyValues</span><span class="op" id="3014495">(</span><span class="ident" id="3014496">exclude</span>&nbsp;<span class="keyword" id="3014504">map</span><span class="op" id="3014507">[</span><span class="builtintype" id="3014508">string</span><span class="op" id="3014514">]</span><span class="builtintype" id="3014515">bool</span><span class="op" id="3014519">)</span>&nbsp;<span class="op" id="3014521">(</span><span class="ident" id="3014522">kvs</span>&nbsp;<span class="op" id="3014526">[</span><span class="op" id="3014527">]</span><span class="ident" id="3014528">keyValues</span><span class="op" id="3014537">,</span>&nbsp;<span class="ident" id="3014539">hs</span>&nbsp;<span class="op" id="3014542">*</span><span class="ident" id="3014543">headerSorter</span><span class="op" id="3014555">)</span>&nbsp;<span class="op" id="3014557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3014560">hs</span>&nbsp;<span class="op" id="3014563">=</span>&nbsp;<span class="ident" id="3014565">headerSorterPool</span><span class="op" id="3014581">.</span><span class="ident" id="3014582">Get</span><span class="op" id="3014585">(</span><span class="op" id="3014586">)</span><span class="op" id="3014587">.</span><span class="op" id="3014588">(</span><span class="op" id="3014589">*</span><span class="ident" id="3014590">headerSorter</span><span class="op" id="3014602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3014605">if</span>&nbsp;<span class="builtinfunc" id="3014608">cap</span><span class="op" id="3014611">(</span><span class="ident" id="3014612">hs</span><span class="op" id="3014614">.</span><span class="ident" id="3014615">kvs</span><span class="op" id="3014618">)</span>&nbsp;<span class="op" id="3014620">&lt;</span>&nbsp;<span class="builtinfunc" id="3014622">len</span><span class="op" id="3014625">(</span><span class="ident" id="3014626">h</span><span class="op" id="3014627">)</span>&nbsp;<span class="op" id="3014629">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3014633">hs</span><span class="op" id="3014635">.</span><span class="ident" id="3014636">kvs</span>&nbsp;<span class="op" id="3014640">=</span>&nbsp;<span class="builtinfunc" id="3014642">make</span><span class="op" id="3014646">(</span><span class="op" id="3014647">[</span><span class="op" id="3014648">]</span><span class="ident" id="3014649">keyValues</span><span class="op" id="3014658">,</span>&nbsp;<span class="num" id="3014660">0</span><span class="op" id="3014661">,</span>&nbsp;<span class="builtinfunc" id="3014663">len</span><span class="op" id="3014666">(</span><span class="ident" id="3014667">h</span><span class="op" id="3014668">)</span><span class="op" id="3014669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3014672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3014675">kvs</span>&nbsp;<span class="op" id="3014679">=</span>&nbsp;<span class="ident" id="3014681">hs</span><span class="op" id="3014683">.</span><span class="ident" id="3014684">kvs</span><span class="op" id="3014687">[</span><span class="op" id="3014688">:</span><span class="num" id="3014689">0</span><span class="op" id="3014690">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3014693">for</span>&nbsp;<span class="ident" id="3014697">k</span><span class="op" id="3014698">,</span>&nbsp;<span class="ident" id="3014700">vv</span>&nbsp;<span class="op" id="3014703">:=</span>&nbsp;<span class="keyword" id="3014706">range</span>&nbsp;<span class="ident" id="3014712">h</span>&nbsp;<span class="op" id="3014714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3014718">if</span>&nbsp;<span class="op" id="3014721">!</span><span class="ident" id="3014722">exclude</span><span class="op" id="3014729">[</span><span class="ident" id="3014730">k</span><span class="op" id="3014731">]</span>&nbsp;<span class="op" id="3014733">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3014738">kvs</span>&nbsp;<span class="op" id="3014742">=</span>&nbsp;<span class="builtinfunc" id="3014744">append</span><span class="op" id="3014750">(</span><span class="ident" id="3014751">kvs</span><span class="op" id="3014754">,</span>&nbsp;<span class="ident" id="3014756">keyValues</span><span class="op" id="3014765">{</span><span class="ident" id="3014766">k</span><span class="op" id="3014767">,</span>&nbsp;<span class="ident" id="3014769">vv</span><span class="op" id="3014771">}</span><span class="op" id="3014772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3014776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3014779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3014782">hs</span><span class="op" id="3014784">.</span><span class="ident" id="3014785">kvs</span>&nbsp;<span class="op" id="3014789">=</span>&nbsp;<span class="ident" id="3014791">kvs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3014796">sort</span><span class="op" id="3014800">.</span><span class="ident" id="3014801">Sort</span><span class="op" id="3014805">(</span><span class="ident" id="3014806">hs</span><span class="op" id="3014808">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3014811">return</span>&nbsp;<span class="ident" id="3014818">kvs</span><span class="op" id="3014821">,</span>&nbsp;<span class="ident" id="3014823">hs</span><br>
<span class="lineno"></span><span class="op" id="3014826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3014829">//&nbsp;WriteSubset&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="3014876">//&nbsp;If&nbsp;exclude&nbsp;is&nbsp;not&nbsp;nil,&nbsp;keys&nbsp;where&nbsp;exclude[key]&nbsp;==&nbsp;true&nbsp;are&nbsp;not&nbsp;written.</span><br>
<span class="lineno">145</span><span class="keyword" id="3014951">func</span>&nbsp;<span class="op" id="3014956">(</span><span class="ident" id="3014957">h</span>&nbsp;<span class="ident" id="3014959">Header</span><span class="op" id="3014965">)</span>&nbsp;<span class="ident" id="3014967">WriteSubset</span><span class="op" id="3014978">(</span><span class="ident" id="3014979">w</span>&nbsp;<span class="ident" id="3014981">io</span><span class="op" id="3014983">.</span><span class="ident" id="3014984">Writer</span><span class="op" id="3014990">,</span>&nbsp;<span class="ident" id="3014992">exclude</span>&nbsp;<span class="keyword" id="3015000">map</span><span class="op" id="3015003">[</span><span class="builtintype" id="3015004">string</span><span class="op" id="3015010">]</span><span class="builtintype" id="3015011">bool</span><span class="op" id="3015015">)</span>&nbsp;<span class="builtintype" id="3015017">error</span>&nbsp;<span class="op" id="3015023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3015026">ws</span><span class="op" id="3015028">,</span>&nbsp;<span class="ident" id="3015030">ok</span>&nbsp;<span class="op" id="3015033">:=</span>&nbsp;<span class="ident" id="3015036">w</span><span class="op" id="3015037">.</span><span class="op" id="3015038">(</span><span class="ident" id="3015039">writeStringer</span><span class="op" id="3015052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3015055">if</span>&nbsp;<span class="op" id="3015058">!</span><span class="ident" id="3015059">ok</span>&nbsp;<span class="op" id="3015062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3015066">ws</span>&nbsp;<span class="op" id="3015069">=</span>&nbsp;<span class="ident" id="3015071">stringWriter</span><span class="op" id="3015083">{</span><span class="ident" id="3015084">w</span><span class="op" id="3015085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3015088">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3015091">kvs</span><span class="op" id="3015094">,</span>&nbsp;<span class="ident" id="3015096">sorter</span>&nbsp;<span class="op" id="3015103">:=</span>&nbsp;<span class="ident" id="3015106">h</span><span class="op" id="3015107">.</span><span class="ident" id="3015108">sortedKeyValues</span><span class="op" id="3015123">(</span><span class="ident" id="3015124">exclude</span><span class="op" id="3015131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3015134">for</span>&nbsp;<span class="ident" id="3015138">_</span><span class="op" id="3015139">,</span>&nbsp;<span class="ident" id="3015141">kv</span>&nbsp;<span class="op" id="3015144">:=</span>&nbsp;<span class="keyword" id="3015147">range</span>&nbsp;<span class="ident" id="3015153">kvs</span>&nbsp;<span class="op" id="3015157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3015161">for</span>&nbsp;<span class="ident" id="3015165">_</span><span class="op" id="3015166">,</span>&nbsp;<span class="ident" id="3015168">v</span>&nbsp;<span class="op" id="3015170">:=</span>&nbsp;<span class="keyword" id="3015173">range</span>&nbsp;<span class="ident" id="3015179">kv</span><span class="op" id="3015181">.</span><span class="ident" id="3015182">values</span>&nbsp;<span class="op" id="3015189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3015194">v</span>&nbsp;<span class="op" id="3015196">=</span>&nbsp;<span class="ident" id="3015198">headerNewlineToSpace</span><span class="op" id="3015218">.</span><span class="ident" id="3015219">Replace</span><span class="op" id="3015226">(</span><span class="ident" id="3015227">v</span><span class="op" id="3015228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3015233">v</span>&nbsp;<span class="op" id="3015235">=</span>&nbsp;<span class="ident" id="3015237">textproto</span><span class="op" id="3015246">.</span><span class="ident" id="3015247">TrimString</span><span class="op" id="3015257">(</span><span class="ident" id="3015258">v</span><span class="op" id="3015259">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3015264">for</span>&nbsp;<span class="ident" id="3015268">_</span><span class="op" id="3015269">,</span>&nbsp;<span class="ident" id="3015271">s</span>&nbsp;<span class="op" id="3015273">:=</span>&nbsp;<span class="keyword" id="3015276">range</span>&nbsp;<span class="op" id="3015282">[</span><span class="op" id="3015283">]</span><span class="builtintype" id="3015284">string</span><span class="op" id="3015290">{</span><span class="ident" id="3015291">kv</span><span class="op" id="3015293">.</span><span class="ident" id="3015294">key</span><span class="op" id="3015297">,</span>&nbsp;<span class="string" id="3015299">&#34;:&nbsp;&#34;</span><span class="op" id="3015303">,</span>&nbsp;<span class="ident" id="3015305">v</span><span class="op" id="3015306">,</span>&nbsp;<span class="string" id="3015308">&#34;\r\n&#34;</span><span class="op" id="3015314">}</span>&nbsp;<span class="op" id="3015316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3015322">if</span>&nbsp;<span class="ident" id="3015325">_</span><span class="op" id="3015326">,</span>&nbsp;<span class="ident" id="3015328">err</span>&nbsp;<span class="op" id="3015332">:=</span>&nbsp;<span class="ident" id="3015335">ws</span><span class="op" id="3015337">.</span><span class="ident" id="3015338">WriteString</span><span class="op" id="3015349">(</span><span class="ident" id="3015350">s</span><span class="op" id="3015351">)</span><span class="op" id="3015352">;</span>&nbsp;<span class="ident" id="3015354">err</span>&nbsp;<span class="op" id="3015358">!=</span>&nbsp;<span class="ident" id="3015361">nil</span>&nbsp;<span class="op" id="3015365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3015372">return</span>&nbsp;<span class="ident" id="3015379">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3015387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3015392">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3015396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3015399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3015402">headerSorterPool</span><span class="op" id="3015418">.</span><span class="ident" id="3015419">Put</span><span class="op" id="3015422">(</span><span class="ident" id="3015423">sorter</span><span class="op" id="3015429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3015432">return</span>&nbsp;<span class="ident" id="3015439">nil</span><br>
<span class="lineno"></span><span class="op" id="3015443">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3015446">//&nbsp;CanonicalHeaderKey&nbsp;returns&nbsp;the&nbsp;canonical&nbsp;format&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3015504">//&nbsp;header&nbsp;key&nbsp;s.&nbsp;&nbsp;The&nbsp;canonicalization&nbsp;converts&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="3015562">//&nbsp;letter&nbsp;and&nbsp;any&nbsp;letter&nbsp;following&nbsp;a&nbsp;hyphen&nbsp;to&nbsp;upper&nbsp;case;</span><br>
<span class="lineno"></span><span class="comment" id="3015621">//&nbsp;the&nbsp;rest&nbsp;are&nbsp;converted&nbsp;to&nbsp;lowercase.&nbsp;&nbsp;For&nbsp;example,&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="3015679">//&nbsp;canonical&nbsp;key&nbsp;for&nbsp;&#34;accept-encoding&#34;&nbsp;is&nbsp;&#34;Accept-Encoding&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3015740">func</span>&nbsp;<span class="ident" id="3015745">CanonicalHeaderKey</span><span class="op" id="3015763">(</span><span class="ident" id="3015764">s</span>&nbsp;<span class="builtintype" id="3015766">string</span><span class="op" id="3015772">)</span>&nbsp;<span class="builtintype" id="3015774">string</span>&nbsp;<span class="op" id="3015781">{</span>&nbsp;<span class="keyword" id="3015783">return</span>&nbsp;<span class="ident" id="3015790">textproto</span><span class="op" id="3015799">.</span><span class="ident" id="3015800">CanonicalMIMEHeaderKey</span><span class="op" id="3015822">(</span><span class="ident" id="3015823">s</span><span class="op" id="3015824">)</span>&nbsp;<span class="op" id="3015826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3015829">//&nbsp;hasToken&nbsp;reports&nbsp;whether&nbsp;token&nbsp;appears&nbsp;with&nbsp;v,&nbsp;ASCII</span><br>
<span class="lineno"></span><span class="comment" id="3015885">//&nbsp;case-insensitive,&nbsp;with&nbsp;space&nbsp;or&nbsp;comma&nbsp;boundaries.</span><br>
<span class="lineno">175</span><span class="comment" id="3015938">//&nbsp;token&nbsp;must&nbsp;be&nbsp;all&nbsp;lowercase.</span><br>
<span class="lineno"></span><span class="comment" id="3015970">//&nbsp;v&nbsp;may&nbsp;contain&nbsp;mixed&nbsp;cased.</span><br>
<span class="lineno"></span><span class="keyword" id="3016000">func</span>&nbsp;<span class="ident" id="3016005">hasToken</span><span class="op" id="3016013">(</span><span class="ident" id="3016014">v</span><span class="op" id="3016015">,</span>&nbsp;<span class="ident" id="3016017">token</span>&nbsp;<span class="builtintype" id="3016023">string</span><span class="op" id="3016029">)</span>&nbsp;<span class="builtintype" id="3016031">bool</span>&nbsp;<span class="op" id="3016036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016039">if</span>&nbsp;<span class="builtinfunc" id="3016042">len</span><span class="op" id="3016045">(</span><span class="ident" id="3016046">token</span><span class="op" id="3016051">)</span>&nbsp;<span class="op" id="3016053">&gt;</span>&nbsp;<span class="builtinfunc" id="3016055">len</span><span class="op" id="3016058">(</span><span class="ident" id="3016059">v</span><span class="op" id="3016060">)</span>&nbsp;<span class="op" id="3016062">||</span>&nbsp;<span class="ident" id="3016065">token</span>&nbsp;<span class="op" id="3016071">==</span>&nbsp;<span class="string" id="3016074">&#34;&#34;</span>&nbsp;<span class="op" id="3016077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016081">return</span>&nbsp;<span class="builtintype" id="3016088">false</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3016095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016098">if</span>&nbsp;<span class="ident" id="3016101">v</span>&nbsp;<span class="op" id="3016103">==</span>&nbsp;<span class="ident" id="3016106">token</span>&nbsp;<span class="op" id="3016112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016116">return</span>&nbsp;<span class="builtintype" id="3016123">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3016129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016132">for</span>&nbsp;<span class="ident" id="3016136">sp</span>&nbsp;<span class="op" id="3016139">:=</span>&nbsp;<span class="num" id="3016142">0</span><span class="op" id="3016143">;</span>&nbsp;<span class="ident" id="3016145">sp</span>&nbsp;<span class="op" id="3016148">&lt;=</span>&nbsp;<span class="builtinfunc" id="3016151">len</span><span class="op" id="3016154">(</span><span class="ident" id="3016155">v</span><span class="op" id="3016156">)</span><span class="op" id="3016157">-</span><span class="builtinfunc" id="3016158">len</span><span class="op" id="3016161">(</span><span class="ident" id="3016162">token</span><span class="op" id="3016167">)</span><span class="op" id="3016168">;</span>&nbsp;<span class="ident" id="3016170">sp</span><span class="op" id="3016172">++</span>&nbsp;<span class="op" id="3016175">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3016179">//&nbsp;Check&nbsp;that&nbsp;first&nbsp;character&nbsp;is&nbsp;good.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3016220">//&nbsp;The&nbsp;token&nbsp;is&nbsp;ASCII,&nbsp;so&nbsp;checking&nbsp;only&nbsp;a&nbsp;single&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3016276">//&nbsp;is&nbsp;sufficient.&nbsp;&nbsp;We&nbsp;skip&nbsp;this&nbsp;potential&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3016329">//&nbsp;position&nbsp;if&nbsp;both&nbsp;the&nbsp;first&nbsp;byte&nbsp;and&nbsp;its&nbsp;potential</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3016384">//&nbsp;ASCII&nbsp;uppercase&nbsp;equivalent&nbsp;(b|0x20)&nbsp;don&#39;t&nbsp;match.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3016438">//&nbsp;False&nbsp;positives&nbsp;(&#39;^&#39;&nbsp;=&gt;&nbsp;&#39;~&#39;)&nbsp;are&nbsp;caught&nbsp;by&nbsp;EqualFold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016497">if</span>&nbsp;<span class="ident" id="3016500">b</span>&nbsp;<span class="op" id="3016502">:=</span>&nbsp;<span class="ident" id="3016505">v</span><span class="op" id="3016506">[</span><span class="ident" id="3016507">sp</span><span class="op" id="3016509">]</span><span class="op" id="3016510">;</span>&nbsp;<span class="ident" id="3016512">b</span>&nbsp;<span class="op" id="3016514">!=</span>&nbsp;<span class="ident" id="3016517">token</span><span class="op" id="3016522">[</span><span class="num" id="3016523">0</span><span class="op" id="3016524">]</span>&nbsp;<span class="op" id="3016526">&amp;&amp;</span>&nbsp;<span class="ident" id="3016529">b</span><span class="op" id="3016530">|</span><span class="num" id="3016531">0x20</span>&nbsp;<span class="op" id="3016536">!=</span>&nbsp;<span class="ident" id="3016539">token</span><span class="op" id="3016544">[</span><span class="num" id="3016545">0</span><span class="op" id="3016546">]</span>&nbsp;<span class="op" id="3016548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016553">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3016564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3016568">//&nbsp;Check&nbsp;that&nbsp;start&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016624">if</span>&nbsp;<span class="ident" id="3016627">sp</span>&nbsp;<span class="op" id="3016630">&gt;</span>&nbsp;<span class="num" id="3016632">0</span>&nbsp;<span class="op" id="3016634">&amp;&amp;</span>&nbsp;<span class="op" id="3016637">!</span><span class="ident" id="3016638">isTokenBoundary</span><span class="op" id="3016653">(</span><span class="ident" id="3016654">v</span><span class="op" id="3016655">[</span><span class="ident" id="3016656">sp</span><span class="op" id="3016658">-</span><span class="num" id="3016659">1</span><span class="op" id="3016660">]</span><span class="op" id="3016661">)</span>&nbsp;<span class="op" id="3016663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016668">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3016679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3016683">//&nbsp;Check&nbsp;that&nbsp;end&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016737">if</span>&nbsp;<span class="ident" id="3016740">endPos</span>&nbsp;<span class="op" id="3016747">:=</span>&nbsp;<span class="ident" id="3016750">sp</span>&nbsp;<span class="op" id="3016753">+</span>&nbsp;<span class="builtinfunc" id="3016755">len</span><span class="op" id="3016758">(</span><span class="ident" id="3016759">token</span><span class="op" id="3016764">)</span><span class="op" id="3016765">;</span>&nbsp;<span class="ident" id="3016767">endPos</span>&nbsp;<span class="op" id="3016774">!=</span>&nbsp;<span class="builtinfunc" id="3016777">len</span><span class="op" id="3016780">(</span><span class="ident" id="3016781">v</span><span class="op" id="3016782">)</span>&nbsp;<span class="op" id="3016784">&amp;&amp;</span>&nbsp;<span class="op" id="3016787">!</span><span class="ident" id="3016788">isTokenBoundary</span><span class="op" id="3016803">(</span><span class="ident" id="3016804">v</span><span class="op" id="3016805">[</span><span class="ident" id="3016806">endPos</span><span class="op" id="3016812">]</span><span class="op" id="3016813">)</span>&nbsp;<span class="op" id="3016815">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016820">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3016831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016835">if</span>&nbsp;<span class="ident" id="3016838">strings</span><span class="op" id="3016845">.</span><span class="ident" id="3016846">EqualFold</span><span class="op" id="3016855">(</span><span class="ident" id="3016856">v</span><span class="op" id="3016857">[</span><span class="ident" id="3016858">sp</span><span class="op" id="3016860">:</span><span class="ident" id="3016861">sp</span><span class="op" id="3016863">+</span><span class="builtinfunc" id="3016864">len</span><span class="op" id="3016867">(</span><span class="ident" id="3016868">token</span><span class="op" id="3016873">)</span><span class="op" id="3016874">]</span><span class="op" id="3016875">,</span>&nbsp;<span class="ident" id="3016877">token</span><span class="op" id="3016882">)</span>&nbsp;<span class="op" id="3016884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016889">return</span>&nbsp;<span class="builtintype" id="3016896">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3016903">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3016906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016909">return</span>&nbsp;<span class="builtintype" id="3016916">false</span><br>
<span class="lineno"></span><span class="op" id="3016922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3016925">func</span>&nbsp;<span class="ident" id="3016930">isTokenBoundary</span><span class="op" id="3016945">(</span><span class="ident" id="3016946">b</span>&nbsp;<span class="builtintype" id="3016948">byte</span><span class="op" id="3016952">)</span>&nbsp;<span class="builtintype" id="3016954">bool</span>&nbsp;<span class="op" id="3016959">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3016962">return</span>&nbsp;<span class="ident" id="3016969">b</span>&nbsp;<span class="op" id="3016971">==</span>&nbsp;<span class="string" id="3016974">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="3016978">||</span>&nbsp;<span class="ident" id="3016981">b</span>&nbsp;<span class="op" id="3016983">==</span>&nbsp;<span class="string" id="3016986">&#39;,&#39;</span>&nbsp;<span class="op" id="3016990">||</span>&nbsp;<span class="ident" id="3016993">b</span>&nbsp;<span class="op" id="3016995">==</span>&nbsp;<span class="string" id="3016998">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="3017003">}</span>
</div>
</body>
</html>
