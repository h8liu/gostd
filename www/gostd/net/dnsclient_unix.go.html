<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html" class="current">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3020734">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3020789">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3020843">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3020894">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3020959">//&nbsp;DNS&nbsp;client:&nbsp;see&nbsp;RFC&nbsp;1035.</span><br>
<span class="lineno"></span><span class="comment" id="3020988">//&nbsp;Has&nbsp;to&nbsp;be&nbsp;linked&nbsp;into&nbsp;package&nbsp;net&nbsp;for&nbsp;Dial.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3021036">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span><span class="comment" id="3021050">//&nbsp;&nbsp;&nbsp;&nbsp;Could&nbsp;potentially&nbsp;handle&nbsp;many&nbsp;outstanding&nbsp;lookups&nbsp;faster.</span><br>
<span class="lineno"></span><span class="comment" id="3021111">//&nbsp;&nbsp;&nbsp;&nbsp;Could&nbsp;have&nbsp;a&nbsp;small&nbsp;cache.</span><br>
<span class="lineno"></span><span class="comment" id="3021140">//&nbsp;&nbsp;&nbsp;&nbsp;Random&nbsp;UDP&nbsp;source&nbsp;port&nbsp;(net.Dial&nbsp;should&nbsp;do&nbsp;that&nbsp;for&nbsp;us).</span><br>
<span class="lineno"></span><span class="comment" id="3021200">//&nbsp;&nbsp;&nbsp;&nbsp;Random&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3021224">package</span>&nbsp;<span class="ident" id="3021232">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3021237">import</span>&nbsp;<span class="op" id="3021244">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3021247">&#34;errors&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3021257">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3021263">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3021276">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3021282">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3021290">&#34;time&#34;</span><br>
<span class="lineno">25</span><span class="op" id="3021297">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3021300">//&nbsp;A&nbsp;dnsConn&nbsp;represents&nbsp;a&nbsp;DNS&nbsp;transport&nbsp;endpoint.</span><br>
<span class="lineno"></span><span class="keyword" id="3021350">type</span>&nbsp;<span class="ident" id="3021355">dnsConn</span>&nbsp;<span class="keyword" id="3021363">interface</span>&nbsp;<span class="op" id="3021373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021376">Conn</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021383">//&nbsp;readDNSResponse&nbsp;reads&nbsp;a&nbsp;DNS&nbsp;response&nbsp;message&nbsp;from&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021445">//&nbsp;transport&nbsp;endpoint&nbsp;and&nbsp;returns&nbsp;the&nbsp;received&nbsp;DNS&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021506">//&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021519">readDNSResponse</span><span class="op" id="3021534">(</span><span class="op" id="3021535">)</span>&nbsp;<span class="op" id="3021537">(</span><span class="op" id="3021538">*</span><span class="ident" id="3021539">dnsMsg</span><span class="op" id="3021545">,</span>&nbsp;<span class="builtintype" id="3021547">error</span><span class="op" id="3021552">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021556">//&nbsp;writeDNSQuery&nbsp;writes&nbsp;a&nbsp;DNS&nbsp;query&nbsp;message&nbsp;to&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021612">//&nbsp;connection&nbsp;endpoint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021637">writeDNSQuery</span><span class="op" id="3021650">(</span><span class="op" id="3021651">*</span><span class="ident" id="3021652">dnsMsg</span><span class="op" id="3021658">)</span>&nbsp;<span class="builtintype" id="3021660">error</span><br>
<span class="lineno"></span><span class="op" id="3021666">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3021669">func</span>&nbsp;<span class="op" id="3021674">(</span><span class="ident" id="3021675">c</span>&nbsp;<span class="op" id="3021677">*</span><span class="ident" id="3021678">UDPConn</span><span class="op" id="3021685">)</span>&nbsp;<span class="ident" id="3021687">readDNSResponse</span><span class="op" id="3021702">(</span><span class="op" id="3021703">)</span>&nbsp;<span class="op" id="3021705">(</span><span class="op" id="3021706">*</span><span class="ident" id="3021707">dnsMsg</span><span class="op" id="3021713">,</span>&nbsp;<span class="builtintype" id="3021715">error</span><span class="op" id="3021720">)</span>&nbsp;<span class="op" id="3021722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021725">b</span>&nbsp;<span class="op" id="3021727">:=</span>&nbsp;<span class="builtinfunc" id="3021730">make</span><span class="op" id="3021734">(</span><span class="op" id="3021735">[</span><span class="op" id="3021736">]</span><span class="builtintype" id="3021737">byte</span><span class="op" id="3021741">,</span>&nbsp;<span class="num" id="3021743">512</span><span class="op" id="3021746">)</span>&nbsp;<span class="comment" id="3021748">//&nbsp;see&nbsp;RFC&nbsp;1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021765">n</span><span class="op" id="3021766">,</span>&nbsp;<span class="ident" id="3021768">err</span>&nbsp;<span class="op" id="3021772">:=</span>&nbsp;<span class="ident" id="3021775">c</span><span class="op" id="3021776">.</span><span class="ident" id="3021777">Read</span><span class="op" id="3021781">(</span><span class="ident" id="3021782">b</span><span class="op" id="3021783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021786">if</span>&nbsp;<span class="ident" id="3021789">err</span>&nbsp;<span class="op" id="3021793">!=</span>&nbsp;<span class="ident" id="3021796">nil</span>&nbsp;<span class="op" id="3021800">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021804">return</span>&nbsp;<span class="ident" id="3021811">nil</span><span class="op" id="3021814">,</span>&nbsp;<span class="ident" id="3021816">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021824">msg</span>&nbsp;<span class="op" id="3021828">:=</span>&nbsp;<span class="op" id="3021831">&amp;</span><span class="ident" id="3021832">dnsMsg</span><span class="op" id="3021838">{</span><span class="op" id="3021839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021842">if</span>&nbsp;<span class="op" id="3021845">!</span><span class="ident" id="3021846">msg</span><span class="op" id="3021849">.</span><span class="ident" id="3021850">Unpack</span><span class="op" id="3021856">(</span><span class="ident" id="3021857">b</span><span class="op" id="3021858">[</span><span class="op" id="3021859">:</span><span class="ident" id="3021860">n</span><span class="op" id="3021861">]</span><span class="op" id="3021862">)</span>&nbsp;<span class="op" id="3021864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021868">return</span>&nbsp;<span class="ident" id="3021875">nil</span><span class="op" id="3021878">,</span>&nbsp;<span class="ident" id="3021880">errors</span><span class="op" id="3021886">.</span><span class="ident" id="3021887">New</span><span class="op" id="3021890">(</span><span class="string" id="3021891">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3021921">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021927">return</span>&nbsp;<span class="ident" id="3021934">msg</span><span class="op" id="3021937">,</span>&nbsp;<span class="ident" id="3021939">nil</span><br>
<span class="lineno"></span><span class="op" id="3021943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3021946">func</span>&nbsp;<span class="op" id="3021951">(</span><span class="ident" id="3021952">c</span>&nbsp;<span class="op" id="3021954">*</span><span class="ident" id="3021955">UDPConn</span><span class="op" id="3021962">)</span>&nbsp;<span class="ident" id="3021964">writeDNSQuery</span><span class="op" id="3021977">(</span><span class="ident" id="3021978">msg</span>&nbsp;<span class="op" id="3021982">*</span><span class="ident" id="3021983">dnsMsg</span><span class="op" id="3021989">)</span>&nbsp;<span class="builtintype" id="3021991">error</span>&nbsp;<span class="op" id="3021997">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022000">b</span><span class="op" id="3022001">,</span>&nbsp;<span class="ident" id="3022003">ok</span>&nbsp;<span class="op" id="3022006">:=</span>&nbsp;<span class="ident" id="3022009">msg</span><span class="op" id="3022012">.</span><span class="ident" id="3022013">Pack</span><span class="op" id="3022017">(</span><span class="op" id="3022018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022021">if</span>&nbsp;<span class="op" id="3022024">!</span><span class="ident" id="3022025">ok</span>&nbsp;<span class="op" id="3022028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022032">return</span>&nbsp;<span class="ident" id="3022039">errors</span><span class="op" id="3022045">.</span><span class="ident" id="3022046">New</span><span class="op" id="3022049">(</span><span class="string" id="3022050">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3022078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3022081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022084">if</span>&nbsp;<span class="ident" id="3022087">_</span><span class="op" id="3022088">,</span>&nbsp;<span class="ident" id="3022090">err</span>&nbsp;<span class="op" id="3022094">:=</span>&nbsp;<span class="ident" id="3022097">c</span><span class="op" id="3022098">.</span><span class="ident" id="3022099">Write</span><span class="op" id="3022104">(</span><span class="ident" id="3022105">b</span><span class="op" id="3022106">)</span><span class="op" id="3022107">;</span>&nbsp;<span class="ident" id="3022109">err</span>&nbsp;<span class="op" id="3022113">!=</span>&nbsp;<span class="ident" id="3022116">nil</span>&nbsp;<span class="op" id="3022120">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022124">return</span>&nbsp;<span class="ident" id="3022131">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3022136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022139">return</span>&nbsp;<span class="ident" id="3022146">nil</span><br>
<span class="lineno"></span><span class="op" id="3022150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="3022153">func</span>&nbsp;<span class="op" id="3022158">(</span><span class="ident" id="3022159">c</span>&nbsp;<span class="op" id="3022161">*</span><span class="ident" id="3022162">TCPConn</span><span class="op" id="3022169">)</span>&nbsp;<span class="ident" id="3022171">readDNSResponse</span><span class="op" id="3022186">(</span><span class="op" id="3022187">)</span>&nbsp;<span class="op" id="3022189">(</span><span class="op" id="3022190">*</span><span class="ident" id="3022191">dnsMsg</span><span class="op" id="3022197">,</span>&nbsp;<span class="builtintype" id="3022199">error</span><span class="op" id="3022204">)</span>&nbsp;<span class="op" id="3022206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022209">b</span>&nbsp;<span class="op" id="3022211">:=</span>&nbsp;<span class="builtinfunc" id="3022214">make</span><span class="op" id="3022218">(</span><span class="op" id="3022219">[</span><span class="op" id="3022220">]</span><span class="builtintype" id="3022221">byte</span><span class="op" id="3022225">,</span>&nbsp;<span class="num" id="3022227">1280</span><span class="op" id="3022231">)</span>&nbsp;<span class="comment" id="3022233">//&nbsp;1280&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;initial&nbsp;size&nbsp;for&nbsp;IP&nbsp;over&nbsp;Ethernet,&nbsp;see&nbsp;RFC&nbsp;4035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022306">if</span>&nbsp;<span class="ident" id="3022309">_</span><span class="op" id="3022310">,</span>&nbsp;<span class="ident" id="3022312">err</span>&nbsp;<span class="op" id="3022316">:=</span>&nbsp;<span class="ident" id="3022319">io</span><span class="op" id="3022321">.</span><span class="ident" id="3022322">ReadFull</span><span class="op" id="3022330">(</span><span class="ident" id="3022331">c</span><span class="op" id="3022332">,</span>&nbsp;<span class="ident" id="3022334">b</span><span class="op" id="3022335">[</span><span class="op" id="3022336">:</span><span class="num" id="3022337">2</span><span class="op" id="3022338">]</span><span class="op" id="3022339">)</span><span class="op" id="3022340">;</span>&nbsp;<span class="ident" id="3022342">err</span>&nbsp;<span class="op" id="3022346">!=</span>&nbsp;<span class="ident" id="3022349">nil</span>&nbsp;<span class="op" id="3022353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022357">return</span>&nbsp;<span class="ident" id="3022364">nil</span><span class="op" id="3022367">,</span>&nbsp;<span class="ident" id="3022369">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3022374">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022377">l</span>&nbsp;<span class="op" id="3022379">:=</span>&nbsp;<span class="builtintype" id="3022382">int</span><span class="op" id="3022385">(</span><span class="ident" id="3022386">b</span><span class="op" id="3022387">[</span><span class="num" id="3022388">0</span><span class="op" id="3022389">]</span><span class="op" id="3022390">)</span><span class="op" id="3022391">&lt;&lt;</span><span class="num" id="3022393">8</span>&nbsp;<span class="op" id="3022395">|</span>&nbsp;<span class="builtintype" id="3022397">int</span><span class="op" id="3022400">(</span><span class="ident" id="3022401">b</span><span class="op" id="3022402">[</span><span class="num" id="3022403">1</span><span class="op" id="3022404">]</span><span class="op" id="3022405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022408">if</span>&nbsp;<span class="ident" id="3022411">l</span>&nbsp;<span class="op" id="3022413">&gt;</span>&nbsp;<span class="builtinfunc" id="3022415">len</span><span class="op" id="3022418">(</span><span class="ident" id="3022419">b</span><span class="op" id="3022420">)</span>&nbsp;<span class="op" id="3022422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022426">b</span>&nbsp;<span class="op" id="3022428">=</span>&nbsp;<span class="builtinfunc" id="3022430">make</span><span class="op" id="3022434">(</span><span class="op" id="3022435">[</span><span class="op" id="3022436">]</span><span class="builtintype" id="3022437">byte</span><span class="op" id="3022441">,</span>&nbsp;<span class="ident" id="3022443">l</span><span class="op" id="3022444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3022447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022450">n</span><span class="op" id="3022451">,</span>&nbsp;<span class="ident" id="3022453">err</span>&nbsp;<span class="op" id="3022457">:=</span>&nbsp;<span class="ident" id="3022460">io</span><span class="op" id="3022462">.</span><span class="ident" id="3022463">ReadFull</span><span class="op" id="3022471">(</span><span class="ident" id="3022472">c</span><span class="op" id="3022473">,</span>&nbsp;<span class="ident" id="3022475">b</span><span class="op" id="3022476">[</span><span class="op" id="3022477">:</span><span class="ident" id="3022478">l</span><span class="op" id="3022479">]</span><span class="op" id="3022480">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022483">if</span>&nbsp;<span class="ident" id="3022486">err</span>&nbsp;<span class="op" id="3022490">!=</span>&nbsp;<span class="ident" id="3022493">nil</span>&nbsp;<span class="op" id="3022497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022501">return</span>&nbsp;<span class="ident" id="3022508">nil</span><span class="op" id="3022511">,</span>&nbsp;<span class="ident" id="3022513">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3022518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022521">msg</span>&nbsp;<span class="op" id="3022525">:=</span>&nbsp;<span class="op" id="3022528">&amp;</span><span class="ident" id="3022529">dnsMsg</span><span class="op" id="3022535">{</span><span class="op" id="3022536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022539">if</span>&nbsp;<span class="op" id="3022542">!</span><span class="ident" id="3022543">msg</span><span class="op" id="3022546">.</span><span class="ident" id="3022547">Unpack</span><span class="op" id="3022553">(</span><span class="ident" id="3022554">b</span><span class="op" id="3022555">[</span><span class="op" id="3022556">:</span><span class="ident" id="3022557">n</span><span class="op" id="3022558">]</span><span class="op" id="3022559">)</span>&nbsp;<span class="op" id="3022561">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022565">return</span>&nbsp;<span class="ident" id="3022572">nil</span><span class="op" id="3022575">,</span>&nbsp;<span class="ident" id="3022577">errors</span><span class="op" id="3022583">.</span><span class="ident" id="3022584">New</span><span class="op" id="3022587">(</span><span class="string" id="3022588">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3022618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3022621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022624">return</span>&nbsp;<span class="ident" id="3022631">msg</span><span class="op" id="3022634">,</span>&nbsp;<span class="ident" id="3022636">nil</span><br>
<span class="lineno"></span><span class="op" id="3022640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="3022643">func</span>&nbsp;<span class="op" id="3022648">(</span><span class="ident" id="3022649">c</span>&nbsp;<span class="op" id="3022651">*</span><span class="ident" id="3022652">TCPConn</span><span class="op" id="3022659">)</span>&nbsp;<span class="ident" id="3022661">writeDNSQuery</span><span class="op" id="3022674">(</span><span class="ident" id="3022675">msg</span>&nbsp;<span class="op" id="3022679">*</span><span class="ident" id="3022680">dnsMsg</span><span class="op" id="3022686">)</span>&nbsp;<span class="builtintype" id="3022688">error</span>&nbsp;<span class="op" id="3022694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022697">b</span><span class="op" id="3022698">,</span>&nbsp;<span class="ident" id="3022700">ok</span>&nbsp;<span class="op" id="3022703">:=</span>&nbsp;<span class="ident" id="3022706">msg</span><span class="op" id="3022709">.</span><span class="ident" id="3022710">Pack</span><span class="op" id="3022714">(</span><span class="op" id="3022715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022718">if</span>&nbsp;<span class="op" id="3022721">!</span><span class="ident" id="3022722">ok</span>&nbsp;<span class="op" id="3022725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022729">return</span>&nbsp;<span class="ident" id="3022736">errors</span><span class="op" id="3022742">.</span><span class="ident" id="3022743">New</span><span class="op" id="3022746">(</span><span class="string" id="3022747">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3022775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3022778">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022781">l</span>&nbsp;<span class="op" id="3022783">:=</span>&nbsp;<span class="builtintype" id="3022786">uint16</span><span class="op" id="3022792">(</span><span class="builtinfunc" id="3022793">len</span><span class="op" id="3022796">(</span><span class="ident" id="3022797">b</span><span class="op" id="3022798">)</span><span class="op" id="3022799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022802">b</span>&nbsp;<span class="op" id="3022804">=</span>&nbsp;<span class="builtinfunc" id="3022806">append</span><span class="op" id="3022812">(</span><span class="op" id="3022813">[</span><span class="op" id="3022814">]</span><span class="builtintype" id="3022815">byte</span><span class="op" id="3022819">{</span><span class="builtintype" id="3022820">byte</span><span class="op" id="3022824">(</span><span class="ident" id="3022825">l</span>&nbsp;<span class="op" id="3022827">&gt;&gt;</span>&nbsp;<span class="num" id="3022830">8</span><span class="op" id="3022831">)</span><span class="op" id="3022832">,</span>&nbsp;<span class="builtintype" id="3022834">byte</span><span class="op" id="3022838">(</span><span class="ident" id="3022839">l</span><span class="op" id="3022840">)</span><span class="op" id="3022841">}</span><span class="op" id="3022842">,</span>&nbsp;<span class="ident" id="3022844">b</span><span class="op" id="3022845">...</span><span class="op" id="3022848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022851">if</span>&nbsp;<span class="ident" id="3022854">_</span><span class="op" id="3022855">,</span>&nbsp;<span class="ident" id="3022857">err</span>&nbsp;<span class="op" id="3022861">:=</span>&nbsp;<span class="ident" id="3022864">c</span><span class="op" id="3022865">.</span><span class="ident" id="3022866">Write</span><span class="op" id="3022871">(</span><span class="ident" id="3022872">b</span><span class="op" id="3022873">)</span><span class="op" id="3022874">;</span>&nbsp;<span class="ident" id="3022876">err</span>&nbsp;<span class="op" id="3022880">!=</span>&nbsp;<span class="ident" id="3022883">nil</span>&nbsp;<span class="op" id="3022887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022891">return</span>&nbsp;<span class="ident" id="3022898">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3022903">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022906">return</span>&nbsp;<span class="ident" id="3022913">nil</span><br>
<span class="lineno"></span><span class="op" id="3022917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3022920">func</span>&nbsp;<span class="op" id="3022925">(</span><span class="ident" id="3022926">d</span>&nbsp;<span class="op" id="3022928">*</span><span class="ident" id="3022929">Dialer</span><span class="op" id="3022935">)</span>&nbsp;<span class="ident" id="3022937">dialDNS</span><span class="op" id="3022944">(</span><span class="ident" id="3022945">network</span><span class="op" id="3022952">,</span>&nbsp;<span class="ident" id="3022954">server</span>&nbsp;<span class="builtintype" id="3022961">string</span><span class="op" id="3022967">)</span>&nbsp;<span class="op" id="3022969">(</span><span class="ident" id="3022970">dnsConn</span><span class="op" id="3022977">,</span>&nbsp;<span class="builtintype" id="3022979">error</span><span class="op" id="3022984">)</span>&nbsp;<span class="op" id="3022986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3022989">switch</span>&nbsp;<span class="ident" id="3022996">network</span>&nbsp;<span class="op" id="3023004">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023007">case</span>&nbsp;<span class="string" id="3023012">&#34;tcp&#34;</span><span class="op" id="3023017">,</span>&nbsp;<span class="string" id="3023019">&#34;tcp4&#34;</span><span class="op" id="3023025">,</span>&nbsp;<span class="string" id="3023027">&#34;tcp6&#34;</span><span class="op" id="3023033">,</span>&nbsp;<span class="string" id="3023035">&#34;udp&#34;</span><span class="op" id="3023040">,</span>&nbsp;<span class="string" id="3023042">&#34;udp4&#34;</span><span class="op" id="3023048">,</span>&nbsp;<span class="string" id="3023050">&#34;udp6&#34;</span><span class="op" id="3023056">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023059">default</span><span class="op" id="3023066">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023070">return</span>&nbsp;<span class="ident" id="3023077">nil</span><span class="op" id="3023080">,</span>&nbsp;<span class="ident" id="3023082">UnknownNetworkError</span><span class="op" id="3023101">(</span><span class="ident" id="3023102">network</span><span class="op" id="3023109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023115">//&nbsp;Calling&nbsp;Dial&nbsp;here&nbsp;is&nbsp;scary&nbsp;--&nbsp;we&nbsp;have&nbsp;to&nbsp;be&nbsp;sure&nbsp;not&nbsp;to</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023175">//&nbsp;dial&nbsp;a&nbsp;name&nbsp;that&nbsp;will&nbsp;require&nbsp;a&nbsp;DNS&nbsp;lookup,&nbsp;or&nbsp;Dial&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023236">//&nbsp;call&nbsp;back&nbsp;here&nbsp;to&nbsp;translate&nbsp;it.&nbsp;The&nbsp;DNS&nbsp;config&nbsp;parser&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023298">//&nbsp;already&nbsp;checked&nbsp;that&nbsp;all&nbsp;the&nbsp;cfg.servers[i]&nbsp;are&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023353">//&nbsp;addresses,&nbsp;which&nbsp;Dial&nbsp;will&nbsp;use&nbsp;without&nbsp;a&nbsp;DNS&nbsp;lookup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023410">c</span><span class="op" id="3023411">,</span>&nbsp;<span class="ident" id="3023413">err</span>&nbsp;<span class="op" id="3023417">:=</span>&nbsp;<span class="ident" id="3023420">d</span><span class="op" id="3023421">.</span><span class="ident" id="3023422">Dial</span><span class="op" id="3023426">(</span><span class="ident" id="3023427">network</span><span class="op" id="3023434">,</span>&nbsp;<span class="ident" id="3023436">server</span><span class="op" id="3023442">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023445">if</span>&nbsp;<span class="ident" id="3023448">err</span>&nbsp;<span class="op" id="3023452">!=</span>&nbsp;<span class="ident" id="3023455">nil</span>&nbsp;<span class="op" id="3023459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023463">return</span>&nbsp;<span class="ident" id="3023470">nil</span><span class="op" id="3023473">,</span>&nbsp;<span class="ident" id="3023475">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023483">switch</span>&nbsp;<span class="ident" id="3023490">network</span>&nbsp;<span class="op" id="3023498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023501">case</span>&nbsp;<span class="string" id="3023506">&#34;tcp&#34;</span><span class="op" id="3023511">,</span>&nbsp;<span class="string" id="3023513">&#34;tcp4&#34;</span><span class="op" id="3023519">,</span>&nbsp;<span class="string" id="3023521">&#34;tcp6&#34;</span><span class="op" id="3023527">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023531">return</span>&nbsp;<span class="ident" id="3023538">c</span><span class="op" id="3023539">.</span><span class="op" id="3023540">(</span><span class="op" id="3023541">*</span><span class="ident" id="3023542">TCPConn</span><span class="op" id="3023549">)</span><span class="op" id="3023550">,</span>&nbsp;<span class="ident" id="3023552">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023557">case</span>&nbsp;<span class="string" id="3023562">&#34;udp&#34;</span><span class="op" id="3023567">,</span>&nbsp;<span class="string" id="3023569">&#34;udp4&#34;</span><span class="op" id="3023575">,</span>&nbsp;<span class="string" id="3023577">&#34;udp6&#34;</span><span class="op" id="3023583">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023587">return</span>&nbsp;<span class="ident" id="3023594">c</span><span class="op" id="3023595">.</span><span class="op" id="3023596">(</span><span class="op" id="3023597">*</span><span class="ident" id="3023598">UDPConn</span><span class="op" id="3023605">)</span><span class="op" id="3023606">,</span>&nbsp;<span class="ident" id="3023608">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3023616">panic</span><span class="op" id="3023621">(</span><span class="string" id="3023622">&#34;unreachable&#34;</span><span class="op" id="3023635">)</span><br>
<span class="lineno">120</span><span class="op" id="3023637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3023640">//&nbsp;exchange&nbsp;sends&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;connection&nbsp;and&nbsp;hopes&nbsp;for&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3023710">func</span>&nbsp;<span class="ident" id="3023715">exchange</span><span class="op" id="3023723">(</span><span class="ident" id="3023724">server</span><span class="op" id="3023730">,</span>&nbsp;<span class="ident" id="3023732">name</span>&nbsp;<span class="builtintype" id="3023737">string</span><span class="op" id="3023743">,</span>&nbsp;<span class="ident" id="3023745">qtype</span>&nbsp;<span class="builtintype" id="3023751">uint16</span><span class="op" id="3023757">,</span>&nbsp;<span class="ident" id="3023759">timeout</span>&nbsp;<span class="ident" id="3023767">time</span><span class="op" id="3023771">.</span><span class="ident" id="3023772">Duration</span><span class="op" id="3023780">)</span>&nbsp;<span class="op" id="3023782">(</span><span class="op" id="3023783">*</span><span class="ident" id="3023784">dnsMsg</span><span class="op" id="3023790">,</span>&nbsp;<span class="builtintype" id="3023792">error</span><span class="op" id="3023797">)</span>&nbsp;<span class="op" id="3023799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023802">d</span>&nbsp;<span class="op" id="3023804">:=</span>&nbsp;<span class="ident" id="3023807">Dialer</span><span class="op" id="3023813">{</span><span class="ident" id="3023814">Timeout</span><span class="op" id="3023821">:</span>&nbsp;<span class="ident" id="3023823">timeout</span><span class="op" id="3023830">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023833">out</span>&nbsp;<span class="op" id="3023837">:=</span>&nbsp;<span class="ident" id="3023840">dnsMsg</span><span class="op" id="3023846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023850">dnsMsgHdr</span><span class="op" id="3023859">:</span>&nbsp;<span class="ident" id="3023861">dnsMsgHdr</span><span class="op" id="3023870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023875">recursion_desired</span><span class="op" id="3023892">:</span>&nbsp;<span class="builtintype" id="3023894">true</span><span class="op" id="3023898">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023902">}</span><span class="op" id="3023903">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023907">question</span><span class="op" id="3023915">:</span>&nbsp;<span class="op" id="3023917">[</span><span class="op" id="3023918">]</span><span class="ident" id="3023919">dnsQuestion</span><span class="op" id="3023930">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023935">{</span><span class="ident" id="3023936">name</span><span class="op" id="3023940">,</span>&nbsp;<span class="ident" id="3023942">qtype</span><span class="op" id="3023947">,</span>&nbsp;<span class="ident" id="3023949">dnsClassINET</span><span class="op" id="3023961">}</span><span class="op" id="3023962">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023966">}</span><span class="op" id="3023967">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023973">for</span>&nbsp;<span class="ident" id="3023977">_</span><span class="op" id="3023978">,</span>&nbsp;<span class="ident" id="3023980">network</span>&nbsp;<span class="op" id="3023988">:=</span>&nbsp;<span class="keyword" id="3023991">range</span>&nbsp;<span class="op" id="3023997">[</span><span class="op" id="3023998">]</span><span class="builtintype" id="3023999">string</span><span class="op" id="3024005">{</span><span class="string" id="3024006">&#34;udp&#34;</span><span class="op" id="3024011">,</span>&nbsp;<span class="string" id="3024013">&#34;tcp&#34;</span><span class="op" id="3024018">}</span>&nbsp;<span class="op" id="3024020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024024">c</span><span class="op" id="3024025">,</span>&nbsp;<span class="ident" id="3024027">err</span>&nbsp;<span class="op" id="3024031">:=</span>&nbsp;<span class="ident" id="3024034">d</span><span class="op" id="3024035">.</span><span class="ident" id="3024036">dialDNS</span><span class="op" id="3024043">(</span><span class="ident" id="3024044">network</span><span class="op" id="3024051">,</span>&nbsp;<span class="ident" id="3024053">server</span><span class="op" id="3024059">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024063">if</span>&nbsp;<span class="ident" id="3024066">err</span>&nbsp;<span class="op" id="3024070">!=</span>&nbsp;<span class="ident" id="3024073">nil</span>&nbsp;<span class="op" id="3024077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024082">return</span>&nbsp;<span class="ident" id="3024089">nil</span><span class="op" id="3024092">,</span>&nbsp;<span class="ident" id="3024094">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024104">defer</span>&nbsp;<span class="ident" id="3024110">c</span><span class="op" id="3024111">.</span><span class="ident" id="3024112">Close</span><span class="op" id="3024117">(</span><span class="op" id="3024118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024122">if</span>&nbsp;<span class="ident" id="3024125">timeout</span>&nbsp;<span class="op" id="3024133">&gt;</span>&nbsp;<span class="num" id="3024135">0</span>&nbsp;<span class="op" id="3024137">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024142">c</span><span class="op" id="3024143">.</span><span class="ident" id="3024144">SetDeadline</span><span class="op" id="3024155">(</span><span class="ident" id="3024156">time</span><span class="op" id="3024160">.</span><span class="ident" id="3024161">Now</span><span class="op" id="3024164">(</span><span class="op" id="3024165">)</span><span class="op" id="3024166">.</span><span class="ident" id="3024167">Add</span><span class="op" id="3024170">(</span><span class="ident" id="3024171">timeout</span><span class="op" id="3024178">)</span><span class="op" id="3024179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024187">out</span><span class="op" id="3024190">.</span><span class="ident" id="3024191">id</span>&nbsp;<span class="op" id="3024194">=</span>&nbsp;<span class="builtintype" id="3024196">uint16</span><span class="op" id="3024202">(</span><span class="ident" id="3024203">rand</span><span class="op" id="3024207">.</span><span class="ident" id="3024208">Int</span><span class="op" id="3024211">(</span><span class="op" id="3024212">)</span><span class="op" id="3024213">)</span>&nbsp;<span class="op" id="3024215">^</span>&nbsp;<span class="builtintype" id="3024217">uint16</span><span class="op" id="3024223">(</span><span class="ident" id="3024224">time</span><span class="op" id="3024228">.</span><span class="ident" id="3024229">Now</span><span class="op" id="3024232">(</span><span class="op" id="3024233">)</span><span class="op" id="3024234">.</span><span class="ident" id="3024235">UnixNano</span><span class="op" id="3024243">(</span><span class="op" id="3024244">)</span><span class="op" id="3024245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024249">if</span>&nbsp;<span class="ident" id="3024252">err</span>&nbsp;<span class="op" id="3024256">:=</span>&nbsp;<span class="ident" id="3024259">c</span><span class="op" id="3024260">.</span><span class="ident" id="3024261">writeDNSQuery</span><span class="op" id="3024274">(</span><span class="op" id="3024275">&amp;</span><span class="ident" id="3024276">out</span><span class="op" id="3024279">)</span><span class="op" id="3024280">;</span>&nbsp;<span class="ident" id="3024282">err</span>&nbsp;<span class="op" id="3024286">!=</span>&nbsp;<span class="ident" id="3024289">nil</span>&nbsp;<span class="op" id="3024293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024298">return</span>&nbsp;<span class="ident" id="3024305">nil</span><span class="op" id="3024308">,</span>&nbsp;<span class="ident" id="3024310">err</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024320">in</span><span class="op" id="3024322">,</span>&nbsp;<span class="ident" id="3024324">err</span>&nbsp;<span class="op" id="3024328">:=</span>&nbsp;<span class="ident" id="3024331">c</span><span class="op" id="3024332">.</span><span class="ident" id="3024333">readDNSResponse</span><span class="op" id="3024348">(</span><span class="op" id="3024349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024353">if</span>&nbsp;<span class="ident" id="3024356">err</span>&nbsp;<span class="op" id="3024360">!=</span>&nbsp;<span class="ident" id="3024363">nil</span>&nbsp;<span class="op" id="3024367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024372">return</span>&nbsp;<span class="ident" id="3024379">nil</span><span class="op" id="3024382">,</span>&nbsp;<span class="ident" id="3024384">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024390">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024394">if</span>&nbsp;<span class="ident" id="3024397">in</span><span class="op" id="3024399">.</span><span class="ident" id="3024400">id</span>&nbsp;<span class="op" id="3024403">!=</span>&nbsp;<span class="ident" id="3024406">out</span><span class="op" id="3024409">.</span><span class="ident" id="3024410">id</span>&nbsp;<span class="op" id="3024413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024418">return</span>&nbsp;<span class="ident" id="3024425">nil</span><span class="op" id="3024428">,</span>&nbsp;<span class="ident" id="3024430">errors</span><span class="op" id="3024436">.</span><span class="ident" id="3024437">New</span><span class="op" id="3024440">(</span><span class="string" id="3024441">&#34;DNS&nbsp;message&nbsp;ID&nbsp;mismatch&#34;</span><span class="op" id="3024466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024474">if</span>&nbsp;<span class="ident" id="3024477">in</span><span class="op" id="3024479">.</span><span class="ident" id="3024480">truncated</span>&nbsp;<span class="op" id="3024490">{</span>&nbsp;<span class="comment" id="3024492">//&nbsp;see&nbsp;RFC&nbsp;5966</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024511">continue</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024526">return</span>&nbsp;<span class="ident" id="3024533">in</span><span class="op" id="3024535">,</span>&nbsp;<span class="ident" id="3024537">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024545">return</span>&nbsp;<span class="ident" id="3024552">nil</span><span class="op" id="3024555">,</span>&nbsp;<span class="ident" id="3024557">errors</span><span class="op" id="3024563">.</span><span class="ident" id="3024564">New</span><span class="op" id="3024567">(</span><span class="string" id="3024568">&#34;no&nbsp;answer&nbsp;from&nbsp;DNS&nbsp;server&#34;</span><span class="op" id="3024595">)</span><br>
<span class="lineno"></span><span class="op" id="3024597">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="3024600">//&nbsp;Do&nbsp;a&nbsp;lookup&nbsp;for&nbsp;a&nbsp;single&nbsp;name,&nbsp;which&nbsp;must&nbsp;be&nbsp;rooted</span><br>
<span class="lineno"></span><span class="comment" id="3024655">//&nbsp;(otherwise&nbsp;answer&nbsp;will&nbsp;not&nbsp;find&nbsp;the&nbsp;answers).</span><br>
<span class="lineno"></span><span class="keyword" id="3024704">func</span>&nbsp;<span class="ident" id="3024709">tryOneName</span><span class="op" id="3024719">(</span><span class="ident" id="3024720">cfg</span>&nbsp;<span class="op" id="3024724">*</span><span class="ident" id="3024725">dnsConfig</span><span class="op" id="3024734">,</span>&nbsp;<span class="ident" id="3024736">name</span>&nbsp;<span class="builtintype" id="3024741">string</span><span class="op" id="3024747">,</span>&nbsp;<span class="ident" id="3024749">qtype</span>&nbsp;<span class="builtintype" id="3024755">uint16</span><span class="op" id="3024761">)</span>&nbsp;<span class="op" id="3024763">(</span><span class="builtintype" id="3024764">string</span><span class="op" id="3024770">,</span>&nbsp;<span class="op" id="3024772">[</span><span class="op" id="3024773">]</span><span class="ident" id="3024774">dnsRR</span><span class="op" id="3024779">,</span>&nbsp;<span class="builtintype" id="3024781">error</span><span class="op" id="3024786">)</span>&nbsp;<span class="op" id="3024788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024791">if</span>&nbsp;<span class="builtinfunc" id="3024794">len</span><span class="op" id="3024797">(</span><span class="ident" id="3024798">cfg</span><span class="op" id="3024801">.</span><span class="ident" id="3024802">servers</span><span class="op" id="3024809">)</span>&nbsp;<span class="op" id="3024811">==</span>&nbsp;<span class="num" id="3024814">0</span>&nbsp;<span class="op" id="3024816">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024820">return</span>&nbsp;<span class="string" id="3024827">&#34;&#34;</span><span class="op" id="3024829">,</span>&nbsp;<span class="ident" id="3024831">nil</span><span class="op" id="3024834">,</span>&nbsp;<span class="op" id="3024836">&amp;</span><span class="ident" id="3024837">DNSError</span><span class="op" id="3024845">{</span><span class="ident" id="3024846">Err</span><span class="op" id="3024849">:</span>&nbsp;<span class="string" id="3024851">&#34;no&nbsp;DNS&nbsp;servers&#34;</span><span class="op" id="3024867">,</span>&nbsp;<span class="ident" id="3024869">Name</span><span class="op" id="3024873">:</span>&nbsp;<span class="ident" id="3024875">name</span><span class="op" id="3024879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024885">if</span>&nbsp;<span class="builtinfunc" id="3024888">len</span><span class="op" id="3024891">(</span><span class="ident" id="3024892">name</span><span class="op" id="3024896">)</span>&nbsp;<span class="op" id="3024898">&gt;=</span>&nbsp;<span class="num" id="3024901">256</span>&nbsp;<span class="op" id="3024905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024909">return</span>&nbsp;<span class="string" id="3024916">&#34;&#34;</span><span class="op" id="3024918">,</span>&nbsp;<span class="ident" id="3024920">nil</span><span class="op" id="3024923">,</span>&nbsp;<span class="op" id="3024925">&amp;</span><span class="ident" id="3024926">DNSError</span><span class="op" id="3024934">{</span><span class="ident" id="3024935">Err</span><span class="op" id="3024938">:</span>&nbsp;<span class="string" id="3024940">&#34;DNS&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="3024959">,</span>&nbsp;<span class="ident" id="3024961">Name</span><span class="op" id="3024965">:</span>&nbsp;<span class="ident" id="3024967">name</span><span class="op" id="3024971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024974">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024977">timeout</span>&nbsp;<span class="op" id="3024985">:=</span>&nbsp;<span class="ident" id="3024988">time</span><span class="op" id="3024992">.</span><span class="ident" id="3024993">Duration</span><span class="op" id="3025001">(</span><span class="ident" id="3025002">cfg</span><span class="op" id="3025005">.</span><span class="ident" id="3025006">timeout</span><span class="op" id="3025013">)</span>&nbsp;<span class="op" id="3025015">*</span>&nbsp;<span class="ident" id="3025017">time</span><span class="op" id="3025021">.</span><span class="ident" id="3025022">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025030">var</span>&nbsp;<span class="ident" id="3025034">lastErr</span>&nbsp;<span class="builtintype" id="3025042">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025049">for</span>&nbsp;<span class="ident" id="3025053">i</span>&nbsp;<span class="op" id="3025055">:=</span>&nbsp;<span class="num" id="3025058">0</span><span class="op" id="3025059">;</span>&nbsp;<span class="ident" id="3025061">i</span>&nbsp;<span class="op" id="3025063">&lt;</span>&nbsp;<span class="ident" id="3025065">cfg</span><span class="op" id="3025068">.</span><span class="ident" id="3025069">attempts</span><span class="op" id="3025077">;</span>&nbsp;<span class="ident" id="3025079">i</span><span class="op" id="3025080">++</span>&nbsp;<span class="op" id="3025083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025087">for</span>&nbsp;<span class="ident" id="3025091">_</span><span class="op" id="3025092">,</span>&nbsp;<span class="ident" id="3025094">server</span>&nbsp;<span class="op" id="3025101">:=</span>&nbsp;<span class="keyword" id="3025104">range</span>&nbsp;<span class="ident" id="3025110">cfg</span><span class="op" id="3025113">.</span><span class="ident" id="3025114">servers</span>&nbsp;<span class="op" id="3025122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025127">server</span>&nbsp;<span class="op" id="3025134">=</span>&nbsp;<span class="ident" id="3025136">JoinHostPort</span><span class="op" id="3025148">(</span><span class="ident" id="3025149">server</span><span class="op" id="3025155">,</span>&nbsp;<span class="string" id="3025157">&#34;53&#34;</span><span class="op" id="3025161">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025166">msg</span><span class="op" id="3025169">,</span>&nbsp;<span class="ident" id="3025171">err</span>&nbsp;<span class="op" id="3025175">:=</span>&nbsp;<span class="ident" id="3025178">exchange</span><span class="op" id="3025186">(</span><span class="ident" id="3025187">server</span><span class="op" id="3025193">,</span>&nbsp;<span class="ident" id="3025195">name</span><span class="op" id="3025199">,</span>&nbsp;<span class="ident" id="3025201">qtype</span><span class="op" id="3025206">,</span>&nbsp;<span class="ident" id="3025208">timeout</span><span class="op" id="3025215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025220">if</span>&nbsp;<span class="ident" id="3025223">err</span>&nbsp;<span class="op" id="3025227">!=</span>&nbsp;<span class="ident" id="3025230">nil</span>&nbsp;<span class="op" id="3025234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025240">lastErr</span>&nbsp;<span class="op" id="3025248">=</span>&nbsp;<span class="op" id="3025250">&amp;</span><span class="ident" id="3025251">DNSError</span><span class="op" id="3025259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025266">Err</span><span class="op" id="3025269">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025274">err</span><span class="op" id="3025277">.</span><span class="ident" id="3025278">Error</span><span class="op" id="3025283">(</span><span class="op" id="3025284">)</span><span class="op" id="3025285">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025292">Name</span><span class="op" id="3025296">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3025300">name</span><span class="op" id="3025304">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025311">Server</span><span class="op" id="3025317">:</span>&nbsp;<span class="ident" id="3025319">server</span><span class="op" id="3025325">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025337">if</span>&nbsp;<span class="ident" id="3025340">nerr</span><span class="op" id="3025344">,</span>&nbsp;<span class="ident" id="3025346">ok</span>&nbsp;<span class="op" id="3025349">:=</span>&nbsp;<span class="ident" id="3025352">err</span><span class="op" id="3025355">.</span><span class="op" id="3025356">(</span><span class="ident" id="3025357">Error</span><span class="op" id="3025362">)</span><span class="op" id="3025363">;</span>&nbsp;<span class="ident" id="3025365">ok</span>&nbsp;<span class="op" id="3025368">&amp;&amp;</span>&nbsp;<span class="ident" id="3025371">nerr</span><span class="op" id="3025375">.</span><span class="ident" id="3025376">Timeout</span><span class="op" id="3025383">(</span><span class="op" id="3025384">)</span>&nbsp;<span class="op" id="3025386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025393">lastErr</span><span class="op" id="3025400">.</span><span class="op" id="3025401">(</span><span class="op" id="3025402">*</span><span class="ident" id="3025403">DNSError</span><span class="op" id="3025411">)</span><span class="op" id="3025412">.</span><span class="ident" id="3025413">IsTimeout</span>&nbsp;<span class="op" id="3025423">=</span>&nbsp;<span class="builtintype" id="3025425">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025434">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025440">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025457">cname</span><span class="op" id="3025462">,</span>&nbsp;<span class="ident" id="3025464">addrs</span><span class="op" id="3025469">,</span>&nbsp;<span class="ident" id="3025471">err</span>&nbsp;<span class="op" id="3025475">:=</span>&nbsp;<span class="ident" id="3025478">answer</span><span class="op" id="3025484">(</span><span class="ident" id="3025485">name</span><span class="op" id="3025489">,</span>&nbsp;<span class="ident" id="3025491">server</span><span class="op" id="3025497">,</span>&nbsp;<span class="ident" id="3025499">msg</span><span class="op" id="3025502">,</span>&nbsp;<span class="ident" id="3025504">qtype</span><span class="op" id="3025509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025514">if</span>&nbsp;<span class="ident" id="3025517">err</span>&nbsp;<span class="op" id="3025521">==</span>&nbsp;<span class="ident" id="3025524">nil</span>&nbsp;<span class="op" id="3025528">||</span>&nbsp;<span class="ident" id="3025531">err</span><span class="op" id="3025534">.</span><span class="op" id="3025535">(</span><span class="op" id="3025536">*</span><span class="ident" id="3025537">DNSError</span><span class="op" id="3025545">)</span><span class="op" id="3025546">.</span><span class="ident" id="3025547">Err</span>&nbsp;<span class="op" id="3025551">==</span>&nbsp;<span class="ident" id="3025554">noSuchHost</span>&nbsp;<span class="op" id="3025565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025571">return</span>&nbsp;<span class="ident" id="3025578">cname</span><span class="op" id="3025583">,</span>&nbsp;<span class="ident" id="3025585">addrs</span><span class="op" id="3025590">,</span>&nbsp;<span class="ident" id="3025592">err</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025604">lastErr</span>&nbsp;<span class="op" id="3025612">=</span>&nbsp;<span class="ident" id="3025614">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025626">return</span>&nbsp;<span class="string" id="3025633">&#34;&#34;</span><span class="op" id="3025635">,</span>&nbsp;<span class="ident" id="3025637">nil</span><span class="op" id="3025640">,</span>&nbsp;<span class="ident" id="3025642">lastErr</span><br>
<span class="lineno">195</span><span class="op" id="3025650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3025653">func</span>&nbsp;<span class="ident" id="3025658">convertRR_A</span><span class="op" id="3025669">(</span><span class="ident" id="3025670">records</span>&nbsp;<span class="op" id="3025678">[</span><span class="op" id="3025679">]</span><span class="ident" id="3025680">dnsRR</span><span class="op" id="3025685">)</span>&nbsp;<span class="op" id="3025687">[</span><span class="op" id="3025688">]</span><span class="ident" id="3025689">IP</span>&nbsp;<span class="op" id="3025692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025695">addrs</span>&nbsp;<span class="op" id="3025701">:=</span>&nbsp;<span class="builtinfunc" id="3025704">make</span><span class="op" id="3025708">(</span><span class="op" id="3025709">[</span><span class="op" id="3025710">]</span><span class="ident" id="3025711">IP</span><span class="op" id="3025713">,</span>&nbsp;<span class="builtinfunc" id="3025715">len</span><span class="op" id="3025718">(</span><span class="ident" id="3025719">records</span><span class="op" id="3025726">)</span><span class="op" id="3025727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025730">for</span>&nbsp;<span class="ident" id="3025734">i</span><span class="op" id="3025735">,</span>&nbsp;<span class="ident" id="3025737">rr</span>&nbsp;<span class="op" id="3025740">:=</span>&nbsp;<span class="keyword" id="3025743">range</span>&nbsp;<span class="ident" id="3025749">records</span>&nbsp;<span class="op" id="3025757">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025761">a</span>&nbsp;<span class="op" id="3025763">:=</span>&nbsp;<span class="ident" id="3025766">rr</span><span class="op" id="3025768">.</span><span class="op" id="3025769">(</span><span class="op" id="3025770">*</span><span class="ident" id="3025771">dnsRR_A</span><span class="op" id="3025778">)</span><span class="op" id="3025779">.</span><span class="ident" id="3025780">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025784">addrs</span><span class="op" id="3025789">[</span><span class="ident" id="3025790">i</span><span class="op" id="3025791">]</span>&nbsp;<span class="op" id="3025793">=</span>&nbsp;<span class="ident" id="3025795">IPv4</span><span class="op" id="3025799">(</span><span class="builtintype" id="3025800">byte</span><span class="op" id="3025804">(</span><span class="ident" id="3025805">a</span><span class="op" id="3025806">&gt;&gt;</span><span class="num" id="3025808">24</span><span class="op" id="3025810">)</span><span class="op" id="3025811">,</span>&nbsp;<span class="builtintype" id="3025813">byte</span><span class="op" id="3025817">(</span><span class="ident" id="3025818">a</span><span class="op" id="3025819">&gt;&gt;</span><span class="num" id="3025821">16</span><span class="op" id="3025823">)</span><span class="op" id="3025824">,</span>&nbsp;<span class="builtintype" id="3025826">byte</span><span class="op" id="3025830">(</span><span class="ident" id="3025831">a</span><span class="op" id="3025832">&gt;&gt;</span><span class="num" id="3025834">8</span><span class="op" id="3025835">)</span><span class="op" id="3025836">,</span>&nbsp;<span class="builtintype" id="3025838">byte</span><span class="op" id="3025842">(</span><span class="ident" id="3025843">a</span><span class="op" id="3025844">)</span><span class="op" id="3025845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025851">return</span>&nbsp;<span class="ident" id="3025858">addrs</span><br>
<span class="lineno"></span><span class="op" id="3025864">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="3025867">func</span>&nbsp;<span class="ident" id="3025872">convertRR_AAAA</span><span class="op" id="3025886">(</span><span class="ident" id="3025887">records</span>&nbsp;<span class="op" id="3025895">[</span><span class="op" id="3025896">]</span><span class="ident" id="3025897">dnsRR</span><span class="op" id="3025902">)</span>&nbsp;<span class="op" id="3025904">[</span><span class="op" id="3025905">]</span><span class="ident" id="3025906">IP</span>&nbsp;<span class="op" id="3025909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025912">addrs</span>&nbsp;<span class="op" id="3025918">:=</span>&nbsp;<span class="builtinfunc" id="3025921">make</span><span class="op" id="3025925">(</span><span class="op" id="3025926">[</span><span class="op" id="3025927">]</span><span class="ident" id="3025928">IP</span><span class="op" id="3025930">,</span>&nbsp;<span class="builtinfunc" id="3025932">len</span><span class="op" id="3025935">(</span><span class="ident" id="3025936">records</span><span class="op" id="3025943">)</span><span class="op" id="3025944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025947">for</span>&nbsp;<span class="ident" id="3025951">i</span><span class="op" id="3025952">,</span>&nbsp;<span class="ident" id="3025954">rr</span>&nbsp;<span class="op" id="3025957">:=</span>&nbsp;<span class="keyword" id="3025960">range</span>&nbsp;<span class="ident" id="3025966">records</span>&nbsp;<span class="op" id="3025974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025978">a</span>&nbsp;<span class="op" id="3025980">:=</span>&nbsp;<span class="builtinfunc" id="3025983">make</span><span class="op" id="3025987">(</span><span class="ident" id="3025988">IP</span><span class="op" id="3025990">,</span>&nbsp;<span class="ident" id="3025992">IPv6len</span><span class="op" id="3025999">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3026003">copy</span><span class="op" id="3026007">(</span><span class="ident" id="3026008">a</span><span class="op" id="3026009">,</span>&nbsp;<span class="ident" id="3026011">rr</span><span class="op" id="3026013">.</span><span class="op" id="3026014">(</span><span class="op" id="3026015">*</span><span class="ident" id="3026016">dnsRR_AAAA</span><span class="op" id="3026026">)</span><span class="op" id="3026027">.</span><span class="ident" id="3026028">AAAA</span><span class="op" id="3026032">[</span><span class="op" id="3026033">:</span><span class="op" id="3026034">]</span><span class="op" id="3026035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026039">addrs</span><span class="op" id="3026044">[</span><span class="ident" id="3026045">i</span><span class="op" id="3026046">]</span>&nbsp;<span class="op" id="3026048">=</span>&nbsp;<span class="ident" id="3026050">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026056">return</span>&nbsp;<span class="ident" id="3026063">addrs</span><br>
<span class="lineno"></span><span class="op" id="3026069">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="3026072">var</span>&nbsp;<span class="ident" id="3026076">cfg</span>&nbsp;<span class="keyword" id="3026080">struct</span>&nbsp;<span class="op" id="3026087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026090">ch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026100">chan</span>&nbsp;<span class="keyword" id="3026105">struct</span><span class="op" id="3026111">{</span><span class="op" id="3026112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026115">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026125">sync</span><span class="op" id="3026129">.</span><span class="ident" id="3026130">RWMutex</span>&nbsp;<span class="comment" id="3026138">//&nbsp;protects&nbsp;dnsConfig&nbsp;and&nbsp;dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026172">dnsConfig</span>&nbsp;<span class="op" id="3026182">*</span><span class="ident" id="3026183">dnsConfig</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026194">dnserr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3026204">error</span><br>
<span class="lineno"></span><span class="op" id="3026210">}</span><br>
<span class="lineno"></span><span class="keyword" id="3026212">var</span>&nbsp;<span class="ident" id="3026216">onceLoadConfig</span>&nbsp;<span class="ident" id="3026231">sync</span><span class="op" id="3026235">.</span><span class="ident" id="3026236">Once</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3026242">//&nbsp;Assume&nbsp;dns&nbsp;config&nbsp;file&nbsp;is&nbsp;/etc/resolv.conf&nbsp;here</span><br>
<span class="lineno">225</span><span class="keyword" id="3026293">func</span>&nbsp;<span class="ident" id="3026298">loadDefaultConfig</span><span class="op" id="3026315">(</span><span class="op" id="3026316">)</span>&nbsp;<span class="op" id="3026318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026321">loadConfig</span><span class="op" id="3026331">(</span><span class="string" id="3026332">&#34;/etc/resolv.conf&#34;</span><span class="op" id="3026350">,</span>&nbsp;<span class="num" id="3026352">5</span><span class="op" id="3026353">*</span><span class="ident" id="3026354">time</span><span class="op" id="3026358">.</span><span class="ident" id="3026359">Second</span><span class="op" id="3026365">,</span>&nbsp;<span class="ident" id="3026367">nil</span><span class="op" id="3026370">)</span><br>
<span class="lineno"></span><span class="op" id="3026372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3026375">func</span>&nbsp;<span class="ident" id="3026380">loadConfig</span><span class="op" id="3026390">(</span><span class="ident" id="3026391">resolvConfPath</span>&nbsp;<span class="builtintype" id="3026406">string</span><span class="op" id="3026412">,</span>&nbsp;<span class="ident" id="3026414">reloadTime</span>&nbsp;<span class="ident" id="3026425">time</span><span class="op" id="3026429">.</span><span class="ident" id="3026430">Duration</span><span class="op" id="3026438">,</span>&nbsp;<span class="ident" id="3026440">quit</span>&nbsp;<span class="op" id="3026445">&lt;-</span><span class="keyword" id="3026447">chan</span>&nbsp;<span class="keyword" id="3026452">chan</span>&nbsp;<span class="keyword" id="3026457">struct</span><span class="op" id="3026463">{</span><span class="op" id="3026464">}</span><span class="op" id="3026465">)</span>&nbsp;<span class="op" id="3026467">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026470">var</span>&nbsp;<span class="ident" id="3026474">mtime</span>&nbsp;<span class="ident" id="3026480">time</span><span class="op" id="3026484">.</span><span class="ident" id="3026485">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026491">cfg</span><span class="op" id="3026494">.</span><span class="ident" id="3026495">ch</span>&nbsp;<span class="op" id="3026498">=</span>&nbsp;<span class="builtinfunc" id="3026500">make</span><span class="op" id="3026504">(</span><span class="keyword" id="3026505">chan</span>&nbsp;<span class="keyword" id="3026510">struct</span><span class="op" id="3026516">{</span><span class="op" id="3026517">}</span><span class="op" id="3026518">,</span>&nbsp;<span class="num" id="3026520">1</span><span class="op" id="3026521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026524">if</span>&nbsp;<span class="ident" id="3026527">fi</span><span class="op" id="3026529">,</span>&nbsp;<span class="ident" id="3026531">err</span>&nbsp;<span class="op" id="3026535">:=</span>&nbsp;<span class="ident" id="3026538">os</span><span class="op" id="3026540">.</span><span class="ident" id="3026541">Stat</span><span class="op" id="3026545">(</span><span class="ident" id="3026546">resolvConfPath</span><span class="op" id="3026560">)</span><span class="op" id="3026561">;</span>&nbsp;<span class="ident" id="3026563">err</span>&nbsp;<span class="op" id="3026567">!=</span>&nbsp;<span class="ident" id="3026570">nil</span>&nbsp;<span class="op" id="3026574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026578">cfg</span><span class="op" id="3026581">.</span><span class="ident" id="3026582">dnserr</span>&nbsp;<span class="op" id="3026589">=</span>&nbsp;<span class="ident" id="3026591">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026596">}</span>&nbsp;<span class="keyword" id="3026598">else</span>&nbsp;<span class="op" id="3026603">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026607">mtime</span>&nbsp;<span class="op" id="3026613">=</span>&nbsp;<span class="ident" id="3026615">fi</span><span class="op" id="3026617">.</span><span class="ident" id="3026618">ModTime</span><span class="op" id="3026625">(</span><span class="op" id="3026626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026630">cfg</span><span class="op" id="3026633">.</span><span class="ident" id="3026634">dnsConfig</span><span class="op" id="3026643">,</span>&nbsp;<span class="ident" id="3026645">cfg</span><span class="op" id="3026648">.</span><span class="ident" id="3026649">dnserr</span>&nbsp;<span class="op" id="3026656">=</span>&nbsp;<span class="ident" id="3026658">dnsReadConfig</span><span class="op" id="3026671">(</span><span class="ident" id="3026672">resolvConfPath</span><span class="op" id="3026686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026692">go</span>&nbsp;<span class="keyword" id="3026695">func</span><span class="op" id="3026699">(</span><span class="op" id="3026700">)</span>&nbsp;<span class="op" id="3026702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026706">for</span>&nbsp;<span class="op" id="3026710">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026715">time</span><span class="op" id="3026719">.</span><span class="ident" id="3026720">Sleep</span><span class="op" id="3026725">(</span><span class="ident" id="3026726">reloadTime</span><span class="op" id="3026736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026741">select</span>&nbsp;<span class="op" id="3026748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026753">case</span>&nbsp;<span class="ident" id="3026758">qresp</span>&nbsp;<span class="op" id="3026764">:=</span>&nbsp;<span class="op" id="3026767">&lt;-</span><span class="ident" id="3026769">quit</span><span class="op" id="3026773">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026779">qresp</span>&nbsp;<span class="op" id="3026785">&lt;-</span>&nbsp;<span class="keyword" id="3026788">struct</span><span class="op" id="3026794">{</span><span class="op" id="3026795">}</span><span class="op" id="3026796">{</span><span class="op" id="3026797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026803">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026813">case</span>&nbsp;<span class="op" id="3026818">&lt;-</span><span class="ident" id="3026820">cfg</span><span class="op" id="3026823">.</span><span class="ident" id="3026824">ch</span><span class="op" id="3026826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3026837">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026889">fi</span><span class="op" id="3026891">,</span>&nbsp;<span class="ident" id="3026893">err</span>&nbsp;<span class="op" id="3026897">:=</span>&nbsp;<span class="ident" id="3026900">os</span><span class="op" id="3026902">.</span><span class="ident" id="3026903">Stat</span><span class="op" id="3026907">(</span><span class="ident" id="3026908">resolvConfPath</span><span class="op" id="3026922">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026927">if</span>&nbsp;<span class="ident" id="3026930">err</span>&nbsp;<span class="op" id="3026934">!=</span>&nbsp;<span class="ident" id="3026937">nil</span>&nbsp;<span class="op" id="3026941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026947">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3026964">//&nbsp;If&nbsp;the&nbsp;resolv.conf&nbsp;mtime&nbsp;didn&#39;t&nbsp;change,&nbsp;do&nbsp;not&nbsp;reload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027024">m</span>&nbsp;<span class="op" id="3027026">:=</span>&nbsp;<span class="ident" id="3027029">fi</span><span class="op" id="3027031">.</span><span class="ident" id="3027032">ModTime</span><span class="op" id="3027039">(</span><span class="op" id="3027040">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027045">if</span>&nbsp;<span class="ident" id="3027048">m</span><span class="op" id="3027049">.</span><span class="ident" id="3027050">Equal</span><span class="op" id="3027055">(</span><span class="ident" id="3027056">mtime</span><span class="op" id="3027061">)</span>&nbsp;<span class="op" id="3027063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027069">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027086">mtime</span>&nbsp;<span class="op" id="3027092">=</span>&nbsp;<span class="ident" id="3027094">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3027099">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027151">ncfg</span><span class="op" id="3027155">,</span>&nbsp;<span class="ident" id="3027157">err</span>&nbsp;<span class="op" id="3027161">:=</span>&nbsp;<span class="ident" id="3027164">dnsReadConfig</span><span class="op" id="3027177">(</span><span class="ident" id="3027178">resolvConfPath</span><span class="op" id="3027192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027197">if</span>&nbsp;<span class="ident" id="3027200">err</span>&nbsp;<span class="op" id="3027204">!=</span>&nbsp;<span class="ident" id="3027207">nil</span>&nbsp;<span class="op" id="3027211">||</span>&nbsp;<span class="builtinfunc" id="3027214">len</span><span class="op" id="3027217">(</span><span class="ident" id="3027218">ncfg</span><span class="op" id="3027222">.</span><span class="ident" id="3027223">servers</span><span class="op" id="3027230">)</span>&nbsp;<span class="op" id="3027232">==</span>&nbsp;<span class="num" id="3027235">0</span>&nbsp;<span class="op" id="3027237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027243">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027260">cfg</span><span class="op" id="3027263">.</span><span class="ident" id="3027264">mu</span><span class="op" id="3027266">.</span><span class="ident" id="3027267">Lock</span><span class="op" id="3027271">(</span><span class="op" id="3027272">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027277">cfg</span><span class="op" id="3027280">.</span><span class="ident" id="3027281">dnsConfig</span>&nbsp;<span class="op" id="3027291">=</span>&nbsp;<span class="ident" id="3027293">ncfg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027301">cfg</span><span class="op" id="3027304">.</span><span class="ident" id="3027305">dnserr</span>&nbsp;<span class="op" id="3027312">=</span>&nbsp;<span class="ident" id="3027314">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027321">cfg</span><span class="op" id="3027324">.</span><span class="ident" id="3027325">mu</span><span class="op" id="3027327">.</span><span class="ident" id="3027328">Unlock</span><span class="op" id="3027334">(</span><span class="op" id="3027335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027342">}</span><span class="op" id="3027343">(</span><span class="op" id="3027344">)</span><br>
<span class="lineno">270</span><span class="op" id="3027346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3027349">func</span>&nbsp;<span class="ident" id="3027354">lookup</span><span class="op" id="3027360">(</span><span class="ident" id="3027361">name</span>&nbsp;<span class="builtintype" id="3027366">string</span><span class="op" id="3027372">,</span>&nbsp;<span class="ident" id="3027374">qtype</span>&nbsp;<span class="builtintype" id="3027380">uint16</span><span class="op" id="3027386">)</span>&nbsp;<span class="op" id="3027388">(</span><span class="ident" id="3027389">cname</span>&nbsp;<span class="builtintype" id="3027395">string</span><span class="op" id="3027401">,</span>&nbsp;<span class="ident" id="3027403">addrs</span>&nbsp;<span class="op" id="3027409">[</span><span class="op" id="3027410">]</span><span class="ident" id="3027411">dnsRR</span><span class="op" id="3027416">,</span>&nbsp;<span class="ident" id="3027418">err</span>&nbsp;<span class="builtintype" id="3027422">error</span><span class="op" id="3027427">)</span>&nbsp;<span class="op" id="3027429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027432">if</span>&nbsp;<span class="op" id="3027435">!</span><span class="ident" id="3027436">isDomainName</span><span class="op" id="3027448">(</span><span class="ident" id="3027449">name</span><span class="op" id="3027453">)</span>&nbsp;<span class="op" id="3027455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027459">return</span>&nbsp;<span class="ident" id="3027466">name</span><span class="op" id="3027470">,</span>&nbsp;<span class="ident" id="3027472">nil</span><span class="op" id="3027475">,</span>&nbsp;<span class="op" id="3027477">&amp;</span><span class="ident" id="3027478">DNSError</span><span class="op" id="3027486">{</span><span class="ident" id="3027487">Err</span><span class="op" id="3027490">:</span>&nbsp;<span class="string" id="3027492">&#34;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="3027513">,</span>&nbsp;<span class="ident" id="3027515">Name</span><span class="op" id="3027519">:</span>&nbsp;<span class="ident" id="3027521">name</span><span class="op" id="3027525">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027531">onceLoadConfig</span><span class="op" id="3027545">.</span><span class="ident" id="3027546">Do</span><span class="op" id="3027548">(</span><span class="ident" id="3027549">loadDefaultConfig</span><span class="op" id="3027566">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027570">select</span>&nbsp;<span class="op" id="3027577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027580">case</span>&nbsp;<span class="ident" id="3027585">cfg</span><span class="op" id="3027588">.</span><span class="ident" id="3027589">ch</span>&nbsp;<span class="op" id="3027592">&lt;-</span>&nbsp;<span class="keyword" id="3027595">struct</span><span class="op" id="3027601">{</span><span class="op" id="3027602">}</span><span class="op" id="3027603">{</span><span class="op" id="3027604">}</span><span class="op" id="3027605">:</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027608">default</span><span class="op" id="3027615">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027622">cfg</span><span class="op" id="3027625">.</span><span class="ident" id="3027626">mu</span><span class="op" id="3027628">.</span><span class="ident" id="3027629">RLock</span><span class="op" id="3027634">(</span><span class="op" id="3027635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027638">defer</span>&nbsp;<span class="ident" id="3027644">cfg</span><span class="op" id="3027647">.</span><span class="ident" id="3027648">mu</span><span class="op" id="3027650">.</span><span class="ident" id="3027651">RUnlock</span><span class="op" id="3027658">(</span><span class="op" id="3027659">)</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027663">if</span>&nbsp;<span class="ident" id="3027666">cfg</span><span class="op" id="3027669">.</span><span class="ident" id="3027670">dnserr</span>&nbsp;<span class="op" id="3027677">!=</span>&nbsp;<span class="ident" id="3027680">nil</span>&nbsp;<span class="op" id="3027684">||</span>&nbsp;<span class="ident" id="3027687">cfg</span><span class="op" id="3027690">.</span><span class="ident" id="3027691">dnsConfig</span>&nbsp;<span class="op" id="3027701">==</span>&nbsp;<span class="ident" id="3027704">nil</span>&nbsp;<span class="op" id="3027708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027712">err</span>&nbsp;<span class="op" id="3027716">=</span>&nbsp;<span class="ident" id="3027718">cfg</span><span class="op" id="3027721">.</span><span class="ident" id="3027722">dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027731">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027739">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3027742">//&nbsp;If&nbsp;name&nbsp;is&nbsp;rooted&nbsp;(trailing&nbsp;dot)&nbsp;or&nbsp;has&nbsp;enough&nbsp;dots,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3027799">//&nbsp;try&nbsp;it&nbsp;by&nbsp;itself&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027827">rooted</span>&nbsp;<span class="op" id="3027834">:=</span>&nbsp;<span class="builtinfunc" id="3027837">len</span><span class="op" id="3027840">(</span><span class="ident" id="3027841">name</span><span class="op" id="3027845">)</span>&nbsp;<span class="op" id="3027847">&gt;</span>&nbsp;<span class="num" id="3027849">0</span>&nbsp;<span class="op" id="3027851">&amp;&amp;</span>&nbsp;<span class="ident" id="3027854">name</span><span class="op" id="3027858">[</span><span class="builtinfunc" id="3027859">len</span><span class="op" id="3027862">(</span><span class="ident" id="3027863">name</span><span class="op" id="3027867">)</span><span class="op" id="3027868">-</span><span class="num" id="3027869">1</span><span class="op" id="3027870">]</span>&nbsp;<span class="op" id="3027872">==</span>&nbsp;<span class="string" id="3027875">&#39;.&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027880">if</span>&nbsp;<span class="ident" id="3027883">rooted</span>&nbsp;<span class="op" id="3027890">||</span>&nbsp;<span class="ident" id="3027893">count</span><span class="op" id="3027898">(</span><span class="ident" id="3027899">name</span><span class="op" id="3027903">,</span>&nbsp;<span class="string" id="3027905">&#39;.&#39;</span><span class="op" id="3027908">)</span>&nbsp;<span class="op" id="3027910">&gt;=</span>&nbsp;<span class="ident" id="3027913">cfg</span><span class="op" id="3027916">.</span><span class="ident" id="3027917">dnsConfig</span><span class="op" id="3027926">.</span><span class="ident" id="3027927">ndots</span>&nbsp;<span class="op" id="3027933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027937">rname</span>&nbsp;<span class="op" id="3027943">:=</span>&nbsp;<span class="ident" id="3027946">name</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027953">if</span>&nbsp;<span class="op" id="3027956">!</span><span class="ident" id="3027957">rooted</span>&nbsp;<span class="op" id="3027964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027969">rname</span>&nbsp;<span class="op" id="3027975">+=</span>&nbsp;<span class="string" id="3027978">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3027988">//&nbsp;Can&nbsp;try&nbsp;as&nbsp;ordinary&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028019">cname</span><span class="op" id="3028024">,</span>&nbsp;<span class="ident" id="3028026">addrs</span><span class="op" id="3028031">,</span>&nbsp;<span class="ident" id="3028033">err</span>&nbsp;<span class="op" id="3028037">=</span>&nbsp;<span class="ident" id="3028039">tryOneName</span><span class="op" id="3028049">(</span><span class="ident" id="3028050">cfg</span><span class="op" id="3028053">.</span><span class="ident" id="3028054">dnsConfig</span><span class="op" id="3028063">,</span>&nbsp;<span class="ident" id="3028065">rname</span><span class="op" id="3028070">,</span>&nbsp;<span class="ident" id="3028072">qtype</span><span class="op" id="3028077">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028081">if</span>&nbsp;<span class="ident" id="3028084">rooted</span>&nbsp;<span class="op" id="3028091">||</span>&nbsp;<span class="ident" id="3028094">err</span>&nbsp;<span class="op" id="3028098">==</span>&nbsp;<span class="ident" id="3028101">nil</span>&nbsp;<span class="op" id="3028105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028110">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3028119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3028122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3028126">//&nbsp;Otherwise,&nbsp;try&nbsp;suffixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028155">for</span>&nbsp;<span class="ident" id="3028159">i</span>&nbsp;<span class="op" id="3028161">:=</span>&nbsp;<span class="num" id="3028164">0</span><span class="op" id="3028165">;</span>&nbsp;<span class="ident" id="3028167">i</span>&nbsp;<span class="op" id="3028169">&lt;</span>&nbsp;<span class="builtinfunc" id="3028171">len</span><span class="op" id="3028174">(</span><span class="ident" id="3028175">cfg</span><span class="op" id="3028178">.</span><span class="ident" id="3028179">dnsConfig</span><span class="op" id="3028188">.</span><span class="ident" id="3028189">search</span><span class="op" id="3028195">)</span><span class="op" id="3028196">;</span>&nbsp;<span class="ident" id="3028198">i</span><span class="op" id="3028199">++</span>&nbsp;<span class="op" id="3028202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028206">rname</span>&nbsp;<span class="op" id="3028212">:=</span>&nbsp;<span class="ident" id="3028215">name</span>&nbsp;<span class="op" id="3028220">+</span>&nbsp;<span class="string" id="3028222">&#34;.&#34;</span>&nbsp;<span class="op" id="3028226">+</span>&nbsp;<span class="ident" id="3028228">cfg</span><span class="op" id="3028231">.</span><span class="ident" id="3028232">dnsConfig</span><span class="op" id="3028241">.</span><span class="ident" id="3028242">search</span><span class="op" id="3028248">[</span><span class="ident" id="3028249">i</span><span class="op" id="3028250">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028254">if</span>&nbsp;<span class="ident" id="3028257">rname</span><span class="op" id="3028262">[</span><span class="builtinfunc" id="3028263">len</span><span class="op" id="3028266">(</span><span class="ident" id="3028267">rname</span><span class="op" id="3028272">)</span><span class="op" id="3028273">-</span><span class="num" id="3028274">1</span><span class="op" id="3028275">]</span>&nbsp;<span class="op" id="3028277">!=</span>&nbsp;<span class="string" id="3028280">&#39;.&#39;</span>&nbsp;<span class="op" id="3028284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028289">rname</span>&nbsp;<span class="op" id="3028295">+=</span>&nbsp;<span class="string" id="3028298">&#34;.&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3028304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028308">cname</span><span class="op" id="3028313">,</span>&nbsp;<span class="ident" id="3028315">addrs</span><span class="op" id="3028320">,</span>&nbsp;<span class="ident" id="3028322">err</span>&nbsp;<span class="op" id="3028326">=</span>&nbsp;<span class="ident" id="3028328">tryOneName</span><span class="op" id="3028338">(</span><span class="ident" id="3028339">cfg</span><span class="op" id="3028342">.</span><span class="ident" id="3028343">dnsConfig</span><span class="op" id="3028352">,</span>&nbsp;<span class="ident" id="3028354">rname</span><span class="op" id="3028359">,</span>&nbsp;<span class="ident" id="3028361">qtype</span><span class="op" id="3028366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028370">if</span>&nbsp;<span class="ident" id="3028373">err</span>&nbsp;<span class="op" id="3028377">==</span>&nbsp;<span class="ident" id="3028380">nil</span>&nbsp;<span class="op" id="3028384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028389">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3028398">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3028401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3028405">//&nbsp;Last&nbsp;ditch&nbsp;effort:&nbsp;try&nbsp;unsuffixed&nbsp;only&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3028471">//&nbsp;that&nbsp;is,&nbsp;name&nbsp;is&nbsp;not&nbsp;rooted&nbsp;and&nbsp;has&nbsp;less&nbsp;than&nbsp;ndots&nbsp;dots.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028533">if</span>&nbsp;<span class="ident" id="3028536">count</span><span class="op" id="3028541">(</span><span class="ident" id="3028542">name</span><span class="op" id="3028546">,</span>&nbsp;<span class="string" id="3028548">&#39;.&#39;</span><span class="op" id="3028551">)</span>&nbsp;<span class="op" id="3028553">&lt;</span>&nbsp;<span class="ident" id="3028555">cfg</span><span class="op" id="3028558">.</span><span class="ident" id="3028559">dnsConfig</span><span class="op" id="3028568">.</span><span class="ident" id="3028569">ndots</span>&nbsp;<span class="op" id="3028575">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028579">cname</span><span class="op" id="3028584">,</span>&nbsp;<span class="ident" id="3028586">addrs</span><span class="op" id="3028591">,</span>&nbsp;<span class="ident" id="3028593">err</span>&nbsp;<span class="op" id="3028597">=</span>&nbsp;<span class="ident" id="3028599">tryOneName</span><span class="op" id="3028609">(</span><span class="ident" id="3028610">cfg</span><span class="op" id="3028613">.</span><span class="ident" id="3028614">dnsConfig</span><span class="op" id="3028623">,</span>&nbsp;<span class="ident" id="3028625">name</span><span class="op" id="3028629">+</span><span class="string" id="3028630">&#34;.&#34;</span><span class="op" id="3028633">,</span>&nbsp;<span class="ident" id="3028635">qtype</span><span class="op" id="3028640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028644">if</span>&nbsp;<span class="ident" id="3028647">err</span>&nbsp;<span class="op" id="3028651">==</span>&nbsp;<span class="ident" id="3028654">nil</span>&nbsp;<span class="op" id="3028658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028663">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3028672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3028675">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028679">if</span>&nbsp;<span class="ident" id="3028682">e</span><span class="op" id="3028683">,</span>&nbsp;<span class="ident" id="3028685">ok</span>&nbsp;<span class="op" id="3028688">:=</span>&nbsp;<span class="ident" id="3028691">err</span><span class="op" id="3028694">.</span><span class="op" id="3028695">(</span><span class="op" id="3028696">*</span><span class="ident" id="3028697">DNSError</span><span class="op" id="3028705">)</span><span class="op" id="3028706">;</span>&nbsp;<span class="ident" id="3028708">ok</span>&nbsp;<span class="op" id="3028711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3028715">//&nbsp;Show&nbsp;original&nbsp;name&nbsp;passed&nbsp;to&nbsp;lookup,&nbsp;not&nbsp;suffixed&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3028775">//&nbsp;In&nbsp;general&nbsp;we&nbsp;might&nbsp;have&nbsp;tried&nbsp;many&nbsp;suffixes;&nbsp;showing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3028834">//&nbsp;just&nbsp;one&nbsp;is&nbsp;misleading.&nbsp;See&nbsp;also&nbsp;golang.org/issue/6324.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028895">e</span><span class="op" id="3028896">.</span><span class="ident" id="3028897">Name</span>&nbsp;<span class="op" id="3028902">=</span>&nbsp;<span class="ident" id="3028904">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3028910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028913">return</span><br>
<span class="lineno"></span><span class="op" id="3028920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="3028923">//&nbsp;goLookupHost&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupHost.</span><br>
<span class="lineno"></span><span class="comment" id="3028986">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3029046">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3029110">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3029171">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">340</span><span class="comment" id="3029234">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3029246">func</span>&nbsp;<span class="ident" id="3029251">goLookupHost</span><span class="op" id="3029263">(</span><span class="ident" id="3029264">name</span>&nbsp;<span class="builtintype" id="3029269">string</span><span class="op" id="3029275">)</span>&nbsp;<span class="op" id="3029277">(</span><span class="ident" id="3029278">addrs</span>&nbsp;<span class="op" id="3029284">[</span><span class="op" id="3029285">]</span><span class="builtintype" id="3029286">string</span><span class="op" id="3029292">,</span>&nbsp;<span class="ident" id="3029294">err</span>&nbsp;<span class="builtintype" id="3029298">error</span><span class="op" id="3029303">)</span>&nbsp;<span class="op" id="3029305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3029308">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;they&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029355">addrs</span>&nbsp;<span class="op" id="3029361">=</span>&nbsp;<span class="ident" id="3029363">lookupStaticHost</span><span class="op" id="3029379">(</span><span class="ident" id="3029380">name</span><span class="op" id="3029384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029387">if</span>&nbsp;<span class="builtinfunc" id="3029390">len</span><span class="op" id="3029393">(</span><span class="ident" id="3029394">addrs</span><span class="op" id="3029399">)</span>&nbsp;<span class="op" id="3029401">&gt;</span>&nbsp;<span class="num" id="3029403">0</span>&nbsp;<span class="op" id="3029405">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029409">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3029417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029420">ips</span><span class="op" id="3029423">,</span>&nbsp;<span class="ident" id="3029425">err</span>&nbsp;<span class="op" id="3029429">:=</span>&nbsp;<span class="ident" id="3029432">goLookupIP</span><span class="op" id="3029442">(</span><span class="ident" id="3029443">name</span><span class="op" id="3029447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029450">if</span>&nbsp;<span class="ident" id="3029453">err</span>&nbsp;<span class="op" id="3029457">!=</span>&nbsp;<span class="ident" id="3029460">nil</span>&nbsp;<span class="op" id="3029464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029468">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3029476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029479">addrs</span>&nbsp;<span class="op" id="3029485">=</span>&nbsp;<span class="builtinfunc" id="3029487">make</span><span class="op" id="3029491">(</span><span class="op" id="3029492">[</span><span class="op" id="3029493">]</span><span class="builtintype" id="3029494">string</span><span class="op" id="3029500">,</span>&nbsp;<span class="num" id="3029502">0</span><span class="op" id="3029503">,</span>&nbsp;<span class="builtinfunc" id="3029505">len</span><span class="op" id="3029508">(</span><span class="ident" id="3029509">ips</span><span class="op" id="3029512">)</span><span class="op" id="3029513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029516">for</span>&nbsp;<span class="ident" id="3029520">_</span><span class="op" id="3029521">,</span>&nbsp;<span class="ident" id="3029523">ip</span>&nbsp;<span class="op" id="3029526">:=</span>&nbsp;<span class="keyword" id="3029529">range</span>&nbsp;<span class="ident" id="3029535">ips</span>&nbsp;<span class="op" id="3029539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029543">addrs</span>&nbsp;<span class="op" id="3029549">=</span>&nbsp;<span class="builtinfunc" id="3029551">append</span><span class="op" id="3029557">(</span><span class="ident" id="3029558">addrs</span><span class="op" id="3029563">,</span>&nbsp;<span class="ident" id="3029565">ip</span><span class="op" id="3029567">.</span><span class="ident" id="3029568">String</span><span class="op" id="3029574">(</span><span class="op" id="3029575">)</span><span class="op" id="3029576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3029579">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029582">return</span><br>
<span class="lineno"></span><span class="op" id="3029589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3029592">//&nbsp;goLookupIP&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupIP.</span><br>
<span class="lineno"></span><span class="comment" id="3029651">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno">360</span><span class="comment" id="3029709">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3029771">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3029832">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3029895">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3029907">func</span>&nbsp;<span class="ident" id="3029912">goLookupIP</span><span class="op" id="3029922">(</span><span class="ident" id="3029923">name</span>&nbsp;<span class="builtintype" id="3029928">string</span><span class="op" id="3029934">)</span>&nbsp;<span class="op" id="3029936">(</span><span class="ident" id="3029937">addrs</span>&nbsp;<span class="op" id="3029943">[</span><span class="op" id="3029944">]</span><span class="ident" id="3029945">IP</span><span class="op" id="3029947">,</span>&nbsp;<span class="ident" id="3029949">err</span>&nbsp;<span class="builtintype" id="3029953">error</span><span class="op" id="3029958">)</span>&nbsp;<span class="op" id="3029960">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3029963">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030008">haddrs</span>&nbsp;<span class="op" id="3030015">:=</span>&nbsp;<span class="ident" id="3030018">lookupStaticHost</span><span class="op" id="3030034">(</span><span class="ident" id="3030035">name</span><span class="op" id="3030039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030042">if</span>&nbsp;<span class="builtinfunc" id="3030045">len</span><span class="op" id="3030048">(</span><span class="ident" id="3030049">haddrs</span><span class="op" id="3030055">)</span>&nbsp;<span class="op" id="3030057">&gt;</span>&nbsp;<span class="num" id="3030059">0</span>&nbsp;<span class="op" id="3030061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030065">for</span>&nbsp;<span class="ident" id="3030069">_</span><span class="op" id="3030070">,</span>&nbsp;<span class="ident" id="3030072">haddr</span>&nbsp;<span class="op" id="3030078">:=</span>&nbsp;<span class="keyword" id="3030081">range</span>&nbsp;<span class="ident" id="3030087">haddrs</span>&nbsp;<span class="op" id="3030094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030099">if</span>&nbsp;<span class="ident" id="3030102">ip</span>&nbsp;<span class="op" id="3030105">:=</span>&nbsp;<span class="ident" id="3030108">ParseIP</span><span class="op" id="3030115">(</span><span class="ident" id="3030116">haddr</span><span class="op" id="3030121">)</span><span class="op" id="3030122">;</span>&nbsp;<span class="ident" id="3030124">ip</span>&nbsp;<span class="op" id="3030127">!=</span>&nbsp;<span class="ident" id="3030130">nil</span>&nbsp;<span class="op" id="3030134">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030140">addrs</span>&nbsp;<span class="op" id="3030146">=</span>&nbsp;<span class="builtinfunc" id="3030148">append</span><span class="op" id="3030154">(</span><span class="ident" id="3030155">addrs</span><span class="op" id="3030160">,</span>&nbsp;<span class="ident" id="3030162">ip</span><span class="op" id="3030164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3030169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3030173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030177">if</span>&nbsp;<span class="builtinfunc" id="3030180">len</span><span class="op" id="3030183">(</span><span class="ident" id="3030184">addrs</span><span class="op" id="3030189">)</span>&nbsp;<span class="op" id="3030191">&gt;</span>&nbsp;<span class="num" id="3030193">0</span>&nbsp;<span class="op" id="3030195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030200">return</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3030209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3030212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030215">type</span>&nbsp;<span class="ident" id="3030220">racer</span>&nbsp;<span class="keyword" id="3030226">struct</span>&nbsp;<span class="op" id="3030233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030237">qtype</span>&nbsp;<span class="builtintype" id="3030243">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030252">rrs</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3030258">[</span><span class="op" id="3030259">]</span><span class="ident" id="3030260">dnsRR</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3030268">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3030275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030278">lane</span>&nbsp;<span class="op" id="3030283">:=</span>&nbsp;<span class="builtinfunc" id="3030286">make</span><span class="op" id="3030290">(</span><span class="keyword" id="3030291">chan</span>&nbsp;<span class="ident" id="3030296">racer</span><span class="op" id="3030301">,</span>&nbsp;<span class="num" id="3030303">1</span><span class="op" id="3030304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030307">qtypes</span>&nbsp;<span class="op" id="3030314">:=</span>&nbsp;<span class="op" id="3030317">[</span><span class="op" id="3030318">...</span><span class="op" id="3030321">]</span><span class="builtintype" id="3030322">uint16</span><span class="op" id="3030328">{</span><span class="ident" id="3030329">dnsTypeA</span><span class="op" id="3030337">,</span>&nbsp;<span class="ident" id="3030339">dnsTypeAAAA</span><span class="op" id="3030350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030353">for</span>&nbsp;<span class="ident" id="3030357">_</span><span class="op" id="3030358">,</span>&nbsp;<span class="ident" id="3030360">qtype</span>&nbsp;<span class="op" id="3030366">:=</span>&nbsp;<span class="keyword" id="3030369">range</span>&nbsp;<span class="ident" id="3030375">qtypes</span>&nbsp;<span class="op" id="3030382">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030386">go</span>&nbsp;<span class="keyword" id="3030389">func</span><span class="op" id="3030393">(</span><span class="ident" id="3030394">qtype</span>&nbsp;<span class="builtintype" id="3030400">uint16</span><span class="op" id="3030406">)</span>&nbsp;<span class="op" id="3030408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030413">_</span><span class="op" id="3030414">,</span>&nbsp;<span class="ident" id="3030416">rrs</span><span class="op" id="3030419">,</span>&nbsp;<span class="ident" id="3030421">err</span>&nbsp;<span class="op" id="3030425">:=</span>&nbsp;<span class="ident" id="3030428">lookup</span><span class="op" id="3030434">(</span><span class="ident" id="3030435">name</span><span class="op" id="3030439">,</span>&nbsp;<span class="ident" id="3030441">qtype</span><span class="op" id="3030446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030451">lane</span>&nbsp;<span class="op" id="3030456">&lt;-</span>&nbsp;<span class="ident" id="3030459">racer</span><span class="op" id="3030464">{</span><span class="ident" id="3030465">qtype</span><span class="op" id="3030470">,</span>&nbsp;<span class="ident" id="3030472">rrs</span><span class="op" id="3030475">,</span>&nbsp;<span class="ident" id="3030477">err</span><span class="op" id="3030480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3030484">}</span><span class="op" id="3030485">(</span><span class="ident" id="3030486">qtype</span><span class="op" id="3030491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3030494">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030497">var</span>&nbsp;<span class="ident" id="3030501">lastErr</span>&nbsp;<span class="builtintype" id="3030509">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030516">for</span>&nbsp;<span class="keyword" id="3030520">range</span>&nbsp;<span class="ident" id="3030526">qtypes</span>&nbsp;<span class="op" id="3030533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030537">racer</span>&nbsp;<span class="op" id="3030543">:=</span>&nbsp;<span class="op" id="3030546">&lt;-</span><span class="ident" id="3030548">lane</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030555">if</span>&nbsp;<span class="ident" id="3030558">racer</span><span class="op" id="3030563">.</span><span class="builtintype" id="3030564">error</span>&nbsp;<span class="op" id="3030570">!=</span>&nbsp;<span class="ident" id="3030573">nil</span>&nbsp;<span class="op" id="3030577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030582">lastErr</span>&nbsp;<span class="op" id="3030590">=</span>&nbsp;<span class="ident" id="3030592">racer</span><span class="op" id="3030597">.</span><span class="builtintype" id="3030598">error</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030607">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3030618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030622">switch</span>&nbsp;<span class="ident" id="3030629">racer</span><span class="op" id="3030634">.</span><span class="ident" id="3030635">qtype</span>&nbsp;<span class="op" id="3030641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030645">case</span>&nbsp;<span class="ident" id="3030650">dnsTypeA</span><span class="op" id="3030658">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030663">addrs</span>&nbsp;<span class="op" id="3030669">=</span>&nbsp;<span class="builtinfunc" id="3030671">append</span><span class="op" id="3030677">(</span><span class="ident" id="3030678">addrs</span><span class="op" id="3030683">,</span>&nbsp;<span class="ident" id="3030685">convertRR_A</span><span class="op" id="3030696">(</span><span class="ident" id="3030697">racer</span><span class="op" id="3030702">.</span><span class="ident" id="3030703">rrs</span><span class="op" id="3030706">)</span><span class="op" id="3030707">...</span><span class="op" id="3030710">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030714">case</span>&nbsp;<span class="ident" id="3030719">dnsTypeAAAA</span><span class="op" id="3030730">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030735">addrs</span>&nbsp;<span class="op" id="3030741">=</span>&nbsp;<span class="builtinfunc" id="3030743">append</span><span class="op" id="3030749">(</span><span class="ident" id="3030750">addrs</span><span class="op" id="3030755">,</span>&nbsp;<span class="ident" id="3030757">convertRR_AAAA</span><span class="op" id="3030771">(</span><span class="ident" id="3030772">racer</span><span class="op" id="3030777">.</span><span class="ident" id="3030778">rrs</span><span class="op" id="3030781">)</span><span class="op" id="3030782">...</span><span class="op" id="3030785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3030789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3030792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030795">if</span>&nbsp;<span class="builtinfunc" id="3030798">len</span><span class="op" id="3030801">(</span><span class="ident" id="3030802">addrs</span><span class="op" id="3030807">)</span>&nbsp;<span class="op" id="3030809">==</span>&nbsp;<span class="num" id="3030812">0</span>&nbsp;<span class="op" id="3030814">&amp;&amp;</span>&nbsp;<span class="ident" id="3030817">lastErr</span>&nbsp;<span class="op" id="3030825">!=</span>&nbsp;<span class="ident" id="3030828">nil</span>&nbsp;<span class="op" id="3030832">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030836">return</span>&nbsp;<span class="ident" id="3030843">nil</span><span class="op" id="3030846">,</span>&nbsp;<span class="ident" id="3030848">lastErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3030857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030860">return</span>&nbsp;<span class="ident" id="3030867">addrs</span><span class="op" id="3030872">,</span>&nbsp;<span class="ident" id="3030874">nil</span><br>
<span class="lineno"></span><span class="op" id="3030878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="3030881">//&nbsp;goLookupCNAME&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupCNAME.</span><br>
<span class="lineno"></span><span class="comment" id="3030946">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3031007">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3031072">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3031133">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">415</span><span class="comment" id="3031196">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3031208">func</span>&nbsp;<span class="ident" id="3031213">goLookupCNAME</span><span class="op" id="3031226">(</span><span class="ident" id="3031227">name</span>&nbsp;<span class="builtintype" id="3031232">string</span><span class="op" id="3031238">)</span>&nbsp;<span class="op" id="3031240">(</span><span class="ident" id="3031241">cname</span>&nbsp;<span class="builtintype" id="3031247">string</span><span class="op" id="3031253">,</span>&nbsp;<span class="ident" id="3031255">err</span>&nbsp;<span class="builtintype" id="3031259">error</span><span class="op" id="3031264">)</span>&nbsp;<span class="op" id="3031266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031269">_</span><span class="op" id="3031270">,</span>&nbsp;<span class="ident" id="3031272">rr</span><span class="op" id="3031274">,</span>&nbsp;<span class="ident" id="3031276">err</span>&nbsp;<span class="op" id="3031280">:=</span>&nbsp;<span class="ident" id="3031283">lookup</span><span class="op" id="3031289">(</span><span class="ident" id="3031290">name</span><span class="op" id="3031294">,</span>&nbsp;<span class="ident" id="3031296">dnsTypeCNAME</span><span class="op" id="3031308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3031311">if</span>&nbsp;<span class="ident" id="3031314">err</span>&nbsp;<span class="op" id="3031318">!=</span>&nbsp;<span class="ident" id="3031321">nil</span>&nbsp;<span class="op" id="3031325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3031329">return</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3031337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031340">cname</span>&nbsp;<span class="op" id="3031346">=</span>&nbsp;<span class="ident" id="3031348">rr</span><span class="op" id="3031350">[</span><span class="num" id="3031351">0</span><span class="op" id="3031352">]</span><span class="op" id="3031353">.</span><span class="op" id="3031354">(</span><span class="op" id="3031355">*</span><span class="ident" id="3031356">dnsRR_CNAME</span><span class="op" id="3031367">)</span><span class="op" id="3031368">.</span><span class="ident" id="3031369">Cname</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3031376">return</span><br>
<span class="lineno"></span><span class="op" id="3031383">}</span>
</div>
</body>
</html>
