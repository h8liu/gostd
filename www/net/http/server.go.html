<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3571864">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3571919">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3571973">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3572024">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3572056">package</span>&nbsp;<span class="ident" id="3572064">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3572070">import</span>&nbsp;<span class="op" id="3572077">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572080">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572089">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572103">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572113">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572120">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572126">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572139">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572146">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572153">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572164">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572170">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572178">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572189">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572200">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572211">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572219">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3572234">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3572241">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3572244">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="3572285">var</span>&nbsp;<span class="op" id="3572289">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3572292">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="3572311">=</span>&nbsp;<span class="ident" id="3572313">errors</span><span class="op" id="3572319">.</span><span class="ident" id="3572320">New</span><span class="op" id="3572323">(</span><span class="string" id="3572324">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="3572355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3572358">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="3572377">=</span>&nbsp;<span class="ident" id="3572379">errors</span><span class="op" id="3572385">.</span><span class="ident" id="3572386">New</span><span class="op" id="3572389">(</span><span class="string" id="3572390">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="3572456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3572459">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3572478">=</span>&nbsp;<span class="ident" id="3572480">errors</span><span class="op" id="3572486">.</span><span class="ident" id="3572487">New</span><span class="op" id="3572490">(</span><span class="string" id="3572491">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="3572515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3572518">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3572537">=</span>&nbsp;<span class="ident" id="3572539">errors</span><span class="op" id="3572545">.</span><span class="ident" id="3572546">New</span><span class="op" id="3572549">(</span><span class="string" id="3572550">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="3572606">)</span><br>
<span class="lineno">35</span><span class="op" id="3572608">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3572611">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3572664">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="3572716">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="3572739">//</span><br>
<span class="lineno"></span><span class="comment" id="3572742">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3572813">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3572881">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3572944">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="3572963">//</span><br>
<span class="lineno"></span><span class="comment" id="3572966">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="3573035">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3573103">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="3573173">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="3573205">//</span><br>
<span class="lineno"></span><span class="keyword" id="3573208">type</span>&nbsp;<span class="ident" id="3573213">Handler</span>&nbsp;<span class="keyword" id="3573221">interface</span>&nbsp;<span class="op" id="3573231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3573234">ServeHTTP</span><span class="op" id="3573243">(</span><span class="ident" id="3573244">ResponseWriter</span><span class="op" id="3573258">,</span>&nbsp;<span class="op" id="3573260">*</span><span class="ident" id="3573261">Request</span><span class="op" id="3573268">)</span><br>
<span class="lineno"></span><span class="op" id="3573270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3573273">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3573333">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3573364">type</span>&nbsp;<span class="ident" id="3573369">ResponseWriter</span>&nbsp;<span class="keyword" id="3573384">interface</span>&nbsp;<span class="op" id="3573394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3573397">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3573465">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3573532">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3573547">Header</span><span class="op" id="3573553">(</span><span class="op" id="3573554">)</span>&nbsp;<span class="ident" id="3573556">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3573565">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3573635">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3573718">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3573781">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3573859">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3573923">Write</span><span class="op" id="3573928">(</span><span class="op" id="3573929">[</span><span class="op" id="3573930">]</span><span class="builtintype" id="3573931">byte</span><span class="op" id="3573935">)</span>&nbsp;<span class="op" id="3573937">(</span><span class="builtintype" id="3573938">int</span><span class="op" id="3573941">,</span>&nbsp;<span class="builtintype" id="3573943">error</span><span class="op" id="3573948">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3573952">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3574016">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3574085">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3574142">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3574200">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3574222">WriteHeader</span><span class="op" id="3574233">(</span><span class="builtintype" id="3574234">int</span><span class="op" id="3574237">)</span><br>
<span class="lineno"></span><span class="op" id="3574239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3574242">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3574312">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="3574369">//</span><br>
<span class="lineno"></span><span class="comment" id="3574372">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="3574430">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3574483">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3574548">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="3574562">type</span>&nbsp;<span class="ident" id="3574567">Flusher</span>&nbsp;<span class="keyword" id="3574575">interface</span>&nbsp;<span class="op" id="3574585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3574588">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3574637">Flush</span><span class="op" id="3574642">(</span><span class="op" id="3574643">)</span><br>
<span class="lineno"></span><span class="op" id="3574645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="3574648">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3574719">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3574767">type</span>&nbsp;<span class="ident" id="3574772">Hijacker</span>&nbsp;<span class="keyword" id="3574781">interface</span>&nbsp;<span class="op" id="3574791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3574794">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3574847">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3574901">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3574952">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3575005">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575035">Hijack</span><span class="op" id="3575041">(</span><span class="op" id="3575042">)</span>&nbsp;<span class="op" id="3575044">(</span><span class="ident" id="3575045">net</span><span class="op" id="3575048">.</span><span class="ident" id="3575049">Conn</span><span class="op" id="3575053">,</span>&nbsp;<span class="op" id="3575055">*</span><span class="ident" id="3575056">bufio</span><span class="op" id="3575061">.</span><span class="ident" id="3575062">ReadWriter</span><span class="op" id="3575072">,</span>&nbsp;<span class="builtintype" id="3575074">error</span><span class="op" id="3575079">)</span><br>
<span class="lineno"></span><span class="op" id="3575081">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="3575084">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3575155">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="3575220">//</span><br>
<span class="lineno"></span><span class="comment" id="3575223">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="3575293">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3575357">type</span>&nbsp;<span class="ident" id="3575362">CloseNotifier</span>&nbsp;<span class="keyword" id="3575376">interface</span>&nbsp;<span class="op" id="3575386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3575389">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3575452">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575498">CloseNotify</span><span class="op" id="3575509">(</span><span class="op" id="3575510">)</span>&nbsp;<span class="op" id="3575512">&lt;-</span><span class="keyword" id="3575514">chan</span>&nbsp;<span class="builtintype" id="3575519">bool</span><br>
<span class="lineno">110</span><span class="op" id="3575524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3575527">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3575587">type</span>&nbsp;<span class="ident" id="3575592">conn</span>&nbsp;<span class="keyword" id="3575597">struct</span>&nbsp;<span class="op" id="3575604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575607">remoteAddr</span>&nbsp;<span class="builtintype" id="3575618">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3575639">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575674">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3575685">*</span><span class="ident" id="3575686">Server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3575706">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575753">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3575764">net</span><span class="op" id="3575767">.</span><span class="ident" id="3575768">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3575785">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575804">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3575815">io</span><span class="op" id="3575817">.</span><span class="ident" id="3575818">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3575836">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575897">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3575908">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3575929">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3575957">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3575968">liveSwitchReader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3575989">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576043">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3576054">*</span><span class="ident" id="3576055">io</span><span class="op" id="3576057">.</span><span class="ident" id="3576058">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3576075">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576098">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3576109">*</span><span class="ident" id="3576110">bufio</span><span class="op" id="3576115">.</span><span class="ident" id="3576116">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3576130">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576193">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3576204">*</span><span class="ident" id="3576205">tls</span><span class="op" id="3576208">.</span><span class="ident" id="3576209">ConnectionState</span>&nbsp;<span class="comment" id="3576225">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576256">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3576269">sync</span><span class="op" id="3576273">.</span><span class="ident" id="3576274">Mutex</span>&nbsp;<span class="comment" id="3576280">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576305">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3576318">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3576329">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576372">closeNotifyc</span>&nbsp;<span class="keyword" id="3576385">chan</span>&nbsp;<span class="builtintype" id="3576390">bool</span>&nbsp;&nbsp;<span class="comment" id="3576396">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576412">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3576425">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3576436">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="3576479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3576482">func</span>&nbsp;<span class="op" id="3576487">(</span><span class="ident" id="3576488">c</span>&nbsp;<span class="op" id="3576490">*</span><span class="ident" id="3576491">conn</span><span class="op" id="3576495">)</span>&nbsp;<span class="ident" id="3576497">hijacked</span><span class="op" id="3576505">(</span><span class="op" id="3576506">)</span>&nbsp;<span class="builtintype" id="3576508">bool</span>&nbsp;<span class="op" id="3576513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576516">c</span><span class="op" id="3576517">.</span><span class="ident" id="3576518">mu</span><span class="op" id="3576520">.</span><span class="ident" id="3576521">Lock</span><span class="op" id="3576525">(</span><span class="op" id="3576526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576529">defer</span>&nbsp;<span class="ident" id="3576535">c</span><span class="op" id="3576536">.</span><span class="ident" id="3576537">mu</span><span class="op" id="3576539">.</span><span class="ident" id="3576540">Unlock</span><span class="op" id="3576546">(</span><span class="op" id="3576547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576550">return</span>&nbsp;<span class="ident" id="3576557">c</span><span class="op" id="3576558">.</span><span class="ident" id="3576559">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="3576569">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="3576572">func</span>&nbsp;<span class="op" id="3576577">(</span><span class="ident" id="3576578">c</span>&nbsp;<span class="op" id="3576580">*</span><span class="ident" id="3576581">conn</span><span class="op" id="3576585">)</span>&nbsp;<span class="ident" id="3576587">hijack</span><span class="op" id="3576593">(</span><span class="op" id="3576594">)</span>&nbsp;<span class="op" id="3576596">(</span><span class="ident" id="3576597">rwc</span>&nbsp;<span class="ident" id="3576601">net</span><span class="op" id="3576604">.</span><span class="ident" id="3576605">Conn</span><span class="op" id="3576609">,</span>&nbsp;<span class="ident" id="3576611">buf</span>&nbsp;<span class="op" id="3576615">*</span><span class="ident" id="3576616">bufio</span><span class="op" id="3576621">.</span><span class="ident" id="3576622">ReadWriter</span><span class="op" id="3576632">,</span>&nbsp;<span class="ident" id="3576634">err</span>&nbsp;<span class="builtintype" id="3576638">error</span><span class="op" id="3576643">)</span>&nbsp;<span class="op" id="3576645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576648">c</span><span class="op" id="3576649">.</span><span class="ident" id="3576650">mu</span><span class="op" id="3576652">.</span><span class="ident" id="3576653">Lock</span><span class="op" id="3576657">(</span><span class="op" id="3576658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576661">defer</span>&nbsp;<span class="ident" id="3576667">c</span><span class="op" id="3576668">.</span><span class="ident" id="3576669">mu</span><span class="op" id="3576671">.</span><span class="ident" id="3576672">Unlock</span><span class="op" id="3576678">(</span><span class="op" id="3576679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576682">if</span>&nbsp;<span class="ident" id="3576685">c</span><span class="op" id="3576686">.</span><span class="ident" id="3576687">hijackedv</span>&nbsp;<span class="op" id="3576697">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576701">return</span>&nbsp;<span class="ident" id="3576708">nil</span><span class="op" id="3576711">,</span>&nbsp;<span class="ident" id="3576713">nil</span><span class="op" id="3576716">,</span>&nbsp;<span class="ident" id="3576718">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3576731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576734">if</span>&nbsp;<span class="ident" id="3576737">c</span><span class="op" id="3576738">.</span><span class="ident" id="3576739">closeNotifyc</span>&nbsp;<span class="op" id="3576752">!=</span>&nbsp;<span class="ident" id="3576755">nil</span>&nbsp;<span class="op" id="3576759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576763">return</span>&nbsp;<span class="ident" id="3576770">nil</span><span class="op" id="3576773">,</span>&nbsp;<span class="ident" id="3576775">nil</span><span class="op" id="3576778">,</span>&nbsp;<span class="ident" id="3576780">errors</span><span class="op" id="3576786">.</span><span class="ident" id="3576787">New</span><span class="op" id="3576790">(</span><span class="string" id="3576791">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="3576847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3576850">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576853">c</span><span class="op" id="3576854">.</span><span class="ident" id="3576855">hijackedv</span>&nbsp;<span class="op" id="3576865">=</span>&nbsp;<span class="ident" id="3576867">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576873">rwc</span>&nbsp;<span class="op" id="3576877">=</span>&nbsp;<span class="ident" id="3576879">c</span><span class="op" id="3576880">.</span><span class="ident" id="3576881">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576886">buf</span>&nbsp;<span class="op" id="3576890">=</span>&nbsp;<span class="ident" id="3576892">c</span><span class="op" id="3576893">.</span><span class="ident" id="3576894">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576899">c</span><span class="op" id="3576900">.</span><span class="ident" id="3576901">rwc</span>&nbsp;<span class="op" id="3576905">=</span>&nbsp;<span class="ident" id="3576907">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576912">c</span><span class="op" id="3576913">.</span><span class="ident" id="3576914">buf</span>&nbsp;<span class="op" id="3576918">=</span>&nbsp;<span class="ident" id="3576920">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3576925">c</span><span class="op" id="3576926">.</span><span class="ident" id="3576927">setState</span><span class="op" id="3576935">(</span><span class="ident" id="3576936">rwc</span><span class="op" id="3576939">,</span>&nbsp;<span class="ident" id="3576941">StateHijacked</span><span class="op" id="3576954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3576957">return</span><br>
<span class="lineno"></span><span class="op" id="3576964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3576967">func</span>&nbsp;<span class="op" id="3576972">(</span><span class="ident" id="3576973">c</span>&nbsp;<span class="op" id="3576975">*</span><span class="ident" id="3576976">conn</span><span class="op" id="3576980">)</span>&nbsp;<span class="ident" id="3576982">closeNotify</span><span class="op" id="3576993">(</span><span class="op" id="3576994">)</span>&nbsp;<span class="op" id="3576996">&lt;-</span><span class="keyword" id="3576998">chan</span>&nbsp;<span class="builtintype" id="3577003">bool</span>&nbsp;<span class="op" id="3577008">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577011">c</span><span class="op" id="3577012">.</span><span class="ident" id="3577013">mu</span><span class="op" id="3577015">.</span><span class="ident" id="3577016">Lock</span><span class="op" id="3577020">(</span><span class="op" id="3577021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577024">defer</span>&nbsp;<span class="ident" id="3577030">c</span><span class="op" id="3577031">.</span><span class="ident" id="3577032">mu</span><span class="op" id="3577034">.</span><span class="ident" id="3577035">Unlock</span><span class="op" id="3577041">(</span><span class="op" id="3577042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577045">if</span>&nbsp;<span class="ident" id="3577048">c</span><span class="op" id="3577049">.</span><span class="ident" id="3577050">closeNotifyc</span>&nbsp;<span class="op" id="3577063">==</span>&nbsp;<span class="ident" id="3577066">nil</span>&nbsp;<span class="op" id="3577070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577074">c</span><span class="op" id="3577075">.</span><span class="ident" id="3577076">closeNotifyc</span>&nbsp;<span class="op" id="3577089">=</span>&nbsp;<span class="builtinfunc" id="3577091">make</span><span class="op" id="3577095">(</span><span class="keyword" id="3577096">chan</span>&nbsp;<span class="builtintype" id="3577101">bool</span><span class="op" id="3577105">,</span>&nbsp;<span class="num" id="3577107">1</span><span class="op" id="3577108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577112">if</span>&nbsp;<span class="ident" id="3577115">c</span><span class="op" id="3577116">.</span><span class="ident" id="3577117">hijackedv</span>&nbsp;<span class="op" id="3577127">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3577132">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3577182">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577217">return</span>&nbsp;<span class="ident" id="3577224">c</span><span class="op" id="3577225">.</span><span class="ident" id="3577226">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3577241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577245">pr</span><span class="op" id="3577247">,</span>&nbsp;<span class="ident" id="3577249">pw</span>&nbsp;<span class="op" id="3577252">:=</span>&nbsp;<span class="ident" id="3577255">io</span><span class="op" id="3577257">.</span><span class="ident" id="3577258">Pipe</span><span class="op" id="3577262">(</span><span class="op" id="3577263">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577268">readSource</span>&nbsp;<span class="op" id="3577279">:=</span>&nbsp;<span class="ident" id="3577282">c</span><span class="op" id="3577283">.</span><span class="ident" id="3577284">sr</span><span class="op" id="3577286">.</span><span class="ident" id="3577287">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577291">c</span><span class="op" id="3577292">.</span><span class="ident" id="3577293">sr</span><span class="op" id="3577295">.</span><span class="ident" id="3577296">Lock</span><span class="op" id="3577300">(</span><span class="op" id="3577301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577305">c</span><span class="op" id="3577306">.</span><span class="ident" id="3577307">sr</span><span class="op" id="3577309">.</span><span class="ident" id="3577310">r</span>&nbsp;<span class="op" id="3577312">=</span>&nbsp;<span class="ident" id="3577314">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577319">c</span><span class="op" id="3577320">.</span><span class="ident" id="3577321">sr</span><span class="op" id="3577323">.</span><span class="ident" id="3577324">Unlock</span><span class="op" id="3577330">(</span><span class="op" id="3577331">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577335">go</span>&nbsp;<span class="keyword" id="3577338">func</span><span class="op" id="3577342">(</span><span class="op" id="3577343">)</span>&nbsp;<span class="op" id="3577345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577350">_</span><span class="op" id="3577351">,</span>&nbsp;<span class="ident" id="3577353">err</span>&nbsp;<span class="op" id="3577357">:=</span>&nbsp;<span class="ident" id="3577360">io</span><span class="op" id="3577362">.</span><span class="ident" id="3577363">Copy</span><span class="op" id="3577367">(</span><span class="ident" id="3577368">pw</span><span class="op" id="3577370">,</span>&nbsp;<span class="ident" id="3577372">readSource</span><span class="op" id="3577382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577387">if</span>&nbsp;<span class="ident" id="3577390">err</span>&nbsp;<span class="op" id="3577394">==</span>&nbsp;<span class="ident" id="3577397">nil</span>&nbsp;<span class="op" id="3577401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577407">err</span>&nbsp;<span class="op" id="3577411">=</span>&nbsp;<span class="ident" id="3577413">io</span><span class="op" id="3577415">.</span><span class="ident" id="3577416">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3577423">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577428">pw</span><span class="op" id="3577430">.</span><span class="ident" id="3577431">CloseWithError</span><span class="op" id="3577445">(</span><span class="ident" id="3577446">err</span><span class="op" id="3577449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577454">c</span><span class="op" id="3577455">.</span><span class="ident" id="3577456">noteClientGone</span><span class="op" id="3577470">(</span><span class="op" id="3577471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3577475">}</span><span class="op" id="3577476">(</span><span class="op" id="3577477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3577480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577483">return</span>&nbsp;<span class="ident" id="3577490">c</span><span class="op" id="3577491">.</span><span class="ident" id="3577492">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="3577505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3577508">func</span>&nbsp;<span class="op" id="3577513">(</span><span class="ident" id="3577514">c</span>&nbsp;<span class="op" id="3577516">*</span><span class="ident" id="3577517">conn</span><span class="op" id="3577521">)</span>&nbsp;<span class="ident" id="3577523">noteClientGone</span><span class="op" id="3577537">(</span><span class="op" id="3577538">)</span>&nbsp;<span class="op" id="3577540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577543">c</span><span class="op" id="3577544">.</span><span class="ident" id="3577545">mu</span><span class="op" id="3577547">.</span><span class="ident" id="3577548">Lock</span><span class="op" id="3577552">(</span><span class="op" id="3577553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577556">defer</span>&nbsp;<span class="ident" id="3577562">c</span><span class="op" id="3577563">.</span><span class="ident" id="3577564">mu</span><span class="op" id="3577566">.</span><span class="ident" id="3577567">Unlock</span><span class="op" id="3577573">(</span><span class="op" id="3577574">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3577577">if</span>&nbsp;<span class="ident" id="3577580">c</span><span class="op" id="3577581">.</span><span class="ident" id="3577582">closeNotifyc</span>&nbsp;<span class="op" id="3577595">!=</span>&nbsp;<span class="ident" id="3577598">nil</span>&nbsp;<span class="op" id="3577602">&amp;&amp;</span>&nbsp;<span class="op" id="3577605">!</span><span class="ident" id="3577606">c</span><span class="op" id="3577607">.</span><span class="ident" id="3577608">clientGone</span>&nbsp;<span class="op" id="3577619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577623">c</span><span class="op" id="3577624">.</span><span class="ident" id="3577625">closeNotifyc</span>&nbsp;<span class="op" id="3577638">&lt;-</span>&nbsp;<span class="ident" id="3577641">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3577647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577650">c</span><span class="op" id="3577651">.</span><span class="ident" id="3577652">clientGone</span>&nbsp;<span class="op" id="3577663">=</span>&nbsp;<span class="ident" id="3577665">true</span><br>
<span class="lineno"></span><span class="op" id="3577670">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3577673">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3577731">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3577783">type</span>&nbsp;<span class="ident" id="3577788">switchReader</span>&nbsp;<span class="keyword" id="3577801">struct</span>&nbsp;<span class="op" id="3577808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577811">io</span><span class="op" id="3577813">.</span><span class="ident" id="3577814">Reader</span><br>
<span class="lineno">195</span><span class="op" id="3577821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3577824">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3577882">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3577935">type</span>&nbsp;<span class="ident" id="3577940">switchWriter</span>&nbsp;<span class="keyword" id="3577953">struct</span>&nbsp;<span class="op" id="3577960">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3577963">io</span><span class="op" id="3577965">.</span><span class="ident" id="3577966">Writer</span><br>
<span class="lineno"></span><span class="op" id="3577973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3577976">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="3578043">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="3578088">type</span>&nbsp;<span class="ident" id="3578093">liveSwitchReader</span>&nbsp;<span class="keyword" id="3578110">struct</span>&nbsp;<span class="op" id="3578117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3578120">sync</span><span class="op" id="3578124">.</span><span class="ident" id="3578125">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3578132">r</span>&nbsp;<span class="ident" id="3578134">io</span><span class="op" id="3578136">.</span><span class="ident" id="3578137">Reader</span><br>
<span class="lineno"></span><span class="op" id="3578144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="3578147">func</span>&nbsp;<span class="op" id="3578152">(</span><span class="ident" id="3578153">sr</span>&nbsp;<span class="op" id="3578156">*</span><span class="ident" id="3578157">liveSwitchReader</span><span class="op" id="3578173">)</span>&nbsp;<span class="ident" id="3578175">Read</span><span class="op" id="3578179">(</span><span class="ident" id="3578180">p</span>&nbsp;<span class="op" id="3578182">[</span><span class="op" id="3578183">]</span><span class="builtintype" id="3578184">byte</span><span class="op" id="3578188">)</span>&nbsp;<span class="op" id="3578190">(</span><span class="ident" id="3578191">n</span>&nbsp;<span class="builtintype" id="3578193">int</span><span class="op" id="3578196">,</span>&nbsp;<span class="ident" id="3578198">err</span>&nbsp;<span class="builtintype" id="3578202">error</span><span class="op" id="3578207">)</span>&nbsp;<span class="op" id="3578209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3578212">sr</span><span class="op" id="3578214">.</span><span class="ident" id="3578215">Lock</span><span class="op" id="3578219">(</span><span class="op" id="3578220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3578223">r</span>&nbsp;<span class="op" id="3578225">:=</span>&nbsp;<span class="ident" id="3578228">sr</span><span class="op" id="3578230">.</span><span class="ident" id="3578231">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3578234">sr</span><span class="op" id="3578236">.</span><span class="ident" id="3578237">Unlock</span><span class="op" id="3578243">(</span><span class="op" id="3578244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3578247">return</span>&nbsp;<span class="ident" id="3578254">r</span><span class="op" id="3578255">.</span><span class="ident" id="3578256">Read</span><span class="op" id="3578260">(</span><span class="ident" id="3578261">p</span><span class="op" id="3578262">)</span><br>
<span class="lineno">215</span><span class="op" id="3578264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3578267">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="3578321">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="3578363">const</span>&nbsp;<span class="ident" id="3578369">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="3578394">=</span>&nbsp;<span class="num" id="3578396">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3578402">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="3578471">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="3578520">//</span><br>
<span class="lineno"></span><span class="comment" id="3578523">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="3578595">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="3578666">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3578738">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="3578812">//</span><br>
<span class="lineno"></span><span class="comment" id="3578815">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="3578885">type</span>&nbsp;<span class="ident" id="3578890">chunkWriter</span>&nbsp;<span class="keyword" id="3578902">struct</span>&nbsp;<span class="op" id="3578909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3578912">res</span>&nbsp;<span class="op" id="3578916">*</span><span class="ident" id="3578917">response</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3578928">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3578990">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3579048">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3579106">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579146">header</span>&nbsp;<span class="ident" id="3579153">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3579162">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3579226">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3579276">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3579337">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579360">wroteHeader</span>&nbsp;<span class="builtintype" id="3579372">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3579379">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579414">chunking</span>&nbsp;<span class="builtintype" id="3579423">bool</span>&nbsp;<span class="comment" id="3579428">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="3579478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3579481">var</span>&nbsp;<span class="op" id="3579485">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579488">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3579499">=</span>&nbsp;<span class="op" id="3579501">[</span><span class="op" id="3579502">]</span><span class="builtintype" id="3579503">byte</span><span class="op" id="3579507">(</span><span class="string" id="3579508">&#34;\r\n&#34;</span><span class="op" id="3579514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579517">colonSpace</span>&nbsp;<span class="op" id="3579528">=</span>&nbsp;<span class="op" id="3579530">[</span><span class="op" id="3579531">]</span><span class="builtintype" id="3579532">byte</span><span class="op" id="3579536">(</span><span class="string" id="3579537">&#34;:&nbsp;&#34;</span><span class="op" id="3579541">)</span><br>
<span class="lineno"></span><span class="op" id="3579543">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3579546">func</span>&nbsp;<span class="op" id="3579551">(</span><span class="ident" id="3579552">cw</span>&nbsp;<span class="op" id="3579555">*</span><span class="ident" id="3579556">chunkWriter</span><span class="op" id="3579567">)</span>&nbsp;<span class="ident" id="3579569">Write</span><span class="op" id="3579574">(</span><span class="ident" id="3579575">p</span>&nbsp;<span class="op" id="3579577">[</span><span class="op" id="3579578">]</span><span class="builtintype" id="3579579">byte</span><span class="op" id="3579583">)</span>&nbsp;<span class="op" id="3579585">(</span><span class="ident" id="3579586">n</span>&nbsp;<span class="builtintype" id="3579588">int</span><span class="op" id="3579591">,</span>&nbsp;<span class="ident" id="3579593">err</span>&nbsp;<span class="builtintype" id="3579597">error</span><span class="op" id="3579602">)</span>&nbsp;<span class="op" id="3579604">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579607">if</span>&nbsp;<span class="op" id="3579610">!</span><span class="ident" id="3579611">cw</span><span class="op" id="3579613">.</span><span class="ident" id="3579614">wroteHeader</span>&nbsp;<span class="op" id="3579626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579630">cw</span><span class="op" id="3579632">.</span><span class="ident" id="3579633">writeHeader</span><span class="op" id="3579644">(</span><span class="ident" id="3579645">p</span><span class="op" id="3579646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3579649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579652">if</span>&nbsp;<span class="ident" id="3579655">cw</span><span class="op" id="3579657">.</span><span class="ident" id="3579658">res</span><span class="op" id="3579661">.</span><span class="ident" id="3579662">req</span><span class="op" id="3579665">.</span><span class="ident" id="3579666">Method</span>&nbsp;<span class="op" id="3579673">==</span>&nbsp;<span class="string" id="3579676">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3579683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3579687">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579704">return</span>&nbsp;<span class="builtinfunc" id="3579711">len</span><span class="op" id="3579714">(</span><span class="ident" id="3579715">p</span><span class="op" id="3579716">)</span><span class="op" id="3579717">,</span>&nbsp;<span class="ident" id="3579719">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3579724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579727">if</span>&nbsp;<span class="ident" id="3579730">cw</span><span class="op" id="3579732">.</span><span class="ident" id="3579733">chunking</span>&nbsp;<span class="op" id="3579742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579746">_</span><span class="op" id="3579747">,</span>&nbsp;<span class="ident" id="3579749">err</span>&nbsp;<span class="op" id="3579753">=</span>&nbsp;<span class="ident" id="3579755">fmt</span><span class="op" id="3579758">.</span><span class="ident" id="3579759">Fprintf</span><span class="op" id="3579766">(</span><span class="ident" id="3579767">cw</span><span class="op" id="3579769">.</span><span class="ident" id="3579770">res</span><span class="op" id="3579773">.</span><span class="ident" id="3579774">conn</span><span class="op" id="3579778">.</span><span class="ident" id="3579779">buf</span><span class="op" id="3579782">,</span>&nbsp;<span class="string" id="3579784">&#34;%x\r\n&#34;</span><span class="op" id="3579792">,</span>&nbsp;<span class="builtinfunc" id="3579794">len</span><span class="op" id="3579797">(</span><span class="ident" id="3579798">p</span><span class="op" id="3579799">)</span><span class="op" id="3579800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579804">if</span>&nbsp;<span class="ident" id="3579807">err</span>&nbsp;<span class="op" id="3579811">!=</span>&nbsp;<span class="ident" id="3579814">nil</span>&nbsp;<span class="op" id="3579818">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579823">cw</span><span class="op" id="3579825">.</span><span class="ident" id="3579826">res</span><span class="op" id="3579829">.</span><span class="ident" id="3579830">conn</span><span class="op" id="3579834">.</span><span class="ident" id="3579835">rwc</span><span class="op" id="3579838">.</span><span class="ident" id="3579839">Close</span><span class="op" id="3579844">(</span><span class="op" id="3579845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579850">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3579859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3579862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579865">n</span><span class="op" id="3579866">,</span>&nbsp;<span class="ident" id="3579868">err</span>&nbsp;<span class="op" id="3579872">=</span>&nbsp;<span class="ident" id="3579874">cw</span><span class="op" id="3579876">.</span><span class="ident" id="3579877">res</span><span class="op" id="3579880">.</span><span class="ident" id="3579881">conn</span><span class="op" id="3579885">.</span><span class="ident" id="3579886">buf</span><span class="op" id="3579889">.</span><span class="ident" id="3579890">Write</span><span class="op" id="3579895">(</span><span class="ident" id="3579896">p</span><span class="op" id="3579897">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579900">if</span>&nbsp;<span class="ident" id="3579903">cw</span><span class="op" id="3579905">.</span><span class="ident" id="3579906">chunking</span>&nbsp;<span class="op" id="3579915">&amp;&amp;</span>&nbsp;<span class="ident" id="3579918">err</span>&nbsp;<span class="op" id="3579922">==</span>&nbsp;<span class="ident" id="3579925">nil</span>&nbsp;<span class="op" id="3579929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579933">_</span><span class="op" id="3579934">,</span>&nbsp;<span class="ident" id="3579936">err</span>&nbsp;<span class="op" id="3579940">=</span>&nbsp;<span class="ident" id="3579942">cw</span><span class="op" id="3579944">.</span><span class="ident" id="3579945">res</span><span class="op" id="3579948">.</span><span class="ident" id="3579949">conn</span><span class="op" id="3579953">.</span><span class="ident" id="3579954">buf</span><span class="op" id="3579957">.</span><span class="ident" id="3579958">Write</span><span class="op" id="3579963">(</span><span class="ident" id="3579964">crlf</span><span class="op" id="3579968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3579971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3579974">if</span>&nbsp;<span class="ident" id="3579977">err</span>&nbsp;<span class="op" id="3579981">!=</span>&nbsp;<span class="ident" id="3579984">nil</span>&nbsp;<span class="op" id="3579988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3579992">cw</span><span class="op" id="3579994">.</span><span class="ident" id="3579995">res</span><span class="op" id="3579998">.</span><span class="ident" id="3579999">conn</span><span class="op" id="3580003">.</span><span class="ident" id="3580004">rwc</span><span class="op" id="3580007">.</span><span class="ident" id="3580008">Close</span><span class="op" id="3580013">(</span><span class="op" id="3580014">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3580017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580020">return</span><br>
<span class="lineno"></span><span class="op" id="3580027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3580030">func</span>&nbsp;<span class="op" id="3580035">(</span><span class="ident" id="3580036">cw</span>&nbsp;<span class="op" id="3580039">*</span><span class="ident" id="3580040">chunkWriter</span><span class="op" id="3580051">)</span>&nbsp;<span class="ident" id="3580053">flush</span><span class="op" id="3580058">(</span><span class="op" id="3580059">)</span>&nbsp;<span class="op" id="3580061">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580064">if</span>&nbsp;<span class="op" id="3580067">!</span><span class="ident" id="3580068">cw</span><span class="op" id="3580070">.</span><span class="ident" id="3580071">wroteHeader</span>&nbsp;<span class="op" id="3580083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580087">cw</span><span class="op" id="3580089">.</span><span class="ident" id="3580090">writeHeader</span><span class="op" id="3580101">(</span><span class="ident" id="3580102">nil</span><span class="op" id="3580105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3580108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580111">cw</span><span class="op" id="3580113">.</span><span class="ident" id="3580114">res</span><span class="op" id="3580117">.</span><span class="ident" id="3580118">conn</span><span class="op" id="3580122">.</span><span class="ident" id="3580123">buf</span><span class="op" id="3580126">.</span><span class="ident" id="3580127">Flush</span><span class="op" id="3580132">(</span><span class="op" id="3580133">)</span><br>
<span class="lineno"></span><span class="op" id="3580135">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="3580138">func</span>&nbsp;<span class="op" id="3580143">(</span><span class="ident" id="3580144">cw</span>&nbsp;<span class="op" id="3580147">*</span><span class="ident" id="3580148">chunkWriter</span><span class="op" id="3580159">)</span>&nbsp;<span class="builtinfunc" id="3580161">close</span><span class="op" id="3580166">(</span><span class="op" id="3580167">)</span>&nbsp;<span class="op" id="3580169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580172">if</span>&nbsp;<span class="op" id="3580175">!</span><span class="ident" id="3580176">cw</span><span class="op" id="3580178">.</span><span class="ident" id="3580179">wroteHeader</span>&nbsp;<span class="op" id="3580191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580195">cw</span><span class="op" id="3580197">.</span><span class="ident" id="3580198">writeHeader</span><span class="op" id="3580209">(</span><span class="ident" id="3580210">nil</span><span class="op" id="3580213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3580216">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3580219">if</span>&nbsp;<span class="ident" id="3580222">cw</span><span class="op" id="3580224">.</span><span class="ident" id="3580225">chunking</span>&nbsp;<span class="op" id="3580234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3580238">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3580294">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3580348">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580359">cw</span><span class="op" id="3580361">.</span><span class="ident" id="3580362">res</span><span class="op" id="3580365">.</span><span class="ident" id="3580366">conn</span><span class="op" id="3580370">.</span><span class="ident" id="3580371">buf</span><span class="op" id="3580374">.</span><span class="ident" id="3580375">WriteString</span><span class="op" id="3580386">(</span><span class="string" id="3580387">&#34;0\r\n\r\n&#34;</span><span class="op" id="3580398">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3580401">}</span><br>
<span class="lineno"></span><span class="op" id="3580403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3580406">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3580468">type</span>&nbsp;<span class="ident" id="3580473">response</span>&nbsp;<span class="keyword" id="3580482">struct</span>&nbsp;<span class="op" id="3580489">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580492">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580506">*</span><span class="ident" id="3580507">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580513">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3580527">*</span><span class="ident" id="3580528">Request</span>&nbsp;<span class="comment" id="3580536">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580566">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3580580">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3580589">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580635">wroteContinue</span>&nbsp;<span class="builtintype" id="3580649">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3580658">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580697">w</span>&nbsp;&nbsp;<span class="op" id="3580700">*</span><span class="ident" id="3580701">bufio</span><span class="op" id="3580706">.</span><span class="ident" id="3580707">Writer</span>&nbsp;<span class="comment" id="3580714">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580758">cw</span>&nbsp;<span class="ident" id="3580761">chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3580774">sw</span>&nbsp;<span class="op" id="3580777">*</span><span class="ident" id="3580778">switchWriter</span>&nbsp;<span class="comment" id="3580791">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3580846">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3580907">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3580969">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581027">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581071">handlerHeader</span>&nbsp;<span class="ident" id="3581085">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581093">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="3581107">bool</span>&nbsp;<span class="comment" id="3581112">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581159">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3581173">int64</span>&nbsp;<span class="comment" id="3581179">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581215">contentLength</span>&nbsp;<span class="ident" id="3581229">int64</span>&nbsp;<span class="comment" id="3581235">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581281">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3581295">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3581301">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581340">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581399">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581452">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581503">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581523">closeAfterReply</span>&nbsp;<span class="builtintype" id="3581539">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581546">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581601">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581656">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581707">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581769">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581825">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581885">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581904">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="3581924">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3581931">handlerDone</span>&nbsp;<span class="builtintype" id="3581943">bool</span>&nbsp;<span class="comment" id="3581948">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3581985">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3582025">dateBuf</span>&nbsp;<span class="op" id="3582033">[</span><span class="builtinfunc" id="3582034">len</span><span class="op" id="3582037">(</span><span class="ident" id="3582038">TimeFormat</span><span class="op" id="3582048">)</span><span class="op" id="3582049">]</span><span class="builtintype" id="3582050">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3582056">clenBuf</span>&nbsp;<span class="op" id="3582064">[</span><span class="num" id="3582065">10</span><span class="op" id="3582067">]</span><span class="builtintype" id="3582068">byte</span><br>
<span class="lineno">340</span><span class="op" id="3582073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3582076">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="3582147">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3582177">func</span>&nbsp;<span class="op" id="3582182">(</span><span class="ident" id="3582183">w</span>&nbsp;<span class="op" id="3582185">*</span><span class="ident" id="3582186">response</span><span class="op" id="3582194">)</span>&nbsp;<span class="ident" id="3582196">requestTooLarge</span><span class="op" id="3582211">(</span><span class="op" id="3582212">)</span>&nbsp;<span class="op" id="3582214">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3582217">w</span><span class="op" id="3582218">.</span><span class="ident" id="3582219">closeAfterReply</span>&nbsp;<span class="op" id="3582235">=</span>&nbsp;<span class="ident" id="3582237">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3582243">w</span><span class="op" id="3582244">.</span><span class="ident" id="3582245">requestBodyLimitHit</span>&nbsp;<span class="op" id="3582265">=</span>&nbsp;<span class="ident" id="3582267">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582273">if</span>&nbsp;<span class="op" id="3582276">!</span><span class="ident" id="3582277">w</span><span class="op" id="3582278">.</span><span class="ident" id="3582279">wroteHeader</span>&nbsp;<span class="op" id="3582291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3582295">w</span><span class="op" id="3582296">.</span><span class="ident" id="3582297">Header</span><span class="op" id="3582303">(</span><span class="op" id="3582304">)</span><span class="op" id="3582305">.</span><span class="ident" id="3582306">Set</span><span class="op" id="3582309">(</span><span class="string" id="3582310">&#34;Connection&#34;</span><span class="op" id="3582322">,</span>&nbsp;<span class="string" id="3582324">&#34;close&#34;</span><span class="op" id="3582331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3582334">}</span><br>
<span class="lineno">350</span><span class="op" id="3582336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3582339">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="3582411">func</span>&nbsp;<span class="op" id="3582416">(</span><span class="ident" id="3582417">w</span>&nbsp;<span class="op" id="3582419">*</span><span class="ident" id="3582420">response</span><span class="op" id="3582428">)</span>&nbsp;<span class="ident" id="3582430">needsSniff</span><span class="op" id="3582440">(</span><span class="op" id="3582441">)</span>&nbsp;<span class="builtintype" id="3582443">bool</span>&nbsp;<span class="op" id="3582448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3582451">_</span><span class="op" id="3582452">,</span>&nbsp;<span class="ident" id="3582454">haveType</span>&nbsp;<span class="op" id="3582463">:=</span>&nbsp;<span class="ident" id="3582466">w</span><span class="op" id="3582467">.</span><span class="ident" id="3582468">handlerHeader</span><span class="op" id="3582481">[</span><span class="string" id="3582482">&#34;Content-Type&#34;</span><span class="op" id="3582496">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582499">return</span>&nbsp;<span class="op" id="3582506">!</span><span class="ident" id="3582507">w</span><span class="op" id="3582508">.</span><span class="ident" id="3582509">cw</span><span class="op" id="3582511">.</span><span class="ident" id="3582512">wroteHeader</span>&nbsp;<span class="op" id="3582524">&amp;&amp;</span>&nbsp;<span class="op" id="3582527">!</span><span class="ident" id="3582528">haveType</span>&nbsp;<span class="op" id="3582537">&amp;&amp;</span>&nbsp;<span class="ident" id="3582540">w</span><span class="op" id="3582541">.</span><span class="ident" id="3582542">written</span>&nbsp;<span class="op" id="3582550">&lt;</span>&nbsp;<span class="ident" id="3582552">sniffLen</span><br>
<span class="lineno"></span><span class="op" id="3582561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3582564">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="3582630">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="3582647">type</span>&nbsp;<span class="ident" id="3582652">writerOnly</span>&nbsp;<span class="keyword" id="3582663">struct</span>&nbsp;<span class="op" id="3582670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3582673">io</span><span class="op" id="3582675">.</span><span class="ident" id="3582676">Writer</span><br>
<span class="lineno"></span><span class="op" id="3582683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3582686">func</span>&nbsp;<span class="ident" id="3582691">srcIsRegularFile</span><span class="op" id="3582707">(</span><span class="ident" id="3582708">src</span>&nbsp;<span class="ident" id="3582712">io</span><span class="op" id="3582714">.</span><span class="ident" id="3582715">Reader</span><span class="op" id="3582721">)</span>&nbsp;<span class="op" id="3582723">(</span><span class="ident" id="3582724">isRegular</span>&nbsp;<span class="builtintype" id="3582734">bool</span><span class="op" id="3582738">,</span>&nbsp;<span class="ident" id="3582740">err</span>&nbsp;<span class="builtintype" id="3582744">error</span><span class="op" id="3582749">)</span>&nbsp;<span class="op" id="3582751">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582754">switch</span>&nbsp;<span class="ident" id="3582761">v</span>&nbsp;<span class="op" id="3582763">:=</span>&nbsp;<span class="ident" id="3582766">src</span><span class="op" id="3582769">.</span><span class="op" id="3582770">(</span><span class="keyword" id="3582771">type</span><span class="op" id="3582775">)</span>&nbsp;<span class="op" id="3582777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582780">case</span>&nbsp;<span class="op" id="3582785">*</span><span class="ident" id="3582786">os</span><span class="op" id="3582788">.</span><span class="ident" id="3582789">File</span><span class="op" id="3582793">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3582797">fi</span><span class="op" id="3582799">,</span>&nbsp;<span class="ident" id="3582801">err</span>&nbsp;<span class="op" id="3582805">:=</span>&nbsp;<span class="ident" id="3582808">v</span><span class="op" id="3582809">.</span><span class="ident" id="3582810">Stat</span><span class="op" id="3582814">(</span><span class="op" id="3582815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582819">if</span>&nbsp;<span class="ident" id="3582822">err</span>&nbsp;<span class="op" id="3582826">!=</span>&nbsp;<span class="ident" id="3582829">nil</span>&nbsp;<span class="op" id="3582833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582838">return</span>&nbsp;<span class="ident" id="3582845">false</span><span class="op" id="3582850">,</span>&nbsp;<span class="ident" id="3582852">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3582858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582862">return</span>&nbsp;<span class="ident" id="3582869">fi</span><span class="op" id="3582871">.</span><span class="ident" id="3582872">Mode</span><span class="op" id="3582876">(</span><span class="op" id="3582877">)</span><span class="op" id="3582878">.</span><span class="ident" id="3582879">IsRegular</span><span class="op" id="3582888">(</span><span class="op" id="3582889">)</span><span class="op" id="3582890">,</span>&nbsp;<span class="ident" id="3582892">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582897">case</span>&nbsp;<span class="op" id="3582902">*</span><span class="ident" id="3582903">io</span><span class="op" id="3582905">.</span><span class="ident" id="3582906">LimitedReader</span><span class="op" id="3582919">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582923">return</span>&nbsp;<span class="ident" id="3582930">srcIsRegularFile</span><span class="op" id="3582946">(</span><span class="ident" id="3582947">v</span><span class="op" id="3582948">.</span><span class="ident" id="3582949">R</span><span class="op" id="3582950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582953">default</span><span class="op" id="3582960">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3582964">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3582972">}</span><br>
<span class="lineno"></span><span class="op" id="3582974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3582977">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="3583047">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="3583083">func</span>&nbsp;<span class="op" id="3583088">(</span><span class="ident" id="3583089">w</span>&nbsp;<span class="op" id="3583091">*</span><span class="ident" id="3583092">response</span><span class="op" id="3583100">)</span>&nbsp;<span class="ident" id="3583102">ReadFrom</span><span class="op" id="3583110">(</span><span class="ident" id="3583111">src</span>&nbsp;<span class="ident" id="3583115">io</span><span class="op" id="3583117">.</span><span class="ident" id="3583118">Reader</span><span class="op" id="3583124">)</span>&nbsp;<span class="op" id="3583126">(</span><span class="ident" id="3583127">n</span>&nbsp;<span class="ident" id="3583129">int64</span><span class="op" id="3583134">,</span>&nbsp;<span class="ident" id="3583136">err</span>&nbsp;<span class="builtintype" id="3583140">error</span><span class="op" id="3583145">)</span>&nbsp;<span class="op" id="3583147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3583150">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3583212">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3583276">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583328">rf</span><span class="op" id="3583330">,</span>&nbsp;<span class="ident" id="3583332">ok</span>&nbsp;<span class="op" id="3583335">:=</span>&nbsp;<span class="ident" id="3583338">w</span><span class="op" id="3583339">.</span><span class="ident" id="3583340">conn</span><span class="op" id="3583344">.</span><span class="ident" id="3583345">rwc</span><span class="op" id="3583348">.</span><span class="op" id="3583349">(</span><span class="ident" id="3583350">io</span><span class="op" id="3583352">.</span><span class="ident" id="3583353">ReaderFrom</span><span class="op" id="3583363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583366">regFile</span><span class="op" id="3583373">,</span>&nbsp;<span class="ident" id="3583375">err</span>&nbsp;<span class="op" id="3583379">:=</span>&nbsp;<span class="ident" id="3583382">srcIsRegularFile</span><span class="op" id="3583398">(</span><span class="ident" id="3583399">src</span><span class="op" id="3583402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583405">if</span>&nbsp;<span class="ident" id="3583408">err</span>&nbsp;<span class="op" id="3583412">!=</span>&nbsp;<span class="ident" id="3583415">nil</span>&nbsp;<span class="op" id="3583419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583423">return</span>&nbsp;<span class="num" id="3583430">0</span><span class="op" id="3583431">,</span>&nbsp;<span class="ident" id="3583433">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3583438">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583441">if</span>&nbsp;<span class="op" id="3583444">!</span><span class="ident" id="3583445">ok</span>&nbsp;<span class="op" id="3583448">||</span>&nbsp;<span class="op" id="3583451">!</span><span class="ident" id="3583452">regFile</span>&nbsp;<span class="op" id="3583460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583464">return</span>&nbsp;<span class="ident" id="3583471">io</span><span class="op" id="3583473">.</span><span class="ident" id="3583474">Copy</span><span class="op" id="3583478">(</span><span class="ident" id="3583479">writerOnly</span><span class="op" id="3583489">{</span><span class="ident" id="3583490">w</span><span class="op" id="3583491">}</span><span class="op" id="3583492">,</span>&nbsp;<span class="ident" id="3583494">src</span><span class="op" id="3583497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3583500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3583504">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583524">if</span>&nbsp;<span class="op" id="3583527">!</span><span class="ident" id="3583528">w</span><span class="op" id="3583529">.</span><span class="ident" id="3583530">wroteHeader</span>&nbsp;<span class="op" id="3583542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583546">w</span><span class="op" id="3583547">.</span><span class="ident" id="3583548">WriteHeader</span><span class="op" id="3583559">(</span><span class="ident" id="3583560">StatusOK</span><span class="op" id="3583568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3583571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583575">if</span>&nbsp;<span class="ident" id="3583578">w</span><span class="op" id="3583579">.</span><span class="ident" id="3583580">needsSniff</span><span class="op" id="3583590">(</span><span class="op" id="3583591">)</span>&nbsp;<span class="op" id="3583593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583597">n0</span><span class="op" id="3583599">,</span>&nbsp;<span class="ident" id="3583601">err</span>&nbsp;<span class="op" id="3583605">:=</span>&nbsp;<span class="ident" id="3583608">io</span><span class="op" id="3583610">.</span><span class="ident" id="3583611">Copy</span><span class="op" id="3583615">(</span><span class="ident" id="3583616">writerOnly</span><span class="op" id="3583626">{</span><span class="ident" id="3583627">w</span><span class="op" id="3583628">}</span><span class="op" id="3583629">,</span>&nbsp;<span class="ident" id="3583631">io</span><span class="op" id="3583633">.</span><span class="ident" id="3583634">LimitReader</span><span class="op" id="3583645">(</span><span class="ident" id="3583646">src</span><span class="op" id="3583649">,</span>&nbsp;<span class="ident" id="3583651">sniffLen</span><span class="op" id="3583659">)</span><span class="op" id="3583660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583664">n</span>&nbsp;<span class="op" id="3583666">+=</span>&nbsp;<span class="ident" id="3583669">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583674">if</span>&nbsp;<span class="ident" id="3583677">err</span>&nbsp;<span class="op" id="3583681">!=</span>&nbsp;<span class="ident" id="3583684">nil</span>&nbsp;<span class="op" id="3583688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583693">return</span>&nbsp;<span class="ident" id="3583700">n</span><span class="op" id="3583701">,</span>&nbsp;<span class="ident" id="3583703">err</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3583709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3583712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583716">w</span><span class="op" id="3583717">.</span><span class="ident" id="3583718">w</span><span class="op" id="3583719">.</span><span class="ident" id="3583720">Flush</span><span class="op" id="3583725">(</span><span class="op" id="3583726">)</span>&nbsp;&nbsp;<span class="comment" id="3583729">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583764">w</span><span class="op" id="3583765">.</span><span class="ident" id="3583766">cw</span><span class="op" id="3583768">.</span><span class="ident" id="3583769">flush</span><span class="op" id="3583774">(</span><span class="op" id="3583775">)</span>&nbsp;<span class="comment" id="3583777">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3583829">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3583909">if</span>&nbsp;<span class="op" id="3583912">!</span><span class="ident" id="3583913">w</span><span class="op" id="3583914">.</span><span class="ident" id="3583915">cw</span><span class="op" id="3583917">.</span><span class="ident" id="3583918">chunking</span>&nbsp;<span class="op" id="3583927">&amp;&amp;</span>&nbsp;<span class="ident" id="3583930">w</span><span class="op" id="3583931">.</span><span class="ident" id="3583932">bodyAllowed</span><span class="op" id="3583943">(</span><span class="op" id="3583944">)</span>&nbsp;<span class="op" id="3583946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583950">n0</span><span class="op" id="3583952">,</span>&nbsp;<span class="ident" id="3583954">err</span>&nbsp;<span class="op" id="3583958">:=</span>&nbsp;<span class="ident" id="3583961">rf</span><span class="op" id="3583963">.</span><span class="ident" id="3583964">ReadFrom</span><span class="op" id="3583972">(</span><span class="ident" id="3583973">src</span><span class="op" id="3583976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583980">n</span>&nbsp;<span class="op" id="3583982">+=</span>&nbsp;<span class="ident" id="3583985">n0</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3583990">w</span><span class="op" id="3583991">.</span><span class="ident" id="3583992">written</span>&nbsp;<span class="op" id="3584000">+=</span>&nbsp;<span class="ident" id="3584003">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584008">return</span>&nbsp;<span class="ident" id="3584015">n</span><span class="op" id="3584016">,</span>&nbsp;<span class="ident" id="3584018">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3584023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584027">n0</span><span class="op" id="3584029">,</span>&nbsp;<span class="ident" id="3584031">err</span>&nbsp;<span class="op" id="3584035">:=</span>&nbsp;<span class="ident" id="3584038">io</span><span class="op" id="3584040">.</span><span class="ident" id="3584041">Copy</span><span class="op" id="3584045">(</span><span class="ident" id="3584046">writerOnly</span><span class="op" id="3584056">{</span><span class="ident" id="3584057">w</span><span class="op" id="3584058">}</span><span class="op" id="3584059">,</span>&nbsp;<span class="ident" id="3584061">src</span><span class="op" id="3584064">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584067">n</span>&nbsp;<span class="op" id="3584069">+=</span>&nbsp;<span class="ident" id="3584072">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584076">return</span>&nbsp;<span class="ident" id="3584083">n</span><span class="op" id="3584084">,</span>&nbsp;<span class="ident" id="3584086">err</span><br>
<span class="lineno"></span><span class="op" id="3584090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3584093">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="3584162">const</span>&nbsp;<span class="ident" id="3584168">noLimit</span>&nbsp;<span class="ident" id="3584176">int64</span>&nbsp;<span class="op" id="3584182">=</span>&nbsp;<span class="op" id="3584184">(</span><span class="num" id="3584185">1</span>&nbsp;<span class="op" id="3584187">&lt;&lt;</span>&nbsp;<span class="num" id="3584190">63</span><span class="op" id="3584192">)</span>&nbsp;<span class="op" id="3584194">-</span>&nbsp;<span class="num" id="3584196">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3584199">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="3584277">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="3584312">const</span>&nbsp;<span class="ident" id="3584318">debugServerConnections</span>&nbsp;<span class="op" id="3584341">=</span>&nbsp;<span class="ident" id="3584343">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="3584350">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="3584385">func</span>&nbsp;<span class="op" id="3584390">(</span><span class="ident" id="3584391">srv</span>&nbsp;<span class="op" id="3584395">*</span><span class="ident" id="3584396">Server</span><span class="op" id="3584402">)</span>&nbsp;<span class="ident" id="3584404">newConn</span><span class="op" id="3584411">(</span><span class="ident" id="3584412">rwc</span>&nbsp;<span class="ident" id="3584416">net</span><span class="op" id="3584419">.</span><span class="ident" id="3584420">Conn</span><span class="op" id="3584424">)</span>&nbsp;<span class="op" id="3584426">(</span><span class="ident" id="3584427">c</span>&nbsp;<span class="op" id="3584429">*</span><span class="ident" id="3584430">conn</span><span class="op" id="3584434">,</span>&nbsp;<span class="ident" id="3584436">err</span>&nbsp;<span class="builtintype" id="3584440">error</span><span class="op" id="3584445">)</span>&nbsp;<span class="op" id="3584447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584450">c</span>&nbsp;<span class="op" id="3584452">=</span>&nbsp;<span class="builtinfunc" id="3584454">new</span><span class="op" id="3584457">(</span><span class="ident" id="3584458">conn</span><span class="op" id="3584462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584465">c</span><span class="op" id="3584466">.</span><span class="ident" id="3584467">remoteAddr</span>&nbsp;<span class="op" id="3584478">=</span>&nbsp;<span class="ident" id="3584480">rwc</span><span class="op" id="3584483">.</span><span class="ident" id="3584484">RemoteAddr</span><span class="op" id="3584494">(</span><span class="op" id="3584495">)</span><span class="op" id="3584496">.</span><span class="ident" id="3584497">String</span><span class="op" id="3584503">(</span><span class="op" id="3584504">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584507">c</span><span class="op" id="3584508">.</span><span class="ident" id="3584509">server</span>&nbsp;<span class="op" id="3584516">=</span>&nbsp;<span class="ident" id="3584518">srv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584523">c</span><span class="op" id="3584524">.</span><span class="ident" id="3584525">rwc</span>&nbsp;<span class="op" id="3584529">=</span>&nbsp;<span class="ident" id="3584531">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584536">c</span><span class="op" id="3584537">.</span><span class="ident" id="3584538">w</span>&nbsp;<span class="op" id="3584540">=</span>&nbsp;<span class="ident" id="3584542">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584547">if</span>&nbsp;<span class="ident" id="3584550">debugServerConnections</span>&nbsp;<span class="op" id="3584573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584577">c</span><span class="op" id="3584578">.</span><span class="ident" id="3584579">rwc</span>&nbsp;<span class="op" id="3584583">=</span>&nbsp;<span class="ident" id="3584585">newLoggingConn</span><span class="op" id="3584599">(</span><span class="string" id="3584600">&#34;server&#34;</span><span class="op" id="3584608">,</span>&nbsp;<span class="ident" id="3584610">c</span><span class="op" id="3584611">.</span><span class="ident" id="3584612">rwc</span><span class="op" id="3584615">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3584618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584621">c</span><span class="op" id="3584622">.</span><span class="ident" id="3584623">sr</span>&nbsp;<span class="op" id="3584626">=</span>&nbsp;<span class="ident" id="3584628">liveSwitchReader</span><span class="op" id="3584644">{</span><span class="ident" id="3584645">r</span><span class="op" id="3584646">:</span>&nbsp;<span class="ident" id="3584648">c</span><span class="op" id="3584649">.</span><span class="ident" id="3584650">rwc</span><span class="op" id="3584653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584656">c</span><span class="op" id="3584657">.</span><span class="ident" id="3584658">lr</span>&nbsp;<span class="op" id="3584661">=</span>&nbsp;<span class="ident" id="3584663">io</span><span class="op" id="3584665">.</span><span class="ident" id="3584666">LimitReader</span><span class="op" id="3584677">(</span><span class="op" id="3584678">&amp;</span><span class="ident" id="3584679">c</span><span class="op" id="3584680">.</span><span class="ident" id="3584681">sr</span><span class="op" id="3584683">,</span>&nbsp;<span class="ident" id="3584685">noLimit</span><span class="op" id="3584692">)</span><span class="op" id="3584693">.</span><span class="op" id="3584694">(</span><span class="op" id="3584695">*</span><span class="ident" id="3584696">io</span><span class="op" id="3584698">.</span><span class="ident" id="3584699">LimitedReader</span><span class="op" id="3584712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584715">br</span>&nbsp;<span class="op" id="3584718">:=</span>&nbsp;<span class="ident" id="3584721">newBufioReader</span><span class="op" id="3584735">(</span><span class="ident" id="3584736">c</span><span class="op" id="3584737">.</span><span class="ident" id="3584738">lr</span><span class="op" id="3584740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584743">bw</span>&nbsp;<span class="op" id="3584746">:=</span>&nbsp;<span class="ident" id="3584749">newBufioWriterSize</span><span class="op" id="3584767">(</span><span class="ident" id="3584768">checkConnErrorWriter</span><span class="op" id="3584788">{</span><span class="ident" id="3584789">c</span><span class="op" id="3584790">}</span><span class="op" id="3584791">,</span>&nbsp;<span class="num" id="3584793">4</span><span class="op" id="3584794">&lt;&lt;</span><span class="num" id="3584796">10</span><span class="op" id="3584798">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584801">c</span><span class="op" id="3584802">.</span><span class="ident" id="3584803">buf</span>&nbsp;<span class="op" id="3584807">=</span>&nbsp;<span class="ident" id="3584809">bufio</span><span class="op" id="3584814">.</span><span class="ident" id="3584815">NewReadWriter</span><span class="op" id="3584828">(</span><span class="ident" id="3584829">br</span><span class="op" id="3584831">,</span>&nbsp;<span class="ident" id="3584833">bw</span><span class="op" id="3584835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584838">return</span>&nbsp;<span class="ident" id="3584845">c</span><span class="op" id="3584846">,</span>&nbsp;<span class="ident" id="3584848">nil</span><br>
<span class="lineno"></span><span class="op" id="3584852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3584855">var</span>&nbsp;<span class="op" id="3584859">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584862">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3584880">sync</span><span class="op" id="3584884">.</span><span class="ident" id="3584885">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584891">bufioWriter2kPool</span>&nbsp;<span class="ident" id="3584909">sync</span><span class="op" id="3584913">.</span><span class="ident" id="3584914">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3584920">bufioWriter4kPool</span>&nbsp;<span class="ident" id="3584938">sync</span><span class="op" id="3584942">.</span><span class="ident" id="3584943">Pool</span><br>
<span class="lineno"></span><span class="op" id="3584948">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="3584951">func</span>&nbsp;<span class="ident" id="3584956">bufioWriterPool</span><span class="op" id="3584971">(</span><span class="ident" id="3584972">size</span>&nbsp;<span class="builtintype" id="3584977">int</span><span class="op" id="3584980">)</span>&nbsp;<span class="op" id="3584982">*</span><span class="ident" id="3584983">sync</span><span class="op" id="3584987">.</span><span class="ident" id="3584988">Pool</span>&nbsp;<span class="op" id="3584993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3584996">switch</span>&nbsp;<span class="ident" id="3585003">size</span>&nbsp;<span class="op" id="3585008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585011">case</span>&nbsp;<span class="num" id="3585016">2</span>&nbsp;<span class="op" id="3585018">&lt;&lt;</span>&nbsp;<span class="num" id="3585021">10</span><span class="op" id="3585023">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585027">return</span>&nbsp;<span class="op" id="3585034">&amp;</span><span class="ident" id="3585035">bufioWriter2kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585054">case</span>&nbsp;<span class="num" id="3585059">4</span>&nbsp;<span class="op" id="3585061">&lt;&lt;</span>&nbsp;<span class="num" id="3585064">10</span><span class="op" id="3585066">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585070">return</span>&nbsp;<span class="op" id="3585077">&amp;</span><span class="ident" id="3585078">bufioWriter4kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3585097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585100">return</span>&nbsp;<span class="ident" id="3585107">nil</span><br>
<span class="lineno"></span><span class="op" id="3585111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="3585114">func</span>&nbsp;<span class="ident" id="3585119">newBufioReader</span><span class="op" id="3585133">(</span><span class="ident" id="3585134">r</span>&nbsp;<span class="ident" id="3585136">io</span><span class="op" id="3585138">.</span><span class="ident" id="3585139">Reader</span><span class="op" id="3585145">)</span>&nbsp;<span class="op" id="3585147">*</span><span class="ident" id="3585148">bufio</span><span class="op" id="3585153">.</span><span class="ident" id="3585154">Reader</span>&nbsp;<span class="op" id="3585161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585164">if</span>&nbsp;<span class="ident" id="3585167">v</span>&nbsp;<span class="op" id="3585169">:=</span>&nbsp;<span class="ident" id="3585172">bufioReaderPool</span><span class="op" id="3585187">.</span><span class="ident" id="3585188">Get</span><span class="op" id="3585191">(</span><span class="op" id="3585192">)</span><span class="op" id="3585193">;</span>&nbsp;<span class="ident" id="3585195">v</span>&nbsp;<span class="op" id="3585197">!=</span>&nbsp;<span class="ident" id="3585200">nil</span>&nbsp;<span class="op" id="3585204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3585208">br</span>&nbsp;<span class="op" id="3585211">:=</span>&nbsp;<span class="ident" id="3585214">v</span><span class="op" id="3585215">.</span><span class="op" id="3585216">(</span><span class="op" id="3585217">*</span><span class="ident" id="3585218">bufio</span><span class="op" id="3585223">.</span><span class="ident" id="3585224">Reader</span><span class="op" id="3585230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3585234">br</span><span class="op" id="3585236">.</span><span class="ident" id="3585237">Reset</span><span class="op" id="3585242">(</span><span class="ident" id="3585243">r</span><span class="op" id="3585244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585248">return</span>&nbsp;<span class="ident" id="3585255">br</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3585259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585262">return</span>&nbsp;<span class="ident" id="3585269">bufio</span><span class="op" id="3585274">.</span><span class="ident" id="3585275">NewReader</span><span class="op" id="3585284">(</span><span class="ident" id="3585285">r</span><span class="op" id="3585286">)</span><br>
<span class="lineno"></span><span class="op" id="3585288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3585291">func</span>&nbsp;<span class="ident" id="3585296">putBufioReader</span><span class="op" id="3585310">(</span><span class="ident" id="3585311">br</span>&nbsp;<span class="op" id="3585314">*</span><span class="ident" id="3585315">bufio</span><span class="op" id="3585320">.</span><span class="ident" id="3585321">Reader</span><span class="op" id="3585327">)</span>&nbsp;<span class="op" id="3585329">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3585332">br</span><span class="op" id="3585334">.</span><span class="ident" id="3585335">Reset</span><span class="op" id="3585340">(</span><span class="ident" id="3585341">nil</span><span class="op" id="3585344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3585347">bufioReaderPool</span><span class="op" id="3585362">.</span><span class="ident" id="3585363">Put</span><span class="op" id="3585366">(</span><span class="ident" id="3585367">br</span><span class="op" id="3585369">)</span><br>
<span class="lineno"></span><span class="op" id="3585371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3585374">func</span>&nbsp;<span class="ident" id="3585379">newBufioWriterSize</span><span class="op" id="3585397">(</span><span class="ident" id="3585398">w</span>&nbsp;<span class="ident" id="3585400">io</span><span class="op" id="3585402">.</span><span class="ident" id="3585403">Writer</span><span class="op" id="3585409">,</span>&nbsp;<span class="ident" id="3585411">size</span>&nbsp;<span class="builtintype" id="3585416">int</span><span class="op" id="3585419">)</span>&nbsp;<span class="op" id="3585421">*</span><span class="ident" id="3585422">bufio</span><span class="op" id="3585427">.</span><span class="ident" id="3585428">Writer</span>&nbsp;<span class="op" id="3585435">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3585438">pool</span>&nbsp;<span class="op" id="3585443">:=</span>&nbsp;<span class="ident" id="3585446">bufioWriterPool</span><span class="op" id="3585461">(</span><span class="ident" id="3585462">size</span><span class="op" id="3585466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585469">if</span>&nbsp;<span class="ident" id="3585472">pool</span>&nbsp;<span class="op" id="3585477">!=</span>&nbsp;<span class="ident" id="3585480">nil</span>&nbsp;<span class="op" id="3585484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585488">if</span>&nbsp;<span class="ident" id="3585491">v</span>&nbsp;<span class="op" id="3585493">:=</span>&nbsp;<span class="ident" id="3585496">pool</span><span class="op" id="3585500">.</span><span class="ident" id="3585501">Get</span><span class="op" id="3585504">(</span><span class="op" id="3585505">)</span><span class="op" id="3585506">;</span>&nbsp;<span class="ident" id="3585508">v</span>&nbsp;<span class="op" id="3585510">!=</span>&nbsp;<span class="ident" id="3585513">nil</span>&nbsp;<span class="op" id="3585517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3585522">bw</span>&nbsp;<span class="op" id="3585525">:=</span>&nbsp;<span class="ident" id="3585528">v</span><span class="op" id="3585529">.</span><span class="op" id="3585530">(</span><span class="op" id="3585531">*</span><span class="ident" id="3585532">bufio</span><span class="op" id="3585537">.</span><span class="ident" id="3585538">Writer</span><span class="op" id="3585544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3585549">bw</span><span class="op" id="3585551">.</span><span class="ident" id="3585552">Reset</span><span class="op" id="3585557">(</span><span class="ident" id="3585558">w</span><span class="op" id="3585559">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585564">return</span>&nbsp;<span class="ident" id="3585571">bw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3585576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3585579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585582">return</span>&nbsp;<span class="ident" id="3585589">bufio</span><span class="op" id="3585594">.</span><span class="ident" id="3585595">NewWriterSize</span><span class="op" id="3585608">(</span><span class="ident" id="3585609">w</span><span class="op" id="3585610">,</span>&nbsp;<span class="ident" id="3585612">size</span><span class="op" id="3585616">)</span><br>
<span class="lineno"></span><span class="op" id="3585618">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="3585621">func</span>&nbsp;<span class="ident" id="3585626">putBufioWriter</span><span class="op" id="3585640">(</span><span class="ident" id="3585641">bw</span>&nbsp;<span class="op" id="3585644">*</span><span class="ident" id="3585645">bufio</span><span class="op" id="3585650">.</span><span class="ident" id="3585651">Writer</span><span class="op" id="3585657">)</span>&nbsp;<span class="op" id="3585659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3585662">bw</span><span class="op" id="3585664">.</span><span class="ident" id="3585665">Reset</span><span class="op" id="3585670">(</span><span class="ident" id="3585671">nil</span><span class="op" id="3585674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585677">if</span>&nbsp;<span class="ident" id="3585680">pool</span>&nbsp;<span class="op" id="3585685">:=</span>&nbsp;<span class="ident" id="3585688">bufioWriterPool</span><span class="op" id="3585703">(</span><span class="ident" id="3585704">bw</span><span class="op" id="3585706">.</span><span class="ident" id="3585707">Available</span><span class="op" id="3585716">(</span><span class="op" id="3585717">)</span><span class="op" id="3585718">)</span><span class="op" id="3585719">;</span>&nbsp;<span class="ident" id="3585721">pool</span>&nbsp;<span class="op" id="3585726">!=</span>&nbsp;<span class="ident" id="3585729">nil</span>&nbsp;<span class="op" id="3585733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3585737">pool</span><span class="op" id="3585741">.</span><span class="ident" id="3585742">Put</span><span class="op" id="3585745">(</span><span class="ident" id="3585746">bw</span><span class="op" id="3585748">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3585751">}</span><br>
<span class="lineno"></span><span class="op" id="3585753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3585756">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="3585826">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="3585849">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3585909">const</span>&nbsp;<span class="ident" id="3585915">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="3585937">=</span>&nbsp;<span class="num" id="3585939">1</span>&nbsp;<span class="op" id="3585941">&lt;&lt;</span>&nbsp;<span class="num" id="3585944">20</span>&nbsp;<span class="comment" id="3585947">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3585956">func</span>&nbsp;<span class="op" id="3585961">(</span><span class="ident" id="3585962">srv</span>&nbsp;<span class="op" id="3585966">*</span><span class="ident" id="3585967">Server</span><span class="op" id="3585973">)</span>&nbsp;<span class="ident" id="3585975">maxHeaderBytes</span><span class="op" id="3585989">(</span><span class="op" id="3585990">)</span>&nbsp;<span class="builtintype" id="3585992">int</span>&nbsp;<span class="op" id="3585996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3585999">if</span>&nbsp;<span class="ident" id="3586002">srv</span><span class="op" id="3586005">.</span><span class="ident" id="3586006">MaxHeaderBytes</span>&nbsp;<span class="op" id="3586021">&gt;</span>&nbsp;<span class="num" id="3586023">0</span>&nbsp;<span class="op" id="3586025">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3586029">return</span>&nbsp;<span class="ident" id="3586036">srv</span><span class="op" id="3586039">.</span><span class="ident" id="3586040">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3586056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3586059">return</span>&nbsp;<span class="ident" id="3586066">DefaultMaxHeaderBytes</span><br>
<span class="lineno"></span><span class="op" id="3586088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="3586091">func</span>&nbsp;<span class="op" id="3586096">(</span><span class="ident" id="3586097">srv</span>&nbsp;<span class="op" id="3586101">*</span><span class="ident" id="3586102">Server</span><span class="op" id="3586108">)</span>&nbsp;<span class="ident" id="3586110">initialLimitedReaderSize</span><span class="op" id="3586134">(</span><span class="op" id="3586135">)</span>&nbsp;<span class="ident" id="3586137">int64</span>&nbsp;<span class="op" id="3586143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3586146">return</span>&nbsp;<span class="ident" id="3586153">int64</span><span class="op" id="3586158">(</span><span class="ident" id="3586159">srv</span><span class="op" id="3586162">.</span><span class="ident" id="3586163">maxHeaderBytes</span><span class="op" id="3586177">(</span><span class="op" id="3586178">)</span><span class="op" id="3586179">)</span>&nbsp;<span class="op" id="3586181">+</span>&nbsp;<span class="num" id="3586183">4096</span>&nbsp;<span class="comment" id="3586188">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="3586202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3586205">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="3586269">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3586301">type</span>&nbsp;<span class="ident" id="3586306">expectContinueReader</span>&nbsp;<span class="keyword" id="3586327">struct</span>&nbsp;<span class="op" id="3586334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3586337">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3586348">*</span><span class="ident" id="3586349">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3586359">readCloser</span>&nbsp;<span class="ident" id="3586370">io</span><span class="op" id="3586372">.</span><span class="ident" id="3586373">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3586385">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3586396">bool</span><br>
<span class="lineno">520</span><span class="op" id="3586401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3586404">func</span>&nbsp;<span class="op" id="3586409">(</span><span class="ident" id="3586410">ecr</span>&nbsp;<span class="op" id="3586414">*</span><span class="ident" id="3586415">expectContinueReader</span><span class="op" id="3586435">)</span>&nbsp;<span class="ident" id="3586437">Read</span><span class="op" id="3586441">(</span><span class="ident" id="3586442">p</span>&nbsp;<span class="op" id="3586444">[</span><span class="op" id="3586445">]</span><span class="builtintype" id="3586446">byte</span><span class="op" id="3586450">)</span>&nbsp;<span class="op" id="3586452">(</span><span class="ident" id="3586453">n</span>&nbsp;<span class="builtintype" id="3586455">int</span><span class="op" id="3586458">,</span>&nbsp;<span class="ident" id="3586460">err</span>&nbsp;<span class="builtintype" id="3586464">error</span><span class="op" id="3586469">)</span>&nbsp;<span class="op" id="3586471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3586474">if</span>&nbsp;<span class="ident" id="3586477">ecr</span><span class="op" id="3586480">.</span><span class="ident" id="3586481">closed</span>&nbsp;<span class="op" id="3586488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3586492">return</span>&nbsp;<span class="num" id="3586499">0</span><span class="op" id="3586500">,</span>&nbsp;<span class="ident" id="3586502">ErrBodyReadAfterClose</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3586525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3586528">if</span>&nbsp;<span class="op" id="3586531">!</span><span class="ident" id="3586532">ecr</span><span class="op" id="3586535">.</span><span class="ident" id="3586536">resp</span><span class="op" id="3586540">.</span><span class="ident" id="3586541">wroteContinue</span>&nbsp;<span class="op" id="3586555">&amp;&amp;</span>&nbsp;<span class="op" id="3586558">!</span><span class="ident" id="3586559">ecr</span><span class="op" id="3586562">.</span><span class="ident" id="3586563">resp</span><span class="op" id="3586567">.</span><span class="ident" id="3586568">conn</span><span class="op" id="3586572">.</span><span class="ident" id="3586573">hijacked</span><span class="op" id="3586581">(</span><span class="op" id="3586582">)</span>&nbsp;<span class="op" id="3586584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3586588">ecr</span><span class="op" id="3586591">.</span><span class="ident" id="3586592">resp</span><span class="op" id="3586596">.</span><span class="ident" id="3586597">wroteContinue</span>&nbsp;<span class="op" id="3586611">=</span>&nbsp;<span class="ident" id="3586613">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3586620">ecr</span><span class="op" id="3586623">.</span><span class="ident" id="3586624">resp</span><span class="op" id="3586628">.</span><span class="ident" id="3586629">conn</span><span class="op" id="3586633">.</span><span class="ident" id="3586634">buf</span><span class="op" id="3586637">.</span><span class="ident" id="3586638">WriteString</span><span class="op" id="3586649">(</span><span class="string" id="3586650">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="3586681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3586685">ecr</span><span class="op" id="3586688">.</span><span class="ident" id="3586689">resp</span><span class="op" id="3586693">.</span><span class="ident" id="3586694">conn</span><span class="op" id="3586698">.</span><span class="ident" id="3586699">buf</span><span class="op" id="3586702">.</span><span class="ident" id="3586703">Flush</span><span class="op" id="3586708">(</span><span class="op" id="3586709">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3586712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3586715">return</span>&nbsp;<span class="ident" id="3586722">ecr</span><span class="op" id="3586725">.</span><span class="ident" id="3586726">readCloser</span><span class="op" id="3586736">.</span><span class="ident" id="3586737">Read</span><span class="op" id="3586741">(</span><span class="ident" id="3586742">p</span><span class="op" id="3586743">)</span><br>
<span class="lineno"></span><span class="op" id="3586745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3586748">func</span>&nbsp;<span class="op" id="3586753">(</span><span class="ident" id="3586754">ecr</span>&nbsp;<span class="op" id="3586758">*</span><span class="ident" id="3586759">expectContinueReader</span><span class="op" id="3586779">)</span>&nbsp;<span class="ident" id="3586781">Close</span><span class="op" id="3586786">(</span><span class="op" id="3586787">)</span>&nbsp;<span class="builtintype" id="3586789">error</span>&nbsp;<span class="op" id="3586795">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3586798">ecr</span><span class="op" id="3586801">.</span><span class="ident" id="3586802">closed</span>&nbsp;<span class="op" id="3586809">=</span>&nbsp;<span class="ident" id="3586811">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3586817">return</span>&nbsp;<span class="ident" id="3586824">ecr</span><span class="op" id="3586827">.</span><span class="ident" id="3586828">readCloser</span><span class="op" id="3586838">.</span><span class="ident" id="3586839">Close</span><span class="op" id="3586844">(</span><span class="op" id="3586845">)</span><br>
<span class="lineno"></span><span class="op" id="3586847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3586850">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="3586895">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="3586943">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="3586983">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="3587047">const</span>&nbsp;<span class="ident" id="3587053">TimeFormat</span>&nbsp;<span class="op" id="3587064">=</span>&nbsp;<span class="string" id="3587066">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="3587099">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="3587179">func</span>&nbsp;<span class="ident" id="3587184">appendTime</span><span class="op" id="3587194">(</span><span class="ident" id="3587195">b</span>&nbsp;<span class="op" id="3587197">[</span><span class="op" id="3587198">]</span><span class="builtintype" id="3587199">byte</span><span class="op" id="3587203">,</span>&nbsp;<span class="ident" id="3587205">t</span>&nbsp;<span class="ident" id="3587207">time</span><span class="op" id="3587211">.</span><span class="ident" id="3587212">Time</span><span class="op" id="3587216">)</span>&nbsp;<span class="op" id="3587218">[</span><span class="op" id="3587219">]</span><span class="builtintype" id="3587220">byte</span>&nbsp;<span class="op" id="3587225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3587228">const</span>&nbsp;<span class="ident" id="3587234">days</span>&nbsp;<span class="op" id="3587239">=</span>&nbsp;<span class="string" id="3587241">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3587266">const</span>&nbsp;<span class="ident" id="3587272">months</span>&nbsp;<span class="op" id="3587279">=</span>&nbsp;<span class="string" id="3587281">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3587322">t</span>&nbsp;<span class="op" id="3587324">=</span>&nbsp;<span class="ident" id="3587326">t</span><span class="op" id="3587327">.</span><span class="ident" id="3587328">UTC</span><span class="op" id="3587331">(</span><span class="op" id="3587332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3587335">yy</span><span class="op" id="3587337">,</span>&nbsp;<span class="ident" id="3587339">mm</span><span class="op" id="3587341">,</span>&nbsp;<span class="ident" id="3587343">dd</span>&nbsp;<span class="op" id="3587346">:=</span>&nbsp;<span class="ident" id="3587349">t</span><span class="op" id="3587350">.</span><span class="ident" id="3587351">Date</span><span class="op" id="3587355">(</span><span class="op" id="3587356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3587359">hh</span><span class="op" id="3587361">,</span>&nbsp;<span class="ident" id="3587363">mn</span><span class="op" id="3587365">,</span>&nbsp;<span class="ident" id="3587367">ss</span>&nbsp;<span class="op" id="3587370">:=</span>&nbsp;<span class="ident" id="3587373">t</span><span class="op" id="3587374">.</span><span class="ident" id="3587375">Clock</span><span class="op" id="3587380">(</span><span class="op" id="3587381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3587384">day</span>&nbsp;<span class="op" id="3587388">:=</span>&nbsp;<span class="ident" id="3587391">days</span><span class="op" id="3587395">[</span><span class="num" id="3587396">3</span><span class="op" id="3587397">*</span><span class="ident" id="3587398">t</span><span class="op" id="3587399">.</span><span class="ident" id="3587400">Weekday</span><span class="op" id="3587407">(</span><span class="op" id="3587408">)</span><span class="op" id="3587409">:</span><span class="op" id="3587410">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3587413">mon</span>&nbsp;<span class="op" id="3587417">:=</span>&nbsp;<span class="ident" id="3587420">months</span><span class="op" id="3587426">[</span><span class="num" id="3587427">3</span><span class="op" id="3587428">*</span><span class="op" id="3587429">(</span><span class="ident" id="3587430">mm</span><span class="op" id="3587432">-</span><span class="num" id="3587433">1</span><span class="op" id="3587434">)</span><span class="op" id="3587435">:</span><span class="op" id="3587436">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3587440">return</span>&nbsp;<span class="builtinfunc" id="3587447">append</span><span class="op" id="3587453">(</span><span class="ident" id="3587454">b</span><span class="op" id="3587455">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3587459">day</span><span class="op" id="3587462">[</span><span class="num" id="3587463">0</span><span class="op" id="3587464">]</span><span class="op" id="3587465">,</span>&nbsp;<span class="ident" id="3587467">day</span><span class="op" id="3587470">[</span><span class="num" id="3587471">1</span><span class="op" id="3587472">]</span><span class="op" id="3587473">,</span>&nbsp;<span class="ident" id="3587475">day</span><span class="op" id="3587478">[</span><span class="num" id="3587479">2</span><span class="op" id="3587480">]</span><span class="op" id="3587481">,</span>&nbsp;<span class="string" id="3587483">&#39;,&#39;</span><span class="op" id="3587486">,</span>&nbsp;<span class="string" id="3587488">&#39;&nbsp;&#39;</span><span class="op" id="3587491">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3587495">byte</span><span class="op" id="3587499">(</span><span class="string" id="3587500">&#39;0&#39;</span><span class="op" id="3587503">+</span><span class="ident" id="3587504">dd</span><span class="op" id="3587506">/</span><span class="num" id="3587507">10</span><span class="op" id="3587509">)</span><span class="op" id="3587510">,</span>&nbsp;<span class="builtintype" id="3587512">byte</span><span class="op" id="3587516">(</span><span class="string" id="3587517">&#39;0&#39;</span><span class="op" id="3587520">+</span><span class="ident" id="3587521">dd</span><span class="op" id="3587523">%</span><span class="num" id="3587524">10</span><span class="op" id="3587526">)</span><span class="op" id="3587527">,</span>&nbsp;<span class="string" id="3587529">&#39;&nbsp;&#39;</span><span class="op" id="3587532">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3587536">mon</span><span class="op" id="3587539">[</span><span class="num" id="3587540">0</span><span class="op" id="3587541">]</span><span class="op" id="3587542">,</span>&nbsp;<span class="ident" id="3587544">mon</span><span class="op" id="3587547">[</span><span class="num" id="3587548">1</span><span class="op" id="3587549">]</span><span class="op" id="3587550">,</span>&nbsp;<span class="ident" id="3587552">mon</span><span class="op" id="3587555">[</span><span class="num" id="3587556">2</span><span class="op" id="3587557">]</span><span class="op" id="3587558">,</span>&nbsp;<span class="string" id="3587560">&#39;&nbsp;&#39;</span><span class="op" id="3587563">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3587567">byte</span><span class="op" id="3587571">(</span><span class="string" id="3587572">&#39;0&#39;</span><span class="op" id="3587575">+</span><span class="ident" id="3587576">yy</span><span class="op" id="3587578">/</span><span class="num" id="3587579">1000</span><span class="op" id="3587583">)</span><span class="op" id="3587584">,</span>&nbsp;<span class="builtintype" id="3587586">byte</span><span class="op" id="3587590">(</span><span class="string" id="3587591">&#39;0&#39;</span><span class="op" id="3587594">+</span><span class="op" id="3587595">(</span><span class="ident" id="3587596">yy</span><span class="op" id="3587598">/</span><span class="num" id="3587599">100</span><span class="op" id="3587602">)</span><span class="op" id="3587603">%</span><span class="num" id="3587604">10</span><span class="op" id="3587606">)</span><span class="op" id="3587607">,</span>&nbsp;<span class="builtintype" id="3587609">byte</span><span class="op" id="3587613">(</span><span class="string" id="3587614">&#39;0&#39;</span><span class="op" id="3587617">+</span><span class="op" id="3587618">(</span><span class="ident" id="3587619">yy</span><span class="op" id="3587621">/</span><span class="num" id="3587622">10</span><span class="op" id="3587624">)</span><span class="op" id="3587625">%</span><span class="num" id="3587626">10</span><span class="op" id="3587628">)</span><span class="op" id="3587629">,</span>&nbsp;<span class="builtintype" id="3587631">byte</span><span class="op" id="3587635">(</span><span class="string" id="3587636">&#39;0&#39;</span><span class="op" id="3587639">+</span><span class="ident" id="3587640">yy</span><span class="op" id="3587642">%</span><span class="num" id="3587643">10</span><span class="op" id="3587645">)</span><span class="op" id="3587646">,</span>&nbsp;<span class="string" id="3587648">&#39;&nbsp;&#39;</span><span class="op" id="3587651">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3587655">byte</span><span class="op" id="3587659">(</span><span class="string" id="3587660">&#39;0&#39;</span><span class="op" id="3587663">+</span><span class="ident" id="3587664">hh</span><span class="op" id="3587666">/</span><span class="num" id="3587667">10</span><span class="op" id="3587669">)</span><span class="op" id="3587670">,</span>&nbsp;<span class="builtintype" id="3587672">byte</span><span class="op" id="3587676">(</span><span class="string" id="3587677">&#39;0&#39;</span><span class="op" id="3587680">+</span><span class="ident" id="3587681">hh</span><span class="op" id="3587683">%</span><span class="num" id="3587684">10</span><span class="op" id="3587686">)</span><span class="op" id="3587687">,</span>&nbsp;<span class="string" id="3587689">&#39;:&#39;</span><span class="op" id="3587692">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3587696">byte</span><span class="op" id="3587700">(</span><span class="string" id="3587701">&#39;0&#39;</span><span class="op" id="3587704">+</span><span class="ident" id="3587705">mn</span><span class="op" id="3587707">/</span><span class="num" id="3587708">10</span><span class="op" id="3587710">)</span><span class="op" id="3587711">,</span>&nbsp;<span class="builtintype" id="3587713">byte</span><span class="op" id="3587717">(</span><span class="string" id="3587718">&#39;0&#39;</span><span class="op" id="3587721">+</span><span class="ident" id="3587722">mn</span><span class="op" id="3587724">%</span><span class="num" id="3587725">10</span><span class="op" id="3587727">)</span><span class="op" id="3587728">,</span>&nbsp;<span class="string" id="3587730">&#39;:&#39;</span><span class="op" id="3587733">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3587737">byte</span><span class="op" id="3587741">(</span><span class="string" id="3587742">&#39;0&#39;</span><span class="op" id="3587745">+</span><span class="ident" id="3587746">ss</span><span class="op" id="3587748">/</span><span class="num" id="3587749">10</span><span class="op" id="3587751">)</span><span class="op" id="3587752">,</span>&nbsp;<span class="builtintype" id="3587754">byte</span><span class="op" id="3587758">(</span><span class="string" id="3587759">&#39;0&#39;</span><span class="op" id="3587762">+</span><span class="ident" id="3587763">ss</span><span class="op" id="3587765">%</span><span class="num" id="3587766">10</span><span class="op" id="3587768">)</span><span class="op" id="3587769">,</span>&nbsp;<span class="string" id="3587771">&#39;&nbsp;&#39;</span><span class="op" id="3587774">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3587778">&#39;G&#39;</span><span class="op" id="3587781">,</span>&nbsp;<span class="string" id="3587783">&#39;M&#39;</span><span class="op" id="3587786">,</span>&nbsp;<span class="string" id="3587788">&#39;T&#39;</span><span class="op" id="3587791">)</span><br>
<span class="lineno">565</span><span class="op" id="3587793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3587796">var</span>&nbsp;<span class="ident" id="3587800">errTooLarge</span>&nbsp;<span class="op" id="3587812">=</span>&nbsp;<span class="ident" id="3587814">errors</span><span class="op" id="3587820">.</span><span class="ident" id="3587821">New</span><span class="op" id="3587824">(</span><span class="string" id="3587825">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="3587850">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3587853">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="3587891">func</span>&nbsp;<span class="op" id="3587896">(</span><span class="ident" id="3587897">c</span>&nbsp;<span class="op" id="3587899">*</span><span class="ident" id="3587900">conn</span><span class="op" id="3587904">)</span>&nbsp;<span class="ident" id="3587906">readRequest</span><span class="op" id="3587917">(</span><span class="op" id="3587918">)</span>&nbsp;<span class="op" id="3587920">(</span><span class="ident" id="3587921">w</span>&nbsp;<span class="op" id="3587923">*</span><span class="ident" id="3587924">response</span><span class="op" id="3587932">,</span>&nbsp;<span class="ident" id="3587934">err</span>&nbsp;<span class="builtintype" id="3587938">error</span><span class="op" id="3587943">)</span>&nbsp;<span class="op" id="3587945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3587948">if</span>&nbsp;<span class="ident" id="3587951">c</span><span class="op" id="3587952">.</span><span class="ident" id="3587953">hijacked</span><span class="op" id="3587961">(</span><span class="op" id="3587962">)</span>&nbsp;<span class="op" id="3587964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3587968">return</span>&nbsp;<span class="ident" id="3587975">nil</span><span class="op" id="3587978">,</span>&nbsp;<span class="ident" id="3587980">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3587993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3587997">if</span>&nbsp;<span class="ident" id="3588000">d</span>&nbsp;<span class="op" id="3588002">:=</span>&nbsp;<span class="ident" id="3588005">c</span><span class="op" id="3588006">.</span><span class="ident" id="3588007">server</span><span class="op" id="3588013">.</span><span class="ident" id="3588014">ReadTimeout</span><span class="op" id="3588025">;</span>&nbsp;<span class="ident" id="3588027">d</span>&nbsp;<span class="op" id="3588029">!=</span>&nbsp;<span class="num" id="3588032">0</span>&nbsp;<span class="op" id="3588034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588038">c</span><span class="op" id="3588039">.</span><span class="ident" id="3588040">rwc</span><span class="op" id="3588043">.</span><span class="ident" id="3588044">SetReadDeadline</span><span class="op" id="3588059">(</span><span class="ident" id="3588060">time</span><span class="op" id="3588064">.</span><span class="ident" id="3588065">Now</span><span class="op" id="3588068">(</span><span class="op" id="3588069">)</span><span class="op" id="3588070">.</span><span class="ident" id="3588071">Add</span><span class="op" id="3588074">(</span><span class="ident" id="3588075">d</span><span class="op" id="3588076">)</span><span class="op" id="3588077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3588080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3588083">if</span>&nbsp;<span class="ident" id="3588086">d</span>&nbsp;<span class="op" id="3588088">:=</span>&nbsp;<span class="ident" id="3588091">c</span><span class="op" id="3588092">.</span><span class="ident" id="3588093">server</span><span class="op" id="3588099">.</span><span class="ident" id="3588100">WriteTimeout</span><span class="op" id="3588112">;</span>&nbsp;<span class="ident" id="3588114">d</span>&nbsp;<span class="op" id="3588116">!=</span>&nbsp;<span class="num" id="3588119">0</span>&nbsp;<span class="op" id="3588121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3588125">defer</span>&nbsp;<span class="keyword" id="3588131">func</span><span class="op" id="3588135">(</span><span class="op" id="3588136">)</span>&nbsp;<span class="op" id="3588138">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588143">c</span><span class="op" id="3588144">.</span><span class="ident" id="3588145">rwc</span><span class="op" id="3588148">.</span><span class="ident" id="3588149">SetWriteDeadline</span><span class="op" id="3588165">(</span><span class="ident" id="3588166">time</span><span class="op" id="3588170">.</span><span class="ident" id="3588171">Now</span><span class="op" id="3588174">(</span><span class="op" id="3588175">)</span><span class="op" id="3588176">.</span><span class="ident" id="3588177">Add</span><span class="op" id="3588180">(</span><span class="ident" id="3588181">d</span><span class="op" id="3588182">)</span><span class="op" id="3588183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3588187">}</span><span class="op" id="3588188">(</span><span class="op" id="3588189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3588192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588196">c</span><span class="op" id="3588197">.</span><span class="ident" id="3588198">lr</span><span class="op" id="3588200">.</span><span class="ident" id="3588201">N</span>&nbsp;<span class="op" id="3588203">=</span>&nbsp;<span class="ident" id="3588205">c</span><span class="op" id="3588206">.</span><span class="ident" id="3588207">server</span><span class="op" id="3588213">.</span><span class="ident" id="3588214">initialLimitedReaderSize</span><span class="op" id="3588238">(</span><span class="op" id="3588239">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3588242">var</span>&nbsp;<span class="ident" id="3588246">req</span>&nbsp;<span class="op" id="3588250">*</span><span class="ident" id="3588251">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3588260">if</span>&nbsp;<span class="ident" id="3588263">req</span><span class="op" id="3588266">,</span>&nbsp;<span class="ident" id="3588268">err</span>&nbsp;<span class="op" id="3588272">=</span>&nbsp;<span class="ident" id="3588274">ReadRequest</span><span class="op" id="3588285">(</span><span class="ident" id="3588286">c</span><span class="op" id="3588287">.</span><span class="ident" id="3588288">buf</span><span class="op" id="3588291">.</span><span class="ident" id="3588292">Reader</span><span class="op" id="3588298">)</span><span class="op" id="3588299">;</span>&nbsp;<span class="ident" id="3588301">err</span>&nbsp;<span class="op" id="3588305">!=</span>&nbsp;<span class="ident" id="3588308">nil</span>&nbsp;<span class="op" id="3588312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3588316">if</span>&nbsp;<span class="ident" id="3588319">c</span><span class="op" id="3588320">.</span><span class="ident" id="3588321">lr</span><span class="op" id="3588323">.</span><span class="ident" id="3588324">N</span>&nbsp;<span class="op" id="3588326">==</span>&nbsp;<span class="num" id="3588329">0</span>&nbsp;<span class="op" id="3588331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3588336">return</span>&nbsp;<span class="ident" id="3588343">nil</span><span class="op" id="3588346">,</span>&nbsp;<span class="ident" id="3588348">errTooLarge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3588362">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3588366">return</span>&nbsp;<span class="ident" id="3588373">nil</span><span class="op" id="3588376">,</span>&nbsp;<span class="ident" id="3588378">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3588383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588386">c</span><span class="op" id="3588387">.</span><span class="ident" id="3588388">lr</span><span class="op" id="3588390">.</span><span class="ident" id="3588391">N</span>&nbsp;<span class="op" id="3588393">=</span>&nbsp;<span class="ident" id="3588395">noLimit</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588405">req</span><span class="op" id="3588408">.</span><span class="ident" id="3588409">RemoteAddr</span>&nbsp;<span class="op" id="3588420">=</span>&nbsp;<span class="ident" id="3588422">c</span><span class="op" id="3588423">.</span><span class="ident" id="3588424">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588436">req</span><span class="op" id="3588439">.</span><span class="ident" id="3588440">TLS</span>&nbsp;<span class="op" id="3588444">=</span>&nbsp;<span class="ident" id="3588446">c</span><span class="op" id="3588447">.</span><span class="ident" id="3588448">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588459">w</span>&nbsp;<span class="op" id="3588461">=</span>&nbsp;<span class="op" id="3588463">&amp;</span><span class="ident" id="3588464">response</span><span class="op" id="3588472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588476">conn</span><span class="op" id="3588480">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588491">c</span><span class="op" id="3588492">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588496">req</span><span class="op" id="3588499">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3588511">req</span><span class="op" id="3588514">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588518">handlerHeader</span><span class="op" id="3588531">:</span>&nbsp;<span class="builtinfunc" id="3588533">make</span><span class="op" id="3588537">(</span><span class="ident" id="3588538">Header</span><span class="op" id="3588544">)</span><span class="op" id="3588545">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588549">contentLength</span><span class="op" id="3588562">:</span>&nbsp;<span class="op" id="3588564">-</span><span class="num" id="3588565">1</span><span class="op" id="3588566">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3588569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588572">w</span><span class="op" id="3588573">.</span><span class="ident" id="3588574">cw</span><span class="op" id="3588576">.</span><span class="ident" id="3588577">res</span>&nbsp;<span class="op" id="3588581">=</span>&nbsp;<span class="ident" id="3588583">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588586">w</span><span class="op" id="3588587">.</span><span class="ident" id="3588588">w</span>&nbsp;<span class="op" id="3588590">=</span>&nbsp;<span class="ident" id="3588592">newBufioWriterSize</span><span class="op" id="3588610">(</span><span class="op" id="3588611">&amp;</span><span class="ident" id="3588612">w</span><span class="op" id="3588613">.</span><span class="ident" id="3588614">cw</span><span class="op" id="3588616">,</span>&nbsp;<span class="ident" id="3588618">bufferBeforeChunkingSize</span><span class="op" id="3588642">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3588645">return</span>&nbsp;<span class="ident" id="3588652">w</span><span class="op" id="3588653">,</span>&nbsp;<span class="ident" id="3588655">nil</span><br>
<span class="lineno"></span><span class="op" id="3588659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3588662">func</span>&nbsp;<span class="op" id="3588667">(</span><span class="ident" id="3588668">w</span>&nbsp;<span class="op" id="3588670">*</span><span class="ident" id="3588671">response</span><span class="op" id="3588679">)</span>&nbsp;<span class="ident" id="3588681">Header</span><span class="op" id="3588687">(</span><span class="op" id="3588688">)</span>&nbsp;<span class="ident" id="3588690">Header</span>&nbsp;<span class="op" id="3588697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3588700">if</span>&nbsp;<span class="ident" id="3588703">w</span><span class="op" id="3588704">.</span><span class="ident" id="3588705">cw</span><span class="op" id="3588707">.</span><span class="ident" id="3588708">header</span>&nbsp;<span class="op" id="3588715">==</span>&nbsp;<span class="ident" id="3588718">nil</span>&nbsp;<span class="op" id="3588722">&amp;&amp;</span>&nbsp;<span class="ident" id="3588725">w</span><span class="op" id="3588726">.</span><span class="ident" id="3588727">wroteHeader</span>&nbsp;<span class="op" id="3588739">&amp;&amp;</span>&nbsp;<span class="op" id="3588742">!</span><span class="ident" id="3588743">w</span><span class="op" id="3588744">.</span><span class="ident" id="3588745">cw</span><span class="op" id="3588747">.</span><span class="ident" id="3588748">wroteHeader</span>&nbsp;<span class="op" id="3588760">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3588764">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3588819">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3588876">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588930">w</span><span class="op" id="3588931">.</span><span class="ident" id="3588932">cw</span><span class="op" id="3588934">.</span><span class="ident" id="3588935">header</span>&nbsp;<span class="op" id="3588942">=</span>&nbsp;<span class="ident" id="3588944">w</span><span class="op" id="3588945">.</span><span class="ident" id="3588946">handlerHeader</span><span class="op" id="3588959">.</span><span class="ident" id="3588960">clone</span><span class="op" id="3588965">(</span><span class="op" id="3588966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3588969">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3588972">w</span><span class="op" id="3588973">.</span><span class="ident" id="3588974">calledHeader</span>&nbsp;<span class="op" id="3588987">=</span>&nbsp;<span class="ident" id="3588989">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3588995">return</span>&nbsp;<span class="ident" id="3589002">w</span><span class="op" id="3589003">.</span><span class="ident" id="3589004">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="3589018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3589021">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="3589092">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3589159">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="3589229">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="3589297">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3589317">//</span><br>
<span class="lineno">625</span><span class="comment" id="3589320">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3589388">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3589458">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="3589477">const</span>&nbsp;<span class="ident" id="3589483">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3589507">=</span>&nbsp;<span class="num" id="3589509">256</span>&nbsp;<span class="op" id="3589513">&lt;&lt;</span>&nbsp;<span class="num" id="3589516">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="3589520">func</span>&nbsp;<span class="op" id="3589525">(</span><span class="ident" id="3589526">w</span>&nbsp;<span class="op" id="3589528">*</span><span class="ident" id="3589529">response</span><span class="op" id="3589537">)</span>&nbsp;<span class="ident" id="3589539">WriteHeader</span><span class="op" id="3589550">(</span><span class="ident" id="3589551">code</span>&nbsp;<span class="builtintype" id="3589556">int</span><span class="op" id="3589559">)</span>&nbsp;<span class="op" id="3589561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3589564">if</span>&nbsp;<span class="ident" id="3589567">w</span><span class="op" id="3589568">.</span><span class="ident" id="3589569">conn</span><span class="op" id="3589573">.</span><span class="ident" id="3589574">hijacked</span><span class="op" id="3589582">(</span><span class="op" id="3589583">)</span>&nbsp;<span class="op" id="3589585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589589">w</span><span class="op" id="3589590">.</span><span class="ident" id="3589591">conn</span><span class="op" id="3589595">.</span><span class="ident" id="3589596">server</span><span class="op" id="3589602">.</span><span class="ident" id="3589603">logf</span><span class="op" id="3589607">(</span><span class="string" id="3589608">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3589659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3589663">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3589671">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3589674">if</span>&nbsp;<span class="ident" id="3589677">w</span><span class="op" id="3589678">.</span><span class="ident" id="3589679">wroteHeader</span>&nbsp;<span class="op" id="3589691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589695">w</span><span class="op" id="3589696">.</span><span class="ident" id="3589697">conn</span><span class="op" id="3589701">.</span><span class="ident" id="3589702">server</span><span class="op" id="3589708">.</span><span class="ident" id="3589709">logf</span><span class="op" id="3589713">(</span><span class="string" id="3589714">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="3589757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3589761">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3589769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589772">w</span><span class="op" id="3589773">.</span><span class="ident" id="3589774">wroteHeader</span>&nbsp;<span class="op" id="3589786">=</span>&nbsp;<span class="ident" id="3589788">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589794">w</span><span class="op" id="3589795">.</span><span class="ident" id="3589796">status</span>&nbsp;<span class="op" id="3589803">=</span>&nbsp;<span class="ident" id="3589805">code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3589812">if</span>&nbsp;<span class="ident" id="3589815">w</span><span class="op" id="3589816">.</span><span class="ident" id="3589817">calledHeader</span>&nbsp;<span class="op" id="3589830">&amp;&amp;</span>&nbsp;<span class="ident" id="3589833">w</span><span class="op" id="3589834">.</span><span class="ident" id="3589835">cw</span><span class="op" id="3589837">.</span><span class="ident" id="3589838">header</span>&nbsp;<span class="op" id="3589845">==</span>&nbsp;<span class="ident" id="3589848">nil</span>&nbsp;<span class="op" id="3589852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589856">w</span><span class="op" id="3589857">.</span><span class="ident" id="3589858">cw</span><span class="op" id="3589860">.</span><span class="ident" id="3589861">header</span>&nbsp;<span class="op" id="3589868">=</span>&nbsp;<span class="ident" id="3589870">w</span><span class="op" id="3589871">.</span><span class="ident" id="3589872">handlerHeader</span><span class="op" id="3589885">.</span><span class="ident" id="3589886">clone</span><span class="op" id="3589891">(</span><span class="op" id="3589892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3589895">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3589899">if</span>&nbsp;<span class="ident" id="3589902">cl</span>&nbsp;<span class="op" id="3589905">:=</span>&nbsp;<span class="ident" id="3589908">w</span><span class="op" id="3589909">.</span><span class="ident" id="3589910">handlerHeader</span><span class="op" id="3589923">.</span><span class="ident" id="3589924">get</span><span class="op" id="3589927">(</span><span class="string" id="3589928">&#34;Content-Length&#34;</span><span class="op" id="3589944">)</span><span class="op" id="3589945">;</span>&nbsp;<span class="ident" id="3589947">cl</span>&nbsp;<span class="op" id="3589950">!=</span>&nbsp;<span class="string" id="3589953">&#34;&#34;</span>&nbsp;<span class="op" id="3589956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589960">v</span><span class="op" id="3589961">,</span>&nbsp;<span class="ident" id="3589963">err</span>&nbsp;<span class="op" id="3589967">:=</span>&nbsp;<span class="ident" id="3589970">strconv</span><span class="op" id="3589977">.</span><span class="ident" id="3589978">ParseInt</span><span class="op" id="3589986">(</span><span class="ident" id="3589987">cl</span><span class="op" id="3589989">,</span>&nbsp;<span class="num" id="3589991">10</span><span class="op" id="3589993">,</span>&nbsp;<span class="num" id="3589995">64</span><span class="op" id="3589997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3590001">if</span>&nbsp;<span class="ident" id="3590004">err</span>&nbsp;<span class="op" id="3590008">==</span>&nbsp;<span class="ident" id="3590011">nil</span>&nbsp;<span class="op" id="3590015">&amp;&amp;</span>&nbsp;<span class="ident" id="3590018">v</span>&nbsp;<span class="op" id="3590020">&gt;=</span>&nbsp;<span class="num" id="3590023">0</span>&nbsp;<span class="op" id="3590025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590030">w</span><span class="op" id="3590031">.</span><span class="ident" id="3590032">contentLength</span>&nbsp;<span class="op" id="3590046">=</span>&nbsp;<span class="ident" id="3590048">v</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3590052">}</span>&nbsp;<span class="keyword" id="3590054">else</span>&nbsp;<span class="op" id="3590059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590064">w</span><span class="op" id="3590065">.</span><span class="ident" id="3590066">conn</span><span class="op" id="3590070">.</span><span class="ident" id="3590071">server</span><span class="op" id="3590077">.</span><span class="ident" id="3590078">logf</span><span class="op" id="3590082">(</span><span class="string" id="3590083">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="3590119">,</span>&nbsp;<span class="ident" id="3590121">cl</span><span class="op" id="3590123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590128">w</span><span class="op" id="3590129">.</span><span class="ident" id="3590130">handlerHeader</span><span class="op" id="3590143">.</span><span class="ident" id="3590144">Del</span><span class="op" id="3590147">(</span><span class="string" id="3590148">&#34;Content-Length&#34;</span><span class="op" id="3590164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3590168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3590171">}</span><br>
<span class="lineno">655</span><span class="op" id="3590173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3590176">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="3590257">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="3590336">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="3590393">type</span>&nbsp;<span class="ident" id="3590398">extraHeader</span>&nbsp;<span class="keyword" id="3590410">struct</span>&nbsp;<span class="op" id="3590417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590420">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3590437">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590445">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3590462">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590470">transferEncoding</span>&nbsp;<span class="builtintype" id="3590487">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590495">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3590512">[</span><span class="op" id="3590513">]</span><span class="builtintype" id="3590514">byte</span>&nbsp;<span class="comment" id="3590519">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590542">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3590559">[</span><span class="op" id="3590560">]</span><span class="builtintype" id="3590561">byte</span>&nbsp;<span class="comment" id="3590566">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3590588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3590591">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="3590639">var</span>&nbsp;<span class="ident" id="3590643">extraHeaderKeys</span>&nbsp;<span class="op" id="3590659">=</span>&nbsp;<span class="op" id="3590661">[</span><span class="op" id="3590662">]</span><span class="op" id="3590663">[</span><span class="op" id="3590664">]</span><span class="builtintype" id="3590665">byte</span><span class="op" id="3590669">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3590672">[</span><span class="op" id="3590673">]</span><span class="builtintype" id="3590674">byte</span><span class="op" id="3590678">(</span><span class="string" id="3590679">&#34;Content-Type&#34;</span><span class="op" id="3590693">)</span><span class="op" id="3590694">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3590697">[</span><span class="op" id="3590698">]</span><span class="builtintype" id="3590699">byte</span><span class="op" id="3590703">(</span><span class="string" id="3590704">&#34;Connection&#34;</span><span class="op" id="3590716">)</span><span class="op" id="3590717">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3590720">[</span><span class="op" id="3590721">]</span><span class="builtintype" id="3590722">byte</span><span class="op" id="3590726">(</span><span class="string" id="3590727">&#34;Transfer-Encoding&#34;</span><span class="op" id="3590746">)</span><span class="op" id="3590747">,</span><br>
<span class="lineno"></span><span class="op" id="3590749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="3590752">var</span>&nbsp;<span class="op" id="3590756">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590759">headerContentLength</span>&nbsp;<span class="op" id="3590779">=</span>&nbsp;<span class="op" id="3590781">[</span><span class="op" id="3590782">]</span><span class="builtintype" id="3590783">byte</span><span class="op" id="3590787">(</span><span class="string" id="3590788">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3590806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590809">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3590829">=</span>&nbsp;<span class="op" id="3590831">[</span><span class="op" id="3590832">]</span><span class="builtintype" id="3590833">byte</span><span class="op" id="3590837">(</span><span class="string" id="3590838">&#34;Date:&nbsp;&#34;</span><span class="op" id="3590846">)</span><br>
<span class="lineno"></span><span class="op" id="3590848">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="3590851">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="3590900">//</span><br>
<span class="lineno"></span><span class="comment" id="3590903">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="3590972">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3591042">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="3591101">func</span>&nbsp;<span class="op" id="3591106">(</span><span class="ident" id="3591107">h</span>&nbsp;<span class="ident" id="3591109">extraHeader</span><span class="op" id="3591120">)</span>&nbsp;<span class="ident" id="3591122">Write</span><span class="op" id="3591127">(</span><span class="ident" id="3591128">w</span>&nbsp;<span class="op" id="3591130">*</span><span class="ident" id="3591131">bufio</span><span class="op" id="3591136">.</span><span class="ident" id="3591137">Writer</span><span class="op" id="3591143">)</span>&nbsp;<span class="op" id="3591145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3591148">if</span>&nbsp;<span class="ident" id="3591151">h</span><span class="op" id="3591152">.</span><span class="ident" id="3591153">date</span>&nbsp;<span class="op" id="3591158">!=</span>&nbsp;<span class="ident" id="3591161">nil</span>&nbsp;<span class="op" id="3591165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591169">w</span><span class="op" id="3591170">.</span><span class="ident" id="3591171">Write</span><span class="op" id="3591176">(</span><span class="ident" id="3591177">headerDate</span><span class="op" id="3591187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591191">w</span><span class="op" id="3591192">.</span><span class="ident" id="3591193">Write</span><span class="op" id="3591198">(</span><span class="ident" id="3591199">h</span><span class="op" id="3591200">.</span><span class="ident" id="3591201">date</span><span class="op" id="3591205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591209">w</span><span class="op" id="3591210">.</span><span class="ident" id="3591211">Write</span><span class="op" id="3591216">(</span><span class="ident" id="3591217">crlf</span><span class="op" id="3591221">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3591224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3591227">if</span>&nbsp;<span class="ident" id="3591230">h</span><span class="op" id="3591231">.</span><span class="ident" id="3591232">contentLength</span>&nbsp;<span class="op" id="3591246">!=</span>&nbsp;<span class="ident" id="3591249">nil</span>&nbsp;<span class="op" id="3591253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591257">w</span><span class="op" id="3591258">.</span><span class="ident" id="3591259">Write</span><span class="op" id="3591264">(</span><span class="ident" id="3591265">headerContentLength</span><span class="op" id="3591284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591288">w</span><span class="op" id="3591289">.</span><span class="ident" id="3591290">Write</span><span class="op" id="3591295">(</span><span class="ident" id="3591296">h</span><span class="op" id="3591297">.</span><span class="ident" id="3591298">contentLength</span><span class="op" id="3591311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591315">w</span><span class="op" id="3591316">.</span><span class="ident" id="3591317">Write</span><span class="op" id="3591322">(</span><span class="ident" id="3591323">crlf</span><span class="op" id="3591327">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3591330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3591333">for</span>&nbsp;<span class="ident" id="3591337">i</span><span class="op" id="3591338">,</span>&nbsp;<span class="ident" id="3591340">v</span>&nbsp;<span class="op" id="3591342">:=</span>&nbsp;<span class="keyword" id="3591345">range</span>&nbsp;<span class="op" id="3591351">[</span><span class="op" id="3591352">]</span><span class="builtintype" id="3591353">string</span><span class="op" id="3591359">{</span><span class="ident" id="3591360">h</span><span class="op" id="3591361">.</span><span class="ident" id="3591362">contentType</span><span class="op" id="3591373">,</span>&nbsp;<span class="ident" id="3591375">h</span><span class="op" id="3591376">.</span><span class="ident" id="3591377">connection</span><span class="op" id="3591387">,</span>&nbsp;<span class="ident" id="3591389">h</span><span class="op" id="3591390">.</span><span class="ident" id="3591391">transferEncoding</span><span class="op" id="3591407">}</span>&nbsp;<span class="op" id="3591409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3591413">if</span>&nbsp;<span class="ident" id="3591416">v</span>&nbsp;<span class="op" id="3591418">!=</span>&nbsp;<span class="string" id="3591421">&#34;&#34;</span>&nbsp;<span class="op" id="3591424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591429">w</span><span class="op" id="3591430">.</span><span class="ident" id="3591431">Write</span><span class="op" id="3591436">(</span><span class="ident" id="3591437">extraHeaderKeys</span><span class="op" id="3591452">[</span><span class="ident" id="3591453">i</span><span class="op" id="3591454">]</span><span class="op" id="3591455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591460">w</span><span class="op" id="3591461">.</span><span class="ident" id="3591462">Write</span><span class="op" id="3591467">(</span><span class="ident" id="3591468">colonSpace</span><span class="op" id="3591478">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591483">w</span><span class="op" id="3591484">.</span><span class="ident" id="3591485">WriteString</span><span class="op" id="3591496">(</span><span class="ident" id="3591497">v</span><span class="op" id="3591498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591503">w</span><span class="op" id="3591504">.</span><span class="ident" id="3591505">Write</span><span class="op" id="3591510">(</span><span class="ident" id="3591511">crlf</span><span class="op" id="3591515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3591519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3591522">}</span><br>
<span class="lineno"></span><span class="op" id="3591524">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="3591527">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3591596">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="3591619">//</span><br>
<span class="lineno"></span><span class="comment" id="3591622">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="3591693">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3591763">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3591832">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3591898">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="3591910">func</span>&nbsp;<span class="op" id="3591915">(</span><span class="ident" id="3591916">cw</span>&nbsp;<span class="op" id="3591919">*</span><span class="ident" id="3591920">chunkWriter</span><span class="op" id="3591931">)</span>&nbsp;<span class="ident" id="3591933">writeHeader</span><span class="op" id="3591944">(</span><span class="ident" id="3591945">p</span>&nbsp;<span class="op" id="3591947">[</span><span class="op" id="3591948">]</span><span class="builtintype" id="3591949">byte</span><span class="op" id="3591953">)</span>&nbsp;<span class="op" id="3591955">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3591958">if</span>&nbsp;<span class="ident" id="3591961">cw</span><span class="op" id="3591963">.</span><span class="ident" id="3591964">wroteHeader</span>&nbsp;<span class="op" id="3591976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3591980">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3591988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591991">cw</span><span class="op" id="3591993">.</span><span class="ident" id="3591994">wroteHeader</span>&nbsp;<span class="op" id="3592006">=</span>&nbsp;<span class="ident" id="3592008">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592015">w</span>&nbsp;<span class="op" id="3592017">:=</span>&nbsp;<span class="ident" id="3592020">cw</span><span class="op" id="3592022">.</span><span class="ident" id="3592023">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592028">keepAlivesEnabled</span>&nbsp;<span class="op" id="3592046">:=</span>&nbsp;<span class="ident" id="3592049">w</span><span class="op" id="3592050">.</span><span class="ident" id="3592051">conn</span><span class="op" id="3592055">.</span><span class="ident" id="3592056">server</span><span class="op" id="3592062">.</span><span class="ident" id="3592063">doKeepAlives</span><span class="op" id="3592075">(</span><span class="op" id="3592076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592079">isHEAD</span>&nbsp;<span class="op" id="3592086">:=</span>&nbsp;<span class="ident" id="3592089">w</span><span class="op" id="3592090">.</span><span class="ident" id="3592091">req</span><span class="op" id="3592094">.</span><span class="ident" id="3592095">Method</span>&nbsp;<span class="op" id="3592102">==</span>&nbsp;<span class="string" id="3592105">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592114">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592178">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592240">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592296">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592358">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592386">header</span>&nbsp;<span class="op" id="3592393">:=</span>&nbsp;<span class="ident" id="3592396">cw</span><span class="op" id="3592398">.</span><span class="ident" id="3592399">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592407">owned</span>&nbsp;<span class="op" id="3592413">:=</span>&nbsp;<span class="ident" id="3592416">header</span>&nbsp;<span class="op" id="3592423">!=</span>&nbsp;<span class="ident" id="3592426">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592431">if</span>&nbsp;<span class="op" id="3592434">!</span><span class="ident" id="3592435">owned</span>&nbsp;<span class="op" id="3592441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592445">header</span>&nbsp;<span class="op" id="3592452">=</span>&nbsp;<span class="ident" id="3592454">w</span><span class="op" id="3592455">.</span><span class="ident" id="3592456">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592474">var</span>&nbsp;<span class="ident" id="3592478">excludeHeader</span>&nbsp;<span class="keyword" id="3592492">map</span><span class="op" id="3592495">[</span><span class="builtintype" id="3592496">string</span><span class="op" id="3592502">]</span><span class="builtintype" id="3592503">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592509">delHeader</span>&nbsp;<span class="op" id="3592519">:=</span>&nbsp;<span class="keyword" id="3592522">func</span><span class="op" id="3592526">(</span><span class="ident" id="3592527">key</span>&nbsp;<span class="builtintype" id="3592531">string</span><span class="op" id="3592537">)</span>&nbsp;<span class="op" id="3592539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592543">if</span>&nbsp;<span class="ident" id="3592546">owned</span>&nbsp;<span class="op" id="3592552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592557">header</span><span class="op" id="3592563">.</span><span class="ident" id="3592564">Del</span><span class="op" id="3592567">(</span><span class="ident" id="3592568">key</span><span class="op" id="3592571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592576">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592585">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592589">if</span>&nbsp;<span class="ident" id="3592592">_</span><span class="op" id="3592593">,</span>&nbsp;<span class="ident" id="3592595">ok</span>&nbsp;<span class="op" id="3592598">:=</span>&nbsp;<span class="ident" id="3592601">header</span><span class="op" id="3592607">[</span><span class="ident" id="3592608">key</span><span class="op" id="3592611">]</span><span class="op" id="3592612">;</span>&nbsp;<span class="op" id="3592614">!</span><span class="ident" id="3592615">ok</span>&nbsp;<span class="op" id="3592618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592623">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592636">if</span>&nbsp;<span class="ident" id="3592639">excludeHeader</span>&nbsp;<span class="op" id="3592653">==</span>&nbsp;<span class="ident" id="3592656">nil</span>&nbsp;<span class="op" id="3592660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592665">excludeHeader</span>&nbsp;<span class="op" id="3592679">=</span>&nbsp;<span class="builtinfunc" id="3592681">make</span><span class="op" id="3592685">(</span><span class="keyword" id="3592686">map</span><span class="op" id="3592689">[</span><span class="builtintype" id="3592690">string</span><span class="op" id="3592696">]</span><span class="builtintype" id="3592697">bool</span><span class="op" id="3592701">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592709">excludeHeader</span><span class="op" id="3592722">[</span><span class="ident" id="3592723">key</span><span class="op" id="3592726">]</span>&nbsp;<span class="op" id="3592728">=</span>&nbsp;<span class="ident" id="3592730">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592739">var</span>&nbsp;<span class="ident" id="3592743">setHeader</span>&nbsp;<span class="ident" id="3592753">extraHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592767">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592826">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592890">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592951">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592987">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3593058">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3593122">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3593184">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3593248">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3593312">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3593372">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3593434">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593468">if</span>&nbsp;<span class="ident" id="3593471">w</span><span class="op" id="3593472">.</span><span class="ident" id="3593473">handlerDone</span>&nbsp;<span class="op" id="3593485">&amp;&amp;</span>&nbsp;<span class="ident" id="3593488">bodyAllowedForStatus</span><span class="op" id="3593508">(</span><span class="ident" id="3593509">w</span><span class="op" id="3593510">.</span><span class="ident" id="3593511">status</span><span class="op" id="3593517">)</span>&nbsp;<span class="op" id="3593519">&amp;&amp;</span>&nbsp;<span class="ident" id="3593522">header</span><span class="op" id="3593528">.</span><span class="ident" id="3593529">get</span><span class="op" id="3593532">(</span><span class="string" id="3593533">&#34;Content-Length&#34;</span><span class="op" id="3593549">)</span>&nbsp;<span class="op" id="3593551">==</span>&nbsp;<span class="string" id="3593554">&#34;&#34;</span>&nbsp;<span class="op" id="3593557">&amp;&amp;</span>&nbsp;<span class="op" id="3593560">(</span><span class="op" id="3593561">!</span><span class="ident" id="3593562">isHEAD</span>&nbsp;<span class="op" id="3593569">||</span>&nbsp;<span class="builtinfunc" id="3593572">len</span><span class="op" id="3593575">(</span><span class="ident" id="3593576">p</span><span class="op" id="3593577">)</span>&nbsp;<span class="op" id="3593579">&gt;</span>&nbsp;<span class="num" id="3593581">0</span><span class="op" id="3593582">)</span>&nbsp;<span class="op" id="3593584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3593588">w</span><span class="op" id="3593589">.</span><span class="ident" id="3593590">contentLength</span>&nbsp;<span class="op" id="3593604">=</span>&nbsp;<span class="ident" id="3593606">int64</span><span class="op" id="3593611">(</span><span class="builtinfunc" id="3593612">len</span><span class="op" id="3593615">(</span><span class="ident" id="3593616">p</span><span class="op" id="3593617">)</span><span class="op" id="3593618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3593622">setHeader</span><span class="op" id="3593631">.</span><span class="ident" id="3593632">contentLength</span>&nbsp;<span class="op" id="3593646">=</span>&nbsp;<span class="ident" id="3593648">strconv</span><span class="op" id="3593655">.</span><span class="ident" id="3593656">AppendInt</span><span class="op" id="3593665">(</span><span class="ident" id="3593666">cw</span><span class="op" id="3593668">.</span><span class="ident" id="3593669">res</span><span class="op" id="3593672">.</span><span class="ident" id="3593673">clenBuf</span><span class="op" id="3593680">[</span><span class="op" id="3593681">:</span><span class="num" id="3593682">0</span><span class="op" id="3593683">]</span><span class="op" id="3593684">,</span>&nbsp;<span class="ident" id="3593686">int64</span><span class="op" id="3593691">(</span><span class="builtinfunc" id="3593692">len</span><span class="op" id="3593695">(</span><span class="ident" id="3593696">p</span><span class="op" id="3593697">)</span><span class="op" id="3593698">)</span><span class="op" id="3593699">,</span>&nbsp;<span class="num" id="3593701">10</span><span class="op" id="3593703">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3593706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3593710">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3593776">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593844">if</span>&nbsp;<span class="ident" id="3593847">w</span><span class="op" id="3593848">.</span><span class="ident" id="3593849">req</span><span class="op" id="3593852">.</span><span class="ident" id="3593853">wantsHttp10KeepAlive</span><span class="op" id="3593873">(</span><span class="op" id="3593874">)</span>&nbsp;<span class="op" id="3593876">&amp;&amp;</span>&nbsp;<span class="ident" id="3593879">keepAlivesEnabled</span>&nbsp;<span class="op" id="3593897">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3593901">sentLength</span>&nbsp;<span class="op" id="3593912">:=</span>&nbsp;<span class="ident" id="3593915">header</span><span class="op" id="3593921">.</span><span class="ident" id="3593922">get</span><span class="op" id="3593925">(</span><span class="string" id="3593926">&#34;Content-Length&#34;</span><span class="op" id="3593942">)</span>&nbsp;<span class="op" id="3593944">!=</span>&nbsp;<span class="string" id="3593947">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593952">if</span>&nbsp;<span class="ident" id="3593955">sentLength</span>&nbsp;<span class="op" id="3593966">&amp;&amp;</span>&nbsp;<span class="ident" id="3593969">header</span><span class="op" id="3593975">.</span><span class="ident" id="3593976">get</span><span class="op" id="3593979">(</span><span class="string" id="3593980">&#34;Connection&#34;</span><span class="op" id="3593992">)</span>&nbsp;<span class="op" id="3593994">==</span>&nbsp;<span class="string" id="3593997">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="3594010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594015">w</span><span class="op" id="3594016">.</span><span class="ident" id="3594017">closeAfterReply</span>&nbsp;<span class="op" id="3594033">=</span>&nbsp;<span class="ident" id="3594035">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3594043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3594046">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3594050">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594110">hasCL</span>&nbsp;<span class="op" id="3594116">:=</span>&nbsp;<span class="ident" id="3594119">w</span><span class="op" id="3594120">.</span><span class="ident" id="3594121">contentLength</span>&nbsp;<span class="op" id="3594135">!=</span>&nbsp;<span class="op" id="3594138">-</span><span class="num" id="3594139">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3594143">if</span>&nbsp;<span class="ident" id="3594146">w</span><span class="op" id="3594147">.</span><span class="ident" id="3594148">req</span><span class="op" id="3594151">.</span><span class="ident" id="3594152">wantsHttp10KeepAlive</span><span class="op" id="3594172">(</span><span class="op" id="3594173">)</span>&nbsp;<span class="op" id="3594175">&amp;&amp;</span>&nbsp;<span class="op" id="3594178">(</span><span class="ident" id="3594179">isHEAD</span>&nbsp;<span class="op" id="3594186">||</span>&nbsp;<span class="ident" id="3594189">hasCL</span><span class="op" id="3594194">)</span>&nbsp;<span class="op" id="3594196">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594200">_</span><span class="op" id="3594201">,</span>&nbsp;<span class="ident" id="3594203">connectionHeaderSet</span>&nbsp;<span class="op" id="3594223">:=</span>&nbsp;<span class="ident" id="3594226">header</span><span class="op" id="3594232">[</span><span class="string" id="3594233">&#34;Connection&#34;</span><span class="op" id="3594245">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3594249">if</span>&nbsp;<span class="op" id="3594252">!</span><span class="ident" id="3594253">connectionHeaderSet</span>&nbsp;<span class="op" id="3594273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594278">setHeader</span><span class="op" id="3594287">.</span><span class="ident" id="3594288">connection</span>&nbsp;<span class="op" id="3594299">=</span>&nbsp;<span class="string" id="3594301">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3594316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3594319">}</span>&nbsp;<span class="keyword" id="3594321">else</span>&nbsp;<span class="keyword" id="3594326">if</span>&nbsp;<span class="op" id="3594329">!</span><span class="ident" id="3594330">w</span><span class="op" id="3594331">.</span><span class="ident" id="3594332">req</span><span class="op" id="3594335">.</span><span class="ident" id="3594336">ProtoAtLeast</span><span class="op" id="3594348">(</span><span class="num" id="3594349">1</span><span class="op" id="3594350">,</span>&nbsp;<span class="num" id="3594352">1</span><span class="op" id="3594353">)</span>&nbsp;<span class="op" id="3594355">||</span>&nbsp;<span class="ident" id="3594358">w</span><span class="op" id="3594359">.</span><span class="ident" id="3594360">req</span><span class="op" id="3594363">.</span><span class="ident" id="3594364">wantsClose</span><span class="op" id="3594374">(</span><span class="op" id="3594375">)</span>&nbsp;<span class="op" id="3594377">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594381">w</span><span class="op" id="3594382">.</span><span class="ident" id="3594383">closeAfterReply</span>&nbsp;<span class="op" id="3594399">=</span>&nbsp;<span class="ident" id="3594401">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3594407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3594411">if</span>&nbsp;<span class="ident" id="3594414">header</span><span class="op" id="3594420">.</span><span class="ident" id="3594421">get</span><span class="op" id="3594424">(</span><span class="string" id="3594425">&#34;Connection&#34;</span><span class="op" id="3594437">)</span>&nbsp;<span class="op" id="3594439">==</span>&nbsp;<span class="string" id="3594442">&#34;close&#34;</span>&nbsp;<span class="op" id="3594450">||</span>&nbsp;<span class="op" id="3594453">!</span><span class="ident" id="3594454">keepAlivesEnabled</span>&nbsp;<span class="op" id="3594472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594476">w</span><span class="op" id="3594477">.</span><span class="ident" id="3594478">closeAfterReply</span>&nbsp;<span class="op" id="3594494">=</span>&nbsp;<span class="ident" id="3594496">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3594502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3594506">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3594566">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3594627">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3594688">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3594739">if</span>&nbsp;<span class="ident" id="3594742">w</span><span class="op" id="3594743">.</span><span class="ident" id="3594744">req</span><span class="op" id="3594747">.</span><span class="ident" id="3594748">ContentLength</span>&nbsp;<span class="op" id="3594762">!=</span>&nbsp;<span class="num" id="3594765">0</span>&nbsp;<span class="op" id="3594767">&amp;&amp;</span>&nbsp;<span class="op" id="3594770">!</span><span class="ident" id="3594771">w</span><span class="op" id="3594772">.</span><span class="ident" id="3594773">closeAfterReply</span>&nbsp;<span class="op" id="3594789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594793">ecr</span><span class="op" id="3594796">,</span>&nbsp;<span class="ident" id="3594798">isExpecter</span>&nbsp;<span class="op" id="3594809">:=</span>&nbsp;<span class="ident" id="3594812">w</span><span class="op" id="3594813">.</span><span class="ident" id="3594814">req</span><span class="op" id="3594817">.</span><span class="ident" id="3594818">Body</span><span class="op" id="3594822">.</span><span class="op" id="3594823">(</span><span class="op" id="3594824">*</span><span class="ident" id="3594825">expectContinueReader</span><span class="op" id="3594845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3594849">if</span>&nbsp;<span class="op" id="3594852">!</span><span class="ident" id="3594853">isExpecter</span>&nbsp;<span class="op" id="3594864">||</span>&nbsp;<span class="ident" id="3594867">ecr</span><span class="op" id="3594870">.</span><span class="ident" id="3594871">resp</span><span class="op" id="3594875">.</span><span class="ident" id="3594876">wroteContinue</span>&nbsp;<span class="op" id="3594890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594895">n</span><span class="op" id="3594896">,</span>&nbsp;<span class="ident" id="3594898">_</span>&nbsp;<span class="op" id="3594900">:=</span>&nbsp;<span class="ident" id="3594903">io</span><span class="op" id="3594905">.</span><span class="ident" id="3594906">CopyN</span><span class="op" id="3594911">(</span><span class="ident" id="3594912">ioutil</span><span class="op" id="3594918">.</span><span class="ident" id="3594919">Discard</span><span class="op" id="3594926">,</span>&nbsp;<span class="ident" id="3594928">w</span><span class="op" id="3594929">.</span><span class="ident" id="3594930">req</span><span class="op" id="3594933">.</span><span class="ident" id="3594934">Body</span><span class="op" id="3594938">,</span>&nbsp;<span class="ident" id="3594940">maxPostHandlerReadBytes</span><span class="op" id="3594963">+</span><span class="num" id="3594964">1</span><span class="op" id="3594965">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3594970">if</span>&nbsp;<span class="ident" id="3594973">n</span>&nbsp;<span class="op" id="3594975">&gt;=</span>&nbsp;<span class="ident" id="3594978">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3595002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595008">w</span><span class="op" id="3595009">.</span><span class="ident" id="3595010">requestTooLarge</span><span class="op" id="3595025">(</span><span class="op" id="3595026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595032">delHeader</span><span class="op" id="3595041">(</span><span class="string" id="3595042">&#34;Connection&#34;</span><span class="op" id="3595054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595060">setHeader</span><span class="op" id="3595069">.</span><span class="ident" id="3595070">connection</span>&nbsp;<span class="op" id="3595081">=</span>&nbsp;<span class="string" id="3595083">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3595094">}</span>&nbsp;<span class="keyword" id="3595096">else</span>&nbsp;<span class="op" id="3595101">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595107">w</span><span class="op" id="3595108">.</span><span class="ident" id="3595109">req</span><span class="op" id="3595112">.</span><span class="ident" id="3595113">Body</span><span class="op" id="3595117">.</span><span class="ident" id="3595118">Close</span><span class="op" id="3595123">(</span><span class="op" id="3595124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3595129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3595133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3595136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595140">code</span>&nbsp;<span class="op" id="3595145">:=</span>&nbsp;<span class="ident" id="3595148">w</span><span class="op" id="3595149">.</span><span class="ident" id="3595150">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3595158">if</span>&nbsp;<span class="ident" id="3595161">bodyAllowedForStatus</span><span class="op" id="3595181">(</span><span class="ident" id="3595182">code</span><span class="op" id="3595186">)</span>&nbsp;<span class="op" id="3595188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3595192">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595251">_</span><span class="op" id="3595252">,</span>&nbsp;<span class="ident" id="3595254">haveType</span>&nbsp;<span class="op" id="3595263">:=</span>&nbsp;<span class="ident" id="3595266">header</span><span class="op" id="3595272">[</span><span class="string" id="3595273">&#34;Content-Type&#34;</span><span class="op" id="3595287">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3595291">if</span>&nbsp;<span class="op" id="3595294">!</span><span class="ident" id="3595295">haveType</span>&nbsp;<span class="op" id="3595304">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595309">setHeader</span><span class="op" id="3595318">.</span><span class="ident" id="3595319">contentType</span>&nbsp;<span class="op" id="3595331">=</span>&nbsp;<span class="ident" id="3595333">DetectContentType</span><span class="op" id="3595350">(</span><span class="ident" id="3595351">p</span><span class="op" id="3595352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3595356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3595359">}</span>&nbsp;<span class="keyword" id="3595361">else</span>&nbsp;<span class="op" id="3595366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3595370">for</span>&nbsp;<span class="ident" id="3595374">_</span><span class="op" id="3595375">,</span>&nbsp;<span class="ident" id="3595377">k</span>&nbsp;<span class="op" id="3595379">:=</span>&nbsp;<span class="keyword" id="3595382">range</span>&nbsp;<span class="ident" id="3595388">suppressedHeaders</span><span class="op" id="3595405">(</span><span class="ident" id="3595406">code</span><span class="op" id="3595410">)</span>&nbsp;<span class="op" id="3595412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595417">delHeader</span><span class="op" id="3595426">(</span><span class="ident" id="3595427">k</span><span class="op" id="3595428">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3595432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3595435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3595439">if</span>&nbsp;<span class="ident" id="3595442">_</span><span class="op" id="3595443">,</span>&nbsp;<span class="ident" id="3595445">ok</span>&nbsp;<span class="op" id="3595448">:=</span>&nbsp;<span class="ident" id="3595451">header</span><span class="op" id="3595457">[</span><span class="string" id="3595458">&#34;Date&#34;</span><span class="op" id="3595464">]</span><span class="op" id="3595465">;</span>&nbsp;<span class="op" id="3595467">!</span><span class="ident" id="3595468">ok</span>&nbsp;<span class="op" id="3595471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595475">setHeader</span><span class="op" id="3595484">.</span><span class="ident" id="3595485">date</span>&nbsp;<span class="op" id="3595490">=</span>&nbsp;<span class="ident" id="3595492">appendTime</span><span class="op" id="3595502">(</span><span class="ident" id="3595503">cw</span><span class="op" id="3595505">.</span><span class="ident" id="3595506">res</span><span class="op" id="3595509">.</span><span class="ident" id="3595510">dateBuf</span><span class="op" id="3595517">[</span><span class="op" id="3595518">:</span><span class="num" id="3595519">0</span><span class="op" id="3595520">]</span><span class="op" id="3595521">,</span>&nbsp;<span class="ident" id="3595523">time</span><span class="op" id="3595527">.</span><span class="ident" id="3595528">Now</span><span class="op" id="3595531">(</span><span class="op" id="3595532">)</span><span class="op" id="3595533">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3595536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595540">te</span>&nbsp;<span class="op" id="3595543">:=</span>&nbsp;<span class="ident" id="3595546">header</span><span class="op" id="3595552">.</span><span class="ident" id="3595553">get</span><span class="op" id="3595556">(</span><span class="string" id="3595557">&#34;Transfer-Encoding&#34;</span><span class="op" id="3595576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595579">hasTE</span>&nbsp;<span class="op" id="3595585">:=</span>&nbsp;<span class="ident" id="3595588">te</span>&nbsp;<span class="op" id="3595591">!=</span>&nbsp;<span class="string" id="3595594">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3595598">if</span>&nbsp;<span class="ident" id="3595601">hasCL</span>&nbsp;<span class="op" id="3595607">&amp;&amp;</span>&nbsp;<span class="ident" id="3595610">hasTE</span>&nbsp;<span class="op" id="3595616">&amp;&amp;</span>&nbsp;<span class="ident" id="3595619">te</span>&nbsp;<span class="op" id="3595622">!=</span>&nbsp;<span class="string" id="3595625">&#34;identity&#34;</span>&nbsp;<span class="op" id="3595636">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3595640">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3595706">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595751">w</span><span class="op" id="3595752">.</span><span class="ident" id="3595753">conn</span><span class="op" id="3595757">.</span><span class="ident" id="3595758">server</span><span class="op" id="3595764">.</span><span class="ident" id="3595765">logf</span><span class="op" id="3595769">(</span><span class="string" id="3595770">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="3595857">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595862">te</span><span class="op" id="3595864">,</span>&nbsp;<span class="ident" id="3595866">w</span><span class="op" id="3595867">.</span><span class="ident" id="3595868">contentLength</span><span class="op" id="3595881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595885">delHeader</span><span class="op" id="3595894">(</span><span class="string" id="3595895">&#34;Content-Length&#34;</span><span class="op" id="3595911">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595915">hasCL</span>&nbsp;<span class="op" id="3595921">=</span>&nbsp;<span class="ident" id="3595923">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3595930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3595934">if</span>&nbsp;<span class="ident" id="3595937">w</span><span class="op" id="3595938">.</span><span class="ident" id="3595939">req</span><span class="op" id="3595942">.</span><span class="ident" id="3595943">Method</span>&nbsp;<span class="op" id="3595950">==</span>&nbsp;<span class="string" id="3595953">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3595960">||</span>&nbsp;<span class="op" id="3595963">!</span><span class="ident" id="3595964">bodyAllowedForStatus</span><span class="op" id="3595984">(</span><span class="ident" id="3595985">code</span><span class="op" id="3595989">)</span>&nbsp;<span class="op" id="3595991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3595995">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596010">}</span>&nbsp;<span class="keyword" id="3596012">else</span>&nbsp;<span class="keyword" id="3596017">if</span>&nbsp;<span class="ident" id="3596020">code</span>&nbsp;<span class="op" id="3596025">==</span>&nbsp;<span class="ident" id="3596028">StatusNoContent</span>&nbsp;<span class="op" id="3596044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596048">delHeader</span><span class="op" id="3596057">(</span><span class="string" id="3596058">&#34;Transfer-Encoding&#34;</span><span class="op" id="3596077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596080">}</span>&nbsp;<span class="keyword" id="3596082">else</span>&nbsp;<span class="keyword" id="3596087">if</span>&nbsp;<span class="ident" id="3596090">hasCL</span>&nbsp;<span class="op" id="3596096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596100">delHeader</span><span class="op" id="3596109">(</span><span class="string" id="3596110">&#34;Transfer-Encoding&#34;</span><span class="op" id="3596129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596132">}</span>&nbsp;<span class="keyword" id="3596134">else</span>&nbsp;<span class="keyword" id="3596139">if</span>&nbsp;<span class="ident" id="3596142">w</span><span class="op" id="3596143">.</span><span class="ident" id="3596144">req</span><span class="op" id="3596147">.</span><span class="ident" id="3596148">ProtoAtLeast</span><span class="op" id="3596160">(</span><span class="num" id="3596161">1</span><span class="op" id="3596162">,</span>&nbsp;<span class="num" id="3596164">1</span><span class="op" id="3596165">)</span>&nbsp;<span class="op" id="3596167">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3596171">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3596249">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3596328">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3596400">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3596472">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3596488">if</span>&nbsp;<span class="ident" id="3596491">hasTE</span>&nbsp;<span class="op" id="3596497">&amp;&amp;</span>&nbsp;<span class="ident" id="3596500">te</span>&nbsp;<span class="op" id="3596503">==</span>&nbsp;<span class="string" id="3596506">&#34;identity&#34;</span>&nbsp;<span class="op" id="3596517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596522">cw</span><span class="op" id="3596524">.</span><span class="ident" id="3596525">chunking</span>&nbsp;<span class="op" id="3596534">=</span>&nbsp;<span class="ident" id="3596536">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596545">w</span><span class="op" id="3596546">.</span><span class="ident" id="3596547">closeAfterReply</span>&nbsp;<span class="op" id="3596563">=</span>&nbsp;<span class="ident" id="3596565">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596572">}</span>&nbsp;<span class="keyword" id="3596574">else</span>&nbsp;<span class="op" id="3596579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3596584">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3596641">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596687">cw</span><span class="op" id="3596689">.</span><span class="ident" id="3596690">chunking</span>&nbsp;<span class="op" id="3596699">=</span>&nbsp;<span class="ident" id="3596701">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596709">setHeader</span><span class="op" id="3596718">.</span><span class="ident" id="3596719">transferEncoding</span>&nbsp;<span class="op" id="3596736">=</span>&nbsp;<span class="string" id="3596738">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596753">}</span>&nbsp;<span class="keyword" id="3596755">else</span>&nbsp;<span class="op" id="3596760">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3596764">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3596816">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3596870">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596909">w</span><span class="op" id="3596910">.</span><span class="ident" id="3596911">closeAfterReply</span>&nbsp;<span class="op" id="3596927">=</span>&nbsp;<span class="ident" id="3596929">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596936">delHeader</span><span class="op" id="3596945">(</span><span class="string" id="3596946">&#34;Transfer-Encoding&#34;</span><span class="op" id="3596965">)</span>&nbsp;<span class="comment" id="3596967">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3596995">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3597062">if</span>&nbsp;<span class="ident" id="3597065">cw</span><span class="op" id="3597067">.</span><span class="ident" id="3597068">chunking</span>&nbsp;<span class="op" id="3597077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3597081">delHeader</span><span class="op" id="3597090">(</span><span class="string" id="3597091">&#34;Content-Length&#34;</span><span class="op" id="3597107">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3597110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3597113">if</span>&nbsp;<span class="op" id="3597116">!</span><span class="ident" id="3597117">w</span><span class="op" id="3597118">.</span><span class="ident" id="3597119">req</span><span class="op" id="3597122">.</span><span class="ident" id="3597123">ProtoAtLeast</span><span class="op" id="3597135">(</span><span class="num" id="3597136">1</span><span class="op" id="3597137">,</span>&nbsp;<span class="num" id="3597139">0</span><span class="op" id="3597140">)</span>&nbsp;<span class="op" id="3597142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3597146">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3597154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3597158">if</span>&nbsp;<span class="ident" id="3597161">w</span><span class="op" id="3597162">.</span><span class="ident" id="3597163">closeAfterReply</span>&nbsp;<span class="op" id="3597179">&amp;&amp;</span>&nbsp;<span class="op" id="3597182">(</span><span class="op" id="3597183">!</span><span class="ident" id="3597184">keepAlivesEnabled</span>&nbsp;<span class="op" id="3597202">||</span>&nbsp;<span class="op" id="3597205">!</span><span class="ident" id="3597206">hasToken</span><span class="op" id="3597214">(</span><span class="ident" id="3597215">cw</span><span class="op" id="3597217">.</span><span class="ident" id="3597218">header</span><span class="op" id="3597224">.</span><span class="ident" id="3597225">get</span><span class="op" id="3597228">(</span><span class="string" id="3597229">&#34;Connection&#34;</span><span class="op" id="3597241">)</span><span class="op" id="3597242">,</span>&nbsp;<span class="string" id="3597244">&#34;close&#34;</span><span class="op" id="3597251">)</span><span class="op" id="3597252">)</span>&nbsp;<span class="op" id="3597254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3597258">delHeader</span><span class="op" id="3597267">(</span><span class="string" id="3597268">&#34;Connection&#34;</span><span class="op" id="3597280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3597284">if</span>&nbsp;<span class="ident" id="3597287">w</span><span class="op" id="3597288">.</span><span class="ident" id="3597289">req</span><span class="op" id="3597292">.</span><span class="ident" id="3597293">ProtoAtLeast</span><span class="op" id="3597305">(</span><span class="num" id="3597306">1</span><span class="op" id="3597307">,</span>&nbsp;<span class="num" id="3597309">1</span><span class="op" id="3597310">)</span>&nbsp;<span class="op" id="3597312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3597317">setHeader</span><span class="op" id="3597326">.</span><span class="ident" id="3597327">connection</span>&nbsp;<span class="op" id="3597338">=</span>&nbsp;<span class="string" id="3597340">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3597350">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3597353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3597357">w</span><span class="op" id="3597358">.</span><span class="ident" id="3597359">conn</span><span class="op" id="3597363">.</span><span class="ident" id="3597364">buf</span><span class="op" id="3597367">.</span><span class="ident" id="3597368">WriteString</span><span class="op" id="3597379">(</span><span class="ident" id="3597380">statusLine</span><span class="op" id="3597390">(</span><span class="ident" id="3597391">w</span><span class="op" id="3597392">.</span><span class="ident" id="3597393">req</span><span class="op" id="3597396">,</span>&nbsp;<span class="ident" id="3597398">code</span><span class="op" id="3597402">)</span><span class="op" id="3597403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3597406">cw</span><span class="op" id="3597408">.</span><span class="ident" id="3597409">header</span><span class="op" id="3597415">.</span><span class="ident" id="3597416">WriteSubset</span><span class="op" id="3597427">(</span><span class="ident" id="3597428">w</span><span class="op" id="3597429">.</span><span class="ident" id="3597430">conn</span><span class="op" id="3597434">.</span><span class="ident" id="3597435">buf</span><span class="op" id="3597438">,</span>&nbsp;<span class="ident" id="3597440">excludeHeader</span><span class="op" id="3597453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3597456">setHeader</span><span class="op" id="3597465">.</span><span class="ident" id="3597466">Write</span><span class="op" id="3597471">(</span><span class="ident" id="3597472">w</span><span class="op" id="3597473">.</span><span class="ident" id="3597474">conn</span><span class="op" id="3597478">.</span><span class="ident" id="3597479">buf</span><span class="op" id="3597482">.</span><span class="ident" id="3597483">Writer</span><span class="op" id="3597489">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3597492">w</span><span class="op" id="3597493">.</span><span class="ident" id="3597494">conn</span><span class="op" id="3597498">.</span><span class="ident" id="3597499">buf</span><span class="op" id="3597502">.</span><span class="ident" id="3597503">Write</span><span class="op" id="3597508">(</span><span class="ident" id="3597509">crlf</span><span class="op" id="3597513">)</span><br>
<span class="lineno"></span><span class="op" id="3597515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3597518">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="3597587">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="3597655">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="3597724">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="3597792">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="3597830">var</span>&nbsp;<span class="op" id="3597834">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3597837">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3597849">sync</span><span class="op" id="3597853">.</span><span class="ident" id="3597854">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3597863">statusLines</span>&nbsp;<span class="op" id="3597875">=</span>&nbsp;<span class="builtinfunc" id="3597877">make</span><span class="op" id="3597881">(</span><span class="keyword" id="3597882">map</span><span class="op" id="3597885">[</span><span class="builtintype" id="3597886">int</span><span class="op" id="3597889">]</span><span class="builtintype" id="3597890">string</span><span class="op" id="3597896">)</span><br>
<span class="lineno"></span><span class="op" id="3597898">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3597901">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="3597969">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="3598020">func</span>&nbsp;<span class="ident" id="3598025">statusLine</span><span class="op" id="3598035">(</span><span class="ident" id="3598036">req</span>&nbsp;<span class="op" id="3598040">*</span><span class="ident" id="3598041">Request</span><span class="op" id="3598048">,</span>&nbsp;<span class="ident" id="3598050">code</span>&nbsp;<span class="builtintype" id="3598055">int</span><span class="op" id="3598058">)</span>&nbsp;<span class="builtintype" id="3598060">string</span>&nbsp;<span class="op" id="3598067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3598070">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598085">key</span>&nbsp;<span class="op" id="3598089">:=</span>&nbsp;<span class="ident" id="3598092">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598098">proto11</span>&nbsp;<span class="op" id="3598106">:=</span>&nbsp;<span class="ident" id="3598109">req</span><span class="op" id="3598112">.</span><span class="ident" id="3598113">ProtoAtLeast</span><span class="op" id="3598125">(</span><span class="num" id="3598126">1</span><span class="op" id="3598127">,</span>&nbsp;<span class="num" id="3598129">1</span><span class="op" id="3598130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598133">if</span>&nbsp;<span class="op" id="3598136">!</span><span class="ident" id="3598137">proto11</span>&nbsp;<span class="op" id="3598145">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598149">key</span>&nbsp;<span class="op" id="3598153">=</span>&nbsp;<span class="op" id="3598155">-</span><span class="ident" id="3598156">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3598161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598164">statusMu</span><span class="op" id="3598172">.</span><span class="ident" id="3598173">RLock</span><span class="op" id="3598178">(</span><span class="op" id="3598179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598182">line</span><span class="op" id="3598186">,</span>&nbsp;<span class="ident" id="3598188">ok</span>&nbsp;<span class="op" id="3598191">:=</span>&nbsp;<span class="ident" id="3598194">statusLines</span><span class="op" id="3598205">[</span><span class="ident" id="3598206">key</span><span class="op" id="3598209">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598212">statusMu</span><span class="op" id="3598220">.</span><span class="ident" id="3598221">RUnlock</span><span class="op" id="3598228">(</span><span class="op" id="3598229">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598232">if</span>&nbsp;<span class="ident" id="3598235">ok</span>&nbsp;<span class="op" id="3598238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598242">return</span>&nbsp;<span class="ident" id="3598249">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3598255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3598259">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598274">proto</span>&nbsp;<span class="op" id="3598280">:=</span>&nbsp;<span class="string" id="3598283">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598295">if</span>&nbsp;<span class="ident" id="3598298">proto11</span>&nbsp;<span class="op" id="3598306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598310">proto</span>&nbsp;<span class="op" id="3598316">=</span>&nbsp;<span class="string" id="3598318">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3598330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598333">codestring</span>&nbsp;<span class="op" id="3598344">:=</span>&nbsp;<span class="ident" id="3598347">strconv</span><span class="op" id="3598354">.</span><span class="ident" id="3598355">Itoa</span><span class="op" id="3598359">(</span><span class="ident" id="3598360">code</span><span class="op" id="3598364">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598367">text</span><span class="op" id="3598371">,</span>&nbsp;<span class="ident" id="3598373">ok</span>&nbsp;<span class="op" id="3598376">:=</span>&nbsp;<span class="ident" id="3598379">statusText</span><span class="op" id="3598389">[</span><span class="ident" id="3598390">code</span><span class="op" id="3598394">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598397">if</span>&nbsp;<span class="op" id="3598400">!</span><span class="ident" id="3598401">ok</span>&nbsp;<span class="op" id="3598404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598408">text</span>&nbsp;<span class="op" id="3598413">=</span>&nbsp;<span class="string" id="3598415">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="3598430">+</span>&nbsp;<span class="ident" id="3598432">codestring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3598444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598447">line</span>&nbsp;<span class="op" id="3598452">=</span>&nbsp;<span class="ident" id="3598454">proto</span>&nbsp;<span class="op" id="3598460">+</span>&nbsp;<span class="string" id="3598462">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3598466">+</span>&nbsp;<span class="ident" id="3598468">codestring</span>&nbsp;<span class="op" id="3598479">+</span>&nbsp;<span class="string" id="3598481">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3598485">+</span>&nbsp;<span class="ident" id="3598487">text</span>&nbsp;<span class="op" id="3598492">+</span>&nbsp;<span class="string" id="3598494">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598502">if</span>&nbsp;<span class="ident" id="3598505">ok</span>&nbsp;<span class="op" id="3598508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598512">statusMu</span><span class="op" id="3598520">.</span><span class="ident" id="3598521">Lock</span><span class="op" id="3598525">(</span><span class="op" id="3598526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598530">defer</span>&nbsp;<span class="ident" id="3598536">statusMu</span><span class="op" id="3598544">.</span><span class="ident" id="3598545">Unlock</span><span class="op" id="3598551">(</span><span class="op" id="3598552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598556">statusLines</span><span class="op" id="3598567">[</span><span class="ident" id="3598568">key</span><span class="op" id="3598571">]</span>&nbsp;<span class="op" id="3598573">=</span>&nbsp;<span class="ident" id="3598575">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3598581">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598584">return</span>&nbsp;<span class="ident" id="3598591">line</span><br>
<span class="lineno"></span><span class="op" id="3598596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3598599">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3598673">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="3598738">func</span>&nbsp;<span class="op" id="3598743">(</span><span class="ident" id="3598744">w</span>&nbsp;<span class="op" id="3598746">*</span><span class="ident" id="3598747">response</span><span class="op" id="3598755">)</span>&nbsp;<span class="ident" id="3598757">bodyAllowed</span><span class="op" id="3598768">(</span><span class="op" id="3598769">)</span>&nbsp;<span class="builtintype" id="3598771">bool</span>&nbsp;<span class="op" id="3598776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598779">if</span>&nbsp;<span class="op" id="3598782">!</span><span class="ident" id="3598783">w</span><span class="op" id="3598784">.</span><span class="ident" id="3598785">wroteHeader</span>&nbsp;<span class="op" id="3598797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3598801">panic</span><span class="op" id="3598806">(</span><span class="string" id="3598807">&#34;&#34;</span><span class="op" id="3598809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3598812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598815">return</span>&nbsp;<span class="ident" id="3598822">bodyAllowedForStatus</span><span class="op" id="3598842">(</span><span class="ident" id="3598843">w</span><span class="op" id="3598844">.</span><span class="ident" id="3598845">status</span><span class="op" id="3598851">)</span><br>
<span class="lineno">940</span><span class="op" id="3598853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3598856">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="3598893">//</span><br>
<span class="lineno"></span><span class="comment" id="3598896">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="3598963">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="3599038">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="3599082">//</span><br>
<span class="lineno"></span><span class="comment" id="3599085">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="3599155">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="3599223">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3599294">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="3599320">//</span><br>
<span class="lineno"></span><span class="comment" id="3599323">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3599392">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="3599429">//</span><br>
<span class="lineno"></span><span class="comment" id="3599432">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="3599472">//</span><br>
<span class="lineno"></span><span class="comment" id="3599475">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3599515">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="3599586">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="3599661">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="3599714">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3599783">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="3599853">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="3599920">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="3599949">//</span><br>
<span class="lineno"></span><span class="comment" id="3599952">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3600016">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="3600083">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="3600151">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="3600216">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3600286">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3600355">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3600426">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="3600497">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="3600519">func</span>&nbsp;<span class="op" id="3600524">(</span><span class="ident" id="3600525">w</span>&nbsp;<span class="op" id="3600527">*</span><span class="ident" id="3600528">response</span><span class="op" id="3600536">)</span>&nbsp;<span class="ident" id="3600538">Write</span><span class="op" id="3600543">(</span><span class="ident" id="3600544">data</span>&nbsp;<span class="op" id="3600549">[</span><span class="op" id="3600550">]</span><span class="builtintype" id="3600551">byte</span><span class="op" id="3600555">)</span>&nbsp;<span class="op" id="3600557">(</span><span class="ident" id="3600558">n</span>&nbsp;<span class="builtintype" id="3600560">int</span><span class="op" id="3600563">,</span>&nbsp;<span class="ident" id="3600565">err</span>&nbsp;<span class="builtintype" id="3600569">error</span><span class="op" id="3600574">)</span>&nbsp;<span class="op" id="3600576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3600579">return</span>&nbsp;<span class="ident" id="3600586">w</span><span class="op" id="3600587">.</span><span class="ident" id="3600588">write</span><span class="op" id="3600593">(</span><span class="builtinfunc" id="3600594">len</span><span class="op" id="3600597">(</span><span class="ident" id="3600598">data</span><span class="op" id="3600602">)</span><span class="op" id="3600603">,</span>&nbsp;<span class="ident" id="3600605">data</span><span class="op" id="3600609">,</span>&nbsp;<span class="string" id="3600611">&#34;&#34;</span><span class="op" id="3600613">)</span><br>
<span class="lineno"></span><span class="op" id="3600615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="3600618">func</span>&nbsp;<span class="op" id="3600623">(</span><span class="ident" id="3600624">w</span>&nbsp;<span class="op" id="3600626">*</span><span class="ident" id="3600627">response</span><span class="op" id="3600635">)</span>&nbsp;<span class="ident" id="3600637">WriteString</span><span class="op" id="3600648">(</span><span class="ident" id="3600649">data</span>&nbsp;<span class="builtintype" id="3600654">string</span><span class="op" id="3600660">)</span>&nbsp;<span class="op" id="3600662">(</span><span class="ident" id="3600663">n</span>&nbsp;<span class="builtintype" id="3600665">int</span><span class="op" id="3600668">,</span>&nbsp;<span class="ident" id="3600670">err</span>&nbsp;<span class="builtintype" id="3600674">error</span><span class="op" id="3600679">)</span>&nbsp;<span class="op" id="3600681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3600684">return</span>&nbsp;<span class="ident" id="3600691">w</span><span class="op" id="3600692">.</span><span class="ident" id="3600693">write</span><span class="op" id="3600698">(</span><span class="builtinfunc" id="3600699">len</span><span class="op" id="3600702">(</span><span class="ident" id="3600703">data</span><span class="op" id="3600707">)</span><span class="op" id="3600708">,</span>&nbsp;<span class="ident" id="3600710">nil</span><span class="op" id="3600713">,</span>&nbsp;<span class="ident" id="3600715">data</span><span class="op" id="3600719">)</span><br>
<span class="lineno"></span><span class="op" id="3600721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3600724">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="3600762">func</span>&nbsp;<span class="op" id="3600767">(</span><span class="ident" id="3600768">w</span>&nbsp;<span class="op" id="3600770">*</span><span class="ident" id="3600771">response</span><span class="op" id="3600779">)</span>&nbsp;<span class="ident" id="3600781">write</span><span class="op" id="3600786">(</span><span class="ident" id="3600787">lenData</span>&nbsp;<span class="builtintype" id="3600795">int</span><span class="op" id="3600798">,</span>&nbsp;<span class="ident" id="3600800">dataB</span>&nbsp;<span class="op" id="3600806">[</span><span class="op" id="3600807">]</span><span class="builtintype" id="3600808">byte</span><span class="op" id="3600812">,</span>&nbsp;<span class="ident" id="3600814">dataS</span>&nbsp;<span class="builtintype" id="3600820">string</span><span class="op" id="3600826">)</span>&nbsp;<span class="op" id="3600828">(</span><span class="ident" id="3600829">n</span>&nbsp;<span class="builtintype" id="3600831">int</span><span class="op" id="3600834">,</span>&nbsp;<span class="ident" id="3600836">err</span>&nbsp;<span class="builtintype" id="3600840">error</span><span class="op" id="3600845">)</span>&nbsp;<span class="op" id="3600847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3600850">if</span>&nbsp;<span class="ident" id="3600853">w</span><span class="op" id="3600854">.</span><span class="ident" id="3600855">conn</span><span class="op" id="3600859">.</span><span class="ident" id="3600860">hijacked</span><span class="op" id="3600868">(</span><span class="op" id="3600869">)</span>&nbsp;<span class="op" id="3600871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3600875">w</span><span class="op" id="3600876">.</span><span class="ident" id="3600877">conn</span><span class="op" id="3600881">.</span><span class="ident" id="3600882">server</span><span class="op" id="3600888">.</span><span class="ident" id="3600889">logf</span><span class="op" id="3600893">(</span><span class="string" id="3600894">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3600939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3600943">return</span>&nbsp;<span class="num" id="3600950">0</span><span class="op" id="3600951">,</span>&nbsp;<span class="ident" id="3600953">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3600966">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3600969">if</span>&nbsp;<span class="op" id="3600972">!</span><span class="ident" id="3600973">w</span><span class="op" id="3600974">.</span><span class="ident" id="3600975">wroteHeader</span>&nbsp;<span class="op" id="3600987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3600991">w</span><span class="op" id="3600992">.</span><span class="ident" id="3600993">WriteHeader</span><span class="op" id="3601004">(</span><span class="ident" id="3601005">StatusOK</span><span class="op" id="3601013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601019">if</span>&nbsp;<span class="ident" id="3601022">lenData</span>&nbsp;<span class="op" id="3601030">==</span>&nbsp;<span class="num" id="3601033">0</span>&nbsp;<span class="op" id="3601035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601039">return</span>&nbsp;<span class="num" id="3601046">0</span><span class="op" id="3601047">,</span>&nbsp;<span class="ident" id="3601049">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601057">if</span>&nbsp;<span class="op" id="3601060">!</span><span class="ident" id="3601061">w</span><span class="op" id="3601062">.</span><span class="ident" id="3601063">bodyAllowed</span><span class="op" id="3601074">(</span><span class="op" id="3601075">)</span>&nbsp;<span class="op" id="3601077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601081">return</span>&nbsp;<span class="num" id="3601088">0</span><span class="op" id="3601089">,</span>&nbsp;<span class="ident" id="3601091">ErrBodyNotAllowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601114">w</span><span class="op" id="3601115">.</span><span class="ident" id="3601116">written</span>&nbsp;<span class="op" id="3601124">+=</span>&nbsp;<span class="ident" id="3601127">int64</span><span class="op" id="3601132">(</span><span class="ident" id="3601133">lenData</span><span class="op" id="3601140">)</span>&nbsp;<span class="comment" id="3601142">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601179">if</span>&nbsp;<span class="ident" id="3601182">w</span><span class="op" id="3601183">.</span><span class="ident" id="3601184">contentLength</span>&nbsp;<span class="op" id="3601198">!=</span>&nbsp;<span class="op" id="3601201">-</span><span class="num" id="3601202">1</span>&nbsp;<span class="op" id="3601204">&amp;&amp;</span>&nbsp;<span class="ident" id="3601207">w</span><span class="op" id="3601208">.</span><span class="ident" id="3601209">written</span>&nbsp;<span class="op" id="3601217">&gt;</span>&nbsp;<span class="ident" id="3601219">w</span><span class="op" id="3601220">.</span><span class="ident" id="3601221">contentLength</span>&nbsp;<span class="op" id="3601235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601239">return</span>&nbsp;<span class="num" id="3601246">0</span><span class="op" id="3601247">,</span>&nbsp;<span class="ident" id="3601249">ErrContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601270">if</span>&nbsp;<span class="ident" id="3601273">dataB</span>&nbsp;<span class="op" id="3601279">!=</span>&nbsp;<span class="ident" id="3601282">nil</span>&nbsp;<span class="op" id="3601286">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601290">return</span>&nbsp;<span class="ident" id="3601297">w</span><span class="op" id="3601298">.</span><span class="ident" id="3601299">w</span><span class="op" id="3601300">.</span><span class="ident" id="3601301">Write</span><span class="op" id="3601306">(</span><span class="ident" id="3601307">dataB</span><span class="op" id="3601312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601315">}</span>&nbsp;<span class="keyword" id="3601317">else</span>&nbsp;<span class="op" id="3601322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601326">return</span>&nbsp;<span class="ident" id="3601333">w</span><span class="op" id="3601334">.</span><span class="ident" id="3601335">w</span><span class="op" id="3601336">.</span><span class="ident" id="3601337">WriteString</span><span class="op" id="3601348">(</span><span class="ident" id="3601349">dataS</span><span class="op" id="3601354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601357">}</span><br>
<span class="lineno"></span><span class="op" id="3601359">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="3601362">func</span>&nbsp;<span class="op" id="3601367">(</span><span class="ident" id="3601368">w</span>&nbsp;<span class="op" id="3601370">*</span><span class="ident" id="3601371">response</span><span class="op" id="3601379">)</span>&nbsp;<span class="ident" id="3601381">finishRequest</span><span class="op" id="3601394">(</span><span class="op" id="3601395">)</span>&nbsp;<span class="op" id="3601397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601400">w</span><span class="op" id="3601401">.</span><span class="ident" id="3601402">handlerDone</span>&nbsp;<span class="op" id="3601414">=</span>&nbsp;<span class="ident" id="3601416">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601423">if</span>&nbsp;<span class="op" id="3601426">!</span><span class="ident" id="3601427">w</span><span class="op" id="3601428">.</span><span class="ident" id="3601429">wroteHeader</span>&nbsp;<span class="op" id="3601441">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601445">w</span><span class="op" id="3601446">.</span><span class="ident" id="3601447">WriteHeader</span><span class="op" id="3601458">(</span><span class="ident" id="3601459">StatusOK</span><span class="op" id="3601467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601474">w</span><span class="op" id="3601475">.</span><span class="ident" id="3601476">w</span><span class="op" id="3601477">.</span><span class="ident" id="3601478">Flush</span><span class="op" id="3601483">(</span><span class="op" id="3601484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601487">putBufioWriter</span><span class="op" id="3601501">(</span><span class="ident" id="3601502">w</span><span class="op" id="3601503">.</span><span class="ident" id="3601504">w</span><span class="op" id="3601505">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601508">w</span><span class="op" id="3601509">.</span><span class="ident" id="3601510">cw</span><span class="op" id="3601512">.</span><span class="builtinfunc" id="3601513">close</span><span class="op" id="3601518">(</span><span class="op" id="3601519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601522">w</span><span class="op" id="3601523">.</span><span class="ident" id="3601524">conn</span><span class="op" id="3601528">.</span><span class="ident" id="3601529">buf</span><span class="op" id="3601532">.</span><span class="ident" id="3601533">Flush</span><span class="op" id="3601538">(</span><span class="op" id="3601539">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3601543">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3601606">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601648">w</span><span class="op" id="3601649">.</span><span class="ident" id="3601650">req</span><span class="op" id="3601653">.</span><span class="ident" id="3601654">Body</span><span class="op" id="3601658">.</span><span class="ident" id="3601659">Close</span><span class="op" id="3601664">(</span><span class="op" id="3601665">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601669">if</span>&nbsp;<span class="ident" id="3601672">w</span><span class="op" id="3601673">.</span><span class="ident" id="3601674">req</span><span class="op" id="3601677">.</span><span class="ident" id="3601678">MultipartForm</span>&nbsp;<span class="op" id="3601692">!=</span>&nbsp;<span class="ident" id="3601695">nil</span>&nbsp;<span class="op" id="3601699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601703">w</span><span class="op" id="3601704">.</span><span class="ident" id="3601705">req</span><span class="op" id="3601708">.</span><span class="ident" id="3601709">MultipartForm</span><span class="op" id="3601722">.</span><span class="ident" id="3601723">RemoveAll</span><span class="op" id="3601732">(</span><span class="op" id="3601733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601736">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601740">if</span>&nbsp;<span class="ident" id="3601743">w</span><span class="op" id="3601744">.</span><span class="ident" id="3601745">req</span><span class="op" id="3601748">.</span><span class="ident" id="3601749">Method</span>&nbsp;<span class="op" id="3601756">!=</span>&nbsp;<span class="string" id="3601759">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3601766">&amp;&amp;</span>&nbsp;<span class="ident" id="3601769">w</span><span class="op" id="3601770">.</span><span class="ident" id="3601771">contentLength</span>&nbsp;<span class="op" id="3601785">!=</span>&nbsp;<span class="op" id="3601788">-</span><span class="num" id="3601789">1</span>&nbsp;<span class="op" id="3601791">&amp;&amp;</span>&nbsp;<span class="ident" id="3601794">w</span><span class="op" id="3601795">.</span><span class="ident" id="3601796">bodyAllowed</span><span class="op" id="3601807">(</span><span class="op" id="3601808">)</span>&nbsp;<span class="op" id="3601810">&amp;&amp;</span>&nbsp;<span class="ident" id="3601813">w</span><span class="op" id="3601814">.</span><span class="ident" id="3601815">contentLength</span>&nbsp;<span class="op" id="3601829">!=</span>&nbsp;<span class="ident" id="3601832">w</span><span class="op" id="3601833">.</span><span class="ident" id="3601834">written</span>&nbsp;<span class="op" id="3601842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3601846">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601900">w</span><span class="op" id="3601901">.</span><span class="ident" id="3601902">closeAfterReply</span>&nbsp;<span class="op" id="3601918">=</span>&nbsp;<span class="ident" id="3601920">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601926">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3601930">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3601992">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602043">if</span>&nbsp;<span class="ident" id="3602046">w</span><span class="op" id="3602047">.</span><span class="ident" id="3602048">conn</span><span class="op" id="3602052">.</span><span class="ident" id="3602053">werr</span>&nbsp;<span class="op" id="3602058">!=</span>&nbsp;<span class="ident" id="3602061">nil</span>&nbsp;<span class="op" id="3602065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602069">w</span><span class="op" id="3602070">.</span><span class="ident" id="3602071">closeAfterReply</span>&nbsp;<span class="op" id="3602087">=</span>&nbsp;<span class="ident" id="3602089">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3602095">}</span><br>
<span class="lineno"></span><span class="op" id="3602097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3602100">func</span>&nbsp;<span class="op" id="3602105">(</span><span class="ident" id="3602106">w</span>&nbsp;<span class="op" id="3602108">*</span><span class="ident" id="3602109">response</span><span class="op" id="3602117">)</span>&nbsp;<span class="ident" id="3602119">Flush</span><span class="op" id="3602124">(</span><span class="op" id="3602125">)</span>&nbsp;<span class="op" id="3602127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602130">if</span>&nbsp;<span class="op" id="3602133">!</span><span class="ident" id="3602134">w</span><span class="op" id="3602135">.</span><span class="ident" id="3602136">wroteHeader</span>&nbsp;<span class="op" id="3602148">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602152">w</span><span class="op" id="3602153">.</span><span class="ident" id="3602154">WriteHeader</span><span class="op" id="3602165">(</span><span class="ident" id="3602166">StatusOK</span><span class="op" id="3602174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3602177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602180">w</span><span class="op" id="3602181">.</span><span class="ident" id="3602182">w</span><span class="op" id="3602183">.</span><span class="ident" id="3602184">Flush</span><span class="op" id="3602189">(</span><span class="op" id="3602190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602193">w</span><span class="op" id="3602194">.</span><span class="ident" id="3602195">cw</span><span class="op" id="3602197">.</span><span class="ident" id="3602198">flush</span><span class="op" id="3602203">(</span><span class="op" id="3602204">)</span><br>
<span class="lineno"></span><span class="op" id="3602206">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="3602209">func</span>&nbsp;<span class="op" id="3602214">(</span><span class="ident" id="3602215">c</span>&nbsp;<span class="op" id="3602217">*</span><span class="ident" id="3602218">conn</span><span class="op" id="3602222">)</span>&nbsp;<span class="ident" id="3602224">finalFlush</span><span class="op" id="3602234">(</span><span class="op" id="3602235">)</span>&nbsp;<span class="op" id="3602237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602240">if</span>&nbsp;<span class="ident" id="3602243">c</span><span class="op" id="3602244">.</span><span class="ident" id="3602245">buf</span>&nbsp;<span class="op" id="3602249">!=</span>&nbsp;<span class="ident" id="3602252">nil</span>&nbsp;<span class="op" id="3602256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602260">c</span><span class="op" id="3602261">.</span><span class="ident" id="3602262">buf</span><span class="op" id="3602265">.</span><span class="ident" id="3602266">Flush</span><span class="op" id="3602271">(</span><span class="op" id="3602272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3602277">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3602347">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602384">putBufioReader</span><span class="op" id="3602398">(</span><span class="ident" id="3602399">c</span><span class="op" id="3602400">.</span><span class="ident" id="3602401">buf</span><span class="op" id="3602404">.</span><span class="ident" id="3602405">Reader</span><span class="op" id="3602411">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3602416">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3602486">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602523">putBufioWriter</span><span class="op" id="3602537">(</span><span class="ident" id="3602538">c</span><span class="op" id="3602539">.</span><span class="ident" id="3602540">buf</span><span class="op" id="3602543">.</span><span class="ident" id="3602544">Writer</span><span class="op" id="3602550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602555">c</span><span class="op" id="3602556">.</span><span class="ident" id="3602557">buf</span>&nbsp;<span class="op" id="3602561">=</span>&nbsp;<span class="ident" id="3602563">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3602568">}</span><br>
<span class="lineno">1065</span><span class="op" id="3602570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3602573">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3602598">func</span>&nbsp;<span class="op" id="3602603">(</span><span class="ident" id="3602604">c</span>&nbsp;<span class="op" id="3602606">*</span><span class="ident" id="3602607">conn</span><span class="op" id="3602611">)</span>&nbsp;<span class="builtinfunc" id="3602613">close</span><span class="op" id="3602618">(</span><span class="op" id="3602619">)</span>&nbsp;<span class="op" id="3602621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602624">c</span><span class="op" id="3602625">.</span><span class="ident" id="3602626">finalFlush</span><span class="op" id="3602636">(</span><span class="op" id="3602637">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602640">if</span>&nbsp;<span class="ident" id="3602643">c</span><span class="op" id="3602644">.</span><span class="ident" id="3602645">rwc</span>&nbsp;<span class="op" id="3602649">!=</span>&nbsp;<span class="ident" id="3602652">nil</span>&nbsp;<span class="op" id="3602656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602660">c</span><span class="op" id="3602661">.</span><span class="ident" id="3602662">rwc</span><span class="op" id="3602665">.</span><span class="ident" id="3602666">Close</span><span class="op" id="3602671">(</span><span class="op" id="3602672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602676">c</span><span class="op" id="3602677">.</span><span class="ident" id="3602678">rwc</span>&nbsp;<span class="op" id="3602682">=</span>&nbsp;<span class="ident" id="3602684">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3602689">}</span><br>
<span class="lineno"></span><span class="op" id="3602691">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="3602694">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3602764">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="3602832">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="3602901">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="3602972">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3603025">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="3603090">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="3603158">const</span>&nbsp;<span class="ident" id="3603164">rstAvoidanceDelay</span>&nbsp;<span class="op" id="3603182">=</span>&nbsp;<span class="num" id="3603184">500</span>&nbsp;<span class="op" id="3603188">*</span>&nbsp;<span class="ident" id="3603190">time</span><span class="op" id="3603194">.</span><span class="ident" id="3603195">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="3603208">type</span>&nbsp;<span class="ident" id="3603213">closeWriter</span>&nbsp;<span class="keyword" id="3603225">interface</span>&nbsp;<span class="op" id="3603235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3603238">CloseWrite</span><span class="op" id="3603248">(</span><span class="op" id="3603249">)</span>&nbsp;<span class="builtintype" id="3603251">error</span><br>
<span class="lineno"></span><span class="op" id="3603257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3603260">var</span>&nbsp;<span class="ident" id="3603264">_</span>&nbsp;<span class="ident" id="3603266">closeWriter</span>&nbsp;<span class="op" id="3603278">=</span>&nbsp;<span class="op" id="3603280">(</span><span class="op" id="3603281">*</span><span class="ident" id="3603282">net</span><span class="op" id="3603285">.</span><span class="ident" id="3603286">TCPConn</span><span class="op" id="3603293">)</span><span class="op" id="3603294">(</span><span class="ident" id="3603295">nil</span><span class="op" id="3603298">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="3603301">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="3603371">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3603441">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3603503">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="3603522">//</span><br>
<span class="lineno"></span><span class="comment" id="3603525">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="3603561">func</span>&nbsp;<span class="op" id="3603566">(</span><span class="ident" id="3603567">c</span>&nbsp;<span class="op" id="3603569">*</span><span class="ident" id="3603570">conn</span><span class="op" id="3603574">)</span>&nbsp;<span class="ident" id="3603576">closeWriteAndWait</span><span class="op" id="3603593">(</span><span class="op" id="3603594">)</span>&nbsp;<span class="op" id="3603596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3603599">c</span><span class="op" id="3603600">.</span><span class="ident" id="3603601">finalFlush</span><span class="op" id="3603611">(</span><span class="op" id="3603612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603615">if</span>&nbsp;<span class="ident" id="3603618">tcp</span><span class="op" id="3603621">,</span>&nbsp;<span class="ident" id="3603623">ok</span>&nbsp;<span class="op" id="3603626">:=</span>&nbsp;<span class="ident" id="3603629">c</span><span class="op" id="3603630">.</span><span class="ident" id="3603631">rwc</span><span class="op" id="3603634">.</span><span class="op" id="3603635">(</span><span class="ident" id="3603636">closeWriter</span><span class="op" id="3603647">)</span><span class="op" id="3603648">;</span>&nbsp;<span class="ident" id="3603650">ok</span>&nbsp;<span class="op" id="3603653">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3603657">tcp</span><span class="op" id="3603660">.</span><span class="ident" id="3603661">CloseWrite</span><span class="op" id="3603671">(</span><span class="op" id="3603672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3603675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3603678">time</span><span class="op" id="3603682">.</span><span class="ident" id="3603683">Sleep</span><span class="op" id="3603688">(</span><span class="ident" id="3603689">rstAvoidanceDelay</span><span class="op" id="3603706">)</span><br>
<span class="lineno"></span><span class="op" id="3603708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="3603711">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="3603775">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="3603844">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="3603902">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="3603922">func</span>&nbsp;<span class="ident" id="3603927">validNPN</span><span class="op" id="3603935">(</span><span class="ident" id="3603936">proto</span>&nbsp;<span class="builtintype" id="3603942">string</span><span class="op" id="3603948">)</span>&nbsp;<span class="builtintype" id="3603950">bool</span>&nbsp;<span class="op" id="3603955">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603958">switch</span>&nbsp;<span class="ident" id="3603965">proto</span>&nbsp;<span class="op" id="3603971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603974">case</span>&nbsp;<span class="string" id="3603979">&#34;&#34;</span><span class="op" id="3603981">,</span>&nbsp;<span class="string" id="3603983">&#34;http/1.1&#34;</span><span class="op" id="3603993">,</span>&nbsp;<span class="string" id="3603995">&#34;http/1.0&#34;</span><span class="op" id="3604005">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604009">return</span>&nbsp;<span class="ident" id="3604016">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604026">return</span>&nbsp;<span class="ident" id="3604033">true</span><br>
<span class="lineno">1115</span><span class="op" id="3604038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3604041">func</span>&nbsp;<span class="op" id="3604046">(</span><span class="ident" id="3604047">c</span>&nbsp;<span class="op" id="3604049">*</span><span class="ident" id="3604050">conn</span><span class="op" id="3604054">)</span>&nbsp;<span class="ident" id="3604056">setState</span><span class="op" id="3604064">(</span><span class="ident" id="3604065">nc</span>&nbsp;<span class="ident" id="3604068">net</span><span class="op" id="3604071">.</span><span class="ident" id="3604072">Conn</span><span class="op" id="3604076">,</span>&nbsp;<span class="ident" id="3604078">state</span>&nbsp;<span class="ident" id="3604084">ConnState</span><span class="op" id="3604093">)</span>&nbsp;<span class="op" id="3604095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604098">if</span>&nbsp;<span class="ident" id="3604101">hook</span>&nbsp;<span class="op" id="3604106">:=</span>&nbsp;<span class="ident" id="3604109">c</span><span class="op" id="3604110">.</span><span class="ident" id="3604111">server</span><span class="op" id="3604117">.</span><span class="ident" id="3604118">ConnState</span><span class="op" id="3604127">;</span>&nbsp;<span class="ident" id="3604129">hook</span>&nbsp;<span class="op" id="3604134">!=</span>&nbsp;<span class="ident" id="3604137">nil</span>&nbsp;<span class="op" id="3604141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604145">hook</span><span class="op" id="3604149">(</span><span class="ident" id="3604150">nc</span><span class="op" id="3604152">,</span>&nbsp;<span class="ident" id="3604154">state</span><span class="op" id="3604159">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604162">}</span><br>
<span class="lineno"></span><span class="op" id="3604164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3604167">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3604194">func</span>&nbsp;<span class="op" id="3604199">(</span><span class="ident" id="3604200">c</span>&nbsp;<span class="op" id="3604202">*</span><span class="ident" id="3604203">conn</span><span class="op" id="3604207">)</span>&nbsp;<span class="ident" id="3604209">serve</span><span class="op" id="3604214">(</span><span class="op" id="3604215">)</span>&nbsp;<span class="op" id="3604217">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604220">origConn</span>&nbsp;<span class="op" id="3604229">:=</span>&nbsp;<span class="ident" id="3604232">c</span><span class="op" id="3604233">.</span><span class="ident" id="3604234">rwc</span>&nbsp;<span class="comment" id="3604238">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604289">defer</span>&nbsp;<span class="keyword" id="3604295">func</span><span class="op" id="3604299">(</span><span class="op" id="3604300">)</span>&nbsp;<span class="op" id="3604302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604306">if</span>&nbsp;<span class="ident" id="3604309">err</span>&nbsp;<span class="op" id="3604313">:=</span>&nbsp;<span class="builtinfunc" id="3604316">recover</span><span class="op" id="3604323">(</span><span class="op" id="3604324">)</span><span class="op" id="3604325">;</span>&nbsp;<span class="ident" id="3604327">err</span>&nbsp;<span class="op" id="3604331">!=</span>&nbsp;<span class="ident" id="3604334">nil</span>&nbsp;<span class="op" id="3604338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604343">const</span>&nbsp;<span class="ident" id="3604349">size</span>&nbsp;<span class="op" id="3604354">=</span>&nbsp;<span class="num" id="3604356">64</span>&nbsp;<span class="op" id="3604359">&lt;&lt;</span>&nbsp;<span class="num" id="3604362">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604368">buf</span>&nbsp;<span class="op" id="3604372">:=</span>&nbsp;<span class="builtinfunc" id="3604375">make</span><span class="op" id="3604379">(</span><span class="op" id="3604380">[</span><span class="op" id="3604381">]</span><span class="builtintype" id="3604382">byte</span><span class="op" id="3604386">,</span>&nbsp;<span class="ident" id="3604388">size</span><span class="op" id="3604392">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604397">buf</span>&nbsp;<span class="op" id="3604401">=</span>&nbsp;<span class="ident" id="3604403">buf</span><span class="op" id="3604406">[</span><span class="op" id="3604407">:</span><span class="ident" id="3604408">runtime</span><span class="op" id="3604415">.</span><span class="ident" id="3604416">Stack</span><span class="op" id="3604421">(</span><span class="ident" id="3604422">buf</span><span class="op" id="3604425">,</span>&nbsp;<span class="ident" id="3604427">false</span><span class="op" id="3604432">)</span><span class="op" id="3604433">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604438">c</span><span class="op" id="3604439">.</span><span class="ident" id="3604440">server</span><span class="op" id="3604446">.</span><span class="ident" id="3604447">logf</span><span class="op" id="3604451">(</span><span class="string" id="3604452">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="3604484">,</span>&nbsp;<span class="ident" id="3604486">c</span><span class="op" id="3604487">.</span><span class="ident" id="3604488">remoteAddr</span><span class="op" id="3604498">,</span>&nbsp;<span class="ident" id="3604500">err</span><span class="op" id="3604503">,</span>&nbsp;<span class="ident" id="3604505">buf</span><span class="op" id="3604508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604516">if</span>&nbsp;<span class="op" id="3604519">!</span><span class="ident" id="3604520">c</span><span class="op" id="3604521">.</span><span class="ident" id="3604522">hijacked</span><span class="op" id="3604530">(</span><span class="op" id="3604531">)</span>&nbsp;<span class="op" id="3604533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604538">c</span><span class="op" id="3604539">.</span><span class="builtinfunc" id="3604540">close</span><span class="op" id="3604545">(</span><span class="op" id="3604546">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604551">c</span><span class="op" id="3604552">.</span><span class="ident" id="3604553">setState</span><span class="op" id="3604561">(</span><span class="ident" id="3604562">origConn</span><span class="op" id="3604570">,</span>&nbsp;<span class="ident" id="3604572">StateClosed</span><span class="op" id="3604583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604590">}</span><span class="op" id="3604591">(</span><span class="op" id="3604592">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604596">if</span>&nbsp;<span class="ident" id="3604599">tlsConn</span><span class="op" id="3604606">,</span>&nbsp;<span class="ident" id="3604608">ok</span>&nbsp;<span class="op" id="3604611">:=</span>&nbsp;<span class="ident" id="3604614">c</span><span class="op" id="3604615">.</span><span class="ident" id="3604616">rwc</span><span class="op" id="3604619">.</span><span class="op" id="3604620">(</span><span class="op" id="3604621">*</span><span class="ident" id="3604622">tls</span><span class="op" id="3604625">.</span><span class="ident" id="3604626">Conn</span><span class="op" id="3604630">)</span><span class="op" id="3604631">;</span>&nbsp;<span class="ident" id="3604633">ok</span>&nbsp;<span class="op" id="3604636">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604640">if</span>&nbsp;<span class="ident" id="3604643">d</span>&nbsp;<span class="op" id="3604645">:=</span>&nbsp;<span class="ident" id="3604648">c</span><span class="op" id="3604649">.</span><span class="ident" id="3604650">server</span><span class="op" id="3604656">.</span><span class="ident" id="3604657">ReadTimeout</span><span class="op" id="3604668">;</span>&nbsp;<span class="ident" id="3604670">d</span>&nbsp;<span class="op" id="3604672">!=</span>&nbsp;<span class="num" id="3604675">0</span>&nbsp;<span class="op" id="3604677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604682">c</span><span class="op" id="3604683">.</span><span class="ident" id="3604684">rwc</span><span class="op" id="3604687">.</span><span class="ident" id="3604688">SetReadDeadline</span><span class="op" id="3604703">(</span><span class="ident" id="3604704">time</span><span class="op" id="3604708">.</span><span class="ident" id="3604709">Now</span><span class="op" id="3604712">(</span><span class="op" id="3604713">)</span><span class="op" id="3604714">.</span><span class="ident" id="3604715">Add</span><span class="op" id="3604718">(</span><span class="ident" id="3604719">d</span><span class="op" id="3604720">)</span><span class="op" id="3604721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604729">if</span>&nbsp;<span class="ident" id="3604732">d</span>&nbsp;<span class="op" id="3604734">:=</span>&nbsp;<span class="ident" id="3604737">c</span><span class="op" id="3604738">.</span><span class="ident" id="3604739">server</span><span class="op" id="3604745">.</span><span class="ident" id="3604746">WriteTimeout</span><span class="op" id="3604758">;</span>&nbsp;<span class="ident" id="3604760">d</span>&nbsp;<span class="op" id="3604762">!=</span>&nbsp;<span class="num" id="3604765">0</span>&nbsp;<span class="op" id="3604767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604772">c</span><span class="op" id="3604773">.</span><span class="ident" id="3604774">rwc</span><span class="op" id="3604777">.</span><span class="ident" id="3604778">SetWriteDeadline</span><span class="op" id="3604794">(</span><span class="ident" id="3604795">time</span><span class="op" id="3604799">.</span><span class="ident" id="3604800">Now</span><span class="op" id="3604803">(</span><span class="op" id="3604804">)</span><span class="op" id="3604805">.</span><span class="ident" id="3604806">Add</span><span class="op" id="3604809">(</span><span class="ident" id="3604810">d</span><span class="op" id="3604811">)</span><span class="op" id="3604812">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604820">if</span>&nbsp;<span class="ident" id="3604823">err</span>&nbsp;<span class="op" id="3604827">:=</span>&nbsp;<span class="ident" id="3604830">tlsConn</span><span class="op" id="3604837">.</span><span class="ident" id="3604838">Handshake</span><span class="op" id="3604847">(</span><span class="op" id="3604848">)</span><span class="op" id="3604849">;</span>&nbsp;<span class="ident" id="3604851">err</span>&nbsp;<span class="op" id="3604855">!=</span>&nbsp;<span class="ident" id="3604858">nil</span>&nbsp;<span class="op" id="3604862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604867">c</span><span class="op" id="3604868">.</span><span class="ident" id="3604869">server</span><span class="op" id="3604875">.</span><span class="ident" id="3604876">logf</span><span class="op" id="3604880">(</span><span class="string" id="3604881">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3604920">,</span>&nbsp;<span class="ident" id="3604922">c</span><span class="op" id="3604923">.</span><span class="ident" id="3604924">rwc</span><span class="op" id="3604927">.</span><span class="ident" id="3604928">RemoteAddr</span><span class="op" id="3604938">(</span><span class="op" id="3604939">)</span><span class="op" id="3604940">,</span>&nbsp;<span class="ident" id="3604942">err</span><span class="op" id="3604945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604950">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604959">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604963">c</span><span class="op" id="3604964">.</span><span class="ident" id="3604965">tlsState</span>&nbsp;<span class="op" id="3604974">=</span>&nbsp;<span class="builtinfunc" id="3604976">new</span><span class="op" id="3604979">(</span><span class="ident" id="3604980">tls</span><span class="op" id="3604983">.</span><span class="ident" id="3604984">ConnectionState</span><span class="op" id="3604999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3605003">*</span><span class="ident" id="3605004">c</span><span class="op" id="3605005">.</span><span class="ident" id="3605006">tlsState</span>&nbsp;<span class="op" id="3605015">=</span>&nbsp;<span class="ident" id="3605017">tlsConn</span><span class="op" id="3605024">.</span><span class="ident" id="3605025">ConnectionState</span><span class="op" id="3605040">(</span><span class="op" id="3605041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605045">if</span>&nbsp;<span class="ident" id="3605048">proto</span>&nbsp;<span class="op" id="3605054">:=</span>&nbsp;<span class="ident" id="3605057">c</span><span class="op" id="3605058">.</span><span class="ident" id="3605059">tlsState</span><span class="op" id="3605067">.</span><span class="ident" id="3605068">NegotiatedProtocol</span><span class="op" id="3605086">;</span>&nbsp;<span class="ident" id="3605088">validNPN</span><span class="op" id="3605096">(</span><span class="ident" id="3605097">proto</span><span class="op" id="3605102">)</span>&nbsp;<span class="op" id="3605104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605109">if</span>&nbsp;<span class="ident" id="3605112">fn</span>&nbsp;<span class="op" id="3605115">:=</span>&nbsp;<span class="ident" id="3605118">c</span><span class="op" id="3605119">.</span><span class="ident" id="3605120">server</span><span class="op" id="3605126">.</span><span class="ident" id="3605127">TLSNextProto</span><span class="op" id="3605139">[</span><span class="ident" id="3605140">proto</span><span class="op" id="3605145">]</span><span class="op" id="3605146">;</span>&nbsp;<span class="ident" id="3605148">fn</span>&nbsp;<span class="op" id="3605151">!=</span>&nbsp;<span class="ident" id="3605154">nil</span>&nbsp;<span class="op" id="3605158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3605164">h</span>&nbsp;<span class="op" id="3605166">:=</span>&nbsp;<span class="ident" id="3605169">initNPNRequest</span><span class="op" id="3605183">{</span><span class="ident" id="3605184">tlsConn</span><span class="op" id="3605191">,</span>&nbsp;<span class="ident" id="3605193">serverHandler</span><span class="op" id="3605206">{</span><span class="ident" id="3605207">c</span><span class="op" id="3605208">.</span><span class="ident" id="3605209">server</span><span class="op" id="3605215">}</span><span class="op" id="3605216">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3605222">fn</span><span class="op" id="3605224">(</span><span class="ident" id="3605225">c</span><span class="op" id="3605226">.</span><span class="ident" id="3605227">server</span><span class="op" id="3605233">,</span>&nbsp;<span class="ident" id="3605235">tlsConn</span><span class="op" id="3605242">,</span>&nbsp;<span class="ident" id="3605244">h</span><span class="op" id="3605245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3605250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605255">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3605264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3605267">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605271">for</span>&nbsp;<span class="op" id="3605275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3605279">w</span><span class="op" id="3605280">,</span>&nbsp;<span class="ident" id="3605282">err</span>&nbsp;<span class="op" id="3605286">:=</span>&nbsp;<span class="ident" id="3605289">c</span><span class="op" id="3605290">.</span><span class="ident" id="3605291">readRequest</span><span class="op" id="3605302">(</span><span class="op" id="3605303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605307">if</span>&nbsp;<span class="ident" id="3605310">c</span><span class="op" id="3605311">.</span><span class="ident" id="3605312">lr</span><span class="op" id="3605314">.</span><span class="ident" id="3605315">N</span>&nbsp;<span class="op" id="3605317">!=</span>&nbsp;<span class="ident" id="3605320">c</span><span class="op" id="3605321">.</span><span class="ident" id="3605322">server</span><span class="op" id="3605328">.</span><span class="ident" id="3605329">initialLimitedReaderSize</span><span class="op" id="3605353">(</span><span class="op" id="3605354">)</span>&nbsp;<span class="op" id="3605356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3605361">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3605416">c</span><span class="op" id="3605417">.</span><span class="ident" id="3605418">setState</span><span class="op" id="3605426">(</span><span class="ident" id="3605427">c</span><span class="op" id="3605428">.</span><span class="ident" id="3605429">rwc</span><span class="op" id="3605432">,</span>&nbsp;<span class="ident" id="3605434">StateActive</span><span class="op" id="3605445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3605449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605453">if</span>&nbsp;<span class="ident" id="3605456">err</span>&nbsp;<span class="op" id="3605460">!=</span>&nbsp;<span class="ident" id="3605463">nil</span>&nbsp;<span class="op" id="3605467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605472">if</span>&nbsp;<span class="ident" id="3605475">err</span>&nbsp;<span class="op" id="3605479">==</span>&nbsp;<span class="ident" id="3605482">errTooLarge</span>&nbsp;<span class="op" id="3605494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3605500">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3605543">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3605577">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3605618">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3605659">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3605696">io</span><span class="op" id="3605698">.</span><span class="ident" id="3605699">WriteString</span><span class="op" id="3605710">(</span><span class="ident" id="3605711">c</span><span class="op" id="3605712">.</span><span class="ident" id="3605713">rwc</span><span class="op" id="3605716">,</span>&nbsp;<span class="string" id="3605718">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="3605765">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3605771">c</span><span class="op" id="3605772">.</span><span class="ident" id="3605773">closeWriteAndWait</span><span class="op" id="3605790">(</span><span class="op" id="3605791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605797">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3605806">}</span>&nbsp;<span class="keyword" id="3605808">else</span>&nbsp;<span class="keyword" id="3605813">if</span>&nbsp;<span class="ident" id="3605816">err</span>&nbsp;<span class="op" id="3605820">==</span>&nbsp;<span class="ident" id="3605823">io</span><span class="op" id="3605825">.</span><span class="ident" id="3605826">EOF</span>&nbsp;<span class="op" id="3605830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605836">break</span>&nbsp;<span class="comment" id="3605842">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3605860">}</span>&nbsp;<span class="keyword" id="3605862">else</span>&nbsp;<span class="keyword" id="3605867">if</span>&nbsp;<span class="ident" id="3605870">neterr</span><span class="op" id="3605876">,</span>&nbsp;<span class="ident" id="3605878">ok</span>&nbsp;<span class="op" id="3605881">:=</span>&nbsp;<span class="ident" id="3605884">err</span><span class="op" id="3605887">.</span><span class="op" id="3605888">(</span><span class="ident" id="3605889">net</span><span class="op" id="3605892">.</span><span class="ident" id="3605893">Error</span><span class="op" id="3605898">)</span><span class="op" id="3605899">;</span>&nbsp;<span class="ident" id="3605901">ok</span>&nbsp;<span class="op" id="3605904">&amp;&amp;</span>&nbsp;<span class="ident" id="3605907">neterr</span><span class="op" id="3605913">.</span><span class="ident" id="3605914">Timeout</span><span class="op" id="3605921">(</span><span class="op" id="3605922">)</span>&nbsp;<span class="op" id="3605924">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605930">break</span>&nbsp;<span class="comment" id="3605936">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3605954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3605959">io</span><span class="op" id="3605961">.</span><span class="ident" id="3605962">WriteString</span><span class="op" id="3605973">(</span><span class="ident" id="3605974">c</span><span class="op" id="3605975">.</span><span class="ident" id="3605976">rwc</span><span class="op" id="3605979">,</span>&nbsp;<span class="string" id="3605981">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="3606015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3606020">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3606028">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3606033">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3606066">req</span>&nbsp;<span class="op" id="3606070">:=</span>&nbsp;<span class="ident" id="3606073">w</span><span class="op" id="3606074">.</span><span class="ident" id="3606075">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3606081">if</span>&nbsp;<span class="ident" id="3606084">req</span><span class="op" id="3606087">.</span><span class="ident" id="3606088">expectsContinue</span><span class="op" id="3606103">(</span><span class="op" id="3606104">)</span>&nbsp;<span class="op" id="3606106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3606111">if</span>&nbsp;<span class="ident" id="3606114">req</span><span class="op" id="3606117">.</span><span class="ident" id="3606118">ProtoAtLeast</span><span class="op" id="3606130">(</span><span class="num" id="3606131">1</span><span class="op" id="3606132">,</span>&nbsp;<span class="num" id="3606134">1</span><span class="op" id="3606135">)</span>&nbsp;<span class="op" id="3606137">&amp;&amp;</span>&nbsp;<span class="ident" id="3606140">req</span><span class="op" id="3606143">.</span><span class="ident" id="3606144">ContentLength</span>&nbsp;<span class="op" id="3606158">!=</span>&nbsp;<span class="num" id="3606161">0</span>&nbsp;<span class="op" id="3606163">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3606169">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3606237">req</span><span class="op" id="3606240">.</span><span class="ident" id="3606241">Body</span>&nbsp;<span class="op" id="3606246">=</span>&nbsp;<span class="op" id="3606248">&amp;</span><span class="ident" id="3606249">expectContinueReader</span><span class="op" id="3606269">{</span><span class="ident" id="3606270">readCloser</span><span class="op" id="3606280">:</span>&nbsp;<span class="ident" id="3606282">req</span><span class="op" id="3606285">.</span><span class="ident" id="3606286">Body</span><span class="op" id="3606290">,</span>&nbsp;<span class="ident" id="3606292">resp</span><span class="op" id="3606296">:</span>&nbsp;<span class="ident" id="3606298">w</span><span class="op" id="3606299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3606304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3606309">req</span><span class="op" id="3606312">.</span><span class="ident" id="3606313">Header</span><span class="op" id="3606319">.</span><span class="ident" id="3606320">Del</span><span class="op" id="3606323">(</span><span class="string" id="3606324">&#34;Expect&#34;</span><span class="op" id="3606332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3606336">}</span>&nbsp;<span class="keyword" id="3606338">else</span>&nbsp;<span class="keyword" id="3606343">if</span>&nbsp;<span class="ident" id="3606346">req</span><span class="op" id="3606349">.</span><span class="ident" id="3606350">Header</span><span class="op" id="3606356">.</span><span class="ident" id="3606357">get</span><span class="op" id="3606360">(</span><span class="string" id="3606361">&#34;Expect&#34;</span><span class="op" id="3606369">)</span>&nbsp;<span class="op" id="3606371">!=</span>&nbsp;<span class="string" id="3606374">&#34;&#34;</span>&nbsp;<span class="op" id="3606377">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3606382">w</span><span class="op" id="3606383">.</span><span class="ident" id="3606384">sendExpectationFailed</span><span class="op" id="3606405">(</span><span class="op" id="3606406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3606411">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3606419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3606424">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3606488">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3606558">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3606618">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3606694">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3606758">serverHandler</span><span class="op" id="3606771">{</span><span class="ident" id="3606772">c</span><span class="op" id="3606773">.</span><span class="ident" id="3606774">server</span><span class="op" id="3606780">}</span><span class="op" id="3606781">.</span><span class="ident" id="3606782">ServeHTTP</span><span class="op" id="3606791">(</span><span class="ident" id="3606792">w</span><span class="op" id="3606793">,</span>&nbsp;<span class="ident" id="3606795">w</span><span class="op" id="3606796">.</span><span class="ident" id="3606797">req</span><span class="op" id="3606800">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3606804">if</span>&nbsp;<span class="ident" id="3606807">c</span><span class="op" id="3606808">.</span><span class="ident" id="3606809">hijacked</span><span class="op" id="3606817">(</span><span class="op" id="3606818">)</span>&nbsp;<span class="op" id="3606820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3606825">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3606834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3606838">w</span><span class="op" id="3606839">.</span><span class="ident" id="3606840">finishRequest</span><span class="op" id="3606853">(</span><span class="op" id="3606854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3606858">if</span>&nbsp;<span class="ident" id="3606861">w</span><span class="op" id="3606862">.</span><span class="ident" id="3606863">closeAfterReply</span>&nbsp;<span class="op" id="3606879">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3606884">if</span>&nbsp;<span class="ident" id="3606887">w</span><span class="op" id="3606888">.</span><span class="ident" id="3606889">requestBodyLimitHit</span>&nbsp;<span class="op" id="3606909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3606915">c</span><span class="op" id="3606916">.</span><span class="ident" id="3606917">closeWriteAndWait</span><span class="op" id="3606934">(</span><span class="op" id="3606935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3606940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3606945">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3606953">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3606957">c</span><span class="op" id="3606958">.</span><span class="ident" id="3606959">setState</span><span class="op" id="3606967">(</span><span class="ident" id="3606968">c</span><span class="op" id="3606969">.</span><span class="ident" id="3606970">rwc</span><span class="op" id="3606973">,</span>&nbsp;<span class="ident" id="3606975">StateIdle</span><span class="op" id="3606984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3606987">}</span><br>
<span class="lineno"></span><span class="op" id="3606989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3606992">func</span>&nbsp;<span class="op" id="3606997">(</span><span class="ident" id="3606998">w</span>&nbsp;<span class="op" id="3607000">*</span><span class="ident" id="3607001">response</span><span class="op" id="3607009">)</span>&nbsp;<span class="ident" id="3607011">sendExpectationFailed</span><span class="op" id="3607032">(</span><span class="op" id="3607033">)</span>&nbsp;<span class="op" id="3607035">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607038">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607088">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607141">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607191">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607241">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607281">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607325">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607329">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607383">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607433">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607480">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607528">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3607581">w</span><span class="op" id="3607582">.</span><span class="ident" id="3607583">Header</span><span class="op" id="3607589">(</span><span class="op" id="3607590">)</span><span class="op" id="3607591">.</span><span class="ident" id="3607592">Set</span><span class="op" id="3607595">(</span><span class="string" id="3607596">&#34;Connection&#34;</span><span class="op" id="3607608">,</span>&nbsp;<span class="string" id="3607610">&#34;close&#34;</span><span class="op" id="3607617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3607620">w</span><span class="op" id="3607621">.</span><span class="ident" id="3607622">WriteHeader</span><span class="op" id="3607633">(</span><span class="ident" id="3607634">StatusExpectationFailed</span><span class="op" id="3607657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3607660">w</span><span class="op" id="3607661">.</span><span class="ident" id="3607662">finishRequest</span><span class="op" id="3607675">(</span><span class="op" id="3607676">)</span><br>
<span class="lineno">1235</span><span class="op" id="3607678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3607681">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3607768">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="3607787">func</span>&nbsp;<span class="op" id="3607792">(</span><span class="ident" id="3607793">w</span>&nbsp;<span class="op" id="3607795">*</span><span class="ident" id="3607796">response</span><span class="op" id="3607804">)</span>&nbsp;<span class="ident" id="3607806">Hijack</span><span class="op" id="3607812">(</span><span class="op" id="3607813">)</span>&nbsp;<span class="op" id="3607815">(</span><span class="ident" id="3607816">rwc</span>&nbsp;<span class="ident" id="3607820">net</span><span class="op" id="3607823">.</span><span class="ident" id="3607824">Conn</span><span class="op" id="3607828">,</span>&nbsp;<span class="ident" id="3607830">buf</span>&nbsp;<span class="op" id="3607834">*</span><span class="ident" id="3607835">bufio</span><span class="op" id="3607840">.</span><span class="ident" id="3607841">ReadWriter</span><span class="op" id="3607851">,</span>&nbsp;<span class="ident" id="3607853">err</span>&nbsp;<span class="builtintype" id="3607857">error</span><span class="op" id="3607862">)</span>&nbsp;<span class="op" id="3607864">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3607867">if</span>&nbsp;<span class="ident" id="3607870">w</span><span class="op" id="3607871">.</span><span class="ident" id="3607872">wroteHeader</span>&nbsp;<span class="op" id="3607884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3607888">w</span><span class="op" id="3607889">.</span><span class="ident" id="3607890">cw</span><span class="op" id="3607892">.</span><span class="ident" id="3607893">flush</span><span class="op" id="3607898">(</span><span class="op" id="3607899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3607902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607905">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3607976">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3608023">rwc</span><span class="op" id="3608026">,</span>&nbsp;<span class="ident" id="3608028">buf</span><span class="op" id="3608031">,</span>&nbsp;<span class="ident" id="3608033">err</span>&nbsp;<span class="op" id="3608037">=</span>&nbsp;<span class="ident" id="3608039">w</span><span class="op" id="3608040">.</span><span class="ident" id="3608041">conn</span><span class="op" id="3608045">.</span><span class="ident" id="3608046">hijack</span><span class="op" id="3608052">(</span><span class="op" id="3608053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3608056">if</span>&nbsp;<span class="ident" id="3608059">err</span>&nbsp;<span class="op" id="3608063">==</span>&nbsp;<span class="ident" id="3608066">nil</span>&nbsp;<span class="op" id="3608070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3608074">putBufioWriter</span><span class="op" id="3608088">(</span><span class="ident" id="3608089">w</span><span class="op" id="3608090">.</span><span class="ident" id="3608091">w</span><span class="op" id="3608092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3608096">w</span><span class="op" id="3608097">.</span><span class="ident" id="3608098">w</span>&nbsp;<span class="op" id="3608100">=</span>&nbsp;<span class="ident" id="3608102">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3608107">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3608110">return</span>&nbsp;<span class="ident" id="3608117">rwc</span><span class="op" id="3608120">,</span>&nbsp;<span class="ident" id="3608122">buf</span><span class="op" id="3608125">,</span>&nbsp;<span class="ident" id="3608127">err</span><br>
<span class="lineno"></span><span class="op" id="3608131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3608134">func</span>&nbsp;<span class="op" id="3608139">(</span><span class="ident" id="3608140">w</span>&nbsp;<span class="op" id="3608142">*</span><span class="ident" id="3608143">response</span><span class="op" id="3608151">)</span>&nbsp;<span class="ident" id="3608153">CloseNotify</span><span class="op" id="3608164">(</span><span class="op" id="3608165">)</span>&nbsp;<span class="op" id="3608167">&lt;-</span><span class="keyword" id="3608169">chan</span>&nbsp;<span class="builtintype" id="3608174">bool</span>&nbsp;<span class="op" id="3608179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3608182">return</span>&nbsp;<span class="ident" id="3608189">w</span><span class="op" id="3608190">.</span><span class="ident" id="3608191">conn</span><span class="op" id="3608195">.</span><span class="ident" id="3608196">closeNotify</span><span class="op" id="3608207">(</span><span class="op" id="3608208">)</span><br>
<span class="lineno">1255</span><span class="op" id="3608210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3608213">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3608271">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="3608331">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="3608386">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="3608418">type</span>&nbsp;<span class="ident" id="3608423">HandlerFunc</span>&nbsp;<span class="keyword" id="3608435">func</span><span class="op" id="3608439">(</span><span class="ident" id="3608440">ResponseWriter</span><span class="op" id="3608454">,</span>&nbsp;<span class="op" id="3608456">*</span><span class="ident" id="3608457">Request</span><span class="op" id="3608464">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3608467">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="3608495">func</span>&nbsp;<span class="op" id="3608500">(</span><span class="ident" id="3608501">f</span>&nbsp;<span class="ident" id="3608503">HandlerFunc</span><span class="op" id="3608514">)</span>&nbsp;<span class="ident" id="3608516">ServeHTTP</span><span class="op" id="3608525">(</span><span class="ident" id="3608526">w</span>&nbsp;<span class="ident" id="3608528">ResponseWriter</span><span class="op" id="3608542">,</span>&nbsp;<span class="ident" id="3608544">r</span>&nbsp;<span class="op" id="3608546">*</span><span class="ident" id="3608547">Request</span><span class="op" id="3608554">)</span>&nbsp;<span class="op" id="3608556">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3608559">f</span><span class="op" id="3608560">(</span><span class="ident" id="3608561">w</span><span class="op" id="3608562">,</span>&nbsp;<span class="ident" id="3608564">r</span><span class="op" id="3608565">)</span><br>
<span class="lineno"></span><span class="op" id="3608567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3608570">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="3608590">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="3608670">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="3608713">func</span>&nbsp;<span class="ident" id="3608718">Error</span><span class="op" id="3608723">(</span><span class="ident" id="3608724">w</span>&nbsp;<span class="ident" id="3608726">ResponseWriter</span><span class="op" id="3608740">,</span>&nbsp;<span class="builtintype" id="3608742">error</span>&nbsp;<span class="builtintype" id="3608748">string</span><span class="op" id="3608754">,</span>&nbsp;<span class="ident" id="3608756">code</span>&nbsp;<span class="builtintype" id="3608761">int</span><span class="op" id="3608764">)</span>&nbsp;<span class="op" id="3608766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3608769">w</span><span class="op" id="3608770">.</span><span class="ident" id="3608771">Header</span><span class="op" id="3608777">(</span><span class="op" id="3608778">)</span><span class="op" id="3608779">.</span><span class="ident" id="3608780">Set</span><span class="op" id="3608783">(</span><span class="string" id="3608784">&#34;Content-Type&#34;</span><span class="op" id="3608798">,</span>&nbsp;<span class="string" id="3608800">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="3608827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3608830">w</span><span class="op" id="3608831">.</span><span class="ident" id="3608832">WriteHeader</span><span class="op" id="3608843">(</span><span class="ident" id="3608844">code</span><span class="op" id="3608848">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3608851">fmt</span><span class="op" id="3608854">.</span><span class="ident" id="3608855">Fprintln</span><span class="op" id="3608863">(</span><span class="ident" id="3608864">w</span><span class="op" id="3608865">,</span>&nbsp;<span class="builtintype" id="3608867">error</span><span class="op" id="3608872">)</span><br>
<span class="lineno"></span><span class="op" id="3608874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3608877">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3608946">func</span>&nbsp;<span class="ident" id="3608951">NotFound</span><span class="op" id="3608959">(</span><span class="ident" id="3608960">w</span>&nbsp;<span class="ident" id="3608962">ResponseWriter</span><span class="op" id="3608976">,</span>&nbsp;<span class="ident" id="3608978">r</span>&nbsp;<span class="op" id="3608980">*</span><span class="ident" id="3608981">Request</span><span class="op" id="3608988">)</span>&nbsp;<span class="op" id="3608990">{</span>&nbsp;<span class="ident" id="3608992">Error</span><span class="op" id="3608997">(</span><span class="ident" id="3608998">w</span><span class="op" id="3608999">,</span>&nbsp;<span class="string" id="3609001">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="3609021">,</span>&nbsp;<span class="ident" id="3609023">StatusNotFound</span><span class="op" id="3609037">)</span>&nbsp;<span class="op" id="3609039">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="3609042">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="3609094">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3609163">func</span>&nbsp;<span class="ident" id="3609168">NotFoundHandler</span><span class="op" id="3609183">(</span><span class="op" id="3609184">)</span>&nbsp;<span class="ident" id="3609186">Handler</span>&nbsp;<span class="op" id="3609194">{</span>&nbsp;<span class="keyword" id="3609196">return</span>&nbsp;<span class="ident" id="3609203">HandlerFunc</span><span class="op" id="3609214">(</span><span class="ident" id="3609215">NotFound</span><span class="op" id="3609223">)</span>&nbsp;<span class="op" id="3609225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="3609228">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3609287">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="3609347">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3609400">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3609456">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="3609502">func</span>&nbsp;<span class="ident" id="3609507">StripPrefix</span><span class="op" id="3609518">(</span><span class="ident" id="3609519">prefix</span>&nbsp;<span class="builtintype" id="3609526">string</span><span class="op" id="3609532">,</span>&nbsp;<span class="ident" id="3609534">h</span>&nbsp;<span class="ident" id="3609536">Handler</span><span class="op" id="3609543">)</span>&nbsp;<span class="ident" id="3609545">Handler</span>&nbsp;<span class="op" id="3609553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3609556">if</span>&nbsp;<span class="ident" id="3609559">prefix</span>&nbsp;<span class="op" id="3609566">==</span>&nbsp;<span class="string" id="3609569">&#34;&#34;</span>&nbsp;<span class="op" id="3609572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3609576">return</span>&nbsp;<span class="ident" id="3609583">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3609586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3609589">return</span>&nbsp;<span class="ident" id="3609596">HandlerFunc</span><span class="op" id="3609607">(</span><span class="keyword" id="3609608">func</span><span class="op" id="3609612">(</span><span class="ident" id="3609613">w</span>&nbsp;<span class="ident" id="3609615">ResponseWriter</span><span class="op" id="3609629">,</span>&nbsp;<span class="ident" id="3609631">r</span>&nbsp;<span class="op" id="3609633">*</span><span class="ident" id="3609634">Request</span><span class="op" id="3609641">)</span>&nbsp;<span class="op" id="3609643">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3609647">if</span>&nbsp;<span class="ident" id="3609650">p</span>&nbsp;<span class="op" id="3609652">:=</span>&nbsp;<span class="ident" id="3609655">strings</span><span class="op" id="3609662">.</span><span class="ident" id="3609663">TrimPrefix</span><span class="op" id="3609673">(</span><span class="ident" id="3609674">r</span><span class="op" id="3609675">.</span><span class="ident" id="3609676">URL</span><span class="op" id="3609679">.</span><span class="ident" id="3609680">Path</span><span class="op" id="3609684">,</span>&nbsp;<span class="ident" id="3609686">prefix</span><span class="op" id="3609692">)</span><span class="op" id="3609693">;</span>&nbsp;<span class="builtinfunc" id="3609695">len</span><span class="op" id="3609698">(</span><span class="ident" id="3609699">p</span><span class="op" id="3609700">)</span>&nbsp;<span class="op" id="3609702">&lt;</span>&nbsp;<span class="builtinfunc" id="3609704">len</span><span class="op" id="3609707">(</span><span class="ident" id="3609708">r</span><span class="op" id="3609709">.</span><span class="ident" id="3609710">URL</span><span class="op" id="3609713">.</span><span class="ident" id="3609714">Path</span><span class="op" id="3609718">)</span>&nbsp;<span class="op" id="3609720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3609725">r</span><span class="op" id="3609726">.</span><span class="ident" id="3609727">URL</span><span class="op" id="3609730">.</span><span class="ident" id="3609731">Path</span>&nbsp;<span class="op" id="3609736">=</span>&nbsp;<span class="ident" id="3609738">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3609743">h</span><span class="op" id="3609744">.</span><span class="ident" id="3609745">ServeHTTP</span><span class="op" id="3609754">(</span><span class="ident" id="3609755">w</span><span class="op" id="3609756">,</span>&nbsp;<span class="ident" id="3609758">r</span><span class="op" id="3609759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3609763">}</span>&nbsp;<span class="keyword" id="3609765">else</span>&nbsp;<span class="op" id="3609770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3609775">NotFound</span><span class="op" id="3609783">(</span><span class="ident" id="3609784">w</span><span class="op" id="3609785">,</span>&nbsp;<span class="ident" id="3609787">r</span><span class="op" id="3609788">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3609792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3609795">}</span><span class="op" id="3609796">)</span><br>
<span class="lineno"></span><span class="op" id="3609798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3609801">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="3609860">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="3609913">func</span>&nbsp;<span class="ident" id="3609918">Redirect</span><span class="op" id="3609926">(</span><span class="ident" id="3609927">w</span>&nbsp;<span class="ident" id="3609929">ResponseWriter</span><span class="op" id="3609943">,</span>&nbsp;<span class="ident" id="3609945">r</span>&nbsp;<span class="op" id="3609947">*</span><span class="ident" id="3609948">Request</span><span class="op" id="3609955">,</span>&nbsp;<span class="ident" id="3609957">urlStr</span>&nbsp;<span class="builtintype" id="3609964">string</span><span class="op" id="3609970">,</span>&nbsp;<span class="ident" id="3609972">code</span>&nbsp;<span class="builtintype" id="3609977">int</span><span class="op" id="3609980">)</span>&nbsp;<span class="op" id="3609982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3609985">if</span>&nbsp;<span class="ident" id="3609988">u</span><span class="op" id="3609989">,</span>&nbsp;<span class="ident" id="3609991">err</span>&nbsp;<span class="op" id="3609995">:=</span>&nbsp;<span class="ident" id="3609998">url</span><span class="op" id="3610001">.</span><span class="ident" id="3610002">Parse</span><span class="op" id="3610007">(</span><span class="ident" id="3610008">urlStr</span><span class="op" id="3610014">)</span><span class="op" id="3610015">;</span>&nbsp;<span class="ident" id="3610017">err</span>&nbsp;<span class="op" id="3610021">==</span>&nbsp;<span class="ident" id="3610024">nil</span>&nbsp;<span class="op" id="3610028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610032">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610075">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610109">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610157">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610204">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610252">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610292">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610332">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610367">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610409">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610454">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610502">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610549">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610601">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610654">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610669">oldpath</span>&nbsp;<span class="op" id="3610677">:=</span>&nbsp;<span class="ident" id="3610680">r</span><span class="op" id="3610681">.</span><span class="ident" id="3610682">URL</span><span class="op" id="3610685">.</span><span class="ident" id="3610686">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3610693">if</span>&nbsp;<span class="ident" id="3610696">oldpath</span>&nbsp;<span class="op" id="3610704">==</span>&nbsp;<span class="string" id="3610707">&#34;&#34;</span>&nbsp;<span class="op" id="3610710">{</span>&nbsp;<span class="comment" id="3610712">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610766">oldpath</span>&nbsp;<span class="op" id="3610774">=</span>&nbsp;<span class="string" id="3610776">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3610782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3610786">if</span>&nbsp;<span class="ident" id="3610789">u</span><span class="op" id="3610790">.</span><span class="ident" id="3610791">Scheme</span>&nbsp;<span class="op" id="3610798">==</span>&nbsp;<span class="string" id="3610801">&#34;&#34;</span>&nbsp;<span class="op" id="3610804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610809">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3610840">if</span>&nbsp;<span class="ident" id="3610843">urlStr</span>&nbsp;<span class="op" id="3610850">==</span>&nbsp;<span class="string" id="3610853">&#34;&#34;</span>&nbsp;<span class="op" id="3610856">||</span>&nbsp;<span class="ident" id="3610859">urlStr</span><span class="op" id="3610865">[</span><span class="num" id="3610866">0</span><span class="op" id="3610867">]</span>&nbsp;<span class="op" id="3610869">!=</span>&nbsp;<span class="string" id="3610872">&#39;/&#39;</span>&nbsp;<span class="op" id="3610876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3610882">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610917">olddir</span><span class="op" id="3610923">,</span>&nbsp;<span class="ident" id="3610925">_</span>&nbsp;<span class="op" id="3610927">:=</span>&nbsp;<span class="ident" id="3610930">path</span><span class="op" id="3610934">.</span><span class="ident" id="3610935">Split</span><span class="op" id="3610940">(</span><span class="ident" id="3610941">oldpath</span><span class="op" id="3610948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3610954">urlStr</span>&nbsp;<span class="op" id="3610961">=</span>&nbsp;<span class="ident" id="3610963">olddir</span>&nbsp;<span class="op" id="3610970">+</span>&nbsp;<span class="ident" id="3610972">urlStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3610982">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3610988">var</span>&nbsp;<span class="ident" id="3610992">query</span>&nbsp;<span class="builtintype" id="3610998">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611008">if</span>&nbsp;<span class="ident" id="3611011">i</span>&nbsp;<span class="op" id="3611013">:=</span>&nbsp;<span class="ident" id="3611016">strings</span><span class="op" id="3611023">.</span><span class="ident" id="3611024">Index</span><span class="op" id="3611029">(</span><span class="ident" id="3611030">urlStr</span><span class="op" id="3611036">,</span>&nbsp;<span class="string" id="3611038">&#34;?&#34;</span><span class="op" id="3611041">)</span><span class="op" id="3611042">;</span>&nbsp;<span class="ident" id="3611044">i</span>&nbsp;<span class="op" id="3611046">!=</span>&nbsp;<span class="op" id="3611049">-</span><span class="num" id="3611050">1</span>&nbsp;<span class="op" id="3611052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611058">urlStr</span><span class="op" id="3611064">,</span>&nbsp;<span class="ident" id="3611066">query</span>&nbsp;<span class="op" id="3611072">=</span>&nbsp;<span class="ident" id="3611074">urlStr</span><span class="op" id="3611080">[</span><span class="op" id="3611081">:</span><span class="ident" id="3611082">i</span><span class="op" id="3611083">]</span><span class="op" id="3611084">,</span>&nbsp;<span class="ident" id="3611086">urlStr</span><span class="op" id="3611092">[</span><span class="ident" id="3611093">i</span><span class="op" id="3611094">:</span><span class="op" id="3611095">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611100">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3611106">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611149">trailing</span>&nbsp;<span class="op" id="3611158">:=</span>&nbsp;<span class="ident" id="3611161">strings</span><span class="op" id="3611168">.</span><span class="ident" id="3611169">HasSuffix</span><span class="op" id="3611178">(</span><span class="ident" id="3611179">urlStr</span><span class="op" id="3611185">,</span>&nbsp;<span class="string" id="3611187">&#34;/&#34;</span><span class="op" id="3611190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611195">urlStr</span>&nbsp;<span class="op" id="3611202">=</span>&nbsp;<span class="ident" id="3611204">path</span><span class="op" id="3611208">.</span><span class="ident" id="3611209">Clean</span><span class="op" id="3611214">(</span><span class="ident" id="3611215">urlStr</span><span class="op" id="3611221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611226">if</span>&nbsp;<span class="ident" id="3611229">trailing</span>&nbsp;<span class="op" id="3611238">&amp;&amp;</span>&nbsp;<span class="op" id="3611241">!</span><span class="ident" id="3611242">strings</span><span class="op" id="3611249">.</span><span class="ident" id="3611250">HasSuffix</span><span class="op" id="3611259">(</span><span class="ident" id="3611260">urlStr</span><span class="op" id="3611266">,</span>&nbsp;<span class="string" id="3611268">&#34;/&#34;</span><span class="op" id="3611271">)</span>&nbsp;<span class="op" id="3611273">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611279">urlStr</span>&nbsp;<span class="op" id="3611286">+=</span>&nbsp;<span class="string" id="3611289">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611301">urlStr</span>&nbsp;<span class="op" id="3611308">+=</span>&nbsp;<span class="ident" id="3611311">query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611322">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611326">w</span><span class="op" id="3611327">.</span><span class="ident" id="3611328">Header</span><span class="op" id="3611334">(</span><span class="op" id="3611335">)</span><span class="op" id="3611336">.</span><span class="ident" id="3611337">Set</span><span class="op" id="3611340">(</span><span class="string" id="3611341">&#34;Location&#34;</span><span class="op" id="3611351">,</span>&nbsp;<span class="ident" id="3611353">urlStr</span><span class="op" id="3611359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611362">w</span><span class="op" id="3611363">.</span><span class="ident" id="3611364">WriteHeader</span><span class="op" id="3611375">(</span><span class="ident" id="3611376">code</span><span class="op" id="3611380">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3611384">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3611453">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3611520">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611587">if</span>&nbsp;<span class="ident" id="3611590">r</span><span class="op" id="3611591">.</span><span class="ident" id="3611592">Method</span>&nbsp;<span class="op" id="3611599">==</span>&nbsp;<span class="string" id="3611602">&#34;GET&#34;</span>&nbsp;<span class="op" id="3611608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611612">note</span>&nbsp;<span class="op" id="3611617">:=</span>&nbsp;<span class="string" id="3611620">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="3611633">+</span>&nbsp;<span class="ident" id="3611635">htmlEscape</span><span class="op" id="3611645">(</span><span class="ident" id="3611646">urlStr</span><span class="op" id="3611652">)</span>&nbsp;<span class="op" id="3611654">+</span>&nbsp;<span class="string" id="3611656">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="3611662">+</span>&nbsp;<span class="ident" id="3611664">statusText</span><span class="op" id="3611674">[</span><span class="ident" id="3611675">code</span><span class="op" id="3611679">]</span>&nbsp;<span class="op" id="3611681">+</span>&nbsp;<span class="string" id="3611683">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3611695">fmt</span><span class="op" id="3611698">.</span><span class="ident" id="3611699">Fprintln</span><span class="op" id="3611707">(</span><span class="ident" id="3611708">w</span><span class="op" id="3611709">,</span>&nbsp;<span class="ident" id="3611711">note</span><span class="op" id="3611715">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3611718">}</span><br>
<span class="lineno"></span><span class="op" id="3611720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3611723">var</span>&nbsp;<span class="ident" id="3611727">htmlReplacer</span>&nbsp;<span class="op" id="3611740">=</span>&nbsp;<span class="ident" id="3611742">strings</span><span class="op" id="3611749">.</span><span class="ident" id="3611750">NewReplacer</span><span class="op" id="3611761">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3611764">&#34;&amp;&#34;</span><span class="op" id="3611767">,</span>&nbsp;<span class="string" id="3611769">&#34;&amp;amp;&#34;</span><span class="op" id="3611776">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3611779">&#34;&lt;&#34;</span><span class="op" id="3611782">,</span>&nbsp;<span class="string" id="3611784">&#34;&amp;lt;&#34;</span><span class="op" id="3611790">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3611793">&#34;&gt;&#34;</span><span class="op" id="3611796">,</span>&nbsp;<span class="string" id="3611798">&#34;&amp;gt;&#34;</span><span class="op" id="3611804">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3611807">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3611845">`&#34;`</span><span class="op" id="3611848">,</span>&nbsp;<span class="string" id="3611850">&#34;&amp;#34;&#34;</span><span class="op" id="3611857">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3611860">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3611935">&#34;&#39;&#34;</span><span class="op" id="3611938">,</span>&nbsp;<span class="string" id="3611940">&#34;&amp;#39;&#34;</span><span class="op" id="3611947">,</span><br>
<span class="lineno"></span><span class="op" id="3611949">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3611952">func</span>&nbsp;<span class="ident" id="3611957">htmlEscape</span><span class="op" id="3611967">(</span><span class="ident" id="3611968">s</span>&nbsp;<span class="builtintype" id="3611970">string</span><span class="op" id="3611976">)</span>&nbsp;<span class="builtintype" id="3611978">string</span>&nbsp;<span class="op" id="3611985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3611988">return</span>&nbsp;<span class="ident" id="3611995">htmlReplacer</span><span class="op" id="3612007">.</span><span class="ident" id="3612008">Replace</span><span class="op" id="3612015">(</span><span class="ident" id="3612016">s</span><span class="op" id="3612017">)</span><br>
<span class="lineno">1375</span><span class="op" id="3612019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3612022">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="3612049">type</span>&nbsp;<span class="ident" id="3612054">redirectHandler</span>&nbsp;<span class="keyword" id="3612070">struct</span>&nbsp;<span class="op" id="3612077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3612080">url</span>&nbsp;&nbsp;<span class="builtintype" id="3612085">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3612093">code</span>&nbsp;<span class="builtintype" id="3612098">int</span><br>
<span class="lineno"></span><span class="op" id="3612102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3612105">func</span>&nbsp;<span class="op" id="3612110">(</span><span class="ident" id="3612111">rh</span>&nbsp;<span class="op" id="3612114">*</span><span class="ident" id="3612115">redirectHandler</span><span class="op" id="3612130">)</span>&nbsp;<span class="ident" id="3612132">ServeHTTP</span><span class="op" id="3612141">(</span><span class="ident" id="3612142">w</span>&nbsp;<span class="ident" id="3612144">ResponseWriter</span><span class="op" id="3612158">,</span>&nbsp;<span class="ident" id="3612160">r</span>&nbsp;<span class="op" id="3612162">*</span><span class="ident" id="3612163">Request</span><span class="op" id="3612170">)</span>&nbsp;<span class="op" id="3612172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3612175">Redirect</span><span class="op" id="3612183">(</span><span class="ident" id="3612184">w</span><span class="op" id="3612185">,</span>&nbsp;<span class="ident" id="3612187">r</span><span class="op" id="3612188">,</span>&nbsp;<span class="ident" id="3612190">rh</span><span class="op" id="3612192">.</span><span class="ident" id="3612193">url</span><span class="op" id="3612196">,</span>&nbsp;<span class="ident" id="3612198">rh</span><span class="op" id="3612200">.</span><span class="ident" id="3612201">code</span><span class="op" id="3612205">)</span><br>
<span class="lineno">1385</span><span class="op" id="3612207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3612210">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="3612270">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="3612331">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="3612347">func</span>&nbsp;<span class="ident" id="3612352">RedirectHandler</span><span class="op" id="3612367">(</span><span class="ident" id="3612368">url</span>&nbsp;<span class="builtintype" id="3612372">string</span><span class="op" id="3612378">,</span>&nbsp;<span class="ident" id="3612380">code</span>&nbsp;<span class="builtintype" id="3612385">int</span><span class="op" id="3612388">)</span>&nbsp;<span class="ident" id="3612390">Handler</span>&nbsp;<span class="op" id="3612398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3612401">return</span>&nbsp;<span class="op" id="3612408">&amp;</span><span class="ident" id="3612409">redirectHandler</span><span class="op" id="3612424">{</span><span class="ident" id="3612425">url</span><span class="op" id="3612428">,</span>&nbsp;<span class="ident" id="3612430">code</span><span class="op" id="3612434">}</span><br>
<span class="lineno"></span><span class="op" id="3612436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3612439">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="3612483">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="3612559">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3612614">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="3612647">//</span><br>
<span class="lineno"></span><span class="comment" id="3612650">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="3612709">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="3612775">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3612837">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3612893">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3612950">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="3613010">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3613069">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="3613092">//</span><br>
<span class="lineno"></span><span class="comment" id="3613095">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="3613166">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="3613235">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3613283">//</span><br>
<span class="lineno"></span><span class="comment" id="3613286">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3613360">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3613432">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="3613507">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3613578">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3613620">//</span><br>
<span class="lineno"></span><span class="comment" id="3613623">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="3613687">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="3613748">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3613782">type</span>&nbsp;<span class="ident" id="3613787">ServeMux</span>&nbsp;<span class="keyword" id="3613796">struct</span>&nbsp;<span class="op" id="3613803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613806">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3613812">sync</span><span class="op" id="3613816">.</span><span class="ident" id="3613817">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613826">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3613832">map</span><span class="op" id="3613835">[</span><span class="builtintype" id="3613836">string</span><span class="op" id="3613842">]</span><span class="ident" id="3613843">muxEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613853">hosts</span>&nbsp;<span class="builtintype" id="3613859">bool</span>&nbsp;<span class="comment" id="3613864">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="3613906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3613909">type</span>&nbsp;<span class="ident" id="3613914">muxEntry</span>&nbsp;<span class="keyword" id="3613923">struct</span>&nbsp;<span class="op" id="3613930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613933">explicit</span>&nbsp;<span class="builtintype" id="3613942">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613948">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3613957">Handler</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3613966">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="3613975">string</span><br>
<span class="lineno"></span><span class="op" id="3613982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3613985">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="3614038">func</span>&nbsp;<span class="ident" id="3614043">NewServeMux</span><span class="op" id="3614054">(</span><span class="op" id="3614055">)</span>&nbsp;<span class="op" id="3614057">*</span><span class="ident" id="3614058">ServeMux</span>&nbsp;<span class="op" id="3614067">{</span>&nbsp;<span class="keyword" id="3614069">return</span>&nbsp;<span class="op" id="3614076">&amp;</span><span class="ident" id="3614077">ServeMux</span><span class="op" id="3614085">{</span><span class="ident" id="3614086">m</span><span class="op" id="3614087">:</span>&nbsp;<span class="builtinfunc" id="3614089">make</span><span class="op" id="3614093">(</span><span class="keyword" id="3614094">map</span><span class="op" id="3614097">[</span><span class="builtintype" id="3614098">string</span><span class="op" id="3614104">]</span><span class="ident" id="3614105">muxEntry</span><span class="op" id="3614113">)</span><span class="op" id="3614114">}</span>&nbsp;<span class="op" id="3614116">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="3614119">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="3614177">var</span>&nbsp;<span class="ident" id="3614181">DefaultServeMux</span>&nbsp;<span class="op" id="3614197">=</span>&nbsp;<span class="ident" id="3614199">NewServeMux</span><span class="op" id="3614210">(</span><span class="op" id="3614211">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3614214">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="3614242">func</span>&nbsp;<span class="ident" id="3614247">pathMatch</span><span class="op" id="3614256">(</span><span class="ident" id="3614257">pattern</span><span class="op" id="3614264">,</span>&nbsp;<span class="ident" id="3614266">path</span>&nbsp;<span class="builtintype" id="3614271">string</span><span class="op" id="3614277">)</span>&nbsp;<span class="builtintype" id="3614279">bool</span>&nbsp;<span class="op" id="3614284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614287">if</span>&nbsp;<span class="builtinfunc" id="3614290">len</span><span class="op" id="3614293">(</span><span class="ident" id="3614294">pattern</span><span class="op" id="3614301">)</span>&nbsp;<span class="op" id="3614303">==</span>&nbsp;<span class="num" id="3614306">0</span>&nbsp;<span class="op" id="3614308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3614312">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614335">return</span>&nbsp;<span class="ident" id="3614342">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3614349">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3614352">n</span>&nbsp;<span class="op" id="3614354">:=</span>&nbsp;<span class="builtinfunc" id="3614357">len</span><span class="op" id="3614360">(</span><span class="ident" id="3614361">pattern</span><span class="op" id="3614368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614371">if</span>&nbsp;<span class="ident" id="3614374">pattern</span><span class="op" id="3614381">[</span><span class="ident" id="3614382">n</span><span class="op" id="3614383">-</span><span class="num" id="3614384">1</span><span class="op" id="3614385">]</span>&nbsp;<span class="op" id="3614387">!=</span>&nbsp;<span class="string" id="3614390">&#39;/&#39;</span>&nbsp;<span class="op" id="3614394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614398">return</span>&nbsp;<span class="ident" id="3614405">pattern</span>&nbsp;<span class="op" id="3614413">==</span>&nbsp;<span class="ident" id="3614416">path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3614422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614425">return</span>&nbsp;<span class="builtinfunc" id="3614432">len</span><span class="op" id="3614435">(</span><span class="ident" id="3614436">path</span><span class="op" id="3614440">)</span>&nbsp;<span class="op" id="3614442">&gt;=</span>&nbsp;<span class="ident" id="3614445">n</span>&nbsp;<span class="op" id="3614447">&amp;&amp;</span>&nbsp;<span class="ident" id="3614450">path</span><span class="op" id="3614454">[</span><span class="num" id="3614455">0</span><span class="op" id="3614456">:</span><span class="ident" id="3614457">n</span><span class="op" id="3614458">]</span>&nbsp;<span class="op" id="3614460">==</span>&nbsp;<span class="ident" id="3614463">pattern</span><br>
<span class="lineno">1450</span><span class="op" id="3614471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3614474">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="3614541">func</span>&nbsp;<span class="ident" id="3614546">cleanPath</span><span class="op" id="3614555">(</span><span class="ident" id="3614556">p</span>&nbsp;<span class="builtintype" id="3614558">string</span><span class="op" id="3614564">)</span>&nbsp;<span class="builtintype" id="3614566">string</span>&nbsp;<span class="op" id="3614573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614576">if</span>&nbsp;<span class="ident" id="3614579">p</span>&nbsp;<span class="op" id="3614581">==</span>&nbsp;<span class="string" id="3614584">&#34;&#34;</span>&nbsp;<span class="op" id="3614587">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614591">return</span>&nbsp;<span class="string" id="3614598">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3614603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614606">if</span>&nbsp;<span class="ident" id="3614609">p</span><span class="op" id="3614610">[</span><span class="num" id="3614611">0</span><span class="op" id="3614612">]</span>&nbsp;<span class="op" id="3614614">!=</span>&nbsp;<span class="string" id="3614617">&#39;/&#39;</span>&nbsp;<span class="op" id="3614621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3614625">p</span>&nbsp;<span class="op" id="3614627">=</span>&nbsp;<span class="string" id="3614629">&#34;/&#34;</span>&nbsp;<span class="op" id="3614633">+</span>&nbsp;<span class="ident" id="3614635">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3614638">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3614641">np</span>&nbsp;<span class="op" id="3614644">:=</span>&nbsp;<span class="ident" id="3614647">path</span><span class="op" id="3614651">.</span><span class="ident" id="3614652">Clean</span><span class="op" id="3614657">(</span><span class="ident" id="3614658">p</span><span class="op" id="3614659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3614662">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3614717">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614763">if</span>&nbsp;<span class="ident" id="3614766">p</span><span class="op" id="3614767">[</span><span class="builtinfunc" id="3614768">len</span><span class="op" id="3614771">(</span><span class="ident" id="3614772">p</span><span class="op" id="3614773">)</span><span class="op" id="3614774">-</span><span class="num" id="3614775">1</span><span class="op" id="3614776">]</span>&nbsp;<span class="op" id="3614778">==</span>&nbsp;<span class="string" id="3614781">&#39;/&#39;</span>&nbsp;<span class="op" id="3614785">&amp;&amp;</span>&nbsp;<span class="ident" id="3614788">np</span>&nbsp;<span class="op" id="3614791">!=</span>&nbsp;<span class="string" id="3614794">&#34;/&#34;</span>&nbsp;<span class="op" id="3614798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3614802">np</span>&nbsp;<span class="op" id="3614805">+=</span>&nbsp;<span class="string" id="3614808">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3614813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614816">return</span>&nbsp;<span class="ident" id="3614823">np</span><br>
<span class="lineno"></span><span class="op" id="3614826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3614829">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="3614884">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="3614924">func</span>&nbsp;<span class="op" id="3614929">(</span><span class="ident" id="3614930">mux</span>&nbsp;<span class="op" id="3614934">*</span><span class="ident" id="3614935">ServeMux</span><span class="op" id="3614943">)</span>&nbsp;<span class="ident" id="3614945">match</span><span class="op" id="3614950">(</span><span class="ident" id="3614951">path</span>&nbsp;<span class="builtintype" id="3614956">string</span><span class="op" id="3614962">)</span>&nbsp;<span class="op" id="3614964">(</span><span class="ident" id="3614965">h</span>&nbsp;<span class="ident" id="3614967">Handler</span><span class="op" id="3614974">,</span>&nbsp;<span class="ident" id="3614976">pattern</span>&nbsp;<span class="builtintype" id="3614984">string</span><span class="op" id="3614990">)</span>&nbsp;<span class="op" id="3614992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3614995">var</span>&nbsp;<span class="ident" id="3614999">n</span>&nbsp;<span class="op" id="3615001">=</span>&nbsp;<span class="num" id="3615003">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3615006">for</span>&nbsp;<span class="ident" id="3615010">k</span><span class="op" id="3615011">,</span>&nbsp;<span class="ident" id="3615013">v</span>&nbsp;<span class="op" id="3615015">:=</span>&nbsp;<span class="keyword" id="3615018">range</span>&nbsp;<span class="ident" id="3615024">mux</span><span class="op" id="3615027">.</span><span class="ident" id="3615028">m</span>&nbsp;<span class="op" id="3615030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3615034">if</span>&nbsp;<span class="op" id="3615037">!</span><span class="ident" id="3615038">pathMatch</span><span class="op" id="3615047">(</span><span class="ident" id="3615048">k</span><span class="op" id="3615049">,</span>&nbsp;<span class="ident" id="3615051">path</span><span class="op" id="3615055">)</span>&nbsp;<span class="op" id="3615057">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3615062">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3615073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3615077">if</span>&nbsp;<span class="ident" id="3615080">h</span>&nbsp;<span class="op" id="3615082">==</span>&nbsp;<span class="ident" id="3615085">nil</span>&nbsp;<span class="op" id="3615089">||</span>&nbsp;<span class="builtinfunc" id="3615092">len</span><span class="op" id="3615095">(</span><span class="ident" id="3615096">k</span><span class="op" id="3615097">)</span>&nbsp;<span class="op" id="3615099">&gt;</span>&nbsp;<span class="ident" id="3615101">n</span>&nbsp;<span class="op" id="3615103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3615108">n</span>&nbsp;<span class="op" id="3615110">=</span>&nbsp;<span class="builtinfunc" id="3615112">len</span><span class="op" id="3615115">(</span><span class="ident" id="3615116">k</span><span class="op" id="3615117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3615122">h</span>&nbsp;<span class="op" id="3615124">=</span>&nbsp;<span class="ident" id="3615126">v</span><span class="op" id="3615127">.</span><span class="ident" id="3615128">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3615133">pattern</span>&nbsp;<span class="op" id="3615141">=</span>&nbsp;<span class="ident" id="3615143">v</span><span class="op" id="3615144">.</span><span class="ident" id="3615145">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3615155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3615158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3615161">return</span><br>
<span class="lineno"></span><span class="op" id="3615168">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="3615171">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3615232">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3615298">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3615366">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="3615432">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="3615458">//</span><br>
<span class="lineno"></span><span class="comment" id="3615461">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3615525">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="3615587">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="3615648">//</span><br>
<span class="lineno"></span><span class="comment" id="3615651">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3615717">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3615787">func</span>&nbsp;<span class="op" id="3615792">(</span><span class="ident" id="3615793">mux</span>&nbsp;<span class="op" id="3615797">*</span><span class="ident" id="3615798">ServeMux</span><span class="op" id="3615806">)</span>&nbsp;<span class="ident" id="3615808">Handler</span><span class="op" id="3615815">(</span><span class="ident" id="3615816">r</span>&nbsp;<span class="op" id="3615818">*</span><span class="ident" id="3615819">Request</span><span class="op" id="3615826">)</span>&nbsp;<span class="op" id="3615828">(</span><span class="ident" id="3615829">h</span>&nbsp;<span class="ident" id="3615831">Handler</span><span class="op" id="3615838">,</span>&nbsp;<span class="ident" id="3615840">pattern</span>&nbsp;<span class="builtintype" id="3615848">string</span><span class="op" id="3615854">)</span>&nbsp;<span class="op" id="3615856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3615859">if</span>&nbsp;<span class="ident" id="3615862">r</span><span class="op" id="3615863">.</span><span class="ident" id="3615864">Method</span>&nbsp;<span class="op" id="3615871">!=</span>&nbsp;<span class="string" id="3615874">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="3615884">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3615888">if</span>&nbsp;<span class="ident" id="3615891">p</span>&nbsp;<span class="op" id="3615893">:=</span>&nbsp;<span class="ident" id="3615896">cleanPath</span><span class="op" id="3615905">(</span><span class="ident" id="3615906">r</span><span class="op" id="3615907">.</span><span class="ident" id="3615908">URL</span><span class="op" id="3615911">.</span><span class="ident" id="3615912">Path</span><span class="op" id="3615916">)</span><span class="op" id="3615917">;</span>&nbsp;<span class="ident" id="3615919">p</span>&nbsp;<span class="op" id="3615921">!=</span>&nbsp;<span class="ident" id="3615924">r</span><span class="op" id="3615925">.</span><span class="ident" id="3615926">URL</span><span class="op" id="3615929">.</span><span class="ident" id="3615930">Path</span>&nbsp;<span class="op" id="3615935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3615940">_</span><span class="op" id="3615941">,</span>&nbsp;<span class="ident" id="3615943">pattern</span>&nbsp;<span class="op" id="3615951">=</span>&nbsp;<span class="ident" id="3615953">mux</span><span class="op" id="3615956">.</span><span class="ident" id="3615957">handler</span><span class="op" id="3615964">(</span><span class="ident" id="3615965">r</span><span class="op" id="3615966">.</span><span class="ident" id="3615967">Host</span><span class="op" id="3615971">,</span>&nbsp;<span class="ident" id="3615973">p</span><span class="op" id="3615974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3615979">url</span>&nbsp;<span class="op" id="3615983">:=</span>&nbsp;<span class="op" id="3615986">*</span><span class="ident" id="3615987">r</span><span class="op" id="3615988">.</span><span class="ident" id="3615989">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3615996">url</span><span class="op" id="3615999">.</span><span class="ident" id="3616000">Path</span>&nbsp;<span class="op" id="3616005">=</span>&nbsp;<span class="ident" id="3616007">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616012">return</span>&nbsp;<span class="ident" id="3616019">RedirectHandler</span><span class="op" id="3616034">(</span><span class="ident" id="3616035">url</span><span class="op" id="3616038">.</span><span class="ident" id="3616039">String</span><span class="op" id="3616045">(</span><span class="op" id="3616046">)</span><span class="op" id="3616047">,</span>&nbsp;<span class="ident" id="3616049">StatusMovedPermanently</span><span class="op" id="3616071">)</span><span class="op" id="3616072">,</span>&nbsp;<span class="ident" id="3616074">pattern</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3616084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3616087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616091">return</span>&nbsp;<span class="ident" id="3616098">mux</span><span class="op" id="3616101">.</span><span class="ident" id="3616102">handler</span><span class="op" id="3616109">(</span><span class="ident" id="3616110">r</span><span class="op" id="3616111">.</span><span class="ident" id="3616112">Host</span><span class="op" id="3616116">,</span>&nbsp;<span class="ident" id="3616118">r</span><span class="op" id="3616119">.</span><span class="ident" id="3616120">URL</span><span class="op" id="3616123">.</span><span class="ident" id="3616124">Path</span><span class="op" id="3616128">)</span><br>
<span class="lineno"></span><span class="op" id="3616130">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="3616133">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="3616183">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="3616257">func</span>&nbsp;<span class="op" id="3616262">(</span><span class="ident" id="3616263">mux</span>&nbsp;<span class="op" id="3616267">*</span><span class="ident" id="3616268">ServeMux</span><span class="op" id="3616276">)</span>&nbsp;<span class="ident" id="3616278">handler</span><span class="op" id="3616285">(</span><span class="ident" id="3616286">host</span><span class="op" id="3616290">,</span>&nbsp;<span class="ident" id="3616292">path</span>&nbsp;<span class="builtintype" id="3616297">string</span><span class="op" id="3616303">)</span>&nbsp;<span class="op" id="3616305">(</span><span class="ident" id="3616306">h</span>&nbsp;<span class="ident" id="3616308">Handler</span><span class="op" id="3616315">,</span>&nbsp;<span class="ident" id="3616317">pattern</span>&nbsp;<span class="builtintype" id="3616325">string</span><span class="op" id="3616331">)</span>&nbsp;<span class="op" id="3616333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616336">mux</span><span class="op" id="3616339">.</span><span class="ident" id="3616340">mu</span><span class="op" id="3616342">.</span><span class="ident" id="3616343">RLock</span><span class="op" id="3616348">(</span><span class="op" id="3616349">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616352">defer</span>&nbsp;<span class="ident" id="3616358">mux</span><span class="op" id="3616361">.</span><span class="ident" id="3616362">mu</span><span class="op" id="3616364">.</span><span class="ident" id="3616365">RUnlock</span><span class="op" id="3616372">(</span><span class="op" id="3616373">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3616377">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616438">if</span>&nbsp;<span class="ident" id="3616441">mux</span><span class="op" id="3616444">.</span><span class="ident" id="3616445">hosts</span>&nbsp;<span class="op" id="3616451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616455">h</span><span class="op" id="3616456">,</span>&nbsp;<span class="ident" id="3616458">pattern</span>&nbsp;<span class="op" id="3616466">=</span>&nbsp;<span class="ident" id="3616468">mux</span><span class="op" id="3616471">.</span><span class="ident" id="3616472">match</span><span class="op" id="3616477">(</span><span class="ident" id="3616478">host</span>&nbsp;<span class="op" id="3616483">+</span>&nbsp;<span class="ident" id="3616485">path</span><span class="op" id="3616489">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3616492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616495">if</span>&nbsp;<span class="ident" id="3616498">h</span>&nbsp;<span class="op" id="3616500">==</span>&nbsp;<span class="ident" id="3616503">nil</span>&nbsp;<span class="op" id="3616507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616511">h</span><span class="op" id="3616512">,</span>&nbsp;<span class="ident" id="3616514">pattern</span>&nbsp;<span class="op" id="3616522">=</span>&nbsp;<span class="ident" id="3616524">mux</span><span class="op" id="3616527">.</span><span class="ident" id="3616528">match</span><span class="op" id="3616533">(</span><span class="ident" id="3616534">path</span><span class="op" id="3616538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3616541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616544">if</span>&nbsp;<span class="ident" id="3616547">h</span>&nbsp;<span class="op" id="3616549">==</span>&nbsp;<span class="ident" id="3616552">nil</span>&nbsp;<span class="op" id="3616556">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616560">h</span><span class="op" id="3616561">,</span>&nbsp;<span class="ident" id="3616563">pattern</span>&nbsp;<span class="op" id="3616571">=</span>&nbsp;<span class="ident" id="3616573">NotFoundHandler</span><span class="op" id="3616588">(</span><span class="op" id="3616589">)</span><span class="op" id="3616590">,</span>&nbsp;<span class="string" id="3616592">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3616596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616599">return</span><br>
<span class="lineno"></span><span class="op" id="3616606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="3616609">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="3616666">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3616715">func</span>&nbsp;<span class="op" id="3616720">(</span><span class="ident" id="3616721">mux</span>&nbsp;<span class="op" id="3616725">*</span><span class="ident" id="3616726">ServeMux</span><span class="op" id="3616734">)</span>&nbsp;<span class="ident" id="3616736">ServeHTTP</span><span class="op" id="3616745">(</span><span class="ident" id="3616746">w</span>&nbsp;<span class="ident" id="3616748">ResponseWriter</span><span class="op" id="3616762">,</span>&nbsp;<span class="ident" id="3616764">r</span>&nbsp;<span class="op" id="3616766">*</span><span class="ident" id="3616767">Request</span><span class="op" id="3616774">)</span>&nbsp;<span class="op" id="3616776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616779">if</span>&nbsp;<span class="ident" id="3616782">r</span><span class="op" id="3616783">.</span><span class="ident" id="3616784">RequestURI</span>&nbsp;<span class="op" id="3616795">==</span>&nbsp;<span class="string" id="3616798">&#34;*&#34;</span>&nbsp;<span class="op" id="3616802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616806">if</span>&nbsp;<span class="ident" id="3616809">r</span><span class="op" id="3616810">.</span><span class="ident" id="3616811">ProtoAtLeast</span><span class="op" id="3616823">(</span><span class="num" id="3616824">1</span><span class="op" id="3616825">,</span>&nbsp;<span class="num" id="3616827">1</span><span class="op" id="3616828">)</span>&nbsp;<span class="op" id="3616830">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616835">w</span><span class="op" id="3616836">.</span><span class="ident" id="3616837">Header</span><span class="op" id="3616843">(</span><span class="op" id="3616844">)</span><span class="op" id="3616845">.</span><span class="ident" id="3616846">Set</span><span class="op" id="3616849">(</span><span class="string" id="3616850">&#34;Connection&#34;</span><span class="op" id="3616862">,</span>&nbsp;<span class="string" id="3616864">&#34;close&#34;</span><span class="op" id="3616871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3616875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616879">w</span><span class="op" id="3616880">.</span><span class="ident" id="3616881">WriteHeader</span><span class="op" id="3616892">(</span><span class="ident" id="3616893">StatusBadRequest</span><span class="op" id="3616909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616913">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3616921">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616924">h</span><span class="op" id="3616925">,</span>&nbsp;<span class="ident" id="3616927">_</span>&nbsp;<span class="op" id="3616929">:=</span>&nbsp;<span class="ident" id="3616932">mux</span><span class="op" id="3616935">.</span><span class="ident" id="3616936">Handler</span><span class="op" id="3616943">(</span><span class="ident" id="3616944">r</span><span class="op" id="3616945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616948">h</span><span class="op" id="3616949">.</span><span class="ident" id="3616950">ServeHTTP</span><span class="op" id="3616959">(</span><span class="ident" id="3616960">w</span><span class="op" id="3616961">,</span>&nbsp;<span class="ident" id="3616963">r</span><span class="op" id="3616964">)</span><br>
<span class="lineno"></span><span class="op" id="3616966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3616969">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="3617024">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="3617083">func</span>&nbsp;<span class="op" id="3617088">(</span><span class="ident" id="3617089">mux</span>&nbsp;<span class="op" id="3617093">*</span><span class="ident" id="3617094">ServeMux</span><span class="op" id="3617102">)</span>&nbsp;<span class="ident" id="3617104">Handle</span><span class="op" id="3617110">(</span><span class="ident" id="3617111">pattern</span>&nbsp;<span class="builtintype" id="3617119">string</span><span class="op" id="3617125">,</span>&nbsp;<span class="ident" id="3617127">handler</span>&nbsp;<span class="ident" id="3617135">Handler</span><span class="op" id="3617142">)</span>&nbsp;<span class="op" id="3617144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617147">mux</span><span class="op" id="3617150">.</span><span class="ident" id="3617151">mu</span><span class="op" id="3617153">.</span><span class="ident" id="3617154">Lock</span><span class="op" id="3617158">(</span><span class="op" id="3617159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3617162">defer</span>&nbsp;<span class="ident" id="3617168">mux</span><span class="op" id="3617171">.</span><span class="ident" id="3617172">mu</span><span class="op" id="3617174">.</span><span class="ident" id="3617175">Unlock</span><span class="op" id="3617181">(</span><span class="op" id="3617182">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3617186">if</span>&nbsp;<span class="ident" id="3617189">pattern</span>&nbsp;<span class="op" id="3617197">==</span>&nbsp;<span class="string" id="3617200">&#34;&#34;</span>&nbsp;<span class="op" id="3617203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3617207">panic</span><span class="op" id="3617212">(</span><span class="string" id="3617213">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="3617238">+</span>&nbsp;<span class="ident" id="3617240">pattern</span><span class="op" id="3617247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3617250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3617253">if</span>&nbsp;<span class="ident" id="3617256">handler</span>&nbsp;<span class="op" id="3617264">==</span>&nbsp;<span class="ident" id="3617267">nil</span>&nbsp;<span class="op" id="3617271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3617275">panic</span><span class="op" id="3617280">(</span><span class="string" id="3617281">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="3617300">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3617303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3617306">if</span>&nbsp;<span class="ident" id="3617309">mux</span><span class="op" id="3617312">.</span><span class="ident" id="3617313">m</span><span class="op" id="3617314">[</span><span class="ident" id="3617315">pattern</span><span class="op" id="3617322">]</span><span class="op" id="3617323">.</span><span class="ident" id="3617324">explicit</span>&nbsp;<span class="op" id="3617333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3617337">panic</span><span class="op" id="3617342">(</span><span class="string" id="3617343">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3617379">+</span>&nbsp;<span class="ident" id="3617381">pattern</span><span class="op" id="3617388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3617391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617395">mux</span><span class="op" id="3617398">.</span><span class="ident" id="3617399">m</span><span class="op" id="3617400">[</span><span class="ident" id="3617401">pattern</span><span class="op" id="3617408">]</span>&nbsp;<span class="op" id="3617410">=</span>&nbsp;<span class="ident" id="3617412">muxEntry</span><span class="op" id="3617420">{</span><span class="ident" id="3617421">explicit</span><span class="op" id="3617429">:</span>&nbsp;<span class="ident" id="3617431">true</span><span class="op" id="3617435">,</span>&nbsp;<span class="ident" id="3617437">h</span><span class="op" id="3617438">:</span>&nbsp;<span class="ident" id="3617440">handler</span><span class="op" id="3617447">,</span>&nbsp;<span class="ident" id="3617449">pattern</span><span class="op" id="3617456">:</span>&nbsp;<span class="ident" id="3617458">pattern</span><span class="op" id="3617465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3617469">if</span>&nbsp;<span class="ident" id="3617472">pattern</span><span class="op" id="3617479">[</span><span class="num" id="3617480">0</span><span class="op" id="3617481">]</span>&nbsp;<span class="op" id="3617483">!=</span>&nbsp;<span class="string" id="3617486">&#39;/&#39;</span>&nbsp;<span class="op" id="3617490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617494">mux</span><span class="op" id="3617497">.</span><span class="ident" id="3617498">hosts</span>&nbsp;<span class="op" id="3617504">=</span>&nbsp;<span class="ident" id="3617506">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3617512">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617516">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617538">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617613">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617667">n</span>&nbsp;<span class="op" id="3617669">:=</span>&nbsp;<span class="builtinfunc" id="3617672">len</span><span class="op" id="3617675">(</span><span class="ident" id="3617676">pattern</span><span class="op" id="3617683">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3617686">if</span>&nbsp;<span class="ident" id="3617689">n</span>&nbsp;<span class="op" id="3617691">&gt;</span>&nbsp;<span class="num" id="3617693">0</span>&nbsp;<span class="op" id="3617695">&amp;&amp;</span>&nbsp;<span class="ident" id="3617698">pattern</span><span class="op" id="3617705">[</span><span class="ident" id="3617706">n</span><span class="op" id="3617707">-</span><span class="num" id="3617708">1</span><span class="op" id="3617709">]</span>&nbsp;<span class="op" id="3617711">==</span>&nbsp;<span class="string" id="3617714">&#39;/&#39;</span>&nbsp;<span class="op" id="3617718">&amp;&amp;</span>&nbsp;<span class="op" id="3617721">!</span><span class="ident" id="3617722">mux</span><span class="op" id="3617725">.</span><span class="ident" id="3617726">m</span><span class="op" id="3617727">[</span><span class="ident" id="3617728">pattern</span><span class="op" id="3617735">[</span><span class="num" id="3617736">0</span><span class="op" id="3617737">:</span><span class="ident" id="3617738">n</span><span class="op" id="3617739">-</span><span class="num" id="3617740">1</span><span class="op" id="3617741">]</span><span class="op" id="3617742">]</span><span class="op" id="3617743">.</span><span class="ident" id="3617744">explicit</span>&nbsp;<span class="op" id="3617753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617757">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617822">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617846">path</span>&nbsp;<span class="op" id="3617851">:=</span>&nbsp;<span class="ident" id="3617854">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3617864">if</span>&nbsp;<span class="ident" id="3617867">pattern</span><span class="op" id="3617874">[</span><span class="num" id="3617875">0</span><span class="op" id="3617876">]</span>&nbsp;<span class="op" id="3617878">!=</span>&nbsp;<span class="string" id="3617881">&#39;/&#39;</span>&nbsp;<span class="op" id="3617885">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617890">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617949">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617982">path</span>&nbsp;<span class="op" id="3617987">=</span>&nbsp;<span class="ident" id="3617989">pattern</span><span class="op" id="3617996">[</span><span class="ident" id="3617997">strings</span><span class="op" id="3618004">.</span><span class="ident" id="3618005">Index</span><span class="op" id="3618010">(</span><span class="ident" id="3618011">pattern</span><span class="op" id="3618018">,</span>&nbsp;<span class="string" id="3618020">&#34;/&#34;</span><span class="op" id="3618023">)</span><span class="op" id="3618024">:</span><span class="op" id="3618025">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3618029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618033">mux</span><span class="op" id="3618036">.</span><span class="ident" id="3618037">m</span><span class="op" id="3618038">[</span><span class="ident" id="3618039">pattern</span><span class="op" id="3618046">[</span><span class="num" id="3618047">0</span><span class="op" id="3618048">:</span><span class="ident" id="3618049">n</span><span class="op" id="3618050">-</span><span class="num" id="3618051">1</span><span class="op" id="3618052">]</span><span class="op" id="3618053">]</span>&nbsp;<span class="op" id="3618055">=</span>&nbsp;<span class="ident" id="3618057">muxEntry</span><span class="op" id="3618065">{</span><span class="ident" id="3618066">h</span><span class="op" id="3618067">:</span>&nbsp;<span class="ident" id="3618069">RedirectHandler</span><span class="op" id="3618084">(</span><span class="ident" id="3618085">path</span><span class="op" id="3618089">,</span>&nbsp;<span class="ident" id="3618091">StatusMovedPermanently</span><span class="op" id="3618113">)</span><span class="op" id="3618114">,</span>&nbsp;<span class="ident" id="3618116">pattern</span><span class="op" id="3618123">:</span>&nbsp;<span class="ident" id="3618125">pattern</span><span class="op" id="3618132">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3618135">}</span><br>
<span class="lineno"></span><span class="op" id="3618137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3618140">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3618208">func</span>&nbsp;<span class="op" id="3618213">(</span><span class="ident" id="3618214">mux</span>&nbsp;<span class="op" id="3618218">*</span><span class="ident" id="3618219">ServeMux</span><span class="op" id="3618227">)</span>&nbsp;<span class="ident" id="3618229">HandleFunc</span><span class="op" id="3618239">(</span><span class="ident" id="3618240">pattern</span>&nbsp;<span class="builtintype" id="3618248">string</span><span class="op" id="3618254">,</span>&nbsp;<span class="ident" id="3618256">handler</span>&nbsp;<span class="keyword" id="3618264">func</span><span class="op" id="3618268">(</span><span class="ident" id="3618269">ResponseWriter</span><span class="op" id="3618283">,</span>&nbsp;<span class="op" id="3618285">*</span><span class="ident" id="3618286">Request</span><span class="op" id="3618293">)</span><span class="op" id="3618294">)</span>&nbsp;<span class="op" id="3618296">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618299">mux</span><span class="op" id="3618302">.</span><span class="ident" id="3618303">Handle</span><span class="op" id="3618309">(</span><span class="ident" id="3618310">pattern</span><span class="op" id="3618317">,</span>&nbsp;<span class="ident" id="3618319">HandlerFunc</span><span class="op" id="3618330">(</span><span class="ident" id="3618331">handler</span><span class="op" id="3618338">)</span><span class="op" id="3618339">)</span><br>
<span class="lineno"></span><span class="op" id="3618341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3618344">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3618398">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="3618425">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3618494">func</span>&nbsp;<span class="ident" id="3618499">Handle</span><span class="op" id="3618505">(</span><span class="ident" id="3618506">pattern</span>&nbsp;<span class="builtintype" id="3618514">string</span><span class="op" id="3618520">,</span>&nbsp;<span class="ident" id="3618522">handler</span>&nbsp;<span class="ident" id="3618530">Handler</span><span class="op" id="3618537">)</span>&nbsp;<span class="op" id="3618539">{</span>&nbsp;<span class="ident" id="3618541">DefaultServeMux</span><span class="op" id="3618556">.</span><span class="ident" id="3618557">Handle</span><span class="op" id="3618563">(</span><span class="ident" id="3618564">pattern</span><span class="op" id="3618571">,</span>&nbsp;<span class="ident" id="3618573">handler</span><span class="op" id="3618580">)</span>&nbsp;<span class="op" id="3618582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3618585">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3618652">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="3618679">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3618748">func</span>&nbsp;<span class="ident" id="3618753">HandleFunc</span><span class="op" id="3618763">(</span><span class="ident" id="3618764">pattern</span>&nbsp;<span class="builtintype" id="3618772">string</span><span class="op" id="3618778">,</span>&nbsp;<span class="ident" id="3618780">handler</span>&nbsp;<span class="keyword" id="3618788">func</span><span class="op" id="3618792">(</span><span class="ident" id="3618793">ResponseWriter</span><span class="op" id="3618807">,</span>&nbsp;<span class="op" id="3618809">*</span><span class="ident" id="3618810">Request</span><span class="op" id="3618817">)</span><span class="op" id="3618818">)</span>&nbsp;<span class="op" id="3618820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618823">DefaultServeMux</span><span class="op" id="3618838">.</span><span class="ident" id="3618839">HandleFunc</span><span class="op" id="3618849">(</span><span class="ident" id="3618850">pattern</span><span class="op" id="3618857">,</span>&nbsp;<span class="ident" id="3618859">handler</span><span class="op" id="3618866">)</span><br>
<span class="lineno"></span><span class="op" id="3618868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="3618871">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="3618933">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="3619003">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="3619060">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3619132">func</span>&nbsp;<span class="ident" id="3619137">Serve</span><span class="op" id="3619142">(</span><span class="ident" id="3619143">l</span>&nbsp;<span class="ident" id="3619145">net</span><span class="op" id="3619148">.</span><span class="ident" id="3619149">Listener</span><span class="op" id="3619157">,</span>&nbsp;<span class="ident" id="3619159">handler</span>&nbsp;<span class="ident" id="3619167">Handler</span><span class="op" id="3619174">)</span>&nbsp;<span class="builtintype" id="3619176">error</span>&nbsp;<span class="op" id="3619182">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3619185">srv</span>&nbsp;<span class="op" id="3619189">:=</span>&nbsp;<span class="op" id="3619192">&amp;</span><span class="ident" id="3619193">Server</span><span class="op" id="3619199">{</span><span class="ident" id="3619200">Handler</span><span class="op" id="3619207">:</span>&nbsp;<span class="ident" id="3619209">handler</span><span class="op" id="3619216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3619219">return</span>&nbsp;<span class="ident" id="3619226">srv</span><span class="op" id="3619229">.</span><span class="ident" id="3619230">Serve</span><span class="op" id="3619235">(</span><span class="ident" id="3619236">l</span><span class="op" id="3619237">)</span><br>
<span class="lineno"></span><span class="op" id="3619239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3619242">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="3619301">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="3619356">type</span>&nbsp;<span class="ident" id="3619361">Server</span>&nbsp;<span class="keyword" id="3619368">struct</span>&nbsp;<span class="op" id="3619375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3619378">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3619393">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3619407">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3619454">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619469">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3619483">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3619534">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3619549">time</span><span class="op" id="3619553">.</span><span class="ident" id="3619554">Duration</span>&nbsp;<span class="comment" id="3619563">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3619622">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3619637">time</span><span class="op" id="3619641">.</span><span class="ident" id="3619642">Duration</span>&nbsp;<span class="comment" id="3619651">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3619712">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="3619727">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3619741">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3619805">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3619820">*</span><span class="ident" id="3619821">tls</span><span class="op" id="3619824">.</span><span class="ident" id="3619825">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3619834">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619886">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619948">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620005">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620069">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620129">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620192">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620250">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3620302">TLSNextProto</span>&nbsp;<span class="keyword" id="3620315">map</span><span class="op" id="3620318">[</span><span class="builtintype" id="3620319">string</span><span class="op" id="3620325">]</span><span class="keyword" id="3620326">func</span><span class="op" id="3620330">(</span><span class="op" id="3620331">*</span><span class="ident" id="3620332">Server</span><span class="op" id="3620338">,</span>&nbsp;<span class="op" id="3620340">*</span><span class="ident" id="3620341">tls</span><span class="op" id="3620344">.</span><span class="ident" id="3620345">Conn</span><span class="op" id="3620349">,</span>&nbsp;<span class="ident" id="3620351">Handler</span><span class="op" id="3620358">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620362">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620424">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620483">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3620540">ConnState</span>&nbsp;<span class="keyword" id="3620550">func</span><span class="op" id="3620554">(</span><span class="ident" id="3620555">net</span><span class="op" id="3620558">.</span><span class="ident" id="3620559">Conn</span><span class="op" id="3620563">,</span>&nbsp;<span class="ident" id="3620565">ConnState</span><span class="op" id="3620574">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620578">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620641">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620696">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620756">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3620777">ErrorLog</span>&nbsp;<span class="op" id="3620786">*</span><span class="ident" id="3620787">log</span><span class="op" id="3620790">.</span><span class="ident" id="3620791">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3620800">disableKeepAlives</span>&nbsp;<span class="builtintype" id="3620818">int32</span>&nbsp;<span class="comment" id="3620824">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="3620848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3620851">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="3620923">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="3620975">type</span>&nbsp;<span class="ident" id="3620980">ConnState</span>&nbsp;<span class="builtintype" id="3620990">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="3620995">const</span>&nbsp;<span class="op" id="3621001">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621004">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621065">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621123">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621178">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3621195">StateNew</span>&nbsp;<span class="ident" id="3621204">ConnState</span>&nbsp;<span class="op" id="3621214">=</span>&nbsp;<span class="ident" id="3621216">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621223">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621287">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621341">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621404">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621458">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621511">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3621572">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621586">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621642">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621705">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621766">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3621808">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621820">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621872">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3621941">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621957">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3622005">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3622063">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622094">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="3622106">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3622109">var</span>&nbsp;<span class="ident" id="3622113">stateName</span>&nbsp;<span class="op" id="3622123">=</span>&nbsp;<span class="keyword" id="3622125">map</span><span class="op" id="3622128">[</span><span class="ident" id="3622129">ConnState</span><span class="op" id="3622138">]</span><span class="builtintype" id="3622139">string</span><span class="op" id="3622145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622148">StateNew</span><span class="op" id="3622156">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3622163">&#34;new&#34;</span><span class="op" id="3622168">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622171">StateActive</span><span class="op" id="3622182">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3622186">&#34;active&#34;</span><span class="op" id="3622194">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622197">StateIdle</span><span class="op" id="3622206">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3622212">&#34;idle&#34;</span><span class="op" id="3622218">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622221">StateHijacked</span><span class="op" id="3622234">:</span>&nbsp;<span class="string" id="3622236">&#34;hijacked&#34;</span><span class="op" id="3622246">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622249">StateClosed</span><span class="op" id="3622260">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3622264">&#34;closed&#34;</span><span class="op" id="3622272">,</span><br>
<span class="lineno"></span><span class="op" id="3622274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="3622277">func</span>&nbsp;<span class="op" id="3622282">(</span><span class="ident" id="3622283">c</span>&nbsp;<span class="ident" id="3622285">ConnState</span><span class="op" id="3622294">)</span>&nbsp;<span class="ident" id="3622296">String</span><span class="op" id="3622302">(</span><span class="op" id="3622303">)</span>&nbsp;<span class="builtintype" id="3622305">string</span>&nbsp;<span class="op" id="3622312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622315">return</span>&nbsp;<span class="ident" id="3622322">stateName</span><span class="op" id="3622331">[</span><span class="ident" id="3622332">c</span><span class="op" id="3622333">]</span><br>
<span class="lineno"></span><span class="op" id="3622335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3622338">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="3622399">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3622457">type</span>&nbsp;<span class="ident" id="3622462">serverHandler</span>&nbsp;<span class="keyword" id="3622476">struct</span>&nbsp;<span class="op" id="3622483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622486">srv</span>&nbsp;<span class="op" id="3622490">*</span><span class="ident" id="3622491">Server</span><br>
<span class="lineno"></span><span class="op" id="3622498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="3622501">func</span>&nbsp;<span class="op" id="3622506">(</span><span class="ident" id="3622507">sh</span>&nbsp;<span class="ident" id="3622510">serverHandler</span><span class="op" id="3622523">)</span>&nbsp;<span class="ident" id="3622525">ServeHTTP</span><span class="op" id="3622534">(</span><span class="ident" id="3622535">rw</span>&nbsp;<span class="ident" id="3622538">ResponseWriter</span><span class="op" id="3622552">,</span>&nbsp;<span class="ident" id="3622554">req</span>&nbsp;<span class="op" id="3622558">*</span><span class="ident" id="3622559">Request</span><span class="op" id="3622566">)</span>&nbsp;<span class="op" id="3622568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622571">handler</span>&nbsp;<span class="op" id="3622579">:=</span>&nbsp;<span class="ident" id="3622582">sh</span><span class="op" id="3622584">.</span><span class="ident" id="3622585">srv</span><span class="op" id="3622588">.</span><span class="ident" id="3622589">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622598">if</span>&nbsp;<span class="ident" id="3622601">handler</span>&nbsp;<span class="op" id="3622609">==</span>&nbsp;<span class="ident" id="3622612">nil</span>&nbsp;<span class="op" id="3622616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622620">handler</span>&nbsp;<span class="op" id="3622628">=</span>&nbsp;<span class="ident" id="3622630">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3622647">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622650">if</span>&nbsp;<span class="ident" id="3622653">req</span><span class="op" id="3622656">.</span><span class="ident" id="3622657">RequestURI</span>&nbsp;<span class="op" id="3622668">==</span>&nbsp;<span class="string" id="3622671">&#34;*&#34;</span>&nbsp;<span class="op" id="3622675">&amp;&amp;</span>&nbsp;<span class="ident" id="3622678">req</span><span class="op" id="3622681">.</span><span class="ident" id="3622682">Method</span>&nbsp;<span class="op" id="3622689">==</span>&nbsp;<span class="string" id="3622692">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="3622702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622706">handler</span>&nbsp;<span class="op" id="3622714">=</span>&nbsp;<span class="ident" id="3622716">globalOptionsHandler</span><span class="op" id="3622736">{</span><span class="op" id="3622737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3622740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622743">handler</span><span class="op" id="3622750">.</span><span class="ident" id="3622751">ServeHTTP</span><span class="op" id="3622760">(</span><span class="ident" id="3622761">rw</span><span class="op" id="3622763">,</span>&nbsp;<span class="ident" id="3622765">req</span><span class="op" id="3622768">)</span><br>
<span class="lineno"></span><span class="op" id="3622770">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="3622773">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3622844">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="3622907">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3622946">func</span>&nbsp;<span class="op" id="3622951">(</span><span class="ident" id="3622952">srv</span>&nbsp;<span class="op" id="3622956">*</span><span class="ident" id="3622957">Server</span><span class="op" id="3622963">)</span>&nbsp;<span class="ident" id="3622965">ListenAndServe</span><span class="op" id="3622979">(</span><span class="op" id="3622980">)</span>&nbsp;<span class="builtintype" id="3622982">error</span>&nbsp;<span class="op" id="3622988">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622991">addr</span>&nbsp;<span class="op" id="3622996">:=</span>&nbsp;<span class="ident" id="3622999">srv</span><span class="op" id="3623002">.</span><span class="ident" id="3623003">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623009">if</span>&nbsp;<span class="ident" id="3623012">addr</span>&nbsp;<span class="op" id="3623017">==</span>&nbsp;<span class="string" id="3623020">&#34;&#34;</span>&nbsp;<span class="op" id="3623023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623027">addr</span>&nbsp;<span class="op" id="3623032">=</span>&nbsp;<span class="string" id="3623034">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623046">ln</span><span class="op" id="3623048">,</span>&nbsp;<span class="ident" id="3623050">err</span>&nbsp;<span class="op" id="3623054">:=</span>&nbsp;<span class="ident" id="3623057">net</span><span class="op" id="3623060">.</span><span class="ident" id="3623061">Listen</span><span class="op" id="3623067">(</span><span class="string" id="3623068">&#34;tcp&#34;</span><span class="op" id="3623073">,</span>&nbsp;<span class="ident" id="3623075">addr</span><span class="op" id="3623079">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623082">if</span>&nbsp;<span class="ident" id="3623085">err</span>&nbsp;<span class="op" id="3623089">!=</span>&nbsp;<span class="ident" id="3623092">nil</span>&nbsp;<span class="op" id="3623096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623100">return</span>&nbsp;<span class="ident" id="3623107">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623115">return</span>&nbsp;<span class="ident" id="3623122">srv</span><span class="op" id="3623125">.</span><span class="ident" id="3623126">Serve</span><span class="op" id="3623131">(</span><span class="ident" id="3623132">tcpKeepAliveListener</span><span class="op" id="3623152">{</span><span class="ident" id="3623153">ln</span><span class="op" id="3623155">.</span><span class="op" id="3623156">(</span><span class="op" id="3623157">*</span><span class="ident" id="3623158">net</span><span class="op" id="3623161">.</span><span class="ident" id="3623162">TCPListener</span><span class="op" id="3623173">)</span><span class="op" id="3623174">}</span><span class="op" id="3623175">)</span><br>
<span class="lineno"></span><span class="op" id="3623177">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="3623180">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3623248">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3623325">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3623368">func</span>&nbsp;<span class="op" id="3623373">(</span><span class="ident" id="3623374">srv</span>&nbsp;<span class="op" id="3623378">*</span><span class="ident" id="3623379">Server</span><span class="op" id="3623385">)</span>&nbsp;<span class="ident" id="3623387">Serve</span><span class="op" id="3623392">(</span><span class="ident" id="3623393">l</span>&nbsp;<span class="ident" id="3623395">net</span><span class="op" id="3623398">.</span><span class="ident" id="3623399">Listener</span><span class="op" id="3623407">)</span>&nbsp;<span class="builtintype" id="3623409">error</span>&nbsp;<span class="op" id="3623415">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623418">defer</span>&nbsp;<span class="ident" id="3623424">l</span><span class="op" id="3623425">.</span><span class="ident" id="3623426">Close</span><span class="op" id="3623431">(</span><span class="op" id="3623432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623435">var</span>&nbsp;<span class="ident" id="3623439">tempDelay</span>&nbsp;<span class="ident" id="3623449">time</span><span class="op" id="3623453">.</span><span class="ident" id="3623454">Duration</span>&nbsp;<span class="comment" id="3623463">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623503">for</span>&nbsp;<span class="op" id="3623507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623511">rw</span><span class="op" id="3623513">,</span>&nbsp;<span class="ident" id="3623515">e</span>&nbsp;<span class="op" id="3623517">:=</span>&nbsp;<span class="ident" id="3623520">l</span><span class="op" id="3623521">.</span><span class="ident" id="3623522">Accept</span><span class="op" id="3623528">(</span><span class="op" id="3623529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623533">if</span>&nbsp;<span class="ident" id="3623536">e</span>&nbsp;<span class="op" id="3623538">!=</span>&nbsp;<span class="ident" id="3623541">nil</span>&nbsp;<span class="op" id="3623545">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623550">if</span>&nbsp;<span class="ident" id="3623553">ne</span><span class="op" id="3623555">,</span>&nbsp;<span class="ident" id="3623557">ok</span>&nbsp;<span class="op" id="3623560">:=</span>&nbsp;<span class="ident" id="3623563">e</span><span class="op" id="3623564">.</span><span class="op" id="3623565">(</span><span class="ident" id="3623566">net</span><span class="op" id="3623569">.</span><span class="ident" id="3623570">Error</span><span class="op" id="3623575">)</span><span class="op" id="3623576">;</span>&nbsp;<span class="ident" id="3623578">ok</span>&nbsp;<span class="op" id="3623581">&amp;&amp;</span>&nbsp;<span class="ident" id="3623584">ne</span><span class="op" id="3623586">.</span><span class="ident" id="3623587">Temporary</span><span class="op" id="3623596">(</span><span class="op" id="3623597">)</span>&nbsp;<span class="op" id="3623599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623605">if</span>&nbsp;<span class="ident" id="3623608">tempDelay</span>&nbsp;<span class="op" id="3623618">==</span>&nbsp;<span class="num" id="3623621">0</span>&nbsp;<span class="op" id="3623623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623630">tempDelay</span>&nbsp;<span class="op" id="3623640">=</span>&nbsp;<span class="num" id="3623642">5</span>&nbsp;<span class="op" id="3623644">*</span>&nbsp;<span class="ident" id="3623646">time</span><span class="op" id="3623650">.</span><span class="ident" id="3623651">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623667">}</span>&nbsp;<span class="keyword" id="3623669">else</span>&nbsp;<span class="op" id="3623674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623681">tempDelay</span>&nbsp;<span class="op" id="3623691">*=</span>&nbsp;<span class="num" id="3623694">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623706">if</span>&nbsp;<span class="ident" id="3623709">max</span>&nbsp;<span class="op" id="3623713">:=</span>&nbsp;<span class="num" id="3623716">1</span>&nbsp;<span class="op" id="3623718">*</span>&nbsp;<span class="ident" id="3623720">time</span><span class="op" id="3623724">.</span><span class="ident" id="3623725">Second</span><span class="op" id="3623731">;</span>&nbsp;<span class="ident" id="3623733">tempDelay</span>&nbsp;<span class="op" id="3623743">&gt;</span>&nbsp;<span class="ident" id="3623745">max</span>&nbsp;<span class="op" id="3623749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623756">tempDelay</span>&nbsp;<span class="op" id="3623766">=</span>&nbsp;<span class="ident" id="3623768">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623782">srv</span><span class="op" id="3623785">.</span><span class="ident" id="3623786">logf</span><span class="op" id="3623790">(</span><span class="string" id="3623791">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="3623831">,</span>&nbsp;<span class="ident" id="3623833">e</span><span class="op" id="3623834">,</span>&nbsp;<span class="ident" id="3623836">tempDelay</span><span class="op" id="3623845">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623851">time</span><span class="op" id="3623855">.</span><span class="ident" id="3623856">Sleep</span><span class="op" id="3623861">(</span><span class="ident" id="3623862">tempDelay</span><span class="op" id="3623871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623877">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623894">return</span>&nbsp;<span class="ident" id="3623901">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623905">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623909">tempDelay</span>&nbsp;<span class="op" id="3623919">=</span>&nbsp;<span class="num" id="3623921">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623925">c</span><span class="op" id="3623926">,</span>&nbsp;<span class="ident" id="3623928">err</span>&nbsp;<span class="op" id="3623932">:=</span>&nbsp;<span class="ident" id="3623935">srv</span><span class="op" id="3623938">.</span><span class="ident" id="3623939">newConn</span><span class="op" id="3623946">(</span><span class="ident" id="3623947">rw</span><span class="op" id="3623949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623953">if</span>&nbsp;<span class="ident" id="3623956">err</span>&nbsp;<span class="op" id="3623960">!=</span>&nbsp;<span class="ident" id="3623963">nil</span>&nbsp;<span class="op" id="3623967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623972">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623983">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623987">c</span><span class="op" id="3623988">.</span><span class="ident" id="3623989">setState</span><span class="op" id="3623997">(</span><span class="ident" id="3623998">c</span><span class="op" id="3623999">.</span><span class="ident" id="3624000">rwc</span><span class="op" id="3624003">,</span>&nbsp;<span class="ident" id="3624005">StateNew</span><span class="op" id="3624013">)</span>&nbsp;<span class="comment" id="3624015">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624044">go</span>&nbsp;<span class="ident" id="3624047">c</span><span class="op" id="3624048">.</span><span class="ident" id="3624049">serve</span><span class="op" id="3624054">(</span><span class="op" id="3624055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624058">}</span><br>
<span class="lineno"></span><span class="op" id="3624060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="3624063">func</span>&nbsp;<span class="op" id="3624068">(</span><span class="ident" id="3624069">s</span>&nbsp;<span class="op" id="3624071">*</span><span class="ident" id="3624072">Server</span><span class="op" id="3624078">)</span>&nbsp;<span class="ident" id="3624080">doKeepAlives</span><span class="op" id="3624092">(</span><span class="op" id="3624093">)</span>&nbsp;<span class="builtintype" id="3624095">bool</span>&nbsp;<span class="op" id="3624100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624103">return</span>&nbsp;<span class="ident" id="3624110">atomic</span><span class="op" id="3624116">.</span><span class="ident" id="3624117">LoadInt32</span><span class="op" id="3624126">(</span><span class="op" id="3624127">&amp;</span><span class="ident" id="3624128">s</span><span class="op" id="3624129">.</span><span class="ident" id="3624130">disableKeepAlives</span><span class="op" id="3624147">)</span>&nbsp;<span class="op" id="3624149">==</span>&nbsp;<span class="num" id="3624152">0</span><br>
<span class="lineno"></span><span class="op" id="3624154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3624157">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="3624228">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="3624285">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3624351">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3624389">func</span>&nbsp;<span class="op" id="3624394">(</span><span class="ident" id="3624395">s</span>&nbsp;<span class="op" id="3624397">*</span><span class="ident" id="3624398">Server</span><span class="op" id="3624404">)</span>&nbsp;<span class="ident" id="3624406">SetKeepAlivesEnabled</span><span class="op" id="3624426">(</span><span class="ident" id="3624427">v</span>&nbsp;<span class="builtintype" id="3624429">bool</span><span class="op" id="3624433">)</span>&nbsp;<span class="op" id="3624435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624438">if</span>&nbsp;<span class="ident" id="3624441">v</span>&nbsp;<span class="op" id="3624443">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624447">atomic</span><span class="op" id="3624453">.</span><span class="ident" id="3624454">StoreInt32</span><span class="op" id="3624464">(</span><span class="op" id="3624465">&amp;</span><span class="ident" id="3624466">s</span><span class="op" id="3624467">.</span><span class="ident" id="3624468">disableKeepAlives</span><span class="op" id="3624485">,</span>&nbsp;<span class="num" id="3624487">0</span><span class="op" id="3624488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624491">}</span>&nbsp;<span class="keyword" id="3624493">else</span>&nbsp;<span class="op" id="3624498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624502">atomic</span><span class="op" id="3624508">.</span><span class="ident" id="3624509">StoreInt32</span><span class="op" id="3624519">(</span><span class="op" id="3624520">&amp;</span><span class="ident" id="3624521">s</span><span class="op" id="3624522">.</span><span class="ident" id="3624523">disableKeepAlives</span><span class="op" id="3624540">,</span>&nbsp;<span class="num" id="3624542">1</span><span class="op" id="3624543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624546">}</span><br>
<span class="lineno"></span><span class="op" id="3624548">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="3624551">func</span>&nbsp;<span class="op" id="3624556">(</span><span class="ident" id="3624557">s</span>&nbsp;<span class="op" id="3624559">*</span><span class="ident" id="3624560">Server</span><span class="op" id="3624566">)</span>&nbsp;<span class="ident" id="3624568">logf</span><span class="op" id="3624572">(</span><span class="ident" id="3624573">format</span>&nbsp;<span class="builtintype" id="3624580">string</span><span class="op" id="3624586">,</span>&nbsp;<span class="ident" id="3624588">args</span>&nbsp;<span class="op" id="3624593">...</span><span class="keyword" id="3624596">interface</span><span class="op" id="3624605">{</span><span class="op" id="3624606">}</span><span class="op" id="3624607">)</span>&nbsp;<span class="op" id="3624609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624612">if</span>&nbsp;<span class="ident" id="3624615">s</span><span class="op" id="3624616">.</span><span class="ident" id="3624617">ErrorLog</span>&nbsp;<span class="op" id="3624626">!=</span>&nbsp;<span class="ident" id="3624629">nil</span>&nbsp;<span class="op" id="3624633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624637">s</span><span class="op" id="3624638">.</span><span class="ident" id="3624639">ErrorLog</span><span class="op" id="3624647">.</span><span class="ident" id="3624648">Printf</span><span class="op" id="3624654">(</span><span class="ident" id="3624655">format</span><span class="op" id="3624661">,</span>&nbsp;<span class="ident" id="3624663">args</span><span class="op" id="3624667">...</span><span class="op" id="3624670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624673">}</span>&nbsp;<span class="keyword" id="3624675">else</span>&nbsp;<span class="op" id="3624680">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624684">log</span><span class="op" id="3624687">.</span><span class="ident" id="3624688">Printf</span><span class="op" id="3624694">(</span><span class="ident" id="3624695">format</span><span class="op" id="3624701">,</span>&nbsp;<span class="ident" id="3624703">args</span><span class="op" id="3624707">...</span><span class="op" id="3624710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624713">}</span><br>
<span class="lineno"></span><span class="op" id="3624715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3624718">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="3624776">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3624832">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="3624887">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3624933">//</span><br>
<span class="lineno"></span><span class="comment" id="3624936">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="3624968">//</span><br>
<span class="lineno"></span><span class="comment" id="3624971">//&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="3624987">//</span><br>
<span class="lineno"></span><span class="comment" id="3624990">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="3625002">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="3625011">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3625026">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3625036">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="3625041">//</span><br>
<span class="lineno"></span><span class="comment" id="3625044">//&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="3625078">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3625142">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspio.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3625183">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3625188">//</span><br>
<span class="lineno"></span><span class="comment" id="3625191">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="3625208">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="3625251">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3625297">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3625317">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="3625357">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">1805</span><span class="comment" id="3625363">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="keyword" id="3625368">func</span>&nbsp;<span class="ident" id="3625373">ListenAndServe</span><span class="op" id="3625387">(</span><span class="ident" id="3625388">addr</span>&nbsp;<span class="builtintype" id="3625393">string</span><span class="op" id="3625399">,</span>&nbsp;<span class="ident" id="3625401">handler</span>&nbsp;<span class="ident" id="3625409">Handler</span><span class="op" id="3625416">)</span>&nbsp;<span class="builtintype" id="3625418">error</span>&nbsp;<span class="op" id="3625424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3625427">server</span>&nbsp;<span class="op" id="3625434">:=</span>&nbsp;<span class="op" id="3625437">&amp;</span><span class="ident" id="3625438">Server</span><span class="op" id="3625444">{</span><span class="ident" id="3625445">Addr</span><span class="op" id="3625449">:</span>&nbsp;<span class="ident" id="3625451">addr</span><span class="op" id="3625455">,</span>&nbsp;<span class="ident" id="3625457">Handler</span><span class="op" id="3625464">:</span>&nbsp;<span class="ident" id="3625466">handler</span><span class="op" id="3625473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625476">return</span>&nbsp;<span class="ident" id="3625483">server</span><span class="op" id="3625489">.</span><span class="ident" id="3625490">ListenAndServe</span><span class="op" id="3625504">(</span><span class="op" id="3625505">)</span><br>
<span class="lineno"></span><span class="op" id="3625507">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="3625510">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3625582">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3625661">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="3625737">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="3625819">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3625884">//</span><br>
<span class="lineno"></span><span class="comment" id="3625887">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="3625919">//</span><br>
<span class="lineno"></span><span class="comment" id="3625922">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="3625934">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3625944">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3625959">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="3625964">//</span><br>
<span class="lineno"></span><span class="comment" id="3625967">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="3626027">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3626076">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="3626128">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3626133">//</span><br>
<span class="lineno"></span><span class="comment" id="3626136">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="3626153">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="3626187">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3626262">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3626334">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3626354">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="3626374">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3626380">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3626385">//</span><br>
<span class="lineno"></span><span class="comment" id="3626388">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="3626468">func</span>&nbsp;<span class="ident" id="3626473">ListenAndServeTLS</span><span class="op" id="3626490">(</span><span class="ident" id="3626491">addr</span>&nbsp;<span class="builtintype" id="3626496">string</span><span class="op" id="3626502">,</span>&nbsp;<span class="ident" id="3626504">certFile</span>&nbsp;<span class="builtintype" id="3626513">string</span><span class="op" id="3626519">,</span>&nbsp;<span class="ident" id="3626521">keyFile</span>&nbsp;<span class="builtintype" id="3626529">string</span><span class="op" id="3626535">,</span>&nbsp;<span class="ident" id="3626537">handler</span>&nbsp;<span class="ident" id="3626545">Handler</span><span class="op" id="3626552">)</span>&nbsp;<span class="builtintype" id="3626554">error</span>&nbsp;<span class="op" id="3626560">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3626563">server</span>&nbsp;<span class="op" id="3626570">:=</span>&nbsp;<span class="op" id="3626573">&amp;</span><span class="ident" id="3626574">Server</span><span class="op" id="3626580">{</span><span class="ident" id="3626581">Addr</span><span class="op" id="3626585">:</span>&nbsp;<span class="ident" id="3626587">addr</span><span class="op" id="3626591">,</span>&nbsp;<span class="ident" id="3626593">Handler</span><span class="op" id="3626600">:</span>&nbsp;<span class="ident" id="3626602">handler</span><span class="op" id="3626609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626612">return</span>&nbsp;<span class="ident" id="3626619">server</span><span class="op" id="3626625">.</span><span class="ident" id="3626626">ListenAndServeTLS</span><span class="op" id="3626643">(</span><span class="ident" id="3626644">certFile</span><span class="op" id="3626652">,</span>&nbsp;<span class="ident" id="3626654">keyFile</span><span class="op" id="3626661">)</span><br>
<span class="lineno"></span><span class="op" id="3626663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3626666">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="3626735">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="3626803">//</span><br>
<span class="lineno"></span><span class="comment" id="3626806">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3626873">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3626939">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="3627006">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3627071">//</span><br>
<span class="lineno"></span><span class="comment" id="3627074">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3627117">func</span>&nbsp;<span class="op" id="3627122">(</span><span class="ident" id="3627123">srv</span>&nbsp;<span class="op" id="3627127">*</span><span class="ident" id="3627128">Server</span><span class="op" id="3627134">)</span>&nbsp;<span class="ident" id="3627136">ListenAndServeTLS</span><span class="op" id="3627153">(</span><span class="ident" id="3627154">certFile</span><span class="op" id="3627162">,</span>&nbsp;<span class="ident" id="3627164">keyFile</span>&nbsp;<span class="builtintype" id="3627172">string</span><span class="op" id="3627178">)</span>&nbsp;<span class="builtintype" id="3627180">error</span>&nbsp;<span class="op" id="3627186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627189">addr</span>&nbsp;<span class="op" id="3627194">:=</span>&nbsp;<span class="ident" id="3627197">srv</span><span class="op" id="3627200">.</span><span class="ident" id="3627201">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627207">if</span>&nbsp;<span class="ident" id="3627210">addr</span>&nbsp;<span class="op" id="3627215">==</span>&nbsp;<span class="string" id="3627218">&#34;&#34;</span>&nbsp;<span class="op" id="3627221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627225">addr</span>&nbsp;<span class="op" id="3627230">=</span>&nbsp;<span class="string" id="3627232">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627245">config</span>&nbsp;<span class="op" id="3627252">:=</span>&nbsp;<span class="op" id="3627255">&amp;</span><span class="ident" id="3627256">tls</span><span class="op" id="3627259">.</span><span class="ident" id="3627260">Config</span><span class="op" id="3627266">{</span><span class="op" id="3627267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627270">if</span>&nbsp;<span class="ident" id="3627273">srv</span><span class="op" id="3627276">.</span><span class="ident" id="3627277">TLSConfig</span>&nbsp;<span class="op" id="3627287">!=</span>&nbsp;<span class="ident" id="3627290">nil</span>&nbsp;<span class="op" id="3627294">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627298">*</span><span class="ident" id="3627299">config</span>&nbsp;<span class="op" id="3627306">=</span>&nbsp;<span class="op" id="3627308">*</span><span class="ident" id="3627309">srv</span><span class="op" id="3627312">.</span><span class="ident" id="3627313">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627327">if</span>&nbsp;<span class="ident" id="3627330">config</span><span class="op" id="3627336">.</span><span class="ident" id="3627337">NextProtos</span>&nbsp;<span class="op" id="3627348">==</span>&nbsp;<span class="ident" id="3627351">nil</span>&nbsp;<span class="op" id="3627355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627359">config</span><span class="op" id="3627365">.</span><span class="ident" id="3627366">NextProtos</span>&nbsp;<span class="op" id="3627377">=</span>&nbsp;<span class="op" id="3627379">[</span><span class="op" id="3627380">]</span><span class="builtintype" id="3627381">string</span><span class="op" id="3627387">{</span><span class="string" id="3627388">&#34;http/1.1&#34;</span><span class="op" id="3627398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627401">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627405">var</span>&nbsp;<span class="ident" id="3627409">err</span>&nbsp;<span class="builtintype" id="3627413">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627420">config</span><span class="op" id="3627426">.</span><span class="ident" id="3627427">Certificates</span>&nbsp;<span class="op" id="3627440">=</span>&nbsp;<span class="builtinfunc" id="3627442">make</span><span class="op" id="3627446">(</span><span class="op" id="3627447">[</span><span class="op" id="3627448">]</span><span class="ident" id="3627449">tls</span><span class="op" id="3627452">.</span><span class="ident" id="3627453">Certificate</span><span class="op" id="3627464">,</span>&nbsp;<span class="num" id="3627466">1</span><span class="op" id="3627467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627470">config</span><span class="op" id="3627476">.</span><span class="ident" id="3627477">Certificates</span><span class="op" id="3627489">[</span><span class="num" id="3627490">0</span><span class="op" id="3627491">]</span><span class="op" id="3627492">,</span>&nbsp;<span class="ident" id="3627494">err</span>&nbsp;<span class="op" id="3627498">=</span>&nbsp;<span class="ident" id="3627500">tls</span><span class="op" id="3627503">.</span><span class="ident" id="3627504">LoadX509KeyPair</span><span class="op" id="3627519">(</span><span class="ident" id="3627520">certFile</span><span class="op" id="3627528">,</span>&nbsp;<span class="ident" id="3627530">keyFile</span><span class="op" id="3627537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627540">if</span>&nbsp;<span class="ident" id="3627543">err</span>&nbsp;<span class="op" id="3627547">!=</span>&nbsp;<span class="ident" id="3627550">nil</span>&nbsp;<span class="op" id="3627554">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627558">return</span>&nbsp;<span class="ident" id="3627565">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627574">ln</span><span class="op" id="3627576">,</span>&nbsp;<span class="ident" id="3627578">err</span>&nbsp;<span class="op" id="3627582">:=</span>&nbsp;<span class="ident" id="3627585">net</span><span class="op" id="3627588">.</span><span class="ident" id="3627589">Listen</span><span class="op" id="3627595">(</span><span class="string" id="3627596">&#34;tcp&#34;</span><span class="op" id="3627601">,</span>&nbsp;<span class="ident" id="3627603">addr</span><span class="op" id="3627607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627610">if</span>&nbsp;<span class="ident" id="3627613">err</span>&nbsp;<span class="op" id="3627617">!=</span>&nbsp;<span class="ident" id="3627620">nil</span>&nbsp;<span class="op" id="3627624">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627628">return</span>&nbsp;<span class="ident" id="3627635">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627644">tlsListener</span>&nbsp;<span class="op" id="3627656">:=</span>&nbsp;<span class="ident" id="3627659">tls</span><span class="op" id="3627662">.</span><span class="ident" id="3627663">NewListener</span><span class="op" id="3627674">(</span><span class="ident" id="3627675">tcpKeepAliveListener</span><span class="op" id="3627695">{</span><span class="ident" id="3627696">ln</span><span class="op" id="3627698">.</span><span class="op" id="3627699">(</span><span class="op" id="3627700">*</span><span class="ident" id="3627701">net</span><span class="op" id="3627704">.</span><span class="ident" id="3627705">TCPListener</span><span class="op" id="3627716">)</span><span class="op" id="3627717">}</span><span class="op" id="3627718">,</span>&nbsp;<span class="ident" id="3627720">config</span><span class="op" id="3627726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627729">return</span>&nbsp;<span class="ident" id="3627736">srv</span><span class="op" id="3627739">.</span><span class="ident" id="3627740">Serve</span><span class="op" id="3627745">(</span><span class="ident" id="3627746">tlsListener</span><span class="op" id="3627757">)</span><br>
<span class="lineno">1880</span><span class="op" id="3627759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3627762">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="3627837">//</span><br>
<span class="lineno"></span><span class="comment" id="3627840">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="3627910">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3627981">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="3628051">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="3628114">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="3628185">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="3628207">func</span>&nbsp;<span class="ident" id="3628212">TimeoutHandler</span><span class="op" id="3628226">(</span><span class="ident" id="3628227">h</span>&nbsp;<span class="ident" id="3628229">Handler</span><span class="op" id="3628236">,</span>&nbsp;<span class="ident" id="3628238">dt</span>&nbsp;<span class="ident" id="3628241">time</span><span class="op" id="3628245">.</span><span class="ident" id="3628246">Duration</span><span class="op" id="3628254">,</span>&nbsp;<span class="ident" id="3628256">msg</span>&nbsp;<span class="builtintype" id="3628260">string</span><span class="op" id="3628266">)</span>&nbsp;<span class="ident" id="3628268">Handler</span>&nbsp;<span class="op" id="3628276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628279">f</span>&nbsp;<span class="op" id="3628281">:=</span>&nbsp;<span class="keyword" id="3628284">func</span><span class="op" id="3628288">(</span><span class="op" id="3628289">)</span>&nbsp;<span class="op" id="3628291">&lt;-</span><span class="keyword" id="3628293">chan</span>&nbsp;<span class="ident" id="3628298">time</span><span class="op" id="3628302">.</span><span class="ident" id="3628303">Time</span>&nbsp;<span class="op" id="3628308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628312">return</span>&nbsp;<span class="ident" id="3628319">time</span><span class="op" id="3628323">.</span><span class="ident" id="3628324">After</span><span class="op" id="3628329">(</span><span class="ident" id="3628330">dt</span><span class="op" id="3628332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3628335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628338">return</span>&nbsp;<span class="op" id="3628345">&amp;</span><span class="ident" id="3628346">timeoutHandler</span><span class="op" id="3628360">{</span><span class="ident" id="3628361">h</span><span class="op" id="3628362">,</span>&nbsp;<span class="ident" id="3628364">f</span><span class="op" id="3628365">,</span>&nbsp;<span class="ident" id="3628367">msg</span><span class="op" id="3628370">}</span><br>
<span class="lineno">1895</span><span class="op" id="3628372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3628375">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3628438">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3628475">var</span>&nbsp;<span class="ident" id="3628479">ErrHandlerTimeout</span>&nbsp;<span class="op" id="3628497">=</span>&nbsp;<span class="ident" id="3628499">errors</span><span class="op" id="3628505">.</span><span class="ident" id="3628506">New</span><span class="op" id="3628509">(</span><span class="string" id="3628510">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="3628533">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="3628536">type</span>&nbsp;<span class="ident" id="3628541">timeoutHandler</span>&nbsp;<span class="keyword" id="3628556">struct</span>&nbsp;<span class="op" id="3628563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628566">handler</span>&nbsp;<span class="ident" id="3628574">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628583">timeout</span>&nbsp;<span class="keyword" id="3628591">func</span><span class="op" id="3628595">(</span><span class="op" id="3628596">)</span>&nbsp;<span class="op" id="3628598">&lt;-</span><span class="keyword" id="3628600">chan</span>&nbsp;<span class="ident" id="3628605">time</span><span class="op" id="3628609">.</span><span class="ident" id="3628610">Time</span>&nbsp;<span class="comment" id="3628615">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628655">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3628663">string</span><br>
<span class="lineno">1905</span><span class="op" id="3628670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3628673">func</span>&nbsp;<span class="op" id="3628678">(</span><span class="ident" id="3628679">h</span>&nbsp;<span class="op" id="3628681">*</span><span class="ident" id="3628682">timeoutHandler</span><span class="op" id="3628696">)</span>&nbsp;<span class="ident" id="3628698">errorBody</span><span class="op" id="3628707">(</span><span class="op" id="3628708">)</span>&nbsp;<span class="builtintype" id="3628710">string</span>&nbsp;<span class="op" id="3628717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628720">if</span>&nbsp;<span class="ident" id="3628723">h</span><span class="op" id="3628724">.</span><span class="ident" id="3628725">body</span>&nbsp;<span class="op" id="3628730">!=</span>&nbsp;<span class="string" id="3628733">&#34;&#34;</span>&nbsp;<span class="op" id="3628736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628740">return</span>&nbsp;<span class="ident" id="3628747">h</span><span class="op" id="3628748">.</span><span class="ident" id="3628749">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3628755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628758">return</span>&nbsp;<span class="string" id="3628765">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3628845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3628848">func</span>&nbsp;<span class="op" id="3628853">(</span><span class="ident" id="3628854">h</span>&nbsp;<span class="op" id="3628856">*</span><span class="ident" id="3628857">timeoutHandler</span><span class="op" id="3628871">)</span>&nbsp;<span class="ident" id="3628873">ServeHTTP</span><span class="op" id="3628882">(</span><span class="ident" id="3628883">w</span>&nbsp;<span class="ident" id="3628885">ResponseWriter</span><span class="op" id="3628899">,</span>&nbsp;<span class="ident" id="3628901">r</span>&nbsp;<span class="op" id="3628903">*</span><span class="ident" id="3628904">Request</span><span class="op" id="3628911">)</span>&nbsp;<span class="op" id="3628913">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628916">done</span>&nbsp;<span class="op" id="3628921">:=</span>&nbsp;<span class="builtinfunc" id="3628924">make</span><span class="op" id="3628928">(</span><span class="keyword" id="3628929">chan</span>&nbsp;<span class="builtintype" id="3628934">bool</span><span class="op" id="3628938">,</span>&nbsp;<span class="num" id="3628940">1</span><span class="op" id="3628941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628944">tw</span>&nbsp;<span class="op" id="3628947">:=</span>&nbsp;<span class="op" id="3628950">&amp;</span><span class="ident" id="3628951">timeoutWriter</span><span class="op" id="3628964">{</span><span class="ident" id="3628965">w</span><span class="op" id="3628966">:</span>&nbsp;<span class="ident" id="3628968">w</span><span class="op" id="3628969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628972">go</span>&nbsp;<span class="keyword" id="3628975">func</span><span class="op" id="3628979">(</span><span class="op" id="3628980">)</span>&nbsp;<span class="op" id="3628982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628986">h</span><span class="op" id="3628987">.</span><span class="ident" id="3628988">handler</span><span class="op" id="3628995">.</span><span class="ident" id="3628996">ServeHTTP</span><span class="op" id="3629005">(</span><span class="ident" id="3629006">tw</span><span class="op" id="3629008">,</span>&nbsp;<span class="ident" id="3629010">r</span><span class="op" id="3629011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629015">done</span>&nbsp;<span class="op" id="3629020">&lt;-</span>&nbsp;<span class="ident" id="3629023">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629029">}</span><span class="op" id="3629030">(</span><span class="op" id="3629031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629034">select</span>&nbsp;<span class="op" id="3629041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629044">case</span>&nbsp;<span class="op" id="3629049">&lt;-</span><span class="ident" id="3629051">done</span><span class="op" id="3629055">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629059">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629067">case</span>&nbsp;<span class="op" id="3629072">&lt;-</span><span class="ident" id="3629074">h</span><span class="op" id="3629075">.</span><span class="ident" id="3629076">timeout</span><span class="op" id="3629083">(</span><span class="op" id="3629084">)</span><span class="op" id="3629085">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629089">tw</span><span class="op" id="3629091">.</span><span class="ident" id="3629092">mu</span><span class="op" id="3629094">.</span><span class="ident" id="3629095">Lock</span><span class="op" id="3629099">(</span><span class="op" id="3629100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629104">defer</span>&nbsp;<span class="ident" id="3629110">tw</span><span class="op" id="3629112">.</span><span class="ident" id="3629113">mu</span><span class="op" id="3629115">.</span><span class="ident" id="3629116">Unlock</span><span class="op" id="3629122">(</span><span class="op" id="3629123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629127">if</span>&nbsp;<span class="op" id="3629130">!</span><span class="ident" id="3629131">tw</span><span class="op" id="3629133">.</span><span class="ident" id="3629134">wroteHeader</span>&nbsp;<span class="op" id="3629146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629151">tw</span><span class="op" id="3629153">.</span><span class="ident" id="3629154">w</span><span class="op" id="3629155">.</span><span class="ident" id="3629156">WriteHeader</span><span class="op" id="3629167">(</span><span class="ident" id="3629168">StatusServiceUnavailable</span><span class="op" id="3629192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629197">tw</span><span class="op" id="3629199">.</span><span class="ident" id="3629200">w</span><span class="op" id="3629201">.</span><span class="ident" id="3629202">Write</span><span class="op" id="3629207">(</span><span class="op" id="3629208">[</span><span class="op" id="3629209">]</span><span class="builtintype" id="3629210">byte</span><span class="op" id="3629214">(</span><span class="ident" id="3629215">h</span><span class="op" id="3629216">.</span><span class="ident" id="3629217">errorBody</span><span class="op" id="3629226">(</span><span class="op" id="3629227">)</span><span class="op" id="3629228">)</span><span class="op" id="3629229">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629237">tw</span><span class="op" id="3629239">.</span><span class="ident" id="3629240">timedOut</span>&nbsp;<span class="op" id="3629249">=</span>&nbsp;<span class="ident" id="3629251">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629257">}</span><br>
<span class="lineno"></span><span class="op" id="3629259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="3629262">type</span>&nbsp;<span class="ident" id="3629267">timeoutWriter</span>&nbsp;<span class="keyword" id="3629281">struct</span>&nbsp;<span class="op" id="3629288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629291">w</span>&nbsp;<span class="ident" id="3629293">ResponseWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629310">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3629322">sync</span><span class="op" id="3629326">.</span><span class="ident" id="3629327">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629334">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3629346">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629352">wroteHeader</span>&nbsp;<span class="builtintype" id="3629364">bool</span><br>
<span class="lineno"></span><span class="op" id="3629369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3629372">func</span>&nbsp;<span class="op" id="3629377">(</span><span class="ident" id="3629378">tw</span>&nbsp;<span class="op" id="3629381">*</span><span class="ident" id="3629382">timeoutWriter</span><span class="op" id="3629395">)</span>&nbsp;<span class="ident" id="3629397">Header</span><span class="op" id="3629403">(</span><span class="op" id="3629404">)</span>&nbsp;<span class="ident" id="3629406">Header</span>&nbsp;<span class="op" id="3629413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629416">return</span>&nbsp;<span class="ident" id="3629423">tw</span><span class="op" id="3629425">.</span><span class="ident" id="3629426">w</span><span class="op" id="3629427">.</span><span class="ident" id="3629428">Header</span><span class="op" id="3629434">(</span><span class="op" id="3629435">)</span><br>
<span class="lineno">1945</span><span class="op" id="3629437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3629440">func</span>&nbsp;<span class="op" id="3629445">(</span><span class="ident" id="3629446">tw</span>&nbsp;<span class="op" id="3629449">*</span><span class="ident" id="3629450">timeoutWriter</span><span class="op" id="3629463">)</span>&nbsp;<span class="ident" id="3629465">Write</span><span class="op" id="3629470">(</span><span class="ident" id="3629471">p</span>&nbsp;<span class="op" id="3629473">[</span><span class="op" id="3629474">]</span><span class="builtintype" id="3629475">byte</span><span class="op" id="3629479">)</span>&nbsp;<span class="op" id="3629481">(</span><span class="builtintype" id="3629482">int</span><span class="op" id="3629485">,</span>&nbsp;<span class="builtintype" id="3629487">error</span><span class="op" id="3629492">)</span>&nbsp;<span class="op" id="3629494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629497">tw</span><span class="op" id="3629499">.</span><span class="ident" id="3629500">mu</span><span class="op" id="3629502">.</span><span class="ident" id="3629503">Lock</span><span class="op" id="3629507">(</span><span class="op" id="3629508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629511">defer</span>&nbsp;<span class="ident" id="3629517">tw</span><span class="op" id="3629519">.</span><span class="ident" id="3629520">mu</span><span class="op" id="3629522">.</span><span class="ident" id="3629523">Unlock</span><span class="op" id="3629529">(</span><span class="op" id="3629530">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629533">tw</span><span class="op" id="3629535">.</span><span class="ident" id="3629536">wroteHeader</span>&nbsp;<span class="op" id="3629548">=</span>&nbsp;<span class="ident" id="3629550">true</span>&nbsp;<span class="comment" id="3629555">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629579">if</span>&nbsp;<span class="ident" id="3629582">tw</span><span class="op" id="3629584">.</span><span class="ident" id="3629585">timedOut</span>&nbsp;<span class="op" id="3629594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629598">return</span>&nbsp;<span class="num" id="3629605">0</span><span class="op" id="3629606">,</span>&nbsp;<span class="ident" id="3629608">ErrHandlerTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629630">return</span>&nbsp;<span class="ident" id="3629637">tw</span><span class="op" id="3629639">.</span><span class="ident" id="3629640">w</span><span class="op" id="3629641">.</span><span class="ident" id="3629642">Write</span><span class="op" id="3629647">(</span><span class="ident" id="3629648">p</span><span class="op" id="3629649">)</span><br>
<span class="lineno">1955</span><span class="op" id="3629651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3629654">func</span>&nbsp;<span class="op" id="3629659">(</span><span class="ident" id="3629660">tw</span>&nbsp;<span class="op" id="3629663">*</span><span class="ident" id="3629664">timeoutWriter</span><span class="op" id="3629677">)</span>&nbsp;<span class="ident" id="3629679">WriteHeader</span><span class="op" id="3629690">(</span><span class="ident" id="3629691">code</span>&nbsp;<span class="builtintype" id="3629696">int</span><span class="op" id="3629699">)</span>&nbsp;<span class="op" id="3629701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629704">tw</span><span class="op" id="3629706">.</span><span class="ident" id="3629707">mu</span><span class="op" id="3629709">.</span><span class="ident" id="3629710">Lock</span><span class="op" id="3629714">(</span><span class="op" id="3629715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629718">defer</span>&nbsp;<span class="ident" id="3629724">tw</span><span class="op" id="3629726">.</span><span class="ident" id="3629727">mu</span><span class="op" id="3629729">.</span><span class="ident" id="3629730">Unlock</span><span class="op" id="3629736">(</span><span class="op" id="3629737">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629740">if</span>&nbsp;<span class="ident" id="3629743">tw</span><span class="op" id="3629745">.</span><span class="ident" id="3629746">timedOut</span>&nbsp;<span class="op" id="3629755">||</span>&nbsp;<span class="ident" id="3629758">tw</span><span class="op" id="3629760">.</span><span class="ident" id="3629761">wroteHeader</span>&nbsp;<span class="op" id="3629773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629777">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629788">tw</span><span class="op" id="3629790">.</span><span class="ident" id="3629791">wroteHeader</span>&nbsp;<span class="op" id="3629803">=</span>&nbsp;<span class="ident" id="3629805">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629811">tw</span><span class="op" id="3629813">.</span><span class="ident" id="3629814">w</span><span class="op" id="3629815">.</span><span class="ident" id="3629816">WriteHeader</span><span class="op" id="3629827">(</span><span class="ident" id="3629828">code</span><span class="op" id="3629832">)</span><br>
<span class="lineno">1965</span><span class="op" id="3629834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3629837">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="3629902">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3629971">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="3630041">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="3630053">type</span>&nbsp;<span class="ident" id="3630058">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="3630079">struct</span>&nbsp;<span class="op" id="3630086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3630089">*</span><span class="ident" id="3630090">net</span><span class="op" id="3630093">.</span><span class="ident" id="3630094">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="3630106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="3630109">func</span>&nbsp;<span class="op" id="3630114">(</span><span class="ident" id="3630115">ln</span>&nbsp;<span class="ident" id="3630118">tcpKeepAliveListener</span><span class="op" id="3630138">)</span>&nbsp;<span class="ident" id="3630140">Accept</span><span class="op" id="3630146">(</span><span class="op" id="3630147">)</span>&nbsp;<span class="op" id="3630149">(</span><span class="ident" id="3630150">c</span>&nbsp;<span class="ident" id="3630152">net</span><span class="op" id="3630155">.</span><span class="ident" id="3630156">Conn</span><span class="op" id="3630160">,</span>&nbsp;<span class="ident" id="3630162">err</span>&nbsp;<span class="builtintype" id="3630166">error</span><span class="op" id="3630171">)</span>&nbsp;<span class="op" id="3630173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3630176">tc</span><span class="op" id="3630178">,</span>&nbsp;<span class="ident" id="3630180">err</span>&nbsp;<span class="op" id="3630184">:=</span>&nbsp;<span class="ident" id="3630187">ln</span><span class="op" id="3630189">.</span><span class="ident" id="3630190">AcceptTCP</span><span class="op" id="3630199">(</span><span class="op" id="3630200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3630203">if</span>&nbsp;<span class="ident" id="3630206">err</span>&nbsp;<span class="op" id="3630210">!=</span>&nbsp;<span class="ident" id="3630213">nil</span>&nbsp;<span class="op" id="3630217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3630221">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3630229">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3630232">tc</span><span class="op" id="3630234">.</span><span class="ident" id="3630235">SetKeepAlive</span><span class="op" id="3630247">(</span><span class="ident" id="3630248">true</span><span class="op" id="3630252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3630255">tc</span><span class="op" id="3630257">.</span><span class="ident" id="3630258">SetKeepAlivePeriod</span><span class="op" id="3630276">(</span><span class="num" id="3630277">3</span>&nbsp;<span class="op" id="3630279">*</span>&nbsp;<span class="ident" id="3630281">time</span><span class="op" id="3630285">.</span><span class="ident" id="3630286">Minute</span><span class="op" id="3630292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3630295">return</span>&nbsp;<span class="ident" id="3630302">tc</span><span class="op" id="3630304">,</span>&nbsp;<span class="ident" id="3630306">nil</span><br>
<span class="lineno"></span><span class="op" id="3630310">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="3630313">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3630371">type</span>&nbsp;<span class="ident" id="3630376">globalOptionsHandler</span>&nbsp;<span class="keyword" id="3630397">struct</span><span class="op" id="3630403">{</span><span class="op" id="3630404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3630407">func</span>&nbsp;<span class="op" id="3630412">(</span><span class="ident" id="3630413">globalOptionsHandler</span><span class="op" id="3630433">)</span>&nbsp;<span class="ident" id="3630435">ServeHTTP</span><span class="op" id="3630444">(</span><span class="ident" id="3630445">w</span>&nbsp;<span class="ident" id="3630447">ResponseWriter</span><span class="op" id="3630461">,</span>&nbsp;<span class="ident" id="3630463">r</span>&nbsp;<span class="op" id="3630465">*</span><span class="ident" id="3630466">Request</span><span class="op" id="3630473">)</span>&nbsp;<span class="op" id="3630475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3630478">w</span><span class="op" id="3630479">.</span><span class="ident" id="3630480">Header</span><span class="op" id="3630486">(</span><span class="op" id="3630487">)</span><span class="op" id="3630488">.</span><span class="ident" id="3630489">Set</span><span class="op" id="3630492">(</span><span class="string" id="3630493">&#34;Content-Length&#34;</span><span class="op" id="3630509">,</span>&nbsp;<span class="string" id="3630511">&#34;0&#34;</span><span class="op" id="3630514">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3630517">if</span>&nbsp;<span class="ident" id="3630520">r</span><span class="op" id="3630521">.</span><span class="ident" id="3630522">ContentLength</span>&nbsp;<span class="op" id="3630536">!=</span>&nbsp;<span class="num" id="3630539">0</span>&nbsp;<span class="op" id="3630541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3630545">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3630602">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3630660">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3630717">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3630776">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3630824">mb</span>&nbsp;<span class="op" id="3630827">:=</span>&nbsp;<span class="ident" id="3630830">MaxBytesReader</span><span class="op" id="3630844">(</span><span class="ident" id="3630845">w</span><span class="op" id="3630846">,</span>&nbsp;<span class="ident" id="3630848">r</span><span class="op" id="3630849">.</span><span class="ident" id="3630850">Body</span><span class="op" id="3630854">,</span>&nbsp;<span class="num" id="3630856">4</span><span class="op" id="3630857">&lt;&lt;</span><span class="num" id="3630859">10</span><span class="op" id="3630861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3630865">io</span><span class="op" id="3630867">.</span><span class="ident" id="3630868">Copy</span><span class="op" id="3630872">(</span><span class="ident" id="3630873">ioutil</span><span class="op" id="3630879">.</span><span class="ident" id="3630880">Discard</span><span class="op" id="3630887">,</span>&nbsp;<span class="ident" id="3630889">mb</span><span class="op" id="3630891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3630894">}</span><br>
<span class="lineno"></span><span class="op" id="3630896">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="3630899">type</span>&nbsp;<span class="ident" id="3630904">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="3630925">struct</span><span class="op" id="3630931">{</span><span class="op" id="3630932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3630935">func</span>&nbsp;<span class="op" id="3630940">(</span><span class="ident" id="3630941">eofReaderWithWriteTo</span><span class="op" id="3630961">)</span>&nbsp;<span class="ident" id="3630963">WriteTo</span><span class="op" id="3630970">(</span><span class="ident" id="3630971">io</span><span class="op" id="3630973">.</span><span class="ident" id="3630974">Writer</span><span class="op" id="3630980">)</span>&nbsp;<span class="op" id="3630982">(</span><span class="ident" id="3630983">int64</span><span class="op" id="3630988">,</span>&nbsp;<span class="builtintype" id="3630990">error</span><span class="op" id="3630995">)</span>&nbsp;<span class="op" id="3630997">{</span>&nbsp;<span class="keyword" id="3630999">return</span>&nbsp;<span class="num" id="3631006">0</span><span class="op" id="3631007">,</span>&nbsp;<span class="ident" id="3631009">nil</span>&nbsp;<span class="op" id="3631013">}</span><br>
<span class="lineno"></span><span class="keyword" id="3631015">func</span>&nbsp;<span class="op" id="3631020">(</span><span class="ident" id="3631021">eofReaderWithWriteTo</span><span class="op" id="3631041">)</span>&nbsp;<span class="ident" id="3631043">Read</span><span class="op" id="3631047">(</span><span class="op" id="3631048">[</span><span class="op" id="3631049">]</span><span class="builtintype" id="3631050">byte</span><span class="op" id="3631054">)</span>&nbsp;<span class="op" id="3631056">(</span><span class="builtintype" id="3631057">int</span><span class="op" id="3631060">,</span>&nbsp;<span class="builtintype" id="3631062">error</span><span class="op" id="3631067">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3631077">{</span>&nbsp;<span class="keyword" id="3631079">return</span>&nbsp;<span class="num" id="3631086">0</span><span class="op" id="3631087">,</span>&nbsp;<span class="ident" id="3631089">io</span><span class="op" id="3631091">.</span><span class="ident" id="3631092">EOF</span>&nbsp;<span class="op" id="3631096">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="3631099">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="3631164">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3631223">var</span>&nbsp;<span class="ident" id="3631227">eofReader</span>&nbsp;<span class="op" id="3631237">=</span>&nbsp;<span class="op" id="3631239">&amp;</span><span class="keyword" id="3631240">struct</span>&nbsp;<span class="op" id="3631247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3631250">eofReaderWithWriteTo</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3631272">io</span><span class="op" id="3631274">.</span><span class="ident" id="3631275">Closer</span><br>
<span class="lineno"></span><span class="op" id="3631282">}</span><span class="op" id="3631283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3631286">eofReaderWithWriteTo</span><span class="op" id="3631306">{</span><span class="op" id="3631307">}</span><span class="op" id="3631308">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3631311">ioutil</span><span class="op" id="3631317">.</span><span class="ident" id="3631318">NopCloser</span><span class="op" id="3631327">(</span><span class="ident" id="3631328">nil</span><span class="op" id="3631331">)</span><span class="op" id="3631332">,</span><br>
<span class="lineno"></span><span class="op" id="3631334">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="3631337">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3631405">var</span>&nbsp;<span class="ident" id="3631409">_</span>&nbsp;<span class="ident" id="3631411">io</span><span class="op" id="3631413">.</span><span class="ident" id="3631414">WriterTo</span>&nbsp;<span class="op" id="3631423">=</span>&nbsp;<span class="ident" id="3631425">eofReader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3631436">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="3631498">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="3631566">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="3631611">type</span>&nbsp;<span class="ident" id="3631616">initNPNRequest</span>&nbsp;<span class="keyword" id="3631631">struct</span>&nbsp;<span class="op" id="3631638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3631641">c</span>&nbsp;<span class="op" id="3631643">*</span><span class="ident" id="3631644">tls</span><span class="op" id="3631647">.</span><span class="ident" id="3631648">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3631654">h</span>&nbsp;<span class="ident" id="3631656">serverHandler</span><br>
<span class="lineno">2025</span><span class="op" id="3631670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3631673">func</span>&nbsp;<span class="op" id="3631678">(</span><span class="ident" id="3631679">h</span>&nbsp;<span class="ident" id="3631681">initNPNRequest</span><span class="op" id="3631695">)</span>&nbsp;<span class="ident" id="3631697">ServeHTTP</span><span class="op" id="3631706">(</span><span class="ident" id="3631707">rw</span>&nbsp;<span class="ident" id="3631710">ResponseWriter</span><span class="op" id="3631724">,</span>&nbsp;<span class="ident" id="3631726">req</span>&nbsp;<span class="op" id="3631730">*</span><span class="ident" id="3631731">Request</span><span class="op" id="3631738">)</span>&nbsp;<span class="op" id="3631740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3631743">if</span>&nbsp;<span class="ident" id="3631746">req</span><span class="op" id="3631749">.</span><span class="ident" id="3631750">TLS</span>&nbsp;<span class="op" id="3631754">==</span>&nbsp;<span class="ident" id="3631757">nil</span>&nbsp;<span class="op" id="3631761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3631765">req</span><span class="op" id="3631768">.</span><span class="ident" id="3631769">TLS</span>&nbsp;<span class="op" id="3631773">=</span>&nbsp;<span class="op" id="3631775">&amp;</span><span class="ident" id="3631776">tls</span><span class="op" id="3631779">.</span><span class="ident" id="3631780">ConnectionState</span><span class="op" id="3631795">{</span><span class="op" id="3631796">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3631800">*</span><span class="ident" id="3631801">req</span><span class="op" id="3631804">.</span><span class="ident" id="3631805">TLS</span>&nbsp;<span class="op" id="3631809">=</span>&nbsp;<span class="ident" id="3631811">h</span><span class="op" id="3631812">.</span><span class="ident" id="3631813">c</span><span class="op" id="3631814">.</span><span class="ident" id="3631815">ConnectionState</span><span class="op" id="3631830">(</span><span class="op" id="3631831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3631834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3631837">if</span>&nbsp;<span class="ident" id="3631840">req</span><span class="op" id="3631843">.</span><span class="ident" id="3631844">Body</span>&nbsp;<span class="op" id="3631849">==</span>&nbsp;<span class="ident" id="3631852">nil</span>&nbsp;<span class="op" id="3631856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3631860">req</span><span class="op" id="3631863">.</span><span class="ident" id="3631864">Body</span>&nbsp;<span class="op" id="3631869">=</span>&nbsp;<span class="ident" id="3631871">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3631882">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3631885">if</span>&nbsp;<span class="ident" id="3631888">req</span><span class="op" id="3631891">.</span><span class="ident" id="3631892">RemoteAddr</span>&nbsp;<span class="op" id="3631903">==</span>&nbsp;<span class="string" id="3631906">&#34;&#34;</span>&nbsp;<span class="op" id="3631909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3631913">req</span><span class="op" id="3631916">.</span><span class="ident" id="3631917">RemoteAddr</span>&nbsp;<span class="op" id="3631928">=</span>&nbsp;<span class="ident" id="3631930">h</span><span class="op" id="3631931">.</span><span class="ident" id="3631932">c</span><span class="op" id="3631933">.</span><span class="ident" id="3631934">RemoteAddr</span><span class="op" id="3631944">(</span><span class="op" id="3631945">)</span><span class="op" id="3631946">.</span><span class="ident" id="3631947">String</span><span class="op" id="3631953">(</span><span class="op" id="3631954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3631957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3631960">h</span><span class="op" id="3631961">.</span><span class="ident" id="3631962">h</span><span class="op" id="3631963">.</span><span class="ident" id="3631964">ServeHTTP</span><span class="op" id="3631973">(</span><span class="ident" id="3631974">rw</span><span class="op" id="3631976">,</span>&nbsp;<span class="ident" id="3631978">req</span><span class="op" id="3631981">)</span><br>
<span class="lineno"></span><span class="op" id="3631983">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="3631986">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="3632024">type</span>&nbsp;<span class="ident" id="3632029">loggingConn</span>&nbsp;<span class="keyword" id="3632041">struct</span>&nbsp;<span class="op" id="3632048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632051">name</span>&nbsp;<span class="builtintype" id="3632056">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632064">net</span><span class="op" id="3632067">.</span><span class="ident" id="3632068">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="3632073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3632076">var</span>&nbsp;<span class="op" id="3632080">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632083">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3632096">sync</span><span class="op" id="3632100">.</span><span class="ident" id="3632101">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632108">uniqNameNext</span>&nbsp;<span class="op" id="3632121">=</span>&nbsp;<span class="builtinfunc" id="3632123">make</span><span class="op" id="3632127">(</span><span class="keyword" id="3632128">map</span><span class="op" id="3632131">[</span><span class="builtintype" id="3632132">string</span><span class="op" id="3632138">]</span><span class="builtintype" id="3632139">int</span><span class="op" id="3632142">)</span><br>
<span class="lineno">2050</span><span class="op" id="3632144">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3632147">func</span>&nbsp;<span class="ident" id="3632152">newLoggingConn</span><span class="op" id="3632166">(</span><span class="ident" id="3632167">baseName</span>&nbsp;<span class="builtintype" id="3632176">string</span><span class="op" id="3632182">,</span>&nbsp;<span class="ident" id="3632184">c</span>&nbsp;<span class="ident" id="3632186">net</span><span class="op" id="3632189">.</span><span class="ident" id="3632190">Conn</span><span class="op" id="3632194">)</span>&nbsp;<span class="ident" id="3632196">net</span><span class="op" id="3632199">.</span><span class="ident" id="3632200">Conn</span>&nbsp;<span class="op" id="3632205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632208">uniqNameMu</span><span class="op" id="3632218">.</span><span class="ident" id="3632219">Lock</span><span class="op" id="3632223">(</span><span class="op" id="3632224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3632227">defer</span>&nbsp;<span class="ident" id="3632233">uniqNameMu</span><span class="op" id="3632243">.</span><span class="ident" id="3632244">Unlock</span><span class="op" id="3632250">(</span><span class="op" id="3632251">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632254">uniqNameNext</span><span class="op" id="3632266">[</span><span class="ident" id="3632267">baseName</span><span class="op" id="3632275">]</span><span class="op" id="3632276">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3632280">return</span>&nbsp;<span class="op" id="3632287">&amp;</span><span class="ident" id="3632288">loggingConn</span><span class="op" id="3632299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632303">name</span><span class="op" id="3632307">:</span>&nbsp;<span class="ident" id="3632309">fmt</span><span class="op" id="3632312">.</span><span class="ident" id="3632313">Sprintf</span><span class="op" id="3632320">(</span><span class="string" id="3632321">&#34;%s-%d&#34;</span><span class="op" id="3632328">,</span>&nbsp;<span class="ident" id="3632330">baseName</span><span class="op" id="3632338">,</span>&nbsp;<span class="ident" id="3632340">uniqNameNext</span><span class="op" id="3632352">[</span><span class="ident" id="3632353">baseName</span><span class="op" id="3632361">]</span><span class="op" id="3632362">)</span><span class="op" id="3632363">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632367">Conn</span><span class="op" id="3632371">:</span>&nbsp;<span class="ident" id="3632373">c</span><span class="op" id="3632374">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3632377">}</span><br>
<span class="lineno">2060</span><span class="op" id="3632379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3632382">func</span>&nbsp;<span class="op" id="3632387">(</span><span class="ident" id="3632388">c</span>&nbsp;<span class="op" id="3632390">*</span><span class="ident" id="3632391">loggingConn</span><span class="op" id="3632402">)</span>&nbsp;<span class="ident" id="3632404">Write</span><span class="op" id="3632409">(</span><span class="ident" id="3632410">p</span>&nbsp;<span class="op" id="3632412">[</span><span class="op" id="3632413">]</span><span class="builtintype" id="3632414">byte</span><span class="op" id="3632418">)</span>&nbsp;<span class="op" id="3632420">(</span><span class="ident" id="3632421">n</span>&nbsp;<span class="builtintype" id="3632423">int</span><span class="op" id="3632426">,</span>&nbsp;<span class="ident" id="3632428">err</span>&nbsp;<span class="builtintype" id="3632432">error</span><span class="op" id="3632437">)</span>&nbsp;<span class="op" id="3632439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632442">log</span><span class="op" id="3632445">.</span><span class="ident" id="3632446">Printf</span><span class="op" id="3632452">(</span><span class="string" id="3632453">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3632474">,</span>&nbsp;<span class="ident" id="3632476">c</span><span class="op" id="3632477">.</span><span class="ident" id="3632478">name</span><span class="op" id="3632482">,</span>&nbsp;<span class="builtinfunc" id="3632484">len</span><span class="op" id="3632487">(</span><span class="ident" id="3632488">p</span><span class="op" id="3632489">)</span><span class="op" id="3632490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632493">n</span><span class="op" id="3632494">,</span>&nbsp;<span class="ident" id="3632496">err</span>&nbsp;<span class="op" id="3632500">=</span>&nbsp;<span class="ident" id="3632502">c</span><span class="op" id="3632503">.</span><span class="ident" id="3632504">Conn</span><span class="op" id="3632508">.</span><span class="ident" id="3632509">Write</span><span class="op" id="3632514">(</span><span class="ident" id="3632515">p</span><span class="op" id="3632516">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632519">log</span><span class="op" id="3632522">.</span><span class="ident" id="3632523">Printf</span><span class="op" id="3632529">(</span><span class="string" id="3632530">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3632553">,</span>&nbsp;<span class="ident" id="3632555">c</span><span class="op" id="3632556">.</span><span class="ident" id="3632557">name</span><span class="op" id="3632561">,</span>&nbsp;<span class="builtinfunc" id="3632563">len</span><span class="op" id="3632566">(</span><span class="ident" id="3632567">p</span><span class="op" id="3632568">)</span><span class="op" id="3632569">,</span>&nbsp;<span class="ident" id="3632571">n</span><span class="op" id="3632572">,</span>&nbsp;<span class="ident" id="3632574">err</span><span class="op" id="3632577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3632580">return</span><br>
<span class="lineno"></span><span class="op" id="3632587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3632590">func</span>&nbsp;<span class="op" id="3632595">(</span><span class="ident" id="3632596">c</span>&nbsp;<span class="op" id="3632598">*</span><span class="ident" id="3632599">loggingConn</span><span class="op" id="3632610">)</span>&nbsp;<span class="ident" id="3632612">Read</span><span class="op" id="3632616">(</span><span class="ident" id="3632617">p</span>&nbsp;<span class="op" id="3632619">[</span><span class="op" id="3632620">]</span><span class="builtintype" id="3632621">byte</span><span class="op" id="3632625">)</span>&nbsp;<span class="op" id="3632627">(</span><span class="ident" id="3632628">n</span>&nbsp;<span class="builtintype" id="3632630">int</span><span class="op" id="3632633">,</span>&nbsp;<span class="ident" id="3632635">err</span>&nbsp;<span class="builtintype" id="3632639">error</span><span class="op" id="3632644">)</span>&nbsp;<span class="op" id="3632646">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632649">log</span><span class="op" id="3632652">.</span><span class="ident" id="3632653">Printf</span><span class="op" id="3632659">(</span><span class="string" id="3632660">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3632680">,</span>&nbsp;<span class="ident" id="3632682">c</span><span class="op" id="3632683">.</span><span class="ident" id="3632684">name</span><span class="op" id="3632688">,</span>&nbsp;<span class="builtinfunc" id="3632690">len</span><span class="op" id="3632693">(</span><span class="ident" id="3632694">p</span><span class="op" id="3632695">)</span><span class="op" id="3632696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632699">n</span><span class="op" id="3632700">,</span>&nbsp;<span class="ident" id="3632702">err</span>&nbsp;<span class="op" id="3632706">=</span>&nbsp;<span class="ident" id="3632708">c</span><span class="op" id="3632709">.</span><span class="ident" id="3632710">Conn</span><span class="op" id="3632714">.</span><span class="ident" id="3632715">Read</span><span class="op" id="3632719">(</span><span class="ident" id="3632720">p</span><span class="op" id="3632721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632724">log</span><span class="op" id="3632727">.</span><span class="ident" id="3632728">Printf</span><span class="op" id="3632734">(</span><span class="string" id="3632735">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3632757">,</span>&nbsp;<span class="ident" id="3632759">c</span><span class="op" id="3632760">.</span><span class="ident" id="3632761">name</span><span class="op" id="3632765">,</span>&nbsp;<span class="builtinfunc" id="3632767">len</span><span class="op" id="3632770">(</span><span class="ident" id="3632771">p</span><span class="op" id="3632772">)</span><span class="op" id="3632773">,</span>&nbsp;<span class="ident" id="3632775">n</span><span class="op" id="3632776">,</span>&nbsp;<span class="ident" id="3632778">err</span><span class="op" id="3632781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3632784">return</span><br>
<span class="lineno"></span><span class="op" id="3632791">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="3632794">func</span>&nbsp;<span class="op" id="3632799">(</span><span class="ident" id="3632800">c</span>&nbsp;<span class="op" id="3632802">*</span><span class="ident" id="3632803">loggingConn</span><span class="op" id="3632814">)</span>&nbsp;<span class="ident" id="3632816">Close</span><span class="op" id="3632821">(</span><span class="op" id="3632822">)</span>&nbsp;<span class="op" id="3632824">(</span><span class="ident" id="3632825">err</span>&nbsp;<span class="builtintype" id="3632829">error</span><span class="op" id="3632834">)</span>&nbsp;<span class="op" id="3632836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632839">log</span><span class="op" id="3632842">.</span><span class="ident" id="3632843">Printf</span><span class="op" id="3632849">(</span><span class="string" id="3632850">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="3632868">,</span>&nbsp;<span class="ident" id="3632870">c</span><span class="op" id="3632871">.</span><span class="ident" id="3632872">name</span><span class="op" id="3632876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632879">err</span>&nbsp;<span class="op" id="3632883">=</span>&nbsp;<span class="ident" id="3632885">c</span><span class="op" id="3632886">.</span><span class="ident" id="3632887">Conn</span><span class="op" id="3632891">.</span><span class="ident" id="3632892">Close</span><span class="op" id="3632897">(</span><span class="op" id="3632898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3632901">log</span><span class="op" id="3632904">.</span><span class="ident" id="3632905">Printf</span><span class="op" id="3632911">(</span><span class="string" id="3632912">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="3632929">,</span>&nbsp;<span class="ident" id="3632931">c</span><span class="op" id="3632932">.</span><span class="ident" id="3632933">name</span><span class="op" id="3632937">,</span>&nbsp;<span class="ident" id="3632939">err</span><span class="op" id="3632942">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3632945">return</span><br>
<span class="lineno"></span><span class="op" id="3632952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3632955">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="3633035">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="3633102">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3633161">type</span>&nbsp;<span class="ident" id="3633166">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="3633187">struct</span>&nbsp;<span class="op" id="3633194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3633197">c</span>&nbsp;<span class="op" id="3633199">*</span><span class="ident" id="3633200">conn</span><br>
<span class="lineno"></span><span class="op" id="3633205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="3633208">func</span>&nbsp;<span class="op" id="3633213">(</span><span class="ident" id="3633214">w</span>&nbsp;<span class="ident" id="3633216">checkConnErrorWriter</span><span class="op" id="3633236">)</span>&nbsp;<span class="ident" id="3633238">Write</span><span class="op" id="3633243">(</span><span class="ident" id="3633244">p</span>&nbsp;<span class="op" id="3633246">[</span><span class="op" id="3633247">]</span><span class="builtintype" id="3633248">byte</span><span class="op" id="3633252">)</span>&nbsp;<span class="op" id="3633254">(</span><span class="ident" id="3633255">n</span>&nbsp;<span class="builtintype" id="3633257">int</span><span class="op" id="3633260">,</span>&nbsp;<span class="ident" id="3633262">err</span>&nbsp;<span class="builtintype" id="3633266">error</span><span class="op" id="3633271">)</span>&nbsp;<span class="op" id="3633273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3633276">n</span><span class="op" id="3633277">,</span>&nbsp;<span class="ident" id="3633279">err</span>&nbsp;<span class="op" id="3633283">=</span>&nbsp;<span class="ident" id="3633285">w</span><span class="op" id="3633286">.</span><span class="ident" id="3633287">c</span><span class="op" id="3633288">.</span><span class="ident" id="3633289">w</span><span class="op" id="3633290">.</span><span class="ident" id="3633291">Write</span><span class="op" id="3633296">(</span><span class="ident" id="3633297">p</span><span class="op" id="3633298">)</span>&nbsp;<span class="comment" id="3633300">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3633358">if</span>&nbsp;<span class="ident" id="3633361">err</span>&nbsp;<span class="op" id="3633365">!=</span>&nbsp;<span class="ident" id="3633368">nil</span>&nbsp;<span class="op" id="3633372">&amp;&amp;</span>&nbsp;<span class="ident" id="3633375">w</span><span class="op" id="3633376">.</span><span class="ident" id="3633377">c</span><span class="op" id="3633378">.</span><span class="ident" id="3633379">werr</span>&nbsp;<span class="op" id="3633384">==</span>&nbsp;<span class="ident" id="3633387">nil</span>&nbsp;<span class="op" id="3633391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3633395">w</span><span class="op" id="3633396">.</span><span class="ident" id="3633397">c</span><span class="op" id="3633398">.</span><span class="ident" id="3633399">werr</span>&nbsp;<span class="op" id="3633404">=</span>&nbsp;<span class="ident" id="3633406">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3633411">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3633414">return</span><br>
<span class="lineno"></span><span class="op" id="3633421">}</span>
</div>
</body>
</html>
