<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment">//&nbsp;min&nbsp;returns&nbsp;the&nbsp;minimum&nbsp;of&nbsp;two&nbsp;integers.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">min</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">y</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;div&nbsp;returns&nbsp;a/b&nbsp;rounded&nbsp;to&nbsp;the&nbsp;nearest&nbsp;integer,&nbsp;instead&nbsp;of&nbsp;rounded&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">div</span><span class="op">(</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="builtintype">int32</span><span class="op">)</span>&nbsp;<span class="builtintype">int32</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">a</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">(</span><span class="ident">a</span>&nbsp;<span class="op">+</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">1</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">-</span><span class="op">(</span><span class="op">(</span><span class="op">-</span><span class="ident">a</span>&nbsp;<span class="op">+</span>&nbsp;<span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">1</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;bitCount&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;needed&nbsp;to&nbsp;hold&nbsp;an&nbsp;integer.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">bitCount</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="num">256</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">quantIndex</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">quantIndexLuminance</span>&nbsp;<span class="ident">quantIndex</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">iota</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">quantIndexChrominance</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nQuantIndex</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;unscaledQuant&nbsp;are&nbsp;the&nbsp;unscaled&nbsp;quantization&nbsp;tables&nbsp;in&nbsp;zig-zag&nbsp;order.&nbsp;Each</span><br>
<span class="lineno">60</span><span class="comment">//&nbsp;encoder&nbsp;copies&nbsp;and&nbsp;scales&nbsp;the&nbsp;tables&nbsp;according&nbsp;to&nbsp;its&nbsp;quality&nbsp;parameter.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;values&nbsp;are&nbsp;derived&nbsp;from&nbsp;section&nbsp;K.1&nbsp;after&nbsp;converting&nbsp;from&nbsp;natural&nbsp;to</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;zig-zag&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">unscaledQuant</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="ident">nQuantIndex</span><span class="op">]</span><span class="op">[</span><span class="ident">blockSize</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Luminance.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">16</span><span class="op">,</span>&nbsp;<span class="num">11</span><span class="op">,</span>&nbsp;<span class="num">12</span><span class="op">,</span>&nbsp;<span class="num">14</span><span class="op">,</span>&nbsp;<span class="num">12</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">,</span>&nbsp;<span class="num">16</span><span class="op">,</span>&nbsp;<span class="num">14</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">13</span><span class="op">,</span>&nbsp;<span class="num">14</span><span class="op">,</span>&nbsp;<span class="num">18</span><span class="op">,</span>&nbsp;<span class="num">17</span><span class="op">,</span>&nbsp;<span class="num">16</span><span class="op">,</span>&nbsp;<span class="num">19</span><span class="op">,</span>&nbsp;<span class="num">24</span><span class="op">,</span>&nbsp;<span class="num">40</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">26</span><span class="op">,</span>&nbsp;<span class="num">24</span><span class="op">,</span>&nbsp;<span class="num">22</span><span class="op">,</span>&nbsp;<span class="num">22</span><span class="op">,</span>&nbsp;<span class="num">24</span><span class="op">,</span>&nbsp;<span class="num">49</span><span class="op">,</span>&nbsp;<span class="num">35</span><span class="op">,</span>&nbsp;<span class="num">37</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">29</span><span class="op">,</span>&nbsp;<span class="num">40</span><span class="op">,</span>&nbsp;<span class="num">58</span><span class="op">,</span>&nbsp;<span class="num">51</span><span class="op">,</span>&nbsp;<span class="num">61</span><span class="op">,</span>&nbsp;<span class="num">60</span><span class="op">,</span>&nbsp;<span class="num">57</span><span class="op">,</span>&nbsp;<span class="num">51</span><span class="op">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">56</span><span class="op">,</span>&nbsp;<span class="num">55</span><span class="op">,</span>&nbsp;<span class="num">64</span><span class="op">,</span>&nbsp;<span class="num">72</span><span class="op">,</span>&nbsp;<span class="num">92</span><span class="op">,</span>&nbsp;<span class="num">78</span><span class="op">,</span>&nbsp;<span class="num">64</span><span class="op">,</span>&nbsp;<span class="num">68</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">87</span><span class="op">,</span>&nbsp;<span class="num">69</span><span class="op">,</span>&nbsp;<span class="num">55</span><span class="op">,</span>&nbsp;<span class="num">56</span><span class="op">,</span>&nbsp;<span class="num">80</span><span class="op">,</span>&nbsp;<span class="num">109</span><span class="op">,</span>&nbsp;<span class="num">81</span><span class="op">,</span>&nbsp;<span class="num">87</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">95</span><span class="op">,</span>&nbsp;<span class="num">98</span><span class="op">,</span>&nbsp;<span class="num">103</span><span class="op">,</span>&nbsp;<span class="num">104</span><span class="op">,</span>&nbsp;<span class="num">103</span><span class="op">,</span>&nbsp;<span class="num">62</span><span class="op">,</span>&nbsp;<span class="num">77</span><span class="op">,</span>&nbsp;<span class="num">113</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">121</span><span class="op">,</span>&nbsp;<span class="num">112</span><span class="op">,</span>&nbsp;<span class="num">100</span><span class="op">,</span>&nbsp;<span class="num">120</span><span class="op">,</span>&nbsp;<span class="num">92</span><span class="op">,</span>&nbsp;<span class="num">101</span><span class="op">,</span>&nbsp;<span class="num">103</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Chrominance.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">17</span><span class="op">,</span>&nbsp;<span class="num">18</span><span class="op">,</span>&nbsp;<span class="num">18</span><span class="op">,</span>&nbsp;<span class="num">24</span><span class="op">,</span>&nbsp;<span class="num">21</span><span class="op">,</span>&nbsp;<span class="num">24</span><span class="op">,</span>&nbsp;<span class="num">47</span><span class="op">,</span>&nbsp;<span class="num">26</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">26</span><span class="op">,</span>&nbsp;<span class="num">47</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">66</span><span class="op">,</span>&nbsp;<span class="num">56</span><span class="op">,</span>&nbsp;<span class="num">66</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span>&nbsp;<span class="num">99</span><span class="op">,</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">huffIndex</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">huffIndexLuminanceDC</span>&nbsp;<span class="ident">huffIndex</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">huffIndexLuminanceAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">huffIndexChrominanceDC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">huffIndexChrominanceAC</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nHuffIndex</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;huffmanSpec&nbsp;specifies&nbsp;a&nbsp;Huffman&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">huffmanSpec</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;count[i]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;of&nbsp;length&nbsp;i&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">count</span>&nbsp;<span class="op">[</span><span class="num">16</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;value[i]&nbsp;is&nbsp;the&nbsp;decoded&nbsp;value&nbsp;of&nbsp;the&nbsp;i&#39;th&nbsp;codeword.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;theHuffmanSpec&nbsp;is&nbsp;the&nbsp;Huffman&nbsp;encoding&nbsp;specifications.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;This&nbsp;encoder&nbsp;uses&nbsp;the&nbsp;same&nbsp;Huffman&nbsp;encoding&nbsp;for&nbsp;all&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">theHuffmanSpec</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="ident">nHuffIndex</span><span class="op">]</span><span class="ident">huffmanSpec</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Luminance&nbsp;DC.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">[</span><span class="num">16</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">9</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">,</span>&nbsp;<span class="num">11</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Luminance&nbsp;AC.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">[</span><span class="num">16</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">125</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x01</span><span class="op">,</span>&nbsp;<span class="num">0x02</span><span class="op">,</span>&nbsp;<span class="num">0x03</span><span class="op">,</span>&nbsp;<span class="num">0x00</span><span class="op">,</span>&nbsp;<span class="num">0x04</span><span class="op">,</span>&nbsp;<span class="num">0x11</span><span class="op">,</span>&nbsp;<span class="num">0x05</span><span class="op">,</span>&nbsp;<span class="num">0x12</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x21</span><span class="op">,</span>&nbsp;<span class="num">0x31</span><span class="op">,</span>&nbsp;<span class="num">0x41</span><span class="op">,</span>&nbsp;<span class="num">0x06</span><span class="op">,</span>&nbsp;<span class="num">0x13</span><span class="op">,</span>&nbsp;<span class="num">0x51</span><span class="op">,</span>&nbsp;<span class="num">0x61</span><span class="op">,</span>&nbsp;<span class="num">0x07</span><span class="op">,</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x22</span><span class="op">,</span>&nbsp;<span class="num">0x71</span><span class="op">,</span>&nbsp;<span class="num">0x14</span><span class="op">,</span>&nbsp;<span class="num">0x32</span><span class="op">,</span>&nbsp;<span class="num">0x81</span><span class="op">,</span>&nbsp;<span class="num">0x91</span><span class="op">,</span>&nbsp;<span class="num">0xa1</span><span class="op">,</span>&nbsp;<span class="num">0x08</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x23</span><span class="op">,</span>&nbsp;<span class="num">0x42</span><span class="op">,</span>&nbsp;<span class="num">0xb1</span><span class="op">,</span>&nbsp;<span class="num">0xc1</span><span class="op">,</span>&nbsp;<span class="num">0x15</span><span class="op">,</span>&nbsp;<span class="num">0x52</span><span class="op">,</span>&nbsp;<span class="num">0xd1</span><span class="op">,</span>&nbsp;<span class="num">0xf0</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x24</span><span class="op">,</span>&nbsp;<span class="num">0x33</span><span class="op">,</span>&nbsp;<span class="num">0x62</span><span class="op">,</span>&nbsp;<span class="num">0x72</span><span class="op">,</span>&nbsp;<span class="num">0x82</span><span class="op">,</span>&nbsp;<span class="num">0x09</span><span class="op">,</span>&nbsp;<span class="num">0x0a</span><span class="op">,</span>&nbsp;<span class="num">0x16</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x17</span><span class="op">,</span>&nbsp;<span class="num">0x18</span><span class="op">,</span>&nbsp;<span class="num">0x19</span><span class="op">,</span>&nbsp;<span class="num">0x1a</span><span class="op">,</span>&nbsp;<span class="num">0x25</span><span class="op">,</span>&nbsp;<span class="num">0x26</span><span class="op">,</span>&nbsp;<span class="num">0x27</span><span class="op">,</span>&nbsp;<span class="num">0x28</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x29</span><span class="op">,</span>&nbsp;<span class="num">0x2a</span><span class="op">,</span>&nbsp;<span class="num">0x34</span><span class="op">,</span>&nbsp;<span class="num">0x35</span><span class="op">,</span>&nbsp;<span class="num">0x36</span><span class="op">,</span>&nbsp;<span class="num">0x37</span><span class="op">,</span>&nbsp;<span class="num">0x38</span><span class="op">,</span>&nbsp;<span class="num">0x39</span><span class="op">,</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x3a</span><span class="op">,</span>&nbsp;<span class="num">0x43</span><span class="op">,</span>&nbsp;<span class="num">0x44</span><span class="op">,</span>&nbsp;<span class="num">0x45</span><span class="op">,</span>&nbsp;<span class="num">0x46</span><span class="op">,</span>&nbsp;<span class="num">0x47</span><span class="op">,</span>&nbsp;<span class="num">0x48</span><span class="op">,</span>&nbsp;<span class="num">0x49</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x4a</span><span class="op">,</span>&nbsp;<span class="num">0x53</span><span class="op">,</span>&nbsp;<span class="num">0x54</span><span class="op">,</span>&nbsp;<span class="num">0x55</span><span class="op">,</span>&nbsp;<span class="num">0x56</span><span class="op">,</span>&nbsp;<span class="num">0x57</span><span class="op">,</span>&nbsp;<span class="num">0x58</span><span class="op">,</span>&nbsp;<span class="num">0x59</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x5a</span><span class="op">,</span>&nbsp;<span class="num">0x63</span><span class="op">,</span>&nbsp;<span class="num">0x64</span><span class="op">,</span>&nbsp;<span class="num">0x65</span><span class="op">,</span>&nbsp;<span class="num">0x66</span><span class="op">,</span>&nbsp;<span class="num">0x67</span><span class="op">,</span>&nbsp;<span class="num">0x68</span><span class="op">,</span>&nbsp;<span class="num">0x69</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x6a</span><span class="op">,</span>&nbsp;<span class="num">0x73</span><span class="op">,</span>&nbsp;<span class="num">0x74</span><span class="op">,</span>&nbsp;<span class="num">0x75</span><span class="op">,</span>&nbsp;<span class="num">0x76</span><span class="op">,</span>&nbsp;<span class="num">0x77</span><span class="op">,</span>&nbsp;<span class="num">0x78</span><span class="op">,</span>&nbsp;<span class="num">0x79</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x7a</span><span class="op">,</span>&nbsp;<span class="num">0x83</span><span class="op">,</span>&nbsp;<span class="num">0x84</span><span class="op">,</span>&nbsp;<span class="num">0x85</span><span class="op">,</span>&nbsp;<span class="num">0x86</span><span class="op">,</span>&nbsp;<span class="num">0x87</span><span class="op">,</span>&nbsp;<span class="num">0x88</span><span class="op">,</span>&nbsp;<span class="num">0x89</span><span class="op">,</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x8a</span><span class="op">,</span>&nbsp;<span class="num">0x92</span><span class="op">,</span>&nbsp;<span class="num">0x93</span><span class="op">,</span>&nbsp;<span class="num">0x94</span><span class="op">,</span>&nbsp;<span class="num">0x95</span><span class="op">,</span>&nbsp;<span class="num">0x96</span><span class="op">,</span>&nbsp;<span class="num">0x97</span><span class="op">,</span>&nbsp;<span class="num">0x98</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x99</span><span class="op">,</span>&nbsp;<span class="num">0x9a</span><span class="op">,</span>&nbsp;<span class="num">0xa2</span><span class="op">,</span>&nbsp;<span class="num">0xa3</span><span class="op">,</span>&nbsp;<span class="num">0xa4</span><span class="op">,</span>&nbsp;<span class="num">0xa5</span><span class="op">,</span>&nbsp;<span class="num">0xa6</span><span class="op">,</span>&nbsp;<span class="num">0xa7</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xa8</span><span class="op">,</span>&nbsp;<span class="num">0xa9</span><span class="op">,</span>&nbsp;<span class="num">0xaa</span><span class="op">,</span>&nbsp;<span class="num">0xb2</span><span class="op">,</span>&nbsp;<span class="num">0xb3</span><span class="op">,</span>&nbsp;<span class="num">0xb4</span><span class="op">,</span>&nbsp;<span class="num">0xb5</span><span class="op">,</span>&nbsp;<span class="num">0xb6</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xb7</span><span class="op">,</span>&nbsp;<span class="num">0xb8</span><span class="op">,</span>&nbsp;<span class="num">0xb9</span><span class="op">,</span>&nbsp;<span class="num">0xba</span><span class="op">,</span>&nbsp;<span class="num">0xc2</span><span class="op">,</span>&nbsp;<span class="num">0xc3</span><span class="op">,</span>&nbsp;<span class="num">0xc4</span><span class="op">,</span>&nbsp;<span class="num">0xc5</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xc6</span><span class="op">,</span>&nbsp;<span class="num">0xc7</span><span class="op">,</span>&nbsp;<span class="num">0xc8</span><span class="op">,</span>&nbsp;<span class="num">0xc9</span><span class="op">,</span>&nbsp;<span class="num">0xca</span><span class="op">,</span>&nbsp;<span class="num">0xd2</span><span class="op">,</span>&nbsp;<span class="num">0xd3</span><span class="op">,</span>&nbsp;<span class="num">0xd4</span><span class="op">,</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xd5</span><span class="op">,</span>&nbsp;<span class="num">0xd6</span><span class="op">,</span>&nbsp;<span class="num">0xd7</span><span class="op">,</span>&nbsp;<span class="num">0xd8</span><span class="op">,</span>&nbsp;<span class="num">0xd9</span><span class="op">,</span>&nbsp;<span class="num">0xda</span><span class="op">,</span>&nbsp;<span class="num">0xe1</span><span class="op">,</span>&nbsp;<span class="num">0xe2</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xe3</span><span class="op">,</span>&nbsp;<span class="num">0xe4</span><span class="op">,</span>&nbsp;<span class="num">0xe5</span><span class="op">,</span>&nbsp;<span class="num">0xe6</span><span class="op">,</span>&nbsp;<span class="num">0xe7</span><span class="op">,</span>&nbsp;<span class="num">0xe8</span><span class="op">,</span>&nbsp;<span class="num">0xe9</span><span class="op">,</span>&nbsp;<span class="num">0xea</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xf1</span><span class="op">,</span>&nbsp;<span class="num">0xf2</span><span class="op">,</span>&nbsp;<span class="num">0xf3</span><span class="op">,</span>&nbsp;<span class="num">0xf4</span><span class="op">,</span>&nbsp;<span class="num">0xf5</span><span class="op">,</span>&nbsp;<span class="num">0xf6</span><span class="op">,</span>&nbsp;<span class="num">0xf7</span><span class="op">,</span>&nbsp;<span class="num">0xf8</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xf9</span><span class="op">,</span>&nbsp;<span class="num">0xfa</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Chrominance&nbsp;DC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">[</span><span class="num">16</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">,</span>&nbsp;<span class="num">9</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">,</span>&nbsp;<span class="num">11</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Chrominance&nbsp;AC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">[</span><span class="num">16</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="num">119</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x00</span><span class="op">,</span>&nbsp;<span class="num">0x01</span><span class="op">,</span>&nbsp;<span class="num">0x02</span><span class="op">,</span>&nbsp;<span class="num">0x03</span><span class="op">,</span>&nbsp;<span class="num">0x11</span><span class="op">,</span>&nbsp;<span class="num">0x04</span><span class="op">,</span>&nbsp;<span class="num">0x05</span><span class="op">,</span>&nbsp;<span class="num">0x21</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x31</span><span class="op">,</span>&nbsp;<span class="num">0x06</span><span class="op">,</span>&nbsp;<span class="num">0x12</span><span class="op">,</span>&nbsp;<span class="num">0x41</span><span class="op">,</span>&nbsp;<span class="num">0x51</span><span class="op">,</span>&nbsp;<span class="num">0x07</span><span class="op">,</span>&nbsp;<span class="num">0x61</span><span class="op">,</span>&nbsp;<span class="num">0x71</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x13</span><span class="op">,</span>&nbsp;<span class="num">0x22</span><span class="op">,</span>&nbsp;<span class="num">0x32</span><span class="op">,</span>&nbsp;<span class="num">0x81</span><span class="op">,</span>&nbsp;<span class="num">0x08</span><span class="op">,</span>&nbsp;<span class="num">0x14</span><span class="op">,</span>&nbsp;<span class="num">0x42</span><span class="op">,</span>&nbsp;<span class="num">0x91</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xa1</span><span class="op">,</span>&nbsp;<span class="num">0xb1</span><span class="op">,</span>&nbsp;<span class="num">0xc1</span><span class="op">,</span>&nbsp;<span class="num">0x09</span><span class="op">,</span>&nbsp;<span class="num">0x23</span><span class="op">,</span>&nbsp;<span class="num">0x33</span><span class="op">,</span>&nbsp;<span class="num">0x52</span><span class="op">,</span>&nbsp;<span class="num">0xf0</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x15</span><span class="op">,</span>&nbsp;<span class="num">0x62</span><span class="op">,</span>&nbsp;<span class="num">0x72</span><span class="op">,</span>&nbsp;<span class="num">0xd1</span><span class="op">,</span>&nbsp;<span class="num">0x0a</span><span class="op">,</span>&nbsp;<span class="num">0x16</span><span class="op">,</span>&nbsp;<span class="num">0x24</span><span class="op">,</span>&nbsp;<span class="num">0x34</span><span class="op">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xe1</span><span class="op">,</span>&nbsp;<span class="num">0x25</span><span class="op">,</span>&nbsp;<span class="num">0xf1</span><span class="op">,</span>&nbsp;<span class="num">0x17</span><span class="op">,</span>&nbsp;<span class="num">0x18</span><span class="op">,</span>&nbsp;<span class="num">0x19</span><span class="op">,</span>&nbsp;<span class="num">0x1a</span><span class="op">,</span>&nbsp;<span class="num">0x26</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x27</span><span class="op">,</span>&nbsp;<span class="num">0x28</span><span class="op">,</span>&nbsp;<span class="num">0x29</span><span class="op">,</span>&nbsp;<span class="num">0x2a</span><span class="op">,</span>&nbsp;<span class="num">0x35</span><span class="op">,</span>&nbsp;<span class="num">0x36</span><span class="op">,</span>&nbsp;<span class="num">0x37</span><span class="op">,</span>&nbsp;<span class="num">0x38</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x39</span><span class="op">,</span>&nbsp;<span class="num">0x3a</span><span class="op">,</span>&nbsp;<span class="num">0x43</span><span class="op">,</span>&nbsp;<span class="num">0x44</span><span class="op">,</span>&nbsp;<span class="num">0x45</span><span class="op">,</span>&nbsp;<span class="num">0x46</span><span class="op">,</span>&nbsp;<span class="num">0x47</span><span class="op">,</span>&nbsp;<span class="num">0x48</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x49</span><span class="op">,</span>&nbsp;<span class="num">0x4a</span><span class="op">,</span>&nbsp;<span class="num">0x53</span><span class="op">,</span>&nbsp;<span class="num">0x54</span><span class="op">,</span>&nbsp;<span class="num">0x55</span><span class="op">,</span>&nbsp;<span class="num">0x56</span><span class="op">,</span>&nbsp;<span class="num">0x57</span><span class="op">,</span>&nbsp;<span class="num">0x58</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x59</span><span class="op">,</span>&nbsp;<span class="num">0x5a</span><span class="op">,</span>&nbsp;<span class="num">0x63</span><span class="op">,</span>&nbsp;<span class="num">0x64</span><span class="op">,</span>&nbsp;<span class="num">0x65</span><span class="op">,</span>&nbsp;<span class="num">0x66</span><span class="op">,</span>&nbsp;<span class="num">0x67</span><span class="op">,</span>&nbsp;<span class="num">0x68</span><span class="op">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x69</span><span class="op">,</span>&nbsp;<span class="num">0x6a</span><span class="op">,</span>&nbsp;<span class="num">0x73</span><span class="op">,</span>&nbsp;<span class="num">0x74</span><span class="op">,</span>&nbsp;<span class="num">0x75</span><span class="op">,</span>&nbsp;<span class="num">0x76</span><span class="op">,</span>&nbsp;<span class="num">0x77</span><span class="op">,</span>&nbsp;<span class="num">0x78</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x79</span><span class="op">,</span>&nbsp;<span class="num">0x7a</span><span class="op">,</span>&nbsp;<span class="num">0x82</span><span class="op">,</span>&nbsp;<span class="num">0x83</span><span class="op">,</span>&nbsp;<span class="num">0x84</span><span class="op">,</span>&nbsp;<span class="num">0x85</span><span class="op">,</span>&nbsp;<span class="num">0x86</span><span class="op">,</span>&nbsp;<span class="num">0x87</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x88</span><span class="op">,</span>&nbsp;<span class="num">0x89</span><span class="op">,</span>&nbsp;<span class="num">0x8a</span><span class="op">,</span>&nbsp;<span class="num">0x92</span><span class="op">,</span>&nbsp;<span class="num">0x93</span><span class="op">,</span>&nbsp;<span class="num">0x94</span><span class="op">,</span>&nbsp;<span class="num">0x95</span><span class="op">,</span>&nbsp;<span class="num">0x96</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x97</span><span class="op">,</span>&nbsp;<span class="num">0x98</span><span class="op">,</span>&nbsp;<span class="num">0x99</span><span class="op">,</span>&nbsp;<span class="num">0x9a</span><span class="op">,</span>&nbsp;<span class="num">0xa2</span><span class="op">,</span>&nbsp;<span class="num">0xa3</span><span class="op">,</span>&nbsp;<span class="num">0xa4</span><span class="op">,</span>&nbsp;<span class="num">0xa5</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xa6</span><span class="op">,</span>&nbsp;<span class="num">0xa7</span><span class="op">,</span>&nbsp;<span class="num">0xa8</span><span class="op">,</span>&nbsp;<span class="num">0xa9</span><span class="op">,</span>&nbsp;<span class="num">0xaa</span><span class="op">,</span>&nbsp;<span class="num">0xb2</span><span class="op">,</span>&nbsp;<span class="num">0xb3</span><span class="op">,</span>&nbsp;<span class="num">0xb4</span><span class="op">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xb5</span><span class="op">,</span>&nbsp;<span class="num">0xb6</span><span class="op">,</span>&nbsp;<span class="num">0xb7</span><span class="op">,</span>&nbsp;<span class="num">0xb8</span><span class="op">,</span>&nbsp;<span class="num">0xb9</span><span class="op">,</span>&nbsp;<span class="num">0xba</span><span class="op">,</span>&nbsp;<span class="num">0xc2</span><span class="op">,</span>&nbsp;<span class="num">0xc3</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xc4</span><span class="op">,</span>&nbsp;<span class="num">0xc5</span><span class="op">,</span>&nbsp;<span class="num">0xc6</span><span class="op">,</span>&nbsp;<span class="num">0xc7</span><span class="op">,</span>&nbsp;<span class="num">0xc8</span><span class="op">,</span>&nbsp;<span class="num">0xc9</span><span class="op">,</span>&nbsp;<span class="num">0xca</span><span class="op">,</span>&nbsp;<span class="num">0xd2</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xd3</span><span class="op">,</span>&nbsp;<span class="num">0xd4</span><span class="op">,</span>&nbsp;<span class="num">0xd5</span><span class="op">,</span>&nbsp;<span class="num">0xd6</span><span class="op">,</span>&nbsp;<span class="num">0xd7</span><span class="op">,</span>&nbsp;<span class="num">0xd8</span><span class="op">,</span>&nbsp;<span class="num">0xd9</span><span class="op">,</span>&nbsp;<span class="num">0xda</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xe2</span><span class="op">,</span>&nbsp;<span class="num">0xe3</span><span class="op">,</span>&nbsp;<span class="num">0xe4</span><span class="op">,</span>&nbsp;<span class="num">0xe5</span><span class="op">,</span>&nbsp;<span class="num">0xe6</span><span class="op">,</span>&nbsp;<span class="num">0xe7</span><span class="op">,</span>&nbsp;<span class="num">0xe8</span><span class="op">,</span>&nbsp;<span class="num">0xe9</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xea</span><span class="op">,</span>&nbsp;<span class="num">0xf2</span><span class="op">,</span>&nbsp;<span class="num">0xf3</span><span class="op">,</span>&nbsp;<span class="num">0xf4</span><span class="op">,</span>&nbsp;<span class="num">0xf5</span><span class="op">,</span>&nbsp;<span class="num">0xf6</span><span class="op">,</span>&nbsp;<span class="num">0xf7</span><span class="op">,</span>&nbsp;<span class="num">0xf8</span><span class="op">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xf9</span><span class="op">,</span>&nbsp;<span class="num">0xfa</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment">//&nbsp;huffmanLUT&nbsp;is&nbsp;a&nbsp;compiled&nbsp;look-up&nbsp;table&nbsp;representation&nbsp;of&nbsp;a&nbsp;huffmanSpec.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Each&nbsp;value&nbsp;maps&nbsp;to&nbsp;a&nbsp;uint32&nbsp;of&nbsp;which&nbsp;the&nbsp;8&nbsp;most&nbsp;significant&nbsp;bits&nbsp;hold&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;codeword&nbsp;size&nbsp;in&nbsp;bits&nbsp;and&nbsp;the&nbsp;24&nbsp;least&nbsp;significant&nbsp;bits&nbsp;hold&nbsp;the&nbsp;codeword.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;maximum&nbsp;codeword&nbsp;size&nbsp;is&nbsp;16&nbsp;bits.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">huffmanLUT</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">h</span>&nbsp;<span class="op">*</span><span class="ident">huffmanLUT</span><span class="op">)</span>&nbsp;<span class="ident">init</span><span class="op">(</span><span class="ident">s</span>&nbsp;<span class="ident">huffmanSpec</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">maxValue</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">value</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">maxValue</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">maxValue</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">h</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">,</span>&nbsp;<span class="ident">maxValue</span><span class="op">+</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span><span class="op">,</span>&nbsp;<span class="ident">k</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">.</span><span class="ident">count</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nBits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">i</span><span class="op">+</span><span class="num">1</span><span class="op">)</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">count</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">(</span><span class="op">*</span><span class="ident">h</span><span class="op">)</span><span class="op">[</span><span class="ident">s</span><span class="op">.</span><span class="ident">value</span><span class="op">[</span><span class="ident">k</span><span class="op">]</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nBits</span>&nbsp;<span class="op">|</span>&nbsp;<span class="ident">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span><span class="op">++</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span>&nbsp;<span class="op">&lt;&lt;=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;theHuffmanLUT&nbsp;are&nbsp;compiled&nbsp;representations&nbsp;of&nbsp;theHuffmanSpec.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">theHuffmanLUT</span>&nbsp;<span class="op">[</span><span class="num">4</span><span class="op">]</span><span class="ident">huffmanLUT</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">init</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">theHuffmanSpec</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">theHuffmanLUT</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">init</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment">//&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">writer</span>&nbsp;<span class="keyword">interface</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Flush</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">io</span><span class="op">.</span><span class="ident">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">io</span><span class="op">.</span><span class="ident">ByteWriter</span><br>
<span class="lineno">215</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encoder&nbsp;encodes&nbsp;an&nbsp;image&nbsp;to&nbsp;the&nbsp;JPEG&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">encoder</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;to&nbsp;write&nbsp;to.&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;writing.&nbsp;All&nbsp;attempted&nbsp;writes&nbsp;after&nbsp;the&nbsp;first&nbsp;error&nbsp;become&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">w</span>&nbsp;&nbsp;&nbsp;<span class="ident">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;buf&nbsp;is&nbsp;a&nbsp;scratch&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="num">16</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;bits&nbsp;and&nbsp;nBits&nbsp;are&nbsp;accumulated&nbsp;bits&nbsp;to&nbsp;write&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span><span class="op">,</span>&nbsp;<span class="ident">nBits</span>&nbsp;<span class="builtintype">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;quant&nbsp;is&nbsp;the&nbsp;scaled&nbsp;quantization&nbsp;tables,&nbsp;in&nbsp;zig-zag&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">quant</span>&nbsp;<span class="op">[</span><span class="ident">nQuantIndex</span><span class="op">]</span><span class="op">[</span><span class="ident">blockSize</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encoder</span><span class="op">)</span>&nbsp;<span class="ident">flush</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">w</span><span class="op">.</span><span class="ident">Flush</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encoder</span><span class="op">)</span>&nbsp;<span class="ident">write</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">w</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encoder</span><span class="op">)</span>&nbsp;<span class="ident">writeByte</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">w</span><span class="op">.</span><span class="ident">WriteByte</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno">250</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;emit&nbsp;emits&nbsp;the&nbsp;least&nbsp;significant&nbsp;nBits&nbsp;bits&nbsp;of&nbsp;bits&nbsp;to&nbsp;the&nbsp;bit-stream.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;precondition&nbsp;is&nbsp;bits&nbsp;&lt;&nbsp;1&lt;&lt;nBits&nbsp;&amp;&amp;&nbsp;nBits&nbsp;&lt;=&nbsp;16.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encoder</span><span class="op">)</span>&nbsp;<span class="ident">emit</span><span class="op">(</span><span class="ident">bits</span><span class="op">,</span>&nbsp;<span class="ident">nBits</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nBits</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">&lt;&lt;=</span>&nbsp;<span class="num">32</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">nBits</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">8</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">bits</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">24</span><span class="op">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">writeByte</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0xff</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">writeByte</span><span class="op">(</span><span class="num">0x00</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">&lt;&lt;=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nBits</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">bits</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">nBits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bits</span><span class="op">,</span>&nbsp;<span class="ident">nBits</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment">//&nbsp;emitHuff&nbsp;emits&nbsp;the&nbsp;given&nbsp;value&nbsp;with&nbsp;the&nbsp;given&nbsp;Huffman&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encoder</span><span class="op">)</span>&nbsp;<span class="ident">emitHuff</span><span class="op">(</span><span class="ident">h</span>&nbsp;<span class="ident">huffIndex</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="builtintype">int32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">theHuffmanLUT</span><span class="op">[</span><span class="ident">h</span><span class="op">]</span><span class="op">[</span><span class="ident">value</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">emit</span><span class="op">(</span><span class="ident">x</span><span class="op">&amp;</span><span class="op">(</span><span class="num">1</span><span class="op">&lt;&lt;</span><span class="num">24</span><span class="op">-</span><span class="num">1</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">&gt;&gt;</span><span class="num">24</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;emitHuffRLE&nbsp;emits&nbsp;a&nbsp;run&nbsp;of&nbsp;runLength&nbsp;copies&nbsp;of&nbsp;value&nbsp;encoded&nbsp;with&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Huffman&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encoder</span><span class="op">)</span>&nbsp;<span class="ident">emitHuffRLE</span><span class="op">(</span><span class="ident">h</span>&nbsp;<span class="ident">huffIndex</span><span class="op">,</span>&nbsp;<span class="ident">runLength</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="builtintype">int32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">value</span><span class="op">,</span>&nbsp;<span class="ident">value</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">a</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="ident">value</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">-</span><span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">nBits</span>&nbsp;<span class="builtintype">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">a</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0x100</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nBits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">bitCount</span><span class="op">[</span><span class="ident">a</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nBits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">8</span>&nbsp;<span class="op">+</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">bitCount</span><span class="op">[</span><span class="ident">a</span><span class="op">&gt;&gt;</span><span class="num">8</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">emitHuff</span><span class="op">(</span><span class="ident">h</span><span class="op">,</span>&nbsp;<span class="ident">runLength</span><span class="op">&lt;&lt;</span><span class="num">4</span><span class="op">|</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">nBits</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nBits</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">emit</span><span class="op">(</span><span class="builtintype">uint32</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">&amp;</span><span class="op">(</span><span class="num">1</span><span class="op">&lt;&lt;</span><span class="ident">nBits</span><span class="op">-</span><span class="num">1</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nBits</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span><span class="comment">//&nbsp;writeMarkerHeader&nbsp;writes&nbsp;the&nbsp;header&nbsp;for&nbsp;a&nbsp;marker&nbsp;with&nbsp;the&nbsp;given&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encoder</span><span class="op">)</span>&nbsp;<span class="ident">writeMarkerHeader</span><span class="op">(</span><span class="ident">marker</span>&nbsp;<span class="builtintype">uint8</span><span class="op">,</span>&nbsp;<span class="ident">markerlen</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">marker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">2</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">markerlen</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">8</span><span class="op">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">3</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">markerlen</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">0xff</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">write</span><span class="op">(</span><span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="op">:</span><span class="num">4</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;writeDQT&nbsp;writes&nbsp;the&nbsp;Define&nbsp;Quantization&nbsp;Table&nbsp;marker.</span><br>
<span class="lineno">305</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encoder</span><span class="op">)</span>&nbsp;<span class="ident">writeDQT</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">markerlen</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">+</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">nQuantIndex</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="num">1</span><span class="op">+</span><span class="ident">blockSize</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">writeMarkerHeader</span><span class="op">(</span><span class="ident">dqtMarker</span><span class="op">,</span>&nbsp;<span class="ident">markerlen</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">quant</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">writeByte</span><span class="op">(</span><span class="builtintype">uint8</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">write</span><span class="op">(</span><span class="ident">e</span><span class="op">.</span><span class="ident">quant</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;writeSOF0&nbsp;writes&nbsp;the&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Baseline)&nbsp;marker.</span><br>
<span class="lineno">315</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encoder</span><span class="op">)</span>&nbsp;<span class="ident">writeSOF0</span><span class="op">(</span><span class="ident">size</span>&nbsp;<span class="ident">image</span><span class="op">.</span><span class="ident">Point</span><span class="op">,</span>&nbsp;<span class="ident">nComponent</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">markerlen</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">8</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">3</span><span class="op">*</span><span class="ident">nComponent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">writeMarkerHeader</span><span class="op">(</span><span class="ident">sof0Marker</span><span class="op">,</span>&nbsp;<span class="ident">markerlen</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">8</span>&nbsp;<span class="comment">//&nbsp;8-bit&nbsp;color.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">size</span><span class="op">.</span><span class="ident">Y</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">8</span><span class="op">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">2</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">size</span><span class="op">.</span><span class="ident">Y</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">0xff</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">3</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">size</span><span class="op">.</span><span class="ident">X</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">8</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">4</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">size</span><span class="op">.</span><span class="ident">X</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">0xff</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">5</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">nComponent</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nComponent</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">6</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;No&nbsp;subsampling&nbsp;for&nbsp;grayscale&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">7</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0x11</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">8</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">nComponent</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">3</span><span class="op">*</span><span class="ident">i</span><span class="op">+</span><span class="num">6</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;use&nbsp;4:2:0&nbsp;chroma&nbsp;subsampling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">3</span><span class="op">*</span><span class="ident">i</span><span class="op">+</span><span class="num">7</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;\x22\x11\x11&#34;</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">3</span><span class="op">*</span><span class="ident">i</span><span class="op">+</span><span class="num">8</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;\x00\x01\x01&#34;</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">write</span><span class="op">(</span><span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="op">:</span><span class="num">3</span><span class="op">*</span><span class="op">(</span><span class="ident">nComponent</span><span class="op">-</span><span class="num">1</span><span class="op">)</span><span class="op">+</span><span class="num">9</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment">//&nbsp;writeDHT&nbsp;writes&nbsp;the&nbsp;Define&nbsp;Huffman&nbsp;Table&nbsp;marker.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encoder</span><span class="op">)</span>&nbsp;<span class="ident">writeDHT</span><span class="op">(</span><span class="ident">nComponent</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">markerlen</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">specs</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">theHuffmanSpec</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nComponent</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Drop&nbsp;the&nbsp;Chrominance&nbsp;tables.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">specs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">specs</span><span class="op">[</span><span class="op">:</span><span class="num">2</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">specs</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">markerlen</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">16</span>&nbsp;<span class="op">+</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">.</span><span class="ident">value</span><span class="op">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">writeMarkerHeader</span><span class="op">(</span><span class="ident">dhtMarker</span><span class="op">,</span>&nbsp;<span class="ident">markerlen</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">specs</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">writeByte</span><span class="op">(</span><span class="string">&#34;\x00\x10\x01\x11&#34;</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">write</span><span class="op">(</span><span class="ident">s</span><span class="op">.</span><span class="ident">count</span><span class="op">[</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">write</span><span class="op">(</span><span class="ident">s</span><span class="op">.</span><span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;writeBlock&nbsp;writes&nbsp;a&nbsp;block&nbsp;of&nbsp;pixel&nbsp;data&nbsp;using&nbsp;the&nbsp;given&nbsp;quantization&nbsp;table,</span><br>
<span class="lineno">360</span><span class="comment">//&nbsp;returning&nbsp;the&nbsp;post-quantized&nbsp;DC&nbsp;value&nbsp;of&nbsp;the&nbsp;DCT-transformed&nbsp;block.&nbsp;b&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;natural&nbsp;(not&nbsp;zig-zag)&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encoder</span><span class="op">)</span>&nbsp;<span class="ident">writeBlock</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">block</span><span class="op">,</span>&nbsp;<span class="ident">q</span>&nbsp;<span class="ident">quantIndex</span><span class="op">,</span>&nbsp;<span class="ident">prevDC</span>&nbsp;<span class="builtintype">int32</span><span class="op">)</span>&nbsp;<span class="builtintype">int32</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fdct</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Emit&nbsp;the&nbsp;DC&nbsp;delta.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">div</span><span class="op">(</span><span class="ident">b</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">*</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">e</span><span class="op">.</span><span class="ident">quant</span><span class="op">[</span><span class="ident">q</span><span class="op">]</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">emitHuffRLE</span><span class="op">(</span><span class="ident">huffIndex</span><span class="op">(</span><span class="num">2</span><span class="op">*</span><span class="ident">q</span><span class="op">+</span><span class="num">0</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">dc</span><span class="op">-</span><span class="ident">prevDC</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Emit&nbsp;the&nbsp;AC&nbsp;components.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">,</span>&nbsp;<span class="ident">runLength</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">huffIndex</span><span class="op">(</span><span class="num">2</span><span class="op">*</span><span class="ident">q</span><span class="op">+</span><span class="num">1</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">zig</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">1</span><span class="op">;</span>&nbsp;<span class="ident">zig</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">blockSize</span><span class="op">;</span>&nbsp;<span class="ident">zig</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ac</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">div</span><span class="op">(</span><span class="ident">b</span><span class="op">[</span><span class="ident">unzig</span><span class="op">[</span><span class="ident">zig</span><span class="op">]</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">*</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">e</span><span class="op">.</span><span class="ident">quant</span><span class="op">[</span><span class="ident">q</span><span class="op">]</span><span class="op">[</span><span class="ident">zig</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ac</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runLength</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">runLength</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">15</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">emitHuff</span><span class="op">(</span><span class="ident">h</span><span class="op">,</span>&nbsp;<span class="num">0xf0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runLength</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="num">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">emitHuffRLE</span><span class="op">(</span><span class="ident">h</span><span class="op">,</span>&nbsp;<span class="ident">runLength</span><span class="op">,</span>&nbsp;<span class="ident">ac</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runLength</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">runLength</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">emitHuff</span><span class="op">(</span><span class="ident">h</span><span class="op">,</span>&nbsp;<span class="num">0x00</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">dc</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;toYCbCr&nbsp;converts&nbsp;the&nbsp;8x8&nbsp;region&nbsp;of&nbsp;m&nbsp;whose&nbsp;top-left&nbsp;corner&nbsp;is&nbsp;p&nbsp;to&nbsp;its</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;YCbCr&nbsp;values.</span><br>
<span class="lineno">390</span><span class="keyword">func</span>&nbsp;<span class="ident">toYCbCr</span><span class="op">(</span><span class="ident">m</span>&nbsp;<span class="ident">image</span><span class="op">.</span><span class="ident">Image</span><span class="op">,</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="ident">image</span><span class="op">.</span><span class="ident">Point</span><span class="op">,</span>&nbsp;<span class="ident">yBlock</span><span class="op">,</span>&nbsp;<span class="ident">cbBlock</span><span class="op">,</span>&nbsp;<span class="ident">crBlock</span>&nbsp;<span class="op">*</span><span class="ident">block</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">Bounds</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xmax</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Max</span><span class="op">.</span><span class="ident">X</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ymax</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Max</span><span class="op">.</span><span class="ident">Y</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">8</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">8</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">g</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">At</span><span class="op">(</span><span class="ident">min</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">X</span><span class="op">+</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">xmax</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">min</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Y</span><span class="op">+</span><span class="ident">j</span><span class="op">,</span>&nbsp;<span class="ident">ymax</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">RGBA</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">yy</span><span class="op">,</span>&nbsp;<span class="ident">cb</span><span class="op">,</span>&nbsp;<span class="ident">cr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">color</span><span class="op">.</span><span class="ident">RGBToYCbCr</span><span class="op">(</span><span class="builtintype">uint8</span><span class="op">(</span><span class="ident">r</span><span class="op">&gt;&gt;</span><span class="num">8</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">g</span><span class="op">&gt;&gt;</span><span class="num">8</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">b</span><span class="op">&gt;&gt;</span><span class="num">8</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">yBlock</span><span class="op">[</span><span class="num">8</span><span class="op">*</span><span class="ident">j</span><span class="op">+</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="ident">yy</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cbBlock</span><span class="op">[</span><span class="num">8</span><span class="op">*</span><span class="ident">j</span><span class="op">+</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="ident">cb</span><span class="op">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">crBlock</span><span class="op">[</span><span class="num">8</span><span class="op">*</span><span class="ident">j</span><span class="op">+</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="ident">cr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="comment">//&nbsp;grayToY&nbsp;stores&nbsp;the&nbsp;8x8&nbsp;region&nbsp;of&nbsp;m&nbsp;whose&nbsp;top-left&nbsp;corner&nbsp;is&nbsp;p&nbsp;in&nbsp;yBlock.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">grayToY</span><span class="op">(</span><span class="ident">m</span>&nbsp;<span class="op">*</span><span class="ident">image</span><span class="op">.</span><span class="ident">Gray</span><span class="op">,</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="ident">image</span><span class="op">.</span><span class="ident">Point</span><span class="op">,</span>&nbsp;<span class="ident">yBlock</span>&nbsp;<span class="op">*</span><span class="ident">block</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">Bounds</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xmax</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Max</span><span class="op">.</span><span class="ident">X</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ymax</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Max</span><span class="op">.</span><span class="ident">Y</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pix</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">8</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">8</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">idx</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">PixOffset</span><span class="op">(</span><span class="ident">min</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">X</span><span class="op">+</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">xmax</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">min</span><span class="op">(</span><span class="ident">p</span><span class="op">.</span><span class="ident">Y</span><span class="op">+</span><span class="ident">j</span><span class="op">,</span>&nbsp;<span class="ident">ymax</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">yBlock</span><span class="op">[</span><span class="num">8</span><span class="op">*</span><span class="ident">j</span><span class="op">+</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="ident">pix</span><span class="op">[</span><span class="ident">idx</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;rgbaToYCbCr&nbsp;is&nbsp;a&nbsp;specialized&nbsp;version&nbsp;of&nbsp;toYCbCr&nbsp;for&nbsp;image.RGBA&nbsp;images.</span><br>
<span class="lineno">420</span><span class="keyword">func</span>&nbsp;<span class="ident">rgbaToYCbCr</span><span class="op">(</span><span class="ident">m</span>&nbsp;<span class="op">*</span><span class="ident">image</span><span class="op">.</span><span class="ident">RGBA</span><span class="op">,</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="ident">image</span><span class="op">.</span><span class="ident">Point</span><span class="op">,</span>&nbsp;<span class="ident">yBlock</span><span class="op">,</span>&nbsp;<span class="ident">cbBlock</span><span class="op">,</span>&nbsp;<span class="ident">crBlock</span>&nbsp;<span class="op">*</span><span class="ident">block</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">Bounds</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xmax</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Max</span><span class="op">.</span><span class="ident">X</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ymax</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Max</span><span class="op">.</span><span class="ident">Y</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">8</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sj</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Y</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">sj</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">ymax</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sj</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ymax</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">offset</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="ident">sj</span><span class="op">-</span><span class="ident">b</span><span class="op">.</span><span class="ident">Min</span><span class="op">.</span><span class="ident">Y</span><span class="op">)</span><span class="op">*</span><span class="ident">m</span><span class="op">.</span><span class="ident">Stride</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Min</span><span class="op">.</span><span class="ident">X</span><span class="op">*</span><span class="num">4</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">8</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sx</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">X</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">sx</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">xmax</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sx</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">xmax</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pix</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">Pix</span><span class="op">[</span><span class="ident">offset</span><span class="op">+</span><span class="ident">sx</span><span class="op">*</span><span class="num">4</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">yy</span><span class="op">,</span>&nbsp;<span class="ident">cb</span><span class="op">,</span>&nbsp;<span class="ident">cr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">color</span><span class="op">.</span><span class="ident">RGBToYCbCr</span><span class="op">(</span><span class="ident">pix</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">pix</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">pix</span><span class="op">[</span><span class="num">2</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">yBlock</span><span class="op">[</span><span class="num">8</span><span class="op">*</span><span class="ident">j</span><span class="op">+</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="ident">yy</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cbBlock</span><span class="op">[</span><span class="num">8</span><span class="op">*</span><span class="ident">j</span><span class="op">+</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="ident">cb</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">crBlock</span><span class="op">[</span><span class="num">8</span><span class="op">*</span><span class="ident">j</span><span class="op">+</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="ident">cr</span><span class="op">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;scale&nbsp;scales&nbsp;the&nbsp;16x16&nbsp;region&nbsp;represented&nbsp;by&nbsp;the&nbsp;4&nbsp;src&nbsp;blocks&nbsp;to&nbsp;the&nbsp;8x8</span><br>
<span class="lineno">445</span><span class="comment">//&nbsp;dst&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">scale</span><span class="op">(</span><span class="ident">dst</span>&nbsp;<span class="op">*</span><span class="ident">block</span><span class="op">,</span>&nbsp;<span class="ident">src</span>&nbsp;<span class="op">*</span><span class="op">[</span><span class="num">4</span><span class="op">]</span><span class="ident">block</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">4</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dstOff</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="ident">i</span><span class="op">&amp;</span><span class="num">2</span><span class="op">)</span><span class="op">&lt;&lt;</span><span class="num">4</span>&nbsp;<span class="op">|</span>&nbsp;<span class="op">(</span><span class="ident">i</span><span class="op">&amp;</span><span class="num">1</span><span class="op">)</span><span class="op">&lt;&lt;</span><span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">4</span><span class="op">;</span>&nbsp;<span class="ident">y</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">4</span><span class="op">;</span>&nbsp;<span class="ident">x</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">16</span><span class="op">*</span><span class="ident">y</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">2</span><span class="op">*</span><span class="ident">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sum</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">src</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">src</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">[</span><span class="ident">j</span><span class="op">+</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">src</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">[</span><span class="ident">j</span><span class="op">+</span><span class="num">8</span><span class="op">]</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">src</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">[</span><span class="ident">j</span><span class="op">+</span><span class="num">9</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dst</span><span class="op">[</span><span class="num">8</span><span class="op">*</span><span class="ident">y</span><span class="op">+</span><span class="ident">x</span><span class="op">+</span><span class="ident">dstOff</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">(</span><span class="ident">sum</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">2</span><span class="op">)</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;sosHeaderY&nbsp;is&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;&#34;\xff\xda&#34;&nbsp;followed&nbsp;by&nbsp;8&nbsp;bytes:</span><br>
<span class="lineno">460</span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;marker&nbsp;length&nbsp;&#34;\x00\x08&#34;,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;number&nbsp;of&nbsp;components&nbsp;&#34;\x01&#34;,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;component&nbsp;1&nbsp;uses&nbsp;DC&nbsp;table&nbsp;0&nbsp;and&nbsp;AC&nbsp;table&nbsp;0&nbsp;&#34;\x01\x00&#34;,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;bytes&nbsp;&#34;\x00\x3f\x00&#34;.&nbsp;Section&nbsp;B.2.3&nbsp;of&nbsp;the&nbsp;spec&nbsp;says&nbsp;that&nbsp;for</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;sequential&nbsp;DCTs,&nbsp;those&nbsp;bytes&nbsp;(8-bit&nbsp;Ss,&nbsp;8-bit&nbsp;Se,&nbsp;4-bit&nbsp;Ah,&nbsp;4-bit&nbsp;Al)</span><br>
<span class="lineno">465</span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;should&nbsp;be&nbsp;0x00,&nbsp;0x3f,&nbsp;0x00&lt;&lt;4&nbsp;|&nbsp;0x00.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">sosHeaderY</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xff</span><span class="op">,</span>&nbsp;<span class="num">0xda</span><span class="op">,</span>&nbsp;<span class="num">0x00</span><span class="op">,</span>&nbsp;<span class="num">0x08</span><span class="op">,</span>&nbsp;<span class="num">0x01</span><span class="op">,</span>&nbsp;<span class="num">0x01</span><span class="op">,</span>&nbsp;<span class="num">0x00</span><span class="op">,</span>&nbsp;<span class="num">0x00</span><span class="op">,</span>&nbsp;<span class="num">0x3f</span><span class="op">,</span>&nbsp;<span class="num">0x00</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment">//&nbsp;sosHeaderYCbCr&nbsp;is&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;&#34;\xff\xda&#34;&nbsp;followed&nbsp;by&nbsp;12&nbsp;bytes:</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;marker&nbsp;length&nbsp;&#34;\x00\x0c&#34;,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;number&nbsp;of&nbsp;components&nbsp;&#34;\x03&#34;,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;component&nbsp;1&nbsp;uses&nbsp;DC&nbsp;table&nbsp;0&nbsp;and&nbsp;AC&nbsp;table&nbsp;0&nbsp;&#34;\x01\x00&#34;,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;component&nbsp;2&nbsp;uses&nbsp;DC&nbsp;table&nbsp;1&nbsp;and&nbsp;AC&nbsp;table&nbsp;1&nbsp;&#34;\x02\x11&#34;,</span><br>
<span class="lineno">475</span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;component&nbsp;3&nbsp;uses&nbsp;DC&nbsp;table&nbsp;1&nbsp;and&nbsp;AC&nbsp;table&nbsp;1&nbsp;&#34;\x03\x11&#34;,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;bytes&nbsp;&#34;\x00\x3f\x00&#34;.&nbsp;Section&nbsp;B.2.3&nbsp;of&nbsp;the&nbsp;spec&nbsp;says&nbsp;that&nbsp;for</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;sequential&nbsp;DCTs,&nbsp;those&nbsp;bytes&nbsp;(8-bit&nbsp;Ss,&nbsp;8-bit&nbsp;Se,&nbsp;4-bit&nbsp;Ah,&nbsp;4-bit&nbsp;Al)</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;should&nbsp;be&nbsp;0x00,&nbsp;0x3f,&nbsp;0x00&lt;&lt;4&nbsp;|&nbsp;0x00.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">sosHeaderYCbCr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0xff</span><span class="op">,</span>&nbsp;<span class="num">0xda</span><span class="op">,</span>&nbsp;<span class="num">0x00</span><span class="op">,</span>&nbsp;<span class="num">0x0c</span><span class="op">,</span>&nbsp;<span class="num">0x03</span><span class="op">,</span>&nbsp;<span class="num">0x01</span><span class="op">,</span>&nbsp;<span class="num">0x00</span><span class="op">,</span>&nbsp;<span class="num">0x02</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0x11</span><span class="op">,</span>&nbsp;<span class="num">0x03</span><span class="op">,</span>&nbsp;<span class="num">0x11</span><span class="op">,</span>&nbsp;<span class="num">0x00</span><span class="op">,</span>&nbsp;<span class="num">0x3f</span><span class="op">,</span>&nbsp;<span class="num">0x00</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;writeSOS&nbsp;writes&nbsp;the&nbsp;StartOfScan&nbsp;marker.</span><br>
<span class="lineno">485</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encoder</span><span class="op">)</span>&nbsp;<span class="ident">writeSOS</span><span class="op">(</span><span class="ident">m</span>&nbsp;<span class="ident">image</span><span class="op">.</span><span class="ident">Image</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="op">(</span><span class="keyword">type</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">image</span><span class="op">.</span><span class="ident">Gray</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">write</span><span class="op">(</span><span class="ident">sosHeaderY</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">write</span><span class="op">(</span><span class="ident">sosHeaderYCbCr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Scratch&nbsp;buffers&nbsp;to&nbsp;hold&nbsp;the&nbsp;YCbCr&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;blocks&nbsp;are&nbsp;in&nbsp;natural&nbsp;(not&nbsp;zig-zag)&nbsp;order.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cb</span><span class="op">,</span>&nbsp;<span class="ident">cr</span>&nbsp;<span class="op">[</span><span class="num">4</span><span class="op">]</span><span class="ident">block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;DC&nbsp;components&nbsp;are&nbsp;delta-encoded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prevDCY</span><span class="op">,</span>&nbsp;<span class="ident">prevDCCb</span><span class="op">,</span>&nbsp;<span class="ident">prevDCCr</span>&nbsp;<span class="builtintype">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bounds</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">Bounds</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="op">(</span><span class="keyword">type</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO(wathiede):&nbsp;switch&nbsp;on&nbsp;m.ColorModel()&nbsp;instead&nbsp;of&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">image</span><span class="op">.</span><span class="ident">Gray</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bounds</span><span class="op">.</span><span class="ident">Min</span><span class="op">.</span><span class="ident">Y</span><span class="op">;</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">bounds</span><span class="op">.</span><span class="ident">Max</span><span class="op">.</span><span class="ident">Y</span><span class="op">;</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="num">8</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bounds</span><span class="op">.</span><span class="ident">Min</span><span class="op">.</span><span class="ident">X</span><span class="op">;</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">bounds</span><span class="op">.</span><span class="ident">Max</span><span class="op">.</span><span class="ident">X</span><span class="op">;</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="num">8</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">image</span><span class="op">.</span><span class="ident">Pt</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">grayToY</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prevDCY</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">writeBlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">prevDCY</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rgba</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">image</span><span class="op">.</span><span class="ident">RGBA</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bounds</span><span class="op">.</span><span class="ident">Min</span><span class="op">.</span><span class="ident">Y</span><span class="op">;</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">bounds</span><span class="op">.</span><span class="ident">Max</span><span class="op">.</span><span class="ident">Y</span><span class="op">;</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="num">16</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bounds</span><span class="op">.</span><span class="ident">Min</span><span class="op">.</span><span class="ident">X</span><span class="op">;</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">bounds</span><span class="op">.</span><span class="ident">Max</span><span class="op">.</span><span class="ident">X</span><span class="op">;</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="num">16</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">4</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xOff</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">1</span><span class="op">)</span>&nbsp;<span class="op">*</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">yOff</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">2</span><span class="op">)</span>&nbsp;<span class="op">*</span>&nbsp;<span class="num">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">image</span><span class="op">.</span><span class="ident">Pt</span><span class="op">(</span><span class="ident">x</span><span class="op">+</span><span class="ident">xOff</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">+</span><span class="ident">yOff</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">rgba</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rgbaToYCbCr</span><span class="op">(</span><span class="ident">rgba</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">cb</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">cr</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">toYCbCr</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">cb</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">cr</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prevDCY</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">writeBlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">prevDCY</span><span class="op">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">scale</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">cb</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prevDCCb</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">writeBlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="ident">prevDCCb</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">scale</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">cr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prevDCCr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">writeBlock</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="ident">prevDCCr</span><span class="op">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Pad&nbsp;the&nbsp;last&nbsp;byte&nbsp;with&nbsp;1&#39;s.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">emit</span><span class="op">(</span><span class="num">0x7f</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">)</span><br>
<span class="lineno">535</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;DefaultQuality&nbsp;is&nbsp;the&nbsp;default&nbsp;quality&nbsp;encoding&nbsp;parameter.</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="ident">DefaultQuality</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">75</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="comment">//&nbsp;Options&nbsp;are&nbsp;the&nbsp;encoding&nbsp;parameters.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Quality&nbsp;ranges&nbsp;from&nbsp;1&nbsp;to&nbsp;100&nbsp;inclusive,&nbsp;higher&nbsp;is&nbsp;better.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">Options</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Quality</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;JPEG&nbsp;4:2:0&nbsp;baseline&nbsp;format&nbsp;with&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;options.&nbsp;Default&nbsp;parameters&nbsp;are&nbsp;used&nbsp;if&nbsp;a&nbsp;nil&nbsp;*Options&nbsp;is&nbsp;passed.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Encode</span><span class="op">(</span><span class="ident">w</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Writer</span><span class="op">,</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="ident">image</span><span class="op">.</span><span class="ident">Image</span><span class="op">,</span>&nbsp;<span class="ident">o</span>&nbsp;<span class="op">*</span><span class="ident">Options</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">Bounds</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Dx</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">1</span><span class="op">&lt;&lt;</span><span class="num">16</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">Dy</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">1</span><span class="op">&lt;&lt;</span><span class="num">16</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;jpeg:&nbsp;image&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="ident">encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ww</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="op">(</span><span class="ident">writer</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">w</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ww</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">w</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bufio</span><span class="op">.</span><span class="ident">NewWriter</span><span class="op">(</span><span class="ident">w</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Clip&nbsp;quality&nbsp;to&nbsp;[1,&nbsp;100].</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">quality</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">DefaultQuality</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">o</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">quality</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">o</span><span class="op">.</span><span class="ident">Quality</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">quality</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">quality</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">quality</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">100</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">quality</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Convert&nbsp;from&nbsp;a&nbsp;quality&nbsp;rating&nbsp;to&nbsp;a&nbsp;scaling&nbsp;factor.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">scale</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">quality</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">50</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">scale</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">5000</span>&nbsp;<span class="op">/</span>&nbsp;<span class="ident">quality</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">scale</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">200</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">quality</span><span class="op">*</span><span class="num">2</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Initialize&nbsp;the&nbsp;quantization&nbsp;tables.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">quant</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">quant</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">unscaledQuant</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">(</span><span class="ident">x</span><span class="op">*</span><span class="ident">scale</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">50</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="num">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">255</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">255</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">quant</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Compute&nbsp;number&nbsp;of&nbsp;components&nbsp;based&nbsp;on&nbsp;input&nbsp;image&nbsp;type.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nComponent</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="op">(</span><span class="keyword">type</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO(wathiede):&nbsp;switch&nbsp;on&nbsp;m.ColorModel()&nbsp;instead&nbsp;of&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">image</span><span class="op">.</span><span class="ident">Gray</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nComponent</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Write&nbsp;the&nbsp;Start&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0xd8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">write</span><span class="op">(</span><span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="op">:</span><span class="num">2</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Write&nbsp;the&nbsp;quantization&nbsp;tables.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">writeDQT</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Write&nbsp;the&nbsp;image&nbsp;dimensions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">writeSOF0</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">Size</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nComponent</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Write&nbsp;the&nbsp;Huffman&nbsp;tables.</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">writeDHT</span><span class="op">(</span><span class="ident">nComponent</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Write&nbsp;the&nbsp;image&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">writeSOS</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Write&nbsp;the&nbsp;End&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0xff</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0xd9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">write</span><span class="op">(</span><span class="ident">e</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="op">:</span><span class="num">2</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">flush</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">err</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
