<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4440036">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4440091">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4440145">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4440196">package</span>&nbsp;<span class="ident" id="4440204">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4440209">import</span>&nbsp;<span class="op" id="4440216">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4440219">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4440228">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4440238">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4440244">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4440255">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4440262">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="4440265">//&nbsp;tooBig&nbsp;provides&nbsp;a&nbsp;sanity&nbsp;check&nbsp;for&nbsp;sizes;&nbsp;used&nbsp;in&nbsp;several&nbsp;places.</span><br>
<span class="lineno"></span><span class="comment" id="4440334">//&nbsp;Upper&nbsp;limit&nbsp;of&nbsp;1GB,&nbsp;allowing&nbsp;room&nbsp;to&nbsp;grow&nbsp;a&nbsp;little&nbsp;without&nbsp;overflow.</span><br>
<span class="lineno"></span><span class="comment" id="4440406">//&nbsp;TODO:&nbsp;make&nbsp;this&nbsp;adjustable?</span><br>
<span class="lineno"></span><span class="keyword" id="4440437">const</span>&nbsp;<span class="ident" id="4440443">tooBig</span>&nbsp;<span class="op" id="4440450">=</span>&nbsp;<span class="num" id="4440452">1</span>&nbsp;<span class="op" id="4440454">&lt;&lt;</span>&nbsp;<span class="num" id="4440457">30</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="4440461">//&nbsp;A&nbsp;Decoder&nbsp;manages&nbsp;the&nbsp;receipt&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;read&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4440537">//&nbsp;remote&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4440569">type</span>&nbsp;<span class="ident" id="4440574">Decoder</span>&nbsp;<span class="keyword" id="4440582">struct</span>&nbsp;<span class="op" id="4440589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440592">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440605">sync</span><span class="op" id="4440609">.</span><span class="ident" id="4440610">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4440645">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;received&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440687">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440700">io</span><span class="op" id="4440702">.</span><span class="ident" id="4440703">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4440740">//&nbsp;source&nbsp;of&nbsp;the&nbsp;data</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440763">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440776">decBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4440816">//&nbsp;buffer&nbsp;for&nbsp;more&nbsp;efficient&nbsp;i/o&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440857">wireType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440870">map</span><span class="op" id="4440873">[</span><span class="ident" id="4440874">typeId</span><span class="op" id="4440880">]</span><span class="op" id="4440881">*</span><span class="ident" id="4440882">wireType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4440910">//&nbsp;map&nbsp;from&nbsp;remote&nbsp;ID&nbsp;to&nbsp;local&nbsp;description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4440954">decoderCache</span>&nbsp;<span class="keyword" id="4440967">map</span><span class="op" id="4440970">[</span><span class="ident" id="4440971">reflect</span><span class="op" id="4440978">.</span><span class="ident" id="4440979">Type</span><span class="op" id="4440983">]</span><span class="keyword" id="4440984">map</span><span class="op" id="4440987">[</span><span class="ident" id="4440988">typeId</span><span class="op" id="4440994">]</span><span class="op" id="4440995">*</span><span class="op" id="4440996">*</span><span class="ident" id="4440997">decEngine</span>&nbsp;<span class="comment" id="4441007">//&nbsp;cache&nbsp;of&nbsp;compiled&nbsp;engines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441037">ignorerCache</span>&nbsp;<span class="keyword" id="4441050">map</span><span class="op" id="4441053">[</span><span class="ident" id="4441054">typeId</span><span class="op" id="4441060">]</span><span class="op" id="4441061">*</span><span class="op" id="4441062">*</span><span class="ident" id="4441063">decEngine</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4441090">//&nbsp;ditto&nbsp;for&nbsp;ignored&nbsp;objects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441120">freeList</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4441133">*</span><span class="ident" id="4441134">decoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4441173">//&nbsp;list&nbsp;of&nbsp;free&nbsp;decoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441225">countBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4441238">[</span><span class="op" id="4441239">]</span><span class="builtintype" id="4441240">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4441278">//&nbsp;used&nbsp;for&nbsp;decoding&nbsp;integers&nbsp;while&nbsp;parsing&nbsp;messages</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441332">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4441345">error</span><br>
<span class="lineno"></span><span class="op" id="4441351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4441354">//&nbsp;NewDecoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;decoder&nbsp;that&nbsp;reads&nbsp;from&nbsp;the&nbsp;io.Reader.</span><br>
<span class="lineno">35</span><span class="comment" id="4441421">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,&nbsp;it&nbsp;will&nbsp;be&nbsp;wrapped&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4441492">//&nbsp;bufio.Reader.</span><br>
<span class="lineno"></span><span class="keyword" id="4441509">func</span>&nbsp;<span class="ident" id="4441514">NewDecoder</span><span class="op" id="4441524">(</span><span class="ident" id="4441525">r</span>&nbsp;<span class="ident" id="4441527">io</span><span class="op" id="4441529">.</span><span class="ident" id="4441530">Reader</span><span class="op" id="4441536">)</span>&nbsp;<span class="op" id="4441538">*</span><span class="ident" id="4441539">Decoder</span>&nbsp;<span class="op" id="4441547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441550">dec</span>&nbsp;<span class="op" id="4441554">:=</span>&nbsp;<span class="builtinfunc" id="4441557">new</span><span class="op" id="4441560">(</span><span class="ident" id="4441561">Decoder</span><span class="op" id="4441568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4441571">//&nbsp;We&nbsp;use&nbsp;the&nbsp;ability&nbsp;to&nbsp;read&nbsp;bytes&nbsp;as&nbsp;a&nbsp;plausible&nbsp;surrogate&nbsp;for&nbsp;buffering.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4441648">if</span>&nbsp;<span class="ident" id="4441651">_</span><span class="op" id="4441652">,</span>&nbsp;<span class="ident" id="4441654">ok</span>&nbsp;<span class="op" id="4441657">:=</span>&nbsp;<span class="ident" id="4441660">r</span><span class="op" id="4441661">.</span><span class="op" id="4441662">(</span><span class="ident" id="4441663">io</span><span class="op" id="4441665">.</span><span class="ident" id="4441666">ByteReader</span><span class="op" id="4441676">)</span><span class="op" id="4441677">;</span>&nbsp;<span class="op" id="4441679">!</span><span class="ident" id="4441680">ok</span>&nbsp;<span class="op" id="4441683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441687">r</span>&nbsp;<span class="op" id="4441689">=</span>&nbsp;<span class="ident" id="4441691">bufio</span><span class="op" id="4441696">.</span><span class="ident" id="4441697">NewReader</span><span class="op" id="4441706">(</span><span class="ident" id="4441707">r</span><span class="op" id="4441708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4441711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441714">dec</span><span class="op" id="4441717">.</span><span class="ident" id="4441718">r</span>&nbsp;<span class="op" id="4441720">=</span>&nbsp;<span class="ident" id="4441722">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441725">dec</span><span class="op" id="4441728">.</span><span class="ident" id="4441729">wireType</span>&nbsp;<span class="op" id="4441738">=</span>&nbsp;<span class="builtinfunc" id="4441740">make</span><span class="op" id="4441744">(</span><span class="keyword" id="4441745">map</span><span class="op" id="4441748">[</span><span class="ident" id="4441749">typeId</span><span class="op" id="4441755">]</span><span class="op" id="4441756">*</span><span class="ident" id="4441757">wireType</span><span class="op" id="4441765">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441768">dec</span><span class="op" id="4441771">.</span><span class="ident" id="4441772">decoderCache</span>&nbsp;<span class="op" id="4441785">=</span>&nbsp;<span class="builtinfunc" id="4441787">make</span><span class="op" id="4441791">(</span><span class="keyword" id="4441792">map</span><span class="op" id="4441795">[</span><span class="ident" id="4441796">reflect</span><span class="op" id="4441803">.</span><span class="ident" id="4441804">Type</span><span class="op" id="4441808">]</span><span class="keyword" id="4441809">map</span><span class="op" id="4441812">[</span><span class="ident" id="4441813">typeId</span><span class="op" id="4441819">]</span><span class="op" id="4441820">*</span><span class="op" id="4441821">*</span><span class="ident" id="4441822">decEngine</span><span class="op" id="4441831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441834">dec</span><span class="op" id="4441837">.</span><span class="ident" id="4441838">ignorerCache</span>&nbsp;<span class="op" id="4441851">=</span>&nbsp;<span class="builtinfunc" id="4441853">make</span><span class="op" id="4441857">(</span><span class="keyword" id="4441858">map</span><span class="op" id="4441861">[</span><span class="ident" id="4441862">typeId</span><span class="op" id="4441868">]</span><span class="op" id="4441869">*</span><span class="op" id="4441870">*</span><span class="ident" id="4441871">decEngine</span><span class="op" id="4441880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4441883">dec</span><span class="op" id="4441886">.</span><span class="ident" id="4441887">countBuf</span>&nbsp;<span class="op" id="4441896">=</span>&nbsp;<span class="builtinfunc" id="4441898">make</span><span class="op" id="4441902">(</span><span class="op" id="4441903">[</span><span class="op" id="4441904">]</span><span class="builtintype" id="4441905">byte</span><span class="op" id="4441909">,</span>&nbsp;<span class="num" id="4441911">9</span><span class="op" id="4441912">)</span>&nbsp;<span class="comment" id="4441914">//&nbsp;counts&nbsp;may&nbsp;be&nbsp;uint64s&nbsp;(unlikely!),&nbsp;require&nbsp;9&nbsp;bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4441970">return</span>&nbsp;<span class="ident" id="4441977">dec</span><br>
<span class="lineno">50</span><span class="op" id="4441981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4441984">//&nbsp;recvType&nbsp;loads&nbsp;the&nbsp;definition&nbsp;of&nbsp;a&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4442028">func</span>&nbsp;<span class="op" id="4442033">(</span><span class="ident" id="4442034">dec</span>&nbsp;<span class="op" id="4442038">*</span><span class="ident" id="4442039">Decoder</span><span class="op" id="4442046">)</span>&nbsp;<span class="ident" id="4442048">recvType</span><span class="op" id="4442056">(</span><span class="ident" id="4442057">id</span>&nbsp;<span class="ident" id="4442060">typeId</span><span class="op" id="4442066">)</span>&nbsp;<span class="op" id="4442068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4442071">//&nbsp;Have&nbsp;we&nbsp;already&nbsp;seen&nbsp;this&nbsp;type?&nbsp;&nbsp;That&#39;s&nbsp;an&nbsp;error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442124">if</span>&nbsp;<span class="ident" id="4442127">id</span>&nbsp;<span class="op" id="4442130">&lt;</span>&nbsp;<span class="ident" id="4442132">firstUserId</span>&nbsp;<span class="op" id="4442144">||</span>&nbsp;<span class="ident" id="4442147">dec</span><span class="op" id="4442150">.</span><span class="ident" id="4442151">wireType</span><span class="op" id="4442159">[</span><span class="ident" id="4442160">id</span><span class="op" id="4442162">]</span>&nbsp;<span class="op" id="4442164">!=</span>&nbsp;<span class="ident" id="4442167">nil</span>&nbsp;<span class="op" id="4442171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442175">dec</span><span class="op" id="4442178">.</span><span class="ident" id="4442179">err</span>&nbsp;<span class="op" id="4442183">=</span>&nbsp;<span class="ident" id="4442185">errors</span><span class="op" id="4442191">.</span><span class="ident" id="4442192">New</span><span class="op" id="4442195">(</span><span class="string" id="4442196">&#34;gob:&nbsp;duplicate&nbsp;type&nbsp;received&#34;</span><span class="op" id="4442226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442230">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4442238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4442242">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442252">wire</span>&nbsp;<span class="op" id="4442257">:=</span>&nbsp;<span class="builtinfunc" id="4442260">new</span><span class="op" id="4442263">(</span><span class="ident" id="4442264">wireType</span><span class="op" id="4442272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442275">dec</span><span class="op" id="4442278">.</span><span class="ident" id="4442279">decodeValue</span><span class="op" id="4442290">(</span><span class="ident" id="4442291">tWireType</span><span class="op" id="4442300">,</span>&nbsp;<span class="ident" id="4442302">reflect</span><span class="op" id="4442309">.</span><span class="ident" id="4442310">ValueOf</span><span class="op" id="4442317">(</span><span class="ident" id="4442318">wire</span><span class="op" id="4442322">)</span><span class="op" id="4442323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442326">if</span>&nbsp;<span class="ident" id="4442329">dec</span><span class="op" id="4442332">.</span><span class="ident" id="4442333">err</span>&nbsp;<span class="op" id="4442337">!=</span>&nbsp;<span class="ident" id="4442340">nil</span>&nbsp;<span class="op" id="4442344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442348">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4442356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4442359">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;seen&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442394">dec</span><span class="op" id="4442397">.</span><span class="ident" id="4442398">wireType</span><span class="op" id="4442406">[</span><span class="ident" id="4442407">id</span><span class="op" id="4442409">]</span>&nbsp;<span class="op" id="4442411">=</span>&nbsp;<span class="ident" id="4442413">wire</span><br>
<span class="lineno"></span><span class="op" id="4442418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="4442421">var</span>&nbsp;<span class="ident" id="4442425">errBadCount</span>&nbsp;<span class="op" id="4442437">=</span>&nbsp;<span class="ident" id="4442439">errors</span><span class="op" id="4442445">.</span><span class="ident" id="4442446">New</span><span class="op" id="4442449">(</span><span class="string" id="4442450">&#34;invalid&nbsp;message&nbsp;length&#34;</span><span class="op" id="4442474">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4442477">//&nbsp;recvMessage&nbsp;reads&nbsp;the&nbsp;next&nbsp;count-delimited&nbsp;item&nbsp;from&nbsp;the&nbsp;input.&nbsp;It&nbsp;is&nbsp;the&nbsp;converse</span><br>
<span class="lineno"></span><span class="comment" id="4442563">//&nbsp;of&nbsp;Encoder.writeMessage.&nbsp;It&nbsp;returns&nbsp;false&nbsp;on&nbsp;EOF&nbsp;or&nbsp;other&nbsp;error&nbsp;reading&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span><span class="keyword" id="4442651">func</span>&nbsp;<span class="op" id="4442656">(</span><span class="ident" id="4442657">dec</span>&nbsp;<span class="op" id="4442661">*</span><span class="ident" id="4442662">Decoder</span><span class="op" id="4442669">)</span>&nbsp;<span class="ident" id="4442671">recvMessage</span><span class="op" id="4442682">(</span><span class="op" id="4442683">)</span>&nbsp;<span class="builtintype" id="4442685">bool</span>&nbsp;<span class="op" id="4442690">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4442693">//&nbsp;Read&nbsp;a&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442711">nbytes</span><span class="op" id="4442717">,</span>&nbsp;<span class="ident" id="4442719">_</span><span class="op" id="4442720">,</span>&nbsp;<span class="ident" id="4442722">err</span>&nbsp;<span class="op" id="4442726">:=</span>&nbsp;<span class="ident" id="4442729">decodeUintReader</span><span class="op" id="4442745">(</span><span class="ident" id="4442746">dec</span><span class="op" id="4442749">.</span><span class="ident" id="4442750">r</span><span class="op" id="4442751">,</span>&nbsp;<span class="ident" id="4442753">dec</span><span class="op" id="4442756">.</span><span class="ident" id="4442757">countBuf</span><span class="op" id="4442765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442768">if</span>&nbsp;<span class="ident" id="4442771">err</span>&nbsp;<span class="op" id="4442775">!=</span>&nbsp;<span class="ident" id="4442778">nil</span>&nbsp;<span class="op" id="4442782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442786">dec</span><span class="op" id="4442789">.</span><span class="ident" id="4442790">err</span>&nbsp;<span class="op" id="4442794">=</span>&nbsp;<span class="ident" id="4442796">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442802">return</span>&nbsp;<span class="builtintype" id="4442809">false</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4442816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442819">if</span>&nbsp;<span class="ident" id="4442822">nbytes</span>&nbsp;<span class="op" id="4442829">&gt;=</span>&nbsp;<span class="ident" id="4442832">tooBig</span>&nbsp;<span class="op" id="4442839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442843">dec</span><span class="op" id="4442846">.</span><span class="ident" id="4442847">err</span>&nbsp;<span class="op" id="4442851">=</span>&nbsp;<span class="ident" id="4442853">errBadCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442867">return</span>&nbsp;<span class="builtintype" id="4442874">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4442881">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4442884">dec</span><span class="op" id="4442887">.</span><span class="ident" id="4442888">readMessage</span><span class="op" id="4442899">(</span><span class="builtintype" id="4442900">int</span><span class="op" id="4442903">(</span><span class="ident" id="4442904">nbytes</span><span class="op" id="4442910">)</span><span class="op" id="4442911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4442914">return</span>&nbsp;<span class="ident" id="4442921">dec</span><span class="op" id="4442924">.</span><span class="ident" id="4442925">err</span>&nbsp;<span class="op" id="4442929">==</span>&nbsp;<span class="ident" id="4442932">nil</span><br>
<span class="lineno"></span><span class="op" id="4442936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4442939">//&nbsp;readMessage&nbsp;reads&nbsp;the&nbsp;next&nbsp;nbytes&nbsp;bytes&nbsp;from&nbsp;the&nbsp;input.</span><br>
<span class="lineno">90</span><span class="keyword" id="4442998">func</span>&nbsp;<span class="op" id="4443003">(</span><span class="ident" id="4443004">dec</span>&nbsp;<span class="op" id="4443008">*</span><span class="ident" id="4443009">Decoder</span><span class="op" id="4443016">)</span>&nbsp;<span class="ident" id="4443018">readMessage</span><span class="op" id="4443029">(</span><span class="ident" id="4443030">nbytes</span>&nbsp;<span class="builtintype" id="4443037">int</span><span class="op" id="4443040">)</span>&nbsp;<span class="op" id="4443042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443045">if</span>&nbsp;<span class="ident" id="4443048">dec</span><span class="op" id="4443051">.</span><span class="ident" id="4443052">buf</span><span class="op" id="4443055">.</span><span class="ident" id="4443056">Len</span><span class="op" id="4443059">(</span><span class="op" id="4443060">)</span>&nbsp;<span class="op" id="4443062">!=</span>&nbsp;<span class="num" id="4443065">0</span>&nbsp;<span class="op" id="4443067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4443071">//&nbsp;The&nbsp;buffer&nbsp;should&nbsp;always&nbsp;be&nbsp;empty&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4443115">panic</span><span class="op" id="4443120">(</span><span class="string" id="4443121">&#34;non-empty&nbsp;decoder&nbsp;buffer&#34;</span><span class="op" id="4443147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4443150">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4443153">//&nbsp;Read&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443171">dec</span><span class="op" id="4443174">.</span><span class="ident" id="4443175">buf</span><span class="op" id="4443178">.</span><span class="ident" id="4443179">Size</span><span class="op" id="4443183">(</span><span class="ident" id="4443184">nbytes</span><span class="op" id="4443190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443193">_</span><span class="op" id="4443194">,</span>&nbsp;<span class="ident" id="4443196">dec</span><span class="op" id="4443199">.</span><span class="ident" id="4443200">err</span>&nbsp;<span class="op" id="4443204">=</span>&nbsp;<span class="ident" id="4443206">io</span><span class="op" id="4443208">.</span><span class="ident" id="4443209">ReadFull</span><span class="op" id="4443217">(</span><span class="ident" id="4443218">dec</span><span class="op" id="4443221">.</span><span class="ident" id="4443222">r</span><span class="op" id="4443223">,</span>&nbsp;<span class="ident" id="4443225">dec</span><span class="op" id="4443228">.</span><span class="ident" id="4443229">buf</span><span class="op" id="4443232">.</span><span class="ident" id="4443233">Bytes</span><span class="op" id="4443238">(</span><span class="op" id="4443239">)</span><span class="op" id="4443240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443243">if</span>&nbsp;<span class="ident" id="4443246">dec</span><span class="op" id="4443249">.</span><span class="ident" id="4443250">err</span>&nbsp;<span class="op" id="4443254">!=</span>&nbsp;<span class="ident" id="4443257">nil</span>&nbsp;<span class="op" id="4443261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443265">if</span>&nbsp;<span class="ident" id="4443268">dec</span><span class="op" id="4443271">.</span><span class="ident" id="4443272">err</span>&nbsp;<span class="op" id="4443276">==</span>&nbsp;<span class="ident" id="4443279">io</span><span class="op" id="4443281">.</span><span class="ident" id="4443282">EOF</span>&nbsp;<span class="op" id="4443286">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443291">dec</span><span class="op" id="4443294">.</span><span class="ident" id="4443295">err</span>&nbsp;<span class="op" id="4443299">=</span>&nbsp;<span class="ident" id="4443301">io</span><span class="op" id="4443303">.</span><span class="ident" id="4443304">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4443323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4443326">}</span><br>
<span class="lineno"></span><span class="op" id="4443328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4443331">//&nbsp;toInt&nbsp;turns&nbsp;an&nbsp;encoded&nbsp;uint64&nbsp;into&nbsp;an&nbsp;int,&nbsp;according&nbsp;to&nbsp;the&nbsp;marshaling&nbsp;rules.</span><br>
<span class="lineno"></span><span class="keyword" id="4443412">func</span>&nbsp;<span class="ident" id="4443417">toInt</span><span class="op" id="4443422">(</span><span class="ident" id="4443423">x</span>&nbsp;<span class="ident" id="4443425">uint64</span><span class="op" id="4443431">)</span>&nbsp;<span class="ident" id="4443433">int64</span>&nbsp;<span class="op" id="4443439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443442">i</span>&nbsp;<span class="op" id="4443444">:=</span>&nbsp;<span class="ident" id="4443447">int64</span><span class="op" id="4443452">(</span><span class="ident" id="4443453">x</span>&nbsp;<span class="op" id="4443455">&gt;&gt;</span>&nbsp;<span class="num" id="4443458">1</span><span class="op" id="4443459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443462">if</span>&nbsp;<span class="ident" id="4443465">x</span><span class="op" id="4443466">&amp;</span><span class="num" id="4443467">1</span>&nbsp;<span class="op" id="4443469">!=</span>&nbsp;<span class="num" id="4443472">0</span>&nbsp;<span class="op" id="4443474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443478">i</span>&nbsp;<span class="op" id="4443480">=</span>&nbsp;<span class="op" id="4443482">^</span><span class="ident" id="4443483">i</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4443486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443489">return</span>&nbsp;<span class="ident" id="4443496">i</span><br>
<span class="lineno"></span><span class="op" id="4443498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4443501">func</span>&nbsp;<span class="op" id="4443506">(</span><span class="ident" id="4443507">dec</span>&nbsp;<span class="op" id="4443511">*</span><span class="ident" id="4443512">Decoder</span><span class="op" id="4443519">)</span>&nbsp;<span class="ident" id="4443521">nextInt</span><span class="op" id="4443528">(</span><span class="op" id="4443529">)</span>&nbsp;<span class="ident" id="4443531">int64</span>&nbsp;<span class="op" id="4443537">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443540">n</span><span class="op" id="4443541">,</span>&nbsp;<span class="ident" id="4443543">_</span><span class="op" id="4443544">,</span>&nbsp;<span class="ident" id="4443546">err</span>&nbsp;<span class="op" id="4443550">:=</span>&nbsp;<span class="ident" id="4443553">decodeUintReader</span><span class="op" id="4443569">(</span><span class="op" id="4443570">&amp;</span><span class="ident" id="4443571">dec</span><span class="op" id="4443574">.</span><span class="ident" id="4443575">buf</span><span class="op" id="4443578">,</span>&nbsp;<span class="ident" id="4443580">dec</span><span class="op" id="4443583">.</span><span class="ident" id="4443584">countBuf</span><span class="op" id="4443592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443595">if</span>&nbsp;<span class="ident" id="4443598">err</span>&nbsp;<span class="op" id="4443602">!=</span>&nbsp;<span class="ident" id="4443605">nil</span>&nbsp;<span class="op" id="4443609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443613">dec</span><span class="op" id="4443616">.</span><span class="ident" id="4443617">err</span>&nbsp;<span class="op" id="4443621">=</span>&nbsp;<span class="ident" id="4443623">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4443628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443631">return</span>&nbsp;<span class="ident" id="4443638">toInt</span><span class="op" id="4443643">(</span><span class="ident" id="4443644">n</span><span class="op" id="4443645">)</span><br>
<span class="lineno">120</span><span class="op" id="4443647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4443650">func</span>&nbsp;<span class="op" id="4443655">(</span><span class="ident" id="4443656">dec</span>&nbsp;<span class="op" id="4443660">*</span><span class="ident" id="4443661">Decoder</span><span class="op" id="4443668">)</span>&nbsp;<span class="ident" id="4443670">nextUint</span><span class="op" id="4443678">(</span><span class="op" id="4443679">)</span>&nbsp;<span class="ident" id="4443681">uint64</span>&nbsp;<span class="op" id="4443688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443691">n</span><span class="op" id="4443692">,</span>&nbsp;<span class="ident" id="4443694">_</span><span class="op" id="4443695">,</span>&nbsp;<span class="ident" id="4443697">err</span>&nbsp;<span class="op" id="4443701">:=</span>&nbsp;<span class="ident" id="4443704">decodeUintReader</span><span class="op" id="4443720">(</span><span class="op" id="4443721">&amp;</span><span class="ident" id="4443722">dec</span><span class="op" id="4443725">.</span><span class="ident" id="4443726">buf</span><span class="op" id="4443729">,</span>&nbsp;<span class="ident" id="4443731">dec</span><span class="op" id="4443734">.</span><span class="ident" id="4443735">countBuf</span><span class="op" id="4443743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443746">if</span>&nbsp;<span class="ident" id="4443749">err</span>&nbsp;<span class="op" id="4443753">!=</span>&nbsp;<span class="ident" id="4443756">nil</span>&nbsp;<span class="op" id="4443760">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4443764">dec</span><span class="op" id="4443767">.</span><span class="ident" id="4443768">err</span>&nbsp;<span class="op" id="4443772">=</span>&nbsp;<span class="ident" id="4443774">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4443779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4443782">return</span>&nbsp;<span class="ident" id="4443789">n</span><br>
<span class="lineno"></span><span class="op" id="4443791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="4443794">//&nbsp;decodeTypeSequence&nbsp;parses:</span><br>
<span class="lineno"></span><span class="comment" id="4443824">//&nbsp;TypeSequence</span><br>
<span class="lineno"></span><span class="comment" id="4443840">//&nbsp;&nbsp;&nbsp;&nbsp(TypeDefinition&nbsp;DelimitedTypeDefinition*)?</span><br>
<span class="lineno"></span><span class="comment" id="4443886">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;type&nbsp;id&nbsp;of&nbsp;the&nbsp;next&nbsp;value.&nbsp;&nbsp;It&nbsp;returns&nbsp;-1&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="4443950">//&nbsp;EOF.&nbsp;&nbsp;Upon&nbsp;return,&nbsp;the&nbsp;remainder&nbsp;of&nbsp;dec.buf&nbsp;is&nbsp;the&nbsp;value&nbsp;to&nbsp;be</span><br>
<span class="lineno">135</span><span class="comment" id="4444016">//&nbsp;decoded.&nbsp;&nbsp;If&nbsp;this&nbsp;is&nbsp;an&nbsp;interface&nbsp;value,&nbsp;it&nbsp;can&nbsp;be&nbsp;ignored&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4444081">//&nbsp;resetting&nbsp;that&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4444107">func</span>&nbsp;<span class="op" id="4444112">(</span><span class="ident" id="4444113">dec</span>&nbsp;<span class="op" id="4444117">*</span><span class="ident" id="4444118">Decoder</span><span class="op" id="4444125">)</span>&nbsp;<span class="ident" id="4444127">decodeTypeSequence</span><span class="op" id="4444145">(</span><span class="ident" id="4444146">isInterface</span>&nbsp;<span class="builtintype" id="4444158">bool</span><span class="op" id="4444162">)</span>&nbsp;<span class="ident" id="4444164">typeId</span>&nbsp;<span class="op" id="4444171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4444174">for</span>&nbsp;<span class="ident" id="4444178">dec</span><span class="op" id="4444181">.</span><span class="ident" id="4444182">err</span>&nbsp;<span class="op" id="4444186">==</span>&nbsp;<span class="ident" id="4444189">nil</span>&nbsp;<span class="op" id="4444193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4444197">if</span>&nbsp;<span class="ident" id="4444200">dec</span><span class="op" id="4444203">.</span><span class="ident" id="4444204">buf</span><span class="op" id="4444207">.</span><span class="ident" id="4444208">Len</span><span class="op" id="4444211">(</span><span class="op" id="4444212">)</span>&nbsp;<span class="op" id="4444214">==</span>&nbsp;<span class="num" id="4444217">0</span>&nbsp;<span class="op" id="4444219">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4444224">if</span>&nbsp;<span class="op" id="4444227">!</span><span class="ident" id="4444228">dec</span><span class="op" id="4444231">.</span><span class="ident" id="4444232">recvMessage</span><span class="op" id="4444243">(</span><span class="op" id="4444244">)</span>&nbsp;<span class="op" id="4444246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4444252">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4444261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4444265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4444269">//&nbsp;Receive&nbsp;a&nbsp;type&nbsp;id.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4444293">id</span>&nbsp;<span class="op" id="4444296">:=</span>&nbsp;<span class="ident" id="4444299">typeId</span><span class="op" id="4444305">(</span><span class="ident" id="4444306">dec</span><span class="op" id="4444309">.</span><span class="ident" id="4444310">nextInt</span><span class="op" id="4444317">(</span><span class="op" id="4444318">)</span><span class="op" id="4444319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4444323">if</span>&nbsp;<span class="ident" id="4444326">id</span>&nbsp;<span class="op" id="4444329">&gt;=</span>&nbsp;<span class="num" id="4444332">0</span>&nbsp;<span class="op" id="4444334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4444339">//&nbsp;Value&nbsp;follows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4444360">return</span>&nbsp;<span class="ident" id="4444367">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4444372">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4444376">//&nbsp;Type&nbsp;definition&nbsp;for&nbsp;(-id)&nbsp;follows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4444416">dec</span><span class="op" id="4444419">.</span><span class="ident" id="4444420">recvType</span><span class="op" id="4444428">(</span><span class="op" id="4444429">-</span><span class="ident" id="4444430">id</span><span class="op" id="4444432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4444436">//&nbsp;When&nbsp;decoding&nbsp;an&nbsp;interface,&nbsp;after&nbsp;a&nbsp;type&nbsp;there&nbsp;may&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4444497">//&nbsp;DelimitedValue&nbsp;still&nbsp;in&nbsp;the&nbsp;buffer.&nbsp;&nbsp;Skip&nbsp;its&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4444555">//&nbsp;(Alternatively,&nbsp;the&nbsp;buffer&nbsp;is&nbsp;empty&nbsp;and&nbsp;the&nbsp;byte&nbsp;count</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4444615">//&nbsp;will&nbsp;be&nbsp;absorbed&nbsp;by&nbsp;recvMessage.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4444654">if</span>&nbsp;<span class="ident" id="4444657">dec</span><span class="op" id="4444660">.</span><span class="ident" id="4444661">buf</span><span class="op" id="4444664">.</span><span class="ident" id="4444665">Len</span><span class="op" id="4444668">(</span><span class="op" id="4444669">)</span>&nbsp;<span class="op" id="4444671">&gt;</span>&nbsp;<span class="num" id="4444673">0</span>&nbsp;<span class="op" id="4444675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4444680">if</span>&nbsp;<span class="op" id="4444683">!</span><span class="ident" id="4444684">isInterface</span>&nbsp;<span class="op" id="4444696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4444702">dec</span><span class="op" id="4444705">.</span><span class="ident" id="4444706">err</span>&nbsp;<span class="op" id="4444710">=</span>&nbsp;<span class="ident" id="4444712">errors</span><span class="op" id="4444718">.</span><span class="ident" id="4444719">New</span><span class="op" id="4444722">(</span><span class="string" id="4444723">&#34;extra&nbsp;data&nbsp;in&nbsp;buffer&#34;</span><span class="op" id="4444745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4444751">break</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4444760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4444765">dec</span><span class="op" id="4444768">.</span><span class="ident" id="4444769">nextUint</span><span class="op" id="4444777">(</span><span class="op" id="4444778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4444782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4444785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4444788">return</span>&nbsp;<span class="op" id="4444795">-</span><span class="num" id="4444796">1</span><br>
<span class="lineno">165</span><span class="op" id="4444798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4444801">//&nbsp;Decode&nbsp;reads&nbsp;the&nbsp;next&nbsp;value&nbsp;from&nbsp;the&nbsp;input&nbsp;stream&nbsp;and&nbsp;stores</span><br>
<span class="lineno"></span><span class="comment" id="4444865">//&nbsp;it&nbsp;in&nbsp;the&nbsp;data&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment" id="4444925">//&nbsp;If&nbsp;e&nbsp;is&nbsp;nil,&nbsp;the&nbsp;value&nbsp;will&nbsp;be&nbsp;discarded.&nbsp;Otherwise,</span><br>
<span class="lineno">170</span><span class="comment" id="4444981">//&nbsp;the&nbsp;value&nbsp;underlying&nbsp;e&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4445032">//&nbsp;correct&nbsp;type&nbsp;for&nbsp;the&nbsp;next&nbsp;data&nbsp;item&nbsp;received.</span><br>
<span class="lineno"></span><span class="comment" id="4445081">//&nbsp;If&nbsp;the&nbsp;input&nbsp;is&nbsp;at&nbsp;EOF,&nbsp;Decode&nbsp;returns&nbsp;io.EOF&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4445134">//&nbsp;does&nbsp;not&nbsp;modify&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="4445156">func</span>&nbsp;<span class="op" id="4445161">(</span><span class="ident" id="4445162">dec</span>&nbsp;<span class="op" id="4445166">*</span><span class="ident" id="4445167">Decoder</span><span class="op" id="4445174">)</span>&nbsp;<span class="ident" id="4445176">Decode</span><span class="op" id="4445182">(</span><span class="ident" id="4445183">e</span>&nbsp;<span class="keyword" id="4445185">interface</span><span class="op" id="4445194">{</span><span class="op" id="4445195">}</span><span class="op" id="4445196">)</span>&nbsp;<span class="builtintype" id="4445198">error</span>&nbsp;<span class="op" id="4445204">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4445207">if</span>&nbsp;<span class="ident" id="4445210">e</span>&nbsp;<span class="op" id="4445212">==</span>&nbsp;<span class="ident" id="4445215">nil</span>&nbsp;<span class="op" id="4445219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4445223">return</span>&nbsp;<span class="ident" id="4445230">dec</span><span class="op" id="4445233">.</span><span class="ident" id="4445234">DecodeValue</span><span class="op" id="4445245">(</span><span class="ident" id="4445246">reflect</span><span class="op" id="4445253">.</span><span class="ident" id="4445254">Value</span><span class="op" id="4445259">{</span><span class="op" id="4445260">}</span><span class="op" id="4445261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4445264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445267">value</span>&nbsp;<span class="op" id="4445273">:=</span>&nbsp;<span class="ident" id="4445276">reflect</span><span class="op" id="4445283">.</span><span class="ident" id="4445284">ValueOf</span><span class="op" id="4445291">(</span><span class="ident" id="4445292">e</span><span class="op" id="4445293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4445296">//&nbsp;If&nbsp;e&nbsp;represents&nbsp;a&nbsp;value&nbsp;as&nbsp;opposed&nbsp;to&nbsp;a&nbsp;pointer,&nbsp;the&nbsp;answer&nbsp;won&#39;t</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4445366">//&nbsp;get&nbsp;back&nbsp;to&nbsp;the&nbsp;caller.&nbsp;&nbsp;Make&nbsp;sure&nbsp;it&#39;s&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4445421">if</span>&nbsp;<span class="ident" id="4445424">value</span><span class="op" id="4445429">.</span><span class="ident" id="4445430">Type</span><span class="op" id="4445434">(</span><span class="op" id="4445435">)</span><span class="op" id="4445436">.</span><span class="ident" id="4445437">Kind</span><span class="op" id="4445441">(</span><span class="op" id="4445442">)</span>&nbsp;<span class="op" id="4445444">!=</span>&nbsp;<span class="ident" id="4445447">reflect</span><span class="op" id="4445454">.</span><span class="ident" id="4445455">Ptr</span>&nbsp;<span class="op" id="4445459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4445463">dec</span><span class="op" id="4445466">.</span><span class="ident" id="4445467">err</span>&nbsp;<span class="op" id="4445471">=</span>&nbsp;<span class="ident" id="4445473">errors</span><span class="op" id="4445479">.</span><span class="ident" id="4445480">New</span><span class="op" id="4445483">(</span><span class="string" id="4445484">&#34;gob:&nbsp;attempt&nbsp;to&nbsp;decode&nbsp;into&nbsp;a&nbsp;non-pointer&#34;</span><span class="op" id="4445527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4445531">return</span>&nbsp;<span class="ident" id="4445538">dec</span><span class="op" id="4445541">.</span><span class="ident" id="4445542">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4445547">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4445550">return</span>&nbsp;<span class="ident" id="4445557">dec</span><span class="op" id="4445560">.</span><span class="ident" id="4445561">DecodeValue</span><span class="op" id="4445572">(</span><span class="ident" id="4445573">value</span><span class="op" id="4445578">)</span><br>
<span class="lineno"></span><span class="op" id="4445580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4445583">//&nbsp;DecodeValue&nbsp;reads&nbsp;the&nbsp;next&nbsp;value&nbsp;from&nbsp;the&nbsp;input&nbsp;stream.</span><br>
<span class="lineno"></span><span class="comment" id="4445642">//&nbsp;If&nbsp;v&nbsp;is&nbsp;the&nbsp;zero&nbsp;reflect.Value&nbsp;(v.Kind()&nbsp;==&nbsp;Invalid),&nbsp;DecodeValue&nbsp;discards&nbsp;the&nbsp;value.</span><br>
<span class="lineno">190</span><span class="comment" id="4445731">//&nbsp;Otherwise,&nbsp;it&nbsp;stores&nbsp;the&nbsp;value&nbsp;into&nbsp;v.&nbsp;&nbsp;In&nbsp;that&nbsp;case,&nbsp;v&nbsp;must&nbsp;represent</span><br>
<span class="lineno"></span><span class="comment" id="4445805">//&nbsp;a&nbsp;non-nil&nbsp;pointer&nbsp;to&nbsp;data&nbsp;or&nbsp;be&nbsp;an&nbsp;assignable&nbsp;reflect.Value&nbsp;(v.CanSet())</span><br>
<span class="lineno"></span><span class="comment" id="4445881">//&nbsp;If&nbsp;the&nbsp;input&nbsp;is&nbsp;at&nbsp;EOF,&nbsp;DecodeValue&nbsp;returns&nbsp;io.EOF&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4445939">//&nbsp;does&nbsp;not&nbsp;modify&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4445961">func</span>&nbsp;<span class="op" id="4445966">(</span><span class="ident" id="4445967">dec</span>&nbsp;<span class="op" id="4445971">*</span><span class="ident" id="4445972">Decoder</span><span class="op" id="4445979">)</span>&nbsp;<span class="ident" id="4445981">DecodeValue</span><span class="op" id="4445992">(</span><span class="ident" id="4445993">v</span>&nbsp;<span class="ident" id="4445995">reflect</span><span class="op" id="4446002">.</span><span class="ident" id="4446003">Value</span><span class="op" id="4446008">)</span>&nbsp;<span class="builtintype" id="4446010">error</span>&nbsp;<span class="op" id="4446016">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4446019">if</span>&nbsp;<span class="ident" id="4446022">v</span><span class="op" id="4446023">.</span><span class="ident" id="4446024">IsValid</span><span class="op" id="4446031">(</span><span class="op" id="4446032">)</span>&nbsp;<span class="op" id="4446034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4446038">if</span>&nbsp;<span class="ident" id="4446041">v</span><span class="op" id="4446042">.</span><span class="ident" id="4446043">Kind</span><span class="op" id="4446047">(</span><span class="op" id="4446048">)</span>&nbsp;<span class="op" id="4446050">==</span>&nbsp;<span class="ident" id="4446053">reflect</span><span class="op" id="4446060">.</span><span class="ident" id="4446061">Ptr</span>&nbsp;<span class="op" id="4446065">&amp;&amp;</span>&nbsp;<span class="op" id="4446068">!</span><span class="ident" id="4446069">v</span><span class="op" id="4446070">.</span><span class="ident" id="4446071">IsNil</span><span class="op" id="4446076">(</span><span class="op" id="4446077">)</span>&nbsp;<span class="op" id="4446079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4446084">//&nbsp;That&#39;s&nbsp;okay,&nbsp;we&#39;ll&nbsp;store&nbsp;through&nbsp;the&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4446135">}</span>&nbsp;<span class="keyword" id="4446137">else</span>&nbsp;<span class="keyword" id="4446142">if</span>&nbsp;<span class="op" id="4446145">!</span><span class="ident" id="4446146">v</span><span class="op" id="4446147">.</span><span class="ident" id="4446148">CanSet</span><span class="op" id="4446154">(</span><span class="op" id="4446155">)</span>&nbsp;<span class="op" id="4446157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4446162">return</span>&nbsp;<span class="ident" id="4446169">errors</span><span class="op" id="4446175">.</span><span class="ident" id="4446176">New</span><span class="op" id="4446179">(</span><span class="string" id="4446180">&#34;gob:&nbsp;DecodeValue&nbsp;of&nbsp;unassignable&nbsp;value&#34;</span><span class="op" id="4446220">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4446224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4446227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4446230">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446280">dec</span><span class="op" id="4446283">.</span><span class="ident" id="4446284">mutex</span><span class="op" id="4446289">.</span><span class="ident" id="4446290">Lock</span><span class="op" id="4446294">(</span><span class="op" id="4446295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4446298">defer</span>&nbsp;<span class="ident" id="4446304">dec</span><span class="op" id="4446307">.</span><span class="ident" id="4446308">mutex</span><span class="op" id="4446313">.</span><span class="ident" id="4446314">Unlock</span><span class="op" id="4446320">(</span><span class="op" id="4446321">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446325">dec</span><span class="op" id="4446328">.</span><span class="ident" id="4446329">buf</span><span class="op" id="4446332">.</span><span class="ident" id="4446333">Reset</span><span class="op" id="4446338">(</span><span class="op" id="4446339">)</span>&nbsp;<span class="comment" id="4446341">//&nbsp;In&nbsp;case&nbsp;data&nbsp;lingers&nbsp;from&nbsp;previous&nbsp;invocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446392">dec</span><span class="op" id="4446395">.</span><span class="ident" id="4446396">err</span>&nbsp;<span class="op" id="4446400">=</span>&nbsp;<span class="ident" id="4446402">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446407">id</span>&nbsp;<span class="op" id="4446410">:=</span>&nbsp;<span class="ident" id="4446413">dec</span><span class="op" id="4446416">.</span><span class="ident" id="4446417">decodeTypeSequence</span><span class="op" id="4446435">(</span><span class="builtintype" id="4446436">false</span><span class="op" id="4446441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4446444">if</span>&nbsp;<span class="ident" id="4446447">dec</span><span class="op" id="4446450">.</span><span class="ident" id="4446451">err</span>&nbsp;<span class="op" id="4446455">==</span>&nbsp;<span class="ident" id="4446458">nil</span>&nbsp;<span class="op" id="4446462">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4446466">dec</span><span class="op" id="4446469">.</span><span class="ident" id="4446470">decodeValue</span><span class="op" id="4446481">(</span><span class="ident" id="4446482">id</span><span class="op" id="4446484">,</span>&nbsp;<span class="ident" id="4446486">v</span><span class="op" id="4446487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4446490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4446493">return</span>&nbsp;<span class="ident" id="4446500">dec</span><span class="op" id="4446503">.</span><span class="ident" id="4446504">err</span><br>
<span class="lineno"></span><span class="op" id="4446508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="comment" id="4446511">//&nbsp;If&nbsp;debug.go&nbsp;is&nbsp;compiled&nbsp;into&nbsp;the&nbsp;program&nbsp;,&nbsp;debugFunc&nbsp;prints&nbsp;a&nbsp;human-readable</span><br>
<span class="lineno"></span><span class="comment" id="4446591">//&nbsp;representation&nbsp;of&nbsp;the&nbsp;gob&nbsp;data&nbsp;read&nbsp;from&nbsp;r&nbsp;by&nbsp;calling&nbsp;that&nbsp;file&#39;s&nbsp;Debug&nbsp;function.</span><br>
<span class="lineno"></span><span class="comment" id="4446676">//&nbsp;Otherwise&nbsp;it&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4446700">var</span>&nbsp;<span class="ident" id="4446704">debugFunc</span>&nbsp;<span class="keyword" id="4446714">func</span><span class="op" id="4446718">(</span><span class="ident" id="4446719">io</span><span class="op" id="4446721">.</span><span class="ident" id="4446722">Reader</span><span class="op" id="4446728">)</span>
</div>
</body>
</html>
