<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html" class="current">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1501174">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1501229">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1501283">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1501334">package</span>&nbsp;<span class="ident" id="1501342">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1501351">import</span>&nbsp;<span class="op" id="1501358">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1501361">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1501370">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1501373">const</span>&nbsp;<span class="op" id="1501379">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501382">debugMalloc</span>&nbsp;<span class="op" id="1501394">=</span>&nbsp;<span class="builtintype" id="1501396">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501404">flagNoScan</span>&nbsp;<span class="op" id="1501415">=</span>&nbsp;<span class="ident" id="1501417">_FlagNoScan</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501430">flagNoZero</span>&nbsp;<span class="op" id="1501441">=</span>&nbsp;<span class="ident" id="1501443">_FlagNoZero</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501457">maxTinySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1501471">=</span>&nbsp;<span class="ident" id="1501473">_TinySize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501484">tinySizeClass</span>&nbsp;<span class="op" id="1501498">=</span>&nbsp;<span class="ident" id="1501500">_TinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501516">maxSmallSize</span>&nbsp;&nbsp;<span class="op" id="1501530">=</span>&nbsp;<span class="ident" id="1501532">_MaxSmallSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501548">pageShift</span>&nbsp;<span class="op" id="1501558">=</span>&nbsp;<span class="ident" id="1501560">_PageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501572">pageSize</span>&nbsp;&nbsp;<span class="op" id="1501582">=</span>&nbsp;<span class="ident" id="1501584">_PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501595">pageMask</span>&nbsp;&nbsp;<span class="op" id="1501605">=</span>&nbsp;<span class="ident" id="1501607">_PageMask</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501619">bitsPerPointer</span>&nbsp;&nbsp;<span class="op" id="1501635">=</span>&nbsp;<span class="ident" id="1501637">_BitsPerPointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501654">bitsMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501670">=</span>&nbsp;<span class="ident" id="1501672">_BitsMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501683">pointersPerByte</span>&nbsp;<span class="op" id="1501699">=</span>&nbsp;<span class="ident" id="1501701">_PointersPerByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501719">maxGCMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501735">=</span>&nbsp;<span class="ident" id="1501737">_MaxGCMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501749">bitsDead</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501765">=</span>&nbsp;<span class="ident" id="1501767">_BitsDead</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501778">bitsPointer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1501794">=</span>&nbsp;<span class="ident" id="1501796">_BitsPointer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501811">mSpanInUse</span>&nbsp;<span class="op" id="1501822">=</span>&nbsp;<span class="ident" id="1501824">_MSpanInUse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1501838">concurrentSweep</span>&nbsp;<span class="op" id="1501854">=</span>&nbsp;<span class="ident" id="1501856">_ConcurrentSweep</span>&nbsp;<span class="op" id="1501873">!=</span>&nbsp;<span class="num" id="1501876">0</span><br>
<span class="lineno">35</span><span class="op" id="1501878">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1501881">//&nbsp;Page&nbsp;number&nbsp;(address&gt;&gt;pageShift)</span><br>
<span class="lineno"></span><span class="keyword" id="1501917">type</span>&nbsp;<span class="ident" id="1501922">pageID</span>&nbsp;<span class="builtintype" id="1501929">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1501938">//&nbsp;base&nbsp;address&nbsp;for&nbsp;all&nbsp;0-byte&nbsp;allocations</span><br>
<span class="lineno"></span><span class="keyword" id="1501981">var</span>&nbsp;<span class="ident" id="1501985">zerobase</span>&nbsp;<span class="builtintype" id="1501994">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1502003">//&nbsp;Allocate&nbsp;an&nbsp;object&nbsp;of&nbsp;size&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1502040">//&nbsp;Small&nbsp;objects&nbsp;are&nbsp;allocated&nbsp;from&nbsp;the&nbsp;per-P&nbsp;cache&#39;s&nbsp;free&nbsp;lists.</span><br>
<span class="lineno">45</span><span class="comment" id="1502106">//&nbsp;Large&nbsp;objects&nbsp;(&gt;&nbsp;32&nbsp;kB)&nbsp;are&nbsp;allocated&nbsp;straight&nbsp;from&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span><span class="keyword" id="1502171">func</span>&nbsp;<span class="ident" id="1502176">mallocgc</span><span class="op" id="1502184">(</span><span class="ident" id="1502185">size</span>&nbsp;<span class="builtintype" id="1502190">uintptr</span><span class="op" id="1502197">,</span>&nbsp;<span class="ident" id="1502199">typ</span>&nbsp;<span class="op" id="1502203">*</span><span class="ident" id="1502204">_type</span><span class="op" id="1502209">,</span>&nbsp;<span class="ident" id="1502211">flags</span>&nbsp;<span class="builtintype" id="1502217">uint32</span><span class="op" id="1502223">)</span>&nbsp;<span class="ident" id="1502225">unsafe</span><span class="op" id="1502231">.</span><span class="ident" id="1502232">Pointer</span>&nbsp;<span class="op" id="1502240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502243">if</span>&nbsp;<span class="ident" id="1502246">size</span>&nbsp;<span class="op" id="1502251">==</span>&nbsp;<span class="num" id="1502254">0</span>&nbsp;<span class="op" id="1502256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502260">return</span>&nbsp;<span class="ident" id="1502267">unsafe</span><span class="op" id="1502273">.</span><span class="ident" id="1502274">Pointer</span><span class="op" id="1502281">(</span><span class="op" id="1502282">&amp;</span><span class="ident" id="1502283">zerobase</span><span class="op" id="1502291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502294">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502297">size0</span>&nbsp;<span class="op" id="1502303">:=</span>&nbsp;<span class="ident" id="1502306">size</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502313">if</span>&nbsp;<span class="ident" id="1502316">flags</span><span class="op" id="1502321">&amp;</span><span class="ident" id="1502322">flagNoScan</span>&nbsp;<span class="op" id="1502333">==</span>&nbsp;<span class="num" id="1502336">0</span>&nbsp;<span class="op" id="1502338">&amp;&amp;</span>&nbsp;<span class="ident" id="1502341">typ</span>&nbsp;<span class="op" id="1502345">==</span>&nbsp;<span class="builtintype" id="1502348">nil</span>&nbsp;<span class="op" id="1502352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502356">gothrow</span><span class="op" id="1502363">(</span><span class="string" id="1502364">&#34;malloc&nbsp;missing&nbsp;type&#34;</span><span class="op" id="1502385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502388">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502392">//&nbsp;This&nbsp;function&nbsp;must&nbsp;be&nbsp;atomic&nbsp;wrt&nbsp;GC,&nbsp;but&nbsp;for&nbsp;performance&nbsp;reasons</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502461">//&nbsp;we&nbsp;don&#39;t&nbsp;acquirem/releasem&nbsp;on&nbsp;fast&nbsp;path.&nbsp;The&nbsp;code&nbsp;below&nbsp;does&nbsp;not&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502535">//&nbsp;split&nbsp;stack&nbsp;checks,&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;preempted&nbsp;by&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502591">//&nbsp;Functions&nbsp;like&nbsp;roundup/add&nbsp;are&nbsp;inlined.&nbsp;And&nbsp;onM/racemalloc&nbsp;are&nbsp;nosplit.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1502667">//&nbsp;If&nbsp;debugMalloc&nbsp;=&nbsp;true,&nbsp;these&nbsp;assumptions&nbsp;are&nbsp;checked&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502731">if</span>&nbsp;<span class="ident" id="1502734">debugMalloc</span>&nbsp;<span class="op" id="1502746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502750">mp</span>&nbsp;<span class="op" id="1502753">:=</span>&nbsp;<span class="ident" id="1502756">acquirem</span><span class="op" id="1502764">(</span><span class="op" id="1502765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502769">if</span>&nbsp;<span class="ident" id="1502772">mp</span><span class="op" id="1502774">.</span><span class="ident" id="1502775">mallocing</span>&nbsp;<span class="op" id="1502785">!=</span>&nbsp;<span class="num" id="1502788">0</span>&nbsp;<span class="op" id="1502790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502795">gothrow</span><span class="op" id="1502802">(</span><span class="string" id="1502803">&#34;malloc&nbsp;deadlock&#34;</span><span class="op" id="1502820">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502828">mp</span><span class="op" id="1502830">.</span><span class="ident" id="1502831">mallocing</span>&nbsp;<span class="op" id="1502841">=</span>&nbsp;<span class="num" id="1502843">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502847">if</span>&nbsp;<span class="ident" id="1502850">mp</span><span class="op" id="1502852">.</span><span class="ident" id="1502853">curg</span>&nbsp;<span class="op" id="1502858">!=</span>&nbsp;<span class="builtintype" id="1502861">nil</span>&nbsp;<span class="op" id="1502865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502870">mp</span><span class="op" id="1502872">.</span><span class="ident" id="1502873">curg</span><span class="op" id="1502877">.</span><span class="ident" id="1502878">stackguard0</span>&nbsp;<span class="op" id="1502890">=</span>&nbsp;<span class="op" id="1502892">^</span><span class="builtintype" id="1502893">uintptr</span><span class="op" id="1502900">(</span><span class="num" id="1502901">0xfff</span><span class="op" id="1502906">)</span>&nbsp;<span class="op" id="1502908">|</span>&nbsp;<span class="num" id="1502910">0xbad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502918">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1502921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1502925">c</span>&nbsp;<span class="op" id="1502927">:=</span>&nbsp;<span class="ident" id="1502930">gomcache</span><span class="op" id="1502938">(</span><span class="op" id="1502939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502942">var</span>&nbsp;<span class="ident" id="1502946">s</span>&nbsp;<span class="op" id="1502948">*</span><span class="ident" id="1502949">mspan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502956">var</span>&nbsp;<span class="ident" id="1502960">x</span>&nbsp;<span class="ident" id="1502962">unsafe</span><span class="op" id="1502968">.</span><span class="ident" id="1502969">Pointer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1502978">if</span>&nbsp;<span class="ident" id="1502981">size</span>&nbsp;<span class="op" id="1502986">&lt;=</span>&nbsp;<span class="ident" id="1502989">maxSmallSize</span>&nbsp;<span class="op" id="1503002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1503006">if</span>&nbsp;<span class="ident" id="1503009">flags</span><span class="op" id="1503014">&amp;</span><span class="ident" id="1503015">flagNoScan</span>&nbsp;<span class="op" id="1503026">!=</span>&nbsp;<span class="num" id="1503029">0</span>&nbsp;<span class="op" id="1503031">&amp;&amp;</span>&nbsp;<span class="ident" id="1503034">size</span>&nbsp;<span class="op" id="1503039">&lt;</span>&nbsp;<span class="ident" id="1503041">maxTinySize</span>&nbsp;<span class="op" id="1503053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503058">//&nbsp;Tiny&nbsp;allocator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503080">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503086">//&nbsp;Tiny&nbsp;allocator&nbsp;combines&nbsp;several&nbsp;tiny&nbsp;allocation&nbsp;requests</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503149">//&nbsp;into&nbsp;a&nbsp;single&nbsp;memory&nbsp;block.&nbsp;The&nbsp;resulting&nbsp;memory&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503210">//&nbsp;is&nbsp;freed&nbsp;when&nbsp;all&nbsp;subobjects&nbsp;are&nbsp;unreachable.&nbsp;The&nbsp;subobjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503277">//&nbsp;must&nbsp;be&nbsp;FlagNoScan&nbsp;(don&#39;t&nbsp;have&nbsp;pointers),&nbsp;this&nbsp;ensures&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503343">//&nbsp;the&nbsp;amount&nbsp;of&nbsp;potentially&nbsp;wasted&nbsp;memory&nbsp;is&nbsp;bounded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503401">//</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503407">//&nbsp;Size&nbsp;of&nbsp;the&nbsp;memory&nbsp;block&nbsp;used&nbsp;for&nbsp;combining&nbsp;(maxTinySize)&nbsp;is&nbsp;tunable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503483">//&nbsp;Current&nbsp;setting&nbsp;is&nbsp;16&nbsp;bytes,&nbsp;which&nbsp;relates&nbsp;to&nbsp;2x&nbsp;worst&nbsp;case&nbsp;memory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503556">//&nbsp;wastage&nbsp;(when&nbsp;all&nbsp;but&nbsp;one&nbsp;subobjects&nbsp;are&nbsp;unreachable).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503617">//&nbsp;8&nbsp;bytes&nbsp;would&nbsp;result&nbsp;in&nbsp;no&nbsp;wastage&nbsp;at&nbsp;all,&nbsp;but&nbsp;provides&nbsp;less</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503684">//&nbsp;opportunities&nbsp;for&nbsp;combining.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503719">//&nbsp;32&nbsp;bytes&nbsp;provides&nbsp;more&nbsp;opportunities&nbsp;for&nbsp;combining,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503777">//&nbsp;but&nbsp;can&nbsp;lead&nbsp;to&nbsp;4x&nbsp;worst&nbsp;case&nbsp;wastage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503822">//&nbsp;The&nbsp;best&nbsp;case&nbsp;winning&nbsp;is&nbsp;8x&nbsp;regardless&nbsp;of&nbsp;block&nbsp;size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503882">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503888">//&nbsp;Objects&nbsp;obtained&nbsp;from&nbsp;tiny&nbsp;allocator&nbsp;must&nbsp;not&nbsp;be&nbsp;freed&nbsp;explicitly.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1503961">//&nbsp;So&nbsp;when&nbsp;an&nbsp;object&nbsp;will&nbsp;be&nbsp;freed&nbsp;explicitly,&nbsp;we&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504026">//&nbsp;its&nbsp;size&nbsp;&gt;=&nbsp;maxTinySize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504057">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504063">//&nbsp;SetFinalizer&nbsp;has&nbsp;a&nbsp;special&nbsp;case&nbsp;for&nbsp;objects&nbsp;potentially&nbsp;coming</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504132">//&nbsp;from&nbsp;tiny&nbsp;allocator,&nbsp;it&nbsp;such&nbsp;case&nbsp;it&nbsp;allows&nbsp;to&nbsp;set&nbsp;finalizers</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504200">//&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte&nbsp;of&nbsp;a&nbsp;memory&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504243">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504249">//&nbsp;The&nbsp;main&nbsp;targets&nbsp;of&nbsp;tiny&nbsp;allocator&nbsp;are&nbsp;small&nbsp;strings&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504312">//&nbsp;standalone&nbsp;escaping&nbsp;variables.&nbsp;On&nbsp;a&nbsp;json&nbsp;benchmark</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504369">//&nbsp;the&nbsp;allocator&nbsp;reduces&nbsp;number&nbsp;of&nbsp;allocations&nbsp;by&nbsp;~12%&nbsp;and</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504431">//&nbsp;reduces&nbsp;heap&nbsp;size&nbsp;by&nbsp;~20%.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504464">tinysize</span>&nbsp;<span class="op" id="1504473">:=</span>&nbsp;<span class="builtintype" id="1504476">uintptr</span><span class="op" id="1504483">(</span><span class="ident" id="1504484">c</span><span class="op" id="1504485">.</span><span class="ident" id="1504486">tinysize</span><span class="op" id="1504494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504499">if</span>&nbsp;<span class="ident" id="1504502">size</span>&nbsp;<span class="op" id="1504507">&lt;=</span>&nbsp;<span class="ident" id="1504510">tinysize</span>&nbsp;<span class="op" id="1504519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504525">tiny</span>&nbsp;<span class="op" id="1504530">:=</span>&nbsp;<span class="ident" id="1504533">unsafe</span><span class="op" id="1504539">.</span><span class="ident" id="1504540">Pointer</span><span class="op" id="1504547">(</span><span class="ident" id="1504548">c</span><span class="op" id="1504549">.</span><span class="ident" id="1504550">tiny</span><span class="op" id="1504554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504560">//&nbsp;Align&nbsp;tiny&nbsp;pointer&nbsp;for&nbsp;required&nbsp;(conservative)&nbsp;alignment.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504625">if</span>&nbsp;<span class="ident" id="1504628">size</span><span class="op" id="1504632">&amp;</span><span class="num" id="1504633">7</span>&nbsp;<span class="op" id="1504635">==</span>&nbsp;<span class="num" id="1504638">0</span>&nbsp;<span class="op" id="1504640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504647">tiny</span>&nbsp;<span class="op" id="1504652">=</span>&nbsp;<span class="ident" id="1504654">roundup</span><span class="op" id="1504661">(</span><span class="ident" id="1504662">tiny</span><span class="op" id="1504666">,</span>&nbsp;<span class="num" id="1504668">8</span><span class="op" id="1504669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504675">}</span>&nbsp;<span class="keyword" id="1504677">else</span>&nbsp;<span class="keyword" id="1504682">if</span>&nbsp;<span class="ident" id="1504685">size</span><span class="op" id="1504689">&amp;</span><span class="num" id="1504690">3</span>&nbsp;<span class="op" id="1504692">==</span>&nbsp;<span class="num" id="1504695">0</span>&nbsp;<span class="op" id="1504697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504704">tiny</span>&nbsp;<span class="op" id="1504709">=</span>&nbsp;<span class="ident" id="1504711">roundup</span><span class="op" id="1504718">(</span><span class="ident" id="1504719">tiny</span><span class="op" id="1504723">,</span>&nbsp;<span class="num" id="1504725">4</span><span class="op" id="1504726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504732">}</span>&nbsp;<span class="keyword" id="1504734">else</span>&nbsp;<span class="keyword" id="1504739">if</span>&nbsp;<span class="ident" id="1504742">size</span><span class="op" id="1504746">&amp;</span><span class="num" id="1504747">1</span>&nbsp;<span class="op" id="1504749">==</span>&nbsp;<span class="num" id="1504752">0</span>&nbsp;<span class="op" id="1504754">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504761">tiny</span>&nbsp;<span class="op" id="1504766">=</span>&nbsp;<span class="ident" id="1504768">roundup</span><span class="op" id="1504775">(</span><span class="ident" id="1504776">tiny</span><span class="op" id="1504780">,</span>&nbsp;<span class="num" id="1504782">2</span><span class="op" id="1504783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1504789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504795">size1</span>&nbsp;<span class="op" id="1504801">:=</span>&nbsp;<span class="ident" id="1504804">size</span>&nbsp;<span class="op" id="1504809">+</span>&nbsp;<span class="op" id="1504811">(</span><span class="builtintype" id="1504812">uintptr</span><span class="op" id="1504819">(</span><span class="ident" id="1504820">tiny</span><span class="op" id="1504824">)</span>&nbsp;<span class="op" id="1504826">-</span>&nbsp;<span class="builtintype" id="1504828">uintptr</span><span class="op" id="1504835">(</span><span class="ident" id="1504836">unsafe</span><span class="op" id="1504842">.</span><span class="ident" id="1504843">Pointer</span><span class="op" id="1504850">(</span><span class="ident" id="1504851">c</span><span class="op" id="1504852">.</span><span class="ident" id="1504853">tiny</span><span class="op" id="1504857">)</span><span class="op" id="1504858">)</span><span class="op" id="1504859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1504865">if</span>&nbsp;<span class="ident" id="1504868">size1</span>&nbsp;<span class="op" id="1504874">&lt;=</span>&nbsp;<span class="ident" id="1504877">tinysize</span>&nbsp;<span class="op" id="1504886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1504893">//&nbsp;The&nbsp;object&nbsp;fits&nbsp;into&nbsp;existing&nbsp;tiny&nbsp;block.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504943">x</span>&nbsp;<span class="op" id="1504945">=</span>&nbsp;<span class="ident" id="1504947">tiny</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504957">c</span><span class="op" id="1504958">.</span><span class="ident" id="1504959">tiny</span>&nbsp;<span class="op" id="1504964">=</span>&nbsp;<span class="op" id="1504966">(</span><span class="op" id="1504967">*</span><span class="builtintype" id="1504968">byte</span><span class="op" id="1504972">)</span><span class="op" id="1504973">(</span><span class="ident" id="1504974">add</span><span class="op" id="1504977">(</span><span class="ident" id="1504978">x</span><span class="op" id="1504979">,</span>&nbsp;<span class="ident" id="1504981">size</span><span class="op" id="1504985">)</span><span class="op" id="1504986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1504993">c</span><span class="op" id="1504994">.</span><span class="ident" id="1504995">tinysize</span>&nbsp;<span class="op" id="1505004">-=</span>&nbsp;<span class="builtintype" id="1505007">uintptr</span><span class="op" id="1505014">(</span><span class="ident" id="1505015">size1</span><span class="op" id="1505020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505027">c</span><span class="op" id="1505028">.</span><span class="ident" id="1505029">local_tinyallocs</span><span class="op" id="1505045">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505053">if</span>&nbsp;<span class="ident" id="1505056">debugMalloc</span>&nbsp;<span class="op" id="1505068">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505076">mp</span>&nbsp;<span class="op" id="1505079">:=</span>&nbsp;<span class="ident" id="1505082">acquirem</span><span class="op" id="1505090">(</span><span class="op" id="1505091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505099">if</span>&nbsp;<span class="ident" id="1505102">mp</span><span class="op" id="1505104">.</span><span class="ident" id="1505105">mallocing</span>&nbsp;<span class="op" id="1505115">==</span>&nbsp;<span class="num" id="1505118">0</span>&nbsp;<span class="op" id="1505120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505129">gothrow</span><span class="op" id="1505136">(</span><span class="string" id="1505137">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1505149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505165">mp</span><span class="op" id="1505167">.</span><span class="ident" id="1505168">mallocing</span>&nbsp;<span class="op" id="1505178">=</span>&nbsp;<span class="num" id="1505180">0</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505188">if</span>&nbsp;<span class="ident" id="1505191">mp</span><span class="op" id="1505193">.</span><span class="ident" id="1505194">curg</span>&nbsp;<span class="op" id="1505199">!=</span>&nbsp;<span class="builtintype" id="1505202">nil</span>&nbsp;<span class="op" id="1505206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505215">mp</span><span class="op" id="1505217">.</span><span class="ident" id="1505218">curg</span><span class="op" id="1505222">.</span><span class="ident" id="1505223">stackguard0</span>&nbsp;<span class="op" id="1505235">=</span>&nbsp;<span class="ident" id="1505237">mp</span><span class="op" id="1505239">.</span><span class="ident" id="1505240">curg</span><span class="op" id="1505244">.</span><span class="ident" id="1505245">stack</span><span class="op" id="1505250">.</span><span class="ident" id="1505251">lo</span>&nbsp;<span class="op" id="1505254">+</span>&nbsp;<span class="ident" id="1505256">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505282">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505339">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505395">releasem</span><span class="op" id="1505403">(</span><span class="ident" id="1505404">mp</span><span class="op" id="1505406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505414">releasem</span><span class="op" id="1505422">(</span><span class="ident" id="1505423">mp</span><span class="op" id="1505425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505439">return</span>&nbsp;<span class="ident" id="1505446">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505452">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505462">//&nbsp;Allocate&nbsp;a&nbsp;new&nbsp;maxTinySize&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505502">s</span>&nbsp;<span class="op" id="1505504">=</span>&nbsp;<span class="ident" id="1505506">c</span><span class="op" id="1505507">.</span><span class="ident" id="1505508">alloc</span><span class="op" id="1505513">[</span><span class="ident" id="1505514">tinySizeClass</span><span class="op" id="1505527">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505532">v</span>&nbsp;<span class="op" id="1505534">:=</span>&nbsp;<span class="ident" id="1505537">s</span><span class="op" id="1505538">.</span><span class="ident" id="1505539">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505551">if</span>&nbsp;<span class="ident" id="1505554">v</span>&nbsp;<span class="op" id="1505556">==</span>&nbsp;<span class="builtintype" id="1505559">nil</span>&nbsp;<span class="op" id="1505563">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505569">mp</span>&nbsp;<span class="op" id="1505572">:=</span>&nbsp;<span class="ident" id="1505575">acquirem</span><span class="op" id="1505583">(</span><span class="op" id="1505584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505590">mp</span><span class="op" id="1505592">.</span><span class="ident" id="1505593">scalararg</span><span class="op" id="1505602">[</span><span class="num" id="1505603">0</span><span class="op" id="1505604">]</span>&nbsp;<span class="op" id="1505606">=</span>&nbsp;<span class="ident" id="1505608">tinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505626">onM</span><span class="op" id="1505629">(</span><span class="ident" id="1505630">mcacheRefill_m</span><span class="op" id="1505644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505650">releasem</span><span class="op" id="1505658">(</span><span class="ident" id="1505659">mp</span><span class="op" id="1505661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505667">s</span>&nbsp;<span class="op" id="1505669">=</span>&nbsp;<span class="ident" id="1505671">c</span><span class="op" id="1505672">.</span><span class="ident" id="1505673">alloc</span><span class="op" id="1505678">[</span><span class="ident" id="1505679">tinySizeClass</span><span class="op" id="1505692">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505698">v</span>&nbsp;<span class="op" id="1505700">=</span>&nbsp;<span class="ident" id="1505702">s</span><span class="op" id="1505703">.</span><span class="ident" id="1505704">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505721">s</span><span class="op" id="1505722">.</span><span class="ident" id="1505723">freelist</span>&nbsp;<span class="op" id="1505732">=</span>&nbsp;<span class="ident" id="1505734">v</span><span class="op" id="1505735">.</span><span class="ident" id="1505736">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505744">s</span><span class="op" id="1505745">.</span><span class="ident" id="1505746">ref</span><span class="op" id="1505749">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505755">//TODO:&nbsp;prefetch&nbsp;v.next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1505782">x</span>&nbsp;<span class="op" id="1505784">=</span>&nbsp;<span class="ident" id="1505786">unsafe</span><span class="op" id="1505792">.</span><span class="ident" id="1505793">Pointer</span><span class="op" id="1505800">(</span><span class="ident" id="1505801">v</span><span class="op" id="1505802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505807">(</span><span class="op" id="1505808">*</span><span class="op" id="1505809">[</span><span class="num" id="1505810">2</span><span class="op" id="1505811">]</span><span class="builtintype" id="1505812">uint64</span><span class="op" id="1505818">)</span><span class="op" id="1505819">(</span><span class="ident" id="1505820">x</span><span class="op" id="1505821">)</span><span class="op" id="1505822">[</span><span class="num" id="1505823">0</span><span class="op" id="1505824">]</span>&nbsp;<span class="op" id="1505826">=</span>&nbsp;<span class="num" id="1505828">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1505833">(</span><span class="op" id="1505834">*</span><span class="op" id="1505835">[</span><span class="num" id="1505836">2</span><span class="op" id="1505837">]</span><span class="builtintype" id="1505838">uint64</span><span class="op" id="1505844">)</span><span class="op" id="1505845">(</span><span class="ident" id="1505846">x</span><span class="op" id="1505847">)</span><span class="op" id="1505848">[</span><span class="num" id="1505849">1</span><span class="op" id="1505850">]</span>&nbsp;<span class="op" id="1505852">=</span>&nbsp;<span class="num" id="1505854">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505859">//&nbsp;See&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;replace&nbsp;the&nbsp;existing&nbsp;tiny&nbsp;block&nbsp;with&nbsp;the&nbsp;new&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1505932">//&nbsp;based&nbsp;on&nbsp;amount&nbsp;of&nbsp;remaining&nbsp;free&nbsp;space.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1505979">if</span>&nbsp;<span class="ident" id="1505982">maxTinySize</span><span class="op" id="1505993">-</span><span class="ident" id="1505994">size</span>&nbsp;<span class="op" id="1505999">&gt;</span>&nbsp;<span class="ident" id="1506001">tinysize</span>&nbsp;<span class="op" id="1506010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506016">c</span><span class="op" id="1506017">.</span><span class="ident" id="1506018">tiny</span>&nbsp;<span class="op" id="1506023">=</span>&nbsp;<span class="op" id="1506025">(</span><span class="op" id="1506026">*</span><span class="builtintype" id="1506027">byte</span><span class="op" id="1506031">)</span><span class="op" id="1506032">(</span><span class="ident" id="1506033">add</span><span class="op" id="1506036">(</span><span class="ident" id="1506037">x</span><span class="op" id="1506038">,</span>&nbsp;<span class="ident" id="1506040">size</span><span class="op" id="1506044">)</span><span class="op" id="1506045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506051">c</span><span class="op" id="1506052">.</span><span class="ident" id="1506053">tinysize</span>&nbsp;<span class="op" id="1506062">=</span>&nbsp;<span class="builtintype" id="1506064">uintptr</span><span class="op" id="1506071">(</span><span class="ident" id="1506072">maxTinySize</span>&nbsp;<span class="op" id="1506084">-</span>&nbsp;<span class="ident" id="1506086">size</span><span class="op" id="1506090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506100">size</span>&nbsp;<span class="op" id="1506105">=</span>&nbsp;<span class="ident" id="1506107">maxTinySize</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506121">}</span>&nbsp;<span class="keyword" id="1506123">else</span>&nbsp;<span class="op" id="1506128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506133">var</span>&nbsp;<span class="ident" id="1506137">sizeclass</span>&nbsp;<span class="builtintype" id="1506147">int8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506155">if</span>&nbsp;<span class="ident" id="1506158">size</span>&nbsp;<span class="op" id="1506163">&lt;=</span>&nbsp;<span class="num" id="1506166">1024</span><span class="op" id="1506170">-</span><span class="num" id="1506171">8</span>&nbsp;<span class="op" id="1506173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506179">sizeclass</span>&nbsp;<span class="op" id="1506189">=</span>&nbsp;<span class="ident" id="1506191">size_to_class8</span><span class="op" id="1506205">[</span><span class="op" id="1506206">(</span><span class="ident" id="1506207">size</span><span class="op" id="1506211">+</span><span class="num" id="1506212">7</span><span class="op" id="1506213">)</span><span class="op" id="1506214">&gt;&gt;</span><span class="num" id="1506216">3</span><span class="op" id="1506217">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506222">}</span>&nbsp;<span class="keyword" id="1506224">else</span>&nbsp;<span class="op" id="1506229">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506235">sizeclass</span>&nbsp;<span class="op" id="1506245">=</span>&nbsp;<span class="ident" id="1506247">size_to_class128</span><span class="op" id="1506263">[</span><span class="op" id="1506264">(</span><span class="ident" id="1506265">size</span><span class="op" id="1506269">-</span><span class="num" id="1506270">1024</span><span class="op" id="1506274">+</span><span class="num" id="1506275">127</span><span class="op" id="1506278">)</span><span class="op" id="1506279">&gt;&gt;</span><span class="num" id="1506281">7</span><span class="op" id="1506282">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506292">size</span>&nbsp;<span class="op" id="1506297">=</span>&nbsp;<span class="builtintype" id="1506299">uintptr</span><span class="op" id="1506306">(</span><span class="ident" id="1506307">class_to_size</span><span class="op" id="1506320">[</span><span class="ident" id="1506321">sizeclass</span><span class="op" id="1506330">]</span><span class="op" id="1506331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506336">s</span>&nbsp;<span class="op" id="1506338">=</span>&nbsp;<span class="ident" id="1506340">c</span><span class="op" id="1506341">.</span><span class="ident" id="1506342">alloc</span><span class="op" id="1506347">[</span><span class="ident" id="1506348">sizeclass</span><span class="op" id="1506357">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506362">v</span>&nbsp;<span class="op" id="1506364">:=</span>&nbsp;<span class="ident" id="1506367">s</span><span class="op" id="1506368">.</span><span class="ident" id="1506369">freelist</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506381">if</span>&nbsp;<span class="ident" id="1506384">v</span>&nbsp;<span class="op" id="1506386">==</span>&nbsp;<span class="builtintype" id="1506389">nil</span>&nbsp;<span class="op" id="1506393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506399">mp</span>&nbsp;<span class="op" id="1506402">:=</span>&nbsp;<span class="ident" id="1506405">acquirem</span><span class="op" id="1506413">(</span><span class="op" id="1506414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506420">mp</span><span class="op" id="1506422">.</span><span class="ident" id="1506423">scalararg</span><span class="op" id="1506432">[</span><span class="num" id="1506433">0</span><span class="op" id="1506434">]</span>&nbsp;<span class="op" id="1506436">=</span>&nbsp;<span class="builtintype" id="1506438">uintptr</span><span class="op" id="1506445">(</span><span class="ident" id="1506446">sizeclass</span><span class="op" id="1506455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506461">onM</span><span class="op" id="1506464">(</span><span class="ident" id="1506465">mcacheRefill_m</span><span class="op" id="1506479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506485">releasem</span><span class="op" id="1506493">(</span><span class="ident" id="1506494">mp</span><span class="op" id="1506496">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506502">s</span>&nbsp;<span class="op" id="1506504">=</span>&nbsp;<span class="ident" id="1506506">c</span><span class="op" id="1506507">.</span><span class="ident" id="1506508">alloc</span><span class="op" id="1506513">[</span><span class="ident" id="1506514">sizeclass</span><span class="op" id="1506523">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506529">v</span>&nbsp;<span class="op" id="1506531">=</span>&nbsp;<span class="ident" id="1506533">s</span><span class="op" id="1506534">.</span><span class="ident" id="1506535">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506552">s</span><span class="op" id="1506553">.</span><span class="ident" id="1506554">freelist</span>&nbsp;<span class="op" id="1506563">=</span>&nbsp;<span class="ident" id="1506565">v</span><span class="op" id="1506566">.</span><span class="ident" id="1506567">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506575">s</span><span class="op" id="1506576">.</span><span class="ident" id="1506577">ref</span><span class="op" id="1506580">++</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1506586">//TODO:&nbsp;prefetch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506606">x</span>&nbsp;<span class="op" id="1506608">=</span>&nbsp;<span class="ident" id="1506610">unsafe</span><span class="op" id="1506616">.</span><span class="ident" id="1506617">Pointer</span><span class="op" id="1506624">(</span><span class="ident" id="1506625">v</span><span class="op" id="1506626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506631">if</span>&nbsp;<span class="ident" id="1506634">flags</span><span class="op" id="1506639">&amp;</span><span class="ident" id="1506640">flagNoZero</span>&nbsp;<span class="op" id="1506651">==</span>&nbsp;<span class="num" id="1506654">0</span>&nbsp;<span class="op" id="1506656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506662">v</span><span class="op" id="1506663">.</span><span class="ident" id="1506664">next</span>&nbsp;<span class="op" id="1506669">=</span>&nbsp;<span class="builtintype" id="1506671">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1506679">if</span>&nbsp;<span class="ident" id="1506682">size</span>&nbsp;<span class="op" id="1506687">&gt;</span>&nbsp;<span class="num" id="1506689">2</span><span class="op" id="1506690">*</span><span class="ident" id="1506691">ptrSize</span>&nbsp;<span class="op" id="1506699">&amp;&amp;</span>&nbsp;<span class="op" id="1506702">(</span><span class="op" id="1506703">(</span><span class="op" id="1506704">*</span><span class="op" id="1506705">[</span><span class="num" id="1506706">2</span><span class="op" id="1506707">]</span><span class="builtintype" id="1506708">uintptr</span><span class="op" id="1506715">)</span><span class="op" id="1506716">(</span><span class="ident" id="1506717">x</span><span class="op" id="1506718">)</span><span class="op" id="1506719">)</span><span class="op" id="1506720">[</span><span class="num" id="1506721">1</span><span class="op" id="1506722">]</span>&nbsp;<span class="op" id="1506724">!=</span>&nbsp;<span class="num" id="1506727">0</span>&nbsp;<span class="op" id="1506729">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506736">memclr</span><span class="op" id="1506742">(</span><span class="ident" id="1506743">unsafe</span><span class="op" id="1506749">.</span><span class="ident" id="1506750">Pointer</span><span class="op" id="1506757">(</span><span class="ident" id="1506758">v</span><span class="op" id="1506759">)</span><span class="op" id="1506760">,</span>&nbsp;<span class="ident" id="1506762">size</span><span class="op" id="1506766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506785">c</span><span class="op" id="1506786">.</span><span class="ident" id="1506787">local_cachealloc</span>&nbsp;<span class="op" id="1506804">+=</span>&nbsp;<span class="ident" id="1506807">intptr</span><span class="op" id="1506813">(</span><span class="ident" id="1506814">size</span><span class="op" id="1506818">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506821">}</span>&nbsp;<span class="keyword" id="1506823">else</span>&nbsp;<span class="op" id="1506828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506832">mp</span>&nbsp;<span class="op" id="1506835">:=</span>&nbsp;<span class="ident" id="1506838">acquirem</span><span class="op" id="1506846">(</span><span class="op" id="1506847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506851">mp</span><span class="op" id="1506853">.</span><span class="ident" id="1506854">scalararg</span><span class="op" id="1506863">[</span><span class="num" id="1506864">0</span><span class="op" id="1506865">]</span>&nbsp;<span class="op" id="1506867">=</span>&nbsp;<span class="builtintype" id="1506869">uintptr</span><span class="op" id="1506876">(</span><span class="ident" id="1506877">size</span><span class="op" id="1506881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506885">mp</span><span class="op" id="1506887">.</span><span class="ident" id="1506888">scalararg</span><span class="op" id="1506897">[</span><span class="num" id="1506898">1</span><span class="op" id="1506899">]</span>&nbsp;<span class="op" id="1506901">=</span>&nbsp;<span class="builtintype" id="1506903">uintptr</span><span class="op" id="1506910">(</span><span class="ident" id="1506911">flags</span><span class="op" id="1506916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506920">onM</span><span class="op" id="1506923">(</span><span class="ident" id="1506924">largeAlloc_m</span><span class="op" id="1506936">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506940">s</span>&nbsp;<span class="op" id="1506942">=</span>&nbsp;<span class="op" id="1506944">(</span><span class="op" id="1506945">*</span><span class="ident" id="1506946">mspan</span><span class="op" id="1506951">)</span><span class="op" id="1506952">(</span><span class="ident" id="1506953">mp</span><span class="op" id="1506955">.</span><span class="ident" id="1506956">ptrarg</span><span class="op" id="1506962">[</span><span class="num" id="1506963">0</span><span class="op" id="1506964">]</span><span class="op" id="1506965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506969">mp</span><span class="op" id="1506971">.</span><span class="ident" id="1506972">ptrarg</span><span class="op" id="1506978">[</span><span class="num" id="1506979">0</span><span class="op" id="1506980">]</span>&nbsp;<span class="op" id="1506982">=</span>&nbsp;<span class="builtintype" id="1506984">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1506990">releasem</span><span class="op" id="1506998">(</span><span class="ident" id="1506999">mp</span><span class="op" id="1507001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507005">x</span>&nbsp;<span class="op" id="1507007">=</span>&nbsp;<span class="ident" id="1507009">unsafe</span><span class="op" id="1507015">.</span><span class="ident" id="1507016">Pointer</span><span class="op" id="1507023">(</span><span class="builtintype" id="1507024">uintptr</span><span class="op" id="1507031">(</span><span class="ident" id="1507032">s</span><span class="op" id="1507033">.</span><span class="ident" id="1507034">start</span>&nbsp;<span class="op" id="1507040">&lt;&lt;</span>&nbsp;<span class="ident" id="1507043">pageShift</span><span class="op" id="1507052">)</span><span class="op" id="1507053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507057">size</span>&nbsp;<span class="op" id="1507062">=</span>&nbsp;<span class="builtintype" id="1507064">uintptr</span><span class="op" id="1507071">(</span><span class="ident" id="1507072">s</span><span class="op" id="1507073">.</span><span class="ident" id="1507074">elemsize</span><span class="op" id="1507082">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507089">if</span>&nbsp;<span class="ident" id="1507092">flags</span><span class="op" id="1507097">&amp;</span><span class="ident" id="1507098">flagNoScan</span>&nbsp;<span class="op" id="1507109">!=</span>&nbsp;<span class="num" id="1507112">0</span>&nbsp;<span class="op" id="1507114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507118">//&nbsp;All&nbsp;objects&nbsp;are&nbsp;pre-marked&nbsp;as&nbsp;noscan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507161">goto</span>&nbsp;<span class="ident" id="1507166">marked</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507178">//&nbsp;If&nbsp;allocating&nbsp;a&nbsp;defer+arg&nbsp;block,&nbsp;now&nbsp;that&nbsp;we&#39;ve&nbsp;picked&nbsp;a&nbsp;malloc&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507251">//&nbsp;large&nbsp;enough&nbsp;to&nbsp;hold&nbsp;everything,&nbsp;cut&nbsp;the&nbsp;&#34;asked&nbsp;for&#34;&nbsp;size&nbsp;down&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507321">//&nbsp;just&nbsp;the&nbsp;defer&nbsp;header,&nbsp;so&nbsp;that&nbsp;the&nbsp;GC&nbsp;bitmap&nbsp;will&nbsp;record&nbsp;the&nbsp;arg&nbsp;block</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507396">//&nbsp;as&nbsp;containing&nbsp;nothing&nbsp;at&nbsp;all&nbsp;(as&nbsp;if&nbsp;it&nbsp;were&nbsp;unused&nbsp;space&nbsp;at&nbsp;the&nbsp;end&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507471">//&nbsp;a&nbsp;malloc&nbsp;block&nbsp;caused&nbsp;by&nbsp;size&nbsp;rounding).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507516">//&nbsp;The&nbsp;defer&nbsp;arg&nbsp;areas&nbsp;are&nbsp;scanned&nbsp;as&nbsp;part&nbsp;of&nbsp;scanstack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507574">if</span>&nbsp;<span class="ident" id="1507577">typ</span>&nbsp;<span class="op" id="1507581">==</span>&nbsp;<span class="ident" id="1507584">deferType</span>&nbsp;<span class="op" id="1507594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507598">size0</span>&nbsp;<span class="op" id="1507604">=</span>&nbsp;<span class="ident" id="1507606">unsafe</span><span class="op" id="1507612">.</span><span class="ident" id="1507613">Sizeof</span><span class="op" id="1507619">(</span><span class="ident" id="1507620">_defer</span><span class="op" id="1507626">{</span><span class="op" id="1507627">}</span><span class="op" id="1507628">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507635">//&nbsp;From&nbsp;here&nbsp;till&nbsp;marked&nbsp;label&nbsp;marking&nbsp;the&nbsp;object&nbsp;as&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1507699">//&nbsp;and&nbsp;storing&nbsp;type&nbsp;info&nbsp;in&nbsp;the&nbsp;GC&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1507743">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507747">arena_start</span>&nbsp;<span class="op" id="1507759">:=</span>&nbsp;<span class="builtintype" id="1507762">uintptr</span><span class="op" id="1507769">(</span><span class="ident" id="1507770">unsafe</span><span class="op" id="1507776">.</span><span class="ident" id="1507777">Pointer</span><span class="op" id="1507784">(</span><span class="ident" id="1507785">mheap_</span><span class="op" id="1507791">.</span><span class="ident" id="1507792">arena_start</span><span class="op" id="1507803">)</span><span class="op" id="1507804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507808">off</span>&nbsp;<span class="op" id="1507812">:=</span>&nbsp;<span class="op" id="1507815">(</span><span class="builtintype" id="1507816">uintptr</span><span class="op" id="1507823">(</span><span class="ident" id="1507824">x</span><span class="op" id="1507825">)</span>&nbsp;<span class="op" id="1507827">-</span>&nbsp;<span class="ident" id="1507829">arena_start</span><span class="op" id="1507840">)</span>&nbsp;<span class="op" id="1507842">/</span>&nbsp;<span class="ident" id="1507844">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507854">xbits</span>&nbsp;<span class="op" id="1507860">:=</span>&nbsp;<span class="op" id="1507863">(</span><span class="op" id="1507864">*</span><span class="builtintype" id="1507865">uint8</span><span class="op" id="1507870">)</span><span class="op" id="1507871">(</span><span class="ident" id="1507872">unsafe</span><span class="op" id="1507878">.</span><span class="ident" id="1507879">Pointer</span><span class="op" id="1507886">(</span><span class="ident" id="1507887">arena_start</span>&nbsp;<span class="op" id="1507899">-</span>&nbsp;<span class="ident" id="1507901">off</span><span class="op" id="1507904">/</span><span class="ident" id="1507905">wordsPerBitmapByte</span>&nbsp;<span class="op" id="1507924">-</span>&nbsp;<span class="num" id="1507926">1</span><span class="op" id="1507927">)</span><span class="op" id="1507928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1507932">shift</span>&nbsp;<span class="op" id="1507938">:=</span>&nbsp;<span class="op" id="1507941">(</span><span class="ident" id="1507942">off</span>&nbsp;<span class="op" id="1507946">%</span>&nbsp;<span class="ident" id="1507948">wordsPerBitmapByte</span><span class="op" id="1507966">)</span>&nbsp;<span class="op" id="1507968">*</span>&nbsp;<span class="ident" id="1507970">gcBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1507979">if</span>&nbsp;<span class="ident" id="1507982">debugMalloc</span>&nbsp;<span class="op" id="1507994">&amp;&amp;</span>&nbsp;<span class="op" id="1507997">(</span><span class="op" id="1507998">(</span><span class="op" id="1507999">*</span><span class="ident" id="1508000">xbits</span><span class="op" id="1508005">&gt;&gt;</span><span class="ident" id="1508007">shift</span><span class="op" id="1508012">)</span><span class="op" id="1508013">&amp;</span><span class="op" id="1508014">(</span><span class="ident" id="1508015">bitMask</span><span class="op" id="1508022">|</span><span class="ident" id="1508023">bitPtrMask</span><span class="op" id="1508033">)</span><span class="op" id="1508034">)</span>&nbsp;<span class="op" id="1508036">!=</span>&nbsp;<span class="ident" id="1508039">bitBoundary</span>&nbsp;<span class="op" id="1508051">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1508056">println</span><span class="op" id="1508063">(</span><span class="string" id="1508064">&#34;runtime:&nbsp;bits&nbsp;=&#34;</span><span class="op" id="1508081">,</span>&nbsp;<span class="op" id="1508083">(</span><span class="op" id="1508084">*</span><span class="ident" id="1508085">xbits</span><span class="op" id="1508090">&gt;&gt;</span><span class="ident" id="1508092">shift</span><span class="op" id="1508097">)</span><span class="op" id="1508098">&amp;</span><span class="op" id="1508099">(</span><span class="ident" id="1508100">bitMask</span><span class="op" id="1508107">|</span><span class="ident" id="1508108">bitPtrMask</span><span class="op" id="1508118">)</span><span class="op" id="1508119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508124">gothrow</span><span class="op" id="1508131">(</span><span class="string" id="1508132">&#34;bad&nbsp;bits&nbsp;in&nbsp;markallocated&#34;</span><span class="op" id="1508159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508168">var</span>&nbsp;<span class="ident" id="1508172">ti</span><span class="op" id="1508174">,</span>&nbsp;<span class="ident" id="1508176">te</span>&nbsp;<span class="builtintype" id="1508179">uintptr</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508189">var</span>&nbsp;<span class="ident" id="1508193">ptrmask</span>&nbsp;<span class="op" id="1508201">*</span><span class="builtintype" id="1508202">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508210">if</span>&nbsp;<span class="ident" id="1508213">size</span>&nbsp;<span class="op" id="1508218">==</span>&nbsp;<span class="ident" id="1508221">ptrSize</span>&nbsp;<span class="op" id="1508229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1508234">//&nbsp;It&#39;s&nbsp;one&nbsp;word&nbsp;and&nbsp;it&nbsp;has&nbsp;pointers,&nbsp;it&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508297">*</span><span class="ident" id="1508298">xbits</span>&nbsp;<span class="op" id="1508304">|=</span>&nbsp;<span class="op" id="1508307">(</span><span class="ident" id="1508308">bitsPointer</span>&nbsp;<span class="op" id="1508320">&lt;&lt;</span>&nbsp;<span class="num" id="1508323">2</span><span class="op" id="1508324">)</span>&nbsp;<span class="op" id="1508326">&lt;&lt;</span>&nbsp;<span class="ident" id="1508329">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508338">goto</span>&nbsp;<span class="ident" id="1508343">marked</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508356">if</span>&nbsp;<span class="ident" id="1508359">typ</span><span class="op" id="1508362">.</span><span class="ident" id="1508363">kind</span><span class="op" id="1508367">&amp;</span><span class="ident" id="1508368">kindGCProg</span>&nbsp;<span class="op" id="1508379">!=</span>&nbsp;<span class="num" id="1508382">0</span>&nbsp;<span class="op" id="1508384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508389">nptr</span>&nbsp;<span class="op" id="1508394">:=</span>&nbsp;<span class="op" id="1508397">(</span><span class="builtintype" id="1508398">uintptr</span><span class="op" id="1508405">(</span><span class="ident" id="1508406">typ</span><span class="op" id="1508409">.</span><span class="ident" id="1508410">size</span><span class="op" id="1508414">)</span>&nbsp;<span class="op" id="1508416">+</span>&nbsp;<span class="ident" id="1508418">ptrSize</span>&nbsp;<span class="op" id="1508426">-</span>&nbsp;<span class="num" id="1508428">1</span><span class="op" id="1508429">)</span>&nbsp;<span class="op" id="1508431">/</span>&nbsp;<span class="ident" id="1508433">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508444">masksize</span>&nbsp;<span class="op" id="1508453">:=</span>&nbsp;<span class="ident" id="1508456">nptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508464">if</span>&nbsp;<span class="ident" id="1508467">masksize</span><span class="op" id="1508475">%</span><span class="num" id="1508476">2</span>&nbsp;<span class="op" id="1508478">!=</span>&nbsp;<span class="num" id="1508481">0</span>&nbsp;<span class="op" id="1508483">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508489">masksize</span>&nbsp;<span class="op" id="1508498">*=</span>&nbsp;<span class="num" id="1508501">2</span>&nbsp;<span class="comment" id="1508503">//&nbsp;repeated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1508518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508523">masksize</span>&nbsp;<span class="op" id="1508532">=</span>&nbsp;<span class="ident" id="1508534">masksize</span>&nbsp;<span class="op" id="1508543">*</span>&nbsp;<span class="ident" id="1508545">pointersPerByte</span>&nbsp;<span class="op" id="1508561">/</span>&nbsp;<span class="num" id="1508563">8</span>&nbsp;<span class="comment" id="1508565">//&nbsp;4&nbsp;bits&nbsp;per&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508587">masksize</span><span class="op" id="1508595">++</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1508629">//&nbsp;unroll&nbsp;flag&nbsp;in&nbsp;the&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1508664">if</span>&nbsp;<span class="ident" id="1508667">masksize</span>&nbsp;<span class="op" id="1508676">&gt;</span>&nbsp;<span class="ident" id="1508678">maxGCMask</span>&nbsp;<span class="op" id="1508688">&amp;&amp;</span>&nbsp;<span class="ident" id="1508691">typ</span><span class="op" id="1508694">.</span><span class="ident" id="1508695">gc</span><span class="op" id="1508697">[</span><span class="num" id="1508698">1</span><span class="op" id="1508699">]</span>&nbsp;<span class="op" id="1508701">!=</span>&nbsp;<span class="num" id="1508704">0</span>&nbsp;<span class="op" id="1508706">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1508712">//&nbsp;If&nbsp;the&nbsp;mask&nbsp;is&nbsp;too&nbsp;large,&nbsp;unroll&nbsp;the&nbsp;program&nbsp;directly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1508773">//&nbsp;into&nbsp;the&nbsp;GC&nbsp;bitmap.&nbsp;It&#39;s&nbsp;7&nbsp;times&nbsp;slower&nbsp;than&nbsp;copying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1508833">//&nbsp;from&nbsp;the&nbsp;pre-unrolled&nbsp;mask,&nbsp;but&nbsp;saves&nbsp;1/16&nbsp;of&nbsp;type&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1508896">//&nbsp;memory&nbsp;for&nbsp;the&nbsp;mask.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508924">mp</span>&nbsp;<span class="op" id="1508927">:=</span>&nbsp;<span class="ident" id="1508930">acquirem</span><span class="op" id="1508938">(</span><span class="op" id="1508939">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508945">mp</span><span class="op" id="1508947">.</span><span class="ident" id="1508948">ptrarg</span><span class="op" id="1508954">[</span><span class="num" id="1508955">0</span><span class="op" id="1508956">]</span>&nbsp;<span class="op" id="1508958">=</span>&nbsp;<span class="ident" id="1508960">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1508966">mp</span><span class="op" id="1508968">.</span><span class="ident" id="1508969">ptrarg</span><span class="op" id="1508975">[</span><span class="num" id="1508976">1</span><span class="op" id="1508977">]</span>&nbsp;<span class="op" id="1508979">=</span>&nbsp;<span class="ident" id="1508981">unsafe</span><span class="op" id="1508987">.</span><span class="ident" id="1508988">Pointer</span><span class="op" id="1508995">(</span><span class="ident" id="1508996">typ</span><span class="op" id="1508999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509005">mp</span><span class="op" id="1509007">.</span><span class="ident" id="1509008">scalararg</span><span class="op" id="1509017">[</span><span class="num" id="1509018">0</span><span class="op" id="1509019">]</span>&nbsp;<span class="op" id="1509021">=</span>&nbsp;<span class="builtintype" id="1509023">uintptr</span><span class="op" id="1509030">(</span><span class="ident" id="1509031">size</span><span class="op" id="1509035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509041">mp</span><span class="op" id="1509043">.</span><span class="ident" id="1509044">scalararg</span><span class="op" id="1509053">[</span><span class="num" id="1509054">1</span><span class="op" id="1509055">]</span>&nbsp;<span class="op" id="1509057">=</span>&nbsp;<span class="builtintype" id="1509059">uintptr</span><span class="op" id="1509066">(</span><span class="ident" id="1509067">size0</span><span class="op" id="1509072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509078">onM</span><span class="op" id="1509081">(</span><span class="ident" id="1509082">unrollgcproginplace_m</span><span class="op" id="1509103">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509109">releasem</span><span class="op" id="1509117">(</span><span class="ident" id="1509118">mp</span><span class="op" id="1509120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509126">goto</span>&nbsp;<span class="ident" id="1509131">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509146">ptrmask</span>&nbsp;<span class="op" id="1509154">=</span>&nbsp;<span class="op" id="1509156">(</span><span class="op" id="1509157">*</span><span class="builtintype" id="1509158">uint8</span><span class="op" id="1509163">)</span><span class="op" id="1509164">(</span><span class="ident" id="1509165">unsafe</span><span class="op" id="1509171">.</span><span class="ident" id="1509172">Pointer</span><span class="op" id="1509179">(</span><span class="builtintype" id="1509180">uintptr</span><span class="op" id="1509187">(</span><span class="ident" id="1509188">typ</span><span class="op" id="1509191">.</span><span class="ident" id="1509192">gc</span><span class="op" id="1509194">[</span><span class="num" id="1509195">0</span><span class="op" id="1509196">]</span><span class="op" id="1509197">)</span><span class="op" id="1509198">)</span><span class="op" id="1509199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1509204">//&nbsp;Check&nbsp;whether&nbsp;the&nbsp;program&nbsp;is&nbsp;already&nbsp;unrolled.</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509257">if</span>&nbsp;<span class="builtintype" id="1509260">uintptr</span><span class="op" id="1509267">(</span><span class="ident" id="1509268">atomicloadp</span><span class="op" id="1509279">(</span><span class="ident" id="1509280">unsafe</span><span class="op" id="1509286">.</span><span class="ident" id="1509287">Pointer</span><span class="op" id="1509294">(</span><span class="ident" id="1509295">ptrmask</span><span class="op" id="1509302">)</span><span class="op" id="1509303">)</span><span class="op" id="1509304">)</span><span class="op" id="1509305">&amp;</span><span class="num" id="1509306">0xff</span>&nbsp;<span class="op" id="1509311">==</span>&nbsp;<span class="num" id="1509314">0</span>&nbsp;<span class="op" id="1509316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509322">mp</span>&nbsp;<span class="op" id="1509325">:=</span>&nbsp;<span class="ident" id="1509328">acquirem</span><span class="op" id="1509336">(</span><span class="op" id="1509337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509343">mp</span><span class="op" id="1509345">.</span><span class="ident" id="1509346">ptrarg</span><span class="op" id="1509352">[</span><span class="num" id="1509353">0</span><span class="op" id="1509354">]</span>&nbsp;<span class="op" id="1509356">=</span>&nbsp;<span class="ident" id="1509358">unsafe</span><span class="op" id="1509364">.</span><span class="ident" id="1509365">Pointer</span><span class="op" id="1509372">(</span><span class="ident" id="1509373">typ</span><span class="op" id="1509376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509382">onM</span><span class="op" id="1509385">(</span><span class="ident" id="1509386">unrollgcprog_m</span><span class="op" id="1509400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509406">releasem</span><span class="op" id="1509414">(</span><span class="ident" id="1509415">mp</span><span class="op" id="1509417">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509427">ptrmask</span>&nbsp;<span class="op" id="1509435">=</span>&nbsp;<span class="op" id="1509437">(</span><span class="op" id="1509438">*</span><span class="builtintype" id="1509439">uint8</span><span class="op" id="1509444">)</span><span class="op" id="1509445">(</span><span class="ident" id="1509446">add</span><span class="op" id="1509449">(</span><span class="ident" id="1509450">unsafe</span><span class="op" id="1509456">.</span><span class="ident" id="1509457">Pointer</span><span class="op" id="1509464">(</span><span class="ident" id="1509465">ptrmask</span><span class="op" id="1509472">)</span><span class="op" id="1509473">,</span>&nbsp;<span class="num" id="1509475">1</span><span class="op" id="1509476">)</span><span class="op" id="1509477">)</span>&nbsp;<span class="comment" id="1509479">//&nbsp;skip&nbsp;the&nbsp;unroll&nbsp;flag&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509510">}</span>&nbsp;<span class="keyword" id="1509512">else</span>&nbsp;<span class="op" id="1509517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509522">ptrmask</span>&nbsp;<span class="op" id="1509530">=</span>&nbsp;<span class="op" id="1509532">(</span><span class="op" id="1509533">*</span><span class="builtintype" id="1509534">uint8</span><span class="op" id="1509539">)</span><span class="op" id="1509540">(</span><span class="ident" id="1509541">unsafe</span><span class="op" id="1509547">.</span><span class="ident" id="1509548">Pointer</span><span class="op" id="1509555">(</span><span class="ident" id="1509556">typ</span><span class="op" id="1509559">.</span><span class="ident" id="1509560">gc</span><span class="op" id="1509562">[</span><span class="num" id="1509563">0</span><span class="op" id="1509564">]</span><span class="op" id="1509565">)</span><span class="op" id="1509566">)</span>&nbsp;<span class="comment" id="1509568">//&nbsp;pointer&nbsp;to&nbsp;unrolled&nbsp;mask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509598">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509602">if</span>&nbsp;<span class="ident" id="1509605">size</span>&nbsp;<span class="op" id="1509610">==</span>&nbsp;<span class="num" id="1509613">2</span><span class="op" id="1509614">*</span><span class="ident" id="1509615">ptrSize</span>&nbsp;<span class="op" id="1509623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509628">*</span><span class="ident" id="1509629">xbits</span>&nbsp;<span class="op" id="1509635">=</span>&nbsp;<span class="op" id="1509637">*</span><span class="ident" id="1509638">ptrmask</span>&nbsp;<span class="op" id="1509646">|</span>&nbsp;<span class="ident" id="1509648">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509663">goto</span>&nbsp;<span class="ident" id="1509668">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509681">te</span>&nbsp;<span class="op" id="1509684">=</span>&nbsp;<span class="builtintype" id="1509686">uintptr</span><span class="op" id="1509693">(</span><span class="ident" id="1509694">typ</span><span class="op" id="1509697">.</span><span class="ident" id="1509698">size</span><span class="op" id="1509702">)</span>&nbsp;<span class="op" id="1509704">/</span>&nbsp;<span class="ident" id="1509706">ptrSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1509716">//&nbsp;If&nbsp;the&nbsp;type&nbsp;occupies&nbsp;odd&nbsp;number&nbsp;of&nbsp;words,&nbsp;its&nbsp;mask&nbsp;is&nbsp;repeated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509785">if</span>&nbsp;<span class="ident" id="1509788">te</span><span class="op" id="1509790">%</span><span class="num" id="1509791">2</span>&nbsp;<span class="op" id="1509793">==</span>&nbsp;<span class="num" id="1509796">0</span>&nbsp;<span class="op" id="1509798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509803">te</span>&nbsp;<span class="op" id="1509806">/=</span>&nbsp;<span class="num" id="1509809">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1509813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1509817">//&nbsp;Copy&nbsp;pointer&nbsp;bitmask&nbsp;into&nbsp;the&nbsp;bitmap.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509860">for</span>&nbsp;<span class="ident" id="1509864">i</span>&nbsp;<span class="op" id="1509866">:=</span>&nbsp;<span class="builtintype" id="1509869">uintptr</span><span class="op" id="1509876">(</span><span class="num" id="1509877">0</span><span class="op" id="1509878">)</span><span class="op" id="1509879">;</span>&nbsp;<span class="ident" id="1509881">i</span>&nbsp;<span class="op" id="1509883">&lt;</span>&nbsp;<span class="ident" id="1509885">size0</span><span class="op" id="1509890">;</span>&nbsp;<span class="ident" id="1509892">i</span>&nbsp;<span class="op" id="1509894">+=</span>&nbsp;<span class="num" id="1509897">2</span>&nbsp;<span class="op" id="1509899">*</span>&nbsp;<span class="ident" id="1509901">ptrSize</span>&nbsp;<span class="op" id="1509909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509914">v</span>&nbsp;<span class="op" id="1509916">:=</span>&nbsp;<span class="op" id="1509919">*</span><span class="op" id="1509920">(</span><span class="op" id="1509921">*</span><span class="builtintype" id="1509922">uint8</span><span class="op" id="1509927">)</span><span class="op" id="1509928">(</span><span class="ident" id="1509929">add</span><span class="op" id="1509932">(</span><span class="ident" id="1509933">unsafe</span><span class="op" id="1509939">.</span><span class="ident" id="1509940">Pointer</span><span class="op" id="1509947">(</span><span class="ident" id="1509948">ptrmask</span><span class="op" id="1509955">)</span><span class="op" id="1509956">,</span>&nbsp;<span class="ident" id="1509958">ti</span><span class="op" id="1509960">)</span><span class="op" id="1509961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509966">ti</span><span class="op" id="1509968">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1509974">if</span>&nbsp;<span class="ident" id="1509977">ti</span>&nbsp;<span class="op" id="1509980">==</span>&nbsp;<span class="ident" id="1509983">te</span>&nbsp;<span class="op" id="1509986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1509992">ti</span>&nbsp;<span class="op" id="1509995">=</span>&nbsp;<span class="num" id="1509997">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510007">if</span>&nbsp;<span class="ident" id="1510010">i</span>&nbsp;<span class="op" id="1510012">==</span>&nbsp;<span class="num" id="1510015">0</span>&nbsp;<span class="op" id="1510017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510023">v</span>&nbsp;<span class="op" id="1510025">|=</span>&nbsp;<span class="ident" id="1510028">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510048">if</span>&nbsp;<span class="ident" id="1510051">i</span><span class="op" id="1510052">+</span><span class="ident" id="1510053">ptrSize</span>&nbsp;<span class="op" id="1510061">==</span>&nbsp;<span class="ident" id="1510064">size0</span>&nbsp;<span class="op" id="1510070">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510076">v</span>&nbsp;<span class="op" id="1510078">&amp;^=</span>&nbsp;<span class="builtintype" id="1510082">uint8</span><span class="op" id="1510087">(</span><span class="ident" id="1510088">bitPtrMask</span>&nbsp;<span class="op" id="1510099">&lt;&lt;</span>&nbsp;<span class="num" id="1510102">4</span><span class="op" id="1510103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510114">*</span><span class="ident" id="1510115">xbits</span>&nbsp;<span class="op" id="1510121">=</span>&nbsp;<span class="ident" id="1510123">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510128">xbits</span>&nbsp;<span class="op" id="1510134">=</span>&nbsp;<span class="op" id="1510136">(</span><span class="op" id="1510137">*</span><span class="builtintype" id="1510138">byte</span><span class="op" id="1510142">)</span><span class="op" id="1510143">(</span><span class="ident" id="1510144">add</span><span class="op" id="1510147">(</span><span class="ident" id="1510148">unsafe</span><span class="op" id="1510154">.</span><span class="ident" id="1510155">Pointer</span><span class="op" id="1510162">(</span><span class="ident" id="1510163">xbits</span><span class="op" id="1510168">)</span><span class="op" id="1510169">,</span>&nbsp;<span class="op" id="1510171">^</span><span class="builtintype" id="1510172">uintptr</span><span class="op" id="1510179">(</span><span class="num" id="1510180">0</span><span class="op" id="1510181">)</span><span class="op" id="1510182">)</span><span class="op" id="1510183">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510191">if</span>&nbsp;<span class="ident" id="1510194">size0</span><span class="op" id="1510199">%</span><span class="op" id="1510200">(</span><span class="num" id="1510201">2</span><span class="op" id="1510202">*</span><span class="ident" id="1510203">ptrSize</span><span class="op" id="1510210">)</span>&nbsp;<span class="op" id="1510212">==</span>&nbsp;<span class="num" id="1510215">0</span>&nbsp;<span class="op" id="1510217">&amp;&amp;</span>&nbsp;<span class="ident" id="1510220">size0</span>&nbsp;<span class="op" id="1510226">&lt;</span>&nbsp;<span class="ident" id="1510228">size</span>&nbsp;<span class="op" id="1510233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1510238">//&nbsp;Mark&nbsp;the&nbsp;word&nbsp;after&nbsp;last&nbsp;object&#39;s&nbsp;word&nbsp;as&nbsp;bitsDead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510296">*</span><span class="ident" id="1510297">xbits</span>&nbsp;<span class="op" id="1510303">=</span>&nbsp;<span class="ident" id="1510305">bitsDead</span>&nbsp;<span class="op" id="1510314">&lt;&lt;</span>&nbsp;<span class="num" id="1510317">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510321">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510324">}</span><br>
<span class="lineno"></span><span class="ident" id="1510326">marked</span><span class="op" id="1510332">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510335">if</span>&nbsp;<span class="ident" id="1510338">raceenabled</span>&nbsp;<span class="op" id="1510350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510354">racemalloc</span><span class="op" id="1510364">(</span><span class="ident" id="1510365">x</span><span class="op" id="1510366">,</span>&nbsp;<span class="ident" id="1510368">size</span><span class="op" id="1510372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510375">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510379">if</span>&nbsp;<span class="ident" id="1510382">debugMalloc</span>&nbsp;<span class="op" id="1510394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510398">mp</span>&nbsp;<span class="op" id="1510401">:=</span>&nbsp;<span class="ident" id="1510404">acquirem</span><span class="op" id="1510412">(</span><span class="op" id="1510413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510417">if</span>&nbsp;<span class="ident" id="1510420">mp</span><span class="op" id="1510422">.</span><span class="ident" id="1510423">mallocing</span>&nbsp;<span class="op" id="1510433">==</span>&nbsp;<span class="num" id="1510436">0</span>&nbsp;<span class="op" id="1510438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510443">gothrow</span><span class="op" id="1510450">(</span><span class="string" id="1510451">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1510463">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510471">mp</span><span class="op" id="1510473">.</span><span class="ident" id="1510474">mallocing</span>&nbsp;<span class="op" id="1510484">=</span>&nbsp;<span class="num" id="1510486">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510490">if</span>&nbsp;<span class="ident" id="1510493">mp</span><span class="op" id="1510495">.</span><span class="ident" id="1510496">curg</span>&nbsp;<span class="op" id="1510501">!=</span>&nbsp;<span class="builtintype" id="1510504">nil</span>&nbsp;<span class="op" id="1510508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510513">mp</span><span class="op" id="1510515">.</span><span class="ident" id="1510516">curg</span><span class="op" id="1510520">.</span><span class="ident" id="1510521">stackguard0</span>&nbsp;<span class="op" id="1510533">=</span>&nbsp;<span class="ident" id="1510535">mp</span><span class="op" id="1510537">.</span><span class="ident" id="1510538">curg</span><span class="op" id="1510542">.</span><span class="ident" id="1510543">stack</span><span class="op" id="1510548">.</span><span class="ident" id="1510549">lo</span>&nbsp;<span class="op" id="1510552">+</span>&nbsp;<span class="ident" id="1510554">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510568">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1510572">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1510625">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510677">releasem</span><span class="op" id="1510685">(</span><span class="ident" id="1510686">mp</span><span class="op" id="1510688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510692">releasem</span><span class="op" id="1510700">(</span><span class="ident" id="1510701">mp</span><span class="op" id="1510703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510706">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510710">if</span>&nbsp;<span class="ident" id="1510713">debug</span><span class="op" id="1510718">.</span><span class="ident" id="1510719">allocfreetrace</span>&nbsp;<span class="op" id="1510734">!=</span>&nbsp;<span class="num" id="1510737">0</span>&nbsp;<span class="op" id="1510739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510743">tracealloc</span><span class="op" id="1510753">(</span><span class="ident" id="1510754">x</span><span class="op" id="1510755">,</span>&nbsp;<span class="ident" id="1510757">size</span><span class="op" id="1510761">,</span>&nbsp;<span class="ident" id="1510763">typ</span><span class="op" id="1510766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510773">if</span>&nbsp;<span class="ident" id="1510776">rate</span>&nbsp;<span class="op" id="1510781">:=</span>&nbsp;<span class="ident" id="1510784">MemProfileRate</span><span class="op" id="1510798">;</span>&nbsp;<span class="ident" id="1510800">rate</span>&nbsp;<span class="op" id="1510805">&gt;</span>&nbsp;<span class="num" id="1510807">0</span>&nbsp;<span class="op" id="1510809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510813">if</span>&nbsp;<span class="ident" id="1510816">size</span>&nbsp;<span class="op" id="1510821">&lt;</span>&nbsp;<span class="builtintype" id="1510823">uintptr</span><span class="op" id="1510830">(</span><span class="ident" id="1510831">rate</span><span class="op" id="1510835">)</span>&nbsp;<span class="op" id="1510837">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1510840">int32</span><span class="op" id="1510845">(</span><span class="ident" id="1510846">size</span><span class="op" id="1510850">)</span>&nbsp;<span class="op" id="1510852">&lt;</span>&nbsp;<span class="ident" id="1510854">c</span><span class="op" id="1510855">.</span><span class="ident" id="1510856">next_sample</span>&nbsp;<span class="op" id="1510868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510873">c</span><span class="op" id="1510874">.</span><span class="ident" id="1510875">next_sample</span>&nbsp;<span class="op" id="1510887">-=</span>&nbsp;<span class="builtintype" id="1510890">int32</span><span class="op" id="1510895">(</span><span class="ident" id="1510896">size</span><span class="op" id="1510900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510904">}</span>&nbsp;<span class="keyword" id="1510906">else</span>&nbsp;<span class="op" id="1510911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510916">mp</span>&nbsp;<span class="op" id="1510919">:=</span>&nbsp;<span class="ident" id="1510922">acquirem</span><span class="op" id="1510930">(</span><span class="op" id="1510931">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510936">profilealloc</span><span class="op" id="1510948">(</span><span class="ident" id="1510949">mp</span><span class="op" id="1510951">,</span>&nbsp;<span class="ident" id="1510953">x</span><span class="op" id="1510954">,</span>&nbsp;<span class="ident" id="1510956">size</span><span class="op" id="1510960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510965">releasem</span><span class="op" id="1510973">(</span><span class="ident" id="1510974">mp</span><span class="op" id="1510976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1510983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510987">if</span>&nbsp;<span class="ident" id="1510990">memstats</span><span class="op" id="1510998">.</span><span class="ident" id="1510999">heap_alloc</span>&nbsp;<span class="op" id="1511010">&gt;=</span>&nbsp;<span class="ident" id="1511013">memstats</span><span class="op" id="1511021">.</span><span class="ident" id="1511022">next_gc</span>&nbsp;<span class="op" id="1511030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511034">gogc</span><span class="op" id="1511038">(</span><span class="num" id="1511039">0</span><span class="op" id="1511040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511047">return</span>&nbsp;<span class="ident" id="1511054">x</span><br>
<span class="lineno">345</span><span class="op" id="1511056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1511059">//&nbsp;implementation&nbsp;of&nbsp;new&nbsp;builtin</span><br>
<span class="lineno"></span><span class="keyword" id="1511092">func</span>&nbsp;<span class="ident" id="1511097">newobject</span><span class="op" id="1511106">(</span><span class="ident" id="1511107">typ</span>&nbsp;<span class="op" id="1511111">*</span><span class="ident" id="1511112">_type</span><span class="op" id="1511117">)</span>&nbsp;<span class="ident" id="1511119">unsafe</span><span class="op" id="1511125">.</span><span class="ident" id="1511126">Pointer</span>&nbsp;<span class="op" id="1511134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511137">flags</span>&nbsp;<span class="op" id="1511143">:=</span>&nbsp;<span class="builtintype" id="1511146">uint32</span><span class="op" id="1511152">(</span><span class="num" id="1511153">0</span><span class="op" id="1511154">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511157">if</span>&nbsp;<span class="ident" id="1511160">typ</span><span class="op" id="1511163">.</span><span class="ident" id="1511164">kind</span><span class="op" id="1511168">&amp;</span><span class="ident" id="1511169">kindNoPointers</span>&nbsp;<span class="op" id="1511184">!=</span>&nbsp;<span class="num" id="1511187">0</span>&nbsp;<span class="op" id="1511189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511193">flags</span>&nbsp;<span class="op" id="1511199">|=</span>&nbsp;<span class="ident" id="1511202">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511217">return</span>&nbsp;<span class="ident" id="1511224">mallocgc</span><span class="op" id="1511232">(</span><span class="builtintype" id="1511233">uintptr</span><span class="op" id="1511240">(</span><span class="ident" id="1511241">typ</span><span class="op" id="1511244">.</span><span class="ident" id="1511245">size</span><span class="op" id="1511249">)</span><span class="op" id="1511250">,</span>&nbsp;<span class="ident" id="1511252">typ</span><span class="op" id="1511255">,</span>&nbsp;<span class="ident" id="1511257">flags</span><span class="op" id="1511262">)</span><br>
<span class="lineno"></span><span class="op" id="1511264">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="1511267">//&nbsp;implementation&nbsp;of&nbsp;make&nbsp;builtin&nbsp;for&nbsp;slices</span><br>
<span class="lineno"></span><span class="keyword" id="1511312">func</span>&nbsp;<span class="ident" id="1511317">newarray</span><span class="op" id="1511325">(</span><span class="ident" id="1511326">typ</span>&nbsp;<span class="op" id="1511330">*</span><span class="ident" id="1511331">_type</span><span class="op" id="1511336">,</span>&nbsp;<span class="ident" id="1511338">n</span>&nbsp;<span class="builtintype" id="1511340">uintptr</span><span class="op" id="1511347">)</span>&nbsp;<span class="ident" id="1511349">unsafe</span><span class="op" id="1511355">.</span><span class="ident" id="1511356">Pointer</span>&nbsp;<span class="op" id="1511364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511367">flags</span>&nbsp;<span class="op" id="1511373">:=</span>&nbsp;<span class="builtintype" id="1511376">uint32</span><span class="op" id="1511382">(</span><span class="num" id="1511383">0</span><span class="op" id="1511384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511387">if</span>&nbsp;<span class="ident" id="1511390">typ</span><span class="op" id="1511393">.</span><span class="ident" id="1511394">kind</span><span class="op" id="1511398">&amp;</span><span class="ident" id="1511399">kindNoPointers</span>&nbsp;<span class="op" id="1511414">!=</span>&nbsp;<span class="num" id="1511417">0</span>&nbsp;<span class="op" id="1511419">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1511423">flags</span>&nbsp;<span class="op" id="1511429">|=</span>&nbsp;<span class="ident" id="1511432">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511447">if</span>&nbsp;<span class="builtintype" id="1511450">int</span><span class="op" id="1511453">(</span><span class="ident" id="1511454">n</span><span class="op" id="1511455">)</span>&nbsp;<span class="op" id="1511457">&lt;</span>&nbsp;<span class="num" id="1511459">0</span>&nbsp;<span class="op" id="1511461">||</span>&nbsp;<span class="op" id="1511464">(</span><span class="ident" id="1511465">typ</span><span class="op" id="1511468">.</span><span class="ident" id="1511469">size</span>&nbsp;<span class="op" id="1511474">&gt;</span>&nbsp;<span class="num" id="1511476">0</span>&nbsp;<span class="op" id="1511478">&amp;&amp;</span>&nbsp;<span class="ident" id="1511481">n</span>&nbsp;<span class="op" id="1511483">&gt;</span>&nbsp;<span class="ident" id="1511485">maxmem</span><span class="op" id="1511491">/</span><span class="builtintype" id="1511492">uintptr</span><span class="op" id="1511499">(</span><span class="ident" id="1511500">typ</span><span class="op" id="1511503">.</span><span class="ident" id="1511504">size</span><span class="op" id="1511508">)</span><span class="op" id="1511509">)</span>&nbsp;<span class="op" id="1511511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1511515">panic</span><span class="op" id="1511520">(</span><span class="string" id="1511521">&#34;runtime:&nbsp;allocation&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1511560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511563">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511566">return</span>&nbsp;<span class="ident" id="1511573">mallocgc</span><span class="op" id="1511581">(</span><span class="builtintype" id="1511582">uintptr</span><span class="op" id="1511589">(</span><span class="ident" id="1511590">typ</span><span class="op" id="1511593">.</span><span class="ident" id="1511594">size</span><span class="op" id="1511598">)</span><span class="op" id="1511599">*</span><span class="ident" id="1511600">n</span><span class="op" id="1511601">,</span>&nbsp;<span class="ident" id="1511603">typ</span><span class="op" id="1511606">,</span>&nbsp;<span class="ident" id="1511608">flags</span><span class="op" id="1511613">)</span><br>
<span class="lineno"></span><span class="op" id="1511615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1511618">//&nbsp;rawmem&nbsp;returns&nbsp;a&nbsp;chunk&nbsp;of&nbsp;pointerless&nbsp;memory.&nbsp;&nbsp;It&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1511674">//&nbsp;not&nbsp;zeroed.</span><br>
<span class="lineno">370</span><span class="keyword" id="1511689">func</span>&nbsp;<span class="ident" id="1511694">rawmem</span><span class="op" id="1511700">(</span><span class="ident" id="1511701">size</span>&nbsp;<span class="builtintype" id="1511706">uintptr</span><span class="op" id="1511713">)</span>&nbsp;<span class="ident" id="1511715">unsafe</span><span class="op" id="1511721">.</span><span class="ident" id="1511722">Pointer</span>&nbsp;<span class="op" id="1511730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511733">return</span>&nbsp;<span class="ident" id="1511740">mallocgc</span><span class="op" id="1511748">(</span><span class="ident" id="1511749">size</span><span class="op" id="1511753">,</span>&nbsp;<span class="builtintype" id="1511755">nil</span><span class="op" id="1511758">,</span>&nbsp;<span class="ident" id="1511760">flagNoScan</span><span class="op" id="1511770">|</span><span class="ident" id="1511771">flagNoZero</span><span class="op" id="1511781">)</span><br>
<span class="lineno"></span><span class="op" id="1511783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1511786">//&nbsp;round&nbsp;size&nbsp;up&nbsp;to&nbsp;next&nbsp;size&nbsp;class</span><br>
<span class="lineno">375</span><span class="keyword" id="1511822">func</span>&nbsp;<span class="ident" id="1511827">goroundupsize</span><span class="op" id="1511840">(</span><span class="ident" id="1511841">size</span>&nbsp;<span class="builtintype" id="1511846">uintptr</span><span class="op" id="1511853">)</span>&nbsp;<span class="builtintype" id="1511855">uintptr</span>&nbsp;<span class="op" id="1511863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511866">if</span>&nbsp;<span class="ident" id="1511869">size</span>&nbsp;<span class="op" id="1511874">&lt;</span>&nbsp;<span class="ident" id="1511876">maxSmallSize</span>&nbsp;<span class="op" id="1511889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511893">if</span>&nbsp;<span class="ident" id="1511896">size</span>&nbsp;<span class="op" id="1511901">&lt;=</span>&nbsp;<span class="num" id="1511904">1024</span><span class="op" id="1511908">-</span><span class="num" id="1511909">8</span>&nbsp;<span class="op" id="1511911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511916">return</span>&nbsp;<span class="builtintype" id="1511923">uintptr</span><span class="op" id="1511930">(</span><span class="ident" id="1511931">class_to_size</span><span class="op" id="1511944">[</span><span class="ident" id="1511945">size_to_class8</span><span class="op" id="1511959">[</span><span class="op" id="1511960">(</span><span class="ident" id="1511961">size</span><span class="op" id="1511965">+</span><span class="num" id="1511966">7</span><span class="op" id="1511967">)</span><span class="op" id="1511968">&gt;&gt;</span><span class="num" id="1511970">3</span><span class="op" id="1511971">]</span><span class="op" id="1511972">]</span><span class="op" id="1511973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1511977">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1511981">return</span>&nbsp;<span class="builtintype" id="1511988">uintptr</span><span class="op" id="1511995">(</span><span class="ident" id="1511996">class_to_size</span><span class="op" id="1512009">[</span><span class="ident" id="1512010">size_to_class128</span><span class="op" id="1512026">[</span><span class="op" id="1512027">(</span><span class="ident" id="1512028">size</span><span class="op" id="1512032">-</span><span class="num" id="1512033">1024</span><span class="op" id="1512037">+</span><span class="num" id="1512038">127</span><span class="op" id="1512041">)</span><span class="op" id="1512042">&gt;&gt;</span><span class="num" id="1512044">7</span><span class="op" id="1512045">]</span><span class="op" id="1512046">]</span><span class="op" id="1512047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512053">if</span>&nbsp;<span class="ident" id="1512056">size</span><span class="op" id="1512060">+</span><span class="ident" id="1512061">pageSize</span>&nbsp;<span class="op" id="1512070">&lt;</span>&nbsp;<span class="ident" id="1512072">size</span>&nbsp;<span class="op" id="1512077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512081">return</span>&nbsp;<span class="ident" id="1512088">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512094">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512097">return</span>&nbsp;<span class="op" id="1512104">(</span><span class="ident" id="1512105">size</span>&nbsp;<span class="op" id="1512110">+</span>&nbsp;<span class="ident" id="1512112">pageSize</span>&nbsp;<span class="op" id="1512121">-</span>&nbsp;<span class="num" id="1512123">1</span><span class="op" id="1512124">)</span>&nbsp;<span class="op" id="1512126">&amp;^</span>&nbsp;<span class="ident" id="1512129">pageMask</span><br>
<span class="lineno"></span><span class="op" id="1512138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1512141">func</span>&nbsp;<span class="ident" id="1512146">profilealloc</span><span class="op" id="1512158">(</span><span class="ident" id="1512159">mp</span>&nbsp;<span class="op" id="1512162">*</span><span class="ident" id="1512163">m</span><span class="op" id="1512164">,</span>&nbsp;<span class="ident" id="1512166">x</span>&nbsp;<span class="ident" id="1512168">unsafe</span><span class="op" id="1512174">.</span><span class="ident" id="1512175">Pointer</span><span class="op" id="1512182">,</span>&nbsp;<span class="ident" id="1512184">size</span>&nbsp;<span class="builtintype" id="1512189">uintptr</span><span class="op" id="1512196">)</span>&nbsp;<span class="op" id="1512198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512201">c</span>&nbsp;<span class="op" id="1512203">:=</span>&nbsp;<span class="ident" id="1512206">mp</span><span class="op" id="1512208">.</span><span class="ident" id="1512209">mcache</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512217">rate</span>&nbsp;<span class="op" id="1512222">:=</span>&nbsp;<span class="ident" id="1512225">MemProfileRate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512241">if</span>&nbsp;<span class="ident" id="1512244">size</span>&nbsp;<span class="op" id="1512249">&lt;</span>&nbsp;<span class="builtintype" id="1512251">uintptr</span><span class="op" id="1512258">(</span><span class="ident" id="1512259">rate</span><span class="op" id="1512263">)</span>&nbsp;<span class="op" id="1512265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1512269">//&nbsp;pick&nbsp;next&nbsp;profile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1512297">//&nbsp;If&nbsp;you&nbsp;change&nbsp;this,&nbsp;also&nbsp;change&nbsp;allocmcache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512347">if</span>&nbsp;<span class="ident" id="1512350">rate</span>&nbsp;<span class="op" id="1512355">&gt;</span>&nbsp;<span class="num" id="1512357">0x3fffffff</span>&nbsp;<span class="op" id="1512368">{</span>&nbsp;<span class="comment" id="1512370">//&nbsp;make&nbsp;2*rate&nbsp;not&nbsp;overflow</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512401">rate</span>&nbsp;<span class="op" id="1512406">=</span>&nbsp;<span class="num" id="1512408">0x3fffffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512425">next</span>&nbsp;<span class="op" id="1512430">:=</span>&nbsp;<span class="builtintype" id="1512433">int32</span><span class="op" id="1512438">(</span><span class="ident" id="1512439">fastrand1</span><span class="op" id="1512448">(</span><span class="op" id="1512449">)</span><span class="op" id="1512450">)</span>&nbsp;<span class="op" id="1512452">%</span>&nbsp;<span class="op" id="1512454">(</span><span class="num" id="1512455">2</span>&nbsp;<span class="op" id="1512457">*</span>&nbsp;<span class="builtintype" id="1512459">int32</span><span class="op" id="1512464">(</span><span class="ident" id="1512465">rate</span><span class="op" id="1512469">)</span><span class="op" id="1512470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1512474">//&nbsp;Subtract&nbsp;the&nbsp;&#34;remainder&#34;&nbsp;of&nbsp;the&nbsp;current&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1512531">//&nbsp;Otherwise&nbsp;objects&nbsp;that&nbsp;are&nbsp;close&nbsp;in&nbsp;size&nbsp;to&nbsp;sampling&nbsp;rate</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1512594">//&nbsp;will&nbsp;be&nbsp;under-sampled,&nbsp;because&nbsp;we&nbsp;consistently&nbsp;discard&nbsp;this&nbsp;remainder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512670">next</span>&nbsp;<span class="op" id="1512675">-=</span>&nbsp;<span class="op" id="1512678">(</span><span class="builtintype" id="1512679">int32</span><span class="op" id="1512684">(</span><span class="ident" id="1512685">size</span><span class="op" id="1512689">)</span>&nbsp;<span class="op" id="1512691">-</span>&nbsp;<span class="ident" id="1512693">c</span><span class="op" id="1512694">.</span><span class="ident" id="1512695">next_sample</span><span class="op" id="1512706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1512710">if</span>&nbsp;<span class="ident" id="1512713">next</span>&nbsp;<span class="op" id="1512718">&lt;</span>&nbsp;<span class="num" id="1512720">0</span>&nbsp;<span class="op" id="1512722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512727">next</span>&nbsp;<span class="op" id="1512732">=</span>&nbsp;<span class="num" id="1512734">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512738">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512742">c</span><span class="op" id="1512743">.</span><span class="ident" id="1512744">next_sample</span>&nbsp;<span class="op" id="1512756">=</span>&nbsp;<span class="ident" id="1512758">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1512764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1512768">mProf_Malloc</span><span class="op" id="1512780">(</span><span class="ident" id="1512781">x</span><span class="op" id="1512782">,</span>&nbsp;<span class="ident" id="1512784">size</span><span class="op" id="1512788">)</span><br>
<span class="lineno"></span><span class="op" id="1512790">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="1512793">//&nbsp;force&nbsp;=&nbsp;1&nbsp;-&nbsp;do&nbsp;GC&nbsp;regardless&nbsp;of&nbsp;current&nbsp;heap&nbsp;usage</span><br>
<span class="lineno"></span><span class="comment" id="1512847">//&nbsp;force&nbsp;=&nbsp;2&nbsp;-&nbsp;go&nbsp;GC&nbsp;and&nbsp;eager&nbsp;sweep</span><br>
<span class="lineno"></span><span class="keyword" id="1512884">func</span>&nbsp;<span class="ident" id="1512889">gogc</span><span class="op" id="1512893">(</span><span class="ident" id="1512894">force</span>&nbsp;<span class="builtintype" id="1512900">int32</span><span class="op" id="1512905">)</span>&nbsp;<span class="op" id="1512907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1512910">//&nbsp;The&nbsp;gc&nbsp;is&nbsp;turned&nbsp;off&nbsp;(via&nbsp;enablegc)&nbsp;until&nbsp;the&nbsp;bootstrap&nbsp;has&nbsp;completed.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1512985">//&nbsp;Also,&nbsp;malloc&nbsp;gets&nbsp;called&nbsp;in&nbsp;the&nbsp;guts&nbsp;of&nbsp;a&nbsp;number&nbsp;of&nbsp;libraries&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513065">//&nbsp;holding&nbsp;locks.&nbsp;To&nbsp;avoid&nbsp;deadlocks&nbsp;during&nbsp;stoptheworld,&nbsp;don&#39;t&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513137">//&nbsp;trying&nbsp;to&nbsp;run&nbsp;gc&nbsp;while&nbsp;holding&nbsp;a&nbsp;lock.&nbsp;The&nbsp;next&nbsp;mallocgc&nbsp;without&nbsp;a&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513213">//&nbsp;will&nbsp;do&nbsp;the&nbsp;gc&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513241">mp</span>&nbsp;<span class="op" id="1513244">:=</span>&nbsp;<span class="ident" id="1513247">acquirem</span><span class="op" id="1513255">(</span><span class="op" id="1513256">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513259">if</span>&nbsp;<span class="ident" id="1513262">gp</span>&nbsp;<span class="op" id="1513265">:=</span>&nbsp;<span class="ident" id="1513268">getg</span><span class="op" id="1513272">(</span><span class="op" id="1513273">)</span><span class="op" id="1513274">;</span>&nbsp;<span class="ident" id="1513276">gp</span>&nbsp;<span class="op" id="1513279">==</span>&nbsp;<span class="ident" id="1513282">mp</span><span class="op" id="1513284">.</span><span class="ident" id="1513285">g0</span>&nbsp;<span class="op" id="1513288">||</span>&nbsp;<span class="ident" id="1513291">mp</span><span class="op" id="1513293">.</span><span class="ident" id="1513294">locks</span>&nbsp;<span class="op" id="1513300">&gt;</span>&nbsp;<span class="num" id="1513302">1</span>&nbsp;<span class="op" id="1513304">||</span>&nbsp;<span class="op" id="1513307">!</span><span class="ident" id="1513308">memstats</span><span class="op" id="1513316">.</span><span class="ident" id="1513317">enablegc</span>&nbsp;<span class="op" id="1513326">||</span>&nbsp;<span class="ident" id="1513329">panicking</span>&nbsp;<span class="op" id="1513339">!=</span>&nbsp;<span class="num" id="1513342">0</span>&nbsp;<span class="op" id="1513344">||</span>&nbsp;<span class="ident" id="1513347">gcpercent</span>&nbsp;<span class="op" id="1513357">&lt;</span>&nbsp;<span class="num" id="1513359">0</span>&nbsp;<span class="op" id="1513361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513365">releasem</span><span class="op" id="1513373">(</span><span class="ident" id="1513374">mp</span><span class="op" id="1513376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513380">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513391">releasem</span><span class="op" id="1513399">(</span><span class="ident" id="1513400">mp</span><span class="op" id="1513402">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513405">mp</span>&nbsp;<span class="op" id="1513408">=</span>&nbsp;<span class="builtintype" id="1513410">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513416">semacquire</span><span class="op" id="1513426">(</span><span class="op" id="1513427">&amp;</span><span class="ident" id="1513428">worldsema</span><span class="op" id="1513437">,</span>&nbsp;<span class="builtintype" id="1513439">false</span><span class="op" id="1513444">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513448">if</span>&nbsp;<span class="ident" id="1513451">force</span>&nbsp;<span class="op" id="1513457">==</span>&nbsp;<span class="num" id="1513460">0</span>&nbsp;<span class="op" id="1513462">&amp;&amp;</span>&nbsp;<span class="ident" id="1513465">memstats</span><span class="op" id="1513473">.</span><span class="ident" id="1513474">heap_alloc</span>&nbsp;<span class="op" id="1513485">&lt;</span>&nbsp;<span class="ident" id="1513487">memstats</span><span class="op" id="1513495">.</span><span class="ident" id="1513496">next_gc</span>&nbsp;<span class="op" id="1513504">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513508">//&nbsp;typically&nbsp;threads&nbsp;which&nbsp;lost&nbsp;the&nbsp;race&nbsp;to&nbsp;grab</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513559">//&nbsp;worldsema&nbsp;exit&nbsp;here&nbsp;when&nbsp;gc&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513601">semrelease</span><span class="op" id="1513611">(</span><span class="op" id="1513612">&amp;</span><span class="ident" id="1513613">worldsema</span><span class="op" id="1513622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513626">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513634">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513638">//&nbsp;Ok,&nbsp;we&#39;re&nbsp;doing&nbsp;it!&nbsp;&nbsp;Stop&nbsp;everybody&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513683">startTime</span>&nbsp;<span class="op" id="1513693">:=</span>&nbsp;<span class="ident" id="1513696">nanotime</span><span class="op" id="1513704">(</span><span class="op" id="1513705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513708">mp</span>&nbsp;<span class="op" id="1513711">=</span>&nbsp;<span class="ident" id="1513713">acquirem</span><span class="op" id="1513721">(</span><span class="op" id="1513722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513725">mp</span><span class="op" id="1513727">.</span><span class="ident" id="1513728">gcing</span>&nbsp;<span class="op" id="1513734">=</span>&nbsp;<span class="num" id="1513736">1</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513739">releasem</span><span class="op" id="1513747">(</span><span class="ident" id="1513748">mp</span><span class="op" id="1513750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513753">onM</span><span class="op" id="1513756">(</span><span class="ident" id="1513757">stoptheworld</span><span class="op" id="1513769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1513772">if</span>&nbsp;<span class="ident" id="1513775">mp</span>&nbsp;<span class="op" id="1513778">!=</span>&nbsp;<span class="ident" id="1513781">acquirem</span><span class="op" id="1513789">(</span><span class="op" id="1513790">)</span>&nbsp;<span class="op" id="1513792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513796">gothrow</span><span class="op" id="1513803">(</span><span class="string" id="1513804">&#34;gogc:&nbsp;rescheduled&#34;</span><span class="op" id="1513823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1513826">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1513830">clearpools</span><span class="op" id="1513840">(</span><span class="op" id="1513841">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513845">//&nbsp;Run&nbsp;gc&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;so&nbsp;that&nbsp;the&nbsp;g&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513905">//&nbsp;we&#39;re&nbsp;currently&nbsp;running&nbsp;on&nbsp;will&nbsp;no&nbsp;longer&nbsp;change.&nbsp;&nbsp;Cuts</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1513965">//&nbsp;the&nbsp;root&nbsp;set&nbsp;down&nbsp;a&nbsp;bit&nbsp;(g0&nbsp;stacks&nbsp;are&nbsp;not&nbsp;scanned,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514025">//&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;scan&nbsp;gc&#39;s&nbsp;internal&nbsp;state).&nbsp;&nbsp;We&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514082">//&nbsp;need&nbsp;to&nbsp;switch&nbsp;to&nbsp;g0&nbsp;so&nbsp;we&nbsp;can&nbsp;shrink&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514135">n</span>&nbsp;<span class="op" id="1514137">:=</span>&nbsp;<span class="num" id="1514140">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514143">if</span>&nbsp;<span class="ident" id="1514146">debug</span><span class="op" id="1514151">.</span><span class="ident" id="1514152">gctrace</span>&nbsp;<span class="op" id="1514160">&gt;</span>&nbsp;<span class="num" id="1514162">1</span>&nbsp;<span class="op" id="1514164">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514168">n</span>&nbsp;<span class="op" id="1514170">=</span>&nbsp;<span class="num" id="1514172">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514178">for</span>&nbsp;<span class="ident" id="1514182">i</span>&nbsp;<span class="op" id="1514184">:=</span>&nbsp;<span class="num" id="1514187">0</span><span class="op" id="1514188">;</span>&nbsp;<span class="ident" id="1514190">i</span>&nbsp;<span class="op" id="1514192">&lt;</span>&nbsp;<span class="ident" id="1514194">n</span><span class="op" id="1514195">;</span>&nbsp;<span class="ident" id="1514197">i</span><span class="op" id="1514198">++</span>&nbsp;<span class="op" id="1514201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514205">if</span>&nbsp;<span class="ident" id="1514208">i</span>&nbsp;<span class="op" id="1514210">&gt;</span>&nbsp;<span class="num" id="1514212">0</span>&nbsp;<span class="op" id="1514214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514219">startTime</span>&nbsp;<span class="op" id="1514229">=</span>&nbsp;<span class="ident" id="1514231">nanotime</span><span class="op" id="1514239">(</span><span class="op" id="1514240">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514248">//&nbsp;switch&nbsp;to&nbsp;g0,&nbsp;call&nbsp;gc,&nbsp;then&nbsp;switch&nbsp;back</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514293">mp</span><span class="op" id="1514295">.</span><span class="ident" id="1514296">scalararg</span><span class="op" id="1514305">[</span><span class="num" id="1514306">0</span><span class="op" id="1514307">]</span>&nbsp;<span class="op" id="1514309">=</span>&nbsp;<span class="builtintype" id="1514311">uintptr</span><span class="op" id="1514318">(</span><span class="builtintype" id="1514319">uint32</span><span class="op" id="1514325">(</span><span class="ident" id="1514326">startTime</span><span class="op" id="1514335">)</span><span class="op" id="1514336">)</span>&nbsp;<span class="comment" id="1514338">//&nbsp;low&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514355">mp</span><span class="op" id="1514357">.</span><span class="ident" id="1514358">scalararg</span><span class="op" id="1514367">[</span><span class="num" id="1514368">1</span><span class="op" id="1514369">]</span>&nbsp;<span class="op" id="1514371">=</span>&nbsp;<span class="builtintype" id="1514373">uintptr</span><span class="op" id="1514380">(</span><span class="ident" id="1514381">startTime</span>&nbsp;<span class="op" id="1514391">&gt;&gt;</span>&nbsp;<span class="num" id="1514394">32</span><span class="op" id="1514396">)</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1514400">//&nbsp;high&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514418">if</span>&nbsp;<span class="ident" id="1514421">force</span>&nbsp;<span class="op" id="1514427">&gt;=</span>&nbsp;<span class="num" id="1514430">2</span>&nbsp;<span class="op" id="1514432">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514437">mp</span><span class="op" id="1514439">.</span><span class="ident" id="1514440">scalararg</span><span class="op" id="1514449">[</span><span class="num" id="1514450">2</span><span class="op" id="1514451">]</span>&nbsp;<span class="op" id="1514453">=</span>&nbsp;<span class="num" id="1514455">1</span>&nbsp;<span class="comment" id="1514457">//&nbsp;eagersweep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514473">}</span>&nbsp;<span class="keyword" id="1514475">else</span>&nbsp;<span class="op" id="1514480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514485">mp</span><span class="op" id="1514487">.</span><span class="ident" id="1514488">scalararg</span><span class="op" id="1514497">[</span><span class="num" id="1514498">2</span><span class="op" id="1514499">]</span>&nbsp;<span class="op" id="1514501">=</span>&nbsp;<span class="num" id="1514503">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514511">onM</span><span class="op" id="1514514">(</span><span class="ident" id="1514515">gc_m</span><span class="op" id="1514519">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514526">//&nbsp;all&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514539">mp</span><span class="op" id="1514541">.</span><span class="ident" id="1514542">gcing</span>&nbsp;<span class="op" id="1514548">=</span>&nbsp;<span class="num" id="1514550">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514553">semrelease</span><span class="op" id="1514563">(</span><span class="op" id="1514564">&amp;</span><span class="ident" id="1514565">worldsema</span><span class="op" id="1514574">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514577">onM</span><span class="op" id="1514580">(</span><span class="ident" id="1514581">starttheworld</span><span class="op" id="1514594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514597">releasem</span><span class="op" id="1514605">(</span><span class="ident" id="1514606">mp</span><span class="op" id="1514608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514611">mp</span>&nbsp;<span class="op" id="1514614">=</span>&nbsp;<span class="builtintype" id="1514616">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514622">//&nbsp;now&nbsp;that&nbsp;gc&nbsp;is&nbsp;done,&nbsp;kick&nbsp;off&nbsp;finalizer&nbsp;thread&nbsp;if&nbsp;needed</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1514683">if</span>&nbsp;<span class="op" id="1514686">!</span><span class="ident" id="1514687">concurrentSweep</span>&nbsp;<span class="op" id="1514703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1514707">//&nbsp;give&nbsp;the&nbsp;queued&nbsp;finalizers,&nbsp;if&nbsp;any,&nbsp;a&nbsp;chance&nbsp;to&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514764">Gosched</span><span class="op" id="1514771">(</span><span class="op" id="1514772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1514775">}</span><br>
<span class="lineno"></span><span class="op" id="1514777">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="1514780">//&nbsp;GC&nbsp;runs&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span><span class="keyword" id="1514813">func</span>&nbsp;<span class="ident" id="1514818">GC</span><span class="op" id="1514820">(</span><span class="op" id="1514821">)</span>&nbsp;<span class="op" id="1514823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1514826">gogc</span><span class="op" id="1514830">(</span><span class="num" id="1514831">2</span><span class="op" id="1514832">)</span><br>
<span class="lineno"></span><span class="op" id="1514834">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="comment" id="1514837">//&nbsp;linker-provided</span><br>
<span class="lineno"></span><span class="keyword" id="1514856">var</span>&nbsp;<span class="ident" id="1514860">noptrdata</span>&nbsp;<span class="keyword" id="1514870">struct</span><span class="op" id="1514876">{</span><span class="op" id="1514877">}</span><br>
<span class="lineno"></span><span class="keyword" id="1514879">var</span>&nbsp;<span class="ident" id="1514883">enoptrdata</span>&nbsp;<span class="keyword" id="1514894">struct</span><span class="op" id="1514900">{</span><span class="op" id="1514901">}</span><br>
<span class="lineno"></span><span class="keyword" id="1514903">var</span>&nbsp;<span class="ident" id="1514907">noptrbss</span>&nbsp;<span class="keyword" id="1514916">struct</span><span class="op" id="1514922">{</span><span class="op" id="1514923">}</span><br>
<span class="lineno">495</span><span class="keyword" id="1514925">var</span>&nbsp;<span class="ident" id="1514929">enoptrbss</span>&nbsp;<span class="keyword" id="1514939">struct</span><span class="op" id="1514945">{</span><span class="op" id="1514946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1514949">//&nbsp;SetFinalizer&nbsp;sets&nbsp;the&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span><span class="comment" id="1515008">//&nbsp;When&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;finds&nbsp;an&nbsp;unreachable&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="1515065">//&nbsp;with&nbsp;an&nbsp;associated&nbsp;finalizer,&nbsp;it&nbsp;clears&nbsp;the&nbsp;association&nbsp;and&nbsp;runs</span><br>
<span class="lineno">500</span><span class="comment" id="1515133">//&nbsp;f(x)&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine.&nbsp;&nbsp;This&nbsp;makes&nbsp;x&nbsp;reachable&nbsp;again,&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="1515201">//&nbsp;now&nbsp;without&nbsp;an&nbsp;associated&nbsp;finalizer.&nbsp;&nbsp;Assuming&nbsp;that&nbsp;SetFinalizer</span><br>
<span class="lineno"></span><span class="comment" id="1515269">//&nbsp;is&nbsp;not&nbsp;called&nbsp;again,&nbsp;the&nbsp;next&nbsp;time&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;sees</span><br>
<span class="lineno"></span><span class="comment" id="1515334">//&nbsp;that&nbsp;x&nbsp;is&nbsp;unreachable,&nbsp;it&nbsp;will&nbsp;free&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1515376">//</span><br>
<span class="lineno">505</span><span class="comment" id="1515379">//&nbsp;SetFinalizer(x,&nbsp;nil)&nbsp;clears&nbsp;any&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1515443">//</span><br>
<span class="lineno"></span><span class="comment" id="1515446">//&nbsp;The&nbsp;argument&nbsp;x&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;object&nbsp;allocated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="1515508">//&nbsp;calling&nbsp;new&nbsp;or&nbsp;by&nbsp;taking&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;composite&nbsp;literal.</span><br>
<span class="lineno"></span><span class="comment" id="1515572">//&nbsp;The&nbsp;argument&nbsp;f&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;that&nbsp;takes&nbsp;a&nbsp;single&nbsp;argument</span><br>
<span class="lineno">510</span><span class="comment" id="1515638">//&nbsp;to&nbsp;which&nbsp;x&#39;s&nbsp;type&nbsp;can&nbsp;be&nbsp;assigned,&nbsp;and&nbsp;can&nbsp;have&nbsp;arbitrary&nbsp;ignored&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="1515714">//&nbsp;values.&nbsp;If&nbsp;either&nbsp;of&nbsp;these&nbsp;is&nbsp;not&nbsp;true,&nbsp;SetFinalizer&nbsp;aborts&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1515781">//&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1515793">//</span><br>
<span class="lineno"></span><span class="comment" id="1515796">//&nbsp;Finalizers&nbsp;are&nbsp;run&nbsp;in&nbsp;dependency&nbsp;order:&nbsp;if&nbsp;A&nbsp;points&nbsp;at&nbsp;B,&nbsp;both&nbsp;have</span><br>
<span class="lineno">515</span><span class="comment" id="1515867">//&nbsp;finalizers,&nbsp;and&nbsp;they&nbsp;are&nbsp;otherwise&nbsp;unreachable,&nbsp;only&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1515937">//&nbsp;for&nbsp;A&nbsp;runs;&nbsp;once&nbsp;A&nbsp;is&nbsp;freed,&nbsp;the&nbsp;finalizer&nbsp;for&nbsp;B&nbsp;can&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="1515998">//&nbsp;If&nbsp;a&nbsp;cyclic&nbsp;structure&nbsp;includes&nbsp;a&nbsp;block&nbsp;with&nbsp;a&nbsp;finalizer,&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1516063">//&nbsp;cycle&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;and&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1516132">//&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;run,&nbsp;because&nbsp;there&nbsp;is&nbsp;no&nbsp;ordering&nbsp;that</span><br>
<span class="lineno">520</span><span class="comment" id="1516195">//&nbsp;respects&nbsp;the&nbsp;dependencies.</span><br>
<span class="lineno"></span><span class="comment" id="1516225">//</span><br>
<span class="lineno"></span><span class="comment" id="1516228">//&nbsp;The&nbsp;finalizer&nbsp;for&nbsp;x&nbsp;is&nbsp;scheduled&nbsp;to&nbsp;run&nbsp;at&nbsp;some&nbsp;arbitrary&nbsp;time&nbsp;after</span><br>
<span class="lineno"></span><span class="comment" id="1516300">//&nbsp;x&nbsp;becomes&nbsp;unreachable.</span><br>
<span class="lineno"></span><span class="comment" id="1516326">//&nbsp;There&nbsp;is&nbsp;no&nbsp;guarantee&nbsp;that&nbsp;finalizers&nbsp;will&nbsp;run&nbsp;before&nbsp;a&nbsp;program&nbsp;exits,</span><br>
<span class="lineno">525</span><span class="comment" id="1516400">//&nbsp;so&nbsp;typically&nbsp;they&nbsp;are&nbsp;useful&nbsp;only&nbsp;for&nbsp;releasing&nbsp;non-memory&nbsp;resources</span><br>
<span class="lineno"></span><span class="comment" id="1516472">//&nbsp;associated&nbsp;with&nbsp;an&nbsp;object&nbsp;during&nbsp;a&nbsp;long-running&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1516532">//&nbsp;For&nbsp;example,&nbsp;an&nbsp;os.File&nbsp;object&nbsp;could&nbsp;use&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;close&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1516601">//&nbsp;associated&nbsp;operating&nbsp;system&nbsp;file&nbsp;descriptor&nbsp;when&nbsp;a&nbsp;program&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="1516672">//&nbsp;an&nbsp;os.File&nbsp;without&nbsp;calling&nbsp;Close,&nbsp;but&nbsp;it&nbsp;would&nbsp;be&nbsp;a&nbsp;mistake</span><br>
<span class="lineno">530</span><span class="comment" id="1516735">//&nbsp;to&nbsp;depend&nbsp;on&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;flush&nbsp;an&nbsp;in-memory&nbsp;I/O&nbsp;buffer&nbsp;such&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1516806">//&nbsp;bufio.Writer,&nbsp;because&nbsp;the&nbsp;buffer&nbsp;would&nbsp;not&nbsp;be&nbsp;flushed&nbsp;at&nbsp;program&nbsp;exit.</span><br>
<span class="lineno"></span><span class="comment" id="1516880">//</span><br>
<span class="lineno"></span><span class="comment" id="1516883">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;*x&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1516954">//&nbsp;zero&nbsp;bytes.</span><br>
<span class="lineno">535</span><span class="comment" id="1516969">//</span><br>
<span class="lineno"></span><span class="comment" id="1516972">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;for&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1517044">//&nbsp;in&nbsp;initializers&nbsp;for&nbsp;package-level&nbsp;variables.&nbsp;Such&nbsp;objects&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1517112">//&nbsp;linker-allocated,&nbsp;not&nbsp;heap-allocated.</span><br>
<span class="lineno"></span><span class="comment" id="1517153">//</span><br>
<span class="lineno">540</span><span class="comment" id="1517156">//&nbsp;A&nbsp;single&nbsp;goroutine&nbsp;runs&nbsp;all&nbsp;finalizers&nbsp;for&nbsp;a&nbsp;program,&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="comment" id="1517227">//&nbsp;If&nbsp;a&nbsp;finalizer&nbsp;must&nbsp;run&nbsp;for&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;should&nbsp;do&nbsp;so&nbsp;by&nbsp;starting</span><br>
<span class="lineno"></span><span class="comment" id="1517299">//&nbsp;a&nbsp;new&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1517319">func</span>&nbsp;<span class="ident" id="1517324">SetFinalizer</span><span class="op" id="1517336">(</span><span class="ident" id="1517337">obj</span>&nbsp;<span class="keyword" id="1517341">interface</span><span class="op" id="1517350">{</span><span class="op" id="1517351">}</span><span class="op" id="1517352">,</span>&nbsp;<span class="ident" id="1517354">finalizer</span>&nbsp;<span class="keyword" id="1517364">interface</span><span class="op" id="1517373">{</span><span class="op" id="1517374">}</span><span class="op" id="1517375">)</span>&nbsp;<span class="op" id="1517377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517380">e</span>&nbsp;<span class="op" id="1517382">:=</span>&nbsp;<span class="op" id="1517385">(</span><span class="op" id="1517386">*</span><span class="ident" id="1517387">eface</span><span class="op" id="1517392">)</span><span class="op" id="1517393">(</span><span class="ident" id="1517394">unsafe</span><span class="op" id="1517400">.</span><span class="ident" id="1517401">Pointer</span><span class="op" id="1517408">(</span><span class="op" id="1517409">&amp;</span><span class="ident" id="1517410">obj</span><span class="op" id="1517413">)</span><span class="op" id="1517414">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517417">etyp</span>&nbsp;<span class="op" id="1517422">:=</span>&nbsp;<span class="ident" id="1517425">e</span><span class="op" id="1517426">.</span><span class="ident" id="1517427">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517434">if</span>&nbsp;<span class="ident" id="1517437">etyp</span>&nbsp;<span class="op" id="1517442">==</span>&nbsp;<span class="builtintype" id="1517445">nil</span>&nbsp;<span class="op" id="1517449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517453">gothrow</span><span class="op" id="1517460">(</span><span class="string" id="1517461">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;nil&#34;</span><span class="op" id="1517506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1517509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517512">if</span>&nbsp;<span class="ident" id="1517515">etyp</span><span class="op" id="1517519">.</span><span class="ident" id="1517520">kind</span><span class="op" id="1517524">&amp;</span><span class="ident" id="1517525">kindMask</span>&nbsp;<span class="op" id="1517534">!=</span>&nbsp;<span class="ident" id="1517537">kindPtr</span>&nbsp;<span class="op" id="1517545">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517549">gothrow</span><span class="op" id="1517556">(</span><span class="string" id="1517557">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1517600">+</span>&nbsp;<span class="op" id="1517602">*</span><span class="ident" id="1517603">etyp</span><span class="op" id="1517607">.</span><span class="ident" id="1517608">_string</span>&nbsp;<span class="op" id="1517616">+</span>&nbsp;<span class="string" id="1517618">&#34;,&nbsp;not&nbsp;pointer&#34;</span><span class="op" id="1517633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1517636">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517639">ot</span>&nbsp;<span class="op" id="1517642">:=</span>&nbsp;<span class="op" id="1517645">(</span><span class="op" id="1517646">*</span><span class="ident" id="1517647">ptrtype</span><span class="op" id="1517654">)</span><span class="op" id="1517655">(</span><span class="ident" id="1517656">unsafe</span><span class="op" id="1517662">.</span><span class="ident" id="1517663">Pointer</span><span class="op" id="1517670">(</span><span class="ident" id="1517671">etyp</span><span class="op" id="1517675">)</span><span class="op" id="1517676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517679">if</span>&nbsp;<span class="ident" id="1517682">ot</span><span class="op" id="1517684">.</span><span class="ident" id="1517685">elem</span>&nbsp;<span class="op" id="1517690">==</span>&nbsp;<span class="builtintype" id="1517693">nil</span>&nbsp;<span class="op" id="1517697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517701">gothrow</span><span class="op" id="1517708">(</span><span class="string" id="1517709">&#34;nil&nbsp;elem&nbsp;type!&#34;</span><span class="op" id="1517725">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1517728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517732">//&nbsp;find&nbsp;the&nbsp;containing&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1517763">_</span><span class="op" id="1517764">,</span>&nbsp;<span class="ident" id="1517766">base</span><span class="op" id="1517770">,</span>&nbsp;<span class="ident" id="1517772">_</span>&nbsp;<span class="op" id="1517774">:=</span>&nbsp;<span class="ident" id="1517777">findObject</span><span class="op" id="1517787">(</span><span class="ident" id="1517788">e</span><span class="op" id="1517789">.</span><span class="ident" id="1517790">data</span><span class="op" id="1517794">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517798">if</span>&nbsp;<span class="ident" id="1517801">base</span>&nbsp;<span class="op" id="1517806">==</span>&nbsp;<span class="builtintype" id="1517809">nil</span>&nbsp;<span class="op" id="1517813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517817">//&nbsp;0-length&nbsp;objects&nbsp;are&nbsp;okay.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517849">if</span>&nbsp;<span class="ident" id="1517852">e</span><span class="op" id="1517853">.</span><span class="ident" id="1517854">data</span>&nbsp;<span class="op" id="1517859">==</span>&nbsp;<span class="ident" id="1517862">unsafe</span><span class="op" id="1517868">.</span><span class="ident" id="1517869">Pointer</span><span class="op" id="1517876">(</span><span class="op" id="1517877">&amp;</span><span class="ident" id="1517878">zerobase</span><span class="op" id="1517886">)</span>&nbsp;<span class="op" id="1517888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1517893">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1517902">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517907">//&nbsp;Global&nbsp;initializers&nbsp;might&nbsp;be&nbsp;linker-allocated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517959">//&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;Foo&nbsp;=&nbsp;&amp;Object{}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1517984">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518003">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtime.SetFinalizer(Foo,&nbsp;nil)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518040">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518047">//&nbsp;The&nbsp;relevant&nbsp;segments&nbsp;are:&nbsp;noptrdata,&nbsp;data,&nbsp;bss,&nbsp;noptrbss.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518111">//&nbsp;We&nbsp;cannot&nbsp;assume&nbsp;they&nbsp;are&nbsp;in&nbsp;any&nbsp;order&nbsp;or&nbsp;even&nbsp;contiguous,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518175">//&nbsp;due&nbsp;to&nbsp;external&nbsp;linking.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1518205">if</span>&nbsp;<span class="builtintype" id="1518208">uintptr</span><span class="op" id="1518215">(</span><span class="ident" id="1518216">unsafe</span><span class="op" id="1518222">.</span><span class="ident" id="1518223">Pointer</span><span class="op" id="1518230">(</span><span class="op" id="1518231">&amp;</span><span class="ident" id="1518232">noptrdata</span><span class="op" id="1518241">)</span><span class="op" id="1518242">)</span>&nbsp;<span class="op" id="1518244">&lt;=</span>&nbsp;<span class="builtintype" id="1518247">uintptr</span><span class="op" id="1518254">(</span><span class="ident" id="1518255">e</span><span class="op" id="1518256">.</span><span class="ident" id="1518257">data</span><span class="op" id="1518261">)</span>&nbsp;<span class="op" id="1518263">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1518266">uintptr</span><span class="op" id="1518273">(</span><span class="ident" id="1518274">e</span><span class="op" id="1518275">.</span><span class="ident" id="1518276">data</span><span class="op" id="1518280">)</span>&nbsp;<span class="op" id="1518282">&lt;</span>&nbsp;<span class="builtintype" id="1518284">uintptr</span><span class="op" id="1518291">(</span><span class="ident" id="1518292">unsafe</span><span class="op" id="1518298">.</span><span class="ident" id="1518299">Pointer</span><span class="op" id="1518306">(</span><span class="op" id="1518307">&amp;</span><span class="ident" id="1518308">enoptrdata</span><span class="op" id="1518318">)</span><span class="op" id="1518319">)</span>&nbsp;<span class="op" id="1518321">||</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1518327">uintptr</span><span class="op" id="1518334">(</span><span class="ident" id="1518335">unsafe</span><span class="op" id="1518341">.</span><span class="ident" id="1518342">Pointer</span><span class="op" id="1518349">(</span><span class="op" id="1518350">&amp;</span><span class="ident" id="1518351">data</span><span class="op" id="1518355">)</span><span class="op" id="1518356">)</span>&nbsp;<span class="op" id="1518358">&lt;=</span>&nbsp;<span class="builtintype" id="1518361">uintptr</span><span class="op" id="1518368">(</span><span class="ident" id="1518369">e</span><span class="op" id="1518370">.</span><span class="ident" id="1518371">data</span><span class="op" id="1518375">)</span>&nbsp;<span class="op" id="1518377">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1518380">uintptr</span><span class="op" id="1518387">(</span><span class="ident" id="1518388">e</span><span class="op" id="1518389">.</span><span class="ident" id="1518390">data</span><span class="op" id="1518394">)</span>&nbsp;<span class="op" id="1518396">&lt;</span>&nbsp;<span class="builtintype" id="1518398">uintptr</span><span class="op" id="1518405">(</span><span class="ident" id="1518406">unsafe</span><span class="op" id="1518412">.</span><span class="ident" id="1518413">Pointer</span><span class="op" id="1518420">(</span><span class="op" id="1518421">&amp;</span><span class="ident" id="1518422">edata</span><span class="op" id="1518427">)</span><span class="op" id="1518428">)</span>&nbsp;<span class="op" id="1518430">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1518436">uintptr</span><span class="op" id="1518443">(</span><span class="ident" id="1518444">unsafe</span><span class="op" id="1518450">.</span><span class="ident" id="1518451">Pointer</span><span class="op" id="1518458">(</span><span class="op" id="1518459">&amp;</span><span class="ident" id="1518460">bss</span><span class="op" id="1518463">)</span><span class="op" id="1518464">)</span>&nbsp;<span class="op" id="1518466">&lt;=</span>&nbsp;<span class="builtintype" id="1518469">uintptr</span><span class="op" id="1518476">(</span><span class="ident" id="1518477">e</span><span class="op" id="1518478">.</span><span class="ident" id="1518479">data</span><span class="op" id="1518483">)</span>&nbsp;<span class="op" id="1518485">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1518488">uintptr</span><span class="op" id="1518495">(</span><span class="ident" id="1518496">e</span><span class="op" id="1518497">.</span><span class="ident" id="1518498">data</span><span class="op" id="1518502">)</span>&nbsp;<span class="op" id="1518504">&lt;</span>&nbsp;<span class="builtintype" id="1518506">uintptr</span><span class="op" id="1518513">(</span><span class="ident" id="1518514">unsafe</span><span class="op" id="1518520">.</span><span class="ident" id="1518521">Pointer</span><span class="op" id="1518528">(</span><span class="op" id="1518529">&amp;</span><span class="ident" id="1518530">ebss</span><span class="op" id="1518534">)</span><span class="op" id="1518535">)</span>&nbsp;<span class="op" id="1518537">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1518543">uintptr</span><span class="op" id="1518550">(</span><span class="ident" id="1518551">unsafe</span><span class="op" id="1518557">.</span><span class="ident" id="1518558">Pointer</span><span class="op" id="1518565">(</span><span class="op" id="1518566">&amp;</span><span class="ident" id="1518567">noptrbss</span><span class="op" id="1518575">)</span><span class="op" id="1518576">)</span>&nbsp;<span class="op" id="1518578">&lt;=</span>&nbsp;<span class="builtintype" id="1518581">uintptr</span><span class="op" id="1518588">(</span><span class="ident" id="1518589">e</span><span class="op" id="1518590">.</span><span class="ident" id="1518591">data</span><span class="op" id="1518595">)</span>&nbsp;<span class="op" id="1518597">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1518600">uintptr</span><span class="op" id="1518607">(</span><span class="ident" id="1518608">e</span><span class="op" id="1518609">.</span><span class="ident" id="1518610">data</span><span class="op" id="1518614">)</span>&nbsp;<span class="op" id="1518616">&lt;</span>&nbsp;<span class="builtintype" id="1518618">uintptr</span><span class="op" id="1518625">(</span><span class="ident" id="1518626">unsafe</span><span class="op" id="1518632">.</span><span class="ident" id="1518633">Pointer</span><span class="op" id="1518640">(</span><span class="op" id="1518641">&amp;</span><span class="ident" id="1518642">enoptrbss</span><span class="op" id="1518651">)</span><span class="op" id="1518652">)</span>&nbsp;<span class="op" id="1518654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1518659">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1518668">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1518672">gothrow</span><span class="op" id="1518679">(</span><span class="string" id="1518680">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;in&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1518734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1518737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1518741">if</span>&nbsp;<span class="ident" id="1518744">e</span><span class="op" id="1518745">.</span><span class="ident" id="1518746">data</span>&nbsp;<span class="op" id="1518751">!=</span>&nbsp;<span class="ident" id="1518754">base</span>&nbsp;<span class="op" id="1518759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518763">//&nbsp;As&nbsp;an&nbsp;implementation&nbsp;detail&nbsp;we&nbsp;allow&nbsp;to&nbsp;set&nbsp;finalizers&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1518841">//&nbsp;of&nbsp;an&nbsp;object&nbsp;if&nbsp;it&nbsp;could&nbsp;come&nbsp;from&nbsp;tiny&nbsp;alloc&nbsp;(see&nbsp;mallocgc&nbsp;for&nbsp;details).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1518920">if</span>&nbsp;<span class="ident" id="1518923">ot</span><span class="op" id="1518925">.</span><span class="ident" id="1518926">elem</span>&nbsp;<span class="op" id="1518931">==</span>&nbsp;<span class="builtintype" id="1518934">nil</span>&nbsp;<span class="op" id="1518938">||</span>&nbsp;<span class="ident" id="1518941">ot</span><span class="op" id="1518943">.</span><span class="ident" id="1518944">elem</span><span class="op" id="1518948">.</span><span class="ident" id="1518949">kind</span><span class="op" id="1518953">&amp;</span><span class="ident" id="1518954">kindNoPointers</span>&nbsp;<span class="op" id="1518969">==</span>&nbsp;<span class="num" id="1518972">0</span>&nbsp;<span class="op" id="1518974">||</span>&nbsp;<span class="ident" id="1518977">ot</span><span class="op" id="1518979">.</span><span class="ident" id="1518980">elem</span><span class="op" id="1518984">.</span><span class="ident" id="1518985">size</span>&nbsp;<span class="op" id="1518990">&gt;=</span>&nbsp;<span class="ident" id="1518993">maxTinySize</span>&nbsp;<span class="op" id="1519005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519010">gothrow</span><span class="op" id="1519017">(</span><span class="string" id="1519018">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;at&nbsp;beginning&nbsp;of&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1519085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519092">}</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519096">f</span>&nbsp;<span class="op" id="1519098">:=</span>&nbsp;<span class="op" id="1519101">(</span><span class="op" id="1519102">*</span><span class="ident" id="1519103">eface</span><span class="op" id="1519108">)</span><span class="op" id="1519109">(</span><span class="ident" id="1519110">unsafe</span><span class="op" id="1519116">.</span><span class="ident" id="1519117">Pointer</span><span class="op" id="1519124">(</span><span class="op" id="1519125">&amp;</span><span class="ident" id="1519126">finalizer</span><span class="op" id="1519135">)</span><span class="op" id="1519136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519139">ftyp</span>&nbsp;<span class="op" id="1519144">:=</span>&nbsp;<span class="ident" id="1519147">f</span><span class="op" id="1519148">.</span><span class="ident" id="1519149">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519156">if</span>&nbsp;<span class="ident" id="1519159">ftyp</span>&nbsp;<span class="op" id="1519164">==</span>&nbsp;<span class="builtintype" id="1519167">nil</span>&nbsp;<span class="op" id="1519171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519175">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;and&nbsp;remove&nbsp;finalizer</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519219">mp</span>&nbsp;<span class="op" id="1519222">:=</span>&nbsp;<span class="ident" id="1519225">acquirem</span><span class="op" id="1519233">(</span><span class="op" id="1519234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519238">mp</span><span class="op" id="1519240">.</span><span class="ident" id="1519241">ptrarg</span><span class="op" id="1519247">[</span><span class="num" id="1519248">0</span><span class="op" id="1519249">]</span>&nbsp;<span class="op" id="1519251">=</span>&nbsp;<span class="ident" id="1519253">e</span><span class="op" id="1519254">.</span><span class="ident" id="1519255">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519262">onM</span><span class="op" id="1519265">(</span><span class="ident" id="1519266">removeFinalizer_m</span><span class="op" id="1519283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519287">releasem</span><span class="op" id="1519295">(</span><span class="ident" id="1519296">mp</span><span class="op" id="1519298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519302">return</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519310">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519314">if</span>&nbsp;<span class="ident" id="1519317">ftyp</span><span class="op" id="1519321">.</span><span class="ident" id="1519322">kind</span><span class="op" id="1519326">&amp;</span><span class="ident" id="1519327">kindMask</span>&nbsp;<span class="op" id="1519336">!=</span>&nbsp;<span class="ident" id="1519339">kindFunc</span>&nbsp;<span class="op" id="1519348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519352">gothrow</span><span class="op" id="1519359">(</span><span class="string" id="1519360">&#34;runtime.SetFinalizer:&nbsp;second&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1519404">+</span>&nbsp;<span class="op" id="1519406">*</span><span class="ident" id="1519407">ftyp</span><span class="op" id="1519411">.</span><span class="ident" id="1519412">_string</span>&nbsp;<span class="op" id="1519420">+</span>&nbsp;<span class="string" id="1519422">&#34;,&nbsp;not&nbsp;a&nbsp;function&#34;</span><span class="op" id="1519440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519443">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519446">ft</span>&nbsp;<span class="op" id="1519449">:=</span>&nbsp;<span class="op" id="1519452">(</span><span class="op" id="1519453">*</span><span class="ident" id="1519454">functype</span><span class="op" id="1519462">)</span><span class="op" id="1519463">(</span><span class="ident" id="1519464">unsafe</span><span class="op" id="1519470">.</span><span class="ident" id="1519471">Pointer</span><span class="op" id="1519478">(</span><span class="ident" id="1519479">ftyp</span><span class="op" id="1519483">)</span><span class="op" id="1519484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519487">ins</span>&nbsp;<span class="op" id="1519491">:=</span>&nbsp;<span class="op" id="1519494">*</span><span class="op" id="1519495">(</span><span class="op" id="1519496">*</span><span class="op" id="1519497">[</span><span class="op" id="1519498">]</span><span class="op" id="1519499">*</span><span class="ident" id="1519500">_type</span><span class="op" id="1519505">)</span><span class="op" id="1519506">(</span><span class="ident" id="1519507">unsafe</span><span class="op" id="1519513">.</span><span class="ident" id="1519514">Pointer</span><span class="op" id="1519521">(</span><span class="op" id="1519522">&amp;</span><span class="ident" id="1519523">ft</span><span class="op" id="1519525">.</span><span class="ident" id="1519526">in</span><span class="op" id="1519528">)</span><span class="op" id="1519529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519532">if</span>&nbsp;<span class="ident" id="1519535">ft</span><span class="op" id="1519537">.</span><span class="ident" id="1519538">dotdotdot</span>&nbsp;<span class="op" id="1519548">||</span>&nbsp;<span class="builtinfunc" id="1519551">len</span><span class="op" id="1519554">(</span><span class="ident" id="1519555">ins</span><span class="op" id="1519558">)</span>&nbsp;<span class="op" id="1519560">!=</span>&nbsp;<span class="num" id="1519563">1</span>&nbsp;<span class="op" id="1519565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519569">gothrow</span><span class="op" id="1519576">(</span><span class="string" id="1519577">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1519614">+</span>&nbsp;<span class="op" id="1519616">*</span><span class="ident" id="1519617">etyp</span><span class="op" id="1519621">.</span><span class="ident" id="1519622">_string</span>&nbsp;<span class="op" id="1519630">+</span>&nbsp;<span class="string" id="1519632">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1519649">+</span>&nbsp;<span class="op" id="1519651">*</span><span class="ident" id="1519652">ftyp</span><span class="op" id="1519656">.</span><span class="ident" id="1519657">_string</span><span class="op" id="1519664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1519667">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1519670">fint</span>&nbsp;<span class="op" id="1519675">:=</span>&nbsp;<span class="ident" id="1519678">ins</span><span class="op" id="1519681">[</span><span class="num" id="1519682">0</span><span class="op" id="1519683">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519686">switch</span>&nbsp;<span class="op" id="1519693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519696">case</span>&nbsp;<span class="ident" id="1519701">fint</span>&nbsp;<span class="op" id="1519706">==</span>&nbsp;<span class="ident" id="1519709">etyp</span><span class="op" id="1519713">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519717">//&nbsp;ok&nbsp;-&nbsp;same&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519737">goto</span>&nbsp;<span class="ident" id="1519742">okarg</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519749">case</span>&nbsp;<span class="ident" id="1519754">fint</span><span class="op" id="1519758">.</span><span class="ident" id="1519759">kind</span><span class="op" id="1519763">&amp;</span><span class="ident" id="1519764">kindMask</span>&nbsp;<span class="op" id="1519773">==</span>&nbsp;<span class="ident" id="1519776">kindPtr</span><span class="op" id="1519783">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1519787">if</span>&nbsp;<span class="op" id="1519790">(</span><span class="ident" id="1519791">fint</span><span class="op" id="1519795">.</span><span class="ident" id="1519796">x</span>&nbsp;<span class="op" id="1519798">==</span>&nbsp;<span class="builtintype" id="1519801">nil</span>&nbsp;<span class="op" id="1519805">||</span>&nbsp;<span class="ident" id="1519808">fint</span><span class="op" id="1519812">.</span><span class="ident" id="1519813">x</span><span class="op" id="1519814">.</span><span class="ident" id="1519815">name</span>&nbsp;<span class="op" id="1519820">==</span>&nbsp;<span class="builtintype" id="1519823">nil</span>&nbsp;<span class="op" id="1519827">||</span>&nbsp;<span class="ident" id="1519830">etyp</span><span class="op" id="1519834">.</span><span class="ident" id="1519835">x</span>&nbsp;<span class="op" id="1519837">==</span>&nbsp;<span class="builtintype" id="1519840">nil</span>&nbsp;<span class="op" id="1519844">||</span>&nbsp;<span class="ident" id="1519847">etyp</span><span class="op" id="1519851">.</span><span class="ident" id="1519852">x</span><span class="op" id="1519853">.</span><span class="ident" id="1519854">name</span>&nbsp;<span class="op" id="1519859">==</span>&nbsp;<span class="builtintype" id="1519862">nil</span><span class="op" id="1519865">)</span>&nbsp;<span class="op" id="1519867">&amp;&amp;</span>&nbsp;<span class="op" id="1519870">(</span><span class="op" id="1519871">*</span><span class="ident" id="1519872">ptrtype</span><span class="op" id="1519879">)</span><span class="op" id="1519880">(</span><span class="ident" id="1519881">unsafe</span><span class="op" id="1519887">.</span><span class="ident" id="1519888">Pointer</span><span class="op" id="1519895">(</span><span class="ident" id="1519896">fint</span><span class="op" id="1519900">)</span><span class="op" id="1519901">)</span><span class="op" id="1519902">.</span><span class="ident" id="1519903">elem</span>&nbsp;<span class="op" id="1519908">==</span>&nbsp;<span class="ident" id="1519911">ot</span><span class="op" id="1519913">.</span><span class="ident" id="1519914">elem</span>&nbsp;<span class="op" id="1519919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519924">//&nbsp;ok&nbsp;-&nbsp;not&nbsp;same&nbsp;type,&nbsp;but&nbsp;both&nbsp;pointers,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1519969">//&nbsp;one&nbsp;or&nbsp;the&nbsp;other&nbsp;is&nbsp;unnamed,&nbsp;and&nbsp;same&nbsp;element&nbsp;type,&nbsp;so&nbsp;assignable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520042">goto</span>&nbsp;<span class="ident" id="1520047">okarg</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520058">case</span>&nbsp;<span class="ident" id="1520063">fint</span><span class="op" id="1520067">.</span><span class="ident" id="1520068">kind</span><span class="op" id="1520072">&amp;</span><span class="ident" id="1520073">kindMask</span>&nbsp;<span class="op" id="1520082">==</span>&nbsp;<span class="ident" id="1520085">kindInterface</span><span class="op" id="1520098">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520102">ityp</span>&nbsp;<span class="op" id="1520107">:=</span>&nbsp;<span class="op" id="1520110">(</span><span class="op" id="1520111">*</span><span class="ident" id="1520112">interfacetype</span><span class="op" id="1520125">)</span><span class="op" id="1520126">(</span><span class="ident" id="1520127">unsafe</span><span class="op" id="1520133">.</span><span class="ident" id="1520134">Pointer</span><span class="op" id="1520141">(</span><span class="ident" id="1520142">fint</span><span class="op" id="1520146">)</span><span class="op" id="1520147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520151">if</span>&nbsp;<span class="builtinfunc" id="1520154">len</span><span class="op" id="1520157">(</span><span class="ident" id="1520158">ityp</span><span class="op" id="1520162">.</span><span class="ident" id="1520163">mhdr</span><span class="op" id="1520167">)</span>&nbsp;<span class="op" id="1520169">==</span>&nbsp;<span class="num" id="1520172">0</span>&nbsp;<span class="op" id="1520174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520179">//&nbsp;ok&nbsp;-&nbsp;satisfies&nbsp;empty&nbsp;interface</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520216">goto</span>&nbsp;<span class="ident" id="1520221">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520233">if</span>&nbsp;<span class="ident" id="1520236">_</span><span class="op" id="1520237">,</span>&nbsp;<span class="ident" id="1520239">ok</span>&nbsp;<span class="op" id="1520242">:=</span>&nbsp;<span class="ident" id="1520245">assertE2I2</span><span class="op" id="1520255">(</span><span class="ident" id="1520256">ityp</span><span class="op" id="1520260">,</span>&nbsp;<span class="ident" id="1520262">obj</span><span class="op" id="1520265">)</span><span class="op" id="1520266">;</span>&nbsp;<span class="ident" id="1520268">ok</span>&nbsp;<span class="op" id="1520271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520276">goto</span>&nbsp;<span class="ident" id="1520281">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520289">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520295">gothrow</span><span class="op" id="1520302">(</span><span class="string" id="1520303">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1520340">+</span>&nbsp;<span class="op" id="1520342">*</span><span class="ident" id="1520343">etyp</span><span class="op" id="1520347">.</span><span class="ident" id="1520348">_string</span>&nbsp;<span class="op" id="1520356">+</span>&nbsp;<span class="string" id="1520358">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1520375">+</span>&nbsp;<span class="op" id="1520377">*</span><span class="ident" id="1520378">ftyp</span><span class="op" id="1520382">.</span><span class="ident" id="1520383">_string</span><span class="op" id="1520390">)</span><br>
<span class="lineno"></span><span class="ident" id="1520392">okarg</span><span class="op" id="1520397">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520400">//&nbsp;compute&nbsp;size&nbsp;needed&nbsp;for&nbsp;return&nbsp;parameters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520446">nret</span>&nbsp;<span class="op" id="1520451">:=</span>&nbsp;<span class="builtintype" id="1520454">uintptr</span><span class="op" id="1520461">(</span><span class="num" id="1520462">0</span><span class="op" id="1520463">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520466">for</span>&nbsp;<span class="ident" id="1520470">_</span><span class="op" id="1520471">,</span>&nbsp;<span class="ident" id="1520473">t</span>&nbsp;<span class="op" id="1520475">:=</span>&nbsp;<span class="keyword" id="1520478">range</span>&nbsp;<span class="op" id="1520484">*</span><span class="op" id="1520485">(</span><span class="op" id="1520486">*</span><span class="op" id="1520487">[</span><span class="op" id="1520488">]</span><span class="op" id="1520489">*</span><span class="ident" id="1520490">_type</span><span class="op" id="1520495">)</span><span class="op" id="1520496">(</span><span class="ident" id="1520497">unsafe</span><span class="op" id="1520503">.</span><span class="ident" id="1520504">Pointer</span><span class="op" id="1520511">(</span><span class="op" id="1520512">&amp;</span><span class="ident" id="1520513">ft</span><span class="op" id="1520515">.</span><span class="ident" id="1520516">out</span><span class="op" id="1520519">)</span><span class="op" id="1520520">)</span>&nbsp;<span class="op" id="1520522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520526">nret</span>&nbsp;<span class="op" id="1520531">=</span>&nbsp;<span class="ident" id="1520533">round</span><span class="op" id="1520538">(</span><span class="ident" id="1520539">nret</span><span class="op" id="1520543">,</span>&nbsp;<span class="builtintype" id="1520545">uintptr</span><span class="op" id="1520552">(</span><span class="ident" id="1520553">t</span><span class="op" id="1520554">.</span><span class="ident" id="1520555">align</span><span class="op" id="1520560">)</span><span class="op" id="1520561">)</span>&nbsp;<span class="op" id="1520563">+</span>&nbsp;<span class="builtintype" id="1520565">uintptr</span><span class="op" id="1520572">(</span><span class="ident" id="1520573">t</span><span class="op" id="1520574">.</span><span class="ident" id="1520575">size</span><span class="op" id="1520579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520585">nret</span>&nbsp;<span class="op" id="1520590">=</span>&nbsp;<span class="ident" id="1520592">round</span><span class="op" id="1520597">(</span><span class="ident" id="1520598">nret</span><span class="op" id="1520602">,</span>&nbsp;<span class="ident" id="1520604">ptrSize</span><span class="op" id="1520611">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520615">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;have&nbsp;a&nbsp;finalizer&nbsp;goroutine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520659">createfing</span><span class="op" id="1520669">(</span><span class="op" id="1520670">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1520674">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;to&nbsp;add&nbsp;finalizer&nbsp;record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520720">mp</span>&nbsp;<span class="op" id="1520723">:=</span>&nbsp;<span class="ident" id="1520726">acquirem</span><span class="op" id="1520734">(</span><span class="op" id="1520735">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520738">mp</span><span class="op" id="1520740">.</span><span class="ident" id="1520741">ptrarg</span><span class="op" id="1520747">[</span><span class="num" id="1520748">0</span><span class="op" id="1520749">]</span>&nbsp;<span class="op" id="1520751">=</span>&nbsp;<span class="ident" id="1520753">f</span><span class="op" id="1520754">.</span><span class="ident" id="1520755">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520761">mp</span><span class="op" id="1520763">.</span><span class="ident" id="1520764">ptrarg</span><span class="op" id="1520770">[</span><span class="num" id="1520771">1</span><span class="op" id="1520772">]</span>&nbsp;<span class="op" id="1520774">=</span>&nbsp;<span class="ident" id="1520776">e</span><span class="op" id="1520777">.</span><span class="ident" id="1520778">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520784">mp</span><span class="op" id="1520786">.</span><span class="ident" id="1520787">scalararg</span><span class="op" id="1520796">[</span><span class="num" id="1520797">0</span><span class="op" id="1520798">]</span>&nbsp;<span class="op" id="1520800">=</span>&nbsp;<span class="ident" id="1520802">nret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520808">mp</span><span class="op" id="1520810">.</span><span class="ident" id="1520811">ptrarg</span><span class="op" id="1520817">[</span><span class="num" id="1520818">2</span><span class="op" id="1520819">]</span>&nbsp;<span class="op" id="1520821">=</span>&nbsp;<span class="ident" id="1520823">unsafe</span><span class="op" id="1520829">.</span><span class="ident" id="1520830">Pointer</span><span class="op" id="1520837">(</span><span class="ident" id="1520838">fint</span><span class="op" id="1520842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520845">mp</span><span class="op" id="1520847">.</span><span class="ident" id="1520848">ptrarg</span><span class="op" id="1520854">[</span><span class="num" id="1520855">3</span><span class="op" id="1520856">]</span>&nbsp;<span class="op" id="1520858">=</span>&nbsp;<span class="ident" id="1520860">unsafe</span><span class="op" id="1520866">.</span><span class="ident" id="1520867">Pointer</span><span class="op" id="1520874">(</span><span class="ident" id="1520875">ot</span><span class="op" id="1520877">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520880">onM</span><span class="op" id="1520883">(</span><span class="ident" id="1520884">setFinalizer_m</span><span class="op" id="1520898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1520901">if</span>&nbsp;<span class="ident" id="1520904">mp</span><span class="op" id="1520906">.</span><span class="ident" id="1520907">scalararg</span><span class="op" id="1520916">[</span><span class="num" id="1520917">0</span><span class="op" id="1520918">]</span>&nbsp;<span class="op" id="1520920">!=</span>&nbsp;<span class="num" id="1520923">1</span>&nbsp;<span class="op" id="1520925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520929">gothrow</span><span class="op" id="1520936">(</span><span class="string" id="1520937">&#34;runtime.SetFinalizer:&nbsp;finalizer&nbsp;already&nbsp;set&#34;</span><span class="op" id="1520982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1520985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1520988">releasem</span><span class="op" id="1520996">(</span><span class="ident" id="1520997">mp</span><span class="op" id="1520999">)</span><br>
<span class="lineno">655</span><span class="op" id="1521001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1521004">//&nbsp;round&nbsp;n&nbsp;up&nbsp;to&nbsp;a&nbsp;multiple&nbsp;of&nbsp;a.&nbsp;&nbsp;a&nbsp;must&nbsp;be&nbsp;a&nbsp;power&nbsp;of&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="1521063">func</span>&nbsp;<span class="ident" id="1521068">round</span><span class="op" id="1521073">(</span><span class="ident" id="1521074">n</span><span class="op" id="1521075">,</span>&nbsp;<span class="ident" id="1521077">a</span>&nbsp;<span class="builtintype" id="1521079">uintptr</span><span class="op" id="1521086">)</span>&nbsp;<span class="builtintype" id="1521088">uintptr</span>&nbsp;<span class="op" id="1521096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521099">return</span>&nbsp;<span class="op" id="1521106">(</span><span class="ident" id="1521107">n</span>&nbsp;<span class="op" id="1521109">+</span>&nbsp;<span class="ident" id="1521111">a</span>&nbsp;<span class="op" id="1521113">-</span>&nbsp;<span class="num" id="1521115">1</span><span class="op" id="1521116">)</span>&nbsp;<span class="op" id="1521118">&amp;^</span>&nbsp;<span class="op" id="1521121">(</span><span class="ident" id="1521122">a</span>&nbsp;<span class="op" id="1521124">-</span>&nbsp;<span class="num" id="1521126">1</span><span class="op" id="1521127">)</span><br>
<span class="lineno">660</span><span class="op" id="1521129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1521132">//&nbsp;Look&nbsp;up&nbsp;pointer&nbsp;v&nbsp;in&nbsp;heap.&nbsp;&nbsp;Return&nbsp;the&nbsp;span&nbsp;containing&nbsp;the&nbsp;object,</span><br>
<span class="lineno"></span><span class="comment" id="1521202">//&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;object,&nbsp;and&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;If&nbsp;the&nbsp;object</span><br>
<span class="lineno"></span><span class="comment" id="1521273">//&nbsp;does&nbsp;not&nbsp;exist,&nbsp;return&nbsp;nil,&nbsp;nil,&nbsp;0.</span><br>
<span class="lineno">665</span><span class="keyword" id="1521312">func</span>&nbsp;<span class="ident" id="1521317">findObject</span><span class="op" id="1521327">(</span><span class="ident" id="1521328">v</span>&nbsp;<span class="ident" id="1521330">unsafe</span><span class="op" id="1521336">.</span><span class="ident" id="1521337">Pointer</span><span class="op" id="1521344">)</span>&nbsp;<span class="op" id="1521346">(</span><span class="ident" id="1521347">s</span>&nbsp;<span class="op" id="1521349">*</span><span class="ident" id="1521350">mspan</span><span class="op" id="1521355">,</span>&nbsp;<span class="ident" id="1521357">x</span>&nbsp;<span class="ident" id="1521359">unsafe</span><span class="op" id="1521365">.</span><span class="ident" id="1521366">Pointer</span><span class="op" id="1521373">,</span>&nbsp;<span class="ident" id="1521375">n</span>&nbsp;<span class="builtintype" id="1521377">uintptr</span><span class="op" id="1521384">)</span>&nbsp;<span class="op" id="1521386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521389">c</span>&nbsp;<span class="op" id="1521391">:=</span>&nbsp;<span class="ident" id="1521394">gomcache</span><span class="op" id="1521402">(</span><span class="op" id="1521403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521406">c</span><span class="op" id="1521407">.</span><span class="ident" id="1521408">local_nlookup</span><span class="op" id="1521421">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521425">if</span>&nbsp;<span class="ident" id="1521428">ptrSize</span>&nbsp;<span class="op" id="1521436">==</span>&nbsp;<span class="num" id="1521439">4</span>&nbsp;<span class="op" id="1521441">&amp;&amp;</span>&nbsp;<span class="ident" id="1521444">c</span><span class="op" id="1521445">.</span><span class="ident" id="1521446">local_nlookup</span>&nbsp;<span class="op" id="1521460">&gt;=</span>&nbsp;<span class="num" id="1521463">1</span><span class="op" id="1521464">&lt;&lt;</span><span class="num" id="1521466">30</span>&nbsp;<span class="op" id="1521469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1521473">//&nbsp;purge&nbsp;cache&nbsp;stats&nbsp;to&nbsp;prevent&nbsp;overflow</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521516">lock</span><span class="op" id="1521520">(</span><span class="op" id="1521521">&amp;</span><span class="ident" id="1521522">mheap_</span><span class="op" id="1521528">.</span><span class="ident" id="1521529">lock</span><span class="op" id="1521533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521537">purgecachedstats</span><span class="op" id="1521553">(</span><span class="ident" id="1521554">c</span><span class="op" id="1521555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521559">unlock</span><span class="op" id="1521565">(</span><span class="op" id="1521566">&amp;</span><span class="ident" id="1521567">mheap_</span><span class="op" id="1521573">.</span><span class="ident" id="1521574">lock</span><span class="op" id="1521578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1521585">//&nbsp;find&nbsp;span</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521599">arena_start</span>&nbsp;<span class="op" id="1521611">:=</span>&nbsp;<span class="builtintype" id="1521614">uintptr</span><span class="op" id="1521621">(</span><span class="ident" id="1521622">unsafe</span><span class="op" id="1521628">.</span><span class="ident" id="1521629">Pointer</span><span class="op" id="1521636">(</span><span class="ident" id="1521637">mheap_</span><span class="op" id="1521643">.</span><span class="ident" id="1521644">arena_start</span><span class="op" id="1521655">)</span><span class="op" id="1521656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521659">arena_used</span>&nbsp;<span class="op" id="1521670">:=</span>&nbsp;<span class="builtintype" id="1521673">uintptr</span><span class="op" id="1521680">(</span><span class="ident" id="1521681">unsafe</span><span class="op" id="1521687">.</span><span class="ident" id="1521688">Pointer</span><span class="op" id="1521695">(</span><span class="ident" id="1521696">mheap_</span><span class="op" id="1521702">.</span><span class="ident" id="1521703">arena_used</span><span class="op" id="1521713">)</span><span class="op" id="1521714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521717">if</span>&nbsp;<span class="builtintype" id="1521720">uintptr</span><span class="op" id="1521727">(</span><span class="ident" id="1521728">v</span><span class="op" id="1521729">)</span>&nbsp;<span class="op" id="1521731">&lt;</span>&nbsp;<span class="ident" id="1521733">arena_start</span>&nbsp;<span class="op" id="1521745">||</span>&nbsp;<span class="builtintype" id="1521748">uintptr</span><span class="op" id="1521755">(</span><span class="ident" id="1521756">v</span><span class="op" id="1521757">)</span>&nbsp;<span class="op" id="1521759">&gt;=</span>&nbsp;<span class="ident" id="1521762">arena_used</span>&nbsp;<span class="op" id="1521773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521777">return</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521788">p</span>&nbsp;<span class="op" id="1521790">:=</span>&nbsp;<span class="builtintype" id="1521793">uintptr</span><span class="op" id="1521800">(</span><span class="ident" id="1521801">v</span><span class="op" id="1521802">)</span>&nbsp;<span class="op" id="1521804">&gt;&gt;</span>&nbsp;<span class="ident" id="1521807">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521818">q</span>&nbsp;<span class="op" id="1521820">:=</span>&nbsp;<span class="ident" id="1521823">p</span>&nbsp;<span class="op" id="1521825">-</span>&nbsp;<span class="ident" id="1521827">arena_start</span><span class="op" id="1521838">&gt;&gt;</span><span class="ident" id="1521840">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521851">s</span>&nbsp;<span class="op" id="1521853">=</span>&nbsp;<span class="op" id="1521855">*</span><span class="op" id="1521856">(</span><span class="op" id="1521857">*</span><span class="op" id="1521858">*</span><span class="ident" id="1521859">mspan</span><span class="op" id="1521864">)</span><span class="op" id="1521865">(</span><span class="ident" id="1521866">add</span><span class="op" id="1521869">(</span><span class="ident" id="1521870">unsafe</span><span class="op" id="1521876">.</span><span class="ident" id="1521877">Pointer</span><span class="op" id="1521884">(</span><span class="ident" id="1521885">mheap_</span><span class="op" id="1521891">.</span><span class="ident" id="1521892">spans</span><span class="op" id="1521897">)</span><span class="op" id="1521898">,</span>&nbsp;<span class="ident" id="1521900">q</span><span class="op" id="1521901">*</span><span class="ident" id="1521902">ptrSize</span><span class="op" id="1521909">)</span><span class="op" id="1521910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521913">if</span>&nbsp;<span class="ident" id="1521916">s</span>&nbsp;<span class="op" id="1521918">==</span>&nbsp;<span class="builtintype" id="1521921">nil</span>&nbsp;<span class="op" id="1521925">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521929">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1521937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1521940">x</span>&nbsp;<span class="op" id="1521942">=</span>&nbsp;<span class="ident" id="1521944">unsafe</span><span class="op" id="1521950">.</span><span class="ident" id="1521951">Pointer</span><span class="op" id="1521958">(</span><span class="builtintype" id="1521959">uintptr</span><span class="op" id="1521966">(</span><span class="ident" id="1521967">s</span><span class="op" id="1521968">.</span><span class="ident" id="1521969">start</span><span class="op" id="1521974">)</span>&nbsp;<span class="op" id="1521976">&lt;&lt;</span>&nbsp;<span class="ident" id="1521979">pageShift</span><span class="op" id="1521988">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1521992">if</span>&nbsp;<span class="builtintype" id="1521995">uintptr</span><span class="op" id="1522002">(</span><span class="ident" id="1522003">v</span><span class="op" id="1522004">)</span>&nbsp;<span class="op" id="1522006">&lt;</span>&nbsp;<span class="builtintype" id="1522008">uintptr</span><span class="op" id="1522015">(</span><span class="ident" id="1522016">x</span><span class="op" id="1522017">)</span>&nbsp;<span class="op" id="1522019">||</span>&nbsp;<span class="builtintype" id="1522022">uintptr</span><span class="op" id="1522029">(</span><span class="ident" id="1522030">v</span><span class="op" id="1522031">)</span>&nbsp;<span class="op" id="1522033">&gt;=</span>&nbsp;<span class="builtintype" id="1522036">uintptr</span><span class="op" id="1522043">(</span><span class="ident" id="1522044">unsafe</span><span class="op" id="1522050">.</span><span class="ident" id="1522051">Pointer</span><span class="op" id="1522058">(</span><span class="ident" id="1522059">s</span><span class="op" id="1522060">.</span><span class="ident" id="1522061">limit</span><span class="op" id="1522066">)</span><span class="op" id="1522067">)</span>&nbsp;<span class="op" id="1522069">||</span>&nbsp;<span class="ident" id="1522072">s</span><span class="op" id="1522073">.</span><span class="ident" id="1522074">state</span>&nbsp;<span class="op" id="1522080">!=</span>&nbsp;<span class="ident" id="1522083">mSpanInUse</span>&nbsp;<span class="op" id="1522094">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522098">s</span>&nbsp;<span class="op" id="1522100">=</span>&nbsp;<span class="builtintype" id="1522102">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522108">x</span>&nbsp;<span class="op" id="1522110">=</span>&nbsp;<span class="builtintype" id="1522112">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522118">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1522126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522130">n</span>&nbsp;<span class="op" id="1522132">=</span>&nbsp;<span class="builtintype" id="1522134">uintptr</span><span class="op" id="1522141">(</span><span class="ident" id="1522142">s</span><span class="op" id="1522143">.</span><span class="ident" id="1522144">elemsize</span><span class="op" id="1522152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522155">if</span>&nbsp;<span class="ident" id="1522158">s</span><span class="op" id="1522159">.</span><span class="ident" id="1522160">sizeclass</span>&nbsp;<span class="op" id="1522170">!=</span>&nbsp;<span class="num" id="1522173">0</span>&nbsp;<span class="op" id="1522175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522179">x</span>&nbsp;<span class="op" id="1522181">=</span>&nbsp;<span class="ident" id="1522183">add</span><span class="op" id="1522186">(</span><span class="ident" id="1522187">x</span><span class="op" id="1522188">,</span>&nbsp;<span class="op" id="1522190">(</span><span class="builtintype" id="1522191">uintptr</span><span class="op" id="1522198">(</span><span class="ident" id="1522199">v</span><span class="op" id="1522200">)</span><span class="op" id="1522201">-</span><span class="builtintype" id="1522202">uintptr</span><span class="op" id="1522209">(</span><span class="ident" id="1522210">x</span><span class="op" id="1522211">)</span><span class="op" id="1522212">)</span><span class="op" id="1522213">/</span><span class="ident" id="1522214">n</span><span class="op" id="1522215">*</span><span class="ident" id="1522216">n</span><span class="op" id="1522217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1522220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522223">return</span><br>
<span class="lineno">700</span><span class="op" id="1522230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1522233">var</span>&nbsp;<span class="ident" id="1522237">fingCreate</span>&nbsp;<span class="builtintype" id="1522248">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1522256">func</span>&nbsp;<span class="ident" id="1522261">createfing</span><span class="op" id="1522271">(</span><span class="op" id="1522272">)</span>&nbsp;<span class="op" id="1522274">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1522277">//&nbsp;start&nbsp;the&nbsp;finalizer&nbsp;goroutine&nbsp;exactly&nbsp;once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522324">if</span>&nbsp;<span class="ident" id="1522327">fingCreate</span>&nbsp;<span class="op" id="1522338">==</span>&nbsp;<span class="num" id="1522341">0</span>&nbsp;<span class="op" id="1522343">&amp;&amp;</span>&nbsp;<span class="ident" id="1522346">cas</span><span class="op" id="1522349">(</span><span class="op" id="1522350">&amp;</span><span class="ident" id="1522351">fingCreate</span><span class="op" id="1522361">,</span>&nbsp;<span class="num" id="1522363">0</span><span class="op" id="1522364">,</span>&nbsp;<span class="num" id="1522366">1</span><span class="op" id="1522367">)</span>&nbsp;<span class="op" id="1522369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522373">go</span>&nbsp;<span class="ident" id="1522376">runfinq</span><span class="op" id="1522383">(</span><span class="op" id="1522384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1522387">}</span><br>
<span class="lineno"></span><span class="op" id="1522389">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="1522392">//&nbsp;This&nbsp;is&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;runs&nbsp;all&nbsp;of&nbsp;the&nbsp;finalizers</span><br>
<span class="lineno"></span><span class="keyword" id="1522449">func</span>&nbsp;<span class="ident" id="1522454">runfinq</span><span class="op" id="1522461">(</span><span class="op" id="1522462">)</span>&nbsp;<span class="op" id="1522464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522467">var</span>&nbsp;<span class="op" id="1522471">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522475">frame</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522484">unsafe</span><span class="op" id="1522490">.</span><span class="ident" id="1522491">Pointer</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522501">framecap</span>&nbsp;<span class="builtintype" id="1522510">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1522519">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522523">for</span>&nbsp;<span class="op" id="1522527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522531">lock</span><span class="op" id="1522535">(</span><span class="op" id="1522536">&amp;</span><span class="ident" id="1522537">finlock</span><span class="op" id="1522544">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522548">fb</span>&nbsp;<span class="op" id="1522551">:=</span>&nbsp;<span class="ident" id="1522554">finq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522561">finq</span>&nbsp;<span class="op" id="1522566">=</span>&nbsp;<span class="builtintype" id="1522568">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522574">if</span>&nbsp;<span class="ident" id="1522577">fb</span>&nbsp;<span class="op" id="1522580">==</span>&nbsp;<span class="builtintype" id="1522583">nil</span>&nbsp;<span class="op" id="1522587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522592">gp</span>&nbsp;<span class="op" id="1522595">:=</span>&nbsp;<span class="ident" id="1522598">getg</span><span class="op" id="1522602">(</span><span class="op" id="1522603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522608">fing</span>&nbsp;<span class="op" id="1522613">=</span>&nbsp;<span class="ident" id="1522615">gp</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522621">fingwait</span>&nbsp;<span class="op" id="1522630">=</span>&nbsp;<span class="builtintype" id="1522632">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522640">gp</span><span class="op" id="1522642">.</span><span class="ident" id="1522643">issystem</span>&nbsp;<span class="op" id="1522652">=</span>&nbsp;<span class="builtintype" id="1522654">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522662">goparkunlock</span><span class="op" id="1522674">(</span><span class="op" id="1522675">&amp;</span><span class="ident" id="1522676">finlock</span><span class="op" id="1522683">,</span>&nbsp;<span class="string" id="1522685">&#34;finalizer&nbsp;wait&#34;</span><span class="op" id="1522701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522706">gp</span><span class="op" id="1522708">.</span><span class="ident" id="1522709">issystem</span>&nbsp;<span class="op" id="1522718">=</span>&nbsp;<span class="builtintype" id="1522720">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522729">continue</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1522740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522744">unlock</span><span class="op" id="1522750">(</span><span class="op" id="1522751">&amp;</span><span class="ident" id="1522752">finlock</span><span class="op" id="1522759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522763">if</span>&nbsp;<span class="ident" id="1522766">raceenabled</span>&nbsp;<span class="op" id="1522778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522783">racefingo</span><span class="op" id="1522792">(</span><span class="op" id="1522793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1522797">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522801">for</span>&nbsp;<span class="ident" id="1522805">fb</span>&nbsp;<span class="op" id="1522808">!=</span>&nbsp;<span class="builtintype" id="1522811">nil</span>&nbsp;<span class="op" id="1522815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1522820">for</span>&nbsp;<span class="ident" id="1522824">i</span>&nbsp;<span class="op" id="1522826">:=</span>&nbsp;<span class="builtintype" id="1522829">int32</span><span class="op" id="1522834">(</span><span class="num" id="1522835">0</span><span class="op" id="1522836">)</span><span class="op" id="1522837">;</span>&nbsp;<span class="ident" id="1522839">i</span>&nbsp;<span class="op" id="1522841">&lt;</span>&nbsp;<span class="ident" id="1522843">fb</span><span class="op" id="1522845">.</span><span class="ident" id="1522846">cnt</span><span class="op" id="1522849">;</span>&nbsp;<span class="ident" id="1522851">i</span><span class="op" id="1522852">++</span>&nbsp;<span class="op" id="1522855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522861">f</span>&nbsp;<span class="op" id="1522863">:=</span>&nbsp;<span class="op" id="1522866">(</span><span class="op" id="1522867">*</span><span class="ident" id="1522868">finalizer</span><span class="op" id="1522877">)</span><span class="op" id="1522878">(</span><span class="ident" id="1522879">add</span><span class="op" id="1522882">(</span><span class="ident" id="1522883">unsafe</span><span class="op" id="1522889">.</span><span class="ident" id="1522890">Pointer</span><span class="op" id="1522897">(</span><span class="op" id="1522898">&amp;</span><span class="ident" id="1522899">fb</span><span class="op" id="1522901">.</span><span class="ident" id="1522902">fin</span><span class="op" id="1522905">)</span><span class="op" id="1522906">,</span>&nbsp;<span class="builtintype" id="1522908">uintptr</span><span class="op" id="1522915">(</span><span class="ident" id="1522916">i</span><span class="op" id="1522917">)</span><span class="op" id="1522918">*</span><span class="ident" id="1522919">unsafe</span><span class="op" id="1522925">.</span><span class="ident" id="1522926">Sizeof</span><span class="op" id="1522932">(</span><span class="ident" id="1522933">finalizer</span><span class="op" id="1522942">{</span><span class="op" id="1522943">}</span><span class="op" id="1522944">)</span><span class="op" id="1522945">)</span><span class="op" id="1522946">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1522953">framesz</span>&nbsp;<span class="op" id="1522961">:=</span>&nbsp;<span class="ident" id="1522964">unsafe</span><span class="op" id="1522970">.</span><span class="ident" id="1522971">Sizeof</span><span class="op" id="1522977">(</span><span class="op" id="1522978">(</span><span class="keyword" id="1522979">interface</span><span class="op" id="1522988">{</span><span class="op" id="1522989">}</span><span class="op" id="1522990">)</span><span class="op" id="1522991">(</span><span class="builtintype" id="1522992">nil</span><span class="op" id="1522995">)</span><span class="op" id="1522996">)</span>&nbsp;<span class="op" id="1522998">+</span>&nbsp;<span class="builtintype" id="1523000">uintptr</span><span class="op" id="1523007">(</span><span class="ident" id="1523008">f</span><span class="op" id="1523009">.</span><span class="ident" id="1523010">nret</span><span class="op" id="1523014">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523020">if</span>&nbsp;<span class="ident" id="1523023">framecap</span>&nbsp;<span class="op" id="1523032">&lt;</span>&nbsp;<span class="ident" id="1523034">framesz</span>&nbsp;<span class="op" id="1523042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523049">//&nbsp;The&nbsp;frame&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523113">//&nbsp;all&nbsp;not&nbsp;yet&nbsp;finalized&nbsp;objects&nbsp;are&nbsp;stored&nbsp;in&nbsp;finq.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523171">//&nbsp;If&nbsp;we&nbsp;do&nbsp;not&nbsp;mark&nbsp;it&nbsp;as&nbsp;FlagNoScan,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523215">//&nbsp;the&nbsp;last&nbsp;finalized&nbsp;object&nbsp;is&nbsp;not&nbsp;collected.</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1523267">frame</span>&nbsp;<span class="op" id="1523273">=</span>&nbsp;<span class="ident" id="1523275">mallocgc</span><span class="op" id="1523283">(</span><span class="ident" id="1523284">framesz</span><span class="op" id="1523291">,</span>&nbsp;<span class="builtintype" id="1523293">nil</span><span class="op" id="1523296">,</span>&nbsp;<span class="ident" id="1523298">flagNoScan</span><span class="op" id="1523308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1523315">framecap</span>&nbsp;<span class="op" id="1523324">=</span>&nbsp;<span class="ident" id="1523326">framesz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1523338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523345">if</span>&nbsp;<span class="ident" id="1523348">f</span><span class="op" id="1523349">.</span><span class="ident" id="1523350">fint</span>&nbsp;<span class="op" id="1523355">==</span>&nbsp;<span class="builtintype" id="1523358">nil</span>&nbsp;<span class="op" id="1523362">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1523369">gothrow</span><span class="op" id="1523376">(</span><span class="string" id="1523377">&#34;missing&nbsp;type&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1523402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1523408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523414">switch</span>&nbsp;<span class="ident" id="1523421">f</span><span class="op" id="1523422">.</span><span class="ident" id="1523423">fint</span><span class="op" id="1523427">.</span><span class="ident" id="1523428">kind</span>&nbsp;<span class="op" id="1523433">&amp;</span>&nbsp;<span class="ident" id="1523435">kindMask</span>&nbsp;<span class="op" id="1523444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523450">case</span>&nbsp;<span class="ident" id="1523455">kindPtr</span><span class="op" id="1523462">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523469">//&nbsp;direct&nbsp;use&nbsp;of&nbsp;pointer</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1523499">*</span><span class="op" id="1523500">(</span><span class="op" id="1523501">*</span><span class="ident" id="1523502">unsafe</span><span class="op" id="1523508">.</span><span class="ident" id="1523509">Pointer</span><span class="op" id="1523516">)</span><span class="op" id="1523517">(</span><span class="ident" id="1523518">frame</span><span class="op" id="1523523">)</span>&nbsp;<span class="op" id="1523525">=</span>&nbsp;<span class="ident" id="1523527">f</span><span class="op" id="1523528">.</span><span class="ident" id="1523529">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523537">case</span>&nbsp;<span class="ident" id="1523542">kindInterface</span><span class="op" id="1523555">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1523562">ityp</span>&nbsp;<span class="op" id="1523567">:=</span>&nbsp;<span class="op" id="1523570">(</span><span class="op" id="1523571">*</span><span class="ident" id="1523572">interfacetype</span><span class="op" id="1523585">)</span><span class="op" id="1523586">(</span><span class="ident" id="1523587">unsafe</span><span class="op" id="1523593">.</span><span class="ident" id="1523594">Pointer</span><span class="op" id="1523601">(</span><span class="ident" id="1523602">f</span><span class="op" id="1523603">.</span><span class="ident" id="1523604">fint</span><span class="op" id="1523608">)</span><span class="op" id="1523609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523616">//&nbsp;set&nbsp;up&nbsp;with&nbsp;empty&nbsp;interface</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1523652">(</span><span class="op" id="1523653">*</span><span class="ident" id="1523654">eface</span><span class="op" id="1523659">)</span><span class="op" id="1523660">(</span><span class="ident" id="1523661">frame</span><span class="op" id="1523666">)</span><span class="op" id="1523667">.</span><span class="ident" id="1523668">_type</span>&nbsp;<span class="op" id="1523674">=</span>&nbsp;<span class="op" id="1523676">&amp;</span><span class="ident" id="1523677">f</span><span class="op" id="1523678">.</span><span class="ident" id="1523679">ot</span><span class="op" id="1523681">.</span><span class="ident" id="1523682">typ</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1523691">(</span><span class="op" id="1523692">*</span><span class="ident" id="1523693">eface</span><span class="op" id="1523698">)</span><span class="op" id="1523699">(</span><span class="ident" id="1523700">frame</span><span class="op" id="1523705">)</span><span class="op" id="1523706">.</span><span class="ident" id="1523707">data</span>&nbsp;<span class="op" id="1523712">=</span>&nbsp;<span class="ident" id="1523714">f</span><span class="op" id="1523715">.</span><span class="ident" id="1523716">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523725">if</span>&nbsp;<span class="builtinfunc" id="1523728">len</span><span class="op" id="1523731">(</span><span class="ident" id="1523732">ityp</span><span class="op" id="1523736">.</span><span class="ident" id="1523737">mhdr</span><span class="op" id="1523741">)</span>&nbsp;<span class="op" id="1523743">!=</span>&nbsp;<span class="num" id="1523746">0</span>&nbsp;<span class="op" id="1523748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523756">//&nbsp;convert&nbsp;to&nbsp;interface&nbsp;with&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1523799">//&nbsp;this&nbsp;conversion&nbsp;is&nbsp;guaranteed&nbsp;to&nbsp;succeed&nbsp;-&nbsp;we&nbsp;checked&nbsp;in&nbsp;SetFinalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1523878">*</span><span class="op" id="1523879">(</span><span class="op" id="1523880">*</span><span class="ident" id="1523881">fInterface</span><span class="op" id="1523891">)</span><span class="op" id="1523892">(</span><span class="ident" id="1523893">frame</span><span class="op" id="1523898">)</span>&nbsp;<span class="op" id="1523900">=</span>&nbsp;<span class="ident" id="1523902">assertE2I</span><span class="op" id="1523911">(</span><span class="ident" id="1523912">ityp</span><span class="op" id="1523916">,</span>&nbsp;<span class="op" id="1523918">*</span><span class="op" id="1523919">(</span><span class="op" id="1523920">*</span><span class="keyword" id="1523921">interface</span><span class="op" id="1523930">{</span><span class="op" id="1523931">}</span><span class="op" id="1523932">)</span><span class="op" id="1523933">(</span><span class="ident" id="1523934">frame</span><span class="op" id="1523939">)</span><span class="op" id="1523940">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1523947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1523953">default</span><span class="op" id="1523960">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1523967">gothrow</span><span class="op" id="1523974">(</span><span class="string" id="1523975">&#34;bad&nbsp;kind&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1523996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524008">reflectcall</span><span class="op" id="1524019">(</span><span class="ident" id="1524020">unsafe</span><span class="op" id="1524026">.</span><span class="ident" id="1524027">Pointer</span><span class="op" id="1524034">(</span><span class="ident" id="1524035">f</span><span class="op" id="1524036">.</span><span class="ident" id="1524037">fn</span><span class="op" id="1524039">)</span><span class="op" id="1524040">,</span>&nbsp;<span class="ident" id="1524042">frame</span><span class="op" id="1524047">,</span>&nbsp;<span class="builtintype" id="1524049">uint32</span><span class="op" id="1524055">(</span><span class="ident" id="1524056">framesz</span><span class="op" id="1524063">)</span><span class="op" id="1524064">,</span>&nbsp;<span class="builtintype" id="1524066">uint32</span><span class="op" id="1524072">(</span><span class="ident" id="1524073">framesz</span><span class="op" id="1524080">)</span><span class="op" id="1524081">)</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1524088">//&nbsp;drop&nbsp;finalizer&nbsp;queue&nbsp;references&nbsp;to&nbsp;finalized&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524147">f</span><span class="op" id="1524148">.</span><span class="ident" id="1524149">fn</span>&nbsp;<span class="op" id="1524152">=</span>&nbsp;<span class="builtintype" id="1524154">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524162">f</span><span class="op" id="1524163">.</span><span class="ident" id="1524164">arg</span>&nbsp;<span class="op" id="1524168">=</span>&nbsp;<span class="builtintype" id="1524170">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524178">f</span><span class="op" id="1524179">.</span><span class="ident" id="1524180">ot</span>&nbsp;<span class="op" id="1524183">=</span>&nbsp;<span class="builtintype" id="1524185">nil</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524197">fb</span><span class="op" id="1524199">.</span><span class="ident" id="1524200">cnt</span>&nbsp;<span class="op" id="1524204">=</span>&nbsp;<span class="num" id="1524206">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524211">next</span>&nbsp;<span class="op" id="1524216">:=</span>&nbsp;<span class="ident" id="1524219">fb</span><span class="op" id="1524221">.</span><span class="ident" id="1524222">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524230">lock</span><span class="op" id="1524234">(</span><span class="op" id="1524235">&amp;</span><span class="ident" id="1524236">finlock</span><span class="op" id="1524243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524248">fb</span><span class="op" id="1524250">.</span><span class="ident" id="1524251">next</span>&nbsp;<span class="op" id="1524256">=</span>&nbsp;<span class="ident" id="1524258">finc</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524266">finc</span>&nbsp;<span class="op" id="1524271">=</span>&nbsp;<span class="ident" id="1524273">fb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524279">unlock</span><span class="op" id="1524285">(</span><span class="op" id="1524286">&amp;</span><span class="ident" id="1524287">finlock</span><span class="op" id="1524294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524299">fb</span>&nbsp;<span class="op" id="1524302">=</span>&nbsp;<span class="ident" id="1524304">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524314">}</span><br>
<span class="lineno">785</span><span class="op" id="1524316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1524319">var</span>&nbsp;<span class="ident" id="1524323">persistent</span>&nbsp;<span class="keyword" id="1524334">struct</span>&nbsp;<span class="op" id="1524341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524344">lock</span>&nbsp;<span class="ident" id="1524349">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524356">pos</span>&nbsp;&nbsp;<span class="ident" id="1524361">unsafe</span><span class="op" id="1524367">.</span><span class="ident" id="1524368">Pointer</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524377">end</span>&nbsp;&nbsp;<span class="ident" id="1524382">unsafe</span><span class="op" id="1524388">.</span><span class="ident" id="1524389">Pointer</span><br>
<span class="lineno"></span><span class="op" id="1524397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1524400">//&nbsp;Wrapper&nbsp;around&nbsp;sysAlloc&nbsp;that&nbsp;can&nbsp;allocate&nbsp;small&nbsp;chunks.</span><br>
<span class="lineno"></span><span class="comment" id="1524459">//&nbsp;There&nbsp;is&nbsp;no&nbsp;associated&nbsp;free&nbsp;operation.</span><br>
<span class="lineno">795</span><span class="comment" id="1524501">//&nbsp;Intended&nbsp;for&nbsp;things&nbsp;like&nbsp;function/type/debug-related&nbsp;persistent&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1524574">//&nbsp;If&nbsp;align&nbsp;is&nbsp;0,&nbsp;uses&nbsp;default&nbsp;align&nbsp;(currently&nbsp;8).</span><br>
<span class="lineno"></span><span class="keyword" id="1524626">func</span>&nbsp;<span class="ident" id="1524631">persistentalloc</span><span class="op" id="1524646">(</span><span class="ident" id="1524647">size</span><span class="op" id="1524651">,</span>&nbsp;<span class="ident" id="1524653">align</span>&nbsp;<span class="builtintype" id="1524659">uintptr</span><span class="op" id="1524666">,</span>&nbsp;<span class="ident" id="1524668">stat</span>&nbsp;<span class="op" id="1524673">*</span><span class="builtintype" id="1524674">uint64</span><span class="op" id="1524680">)</span>&nbsp;<span class="ident" id="1524682">unsafe</span><span class="op" id="1524688">.</span><span class="ident" id="1524689">Pointer</span>&nbsp;<span class="op" id="1524697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1524700">const</span>&nbsp;<span class="op" id="1524706">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524710">chunk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524719">=</span>&nbsp;<span class="num" id="1524721">256</span>&nbsp;<span class="op" id="1524725">&lt;&lt;</span>&nbsp;<span class="num" id="1524728">10</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524733">maxBlock</span>&nbsp;<span class="op" id="1524742">=</span>&nbsp;<span class="num" id="1524744">64</span>&nbsp;<span class="op" id="1524747">&lt;&lt;</span>&nbsp;<span class="num" id="1524750">10</span>&nbsp;<span class="comment" id="1524753">//&nbsp;VM&nbsp;reservation&nbsp;granularity&nbsp;is&nbsp;64K&nbsp;on&nbsp;windows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524802">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1524806">if</span>&nbsp;<span class="ident" id="1524809">align</span>&nbsp;<span class="op" id="1524815">!=</span>&nbsp;<span class="num" id="1524818">0</span>&nbsp;<span class="op" id="1524820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1524824">if</span>&nbsp;<span class="ident" id="1524827">align</span><span class="op" id="1524832">&amp;</span><span class="op" id="1524833">(</span><span class="ident" id="1524834">align</span><span class="op" id="1524839">-</span><span class="num" id="1524840">1</span><span class="op" id="1524841">)</span>&nbsp;<span class="op" id="1524843">!=</span>&nbsp;<span class="num" id="1524846">0</span>&nbsp;<span class="op" id="1524848">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524853">gothrow</span><span class="op" id="1524860">(</span><span class="string" id="1524861">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;not&nbsp;a&nbsp;power&nbsp;of&nbsp;2&#34;</span><span class="op" id="1524905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1524913">if</span>&nbsp;<span class="ident" id="1524916">align</span>&nbsp;<span class="op" id="1524922">&gt;</span>&nbsp;<span class="ident" id="1524924">_PageSize</span>&nbsp;<span class="op" id="1524934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524939">gothrow</span><span class="op" id="1524946">(</span><span class="string" id="1524947">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;too&nbsp;large&#34;</span><span class="op" id="1524984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524988">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1524991">}</span>&nbsp;<span class="keyword" id="1524993">else</span>&nbsp;<span class="op" id="1524998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525002">align</span>&nbsp;<span class="op" id="1525008">=</span>&nbsp;<span class="num" id="1525010">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1525017">if</span>&nbsp;<span class="ident" id="1525020">size</span>&nbsp;<span class="op" id="1525025">&gt;=</span>&nbsp;<span class="ident" id="1525028">maxBlock</span>&nbsp;<span class="op" id="1525037">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1525041">return</span>&nbsp;<span class="ident" id="1525048">sysAlloc</span><span class="op" id="1525056">(</span><span class="ident" id="1525057">size</span><span class="op" id="1525061">,</span>&nbsp;<span class="ident" id="1525063">stat</span><span class="op" id="1525067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525074">lock</span><span class="op" id="1525078">(</span><span class="op" id="1525079">&amp;</span><span class="ident" id="1525080">persistent</span><span class="op" id="1525090">.</span><span class="ident" id="1525091">lock</span><span class="op" id="1525095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525098">persistent</span><span class="op" id="1525108">.</span><span class="ident" id="1525109">pos</span>&nbsp;<span class="op" id="1525113">=</span>&nbsp;<span class="ident" id="1525115">roundup</span><span class="op" id="1525122">(</span><span class="ident" id="1525123">persistent</span><span class="op" id="1525133">.</span><span class="ident" id="1525134">pos</span><span class="op" id="1525137">,</span>&nbsp;<span class="ident" id="1525139">align</span><span class="op" id="1525144">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1525147">if</span>&nbsp;<span class="builtintype" id="1525150">uintptr</span><span class="op" id="1525157">(</span><span class="ident" id="1525158">persistent</span><span class="op" id="1525168">.</span><span class="ident" id="1525169">pos</span><span class="op" id="1525172">)</span><span class="op" id="1525173">+</span><span class="ident" id="1525174">size</span>&nbsp;<span class="op" id="1525179">&gt;</span>&nbsp;<span class="builtintype" id="1525181">uintptr</span><span class="op" id="1525188">(</span><span class="ident" id="1525189">persistent</span><span class="op" id="1525199">.</span><span class="ident" id="1525200">end</span><span class="op" id="1525203">)</span>&nbsp;<span class="op" id="1525205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525209">persistent</span><span class="op" id="1525219">.</span><span class="ident" id="1525220">pos</span>&nbsp;<span class="op" id="1525224">=</span>&nbsp;<span class="ident" id="1525226">sysAlloc</span><span class="op" id="1525234">(</span><span class="ident" id="1525235">chunk</span><span class="op" id="1525240">,</span>&nbsp;<span class="op" id="1525242">&amp;</span><span class="ident" id="1525243">memstats</span><span class="op" id="1525251">.</span><span class="ident" id="1525252">other_sys</span><span class="op" id="1525261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1525265">if</span>&nbsp;<span class="ident" id="1525268">persistent</span><span class="op" id="1525278">.</span><span class="ident" id="1525279">pos</span>&nbsp;<span class="op" id="1525283">==</span>&nbsp;<span class="builtintype" id="1525286">nil</span>&nbsp;<span class="op" id="1525290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525295">unlock</span><span class="op" id="1525301">(</span><span class="op" id="1525302">&amp;</span><span class="ident" id="1525303">persistent</span><span class="op" id="1525313">.</span><span class="ident" id="1525314">lock</span><span class="op" id="1525318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525323">gothrow</span><span class="op" id="1525330">(</span><span class="string" id="1525331">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1525364">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525372">persistent</span><span class="op" id="1525382">.</span><span class="ident" id="1525383">end</span>&nbsp;<span class="op" id="1525387">=</span>&nbsp;<span class="ident" id="1525389">add</span><span class="op" id="1525392">(</span><span class="ident" id="1525393">persistent</span><span class="op" id="1525403">.</span><span class="ident" id="1525404">pos</span><span class="op" id="1525407">,</span>&nbsp;<span class="ident" id="1525409">chunk</span><span class="op" id="1525414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525420">p</span>&nbsp;<span class="op" id="1525422">:=</span>&nbsp;<span class="ident" id="1525425">persistent</span><span class="op" id="1525435">.</span><span class="ident" id="1525436">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525441">persistent</span><span class="op" id="1525451">.</span><span class="ident" id="1525452">pos</span>&nbsp;<span class="op" id="1525456">=</span>&nbsp;<span class="ident" id="1525458">add</span><span class="op" id="1525461">(</span><span class="ident" id="1525462">persistent</span><span class="op" id="1525472">.</span><span class="ident" id="1525473">pos</span><span class="op" id="1525476">,</span>&nbsp;<span class="ident" id="1525478">size</span><span class="op" id="1525482">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525485">unlock</span><span class="op" id="1525491">(</span><span class="op" id="1525492">&amp;</span><span class="ident" id="1525493">persistent</span><span class="op" id="1525503">.</span><span class="ident" id="1525504">lock</span><span class="op" id="1525508">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1525512">if</span>&nbsp;<span class="ident" id="1525515">stat</span>&nbsp;<span class="op" id="1525520">!=</span>&nbsp;<span class="op" id="1525523">&amp;</span><span class="ident" id="1525524">memstats</span><span class="op" id="1525532">.</span><span class="ident" id="1525533">other_sys</span>&nbsp;<span class="op" id="1525543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525547">xadd64</span><span class="op" id="1525553">(</span><span class="ident" id="1525554">stat</span><span class="op" id="1525558">,</span>&nbsp;<span class="builtintype" id="1525560">int64</span><span class="op" id="1525565">(</span><span class="ident" id="1525566">size</span><span class="op" id="1525570">)</span><span class="op" id="1525571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1525575">xadd64</span><span class="op" id="1525581">(</span><span class="op" id="1525582">&amp;</span><span class="ident" id="1525583">memstats</span><span class="op" id="1525591">.</span><span class="ident" id="1525592">other_sys</span><span class="op" id="1525601">,</span>&nbsp;<span class="op" id="1525603">-</span><span class="builtintype" id="1525604">int64</span><span class="op" id="1525609">(</span><span class="ident" id="1525610">size</span><span class="op" id="1525614">)</span><span class="op" id="1525615">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1525621">return</span>&nbsp;<span class="ident" id="1525628">p</span><br>
<span class="lineno"></span><span class="op" id="1525630">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
