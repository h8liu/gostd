<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3616589">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3616644">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3616698">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3616749">//&nbsp;CFB&nbsp;(Cipher&nbsp;Feedback)&nbsp;Mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3616781">package</span>&nbsp;<span class="ident" id="3616789">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3616797">type</span>&nbsp;<span class="ident" id="3616802">cfb</span>&nbsp;<span class="keyword" id="3616806">struct</span>&nbsp;<span class="op" id="3616813">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616816">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3616824">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616831">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3616839">[</span><span class="op" id="3616840">]</span><span class="builtintype" id="3616841">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616847">out</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3616855">[</span><span class="op" id="3616856">]</span><span class="builtintype" id="3616857">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616863">outUsed</span>&nbsp;<span class="builtintype" id="3616871">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616877">decrypt</span>&nbsp;<span class="builtintype" id="3616885">bool</span><br>
<span class="lineno"></span><span class="op" id="3616890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3616893">func</span>&nbsp;<span class="op" id="3616898">(</span><span class="ident" id="3616899">x</span>&nbsp;<span class="op" id="3616901">*</span><span class="ident" id="3616902">cfb</span><span class="op" id="3616905">)</span>&nbsp;<span class="ident" id="3616907">XORKeyStream</span><span class="op" id="3616919">(</span><span class="ident" id="3616920">dst</span><span class="op" id="3616923">,</span>&nbsp;<span class="ident" id="3616925">src</span>&nbsp;<span class="op" id="3616929">[</span><span class="op" id="3616930">]</span><span class="builtintype" id="3616931">byte</span><span class="op" id="3616935">)</span>&nbsp;<span class="op" id="3616937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616940">for</span>&nbsp;<span class="builtinfunc" id="3616944">len</span><span class="op" id="3616947">(</span><span class="ident" id="3616948">src</span><span class="op" id="3616951">)</span>&nbsp;<span class="op" id="3616953">&gt;</span>&nbsp;<span class="num" id="3616955">0</span>&nbsp;<span class="op" id="3616957">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3616961">if</span>&nbsp;<span class="ident" id="3616964">x</span><span class="op" id="3616965">.</span><span class="ident" id="3616966">outUsed</span>&nbsp;<span class="op" id="3616974">==</span>&nbsp;<span class="builtinfunc" id="3616977">len</span><span class="op" id="3616980">(</span><span class="ident" id="3616981">x</span><span class="op" id="3616982">.</span><span class="ident" id="3616983">out</span><span class="op" id="3616986">)</span>&nbsp;<span class="op" id="3616988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3616993">x</span><span class="op" id="3616994">.</span><span class="ident" id="3616995">b</span><span class="op" id="3616996">.</span><span class="ident" id="3616997">Encrypt</span><span class="op" id="3617004">(</span><span class="ident" id="3617005">x</span><span class="op" id="3617006">.</span><span class="ident" id="3617007">out</span><span class="op" id="3617010">,</span>&nbsp;<span class="ident" id="3617012">x</span><span class="op" id="3617013">.</span><span class="ident" id="3617014">next</span><span class="op" id="3617018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617023">x</span><span class="op" id="3617024">.</span><span class="ident" id="3617025">outUsed</span>&nbsp;<span class="op" id="3617033">=</span>&nbsp;<span class="num" id="3617035">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3617039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3617044">if</span>&nbsp;<span class="ident" id="3617047">x</span><span class="op" id="3617048">.</span><span class="ident" id="3617049">decrypt</span>&nbsp;<span class="op" id="3617057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617062">//&nbsp;We&nbsp;can&nbsp;precompute&nbsp;a&nbsp;larger&nbsp;segment&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617110">//&nbsp;keystream&nbsp;on&nbsp;decryption.&nbsp;This&nbsp;will&nbsp;allow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617157">//&nbsp;larger&nbsp;batches&nbsp;for&nbsp;xor,&nbsp;and&nbsp;we&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617204">//&nbsp;able&nbsp;to&nbsp;match&nbsp;CTR/OFB&nbsp;performance.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3617245">copy</span><span class="op" id="3617249">(</span><span class="ident" id="3617250">x</span><span class="op" id="3617251">.</span><span class="ident" id="3617252">next</span><span class="op" id="3617256">[</span><span class="ident" id="3617257">x</span><span class="op" id="3617258">.</span><span class="ident" id="3617259">outUsed</span><span class="op" id="3617266">:</span><span class="op" id="3617267">]</span><span class="op" id="3617268">,</span>&nbsp;<span class="ident" id="3617270">src</span><span class="op" id="3617273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3617277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617281">n</span>&nbsp;<span class="op" id="3617283">:=</span>&nbsp;<span class="ident" id="3617286">xorBytes</span><span class="op" id="3617294">(</span><span class="ident" id="3617295">dst</span><span class="op" id="3617298">,</span>&nbsp;<span class="ident" id="3617300">src</span><span class="op" id="3617303">,</span>&nbsp;<span class="ident" id="3617305">x</span><span class="op" id="3617306">.</span><span class="ident" id="3617307">out</span><span class="op" id="3617310">[</span><span class="ident" id="3617311">x</span><span class="op" id="3617312">.</span><span class="ident" id="3617313">outUsed</span><span class="op" id="3617320">:</span><span class="op" id="3617321">]</span><span class="op" id="3617322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3617326">if</span>&nbsp;<span class="op" id="3617329">!</span><span class="ident" id="3617330">x</span><span class="op" id="3617331">.</span><span class="ident" id="3617332">decrypt</span>&nbsp;<span class="op" id="3617340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3617345">copy</span><span class="op" id="3617349">(</span><span class="ident" id="3617350">x</span><span class="op" id="3617351">.</span><span class="ident" id="3617352">next</span><span class="op" id="3617356">[</span><span class="ident" id="3617357">x</span><span class="op" id="3617358">.</span><span class="ident" id="3617359">outUsed</span><span class="op" id="3617366">:</span><span class="op" id="3617367">]</span><span class="op" id="3617368">,</span>&nbsp;<span class="ident" id="3617370">dst</span><span class="op" id="3617373">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3617377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617381">dst</span>&nbsp;<span class="op" id="3617385">=</span>&nbsp;<span class="ident" id="3617387">dst</span><span class="op" id="3617390">[</span><span class="ident" id="3617391">n</span><span class="op" id="3617392">:</span><span class="op" id="3617393">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617397">src</span>&nbsp;<span class="op" id="3617401">=</span>&nbsp;<span class="ident" id="3617403">src</span><span class="op" id="3617406">[</span><span class="ident" id="3617407">n</span><span class="op" id="3617408">:</span><span class="op" id="3617409">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617413">x</span><span class="op" id="3617414">.</span><span class="ident" id="3617415">outUsed</span>&nbsp;<span class="op" id="3617423">+=</span>&nbsp;<span class="ident" id="3617426">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3617429">}</span><br>
<span class="lineno">40</span><span class="op" id="3617431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3617434">//&nbsp;NewCFBEncrypter&nbsp;returns&nbsp;a&nbsp;Stream&nbsp;which&nbsp;encrypts&nbsp;with&nbsp;cipher&nbsp;feedback&nbsp;mode,</span><br>
<span class="lineno"></span><span class="comment" id="3617512">//&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;length&nbsp;as&nbsp;the&nbsp;Block&#39;s&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3617590">//&nbsp;size.</span><br>
<span class="lineno">45</span><span class="keyword" id="3617599">func</span>&nbsp;<span class="ident" id="3617604">NewCFBEncrypter</span><span class="op" id="3617619">(</span><span class="ident" id="3617620">block</span>&nbsp;<span class="ident" id="3617626">Block</span><span class="op" id="3617631">,</span>&nbsp;<span class="ident" id="3617633">iv</span>&nbsp;<span class="op" id="3617636">[</span><span class="op" id="3617637">]</span><span class="builtintype" id="3617638">byte</span><span class="op" id="3617642">)</span>&nbsp;<span class="ident" id="3617644">Stream</span>&nbsp;<span class="op" id="3617651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3617654">return</span>&nbsp;<span class="ident" id="3617661">newCFB</span><span class="op" id="3617667">(</span><span class="ident" id="3617668">block</span><span class="op" id="3617673">,</span>&nbsp;<span class="ident" id="3617675">iv</span><span class="op" id="3617677">,</span>&nbsp;<span class="builtintype" id="3617679">false</span><span class="op" id="3617684">)</span><br>
<span class="lineno"></span><span class="op" id="3617686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3617689">//&nbsp;NewCFBDecrypter&nbsp;returns&nbsp;a&nbsp;Stream&nbsp;which&nbsp;decrypts&nbsp;with&nbsp;cipher&nbsp;feedback&nbsp;mode,</span><br>
<span class="lineno">50</span><span class="comment" id="3617767">//&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;length&nbsp;as&nbsp;the&nbsp;Block&#39;s&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3617845">//&nbsp;size.</span><br>
<span class="lineno"></span><span class="keyword" id="3617854">func</span>&nbsp;<span class="ident" id="3617859">NewCFBDecrypter</span><span class="op" id="3617874">(</span><span class="ident" id="3617875">block</span>&nbsp;<span class="ident" id="3617881">Block</span><span class="op" id="3617886">,</span>&nbsp;<span class="ident" id="3617888">iv</span>&nbsp;<span class="op" id="3617891">[</span><span class="op" id="3617892">]</span><span class="builtintype" id="3617893">byte</span><span class="op" id="3617897">)</span>&nbsp;<span class="ident" id="3617899">Stream</span>&nbsp;<span class="op" id="3617906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3617909">return</span>&nbsp;<span class="ident" id="3617916">newCFB</span><span class="op" id="3617922">(</span><span class="ident" id="3617923">block</span><span class="op" id="3617928">,</span>&nbsp;<span class="ident" id="3617930">iv</span><span class="op" id="3617932">,</span>&nbsp;<span class="builtintype" id="3617934">true</span><span class="op" id="3617938">)</span><br>
<span class="lineno"></span><span class="op" id="3617940">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="3617943">func</span>&nbsp;<span class="ident" id="3617948">newCFB</span><span class="op" id="3617954">(</span><span class="ident" id="3617955">block</span>&nbsp;<span class="ident" id="3617961">Block</span><span class="op" id="3617966">,</span>&nbsp;<span class="ident" id="3617968">iv</span>&nbsp;<span class="op" id="3617971">[</span><span class="op" id="3617972">]</span><span class="builtintype" id="3617973">byte</span><span class="op" id="3617977">,</span>&nbsp;<span class="ident" id="3617979">decrypt</span>&nbsp;<span class="builtintype" id="3617987">bool</span><span class="op" id="3617991">)</span>&nbsp;<span class="ident" id="3617993">Stream</span>&nbsp;<span class="op" id="3618000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618003">blockSize</span>&nbsp;<span class="op" id="3618013">:=</span>&nbsp;<span class="ident" id="3618016">block</span><span class="op" id="3618021">.</span><span class="ident" id="3618022">BlockSize</span><span class="op" id="3618031">(</span><span class="op" id="3618032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618035">if</span>&nbsp;<span class="builtinfunc" id="3618038">len</span><span class="op" id="3618041">(</span><span class="ident" id="3618042">iv</span><span class="op" id="3618044">)</span>&nbsp;<span class="op" id="3618046">!=</span>&nbsp;<span class="ident" id="3618049">blockSize</span>&nbsp;<span class="op" id="3618059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3618063">//&nbsp;stack&nbsp;trace&nbsp;will&nbsp;indicate&nbsp;whether&nbsp;it&nbsp;was&nbsp;de&nbsp;or&nbsp;encryption</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3618126">panic</span><span class="op" id="3618131">(</span><span class="string" id="3618132">&#34;cipher.newCFB:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3618180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3618183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618186">x</span>&nbsp;<span class="op" id="3618188">:=</span>&nbsp;<span class="op" id="3618191">&amp;</span><span class="ident" id="3618192">cfb</span><span class="op" id="3618195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618199">b</span><span class="op" id="3618200">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3618208">block</span><span class="op" id="3618213">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618217">out</span><span class="op" id="3618220">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3618226">make</span><span class="op" id="3618230">(</span><span class="op" id="3618231">[</span><span class="op" id="3618232">]</span><span class="builtintype" id="3618233">byte</span><span class="op" id="3618237">,</span>&nbsp;<span class="ident" id="3618239">blockSize</span><span class="op" id="3618248">)</span><span class="op" id="3618249">,</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618253">next</span><span class="op" id="3618257">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3618262">make</span><span class="op" id="3618266">(</span><span class="op" id="3618267">[</span><span class="op" id="3618268">]</span><span class="builtintype" id="3618269">byte</span><span class="op" id="3618273">,</span>&nbsp;<span class="ident" id="3618275">blockSize</span><span class="op" id="3618284">)</span><span class="op" id="3618285">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618289">outUsed</span><span class="op" id="3618296">:</span>&nbsp;<span class="ident" id="3618298">blockSize</span><span class="op" id="3618307">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618311">decrypt</span><span class="op" id="3618318">:</span>&nbsp;<span class="ident" id="3618320">decrypt</span><span class="op" id="3618327">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3618330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3618333">copy</span><span class="op" id="3618337">(</span><span class="ident" id="3618338">x</span><span class="op" id="3618339">.</span><span class="ident" id="3618340">next</span><span class="op" id="3618344">,</span>&nbsp;<span class="ident" id="3618346">iv</span><span class="op" id="3618348">)</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618352">return</span>&nbsp;<span class="ident" id="3618359">x</span><br>
<span class="lineno"></span><span class="op" id="3618361">}</span>
</div>
</body>
</html>
