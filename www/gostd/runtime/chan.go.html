<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1447807">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1447862">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1447916">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1447967">package</span>&nbsp;<span class="ident" id="1447975">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1447984">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;channels.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1448042">import</span>&nbsp;<span class="string" id="1448049">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1448059">const</span>&nbsp;<span class="op" id="1448065">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448068">maxAlign</span>&nbsp;&nbsp;<span class="op" id="1448078">=</span>&nbsp;<span class="num" id="1448080">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448083">hchanSize</span>&nbsp;<span class="op" id="1448093">=</span>&nbsp;<span class="ident" id="1448095">unsafe</span><span class="op" id="1448101">.</span><span class="ident" id="1448102">Sizeof</span><span class="op" id="1448108">(</span><span class="ident" id="1448109">hchan</span><span class="op" id="1448114">{</span><span class="op" id="1448115">}</span><span class="op" id="1448116">)</span>&nbsp;<span class="op" id="1448118">+</span>&nbsp;<span class="builtintype" id="1448120">uintptr</span><span class="op" id="1448127">(</span><span class="op" id="1448128">-</span><span class="builtintype" id="1448129">int</span><span class="op" id="1448132">(</span><span class="ident" id="1448133">unsafe</span><span class="op" id="1448139">.</span><span class="ident" id="1448140">Sizeof</span><span class="op" id="1448146">(</span><span class="ident" id="1448147">hchan</span><span class="op" id="1448152">{</span><span class="op" id="1448153">}</span><span class="op" id="1448154">)</span><span class="op" id="1448155">)</span><span class="op" id="1448156">&amp;</span><span class="op" id="1448157">(</span><span class="ident" id="1448158">maxAlign</span><span class="op" id="1448166">-</span><span class="num" id="1448167">1</span><span class="op" id="1448168">)</span><span class="op" id="1448169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448172">debugChan</span>&nbsp;<span class="op" id="1448182">=</span>&nbsp;<span class="builtintype" id="1448184">false</span><br>
<span class="lineno">15</span><span class="op" id="1448190">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1448193">//&nbsp;TODO(khr):&nbsp;make&nbsp;hchan.buf&nbsp;an&nbsp;unsafe.Pointer,&nbsp;not&nbsp;a&nbsp;*uint8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1448255">func</span>&nbsp;<span class="ident" id="1448260">makechan</span><span class="op" id="1448268">(</span><span class="ident" id="1448269">t</span>&nbsp;<span class="op" id="1448271">*</span><span class="ident" id="1448272">chantype</span><span class="op" id="1448280">,</span>&nbsp;<span class="ident" id="1448282">size</span>&nbsp;<span class="ident" id="1448287">int64</span><span class="op" id="1448292">)</span>&nbsp;<span class="op" id="1448294">*</span><span class="ident" id="1448295">hchan</span>&nbsp;<span class="op" id="1448301">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448304">elem</span>&nbsp;<span class="op" id="1448309">:=</span>&nbsp;<span class="ident" id="1448312">t</span><span class="op" id="1448313">.</span><span class="ident" id="1448314">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448321">//&nbsp;compiler&nbsp;checks&nbsp;this&nbsp;but&nbsp;be&nbsp;safe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448359">if</span>&nbsp;<span class="ident" id="1448362">elem</span><span class="op" id="1448366">.</span><span class="ident" id="1448367">size</span>&nbsp;<span class="op" id="1448372">&gt;=</span>&nbsp;<span class="num" id="1448375">1</span><span class="op" id="1448376">&lt;&lt;</span><span class="num" id="1448378">16</span>&nbsp;<span class="op" id="1448381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448385">gothrow</span><span class="op" id="1448392">(</span><span class="string" id="1448393">&#34;makechan:&nbsp;invalid&nbsp;channel&nbsp;element&nbsp;type&#34;</span><span class="op" id="1448433">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448439">if</span>&nbsp;<span class="ident" id="1448442">hchanSize</span><span class="op" id="1448451">%</span><span class="ident" id="1448452">maxAlign</span>&nbsp;<span class="op" id="1448461">!=</span>&nbsp;<span class="num" id="1448464">0</span>&nbsp;<span class="op" id="1448466">||</span>&nbsp;<span class="ident" id="1448469">elem</span><span class="op" id="1448473">.</span><span class="ident" id="1448474">align</span>&nbsp;<span class="op" id="1448480">&gt;</span>&nbsp;<span class="ident" id="1448482">maxAlign</span>&nbsp;<span class="op" id="1448491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448495">gothrow</span><span class="op" id="1448502">(</span><span class="string" id="1448503">&#34;makechan:&nbsp;bad&nbsp;alignment&#34;</span><span class="op" id="1448528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448534">if</span>&nbsp;<span class="ident" id="1448537">size</span>&nbsp;<span class="op" id="1448542">&lt;</span>&nbsp;<span class="num" id="1448544">0</span>&nbsp;<span class="op" id="1448546">||</span>&nbsp;<span class="ident" id="1448549">int64</span><span class="op" id="1448554">(</span><span class="builtintype" id="1448555">uintptr</span><span class="op" id="1448562">(</span><span class="ident" id="1448563">size</span><span class="op" id="1448567">)</span><span class="op" id="1448568">)</span>&nbsp;<span class="op" id="1448570">!=</span>&nbsp;<span class="ident" id="1448573">size</span>&nbsp;<span class="op" id="1448578">||</span>&nbsp;<span class="op" id="1448581">(</span><span class="ident" id="1448582">elem</span><span class="op" id="1448586">.</span><span class="ident" id="1448587">size</span>&nbsp;<span class="op" id="1448592">&gt;</span>&nbsp;<span class="num" id="1448594">0</span>&nbsp;<span class="op" id="1448596">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1448599">uintptr</span><span class="op" id="1448606">(</span><span class="ident" id="1448607">size</span><span class="op" id="1448611">)</span>&nbsp;<span class="op" id="1448613">&gt;</span>&nbsp;<span class="op" id="1448615">(</span><span class="ident" id="1448616">maxmem</span><span class="op" id="1448622">-</span><span class="ident" id="1448623">hchanSize</span><span class="op" id="1448632">)</span><span class="op" id="1448633">/</span><span class="builtintype" id="1448634">uintptr</span><span class="op" id="1448641">(</span><span class="ident" id="1448642">elem</span><span class="op" id="1448646">.</span><span class="ident" id="1448647">size</span><span class="op" id="1448651">)</span><span class="op" id="1448652">)</span>&nbsp;<span class="op" id="1448654">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1448658">panic</span><span class="op" id="1448663">(</span><span class="string" id="1448664">&#34;makechan:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1448693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448700">var</span>&nbsp;<span class="ident" id="1448704">c</span>&nbsp;<span class="op" id="1448706">*</span><span class="ident" id="1448707">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448714">if</span>&nbsp;<span class="ident" id="1448717">elem</span><span class="op" id="1448721">.</span><span class="ident" id="1448722">kind</span><span class="op" id="1448726">&amp;</span><span class="ident" id="1448727">kindNoPointers</span>&nbsp;<span class="op" id="1448742">!=</span>&nbsp;<span class="num" id="1448745">0</span>&nbsp;<span class="op" id="1448747">||</span>&nbsp;<span class="ident" id="1448750">size</span>&nbsp;<span class="op" id="1448755">==</span>&nbsp;<span class="num" id="1448758">0</span>&nbsp;<span class="op" id="1448760">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448764">//&nbsp;Allocate&nbsp;memory&nbsp;in&nbsp;one&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448798">//&nbsp;Hchan&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC&nbsp;in&nbsp;this&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448868">//&nbsp;buf&nbsp;points&nbsp;into&nbsp;the&nbsp;same&nbsp;allocation,&nbsp;elemtype&nbsp;is&nbsp;persistent.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448934">//&nbsp;SudoG&#39;s&nbsp;are&nbsp;referenced&nbsp;from&nbsp;their&nbsp;owning&nbsp;thread&nbsp;so&nbsp;they&nbsp;can&#39;t&nbsp;be&nbsp;collected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449015">//&nbsp;TODO(dvyukov,rlh):&nbsp;Rethink&nbsp;when&nbsp;collector&nbsp;can&nbsp;move&nbsp;allocated&nbsp;objects.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449090">c</span>&nbsp;<span class="op" id="1449092">=</span>&nbsp;<span class="op" id="1449094">(</span><span class="op" id="1449095">*</span><span class="ident" id="1449096">hchan</span><span class="op" id="1449101">)</span><span class="op" id="1449102">(</span><span class="ident" id="1449103">mallocgc</span><span class="op" id="1449111">(</span><span class="ident" id="1449112">hchanSize</span><span class="op" id="1449121">+</span><span class="builtintype" id="1449122">uintptr</span><span class="op" id="1449129">(</span><span class="ident" id="1449130">size</span><span class="op" id="1449134">)</span><span class="op" id="1449135">*</span><span class="builtintype" id="1449136">uintptr</span><span class="op" id="1449143">(</span><span class="ident" id="1449144">elem</span><span class="op" id="1449148">.</span><span class="ident" id="1449149">size</span><span class="op" id="1449153">)</span><span class="op" id="1449154">,</span>&nbsp;<span class="ident" id="1449156">nil</span><span class="op" id="1449159">,</span>&nbsp;<span class="ident" id="1449161">flagNoScan</span><span class="op" id="1449171">)</span><span class="op" id="1449172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1449176">if</span>&nbsp;<span class="ident" id="1449179">size</span>&nbsp;<span class="op" id="1449184">&gt;</span>&nbsp;<span class="num" id="1449186">0</span>&nbsp;<span class="op" id="1449188">&amp;&amp;</span>&nbsp;<span class="ident" id="1449191">elem</span><span class="op" id="1449195">.</span><span class="ident" id="1449196">size</span>&nbsp;<span class="op" id="1449201">!=</span>&nbsp;<span class="num" id="1449204">0</span>&nbsp;<span class="op" id="1449206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449211">c</span><span class="op" id="1449212">.</span><span class="ident" id="1449213">buf</span>&nbsp;<span class="op" id="1449217">=</span>&nbsp;<span class="op" id="1449219">(</span><span class="op" id="1449220">*</span><span class="builtintype" id="1449221">uint8</span><span class="op" id="1449226">)</span><span class="op" id="1449227">(</span><span class="ident" id="1449228">add</span><span class="op" id="1449231">(</span><span class="ident" id="1449232">unsafe</span><span class="op" id="1449238">.</span><span class="ident" id="1449239">Pointer</span><span class="op" id="1449246">(</span><span class="ident" id="1449247">c</span><span class="op" id="1449248">)</span><span class="op" id="1449249">,</span>&nbsp;<span class="ident" id="1449251">hchanSize</span><span class="op" id="1449260">)</span><span class="op" id="1449261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1449265">}</span>&nbsp;<span class="keyword" id="1449267">else</span>&nbsp;<span class="op" id="1449272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449277">c</span><span class="op" id="1449278">.</span><span class="ident" id="1449279">buf</span>&nbsp;<span class="op" id="1449283">=</span>&nbsp;<span class="op" id="1449285">(</span><span class="op" id="1449286">*</span><span class="builtintype" id="1449287">uint8</span><span class="op" id="1449292">)</span><span class="op" id="1449293">(</span><span class="ident" id="1449294">unsafe</span><span class="op" id="1449300">.</span><span class="ident" id="1449301">Pointer</span><span class="op" id="1449308">(</span><span class="ident" id="1449309">c</span><span class="op" id="1449310">)</span><span class="op" id="1449311">)</span>&nbsp;<span class="comment" id="1449313">//&nbsp;race&nbsp;detector&nbsp;uses&nbsp;this&nbsp;location&nbsp;for&nbsp;synchronization</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1449371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1449374">}</span>&nbsp;<span class="keyword" id="1449376">else</span>&nbsp;<span class="op" id="1449381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449385">c</span>&nbsp;<span class="op" id="1449387">=</span>&nbsp;<span class="builtinfunc" id="1449389">new</span><span class="op" id="1449392">(</span><span class="ident" id="1449393">hchan</span><span class="op" id="1449398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449402">c</span><span class="op" id="1449403">.</span><span class="ident" id="1449404">buf</span>&nbsp;<span class="op" id="1449408">=</span>&nbsp;<span class="op" id="1449410">(</span><span class="op" id="1449411">*</span><span class="builtintype" id="1449412">uint8</span><span class="op" id="1449417">)</span><span class="op" id="1449418">(</span><span class="ident" id="1449419">newarray</span><span class="op" id="1449427">(</span><span class="ident" id="1449428">elem</span><span class="op" id="1449432">,</span>&nbsp;<span class="builtintype" id="1449434">uintptr</span><span class="op" id="1449441">(</span><span class="ident" id="1449442">size</span><span class="op" id="1449446">)</span><span class="op" id="1449447">)</span><span class="op" id="1449448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1449451">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449454">c</span><span class="op" id="1449455">.</span><span class="ident" id="1449456">elemsize</span>&nbsp;<span class="op" id="1449465">=</span>&nbsp;<span class="builtintype" id="1449467">uint16</span><span class="op" id="1449473">(</span><span class="ident" id="1449474">elem</span><span class="op" id="1449478">.</span><span class="ident" id="1449479">size</span><span class="op" id="1449483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449486">c</span><span class="op" id="1449487">.</span><span class="ident" id="1449488">elemtype</span>&nbsp;<span class="op" id="1449497">=</span>&nbsp;<span class="ident" id="1449499">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449505">c</span><span class="op" id="1449506">.</span><span class="ident" id="1449507">dataqsiz</span>&nbsp;<span class="op" id="1449516">=</span>&nbsp;<span class="builtintype" id="1449518">uint</span><span class="op" id="1449522">(</span><span class="ident" id="1449523">size</span><span class="op" id="1449527">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1449531">if</span>&nbsp;<span class="ident" id="1449534">debugChan</span>&nbsp;<span class="op" id="1449544">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1449548">print</span><span class="op" id="1449553">(</span><span class="string" id="1449554">&#34;makechan:&nbsp;chan=&#34;</span><span class="op" id="1449571">,</span>&nbsp;<span class="ident" id="1449573">c</span><span class="op" id="1449574">,</span>&nbsp;<span class="string" id="1449576">&#34;;&nbsp;elemsize=&#34;</span><span class="op" id="1449589">,</span>&nbsp;<span class="ident" id="1449591">elem</span><span class="op" id="1449595">.</span><span class="ident" id="1449596">size</span><span class="op" id="1449600">,</span>&nbsp;<span class="string" id="1449602">&#34;;&nbsp;elemalg=&#34;</span><span class="op" id="1449614">,</span>&nbsp;<span class="ident" id="1449616">elem</span><span class="op" id="1449620">.</span><span class="ident" id="1449621">alg</span><span class="op" id="1449624">,</span>&nbsp;<span class="string" id="1449626">&#34;;&nbsp;dataqsiz=&#34;</span><span class="op" id="1449639">,</span>&nbsp;<span class="ident" id="1449641">size</span><span class="op" id="1449645">,</span>&nbsp;<span class="string" id="1449647">&#34;\n&#34;</span><span class="op" id="1449651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1449654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1449657">return</span>&nbsp;<span class="ident" id="1449664">c</span><br>
<span class="lineno"></span><span class="op" id="1449666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1449669">//&nbsp;chanbuf(c,&nbsp;i)&nbsp;is&nbsp;pointer&nbsp;to&nbsp;the&nbsp;i&#39;th&nbsp;slot&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="1449729">func</span>&nbsp;<span class="ident" id="1449734">chanbuf</span><span class="op" id="1449741">(</span><span class="ident" id="1449742">c</span>&nbsp;<span class="op" id="1449744">*</span><span class="ident" id="1449745">hchan</span><span class="op" id="1449750">,</span>&nbsp;<span class="ident" id="1449752">i</span>&nbsp;<span class="builtintype" id="1449754">uint</span><span class="op" id="1449758">)</span>&nbsp;<span class="ident" id="1449760">unsafe</span><span class="op" id="1449766">.</span><span class="ident" id="1449767">Pointer</span>&nbsp;<span class="op" id="1449775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1449778">return</span>&nbsp;<span class="ident" id="1449785">add</span><span class="op" id="1449788">(</span><span class="ident" id="1449789">unsafe</span><span class="op" id="1449795">.</span><span class="ident" id="1449796">Pointer</span><span class="op" id="1449803">(</span><span class="ident" id="1449804">c</span><span class="op" id="1449805">.</span><span class="ident" id="1449806">buf</span><span class="op" id="1449809">)</span><span class="op" id="1449810">,</span>&nbsp;<span class="builtintype" id="1449812">uintptr</span><span class="op" id="1449819">(</span><span class="ident" id="1449820">i</span><span class="op" id="1449821">)</span><span class="op" id="1449822">*</span><span class="builtintype" id="1449823">uintptr</span><span class="op" id="1449830">(</span><span class="ident" id="1449831">c</span><span class="op" id="1449832">.</span><span class="ident" id="1449833">elemsize</span><span class="op" id="1449841">)</span><span class="op" id="1449842">)</span><br>
<span class="lineno"></span><span class="op" id="1449844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="1449847">//&nbsp;entry&nbsp;point&nbsp;for&nbsp;c&nbsp;&lt;-&nbsp;x&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1449892">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1449905">func</span>&nbsp;<span class="ident" id="1449910">chansend1</span><span class="op" id="1449919">(</span><span class="ident" id="1449920">t</span>&nbsp;<span class="op" id="1449922">*</span><span class="ident" id="1449923">chantype</span><span class="op" id="1449931">,</span>&nbsp;<span class="ident" id="1449933">c</span>&nbsp;<span class="op" id="1449935">*</span><span class="ident" id="1449936">hchan</span><span class="op" id="1449941">,</span>&nbsp;<span class="ident" id="1449943">elem</span>&nbsp;<span class="ident" id="1449948">unsafe</span><span class="op" id="1449954">.</span><span class="ident" id="1449955">Pointer</span><span class="op" id="1449962">)</span>&nbsp;<span class="op" id="1449964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449967">chansend</span><span class="op" id="1449975">(</span><span class="ident" id="1449976">t</span><span class="op" id="1449977">,</span>&nbsp;<span class="ident" id="1449979">c</span><span class="op" id="1449980">,</span>&nbsp;<span class="ident" id="1449982">elem</span><span class="op" id="1449986">,</span>&nbsp;<span class="builtintype" id="1449988">true</span><span class="op" id="1449992">,</span>&nbsp;<span class="ident" id="1449994">getcallerpc</span><span class="op" id="1450005">(</span><span class="ident" id="1450006">unsafe</span><span class="op" id="1450012">.</span><span class="ident" id="1450013">Pointer</span><span class="op" id="1450020">(</span><span class="op" id="1450021">&amp;</span><span class="ident" id="1450022">t</span><span class="op" id="1450023">)</span><span class="op" id="1450024">)</span><span class="op" id="1450025">)</span><br>
<span class="lineno"></span><span class="op" id="1450027">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="1450030">/*<br>
<span class="lineno"></span>&nbsp;*&nbsp;generic&nbsp;single&nbsp;channel&nbsp;send/recv<br>
<span class="lineno"></span>&nbsp;*&nbsp;If&nbsp;block&nbsp;is&nbsp;not&nbsp;nil,<br>
<span class="lineno"></span>&nbsp;*&nbsp;then&nbsp;the&nbsp;protocol&nbsp;will&nbsp;not<br>
<span class="lineno">75</span>&nbsp;*&nbsp;sleep&nbsp;but&nbsp;return&nbsp;if&nbsp;it&nbsp;could<br>
<span class="lineno"></span>&nbsp;*&nbsp;not&nbsp;complete.<br>
<span class="lineno"></span>&nbsp;*<br>
<span class="lineno"></span>&nbsp;*&nbsp;sleep&nbsp;can&nbsp;wake&nbsp;up&nbsp;with&nbsp;g.param&nbsp;==&nbsp;nil<br>
<span class="lineno"></span>&nbsp;*&nbsp;when&nbsp;a&nbsp;channel&nbsp;involved&nbsp;in&nbsp;the&nbsp;sleep&nbsp;has<br>
<span class="lineno">80</span>&nbsp;*&nbsp;been&nbsp;closed.&nbsp;&nbsp;it&nbsp;is&nbsp;easiest&nbsp;to&nbsp;loop&nbsp;and&nbsp;re-run<br>
<span class="lineno"></span>&nbsp;*&nbsp;the&nbsp;operation;&nbsp;we&#39;ll&nbsp;see&nbsp;that&nbsp;it&#39;s&nbsp;now&nbsp;closed.<br>
<span class="lineno"></span>&nbsp;*/</span><br>
<span class="lineno"></span><span class="keyword" id="1450364">func</span>&nbsp;<span class="ident" id="1450369">chansend</span><span class="op" id="1450377">(</span><span class="ident" id="1450378">t</span>&nbsp;<span class="op" id="1450380">*</span><span class="ident" id="1450381">chantype</span><span class="op" id="1450389">,</span>&nbsp;<span class="ident" id="1450391">c</span>&nbsp;<span class="op" id="1450393">*</span><span class="ident" id="1450394">hchan</span><span class="op" id="1450399">,</span>&nbsp;<span class="ident" id="1450401">ep</span>&nbsp;<span class="ident" id="1450404">unsafe</span><span class="op" id="1450410">.</span><span class="ident" id="1450411">Pointer</span><span class="op" id="1450418">,</span>&nbsp;<span class="ident" id="1450420">block</span>&nbsp;<span class="builtintype" id="1450426">bool</span><span class="op" id="1450430">,</span>&nbsp;<span class="ident" id="1450432">callerpc</span>&nbsp;<span class="builtintype" id="1450441">uintptr</span><span class="op" id="1450448">)</span>&nbsp;<span class="builtintype" id="1450450">bool</span>&nbsp;<span class="op" id="1450455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450458">if</span>&nbsp;<span class="ident" id="1450461">raceenabled</span>&nbsp;<span class="op" id="1450473">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450477">raceReadObjectPC</span><span class="op" id="1450493">(</span><span class="ident" id="1450494">t</span><span class="op" id="1450495">.</span><span class="ident" id="1450496">elem</span><span class="op" id="1450500">,</span>&nbsp;<span class="ident" id="1450502">ep</span><span class="op" id="1450504">,</span>&nbsp;<span class="ident" id="1450506">callerpc</span><span class="op" id="1450514">,</span>&nbsp;<span class="ident" id="1450516">funcPC</span><span class="op" id="1450522">(</span><span class="ident" id="1450523">chansend</span><span class="op" id="1450531">)</span><span class="op" id="1450532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450539">if</span>&nbsp;<span class="ident" id="1450542">c</span>&nbsp;<span class="op" id="1450544">==</span>&nbsp;<span class="ident" id="1450547">nil</span>&nbsp;<span class="op" id="1450551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450555">if</span>&nbsp;<span class="op" id="1450558">!</span><span class="ident" id="1450559">block</span>&nbsp;<span class="op" id="1450565">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450570">return</span>&nbsp;<span class="builtintype" id="1450577">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450589">gopark</span><span class="op" id="1450595">(</span><span class="ident" id="1450596">nil</span><span class="op" id="1450599">,</span>&nbsp;<span class="ident" id="1450601">nil</span><span class="op" id="1450604">,</span>&nbsp;<span class="string" id="1450606">&#34;chan&nbsp;send&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1450628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450632">gothrow</span><span class="op" id="1450639">(</span><span class="string" id="1450640">&#34;unreachable&#34;</span><span class="op" id="1450653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450656">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450660">if</span>&nbsp;<span class="ident" id="1450663">debugChan</span>&nbsp;<span class="op" id="1450673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1450677">print</span><span class="op" id="1450682">(</span><span class="string" id="1450683">&#34;chansend:&nbsp;chan=&#34;</span><span class="op" id="1450700">,</span>&nbsp;<span class="ident" id="1450702">c</span><span class="op" id="1450703">,</span>&nbsp;<span class="string" id="1450705">&#34;\n&#34;</span><span class="op" id="1450709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450716">if</span>&nbsp;<span class="ident" id="1450719">raceenabled</span>&nbsp;<span class="op" id="1450731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450735">racereadpc</span><span class="op" id="1450745">(</span><span class="ident" id="1450746">unsafe</span><span class="op" id="1450752">.</span><span class="ident" id="1450753">Pointer</span><span class="op" id="1450760">(</span><span class="ident" id="1450761">c</span><span class="op" id="1450762">)</span><span class="op" id="1450763">,</span>&nbsp;<span class="ident" id="1450765">callerpc</span><span class="op" id="1450773">,</span>&nbsp;<span class="ident" id="1450775">funcPC</span><span class="op" id="1450781">(</span><span class="ident" id="1450782">chansend</span><span class="op" id="1450790">)</span><span class="op" id="1450791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1450798">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1450881">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1450885">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1450968">//&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451050">//&nbsp;(first&nbsp;c.closed&nbsp;and&nbsp;second&nbsp;c.recvq.first&nbsp;or&nbsp;c.qcount&nbsp;depending&nbsp;on&nbsp;kind&nbsp;of&nbsp;channel).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451138">//&nbsp;Because&nbsp;a&nbsp;closed&nbsp;channel&nbsp;cannot&nbsp;transition&nbsp;from&nbsp;&#39;ready&nbsp;for&nbsp;sending&#39;&nbsp;to</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451213">//&nbsp;&#39;not&nbsp;ready&nbsp;for&nbsp;sending&#39;,&nbsp;even&nbsp;if&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed&nbsp;between&nbsp;the&nbsp;two&nbsp;observations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451302">//&nbsp;they&nbsp;imply&nbsp;a&nbsp;moment&nbsp;between&nbsp;the&nbsp;two&nbsp;when&nbsp;the&nbsp;channel&nbsp;was&nbsp;both&nbsp;not&nbsp;yet&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451383">//&nbsp;and&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451470">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;send&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451515">//</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451519">//&nbsp;It&nbsp;is&nbsp;okay&nbsp;if&nbsp;the&nbsp;reads&nbsp;are&nbsp;reordered&nbsp;here:&nbsp;if&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451605">//&nbsp;ready&nbsp;for&nbsp;sending&nbsp;and&nbsp;then&nbsp;observe&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;closed,&nbsp;that&nbsp;implies&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1451689">//&nbsp;channel&nbsp;wasn&#39;t&nbsp;closed&nbsp;during&nbsp;the&nbsp;first&nbsp;observation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451745">if</span>&nbsp;<span class="op" id="1451748">!</span><span class="ident" id="1451749">block</span>&nbsp;<span class="op" id="1451755">&amp;&amp;</span>&nbsp;<span class="ident" id="1451758">c</span><span class="op" id="1451759">.</span><span class="ident" id="1451760">closed</span>&nbsp;<span class="op" id="1451767">==</span>&nbsp;<span class="num" id="1451770">0</span>&nbsp;<span class="op" id="1451772">&amp;&amp;</span>&nbsp;<span class="op" id="1451775">(</span><span class="op" id="1451776">(</span><span class="ident" id="1451777">c</span><span class="op" id="1451778">.</span><span class="ident" id="1451779">dataqsiz</span>&nbsp;<span class="op" id="1451788">==</span>&nbsp;<span class="num" id="1451791">0</span>&nbsp;<span class="op" id="1451793">&amp;&amp;</span>&nbsp;<span class="ident" id="1451796">c</span><span class="op" id="1451797">.</span><span class="ident" id="1451798">recvq</span><span class="op" id="1451803">.</span><span class="ident" id="1451804">first</span>&nbsp;<span class="op" id="1451810">==</span>&nbsp;<span class="ident" id="1451813">nil</span><span class="op" id="1451816">)</span>&nbsp;<span class="op" id="1451818">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451823">(</span><span class="ident" id="1451824">c</span><span class="op" id="1451825">.</span><span class="ident" id="1451826">dataqsiz</span>&nbsp;<span class="op" id="1451835">&gt;</span>&nbsp;<span class="num" id="1451837">0</span>&nbsp;<span class="op" id="1451839">&amp;&amp;</span>&nbsp;<span class="ident" id="1451842">c</span><span class="op" id="1451843">.</span><span class="ident" id="1451844">qcount</span>&nbsp;<span class="op" id="1451851">==</span>&nbsp;<span class="ident" id="1451854">c</span><span class="op" id="1451855">.</span><span class="ident" id="1451856">dataqsiz</span><span class="op" id="1451864">)</span><span class="op" id="1451865">)</span>&nbsp;<span class="op" id="1451867">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451871">return</span>&nbsp;<span class="builtintype" id="1451878">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451889">var</span>&nbsp;<span class="ident" id="1451893">t0</span>&nbsp;<span class="ident" id="1451896">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451903">if</span>&nbsp;<span class="ident" id="1451906">blockprofilerate</span>&nbsp;<span class="op" id="1451923">&gt;</span>&nbsp;<span class="num" id="1451925">0</span>&nbsp;<span class="op" id="1451927">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451931">t0</span>&nbsp;<span class="op" id="1451934">=</span>&nbsp;<span class="ident" id="1451936">cputicks</span><span class="op" id="1451944">(</span><span class="op" id="1451945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1451948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451952">lock</span><span class="op" id="1451956">(</span><span class="op" id="1451957">&amp;</span><span class="ident" id="1451958">c</span><span class="op" id="1451959">.</span><span class="ident" id="1451960">lock</span><span class="op" id="1451964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1451967">if</span>&nbsp;<span class="ident" id="1451970">c</span><span class="op" id="1451971">.</span><span class="ident" id="1451972">closed</span>&nbsp;<span class="op" id="1451979">!=</span>&nbsp;<span class="num" id="1451982">0</span>&nbsp;<span class="op" id="1451984">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1451988">unlock</span><span class="op" id="1451994">(</span><span class="op" id="1451995">&amp;</span><span class="ident" id="1451996">c</span><span class="op" id="1451997">.</span><span class="ident" id="1451998">lock</span><span class="op" id="1452002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1452006">panic</span><span class="op" id="1452011">(</span><span class="string" id="1452012">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1452036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452043">if</span>&nbsp;<span class="ident" id="1452046">c</span><span class="op" id="1452047">.</span><span class="ident" id="1452048">dataqsiz</span>&nbsp;<span class="op" id="1452057">==</span>&nbsp;<span class="num" id="1452060">0</span>&nbsp;<span class="op" id="1452062">{</span>&nbsp;<span class="comment" id="1452064">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452089">sg</span>&nbsp;<span class="op" id="1452092">:=</span>&nbsp;<span class="ident" id="1452095">c</span><span class="op" id="1452096">.</span><span class="ident" id="1452097">recvq</span><span class="op" id="1452102">.</span><span class="ident" id="1452103">dequeue</span><span class="op" id="1452110">(</span><span class="op" id="1452111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452115">if</span>&nbsp;<span class="ident" id="1452118">sg</span>&nbsp;<span class="op" id="1452121">!=</span>&nbsp;<span class="ident" id="1452124">nil</span>&nbsp;<span class="op" id="1452128">{</span>&nbsp;<span class="comment" id="1452130">//&nbsp;found&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452161">if</span>&nbsp;<span class="ident" id="1452164">raceenabled</span>&nbsp;<span class="op" id="1452176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452182">racesync</span><span class="op" id="1452190">(</span><span class="ident" id="1452191">c</span><span class="op" id="1452192">,</span>&nbsp;<span class="ident" id="1452194">sg</span><span class="op" id="1452196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452201">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452206">unlock</span><span class="op" id="1452212">(</span><span class="op" id="1452213">&amp;</span><span class="ident" id="1452214">c</span><span class="op" id="1452215">.</span><span class="ident" id="1452216">lock</span><span class="op" id="1452220">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452226">recvg</span>&nbsp;<span class="op" id="1452232">:=</span>&nbsp;<span class="ident" id="1452235">sg</span><span class="op" id="1452237">.</span><span class="ident" id="1452238">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452243">if</span>&nbsp;<span class="ident" id="1452246">sg</span><span class="op" id="1452248">.</span><span class="ident" id="1452249">elem</span>&nbsp;<span class="op" id="1452254">!=</span>&nbsp;<span class="ident" id="1452257">nil</span>&nbsp;<span class="op" id="1452261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452267">memmove</span><span class="op" id="1452274">(</span><span class="ident" id="1452275">unsafe</span><span class="op" id="1452281">.</span><span class="ident" id="1452282">Pointer</span><span class="op" id="1452289">(</span><span class="ident" id="1452290">sg</span><span class="op" id="1452292">.</span><span class="ident" id="1452293">elem</span><span class="op" id="1452297">)</span><span class="op" id="1452298">,</span>&nbsp;<span class="ident" id="1452300">ep</span><span class="op" id="1452302">,</span>&nbsp;<span class="builtintype" id="1452304">uintptr</span><span class="op" id="1452311">(</span><span class="ident" id="1452312">c</span><span class="op" id="1452313">.</span><span class="ident" id="1452314">elemsize</span><span class="op" id="1452322">)</span><span class="op" id="1452323">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452329">sg</span><span class="op" id="1452331">.</span><span class="ident" id="1452332">elem</span>&nbsp;<span class="op" id="1452337">=</span>&nbsp;<span class="ident" id="1452339">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452351">recvg</span><span class="op" id="1452356">.</span><span class="ident" id="1452357">param</span>&nbsp;<span class="op" id="1452363">=</span>&nbsp;<span class="ident" id="1452365">unsafe</span><span class="op" id="1452371">.</span><span class="ident" id="1452372">Pointer</span><span class="op" id="1452379">(</span><span class="ident" id="1452380">sg</span><span class="op" id="1452382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452387">if</span>&nbsp;<span class="ident" id="1452390">sg</span><span class="op" id="1452392">.</span><span class="ident" id="1452393">releasetime</span>&nbsp;<span class="op" id="1452405">!=</span>&nbsp;<span class="num" id="1452408">0</span>&nbsp;<span class="op" id="1452410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452416">sg</span><span class="op" id="1452418">.</span><span class="ident" id="1452419">releasetime</span>&nbsp;<span class="op" id="1452431">=</span>&nbsp;<span class="ident" id="1452433">cputicks</span><span class="op" id="1452441">(</span><span class="op" id="1452442">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452452">goready</span><span class="op" id="1452459">(</span><span class="ident" id="1452460">recvg</span><span class="op" id="1452465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452470">return</span>&nbsp;<span class="builtintype" id="1452477">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452489">if</span>&nbsp;<span class="op" id="1452492">!</span><span class="ident" id="1452493">block</span>&nbsp;<span class="op" id="1452499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452504">unlock</span><span class="op" id="1452510">(</span><span class="op" id="1452511">&amp;</span><span class="ident" id="1452512">c</span><span class="op" id="1452513">.</span><span class="ident" id="1452514">lock</span><span class="op" id="1452518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452523">return</span>&nbsp;<span class="builtintype" id="1452530">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452543">//&nbsp;no&nbsp;receiver&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452594">gp</span>&nbsp;<span class="op" id="1452597">:=</span>&nbsp;<span class="ident" id="1452600">getg</span><span class="op" id="1452604">(</span><span class="op" id="1452605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452609">mysg</span>&nbsp;<span class="op" id="1452614">:=</span>&nbsp;<span class="ident" id="1452617">acquireSudog</span><span class="op" id="1452629">(</span><span class="op" id="1452630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452634">mysg</span><span class="op" id="1452638">.</span><span class="ident" id="1452639">releasetime</span>&nbsp;<span class="op" id="1452651">=</span>&nbsp;<span class="num" id="1452653">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452657">if</span>&nbsp;<span class="ident" id="1452660">t0</span>&nbsp;<span class="op" id="1452663">!=</span>&nbsp;<span class="num" id="1452666">0</span>&nbsp;<span class="op" id="1452668">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452673">mysg</span><span class="op" id="1452677">.</span><span class="ident" id="1452678">releasetime</span>&nbsp;<span class="op" id="1452690">=</span>&nbsp;<span class="op" id="1452692">-</span><span class="num" id="1452693">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452701">mysg</span><span class="op" id="1452705">.</span><span class="ident" id="1452706">elem</span>&nbsp;<span class="op" id="1452711">=</span>&nbsp;<span class="ident" id="1452713">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452718">mysg</span><span class="op" id="1452722">.</span><span class="ident" id="1452723">waitlink</span>&nbsp;<span class="op" id="1452732">=</span>&nbsp;<span class="ident" id="1452734">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452740">gp</span><span class="op" id="1452742">.</span><span class="ident" id="1452743">waiting</span>&nbsp;<span class="op" id="1452751">=</span>&nbsp;<span class="ident" id="1452753">mysg</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452760">mysg</span><span class="op" id="1452764">.</span><span class="ident" id="1452765">g</span>&nbsp;<span class="op" id="1452767">=</span>&nbsp;<span class="ident" id="1452769">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452774">mysg</span><span class="op" id="1452778">.</span><span class="ident" id="1452779">selectdone</span>&nbsp;<span class="op" id="1452790">=</span>&nbsp;<span class="ident" id="1452792">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452798">gp</span><span class="op" id="1452800">.</span><span class="ident" id="1452801">param</span>&nbsp;<span class="op" id="1452807">=</span>&nbsp;<span class="ident" id="1452809">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452815">c</span><span class="op" id="1452816">.</span><span class="ident" id="1452817">sendq</span><span class="op" id="1452822">.</span><span class="ident" id="1452823">enqueue</span><span class="op" id="1452830">(</span><span class="ident" id="1452831">mysg</span><span class="op" id="1452835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452839">goparkunlock</span><span class="op" id="1452851">(</span><span class="op" id="1452852">&amp;</span><span class="ident" id="1452853">c</span><span class="op" id="1452854">.</span><span class="ident" id="1452855">lock</span><span class="op" id="1452859">,</span>&nbsp;<span class="string" id="1452861">&#34;chan&nbsp;send&#34;</span><span class="op" id="1452872">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1452877">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452902">if</span>&nbsp;<span class="ident" id="1452905">mysg</span>&nbsp;<span class="op" id="1452910">!=</span>&nbsp;<span class="ident" id="1452913">gp</span><span class="op" id="1452915">.</span><span class="ident" id="1452916">waiting</span>&nbsp;<span class="op" id="1452924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452929">gothrow</span><span class="op" id="1452936">(</span><span class="string" id="1452937">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1452967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1452971">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1452975">gp</span><span class="op" id="1452977">.</span><span class="ident" id="1452978">waiting</span>&nbsp;<span class="op" id="1452986">=</span>&nbsp;<span class="ident" id="1452988">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1452994">if</span>&nbsp;<span class="ident" id="1452997">gp</span><span class="op" id="1452999">.</span><span class="ident" id="1453000">param</span>&nbsp;<span class="op" id="1453006">==</span>&nbsp;<span class="ident" id="1453009">nil</span>&nbsp;<span class="op" id="1453013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453018">if</span>&nbsp;<span class="ident" id="1453021">c</span><span class="op" id="1453022">.</span><span class="ident" id="1453023">closed</span>&nbsp;<span class="op" id="1453030">==</span>&nbsp;<span class="num" id="1453033">0</span>&nbsp;<span class="op" id="1453035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453041">gothrow</span><span class="op" id="1453048">(</span><span class="string" id="1453049">&#34;chansend:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1453076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453081">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1453086">panic</span><span class="op" id="1453091">(</span><span class="string" id="1453092">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1453116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453124">gp</span><span class="op" id="1453126">.</span><span class="ident" id="1453127">param</span>&nbsp;<span class="op" id="1453133">=</span>&nbsp;<span class="ident" id="1453135">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453141">if</span>&nbsp;<span class="ident" id="1453144">mysg</span><span class="op" id="1453148">.</span><span class="ident" id="1453149">releasetime</span>&nbsp;<span class="op" id="1453161">&gt;</span>&nbsp;<span class="num" id="1453163">0</span>&nbsp;<span class="op" id="1453165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453170">blockevent</span><span class="op" id="1453180">(</span><span class="ident" id="1453181">int64</span><span class="op" id="1453186">(</span><span class="ident" id="1453187">mysg</span><span class="op" id="1453191">.</span><span class="ident" id="1453192">releasetime</span><span class="op" id="1453203">)</span><span class="op" id="1453204">-</span><span class="ident" id="1453205">t0</span><span class="op" id="1453207">,</span>&nbsp;<span class="num" id="1453209">2</span><span class="op" id="1453210">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453218">releaseSudog</span><span class="op" id="1453230">(</span><span class="ident" id="1453231">mysg</span><span class="op" id="1453235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453239">return</span>&nbsp;<span class="builtintype" id="1453246">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453256">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453281">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;space&nbsp;to&nbsp;write&nbsp;our&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453323">var</span>&nbsp;<span class="ident" id="1453327">t1</span>&nbsp;<span class="ident" id="1453330">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453337">for</span>&nbsp;<span class="ident" id="1453341">c</span><span class="op" id="1453342">.</span><span class="ident" id="1453343">qcount</span>&nbsp;<span class="op" id="1453350">&gt;=</span>&nbsp;<span class="ident" id="1453353">c</span><span class="op" id="1453354">.</span><span class="ident" id="1453355">dataqsiz</span>&nbsp;<span class="op" id="1453364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453368">if</span>&nbsp;<span class="op" id="1453371">!</span><span class="ident" id="1453372">block</span>&nbsp;<span class="op" id="1453378">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453383">unlock</span><span class="op" id="1453389">(</span><span class="op" id="1453390">&amp;</span><span class="ident" id="1453391">c</span><span class="op" id="1453392">.</span><span class="ident" id="1453393">lock</span><span class="op" id="1453397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453402">return</span>&nbsp;<span class="builtintype" id="1453409">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453421">gp</span>&nbsp;<span class="op" id="1453424">:=</span>&nbsp;<span class="ident" id="1453427">getg</span><span class="op" id="1453431">(</span><span class="op" id="1453432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453436">mysg</span>&nbsp;<span class="op" id="1453441">:=</span>&nbsp;<span class="ident" id="1453444">acquireSudog</span><span class="op" id="1453456">(</span><span class="op" id="1453457">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453461">mysg</span><span class="op" id="1453465">.</span><span class="ident" id="1453466">releasetime</span>&nbsp;<span class="op" id="1453478">=</span>&nbsp;<span class="num" id="1453480">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453484">if</span>&nbsp;<span class="ident" id="1453487">t0</span>&nbsp;<span class="op" id="1453490">!=</span>&nbsp;<span class="num" id="1453493">0</span>&nbsp;<span class="op" id="1453495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453500">mysg</span><span class="op" id="1453504">.</span><span class="ident" id="1453505">releasetime</span>&nbsp;<span class="op" id="1453517">=</span>&nbsp;<span class="op" id="1453519">-</span><span class="num" id="1453520">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453528">mysg</span><span class="op" id="1453532">.</span><span class="ident" id="1453533">g</span>&nbsp;<span class="op" id="1453535">=</span>&nbsp;<span class="ident" id="1453537">gp</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453542">mysg</span><span class="op" id="1453546">.</span><span class="ident" id="1453547">elem</span>&nbsp;<span class="op" id="1453552">=</span>&nbsp;<span class="ident" id="1453554">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453560">mysg</span><span class="op" id="1453564">.</span><span class="ident" id="1453565">selectdone</span>&nbsp;<span class="op" id="1453576">=</span>&nbsp;<span class="ident" id="1453578">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453584">c</span><span class="op" id="1453585">.</span><span class="ident" id="1453586">sendq</span><span class="op" id="1453591">.</span><span class="ident" id="1453592">enqueue</span><span class="op" id="1453599">(</span><span class="ident" id="1453600">mysg</span><span class="op" id="1453604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453608">goparkunlock</span><span class="op" id="1453620">(</span><span class="op" id="1453621">&amp;</span><span class="ident" id="1453622">c</span><span class="op" id="1453623">.</span><span class="ident" id="1453624">lock</span><span class="op" id="1453628">,</span>&nbsp;<span class="string" id="1453630">&#34;chan&nbsp;send&#34;</span><span class="op" id="1453641">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453646">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453682">if</span>&nbsp;<span class="ident" id="1453685">mysg</span><span class="op" id="1453689">.</span><span class="ident" id="1453690">releasetime</span>&nbsp;<span class="op" id="1453702">&gt;</span>&nbsp;<span class="num" id="1453704">0</span>&nbsp;<span class="op" id="1453706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453711">t1</span>&nbsp;<span class="op" id="1453714">=</span>&nbsp;<span class="ident" id="1453716">mysg</span><span class="op" id="1453720">.</span><span class="ident" id="1453721">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453739">releaseSudog</span><span class="op" id="1453751">(</span><span class="ident" id="1453752">mysg</span><span class="op" id="1453756">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453760">lock</span><span class="op" id="1453764">(</span><span class="op" id="1453765">&amp;</span><span class="ident" id="1453766">c</span><span class="op" id="1453767">.</span><span class="ident" id="1453768">lock</span><span class="op" id="1453772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453776">if</span>&nbsp;<span class="ident" id="1453779">c</span><span class="op" id="1453780">.</span><span class="ident" id="1453781">closed</span>&nbsp;<span class="op" id="1453788">!=</span>&nbsp;<span class="num" id="1453791">0</span>&nbsp;<span class="op" id="1453793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453798">unlock</span><span class="op" id="1453804">(</span><span class="op" id="1453805">&amp;</span><span class="ident" id="1453806">c</span><span class="op" id="1453807">.</span><span class="ident" id="1453808">lock</span><span class="op" id="1453812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1453817">panic</span><span class="op" id="1453822">(</span><span class="string" id="1453823">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1453847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453851">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1453858">//&nbsp;write&nbsp;our&nbsp;data&nbsp;into&nbsp;the&nbsp;channel&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1453901">if</span>&nbsp;<span class="ident" id="1453904">raceenabled</span>&nbsp;<span class="op" id="1453916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453920">raceacquire</span><span class="op" id="1453931">(</span><span class="ident" id="1453932">chanbuf</span><span class="op" id="1453939">(</span><span class="ident" id="1453940">c</span><span class="op" id="1453941">,</span>&nbsp;<span class="ident" id="1453943">c</span><span class="op" id="1453944">.</span><span class="ident" id="1453945">sendx</span><span class="op" id="1453950">)</span><span class="op" id="1453951">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453955">racerelease</span><span class="op" id="1453966">(</span><span class="ident" id="1453967">chanbuf</span><span class="op" id="1453974">(</span><span class="ident" id="1453975">c</span><span class="op" id="1453976">,</span>&nbsp;<span class="ident" id="1453978">c</span><span class="op" id="1453979">.</span><span class="ident" id="1453980">sendx</span><span class="op" id="1453985">)</span><span class="op" id="1453986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1453989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1453992">memmove</span><span class="op" id="1453999">(</span><span class="ident" id="1454000">chanbuf</span><span class="op" id="1454007">(</span><span class="ident" id="1454008">c</span><span class="op" id="1454009">,</span>&nbsp;<span class="ident" id="1454011">c</span><span class="op" id="1454012">.</span><span class="ident" id="1454013">sendx</span><span class="op" id="1454018">)</span><span class="op" id="1454019">,</span>&nbsp;<span class="ident" id="1454021">ep</span><span class="op" id="1454023">,</span>&nbsp;<span class="builtintype" id="1454025">uintptr</span><span class="op" id="1454032">(</span><span class="ident" id="1454033">c</span><span class="op" id="1454034">.</span><span class="ident" id="1454035">elemsize</span><span class="op" id="1454043">)</span><span class="op" id="1454044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454047">c</span><span class="op" id="1454048">.</span><span class="ident" id="1454049">sendx</span><span class="op" id="1454054">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454058">if</span>&nbsp;<span class="ident" id="1454061">c</span><span class="op" id="1454062">.</span><span class="ident" id="1454063">sendx</span>&nbsp;<span class="op" id="1454069">==</span>&nbsp;<span class="ident" id="1454072">c</span><span class="op" id="1454073">.</span><span class="ident" id="1454074">dataqsiz</span>&nbsp;<span class="op" id="1454083">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454087">c</span><span class="op" id="1454088">.</span><span class="ident" id="1454089">sendx</span>&nbsp;<span class="op" id="1454095">=</span>&nbsp;<span class="num" id="1454097">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454103">c</span><span class="op" id="1454104">.</span><span class="ident" id="1454105">qcount</span><span class="op" id="1454111">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454116">//&nbsp;wake&nbsp;up&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454147">sg</span>&nbsp;<span class="op" id="1454150">:=</span>&nbsp;<span class="ident" id="1454153">c</span><span class="op" id="1454154">.</span><span class="ident" id="1454155">recvq</span><span class="op" id="1454160">.</span><span class="ident" id="1454161">dequeue</span><span class="op" id="1454168">(</span><span class="op" id="1454169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454172">if</span>&nbsp;<span class="ident" id="1454175">sg</span>&nbsp;<span class="op" id="1454178">!=</span>&nbsp;<span class="ident" id="1454181">nil</span>&nbsp;<span class="op" id="1454185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454189">recvg</span>&nbsp;<span class="op" id="1454195">:=</span>&nbsp;<span class="ident" id="1454198">sg</span><span class="op" id="1454200">.</span><span class="ident" id="1454201">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454205">unlock</span><span class="op" id="1454211">(</span><span class="op" id="1454212">&amp;</span><span class="ident" id="1454213">c</span><span class="op" id="1454214">.</span><span class="ident" id="1454215">lock</span><span class="op" id="1454219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454223">if</span>&nbsp;<span class="ident" id="1454226">sg</span><span class="op" id="1454228">.</span><span class="ident" id="1454229">releasetime</span>&nbsp;<span class="op" id="1454241">!=</span>&nbsp;<span class="num" id="1454244">0</span>&nbsp;<span class="op" id="1454246">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454251">sg</span><span class="op" id="1454253">.</span><span class="ident" id="1454254">releasetime</span>&nbsp;<span class="op" id="1454266">=</span>&nbsp;<span class="ident" id="1454268">cputicks</span><span class="op" id="1454276">(</span><span class="op" id="1454277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454285">goready</span><span class="op" id="1454292">(</span><span class="ident" id="1454293">recvg</span><span class="op" id="1454298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454301">}</span>&nbsp;<span class="keyword" id="1454303">else</span>&nbsp;<span class="op" id="1454308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454312">unlock</span><span class="op" id="1454318">(</span><span class="op" id="1454319">&amp;</span><span class="ident" id="1454320">c</span><span class="op" id="1454321">.</span><span class="ident" id="1454322">lock</span><span class="op" id="1454326">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454332">if</span>&nbsp;<span class="ident" id="1454335">t1</span>&nbsp;<span class="op" id="1454338">&gt;</span>&nbsp;<span class="num" id="1454340">0</span>&nbsp;<span class="op" id="1454342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454346">blockevent</span><span class="op" id="1454356">(</span><span class="ident" id="1454357">t1</span><span class="op" id="1454359">-</span><span class="ident" id="1454360">t0</span><span class="op" id="1454362">,</span>&nbsp;<span class="num" id="1454364">2</span><span class="op" id="1454365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454371">return</span>&nbsp;<span class="builtintype" id="1454378">true</span><br>
<span class="lineno">255</span><span class="op" id="1454383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1454386">func</span>&nbsp;<span class="ident" id="1454391">closechan</span><span class="op" id="1454400">(</span><span class="ident" id="1454401">c</span>&nbsp;<span class="op" id="1454403">*</span><span class="ident" id="1454404">hchan</span><span class="op" id="1454409">)</span>&nbsp;<span class="op" id="1454411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454414">if</span>&nbsp;<span class="ident" id="1454417">c</span>&nbsp;<span class="op" id="1454419">==</span>&nbsp;<span class="ident" id="1454422">nil</span>&nbsp;<span class="op" id="1454426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1454430">panic</span><span class="op" id="1454435">(</span><span class="string" id="1454436">&#34;close&nbsp;of&nbsp;nil&nbsp;channel&#34;</span><span class="op" id="1454458">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454465">lock</span><span class="op" id="1454469">(</span><span class="op" id="1454470">&amp;</span><span class="ident" id="1454471">c</span><span class="op" id="1454472">.</span><span class="ident" id="1454473">lock</span><span class="op" id="1454477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454480">if</span>&nbsp;<span class="ident" id="1454483">c</span><span class="op" id="1454484">.</span><span class="ident" id="1454485">closed</span>&nbsp;<span class="op" id="1454492">!=</span>&nbsp;<span class="num" id="1454495">0</span>&nbsp;<span class="op" id="1454497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454501">unlock</span><span class="op" id="1454507">(</span><span class="op" id="1454508">&amp;</span><span class="ident" id="1454509">c</span><span class="op" id="1454510">.</span><span class="ident" id="1454511">lock</span><span class="op" id="1454515">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1454519">panic</span><span class="op" id="1454524">(</span><span class="string" id="1454525">&#34;close&nbsp;of&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1454550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454557">if</span>&nbsp;<span class="ident" id="1454560">raceenabled</span>&nbsp;<span class="op" id="1454572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454576">callerpc</span>&nbsp;<span class="op" id="1454585">:=</span>&nbsp;<span class="ident" id="1454588">getcallerpc</span><span class="op" id="1454599">(</span><span class="ident" id="1454600">unsafe</span><span class="op" id="1454606">.</span><span class="ident" id="1454607">Pointer</span><span class="op" id="1454614">(</span><span class="op" id="1454615">&amp;</span><span class="ident" id="1454616">c</span><span class="op" id="1454617">)</span><span class="op" id="1454618">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454622">racewritepc</span><span class="op" id="1454633">(</span><span class="ident" id="1454634">unsafe</span><span class="op" id="1454640">.</span><span class="ident" id="1454641">Pointer</span><span class="op" id="1454648">(</span><span class="ident" id="1454649">c</span><span class="op" id="1454650">)</span><span class="op" id="1454651">,</span>&nbsp;<span class="ident" id="1454653">callerpc</span><span class="op" id="1454661">,</span>&nbsp;<span class="ident" id="1454663">funcPC</span><span class="op" id="1454669">(</span><span class="ident" id="1454670">closechan</span><span class="op" id="1454679">)</span><span class="op" id="1454680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454684">racerelease</span><span class="op" id="1454695">(</span><span class="ident" id="1454696">unsafe</span><span class="op" id="1454702">.</span><span class="ident" id="1454703">Pointer</span><span class="op" id="1454710">(</span><span class="ident" id="1454711">c</span><span class="op" id="1454712">)</span><span class="op" id="1454713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454720">c</span><span class="op" id="1454721">.</span><span class="ident" id="1454722">closed</span>&nbsp;<span class="op" id="1454729">=</span>&nbsp;<span class="num" id="1454731">1</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454735">//&nbsp;release&nbsp;all&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454759">for</span>&nbsp;<span class="op" id="1454763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454767">sg</span>&nbsp;<span class="op" id="1454770">:=</span>&nbsp;<span class="ident" id="1454773">c</span><span class="op" id="1454774">.</span><span class="ident" id="1454775">recvq</span><span class="op" id="1454780">.</span><span class="ident" id="1454781">dequeue</span><span class="op" id="1454788">(</span><span class="op" id="1454789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454793">if</span>&nbsp;<span class="ident" id="1454796">sg</span>&nbsp;<span class="op" id="1454799">==</span>&nbsp;<span class="ident" id="1454802">nil</span>&nbsp;<span class="op" id="1454806">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454811">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454823">gp</span>&nbsp;<span class="op" id="1454826">:=</span>&nbsp;<span class="ident" id="1454829">sg</span><span class="op" id="1454831">.</span><span class="ident" id="1454832">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454836">sg</span><span class="op" id="1454838">.</span><span class="ident" id="1454839">elem</span>&nbsp;<span class="op" id="1454844">=</span>&nbsp;<span class="ident" id="1454846">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454852">gp</span><span class="op" id="1454854">.</span><span class="ident" id="1454855">param</span>&nbsp;<span class="op" id="1454861">=</span>&nbsp;<span class="ident" id="1454863">nil</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454869">if</span>&nbsp;<span class="ident" id="1454872">sg</span><span class="op" id="1454874">.</span><span class="ident" id="1454875">releasetime</span>&nbsp;<span class="op" id="1454887">!=</span>&nbsp;<span class="num" id="1454890">0</span>&nbsp;<span class="op" id="1454892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454897">sg</span><span class="op" id="1454899">.</span><span class="ident" id="1454900">releasetime</span>&nbsp;<span class="op" id="1454912">=</span>&nbsp;<span class="ident" id="1454914">cputicks</span><span class="op" id="1454922">(</span><span class="op" id="1454923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454931">goready</span><span class="op" id="1454938">(</span><span class="ident" id="1454939">gp</span><span class="op" id="1454941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1454944">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1454948">//&nbsp;release&nbsp;all&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1454972">for</span>&nbsp;<span class="op" id="1454976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1454980">sg</span>&nbsp;<span class="op" id="1454983">:=</span>&nbsp;<span class="ident" id="1454986">c</span><span class="op" id="1454987">.</span><span class="ident" id="1454988">sendq</span><span class="op" id="1454993">.</span><span class="ident" id="1454994">dequeue</span><span class="op" id="1455001">(</span><span class="op" id="1455002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1455006">if</span>&nbsp;<span class="ident" id="1455009">sg</span>&nbsp;<span class="op" id="1455012">==</span>&nbsp;<span class="ident" id="1455015">nil</span>&nbsp;<span class="op" id="1455019">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1455024">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1455032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455036">gp</span>&nbsp;<span class="op" id="1455039">:=</span>&nbsp;<span class="ident" id="1455042">sg</span><span class="op" id="1455044">.</span><span class="ident" id="1455045">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455049">sg</span><span class="op" id="1455051">.</span><span class="ident" id="1455052">elem</span>&nbsp;<span class="op" id="1455057">=</span>&nbsp;<span class="ident" id="1455059">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455065">gp</span><span class="op" id="1455067">.</span><span class="ident" id="1455068">param</span>&nbsp;<span class="op" id="1455074">=</span>&nbsp;<span class="ident" id="1455076">nil</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1455082">if</span>&nbsp;<span class="ident" id="1455085">sg</span><span class="op" id="1455087">.</span><span class="ident" id="1455088">releasetime</span>&nbsp;<span class="op" id="1455100">!=</span>&nbsp;<span class="num" id="1455103">0</span>&nbsp;<span class="op" id="1455105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455110">sg</span><span class="op" id="1455112">.</span><span class="ident" id="1455113">releasetime</span>&nbsp;<span class="op" id="1455125">=</span>&nbsp;<span class="ident" id="1455127">cputicks</span><span class="op" id="1455135">(</span><span class="op" id="1455136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1455140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455144">goready</span><span class="op" id="1455151">(</span><span class="ident" id="1455152">gp</span><span class="op" id="1455154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1455157">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455160">unlock</span><span class="op" id="1455166">(</span><span class="op" id="1455167">&amp;</span><span class="ident" id="1455168">c</span><span class="op" id="1455169">.</span><span class="ident" id="1455170">lock</span><span class="op" id="1455174">)</span><br>
<span class="lineno"></span><span class="op" id="1455176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1455179">//&nbsp;entry&nbsp;points&nbsp;for&nbsp;&lt;-&nbsp;c&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1455223">//go:nosplit</span><br>
<span class="lineno">310</span><span class="keyword" id="1455236">func</span>&nbsp;<span class="ident" id="1455241">chanrecv1</span><span class="op" id="1455250">(</span><span class="ident" id="1455251">t</span>&nbsp;<span class="op" id="1455253">*</span><span class="ident" id="1455254">chantype</span><span class="op" id="1455262">,</span>&nbsp;<span class="ident" id="1455264">c</span>&nbsp;<span class="op" id="1455266">*</span><span class="ident" id="1455267">hchan</span><span class="op" id="1455272">,</span>&nbsp;<span class="ident" id="1455274">elem</span>&nbsp;<span class="ident" id="1455279">unsafe</span><span class="op" id="1455285">.</span><span class="ident" id="1455286">Pointer</span><span class="op" id="1455293">)</span>&nbsp;<span class="op" id="1455295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455298">chanrecv</span><span class="op" id="1455306">(</span><span class="ident" id="1455307">t</span><span class="op" id="1455308">,</span>&nbsp;<span class="ident" id="1455310">c</span><span class="op" id="1455311">,</span>&nbsp;<span class="ident" id="1455313">elem</span><span class="op" id="1455317">,</span>&nbsp;<span class="builtintype" id="1455319">true</span><span class="op" id="1455323">)</span><br>
<span class="lineno"></span><span class="op" id="1455325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1455328">//go:nosplit</span><br>
<span class="lineno">315</span><span class="keyword" id="1455341">func</span>&nbsp;<span class="ident" id="1455346">chanrecv2</span><span class="op" id="1455355">(</span><span class="ident" id="1455356">t</span>&nbsp;<span class="op" id="1455358">*</span><span class="ident" id="1455359">chantype</span><span class="op" id="1455367">,</span>&nbsp;<span class="ident" id="1455369">c</span>&nbsp;<span class="op" id="1455371">*</span><span class="ident" id="1455372">hchan</span><span class="op" id="1455377">,</span>&nbsp;<span class="ident" id="1455379">elem</span>&nbsp;<span class="ident" id="1455384">unsafe</span><span class="op" id="1455390">.</span><span class="ident" id="1455391">Pointer</span><span class="op" id="1455398">)</span>&nbsp;<span class="op" id="1455400">(</span><span class="ident" id="1455401">received</span>&nbsp;<span class="builtintype" id="1455410">bool</span><span class="op" id="1455414">)</span>&nbsp;<span class="op" id="1455416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1455419">_</span><span class="op" id="1455420">,</span>&nbsp;<span class="ident" id="1455422">received</span>&nbsp;<span class="op" id="1455431">=</span>&nbsp;<span class="ident" id="1455433">chanrecv</span><span class="op" id="1455441">(</span><span class="ident" id="1455442">t</span><span class="op" id="1455443">,</span>&nbsp;<span class="ident" id="1455445">c</span><span class="op" id="1455446">,</span>&nbsp;<span class="ident" id="1455448">elem</span><span class="op" id="1455452">,</span>&nbsp;<span class="builtintype" id="1455454">true</span><span class="op" id="1455458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1455461">return</span><br>
<span class="lineno"></span><span class="op" id="1455468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span><span class="comment" id="1455471">//&nbsp;chanrecv&nbsp;receives&nbsp;on&nbsp;channel&nbsp;c&nbsp;and&nbsp;writes&nbsp;the&nbsp;received&nbsp;data&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span><span class="comment" id="1455541">//&nbsp;ep&nbsp;may&nbsp;be&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;received&nbsp;data&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="1455599">//&nbsp;If&nbsp;block&nbsp;==&nbsp;false&nbsp;and&nbsp;no&nbsp;elements&nbsp;are&nbsp;available,&nbsp;returns&nbsp;(false,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1455675">//&nbsp;Otherwise,&nbsp;if&nbsp;c&nbsp;is&nbsp;closed,&nbsp;zeros&nbsp;*ep&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1455742">//&nbsp;Otherwise,&nbsp;fills&nbsp;in&nbsp;*ep&nbsp;with&nbsp;an&nbsp;element&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;true).</span><br>
<span class="lineno">325</span><span class="keyword" id="1455811">func</span>&nbsp;<span class="ident" id="1455816">chanrecv</span><span class="op" id="1455824">(</span><span class="ident" id="1455825">t</span>&nbsp;<span class="op" id="1455827">*</span><span class="ident" id="1455828">chantype</span><span class="op" id="1455836">,</span>&nbsp;<span class="ident" id="1455838">c</span>&nbsp;<span class="op" id="1455840">*</span><span class="ident" id="1455841">hchan</span><span class="op" id="1455846">,</span>&nbsp;<span class="ident" id="1455848">ep</span>&nbsp;<span class="ident" id="1455851">unsafe</span><span class="op" id="1455857">.</span><span class="ident" id="1455858">Pointer</span><span class="op" id="1455865">,</span>&nbsp;<span class="ident" id="1455867">block</span>&nbsp;<span class="builtintype" id="1455873">bool</span><span class="op" id="1455877">)</span>&nbsp;<span class="op" id="1455879">(</span><span class="ident" id="1455880">selected</span><span class="op" id="1455888">,</span>&nbsp;<span class="ident" id="1455890">received</span>&nbsp;<span class="builtintype" id="1455899">bool</span><span class="op" id="1455903">)</span>&nbsp;<span class="op" id="1455905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1455908">//&nbsp;raceenabled:&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;check&nbsp;ep,&nbsp;as&nbsp;it&nbsp;is&nbsp;always&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1455980">if</span>&nbsp;<span class="ident" id="1455983">debugChan</span>&nbsp;<span class="op" id="1455993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1455997">print</span><span class="op" id="1456002">(</span><span class="string" id="1456003">&#34;chanrecv:&nbsp;chan=&#34;</span><span class="op" id="1456020">,</span>&nbsp;<span class="ident" id="1456022">c</span><span class="op" id="1456023">,</span>&nbsp;<span class="string" id="1456025">&#34;\n&#34;</span><span class="op" id="1456029">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1456032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1456036">if</span>&nbsp;<span class="ident" id="1456039">c</span>&nbsp;<span class="op" id="1456041">==</span>&nbsp;<span class="ident" id="1456044">nil</span>&nbsp;<span class="op" id="1456048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1456052">if</span>&nbsp;<span class="op" id="1456055">!</span><span class="ident" id="1456056">block</span>&nbsp;<span class="op" id="1456062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1456067">return</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1456076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1456080">gopark</span><span class="op" id="1456086">(</span><span class="ident" id="1456087">nil</span><span class="op" id="1456090">,</span>&nbsp;<span class="ident" id="1456092">nil</span><span class="op" id="1456095">,</span>&nbsp;<span class="string" id="1456097">&#34;chan&nbsp;receive&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1456122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1456126">gothrow</span><span class="op" id="1456133">(</span><span class="string" id="1456134">&#34;unreachable&#34;</span><span class="op" id="1456147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1456150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456154">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456237">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456241">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;ready&nbsp;for&nbsp;receiving,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456326">//&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456408">//&nbsp;(first&nbsp;c.sendq.first&nbsp;or&nbsp;c.qcount,&nbsp;and&nbsp;second&nbsp;c.closed).</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456468">//&nbsp;Because&nbsp;a&nbsp;channel&nbsp;cannot&nbsp;be&nbsp;reopened,&nbsp;the&nbsp;later&nbsp;observation&nbsp;of&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456547">//&nbsp;being&nbsp;not&nbsp;closed&nbsp;implies&nbsp;that&nbsp;it&nbsp;was&nbsp;also&nbsp;not&nbsp;closed&nbsp;at&nbsp;the&nbsp;moment&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456625">//&nbsp;first&nbsp;observation.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456703">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;receive&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456751">//</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456755">//&nbsp;The&nbsp;order&nbsp;of&nbsp;operations&nbsp;is&nbsp;important&nbsp;here:&nbsp;reversing&nbsp;the&nbsp;operations&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1456839">//&nbsp;incorrect&nbsp;behavior&nbsp;when&nbsp;racing&nbsp;with&nbsp;a&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1456888">if</span>&nbsp;<span class="op" id="1456891">!</span><span class="ident" id="1456892">block</span>&nbsp;<span class="op" id="1456898">&amp;&amp;</span>&nbsp;<span class="op" id="1456901">(</span><span class="ident" id="1456902">c</span><span class="op" id="1456903">.</span><span class="ident" id="1456904">dataqsiz</span>&nbsp;<span class="op" id="1456913">==</span>&nbsp;<span class="num" id="1456916">0</span>&nbsp;<span class="op" id="1456918">&amp;&amp;</span>&nbsp;<span class="ident" id="1456921">c</span><span class="op" id="1456922">.</span><span class="ident" id="1456923">sendq</span><span class="op" id="1456928">.</span><span class="ident" id="1456929">first</span>&nbsp;<span class="op" id="1456935">==</span>&nbsp;<span class="ident" id="1456938">nil</span>&nbsp;<span class="op" id="1456942">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1456947">c</span><span class="op" id="1456948">.</span><span class="ident" id="1456949">dataqsiz</span>&nbsp;<span class="op" id="1456958">&gt;</span>&nbsp;<span class="num" id="1456960">0</span>&nbsp;<span class="op" id="1456962">&amp;&amp;</span>&nbsp;<span class="ident" id="1456965">atomicloaduint</span><span class="op" id="1456979">(</span><span class="op" id="1456980">&amp;</span><span class="ident" id="1456981">c</span><span class="op" id="1456982">.</span><span class="ident" id="1456983">qcount</span><span class="op" id="1456989">)</span>&nbsp;<span class="op" id="1456991">==</span>&nbsp;<span class="num" id="1456994">0</span><span class="op" id="1456995">)</span>&nbsp;<span class="op" id="1456997">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457002">atomicload</span><span class="op" id="1457012">(</span><span class="op" id="1457013">&amp;</span><span class="ident" id="1457014">c</span><span class="op" id="1457015">.</span><span class="ident" id="1457016">closed</span><span class="op" id="1457022">)</span>&nbsp;<span class="op" id="1457024">==</span>&nbsp;<span class="num" id="1457027">0</span>&nbsp;<span class="op" id="1457029">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457033">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1457041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457045">var</span>&nbsp;<span class="ident" id="1457049">t0</span>&nbsp;<span class="ident" id="1457052">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457059">if</span>&nbsp;<span class="ident" id="1457062">blockprofilerate</span>&nbsp;<span class="op" id="1457079">&gt;</span>&nbsp;<span class="num" id="1457081">0</span>&nbsp;<span class="op" id="1457083">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457087">t0</span>&nbsp;<span class="op" id="1457090">=</span>&nbsp;<span class="ident" id="1457092">cputicks</span><span class="op" id="1457100">(</span><span class="op" id="1457101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1457104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457108">lock</span><span class="op" id="1457112">(</span><span class="op" id="1457113">&amp;</span><span class="ident" id="1457114">c</span><span class="op" id="1457115">.</span><span class="ident" id="1457116">lock</span><span class="op" id="1457120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457123">if</span>&nbsp;<span class="ident" id="1457126">c</span><span class="op" id="1457127">.</span><span class="ident" id="1457128">dataqsiz</span>&nbsp;<span class="op" id="1457137">==</span>&nbsp;<span class="num" id="1457140">0</span>&nbsp;<span class="op" id="1457142">{</span>&nbsp;<span class="comment" id="1457144">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457169">if</span>&nbsp;<span class="ident" id="1457172">c</span><span class="op" id="1457173">.</span><span class="ident" id="1457174">closed</span>&nbsp;<span class="op" id="1457181">!=</span>&nbsp;<span class="num" id="1457184">0</span>&nbsp;<span class="op" id="1457186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457191">return</span>&nbsp;<span class="ident" id="1457198">recvclosed</span><span class="op" id="1457208">(</span><span class="ident" id="1457209">c</span><span class="op" id="1457210">,</span>&nbsp;<span class="ident" id="1457212">ep</span><span class="op" id="1457214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1457218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457223">sg</span>&nbsp;<span class="op" id="1457226">:=</span>&nbsp;<span class="ident" id="1457229">c</span><span class="op" id="1457230">.</span><span class="ident" id="1457231">sendq</span><span class="op" id="1457236">.</span><span class="ident" id="1457237">dequeue</span><span class="op" id="1457244">(</span><span class="op" id="1457245">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457249">if</span>&nbsp;<span class="ident" id="1457252">sg</span>&nbsp;<span class="op" id="1457255">!=</span>&nbsp;<span class="ident" id="1457258">nil</span>&nbsp;<span class="op" id="1457262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457267">if</span>&nbsp;<span class="ident" id="1457270">raceenabled</span>&nbsp;<span class="op" id="1457282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457288">racesync</span><span class="op" id="1457296">(</span><span class="ident" id="1457297">c</span><span class="op" id="1457298">,</span>&nbsp;<span class="ident" id="1457300">sg</span><span class="op" id="1457302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1457307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457312">unlock</span><span class="op" id="1457318">(</span><span class="op" id="1457319">&amp;</span><span class="ident" id="1457320">c</span><span class="op" id="1457321">.</span><span class="ident" id="1457322">lock</span><span class="op" id="1457326">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457332">if</span>&nbsp;<span class="ident" id="1457335">ep</span>&nbsp;<span class="op" id="1457338">!=</span>&nbsp;<span class="ident" id="1457341">nil</span>&nbsp;<span class="op" id="1457345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457351">memmove</span><span class="op" id="1457358">(</span><span class="ident" id="1457359">ep</span><span class="op" id="1457361">,</span>&nbsp;<span class="ident" id="1457363">sg</span><span class="op" id="1457365">.</span><span class="ident" id="1457366">elem</span><span class="op" id="1457370">,</span>&nbsp;<span class="builtintype" id="1457372">uintptr</span><span class="op" id="1457379">(</span><span class="ident" id="1457380">c</span><span class="op" id="1457381">.</span><span class="ident" id="1457382">elemsize</span><span class="op" id="1457390">)</span><span class="op" id="1457391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1457396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457401">sg</span><span class="op" id="1457403">.</span><span class="ident" id="1457404">elem</span>&nbsp;<span class="op" id="1457409">=</span>&nbsp;<span class="ident" id="1457411">nil</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457418">gp</span>&nbsp;<span class="op" id="1457421">:=</span>&nbsp;<span class="ident" id="1457424">sg</span><span class="op" id="1457426">.</span><span class="ident" id="1457427">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457432">gp</span><span class="op" id="1457434">.</span><span class="ident" id="1457435">param</span>&nbsp;<span class="op" id="1457441">=</span>&nbsp;<span class="ident" id="1457443">unsafe</span><span class="op" id="1457449">.</span><span class="ident" id="1457450">Pointer</span><span class="op" id="1457457">(</span><span class="ident" id="1457458">sg</span><span class="op" id="1457460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457465">if</span>&nbsp;<span class="ident" id="1457468">sg</span><span class="op" id="1457470">.</span><span class="ident" id="1457471">releasetime</span>&nbsp;<span class="op" id="1457483">!=</span>&nbsp;<span class="num" id="1457486">0</span>&nbsp;<span class="op" id="1457488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457494">sg</span><span class="op" id="1457496">.</span><span class="ident" id="1457497">releasetime</span>&nbsp;<span class="op" id="1457509">=</span>&nbsp;<span class="ident" id="1457511">cputicks</span><span class="op" id="1457519">(</span><span class="op" id="1457520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1457525">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457530">goready</span><span class="op" id="1457537">(</span><span class="ident" id="1457538">gp</span><span class="op" id="1457540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457545">selected</span>&nbsp;<span class="op" id="1457554">=</span>&nbsp;<span class="builtintype" id="1457556">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457564">received</span>&nbsp;<span class="op" id="1457573">=</span>&nbsp;<span class="builtintype" id="1457575">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457583">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1457592">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457597">if</span>&nbsp;<span class="op" id="1457600">!</span><span class="ident" id="1457601">block</span>&nbsp;<span class="op" id="1457607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457612">unlock</span><span class="op" id="1457618">(</span><span class="op" id="1457619">&amp;</span><span class="ident" id="1457620">c</span><span class="op" id="1457621">.</span><span class="ident" id="1457622">lock</span><span class="op" id="1457626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457631">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1457640">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457645">//&nbsp;no&nbsp;sender&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457694">gp</span>&nbsp;<span class="op" id="1457697">:=</span>&nbsp;<span class="ident" id="1457700">getg</span><span class="op" id="1457704">(</span><span class="op" id="1457705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457709">mysg</span>&nbsp;<span class="op" id="1457714">:=</span>&nbsp;<span class="ident" id="1457717">acquireSudog</span><span class="op" id="1457729">(</span><span class="op" id="1457730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457734">mysg</span><span class="op" id="1457738">.</span><span class="ident" id="1457739">releasetime</span>&nbsp;<span class="op" id="1457751">=</span>&nbsp;<span class="num" id="1457753">0</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1457757">if</span>&nbsp;<span class="ident" id="1457760">t0</span>&nbsp;<span class="op" id="1457763">!=</span>&nbsp;<span class="num" id="1457766">0</span>&nbsp;<span class="op" id="1457768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457773">mysg</span><span class="op" id="1457777">.</span><span class="ident" id="1457778">releasetime</span>&nbsp;<span class="op" id="1457790">=</span>&nbsp;<span class="op" id="1457792">-</span><span class="num" id="1457793">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1457797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457801">mysg</span><span class="op" id="1457805">.</span><span class="ident" id="1457806">elem</span>&nbsp;<span class="op" id="1457811">=</span>&nbsp;<span class="ident" id="1457813">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457818">mysg</span><span class="op" id="1457822">.</span><span class="ident" id="1457823">waitlink</span>&nbsp;<span class="op" id="1457832">=</span>&nbsp;<span class="ident" id="1457834">nil</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457840">gp</span><span class="op" id="1457842">.</span><span class="ident" id="1457843">waiting</span>&nbsp;<span class="op" id="1457851">=</span>&nbsp;<span class="ident" id="1457853">mysg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457860">mysg</span><span class="op" id="1457864">.</span><span class="ident" id="1457865">g</span>&nbsp;<span class="op" id="1457867">=</span>&nbsp;<span class="ident" id="1457869">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457874">mysg</span><span class="op" id="1457878">.</span><span class="ident" id="1457879">selectdone</span>&nbsp;<span class="op" id="1457890">=</span>&nbsp;<span class="ident" id="1457892">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457898">gp</span><span class="op" id="1457900">.</span><span class="ident" id="1457901">param</span>&nbsp;<span class="op" id="1457907">=</span>&nbsp;<span class="ident" id="1457909">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457915">c</span><span class="op" id="1457916">.</span><span class="ident" id="1457917">recvq</span><span class="op" id="1457922">.</span><span class="ident" id="1457923">enqueue</span><span class="op" id="1457930">(</span><span class="ident" id="1457931">mysg</span><span class="op" id="1457935">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1457939">goparkunlock</span><span class="op" id="1457951">(</span><span class="op" id="1457952">&amp;</span><span class="ident" id="1457953">c</span><span class="op" id="1457954">.</span><span class="ident" id="1457955">lock</span><span class="op" id="1457959">,</span>&nbsp;<span class="string" id="1457961">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1457975">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1457980">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458004">if</span>&nbsp;<span class="ident" id="1458007">mysg</span>&nbsp;<span class="op" id="1458012">!=</span>&nbsp;<span class="ident" id="1458015">gp</span><span class="op" id="1458017">.</span><span class="ident" id="1458018">waiting</span>&nbsp;<span class="op" id="1458026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458031">gothrow</span><span class="op" id="1458038">(</span><span class="string" id="1458039">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1458069">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458077">gp</span><span class="op" id="1458079">.</span><span class="ident" id="1458080">waiting</span>&nbsp;<span class="op" id="1458088">=</span>&nbsp;<span class="ident" id="1458090">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458096">if</span>&nbsp;<span class="ident" id="1458099">mysg</span><span class="op" id="1458103">.</span><span class="ident" id="1458104">releasetime</span>&nbsp;<span class="op" id="1458116">&gt;</span>&nbsp;<span class="num" id="1458118">0</span>&nbsp;<span class="op" id="1458120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458125">blockevent</span><span class="op" id="1458135">(</span><span class="ident" id="1458136">mysg</span><span class="op" id="1458140">.</span><span class="ident" id="1458141">releasetime</span><span class="op" id="1458152">-</span><span class="ident" id="1458153">t0</span><span class="op" id="1458155">,</span>&nbsp;<span class="num" id="1458157">2</span><span class="op" id="1458158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458162">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458166">haveData</span>&nbsp;<span class="op" id="1458175">:=</span>&nbsp;<span class="ident" id="1458178">gp</span><span class="op" id="1458180">.</span><span class="ident" id="1458181">param</span>&nbsp;<span class="op" id="1458187">!=</span>&nbsp;<span class="ident" id="1458190">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458196">gp</span><span class="op" id="1458198">.</span><span class="ident" id="1458199">param</span>&nbsp;<span class="op" id="1458205">=</span>&nbsp;<span class="ident" id="1458207">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458213">releaseSudog</span><span class="op" id="1458225">(</span><span class="ident" id="1458226">mysg</span><span class="op" id="1458230">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458235">if</span>&nbsp;<span class="ident" id="1458238">haveData</span>&nbsp;<span class="op" id="1458247">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458252">//&nbsp;a&nbsp;sender&nbsp;sent&nbsp;us&nbsp;some&nbsp;data.&nbsp;It&nbsp;already&nbsp;wrote&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458310">selected</span>&nbsp;<span class="op" id="1458319">=</span>&nbsp;<span class="builtintype" id="1458321">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458329">received</span>&nbsp;<span class="op" id="1458338">=</span>&nbsp;<span class="builtintype" id="1458340">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458348">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458357">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458362">lock</span><span class="op" id="1458366">(</span><span class="op" id="1458367">&amp;</span><span class="ident" id="1458368">c</span><span class="op" id="1458369">.</span><span class="ident" id="1458370">lock</span><span class="op" id="1458374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458378">if</span>&nbsp;<span class="ident" id="1458381">c</span><span class="op" id="1458382">.</span><span class="ident" id="1458383">closed</span>&nbsp;<span class="op" id="1458390">==</span>&nbsp;<span class="num" id="1458393">0</span>&nbsp;<span class="op" id="1458395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458400">gothrow</span><span class="op" id="1458407">(</span><span class="string" id="1458408">&#34;chanrecv:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1458435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458439">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458443">return</span>&nbsp;<span class="ident" id="1458450">recvclosed</span><span class="op" id="1458460">(</span><span class="ident" id="1458461">c</span><span class="op" id="1458462">,</span>&nbsp;<span class="ident" id="1458464">ep</span><span class="op" id="1458466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458473">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458498">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;data&nbsp;to&nbsp;appear</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458531">var</span>&nbsp;<span class="ident" id="1458535">t1</span>&nbsp;<span class="ident" id="1458538">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458545">for</span>&nbsp;<span class="ident" id="1458549">c</span><span class="op" id="1458550">.</span><span class="ident" id="1458551">qcount</span>&nbsp;<span class="op" id="1458558">&lt;=</span>&nbsp;<span class="num" id="1458561">0</span>&nbsp;<span class="op" id="1458563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458567">if</span>&nbsp;<span class="ident" id="1458570">c</span><span class="op" id="1458571">.</span><span class="ident" id="1458572">closed</span>&nbsp;<span class="op" id="1458579">!=</span>&nbsp;<span class="num" id="1458582">0</span>&nbsp;<span class="op" id="1458584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458589">selected</span><span class="op" id="1458597">,</span>&nbsp;<span class="ident" id="1458599">received</span>&nbsp;<span class="op" id="1458608">=</span>&nbsp;<span class="ident" id="1458610">recvclosed</span><span class="op" id="1458620">(</span><span class="ident" id="1458621">c</span><span class="op" id="1458622">,</span>&nbsp;<span class="ident" id="1458624">ep</span><span class="op" id="1458626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458631">if</span>&nbsp;<span class="ident" id="1458634">t1</span>&nbsp;<span class="op" id="1458637">&gt;</span>&nbsp;<span class="num" id="1458639">0</span>&nbsp;<span class="op" id="1458641">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458647">blockevent</span><span class="op" id="1458657">(</span><span class="ident" id="1458658">t1</span><span class="op" id="1458660">-</span><span class="ident" id="1458661">t0</span><span class="op" id="1458663">,</span>&nbsp;<span class="num" id="1458665">2</span><span class="op" id="1458666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458676">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458690">if</span>&nbsp;<span class="op" id="1458693">!</span><span class="ident" id="1458694">block</span>&nbsp;<span class="op" id="1458700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458705">unlock</span><span class="op" id="1458711">(</span><span class="op" id="1458712">&amp;</span><span class="ident" id="1458713">c</span><span class="op" id="1458714">.</span><span class="ident" id="1458715">lock</span><span class="op" id="1458719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458724">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458738">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;send&nbsp;an&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458779">gp</span>&nbsp;<span class="op" id="1458782">:=</span>&nbsp;<span class="ident" id="1458785">getg</span><span class="op" id="1458789">(</span><span class="op" id="1458790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458794">mysg</span>&nbsp;<span class="op" id="1458799">:=</span>&nbsp;<span class="ident" id="1458802">acquireSudog</span><span class="op" id="1458814">(</span><span class="op" id="1458815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458819">mysg</span><span class="op" id="1458823">.</span><span class="ident" id="1458824">releasetime</span>&nbsp;<span class="op" id="1458836">=</span>&nbsp;<span class="num" id="1458838">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1458842">if</span>&nbsp;<span class="ident" id="1458845">t0</span>&nbsp;<span class="op" id="1458848">!=</span>&nbsp;<span class="num" id="1458851">0</span>&nbsp;<span class="op" id="1458853">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458858">mysg</span><span class="op" id="1458862">.</span><span class="ident" id="1458863">releasetime</span>&nbsp;<span class="op" id="1458875">=</span>&nbsp;<span class="op" id="1458877">-</span><span class="num" id="1458878">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458886">mysg</span><span class="op" id="1458890">.</span><span class="ident" id="1458891">elem</span>&nbsp;<span class="op" id="1458896">=</span>&nbsp;<span class="ident" id="1458898">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458904">mysg</span><span class="op" id="1458908">.</span><span class="ident" id="1458909">g</span>&nbsp;<span class="op" id="1458911">=</span>&nbsp;<span class="ident" id="1458913">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458918">mysg</span><span class="op" id="1458922">.</span><span class="ident" id="1458923">selectdone</span>&nbsp;<span class="op" id="1458934">=</span>&nbsp;<span class="ident" id="1458936">nil</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458943">c</span><span class="op" id="1458944">.</span><span class="ident" id="1458945">recvq</span><span class="op" id="1458950">.</span><span class="ident" id="1458951">enqueue</span><span class="op" id="1458958">(</span><span class="ident" id="1458959">mysg</span><span class="op" id="1458963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458967">goparkunlock</span><span class="op" id="1458979">(</span><span class="op" id="1458980">&amp;</span><span class="ident" id="1458981">c</span><span class="op" id="1458982">.</span><span class="ident" id="1458983">lock</span><span class="op" id="1458987">,</span>&nbsp;<span class="string" id="1458989">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1459003">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459008">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459044">if</span>&nbsp;<span class="ident" id="1459047">mysg</span><span class="op" id="1459051">.</span><span class="ident" id="1459052">releasetime</span>&nbsp;<span class="op" id="1459064">&gt;</span>&nbsp;<span class="num" id="1459066">0</span>&nbsp;<span class="op" id="1459068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459073">t1</span>&nbsp;<span class="op" id="1459076">=</span>&nbsp;<span class="ident" id="1459078">mysg</span><span class="op" id="1459082">.</span><span class="ident" id="1459083">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459101">releaseSudog</span><span class="op" id="1459113">(</span><span class="ident" id="1459114">mysg</span><span class="op" id="1459118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459122">lock</span><span class="op" id="1459126">(</span><span class="op" id="1459127">&amp;</span><span class="ident" id="1459128">c</span><span class="op" id="1459129">.</span><span class="ident" id="1459130">lock</span><span class="op" id="1459134">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459141">if</span>&nbsp;<span class="ident" id="1459144">raceenabled</span>&nbsp;<span class="op" id="1459156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459160">raceacquire</span><span class="op" id="1459171">(</span><span class="ident" id="1459172">chanbuf</span><span class="op" id="1459179">(</span><span class="ident" id="1459180">c</span><span class="op" id="1459181">,</span>&nbsp;<span class="ident" id="1459183">c</span><span class="op" id="1459184">.</span><span class="ident" id="1459185">recvx</span><span class="op" id="1459190">)</span><span class="op" id="1459191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459195">racerelease</span><span class="op" id="1459206">(</span><span class="ident" id="1459207">chanbuf</span><span class="op" id="1459214">(</span><span class="ident" id="1459215">c</span><span class="op" id="1459216">,</span>&nbsp;<span class="ident" id="1459218">c</span><span class="op" id="1459219">.</span><span class="ident" id="1459220">recvx</span><span class="op" id="1459225">)</span><span class="op" id="1459226">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459232">if</span>&nbsp;<span class="ident" id="1459235">ep</span>&nbsp;<span class="op" id="1459238">!=</span>&nbsp;<span class="ident" id="1459241">nil</span>&nbsp;<span class="op" id="1459245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459249">memmove</span><span class="op" id="1459256">(</span><span class="ident" id="1459257">ep</span><span class="op" id="1459259">,</span>&nbsp;<span class="ident" id="1459261">chanbuf</span><span class="op" id="1459268">(</span><span class="ident" id="1459269">c</span><span class="op" id="1459270">,</span>&nbsp;<span class="ident" id="1459272">c</span><span class="op" id="1459273">.</span><span class="ident" id="1459274">recvx</span><span class="op" id="1459279">)</span><span class="op" id="1459280">,</span>&nbsp;<span class="builtintype" id="1459282">uintptr</span><span class="op" id="1459289">(</span><span class="ident" id="1459290">c</span><span class="op" id="1459291">.</span><span class="ident" id="1459292">elemsize</span><span class="op" id="1459300">)</span><span class="op" id="1459301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459307">memclr</span><span class="op" id="1459313">(</span><span class="ident" id="1459314">chanbuf</span><span class="op" id="1459321">(</span><span class="ident" id="1459322">c</span><span class="op" id="1459323">,</span>&nbsp;<span class="ident" id="1459325">c</span><span class="op" id="1459326">.</span><span class="ident" id="1459327">recvx</span><span class="op" id="1459332">)</span><span class="op" id="1459333">,</span>&nbsp;<span class="builtintype" id="1459335">uintptr</span><span class="op" id="1459342">(</span><span class="ident" id="1459343">c</span><span class="op" id="1459344">.</span><span class="ident" id="1459345">elemsize</span><span class="op" id="1459353">)</span><span class="op" id="1459354">)</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459358">c</span><span class="op" id="1459359">.</span><span class="ident" id="1459360">recvx</span><span class="op" id="1459365">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459369">if</span>&nbsp;<span class="ident" id="1459372">c</span><span class="op" id="1459373">.</span><span class="ident" id="1459374">recvx</span>&nbsp;<span class="op" id="1459380">==</span>&nbsp;<span class="ident" id="1459383">c</span><span class="op" id="1459384">.</span><span class="ident" id="1459385">dataqsiz</span>&nbsp;<span class="op" id="1459394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459398">c</span><span class="op" id="1459399">.</span><span class="ident" id="1459400">recvx</span>&nbsp;<span class="op" id="1459406">=</span>&nbsp;<span class="num" id="1459408">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459411">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459414">c</span><span class="op" id="1459415">.</span><span class="ident" id="1459416">qcount</span><span class="op" id="1459422">--</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459427">//&nbsp;ping&nbsp;a&nbsp;sender&nbsp;now&nbsp;that&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459469">sg</span>&nbsp;<span class="op" id="1459472">:=</span>&nbsp;<span class="ident" id="1459475">c</span><span class="op" id="1459476">.</span><span class="ident" id="1459477">sendq</span><span class="op" id="1459482">.</span><span class="ident" id="1459483">dequeue</span><span class="op" id="1459490">(</span><span class="op" id="1459491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459494">if</span>&nbsp;<span class="ident" id="1459497">sg</span>&nbsp;<span class="op" id="1459500">!=</span>&nbsp;<span class="ident" id="1459503">nil</span>&nbsp;<span class="op" id="1459507">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459511">gp</span>&nbsp;<span class="op" id="1459514">:=</span>&nbsp;<span class="ident" id="1459517">sg</span><span class="op" id="1459519">.</span><span class="ident" id="1459520">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459524">unlock</span><span class="op" id="1459530">(</span><span class="op" id="1459531">&amp;</span><span class="ident" id="1459532">c</span><span class="op" id="1459533">.</span><span class="ident" id="1459534">lock</span><span class="op" id="1459538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459542">if</span>&nbsp;<span class="ident" id="1459545">sg</span><span class="op" id="1459547">.</span><span class="ident" id="1459548">releasetime</span>&nbsp;<span class="op" id="1459560">!=</span>&nbsp;<span class="num" id="1459563">0</span>&nbsp;<span class="op" id="1459565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459570">sg</span><span class="op" id="1459572">.</span><span class="ident" id="1459573">releasetime</span>&nbsp;<span class="op" id="1459585">=</span>&nbsp;<span class="ident" id="1459587">cputicks</span><span class="op" id="1459595">(</span><span class="op" id="1459596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459600">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459604">goready</span><span class="op" id="1459611">(</span><span class="ident" id="1459612">gp</span><span class="op" id="1459614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459617">}</span>&nbsp;<span class="keyword" id="1459619">else</span>&nbsp;<span class="op" id="1459624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459628">unlock</span><span class="op" id="1459634">(</span><span class="op" id="1459635">&amp;</span><span class="ident" id="1459636">c</span><span class="op" id="1459637">.</span><span class="ident" id="1459638">lock</span><span class="op" id="1459642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459649">if</span>&nbsp;<span class="ident" id="1459652">t1</span>&nbsp;<span class="op" id="1459655">&gt;</span>&nbsp;<span class="num" id="1459657">0</span>&nbsp;<span class="op" id="1459659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459663">blockevent</span><span class="op" id="1459673">(</span><span class="ident" id="1459674">t1</span><span class="op" id="1459676">-</span><span class="ident" id="1459677">t0</span><span class="op" id="1459679">,</span>&nbsp;<span class="num" id="1459681">2</span><span class="op" id="1459682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1459685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459688">selected</span>&nbsp;<span class="op" id="1459697">=</span>&nbsp;<span class="builtintype" id="1459699">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459705">received</span>&nbsp;<span class="op" id="1459714">=</span>&nbsp;<span class="builtintype" id="1459716">true</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459722">return</span><br>
<span class="lineno"></span><span class="op" id="1459729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1459732">//&nbsp;recvclosed&nbsp;is&nbsp;a&nbsp;helper&nbsp;function&nbsp;for&nbsp;chanrecv.&nbsp;&nbsp;Handles&nbsp;cleanup</span><br>
<span class="lineno"></span><span class="comment" id="1459798">//&nbsp;when&nbsp;the&nbsp;receiver&nbsp;encounters&nbsp;a&nbsp;closed&nbsp;channel.</span><br>
<span class="lineno">515</span><span class="comment" id="1459848">//&nbsp;Caller&nbsp;must&nbsp;hold&nbsp;c.lock,&nbsp;recvclosed&nbsp;will&nbsp;release&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1459910">func</span>&nbsp;<span class="ident" id="1459915">recvclosed</span><span class="op" id="1459925">(</span><span class="ident" id="1459926">c</span>&nbsp;<span class="op" id="1459928">*</span><span class="ident" id="1459929">hchan</span><span class="op" id="1459934">,</span>&nbsp;<span class="ident" id="1459936">ep</span>&nbsp;<span class="ident" id="1459939">unsafe</span><span class="op" id="1459945">.</span><span class="ident" id="1459946">Pointer</span><span class="op" id="1459953">)</span>&nbsp;<span class="op" id="1459955">(</span><span class="ident" id="1459956">selected</span><span class="op" id="1459964">,</span>&nbsp;<span class="ident" id="1459966">recevied</span>&nbsp;<span class="builtintype" id="1459975">bool</span><span class="op" id="1459979">)</span>&nbsp;<span class="op" id="1459981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1459984">if</span>&nbsp;<span class="ident" id="1459987">raceenabled</span>&nbsp;<span class="op" id="1459999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460003">raceacquire</span><span class="op" id="1460014">(</span><span class="ident" id="1460015">unsafe</span><span class="op" id="1460021">.</span><span class="ident" id="1460022">Pointer</span><span class="op" id="1460029">(</span><span class="ident" id="1460030">c</span><span class="op" id="1460031">)</span><span class="op" id="1460032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1460035">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460038">unlock</span><span class="op" id="1460044">(</span><span class="op" id="1460045">&amp;</span><span class="ident" id="1460046">c</span><span class="op" id="1460047">.</span><span class="ident" id="1460048">lock</span><span class="op" id="1460052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1460055">if</span>&nbsp;<span class="ident" id="1460058">ep</span>&nbsp;<span class="op" id="1460061">!=</span>&nbsp;<span class="ident" id="1460064">nil</span>&nbsp;<span class="op" id="1460068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460072">memclr</span><span class="op" id="1460078">(</span><span class="ident" id="1460079">ep</span><span class="op" id="1460081">,</span>&nbsp;<span class="builtintype" id="1460083">uintptr</span><span class="op" id="1460090">(</span><span class="ident" id="1460091">c</span><span class="op" id="1460092">.</span><span class="ident" id="1460093">elemsize</span><span class="op" id="1460101">)</span><span class="op" id="1460102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1460105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1460108">return</span>&nbsp;<span class="builtintype" id="1460115">true</span><span class="op" id="1460119">,</span>&nbsp;<span class="builtintype" id="1460121">false</span><br>
<span class="lineno">525</span><span class="op" id="1460127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1460130">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1460153">//</span><br>
<span class="lineno"></span><span class="comment" id="1460156">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno">530</span><span class="comment" id="1460168">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;c&nbsp;&lt;-&nbsp;v:</span><br>
<span class="lineno"></span><span class="comment" id="1460184">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1460196">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1460208">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1460220">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">535</span><span class="comment" id="1460225">//</span><br>
<span class="lineno"></span><span class="comment" id="1460228">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1460234">//</span><br>
<span class="lineno"></span><span class="comment" id="1460237">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbsend(c,&nbsp;v)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1460264">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">540</span><span class="comment" id="1460276">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1460288">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1460300">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1460305">//</span><br>
<span class="lineno"></span><span class="keyword" id="1460308">func</span>&nbsp;<span class="ident" id="1460313">selectnbsend</span><span class="op" id="1460325">(</span><span class="ident" id="1460326">t</span>&nbsp;<span class="op" id="1460328">*</span><span class="ident" id="1460329">chantype</span><span class="op" id="1460337">,</span>&nbsp;<span class="ident" id="1460339">c</span>&nbsp;<span class="op" id="1460341">*</span><span class="ident" id="1460342">hchan</span><span class="op" id="1460347">,</span>&nbsp;<span class="ident" id="1460349">elem</span>&nbsp;<span class="ident" id="1460354">unsafe</span><span class="op" id="1460360">.</span><span class="ident" id="1460361">Pointer</span><span class="op" id="1460368">)</span>&nbsp;<span class="op" id="1460370">(</span><span class="ident" id="1460371">selected</span>&nbsp;<span class="builtintype" id="1460380">bool</span><span class="op" id="1460384">)</span>&nbsp;<span class="op" id="1460386">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1460389">return</span>&nbsp;<span class="ident" id="1460396">chansend</span><span class="op" id="1460404">(</span><span class="ident" id="1460405">t</span><span class="op" id="1460406">,</span>&nbsp;<span class="ident" id="1460408">c</span><span class="op" id="1460409">,</span>&nbsp;<span class="ident" id="1460411">elem</span><span class="op" id="1460415">,</span>&nbsp;<span class="builtintype" id="1460417">false</span><span class="op" id="1460422">,</span>&nbsp;<span class="ident" id="1460424">getcallerpc</span><span class="op" id="1460435">(</span><span class="ident" id="1460436">unsafe</span><span class="op" id="1460442">.</span><span class="ident" id="1460443">Pointer</span><span class="op" id="1460450">(</span><span class="op" id="1460451">&amp;</span><span class="ident" id="1460452">t</span><span class="op" id="1460453">)</span><span class="op" id="1460454">)</span><span class="op" id="1460455">)</span><br>
<span class="lineno"></span><span class="op" id="1460457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1460460">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1460483">//</span><br>
<span class="lineno">550</span><span class="comment" id="1460486">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1460498">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1460515">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1460527">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1460539">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">555</span><span class="comment" id="1460551">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1460556">//</span><br>
<span class="lineno"></span><span class="comment" id="1460559">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1460565">//</span><br>
<span class="lineno"></span><span class="comment" id="1460568">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbrecv(&amp;v,&nbsp;c)&nbsp;{</span><br>
<span class="lineno">560</span><span class="comment" id="1460596">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1460608">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1460620">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1460632">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1460637">//</span><br>
<span class="lineno">565</span><span class="keyword" id="1460640">func</span>&nbsp;<span class="ident" id="1460645">selectnbrecv</span><span class="op" id="1460657">(</span><span class="ident" id="1460658">t</span>&nbsp;<span class="op" id="1460660">*</span><span class="ident" id="1460661">chantype</span><span class="op" id="1460669">,</span>&nbsp;<span class="ident" id="1460671">elem</span>&nbsp;<span class="ident" id="1460676">unsafe</span><span class="op" id="1460682">.</span><span class="ident" id="1460683">Pointer</span><span class="op" id="1460690">,</span>&nbsp;<span class="ident" id="1460692">c</span>&nbsp;<span class="op" id="1460694">*</span><span class="ident" id="1460695">hchan</span><span class="op" id="1460700">)</span>&nbsp;<span class="op" id="1460702">(</span><span class="ident" id="1460703">selected</span>&nbsp;<span class="builtintype" id="1460712">bool</span><span class="op" id="1460716">)</span>&nbsp;<span class="op" id="1460718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460721">selected</span><span class="op" id="1460729">,</span>&nbsp;<span class="ident" id="1460731">_</span>&nbsp;<span class="op" id="1460733">=</span>&nbsp;<span class="ident" id="1460735">chanrecv</span><span class="op" id="1460743">(</span><span class="ident" id="1460744">t</span><span class="op" id="1460745">,</span>&nbsp;<span class="ident" id="1460747">c</span><span class="op" id="1460748">,</span>&nbsp;<span class="ident" id="1460750">elem</span><span class="op" id="1460754">,</span>&nbsp;<span class="builtintype" id="1460756">false</span><span class="op" id="1460761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1460764">return</span><br>
<span class="lineno"></span><span class="op" id="1460771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span><span class="comment" id="1460774">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1460797">//</span><br>
<span class="lineno"></span><span class="comment" id="1460800">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1460812">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v,&nbsp;ok&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1460833">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">575</span><span class="comment" id="1460845">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1460857">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1460869">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1460874">//</span><br>
<span class="lineno"></span><span class="comment" id="1460877">//&nbsp;as</span><br>
<span class="lineno">580</span><span class="comment" id="1460883">//</span><br>
<span class="lineno"></span><span class="comment" id="1460886">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;c&nbsp;!=&nbsp;nil&nbsp;&amp;&amp;&nbsp;selectnbrecv2(&amp;v,&nbsp;&amp;ok,&nbsp;c)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1460932">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1460944">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1460956">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">585</span><span class="comment" id="1460968">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1460973">//</span><br>
<span class="lineno"></span><span class="keyword" id="1460976">func</span>&nbsp;<span class="ident" id="1460981">selectnbrecv2</span><span class="op" id="1460994">(</span><span class="ident" id="1460995">t</span>&nbsp;<span class="op" id="1460997">*</span><span class="ident" id="1460998">chantype</span><span class="op" id="1461006">,</span>&nbsp;<span class="ident" id="1461008">elem</span>&nbsp;<span class="ident" id="1461013">unsafe</span><span class="op" id="1461019">.</span><span class="ident" id="1461020">Pointer</span><span class="op" id="1461027">,</span>&nbsp;<span class="ident" id="1461029">received</span>&nbsp;<span class="op" id="1461038">*</span><span class="builtintype" id="1461039">bool</span><span class="op" id="1461043">,</span>&nbsp;<span class="ident" id="1461045">c</span>&nbsp;<span class="op" id="1461047">*</span><span class="ident" id="1461048">hchan</span><span class="op" id="1461053">)</span>&nbsp;<span class="op" id="1461055">(</span><span class="ident" id="1461056">selected</span>&nbsp;<span class="builtintype" id="1461065">bool</span><span class="op" id="1461069">)</span>&nbsp;<span class="op" id="1461071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1461074">//&nbsp;TODO(khr):&nbsp;just&nbsp;return&nbsp;2&nbsp;values&nbsp;from&nbsp;this&nbsp;function,&nbsp;now&nbsp;that&nbsp;it&nbsp;is&nbsp;in&nbsp;Go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461152">selected</span><span class="op" id="1461160">,</span>&nbsp;<span class="op" id="1461162">*</span><span class="ident" id="1461163">received</span>&nbsp;<span class="op" id="1461172">=</span>&nbsp;<span class="ident" id="1461174">chanrecv</span><span class="op" id="1461182">(</span><span class="ident" id="1461183">t</span><span class="op" id="1461184">,</span>&nbsp;<span class="ident" id="1461186">c</span><span class="op" id="1461187">,</span>&nbsp;<span class="ident" id="1461189">elem</span><span class="op" id="1461193">,</span>&nbsp;<span class="builtintype" id="1461195">false</span><span class="op" id="1461200">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461203">return</span><br>
<span class="lineno"></span><span class="op" id="1461210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1461213">func</span>&nbsp;<span class="ident" id="1461218">reflect_chansend</span><span class="op" id="1461234">(</span><span class="ident" id="1461235">t</span>&nbsp;<span class="op" id="1461237">*</span><span class="ident" id="1461238">chantype</span><span class="op" id="1461246">,</span>&nbsp;<span class="ident" id="1461248">c</span>&nbsp;<span class="op" id="1461250">*</span><span class="ident" id="1461251">hchan</span><span class="op" id="1461256">,</span>&nbsp;<span class="ident" id="1461258">elem</span>&nbsp;<span class="ident" id="1461263">unsafe</span><span class="op" id="1461269">.</span><span class="ident" id="1461270">Pointer</span><span class="op" id="1461277">,</span>&nbsp;<span class="ident" id="1461279">nb</span>&nbsp;<span class="builtintype" id="1461282">bool</span><span class="op" id="1461286">)</span>&nbsp;<span class="op" id="1461288">(</span><span class="ident" id="1461289">selected</span>&nbsp;<span class="builtintype" id="1461298">bool</span><span class="op" id="1461302">)</span>&nbsp;<span class="op" id="1461304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461307">return</span>&nbsp;<span class="ident" id="1461314">chansend</span><span class="op" id="1461322">(</span><span class="ident" id="1461323">t</span><span class="op" id="1461324">,</span>&nbsp;<span class="ident" id="1461326">c</span><span class="op" id="1461327">,</span>&nbsp;<span class="ident" id="1461329">elem</span><span class="op" id="1461333">,</span>&nbsp;<span class="op" id="1461335">!</span><span class="ident" id="1461336">nb</span><span class="op" id="1461338">,</span>&nbsp;<span class="ident" id="1461340">getcallerpc</span><span class="op" id="1461351">(</span><span class="ident" id="1461352">unsafe</span><span class="op" id="1461358">.</span><span class="ident" id="1461359">Pointer</span><span class="op" id="1461366">(</span><span class="op" id="1461367">&amp;</span><span class="ident" id="1461368">t</span><span class="op" id="1461369">)</span><span class="op" id="1461370">)</span><span class="op" id="1461371">)</span><br>
<span class="lineno">595</span><span class="op" id="1461373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1461376">func</span>&nbsp;<span class="ident" id="1461381">reflect_chanrecv</span><span class="op" id="1461397">(</span><span class="ident" id="1461398">t</span>&nbsp;<span class="op" id="1461400">*</span><span class="ident" id="1461401">chantype</span><span class="op" id="1461409">,</span>&nbsp;<span class="ident" id="1461411">c</span>&nbsp;<span class="op" id="1461413">*</span><span class="ident" id="1461414">hchan</span><span class="op" id="1461419">,</span>&nbsp;<span class="ident" id="1461421">nb</span>&nbsp;<span class="builtintype" id="1461424">bool</span><span class="op" id="1461428">,</span>&nbsp;<span class="ident" id="1461430">elem</span>&nbsp;<span class="ident" id="1461435">unsafe</span><span class="op" id="1461441">.</span><span class="ident" id="1461442">Pointer</span><span class="op" id="1461449">)</span>&nbsp;<span class="op" id="1461451">(</span><span class="ident" id="1461452">selected</span>&nbsp;<span class="builtintype" id="1461461">bool</span><span class="op" id="1461465">,</span>&nbsp;<span class="ident" id="1461467">received</span>&nbsp;<span class="builtintype" id="1461476">bool</span><span class="op" id="1461480">)</span>&nbsp;<span class="op" id="1461482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461485">return</span>&nbsp;<span class="ident" id="1461492">chanrecv</span><span class="op" id="1461500">(</span><span class="ident" id="1461501">t</span><span class="op" id="1461502">,</span>&nbsp;<span class="ident" id="1461504">c</span><span class="op" id="1461505">,</span>&nbsp;<span class="ident" id="1461507">elem</span><span class="op" id="1461511">,</span>&nbsp;<span class="op" id="1461513">!</span><span class="ident" id="1461514">nb</span><span class="op" id="1461516">)</span><br>
<span class="lineno"></span><span class="op" id="1461518">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="1461521">func</span>&nbsp;<span class="ident" id="1461526">reflect_chanlen</span><span class="op" id="1461541">(</span><span class="ident" id="1461542">c</span>&nbsp;<span class="op" id="1461544">*</span><span class="ident" id="1461545">hchan</span><span class="op" id="1461550">)</span>&nbsp;<span class="builtintype" id="1461552">int</span>&nbsp;<span class="op" id="1461556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461559">if</span>&nbsp;<span class="ident" id="1461562">c</span>&nbsp;<span class="op" id="1461564">==</span>&nbsp;<span class="ident" id="1461567">nil</span>&nbsp;<span class="op" id="1461571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461575">return</span>&nbsp;<span class="num" id="1461582">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1461585">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461588">return</span>&nbsp;<span class="builtintype" id="1461595">int</span><span class="op" id="1461598">(</span><span class="ident" id="1461599">c</span><span class="op" id="1461600">.</span><span class="ident" id="1461601">qcount</span><span class="op" id="1461607">)</span><br>
<span class="lineno"></span><span class="op" id="1461609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1461612">func</span>&nbsp;<span class="ident" id="1461617">reflect_chancap</span><span class="op" id="1461632">(</span><span class="ident" id="1461633">c</span>&nbsp;<span class="op" id="1461635">*</span><span class="ident" id="1461636">hchan</span><span class="op" id="1461641">)</span>&nbsp;<span class="builtintype" id="1461643">int</span>&nbsp;<span class="op" id="1461647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461650">if</span>&nbsp;<span class="ident" id="1461653">c</span>&nbsp;<span class="op" id="1461655">==</span>&nbsp;<span class="ident" id="1461658">nil</span>&nbsp;<span class="op" id="1461662">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461666">return</span>&nbsp;<span class="num" id="1461673">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1461676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461679">return</span>&nbsp;<span class="builtintype" id="1461686">int</span><span class="op" id="1461689">(</span><span class="ident" id="1461690">c</span><span class="op" id="1461691">.</span><span class="ident" id="1461692">dataqsiz</span><span class="op" id="1461700">)</span><br>
<span class="lineno"></span><span class="op" id="1461702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="keyword" id="1461705">func</span>&nbsp;<span class="op" id="1461710">(</span><span class="ident" id="1461711">q</span>&nbsp;<span class="op" id="1461713">*</span><span class="ident" id="1461714">waitq</span><span class="op" id="1461719">)</span>&nbsp;<span class="ident" id="1461721">enqueue</span><span class="op" id="1461728">(</span><span class="ident" id="1461729">sgp</span>&nbsp;<span class="op" id="1461733">*</span><span class="ident" id="1461734">sudog</span><span class="op" id="1461739">)</span>&nbsp;<span class="op" id="1461741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461744">sgp</span><span class="op" id="1461747">.</span><span class="ident" id="1461748">next</span>&nbsp;<span class="op" id="1461753">=</span>&nbsp;<span class="ident" id="1461755">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461760">if</span>&nbsp;<span class="ident" id="1461763">q</span><span class="op" id="1461764">.</span><span class="ident" id="1461765">first</span>&nbsp;<span class="op" id="1461771">==</span>&nbsp;<span class="ident" id="1461774">nil</span>&nbsp;<span class="op" id="1461778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461782">q</span><span class="op" id="1461783">.</span><span class="ident" id="1461784">first</span>&nbsp;<span class="op" id="1461790">=</span>&nbsp;<span class="ident" id="1461792">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461798">q</span><span class="op" id="1461799">.</span><span class="ident" id="1461800">last</span>&nbsp;<span class="op" id="1461805">=</span>&nbsp;<span class="ident" id="1461807">sgp</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461813">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1461821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461824">q</span><span class="op" id="1461825">.</span><span class="ident" id="1461826">last</span><span class="op" id="1461830">.</span><span class="ident" id="1461831">next</span>&nbsp;<span class="op" id="1461836">=</span>&nbsp;<span class="ident" id="1461838">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461843">q</span><span class="op" id="1461844">.</span><span class="ident" id="1461845">last</span>&nbsp;<span class="op" id="1461850">=</span>&nbsp;<span class="ident" id="1461852">sgp</span><br>
<span class="lineno"></span><span class="op" id="1461856">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span><span class="keyword" id="1461859">func</span>&nbsp;<span class="op" id="1461864">(</span><span class="ident" id="1461865">q</span>&nbsp;<span class="op" id="1461867">*</span><span class="ident" id="1461868">waitq</span><span class="op" id="1461873">)</span>&nbsp;<span class="ident" id="1461875">dequeue</span><span class="op" id="1461882">(</span><span class="op" id="1461883">)</span>&nbsp;<span class="op" id="1461885">*</span><span class="ident" id="1461886">sudog</span>&nbsp;<span class="op" id="1461892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461895">for</span>&nbsp;<span class="op" id="1461899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461903">sgp</span>&nbsp;<span class="op" id="1461907">:=</span>&nbsp;<span class="ident" id="1461910">q</span><span class="op" id="1461911">.</span><span class="ident" id="1461912">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461920">if</span>&nbsp;<span class="ident" id="1461923">sgp</span>&nbsp;<span class="op" id="1461927">==</span>&nbsp;<span class="ident" id="1461930">nil</span>&nbsp;<span class="op" id="1461934">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461939">return</span>&nbsp;<span class="ident" id="1461946">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1461952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461956">q</span><span class="op" id="1461957">.</span><span class="ident" id="1461958">first</span>&nbsp;<span class="op" id="1461964">=</span>&nbsp;<span class="ident" id="1461966">sgp</span><span class="op" id="1461969">.</span><span class="ident" id="1461970">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461977">sgp</span><span class="op" id="1461980">.</span><span class="ident" id="1461981">next</span>&nbsp;<span class="op" id="1461986">=</span>&nbsp;<span class="ident" id="1461988">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461994">if</span>&nbsp;<span class="ident" id="1461997">q</span><span class="op" id="1461998">.</span><span class="ident" id="1461999">last</span>&nbsp;<span class="op" id="1462004">==</span>&nbsp;<span class="ident" id="1462007">sgp</span>&nbsp;<span class="op" id="1462011">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462016">q</span><span class="op" id="1462017">.</span><span class="ident" id="1462018">last</span>&nbsp;<span class="op" id="1462023">=</span>&nbsp;<span class="ident" id="1462025">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1462031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1462036">//&nbsp;if&nbsp;sgp&nbsp;participates&nbsp;in&nbsp;a&nbsp;select&nbsp;and&nbsp;is&nbsp;already&nbsp;signaled,&nbsp;ignore&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462108">if</span>&nbsp;<span class="ident" id="1462111">sgp</span><span class="op" id="1462114">.</span><span class="ident" id="1462115">selectdone</span>&nbsp;<span class="op" id="1462126">!=</span>&nbsp;<span class="ident" id="1462129">nil</span>&nbsp;<span class="op" id="1462133">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1462138">//&nbsp;claim&nbsp;the&nbsp;right&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462170">if</span>&nbsp;<span class="op" id="1462173">*</span><span class="ident" id="1462174">sgp</span><span class="op" id="1462177">.</span><span class="ident" id="1462178">selectdone</span>&nbsp;<span class="op" id="1462189">!=</span>&nbsp;<span class="num" id="1462192">0</span>&nbsp;<span class="op" id="1462194">||</span>&nbsp;<span class="op" id="1462197">!</span><span class="ident" id="1462198">cas</span><span class="op" id="1462201">(</span><span class="ident" id="1462202">sgp</span><span class="op" id="1462205">.</span><span class="ident" id="1462206">selectdone</span><span class="op" id="1462216">,</span>&nbsp;<span class="num" id="1462218">0</span><span class="op" id="1462219">,</span>&nbsp;<span class="num" id="1462221">1</span><span class="op" id="1462222">)</span>&nbsp;<span class="op" id="1462224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462230">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1462242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1462246">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462251">return</span>&nbsp;<span class="ident" id="1462258">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1462263">}</span><br>
<span class="lineno"></span><span class="op" id="1462265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="keyword" id="1462268">func</span>&nbsp;<span class="ident" id="1462273">racesync</span><span class="op" id="1462281">(</span><span class="ident" id="1462282">c</span>&nbsp;<span class="op" id="1462284">*</span><span class="ident" id="1462285">hchan</span><span class="op" id="1462290">,</span>&nbsp;<span class="ident" id="1462292">sg</span>&nbsp;<span class="op" id="1462295">*</span><span class="ident" id="1462296">sudog</span><span class="op" id="1462301">)</span>&nbsp;<span class="op" id="1462303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462306">racerelease</span><span class="op" id="1462317">(</span><span class="ident" id="1462318">chanbuf</span><span class="op" id="1462325">(</span><span class="ident" id="1462326">c</span><span class="op" id="1462327">,</span>&nbsp;<span class="num" id="1462329">0</span><span class="op" id="1462330">)</span><span class="op" id="1462331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462334">raceacquireg</span><span class="op" id="1462346">(</span><span class="ident" id="1462347">sg</span><span class="op" id="1462349">.</span><span class="ident" id="1462350">g</span><span class="op" id="1462351">,</span>&nbsp;<span class="ident" id="1462353">chanbuf</span><span class="op" id="1462360">(</span><span class="ident" id="1462361">c</span><span class="op" id="1462362">,</span>&nbsp;<span class="num" id="1462364">0</span><span class="op" id="1462365">)</span><span class="op" id="1462366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462369">racereleaseg</span><span class="op" id="1462381">(</span><span class="ident" id="1462382">sg</span><span class="op" id="1462384">.</span><span class="ident" id="1462385">g</span><span class="op" id="1462386">,</span>&nbsp;<span class="ident" id="1462388">chanbuf</span><span class="op" id="1462395">(</span><span class="ident" id="1462396">c</span><span class="op" id="1462397">,</span>&nbsp;<span class="num" id="1462399">0</span><span class="op" id="1462400">)</span><span class="op" id="1462401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462404">raceacquire</span><span class="op" id="1462415">(</span><span class="ident" id="1462416">chanbuf</span><span class="op" id="1462423">(</span><span class="ident" id="1462424">c</span><span class="op" id="1462425">,</span>&nbsp;<span class="num" id="1462427">0</span><span class="op" id="1462428">)</span><span class="op" id="1462429">)</span><br>
<span class="lineno">655</span><span class="op" id="1462431">}</span>
</div>
</body>
</html>
