<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3381664">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3381719">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3381773">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3381824">package</span>&nbsp;<span class="ident" id="3381832">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3381837">import</span>&nbsp;<span class="op" id="3381844">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3381847">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3381856">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3381866">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3381882">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3381896">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3381913">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3381928">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3381938">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3381945">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3381951">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3381958">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="3381968">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3381971">type</span>&nbsp;<span class="ident" id="3381976">clientHandshakeState</span>&nbsp;<span class="keyword" id="3381997">struct</span>&nbsp;<span class="op" id="3382004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382007">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3382020">*</span><span class="ident" id="3382021">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382027">serverHello</span>&nbsp;&nbsp;<span class="op" id="3382040">*</span><span class="ident" id="3382041">serverHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382057">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3382070">*</span><span class="ident" id="3382071">clientHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382087">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3382100">*</span><span class="ident" id="3382101">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382114">finishedHash</span>&nbsp;<span class="ident" id="3382127">finishedHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382141">masterSecret</span>&nbsp;<span class="op" id="3382154">[</span><span class="op" id="3382155">]</span><span class="builtintype" id="3382156">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382162">session</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3382175">*</span><span class="ident" id="3382176">ClientSessionState</span><br>
<span class="lineno"></span><span class="op" id="3382195">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3382198">func</span>&nbsp;<span class="op" id="3382203">(</span><span class="ident" id="3382204">c</span>&nbsp;<span class="op" id="3382206">*</span><span class="ident" id="3382207">Conn</span><span class="op" id="3382211">)</span>&nbsp;<span class="ident" id="3382213">clientHandshake</span><span class="op" id="3382228">(</span><span class="op" id="3382229">)</span>&nbsp;<span class="builtintype" id="3382231">error</span>&nbsp;<span class="op" id="3382237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382240">if</span>&nbsp;<span class="ident" id="3382243">c</span><span class="op" id="3382244">.</span><span class="ident" id="3382245">config</span>&nbsp;<span class="op" id="3382252">==</span>&nbsp;<span class="ident" id="3382255">nil</span>&nbsp;<span class="op" id="3382259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382263">c</span><span class="op" id="3382264">.</span><span class="ident" id="3382265">config</span>&nbsp;<span class="op" id="3382272">=</span>&nbsp;<span class="ident" id="3382274">defaultConfig</span><span class="op" id="3382287">(</span><span class="op" id="3382288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382291">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382295">if</span>&nbsp;<span class="builtinfunc" id="3382298">len</span><span class="op" id="3382301">(</span><span class="ident" id="3382302">c</span><span class="op" id="3382303">.</span><span class="ident" id="3382304">config</span><span class="op" id="3382310">.</span><span class="ident" id="3382311">ServerName</span><span class="op" id="3382321">)</span>&nbsp;<span class="op" id="3382323">==</span>&nbsp;<span class="num" id="3382326">0</span>&nbsp;<span class="op" id="3382328">&amp;&amp;</span>&nbsp;<span class="op" id="3382331">!</span><span class="ident" id="3382332">c</span><span class="op" id="3382333">.</span><span class="ident" id="3382334">config</span><span class="op" id="3382340">.</span><span class="ident" id="3382341">InsecureSkipVerify</span>&nbsp;<span class="op" id="3382360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382364">return</span>&nbsp;<span class="ident" id="3382371">errors</span><span class="op" id="3382377">.</span><span class="ident" id="3382378">New</span><span class="op" id="3382381">(</span><span class="string" id="3382382">&#34;tls:&nbsp;either&nbsp;ServerName&nbsp;or&nbsp;InsecureSkipVerify&nbsp;must&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;tls.Config&#34;</span><span class="op" id="3382464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382471">nextProtosLength</span>&nbsp;<span class="op" id="3382488">:=</span>&nbsp;<span class="num" id="3382491">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382494">for</span>&nbsp;<span class="ident" id="3382498">_</span><span class="op" id="3382499">,</span>&nbsp;<span class="ident" id="3382501">proto</span>&nbsp;<span class="op" id="3382507">:=</span>&nbsp;<span class="keyword" id="3382510">range</span>&nbsp;<span class="ident" id="3382516">c</span><span class="op" id="3382517">.</span><span class="ident" id="3382518">config</span><span class="op" id="3382524">.</span><span class="ident" id="3382525">NextProtos</span>&nbsp;<span class="op" id="3382536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382540">if</span>&nbsp;<span class="ident" id="3382543">l</span>&nbsp;<span class="op" id="3382545">:=</span>&nbsp;<span class="builtinfunc" id="3382548">len</span><span class="op" id="3382551">(</span><span class="ident" id="3382552">proto</span><span class="op" id="3382557">)</span><span class="op" id="3382558">;</span>&nbsp;<span class="ident" id="3382560">l</span>&nbsp;<span class="op" id="3382562">==</span>&nbsp;<span class="num" id="3382565">0</span>&nbsp;<span class="op" id="3382567">||</span>&nbsp;<span class="ident" id="3382570">l</span>&nbsp;<span class="op" id="3382572">&gt;</span>&nbsp;<span class="num" id="3382574">255</span>&nbsp;<span class="op" id="3382578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382583">return</span>&nbsp;<span class="ident" id="3382590">errors</span><span class="op" id="3382596">.</span><span class="ident" id="3382597">New</span><span class="op" id="3382600">(</span><span class="string" id="3382601">&#34;tls:&nbsp;invalid&nbsp;NextProtos&nbsp;value&#34;</span><span class="op" id="3382632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382636">}</span>&nbsp;<span class="keyword" id="3382638">else</span>&nbsp;<span class="op" id="3382643">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382648">nextProtosLength</span>&nbsp;<span class="op" id="3382665">+=</span>&nbsp;<span class="num" id="3382668">1</span>&nbsp;<span class="op" id="3382670">+</span>&nbsp;<span class="ident" id="3382672">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382682">if</span>&nbsp;<span class="ident" id="3382685">nextProtosLength</span>&nbsp;<span class="op" id="3382702">&gt;</span>&nbsp;<span class="num" id="3382704">0xffff</span>&nbsp;<span class="op" id="3382711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3382715">return</span>&nbsp;<span class="ident" id="3382722">errors</span><span class="op" id="3382728">.</span><span class="ident" id="3382729">New</span><span class="op" id="3382732">(</span><span class="string" id="3382733">&#34;tls:&nbsp;NextProtos&nbsp;values&nbsp;too&nbsp;large&#34;</span><span class="op" id="3382767">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3382770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382774">hello</span>&nbsp;<span class="op" id="3382780">:=</span>&nbsp;<span class="op" id="3382783">&amp;</span><span class="ident" id="3382784">clientHelloMsg</span><span class="op" id="3382798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382802">vers</span><span class="op" id="3382806">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3382823">c</span><span class="op" id="3382824">.</span><span class="ident" id="3382825">config</span><span class="op" id="3382831">.</span><span class="ident" id="3382832">maxVersion</span><span class="op" id="3382842">(</span><span class="op" id="3382843">)</span><span class="op" id="3382844">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382848">compressionMethods</span><span class="op" id="3382866">:</span>&nbsp;&nbsp;<span class="op" id="3382869">[</span><span class="op" id="3382870">]</span><span class="builtintype" id="3382871">uint8</span><span class="op" id="3382876">{</span><span class="ident" id="3382877">compressionNone</span><span class="op" id="3382892">}</span><span class="op" id="3382893">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382897">random</span><span class="op" id="3382903">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3382918">make</span><span class="op" id="3382922">(</span><span class="op" id="3382923">[</span><span class="op" id="3382924">]</span><span class="builtintype" id="3382925">byte</span><span class="op" id="3382929">,</span>&nbsp;<span class="num" id="3382931">32</span><span class="op" id="3382933">)</span><span class="op" id="3382934">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382938">ocspStapling</span><span class="op" id="3382950">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3382959">true</span><span class="op" id="3382963">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3382967">serverName</span><span class="op" id="3382977">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3382988">c</span><span class="op" id="3382989">.</span><span class="ident" id="3382990">config</span><span class="op" id="3382996">.</span><span class="ident" id="3382997">ServerName</span><span class="op" id="3383007">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383011">supportedCurves</span><span class="op" id="3383026">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3383032">c</span><span class="op" id="3383033">.</span><span class="ident" id="3383034">config</span><span class="op" id="3383040">.</span><span class="ident" id="3383041">curvePreferences</span><span class="op" id="3383057">(</span><span class="op" id="3383058">)</span><span class="op" id="3383059">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383063">supportedPoints</span><span class="op" id="3383078">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3383084">[</span><span class="op" id="3383085">]</span><span class="builtintype" id="3383086">uint8</span><span class="op" id="3383091">{</span><span class="ident" id="3383092">pointFormatUncompressed</span><span class="op" id="3383115">}</span><span class="op" id="3383116">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383120">nextProtoNeg</span><span class="op" id="3383132">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3383141">len</span><span class="op" id="3383144">(</span><span class="ident" id="3383145">c</span><span class="op" id="3383146">.</span><span class="ident" id="3383147">config</span><span class="op" id="3383153">.</span><span class="ident" id="3383154">NextProtos</span><span class="op" id="3383164">)</span>&nbsp;<span class="op" id="3383166">&gt;</span>&nbsp;<span class="num" id="3383168">0</span><span class="op" id="3383169">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383173">secureRenegotiation</span><span class="op" id="3383192">:</span>&nbsp;<span class="builtintype" id="3383194">true</span><span class="op" id="3383198">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383202">alpnProtocols</span><span class="op" id="3383215">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3383223">c</span><span class="op" id="3383224">.</span><span class="ident" id="3383225">config</span><span class="op" id="3383231">.</span><span class="ident" id="3383232">NextProtos</span><span class="op" id="3383242">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383249">possibleCipherSuites</span>&nbsp;<span class="op" id="3383270">:=</span>&nbsp;<span class="ident" id="3383273">c</span><span class="op" id="3383274">.</span><span class="ident" id="3383275">config</span><span class="op" id="3383281">.</span><span class="ident" id="3383282">cipherSuites</span><span class="op" id="3383294">(</span><span class="op" id="3383295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383298">hello</span><span class="op" id="3383303">.</span><span class="ident" id="3383304">cipherSuites</span>&nbsp;<span class="op" id="3383317">=</span>&nbsp;<span class="builtinfunc" id="3383319">make</span><span class="op" id="3383323">(</span><span class="op" id="3383324">[</span><span class="op" id="3383325">]</span><span class="builtintype" id="3383326">uint16</span><span class="op" id="3383332">,</span>&nbsp;<span class="num" id="3383334">0</span><span class="op" id="3383335">,</span>&nbsp;<span class="builtinfunc" id="3383337">len</span><span class="op" id="3383340">(</span><span class="ident" id="3383341">possibleCipherSuites</span><span class="op" id="3383361">)</span><span class="op" id="3383362">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="3383365">NextCipherSuite</span><span class="op" id="3383380">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383383">for</span>&nbsp;<span class="ident" id="3383387">_</span><span class="op" id="3383388">,</span>&nbsp;<span class="ident" id="3383390">suiteId</span>&nbsp;<span class="op" id="3383398">:=</span>&nbsp;<span class="keyword" id="3383401">range</span>&nbsp;<span class="ident" id="3383407">possibleCipherSuites</span>&nbsp;<span class="op" id="3383428">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383432">for</span>&nbsp;<span class="ident" id="3383436">_</span><span class="op" id="3383437">,</span>&nbsp;<span class="ident" id="3383439">suite</span>&nbsp;<span class="op" id="3383445">:=</span>&nbsp;<span class="keyword" id="3383448">range</span>&nbsp;<span class="ident" id="3383454">cipherSuites</span>&nbsp;<span class="op" id="3383467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383472">if</span>&nbsp;<span class="ident" id="3383475">suite</span><span class="op" id="3383480">.</span><span class="ident" id="3383481">id</span>&nbsp;<span class="op" id="3383484">!=</span>&nbsp;<span class="ident" id="3383487">suiteId</span>&nbsp;<span class="op" id="3383495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383501">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383518">//&nbsp;Don&#39;t&nbsp;advertise&nbsp;TLS&nbsp;1.2-only&nbsp;cipher&nbsp;suites&nbsp;unless</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3383574">//&nbsp;we&#39;re&nbsp;attempting&nbsp;TLS&nbsp;1.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383606">if</span>&nbsp;<span class="ident" id="3383609">hello</span><span class="op" id="3383614">.</span><span class="ident" id="3383615">vers</span>&nbsp;<span class="op" id="3383620">&lt;</span>&nbsp;<span class="ident" id="3383622">VersionTLS12</span>&nbsp;<span class="op" id="3383635">&amp;&amp;</span>&nbsp;<span class="ident" id="3383638">suite</span><span class="op" id="3383643">.</span><span class="ident" id="3383644">flags</span><span class="op" id="3383649">&amp;</span><span class="ident" id="3383650">suiteTLS12</span>&nbsp;<span class="op" id="3383661">!=</span>&nbsp;<span class="num" id="3383664">0</span>&nbsp;<span class="op" id="3383666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383672">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383689">hello</span><span class="op" id="3383694">.</span><span class="ident" id="3383695">cipherSuites</span>&nbsp;<span class="op" id="3383708">=</span>&nbsp;<span class="builtinfunc" id="3383710">append</span><span class="op" id="3383716">(</span><span class="ident" id="3383717">hello</span><span class="op" id="3383722">.</span><span class="ident" id="3383723">cipherSuites</span><span class="op" id="3383735">,</span>&nbsp;<span class="ident" id="3383737">suiteId</span><span class="op" id="3383744">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383749">continue</span>&nbsp;<span class="ident" id="3383758">NextCipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383783">_</span><span class="op" id="3383784">,</span>&nbsp;<span class="ident" id="3383786">err</span>&nbsp;<span class="op" id="3383790">:=</span>&nbsp;<span class="ident" id="3383793">io</span><span class="op" id="3383795">.</span><span class="ident" id="3383796">ReadFull</span><span class="op" id="3383804">(</span><span class="ident" id="3383805">c</span><span class="op" id="3383806">.</span><span class="ident" id="3383807">config</span><span class="op" id="3383813">.</span><span class="ident" id="3383814">rand</span><span class="op" id="3383818">(</span><span class="op" id="3383819">)</span><span class="op" id="3383820">,</span>&nbsp;<span class="ident" id="3383822">hello</span><span class="op" id="3383827">.</span><span class="ident" id="3383828">random</span><span class="op" id="3383834">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383837">if</span>&nbsp;<span class="ident" id="3383840">err</span>&nbsp;<span class="op" id="3383844">!=</span>&nbsp;<span class="ident" id="3383847">nil</span>&nbsp;<span class="op" id="3383851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383855">c</span><span class="op" id="3383856">.</span><span class="ident" id="3383857">sendAlert</span><span class="op" id="3383866">(</span><span class="ident" id="3383867">alertInternalError</span><span class="op" id="3383885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383889">return</span>&nbsp;<span class="ident" id="3383896">errors</span><span class="op" id="3383902">.</span><span class="ident" id="3383903">New</span><span class="op" id="3383906">(</span><span class="string" id="3383907">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="3383937">+</span>&nbsp;<span class="ident" id="3383939">err</span><span class="op" id="3383942">.</span><span class="ident" id="3383943">Error</span><span class="op" id="3383948">(</span><span class="op" id="3383949">)</span><span class="op" id="3383950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3383953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3383957">if</span>&nbsp;<span class="ident" id="3383960">hello</span><span class="op" id="3383965">.</span><span class="ident" id="3383966">vers</span>&nbsp;<span class="op" id="3383971">&gt;=</span>&nbsp;<span class="ident" id="3383974">VersionTLS12</span>&nbsp;<span class="op" id="3383987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3383991">hello</span><span class="op" id="3383996">.</span><span class="ident" id="3383997">signatureAndHashes</span>&nbsp;<span class="op" id="3384016">=</span>&nbsp;<span class="ident" id="3384018">supportedSKXSignatureAlgorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384055">var</span>&nbsp;<span class="ident" id="3384059">session</span>&nbsp;<span class="op" id="3384067">*</span><span class="ident" id="3384068">ClientSessionState</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384088">var</span>&nbsp;<span class="ident" id="3384092">cacheKey</span>&nbsp;<span class="builtintype" id="3384101">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384109">sessionCache</span>&nbsp;<span class="op" id="3384122">:=</span>&nbsp;<span class="ident" id="3384125">c</span><span class="op" id="3384126">.</span><span class="ident" id="3384127">config</span><span class="op" id="3384133">.</span><span class="ident" id="3384134">ClientSessionCache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384154">if</span>&nbsp;<span class="ident" id="3384157">c</span><span class="op" id="3384158">.</span><span class="ident" id="3384159">config</span><span class="op" id="3384165">.</span><span class="ident" id="3384166">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3384189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384193">sessionCache</span>&nbsp;<span class="op" id="3384206">=</span>&nbsp;<span class="ident" id="3384208">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384213">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384217">if</span>&nbsp;<span class="ident" id="3384220">sessionCache</span>&nbsp;<span class="op" id="3384233">!=</span>&nbsp;<span class="ident" id="3384236">nil</span>&nbsp;<span class="op" id="3384240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384244">hello</span><span class="op" id="3384249">.</span><span class="ident" id="3384250">ticketSupported</span>&nbsp;<span class="op" id="3384266">=</span>&nbsp;<span class="builtintype" id="3384268">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384276">//&nbsp;Try&nbsp;to&nbsp;resume&nbsp;a&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;session,&nbsp;if</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384335">//&nbsp;available.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384351">cacheKey</span>&nbsp;<span class="op" id="3384360">=</span>&nbsp;<span class="ident" id="3384362">clientSessionCacheKey</span><span class="op" id="3384383">(</span><span class="ident" id="3384384">c</span><span class="op" id="3384385">.</span><span class="ident" id="3384386">conn</span><span class="op" id="3384390">.</span><span class="ident" id="3384391">RemoteAddr</span><span class="op" id="3384401">(</span><span class="op" id="3384402">)</span><span class="op" id="3384403">,</span>&nbsp;<span class="ident" id="3384405">c</span><span class="op" id="3384406">.</span><span class="ident" id="3384407">config</span><span class="op" id="3384413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384417">candidateSession</span><span class="op" id="3384433">,</span>&nbsp;<span class="ident" id="3384435">ok</span>&nbsp;<span class="op" id="3384438">:=</span>&nbsp;<span class="ident" id="3384441">sessionCache</span><span class="op" id="3384453">.</span><span class="ident" id="3384454">Get</span><span class="op" id="3384457">(</span><span class="ident" id="3384458">cacheKey</span><span class="op" id="3384466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384470">if</span>&nbsp;<span class="ident" id="3384473">ok</span>&nbsp;<span class="op" id="3384476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384481">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;ciphersuite/version&nbsp;used&nbsp;for&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384535">//&nbsp;previous&nbsp;session&nbsp;are&nbsp;still&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384575">cipherSuiteOk</span>&nbsp;<span class="op" id="3384589">:=</span>&nbsp;<span class="builtintype" id="3384592">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384601">for</span>&nbsp;<span class="ident" id="3384605">_</span><span class="op" id="3384606">,</span>&nbsp;<span class="ident" id="3384608">id</span>&nbsp;<span class="op" id="3384611">:=</span>&nbsp;<span class="keyword" id="3384614">range</span>&nbsp;<span class="ident" id="3384620">hello</span><span class="op" id="3384625">.</span><span class="ident" id="3384626">cipherSuites</span>&nbsp;<span class="op" id="3384639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384645">if</span>&nbsp;<span class="ident" id="3384648">id</span>&nbsp;<span class="op" id="3384651">==</span>&nbsp;<span class="ident" id="3384654">candidateSession</span><span class="op" id="3384670">.</span><span class="ident" id="3384671">cipherSuite</span>&nbsp;<span class="op" id="3384683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384690">cipherSuiteOk</span>&nbsp;<span class="op" id="3384704">=</span>&nbsp;<span class="builtintype" id="3384706">true</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384716">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384737">versOk</span>&nbsp;<span class="op" id="3384744">:=</span>&nbsp;<span class="ident" id="3384747">candidateSession</span><span class="op" id="3384763">.</span><span class="ident" id="3384764">vers</span>&nbsp;<span class="op" id="3384769">&gt;=</span>&nbsp;<span class="ident" id="3384772">c</span><span class="op" id="3384773">.</span><span class="ident" id="3384774">config</span><span class="op" id="3384780">.</span><span class="ident" id="3384781">minVersion</span><span class="op" id="3384791">(</span><span class="op" id="3384792">)</span>&nbsp;<span class="op" id="3384794">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384801">candidateSession</span><span class="op" id="3384817">.</span><span class="ident" id="3384818">vers</span>&nbsp;<span class="op" id="3384823">&lt;=</span>&nbsp;<span class="ident" id="3384826">c</span><span class="op" id="3384827">.</span><span class="ident" id="3384828">config</span><span class="op" id="3384834">.</span><span class="ident" id="3384835">maxVersion</span><span class="op" id="3384845">(</span><span class="op" id="3384846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384851">if</span>&nbsp;<span class="ident" id="3384854">versOk</span>&nbsp;<span class="op" id="3384861">&amp;&amp;</span>&nbsp;<span class="ident" id="3384864">cipherSuiteOk</span>&nbsp;<span class="op" id="3384878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384884">session</span>&nbsp;<span class="op" id="3384892">=</span>&nbsp;<span class="ident" id="3384894">candidateSession</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384918">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3384921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3384925">if</span>&nbsp;<span class="ident" id="3384928">session</span>&nbsp;<span class="op" id="3384936">!=</span>&nbsp;<span class="ident" id="3384939">nil</span>&nbsp;<span class="op" id="3384943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3384947">hello</span><span class="op" id="3384952">.</span><span class="ident" id="3384953">sessionTicket</span>&nbsp;<span class="op" id="3384967">=</span>&nbsp;<span class="ident" id="3384969">session</span><span class="op" id="3384976">.</span><span class="ident" id="3384977">sessionTicket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3384993">//&nbsp;A&nbsp;random&nbsp;session&nbsp;ID&nbsp;is&nbsp;used&nbsp;to&nbsp;detect&nbsp;when&nbsp;the</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385045">//&nbsp;server&nbsp;accepted&nbsp;the&nbsp;ticket&nbsp;and&nbsp;is&nbsp;resuming&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385103">//&nbsp;(see&nbsp;RFC&nbsp;5077).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385124">hello</span><span class="op" id="3385129">.</span><span class="ident" id="3385130">sessionId</span>&nbsp;<span class="op" id="3385140">=</span>&nbsp;<span class="builtinfunc" id="3385142">make</span><span class="op" id="3385146">(</span><span class="op" id="3385147">[</span><span class="op" id="3385148">]</span><span class="builtintype" id="3385149">byte</span><span class="op" id="3385153">,</span>&nbsp;<span class="num" id="3385155">16</span><span class="op" id="3385157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385161">if</span>&nbsp;<span class="ident" id="3385164">_</span><span class="op" id="3385165">,</span>&nbsp;<span class="ident" id="3385167">err</span>&nbsp;<span class="op" id="3385171">:=</span>&nbsp;<span class="ident" id="3385174">io</span><span class="op" id="3385176">.</span><span class="ident" id="3385177">ReadFull</span><span class="op" id="3385185">(</span><span class="ident" id="3385186">c</span><span class="op" id="3385187">.</span><span class="ident" id="3385188">config</span><span class="op" id="3385194">.</span><span class="ident" id="3385195">rand</span><span class="op" id="3385199">(</span><span class="op" id="3385200">)</span><span class="op" id="3385201">,</span>&nbsp;<span class="ident" id="3385203">hello</span><span class="op" id="3385208">.</span><span class="ident" id="3385209">sessionId</span><span class="op" id="3385218">)</span><span class="op" id="3385219">;</span>&nbsp;<span class="ident" id="3385221">err</span>&nbsp;<span class="op" id="3385225">!=</span>&nbsp;<span class="ident" id="3385228">nil</span>&nbsp;<span class="op" id="3385232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385237">c</span><span class="op" id="3385238">.</span><span class="ident" id="3385239">sendAlert</span><span class="op" id="3385248">(</span><span class="ident" id="3385249">alertInternalError</span><span class="op" id="3385267">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385272">return</span>&nbsp;<span class="ident" id="3385279">errors</span><span class="op" id="3385285">.</span><span class="ident" id="3385286">New</span><span class="op" id="3385289">(</span><span class="string" id="3385290">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="3385320">+</span>&nbsp;<span class="ident" id="3385322">err</span><span class="op" id="3385325">.</span><span class="ident" id="3385326">Error</span><span class="op" id="3385331">(</span><span class="op" id="3385332">)</span><span class="op" id="3385333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385344">c</span><span class="op" id="3385345">.</span><span class="ident" id="3385346">writeRecord</span><span class="op" id="3385357">(</span><span class="ident" id="3385358">recordTypeHandshake</span><span class="op" id="3385377">,</span>&nbsp;<span class="ident" id="3385379">hello</span><span class="op" id="3385384">.</span><span class="ident" id="3385385">marshal</span><span class="op" id="3385392">(</span><span class="op" id="3385393">)</span><span class="op" id="3385394">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385398">msg</span><span class="op" id="3385401">,</span>&nbsp;<span class="ident" id="3385403">err</span>&nbsp;<span class="op" id="3385407">:=</span>&nbsp;<span class="ident" id="3385410">c</span><span class="op" id="3385411">.</span><span class="ident" id="3385412">readHandshake</span><span class="op" id="3385425">(</span><span class="op" id="3385426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385429">if</span>&nbsp;<span class="ident" id="3385432">err</span>&nbsp;<span class="op" id="3385436">!=</span>&nbsp;<span class="ident" id="3385439">nil</span>&nbsp;<span class="op" id="3385443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385447">return</span>&nbsp;<span class="ident" id="3385454">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385459">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385462">serverHello</span><span class="op" id="3385473">,</span>&nbsp;<span class="ident" id="3385475">ok</span>&nbsp;<span class="op" id="3385478">:=</span>&nbsp;<span class="ident" id="3385481">msg</span><span class="op" id="3385484">.</span><span class="op" id="3385485">(</span><span class="op" id="3385486">*</span><span class="ident" id="3385487">serverHelloMsg</span><span class="op" id="3385501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385504">if</span>&nbsp;<span class="op" id="3385507">!</span><span class="ident" id="3385508">ok</span>&nbsp;<span class="op" id="3385511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385515">c</span><span class="op" id="3385516">.</span><span class="ident" id="3385517">sendAlert</span><span class="op" id="3385526">(</span><span class="ident" id="3385527">alertUnexpectedMessage</span><span class="op" id="3385549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385553">return</span>&nbsp;<span class="ident" id="3385560">unexpectedMessageError</span><span class="op" id="3385582">(</span><span class="ident" id="3385583">serverHello</span><span class="op" id="3385594">,</span>&nbsp;<span class="ident" id="3385596">msg</span><span class="op" id="3385599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385602">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385606">vers</span><span class="op" id="3385610">,</span>&nbsp;<span class="ident" id="3385612">ok</span>&nbsp;<span class="op" id="3385615">:=</span>&nbsp;<span class="ident" id="3385618">c</span><span class="op" id="3385619">.</span><span class="ident" id="3385620">config</span><span class="op" id="3385626">.</span><span class="ident" id="3385627">mutualVersion</span><span class="op" id="3385640">(</span><span class="ident" id="3385641">serverHello</span><span class="op" id="3385652">.</span><span class="ident" id="3385653">vers</span><span class="op" id="3385657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385660">if</span>&nbsp;<span class="op" id="3385663">!</span><span class="ident" id="3385664">ok</span>&nbsp;<span class="op" id="3385667">||</span>&nbsp;<span class="ident" id="3385670">vers</span>&nbsp;<span class="op" id="3385675">&lt;</span>&nbsp;<span class="ident" id="3385677">VersionTLS10</span>&nbsp;<span class="op" id="3385690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3385694">//&nbsp;TLS&nbsp;1.0&nbsp;is&nbsp;the&nbsp;minimum&nbsp;version&nbsp;supported&nbsp;as&nbsp;a&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385753">c</span><span class="op" id="3385754">.</span><span class="ident" id="3385755">sendAlert</span><span class="op" id="3385764">(</span><span class="ident" id="3385765">alertProtocolVersion</span><span class="op" id="3385785">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385789">return</span>&nbsp;<span class="ident" id="3385796">fmt</span><span class="op" id="3385799">.</span><span class="ident" id="3385800">Errorf</span><span class="op" id="3385806">(</span><span class="string" id="3385807">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;protocol&nbsp;version&nbsp;%x&#34;</span><span class="op" id="3385861">,</span>&nbsp;<span class="ident" id="3385863">serverHello</span><span class="op" id="3385874">.</span><span class="ident" id="3385875">vers</span><span class="op" id="3385879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3385882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385885">c</span><span class="op" id="3385886">.</span><span class="ident" id="3385887">vers</span>&nbsp;<span class="op" id="3385892">=</span>&nbsp;<span class="ident" id="3385894">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385900">c</span><span class="op" id="3385901">.</span><span class="ident" id="3385902">haveVers</span>&nbsp;<span class="op" id="3385911">=</span>&nbsp;<span class="builtintype" id="3385913">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3385920">suite</span>&nbsp;<span class="op" id="3385926">:=</span>&nbsp;<span class="ident" id="3385929">mutualCipherSuite</span><span class="op" id="3385946">(</span><span class="ident" id="3385947">c</span><span class="op" id="3385948">.</span><span class="ident" id="3385949">config</span><span class="op" id="3385955">.</span><span class="ident" id="3385956">cipherSuites</span><span class="op" id="3385968">(</span><span class="op" id="3385969">)</span><span class="op" id="3385970">,</span>&nbsp;<span class="ident" id="3385972">serverHello</span><span class="op" id="3385983">.</span><span class="ident" id="3385984">cipherSuite</span><span class="op" id="3385995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3385998">if</span>&nbsp;<span class="ident" id="3386001">suite</span>&nbsp;<span class="op" id="3386007">==</span>&nbsp;<span class="ident" id="3386010">nil</span>&nbsp;<span class="op" id="3386014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386018">c</span><span class="op" id="3386019">.</span><span class="ident" id="3386020">sendAlert</span><span class="op" id="3386029">(</span><span class="ident" id="3386030">alertHandshakeFailure</span><span class="op" id="3386051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386055">return</span>&nbsp;<span class="ident" id="3386062">fmt</span><span class="op" id="3386065">.</span><span class="ident" id="3386066">Errorf</span><span class="op" id="3386072">(</span><span class="string" id="3386073">&#34;tls:&nbsp;server&nbsp;selected&nbsp;an&nbsp;unsupported&nbsp;cipher&nbsp;suite&#34;</span><span class="op" id="3386123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386126">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386130">hs</span>&nbsp;<span class="op" id="3386133">:=</span>&nbsp;<span class="op" id="3386136">&amp;</span><span class="ident" id="3386137">clientHandshakeState</span><span class="op" id="3386157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386161">c</span><span class="op" id="3386162">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3386175">c</span><span class="op" id="3386176">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386180">serverHello</span><span class="op" id="3386191">:</span>&nbsp;&nbsp;<span class="ident" id="3386194">serverHello</span><span class="op" id="3386205">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386209">hello</span><span class="op" id="3386214">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3386223">hello</span><span class="op" id="3386228">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386232">suite</span><span class="op" id="3386237">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3386246">suite</span><span class="op" id="3386251">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386255">finishedHash</span><span class="op" id="3386267">:</span>&nbsp;<span class="ident" id="3386269">newFinishedHash</span><span class="op" id="3386284">(</span><span class="ident" id="3386285">c</span><span class="op" id="3386286">.</span><span class="ident" id="3386287">vers</span><span class="op" id="3386291">)</span><span class="op" id="3386292">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386296">session</span><span class="op" id="3386303">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3386310">session</span><span class="op" id="3386317">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386324">hs</span><span class="op" id="3386326">.</span><span class="ident" id="3386327">finishedHash</span><span class="op" id="3386339">.</span><span class="ident" id="3386340">Write</span><span class="op" id="3386345">(</span><span class="ident" id="3386346">hs</span><span class="op" id="3386348">.</span><span class="ident" id="3386349">hello</span><span class="op" id="3386354">.</span><span class="ident" id="3386355">marshal</span><span class="op" id="3386362">(</span><span class="op" id="3386363">)</span><span class="op" id="3386364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386367">hs</span><span class="op" id="3386369">.</span><span class="ident" id="3386370">finishedHash</span><span class="op" id="3386382">.</span><span class="ident" id="3386383">Write</span><span class="op" id="3386388">(</span><span class="ident" id="3386389">hs</span><span class="op" id="3386391">.</span><span class="ident" id="3386392">serverHello</span><span class="op" id="3386403">.</span><span class="ident" id="3386404">marshal</span><span class="op" id="3386411">(</span><span class="op" id="3386412">)</span><span class="op" id="3386413">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3386417">isResume</span><span class="op" id="3386425">,</span>&nbsp;<span class="ident" id="3386427">err</span>&nbsp;<span class="op" id="3386431">:=</span>&nbsp;<span class="ident" id="3386434">hs</span><span class="op" id="3386436">.</span><span class="ident" id="3386437">processServerHello</span><span class="op" id="3386455">(</span><span class="op" id="3386456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386459">if</span>&nbsp;<span class="ident" id="3386462">err</span>&nbsp;<span class="op" id="3386466">!=</span>&nbsp;<span class="ident" id="3386469">nil</span>&nbsp;<span class="op" id="3386473">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386477">return</span>&nbsp;<span class="ident" id="3386484">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386493">if</span>&nbsp;<span class="ident" id="3386496">isResume</span>&nbsp;<span class="op" id="3386505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386509">if</span>&nbsp;<span class="ident" id="3386512">err</span>&nbsp;<span class="op" id="3386516">:=</span>&nbsp;<span class="ident" id="3386519">hs</span><span class="op" id="3386521">.</span><span class="ident" id="3386522">establishKeys</span><span class="op" id="3386535">(</span><span class="op" id="3386536">)</span><span class="op" id="3386537">;</span>&nbsp;<span class="ident" id="3386539">err</span>&nbsp;<span class="op" id="3386543">!=</span>&nbsp;<span class="ident" id="3386546">nil</span>&nbsp;<span class="op" id="3386550">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386555">return</span>&nbsp;<span class="ident" id="3386562">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386572">if</span>&nbsp;<span class="ident" id="3386575">err</span>&nbsp;<span class="op" id="3386579">:=</span>&nbsp;<span class="ident" id="3386582">hs</span><span class="op" id="3386584">.</span><span class="ident" id="3386585">readSessionTicket</span><span class="op" id="3386602">(</span><span class="op" id="3386603">)</span><span class="op" id="3386604">;</span>&nbsp;<span class="ident" id="3386606">err</span>&nbsp;<span class="op" id="3386610">!=</span>&nbsp;<span class="ident" id="3386613">nil</span>&nbsp;<span class="op" id="3386617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386622">return</span>&nbsp;<span class="ident" id="3386629">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386635">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386639">if</span>&nbsp;<span class="ident" id="3386642">err</span>&nbsp;<span class="op" id="3386646">:=</span>&nbsp;<span class="ident" id="3386649">hs</span><span class="op" id="3386651">.</span><span class="ident" id="3386652">readFinished</span><span class="op" id="3386664">(</span><span class="ident" id="3386665">c</span><span class="op" id="3386666">.</span><span class="ident" id="3386667">firstFinished</span><span class="op" id="3386680">[</span><span class="op" id="3386681">:</span><span class="op" id="3386682">]</span><span class="op" id="3386683">)</span><span class="op" id="3386684">;</span>&nbsp;<span class="ident" id="3386686">err</span>&nbsp;<span class="op" id="3386690">!=</span>&nbsp;<span class="ident" id="3386693">nil</span>&nbsp;<span class="op" id="3386697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386702">return</span>&nbsp;<span class="ident" id="3386709">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386719">if</span>&nbsp;<span class="ident" id="3386722">err</span>&nbsp;<span class="op" id="3386726">:=</span>&nbsp;<span class="ident" id="3386729">hs</span><span class="op" id="3386731">.</span><span class="ident" id="3386732">sendFinished</span><span class="op" id="3386744">(</span><span class="ident" id="3386745">nil</span><span class="op" id="3386748">)</span><span class="op" id="3386749">;</span>&nbsp;<span class="ident" id="3386751">err</span>&nbsp;<span class="op" id="3386755">!=</span>&nbsp;<span class="ident" id="3386758">nil</span>&nbsp;<span class="op" id="3386762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386767">return</span>&nbsp;<span class="ident" id="3386774">err</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386783">}</span>&nbsp;<span class="keyword" id="3386785">else</span>&nbsp;<span class="op" id="3386790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386794">if</span>&nbsp;<span class="ident" id="3386797">err</span>&nbsp;<span class="op" id="3386801">:=</span>&nbsp;<span class="ident" id="3386804">hs</span><span class="op" id="3386806">.</span><span class="ident" id="3386807">doFullHandshake</span><span class="op" id="3386822">(</span><span class="op" id="3386823">)</span><span class="op" id="3386824">;</span>&nbsp;<span class="ident" id="3386826">err</span>&nbsp;<span class="op" id="3386830">!=</span>&nbsp;<span class="ident" id="3386833">nil</span>&nbsp;<span class="op" id="3386837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386842">return</span>&nbsp;<span class="ident" id="3386849">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386855">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386859">if</span>&nbsp;<span class="ident" id="3386862">err</span>&nbsp;<span class="op" id="3386866">:=</span>&nbsp;<span class="ident" id="3386869">hs</span><span class="op" id="3386871">.</span><span class="ident" id="3386872">establishKeys</span><span class="op" id="3386885">(</span><span class="op" id="3386886">)</span><span class="op" id="3386887">;</span>&nbsp;<span class="ident" id="3386889">err</span>&nbsp;<span class="op" id="3386893">!=</span>&nbsp;<span class="ident" id="3386896">nil</span>&nbsp;<span class="op" id="3386900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386905">return</span>&nbsp;<span class="ident" id="3386912">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386922">if</span>&nbsp;<span class="ident" id="3386925">err</span>&nbsp;<span class="op" id="3386929">:=</span>&nbsp;<span class="ident" id="3386932">hs</span><span class="op" id="3386934">.</span><span class="ident" id="3386935">sendFinished</span><span class="op" id="3386947">(</span><span class="ident" id="3386948">c</span><span class="op" id="3386949">.</span><span class="ident" id="3386950">firstFinished</span><span class="op" id="3386963">[</span><span class="op" id="3386964">:</span><span class="op" id="3386965">]</span><span class="op" id="3386966">)</span><span class="op" id="3386967">;</span>&nbsp;<span class="ident" id="3386969">err</span>&nbsp;<span class="op" id="3386973">!=</span>&nbsp;<span class="ident" id="3386976">nil</span>&nbsp;<span class="op" id="3386980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3386985">return</span>&nbsp;<span class="ident" id="3386992">err</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3386998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387002">if</span>&nbsp;<span class="ident" id="3387005">err</span>&nbsp;<span class="op" id="3387009">:=</span>&nbsp;<span class="ident" id="3387012">hs</span><span class="op" id="3387014">.</span><span class="ident" id="3387015">readSessionTicket</span><span class="op" id="3387032">(</span><span class="op" id="3387033">)</span><span class="op" id="3387034">;</span>&nbsp;<span class="ident" id="3387036">err</span>&nbsp;<span class="op" id="3387040">!=</span>&nbsp;<span class="ident" id="3387043">nil</span>&nbsp;<span class="op" id="3387047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387052">return</span>&nbsp;<span class="ident" id="3387059">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387069">if</span>&nbsp;<span class="ident" id="3387072">err</span>&nbsp;<span class="op" id="3387076">:=</span>&nbsp;<span class="ident" id="3387079">hs</span><span class="op" id="3387081">.</span><span class="ident" id="3387082">readFinished</span><span class="op" id="3387094">(</span><span class="ident" id="3387095">nil</span><span class="op" id="3387098">)</span><span class="op" id="3387099">;</span>&nbsp;<span class="ident" id="3387101">err</span>&nbsp;<span class="op" id="3387105">!=</span>&nbsp;<span class="ident" id="3387108">nil</span>&nbsp;<span class="op" id="3387112">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387117">return</span>&nbsp;<span class="ident" id="3387124">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387137">if</span>&nbsp;<span class="ident" id="3387140">sessionCache</span>&nbsp;<span class="op" id="3387153">!=</span>&nbsp;<span class="ident" id="3387156">nil</span>&nbsp;<span class="op" id="3387160">&amp;&amp;</span>&nbsp;<span class="ident" id="3387163">hs</span><span class="op" id="3387165">.</span><span class="ident" id="3387166">session</span>&nbsp;<span class="op" id="3387174">!=</span>&nbsp;<span class="ident" id="3387177">nil</span>&nbsp;<span class="op" id="3387181">&amp;&amp;</span>&nbsp;<span class="ident" id="3387184">session</span>&nbsp;<span class="op" id="3387192">!=</span>&nbsp;<span class="ident" id="3387195">hs</span><span class="op" id="3387197">.</span><span class="ident" id="3387198">session</span>&nbsp;<span class="op" id="3387206">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387210">sessionCache</span><span class="op" id="3387222">.</span><span class="ident" id="3387223">Put</span><span class="op" id="3387226">(</span><span class="ident" id="3387227">cacheKey</span><span class="op" id="3387235">,</span>&nbsp;<span class="ident" id="3387237">hs</span><span class="op" id="3387239">.</span><span class="ident" id="3387240">session</span><span class="op" id="3387247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387254">c</span><span class="op" id="3387255">.</span><span class="ident" id="3387256">didResume</span>&nbsp;<span class="op" id="3387266">=</span>&nbsp;<span class="ident" id="3387268">isResume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387278">c</span><span class="op" id="3387279">.</span><span class="ident" id="3387280">handshakeComplete</span>&nbsp;<span class="op" id="3387298">=</span>&nbsp;<span class="builtintype" id="3387300">true</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387306">c</span><span class="op" id="3387307">.</span><span class="ident" id="3387308">cipherSuite</span>&nbsp;<span class="op" id="3387320">=</span>&nbsp;<span class="ident" id="3387322">suite</span><span class="op" id="3387327">.</span><span class="ident" id="3387328">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387332">return</span>&nbsp;<span class="ident" id="3387339">nil</span><br>
<span class="lineno"></span><span class="op" id="3387343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3387346">func</span>&nbsp;<span class="op" id="3387351">(</span><span class="ident" id="3387352">hs</span>&nbsp;<span class="op" id="3387355">*</span><span class="ident" id="3387356">clientHandshakeState</span><span class="op" id="3387376">)</span>&nbsp;<span class="ident" id="3387378">doFullHandshake</span><span class="op" id="3387393">(</span><span class="op" id="3387394">)</span>&nbsp;<span class="builtintype" id="3387396">error</span>&nbsp;<span class="op" id="3387402">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387405">c</span>&nbsp;<span class="op" id="3387407">:=</span>&nbsp;<span class="ident" id="3387410">hs</span><span class="op" id="3387412">.</span><span class="ident" id="3387413">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387417">msg</span><span class="op" id="3387420">,</span>&nbsp;<span class="ident" id="3387422">err</span>&nbsp;<span class="op" id="3387426">:=</span>&nbsp;<span class="ident" id="3387429">c</span><span class="op" id="3387430">.</span><span class="ident" id="3387431">readHandshake</span><span class="op" id="3387444">(</span><span class="op" id="3387445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387448">if</span>&nbsp;<span class="ident" id="3387451">err</span>&nbsp;<span class="op" id="3387455">!=</span>&nbsp;<span class="ident" id="3387458">nil</span>&nbsp;<span class="op" id="3387462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387466">return</span>&nbsp;<span class="ident" id="3387473">err</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387481">certMsg</span><span class="op" id="3387488">,</span>&nbsp;<span class="ident" id="3387490">ok</span>&nbsp;<span class="op" id="3387493">:=</span>&nbsp;<span class="ident" id="3387496">msg</span><span class="op" id="3387499">.</span><span class="op" id="3387500">(</span><span class="op" id="3387501">*</span><span class="ident" id="3387502">certificateMsg</span><span class="op" id="3387516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387519">if</span>&nbsp;<span class="op" id="3387522">!</span><span class="ident" id="3387523">ok</span>&nbsp;<span class="op" id="3387526">||</span>&nbsp;<span class="builtinfunc" id="3387529">len</span><span class="op" id="3387532">(</span><span class="ident" id="3387533">certMsg</span><span class="op" id="3387540">.</span><span class="ident" id="3387541">certificates</span><span class="op" id="3387553">)</span>&nbsp;<span class="op" id="3387555">==</span>&nbsp;<span class="num" id="3387558">0</span>&nbsp;<span class="op" id="3387560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387564">c</span><span class="op" id="3387565">.</span><span class="ident" id="3387566">sendAlert</span><span class="op" id="3387575">(</span><span class="ident" id="3387576">alertUnexpectedMessage</span><span class="op" id="3387598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387602">return</span>&nbsp;<span class="ident" id="3387609">unexpectedMessageError</span><span class="op" id="3387631">(</span><span class="ident" id="3387632">certMsg</span><span class="op" id="3387639">,</span>&nbsp;<span class="ident" id="3387641">msg</span><span class="op" id="3387644">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387650">hs</span><span class="op" id="3387652">.</span><span class="ident" id="3387653">finishedHash</span><span class="op" id="3387665">.</span><span class="ident" id="3387666">Write</span><span class="op" id="3387671">(</span><span class="ident" id="3387672">certMsg</span><span class="op" id="3387679">.</span><span class="ident" id="3387680">marshal</span><span class="op" id="3387687">(</span><span class="op" id="3387688">)</span><span class="op" id="3387689">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387693">certs</span>&nbsp;<span class="op" id="3387699">:=</span>&nbsp;<span class="builtinfunc" id="3387702">make</span><span class="op" id="3387706">(</span><span class="op" id="3387707">[</span><span class="op" id="3387708">]</span><span class="op" id="3387709">*</span><span class="ident" id="3387710">x509</span><span class="op" id="3387714">.</span><span class="ident" id="3387715">Certificate</span><span class="op" id="3387726">,</span>&nbsp;<span class="builtinfunc" id="3387728">len</span><span class="op" id="3387731">(</span><span class="ident" id="3387732">certMsg</span><span class="op" id="3387739">.</span><span class="ident" id="3387740">certificates</span><span class="op" id="3387752">)</span><span class="op" id="3387753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387756">for</span>&nbsp;<span class="ident" id="3387760">i</span><span class="op" id="3387761">,</span>&nbsp;<span class="ident" id="3387763">asn1Data</span>&nbsp;<span class="op" id="3387772">:=</span>&nbsp;<span class="keyword" id="3387775">range</span>&nbsp;<span class="ident" id="3387781">certMsg</span><span class="op" id="3387788">.</span><span class="ident" id="3387789">certificates</span>&nbsp;<span class="op" id="3387802">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387806">cert</span><span class="op" id="3387810">,</span>&nbsp;<span class="ident" id="3387812">err</span>&nbsp;<span class="op" id="3387816">:=</span>&nbsp;<span class="ident" id="3387819">x509</span><span class="op" id="3387823">.</span><span class="ident" id="3387824">ParseCertificate</span><span class="op" id="3387840">(</span><span class="ident" id="3387841">asn1Data</span><span class="op" id="3387849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387853">if</span>&nbsp;<span class="ident" id="3387856">err</span>&nbsp;<span class="op" id="3387860">!=</span>&nbsp;<span class="ident" id="3387863">nil</span>&nbsp;<span class="op" id="3387867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387872">c</span><span class="op" id="3387873">.</span><span class="ident" id="3387874">sendAlert</span><span class="op" id="3387883">(</span><span class="ident" id="3387884">alertBadCertificate</span><span class="op" id="3387903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3387908">return</span>&nbsp;<span class="ident" id="3387915">errors</span><span class="op" id="3387921">.</span><span class="ident" id="3387922">New</span><span class="op" id="3387925">(</span><span class="string" id="3387926">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;from&nbsp;server:&nbsp;&#34;</span>&nbsp;<span class="op" id="3387975">+</span>&nbsp;<span class="ident" id="3387977">err</span><span class="op" id="3387980">.</span><span class="ident" id="3387981">Error</span><span class="op" id="3387986">(</span><span class="op" id="3387987">)</span><span class="op" id="3387988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3387992">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3387996">certs</span><span class="op" id="3388001">[</span><span class="ident" id="3388002">i</span><span class="op" id="3388003">]</span>&nbsp;<span class="op" id="3388005">=</span>&nbsp;<span class="ident" id="3388007">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388017">if</span>&nbsp;<span class="op" id="3388020">!</span><span class="ident" id="3388021">c</span><span class="op" id="3388022">.</span><span class="ident" id="3388023">config</span><span class="op" id="3388029">.</span><span class="ident" id="3388030">InsecureSkipVerify</span>&nbsp;<span class="op" id="3388049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388053">opts</span>&nbsp;<span class="op" id="3388058">:=</span>&nbsp;<span class="ident" id="3388061">x509</span><span class="op" id="3388065">.</span><span class="ident" id="3388066">VerifyOptions</span><span class="op" id="3388079">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388084">Roots</span><span class="op" id="3388089">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3388099">c</span><span class="op" id="3388100">.</span><span class="ident" id="3388101">config</span><span class="op" id="3388107">.</span><span class="ident" id="3388108">RootCAs</span><span class="op" id="3388115">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388120">CurrentTime</span><span class="op" id="3388131">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3388135">c</span><span class="op" id="3388136">.</span><span class="ident" id="3388137">config</span><span class="op" id="3388143">.</span><span class="ident" id="3388144">time</span><span class="op" id="3388148">(</span><span class="op" id="3388149">)</span><span class="op" id="3388150">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388155">DNSName</span><span class="op" id="3388162">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3388170">c</span><span class="op" id="3388171">.</span><span class="ident" id="3388172">config</span><span class="op" id="3388178">.</span><span class="ident" id="3388179">ServerName</span><span class="op" id="3388189">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388194">Intermediates</span><span class="op" id="3388207">:</span>&nbsp;<span class="ident" id="3388209">x509</span><span class="op" id="3388213">.</span><span class="ident" id="3388214">NewCertPool</span><span class="op" id="3388225">(</span><span class="op" id="3388226">)</span><span class="op" id="3388227">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388231">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388236">for</span>&nbsp;<span class="ident" id="3388240">i</span><span class="op" id="3388241">,</span>&nbsp;<span class="ident" id="3388243">cert</span>&nbsp;<span class="op" id="3388248">:=</span>&nbsp;<span class="keyword" id="3388251">range</span>&nbsp;<span class="ident" id="3388257">certs</span>&nbsp;<span class="op" id="3388263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388268">if</span>&nbsp;<span class="ident" id="3388271">i</span>&nbsp;<span class="op" id="3388273">==</span>&nbsp;<span class="num" id="3388276">0</span>&nbsp;<span class="op" id="3388278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388284">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388296">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388301">opts</span><span class="op" id="3388305">.</span><span class="ident" id="3388306">Intermediates</span><span class="op" id="3388319">.</span><span class="ident" id="3388320">AddCert</span><span class="op" id="3388327">(</span><span class="ident" id="3388328">cert</span><span class="op" id="3388332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388340">c</span><span class="op" id="3388341">.</span><span class="ident" id="3388342">verifiedChains</span><span class="op" id="3388356">,</span>&nbsp;<span class="ident" id="3388358">err</span>&nbsp;<span class="op" id="3388362">=</span>&nbsp;<span class="ident" id="3388364">certs</span><span class="op" id="3388369">[</span><span class="num" id="3388370">0</span><span class="op" id="3388371">]</span><span class="op" id="3388372">.</span><span class="ident" id="3388373">Verify</span><span class="op" id="3388379">(</span><span class="ident" id="3388380">opts</span><span class="op" id="3388384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388388">if</span>&nbsp;<span class="ident" id="3388391">err</span>&nbsp;<span class="op" id="3388395">!=</span>&nbsp;<span class="ident" id="3388398">nil</span>&nbsp;<span class="op" id="3388402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388407">c</span><span class="op" id="3388408">.</span><span class="ident" id="3388409">sendAlert</span><span class="op" id="3388418">(</span><span class="ident" id="3388419">alertBadCertificate</span><span class="op" id="3388438">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388443">return</span>&nbsp;<span class="ident" id="3388450">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388463">switch</span>&nbsp;<span class="ident" id="3388470">certs</span><span class="op" id="3388475">[</span><span class="num" id="3388476">0</span><span class="op" id="3388477">]</span><span class="op" id="3388478">.</span><span class="ident" id="3388479">PublicKey</span><span class="op" id="3388488">.</span><span class="op" id="3388489">(</span><span class="keyword" id="3388490">type</span><span class="op" id="3388494">)</span>&nbsp;<span class="op" id="3388496">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388499">case</span>&nbsp;<span class="op" id="3388504">*</span><span class="ident" id="3388505">rsa</span><span class="op" id="3388508">.</span><span class="ident" id="3388509">PublicKey</span><span class="op" id="3388518">,</span>&nbsp;<span class="op" id="3388520">*</span><span class="ident" id="3388521">ecdsa</span><span class="op" id="3388526">.</span><span class="ident" id="3388527">PublicKey</span><span class="op" id="3388536">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388540">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388547">default</span><span class="op" id="3388554">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388558">c</span><span class="op" id="3388559">.</span><span class="ident" id="3388560">sendAlert</span><span class="op" id="3388569">(</span><span class="ident" id="3388570">alertUnsupportedCertificate</span><span class="op" id="3388597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388601">return</span>&nbsp;<span class="ident" id="3388608">fmt</span><span class="op" id="3388611">.</span><span class="ident" id="3388612">Errorf</span><span class="op" id="3388618">(</span><span class="string" id="3388619">&#34;tls:&nbsp;server&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;type&nbsp;of&nbsp;public&nbsp;key:&nbsp;%T&#34;</span><span class="op" id="3388693">,</span>&nbsp;<span class="ident" id="3388695">certs</span><span class="op" id="3388700">[</span><span class="num" id="3388701">0</span><span class="op" id="3388702">]</span><span class="op" id="3388703">.</span><span class="ident" id="3388704">PublicKey</span><span class="op" id="3388713">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388720">c</span><span class="op" id="3388721">.</span><span class="ident" id="3388722">peerCertificates</span>&nbsp;<span class="op" id="3388739">=</span>&nbsp;<span class="ident" id="3388741">certs</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388749">if</span>&nbsp;<span class="ident" id="3388752">hs</span><span class="op" id="3388754">.</span><span class="ident" id="3388755">serverHello</span><span class="op" id="3388766">.</span><span class="ident" id="3388767">ocspStapling</span>&nbsp;<span class="op" id="3388780">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388784">msg</span><span class="op" id="3388787">,</span>&nbsp;<span class="ident" id="3388789">err</span>&nbsp;<span class="op" id="3388793">=</span>&nbsp;<span class="ident" id="3388795">c</span><span class="op" id="3388796">.</span><span class="ident" id="3388797">readHandshake</span><span class="op" id="3388810">(</span><span class="op" id="3388811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388815">if</span>&nbsp;<span class="ident" id="3388818">err</span>&nbsp;<span class="op" id="3388822">!=</span>&nbsp;<span class="ident" id="3388825">nil</span>&nbsp;<span class="op" id="3388829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388834">return</span>&nbsp;<span class="ident" id="3388841">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388851">cs</span><span class="op" id="3388853">,</span>&nbsp;<span class="ident" id="3388855">ok</span>&nbsp;<span class="op" id="3388858">:=</span>&nbsp;<span class="ident" id="3388861">msg</span><span class="op" id="3388864">.</span><span class="op" id="3388865">(</span><span class="op" id="3388866">*</span><span class="ident" id="3388867">certificateStatusMsg</span><span class="op" id="3388887">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388891">if</span>&nbsp;<span class="op" id="3388894">!</span><span class="ident" id="3388895">ok</span>&nbsp;<span class="op" id="3388898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388903">c</span><span class="op" id="3388904">.</span><span class="ident" id="3388905">sendAlert</span><span class="op" id="3388914">(</span><span class="ident" id="3388915">alertUnexpectedMessage</span><span class="op" id="3388937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3388942">return</span>&nbsp;<span class="ident" id="3388949">unexpectedMessageError</span><span class="op" id="3388971">(</span><span class="ident" id="3388972">cs</span><span class="op" id="3388974">,</span>&nbsp;<span class="ident" id="3388976">msg</span><span class="op" id="3388979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3388983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3388987">hs</span><span class="op" id="3388989">.</span><span class="ident" id="3388990">finishedHash</span><span class="op" id="3389002">.</span><span class="ident" id="3389003">Write</span><span class="op" id="3389008">(</span><span class="ident" id="3389009">cs</span><span class="op" id="3389011">.</span><span class="ident" id="3389012">marshal</span><span class="op" id="3389019">(</span><span class="op" id="3389020">)</span><span class="op" id="3389021">)</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389026">if</span>&nbsp;<span class="ident" id="3389029">cs</span><span class="op" id="3389031">.</span><span class="ident" id="3389032">statusType</span>&nbsp;<span class="op" id="3389043">==</span>&nbsp;<span class="ident" id="3389046">statusTypeOCSP</span>&nbsp;<span class="op" id="3389061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389066">c</span><span class="op" id="3389067">.</span><span class="ident" id="3389068">ocspResponse</span>&nbsp;<span class="op" id="3389081">=</span>&nbsp;<span class="ident" id="3389083">cs</span><span class="op" id="3389085">.</span><span class="ident" id="3389086">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389100">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389104">msg</span><span class="op" id="3389107">,</span>&nbsp;<span class="ident" id="3389109">err</span>&nbsp;<span class="op" id="3389113">=</span>&nbsp;<span class="ident" id="3389115">c</span><span class="op" id="3389116">.</span><span class="ident" id="3389117">readHandshake</span><span class="op" id="3389130">(</span><span class="op" id="3389131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389134">if</span>&nbsp;<span class="ident" id="3389137">err</span>&nbsp;<span class="op" id="3389141">!=</span>&nbsp;<span class="ident" id="3389144">nil</span>&nbsp;<span class="op" id="3389148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389152">return</span>&nbsp;<span class="ident" id="3389159">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389164">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389168">keyAgreement</span>&nbsp;<span class="op" id="3389181">:=</span>&nbsp;<span class="ident" id="3389184">hs</span><span class="op" id="3389186">.</span><span class="ident" id="3389187">suite</span><span class="op" id="3389192">.</span><span class="ident" id="3389193">ka</span><span class="op" id="3389195">(</span><span class="ident" id="3389196">c</span><span class="op" id="3389197">.</span><span class="ident" id="3389198">vers</span><span class="op" id="3389202">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389206">skx</span><span class="op" id="3389209">,</span>&nbsp;<span class="ident" id="3389211">ok</span>&nbsp;<span class="op" id="3389214">:=</span>&nbsp;<span class="ident" id="3389217">msg</span><span class="op" id="3389220">.</span><span class="op" id="3389221">(</span><span class="op" id="3389222">*</span><span class="ident" id="3389223">serverKeyExchangeMsg</span><span class="op" id="3389243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389246">if</span>&nbsp;<span class="ident" id="3389249">ok</span>&nbsp;<span class="op" id="3389252">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389256">hs</span><span class="op" id="3389258">.</span><span class="ident" id="3389259">finishedHash</span><span class="op" id="3389271">.</span><span class="ident" id="3389272">Write</span><span class="op" id="3389277">(</span><span class="ident" id="3389278">skx</span><span class="op" id="3389281">.</span><span class="ident" id="3389282">marshal</span><span class="op" id="3389289">(</span><span class="op" id="3389290">)</span><span class="op" id="3389291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389295">err</span>&nbsp;<span class="op" id="3389299">=</span>&nbsp;<span class="ident" id="3389301">keyAgreement</span><span class="op" id="3389313">.</span><span class="ident" id="3389314">processServerKeyExchange</span><span class="op" id="3389338">(</span><span class="ident" id="3389339">c</span><span class="op" id="3389340">.</span><span class="ident" id="3389341">config</span><span class="op" id="3389347">,</span>&nbsp;<span class="ident" id="3389349">hs</span><span class="op" id="3389351">.</span><span class="ident" id="3389352">hello</span><span class="op" id="3389357">,</span>&nbsp;<span class="ident" id="3389359">hs</span><span class="op" id="3389361">.</span><span class="ident" id="3389362">serverHello</span><span class="op" id="3389373">,</span>&nbsp;<span class="ident" id="3389375">certs</span><span class="op" id="3389380">[</span><span class="num" id="3389381">0</span><span class="op" id="3389382">]</span><span class="op" id="3389383">,</span>&nbsp;<span class="ident" id="3389385">skx</span><span class="op" id="3389388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389392">if</span>&nbsp;<span class="ident" id="3389395">err</span>&nbsp;<span class="op" id="3389399">!=</span>&nbsp;<span class="ident" id="3389402">nil</span>&nbsp;<span class="op" id="3389406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389411">c</span><span class="op" id="3389412">.</span><span class="ident" id="3389413">sendAlert</span><span class="op" id="3389422">(</span><span class="ident" id="3389423">alertUnexpectedMessage</span><span class="op" id="3389445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389450">return</span>&nbsp;<span class="ident" id="3389457">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389468">msg</span><span class="op" id="3389471">,</span>&nbsp;<span class="ident" id="3389473">err</span>&nbsp;<span class="op" id="3389477">=</span>&nbsp;<span class="ident" id="3389479">c</span><span class="op" id="3389480">.</span><span class="ident" id="3389481">readHandshake</span><span class="op" id="3389494">(</span><span class="op" id="3389495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389499">if</span>&nbsp;<span class="ident" id="3389502">err</span>&nbsp;<span class="op" id="3389506">!=</span>&nbsp;<span class="ident" id="3389509">nil</span>&nbsp;<span class="op" id="3389513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389518">return</span>&nbsp;<span class="ident" id="3389525">err</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3389534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389538">var</span>&nbsp;<span class="ident" id="3389542">chainToSend</span>&nbsp;<span class="op" id="3389554">*</span><span class="ident" id="3389555">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389568">var</span>&nbsp;<span class="ident" id="3389572">certRequested</span>&nbsp;<span class="builtintype" id="3389586">bool</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389592">certReq</span><span class="op" id="3389599">,</span>&nbsp;<span class="ident" id="3389601">ok</span>&nbsp;<span class="op" id="3389604">:=</span>&nbsp;<span class="ident" id="3389607">msg</span><span class="op" id="3389610">.</span><span class="op" id="3389611">(</span><span class="op" id="3389612">*</span><span class="ident" id="3389613">certificateRequestMsg</span><span class="op" id="3389634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3389637">if</span>&nbsp;<span class="ident" id="3389640">ok</span>&nbsp;<span class="op" id="3389643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3389647">certRequested</span>&nbsp;<span class="op" id="3389661">=</span>&nbsp;<span class="builtintype" id="3389663">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3389671">//&nbsp;RFC&nbsp;4346&nbsp;on&nbsp;the&nbsp;certificateAuthorities&nbsp;field:</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3389722">//&nbsp;A&nbsp;list&nbsp;of&nbsp;the&nbsp;distinguished&nbsp;names&nbsp;of&nbsp;acceptable&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3389787">//&nbsp;authorities.&nbsp;These&nbsp;distinguished&nbsp;names&nbsp;may&nbsp;specify&nbsp;a&nbsp;desired</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3389853">//&nbsp;distinguished&nbsp;name&nbsp;for&nbsp;a&nbsp;root&nbsp;CA&nbsp;or&nbsp;for&nbsp;a&nbsp;subordinate&nbsp;CA;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3389916">//&nbsp;thus,&nbsp;this&nbsp;message&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;describe&nbsp;both&nbsp;known&nbsp;roots</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3389981">//&nbsp;and&nbsp;a&nbsp;desired&nbsp;authorization&nbsp;space.&nbsp;If&nbsp;the</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3390028">//&nbsp;certificate_authorities&nbsp;list&nbsp;is&nbsp;empty&nbsp;then&nbsp;the&nbsp;client&nbsp;MAY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3390091">//&nbsp;send&nbsp;any&nbsp;certificate&nbsp;of&nbsp;the&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3390136">//&nbsp;ClientCertificateType,&nbsp;unless&nbsp;there&nbsp;is&nbsp;some&nbsp;external</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3390194">//&nbsp;arrangement&nbsp;to&nbsp;the&nbsp;contrary.</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390229">hs</span><span class="op" id="3390231">.</span><span class="ident" id="3390232">finishedHash</span><span class="op" id="3390244">.</span><span class="ident" id="3390245">Write</span><span class="op" id="3390250">(</span><span class="ident" id="3390251">certReq</span><span class="op" id="3390258">.</span><span class="ident" id="3390259">marshal</span><span class="op" id="3390266">(</span><span class="op" id="3390267">)</span><span class="op" id="3390268">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390273">var</span>&nbsp;<span class="ident" id="3390277">rsaAvail</span><span class="op" id="3390285">,</span>&nbsp;<span class="ident" id="3390287">ecdsaAvail</span>&nbsp;<span class="builtintype" id="3390298">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390305">for</span>&nbsp;<span class="ident" id="3390309">_</span><span class="op" id="3390310">,</span>&nbsp;<span class="ident" id="3390312">certType</span>&nbsp;<span class="op" id="3390321">:=</span>&nbsp;<span class="keyword" id="3390324">range</span>&nbsp;<span class="ident" id="3390330">certReq</span><span class="op" id="3390337">.</span><span class="ident" id="3390338">certificateTypes</span>&nbsp;<span class="op" id="3390355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390360">switch</span>&nbsp;<span class="ident" id="3390367">certType</span>&nbsp;<span class="op" id="3390376">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390381">case</span>&nbsp;<span class="ident" id="3390386">certTypeRSASign</span><span class="op" id="3390401">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390407">rsaAvail</span>&nbsp;<span class="op" id="3390416">=</span>&nbsp;<span class="builtintype" id="3390418">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390426">case</span>&nbsp;<span class="ident" id="3390431">certTypeECDSASign</span><span class="op" id="3390448">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390454">ecdsaAvail</span>&nbsp;<span class="op" id="3390465">=</span>&nbsp;<span class="builtintype" id="3390467">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3390475">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3390479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3390484">//&nbsp;We&nbsp;need&nbsp;to&nbsp;search&nbsp;our&nbsp;list&nbsp;of&nbsp;client&nbsp;certs&nbsp;for&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3390540">//&nbsp;where&nbsp;SignatureAlgorithm&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3390606">//&nbsp;Issuer&nbsp;is&nbsp;in&nbsp;certReq.certificateAuthorities</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390654">findCert</span><span class="op" id="3390662">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390666">for</span>&nbsp;<span class="ident" id="3390670">i</span><span class="op" id="3390671">,</span>&nbsp;<span class="ident" id="3390673">chain</span>&nbsp;<span class="op" id="3390679">:=</span>&nbsp;<span class="keyword" id="3390682">range</span>&nbsp;<span class="ident" id="3390688">c</span><span class="op" id="3390689">.</span><span class="ident" id="3390690">config</span><span class="op" id="3390696">.</span><span class="ident" id="3390697">Certificates</span>&nbsp;<span class="op" id="3390710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390715">if</span>&nbsp;<span class="op" id="3390718">!</span><span class="ident" id="3390719">rsaAvail</span>&nbsp;<span class="op" id="3390728">&amp;&amp;</span>&nbsp;<span class="op" id="3390731">!</span><span class="ident" id="3390732">ecdsaAvail</span>&nbsp;<span class="op" id="3390743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390749">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3390761">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390767">for</span>&nbsp;<span class="ident" id="3390771">j</span><span class="op" id="3390772">,</span>&nbsp;<span class="ident" id="3390774">cert</span>&nbsp;<span class="op" id="3390779">:=</span>&nbsp;<span class="keyword" id="3390782">range</span>&nbsp;<span class="ident" id="3390788">chain</span><span class="op" id="3390793">.</span><span class="ident" id="3390794">Certificate</span>&nbsp;<span class="op" id="3390806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3390812">x509Cert</span>&nbsp;<span class="op" id="3390821">:=</span>&nbsp;<span class="ident" id="3390824">chain</span><span class="op" id="3390829">.</span><span class="ident" id="3390830">Leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3390839">//&nbsp;parse&nbsp;the&nbsp;certificate&nbsp;if&nbsp;this&nbsp;isn&#39;t&nbsp;the&nbsp;leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3390891">//&nbsp;node,&nbsp;or&nbsp;if&nbsp;chain.Leaf&nbsp;was&nbsp;nil</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390929">if</span>&nbsp;<span class="ident" id="3390932">j</span>&nbsp;<span class="op" id="3390934">!=</span>&nbsp;<span class="num" id="3390937">0</span>&nbsp;<span class="op" id="3390939">||</span>&nbsp;<span class="ident" id="3390942">x509Cert</span>&nbsp;<span class="op" id="3390951">==</span>&nbsp;<span class="ident" id="3390954">nil</span>&nbsp;<span class="op" id="3390958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3390965">if</span>&nbsp;<span class="ident" id="3390968">x509Cert</span><span class="op" id="3390976">,</span>&nbsp;<span class="ident" id="3390978">err</span>&nbsp;<span class="op" id="3390982">=</span>&nbsp;<span class="ident" id="3390984">x509</span><span class="op" id="3390988">.</span><span class="ident" id="3390989">ParseCertificate</span><span class="op" id="3391005">(</span><span class="ident" id="3391006">cert</span><span class="op" id="3391010">)</span><span class="op" id="3391011">;</span>&nbsp;<span class="ident" id="3391013">err</span>&nbsp;<span class="op" id="3391017">!=</span>&nbsp;<span class="ident" id="3391020">nil</span>&nbsp;<span class="op" id="3391024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3391032">c</span><span class="op" id="3391033">.</span><span class="ident" id="3391034">sendAlert</span><span class="op" id="3391043">(</span><span class="ident" id="3391044">alertInternalError</span><span class="op" id="3391062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391070">return</span>&nbsp;<span class="ident" id="3391077">errors</span><span class="op" id="3391083">.</span><span class="ident" id="3391084">New</span><span class="op" id="3391087">(</span><span class="string" id="3391088">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate&nbsp;#&#34;</span>&nbsp;<span class="op" id="3391132">+</span>&nbsp;<span class="ident" id="3391134">strconv</span><span class="op" id="3391141">.</span><span class="ident" id="3391142">Itoa</span><span class="op" id="3391146">(</span><span class="ident" id="3391147">i</span><span class="op" id="3391148">)</span>&nbsp;<span class="op" id="3391150">+</span>&nbsp;<span class="string" id="3391152">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="3391157">+</span>&nbsp;<span class="ident" id="3391159">err</span><span class="op" id="3391162">.</span><span class="ident" id="3391163">Error</span><span class="op" id="3391168">(</span><span class="op" id="3391169">)</span><span class="op" id="3391170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391177">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391190">switch</span>&nbsp;<span class="op" id="3391197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391203">case</span>&nbsp;<span class="ident" id="3391208">rsaAvail</span>&nbsp;<span class="op" id="3391217">&amp;&amp;</span>&nbsp;<span class="ident" id="3391220">x509Cert</span><span class="op" id="3391228">.</span><span class="ident" id="3391229">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="3391248">==</span>&nbsp;<span class="ident" id="3391251">x509</span><span class="op" id="3391255">.</span><span class="ident" id="3391256">RSA</span><span class="op" id="3391259">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391265">case</span>&nbsp;<span class="ident" id="3391270">ecdsaAvail</span>&nbsp;<span class="op" id="3391281">&amp;&amp;</span>&nbsp;<span class="ident" id="3391284">x509Cert</span><span class="op" id="3391292">.</span><span class="ident" id="3391293">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="3391312">==</span>&nbsp;<span class="ident" id="3391315">x509</span><span class="op" id="3391319">.</span><span class="ident" id="3391320">ECDSA</span><span class="op" id="3391325">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391331">default</span><span class="op" id="3391338">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391345">continue</span>&nbsp;<span class="ident" id="3391354">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391374">if</span>&nbsp;<span class="builtinfunc" id="3391377">len</span><span class="op" id="3391380">(</span><span class="ident" id="3391381">certReq</span><span class="op" id="3391388">.</span><span class="ident" id="3391389">certificateAuthorities</span><span class="op" id="3391411">)</span>&nbsp;<span class="op" id="3391413">==</span>&nbsp;<span class="num" id="3391416">0</span>&nbsp;<span class="op" id="3391418">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3391425">//&nbsp;they&nbsp;gave&nbsp;us&nbsp;an&nbsp;empty&nbsp;list,&nbsp;so&nbsp;just&nbsp;take&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3391478">//&nbsp;first&nbsp;cert&nbsp;from&nbsp;c.config.Certificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3391524">chainToSend</span>&nbsp;<span class="op" id="3391536">=</span>&nbsp;<span class="op" id="3391538">&amp;</span><span class="ident" id="3391539">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391550">break</span>&nbsp;<span class="ident" id="3391556">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391569">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391576">for</span>&nbsp;<span class="ident" id="3391580">_</span><span class="op" id="3391581">,</span>&nbsp;<span class="ident" id="3391583">ca</span>&nbsp;<span class="op" id="3391586">:=</span>&nbsp;<span class="keyword" id="3391589">range</span>&nbsp;<span class="ident" id="3391595">certReq</span><span class="op" id="3391602">.</span><span class="ident" id="3391603">certificateAuthorities</span>&nbsp;<span class="op" id="3391626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391633">if</span>&nbsp;<span class="ident" id="3391636">bytes</span><span class="op" id="3391641">.</span><span class="ident" id="3391642">Equal</span><span class="op" id="3391647">(</span><span class="ident" id="3391648">x509Cert</span><span class="op" id="3391656">.</span><span class="ident" id="3391657">RawIssuer</span><span class="op" id="3391666">,</span>&nbsp;<span class="ident" id="3391668">ca</span><span class="op" id="3391670">)</span>&nbsp;<span class="op" id="3391672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3391680">chainToSend</span>&nbsp;<span class="op" id="3391692">=</span>&nbsp;<span class="op" id="3391694">&amp;</span><span class="ident" id="3391695">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391707">break</span>&nbsp;<span class="ident" id="3391713">findCert</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3391747">msg</span><span class="op" id="3391750">,</span>&nbsp;<span class="ident" id="3391752">err</span>&nbsp;<span class="op" id="3391756">=</span>&nbsp;<span class="ident" id="3391758">c</span><span class="op" id="3391759">.</span><span class="ident" id="3391760">readHandshake</span><span class="op" id="3391773">(</span><span class="op" id="3391774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391778">if</span>&nbsp;<span class="ident" id="3391781">err</span>&nbsp;<span class="op" id="3391785">!=</span>&nbsp;<span class="ident" id="3391788">nil</span>&nbsp;<span class="op" id="3391792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391797">return</span>&nbsp;<span class="ident" id="3391804">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391813">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3391817">shd</span><span class="op" id="3391820">,</span>&nbsp;<span class="ident" id="3391822">ok</span>&nbsp;<span class="op" id="3391825">:=</span>&nbsp;<span class="ident" id="3391828">msg</span><span class="op" id="3391831">.</span><span class="op" id="3391832">(</span><span class="op" id="3391833">*</span><span class="ident" id="3391834">serverHelloDoneMsg</span><span class="op" id="3391852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391855">if</span>&nbsp;<span class="op" id="3391858">!</span><span class="ident" id="3391859">ok</span>&nbsp;<span class="op" id="3391862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3391866">c</span><span class="op" id="3391867">.</span><span class="ident" id="3391868">sendAlert</span><span class="op" id="3391877">(</span><span class="ident" id="3391878">alertUnexpectedMessage</span><span class="op" id="3391900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3391904">return</span>&nbsp;<span class="ident" id="3391911">unexpectedMessageError</span><span class="op" id="3391933">(</span><span class="ident" id="3391934">shd</span><span class="op" id="3391937">,</span>&nbsp;<span class="ident" id="3391939">msg</span><span class="op" id="3391942">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3391945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3391948">hs</span><span class="op" id="3391950">.</span><span class="ident" id="3391951">finishedHash</span><span class="op" id="3391963">.</span><span class="ident" id="3391964">Write</span><span class="op" id="3391969">(</span><span class="ident" id="3391970">shd</span><span class="op" id="3391973">.</span><span class="ident" id="3391974">marshal</span><span class="op" id="3391981">(</span><span class="op" id="3391982">)</span><span class="op" id="3391983">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3391987">//&nbsp;If&nbsp;the&nbsp;server&nbsp;requested&nbsp;a&nbsp;certificate&nbsp;then&nbsp;we&nbsp;have&nbsp;to&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3392052">//&nbsp;Certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3392120">//&nbsp;certificate&nbsp;to&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392145">if</span>&nbsp;<span class="ident" id="3392148">certRequested</span>&nbsp;<span class="op" id="3392162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392166">certMsg</span>&nbsp;<span class="op" id="3392174">=</span>&nbsp;<span class="builtinfunc" id="3392176">new</span><span class="op" id="3392179">(</span><span class="ident" id="3392180">certificateMsg</span><span class="op" id="3392194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392198">if</span>&nbsp;<span class="ident" id="3392201">chainToSend</span>&nbsp;<span class="op" id="3392213">!=</span>&nbsp;<span class="ident" id="3392216">nil</span>&nbsp;<span class="op" id="3392220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392225">certMsg</span><span class="op" id="3392232">.</span><span class="ident" id="3392233">certificates</span>&nbsp;<span class="op" id="3392246">=</span>&nbsp;<span class="ident" id="3392248">chainToSend</span><span class="op" id="3392259">.</span><span class="ident" id="3392260">Certificate</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3392274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392278">hs</span><span class="op" id="3392280">.</span><span class="ident" id="3392281">finishedHash</span><span class="op" id="3392293">.</span><span class="ident" id="3392294">Write</span><span class="op" id="3392299">(</span><span class="ident" id="3392300">certMsg</span><span class="op" id="3392307">.</span><span class="ident" id="3392308">marshal</span><span class="op" id="3392315">(</span><span class="op" id="3392316">)</span><span class="op" id="3392317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392321">c</span><span class="op" id="3392322">.</span><span class="ident" id="3392323">writeRecord</span><span class="op" id="3392334">(</span><span class="ident" id="3392335">recordTypeHandshake</span><span class="op" id="3392354">,</span>&nbsp;<span class="ident" id="3392356">certMsg</span><span class="op" id="3392363">.</span><span class="ident" id="3392364">marshal</span><span class="op" id="3392371">(</span><span class="op" id="3392372">)</span><span class="op" id="3392373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3392376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392380">preMasterSecret</span><span class="op" id="3392395">,</span>&nbsp;<span class="ident" id="3392397">ckx</span><span class="op" id="3392400">,</span>&nbsp;<span class="ident" id="3392402">err</span>&nbsp;<span class="op" id="3392406">:=</span>&nbsp;<span class="ident" id="3392409">keyAgreement</span><span class="op" id="3392421">.</span><span class="ident" id="3392422">generateClientKeyExchange</span><span class="op" id="3392447">(</span><span class="ident" id="3392448">c</span><span class="op" id="3392449">.</span><span class="ident" id="3392450">config</span><span class="op" id="3392456">,</span>&nbsp;<span class="ident" id="3392458">hs</span><span class="op" id="3392460">.</span><span class="ident" id="3392461">hello</span><span class="op" id="3392466">,</span>&nbsp;<span class="ident" id="3392468">certs</span><span class="op" id="3392473">[</span><span class="num" id="3392474">0</span><span class="op" id="3392475">]</span><span class="op" id="3392476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392479">if</span>&nbsp;<span class="ident" id="3392482">err</span>&nbsp;<span class="op" id="3392486">!=</span>&nbsp;<span class="ident" id="3392489">nil</span>&nbsp;<span class="op" id="3392493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392497">c</span><span class="op" id="3392498">.</span><span class="ident" id="3392499">sendAlert</span><span class="op" id="3392508">(</span><span class="ident" id="3392509">alertInternalError</span><span class="op" id="3392527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392531">return</span>&nbsp;<span class="ident" id="3392538">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3392543">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392546">if</span>&nbsp;<span class="ident" id="3392549">ckx</span>&nbsp;<span class="op" id="3392553">!=</span>&nbsp;<span class="ident" id="3392556">nil</span>&nbsp;<span class="op" id="3392560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392564">hs</span><span class="op" id="3392566">.</span><span class="ident" id="3392567">finishedHash</span><span class="op" id="3392579">.</span><span class="ident" id="3392580">Write</span><span class="op" id="3392585">(</span><span class="ident" id="3392586">ckx</span><span class="op" id="3392589">.</span><span class="ident" id="3392590">marshal</span><span class="op" id="3392597">(</span><span class="op" id="3392598">)</span><span class="op" id="3392599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392603">c</span><span class="op" id="3392604">.</span><span class="ident" id="3392605">writeRecord</span><span class="op" id="3392616">(</span><span class="ident" id="3392617">recordTypeHandshake</span><span class="op" id="3392636">,</span>&nbsp;<span class="ident" id="3392638">ckx</span><span class="op" id="3392641">.</span><span class="ident" id="3392642">marshal</span><span class="op" id="3392649">(</span><span class="op" id="3392650">)</span><span class="op" id="3392651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3392654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392658">if</span>&nbsp;<span class="ident" id="3392661">chainToSend</span>&nbsp;<span class="op" id="3392673">!=</span>&nbsp;<span class="ident" id="3392676">nil</span>&nbsp;<span class="op" id="3392680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392684">var</span>&nbsp;<span class="ident" id="3392688">signed</span>&nbsp;<span class="op" id="3392695">[</span><span class="op" id="3392696">]</span><span class="builtintype" id="3392697">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392704">certVerify</span>&nbsp;<span class="op" id="3392715">:=</span>&nbsp;<span class="op" id="3392718">&amp;</span><span class="ident" id="3392719">certificateVerifyMsg</span><span class="op" id="3392739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392744">hasSignatureAndHash</span><span class="op" id="3392763">:</span>&nbsp;<span class="ident" id="3392765">c</span><span class="op" id="3392766">.</span><span class="ident" id="3392767">vers</span>&nbsp;<span class="op" id="3392772">&gt;=</span>&nbsp;<span class="ident" id="3392775">VersionTLS12</span><span class="op" id="3392787">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3392791">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392796">key</span><span class="op" id="3392799">,</span>&nbsp;<span class="ident" id="3392801">ok</span>&nbsp;<span class="op" id="3392804">:=</span>&nbsp;<span class="ident" id="3392807">chainToSend</span><span class="op" id="3392818">.</span><span class="ident" id="3392819">PrivateKey</span><span class="op" id="3392829">.</span><span class="op" id="3392830">(</span><span class="ident" id="3392831">crypto</span><span class="op" id="3392837">.</span><span class="ident" id="3392838">Signer</span><span class="op" id="3392844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392848">if</span>&nbsp;<span class="op" id="3392851">!</span><span class="ident" id="3392852">ok</span>&nbsp;<span class="op" id="3392855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3392860">c</span><span class="op" id="3392861">.</span><span class="ident" id="3392862">sendAlert</span><span class="op" id="3392871">(</span><span class="ident" id="3392872">alertInternalError</span><span class="op" id="3392890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3392895">return</span>&nbsp;<span class="ident" id="3392902">fmt</span><span class="op" id="3392905">.</span><span class="ident" id="3392906">Errorf</span><span class="op" id="3392912">(</span><span class="string" id="3392913">&#34;tls:&nbsp;client&nbsp;certificate&nbsp;private&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&nbsp;does&nbsp;not&nbsp;implement&nbsp;crypto.Signer&#34;</span><span class="op" id="3392994">,</span>&nbsp;<span class="ident" id="3392996">chainToSend</span><span class="op" id="3393007">.</span><span class="ident" id="3393008">PrivateKey</span><span class="op" id="3393018">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3393022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3393026">switch</span>&nbsp;<span class="ident" id="3393033">key</span><span class="op" id="3393036">.</span><span class="ident" id="3393037">Public</span><span class="op" id="3393043">(</span><span class="op" id="3393044">)</span><span class="op" id="3393045">.</span><span class="op" id="3393046">(</span><span class="keyword" id="3393047">type</span><span class="op" id="3393051">)</span>&nbsp;<span class="op" id="3393053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3393057">case</span>&nbsp;<span class="op" id="3393062">*</span><span class="ident" id="3393063">ecdsa</span><span class="op" id="3393068">.</span><span class="ident" id="3393069">PublicKey</span><span class="op" id="3393078">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393083">digest</span><span class="op" id="3393089">,</span>&nbsp;<span class="ident" id="3393091">hashFunc</span><span class="op" id="3393099">,</span>&nbsp;<span class="ident" id="3393101">hashId</span>&nbsp;<span class="op" id="3393108">:=</span>&nbsp;<span class="ident" id="3393111">hs</span><span class="op" id="3393113">.</span><span class="ident" id="3393114">finishedHash</span><span class="op" id="3393126">.</span><span class="ident" id="3393127">hashForClientCertificate</span><span class="op" id="3393151">(</span><span class="ident" id="3393152">signatureECDSA</span><span class="op" id="3393166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393171">signed</span><span class="op" id="3393177">,</span>&nbsp;<span class="ident" id="3393179">err</span>&nbsp;<span class="op" id="3393183">=</span>&nbsp;<span class="ident" id="3393185">key</span><span class="op" id="3393188">.</span><span class="ident" id="3393189">Sign</span><span class="op" id="3393193">(</span><span class="ident" id="3393194">c</span><span class="op" id="3393195">.</span><span class="ident" id="3393196">config</span><span class="op" id="3393202">.</span><span class="ident" id="3393203">rand</span><span class="op" id="3393207">(</span><span class="op" id="3393208">)</span><span class="op" id="3393209">,</span>&nbsp;<span class="ident" id="3393211">digest</span><span class="op" id="3393217">,</span>&nbsp;<span class="ident" id="3393219">hashFunc</span><span class="op" id="3393227">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393232">certVerify</span><span class="op" id="3393242">.</span><span class="ident" id="3393243">signatureAndHash</span><span class="op" id="3393259">.</span><span class="ident" id="3393260">signature</span>&nbsp;<span class="op" id="3393270">=</span>&nbsp;<span class="ident" id="3393272">signatureECDSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393290">certVerify</span><span class="op" id="3393300">.</span><span class="ident" id="3393301">signatureAndHash</span><span class="op" id="3393317">.</span><span class="ident" id="3393318">hash</span>&nbsp;<span class="op" id="3393323">=</span>&nbsp;<span class="ident" id="3393325">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3393334">case</span>&nbsp;<span class="op" id="3393339">*</span><span class="ident" id="3393340">rsa</span><span class="op" id="3393343">.</span><span class="ident" id="3393344">PublicKey</span><span class="op" id="3393353">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393358">digest</span><span class="op" id="3393364">,</span>&nbsp;<span class="ident" id="3393366">hashFunc</span><span class="op" id="3393374">,</span>&nbsp;<span class="ident" id="3393376">hashId</span>&nbsp;<span class="op" id="3393383">:=</span>&nbsp;<span class="ident" id="3393386">hs</span><span class="op" id="3393388">.</span><span class="ident" id="3393389">finishedHash</span><span class="op" id="3393401">.</span><span class="ident" id="3393402">hashForClientCertificate</span><span class="op" id="3393426">(</span><span class="ident" id="3393427">signatureRSA</span><span class="op" id="3393439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393444">signed</span><span class="op" id="3393450">,</span>&nbsp;<span class="ident" id="3393452">err</span>&nbsp;<span class="op" id="3393456">=</span>&nbsp;<span class="ident" id="3393458">key</span><span class="op" id="3393461">.</span><span class="ident" id="3393462">Sign</span><span class="op" id="3393466">(</span><span class="ident" id="3393467">c</span><span class="op" id="3393468">.</span><span class="ident" id="3393469">config</span><span class="op" id="3393475">.</span><span class="ident" id="3393476">rand</span><span class="op" id="3393480">(</span><span class="op" id="3393481">)</span><span class="op" id="3393482">,</span>&nbsp;<span class="ident" id="3393484">digest</span><span class="op" id="3393490">,</span>&nbsp;<span class="ident" id="3393492">hashFunc</span><span class="op" id="3393500">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393505">certVerify</span><span class="op" id="3393515">.</span><span class="ident" id="3393516">signatureAndHash</span><span class="op" id="3393532">.</span><span class="ident" id="3393533">signature</span>&nbsp;<span class="op" id="3393543">=</span>&nbsp;<span class="ident" id="3393545">signatureRSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393561">certVerify</span><span class="op" id="3393571">.</span><span class="ident" id="3393572">signatureAndHash</span><span class="op" id="3393588">.</span><span class="ident" id="3393589">hash</span>&nbsp;<span class="op" id="3393594">=</span>&nbsp;<span class="ident" id="3393596">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3393605">default</span><span class="op" id="3393612">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393617">err</span>&nbsp;<span class="op" id="3393621">=</span>&nbsp;<span class="ident" id="3393623">fmt</span><span class="op" id="3393626">.</span><span class="ident" id="3393627">Errorf</span><span class="op" id="3393633">(</span><span class="string" id="3393634">&#34;tls:&nbsp;unknown&nbsp;client&nbsp;certificate&nbsp;key&nbsp;type:&nbsp;%T&#34;</span><span class="op" id="3393680">,</span>&nbsp;<span class="ident" id="3393682">key</span><span class="op" id="3393685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3393689">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3393693">if</span>&nbsp;<span class="ident" id="3393696">err</span>&nbsp;<span class="op" id="3393700">!=</span>&nbsp;<span class="ident" id="3393703">nil</span>&nbsp;<span class="op" id="3393707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393712">c</span><span class="op" id="3393713">.</span><span class="ident" id="3393714">sendAlert</span><span class="op" id="3393723">(</span><span class="ident" id="3393724">alertInternalError</span><span class="op" id="3393742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3393747">return</span>&nbsp;<span class="ident" id="3393754">errors</span><span class="op" id="3393760">.</span><span class="ident" id="3393761">New</span><span class="op" id="3393764">(</span><span class="string" id="3393765">&#34;tls:&nbsp;failed&nbsp;to&nbsp;sign&nbsp;handshake&nbsp;with&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3393823">+</span>&nbsp;<span class="ident" id="3393825">err</span><span class="op" id="3393828">.</span><span class="ident" id="3393829">Error</span><span class="op" id="3393834">(</span><span class="op" id="3393835">)</span><span class="op" id="3393836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3393840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393844">certVerify</span><span class="op" id="3393854">.</span><span class="ident" id="3393855">signature</span>&nbsp;<span class="op" id="3393865">=</span>&nbsp;<span class="ident" id="3393867">signed</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393877">hs</span><span class="op" id="3393879">.</span><span class="ident" id="3393880">finishedHash</span><span class="op" id="3393892">.</span><span class="ident" id="3393893">Write</span><span class="op" id="3393898">(</span><span class="ident" id="3393899">certVerify</span><span class="op" id="3393909">.</span><span class="ident" id="3393910">marshal</span><span class="op" id="3393917">(</span><span class="op" id="3393918">)</span><span class="op" id="3393919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393923">c</span><span class="op" id="3393924">.</span><span class="ident" id="3393925">writeRecord</span><span class="op" id="3393936">(</span><span class="ident" id="3393937">recordTypeHandshake</span><span class="op" id="3393956">,</span>&nbsp;<span class="ident" id="3393958">certVerify</span><span class="op" id="3393968">.</span><span class="ident" id="3393969">marshal</span><span class="op" id="3393976">(</span><span class="op" id="3393977">)</span><span class="op" id="3393978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3393981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393985">hs</span><span class="op" id="3393987">.</span><span class="ident" id="3393988">masterSecret</span>&nbsp;<span class="op" id="3394001">=</span>&nbsp;<span class="ident" id="3394003">masterFromPreMasterSecret</span><span class="op" id="3394028">(</span><span class="ident" id="3394029">c</span><span class="op" id="3394030">.</span><span class="ident" id="3394031">vers</span><span class="op" id="3394035">,</span>&nbsp;<span class="ident" id="3394037">preMasterSecret</span><span class="op" id="3394052">,</span>&nbsp;<span class="ident" id="3394054">hs</span><span class="op" id="3394056">.</span><span class="ident" id="3394057">hello</span><span class="op" id="3394062">.</span><span class="ident" id="3394063">random</span><span class="op" id="3394069">,</span>&nbsp;<span class="ident" id="3394071">hs</span><span class="op" id="3394073">.</span><span class="ident" id="3394074">serverHello</span><span class="op" id="3394085">.</span><span class="ident" id="3394086">random</span><span class="op" id="3394092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394095">return</span>&nbsp;<span class="ident" id="3394102">nil</span><br>
<span class="lineno"></span><span class="op" id="3394106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3394109">func</span>&nbsp;<span class="op" id="3394114">(</span><span class="ident" id="3394115">hs</span>&nbsp;<span class="op" id="3394118">*</span><span class="ident" id="3394119">clientHandshakeState</span><span class="op" id="3394139">)</span>&nbsp;<span class="ident" id="3394141">establishKeys</span><span class="op" id="3394154">(</span><span class="op" id="3394155">)</span>&nbsp;<span class="builtintype" id="3394157">error</span>&nbsp;<span class="op" id="3394163">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394166">c</span>&nbsp;<span class="op" id="3394168">:=</span>&nbsp;<span class="ident" id="3394171">hs</span><span class="op" id="3394173">.</span><span class="ident" id="3394174">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394178">clientMAC</span><span class="op" id="3394187">,</span>&nbsp;<span class="ident" id="3394189">serverMAC</span><span class="op" id="3394198">,</span>&nbsp;<span class="ident" id="3394200">clientKey</span><span class="op" id="3394209">,</span>&nbsp;<span class="ident" id="3394211">serverKey</span><span class="op" id="3394220">,</span>&nbsp;<span class="ident" id="3394222">clientIV</span><span class="op" id="3394230">,</span>&nbsp;<span class="ident" id="3394232">serverIV</span>&nbsp;<span class="op" id="3394241">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394246">keysFromMasterSecret</span><span class="op" id="3394266">(</span><span class="ident" id="3394267">c</span><span class="op" id="3394268">.</span><span class="ident" id="3394269">vers</span><span class="op" id="3394273">,</span>&nbsp;<span class="ident" id="3394275">hs</span><span class="op" id="3394277">.</span><span class="ident" id="3394278">masterSecret</span><span class="op" id="3394290">,</span>&nbsp;<span class="ident" id="3394292">hs</span><span class="op" id="3394294">.</span><span class="ident" id="3394295">hello</span><span class="op" id="3394300">.</span><span class="ident" id="3394301">random</span><span class="op" id="3394307">,</span>&nbsp;<span class="ident" id="3394309">hs</span><span class="op" id="3394311">.</span><span class="ident" id="3394312">serverHello</span><span class="op" id="3394323">.</span><span class="ident" id="3394324">random</span><span class="op" id="3394330">,</span>&nbsp;<span class="ident" id="3394332">hs</span><span class="op" id="3394334">.</span><span class="ident" id="3394335">suite</span><span class="op" id="3394340">.</span><span class="ident" id="3394341">macLen</span><span class="op" id="3394347">,</span>&nbsp;<span class="ident" id="3394349">hs</span><span class="op" id="3394351">.</span><span class="ident" id="3394352">suite</span><span class="op" id="3394357">.</span><span class="ident" id="3394358">keyLen</span><span class="op" id="3394364">,</span>&nbsp;<span class="ident" id="3394366">hs</span><span class="op" id="3394368">.</span><span class="ident" id="3394369">suite</span><span class="op" id="3394374">.</span><span class="ident" id="3394375">ivLen</span><span class="op" id="3394380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394383">var</span>&nbsp;<span class="ident" id="3394387">clientCipher</span><span class="op" id="3394399">,</span>&nbsp;<span class="ident" id="3394401">serverCipher</span>&nbsp;<span class="keyword" id="3394414">interface</span><span class="op" id="3394423">{</span><span class="op" id="3394424">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394427">var</span>&nbsp;<span class="ident" id="3394431">clientHash</span><span class="op" id="3394441">,</span>&nbsp;<span class="ident" id="3394443">serverHash</span>&nbsp;<span class="ident" id="3394454">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394467">if</span>&nbsp;<span class="ident" id="3394470">hs</span><span class="op" id="3394472">.</span><span class="ident" id="3394473">suite</span><span class="op" id="3394478">.</span><span class="ident" id="3394479">cipher</span>&nbsp;<span class="op" id="3394486">!=</span>&nbsp;<span class="ident" id="3394489">nil</span>&nbsp;<span class="op" id="3394493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394497">clientCipher</span>&nbsp;<span class="op" id="3394510">=</span>&nbsp;<span class="ident" id="3394512">hs</span><span class="op" id="3394514">.</span><span class="ident" id="3394515">suite</span><span class="op" id="3394520">.</span><span class="ident" id="3394521">cipher</span><span class="op" id="3394527">(</span><span class="ident" id="3394528">clientKey</span><span class="op" id="3394537">,</span>&nbsp;<span class="ident" id="3394539">clientIV</span><span class="op" id="3394547">,</span>&nbsp;<span class="builtintype" id="3394549">false</span>&nbsp;<span class="comment" id="3394555">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3394576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394580">clientHash</span>&nbsp;<span class="op" id="3394591">=</span>&nbsp;<span class="ident" id="3394593">hs</span><span class="op" id="3394595">.</span><span class="ident" id="3394596">suite</span><span class="op" id="3394601">.</span><span class="ident" id="3394602">mac</span><span class="op" id="3394605">(</span><span class="ident" id="3394606">c</span><span class="op" id="3394607">.</span><span class="ident" id="3394608">vers</span><span class="op" id="3394612">,</span>&nbsp;<span class="ident" id="3394614">clientMAC</span><span class="op" id="3394623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394627">serverCipher</span>&nbsp;<span class="op" id="3394640">=</span>&nbsp;<span class="ident" id="3394642">hs</span><span class="op" id="3394644">.</span><span class="ident" id="3394645">suite</span><span class="op" id="3394650">.</span><span class="ident" id="3394651">cipher</span><span class="op" id="3394657">(</span><span class="ident" id="3394658">serverKey</span><span class="op" id="3394667">,</span>&nbsp;<span class="ident" id="3394669">serverIV</span><span class="op" id="3394677">,</span>&nbsp;<span class="builtintype" id="3394679">true</span>&nbsp;<span class="comment" id="3394684">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3394701">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394705">serverHash</span>&nbsp;<span class="op" id="3394716">=</span>&nbsp;<span class="ident" id="3394718">hs</span><span class="op" id="3394720">.</span><span class="ident" id="3394721">suite</span><span class="op" id="3394726">.</span><span class="ident" id="3394727">mac</span><span class="op" id="3394730">(</span><span class="ident" id="3394731">c</span><span class="op" id="3394732">.</span><span class="ident" id="3394733">vers</span><span class="op" id="3394737">,</span>&nbsp;<span class="ident" id="3394739">serverMAC</span><span class="op" id="3394748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3394751">}</span>&nbsp;<span class="keyword" id="3394753">else</span>&nbsp;<span class="op" id="3394758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394762">clientCipher</span>&nbsp;<span class="op" id="3394775">=</span>&nbsp;<span class="ident" id="3394777">hs</span><span class="op" id="3394779">.</span><span class="ident" id="3394780">suite</span><span class="op" id="3394785">.</span><span class="ident" id="3394786">aead</span><span class="op" id="3394790">(</span><span class="ident" id="3394791">clientKey</span><span class="op" id="3394800">,</span>&nbsp;<span class="ident" id="3394802">clientIV</span><span class="op" id="3394810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394814">serverCipher</span>&nbsp;<span class="op" id="3394827">=</span>&nbsp;<span class="ident" id="3394829">hs</span><span class="op" id="3394831">.</span><span class="ident" id="3394832">suite</span><span class="op" id="3394837">.</span><span class="ident" id="3394838">aead</span><span class="op" id="3394842">(</span><span class="ident" id="3394843">serverKey</span><span class="op" id="3394852">,</span>&nbsp;<span class="ident" id="3394854">serverIV</span><span class="op" id="3394862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3394865">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394869">c</span><span class="op" id="3394870">.</span><span class="ident" id="3394871">in</span><span class="op" id="3394873">.</span><span class="ident" id="3394874">prepareCipherSpec</span><span class="op" id="3394891">(</span><span class="ident" id="3394892">c</span><span class="op" id="3394893">.</span><span class="ident" id="3394894">vers</span><span class="op" id="3394898">,</span>&nbsp;<span class="ident" id="3394900">serverCipher</span><span class="op" id="3394912">,</span>&nbsp;<span class="ident" id="3394914">serverHash</span><span class="op" id="3394924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394927">c</span><span class="op" id="3394928">.</span><span class="ident" id="3394929">out</span><span class="op" id="3394932">.</span><span class="ident" id="3394933">prepareCipherSpec</span><span class="op" id="3394950">(</span><span class="ident" id="3394951">c</span><span class="op" id="3394952">.</span><span class="ident" id="3394953">vers</span><span class="op" id="3394957">,</span>&nbsp;<span class="ident" id="3394959">clientCipher</span><span class="op" id="3394971">,</span>&nbsp;<span class="ident" id="3394973">clientHash</span><span class="op" id="3394983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394986">return</span>&nbsp;<span class="ident" id="3394993">nil</span><br>
<span class="lineno"></span><span class="op" id="3394997">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="3395000">func</span>&nbsp;<span class="op" id="3395005">(</span><span class="ident" id="3395006">hs</span>&nbsp;<span class="op" id="3395009">*</span><span class="ident" id="3395010">clientHandshakeState</span><span class="op" id="3395030">)</span>&nbsp;<span class="ident" id="3395032">serverResumedSession</span><span class="op" id="3395052">(</span><span class="op" id="3395053">)</span>&nbsp;<span class="builtintype" id="3395055">bool</span>&nbsp;<span class="op" id="3395060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3395063">//&nbsp;If&nbsp;the&nbsp;server&nbsp;responded&nbsp;with&nbsp;the&nbsp;same&nbsp;sessionId&nbsp;then&nbsp;it&nbsp;means&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3395133">//&nbsp;sessionTicket&nbsp;is&nbsp;being&nbsp;used&nbsp;to&nbsp;resume&nbsp;a&nbsp;TLS&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395190">return</span>&nbsp;<span class="ident" id="3395197">hs</span><span class="op" id="3395199">.</span><span class="ident" id="3395200">session</span>&nbsp;<span class="op" id="3395208">!=</span>&nbsp;<span class="ident" id="3395211">nil</span>&nbsp;<span class="op" id="3395215">&amp;&amp;</span>&nbsp;<span class="ident" id="3395218">hs</span><span class="op" id="3395220">.</span><span class="ident" id="3395221">hello</span><span class="op" id="3395226">.</span><span class="ident" id="3395227">sessionId</span>&nbsp;<span class="op" id="3395237">!=</span>&nbsp;<span class="ident" id="3395240">nil</span>&nbsp;<span class="op" id="3395244">&amp;&amp;</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3395249">bytes</span><span class="op" id="3395254">.</span><span class="ident" id="3395255">Equal</span><span class="op" id="3395260">(</span><span class="ident" id="3395261">hs</span><span class="op" id="3395263">.</span><span class="ident" id="3395264">serverHello</span><span class="op" id="3395275">.</span><span class="ident" id="3395276">sessionId</span><span class="op" id="3395285">,</span>&nbsp;<span class="ident" id="3395287">hs</span><span class="op" id="3395289">.</span><span class="ident" id="3395290">hello</span><span class="op" id="3395295">.</span><span class="ident" id="3395296">sessionId</span><span class="op" id="3395305">)</span><br>
<span class="lineno"></span><span class="op" id="3395307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3395310">func</span>&nbsp;<span class="op" id="3395315">(</span><span class="ident" id="3395316">hs</span>&nbsp;<span class="op" id="3395319">*</span><span class="ident" id="3395320">clientHandshakeState</span><span class="op" id="3395340">)</span>&nbsp;<span class="ident" id="3395342">processServerHello</span><span class="op" id="3395360">(</span><span class="op" id="3395361">)</span>&nbsp;<span class="op" id="3395363">(</span><span class="builtintype" id="3395364">bool</span><span class="op" id="3395368">,</span>&nbsp;<span class="builtintype" id="3395370">error</span><span class="op" id="3395375">)</span>&nbsp;<span class="op" id="3395377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3395380">c</span>&nbsp;<span class="op" id="3395382">:=</span>&nbsp;<span class="ident" id="3395385">hs</span><span class="op" id="3395387">.</span><span class="ident" id="3395388">c</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395392">if</span>&nbsp;<span class="ident" id="3395395">hs</span><span class="op" id="3395397">.</span><span class="ident" id="3395398">serverHello</span><span class="op" id="3395409">.</span><span class="ident" id="3395410">compressionMethod</span>&nbsp;<span class="op" id="3395428">!=</span>&nbsp;<span class="ident" id="3395431">compressionNone</span>&nbsp;<span class="op" id="3395447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3395451">c</span><span class="op" id="3395452">.</span><span class="ident" id="3395453">sendAlert</span><span class="op" id="3395462">(</span><span class="ident" id="3395463">alertUnexpectedMessage</span><span class="op" id="3395485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395489">return</span>&nbsp;<span class="builtintype" id="3395496">false</span><span class="op" id="3395501">,</span>&nbsp;<span class="ident" id="3395503">errors</span><span class="op" id="3395509">.</span><span class="ident" id="3395510">New</span><span class="op" id="3395513">(</span><span class="string" id="3395514">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;compression&nbsp;format&#34;</span><span class="op" id="3395567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3395570">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3395574">clientDidNPN</span>&nbsp;<span class="op" id="3395587">:=</span>&nbsp;<span class="ident" id="3395590">hs</span><span class="op" id="3395592">.</span><span class="ident" id="3395593">hello</span><span class="op" id="3395598">.</span><span class="ident" id="3395599">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3395613">clientDidALPN</span>&nbsp;<span class="op" id="3395627">:=</span>&nbsp;<span class="builtinfunc" id="3395630">len</span><span class="op" id="3395633">(</span><span class="ident" id="3395634">hs</span><span class="op" id="3395636">.</span><span class="ident" id="3395637">hello</span><span class="op" id="3395642">.</span><span class="ident" id="3395643">alpnProtocols</span><span class="op" id="3395656">)</span>&nbsp;<span class="op" id="3395658">&gt;</span>&nbsp;<span class="num" id="3395660">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3395663">serverHasNPN</span>&nbsp;<span class="op" id="3395676">:=</span>&nbsp;<span class="ident" id="3395679">hs</span><span class="op" id="3395681">.</span><span class="ident" id="3395682">serverHello</span><span class="op" id="3395693">.</span><span class="ident" id="3395694">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3395708">serverHasALPN</span>&nbsp;<span class="op" id="3395722">:=</span>&nbsp;<span class="builtinfunc" id="3395725">len</span><span class="op" id="3395728">(</span><span class="ident" id="3395729">hs</span><span class="op" id="3395731">.</span><span class="ident" id="3395732">serverHello</span><span class="op" id="3395743">.</span><span class="ident" id="3395744">alpnProtocol</span><span class="op" id="3395756">)</span>&nbsp;<span class="op" id="3395758">&gt;</span>&nbsp;<span class="num" id="3395760">0</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395764">if</span>&nbsp;<span class="op" id="3395767">!</span><span class="ident" id="3395768">clientDidNPN</span>&nbsp;<span class="op" id="3395781">&amp;&amp;</span>&nbsp;<span class="ident" id="3395784">serverHasNPN</span>&nbsp;<span class="op" id="3395797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3395801">c</span><span class="op" id="3395802">.</span><span class="ident" id="3395803">sendAlert</span><span class="op" id="3395812">(</span><span class="ident" id="3395813">alertHandshakeFailure</span><span class="op" id="3395834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395838">return</span>&nbsp;<span class="builtintype" id="3395845">false</span><span class="op" id="3395850">,</span>&nbsp;<span class="ident" id="3395852">errors</span><span class="op" id="3395858">.</span><span class="ident" id="3395859">New</span><span class="op" id="3395862">(</span><span class="string" id="3395863">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;NPN&nbsp;extension&#34;</span><span class="op" id="3395908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3395911">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395915">if</span>&nbsp;<span class="op" id="3395918">!</span><span class="ident" id="3395919">clientDidALPN</span>&nbsp;<span class="op" id="3395933">&amp;&amp;</span>&nbsp;<span class="ident" id="3395936">serverHasALPN</span>&nbsp;<span class="op" id="3395950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3395954">c</span><span class="op" id="3395955">.</span><span class="ident" id="3395956">sendAlert</span><span class="op" id="3395965">(</span><span class="ident" id="3395966">alertHandshakeFailure</span><span class="op" id="3395987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395991">return</span>&nbsp;<span class="builtintype" id="3395998">false</span><span class="op" id="3396003">,</span>&nbsp;<span class="ident" id="3396005">errors</span><span class="op" id="3396011">.</span><span class="ident" id="3396012">New</span><span class="op" id="3396015">(</span><span class="string" id="3396016">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;ALPN&nbsp;extension&#34;</span><span class="op" id="3396062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3396065">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396069">if</span>&nbsp;<span class="ident" id="3396072">serverHasNPN</span>&nbsp;<span class="op" id="3396085">&amp;&amp;</span>&nbsp;<span class="ident" id="3396088">serverHasALPN</span>&nbsp;<span class="op" id="3396102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3396106">c</span><span class="op" id="3396107">.</span><span class="ident" id="3396108">sendAlert</span><span class="op" id="3396117">(</span><span class="ident" id="3396118">alertHandshakeFailure</span><span class="op" id="3396139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396143">return</span>&nbsp;<span class="builtintype" id="3396150">false</span><span class="op" id="3396155">,</span>&nbsp;<span class="ident" id="3396157">errors</span><span class="op" id="3396163">.</span><span class="ident" id="3396164">New</span><span class="op" id="3396167">(</span><span class="string" id="3396168">&#34;server&nbsp;advertised&nbsp;both&nbsp;NPN&nbsp;and&nbsp;ALPN&nbsp;extensions&#34;</span><span class="op" id="3396216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3396219">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396223">if</span>&nbsp;<span class="ident" id="3396226">serverHasALPN</span>&nbsp;<span class="op" id="3396240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3396244">c</span><span class="op" id="3396245">.</span><span class="ident" id="3396246">clientProtocol</span>&nbsp;<span class="op" id="3396261">=</span>&nbsp;<span class="ident" id="3396263">hs</span><span class="op" id="3396265">.</span><span class="ident" id="3396266">serverHello</span><span class="op" id="3396277">.</span><span class="ident" id="3396278">alpnProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3396293">c</span><span class="op" id="3396294">.</span><span class="ident" id="3396295">clientProtocolFallback</span>&nbsp;<span class="op" id="3396318">=</span>&nbsp;<span class="builtintype" id="3396320">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3396327">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396331">if</span>&nbsp;<span class="ident" id="3396334">hs</span><span class="op" id="3396336">.</span><span class="ident" id="3396337">serverResumedSession</span><span class="op" id="3396357">(</span><span class="op" id="3396358">)</span>&nbsp;<span class="op" id="3396360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3396364">//&nbsp;Restore&nbsp;masterSecret&nbsp;and&nbsp;peerCerts&nbsp;from&nbsp;previous&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3396424">hs</span><span class="op" id="3396426">.</span><span class="ident" id="3396427">masterSecret</span>&nbsp;<span class="op" id="3396440">=</span>&nbsp;<span class="ident" id="3396442">hs</span><span class="op" id="3396444">.</span><span class="ident" id="3396445">session</span><span class="op" id="3396452">.</span><span class="ident" id="3396453">masterSecret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3396468">c</span><span class="op" id="3396469">.</span><span class="ident" id="3396470">peerCertificates</span>&nbsp;<span class="op" id="3396487">=</span>&nbsp;<span class="ident" id="3396489">hs</span><span class="op" id="3396491">.</span><span class="ident" id="3396492">session</span><span class="op" id="3396499">.</span><span class="ident" id="3396500">serverCertificates</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396521">return</span>&nbsp;<span class="builtintype" id="3396528">true</span><span class="op" id="3396532">,</span>&nbsp;<span class="ident" id="3396534">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3396539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396542">return</span>&nbsp;<span class="builtintype" id="3396549">false</span><span class="op" id="3396554">,</span>&nbsp;<span class="ident" id="3396556">nil</span><br>
<span class="lineno"></span><span class="op" id="3396560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="3396563">func</span>&nbsp;<span class="op" id="3396568">(</span><span class="ident" id="3396569">hs</span>&nbsp;<span class="op" id="3396572">*</span><span class="ident" id="3396573">clientHandshakeState</span><span class="op" id="3396593">)</span>&nbsp;<span class="ident" id="3396595">readFinished</span><span class="op" id="3396607">(</span><span class="ident" id="3396608">out</span>&nbsp;<span class="op" id="3396612">[</span><span class="op" id="3396613">]</span><span class="builtintype" id="3396614">byte</span><span class="op" id="3396618">)</span>&nbsp;<span class="builtintype" id="3396620">error</span>&nbsp;<span class="op" id="3396626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3396629">c</span>&nbsp;<span class="op" id="3396631">:=</span>&nbsp;<span class="ident" id="3396634">hs</span><span class="op" id="3396636">.</span><span class="ident" id="3396637">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3396641">c</span><span class="op" id="3396642">.</span><span class="ident" id="3396643">readRecord</span><span class="op" id="3396653">(</span><span class="ident" id="3396654">recordTypeChangeCipherSpec</span><span class="op" id="3396680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396683">if</span>&nbsp;<span class="ident" id="3396686">err</span>&nbsp;<span class="op" id="3396690">:=</span>&nbsp;<span class="ident" id="3396693">c</span><span class="op" id="3396694">.</span><span class="ident" id="3396695">in</span><span class="op" id="3396697">.</span><span class="builtintype" id="3396698">error</span><span class="op" id="3396703">(</span><span class="op" id="3396704">)</span><span class="op" id="3396705">;</span>&nbsp;<span class="ident" id="3396707">err</span>&nbsp;<span class="op" id="3396711">!=</span>&nbsp;<span class="ident" id="3396714">nil</span>&nbsp;<span class="op" id="3396718">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396722">return</span>&nbsp;<span class="ident" id="3396729">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3396734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3396738">msg</span><span class="op" id="3396741">,</span>&nbsp;<span class="ident" id="3396743">err</span>&nbsp;<span class="op" id="3396747">:=</span>&nbsp;<span class="ident" id="3396750">c</span><span class="op" id="3396751">.</span><span class="ident" id="3396752">readHandshake</span><span class="op" id="3396765">(</span><span class="op" id="3396766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396769">if</span>&nbsp;<span class="ident" id="3396772">err</span>&nbsp;<span class="op" id="3396776">!=</span>&nbsp;<span class="ident" id="3396779">nil</span>&nbsp;<span class="op" id="3396783">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396787">return</span>&nbsp;<span class="ident" id="3396794">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3396799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3396802">serverFinished</span><span class="op" id="3396816">,</span>&nbsp;<span class="ident" id="3396818">ok</span>&nbsp;<span class="op" id="3396821">:=</span>&nbsp;<span class="ident" id="3396824">msg</span><span class="op" id="3396827">.</span><span class="op" id="3396828">(</span><span class="op" id="3396829">*</span><span class="ident" id="3396830">finishedMsg</span><span class="op" id="3396841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396844">if</span>&nbsp;<span class="op" id="3396847">!</span><span class="ident" id="3396848">ok</span>&nbsp;<span class="op" id="3396851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3396855">c</span><span class="op" id="3396856">.</span><span class="ident" id="3396857">sendAlert</span><span class="op" id="3396866">(</span><span class="ident" id="3396867">alertUnexpectedMessage</span><span class="op" id="3396889">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3396893">return</span>&nbsp;<span class="ident" id="3396900">unexpectedMessageError</span><span class="op" id="3396922">(</span><span class="ident" id="3396923">serverFinished</span><span class="op" id="3396937">,</span>&nbsp;<span class="ident" id="3396939">msg</span><span class="op" id="3396942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3396945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3396949">verify</span>&nbsp;<span class="op" id="3396956">:=</span>&nbsp;<span class="ident" id="3396959">hs</span><span class="op" id="3396961">.</span><span class="ident" id="3396962">finishedHash</span><span class="op" id="3396974">.</span><span class="ident" id="3396975">serverSum</span><span class="op" id="3396984">(</span><span class="ident" id="3396985">hs</span><span class="op" id="3396987">.</span><span class="ident" id="3396988">masterSecret</span><span class="op" id="3397000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397003">if</span>&nbsp;<span class="builtinfunc" id="3397006">len</span><span class="op" id="3397009">(</span><span class="ident" id="3397010">verify</span><span class="op" id="3397016">)</span>&nbsp;<span class="op" id="3397018">!=</span>&nbsp;<span class="builtinfunc" id="3397021">len</span><span class="op" id="3397024">(</span><span class="ident" id="3397025">serverFinished</span><span class="op" id="3397039">.</span><span class="ident" id="3397040">verifyData</span><span class="op" id="3397050">)</span>&nbsp;<span class="op" id="3397052">||</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397057">subtle</span><span class="op" id="3397063">.</span><span class="ident" id="3397064">ConstantTimeCompare</span><span class="op" id="3397083">(</span><span class="ident" id="3397084">verify</span><span class="op" id="3397090">,</span>&nbsp;<span class="ident" id="3397092">serverFinished</span><span class="op" id="3397106">.</span><span class="ident" id="3397107">verifyData</span><span class="op" id="3397117">)</span>&nbsp;<span class="op" id="3397119">!=</span>&nbsp;<span class="num" id="3397122">1</span>&nbsp;<span class="op" id="3397124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397128">c</span><span class="op" id="3397129">.</span><span class="ident" id="3397130">sendAlert</span><span class="op" id="3397139">(</span><span class="ident" id="3397140">alertHandshakeFailure</span><span class="op" id="3397161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397165">return</span>&nbsp;<span class="ident" id="3397172">errors</span><span class="op" id="3397178">.</span><span class="ident" id="3397179">New</span><span class="op" id="3397182">(</span><span class="string" id="3397183">&#34;tls:&nbsp;server&#39;s&nbsp;Finished&nbsp;message&nbsp;was&nbsp;incorrect&#34;</span><span class="op" id="3397229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3397232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397235">hs</span><span class="op" id="3397237">.</span><span class="ident" id="3397238">finishedHash</span><span class="op" id="3397250">.</span><span class="ident" id="3397251">Write</span><span class="op" id="3397256">(</span><span class="ident" id="3397257">serverFinished</span><span class="op" id="3397271">.</span><span class="ident" id="3397272">marshal</span><span class="op" id="3397279">(</span><span class="op" id="3397280">)</span><span class="op" id="3397281">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3397284">copy</span><span class="op" id="3397288">(</span><span class="ident" id="3397289">out</span><span class="op" id="3397292">,</span>&nbsp;<span class="ident" id="3397294">verify</span><span class="op" id="3397300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397303">return</span>&nbsp;<span class="ident" id="3397310">nil</span><br>
<span class="lineno"></span><span class="op" id="3397314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3397317">func</span>&nbsp;<span class="op" id="3397322">(</span><span class="ident" id="3397323">hs</span>&nbsp;<span class="op" id="3397326">*</span><span class="ident" id="3397327">clientHandshakeState</span><span class="op" id="3397347">)</span>&nbsp;<span class="ident" id="3397349">readSessionTicket</span><span class="op" id="3397366">(</span><span class="op" id="3397367">)</span>&nbsp;<span class="builtintype" id="3397369">error</span>&nbsp;<span class="op" id="3397375">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397378">if</span>&nbsp;<span class="op" id="3397381">!</span><span class="ident" id="3397382">hs</span><span class="op" id="3397384">.</span><span class="ident" id="3397385">serverHello</span><span class="op" id="3397396">.</span><span class="ident" id="3397397">ticketSupported</span>&nbsp;<span class="op" id="3397413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397417">return</span>&nbsp;<span class="ident" id="3397424">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3397429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397433">c</span>&nbsp;<span class="op" id="3397435">:=</span>&nbsp;<span class="ident" id="3397438">hs</span><span class="op" id="3397440">.</span><span class="ident" id="3397441">c</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397444">msg</span><span class="op" id="3397447">,</span>&nbsp;<span class="ident" id="3397449">err</span>&nbsp;<span class="op" id="3397453">:=</span>&nbsp;<span class="ident" id="3397456">c</span><span class="op" id="3397457">.</span><span class="ident" id="3397458">readHandshake</span><span class="op" id="3397471">(</span><span class="op" id="3397472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397475">if</span>&nbsp;<span class="ident" id="3397478">err</span>&nbsp;<span class="op" id="3397482">!=</span>&nbsp;<span class="ident" id="3397485">nil</span>&nbsp;<span class="op" id="3397489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397493">return</span>&nbsp;<span class="ident" id="3397500">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3397505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397508">sessionTicketMsg</span><span class="op" id="3397524">,</span>&nbsp;<span class="ident" id="3397526">ok</span>&nbsp;<span class="op" id="3397529">:=</span>&nbsp;<span class="ident" id="3397532">msg</span><span class="op" id="3397535">.</span><span class="op" id="3397536">(</span><span class="op" id="3397537">*</span><span class="ident" id="3397538">newSessionTicketMsg</span><span class="op" id="3397557">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397560">if</span>&nbsp;<span class="op" id="3397563">!</span><span class="ident" id="3397564">ok</span>&nbsp;<span class="op" id="3397567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397571">c</span><span class="op" id="3397572">.</span><span class="ident" id="3397573">sendAlert</span><span class="op" id="3397582">(</span><span class="ident" id="3397583">alertUnexpectedMessage</span><span class="op" id="3397605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397609">return</span>&nbsp;<span class="ident" id="3397616">unexpectedMessageError</span><span class="op" id="3397638">(</span><span class="ident" id="3397639">sessionTicketMsg</span><span class="op" id="3397655">,</span>&nbsp;<span class="ident" id="3397657">msg</span><span class="op" id="3397660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3397663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397666">hs</span><span class="op" id="3397668">.</span><span class="ident" id="3397669">finishedHash</span><span class="op" id="3397681">.</span><span class="ident" id="3397682">Write</span><span class="op" id="3397687">(</span><span class="ident" id="3397688">sessionTicketMsg</span><span class="op" id="3397704">.</span><span class="ident" id="3397705">marshal</span><span class="op" id="3397712">(</span><span class="op" id="3397713">)</span><span class="op" id="3397714">)</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397718">hs</span><span class="op" id="3397720">.</span><span class="ident" id="3397721">session</span>&nbsp;<span class="op" id="3397729">=</span>&nbsp;<span class="op" id="3397731">&amp;</span><span class="ident" id="3397732">ClientSessionState</span><span class="op" id="3397750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397754">sessionTicket</span><span class="op" id="3397767">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3397774">sessionTicketMsg</span><span class="op" id="3397790">.</span><span class="ident" id="3397791">ticket</span><span class="op" id="3397797">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397801">vers</span><span class="op" id="3397805">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3397821">c</span><span class="op" id="3397822">.</span><span class="ident" id="3397823">vers</span><span class="op" id="3397827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397831">cipherSuite</span><span class="op" id="3397842">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3397851">hs</span><span class="op" id="3397853">.</span><span class="ident" id="3397854">suite</span><span class="op" id="3397859">.</span><span class="ident" id="3397860">id</span><span class="op" id="3397862">,</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397866">masterSecret</span><span class="op" id="3397878">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3397886">hs</span><span class="op" id="3397888">.</span><span class="ident" id="3397889">masterSecret</span><span class="op" id="3397901">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397905">serverCertificates</span><span class="op" id="3397923">:</span>&nbsp;<span class="ident" id="3397925">c</span><span class="op" id="3397926">.</span><span class="ident" id="3397927">peerCertificates</span><span class="op" id="3397943">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3397946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397950">return</span>&nbsp;<span class="ident" id="3397957">nil</span><br>
<span class="lineno">590</span><span class="op" id="3397961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3397964">func</span>&nbsp;<span class="op" id="3397969">(</span><span class="ident" id="3397970">hs</span>&nbsp;<span class="op" id="3397973">*</span><span class="ident" id="3397974">clientHandshakeState</span><span class="op" id="3397994">)</span>&nbsp;<span class="ident" id="3397996">sendFinished</span><span class="op" id="3398008">(</span><span class="ident" id="3398009">out</span>&nbsp;<span class="op" id="3398013">[</span><span class="op" id="3398014">]</span><span class="builtintype" id="3398015">byte</span><span class="op" id="3398019">)</span>&nbsp;<span class="builtintype" id="3398021">error</span>&nbsp;<span class="op" id="3398027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398030">c</span>&nbsp;<span class="op" id="3398032">:=</span>&nbsp;<span class="ident" id="3398035">hs</span><span class="op" id="3398037">.</span><span class="ident" id="3398038">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398042">c</span><span class="op" id="3398043">.</span><span class="ident" id="3398044">writeRecord</span><span class="op" id="3398055">(</span><span class="ident" id="3398056">recordTypeChangeCipherSpec</span><span class="op" id="3398082">,</span>&nbsp;<span class="op" id="3398084">[</span><span class="op" id="3398085">]</span><span class="builtintype" id="3398086">byte</span><span class="op" id="3398090">{</span><span class="num" id="3398091">1</span><span class="op" id="3398092">}</span><span class="op" id="3398093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398096">if</span>&nbsp;<span class="ident" id="3398099">hs</span><span class="op" id="3398101">.</span><span class="ident" id="3398102">serverHello</span><span class="op" id="3398113">.</span><span class="ident" id="3398114">nextProtoNeg</span>&nbsp;<span class="op" id="3398127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398131">nextProto</span>&nbsp;<span class="op" id="3398141">:=</span>&nbsp;<span class="builtinfunc" id="3398144">new</span><span class="op" id="3398147">(</span><span class="ident" id="3398148">nextProtoMsg</span><span class="op" id="3398160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398164">proto</span><span class="op" id="3398169">,</span>&nbsp;<span class="ident" id="3398171">fallback</span>&nbsp;<span class="op" id="3398180">:=</span>&nbsp;<span class="ident" id="3398183">mutualProtocol</span><span class="op" id="3398197">(</span><span class="ident" id="3398198">c</span><span class="op" id="3398199">.</span><span class="ident" id="3398200">config</span><span class="op" id="3398206">.</span><span class="ident" id="3398207">NextProtos</span><span class="op" id="3398217">,</span>&nbsp;<span class="ident" id="3398219">hs</span><span class="op" id="3398221">.</span><span class="ident" id="3398222">serverHello</span><span class="op" id="3398233">.</span><span class="ident" id="3398234">nextProtos</span><span class="op" id="3398244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398248">nextProto</span><span class="op" id="3398257">.</span><span class="ident" id="3398258">proto</span>&nbsp;<span class="op" id="3398264">=</span>&nbsp;<span class="ident" id="3398266">proto</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398274">c</span><span class="op" id="3398275">.</span><span class="ident" id="3398276">clientProtocol</span>&nbsp;<span class="op" id="3398291">=</span>&nbsp;<span class="ident" id="3398293">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398301">c</span><span class="op" id="3398302">.</span><span class="ident" id="3398303">clientProtocolFallback</span>&nbsp;<span class="op" id="3398326">=</span>&nbsp;<span class="ident" id="3398328">fallback</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398340">hs</span><span class="op" id="3398342">.</span><span class="ident" id="3398343">finishedHash</span><span class="op" id="3398355">.</span><span class="ident" id="3398356">Write</span><span class="op" id="3398361">(</span><span class="ident" id="3398362">nextProto</span><span class="op" id="3398371">.</span><span class="ident" id="3398372">marshal</span><span class="op" id="3398379">(</span><span class="op" id="3398380">)</span><span class="op" id="3398381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398385">c</span><span class="op" id="3398386">.</span><span class="ident" id="3398387">writeRecord</span><span class="op" id="3398398">(</span><span class="ident" id="3398399">recordTypeHandshake</span><span class="op" id="3398418">,</span>&nbsp;<span class="ident" id="3398420">nextProto</span><span class="op" id="3398429">.</span><span class="ident" id="3398430">marshal</span><span class="op" id="3398437">(</span><span class="op" id="3398438">)</span><span class="op" id="3398439">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3398442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398446">finished</span>&nbsp;<span class="op" id="3398455">:=</span>&nbsp;<span class="builtinfunc" id="3398458">new</span><span class="op" id="3398461">(</span><span class="ident" id="3398462">finishedMsg</span><span class="op" id="3398473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398476">finished</span><span class="op" id="3398484">.</span><span class="ident" id="3398485">verifyData</span>&nbsp;<span class="op" id="3398496">=</span>&nbsp;<span class="ident" id="3398498">hs</span><span class="op" id="3398500">.</span><span class="ident" id="3398501">finishedHash</span><span class="op" id="3398513">.</span><span class="ident" id="3398514">clientSum</span><span class="op" id="3398523">(</span><span class="ident" id="3398524">hs</span><span class="op" id="3398526">.</span><span class="ident" id="3398527">masterSecret</span><span class="op" id="3398539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398542">hs</span><span class="op" id="3398544">.</span><span class="ident" id="3398545">finishedHash</span><span class="op" id="3398557">.</span><span class="ident" id="3398558">Write</span><span class="op" id="3398563">(</span><span class="ident" id="3398564">finished</span><span class="op" id="3398572">.</span><span class="ident" id="3398573">marshal</span><span class="op" id="3398580">(</span><span class="op" id="3398581">)</span><span class="op" id="3398582">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398585">c</span><span class="op" id="3398586">.</span><span class="ident" id="3398587">writeRecord</span><span class="op" id="3398598">(</span><span class="ident" id="3398599">recordTypeHandshake</span><span class="op" id="3398618">,</span>&nbsp;<span class="ident" id="3398620">finished</span><span class="op" id="3398628">.</span><span class="ident" id="3398629">marshal</span><span class="op" id="3398636">(</span><span class="op" id="3398637">)</span><span class="op" id="3398638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3398641">copy</span><span class="op" id="3398645">(</span><span class="ident" id="3398646">out</span><span class="op" id="3398649">,</span>&nbsp;<span class="ident" id="3398651">finished</span><span class="op" id="3398659">.</span><span class="ident" id="3398660">verifyData</span><span class="op" id="3398670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398673">return</span>&nbsp;<span class="ident" id="3398680">nil</span><br>
<span class="lineno"></span><span class="op" id="3398684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="comment" id="3398687">//&nbsp;clientSessionCacheKey&nbsp;returns&nbsp;a&nbsp;key&nbsp;used&nbsp;to&nbsp;cache&nbsp;sessionTickets&nbsp;that&nbsp;could</span><br>
<span class="lineno"></span><span class="comment" id="3398766">//&nbsp;be&nbsp;used&nbsp;to&nbsp;resume&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;sessions&nbsp;with&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="3398837">func</span>&nbsp;<span class="ident" id="3398842">clientSessionCacheKey</span><span class="op" id="3398863">(</span><span class="ident" id="3398864">serverAddr</span>&nbsp;<span class="ident" id="3398875">net</span><span class="op" id="3398878">.</span><span class="ident" id="3398879">Addr</span><span class="op" id="3398883">,</span>&nbsp;<span class="ident" id="3398885">config</span>&nbsp;<span class="op" id="3398892">*</span><span class="ident" id="3398893">Config</span><span class="op" id="3398899">)</span>&nbsp;<span class="builtintype" id="3398901">string</span>&nbsp;<span class="op" id="3398908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398911">if</span>&nbsp;<span class="builtinfunc" id="3398914">len</span><span class="op" id="3398917">(</span><span class="ident" id="3398918">config</span><span class="op" id="3398924">.</span><span class="ident" id="3398925">ServerName</span><span class="op" id="3398935">)</span>&nbsp;<span class="op" id="3398937">&gt;</span>&nbsp;<span class="num" id="3398939">0</span>&nbsp;<span class="op" id="3398941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398945">return</span>&nbsp;<span class="ident" id="3398952">config</span><span class="op" id="3398958">.</span><span class="ident" id="3398959">ServerName</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3398971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398974">return</span>&nbsp;<span class="ident" id="3398981">serverAddr</span><span class="op" id="3398991">.</span><span class="ident" id="3398992">String</span><span class="op" id="3398998">(</span><span class="op" id="3398999">)</span><br>
<span class="lineno"></span><span class="op" id="3399001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3399004">//&nbsp;mutualProtocol&nbsp;finds&nbsp;the&nbsp;mutual&nbsp;Next&nbsp;Protocol&nbsp;Negotiation&nbsp;or&nbsp;ALPN&nbsp;protocol</span><br>
<span class="lineno">625</span><span class="comment" id="3399082">//&nbsp;given&nbsp;list&nbsp;of&nbsp;possible&nbsp;protocols&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;the&nbsp;preference&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="3399158">//&nbsp;first&nbsp;list&nbsp;must&nbsp;not&nbsp;be&nbsp;empty.&nbsp;It&nbsp;returns&nbsp;the&nbsp;resulting&nbsp;protocol&nbsp;and&nbsp;flag</span><br>
<span class="lineno"></span><span class="comment" id="3399234">//&nbsp;indicating&nbsp;if&nbsp;the&nbsp;fallback&nbsp;case&nbsp;was&nbsp;reached.</span><br>
<span class="lineno"></span><span class="keyword" id="3399282">func</span>&nbsp;<span class="ident" id="3399287">mutualProtocol</span><span class="op" id="3399301">(</span><span class="ident" id="3399302">protos</span><span class="op" id="3399308">,</span>&nbsp;<span class="ident" id="3399310">preferenceProtos</span>&nbsp;<span class="op" id="3399327">[</span><span class="op" id="3399328">]</span><span class="builtintype" id="3399329">string</span><span class="op" id="3399335">)</span>&nbsp;<span class="op" id="3399337">(</span><span class="builtintype" id="3399338">string</span><span class="op" id="3399344">,</span>&nbsp;<span class="builtintype" id="3399346">bool</span><span class="op" id="3399350">)</span>&nbsp;<span class="op" id="3399352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3399355">for</span>&nbsp;<span class="ident" id="3399359">_</span><span class="op" id="3399360">,</span>&nbsp;<span class="ident" id="3399362">s</span>&nbsp;<span class="op" id="3399364">:=</span>&nbsp;<span class="keyword" id="3399367">range</span>&nbsp;<span class="ident" id="3399373">preferenceProtos</span>&nbsp;<span class="op" id="3399390">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3399394">for</span>&nbsp;<span class="ident" id="3399398">_</span><span class="op" id="3399399">,</span>&nbsp;<span class="ident" id="3399401">c</span>&nbsp;<span class="op" id="3399403">:=</span>&nbsp;<span class="keyword" id="3399406">range</span>&nbsp;<span class="ident" id="3399412">protos</span>&nbsp;<span class="op" id="3399419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3399424">if</span>&nbsp;<span class="ident" id="3399427">s</span>&nbsp;<span class="op" id="3399429">==</span>&nbsp;<span class="ident" id="3399432">c</span>&nbsp;<span class="op" id="3399434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3399440">return</span>&nbsp;<span class="ident" id="3399447">s</span><span class="op" id="3399448">,</span>&nbsp;<span class="builtintype" id="3399450">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3399459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3399463">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3399466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3399470">return</span>&nbsp;<span class="ident" id="3399477">protos</span><span class="op" id="3399483">[</span><span class="num" id="3399484">0</span><span class="op" id="3399485">]</span><span class="op" id="3399486">,</span>&nbsp;<span class="builtintype" id="3399488">true</span><br>
<span class="lineno"></span><span class="op" id="3399493">}</span>
</div>
</body>
</html>
