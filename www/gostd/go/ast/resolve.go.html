<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/ast</h2>
<ul>
<li><a href="/gostd/go/ast/ast.go.html">ast.go</a></li>
<li><a href="/gostd/go/ast/ast_test.go.html">ast_test.go</a></li>
<li><a href="/gostd/go/ast/commentmap.go.html">commentmap.go</a></li>
<li><a href="/gostd/go/ast/commentmap_test.go.html">commentmap_test.go</a></li>
<li><a href="/gostd/go/ast/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/ast/filter.go.html">filter.go</a></li>
<li><a href="/gostd/go/ast/filter_test.go.html">filter_test.go</a></li>
<li><a href="/gostd/go/ast/import.go.html">import.go</a></li>
<li><a href="/gostd/go/ast/print.go.html">print.go</a></li>
<li><a href="/gostd/go/ast/print_test.go.html">print_test.go</a></li>
<li><a href="/gostd/go/ast/resolve.go.html">resolve.go</a></li>
<li><a href="/gostd/go/ast/scope.go.html">scope.go</a></li>
<li><a href="/gostd/go/ast/walk.go.html">walk.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5334227">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5334282">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5334336">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5334387">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;NewPackage.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5334424">package</span>&nbsp;<span class="ident" id="5334432">ast</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5334437">import</span>&nbsp;<span class="op" id="5334444">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5334447">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5334454">&#34;go/scanner&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5334468">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5334480">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="5334490">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="5334493">type</span>&nbsp;<span class="ident" id="5334498">pkgBuilder</span>&nbsp;<span class="keyword" id="5334509">struct</span>&nbsp;<span class="op" id="5334516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334519">fset</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5334526">*</span><span class="ident" id="5334527">token</span><span class="op" id="5334532">.</span><span class="ident" id="5334533">FileSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334542">errors</span>&nbsp;<span class="ident" id="5334549">scanner</span><span class="op" id="5334556">.</span><span class="ident" id="5334557">ErrorList</span><br>
<span class="lineno"></span><span class="op" id="5334567">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="5334570">func</span>&nbsp;<span class="op" id="5334575">(</span><span class="ident" id="5334576">p</span>&nbsp;<span class="op" id="5334578">*</span><span class="ident" id="5334579">pkgBuilder</span><span class="op" id="5334589">)</span>&nbsp;<span class="builtintype" id="5334591">error</span><span class="op" id="5334596">(</span><span class="ident" id="5334597">pos</span>&nbsp;<span class="ident" id="5334601">token</span><span class="op" id="5334606">.</span><span class="ident" id="5334607">Pos</span><span class="op" id="5334610">,</span>&nbsp;<span class="ident" id="5334612">msg</span>&nbsp;<span class="builtintype" id="5334616">string</span><span class="op" id="5334622">)</span>&nbsp;<span class="op" id="5334624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334627">p</span><span class="op" id="5334628">.</span><span class="ident" id="5334629">errors</span><span class="op" id="5334635">.</span><span class="ident" id="5334636">Add</span><span class="op" id="5334639">(</span><span class="ident" id="5334640">p</span><span class="op" id="5334641">.</span><span class="ident" id="5334642">fset</span><span class="op" id="5334646">.</span><span class="ident" id="5334647">Position</span><span class="op" id="5334655">(</span><span class="ident" id="5334656">pos</span><span class="op" id="5334659">)</span><span class="op" id="5334660">,</span>&nbsp;<span class="ident" id="5334662">msg</span><span class="op" id="5334665">)</span><br>
<span class="lineno"></span><span class="op" id="5334667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5334670">func</span>&nbsp;<span class="op" id="5334675">(</span><span class="ident" id="5334676">p</span>&nbsp;<span class="op" id="5334678">*</span><span class="ident" id="5334679">pkgBuilder</span><span class="op" id="5334689">)</span>&nbsp;<span class="ident" id="5334691">errorf</span><span class="op" id="5334697">(</span><span class="ident" id="5334698">pos</span>&nbsp;<span class="ident" id="5334702">token</span><span class="op" id="5334707">.</span><span class="ident" id="5334708">Pos</span><span class="op" id="5334711">,</span>&nbsp;<span class="ident" id="5334713">format</span>&nbsp;<span class="builtintype" id="5334720">string</span><span class="op" id="5334726">,</span>&nbsp;<span class="ident" id="5334728">args</span>&nbsp;<span class="op" id="5334733">...</span><span class="keyword" id="5334736">interface</span><span class="op" id="5334745">{</span><span class="op" id="5334746">}</span><span class="op" id="5334747">)</span>&nbsp;<span class="op" id="5334749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334752">p</span><span class="op" id="5334753">.</span><span class="builtintype" id="5334754">error</span><span class="op" id="5334759">(</span><span class="ident" id="5334760">pos</span><span class="op" id="5334763">,</span>&nbsp;<span class="ident" id="5334765">fmt</span><span class="op" id="5334768">.</span><span class="ident" id="5334769">Sprintf</span><span class="op" id="5334776">(</span><span class="ident" id="5334777">format</span><span class="op" id="5334783">,</span>&nbsp;<span class="ident" id="5334785">args</span><span class="op" id="5334789">...</span><span class="op" id="5334792">)</span><span class="op" id="5334793">)</span><br>
<span class="lineno"></span><span class="op" id="5334795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5334798">func</span>&nbsp;<span class="op" id="5334803">(</span><span class="ident" id="5334804">p</span>&nbsp;<span class="op" id="5334806">*</span><span class="ident" id="5334807">pkgBuilder</span><span class="op" id="5334817">)</span>&nbsp;<span class="ident" id="5334819">declare</span><span class="op" id="5334826">(</span><span class="ident" id="5334827">scope</span><span class="op" id="5334832">,</span>&nbsp;<span class="ident" id="5334834">altScope</span>&nbsp;<span class="op" id="5334843">*</span><span class="ident" id="5334844">Scope</span><span class="op" id="5334849">,</span>&nbsp;<span class="ident" id="5334851">obj</span>&nbsp;<span class="op" id="5334855">*</span><span class="ident" id="5334856">Object</span><span class="op" id="5334862">)</span>&nbsp;<span class="op" id="5334864">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334867">alt</span>&nbsp;<span class="op" id="5334871">:=</span>&nbsp;<span class="ident" id="5334874">scope</span><span class="op" id="5334879">.</span><span class="ident" id="5334880">Insert</span><span class="op" id="5334886">(</span><span class="ident" id="5334887">obj</span><span class="op" id="5334890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5334893">if</span>&nbsp;<span class="ident" id="5334896">alt</span>&nbsp;<span class="op" id="5334900">==</span>&nbsp;<span class="ident" id="5334903">nil</span>&nbsp;<span class="op" id="5334907">&amp;&amp;</span>&nbsp;<span class="ident" id="5334910">altScope</span>&nbsp;<span class="op" id="5334919">!=</span>&nbsp;<span class="ident" id="5334922">nil</span>&nbsp;<span class="op" id="5334926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5334930">//&nbsp;see&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;conflicting&nbsp;declaration&nbsp;in&nbsp;altScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5334989">alt</span>&nbsp;<span class="op" id="5334993">=</span>&nbsp;<span class="ident" id="5334995">altScope</span><span class="op" id="5335003">.</span><span class="ident" id="5335004">Lookup</span><span class="op" id="5335010">(</span><span class="ident" id="5335011">obj</span><span class="op" id="5335014">.</span><span class="ident" id="5335015">Name</span><span class="op" id="5335019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5335022">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335025">if</span>&nbsp;<span class="ident" id="5335028">alt</span>&nbsp;<span class="op" id="5335032">!=</span>&nbsp;<span class="ident" id="5335035">nil</span>&nbsp;<span class="op" id="5335039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5335043">prevDecl</span>&nbsp;<span class="op" id="5335052">:=</span>&nbsp;<span class="string" id="5335055">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335060">if</span>&nbsp;<span class="ident" id="5335063">pos</span>&nbsp;<span class="op" id="5335067">:=</span>&nbsp;<span class="ident" id="5335070">alt</span><span class="op" id="5335073">.</span><span class="ident" id="5335074">Pos</span><span class="op" id="5335077">(</span><span class="op" id="5335078">)</span><span class="op" id="5335079">;</span>&nbsp;<span class="ident" id="5335081">pos</span><span class="op" id="5335084">.</span><span class="ident" id="5335085">IsValid</span><span class="op" id="5335092">(</span><span class="op" id="5335093">)</span>&nbsp;<span class="op" id="5335095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5335100">prevDecl</span>&nbsp;<span class="op" id="5335109">=</span>&nbsp;<span class="ident" id="5335111">fmt</span><span class="op" id="5335114">.</span><span class="ident" id="5335115">Sprintf</span><span class="op" id="5335122">(</span><span class="string" id="5335123">&#34;\n\tprevious&nbsp;declaration&nbsp;at&nbsp;%s&#34;</span><span class="op" id="5335155">,</span>&nbsp;<span class="ident" id="5335157">p</span><span class="op" id="5335158">.</span><span class="ident" id="5335159">fset</span><span class="op" id="5335163">.</span><span class="ident" id="5335164">Position</span><span class="op" id="5335172">(</span><span class="ident" id="5335173">pos</span><span class="op" id="5335176">)</span><span class="op" id="5335177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5335181">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5335185">p</span><span class="op" id="5335186">.</span><span class="builtintype" id="5335187">error</span><span class="op" id="5335192">(</span><span class="ident" id="5335193">obj</span><span class="op" id="5335196">.</span><span class="ident" id="5335197">Pos</span><span class="op" id="5335200">(</span><span class="op" id="5335201">)</span><span class="op" id="5335202">,</span>&nbsp;<span class="ident" id="5335204">fmt</span><span class="op" id="5335207">.</span><span class="ident" id="5335208">Sprintf</span><span class="op" id="5335215">(</span><span class="string" id="5335216">&#34;%s&nbsp;redeclared&nbsp;in&nbsp;this&nbsp;block%s&#34;</span><span class="op" id="5335247">,</span>&nbsp;<span class="ident" id="5335249">obj</span><span class="op" id="5335252">.</span><span class="ident" id="5335253">Name</span><span class="op" id="5335257">,</span>&nbsp;<span class="ident" id="5335259">prevDecl</span><span class="op" id="5335267">)</span><span class="op" id="5335268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5335271">}</span><br>
<span class="lineno"></span><span class="op" id="5335273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5335276">func</span>&nbsp;<span class="ident" id="5335281">resolve</span><span class="op" id="5335288">(</span><span class="ident" id="5335289">scope</span>&nbsp;<span class="op" id="5335295">*</span><span class="ident" id="5335296">Scope</span><span class="op" id="5335301">,</span>&nbsp;<span class="ident" id="5335303">ident</span>&nbsp;<span class="op" id="5335309">*</span><span class="ident" id="5335310">Ident</span><span class="op" id="5335315">)</span>&nbsp;<span class="builtintype" id="5335317">bool</span>&nbsp;<span class="op" id="5335322">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335325">for</span>&nbsp;<span class="op" id="5335329">;</span>&nbsp;<span class="ident" id="5335331">scope</span>&nbsp;<span class="op" id="5335337">!=</span>&nbsp;<span class="ident" id="5335340">nil</span><span class="op" id="5335343">;</span>&nbsp;<span class="ident" id="5335345">scope</span>&nbsp;<span class="op" id="5335351">=</span>&nbsp;<span class="ident" id="5335353">scope</span><span class="op" id="5335358">.</span><span class="ident" id="5335359">Outer</span>&nbsp;<span class="op" id="5335365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335369">if</span>&nbsp;<span class="ident" id="5335372">obj</span>&nbsp;<span class="op" id="5335376">:=</span>&nbsp;<span class="ident" id="5335379">scope</span><span class="op" id="5335384">.</span><span class="ident" id="5335385">Lookup</span><span class="op" id="5335391">(</span><span class="ident" id="5335392">ident</span><span class="op" id="5335397">.</span><span class="ident" id="5335398">Name</span><span class="op" id="5335402">)</span><span class="op" id="5335403">;</span>&nbsp;<span class="ident" id="5335405">obj</span>&nbsp;<span class="op" id="5335409">!=</span>&nbsp;<span class="ident" id="5335412">nil</span>&nbsp;<span class="op" id="5335416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5335421">ident</span><span class="op" id="5335426">.</span><span class="ident" id="5335427">Obj</span>&nbsp;<span class="op" id="5335431">=</span>&nbsp;<span class="ident" id="5335433">obj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335440">return</span>&nbsp;<span class="builtintype" id="5335447">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5335454">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5335457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5335460">return</span>&nbsp;<span class="builtintype" id="5335467">false</span><br>
<span class="lineno"></span><span class="op" id="5335473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5335476">//&nbsp;An&nbsp;Importer&nbsp;resolves&nbsp;import&nbsp;paths&nbsp;to&nbsp;package&nbsp;Objects.</span><br>
<span class="lineno">55</span><span class="comment" id="5335533">//&nbsp;The&nbsp;imports&nbsp;map&nbsp;records&nbsp;the&nbsp;packages&nbsp;already&nbsp;imported,</span><br>
<span class="lineno"></span><span class="comment" id="5335591">//&nbsp;indexed&nbsp;by&nbsp;package&nbsp;id&nbsp;(canonical&nbsp;import&nbsp;path).</span><br>
<span class="lineno"></span><span class="comment" id="5335641">//&nbsp;An&nbsp;Importer&nbsp;must&nbsp;determine&nbsp;the&nbsp;canonical&nbsp;import&nbsp;path&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5335701">//&nbsp;check&nbsp;the&nbsp;map&nbsp;to&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;already&nbsp;present&nbsp;in&nbsp;the&nbsp;imports&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="5335770">//&nbsp;If&nbsp;so,&nbsp;the&nbsp;Importer&nbsp;can&nbsp;return&nbsp;the&nbsp;map&nbsp;entry.&nbsp;&nbsp;Otherwise,&nbsp;the</span><br>
<span class="lineno">60</span><span class="comment" id="5335835">//&nbsp;Importer&nbsp;should&nbsp;load&nbsp;the&nbsp;package&nbsp;data&nbsp;for&nbsp;the&nbsp;given&nbsp;path&nbsp;into</span><br>
<span class="lineno"></span><span class="comment" id="5335900">//&nbsp;a&nbsp;new&nbsp;*Object&nbsp;(pkg),&nbsp;record&nbsp;pkg&nbsp;in&nbsp;the&nbsp;imports&nbsp;map,&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="5335964">//&nbsp;return&nbsp;pkg.</span><br>
<span class="lineno"></span><span class="keyword" id="5335979">type</span>&nbsp;<span class="ident" id="5335984">Importer</span>&nbsp;<span class="keyword" id="5335993">func</span><span class="op" id="5335997">(</span><span class="ident" id="5335998">imports</span>&nbsp;<span class="keyword" id="5336006">map</span><span class="op" id="5336009">[</span><span class="builtintype" id="5336010">string</span><span class="op" id="5336016">]</span><span class="op" id="5336017">*</span><span class="ident" id="5336018">Object</span><span class="op" id="5336024">,</span>&nbsp;<span class="ident" id="5336026">path</span>&nbsp;<span class="builtintype" id="5336031">string</span><span class="op" id="5336037">)</span>&nbsp;<span class="op" id="5336039">(</span><span class="ident" id="5336040">pkg</span>&nbsp;<span class="op" id="5336044">*</span><span class="ident" id="5336045">Object</span><span class="op" id="5336051">,</span>&nbsp;<span class="ident" id="5336053">err</span>&nbsp;<span class="builtintype" id="5336057">error</span><span class="op" id="5336062">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5336065">//&nbsp;NewPackage&nbsp;creates&nbsp;a&nbsp;new&nbsp;Package&nbsp;node&nbsp;from&nbsp;a&nbsp;set&nbsp;of&nbsp;File&nbsp;nodes.&nbsp;It&nbsp;resolves</span><br>
<span class="lineno"></span><span class="comment" id="5336144">//&nbsp;unresolved&nbsp;identifiers&nbsp;across&nbsp;files&nbsp;and&nbsp;updates&nbsp;each&nbsp;file&#39;s&nbsp;Unresolved&nbsp;list</span><br>
<span class="lineno"></span><span class="comment" id="5336223">//&nbsp;accordingly.&nbsp;If&nbsp;a&nbsp;non-nil&nbsp;importer&nbsp;and&nbsp;universe&nbsp;scope&nbsp;are&nbsp;provided,&nbsp;they&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5336303">//&nbsp;used&nbsp;to&nbsp;resolve&nbsp;identifiers&nbsp;not&nbsp;declared&nbsp;in&nbsp;any&nbsp;of&nbsp;the&nbsp;package&nbsp;files.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="5336380">//&nbsp;remaining&nbsp;unresolved&nbsp;identifiers&nbsp;are&nbsp;reported&nbsp;as&nbsp;undeclared.&nbsp;If&nbsp;the&nbsp;files</span><br>
<span class="lineno">70</span><span class="comment" id="5336457">//&nbsp;belong&nbsp;to&nbsp;different&nbsp;packages,&nbsp;one&nbsp;package&nbsp;name&nbsp;is&nbsp;selected&nbsp;and&nbsp;files&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5336534">//&nbsp;different&nbsp;package&nbsp;names&nbsp;are&nbsp;reported&nbsp;and&nbsp;then&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="5336592">//&nbsp;The&nbsp;result&nbsp;is&nbsp;a&nbsp;package&nbsp;node&nbsp;and&nbsp;a&nbsp;scanner.ErrorList&nbsp;if&nbsp;there&nbsp;were&nbsp;errors.</span><br>
<span class="lineno"></span><span class="comment" id="5336670">//</span><br>
<span class="lineno"></span><span class="keyword" id="5336673">func</span>&nbsp;<span class="ident" id="5336678">NewPackage</span><span class="op" id="5336688">(</span><span class="ident" id="5336689">fset</span>&nbsp;<span class="op" id="5336694">*</span><span class="ident" id="5336695">token</span><span class="op" id="5336700">.</span><span class="ident" id="5336701">FileSet</span><span class="op" id="5336708">,</span>&nbsp;<span class="ident" id="5336710">files</span>&nbsp;<span class="keyword" id="5336716">map</span><span class="op" id="5336719">[</span><span class="builtintype" id="5336720">string</span><span class="op" id="5336726">]</span><span class="op" id="5336727">*</span><span class="ident" id="5336728">File</span><span class="op" id="5336732">,</span>&nbsp;<span class="ident" id="5336734">importer</span>&nbsp;<span class="ident" id="5336743">Importer</span><span class="op" id="5336751">,</span>&nbsp;<span class="ident" id="5336753">universe</span>&nbsp;<span class="op" id="5336762">*</span><span class="ident" id="5336763">Scope</span><span class="op" id="5336768">)</span>&nbsp;<span class="op" id="5336770">(</span><span class="op" id="5336771">*</span><span class="ident" id="5336772">Package</span><span class="op" id="5336779">,</span>&nbsp;<span class="builtintype" id="5336781">error</span><span class="op" id="5336786">)</span>&nbsp;<span class="op" id="5336788">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5336791">var</span>&nbsp;<span class="ident" id="5336795">p</span>&nbsp;<span class="ident" id="5336797">pkgBuilder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336809">p</span><span class="op" id="5336810">.</span><span class="ident" id="5336811">fset</span>&nbsp;<span class="op" id="5336816">=</span>&nbsp;<span class="ident" id="5336818">fset</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5336825">//&nbsp;complete&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336852">pkgName</span>&nbsp;<span class="op" id="5336860">:=</span>&nbsp;<span class="string" id="5336863">&#34;&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5336867">pkgScope</span>&nbsp;<span class="op" id="5336876">:=</span>&nbsp;<span class="ident" id="5336879">NewScope</span><span class="op" id="5336887">(</span><span class="ident" id="5336888">universe</span><span class="op" id="5336896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5336899">for</span>&nbsp;<span class="ident" id="5336903">_</span><span class="op" id="5336904">,</span>&nbsp;<span class="ident" id="5336906">file</span>&nbsp;<span class="op" id="5336911">:=</span>&nbsp;<span class="keyword" id="5336914">range</span>&nbsp;<span class="ident" id="5336920">files</span>&nbsp;<span class="op" id="5336926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5336930">//&nbsp;package&nbsp;names&nbsp;must&nbsp;match</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5336960">switch</span>&nbsp;<span class="ident" id="5336967">name</span>&nbsp;<span class="op" id="5336972">:=</span>&nbsp;<span class="ident" id="5336975">file</span><span class="op" id="5336979">.</span><span class="ident" id="5336980">Name</span><span class="op" id="5336984">.</span><span class="ident" id="5336985">Name</span><span class="op" id="5336989">;</span>&nbsp;<span class="op" id="5336991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5336995">case</span>&nbsp;<span class="ident" id="5337000">pkgName</span>&nbsp;<span class="op" id="5337008">==</span>&nbsp;<span class="string" id="5337011">&#34;&#34;</span><span class="op" id="5337013">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5337018">pkgName</span>&nbsp;<span class="op" id="5337026">=</span>&nbsp;<span class="ident" id="5337028">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5337035">case</span>&nbsp;<span class="ident" id="5337040">name</span>&nbsp;<span class="op" id="5337045">!=</span>&nbsp;<span class="ident" id="5337048">pkgName</span><span class="op" id="5337055">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5337060">p</span><span class="op" id="5337061">.</span><span class="ident" id="5337062">errorf</span><span class="op" id="5337068">(</span><span class="ident" id="5337069">file</span><span class="op" id="5337073">.</span><span class="ident" id="5337074">Package</span><span class="op" id="5337081">,</span>&nbsp;<span class="string" id="5337083">&#34;package&nbsp;%s;&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="5337108">,</span>&nbsp;<span class="ident" id="5337110">name</span><span class="op" id="5337114">,</span>&nbsp;<span class="ident" id="5337116">pkgName</span><span class="op" id="5337123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5337128">continue</span>&nbsp;<span class="comment" id="5337137">//&nbsp;ignore&nbsp;this&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5337159">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5337164">//&nbsp;collect&nbsp;top-level&nbsp;file&nbsp;objects&nbsp;in&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5337217">for</span>&nbsp;<span class="ident" id="5337221">_</span><span class="op" id="5337222">,</span>&nbsp;<span class="ident" id="5337224">obj</span>&nbsp;<span class="op" id="5337228">:=</span>&nbsp;<span class="keyword" id="5337231">range</span>&nbsp;<span class="ident" id="5337237">file</span><span class="op" id="5337241">.</span><span class="ident" id="5337242">Scope</span><span class="op" id="5337247">.</span><span class="ident" id="5337248">Objects</span>&nbsp;<span class="op" id="5337256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5337261">p</span><span class="op" id="5337262">.</span><span class="ident" id="5337263">declare</span><span class="op" id="5337270">(</span><span class="ident" id="5337271">pkgScope</span><span class="op" id="5337279">,</span>&nbsp;<span class="ident" id="5337281">nil</span><span class="op" id="5337284">,</span>&nbsp;<span class="ident" id="5337286">obj</span><span class="op" id="5337289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5337293">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5337296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5337300">//&nbsp;package&nbsp;global&nbsp;mapping&nbsp;of&nbsp;imported&nbsp;package&nbsp;ids&nbsp;to&nbsp;package&nbsp;objects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5337370">imports</span>&nbsp;<span class="op" id="5337378">:=</span>&nbsp;<span class="builtinfunc" id="5337381">make</span><span class="op" id="5337385">(</span><span class="keyword" id="5337386">map</span><span class="op" id="5337389">[</span><span class="builtintype" id="5337390">string</span><span class="op" id="5337396">]</span><span class="op" id="5337397">*</span><span class="ident" id="5337398">Object</span><span class="op" id="5337404">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5337408">//&nbsp;complete&nbsp;file&nbsp;scopes&nbsp;with&nbsp;imports&nbsp;and&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5337470">for</span>&nbsp;<span class="ident" id="5337474">_</span><span class="op" id="5337475">,</span>&nbsp;<span class="ident" id="5337477">file</span>&nbsp;<span class="op" id="5337482">:=</span>&nbsp;<span class="keyword" id="5337485">range</span>&nbsp;<span class="ident" id="5337491">files</span>&nbsp;<span class="op" id="5337497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5337501">//&nbsp;ignore&nbsp;file&nbsp;if&nbsp;it&nbsp;belongs&nbsp;to&nbsp;a&nbsp;different&nbsp;package</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5337555">//&nbsp;(error&nbsp;has&nbsp;already&nbsp;been&nbsp;reported)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5337594">if</span>&nbsp;<span class="ident" id="5337597">file</span><span class="op" id="5337601">.</span><span class="ident" id="5337602">Name</span><span class="op" id="5337606">.</span><span class="ident" id="5337607">Name</span>&nbsp;<span class="op" id="5337612">!=</span>&nbsp;<span class="ident" id="5337615">pkgName</span>&nbsp;<span class="op" id="5337623">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5337628">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5337639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5337644">//&nbsp;build&nbsp;file&nbsp;scope&nbsp;by&nbsp;processing&nbsp;all&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5337692">importErrors</span>&nbsp;<span class="op" id="5337705">:=</span>&nbsp;<span class="builtintype" id="5337708">false</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5337716">fileScope</span>&nbsp;<span class="op" id="5337726">:=</span>&nbsp;<span class="ident" id="5337729">NewScope</span><span class="op" id="5337737">(</span><span class="ident" id="5337738">pkgScope</span><span class="op" id="5337746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5337750">for</span>&nbsp;<span class="ident" id="5337754">_</span><span class="op" id="5337755">,</span>&nbsp;<span class="ident" id="5337757">spec</span>&nbsp;<span class="op" id="5337762">:=</span>&nbsp;<span class="keyword" id="5337765">range</span>&nbsp;<span class="ident" id="5337771">file</span><span class="op" id="5337775">.</span><span class="ident" id="5337776">Imports</span>&nbsp;<span class="op" id="5337784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5337789">if</span>&nbsp;<span class="ident" id="5337792">importer</span>&nbsp;<span class="op" id="5337801">==</span>&nbsp;<span class="ident" id="5337804">nil</span>&nbsp;<span class="op" id="5337808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5337814">importErrors</span>&nbsp;<span class="op" id="5337827">=</span>&nbsp;<span class="builtintype" id="5337829">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5337838">continue</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5337850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5337855">path</span><span class="op" id="5337859">,</span>&nbsp;<span class="ident" id="5337861">_</span>&nbsp;<span class="op" id="5337863">:=</span>&nbsp;<span class="ident" id="5337866">strconv</span><span class="op" id="5337873">.</span><span class="ident" id="5337874">Unquote</span><span class="op" id="5337881">(</span><span class="ident" id="5337882">spec</span><span class="op" id="5337886">.</span><span class="ident" id="5337887">Path</span><span class="op" id="5337891">.</span><span class="ident" id="5337892">Value</span><span class="op" id="5337897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5337902">pkg</span><span class="op" id="5337905">,</span>&nbsp;<span class="ident" id="5337907">err</span>&nbsp;<span class="op" id="5337911">:=</span>&nbsp;<span class="ident" id="5337914">importer</span><span class="op" id="5337922">(</span><span class="ident" id="5337923">imports</span><span class="op" id="5337930">,</span>&nbsp;<span class="ident" id="5337932">path</span><span class="op" id="5337936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5337941">if</span>&nbsp;<span class="ident" id="5337944">err</span>&nbsp;<span class="op" id="5337948">!=</span>&nbsp;<span class="ident" id="5337951">nil</span>&nbsp;<span class="op" id="5337955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5337961">p</span><span class="op" id="5337962">.</span><span class="ident" id="5337963">errorf</span><span class="op" id="5337969">(</span><span class="ident" id="5337970">spec</span><span class="op" id="5337974">.</span><span class="ident" id="5337975">Path</span><span class="op" id="5337979">.</span><span class="ident" id="5337980">Pos</span><span class="op" id="5337983">(</span><span class="op" id="5337984">)</span><span class="op" id="5337985">,</span>&nbsp;<span class="string" id="5337987">&#34;could&nbsp;not&nbsp;import&nbsp;%s&nbsp;(%s)&#34;</span><span class="op" id="5338013">,</span>&nbsp;<span class="ident" id="5338015">path</span><span class="op" id="5338019">,</span>&nbsp;<span class="ident" id="5338021">err</span><span class="op" id="5338024">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5338030">importErrors</span>&nbsp;<span class="op" id="5338043">=</span>&nbsp;<span class="builtintype" id="5338045">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5338054">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5338066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5338071">//&nbsp;TODO(gri)&nbsp;If&nbsp;a&nbsp;local&nbsp;package&nbsp;name&nbsp;!=&nbsp;&#34;.&#34;&nbsp;is&nbsp;provided,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5338131">//&nbsp;global&nbsp;identifier&nbsp;resolution&nbsp;could&nbsp;proceed&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5338192">//&nbsp;import&nbsp;failed.&nbsp;Consider&nbsp;adjusting&nbsp;the&nbsp;logic&nbsp;here&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5338255">//&nbsp;local&nbsp;name&nbsp;overrides&nbsp;imported&nbsp;package&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5338304">name</span>&nbsp;<span class="op" id="5338309">:=</span>&nbsp;<span class="ident" id="5338312">pkg</span><span class="op" id="5338315">.</span><span class="ident" id="5338316">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5338324">if</span>&nbsp;<span class="ident" id="5338327">spec</span><span class="op" id="5338331">.</span><span class="ident" id="5338332">Name</span>&nbsp;<span class="op" id="5338337">!=</span>&nbsp;<span class="ident" id="5338340">nil</span>&nbsp;<span class="op" id="5338344">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5338350">name</span>&nbsp;<span class="op" id="5338355">=</span>&nbsp;<span class="ident" id="5338357">spec</span><span class="op" id="5338361">.</span><span class="ident" id="5338362">Name</span><span class="op" id="5338366">.</span><span class="ident" id="5338367">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5338375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5338381">//&nbsp;add&nbsp;import&nbsp;to&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5338412">if</span>&nbsp;<span class="ident" id="5338415">name</span>&nbsp;<span class="op" id="5338420">==</span>&nbsp;<span class="string" id="5338423">&#34;.&#34;</span>&nbsp;<span class="op" id="5338427">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5338433">//&nbsp;merge&nbsp;imported&nbsp;scope&nbsp;with&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5338477">for</span>&nbsp;<span class="ident" id="5338481">_</span><span class="op" id="5338482">,</span>&nbsp;<span class="ident" id="5338484">obj</span>&nbsp;<span class="op" id="5338488">:=</span>&nbsp;<span class="keyword" id="5338491">range</span>&nbsp;<span class="ident" id="5338497">pkg</span><span class="op" id="5338500">.</span><span class="ident" id="5338501">Data</span><span class="op" id="5338505">.</span><span class="op" id="5338506">(</span><span class="op" id="5338507">*</span><span class="ident" id="5338508">Scope</span><span class="op" id="5338513">)</span><span class="op" id="5338514">.</span><span class="ident" id="5338515">Objects</span>&nbsp;<span class="op" id="5338523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5338530">p</span><span class="op" id="5338531">.</span><span class="ident" id="5338532">declare</span><span class="op" id="5338539">(</span><span class="ident" id="5338540">fileScope</span><span class="op" id="5338549">,</span>&nbsp;<span class="ident" id="5338551">pkgScope</span><span class="op" id="5338559">,</span>&nbsp;<span class="ident" id="5338561">obj</span><span class="op" id="5338564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5338570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5338575">}</span>&nbsp;<span class="keyword" id="5338577">else</span>&nbsp;<span class="keyword" id="5338582">if</span>&nbsp;<span class="ident" id="5338585">name</span>&nbsp;<span class="op" id="5338590">!=</span>&nbsp;<span class="string" id="5338593">&#34;_&#34;</span>&nbsp;<span class="op" id="5338597">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5338603">//&nbsp;declare&nbsp;imported&nbsp;package&nbsp;object&nbsp;in&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5338656">//&nbsp;(do&nbsp;not&nbsp;re-use&nbsp;pkg&nbsp;in&nbsp;the&nbsp;file&nbsp;scope&nbsp;but&nbsp;create</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5338711">//&nbsp;a&nbsp;new&nbsp;object&nbsp;instead;&nbsp;the&nbsp;Decl&nbsp;field&nbsp;is&nbsp;different</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5338768">//&nbsp;for&nbsp;different&nbsp;files)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5338796">obj</span>&nbsp;<span class="op" id="5338800">:=</span>&nbsp;<span class="ident" id="5338803">NewObj</span><span class="op" id="5338809">(</span><span class="ident" id="5338810">Pkg</span><span class="op" id="5338813">,</span>&nbsp;<span class="ident" id="5338815">name</span><span class="op" id="5338819">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5338825">obj</span><span class="op" id="5338828">.</span><span class="ident" id="5338829">Decl</span>&nbsp;<span class="op" id="5338834">=</span>&nbsp;<span class="ident" id="5338836">spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5338845">obj</span><span class="op" id="5338848">.</span><span class="ident" id="5338849">Data</span>&nbsp;<span class="op" id="5338854">=</span>&nbsp;<span class="ident" id="5338856">pkg</span><span class="op" id="5338859">.</span><span class="ident" id="5338860">Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5338869">p</span><span class="op" id="5338870">.</span><span class="ident" id="5338871">declare</span><span class="op" id="5338878">(</span><span class="ident" id="5338879">fileScope</span><span class="op" id="5338888">,</span>&nbsp;<span class="ident" id="5338890">pkgScope</span><span class="op" id="5338898">,</span>&nbsp;<span class="ident" id="5338900">obj</span><span class="op" id="5338903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5338908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5338912">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5338917">//&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5338942">if</span>&nbsp;<span class="ident" id="5338945">importErrors</span>&nbsp;<span class="op" id="5338958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5338963">//&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;universe&nbsp;scope&nbsp;without&nbsp;correct&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5339022">//&nbsp;(objects&nbsp;in&nbsp;the&nbsp;universe&nbsp;may&nbsp;be&nbsp;shadowed&nbsp;by&nbsp;imports;</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5339081">//&nbsp;with&nbsp;missing&nbsp;imports,&nbsp;identifiers&nbsp;might&nbsp;get&nbsp;resolved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5339140">//&nbsp;incorrectly&nbsp;to&nbsp;universe&nbsp;objects)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5339179">pkgScope</span><span class="op" id="5339187">.</span><span class="ident" id="5339188">Outer</span>&nbsp;<span class="op" id="5339194">=</span>&nbsp;<span class="ident" id="5339196">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5339202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5339206">i</span>&nbsp;<span class="op" id="5339208">:=</span>&nbsp;<span class="num" id="5339211">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5339215">for</span>&nbsp;<span class="ident" id="5339219">_</span><span class="op" id="5339220">,</span>&nbsp;<span class="ident" id="5339222">ident</span>&nbsp;<span class="op" id="5339228">:=</span>&nbsp;<span class="keyword" id="5339231">range</span>&nbsp;<span class="ident" id="5339237">file</span><span class="op" id="5339241">.</span><span class="ident" id="5339242">Unresolved</span>&nbsp;<span class="op" id="5339253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5339258">if</span>&nbsp;<span class="op" id="5339261">!</span><span class="ident" id="5339262">resolve</span><span class="op" id="5339269">(</span><span class="ident" id="5339270">fileScope</span><span class="op" id="5339279">,</span>&nbsp;<span class="ident" id="5339281">ident</span><span class="op" id="5339286">)</span>&nbsp;<span class="op" id="5339288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5339294">p</span><span class="op" id="5339295">.</span><span class="ident" id="5339296">errorf</span><span class="op" id="5339302">(</span><span class="ident" id="5339303">ident</span><span class="op" id="5339308">.</span><span class="ident" id="5339309">Pos</span><span class="op" id="5339312">(</span><span class="op" id="5339313">)</span><span class="op" id="5339314">,</span>&nbsp;<span class="string" id="5339316">&#34;undeclared&nbsp;name:&nbsp;%s&#34;</span><span class="op" id="5339337">,</span>&nbsp;<span class="ident" id="5339339">ident</span><span class="op" id="5339344">.</span><span class="ident" id="5339345">Name</span><span class="op" id="5339349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5339355">file</span><span class="op" id="5339359">.</span><span class="ident" id="5339360">Unresolved</span><span class="op" id="5339370">[</span><span class="ident" id="5339371">i</span><span class="op" id="5339372">]</span>&nbsp;<span class="op" id="5339374">=</span>&nbsp;<span class="ident" id="5339376">ident</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5339386">i</span><span class="op" id="5339387">++</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5339393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5339398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5339402">file</span><span class="op" id="5339406">.</span><span class="ident" id="5339407">Unresolved</span>&nbsp;<span class="op" id="5339418">=</span>&nbsp;<span class="ident" id="5339420">file</span><span class="op" id="5339424">.</span><span class="ident" id="5339425">Unresolved</span><span class="op" id="5339435">[</span><span class="num" id="5339436">0</span><span class="op" id="5339437">:</span><span class="ident" id="5339438">i</span><span class="op" id="5339439">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5339443">pkgScope</span><span class="op" id="5339451">.</span><span class="ident" id="5339452">Outer</span>&nbsp;<span class="op" id="5339458">=</span>&nbsp;<span class="ident" id="5339460">universe</span>&nbsp;<span class="comment" id="5339469">//&nbsp;reset&nbsp;universe&nbsp;scope</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5339494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5339498">p</span><span class="op" id="5339499">.</span><span class="ident" id="5339500">errors</span><span class="op" id="5339506">.</span><span class="ident" id="5339507">Sort</span><span class="op" id="5339511">(</span><span class="op" id="5339512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5339515">return</span>&nbsp;<span class="op" id="5339522">&amp;</span><span class="ident" id="5339523">Package</span><span class="op" id="5339530">{</span><span class="ident" id="5339531">pkgName</span><span class="op" id="5339538">,</span>&nbsp;<span class="ident" id="5339540">pkgScope</span><span class="op" id="5339548">,</span>&nbsp;<span class="ident" id="5339550">imports</span><span class="op" id="5339557">,</span>&nbsp;<span class="ident" id="5339559">files</span><span class="op" id="5339564">}</span><span class="op" id="5339565">,</span>&nbsp;<span class="ident" id="5339567">p</span><span class="op" id="5339568">.</span><span class="ident" id="5339569">errors</span><span class="op" id="5339575">.</span><span class="ident" id="5339576">Err</span><span class="op" id="5339579">(</span><span class="op" id="5339580">)</span><br>
<span class="lineno"></span><span class="op" id="5339582">}</span>
</div>
</body>
</html>
