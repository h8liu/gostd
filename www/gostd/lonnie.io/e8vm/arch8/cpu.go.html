<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="keyword" id="5046470">package</span>&nbsp;<span class="ident" id="5046478">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5046485">//&nbsp;Inst&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;executing&nbsp;one&nbsp;single&nbsp;instruction</span><br>
<span class="lineno"></span><span class="keyword" id="5046546">type</span>&nbsp;<span class="ident" id="5046551">inst</span>&nbsp;<span class="keyword" id="5046556">interface</span>&nbsp;<span class="op" id="5046566">{</span><br>
<span class="lineno">5</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046569">I</span><span class="op" id="5046570">(</span><span class="ident" id="5046571">cpu</span>&nbsp;<span class="op" id="5046575">*</span><span class="ident" id="5046576">cpu</span><span class="op" id="5046579">,</span>&nbsp;<span class="ident" id="5046581">in</span>&nbsp;<span class="builtintype" id="5046584">uint32</span><span class="op" id="5046590">)</span>&nbsp;<span class="op" id="5046592">*</span><span class="ident" id="5046593">Excep</span><br>
<span class="lineno"></span><span class="op" id="5046599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5046602">//&nbsp;CPU&nbsp;defines&nbsp;the&nbsp;structure&nbsp;of&nbsp;a&nbsp;processing&nbsp;unit.</span><br>
<span class="lineno"></span><span class="keyword" id="5046653">type</span>&nbsp;<span class="ident" id="5046658">cpu</span>&nbsp;<span class="keyword" id="5046662">struct</span>&nbsp;<span class="op" id="5046669">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046672">regs</span>&nbsp;<span class="op" id="5046677">[</span><span class="op" id="5046678">]</span><span class="builtintype" id="5046679">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046687">ring</span>&nbsp;<span class="builtintype" id="5046692">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046699">phyMem</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5046709">*</span><span class="ident" id="5046710">phyMemory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046721">virtMem</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5046731">*</span><span class="ident" id="5046732">virtMemory</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046744">interrupt</span>&nbsp;<span class="op" id="5046754">*</span><span class="ident" id="5046755">interrupt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046767">inst</span>&nbsp;&nbsp;<span class="ident" id="5046773">inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5046779">index</span>&nbsp;<span class="builtintype" id="5046785">byte</span><br>
<span class="lineno"></span><span class="op" id="5046790">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="5046793">//&nbsp;InitPC&nbsp;points&nbsp;the&nbsp;default&nbsp;starting&nbsp;value&nbsp;of&nbsp;the&nbsp;program&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="5046861">const</span>&nbsp;<span class="ident" id="5046867">InitPC</span>&nbsp;<span class="op" id="5046874">=</span>&nbsp;<span class="num" id="5046876">0x8000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5046884">//&nbsp;NewCPU&nbsp;creates&nbsp;a&nbsp;CPU&nbsp;with&nbsp;memroy&nbsp;and&nbsp;instruction&nbsp;binding</span><br>
<span class="lineno">25</span><span class="keyword" id="5046944">func</span>&nbsp;<span class="ident" id="5046949">newCPU</span><span class="op" id="5046955">(</span><span class="ident" id="5046956">mem</span>&nbsp;<span class="op" id="5046960">*</span><span class="ident" id="5046961">phyMemory</span><span class="op" id="5046970">,</span>&nbsp;<span class="ident" id="5046972">i</span>&nbsp;<span class="ident" id="5046974">inst</span><span class="op" id="5046978">,</span>&nbsp;<span class="ident" id="5046980">index</span>&nbsp;<span class="builtintype" id="5046986">byte</span><span class="op" id="5046990">)</span>&nbsp;<span class="op" id="5046992">*</span><span class="ident" id="5046993">cpu</span>&nbsp;<span class="op" id="5046997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047000">if</span>&nbsp;<span class="ident" id="5047003">index</span>&nbsp;<span class="op" id="5047009">&gt;=</span>&nbsp;<span class="num" id="5047012">32</span>&nbsp;<span class="op" id="5047015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5047019">panic</span><span class="op" id="5047024">(</span><span class="string" id="5047025">&#34;too&nbsp;many&nbsp;cores&#34;</span><span class="op" id="5047041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047048">ret</span>&nbsp;<span class="op" id="5047052">:=</span>&nbsp;<span class="builtinfunc" id="5047055">new</span><span class="op" id="5047058">(</span><span class="ident" id="5047059">cpu</span><span class="op" id="5047062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047065">ret</span><span class="op" id="5047068">.</span><span class="ident" id="5047069">regs</span>&nbsp;<span class="op" id="5047074">=</span>&nbsp;<span class="ident" id="5047076">makeRegs</span><span class="op" id="5047084">(</span><span class="op" id="5047085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047088">ret</span><span class="op" id="5047091">.</span><span class="ident" id="5047092">phyMem</span>&nbsp;<span class="op" id="5047099">=</span>&nbsp;<span class="ident" id="5047101">mem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047106">ret</span><span class="op" id="5047109">.</span><span class="ident" id="5047110">virtMem</span>&nbsp;<span class="op" id="5047118">=</span>&nbsp;<span class="ident" id="5047120">newVirtMemory</span><span class="op" id="5047133">(</span><span class="ident" id="5047134">ret</span><span class="op" id="5047137">.</span><span class="ident" id="5047138">phyMem</span><span class="op" id="5047144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047147">ret</span><span class="op" id="5047150">.</span><span class="ident" id="5047151">index</span>&nbsp;<span class="op" id="5047157">=</span>&nbsp;<span class="ident" id="5047159">index</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047167">intPage</span>&nbsp;<span class="op" id="5047175">:=</span>&nbsp;<span class="ident" id="5047178">ret</span><span class="op" id="5047181">.</span><span class="ident" id="5047182">phyMem</span><span class="op" id="5047188">.</span><span class="ident" id="5047189">Page</span><span class="op" id="5047193">(</span><span class="ident" id="5047194">pageInterrupt</span><span class="op" id="5047207">)</span>&nbsp;<span class="comment" id="5047209">//&nbsp;page&nbsp;1&nbsp;is&nbsp;the&nbsp;interrupt&nbsp;page</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047242">if</span>&nbsp;<span class="ident" id="5047245">intPage</span>&nbsp;<span class="op" id="5047253">==</span>&nbsp;<span class="ident" id="5047256">nil</span>&nbsp;<span class="op" id="5047260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5047264">panic</span><span class="op" id="5047269">(</span><span class="string" id="5047270">&#34;memory&nbsp;too&nbsp;small&#34;</span><span class="op" id="5047288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047291">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047294">ret</span><span class="op" id="5047297">.</span><span class="ident" id="5047298">interrupt</span>&nbsp;<span class="op" id="5047308">=</span>&nbsp;<span class="ident" id="5047310">newInterrupt</span><span class="op" id="5047322">(</span><span class="ident" id="5047323">intPage</span><span class="op" id="5047330">,</span>&nbsp;<span class="ident" id="5047332">index</span><span class="op" id="5047337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047340">ret</span><span class="op" id="5047343">.</span><span class="ident" id="5047344">inst</span>&nbsp;<span class="op" id="5047349">=</span>&nbsp;<span class="ident" id="5047351">i</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047355">ret</span><span class="op" id="5047358">.</span><span class="ident" id="5047359">regs</span><span class="op" id="5047363">[</span><span class="ident" id="5047364">PC</span><span class="op" id="5047366">]</span>&nbsp;<span class="op" id="5047368">=</span>&nbsp;<span class="ident" id="5047370">InitPC</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047379">return</span>&nbsp;<span class="ident" id="5047386">ret</span><br>
<span class="lineno"></span><span class="op" id="5047390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5047393">//&nbsp;UserMode&nbsp;returns&nbsp;trun&nbsp;when&nbsp;the&nbsp;CPU&nbsp;is&nbsp;in&nbsp;user&nbsp;mode.</span><br>
<span class="lineno"></span><span class="keyword" id="5047448">func</span>&nbsp;<span class="op" id="5047453">(</span><span class="ident" id="5047454">c</span>&nbsp;<span class="op" id="5047456">*</span><span class="ident" id="5047457">cpu</span><span class="op" id="5047460">)</span>&nbsp;<span class="ident" id="5047462">UserMode</span><span class="op" id="5047470">(</span><span class="op" id="5047471">)</span>&nbsp;<span class="builtintype" id="5047473">bool</span>&nbsp;<span class="op" id="5047478">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047481">return</span>&nbsp;<span class="ident" id="5047488">c</span><span class="op" id="5047489">.</span><span class="ident" id="5047490">ring</span>&nbsp;<span class="op" id="5047495">&gt;</span>&nbsp;<span class="num" id="5047497">0</span><br>
<span class="lineno"></span><span class="op" id="5047499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5047502">//&nbsp;Reset&nbsp;resets&nbsp;the&nbsp;CPU&#39;s&nbsp;internal&nbsp;states,&nbsp;i.e.,&nbsp;registers,</span><br>
<span class="lineno"></span><span class="comment" id="5047562">//&nbsp;the&nbsp;page&nbsp;table,&nbsp;and&nbsp;disables&nbsp;interrupt</span><br>
<span class="lineno">55</span><span class="keyword" id="5047604">func</span>&nbsp;<span class="op" id="5047609">(</span><span class="ident" id="5047610">c</span>&nbsp;<span class="op" id="5047612">*</span><span class="ident" id="5047613">cpu</span><span class="op" id="5047616">)</span>&nbsp;<span class="ident" id="5047618">Reset</span><span class="op" id="5047623">(</span><span class="op" id="5047624">)</span>&nbsp;<span class="op" id="5047626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047629">for</span>&nbsp;<span class="ident" id="5047633">i</span>&nbsp;<span class="op" id="5047635">:=</span>&nbsp;<span class="num" id="5047638">0</span><span class="op" id="5047639">;</span>&nbsp;<span class="ident" id="5047641">i</span>&nbsp;<span class="op" id="5047643">&lt;</span>&nbsp;<span class="ident" id="5047645">Nreg</span><span class="op" id="5047649">;</span>&nbsp;<span class="ident" id="5047651">i</span><span class="op" id="5047652">++</span>&nbsp;<span class="op" id="5047655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047659">c</span><span class="op" id="5047660">.</span><span class="ident" id="5047661">regs</span><span class="op" id="5047665">[</span><span class="ident" id="5047666">i</span><span class="op" id="5047667">]</span>&nbsp;<span class="op" id="5047669">=</span>&nbsp;<span class="num" id="5047671">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047677">c</span><span class="op" id="5047678">.</span><span class="ident" id="5047679">regs</span><span class="op" id="5047683">[</span><span class="ident" id="5047684">PC</span><span class="op" id="5047686">]</span>&nbsp;<span class="op" id="5047688">=</span>&nbsp;<span class="ident" id="5047690">InitPC</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047698">c</span><span class="op" id="5047699">.</span><span class="ident" id="5047700">virtMem</span><span class="op" id="5047707">.</span><span class="ident" id="5047708">SetTable</span><span class="op" id="5047716">(</span><span class="num" id="5047717">0</span><span class="op" id="5047718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047721">c</span><span class="op" id="5047722">.</span><span class="ident" id="5047723">ring</span>&nbsp;<span class="op" id="5047728">=</span>&nbsp;<span class="num" id="5047730">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047733">c</span><span class="op" id="5047734">.</span><span class="ident" id="5047735">interrupt</span><span class="op" id="5047744">.</span><span class="ident" id="5047745">Disable</span><span class="op" id="5047752">(</span><span class="op" id="5047753">)</span><br>
<span class="lineno"></span><span class="op" id="5047755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="5047758">func</span>&nbsp;<span class="op" id="5047763">(</span><span class="ident" id="5047764">c</span>&nbsp;<span class="op" id="5047766">*</span><span class="ident" id="5047767">cpu</span><span class="op" id="5047770">)</span>&nbsp;<span class="ident" id="5047772">tick</span><span class="op" id="5047776">(</span><span class="op" id="5047777">)</span>&nbsp;<span class="op" id="5047779">*</span><span class="ident" id="5047780">Excep</span>&nbsp;<span class="op" id="5047786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047789">pc</span>&nbsp;<span class="op" id="5047792">:=</span>&nbsp;<span class="ident" id="5047795">c</span><span class="op" id="5047796">.</span><span class="ident" id="5047797">regs</span><span class="op" id="5047801">[</span><span class="ident" id="5047802">PC</span><span class="op" id="5047804">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047807">inst</span><span class="op" id="5047811">,</span>&nbsp;<span class="ident" id="5047813">e</span>&nbsp;<span class="op" id="5047815">:=</span>&nbsp;<span class="ident" id="5047818">c</span><span class="op" id="5047819">.</span><span class="ident" id="5047820">readWord</span><span class="op" id="5047828">(</span><span class="ident" id="5047829">pc</span><span class="op" id="5047831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047834">if</span>&nbsp;<span class="ident" id="5047837">e</span>&nbsp;<span class="op" id="5047839">!=</span>&nbsp;<span class="ident" id="5047842">nil</span>&nbsp;<span class="op" id="5047846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047850">return</span>&nbsp;<span class="ident" id="5047857">e</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5047860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047864">c</span><span class="op" id="5047865">.</span><span class="ident" id="5047866">regs</span><span class="op" id="5047870">[</span><span class="ident" id="5047871">PC</span><span class="op" id="5047873">]</span>&nbsp;<span class="op" id="5047875">=</span>&nbsp;<span class="ident" id="5047877">pc</span>&nbsp;<span class="op" id="5047880">+</span>&nbsp;<span class="num" id="5047882">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047885">if</span>&nbsp;<span class="ident" id="5047888">c</span><span class="op" id="5047889">.</span><span class="ident" id="5047890">inst</span>&nbsp;<span class="op" id="5047895">!=</span>&nbsp;<span class="ident" id="5047898">nil</span>&nbsp;<span class="op" id="5047902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047906">e</span>&nbsp;<span class="op" id="5047908">=</span>&nbsp;<span class="ident" id="5047910">c</span><span class="op" id="5047911">.</span><span class="ident" id="5047912">inst</span><span class="op" id="5047916">.</span><span class="ident" id="5047917">I</span><span class="op" id="5047918">(</span><span class="ident" id="5047919">c</span><span class="op" id="5047920">,</span>&nbsp;<span class="ident" id="5047922">inst</span><span class="op" id="5047926">)</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047931">if</span>&nbsp;<span class="ident" id="5047934">e</span>&nbsp;<span class="op" id="5047936">!=</span>&nbsp;<span class="ident" id="5047939">nil</span>&nbsp;<span class="op" id="5047943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5047948">c</span><span class="op" id="5047949">.</span><span class="ident" id="5047950">regs</span><span class="op" id="5047954">[</span><span class="ident" id="5047955">PC</span><span class="op" id="5047957">]</span>&nbsp;<span class="op" id="5047959">=</span>&nbsp;<span class="ident" id="5047961">pc</span>&nbsp;<span class="comment" id="5047964">//&nbsp;restore&nbsp;saved&nbsp;original&nbsp;PC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5047996">return</span>&nbsp;<span class="ident" id="5048003">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5048007">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5048010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5048014">return</span>&nbsp;<span class="ident" id="5048021">nil</span><br>
<span class="lineno"></span><span class="op" id="5048025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="5048028">const</span>&nbsp;<span class="op" id="5048034">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048037">intFrameSP</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5048050">=</span>&nbsp;<span class="num" id="5048052">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048055">intFrameRET</span>&nbsp;&nbsp;<span class="op" id="5048068">=</span>&nbsp;<span class="num" id="5048070">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048073">intFrameArg</span>&nbsp;&nbsp;<span class="op" id="5048086">=</span>&nbsp;<span class="num" id="5048088">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048091">intFrameCode</span>&nbsp;<span class="op" id="5048104">=</span>&nbsp;<span class="num" id="5048106">12</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048110">intFrameRing</span>&nbsp;<span class="op" id="5048123">=</span>&nbsp;<span class="num" id="5048125">13</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048130">intFrameSize</span>&nbsp;<span class="op" id="5048143">=</span>&nbsp;<span class="num" id="5048145">16</span><br>
<span class="lineno"></span><span class="op" id="5048148">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="5048151">//&nbsp;Interrupt&nbsp;issues&nbsp;an&nbsp;interrupt&nbsp;to&nbsp;the&nbsp;core</span><br>
<span class="lineno"></span><span class="keyword" id="5048196">func</span>&nbsp;<span class="op" id="5048201">(</span><span class="ident" id="5048202">c</span>&nbsp;<span class="op" id="5048204">*</span><span class="ident" id="5048205">cpu</span><span class="op" id="5048208">)</span>&nbsp;<span class="ident" id="5048210">Interrupt</span><span class="op" id="5048219">(</span><span class="ident" id="5048220">code</span>&nbsp;<span class="builtintype" id="5048225">byte</span><span class="op" id="5048229">)</span>&nbsp;<span class="op" id="5048231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048234">c</span><span class="op" id="5048235">.</span><span class="ident" id="5048236">interrupt</span><span class="op" id="5048245">.</span><span class="ident" id="5048246">Issue</span><span class="op" id="5048251">(</span><span class="ident" id="5048252">code</span><span class="op" id="5048256">)</span><br>
<span class="lineno"></span><span class="op" id="5048258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5048261">func</span>&nbsp;<span class="op" id="5048266">(</span><span class="ident" id="5048267">c</span>&nbsp;<span class="op" id="5048269">*</span><span class="ident" id="5048270">cpu</span><span class="op" id="5048273">)</span>&nbsp;<span class="ident" id="5048275">readWord</span><span class="op" id="5048283">(</span><span class="ident" id="5048284">addr</span>&nbsp;<span class="builtintype" id="5048289">uint32</span><span class="op" id="5048295">)</span>&nbsp;<span class="op" id="5048297">(</span><span class="builtintype" id="5048298">uint32</span><span class="op" id="5048304">,</span>&nbsp;<span class="op" id="5048306">*</span><span class="ident" id="5048307">Excep</span><span class="op" id="5048312">)</span>&nbsp;<span class="op" id="5048314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5048317">return</span>&nbsp;<span class="ident" id="5048324">c</span><span class="op" id="5048325">.</span><span class="ident" id="5048326">virtMem</span><span class="op" id="5048333">.</span><span class="ident" id="5048334">ReadWord</span><span class="op" id="5048342">(</span><span class="ident" id="5048343">addr</span><span class="op" id="5048347">,</span>&nbsp;<span class="ident" id="5048349">c</span><span class="op" id="5048350">.</span><span class="ident" id="5048351">ring</span><span class="op" id="5048355">)</span><br>
<span class="lineno"></span><span class="op" id="5048357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5048360">func</span>&nbsp;<span class="op" id="5048365">(</span><span class="ident" id="5048366">c</span>&nbsp;<span class="op" id="5048368">*</span><span class="ident" id="5048369">cpu</span><span class="op" id="5048372">)</span>&nbsp;<span class="ident" id="5048374">readByte</span><span class="op" id="5048382">(</span><span class="ident" id="5048383">addr</span>&nbsp;<span class="builtintype" id="5048388">uint32</span><span class="op" id="5048394">)</span>&nbsp;<span class="op" id="5048396">(</span><span class="builtintype" id="5048397">uint8</span><span class="op" id="5048402">,</span>&nbsp;<span class="op" id="5048404">*</span><span class="ident" id="5048405">Excep</span><span class="op" id="5048410">)</span>&nbsp;<span class="op" id="5048412">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5048415">return</span>&nbsp;<span class="ident" id="5048422">c</span><span class="op" id="5048423">.</span><span class="ident" id="5048424">virtMem</span><span class="op" id="5048431">.</span><span class="ident" id="5048432">ReadByte</span><span class="op" id="5048440">(</span><span class="ident" id="5048441">addr</span><span class="op" id="5048445">,</span>&nbsp;<span class="ident" id="5048447">c</span><span class="op" id="5048448">.</span><span class="ident" id="5048449">ring</span><span class="op" id="5048453">)</span><br>
<span class="lineno"></span><span class="op" id="5048455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5048458">func</span>&nbsp;<span class="op" id="5048463">(</span><span class="ident" id="5048464">c</span>&nbsp;<span class="op" id="5048466">*</span><span class="ident" id="5048467">cpu</span><span class="op" id="5048470">)</span>&nbsp;<span class="ident" id="5048472">writeWord</span><span class="op" id="5048481">(</span><span class="ident" id="5048482">addr</span>&nbsp;<span class="builtintype" id="5048487">uint32</span><span class="op" id="5048493">,</span>&nbsp;<span class="ident" id="5048495">v</span>&nbsp;<span class="builtintype" id="5048497">uint32</span><span class="op" id="5048503">)</span>&nbsp;<span class="op" id="5048505">*</span><span class="ident" id="5048506">Excep</span>&nbsp;<span class="op" id="5048512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5048515">return</span>&nbsp;<span class="ident" id="5048522">c</span><span class="op" id="5048523">.</span><span class="ident" id="5048524">virtMem</span><span class="op" id="5048531">.</span><span class="ident" id="5048532">WriteWord</span><span class="op" id="5048541">(</span><span class="ident" id="5048542">addr</span><span class="op" id="5048546">,</span>&nbsp;<span class="ident" id="5048548">c</span><span class="op" id="5048549">.</span><span class="ident" id="5048550">ring</span><span class="op" id="5048554">,</span>&nbsp;<span class="ident" id="5048556">v</span><span class="op" id="5048557">)</span><br>
<span class="lineno">110</span><span class="op" id="5048559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5048562">func</span>&nbsp;<span class="op" id="5048567">(</span><span class="ident" id="5048568">c</span>&nbsp;<span class="op" id="5048570">*</span><span class="ident" id="5048571">cpu</span><span class="op" id="5048574">)</span>&nbsp;<span class="ident" id="5048576">writeByte</span><span class="op" id="5048585">(</span><span class="ident" id="5048586">addr</span>&nbsp;<span class="builtintype" id="5048591">uint32</span><span class="op" id="5048597">,</span>&nbsp;<span class="ident" id="5048599">v</span>&nbsp;<span class="builtintype" id="5048601">uint8</span><span class="op" id="5048606">)</span>&nbsp;<span class="op" id="5048608">*</span><span class="ident" id="5048609">Excep</span>&nbsp;<span class="op" id="5048615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5048618">return</span>&nbsp;<span class="ident" id="5048625">c</span><span class="op" id="5048626">.</span><span class="ident" id="5048627">virtMem</span><span class="op" id="5048634">.</span><span class="ident" id="5048635">WriteByte</span><span class="op" id="5048644">(</span><span class="ident" id="5048645">addr</span><span class="op" id="5048649">,</span>&nbsp;<span class="ident" id="5048651">c</span><span class="op" id="5048652">.</span><span class="ident" id="5048653">ring</span><span class="op" id="5048657">,</span>&nbsp;<span class="ident" id="5048659">v</span><span class="op" id="5048660">)</span><br>
<span class="lineno"></span><span class="op" id="5048662">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5048665">//&nbsp;Ienter&nbsp;enters&nbsp;a&nbsp;interrupt&nbsp;routine.</span><br>
<span class="lineno"></span><span class="keyword" id="5048703">func</span>&nbsp;<span class="op" id="5048708">(</span><span class="ident" id="5048709">c</span>&nbsp;<span class="op" id="5048711">*</span><span class="ident" id="5048712">cpu</span><span class="op" id="5048715">)</span>&nbsp;<span class="ident" id="5048717">Ienter</span><span class="op" id="5048723">(</span><span class="ident" id="5048724">code</span>&nbsp;<span class="builtintype" id="5048729">byte</span><span class="op" id="5048733">,</span>&nbsp;<span class="ident" id="5048735">arg</span>&nbsp;<span class="builtintype" id="5048739">uint32</span><span class="op" id="5048745">)</span>&nbsp;<span class="op" id="5048747">*</span><span class="ident" id="5048748">Excep</span>&nbsp;<span class="op" id="5048754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048757">ksp</span>&nbsp;<span class="op" id="5048761">:=</span>&nbsp;<span class="ident" id="5048764">c</span><span class="op" id="5048765">.</span><span class="ident" id="5048766">interrupt</span><span class="op" id="5048775">.</span><span class="ident" id="5048776">kernelSP</span><span class="op" id="5048784">(</span><span class="op" id="5048785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048788">base</span>&nbsp;<span class="op" id="5048793">:=</span>&nbsp;<span class="ident" id="5048796">ksp</span>&nbsp;<span class="op" id="5048800">-</span>&nbsp;<span class="ident" id="5048802">intFrameSize</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048817">writeWord</span>&nbsp;<span class="op" id="5048827">:=</span>&nbsp;<span class="keyword" id="5048830">func</span><span class="op" id="5048834">(</span><span class="ident" id="5048835">off</span>&nbsp;<span class="builtintype" id="5048839">uint32</span><span class="op" id="5048845">,</span>&nbsp;<span class="ident" id="5048847">v</span>&nbsp;<span class="builtintype" id="5048849">uint32</span><span class="op" id="5048855">)</span>&nbsp;<span class="op" id="5048857">*</span><span class="ident" id="5048858">Excep</span>&nbsp;<span class="op" id="5048864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5048868">return</span>&nbsp;<span class="ident" id="5048875">c</span><span class="op" id="5048876">.</span><span class="ident" id="5048877">virtMem</span><span class="op" id="5048884">.</span><span class="ident" id="5048885">WriteWord</span><span class="op" id="5048894">(</span><span class="ident" id="5048895">base</span><span class="op" id="5048899">+</span><span class="ident" id="5048900">off</span><span class="op" id="5048903">,</span>&nbsp;<span class="num" id="5048905">0</span><span class="op" id="5048906">,</span>&nbsp;<span class="ident" id="5048908">v</span><span class="op" id="5048909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5048912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5048915">writeByte</span>&nbsp;<span class="op" id="5048925">:=</span>&nbsp;<span class="keyword" id="5048928">func</span><span class="op" id="5048932">(</span><span class="ident" id="5048933">off</span>&nbsp;<span class="builtintype" id="5048937">uint32</span><span class="op" id="5048943">,</span>&nbsp;<span class="ident" id="5048945">b</span>&nbsp;<span class="builtintype" id="5048947">uint8</span><span class="op" id="5048952">)</span>&nbsp;<span class="op" id="5048954">*</span><span class="ident" id="5048955">Excep</span>&nbsp;<span class="op" id="5048961">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5048965">return</span>&nbsp;<span class="ident" id="5048972">c</span><span class="op" id="5048973">.</span><span class="ident" id="5048974">virtMem</span><span class="op" id="5048981">.</span><span class="ident" id="5048982">WriteByte</span><span class="op" id="5048991">(</span><span class="ident" id="5048992">base</span><span class="op" id="5048996">+</span><span class="ident" id="5048997">off</span><span class="op" id="5049000">,</span>&nbsp;<span class="num" id="5049002">0</span><span class="op" id="5049003">,</span>&nbsp;<span class="ident" id="5049005">b</span><span class="op" id="5049006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5049009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049012">if</span>&nbsp;<span class="ident" id="5049015">e</span>&nbsp;<span class="op" id="5049017">:=</span>&nbsp;<span class="ident" id="5049020">writeWord</span><span class="op" id="5049029">(</span><span class="ident" id="5049030">intFrameSP</span><span class="op" id="5049040">,</span>&nbsp;<span class="ident" id="5049042">c</span><span class="op" id="5049043">.</span><span class="ident" id="5049044">regs</span><span class="op" id="5049048">[</span><span class="ident" id="5049049">SP</span><span class="op" id="5049051">]</span><span class="op" id="5049052">)</span><span class="op" id="5049053">;</span>&nbsp;<span class="ident" id="5049055">e</span>&nbsp;<span class="op" id="5049057">!=</span>&nbsp;<span class="ident" id="5049060">nil</span>&nbsp;<span class="op" id="5049064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049068">return</span>&nbsp;<span class="ident" id="5049075">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5049078">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049081">if</span>&nbsp;<span class="ident" id="5049084">e</span>&nbsp;<span class="op" id="5049086">:=</span>&nbsp;<span class="ident" id="5049089">writeWord</span><span class="op" id="5049098">(</span><span class="ident" id="5049099">intFrameRET</span><span class="op" id="5049110">,</span>&nbsp;<span class="ident" id="5049112">c</span><span class="op" id="5049113">.</span><span class="ident" id="5049114">regs</span><span class="op" id="5049118">[</span><span class="ident" id="5049119">RET</span><span class="op" id="5049122">]</span><span class="op" id="5049123">)</span><span class="op" id="5049124">;</span>&nbsp;<span class="ident" id="5049126">e</span>&nbsp;<span class="op" id="5049128">!=</span>&nbsp;<span class="ident" id="5049131">nil</span>&nbsp;<span class="op" id="5049135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049139">return</span>&nbsp;<span class="ident" id="5049146">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5049149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049152">if</span>&nbsp;<span class="ident" id="5049155">e</span>&nbsp;<span class="op" id="5049157">:=</span>&nbsp;<span class="ident" id="5049160">writeWord</span><span class="op" id="5049169">(</span><span class="ident" id="5049170">intFrameArg</span><span class="op" id="5049181">,</span>&nbsp;<span class="ident" id="5049183">arg</span><span class="op" id="5049186">)</span><span class="op" id="5049187">;</span>&nbsp;<span class="ident" id="5049189">e</span>&nbsp;<span class="op" id="5049191">!=</span>&nbsp;<span class="ident" id="5049194">nil</span>&nbsp;<span class="op" id="5049198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049202">return</span>&nbsp;<span class="ident" id="5049209">e</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5049212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049215">if</span>&nbsp;<span class="ident" id="5049218">e</span>&nbsp;<span class="op" id="5049220">:=</span>&nbsp;<span class="ident" id="5049223">writeByte</span><span class="op" id="5049232">(</span><span class="ident" id="5049233">intFrameCode</span><span class="op" id="5049245">,</span>&nbsp;<span class="ident" id="5049247">code</span><span class="op" id="5049251">)</span><span class="op" id="5049252">;</span>&nbsp;<span class="ident" id="5049254">e</span>&nbsp;<span class="op" id="5049256">!=</span>&nbsp;<span class="ident" id="5049259">nil</span>&nbsp;<span class="op" id="5049263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049267">return</span>&nbsp;<span class="ident" id="5049274">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5049277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049280">if</span>&nbsp;<span class="ident" id="5049283">e</span>&nbsp;<span class="op" id="5049285">:=</span>&nbsp;<span class="ident" id="5049288">writeByte</span><span class="op" id="5049297">(</span><span class="ident" id="5049298">intFrameRing</span><span class="op" id="5049310">,</span>&nbsp;<span class="ident" id="5049312">c</span><span class="op" id="5049313">.</span><span class="ident" id="5049314">ring</span><span class="op" id="5049318">)</span><span class="op" id="5049319">;</span>&nbsp;<span class="ident" id="5049321">e</span>&nbsp;<span class="op" id="5049323">!=</span>&nbsp;<span class="ident" id="5049326">nil</span>&nbsp;<span class="op" id="5049330">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049334">return</span>&nbsp;<span class="ident" id="5049341">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5049344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049348">c</span><span class="op" id="5049349">.</span><span class="ident" id="5049350">interrupt</span><span class="op" id="5049359">.</span><span class="ident" id="5049360">Disable</span><span class="op" id="5049367">(</span><span class="op" id="5049368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049371">c</span><span class="op" id="5049372">.</span><span class="ident" id="5049373">regs</span><span class="op" id="5049377">[</span><span class="ident" id="5049378">SP</span><span class="op" id="5049380">]</span>&nbsp;<span class="op" id="5049382">=</span>&nbsp;<span class="ident" id="5049384">ksp</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049389">c</span><span class="op" id="5049390">.</span><span class="ident" id="5049391">regs</span><span class="op" id="5049395">[</span><span class="ident" id="5049396">RET</span><span class="op" id="5049399">]</span>&nbsp;<span class="op" id="5049401">=</span>&nbsp;<span class="ident" id="5049403">c</span><span class="op" id="5049404">.</span><span class="ident" id="5049405">regs</span><span class="op" id="5049409">[</span><span class="ident" id="5049410">PC</span><span class="op" id="5049412">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049415">c</span><span class="op" id="5049416">.</span><span class="ident" id="5049417">regs</span><span class="op" id="5049421">[</span><span class="ident" id="5049422">PC</span><span class="op" id="5049424">]</span>&nbsp;<span class="op" id="5049426">=</span>&nbsp;<span class="ident" id="5049428">c</span><span class="op" id="5049429">.</span><span class="ident" id="5049430">interrupt</span><span class="op" id="5049439">.</span><span class="ident" id="5049440">handlerPC</span><span class="op" id="5049449">(</span><span class="op" id="5049450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049453">c</span><span class="op" id="5049454">.</span><span class="ident" id="5049455">ring</span>&nbsp;<span class="op" id="5049460">=</span>&nbsp;<span class="num" id="5049462">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049466">return</span>&nbsp;<span class="ident" id="5049473">nil</span><br>
<span class="lineno">150</span><span class="op" id="5049477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5049480">//&nbsp;Syscall&nbsp;jumps&nbsp;to&nbsp;the&nbsp;system&nbsp;call&nbsp;handler&nbsp;and&nbsp;switches&nbsp;to&nbsp;ring&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="5049548">func</span>&nbsp;<span class="op" id="5049553">(</span><span class="ident" id="5049554">c</span>&nbsp;<span class="op" id="5049556">*</span><span class="ident" id="5049557">cpu</span><span class="op" id="5049560">)</span>&nbsp;<span class="ident" id="5049562">Syscall</span><span class="op" id="5049569">(</span><span class="op" id="5049570">)</span>&nbsp;<span class="op" id="5049572">*</span><span class="ident" id="5049573">Excep</span>&nbsp;<span class="op" id="5049579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049582">c</span><span class="op" id="5049583">.</span><span class="ident" id="5049584">regs</span><span class="op" id="5049588">[</span><span class="ident" id="5049589">PC</span><span class="op" id="5049591">]</span>&nbsp;<span class="op" id="5049593">=</span>&nbsp;<span class="ident" id="5049595">c</span><span class="op" id="5049596">.</span><span class="ident" id="5049597">interrupt</span><span class="op" id="5049606">.</span><span class="ident" id="5049607">syscallPC</span><span class="op" id="5049616">(</span><span class="op" id="5049617">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049620">c</span><span class="op" id="5049621">.</span><span class="ident" id="5049622">ring</span>&nbsp;<span class="op" id="5049627">=</span>&nbsp;<span class="num" id="5049629">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049632">return</span>&nbsp;<span class="ident" id="5049639">nil</span><br>
<span class="lineno"></span><span class="op" id="5049643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5049646">//&nbsp;Iret&nbsp;restores&nbsp;from&nbsp;an&nbsp;interrupt.</span><br>
<span class="lineno">160</span><span class="comment" id="5049682">//&nbsp;It&nbsp;restores&nbsp;the&nbsp;SP,&nbsp;RET,&nbsp;PC&nbsp;registers,&nbsp;restores&nbsp;the&nbsp;ring&nbsp;level,</span><br>
<span class="lineno"></span><span class="comment" id="5049749">//&nbsp;clears&nbsp;the&nbsp;served&nbsp;interrupt&nbsp;bit&nbsp;and&nbsp;enables&nbsp;interrupt&nbsp;again.</span><br>
<span class="lineno"></span><span class="keyword" id="5049813">func</span>&nbsp;<span class="op" id="5049818">(</span><span class="ident" id="5049819">c</span>&nbsp;<span class="op" id="5049821">*</span><span class="ident" id="5049822">cpu</span><span class="op" id="5049825">)</span>&nbsp;<span class="ident" id="5049827">Iret</span><span class="op" id="5049831">(</span><span class="op" id="5049832">)</span>&nbsp;<span class="op" id="5049834">*</span><span class="ident" id="5049835">Excep</span>&nbsp;<span class="op" id="5049841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049844">if</span>&nbsp;<span class="ident" id="5049847">c</span><span class="op" id="5049848">.</span><span class="ident" id="5049849">ring</span>&nbsp;<span class="op" id="5049854">!=</span>&nbsp;<span class="num" id="5049857">0</span>&nbsp;<span class="op" id="5049859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5049863">panic</span><span class="op" id="5049868">(</span><span class="string" id="5049869">&#34;iret&nbsp;in&nbsp;userland&#34;</span><span class="op" id="5049887">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5049890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049894">ksp</span>&nbsp;<span class="op" id="5049898">:=</span>&nbsp;<span class="ident" id="5049901">c</span><span class="op" id="5049902">.</span><span class="ident" id="5049903">interrupt</span><span class="op" id="5049912">.</span><span class="ident" id="5049913">kernelSP</span><span class="op" id="5049921">(</span><span class="op" id="5049922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049925">base</span>&nbsp;<span class="op" id="5049930">:=</span>&nbsp;<span class="ident" id="5049933">ksp</span>&nbsp;<span class="op" id="5049937">-</span>&nbsp;<span class="ident" id="5049939">intFrameSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5049953">sp</span><span class="op" id="5049955">,</span>&nbsp;<span class="ident" id="5049957">e</span>&nbsp;<span class="op" id="5049959">:=</span>&nbsp;<span class="ident" id="5049962">c</span><span class="op" id="5049963">.</span><span class="ident" id="5049964">readWord</span><span class="op" id="5049972">(</span><span class="ident" id="5049973">base</span>&nbsp;<span class="op" id="5049978">+</span>&nbsp;<span class="ident" id="5049980">intFrameSP</span><span class="op" id="5049990">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5049993">if</span>&nbsp;<span class="ident" id="5049996">e</span>&nbsp;<span class="op" id="5049998">!=</span>&nbsp;<span class="ident" id="5050001">nil</span>&nbsp;<span class="op" id="5050005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050009">return</span>&nbsp;<span class="ident" id="5050016">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050022">ret</span><span class="op" id="5050025">,</span>&nbsp;<span class="ident" id="5050027">e</span>&nbsp;<span class="op" id="5050029">:=</span>&nbsp;<span class="ident" id="5050032">c</span><span class="op" id="5050033">.</span><span class="ident" id="5050034">readWord</span><span class="op" id="5050042">(</span><span class="ident" id="5050043">base</span>&nbsp;<span class="op" id="5050048">+</span>&nbsp;<span class="ident" id="5050050">intFrameRET</span><span class="op" id="5050061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050064">if</span>&nbsp;<span class="ident" id="5050067">e</span>&nbsp;<span class="op" id="5050069">!=</span>&nbsp;<span class="ident" id="5050072">nil</span>&nbsp;<span class="op" id="5050076">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050080">return</span>&nbsp;<span class="ident" id="5050087">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050093">code</span><span class="op" id="5050097">,</span>&nbsp;<span class="ident" id="5050099">e</span>&nbsp;<span class="op" id="5050101">:=</span>&nbsp;<span class="ident" id="5050104">c</span><span class="op" id="5050105">.</span><span class="ident" id="5050106">readByte</span><span class="op" id="5050114">(</span><span class="ident" id="5050115">base</span>&nbsp;<span class="op" id="5050120">+</span>&nbsp;<span class="ident" id="5050122">intFrameCode</span><span class="op" id="5050134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050137">if</span>&nbsp;<span class="ident" id="5050140">e</span>&nbsp;<span class="op" id="5050142">!=</span>&nbsp;<span class="ident" id="5050145">nil</span>&nbsp;<span class="op" id="5050149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050153">return</span>&nbsp;<span class="ident" id="5050160">e</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050166">ring</span><span class="op" id="5050170">,</span>&nbsp;<span class="ident" id="5050172">e</span>&nbsp;<span class="op" id="5050174">:=</span>&nbsp;<span class="ident" id="5050177">c</span><span class="op" id="5050178">.</span><span class="ident" id="5050179">readByte</span><span class="op" id="5050187">(</span><span class="ident" id="5050188">base</span>&nbsp;<span class="op" id="5050193">+</span>&nbsp;<span class="ident" id="5050195">intFrameRing</span><span class="op" id="5050207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050210">if</span>&nbsp;<span class="ident" id="5050213">e</span>&nbsp;<span class="op" id="5050215">!=</span>&nbsp;<span class="ident" id="5050218">nil</span>&nbsp;<span class="op" id="5050222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050226">return</span>&nbsp;<span class="ident" id="5050233">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050236">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050240">c</span><span class="op" id="5050241">.</span><span class="ident" id="5050242">regs</span><span class="op" id="5050246">[</span><span class="ident" id="5050247">PC</span><span class="op" id="5050249">]</span>&nbsp;<span class="op" id="5050251">=</span>&nbsp;<span class="ident" id="5050253">c</span><span class="op" id="5050254">.</span><span class="ident" id="5050255">regs</span><span class="op" id="5050259">[</span><span class="ident" id="5050260">RET</span><span class="op" id="5050263">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050266">c</span><span class="op" id="5050267">.</span><span class="ident" id="5050268">regs</span><span class="op" id="5050272">[</span><span class="ident" id="5050273">RET</span><span class="op" id="5050276">]</span>&nbsp;<span class="op" id="5050278">=</span>&nbsp;<span class="ident" id="5050280">ret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050285">c</span><span class="op" id="5050286">.</span><span class="ident" id="5050287">regs</span><span class="op" id="5050291">[</span><span class="ident" id="5050292">SP</span><span class="op" id="5050294">]</span>&nbsp;<span class="op" id="5050296">=</span>&nbsp;<span class="ident" id="5050298">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050302">c</span><span class="op" id="5050303">.</span><span class="ident" id="5050304">ring</span>&nbsp;<span class="op" id="5050309">=</span>&nbsp;<span class="ident" id="5050311">ring</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050317">c</span><span class="op" id="5050318">.</span><span class="ident" id="5050319">interrupt</span><span class="op" id="5050328">.</span><span class="ident" id="5050329">Clear</span><span class="op" id="5050334">(</span><span class="ident" id="5050335">code</span><span class="op" id="5050339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050342">c</span><span class="op" id="5050343">.</span><span class="ident" id="5050344">interrupt</span><span class="op" id="5050353">.</span><span class="ident" id="5050354">Enable</span><span class="op" id="5050360">(</span><span class="op" id="5050361">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050365">return</span>&nbsp;<span class="ident" id="5050372">nil</span><br>
<span class="lineno"></span><span class="op" id="5050376">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="comment" id="5050379">//&nbsp;Tick&nbsp;executes&nbsp;one&nbsp;instruction,&nbsp;and&nbsp;increases&nbsp;the&nbsp;program&nbsp;counter</span><br>
<span class="lineno"></span><span class="comment" id="5050447">//&nbsp;by&nbsp;4&nbsp;by&nbsp;default.&nbsp;If&nbsp;an&nbsp;exception&nbsp;is&nbsp;met,&nbsp;it&nbsp;will&nbsp;handle&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5050510">func</span>&nbsp;<span class="op" id="5050515">(</span><span class="ident" id="5050516">c</span>&nbsp;<span class="op" id="5050518">*</span><span class="ident" id="5050519">cpu</span><span class="op" id="5050522">)</span>&nbsp;<span class="ident" id="5050524">Tick</span><span class="op" id="5050528">(</span><span class="op" id="5050529">)</span>&nbsp;<span class="op" id="5050531">*</span><span class="ident" id="5050532">Excep</span>&nbsp;<span class="op" id="5050538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050541">poll</span><span class="op" id="5050545">,</span>&nbsp;<span class="ident" id="5050547">code</span>&nbsp;<span class="op" id="5050552">:=</span>&nbsp;<span class="ident" id="5050555">c</span><span class="op" id="5050556">.</span><span class="ident" id="5050557">interrupt</span><span class="op" id="5050566">.</span><span class="ident" id="5050567">Poll</span><span class="op" id="5050571">(</span><span class="op" id="5050572">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050575">if</span>&nbsp;<span class="ident" id="5050578">poll</span>&nbsp;<span class="op" id="5050583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050587">return</span>&nbsp;<span class="ident" id="5050594">c</span><span class="op" id="5050595">.</span><span class="ident" id="5050596">Ienter</span><span class="op" id="5050602">(</span><span class="ident" id="5050603">code</span><span class="op" id="5050607">,</span>&nbsp;<span class="num" id="5050609">0</span><span class="op" id="5050610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5050617">//&nbsp;no&nbsp;interrupt&nbsp;to&nbsp;dispatch,&nbsp;let&#39;s&nbsp;proceed</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050661">e</span>&nbsp;<span class="op" id="5050663">:=</span>&nbsp;<span class="ident" id="5050666">c</span><span class="op" id="5050667">.</span><span class="ident" id="5050668">tick</span><span class="op" id="5050672">(</span><span class="op" id="5050673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050676">if</span>&nbsp;<span class="ident" id="5050679">e</span>&nbsp;<span class="op" id="5050681">!=</span>&nbsp;<span class="ident" id="5050684">nil</span>&nbsp;<span class="op" id="5050688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5050692">//&nbsp;proceed&nbsp;attempt&nbsp;failed,&nbsp;handle&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050738">c</span><span class="op" id="5050739">.</span><span class="ident" id="5050740">interrupt</span><span class="op" id="5050749">.</span><span class="ident" id="5050750">Issue</span><span class="op" id="5050755">(</span><span class="ident" id="5050756">e</span><span class="op" id="5050757">.</span><span class="ident" id="5050758">Code</span><span class="op" id="5050762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5050766">poll</span><span class="op" id="5050770">,</span>&nbsp;<span class="ident" id="5050772">code</span>&nbsp;<span class="op" id="5050777">:=</span>&nbsp;<span class="ident" id="5050780">c</span><span class="op" id="5050781">.</span><span class="ident" id="5050782">interrupt</span><span class="op" id="5050791">.</span><span class="ident" id="5050792">Poll</span><span class="op" id="5050796">(</span><span class="op" id="5050797">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050801">if</span>&nbsp;<span class="ident" id="5050804">poll</span>&nbsp;<span class="op" id="5050809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050814">if</span>&nbsp;<span class="ident" id="5050817">code</span>&nbsp;<span class="op" id="5050822">!=</span>&nbsp;<span class="ident" id="5050825">e</span><span class="op" id="5050826">.</span><span class="ident" id="5050827">Code</span>&nbsp;<span class="op" id="5050832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5050838">panic</span><span class="op" id="5050843">(</span><span class="string" id="5050844">&#34;interrupt&nbsp;code&nbsp;is&nbsp;different&#34;</span><span class="op" id="5050873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050883">return</span>&nbsp;<span class="ident" id="5050890">c</span><span class="op" id="5050891">.</span><span class="ident" id="5050892">Ienter</span><span class="op" id="5050898">(</span><span class="ident" id="5050899">code</span><span class="op" id="5050903">,</span>&nbsp;<span class="ident" id="5050905">e</span><span class="op" id="5050906">.</span><span class="ident" id="5050907">Arg</span><span class="op" id="5050910">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5050917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5050921">return</span>&nbsp;<span class="ident" id="5050928">e</span><br>
<span class="lineno"></span><span class="op" id="5050930">}</span>
</div>
</body>
</html>
