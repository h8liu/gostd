<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1573045">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1573100">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1573154">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1573205">package</span>&nbsp;<span class="ident" id="1573213">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1573222">import</span>&nbsp;<span class="string" id="1573229">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1573239">var</span>&nbsp;<span class="ident" id="1573243">indexError</span>&nbsp;<span class="op" id="1573254">=</span>&nbsp;<span class="builtintype" id="1573256">error</span><span class="op" id="1573261">(</span><span class="ident" id="1573262">errorString</span><span class="op" id="1573273">(</span><span class="string" id="1573274">&#34;index&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1573294">)</span><span class="op" id="1573295">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1573298">func</span>&nbsp;<span class="ident" id="1573303">panicindex</span><span class="op" id="1573313">(</span><span class="op" id="1573314">)</span>&nbsp;<span class="op" id="1573316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1573319">panic</span><span class="op" id="1573324">(</span><span class="ident" id="1573325">indexError</span><span class="op" id="1573335">)</span><br>
<span class="lineno"></span><span class="op" id="1573337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1573340">var</span>&nbsp;<span class="ident" id="1573344">sliceError</span>&nbsp;<span class="op" id="1573355">=</span>&nbsp;<span class="builtintype" id="1573357">error</span><span class="op" id="1573362">(</span><span class="ident" id="1573363">errorString</span><span class="op" id="1573374">(</span><span class="string" id="1573375">&#34;slice&nbsp;bounds&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1573402">)</span><span class="op" id="1573403">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1573406">func</span>&nbsp;<span class="ident" id="1573411">panicslice</span><span class="op" id="1573421">(</span><span class="op" id="1573422">)</span>&nbsp;<span class="op" id="1573424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1573427">panic</span><span class="op" id="1573432">(</span><span class="ident" id="1573433">sliceError</span><span class="op" id="1573443">)</span><br>
<span class="lineno"></span><span class="op" id="1573445">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="1573448">var</span>&nbsp;<span class="ident" id="1573452">divideError</span>&nbsp;<span class="op" id="1573464">=</span>&nbsp;<span class="builtintype" id="1573466">error</span><span class="op" id="1573471">(</span><span class="ident" id="1573472">errorString</span><span class="op" id="1573483">(</span><span class="string" id="1573484">&#34;integer&nbsp;divide&nbsp;by&nbsp;zero&#34;</span><span class="op" id="1573508">)</span><span class="op" id="1573509">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1573512">func</span>&nbsp;<span class="ident" id="1573517">panicdivide</span><span class="op" id="1573528">(</span><span class="op" id="1573529">)</span>&nbsp;<span class="op" id="1573531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1573534">panic</span><span class="op" id="1573539">(</span><span class="ident" id="1573540">divideError</span><span class="op" id="1573551">)</span><br>
<span class="lineno">25</span><span class="op" id="1573553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1573556">var</span>&nbsp;<span class="ident" id="1573560">overflowError</span>&nbsp;<span class="op" id="1573574">=</span>&nbsp;<span class="builtintype" id="1573576">error</span><span class="op" id="1573581">(</span><span class="ident" id="1573582">errorString</span><span class="op" id="1573593">(</span><span class="string" id="1573594">&#34;integer&nbsp;overflow&#34;</span><span class="op" id="1573612">)</span><span class="op" id="1573613">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1573616">func</span>&nbsp;<span class="ident" id="1573621">panicoverflow</span><span class="op" id="1573634">(</span><span class="op" id="1573635">)</span>&nbsp;<span class="op" id="1573637">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1573640">panic</span><span class="op" id="1573645">(</span><span class="ident" id="1573646">overflowError</span><span class="op" id="1573659">)</span><br>
<span class="lineno"></span><span class="op" id="1573661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1573664">var</span>&nbsp;<span class="ident" id="1573668">floatError</span>&nbsp;<span class="op" id="1573679">=</span>&nbsp;<span class="builtintype" id="1573681">error</span><span class="op" id="1573686">(</span><span class="ident" id="1573687">errorString</span><span class="op" id="1573698">(</span><span class="string" id="1573699">&#34;floating&nbsp;point&nbsp;error&#34;</span><span class="op" id="1573721">)</span><span class="op" id="1573722">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="1573725">func</span>&nbsp;<span class="ident" id="1573730">panicfloat</span><span class="op" id="1573740">(</span><span class="op" id="1573741">)</span>&nbsp;<span class="op" id="1573743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1573746">panic</span><span class="op" id="1573751">(</span><span class="ident" id="1573752">floatError</span><span class="op" id="1573762">)</span><br>
<span class="lineno"></span><span class="op" id="1573764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1573767">var</span>&nbsp;<span class="ident" id="1573771">memoryError</span>&nbsp;<span class="op" id="1573783">=</span>&nbsp;<span class="builtintype" id="1573785">error</span><span class="op" id="1573790">(</span><span class="ident" id="1573791">errorString</span><span class="op" id="1573802">(</span><span class="string" id="1573803">&#34;invalid&nbsp;memory&nbsp;address&nbsp;or&nbsp;nil&nbsp;pointer&nbsp;dereference&#34;</span><span class="op" id="1573854">)</span><span class="op" id="1573855">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="1573858">func</span>&nbsp;<span class="ident" id="1573863">panicmem</span><span class="op" id="1573871">(</span><span class="op" id="1573872">)</span>&nbsp;<span class="op" id="1573874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1573877">panic</span><span class="op" id="1573882">(</span><span class="ident" id="1573883">memoryError</span><span class="op" id="1573894">)</span><br>
<span class="lineno"></span><span class="op" id="1573896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1573899">func</span>&nbsp;<span class="ident" id="1573904">throwreturn</span><span class="op" id="1573915">(</span><span class="op" id="1573916">)</span>&nbsp;<span class="op" id="1573918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1573921">gothrow</span><span class="op" id="1573928">(</span><span class="string" id="1573929">&#34;no&nbsp;return&nbsp;at&nbsp;end&nbsp;of&nbsp;a&nbsp;typed&nbsp;function&nbsp;-&nbsp;compiler&nbsp;is&nbsp;broken&#34;</span><span class="op" id="1573988">)</span><br>
<span class="lineno"></span><span class="op" id="1573990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1573993">func</span>&nbsp;<span class="ident" id="1573998">throwinit</span><span class="op" id="1574007">(</span><span class="op" id="1574008">)</span>&nbsp;<span class="op" id="1574010">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574013">gothrow</span><span class="op" id="1574020">(</span><span class="string" id="1574021">&#34;recursive&nbsp;call&nbsp;during&nbsp;initialization&nbsp;-&nbsp;linker&nbsp;skew&#34;</span><span class="op" id="1574073">)</span><br>
<span class="lineno"></span><span class="op" id="1574075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1574078">//&nbsp;Create&nbsp;a&nbsp;new&nbsp;deferred&nbsp;function&nbsp;fn&nbsp;with&nbsp;siz&nbsp;bytes&nbsp;of&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="1574144">//&nbsp;The&nbsp;compiler&nbsp;turns&nbsp;a&nbsp;defer&nbsp;statement&nbsp;into&nbsp;a&nbsp;call&nbsp;to&nbsp;this.</span><br>
<span class="lineno">55</span><span class="comment" id="1574205">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1574218">func</span>&nbsp;<span class="ident" id="1574223">deferproc</span><span class="op" id="1574232">(</span><span class="ident" id="1574233">siz</span>&nbsp;<span class="builtintype" id="1574237">int32</span><span class="op" id="1574242">,</span>&nbsp;<span class="ident" id="1574244">fn</span>&nbsp;<span class="op" id="1574247">*</span><span class="ident" id="1574248">funcval</span><span class="op" id="1574255">)</span>&nbsp;<span class="op" id="1574257">{</span>&nbsp;<span class="comment" id="1574259">//&nbsp;arguments&nbsp;of&nbsp;fn&nbsp;follow&nbsp;fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1574289">//&nbsp;the&nbsp;arguments&nbsp;of&nbsp;fn&nbsp;are&nbsp;in&nbsp;a&nbsp;perilous&nbsp;state.&nbsp;&nbsp;The&nbsp;stack&nbsp;map</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1574353">//&nbsp;for&nbsp;deferproc&nbsp;does&nbsp;not&nbsp;describe&nbsp;them.&nbsp;&nbsp;So&nbsp;we&nbsp;can&#39;t&nbsp;let&nbsp;garbage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1574420">//&nbsp;collection&nbsp;or&nbsp;stack&nbsp;copying&nbsp;trigger&nbsp;until&nbsp;we&#39;ve&nbsp;copied&nbsp;them&nbsp;out</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1574488">//&nbsp;to&nbsp;somewhere&nbsp;safe.&nbsp;&nbsp;deferproc_m&nbsp;does&nbsp;that.&nbsp;&nbsp;Until&nbsp;deferproc_m,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1574555">//&nbsp;we&nbsp;can&nbsp;only&nbsp;call&nbsp;nosplit&nbsp;routines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574594">argp</span>&nbsp;<span class="op" id="1574599">:=</span>&nbsp;<span class="builtintype" id="1574602">uintptr</span><span class="op" id="1574609">(</span><span class="ident" id="1574610">unsafe</span><span class="op" id="1574616">.</span><span class="ident" id="1574617">Pointer</span><span class="op" id="1574624">(</span><span class="op" id="1574625">&amp;</span><span class="ident" id="1574626">fn</span><span class="op" id="1574628">)</span><span class="op" id="1574629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574632">argp</span>&nbsp;<span class="op" id="1574637">+=</span>&nbsp;<span class="ident" id="1574640">unsafe</span><span class="op" id="1574646">.</span><span class="ident" id="1574647">Sizeof</span><span class="op" id="1574653">(</span><span class="ident" id="1574654">fn</span><span class="op" id="1574656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1574659">if</span>&nbsp;<span class="ident" id="1574662">GOARCH</span>&nbsp;<span class="op" id="1574669">==</span>&nbsp;<span class="string" id="1574672">&#34;arm&#34;</span>&nbsp;<span class="op" id="1574678">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574682">argp</span>&nbsp;<span class="op" id="1574687">+=</span>&nbsp;<span class="ident" id="1574690">ptrSize</span>&nbsp;<span class="comment" id="1574698">//&nbsp;skip&nbsp;caller&#39;s&nbsp;saved&nbsp;link&nbsp;register</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1574736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574739">mp</span>&nbsp;<span class="op" id="1574742">:=</span>&nbsp;<span class="ident" id="1574745">acquirem</span><span class="op" id="1574753">(</span><span class="op" id="1574754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574757">mp</span><span class="op" id="1574759">.</span><span class="ident" id="1574760">scalararg</span><span class="op" id="1574769">[</span><span class="num" id="1574770">0</span><span class="op" id="1574771">]</span>&nbsp;<span class="op" id="1574773">=</span>&nbsp;<span class="builtintype" id="1574775">uintptr</span><span class="op" id="1574782">(</span><span class="ident" id="1574783">siz</span><span class="op" id="1574786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574789">mp</span><span class="op" id="1574791">.</span><span class="ident" id="1574792">ptrarg</span><span class="op" id="1574798">[</span><span class="num" id="1574799">0</span><span class="op" id="1574800">]</span>&nbsp;<span class="op" id="1574802">=</span>&nbsp;<span class="ident" id="1574804">unsafe</span><span class="op" id="1574810">.</span><span class="ident" id="1574811">Pointer</span><span class="op" id="1574818">(</span><span class="ident" id="1574819">fn</span><span class="op" id="1574821">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574824">mp</span><span class="op" id="1574826">.</span><span class="ident" id="1574827">scalararg</span><span class="op" id="1574836">[</span><span class="num" id="1574837">1</span><span class="op" id="1574838">]</span>&nbsp;<span class="op" id="1574840">=</span>&nbsp;<span class="ident" id="1574842">argp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574848">mp</span><span class="op" id="1574850">.</span><span class="ident" id="1574851">scalararg</span><span class="op" id="1574860">[</span><span class="num" id="1574861">2</span><span class="op" id="1574862">]</span>&nbsp;<span class="op" id="1574864">=</span>&nbsp;<span class="ident" id="1574866">getcallerpc</span><span class="op" id="1574877">(</span><span class="ident" id="1574878">unsafe</span><span class="op" id="1574884">.</span><span class="ident" id="1574885">Pointer</span><span class="op" id="1574892">(</span><span class="op" id="1574893">&amp;</span><span class="ident" id="1574894">siz</span><span class="op" id="1574897">)</span><span class="op" id="1574898">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1574902">if</span>&nbsp;<span class="ident" id="1574905">mp</span><span class="op" id="1574907">.</span><span class="ident" id="1574908">curg</span>&nbsp;<span class="op" id="1574913">!=</span>&nbsp;<span class="ident" id="1574916">getg</span><span class="op" id="1574920">(</span><span class="op" id="1574921">)</span>&nbsp;<span class="op" id="1574923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1574927">//&nbsp;go&nbsp;code&nbsp;on&nbsp;the&nbsp;m&nbsp;stack&nbsp;can&#39;t&nbsp;defer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574967">gothrow</span><span class="op" id="1574974">(</span><span class="string" id="1574975">&#34;defer&nbsp;on&nbsp;m&#34;</span><span class="op" id="1574987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1574990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574994">onM</span><span class="op" id="1574997">(</span><span class="ident" id="1574998">deferproc_m</span><span class="op" id="1575009">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575013">releasem</span><span class="op" id="1575021">(</span><span class="ident" id="1575022">mp</span><span class="op" id="1575024">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575028">//&nbsp;deferproc&nbsp;returns&nbsp;0&nbsp;normally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575062">//&nbsp;a&nbsp;deferred&nbsp;func&nbsp;that&nbsp;stops&nbsp;a&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575101">//&nbsp;makes&nbsp;the&nbsp;deferproc&nbsp;return&nbsp;1.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575135">//&nbsp;the&nbsp;code&nbsp;the&nbsp;compiler&nbsp;generates&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575178">//&nbsp;checks&nbsp;the&nbsp;return&nbsp;value&nbsp;and&nbsp;jumps&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575223">//&nbsp;end&nbsp;of&nbsp;the&nbsp;function&nbsp;if&nbsp;deferproc&nbsp;returns&nbsp;!=&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575274">return0</span><span class="op" id="1575281">(</span><span class="op" id="1575282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575285">//&nbsp;No&nbsp;code&nbsp;can&nbsp;go&nbsp;here&nbsp;-&nbsp;the&nbsp;C&nbsp;return&nbsp;register&nbsp;has</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575337">//&nbsp;been&nbsp;set&nbsp;and&nbsp;must&nbsp;not&nbsp;be&nbsp;clobbered.</span><br>
<span class="lineno"></span><span class="op" id="1575376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1575379">//&nbsp;Small&nbsp;malloc&nbsp;size&nbsp;classes&nbsp;&gt;=&nbsp;16&nbsp;are&nbsp;the&nbsp;multiples&nbsp;of&nbsp;16:&nbsp;16,&nbsp;32,&nbsp;48,&nbsp;64,&nbsp;80,&nbsp;96,&nbsp;112,&nbsp;128,&nbsp;144,&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="1575482">//&nbsp;Each&nbsp;P&nbsp;holds&nbsp;a&nbsp;pool&nbsp;for&nbsp;defers&nbsp;with&nbsp;small&nbsp;arg&nbsp;sizes.</span><br>
<span class="lineno">95</span><span class="comment" id="1575538">//&nbsp;Assign&nbsp;defer&nbsp;allocations&nbsp;to&nbsp;pools&nbsp;by&nbsp;rounding&nbsp;to&nbsp;16,&nbsp;to&nbsp;match&nbsp;malloc&nbsp;size&nbsp;classes.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1575625">const</span>&nbsp;<span class="op" id="1575631">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575634">deferHeaderSize</span>&nbsp;<span class="op" id="1575650">=</span>&nbsp;<span class="ident" id="1575652">unsafe</span><span class="op" id="1575658">.</span><span class="ident" id="1575659">Sizeof</span><span class="op" id="1575665">(</span><span class="ident" id="1575666">_defer</span><span class="op" id="1575672">{</span><span class="op" id="1575673">}</span><span class="op" id="1575674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575677">minDeferAlloc</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1575693">=</span>&nbsp;<span class="op" id="1575695">(</span><span class="ident" id="1575696">deferHeaderSize</span>&nbsp;<span class="op" id="1575712">+</span>&nbsp;<span class="num" id="1575714">15</span><span class="op" id="1575716">)</span>&nbsp;<span class="op" id="1575718">&amp;^</span>&nbsp;<span class="num" id="1575721">15</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575725">minDeferArgs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1575741">=</span>&nbsp;<span class="ident" id="1575743">minDeferAlloc</span>&nbsp;<span class="op" id="1575757">-</span>&nbsp;<span class="ident" id="1575759">deferHeaderSize</span><br>
<span class="lineno"></span><span class="op" id="1575775">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1575778">//&nbsp;defer&nbsp;size&nbsp;class&nbsp;for&nbsp;arg&nbsp;size&nbsp;sz</span><br>
<span class="lineno"></span><span class="comment" id="1575814">//go:nosplit</span><br>
<span class="lineno">105</span><span class="keyword" id="1575827">func</span>&nbsp;<span class="ident" id="1575832">deferclass</span><span class="op" id="1575842">(</span><span class="ident" id="1575843">siz</span>&nbsp;<span class="builtintype" id="1575847">uintptr</span><span class="op" id="1575854">)</span>&nbsp;<span class="builtintype" id="1575856">uintptr</span>&nbsp;<span class="op" id="1575864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575867">if</span>&nbsp;<span class="ident" id="1575870">siz</span>&nbsp;<span class="op" id="1575874">&lt;=</span>&nbsp;<span class="ident" id="1575877">minDeferArgs</span>&nbsp;<span class="op" id="1575890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575894">return</span>&nbsp;<span class="num" id="1575901">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1575904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575907">return</span>&nbsp;<span class="op" id="1575914">(</span><span class="ident" id="1575915">siz</span>&nbsp;<span class="op" id="1575919">-</span>&nbsp;<span class="ident" id="1575921">minDeferArgs</span>&nbsp;<span class="op" id="1575934">+</span>&nbsp;<span class="num" id="1575936">15</span><span class="op" id="1575938">)</span>&nbsp;<span class="op" id="1575940">/</span>&nbsp;<span class="num" id="1575942">16</span><br>
<span class="lineno">110</span><span class="op" id="1575945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1575948">//&nbsp;total&nbsp;size&nbsp;of&nbsp;memory&nbsp;block&nbsp;for&nbsp;defer&nbsp;with&nbsp;arg&nbsp;size&nbsp;sz</span><br>
<span class="lineno"></span><span class="keyword" id="1576005">func</span>&nbsp;<span class="ident" id="1576010">totaldefersize</span><span class="op" id="1576024">(</span><span class="ident" id="1576025">siz</span>&nbsp;<span class="builtintype" id="1576029">uintptr</span><span class="op" id="1576036">)</span>&nbsp;<span class="builtintype" id="1576038">uintptr</span>&nbsp;<span class="op" id="1576046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576049">if</span>&nbsp;<span class="ident" id="1576052">siz</span>&nbsp;<span class="op" id="1576056">&lt;=</span>&nbsp;<span class="ident" id="1576059">minDeferArgs</span>&nbsp;<span class="op" id="1576072">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576076">return</span>&nbsp;<span class="ident" id="1576083">minDeferAlloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576101">return</span>&nbsp;<span class="ident" id="1576108">deferHeaderSize</span>&nbsp;<span class="op" id="1576124">+</span>&nbsp;<span class="ident" id="1576126">siz</span><br>
<span class="lineno"></span><span class="op" id="1576130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="1576133">//&nbsp;Ensure&nbsp;that&nbsp;defer&nbsp;arg&nbsp;sizes&nbsp;that&nbsp;map&nbsp;to&nbsp;the&nbsp;same&nbsp;defer&nbsp;size&nbsp;class</span><br>
<span class="lineno"></span><span class="comment" id="1576202">//&nbsp;also&nbsp;map&nbsp;to&nbsp;the&nbsp;same&nbsp;malloc&nbsp;size&nbsp;class.</span><br>
<span class="lineno"></span><span class="keyword" id="1576245">func</span>&nbsp;<span class="ident" id="1576250">testdefersizes</span><span class="op" id="1576264">(</span><span class="op" id="1576265">)</span>&nbsp;<span class="op" id="1576267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576270">var</span>&nbsp;<span class="ident" id="1576274">m</span>&nbsp;<span class="op" id="1576276">[</span><span class="builtinfunc" id="1576277">len</span><span class="op" id="1576280">(</span><span class="ident" id="1576281">p</span><span class="op" id="1576282">{</span><span class="op" id="1576283">}</span><span class="op" id="1576284">.</span><span class="ident" id="1576285">deferpool</span><span class="op" id="1576294">)</span><span class="op" id="1576295">]</span><span class="builtintype" id="1576296">int32</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576304">for</span>&nbsp;<span class="ident" id="1576308">i</span>&nbsp;<span class="op" id="1576310">:=</span>&nbsp;<span class="keyword" id="1576313">range</span>&nbsp;<span class="ident" id="1576319">m</span>&nbsp;<span class="op" id="1576321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576325">m</span><span class="op" id="1576326">[</span><span class="ident" id="1576327">i</span><span class="op" id="1576328">]</span>&nbsp;<span class="op" id="1576330">=</span>&nbsp;<span class="op" id="1576332">-</span><span class="num" id="1576333">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576339">for</span>&nbsp;<span class="ident" id="1576343">i</span>&nbsp;<span class="op" id="1576345">:=</span>&nbsp;<span class="builtintype" id="1576348">uintptr</span><span class="op" id="1576355">(</span><span class="num" id="1576356">0</span><span class="op" id="1576357">)</span><span class="op" id="1576358">;</span>&nbsp;<span class="op" id="1576360">;</span>&nbsp;<span class="ident" id="1576362">i</span><span class="op" id="1576363">++</span>&nbsp;<span class="op" id="1576366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576370">defersc</span>&nbsp;<span class="op" id="1576378">:=</span>&nbsp;<span class="ident" id="1576381">deferclass</span><span class="op" id="1576391">(</span><span class="ident" id="1576392">i</span><span class="op" id="1576393">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576397">if</span>&nbsp;<span class="ident" id="1576400">defersc</span>&nbsp;<span class="op" id="1576408">&gt;=</span>&nbsp;<span class="builtintype" id="1576411">uintptr</span><span class="op" id="1576418">(</span><span class="builtinfunc" id="1576419">len</span><span class="op" id="1576422">(</span><span class="ident" id="1576423">m</span><span class="op" id="1576424">)</span><span class="op" id="1576425">)</span>&nbsp;<span class="op" id="1576427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576432">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576444">siz</span>&nbsp;<span class="op" id="1576448">:=</span>&nbsp;<span class="ident" id="1576451">goroundupsize</span><span class="op" id="1576464">(</span><span class="ident" id="1576465">totaldefersize</span><span class="op" id="1576479">(</span><span class="ident" id="1576480">i</span><span class="op" id="1576481">)</span><span class="op" id="1576482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576486">if</span>&nbsp;<span class="ident" id="1576489">m</span><span class="op" id="1576490">[</span><span class="ident" id="1576491">defersc</span><span class="op" id="1576498">]</span>&nbsp;<span class="op" id="1576500">&lt;</span>&nbsp;<span class="num" id="1576502">0</span>&nbsp;<span class="op" id="1576504">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576509">m</span><span class="op" id="1576510">[</span><span class="ident" id="1576511">defersc</span><span class="op" id="1576518">]</span>&nbsp;<span class="op" id="1576520">=</span>&nbsp;<span class="builtintype" id="1576522">int32</span><span class="op" id="1576527">(</span><span class="ident" id="1576528">siz</span><span class="op" id="1576531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576536">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576551">if</span>&nbsp;<span class="ident" id="1576554">m</span><span class="op" id="1576555">[</span><span class="ident" id="1576556">defersc</span><span class="op" id="1576563">]</span>&nbsp;<span class="op" id="1576565">!=</span>&nbsp;<span class="builtintype" id="1576568">int32</span><span class="op" id="1576573">(</span><span class="ident" id="1576574">siz</span><span class="op" id="1576577">)</span>&nbsp;<span class="op" id="1576579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1576584">print</span><span class="op" id="1576589">(</span><span class="string" id="1576590">&#34;bad&nbsp;defer&nbsp;size&nbsp;class:&nbsp;i=&#34;</span><span class="op" id="1576616">,</span>&nbsp;<span class="ident" id="1576618">i</span><span class="op" id="1576619">,</span>&nbsp;<span class="string" id="1576621">&#34;&nbsp;siz=&#34;</span><span class="op" id="1576628">,</span>&nbsp;<span class="ident" id="1576630">siz</span><span class="op" id="1576633">,</span>&nbsp;<span class="string" id="1576635">&#34;&nbsp;defersc=&#34;</span><span class="op" id="1576646">,</span>&nbsp;<span class="ident" id="1576648">defersc</span><span class="op" id="1576655">,</span>&nbsp;<span class="string" id="1576657">&#34;\n&#34;</span><span class="op" id="1576661">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576666">gothrow</span><span class="op" id="1576673">(</span><span class="string" id="1576674">&#34;bad&nbsp;defer&nbsp;size&nbsp;class&#34;</span><span class="op" id="1576696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576703">}</span><br>
<span class="lineno"></span><span class="op" id="1576705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="1576708">//&nbsp;The&nbsp;arguments&nbsp;associated&nbsp;with&nbsp;a&nbsp;deferred&nbsp;call&nbsp;are&nbsp;stored</span><br>
<span class="lineno"></span><span class="comment" id="1576768">//&nbsp;immediately&nbsp;after&nbsp;the&nbsp;_defer&nbsp;header&nbsp;in&nbsp;memory.</span><br>
<span class="lineno"></span><span class="comment" id="1576818">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1576831">func</span>&nbsp;<span class="ident" id="1576836">deferArgs</span><span class="op" id="1576845">(</span><span class="ident" id="1576846">d</span>&nbsp;<span class="op" id="1576848">*</span><span class="ident" id="1576849">_defer</span><span class="op" id="1576855">)</span>&nbsp;<span class="ident" id="1576857">unsafe</span><span class="op" id="1576863">.</span><span class="ident" id="1576864">Pointer</span>&nbsp;<span class="op" id="1576872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576875">return</span>&nbsp;<span class="ident" id="1576882">add</span><span class="op" id="1576885">(</span><span class="ident" id="1576886">unsafe</span><span class="op" id="1576892">.</span><span class="ident" id="1576893">Pointer</span><span class="op" id="1576900">(</span><span class="ident" id="1576901">d</span><span class="op" id="1576902">)</span><span class="op" id="1576903">,</span>&nbsp;<span class="ident" id="1576905">unsafe</span><span class="op" id="1576911">.</span><span class="ident" id="1576912">Sizeof</span><span class="op" id="1576918">(</span><span class="op" id="1576919">*</span><span class="ident" id="1576920">d</span><span class="op" id="1576921">)</span><span class="op" id="1576922">)</span><br>
<span class="lineno">150</span><span class="op" id="1576924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1576927">var</span>&nbsp;<span class="ident" id="1576931">deferType</span>&nbsp;<span class="op" id="1576941">*</span><span class="ident" id="1576942">_type</span>&nbsp;<span class="comment" id="1576948">//&nbsp;type&nbsp;of&nbsp;_defer&nbsp;struct</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1576974">func</span>&nbsp;<span class="ident" id="1576979">init</span><span class="op" id="1576983">(</span><span class="op" id="1576984">)</span>&nbsp;<span class="op" id="1576986">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576989">var</span>&nbsp;<span class="ident" id="1576993">x</span>&nbsp;<span class="keyword" id="1576995">interface</span><span class="op" id="1577004">{</span><span class="op" id="1577005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577008">x</span>&nbsp;<span class="op" id="1577010">=</span>&nbsp;<span class="op" id="1577012">(</span><span class="op" id="1577013">*</span><span class="ident" id="1577014">_defer</span><span class="op" id="1577020">)</span><span class="op" id="1577021">(</span><span class="ident" id="1577022">nil</span><span class="op" id="1577025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577028">deferType</span>&nbsp;<span class="op" id="1577038">=</span>&nbsp;<span class="op" id="1577040">(</span><span class="op" id="1577041">*</span><span class="op" id="1577042">(</span><span class="op" id="1577043">*</span><span class="op" id="1577044">*</span><span class="ident" id="1577045">ptrtype</span><span class="op" id="1577052">)</span><span class="op" id="1577053">(</span><span class="ident" id="1577054">unsafe</span><span class="op" id="1577060">.</span><span class="ident" id="1577061">Pointer</span><span class="op" id="1577068">(</span><span class="op" id="1577069">&amp;</span><span class="ident" id="1577070">x</span><span class="op" id="1577071">)</span><span class="op" id="1577072">)</span><span class="op" id="1577073">)</span><span class="op" id="1577074">.</span><span class="ident" id="1577075">elem</span><br>
<span class="lineno"></span><span class="op" id="1577080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="1577083">//&nbsp;Allocate&nbsp;a&nbsp;Defer,&nbsp;usually&nbsp;using&nbsp;per-P&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="1577130">//&nbsp;Each&nbsp;defer&nbsp;must&nbsp;be&nbsp;released&nbsp;with&nbsp;freedefer.</span><br>
<span class="lineno"></span><span class="comment" id="1577177">//&nbsp;Note:&nbsp;runs&nbsp;on&nbsp;M&nbsp;stack</span><br>
<span class="lineno"></span><span class="keyword" id="1577202">func</span>&nbsp;<span class="ident" id="1577207">newdefer</span><span class="op" id="1577215">(</span><span class="ident" id="1577216">siz</span>&nbsp;<span class="builtintype" id="1577220">int32</span><span class="op" id="1577225">)</span>&nbsp;<span class="op" id="1577227">*</span><span class="ident" id="1577228">_defer</span>&nbsp;<span class="op" id="1577235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577238">var</span>&nbsp;<span class="ident" id="1577242">d</span>&nbsp;<span class="op" id="1577244">*</span><span class="ident" id="1577245">_defer</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577253">sc</span>&nbsp;<span class="op" id="1577256">:=</span>&nbsp;<span class="ident" id="1577259">deferclass</span><span class="op" id="1577269">(</span><span class="builtintype" id="1577270">uintptr</span><span class="op" id="1577277">(</span><span class="ident" id="1577278">siz</span><span class="op" id="1577281">)</span><span class="op" id="1577282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577285">mp</span>&nbsp;<span class="op" id="1577288">:=</span>&nbsp;<span class="ident" id="1577291">acquirem</span><span class="op" id="1577299">(</span><span class="op" id="1577300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577303">if</span>&nbsp;<span class="ident" id="1577306">sc</span>&nbsp;<span class="op" id="1577309">&lt;</span>&nbsp;<span class="builtintype" id="1577311">uintptr</span><span class="op" id="1577318">(</span><span class="builtinfunc" id="1577319">len</span><span class="op" id="1577322">(</span><span class="ident" id="1577323">p</span><span class="op" id="1577324">{</span><span class="op" id="1577325">}</span><span class="op" id="1577326">.</span><span class="ident" id="1577327">deferpool</span><span class="op" id="1577336">)</span><span class="op" id="1577337">)</span>&nbsp;<span class="op" id="1577339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577343">pp</span>&nbsp;<span class="op" id="1577346">:=</span>&nbsp;<span class="ident" id="1577349">mp</span><span class="op" id="1577351">.</span><span class="ident" id="1577352">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577356">d</span>&nbsp;<span class="op" id="1577358">=</span>&nbsp;<span class="ident" id="1577360">pp</span><span class="op" id="1577362">.</span><span class="ident" id="1577363">deferpool</span><span class="op" id="1577372">[</span><span class="ident" id="1577373">sc</span><span class="op" id="1577375">]</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577379">if</span>&nbsp;<span class="ident" id="1577382">d</span>&nbsp;<span class="op" id="1577384">!=</span>&nbsp;<span class="ident" id="1577387">nil</span>&nbsp;<span class="op" id="1577391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577396">pp</span><span class="op" id="1577398">.</span><span class="ident" id="1577399">deferpool</span><span class="op" id="1577408">[</span><span class="ident" id="1577409">sc</span><span class="op" id="1577411">]</span>&nbsp;<span class="op" id="1577413">=</span>&nbsp;<span class="ident" id="1577415">d</span><span class="op" id="1577416">.</span><span class="ident" id="1577417">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577430">if</span>&nbsp;<span class="ident" id="1577433">d</span>&nbsp;<span class="op" id="1577435">==</span>&nbsp;<span class="ident" id="1577438">nil</span>&nbsp;<span class="op" id="1577442">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577446">//&nbsp;Allocate&nbsp;new&nbsp;defer+args.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577476">total</span>&nbsp;<span class="op" id="1577482">:=</span>&nbsp;<span class="ident" id="1577485">goroundupsize</span><span class="op" id="1577498">(</span><span class="ident" id="1577499">totaldefersize</span><span class="op" id="1577513">(</span><span class="builtintype" id="1577514">uintptr</span><span class="op" id="1577521">(</span><span class="ident" id="1577522">siz</span><span class="op" id="1577525">)</span><span class="op" id="1577526">)</span><span class="op" id="1577527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577531">d</span>&nbsp;<span class="op" id="1577533">=</span>&nbsp;<span class="op" id="1577535">(</span><span class="op" id="1577536">*</span><span class="ident" id="1577537">_defer</span><span class="op" id="1577543">)</span><span class="op" id="1577544">(</span><span class="ident" id="1577545">mallocgc</span><span class="op" id="1577553">(</span><span class="ident" id="1577554">total</span><span class="op" id="1577559">,</span>&nbsp;<span class="ident" id="1577561">deferType</span><span class="op" id="1577570">,</span>&nbsp;<span class="num" id="1577572">0</span><span class="op" id="1577573">)</span><span class="op" id="1577574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577580">d</span><span class="op" id="1577581">.</span><span class="ident" id="1577582">siz</span>&nbsp;<span class="op" id="1577586">=</span>&nbsp;<span class="ident" id="1577588">siz</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577593">gp</span>&nbsp;<span class="op" id="1577596">:=</span>&nbsp;<span class="ident" id="1577599">mp</span><span class="op" id="1577601">.</span><span class="ident" id="1577602">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577608">d</span><span class="op" id="1577609">.</span><span class="ident" id="1577610">link</span>&nbsp;<span class="op" id="1577615">=</span>&nbsp;<span class="ident" id="1577617">gp</span><span class="op" id="1577619">.</span><span class="ident" id="1577620">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577628">gp</span><span class="op" id="1577630">.</span><span class="ident" id="1577631">_defer</span>&nbsp;<span class="op" id="1577638">=</span>&nbsp;<span class="ident" id="1577640">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577643">releasem</span><span class="op" id="1577651">(</span><span class="ident" id="1577652">mp</span><span class="op" id="1577654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577657">return</span>&nbsp;<span class="ident" id="1577664">d</span><br>
<span class="lineno">185</span><span class="op" id="1577666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1577669">//&nbsp;Free&nbsp;the&nbsp;given&nbsp;defer.</span><br>
<span class="lineno"></span><span class="comment" id="1577694">//&nbsp;The&nbsp;defer&nbsp;cannot&nbsp;be&nbsp;used&nbsp;after&nbsp;this&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="1577739">//go:nosplit</span><br>
<span class="lineno">190</span><span class="keyword" id="1577752">func</span>&nbsp;<span class="ident" id="1577757">freedefer</span><span class="op" id="1577766">(</span><span class="ident" id="1577767">d</span>&nbsp;<span class="op" id="1577769">*</span><span class="ident" id="1577770">_defer</span><span class="op" id="1577776">)</span>&nbsp;<span class="op" id="1577778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577781">if</span>&nbsp;<span class="ident" id="1577784">d</span><span class="op" id="1577785">.</span><span class="ident" id="1577786">_panic</span>&nbsp;<span class="op" id="1577793">!=</span>&nbsp;<span class="ident" id="1577796">nil</span>&nbsp;<span class="op" id="1577800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577804">freedeferpanic</span><span class="op" id="1577818">(</span><span class="op" id="1577819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577825">if</span>&nbsp;<span class="ident" id="1577828">d</span><span class="op" id="1577829">.</span><span class="ident" id="1577830">fn</span>&nbsp;<span class="op" id="1577833">!=</span>&nbsp;<span class="ident" id="1577836">nil</span>&nbsp;<span class="op" id="1577840">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577844">freedeferfn</span><span class="op" id="1577855">(</span><span class="op" id="1577856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577862">sc</span>&nbsp;<span class="op" id="1577865">:=</span>&nbsp;<span class="ident" id="1577868">deferclass</span><span class="op" id="1577878">(</span><span class="builtintype" id="1577879">uintptr</span><span class="op" id="1577886">(</span><span class="ident" id="1577887">d</span><span class="op" id="1577888">.</span><span class="ident" id="1577889">siz</span><span class="op" id="1577892">)</span><span class="op" id="1577893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577896">if</span>&nbsp;<span class="ident" id="1577899">sc</span>&nbsp;<span class="op" id="1577902">&lt;</span>&nbsp;<span class="builtintype" id="1577904">uintptr</span><span class="op" id="1577911">(</span><span class="builtinfunc" id="1577912">len</span><span class="op" id="1577915">(</span><span class="ident" id="1577916">p</span><span class="op" id="1577917">{</span><span class="op" id="1577918">}</span><span class="op" id="1577919">.</span><span class="ident" id="1577920">deferpool</span><span class="op" id="1577929">)</span><span class="op" id="1577930">)</span>&nbsp;<span class="op" id="1577932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577936">mp</span>&nbsp;<span class="op" id="1577939">:=</span>&nbsp;<span class="ident" id="1577942">acquirem</span><span class="op" id="1577950">(</span><span class="op" id="1577951">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577955">pp</span>&nbsp;<span class="op" id="1577958">:=</span>&nbsp;<span class="ident" id="1577961">mp</span><span class="op" id="1577963">.</span><span class="ident" id="1577964">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577968">*</span><span class="ident" id="1577969">d</span>&nbsp;<span class="op" id="1577971">=</span>&nbsp;<span class="ident" id="1577973">_defer</span><span class="op" id="1577979">{</span><span class="op" id="1577980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577984">d</span><span class="op" id="1577985">.</span><span class="ident" id="1577986">link</span>&nbsp;<span class="op" id="1577991">=</span>&nbsp;<span class="ident" id="1577993">pp</span><span class="op" id="1577995">.</span><span class="ident" id="1577996">deferpool</span><span class="op" id="1578005">[</span><span class="ident" id="1578006">sc</span><span class="op" id="1578008">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578012">pp</span><span class="op" id="1578014">.</span><span class="ident" id="1578015">deferpool</span><span class="op" id="1578024">[</span><span class="ident" id="1578025">sc</span><span class="op" id="1578027">]</span>&nbsp;<span class="op" id="1578029">=</span>&nbsp;<span class="ident" id="1578031">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578035">releasem</span><span class="op" id="1578043">(</span><span class="ident" id="1578044">mp</span><span class="op" id="1578046">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1578049">}</span><br>
<span class="lineno"></span><span class="op" id="1578051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1578054">//&nbsp;Separate&nbsp;function&nbsp;so&nbsp;that&nbsp;it&nbsp;can&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1578103">//&nbsp;Windows&nbsp;otherwise&nbsp;runs&nbsp;out&nbsp;of&nbsp;stack&nbsp;space.</span><br>
<span class="lineno">210</span><span class="keyword" id="1578149">func</span>&nbsp;<span class="ident" id="1578154">freedeferpanic</span><span class="op" id="1578168">(</span><span class="op" id="1578169">)</span>&nbsp;<span class="op" id="1578171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578174">//&nbsp;_panic&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;d&nbsp;is&nbsp;unlinked&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578231">gothrow</span><span class="op" id="1578238">(</span><span class="string" id="1578239">&#34;freedefer&nbsp;with&nbsp;d._panic&nbsp;!=&nbsp;nil&#34;</span><span class="op" id="1578271">)</span><br>
<span class="lineno"></span><span class="op" id="1578273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="1578276">func</span>&nbsp;<span class="ident" id="1578281">freedeferfn</span><span class="op" id="1578292">(</span><span class="op" id="1578293">)</span>&nbsp;<span class="op" id="1578295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1578298">//&nbsp;fn&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;d&nbsp;is&nbsp;unlinked&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578351">gothrow</span><span class="op" id="1578358">(</span><span class="string" id="1578359">&#34;freedefer&nbsp;with&nbsp;d.fn&nbsp;!=&nbsp;nil&#34;</span><span class="op" id="1578387">)</span><br>
<span class="lineno"></span><span class="op" id="1578389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span><span class="comment" id="1578392">//&nbsp;Run&nbsp;a&nbsp;deferred&nbsp;function&nbsp;if&nbsp;there&nbsp;is&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1578436">//&nbsp;The&nbsp;compiler&nbsp;inserts&nbsp;a&nbsp;call&nbsp;to&nbsp;this&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="1578493">//&nbsp;function&nbsp;which&nbsp;calls&nbsp;defer.</span><br>
<span class="lineno"></span><span class="comment" id="1578524">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;deferred&nbsp;function,&nbsp;this&nbsp;will&nbsp;call&nbsp;runtime·jmpdefer,</span><br>
<span class="lineno"></span><span class="comment" id="1578594">//&nbsp;which&nbsp;will&nbsp;jump&nbsp;to&nbsp;the&nbsp;deferred&nbsp;function&nbsp;such&nbsp;that&nbsp;it&nbsp;appears</span><br>
<span class="lineno">225</span><span class="comment" id="1578659">//&nbsp;to&nbsp;have&nbsp;been&nbsp;called&nbsp;by&nbsp;the&nbsp;caller&nbsp;of&nbsp;deferreturn&nbsp;at&nbsp;the&nbsp;point</span><br>
<span class="lineno"></span><span class="comment" id="1578724">//&nbsp;just&nbsp;before&nbsp;deferreturn&nbsp;was&nbsp;called.&nbsp;&nbsp;The&nbsp;effect&nbsp;is&nbsp;that&nbsp;deferreturn</span><br>
<span class="lineno"></span><span class="comment" id="1578795">//&nbsp;is&nbsp;called&nbsp;again&nbsp;and&nbsp;again&nbsp;until&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;deferred&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="1578868">//&nbsp;Cannot&nbsp;split&nbsp;the&nbsp;stack&nbsp;because&nbsp;we&nbsp;reuse&nbsp;the&nbsp;caller&#39;s&nbsp;frame&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1578933">//&nbsp;call&nbsp;the&nbsp;deferred&nbsp;function.</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="1578965">//&nbsp;The&nbsp;single&nbsp;argument&nbsp;isn&#39;t&nbsp;actually&nbsp;used&nbsp;-&nbsp;it&nbsp;just&nbsp;has&nbsp;its&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="1579034">//&nbsp;taken&nbsp;so&nbsp;it&nbsp;can&nbsp;be&nbsp;matched&nbsp;against&nbsp;pending&nbsp;defers.</span><br>
<span class="lineno"></span><span class="comment" id="1579088">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1579101">func</span>&nbsp;<span class="ident" id="1579106">deferreturn</span><span class="op" id="1579117">(</span><span class="ident" id="1579118">arg0</span>&nbsp;<span class="builtintype" id="1579123">uintptr</span><span class="op" id="1579130">)</span>&nbsp;<span class="op" id="1579132">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579135">gp</span>&nbsp;<span class="op" id="1579138">:=</span>&nbsp;<span class="ident" id="1579141">getg</span><span class="op" id="1579145">(</span><span class="op" id="1579146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579149">d</span>&nbsp;<span class="op" id="1579151">:=</span>&nbsp;<span class="ident" id="1579154">gp</span><span class="op" id="1579156">.</span><span class="ident" id="1579157">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579165">if</span>&nbsp;<span class="ident" id="1579168">d</span>&nbsp;<span class="op" id="1579170">==</span>&nbsp;<span class="ident" id="1579173">nil</span>&nbsp;<span class="op" id="1579177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579181">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1579189">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579192">argp</span>&nbsp;<span class="op" id="1579197">:=</span>&nbsp;<span class="builtintype" id="1579200">uintptr</span><span class="op" id="1579207">(</span><span class="ident" id="1579208">unsafe</span><span class="op" id="1579214">.</span><span class="ident" id="1579215">Pointer</span><span class="op" id="1579222">(</span><span class="op" id="1579223">&amp;</span><span class="ident" id="1579224">arg0</span><span class="op" id="1579228">)</span><span class="op" id="1579229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579232">if</span>&nbsp;<span class="ident" id="1579235">d</span><span class="op" id="1579236">.</span><span class="ident" id="1579237">argp</span>&nbsp;<span class="op" id="1579242">!=</span>&nbsp;<span class="ident" id="1579245">argp</span>&nbsp;<span class="op" id="1579250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579254">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1579262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579266">//&nbsp;Moving&nbsp;arguments&nbsp;around.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579295">//&nbsp;Do&nbsp;not&nbsp;allow&nbsp;preemption&nbsp;here,&nbsp;because&nbsp;the&nbsp;garbage&nbsp;collector</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579359">//&nbsp;won&#39;t&nbsp;know&nbsp;the&nbsp;form&nbsp;of&nbsp;the&nbsp;arguments&nbsp;until&nbsp;the&nbsp;jmpdefer&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579423">//&nbsp;flip&nbsp;the&nbsp;PC&nbsp;over&nbsp;to&nbsp;fn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579451">mp</span>&nbsp;<span class="op" id="1579454">:=</span>&nbsp;<span class="ident" id="1579457">acquirem</span><span class="op" id="1579465">(</span><span class="op" id="1579466">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579469">memmove</span><span class="op" id="1579476">(</span><span class="ident" id="1579477">unsafe</span><span class="op" id="1579483">.</span><span class="ident" id="1579484">Pointer</span><span class="op" id="1579491">(</span><span class="ident" id="1579492">argp</span><span class="op" id="1579496">)</span><span class="op" id="1579497">,</span>&nbsp;<span class="ident" id="1579499">deferArgs</span><span class="op" id="1579508">(</span><span class="ident" id="1579509">d</span><span class="op" id="1579510">)</span><span class="op" id="1579511">,</span>&nbsp;<span class="builtintype" id="1579513">uintptr</span><span class="op" id="1579520">(</span><span class="ident" id="1579521">d</span><span class="op" id="1579522">.</span><span class="ident" id="1579523">siz</span><span class="op" id="1579526">)</span><span class="op" id="1579527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579530">fn</span>&nbsp;<span class="op" id="1579533">:=</span>&nbsp;<span class="ident" id="1579536">d</span><span class="op" id="1579537">.</span><span class="ident" id="1579538">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579542">d</span><span class="op" id="1579543">.</span><span class="ident" id="1579544">fn</span>&nbsp;<span class="op" id="1579547">=</span>&nbsp;<span class="ident" id="1579549">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579554">gp</span><span class="op" id="1579556">.</span><span class="ident" id="1579557">_defer</span>&nbsp;<span class="op" id="1579564">=</span>&nbsp;<span class="ident" id="1579566">d</span><span class="op" id="1579567">.</span><span class="ident" id="1579568">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579574">freedefer</span><span class="op" id="1579583">(</span><span class="ident" id="1579584">d</span><span class="op" id="1579585">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579588">releasem</span><span class="op" id="1579596">(</span><span class="ident" id="1579597">mp</span><span class="op" id="1579599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579602">jmpdefer</span><span class="op" id="1579610">(</span><span class="ident" id="1579611">fn</span><span class="op" id="1579613">,</span>&nbsp;<span class="ident" id="1579615">argp</span><span class="op" id="1579619">)</span><br>
<span class="lineno"></span><span class="op" id="1579621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1579624">//&nbsp;Goexit&nbsp;terminates&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;calls&nbsp;it.&nbsp;&nbsp;No&nbsp;other&nbsp;goroutine&nbsp;is&nbsp;affected.</span><br>
<span class="lineno">260</span><span class="comment" id="1579707">//&nbsp;Goexit&nbsp;runs&nbsp;all&nbsp;deferred&nbsp;calls&nbsp;before&nbsp;terminating&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;Because&nbsp;Goexit</span><br>
<span class="lineno"></span><span class="comment" id="1579791">//&nbsp;is&nbsp;not&nbsp;panic,&nbsp;however,&nbsp;any&nbsp;recover&nbsp;calls&nbsp;in&nbsp;those&nbsp;deferred&nbsp;functions&nbsp;will&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1579880">//</span><br>
<span class="lineno"></span><span class="comment" id="1579883">//&nbsp;Calling&nbsp;Goexit&nbsp;from&nbsp;the&nbsp;main&nbsp;goroutine&nbsp;terminates&nbsp;that&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1579951">//&nbsp;without&nbsp;func&nbsp;main&nbsp;returning.&nbsp;Since&nbsp;func&nbsp;main&nbsp;has&nbsp;not&nbsp;returned,</span><br>
<span class="lineno">265</span><span class="comment" id="1580017">//&nbsp;the&nbsp;program&nbsp;continues&nbsp;execution&nbsp;of&nbsp;other&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="1580073">//&nbsp;If&nbsp;all&nbsp;other&nbsp;goroutines&nbsp;exit,&nbsp;the&nbsp;program&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="1580127">func</span>&nbsp;<span class="ident" id="1580132">Goexit</span><span class="op" id="1580138">(</span><span class="op" id="1580139">)</span>&nbsp;<span class="op" id="1580141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580144">//&nbsp;Run&nbsp;all&nbsp;deferred&nbsp;functions&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580202">//&nbsp;This&nbsp;code&nbsp;is&nbsp;similar&nbsp;to&nbsp;gopanic,&nbsp;see&nbsp;that&nbsp;implementation</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580263">//&nbsp;for&nbsp;detailed&nbsp;comments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580290">gp</span>&nbsp;<span class="op" id="1580293">:=</span>&nbsp;<span class="ident" id="1580296">getg</span><span class="op" id="1580300">(</span><span class="op" id="1580301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580304">for</span>&nbsp;<span class="op" id="1580308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580312">d</span>&nbsp;<span class="op" id="1580314">:=</span>&nbsp;<span class="ident" id="1580317">gp</span><span class="op" id="1580319">.</span><span class="ident" id="1580320">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580329">if</span>&nbsp;<span class="ident" id="1580332">d</span>&nbsp;<span class="op" id="1580334">==</span>&nbsp;<span class="ident" id="1580337">nil</span>&nbsp;<span class="op" id="1580341">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580346">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580358">if</span>&nbsp;<span class="ident" id="1580361">d</span><span class="op" id="1580362">.</span><span class="ident" id="1580363">started</span>&nbsp;<span class="op" id="1580371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580376">if</span>&nbsp;<span class="ident" id="1580379">d</span><span class="op" id="1580380">.</span><span class="ident" id="1580381">_panic</span>&nbsp;<span class="op" id="1580388">!=</span>&nbsp;<span class="ident" id="1580391">nil</span>&nbsp;<span class="op" id="1580395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580401">d</span><span class="op" id="1580402">.</span><span class="ident" id="1580403">_panic</span><span class="op" id="1580409">.</span><span class="ident" id="1580410">aborted</span>&nbsp;<span class="op" id="1580418">=</span>&nbsp;<span class="builtintype" id="1580420">true</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580429">d</span><span class="op" id="1580430">.</span><span class="ident" id="1580431">_panic</span>&nbsp;<span class="op" id="1580438">=</span>&nbsp;<span class="ident" id="1580440">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580452">d</span><span class="op" id="1580453">.</span><span class="ident" id="1580454">fn</span>&nbsp;<span class="op" id="1580457">=</span>&nbsp;<span class="ident" id="1580459">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580466">gp</span><span class="op" id="1580468">.</span><span class="ident" id="1580469">_defer</span>&nbsp;<span class="op" id="1580476">=</span>&nbsp;<span class="ident" id="1580478">d</span><span class="op" id="1580479">.</span><span class="ident" id="1580480">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580488">freedefer</span><span class="op" id="1580497">(</span><span class="ident" id="1580498">d</span><span class="op" id="1580499">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580504">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580519">d</span><span class="op" id="1580520">.</span><span class="ident" id="1580521">started</span>&nbsp;<span class="op" id="1580529">=</span>&nbsp;<span class="builtintype" id="1580531">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580538">reflectcall</span><span class="op" id="1580549">(</span><span class="ident" id="1580550">unsafe</span><span class="op" id="1580556">.</span><span class="ident" id="1580557">Pointer</span><span class="op" id="1580564">(</span><span class="ident" id="1580565">d</span><span class="op" id="1580566">.</span><span class="ident" id="1580567">fn</span><span class="op" id="1580569">)</span><span class="op" id="1580570">,</span>&nbsp;<span class="ident" id="1580572">deferArgs</span><span class="op" id="1580581">(</span><span class="ident" id="1580582">d</span><span class="op" id="1580583">)</span><span class="op" id="1580584">,</span>&nbsp;<span class="builtintype" id="1580586">uint32</span><span class="op" id="1580592">(</span><span class="ident" id="1580593">d</span><span class="op" id="1580594">.</span><span class="ident" id="1580595">siz</span><span class="op" id="1580598">)</span><span class="op" id="1580599">,</span>&nbsp;<span class="builtintype" id="1580601">uint32</span><span class="op" id="1580607">(</span><span class="ident" id="1580608">d</span><span class="op" id="1580609">.</span><span class="ident" id="1580610">siz</span><span class="op" id="1580613">)</span><span class="op" id="1580614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580618">if</span>&nbsp;<span class="ident" id="1580621">gp</span><span class="op" id="1580623">.</span><span class="ident" id="1580624">_defer</span>&nbsp;<span class="op" id="1580631">!=</span>&nbsp;<span class="ident" id="1580634">d</span>&nbsp;<span class="op" id="1580636">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580641">gothrow</span><span class="op" id="1580648">(</span><span class="string" id="1580649">&#34;bad&nbsp;defer&nbsp;entry&nbsp;in&nbsp;Goexit&#34;</span><span class="op" id="1580676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580684">d</span><span class="op" id="1580685">.</span><span class="ident" id="1580686">_panic</span>&nbsp;<span class="op" id="1580693">=</span>&nbsp;<span class="ident" id="1580695">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580701">d</span><span class="op" id="1580702">.</span><span class="ident" id="1580703">fn</span>&nbsp;<span class="op" id="1580706">=</span>&nbsp;<span class="ident" id="1580708">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580714">gp</span><span class="op" id="1580716">.</span><span class="ident" id="1580717">_defer</span>&nbsp;<span class="op" id="1580724">=</span>&nbsp;<span class="ident" id="1580726">d</span><span class="op" id="1580727">.</span><span class="ident" id="1580728">link</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580735">freedefer</span><span class="op" id="1580744">(</span><span class="ident" id="1580745">d</span><span class="op" id="1580746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580750">//&nbsp;Note:&nbsp;we&nbsp;ignore&nbsp;recovers&nbsp;here&nbsp;because&nbsp;Goexit&nbsp;isn&#39;t&nbsp;a&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580816">goexit</span><span class="op" id="1580822">(</span><span class="op" id="1580823">)</span><br>
<span class="lineno"></span><span class="op" id="1580825">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span><span class="keyword" id="1580828">func</span>&nbsp;<span class="ident" id="1580833">canpanic</span><span class="op" id="1580841">(</span><span class="op" id="1580842">*</span><span class="ident" id="1580843">g</span><span class="op" id="1580844">)</span>&nbsp;<span class="builtintype" id="1580846">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1580852">//&nbsp;Print&nbsp;all&nbsp;currently&nbsp;active&nbsp;panics.&nbsp;&nbsp;Used&nbsp;when&nbsp;crashing.</span><br>
<span class="lineno"></span><span class="keyword" id="1580911">func</span>&nbsp;<span class="ident" id="1580916">printpanics</span><span class="op" id="1580927">(</span><span class="ident" id="1580928">p</span>&nbsp;<span class="op" id="1580930">*</span><span class="ident" id="1580931">_panic</span><span class="op" id="1580937">)</span>&nbsp;<span class="op" id="1580939">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580942">if</span>&nbsp;<span class="ident" id="1580945">p</span><span class="op" id="1580946">.</span><span class="ident" id="1580947">link</span>&nbsp;<span class="op" id="1580952">!=</span>&nbsp;<span class="ident" id="1580955">nil</span>&nbsp;<span class="op" id="1580959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580963">printpanics</span><span class="op" id="1580974">(</span><span class="ident" id="1580975">p</span><span class="op" id="1580976">.</span><span class="ident" id="1580977">link</span><span class="op" id="1580981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1580985">print</span><span class="op" id="1580990">(</span><span class="string" id="1580991">&#34;\t&#34;</span><span class="op" id="1580995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1581001">print</span><span class="op" id="1581006">(</span><span class="string" id="1581007">&#34;panic:&nbsp;&#34;</span><span class="op" id="1581016">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581019">printany</span><span class="op" id="1581027">(</span><span class="ident" id="1581028">p</span><span class="op" id="1581029">.</span><span class="ident" id="1581030">arg</span><span class="op" id="1581033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581036">if</span>&nbsp;<span class="ident" id="1581039">p</span><span class="op" id="1581040">.</span><span class="ident" id="1581041">recovered</span>&nbsp;<span class="op" id="1581051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1581055">print</span><span class="op" id="1581060">(</span><span class="string" id="1581061">&#34;&nbsp;[recovered]&#34;</span><span class="op" id="1581075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1581081">print</span><span class="op" id="1581086">(</span><span class="string" id="1581087">&#34;\n&#34;</span><span class="op" id="1581091">)</span><br>
<span class="lineno">315</span><span class="op" id="1581093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1581096">//&nbsp;The&nbsp;implementation&nbsp;of&nbsp;the&nbsp;predeclared&nbsp;function&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="1581153">func</span>&nbsp;<span class="ident" id="1581158">gopanic</span><span class="op" id="1581165">(</span><span class="ident" id="1581166">e</span>&nbsp;<span class="keyword" id="1581168">interface</span><span class="op" id="1581177">{</span><span class="op" id="1581178">}</span><span class="op" id="1581179">)</span>&nbsp;<span class="op" id="1581181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581184">gp</span>&nbsp;<span class="op" id="1581187">:=</span>&nbsp;<span class="ident" id="1581190">getg</span><span class="op" id="1581194">(</span><span class="op" id="1581195">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581198">if</span>&nbsp;<span class="ident" id="1581201">gp</span><span class="op" id="1581203">.</span><span class="ident" id="1581204">m</span><span class="op" id="1581205">.</span><span class="ident" id="1581206">curg</span>&nbsp;<span class="op" id="1581211">!=</span>&nbsp;<span class="ident" id="1581214">gp</span>&nbsp;<span class="op" id="1581217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581221">gothrow</span><span class="op" id="1581228">(</span><span class="string" id="1581229">&#34;panic&nbsp;on&nbsp;m&nbsp;stack&#34;</span><span class="op" id="1581247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581254">//&nbsp;m.softfloat&nbsp;is&nbsp;set&nbsp;during&nbsp;software&nbsp;floating&nbsp;point.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581309">//&nbsp;It&nbsp;increments&nbsp;m.locks&nbsp;to&nbsp;avoid&nbsp;preemption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581356">//&nbsp;We&nbsp;moved&nbsp;the&nbsp;memory&nbsp;loads&nbsp;out,&nbsp;so&nbsp;there&nbsp;shouldn&#39;t&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581413">//&nbsp;any&nbsp;reason&nbsp;for&nbsp;it&nbsp;to&nbsp;panic&nbsp;anymore.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581453">if</span>&nbsp;<span class="ident" id="1581456">gp</span><span class="op" id="1581458">.</span><span class="ident" id="1581459">m</span><span class="op" id="1581460">.</span><span class="ident" id="1581461">softfloat</span>&nbsp;<span class="op" id="1581471">!=</span>&nbsp;<span class="num" id="1581474">0</span>&nbsp;<span class="op" id="1581476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581480">gp</span><span class="op" id="1581482">.</span><span class="ident" id="1581483">m</span><span class="op" id="1581484">.</span><span class="ident" id="1581485">locks</span><span class="op" id="1581490">--</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581495">gp</span><span class="op" id="1581497">.</span><span class="ident" id="1581498">m</span><span class="op" id="1581499">.</span><span class="ident" id="1581500">softfloat</span>&nbsp;<span class="op" id="1581510">=</span>&nbsp;<span class="num" id="1581512">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581516">gothrow</span><span class="op" id="1581523">(</span><span class="string" id="1581524">&#34;panic&nbsp;during&nbsp;softfloat&#34;</span><span class="op" id="1581548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581554">if</span>&nbsp;<span class="ident" id="1581557">gp</span><span class="op" id="1581559">.</span><span class="ident" id="1581560">m</span><span class="op" id="1581561">.</span><span class="ident" id="1581562">mallocing</span>&nbsp;<span class="op" id="1581572">!=</span>&nbsp;<span class="num" id="1581575">0</span>&nbsp;<span class="op" id="1581577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1581581">print</span><span class="op" id="1581586">(</span><span class="string" id="1581587">&#34;panic:&nbsp;&#34;</span><span class="op" id="1581596">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581600">printany</span><span class="op" id="1581608">(</span><span class="ident" id="1581609">e</span><span class="op" id="1581610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1581614">print</span><span class="op" id="1581619">(</span><span class="string" id="1581620">&#34;\n&#34;</span><span class="op" id="1581624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581628">gothrow</span><span class="op" id="1581635">(</span><span class="string" id="1581636">&#34;panic&nbsp;during&nbsp;malloc&#34;</span><span class="op" id="1581657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581663">if</span>&nbsp;<span class="ident" id="1581666">gp</span><span class="op" id="1581668">.</span><span class="ident" id="1581669">m</span><span class="op" id="1581670">.</span><span class="ident" id="1581671">gcing</span>&nbsp;<span class="op" id="1581677">!=</span>&nbsp;<span class="num" id="1581680">0</span>&nbsp;<span class="op" id="1581682">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1581686">print</span><span class="op" id="1581691">(</span><span class="string" id="1581692">&#34;panic:&nbsp;&#34;</span><span class="op" id="1581701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581705">printany</span><span class="op" id="1581713">(</span><span class="ident" id="1581714">e</span><span class="op" id="1581715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1581719">print</span><span class="op" id="1581724">(</span><span class="string" id="1581725">&#34;\n&#34;</span><span class="op" id="1581729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581733">gothrow</span><span class="op" id="1581740">(</span><span class="string" id="1581741">&#34;panic&nbsp;during&nbsp;gc&#34;</span><span class="op" id="1581758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581761">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581764">if</span>&nbsp;<span class="ident" id="1581767">gp</span><span class="op" id="1581769">.</span><span class="ident" id="1581770">m</span><span class="op" id="1581771">.</span><span class="ident" id="1581772">locks</span>&nbsp;<span class="op" id="1581778">!=</span>&nbsp;<span class="num" id="1581781">0</span>&nbsp;<span class="op" id="1581783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1581787">print</span><span class="op" id="1581792">(</span><span class="string" id="1581793">&#34;panic:&nbsp;&#34;</span><span class="op" id="1581802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581806">printany</span><span class="op" id="1581814">(</span><span class="ident" id="1581815">e</span><span class="op" id="1581816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1581820">print</span><span class="op" id="1581825">(</span><span class="string" id="1581826">&#34;\n&#34;</span><span class="op" id="1581830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581834">gothrow</span><span class="op" id="1581841">(</span><span class="string" id="1581842">&#34;panic&nbsp;holding&nbsp;locks&#34;</span><span class="op" id="1581863">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581870">var</span>&nbsp;<span class="ident" id="1581874">p</span>&nbsp;<span class="ident" id="1581876">_panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581884">p</span><span class="op" id="1581885">.</span><span class="ident" id="1581886">arg</span>&nbsp;<span class="op" id="1581890">=</span>&nbsp;<span class="ident" id="1581892">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581895">p</span><span class="op" id="1581896">.</span><span class="ident" id="1581897">link</span>&nbsp;<span class="op" id="1581902">=</span>&nbsp;<span class="ident" id="1581904">gp</span><span class="op" id="1581906">.</span><span class="ident" id="1581907">_panic</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581915">gp</span><span class="op" id="1581917">.</span><span class="ident" id="1581918">_panic</span>&nbsp;<span class="op" id="1581925">=</span>&nbsp;<span class="op" id="1581927">(</span><span class="op" id="1581928">*</span><span class="ident" id="1581929">_panic</span><span class="op" id="1581935">)</span><span class="op" id="1581936">(</span><span class="ident" id="1581937">noescape</span><span class="op" id="1581945">(</span><span class="ident" id="1581946">unsafe</span><span class="op" id="1581952">.</span><span class="ident" id="1581953">Pointer</span><span class="op" id="1581960">(</span><span class="op" id="1581961">&amp;</span><span class="ident" id="1581962">p</span><span class="op" id="1581963">)</span><span class="op" id="1581964">)</span><span class="op" id="1581965">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581969">for</span>&nbsp;<span class="op" id="1581973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581977">d</span>&nbsp;<span class="op" id="1581979">:=</span>&nbsp;<span class="ident" id="1581982">gp</span><span class="op" id="1581984">.</span><span class="ident" id="1581985">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581994">if</span>&nbsp;<span class="ident" id="1581997">d</span>&nbsp;<span class="op" id="1581999">==</span>&nbsp;<span class="ident" id="1582002">nil</span>&nbsp;<span class="op" id="1582006">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582011">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582024">//&nbsp;If&nbsp;defer&nbsp;was&nbsp;started&nbsp;by&nbsp;earlier&nbsp;panic&nbsp;or&nbsp;Goexit&nbsp;(and,&nbsp;since&nbsp;we&#39;re&nbsp;back&nbsp;here,&nbsp;that&nbsp;triggered&nbsp;a&nbsp;new&nbsp;panic),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582135">//&nbsp;take&nbsp;defer&nbsp;off&nbsp;list.&nbsp;The&nbsp;earlier&nbsp;panic&nbsp;or&nbsp;Goexit&nbsp;will&nbsp;not&nbsp;continue&nbsp;running.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582216">if</span>&nbsp;<span class="ident" id="1582219">d</span><span class="op" id="1582220">.</span><span class="ident" id="1582221">started</span>&nbsp;<span class="op" id="1582229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582234">if</span>&nbsp;<span class="ident" id="1582237">d</span><span class="op" id="1582238">.</span><span class="ident" id="1582239">_panic</span>&nbsp;<span class="op" id="1582246">!=</span>&nbsp;<span class="ident" id="1582249">nil</span>&nbsp;<span class="op" id="1582253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582259">d</span><span class="op" id="1582260">.</span><span class="ident" id="1582261">_panic</span><span class="op" id="1582267">.</span><span class="ident" id="1582268">aborted</span>&nbsp;<span class="op" id="1582276">=</span>&nbsp;<span class="builtintype" id="1582278">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582291">d</span><span class="op" id="1582292">.</span><span class="ident" id="1582293">_panic</span>&nbsp;<span class="op" id="1582300">=</span>&nbsp;<span class="ident" id="1582302">nil</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582309">d</span><span class="op" id="1582310">.</span><span class="ident" id="1582311">fn</span>&nbsp;<span class="op" id="1582314">=</span>&nbsp;<span class="ident" id="1582316">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582323">gp</span><span class="op" id="1582325">.</span><span class="ident" id="1582326">_defer</span>&nbsp;<span class="op" id="1582333">=</span>&nbsp;<span class="ident" id="1582335">d</span><span class="op" id="1582336">.</span><span class="ident" id="1582337">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582345">freedefer</span><span class="op" id="1582354">(</span><span class="ident" id="1582355">d</span><span class="op" id="1582356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582361">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582372">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582377">//&nbsp;Mark&nbsp;defer&nbsp;as&nbsp;started,&nbsp;but&nbsp;keep&nbsp;on&nbsp;list,&nbsp;so&nbsp;that&nbsp;traceback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582441">//&nbsp;can&nbsp;find&nbsp;and&nbsp;update&nbsp;the&nbsp;defer&#39;s&nbsp;argument&nbsp;frame&nbsp;if&nbsp;stack&nbsp;growth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582509">//&nbsp;or&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;hapens&nbsp;before&nbsp;reflectcall&nbsp;starts&nbsp;executing&nbsp;d.fn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582587">d</span><span class="op" id="1582588">.</span><span class="ident" id="1582589">started</span>&nbsp;<span class="op" id="1582597">=</span>&nbsp;<span class="builtintype" id="1582599">true</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582607">//&nbsp;Record&nbsp;the&nbsp;panic&nbsp;that&nbsp;is&nbsp;running&nbsp;the&nbsp;defer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582656">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;new&nbsp;panic&nbsp;during&nbsp;the&nbsp;deferred&nbsp;call,&nbsp;that&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582722">//&nbsp;will&nbsp;find&nbsp;d&nbsp;in&nbsp;the&nbsp;list&nbsp;and&nbsp;will&nbsp;mark&nbsp;d._panic&nbsp;(this&nbsp;panic)&nbsp;aborted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582796">d</span><span class="op" id="1582797">.</span><span class="ident" id="1582798">_panic</span>&nbsp;<span class="op" id="1582805">=</span>&nbsp;<span class="op" id="1582807">(</span><span class="op" id="1582808">*</span><span class="ident" id="1582809">_panic</span><span class="op" id="1582815">)</span><span class="op" id="1582816">(</span><span class="ident" id="1582817">noescape</span><span class="op" id="1582825">(</span><span class="op" id="1582826">(</span><span class="ident" id="1582827">unsafe</span><span class="op" id="1582833">.</span><span class="ident" id="1582834">Pointer</span><span class="op" id="1582841">)</span><span class="op" id="1582842">(</span><span class="op" id="1582843">&amp;</span><span class="ident" id="1582844">p</span><span class="op" id="1582845">)</span><span class="op" id="1582846">)</span><span class="op" id="1582847">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582852">p</span><span class="op" id="1582853">.</span><span class="ident" id="1582854">argp</span>&nbsp;<span class="op" id="1582859">=</span>&nbsp;<span class="ident" id="1582861">unsafe</span><span class="op" id="1582867">.</span><span class="ident" id="1582868">Pointer</span><span class="op" id="1582875">(</span><span class="ident" id="1582876">getargp</span><span class="op" id="1582883">(</span><span class="num" id="1582884">0</span><span class="op" id="1582885">)</span><span class="op" id="1582886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582890">reflectcall</span><span class="op" id="1582901">(</span><span class="ident" id="1582902">unsafe</span><span class="op" id="1582908">.</span><span class="ident" id="1582909">Pointer</span><span class="op" id="1582916">(</span><span class="ident" id="1582917">d</span><span class="op" id="1582918">.</span><span class="ident" id="1582919">fn</span><span class="op" id="1582921">)</span><span class="op" id="1582922">,</span>&nbsp;<span class="ident" id="1582924">deferArgs</span><span class="op" id="1582933">(</span><span class="ident" id="1582934">d</span><span class="op" id="1582935">)</span><span class="op" id="1582936">,</span>&nbsp;<span class="builtintype" id="1582938">uint32</span><span class="op" id="1582944">(</span><span class="ident" id="1582945">d</span><span class="op" id="1582946">.</span><span class="ident" id="1582947">siz</span><span class="op" id="1582950">)</span><span class="op" id="1582951">,</span>&nbsp;<span class="builtintype" id="1582953">uint32</span><span class="op" id="1582959">(</span><span class="ident" id="1582960">d</span><span class="op" id="1582961">.</span><span class="ident" id="1582962">siz</span><span class="op" id="1582965">)</span><span class="op" id="1582966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582970">p</span><span class="op" id="1582971">.</span><span class="ident" id="1582972">argp</span>&nbsp;<span class="op" id="1582977">=</span>&nbsp;<span class="ident" id="1582979">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582986">//&nbsp;reflectcall&nbsp;did&nbsp;not&nbsp;panic.&nbsp;Remove&nbsp;d.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583028">if</span>&nbsp;<span class="ident" id="1583031">gp</span><span class="op" id="1583033">.</span><span class="ident" id="1583034">_defer</span>&nbsp;<span class="op" id="1583041">!=</span>&nbsp;<span class="ident" id="1583044">d</span>&nbsp;<span class="op" id="1583046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583051">gothrow</span><span class="op" id="1583058">(</span><span class="string" id="1583059">&#34;bad&nbsp;defer&nbsp;entry&nbsp;in&nbsp;panic&#34;</span><span class="op" id="1583085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583093">d</span><span class="op" id="1583094">.</span><span class="ident" id="1583095">_panic</span>&nbsp;<span class="op" id="1583102">=</span>&nbsp;<span class="ident" id="1583104">nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583110">d</span><span class="op" id="1583111">.</span><span class="ident" id="1583112">fn</span>&nbsp;<span class="op" id="1583115">=</span>&nbsp;<span class="ident" id="1583117">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583123">gp</span><span class="op" id="1583125">.</span><span class="ident" id="1583126">_defer</span>&nbsp;<span class="op" id="1583133">=</span>&nbsp;<span class="ident" id="1583135">d</span><span class="op" id="1583136">.</span><span class="ident" id="1583137">link</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583145">//&nbsp;trigger&nbsp;shrinkage&nbsp;to&nbsp;test&nbsp;stack&nbsp;copy.&nbsp;&nbsp;See&nbsp;stack_test.go:TestStackPanic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583222">//GC()</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583232">pc</span>&nbsp;<span class="op" id="1583235">:=</span>&nbsp;<span class="ident" id="1583238">d</span><span class="op" id="1583239">.</span><span class="ident" id="1583240">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583245">argp</span>&nbsp;<span class="op" id="1583250">:=</span>&nbsp;<span class="ident" id="1583253">unsafe</span><span class="op" id="1583259">.</span><span class="ident" id="1583260">Pointer</span><span class="op" id="1583267">(</span><span class="ident" id="1583268">d</span><span class="op" id="1583269">.</span><span class="ident" id="1583270">argp</span><span class="op" id="1583274">)</span>&nbsp;<span class="comment" id="1583276">//&nbsp;must&nbsp;be&nbsp;pointer&nbsp;so&nbsp;it&nbsp;gets&nbsp;adjusted&nbsp;during&nbsp;stack&nbsp;copy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583335">freedefer</span><span class="op" id="1583344">(</span><span class="ident" id="1583345">d</span><span class="op" id="1583346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583350">if</span>&nbsp;<span class="ident" id="1583353">p</span><span class="op" id="1583354">.</span><span class="ident" id="1583355">recovered</span>&nbsp;<span class="op" id="1583365">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583370">gp</span><span class="op" id="1583372">.</span><span class="ident" id="1583373">_panic</span>&nbsp;<span class="op" id="1583380">=</span>&nbsp;<span class="ident" id="1583382">p</span><span class="op" id="1583383">.</span><span class="ident" id="1583384">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583392">//&nbsp;Aborted&nbsp;panics&nbsp;are&nbsp;marked&nbsp;but&nbsp;remain&nbsp;on&nbsp;the&nbsp;g.panic&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583456">//&nbsp;Remove&nbsp;them&nbsp;from&nbsp;the&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583489">for</span>&nbsp;<span class="ident" id="1583493">gp</span><span class="op" id="1583495">.</span><span class="ident" id="1583496">_panic</span>&nbsp;<span class="op" id="1583503">!=</span>&nbsp;<span class="ident" id="1583506">nil</span>&nbsp;<span class="op" id="1583510">&amp;&amp;</span>&nbsp;<span class="ident" id="1583513">gp</span><span class="op" id="1583515">.</span><span class="ident" id="1583516">_panic</span><span class="op" id="1583522">.</span><span class="ident" id="1583523">aborted</span>&nbsp;<span class="op" id="1583531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583537">gp</span><span class="op" id="1583539">.</span><span class="ident" id="1583540">_panic</span>&nbsp;<span class="op" id="1583547">=</span>&nbsp;<span class="ident" id="1583549">gp</span><span class="op" id="1583551">.</span><span class="ident" id="1583552">_panic</span><span class="op" id="1583558">.</span><span class="ident" id="1583559">link</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583572">if</span>&nbsp;<span class="ident" id="1583575">gp</span><span class="op" id="1583577">.</span><span class="ident" id="1583578">_panic</span>&nbsp;<span class="op" id="1583585">==</span>&nbsp;<span class="ident" id="1583588">nil</span>&nbsp;<span class="op" id="1583592">{</span>&nbsp;<span class="comment" id="1583594">//&nbsp;must&nbsp;be&nbsp;done&nbsp;with&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583626">gp</span><span class="op" id="1583628">.</span><span class="ident" id="1583629">sig</span>&nbsp;<span class="op" id="1583633">=</span>&nbsp;<span class="num" id="1583635">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583645">//&nbsp;Pass&nbsp;information&nbsp;about&nbsp;recovering&nbsp;frame&nbsp;to&nbsp;recovery.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583704">gp</span><span class="op" id="1583706">.</span><span class="ident" id="1583707">sigcode0</span>&nbsp;<span class="op" id="1583716">=</span>&nbsp;<span class="builtintype" id="1583718">uintptr</span><span class="op" id="1583725">(</span><span class="ident" id="1583726">argp</span><span class="op" id="1583730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583735">gp</span><span class="op" id="1583737">.</span><span class="ident" id="1583738">sigcode1</span>&nbsp;<span class="op" id="1583747">=</span>&nbsp;<span class="ident" id="1583749">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583755">mcall</span><span class="op" id="1583760">(</span><span class="ident" id="1583761">recovery_m</span><span class="op" id="1583771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583776">gothrow</span><span class="op" id="1583783">(</span><span class="string" id="1583784">&#34;recovery&nbsp;failed&#34;</span><span class="op" id="1583801">)</span>&nbsp;<span class="comment" id="1583803">//&nbsp;mcall&nbsp;should&nbsp;not&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583832">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1583839">//&nbsp;ran&nbsp;out&nbsp;of&nbsp;deferred&nbsp;calls&nbsp;-&nbsp;old-school&nbsp;panic&nbsp;now</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583892">startpanic</span><span class="op" id="1583902">(</span><span class="op" id="1583903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583906">printpanics</span><span class="op" id="1583917">(</span><span class="ident" id="1583918">gp</span><span class="op" id="1583920">.</span><span class="ident" id="1583921">_panic</span><span class="op" id="1583927">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583930">dopanic</span><span class="op" id="1583937">(</span><span class="num" id="1583938">0</span><span class="op" id="1583939">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1583947">//&nbsp;should&nbsp;not&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583969">*</span><span class="op" id="1583970">(</span><span class="op" id="1583971">*</span><span class="builtintype" id="1583972">int</span><span class="op" id="1583975">)</span><span class="op" id="1583976">(</span><span class="ident" id="1583977">nil</span><span class="op" id="1583980">)</span>&nbsp;<span class="op" id="1583982">=</span>&nbsp;<span class="num" id="1583984">0</span>&nbsp;<span class="comment" id="1583986">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno"></span><span class="op" id="1584001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1584004">//&nbsp;getargp&nbsp;returns&nbsp;the&nbsp;location&nbsp;where&nbsp;the&nbsp;caller</span><br>
<span class="lineno">430</span><span class="comment" id="1584053">//&nbsp;writes&nbsp;outgoing&nbsp;function&nbsp;call&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="1584097">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1584110">func</span>&nbsp;<span class="ident" id="1584115">getargp</span><span class="op" id="1584122">(</span><span class="ident" id="1584123">x</span>&nbsp;<span class="builtintype" id="1584125">int</span><span class="op" id="1584128">)</span>&nbsp;<span class="builtintype" id="1584130">uintptr</span>&nbsp;<span class="op" id="1584138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584141">//&nbsp;x&nbsp;is&nbsp;an&nbsp;argument&nbsp;mainly&nbsp;so&nbsp;that&nbsp;we&nbsp;can&nbsp;return&nbsp;its&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584204">//&nbsp;However,&nbsp;we&nbsp;need&nbsp;to&nbsp;make&nbsp;the&nbsp;function&nbsp;complex&nbsp;enough</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584261">//&nbsp;that&nbsp;it&nbsp;won&#39;t&nbsp;be&nbsp;inlined.&nbsp;We&nbsp;always&nbsp;pass&nbsp;x&nbsp;=&nbsp;0,&nbsp;so&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584326">//&nbsp;does&nbsp;nothing&nbsp;other&nbsp;than&nbsp;keep&nbsp;the&nbsp;compiler&nbsp;from&nbsp;thinking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584386">//&nbsp;the&nbsp;function&nbsp;is&nbsp;simple&nbsp;enough&nbsp;to&nbsp;inline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584431">if</span>&nbsp;<span class="ident" id="1584434">x</span>&nbsp;<span class="op" id="1584436">&gt;</span>&nbsp;<span class="num" id="1584438">0</span>&nbsp;<span class="op" id="1584440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584444">return</span>&nbsp;<span class="ident" id="1584451">getcallersp</span><span class="op" id="1584462">(</span><span class="ident" id="1584463">unsafe</span><span class="op" id="1584469">.</span><span class="ident" id="1584470">Pointer</span><span class="op" id="1584477">(</span><span class="op" id="1584478">&amp;</span><span class="ident" id="1584479">x</span><span class="op" id="1584480">)</span><span class="op" id="1584481">)</span>&nbsp;<span class="op" id="1584483">*</span>&nbsp;<span class="num" id="1584485">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1584488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1584491">return</span>&nbsp;<span class="builtintype" id="1584498">uintptr</span><span class="op" id="1584505">(</span><span class="ident" id="1584506">noescape</span><span class="op" id="1584514">(</span><span class="ident" id="1584515">unsafe</span><span class="op" id="1584521">.</span><span class="ident" id="1584522">Pointer</span><span class="op" id="1584529">(</span><span class="op" id="1584530">&amp;</span><span class="ident" id="1584531">x</span><span class="op" id="1584532">)</span><span class="op" id="1584533">)</span><span class="op" id="1584534">)</span><br>
<span class="lineno"></span><span class="op" id="1584536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1584539">//&nbsp;The&nbsp;implementation&nbsp;of&nbsp;the&nbsp;predeclared&nbsp;function&nbsp;recover.</span><br>
<span class="lineno">445</span><span class="comment" id="1584598">//&nbsp;Cannot&nbsp;split&nbsp;the&nbsp;stack&nbsp;because&nbsp;it&nbsp;needs&nbsp;to&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="1584653">//&nbsp;find&nbsp;the&nbsp;stack&nbsp;segment&nbsp;of&nbsp;its&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1584694">//</span><br>
<span class="lineno"></span><span class="comment" id="1584697">//&nbsp;TODO(rsc):&nbsp;Once&nbsp;we&nbsp;commit&nbsp;to&nbsp;CopyStackAlways,</span><br>
<span class="lineno"></span><span class="comment" id="1584746">//&nbsp;this&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;nosplit.</span><br>
<span class="lineno">450</span><span class="comment" id="1584782">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1584795">func</span>&nbsp;<span class="ident" id="1584800">gorecover</span><span class="op" id="1584809">(</span><span class="ident" id="1584810">argp</span>&nbsp;<span class="builtintype" id="1584815">uintptr</span><span class="op" id="1584822">)</span>&nbsp;<span class="keyword" id="1584824">interface</span><span class="op" id="1584833">{</span><span class="op" id="1584834">}</span>&nbsp;<span class="op" id="1584836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584839">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;a&nbsp;function&nbsp;running&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;deferred&nbsp;call&nbsp;during&nbsp;the&nbsp;panic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584918">//&nbsp;Must&nbsp;be&nbsp;called&nbsp;from&nbsp;the&nbsp;topmost&nbsp;function&nbsp;of&nbsp;the&nbsp;call</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1584975">//&nbsp;(the&nbsp;function&nbsp;used&nbsp;in&nbsp;the&nbsp;defer&nbsp;statement).</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1585023">//&nbsp;p.argp&nbsp;is&nbsp;the&nbsp;argument&nbsp;pointer&nbsp;of&nbsp;that&nbsp;topmost&nbsp;deferred&nbsp;function&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1585098">//&nbsp;Compare&nbsp;against&nbsp;argp&nbsp;reported&nbsp;by&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1585143">//&nbsp;If&nbsp;they&nbsp;match,&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;who&nbsp;can&nbsp;recover.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585201">gp</span>&nbsp;<span class="op" id="1585204">:=</span>&nbsp;<span class="ident" id="1585207">getg</span><span class="op" id="1585211">(</span><span class="op" id="1585212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585215">p</span>&nbsp;<span class="op" id="1585217">:=</span>&nbsp;<span class="ident" id="1585220">gp</span><span class="op" id="1585222">.</span><span class="ident" id="1585223">_panic</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585231">if</span>&nbsp;<span class="ident" id="1585234">p</span>&nbsp;<span class="op" id="1585236">!=</span>&nbsp;<span class="ident" id="1585239">nil</span>&nbsp;<span class="op" id="1585243">&amp;&amp;</span>&nbsp;<span class="op" id="1585246">!</span><span class="ident" id="1585247">p</span><span class="op" id="1585248">.</span><span class="ident" id="1585249">recovered</span>&nbsp;<span class="op" id="1585259">&amp;&amp;</span>&nbsp;<span class="ident" id="1585262">argp</span>&nbsp;<span class="op" id="1585267">==</span>&nbsp;<span class="builtintype" id="1585270">uintptr</span><span class="op" id="1585277">(</span><span class="ident" id="1585278">p</span><span class="op" id="1585279">.</span><span class="ident" id="1585280">argp</span><span class="op" id="1585284">)</span>&nbsp;<span class="op" id="1585286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585290">p</span><span class="op" id="1585291">.</span><span class="ident" id="1585292">recovered</span>&nbsp;<span class="op" id="1585302">=</span>&nbsp;<span class="builtintype" id="1585304">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585311">return</span>&nbsp;<span class="ident" id="1585318">p</span><span class="op" id="1585319">.</span><span class="ident" id="1585320">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585328">return</span>&nbsp;<span class="ident" id="1585335">nil</span><br>
<span class="lineno">465</span><span class="op" id="1585339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1585342">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1585355">func</span>&nbsp;<span class="ident" id="1585360">startpanic</span><span class="op" id="1585370">(</span><span class="op" id="1585371">)</span>&nbsp;<span class="op" id="1585373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585376">onM_signalok</span><span class="op" id="1585388">(</span><span class="ident" id="1585389">startpanic_m</span><span class="op" id="1585401">)</span><br>
<span class="lineno">470</span><span class="op" id="1585403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1585406">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1585419">func</span>&nbsp;<span class="ident" id="1585424">dopanic</span><span class="op" id="1585431">(</span><span class="ident" id="1585432">unused</span>&nbsp;<span class="builtintype" id="1585439">int</span><span class="op" id="1585442">)</span>&nbsp;<span class="op" id="1585444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585447">gp</span>&nbsp;<span class="op" id="1585450">:=</span>&nbsp;<span class="ident" id="1585453">getg</span><span class="op" id="1585457">(</span><span class="op" id="1585458">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585461">mp</span>&nbsp;<span class="op" id="1585464">:=</span>&nbsp;<span class="ident" id="1585467">acquirem</span><span class="op" id="1585475">(</span><span class="op" id="1585476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585479">mp</span><span class="op" id="1585481">.</span><span class="ident" id="1585482">ptrarg</span><span class="op" id="1585488">[</span><span class="num" id="1585489">0</span><span class="op" id="1585490">]</span>&nbsp;<span class="op" id="1585492">=</span>&nbsp;<span class="ident" id="1585494">unsafe</span><span class="op" id="1585500">.</span><span class="ident" id="1585501">Pointer</span><span class="op" id="1585508">(</span><span class="ident" id="1585509">gp</span><span class="op" id="1585511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585514">mp</span><span class="op" id="1585516">.</span><span class="ident" id="1585517">scalararg</span><span class="op" id="1585526">[</span><span class="num" id="1585527">0</span><span class="op" id="1585528">]</span>&nbsp;<span class="op" id="1585530">=</span>&nbsp;<span class="ident" id="1585532">getcallerpc</span><span class="op" id="1585543">(</span><span class="op" id="1585544">(</span><span class="ident" id="1585545">unsafe</span><span class="op" id="1585551">.</span><span class="ident" id="1585552">Pointer</span><span class="op" id="1585559">)</span><span class="op" id="1585560">(</span><span class="op" id="1585561">&amp;</span><span class="ident" id="1585562">unused</span><span class="op" id="1585568">)</span><span class="op" id="1585569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585572">mp</span><span class="op" id="1585574">.</span><span class="ident" id="1585575">scalararg</span><span class="op" id="1585584">[</span><span class="num" id="1585585">1</span><span class="op" id="1585586">]</span>&nbsp;<span class="op" id="1585588">=</span>&nbsp;<span class="ident" id="1585590">getcallersp</span><span class="op" id="1585601">(</span><span class="op" id="1585602">(</span><span class="ident" id="1585603">unsafe</span><span class="op" id="1585609">.</span><span class="ident" id="1585610">Pointer</span><span class="op" id="1585617">)</span><span class="op" id="1585618">(</span><span class="op" id="1585619">&amp;</span><span class="ident" id="1585620">unused</span><span class="op" id="1585626">)</span><span class="op" id="1585627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585630">onM_signalok</span><span class="op" id="1585642">(</span><span class="ident" id="1585643">dopanic_m</span><span class="op" id="1585652">)</span>&nbsp;<span class="comment" id="1585654">//&nbsp;should&nbsp;never&nbsp;return</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585678">*</span><span class="op" id="1585679">(</span><span class="op" id="1585680">*</span><span class="builtintype" id="1585681">int</span><span class="op" id="1585684">)</span><span class="op" id="1585685">(</span><span class="ident" id="1585686">nil</span><span class="op" id="1585689">)</span>&nbsp;<span class="op" id="1585691">=</span>&nbsp;<span class="num" id="1585693">0</span><br>
<span class="lineno"></span><span class="op" id="1585695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1585698">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1585711">func</span>&nbsp;<span class="ident" id="1585716">throw</span><span class="op" id="1585721">(</span><span class="ident" id="1585722">s</span>&nbsp;<span class="op" id="1585724">*</span><span class="builtintype" id="1585725">byte</span><span class="op" id="1585729">)</span>&nbsp;<span class="op" id="1585731">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585734">gp</span>&nbsp;<span class="op" id="1585737">:=</span>&nbsp;<span class="ident" id="1585740">getg</span><span class="op" id="1585744">(</span><span class="op" id="1585745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585748">if</span>&nbsp;<span class="ident" id="1585751">gp</span><span class="op" id="1585753">.</span><span class="ident" id="1585754">m</span><span class="op" id="1585755">.</span><span class="ident" id="1585756">throwing</span>&nbsp;<span class="op" id="1585765">==</span>&nbsp;<span class="num" id="1585768">0</span>&nbsp;<span class="op" id="1585770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585774">gp</span><span class="op" id="1585776">.</span><span class="ident" id="1585777">m</span><span class="op" id="1585778">.</span><span class="ident" id="1585779">throwing</span>&nbsp;<span class="op" id="1585788">=</span>&nbsp;<span class="num" id="1585790">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585796">startpanic</span><span class="op" id="1585806">(</span><span class="op" id="1585807">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1585810">print</span><span class="op" id="1585815">(</span><span class="string" id="1585816">&#34;fatal&nbsp;error:&nbsp;&#34;</span><span class="op" id="1585831">,</span>&nbsp;<span class="ident" id="1585833">gostringnocopy</span><span class="op" id="1585847">(</span><span class="ident" id="1585848">s</span><span class="op" id="1585849">)</span><span class="op" id="1585850">,</span>&nbsp;<span class="string" id="1585852">&#34;\n&#34;</span><span class="op" id="1585856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585859">dopanic</span><span class="op" id="1585866">(</span><span class="num" id="1585867">0</span><span class="op" id="1585868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585871">*</span><span class="op" id="1585872">(</span><span class="op" id="1585873">*</span><span class="builtintype" id="1585874">int</span><span class="op" id="1585877">)</span><span class="op" id="1585878">(</span><span class="ident" id="1585879">nil</span><span class="op" id="1585882">)</span>&nbsp;<span class="op" id="1585884">=</span>&nbsp;<span class="num" id="1585886">0</span>&nbsp;<span class="comment" id="1585888">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno"></span><span class="op" id="1585903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="1585906">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1585919">func</span>&nbsp;<span class="ident" id="1585924">gothrow</span><span class="op" id="1585931">(</span><span class="ident" id="1585932">s</span>&nbsp;<span class="builtintype" id="1585934">string</span><span class="op" id="1585940">)</span>&nbsp;<span class="op" id="1585942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585945">gp</span>&nbsp;<span class="op" id="1585948">:=</span>&nbsp;<span class="ident" id="1585951">getg</span><span class="op" id="1585955">(</span><span class="op" id="1585956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585959">if</span>&nbsp;<span class="ident" id="1585962">gp</span><span class="op" id="1585964">.</span><span class="ident" id="1585965">m</span><span class="op" id="1585966">.</span><span class="ident" id="1585967">throwing</span>&nbsp;<span class="op" id="1585976">==</span>&nbsp;<span class="num" id="1585979">0</span>&nbsp;<span class="op" id="1585981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1585985">gp</span><span class="op" id="1585987">.</span><span class="ident" id="1585988">m</span><span class="op" id="1585989">.</span><span class="ident" id="1585990">throwing</span>&nbsp;<span class="op" id="1585999">=</span>&nbsp;<span class="num" id="1586001">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586007">startpanic</span><span class="op" id="1586017">(</span><span class="op" id="1586018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1586021">print</span><span class="op" id="1586026">(</span><span class="string" id="1586027">&#34;fatal&nbsp;error:&nbsp;&#34;</span><span class="op" id="1586042">,</span>&nbsp;<span class="ident" id="1586044">s</span><span class="op" id="1586045">,</span>&nbsp;<span class="string" id="1586047">&#34;\n&#34;</span><span class="op" id="1586051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586054">dopanic</span><span class="op" id="1586061">(</span><span class="num" id="1586062">0</span><span class="op" id="1586063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586066">*</span><span class="op" id="1586067">(</span><span class="op" id="1586068">*</span><span class="builtintype" id="1586069">int</span><span class="op" id="1586072">)</span><span class="op" id="1586073">(</span><span class="ident" id="1586074">nil</span><span class="op" id="1586077">)</span>&nbsp;<span class="op" id="1586079">=</span>&nbsp;<span class="num" id="1586081">0</span>&nbsp;<span class="comment" id="1586083">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno">505</span><span class="op" id="1586098">}</span>
</div>
</body>
</html>
