<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/gif</h2>
<ul>
<li><a href="/gostd/image/gif/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/gif/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/gif/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/gif/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6402470">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6402525">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6402579">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6402630">package</span>&nbsp;<span class="ident" id="6402638">gif</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6402643">import</span>&nbsp;<span class="op" id="6402650">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6402653">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6402662">&#34;compress/lzw&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6402678">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6402688">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6402697">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6402712">&#34;image/color/palette&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6402735">&#34;image/draw&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6402749">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6402754">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6402757">//&nbsp;Graphic&nbsp;control&nbsp;extension&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="6402794">const</span>&nbsp;<span class="op" id="6402800">(</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6402803">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6402815">=</span>&nbsp;<span class="num" id="6402817">0xF9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6402823">gcBlockSize</span>&nbsp;<span class="op" id="6402835">=</span>&nbsp;<span class="num" id="6402837">0x04</span><br>
<span class="lineno"></span><span class="op" id="6402842">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6402845">var</span>&nbsp;<span class="ident" id="6402849">log2Lookup</span>&nbsp;<span class="op" id="6402860">=</span>&nbsp;<span class="op" id="6402862">[</span><span class="num" id="6402863">8</span><span class="op" id="6402864">]</span><span class="builtintype" id="6402865">int</span><span class="op" id="6402868">{</span><span class="num" id="6402869">2</span><span class="op" id="6402870">,</span>&nbsp;<span class="num" id="6402872">4</span><span class="op" id="6402873">,</span>&nbsp;<span class="num" id="6402875">8</span><span class="op" id="6402876">,</span>&nbsp;<span class="num" id="6402878">16</span><span class="op" id="6402880">,</span>&nbsp;<span class="num" id="6402882">32</span><span class="op" id="6402884">,</span>&nbsp;<span class="num" id="6402886">64</span><span class="op" id="6402888">,</span>&nbsp;<span class="num" id="6402890">128</span><span class="op" id="6402893">,</span>&nbsp;<span class="num" id="6402895">256</span><span class="op" id="6402898">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6402901">func</span>&nbsp;<span class="ident" id="6402906">log2</span><span class="op" id="6402910">(</span><span class="ident" id="6402911">x</span>&nbsp;<span class="builtintype" id="6402913">int</span><span class="op" id="6402916">)</span>&nbsp;<span class="builtintype" id="6402918">int</span>&nbsp;<span class="op" id="6402922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6402925">for</span>&nbsp;<span class="ident" id="6402929">i</span><span class="op" id="6402930">,</span>&nbsp;<span class="ident" id="6402932">v</span>&nbsp;<span class="op" id="6402934">:=</span>&nbsp;<span class="keyword" id="6402937">range</span>&nbsp;<span class="ident" id="6402943">log2Lookup</span>&nbsp;<span class="op" id="6402954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6402958">if</span>&nbsp;<span class="ident" id="6402961">x</span>&nbsp;<span class="op" id="6402963">&lt;=</span>&nbsp;<span class="ident" id="6402966">v</span>&nbsp;<span class="op" id="6402968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6402973">return</span>&nbsp;<span class="ident" id="6402980">i</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6402984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6402987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6402990">return</span>&nbsp;<span class="op" id="6402997">-</span><span class="num" id="6402998">1</span><br>
<span class="lineno"></span><span class="op" id="6403000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="6403003">//&nbsp;Little-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="6403021">func</span>&nbsp;<span class="ident" id="6403026">writeUint16</span><span class="op" id="6403037">(</span><span class="ident" id="6403038">b</span>&nbsp;<span class="op" id="6403040">[</span><span class="op" id="6403041">]</span><span class="builtintype" id="6403042">uint8</span><span class="op" id="6403047">,</span>&nbsp;<span class="ident" id="6403049">u</span>&nbsp;<span class="builtintype" id="6403051">uint16</span><span class="op" id="6403057">)</span>&nbsp;<span class="op" id="6403059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403062">b</span><span class="op" id="6403063">[</span><span class="num" id="6403064">0</span><span class="op" id="6403065">]</span>&nbsp;<span class="op" id="6403067">=</span>&nbsp;<span class="builtintype" id="6403069">uint8</span><span class="op" id="6403074">(</span><span class="ident" id="6403075">u</span><span class="op" id="6403076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403079">b</span><span class="op" id="6403080">[</span><span class="num" id="6403081">1</span><span class="op" id="6403082">]</span>&nbsp;<span class="op" id="6403084">=</span>&nbsp;<span class="builtintype" id="6403086">uint8</span><span class="op" id="6403091">(</span><span class="ident" id="6403092">u</span>&nbsp;<span class="op" id="6403094">&gt;&gt;</span>&nbsp;<span class="num" id="6403097">8</span><span class="op" id="6403098">)</span><br>
<span class="lineno"></span><span class="op" id="6403100">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="6403103">//&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6403135">type</span>&nbsp;<span class="ident" id="6403140">writer</span>&nbsp;<span class="keyword" id="6403147">interface</span>&nbsp;<span class="op" id="6403157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403160">Flush</span><span class="op" id="6403165">(</span><span class="op" id="6403166">)</span>&nbsp;<span class="builtintype" id="6403168">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403175">io</span><span class="op" id="6403177">.</span><span class="ident" id="6403178">Writer</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403186">io</span><span class="op" id="6403188">.</span><span class="ident" id="6403189">ByteWriter</span><br>
<span class="lineno"></span><span class="op" id="6403200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6403203">//&nbsp;encoder&nbsp;encodes&nbsp;an&nbsp;image&nbsp;to&nbsp;the&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="6403250">type</span>&nbsp;<span class="ident" id="6403255">encoder</span>&nbsp;<span class="keyword" id="6403263">struct</span>&nbsp;<span class="op" id="6403270">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6403273">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;to&nbsp;write&nbsp;to.&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6403348">//&nbsp;writing.&nbsp;All&nbsp;attempted&nbsp;writes&nbsp;after&nbsp;the&nbsp;first&nbsp;error&nbsp;become&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403419">w</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6403423">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403431">err</span>&nbsp;<span class="builtintype" id="6403435">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6403442">//&nbsp;g&nbsp;is&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;data&nbsp;that&nbsp;is&nbsp;being&nbsp;encoded.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403498">g</span>&nbsp;<span class="op" id="6403500">*</span><span class="ident" id="6403501">GIF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6403506">//&nbsp;buf&nbsp;is&nbsp;a&nbsp;scratch&nbsp;buffer.&nbsp;It&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;768&nbsp;so&nbsp;we&nbsp;can&nbsp;write&nbsp;the&nbsp;color&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403590">buf</span>&nbsp;<span class="op" id="6403594">[</span><span class="num" id="6403595">1024</span><span class="op" id="6403599">]</span><span class="builtintype" id="6403600">byte</span><br>
<span class="lineno"></span><span class="op" id="6403605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6403608">//&nbsp;blockWriter&nbsp;writes&nbsp;the&nbsp;block&nbsp;structure&nbsp;of&nbsp;GIF&nbsp;image&nbsp;data,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="6403675">//&nbsp;comprises&nbsp;(n,&nbsp;(n&nbsp;bytes))&nbsp;blocks,&nbsp;with&nbsp;1&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;255.&nbsp;It&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6403741">//&nbsp;writer&nbsp;given&nbsp;to&nbsp;the&nbsp;LZW&nbsp;encoder,&nbsp;which&nbsp;is&nbsp;thus&nbsp;immune&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6403805">//&nbsp;blocking.</span><br>
<span class="lineno"></span><span class="keyword" id="6403818">type</span>&nbsp;<span class="ident" id="6403823">blockWriter</span>&nbsp;<span class="keyword" id="6403835">struct</span>&nbsp;<span class="op" id="6403842">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403845">e</span>&nbsp;<span class="op" id="6403847">*</span><span class="ident" id="6403848">encoder</span><br>
<span class="lineno"></span><span class="op" id="6403856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6403859">func</span>&nbsp;<span class="op" id="6403864">(</span><span class="ident" id="6403865">b</span>&nbsp;<span class="ident" id="6403867">blockWriter</span><span class="op" id="6403878">)</span>&nbsp;<span class="ident" id="6403880">Write</span><span class="op" id="6403885">(</span><span class="ident" id="6403886">data</span>&nbsp;<span class="op" id="6403891">[</span><span class="op" id="6403892">]</span><span class="builtintype" id="6403893">byte</span><span class="op" id="6403897">)</span>&nbsp;<span class="op" id="6403899">(</span><span class="builtintype" id="6403900">int</span><span class="op" id="6403903">,</span>&nbsp;<span class="builtintype" id="6403905">error</span><span class="op" id="6403910">)</span>&nbsp;<span class="op" id="6403912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6403915">if</span>&nbsp;<span class="ident" id="6403918">b</span><span class="op" id="6403919">.</span><span class="ident" id="6403920">e</span><span class="op" id="6403921">.</span><span class="ident" id="6403922">err</span>&nbsp;<span class="op" id="6403926">!=</span>&nbsp;<span class="ident" id="6403929">nil</span>&nbsp;<span class="op" id="6403933">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6403937">return</span>&nbsp;<span class="num" id="6403944">0</span><span class="op" id="6403945">,</span>&nbsp;<span class="ident" id="6403947">b</span><span class="op" id="6403948">.</span><span class="ident" id="6403949">e</span><span class="op" id="6403950">.</span><span class="ident" id="6403951">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6403956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6403959">if</span>&nbsp;<span class="builtinfunc" id="6403962">len</span><span class="op" id="6403965">(</span><span class="ident" id="6403966">data</span><span class="op" id="6403970">)</span>&nbsp;<span class="op" id="6403972">==</span>&nbsp;<span class="num" id="6403975">0</span>&nbsp;<span class="op" id="6403977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6403981">return</span>&nbsp;<span class="num" id="6403988">0</span><span class="op" id="6403989">,</span>&nbsp;<span class="ident" id="6403991">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6403996">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6403999">total</span>&nbsp;<span class="op" id="6404005">:=</span>&nbsp;<span class="num" id="6404008">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404011">for</span>&nbsp;<span class="ident" id="6404015">total</span>&nbsp;<span class="op" id="6404021">&lt;</span>&nbsp;<span class="builtinfunc" id="6404023">len</span><span class="op" id="6404026">(</span><span class="ident" id="6404027">data</span><span class="op" id="6404031">)</span>&nbsp;<span class="op" id="6404033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404037">n</span>&nbsp;<span class="op" id="6404039">:=</span>&nbsp;<span class="builtinfunc" id="6404042">copy</span><span class="op" id="6404046">(</span><span class="ident" id="6404047">b</span><span class="op" id="6404048">.</span><span class="ident" id="6404049">e</span><span class="op" id="6404050">.</span><span class="ident" id="6404051">buf</span><span class="op" id="6404054">[</span><span class="num" id="6404055">1</span><span class="op" id="6404056">:</span><span class="num" id="6404057">256</span><span class="op" id="6404060">]</span><span class="op" id="6404061">,</span>&nbsp;<span class="ident" id="6404063">data</span><span class="op" id="6404067">[</span><span class="ident" id="6404068">total</span><span class="op" id="6404073">:</span><span class="op" id="6404074">]</span><span class="op" id="6404075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404079">total</span>&nbsp;<span class="op" id="6404085">+=</span>&nbsp;<span class="ident" id="6404088">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404092">b</span><span class="op" id="6404093">.</span><span class="ident" id="6404094">e</span><span class="op" id="6404095">.</span><span class="ident" id="6404096">buf</span><span class="op" id="6404099">[</span><span class="num" id="6404100">0</span><span class="op" id="6404101">]</span>&nbsp;<span class="op" id="6404103">=</span>&nbsp;<span class="builtintype" id="6404105">uint8</span><span class="op" id="6404110">(</span><span class="ident" id="6404111">n</span><span class="op" id="6404112">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404117">n</span><span class="op" id="6404118">,</span>&nbsp;<span class="ident" id="6404120">b</span><span class="op" id="6404121">.</span><span class="ident" id="6404122">e</span><span class="op" id="6404123">.</span><span class="ident" id="6404124">err</span>&nbsp;<span class="op" id="6404128">=</span>&nbsp;<span class="ident" id="6404130">b</span><span class="op" id="6404131">.</span><span class="ident" id="6404132">e</span><span class="op" id="6404133">.</span><span class="ident" id="6404134">w</span><span class="op" id="6404135">.</span><span class="ident" id="6404136">Write</span><span class="op" id="6404141">(</span><span class="ident" id="6404142">b</span><span class="op" id="6404143">.</span><span class="ident" id="6404144">e</span><span class="op" id="6404145">.</span><span class="ident" id="6404146">buf</span><span class="op" id="6404149">[</span><span class="op" id="6404150">:</span><span class="ident" id="6404151">n</span><span class="op" id="6404152">+</span><span class="num" id="6404153">1</span><span class="op" id="6404154">]</span><span class="op" id="6404155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404159">if</span>&nbsp;<span class="ident" id="6404162">b</span><span class="op" id="6404163">.</span><span class="ident" id="6404164">e</span><span class="op" id="6404165">.</span><span class="ident" id="6404166">err</span>&nbsp;<span class="op" id="6404170">!=</span>&nbsp;<span class="ident" id="6404173">nil</span>&nbsp;<span class="op" id="6404177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404182">return</span>&nbsp;<span class="num" id="6404189">0</span><span class="op" id="6404190">,</span>&nbsp;<span class="ident" id="6404192">b</span><span class="op" id="6404193">.</span><span class="ident" id="6404194">e</span><span class="op" id="6404195">.</span><span class="ident" id="6404196">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6404202">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6404205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404208">return</span>&nbsp;<span class="ident" id="6404215">total</span><span class="op" id="6404220">,</span>&nbsp;<span class="ident" id="6404222">b</span><span class="op" id="6404223">.</span><span class="ident" id="6404224">e</span><span class="op" id="6404225">.</span><span class="ident" id="6404226">err</span><br>
<span class="lineno"></span><span class="op" id="6404230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6404233">func</span>&nbsp;<span class="op" id="6404238">(</span><span class="ident" id="6404239">e</span>&nbsp;<span class="op" id="6404241">*</span><span class="ident" id="6404242">encoder</span><span class="op" id="6404249">)</span>&nbsp;<span class="ident" id="6404251">flush</span><span class="op" id="6404256">(</span><span class="op" id="6404257">)</span>&nbsp;<span class="op" id="6404259">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404262">if</span>&nbsp;<span class="ident" id="6404265">e</span><span class="op" id="6404266">.</span><span class="ident" id="6404267">err</span>&nbsp;<span class="op" id="6404271">!=</span>&nbsp;<span class="ident" id="6404274">nil</span>&nbsp;<span class="op" id="6404278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404282">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6404290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404293">e</span><span class="op" id="6404294">.</span><span class="ident" id="6404295">err</span>&nbsp;<span class="op" id="6404299">=</span>&nbsp;<span class="ident" id="6404301">e</span><span class="op" id="6404302">.</span><span class="ident" id="6404303">w</span><span class="op" id="6404304">.</span><span class="ident" id="6404305">Flush</span><span class="op" id="6404310">(</span><span class="op" id="6404311">)</span><br>
<span class="lineno"></span><span class="op" id="6404313">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="6404316">func</span>&nbsp;<span class="op" id="6404321">(</span><span class="ident" id="6404322">e</span>&nbsp;<span class="op" id="6404324">*</span><span class="ident" id="6404325">encoder</span><span class="op" id="6404332">)</span>&nbsp;<span class="ident" id="6404334">write</span><span class="op" id="6404339">(</span><span class="ident" id="6404340">p</span>&nbsp;<span class="op" id="6404342">[</span><span class="op" id="6404343">]</span><span class="builtintype" id="6404344">byte</span><span class="op" id="6404348">)</span>&nbsp;<span class="op" id="6404350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404353">if</span>&nbsp;<span class="ident" id="6404356">e</span><span class="op" id="6404357">.</span><span class="ident" id="6404358">err</span>&nbsp;<span class="op" id="6404362">!=</span>&nbsp;<span class="ident" id="6404365">nil</span>&nbsp;<span class="op" id="6404369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404373">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6404381">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404384">_</span><span class="op" id="6404385">,</span>&nbsp;<span class="ident" id="6404387">e</span><span class="op" id="6404388">.</span><span class="ident" id="6404389">err</span>&nbsp;<span class="op" id="6404393">=</span>&nbsp;<span class="ident" id="6404395">e</span><span class="op" id="6404396">.</span><span class="ident" id="6404397">w</span><span class="op" id="6404398">.</span><span class="ident" id="6404399">Write</span><span class="op" id="6404404">(</span><span class="ident" id="6404405">p</span><span class="op" id="6404406">)</span><br>
<span class="lineno"></span><span class="op" id="6404408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6404411">func</span>&nbsp;<span class="op" id="6404416">(</span><span class="ident" id="6404417">e</span>&nbsp;<span class="op" id="6404419">*</span><span class="ident" id="6404420">encoder</span><span class="op" id="6404427">)</span>&nbsp;<span class="ident" id="6404429">writeByte</span><span class="op" id="6404438">(</span><span class="ident" id="6404439">b</span>&nbsp;<span class="builtintype" id="6404441">byte</span><span class="op" id="6404445">)</span>&nbsp;<span class="op" id="6404447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404450">if</span>&nbsp;<span class="ident" id="6404453">e</span><span class="op" id="6404454">.</span><span class="ident" id="6404455">err</span>&nbsp;<span class="op" id="6404459">!=</span>&nbsp;<span class="ident" id="6404462">nil</span>&nbsp;<span class="op" id="6404466">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404470">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6404478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404481">e</span><span class="op" id="6404482">.</span><span class="ident" id="6404483">err</span>&nbsp;<span class="op" id="6404487">=</span>&nbsp;<span class="ident" id="6404489">e</span><span class="op" id="6404490">.</span><span class="ident" id="6404491">w</span><span class="op" id="6404492">.</span><span class="ident" id="6404493">WriteByte</span><span class="op" id="6404502">(</span><span class="ident" id="6404503">b</span><span class="op" id="6404504">)</span><br>
<span class="lineno"></span><span class="op" id="6404506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="6404509">func</span>&nbsp;<span class="op" id="6404514">(</span><span class="ident" id="6404515">e</span>&nbsp;<span class="op" id="6404517">*</span><span class="ident" id="6404518">encoder</span><span class="op" id="6404525">)</span>&nbsp;<span class="ident" id="6404527">writeHeader</span><span class="op" id="6404538">(</span><span class="op" id="6404539">)</span>&nbsp;<span class="op" id="6404541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404544">if</span>&nbsp;<span class="ident" id="6404547">e</span><span class="op" id="6404548">.</span><span class="ident" id="6404549">err</span>&nbsp;<span class="op" id="6404553">!=</span>&nbsp;<span class="ident" id="6404556">nil</span>&nbsp;<span class="op" id="6404560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404564">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6404572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404575">_</span><span class="op" id="6404576">,</span>&nbsp;<span class="ident" id="6404578">e</span><span class="op" id="6404579">.</span><span class="ident" id="6404580">err</span>&nbsp;<span class="op" id="6404584">=</span>&nbsp;<span class="ident" id="6404586">io</span><span class="op" id="6404588">.</span><span class="ident" id="6404589">WriteString</span><span class="op" id="6404600">(</span><span class="ident" id="6404601">e</span><span class="op" id="6404602">.</span><span class="ident" id="6404603">w</span><span class="op" id="6404604">,</span>&nbsp;<span class="string" id="6404606">&#34;GIF89a&#34;</span><span class="op" id="6404614">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404617">if</span>&nbsp;<span class="ident" id="6404620">e</span><span class="op" id="6404621">.</span><span class="ident" id="6404622">err</span>&nbsp;<span class="op" id="6404626">!=</span>&nbsp;<span class="ident" id="6404629">nil</span>&nbsp;<span class="op" id="6404633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6404637">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6404645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404649">pm</span>&nbsp;<span class="op" id="6404652">:=</span>&nbsp;<span class="ident" id="6404655">e</span><span class="op" id="6404656">.</span><span class="ident" id="6404657">g</span><span class="op" id="6404658">.</span><span class="ident" id="6404659">Image</span><span class="op" id="6404664">[</span><span class="num" id="6404665">0</span><span class="op" id="6404666">]</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6404669">//&nbsp;Logical&nbsp;screen&nbsp;width&nbsp;and&nbsp;height.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404706">writeUint16</span><span class="op" id="6404717">(</span><span class="ident" id="6404718">e</span><span class="op" id="6404719">.</span><span class="ident" id="6404720">buf</span><span class="op" id="6404723">[</span><span class="num" id="6404724">0</span><span class="op" id="6404725">:</span><span class="num" id="6404726">2</span><span class="op" id="6404727">]</span><span class="op" id="6404728">,</span>&nbsp;<span class="builtintype" id="6404730">uint16</span><span class="op" id="6404736">(</span><span class="ident" id="6404737">pm</span><span class="op" id="6404739">.</span><span class="ident" id="6404740">Bounds</span><span class="op" id="6404746">(</span><span class="op" id="6404747">)</span><span class="op" id="6404748">.</span><span class="ident" id="6404749">Dx</span><span class="op" id="6404751">(</span><span class="op" id="6404752">)</span><span class="op" id="6404753">)</span><span class="op" id="6404754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404757">writeUint16</span><span class="op" id="6404768">(</span><span class="ident" id="6404769">e</span><span class="op" id="6404770">.</span><span class="ident" id="6404771">buf</span><span class="op" id="6404774">[</span><span class="num" id="6404775">2</span><span class="op" id="6404776">:</span><span class="num" id="6404777">4</span><span class="op" id="6404778">]</span><span class="op" id="6404779">,</span>&nbsp;<span class="builtintype" id="6404781">uint16</span><span class="op" id="6404787">(</span><span class="ident" id="6404788">pm</span><span class="op" id="6404790">.</span><span class="ident" id="6404791">Bounds</span><span class="op" id="6404797">(</span><span class="op" id="6404798">)</span><span class="op" id="6404799">.</span><span class="ident" id="6404800">Dy</span><span class="op" id="6404802">(</span><span class="op" id="6404803">)</span><span class="op" id="6404804">)</span><span class="op" id="6404805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404808">e</span><span class="op" id="6404809">.</span><span class="ident" id="6404810">write</span><span class="op" id="6404815">(</span><span class="ident" id="6404816">e</span><span class="op" id="6404817">.</span><span class="ident" id="6404818">buf</span><span class="op" id="6404821">[</span><span class="op" id="6404822">:</span><span class="num" id="6404823">4</span><span class="op" id="6404824">]</span><span class="op" id="6404825">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6404829">//&nbsp;All&nbsp;frames&nbsp;have&nbsp;a&nbsp;local&nbsp;color&nbsp;table,&nbsp;so&nbsp;a&nbsp;global&nbsp;color&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6404894">//&nbsp;is&nbsp;not&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404913">e</span><span class="op" id="6404914">.</span><span class="ident" id="6404915">buf</span><span class="op" id="6404918">[</span><span class="num" id="6404919">0</span><span class="op" id="6404920">]</span>&nbsp;<span class="op" id="6404922">=</span>&nbsp;<span class="num" id="6404924">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404930">e</span><span class="op" id="6404931">.</span><span class="ident" id="6404932">buf</span><span class="op" id="6404935">[</span><span class="num" id="6404936">1</span><span class="op" id="6404937">]</span>&nbsp;<span class="op" id="6404939">=</span>&nbsp;<span class="num" id="6404941">0x00</span>&nbsp;<span class="comment" id="6404946">//&nbsp;Background&nbsp;Color&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6404974">e</span><span class="op" id="6404975">.</span><span class="ident" id="6404976">buf</span><span class="op" id="6404979">[</span><span class="num" id="6404980">2</span><span class="op" id="6404981">]</span>&nbsp;<span class="op" id="6404983">=</span>&nbsp;<span class="num" id="6404985">0x00</span>&nbsp;<span class="comment" id="6404990">//&nbsp;Pixel&nbsp;Aspect&nbsp;Ratio.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405014">e</span><span class="op" id="6405015">.</span><span class="ident" id="6405016">write</span><span class="op" id="6405021">(</span><span class="ident" id="6405022">e</span><span class="op" id="6405023">.</span><span class="ident" id="6405024">buf</span><span class="op" id="6405027">[</span><span class="op" id="6405028">:</span><span class="num" id="6405029">3</span><span class="op" id="6405030">]</span><span class="op" id="6405031">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6405035">//&nbsp;Add&nbsp;animation&nbsp;info&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405072">if</span>&nbsp;<span class="builtinfunc" id="6405075">len</span><span class="op" id="6405078">(</span><span class="ident" id="6405079">e</span><span class="op" id="6405080">.</span><span class="ident" id="6405081">g</span><span class="op" id="6405082">.</span><span class="ident" id="6405083">Image</span><span class="op" id="6405088">)</span>&nbsp;<span class="op" id="6405090">&gt;</span>&nbsp;<span class="num" id="6405092">1</span>&nbsp;<span class="op" id="6405094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405098">e</span><span class="op" id="6405099">.</span><span class="ident" id="6405100">buf</span><span class="op" id="6405103">[</span><span class="num" id="6405104">0</span><span class="op" id="6405105">]</span>&nbsp;<span class="op" id="6405107">=</span>&nbsp;<span class="num" id="6405109">0x21</span>&nbsp;<span class="comment" id="6405114">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405141">e</span><span class="op" id="6405142">.</span><span class="ident" id="6405143">buf</span><span class="op" id="6405146">[</span><span class="num" id="6405147">1</span><span class="op" id="6405148">]</span>&nbsp;<span class="op" id="6405150">=</span>&nbsp;<span class="num" id="6405152">0xff</span>&nbsp;<span class="comment" id="6405157">//&nbsp;Application&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405181">e</span><span class="op" id="6405182">.</span><span class="ident" id="6405183">buf</span><span class="op" id="6405186">[</span><span class="num" id="6405187">2</span><span class="op" id="6405188">]</span>&nbsp;<span class="op" id="6405190">=</span>&nbsp;<span class="num" id="6405192">0x0b</span>&nbsp;<span class="comment" id="6405197">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405214">e</span><span class="op" id="6405215">.</span><span class="ident" id="6405216">write</span><span class="op" id="6405221">(</span><span class="ident" id="6405222">e</span><span class="op" id="6405223">.</span><span class="ident" id="6405224">buf</span><span class="op" id="6405227">[</span><span class="op" id="6405228">:</span><span class="num" id="6405229">3</span><span class="op" id="6405230">]</span><span class="op" id="6405231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405235">_</span><span class="op" id="6405236">,</span>&nbsp;<span class="ident" id="6405238">e</span><span class="op" id="6405239">.</span><span class="ident" id="6405240">err</span>&nbsp;<span class="op" id="6405244">=</span>&nbsp;<span class="ident" id="6405246">io</span><span class="op" id="6405248">.</span><span class="ident" id="6405249">WriteString</span><span class="op" id="6405260">(</span><span class="ident" id="6405261">e</span><span class="op" id="6405262">.</span><span class="ident" id="6405263">w</span><span class="op" id="6405264">,</span>&nbsp;<span class="string" id="6405266">&#34;NETSCAPE2.0&#34;</span><span class="op" id="6405279">)</span>&nbsp;<span class="comment" id="6405281">//&nbsp;Application&nbsp;Identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405310">if</span>&nbsp;<span class="ident" id="6405313">e</span><span class="op" id="6405314">.</span><span class="ident" id="6405315">err</span>&nbsp;<span class="op" id="6405319">!=</span>&nbsp;<span class="ident" id="6405322">nil</span>&nbsp;<span class="op" id="6405326">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405331">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6405340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405344">e</span><span class="op" id="6405345">.</span><span class="ident" id="6405346">buf</span><span class="op" id="6405349">[</span><span class="num" id="6405350">0</span><span class="op" id="6405351">]</span>&nbsp;<span class="op" id="6405353">=</span>&nbsp;<span class="num" id="6405355">0x03</span>&nbsp;<span class="comment" id="6405360">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405377">e</span><span class="op" id="6405378">.</span><span class="ident" id="6405379">buf</span><span class="op" id="6405382">[</span><span class="num" id="6405383">1</span><span class="op" id="6405384">]</span>&nbsp;<span class="op" id="6405386">=</span>&nbsp;<span class="num" id="6405388">0x01</span>&nbsp;<span class="comment" id="6405393">//&nbsp;Sub-block&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405415">writeUint16</span><span class="op" id="6405426">(</span><span class="ident" id="6405427">e</span><span class="op" id="6405428">.</span><span class="ident" id="6405429">buf</span><span class="op" id="6405432">[</span><span class="num" id="6405433">2</span><span class="op" id="6405434">:</span><span class="num" id="6405435">4</span><span class="op" id="6405436">]</span><span class="op" id="6405437">,</span>&nbsp;<span class="builtintype" id="6405439">uint16</span><span class="op" id="6405445">(</span><span class="ident" id="6405446">e</span><span class="op" id="6405447">.</span><span class="ident" id="6405448">g</span><span class="op" id="6405449">.</span><span class="ident" id="6405450">LoopCount</span><span class="op" id="6405459">)</span><span class="op" id="6405460">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405464">e</span><span class="op" id="6405465">.</span><span class="ident" id="6405466">buf</span><span class="op" id="6405469">[</span><span class="num" id="6405470">4</span><span class="op" id="6405471">]</span>&nbsp;<span class="op" id="6405473">=</span>&nbsp;<span class="num" id="6405475">0x00</span>&nbsp;<span class="comment" id="6405480">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405503">e</span><span class="op" id="6405504">.</span><span class="ident" id="6405505">write</span><span class="op" id="6405510">(</span><span class="ident" id="6405511">e</span><span class="op" id="6405512">.</span><span class="ident" id="6405513">buf</span><span class="op" id="6405516">[</span><span class="op" id="6405517">:</span><span class="num" id="6405518">5</span><span class="op" id="6405519">]</span><span class="op" id="6405520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6405523">}</span><br>
<span class="lineno"></span><span class="op" id="6405525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="keyword" id="6405528">func</span>&nbsp;<span class="op" id="6405533">(</span><span class="ident" id="6405534">e</span>&nbsp;<span class="op" id="6405536">*</span><span class="ident" id="6405537">encoder</span><span class="op" id="6405544">)</span>&nbsp;<span class="ident" id="6405546">writeColorTable</span><span class="op" id="6405561">(</span><span class="ident" id="6405562">p</span>&nbsp;<span class="ident" id="6405564">color</span><span class="op" id="6405569">.</span><span class="ident" id="6405570">Palette</span><span class="op" id="6405577">,</span>&nbsp;<span class="ident" id="6405579">size</span>&nbsp;<span class="builtintype" id="6405584">int</span><span class="op" id="6405587">)</span>&nbsp;<span class="op" id="6405589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405592">if</span>&nbsp;<span class="ident" id="6405595">e</span><span class="op" id="6405596">.</span><span class="ident" id="6405597">err</span>&nbsp;<span class="op" id="6405601">!=</span>&nbsp;<span class="ident" id="6405604">nil</span>&nbsp;<span class="op" id="6405608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405612">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6405620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405624">for</span>&nbsp;<span class="ident" id="6405628">i</span>&nbsp;<span class="op" id="6405630">:=</span>&nbsp;<span class="num" id="6405633">0</span><span class="op" id="6405634">;</span>&nbsp;<span class="ident" id="6405636">i</span>&nbsp;<span class="op" id="6405638">&lt;</span>&nbsp;<span class="ident" id="6405640">log2Lookup</span><span class="op" id="6405650">[</span><span class="ident" id="6405651">size</span><span class="op" id="6405655">]</span><span class="op" id="6405656">;</span>&nbsp;<span class="ident" id="6405658">i</span><span class="op" id="6405659">++</span>&nbsp;<span class="op" id="6405662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6405666">if</span>&nbsp;<span class="ident" id="6405669">i</span>&nbsp;<span class="op" id="6405671">&lt;</span>&nbsp;<span class="builtinfunc" id="6405673">len</span><span class="op" id="6405676">(</span><span class="ident" id="6405677">p</span><span class="op" id="6405678">)</span>&nbsp;<span class="op" id="6405680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405685">r</span><span class="op" id="6405686">,</span>&nbsp;<span class="ident" id="6405688">g</span><span class="op" id="6405689">,</span>&nbsp;<span class="ident" id="6405691">b</span><span class="op" id="6405692">,</span>&nbsp;<span class="ident" id="6405694">_</span>&nbsp;<span class="op" id="6405696">:=</span>&nbsp;<span class="ident" id="6405699">p</span><span class="op" id="6405700">[</span><span class="ident" id="6405701">i</span><span class="op" id="6405702">]</span><span class="op" id="6405703">.</span><span class="ident" id="6405704">RGBA</span><span class="op" id="6405708">(</span><span class="op" id="6405709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405714">e</span><span class="op" id="6405715">.</span><span class="ident" id="6405716">buf</span><span class="op" id="6405719">[</span><span class="num" id="6405720">3</span><span class="op" id="6405721">*</span><span class="ident" id="6405722">i</span><span class="op" id="6405723">+</span><span class="num" id="6405724">0</span><span class="op" id="6405725">]</span>&nbsp;<span class="op" id="6405727">=</span>&nbsp;<span class="builtintype" id="6405729">uint8</span><span class="op" id="6405734">(</span><span class="ident" id="6405735">r</span>&nbsp;<span class="op" id="6405737">&gt;&gt;</span>&nbsp;<span class="num" id="6405740">8</span><span class="op" id="6405741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405746">e</span><span class="op" id="6405747">.</span><span class="ident" id="6405748">buf</span><span class="op" id="6405751">[</span><span class="num" id="6405752">3</span><span class="op" id="6405753">*</span><span class="ident" id="6405754">i</span><span class="op" id="6405755">+</span><span class="num" id="6405756">1</span><span class="op" id="6405757">]</span>&nbsp;<span class="op" id="6405759">=</span>&nbsp;<span class="builtintype" id="6405761">uint8</span><span class="op" id="6405766">(</span><span class="ident" id="6405767">g</span>&nbsp;<span class="op" id="6405769">&gt;&gt;</span>&nbsp;<span class="num" id="6405772">8</span><span class="op" id="6405773">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405778">e</span><span class="op" id="6405779">.</span><span class="ident" id="6405780">buf</span><span class="op" id="6405783">[</span><span class="num" id="6405784">3</span><span class="op" id="6405785">*</span><span class="ident" id="6405786">i</span><span class="op" id="6405787">+</span><span class="num" id="6405788">2</span><span class="op" id="6405789">]</span>&nbsp;<span class="op" id="6405791">=</span>&nbsp;<span class="builtintype" id="6405793">uint8</span><span class="op" id="6405798">(</span><span class="ident" id="6405799">b</span>&nbsp;<span class="op" id="6405801">&gt;&gt;</span>&nbsp;<span class="num" id="6405804">8</span><span class="op" id="6405805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6405809">}</span>&nbsp;<span class="keyword" id="6405811">else</span>&nbsp;<span class="op" id="6405816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6405821">//&nbsp;Pad&nbsp;with&nbsp;black.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405843">e</span><span class="op" id="6405844">.</span><span class="ident" id="6405845">buf</span><span class="op" id="6405848">[</span><span class="num" id="6405849">3</span><span class="op" id="6405850">*</span><span class="ident" id="6405851">i</span><span class="op" id="6405852">+</span><span class="num" id="6405853">0</span><span class="op" id="6405854">]</span>&nbsp;<span class="op" id="6405856">=</span>&nbsp;<span class="num" id="6405858">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405866">e</span><span class="op" id="6405867">.</span><span class="ident" id="6405868">buf</span><span class="op" id="6405871">[</span><span class="num" id="6405872">3</span><span class="op" id="6405873">*</span><span class="ident" id="6405874">i</span><span class="op" id="6405875">+</span><span class="num" id="6405876">1</span><span class="op" id="6405877">]</span>&nbsp;<span class="op" id="6405879">=</span>&nbsp;<span class="num" id="6405881">0x00</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405889">e</span><span class="op" id="6405890">.</span><span class="ident" id="6405891">buf</span><span class="op" id="6405894">[</span><span class="num" id="6405895">3</span><span class="op" id="6405896">*</span><span class="ident" id="6405897">i</span><span class="op" id="6405898">+</span><span class="num" id="6405899">2</span><span class="op" id="6405900">]</span>&nbsp;<span class="op" id="6405902">=</span>&nbsp;<span class="num" id="6405904">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6405911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6405914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6405917">e</span><span class="op" id="6405918">.</span><span class="ident" id="6405919">write</span><span class="op" id="6405924">(</span><span class="ident" id="6405925">e</span><span class="op" id="6405926">.</span><span class="ident" id="6405927">buf</span><span class="op" id="6405930">[</span><span class="op" id="6405931">:</span><span class="num" id="6405932">3</span><span class="op" id="6405933">*</span><span class="ident" id="6405934">log2Lookup</span><span class="op" id="6405944">[</span><span class="ident" id="6405945">size</span><span class="op" id="6405949">]</span><span class="op" id="6405950">]</span><span class="op" id="6405951">)</span><br>
<span class="lineno"></span><span class="op" id="6405953">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="6405956">func</span>&nbsp;<span class="op" id="6405961">(</span><span class="ident" id="6405962">e</span>&nbsp;<span class="op" id="6405964">*</span><span class="ident" id="6405965">encoder</span><span class="op" id="6405972">)</span>&nbsp;<span class="ident" id="6405974">writeImageBlock</span><span class="op" id="6405989">(</span><span class="ident" id="6405990">pm</span>&nbsp;<span class="op" id="6405993">*</span><span class="ident" id="6405994">image</span><span class="op" id="6405999">.</span><span class="ident" id="6406000">Paletted</span><span class="op" id="6406008">,</span>&nbsp;<span class="ident" id="6406010">delay</span>&nbsp;<span class="builtintype" id="6406016">int</span><span class="op" id="6406019">)</span>&nbsp;<span class="op" id="6406021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406024">if</span>&nbsp;<span class="ident" id="6406027">e</span><span class="op" id="6406028">.</span><span class="ident" id="6406029">err</span>&nbsp;<span class="op" id="6406033">!=</span>&nbsp;<span class="ident" id="6406036">nil</span>&nbsp;<span class="op" id="6406040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406044">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406052">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406056">if</span>&nbsp;<span class="builtinfunc" id="6406059">len</span><span class="op" id="6406062">(</span><span class="ident" id="6406063">pm</span><span class="op" id="6406065">.</span><span class="ident" id="6406066">Palette</span><span class="op" id="6406073">)</span>&nbsp;<span class="op" id="6406075">==</span>&nbsp;<span class="num" id="6406078">0</span>&nbsp;<span class="op" id="6406080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406084">e</span><span class="op" id="6406085">.</span><span class="ident" id="6406086">err</span>&nbsp;<span class="op" id="6406090">=</span>&nbsp;<span class="ident" id="6406092">errors</span><span class="op" id="6406098">.</span><span class="ident" id="6406099">New</span><span class="op" id="6406102">(</span><span class="string" id="6406103">&#34;gif:&nbsp;cannot&nbsp;encode&nbsp;image&nbsp;block&nbsp;with&nbsp;empty&nbsp;palette&#34;</span><span class="op" id="6406154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406158">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406166">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406170">b</span>&nbsp;<span class="op" id="6406172">:=</span>&nbsp;<span class="ident" id="6406175">pm</span><span class="op" id="6406177">.</span><span class="ident" id="6406178">Bounds</span><span class="op" id="6406184">(</span><span class="op" id="6406185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406188">if</span>&nbsp;<span class="ident" id="6406191">b</span><span class="op" id="6406192">.</span><span class="ident" id="6406193">Dx</span><span class="op" id="6406195">(</span><span class="op" id="6406196">)</span>&nbsp;<span class="op" id="6406198">&gt;=</span>&nbsp;<span class="num" id="6406201">1</span><span class="op" id="6406202">&lt;&lt;</span><span class="num" id="6406204">16</span>&nbsp;<span class="op" id="6406207">||</span>&nbsp;<span class="ident" id="6406210">b</span><span class="op" id="6406211">.</span><span class="ident" id="6406212">Dy</span><span class="op" id="6406214">(</span><span class="op" id="6406215">)</span>&nbsp;<span class="op" id="6406217">&gt;=</span>&nbsp;<span class="num" id="6406220">1</span><span class="op" id="6406221">&lt;&lt;</span><span class="num" id="6406223">16</span>&nbsp;<span class="op" id="6406226">||</span>&nbsp;<span class="ident" id="6406229">b</span><span class="op" id="6406230">.</span><span class="ident" id="6406231">Min</span><span class="op" id="6406234">.</span><span class="ident" id="6406235">X</span>&nbsp;<span class="op" id="6406237">&lt;</span>&nbsp;<span class="num" id="6406239">0</span>&nbsp;<span class="op" id="6406241">||</span>&nbsp;<span class="ident" id="6406244">b</span><span class="op" id="6406245">.</span><span class="ident" id="6406246">Min</span><span class="op" id="6406249">.</span><span class="ident" id="6406250">X</span>&nbsp;<span class="op" id="6406252">&gt;=</span>&nbsp;<span class="num" id="6406255">1</span><span class="op" id="6406256">&lt;&lt;</span><span class="num" id="6406258">16</span>&nbsp;<span class="op" id="6406261">||</span>&nbsp;<span class="ident" id="6406264">b</span><span class="op" id="6406265">.</span><span class="ident" id="6406266">Min</span><span class="op" id="6406269">.</span><span class="ident" id="6406270">Y</span>&nbsp;<span class="op" id="6406272">&lt;</span>&nbsp;<span class="num" id="6406274">0</span>&nbsp;<span class="op" id="6406276">||</span>&nbsp;<span class="ident" id="6406279">b</span><span class="op" id="6406280">.</span><span class="ident" id="6406281">Min</span><span class="op" id="6406284">.</span><span class="ident" id="6406285">Y</span>&nbsp;<span class="op" id="6406287">&gt;=</span>&nbsp;<span class="num" id="6406290">1</span><span class="op" id="6406291">&lt;&lt;</span><span class="num" id="6406293">16</span>&nbsp;<span class="op" id="6406296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406300">e</span><span class="op" id="6406301">.</span><span class="ident" id="6406302">err</span>&nbsp;<span class="op" id="6406306">=</span>&nbsp;<span class="ident" id="6406308">errors</span><span class="op" id="6406314">.</span><span class="ident" id="6406315">New</span><span class="op" id="6406318">(</span><span class="string" id="6406319">&#34;gif:&nbsp;image&nbsp;block&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="6406360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406364">return</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406376">transparentIndex</span>&nbsp;<span class="op" id="6406393">:=</span>&nbsp;<span class="op" id="6406396">-</span><span class="num" id="6406397">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406400">for</span>&nbsp;<span class="ident" id="6406404">i</span><span class="op" id="6406405">,</span>&nbsp;<span class="ident" id="6406407">c</span>&nbsp;<span class="op" id="6406409">:=</span>&nbsp;<span class="keyword" id="6406412">range</span>&nbsp;<span class="ident" id="6406418">pm</span><span class="op" id="6406420">.</span><span class="ident" id="6406421">Palette</span>&nbsp;<span class="op" id="6406429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406433">if</span>&nbsp;<span class="ident" id="6406436">_</span><span class="op" id="6406437">,</span>&nbsp;<span class="ident" id="6406439">_</span><span class="op" id="6406440">,</span>&nbsp;<span class="ident" id="6406442">_</span><span class="op" id="6406443">,</span>&nbsp;<span class="ident" id="6406445">a</span>&nbsp;<span class="op" id="6406447">:=</span>&nbsp;<span class="ident" id="6406450">c</span><span class="op" id="6406451">.</span><span class="ident" id="6406452">RGBA</span><span class="op" id="6406456">(</span><span class="op" id="6406457">)</span><span class="op" id="6406458">;</span>&nbsp;<span class="ident" id="6406460">a</span>&nbsp;<span class="op" id="6406462">==</span>&nbsp;<span class="num" id="6406465">0</span>&nbsp;<span class="op" id="6406467">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406472">transparentIndex</span>&nbsp;<span class="op" id="6406489">=</span>&nbsp;<span class="ident" id="6406491">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406496">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406511">if</span>&nbsp;<span class="ident" id="6406514">delay</span>&nbsp;<span class="op" id="6406520">&gt;</span>&nbsp;<span class="num" id="6406522">0</span>&nbsp;<span class="op" id="6406524">||</span>&nbsp;<span class="ident" id="6406527">transparentIndex</span>&nbsp;<span class="op" id="6406544">!=</span>&nbsp;<span class="op" id="6406547">-</span><span class="num" id="6406548">1</span>&nbsp;<span class="op" id="6406550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406554">e</span><span class="op" id="6406555">.</span><span class="ident" id="6406556">buf</span><span class="op" id="6406559">[</span><span class="num" id="6406560">0</span><span class="op" id="6406561">]</span>&nbsp;<span class="op" id="6406563">=</span>&nbsp;<span class="ident" id="6406565">sExtension</span>&nbsp;&nbsp;<span class="comment" id="6406577">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406604">e</span><span class="op" id="6406605">.</span><span class="ident" id="6406606">buf</span><span class="op" id="6406609">[</span><span class="num" id="6406610">1</span><span class="op" id="6406611">]</span>&nbsp;<span class="op" id="6406613">=</span>&nbsp;<span class="ident" id="6406615">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6406627">//&nbsp;Graphic&nbsp;Control&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406655">e</span><span class="op" id="6406656">.</span><span class="ident" id="6406657">buf</span><span class="op" id="6406660">[</span><span class="num" id="6406661">2</span><span class="op" id="6406662">]</span>&nbsp;<span class="op" id="6406664">=</span>&nbsp;<span class="ident" id="6406666">gcBlockSize</span>&nbsp;<span class="comment" id="6406678">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406695">if</span>&nbsp;<span class="ident" id="6406698">transparentIndex</span>&nbsp;<span class="op" id="6406715">!=</span>&nbsp;<span class="op" id="6406718">-</span><span class="num" id="6406719">1</span>&nbsp;<span class="op" id="6406721">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406726">e</span><span class="op" id="6406727">.</span><span class="ident" id="6406728">buf</span><span class="op" id="6406731">[</span><span class="num" id="6406732">3</span><span class="op" id="6406733">]</span>&nbsp;<span class="op" id="6406735">=</span>&nbsp;<span class="num" id="6406737">0x01</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406744">}</span>&nbsp;<span class="keyword" id="6406746">else</span>&nbsp;<span class="op" id="6406751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406756">e</span><span class="op" id="6406757">.</span><span class="ident" id="6406758">buf</span><span class="op" id="6406761">[</span><span class="num" id="6406762">3</span><span class="op" id="6406763">]</span>&nbsp;<span class="op" id="6406765">=</span>&nbsp;<span class="num" id="6406767">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406778">writeUint16</span><span class="op" id="6406789">(</span><span class="ident" id="6406790">e</span><span class="op" id="6406791">.</span><span class="ident" id="6406792">buf</span><span class="op" id="6406795">[</span><span class="num" id="6406796">4</span><span class="op" id="6406797">:</span><span class="num" id="6406798">6</span><span class="op" id="6406799">]</span><span class="op" id="6406800">,</span>&nbsp;<span class="builtintype" id="6406802">uint16</span><span class="op" id="6406808">(</span><span class="ident" id="6406809">delay</span><span class="op" id="6406814">)</span><span class="op" id="6406815">)</span>&nbsp;<span class="comment" id="6406817">//&nbsp;Delay&nbsp;Time&nbsp;(1/100ths&nbsp;of&nbsp;a&nbsp;second)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6406857">//&nbsp;Transparent&nbsp;color&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6406887">if</span>&nbsp;<span class="ident" id="6406890">transparentIndex</span>&nbsp;<span class="op" id="6406907">!=</span>&nbsp;<span class="op" id="6406910">-</span><span class="num" id="6406911">1</span>&nbsp;<span class="op" id="6406913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406918">e</span><span class="op" id="6406919">.</span><span class="ident" id="6406920">buf</span><span class="op" id="6406923">[</span><span class="num" id="6406924">6</span><span class="op" id="6406925">]</span>&nbsp;<span class="op" id="6406927">=</span>&nbsp;<span class="builtintype" id="6406929">uint8</span><span class="op" id="6406934">(</span><span class="ident" id="6406935">transparentIndex</span><span class="op" id="6406951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406955">}</span>&nbsp;<span class="keyword" id="6406957">else</span>&nbsp;<span class="op" id="6406962">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406967">e</span><span class="op" id="6406968">.</span><span class="ident" id="6406969">buf</span><span class="op" id="6406972">[</span><span class="num" id="6406973">6</span><span class="op" id="6406974">]</span>&nbsp;<span class="op" id="6406976">=</span>&nbsp;<span class="num" id="6406978">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6406985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6406989">e</span><span class="op" id="6406990">.</span><span class="ident" id="6406991">buf</span><span class="op" id="6406994">[</span><span class="num" id="6406995">7</span><span class="op" id="6406996">]</span>&nbsp;<span class="op" id="6406998">=</span>&nbsp;<span class="num" id="6407000">0x00</span>&nbsp;<span class="comment" id="6407005">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407028">e</span><span class="op" id="6407029">.</span><span class="ident" id="6407030">write</span><span class="op" id="6407035">(</span><span class="ident" id="6407036">e</span><span class="op" id="6407037">.</span><span class="ident" id="6407038">buf</span><span class="op" id="6407041">[</span><span class="op" id="6407042">:</span><span class="num" id="6407043">8</span><span class="op" id="6407044">]</span><span class="op" id="6407045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6407048">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407051">e</span><span class="op" id="6407052">.</span><span class="ident" id="6407053">buf</span><span class="op" id="6407056">[</span><span class="num" id="6407057">0</span><span class="op" id="6407058">]</span>&nbsp;<span class="op" id="6407060">=</span>&nbsp;<span class="ident" id="6407062">sImageDescriptor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407080">writeUint16</span><span class="op" id="6407091">(</span><span class="ident" id="6407092">e</span><span class="op" id="6407093">.</span><span class="ident" id="6407094">buf</span><span class="op" id="6407097">[</span><span class="num" id="6407098">1</span><span class="op" id="6407099">:</span><span class="num" id="6407100">3</span><span class="op" id="6407101">]</span><span class="op" id="6407102">,</span>&nbsp;<span class="builtintype" id="6407104">uint16</span><span class="op" id="6407110">(</span><span class="ident" id="6407111">b</span><span class="op" id="6407112">.</span><span class="ident" id="6407113">Min</span><span class="op" id="6407116">.</span><span class="ident" id="6407117">X</span><span class="op" id="6407118">)</span><span class="op" id="6407119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407122">writeUint16</span><span class="op" id="6407133">(</span><span class="ident" id="6407134">e</span><span class="op" id="6407135">.</span><span class="ident" id="6407136">buf</span><span class="op" id="6407139">[</span><span class="num" id="6407140">3</span><span class="op" id="6407141">:</span><span class="num" id="6407142">5</span><span class="op" id="6407143">]</span><span class="op" id="6407144">,</span>&nbsp;<span class="builtintype" id="6407146">uint16</span><span class="op" id="6407152">(</span><span class="ident" id="6407153">b</span><span class="op" id="6407154">.</span><span class="ident" id="6407155">Min</span><span class="op" id="6407158">.</span><span class="ident" id="6407159">Y</span><span class="op" id="6407160">)</span><span class="op" id="6407161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407164">writeUint16</span><span class="op" id="6407175">(</span><span class="ident" id="6407176">e</span><span class="op" id="6407177">.</span><span class="ident" id="6407178">buf</span><span class="op" id="6407181">[</span><span class="num" id="6407182">5</span><span class="op" id="6407183">:</span><span class="num" id="6407184">7</span><span class="op" id="6407185">]</span><span class="op" id="6407186">,</span>&nbsp;<span class="builtintype" id="6407188">uint16</span><span class="op" id="6407194">(</span><span class="ident" id="6407195">b</span><span class="op" id="6407196">.</span><span class="ident" id="6407197">Dx</span><span class="op" id="6407199">(</span><span class="op" id="6407200">)</span><span class="op" id="6407201">)</span><span class="op" id="6407202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407205">writeUint16</span><span class="op" id="6407216">(</span><span class="ident" id="6407217">e</span><span class="op" id="6407218">.</span><span class="ident" id="6407219">buf</span><span class="op" id="6407222">[</span><span class="num" id="6407223">7</span><span class="op" id="6407224">:</span><span class="num" id="6407225">9</span><span class="op" id="6407226">]</span><span class="op" id="6407227">,</span>&nbsp;<span class="builtintype" id="6407229">uint16</span><span class="op" id="6407235">(</span><span class="ident" id="6407236">b</span><span class="op" id="6407237">.</span><span class="ident" id="6407238">Dy</span><span class="op" id="6407240">(</span><span class="op" id="6407241">)</span><span class="op" id="6407242">)</span><span class="op" id="6407243">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407246">e</span><span class="op" id="6407247">.</span><span class="ident" id="6407248">write</span><span class="op" id="6407253">(</span><span class="ident" id="6407254">e</span><span class="op" id="6407255">.</span><span class="ident" id="6407256">buf</span><span class="op" id="6407259">[</span><span class="op" id="6407260">:</span><span class="num" id="6407261">9</span><span class="op" id="6407262">]</span><span class="op" id="6407263">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407267">paddedSize</span>&nbsp;<span class="op" id="6407278">:=</span>&nbsp;<span class="ident" id="6407281">log2</span><span class="op" id="6407285">(</span><span class="builtinfunc" id="6407286">len</span><span class="op" id="6407289">(</span><span class="ident" id="6407290">pm</span><span class="op" id="6407292">.</span><span class="ident" id="6407293">Palette</span><span class="op" id="6407300">)</span><span class="op" id="6407301">)</span>&nbsp;<span class="comment" id="6407303">//&nbsp;Size&nbsp;of&nbsp;Local&nbsp;Color&nbsp;Table:&nbsp;2^(1+n).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6407343">//&nbsp;Interlacing&nbsp;is&nbsp;not&nbsp;supported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407377">e</span><span class="op" id="6407378">.</span><span class="ident" id="6407379">writeByte</span><span class="op" id="6407388">(</span><span class="num" id="6407389">0x80</span>&nbsp;<span class="op" id="6407394">|</span>&nbsp;<span class="builtintype" id="6407396">uint8</span><span class="op" id="6407401">(</span><span class="ident" id="6407402">paddedSize</span><span class="op" id="6407412">)</span><span class="op" id="6407413">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6407417">//&nbsp;Local&nbsp;Color&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407440">e</span><span class="op" id="6407441">.</span><span class="ident" id="6407442">writeColorTable</span><span class="op" id="6407457">(</span><span class="ident" id="6407458">pm</span><span class="op" id="6407460">.</span><span class="ident" id="6407461">Palette</span><span class="op" id="6407468">,</span>&nbsp;<span class="ident" id="6407470">paddedSize</span><span class="op" id="6407480">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407484">litWidth</span>&nbsp;<span class="op" id="6407493">:=</span>&nbsp;<span class="ident" id="6407496">paddedSize</span>&nbsp;<span class="op" id="6407507">+</span>&nbsp;<span class="num" id="6407509">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407512">if</span>&nbsp;<span class="ident" id="6407515">litWidth</span>&nbsp;<span class="op" id="6407524">&lt;</span>&nbsp;<span class="num" id="6407526">2</span>&nbsp;<span class="op" id="6407528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407532">litWidth</span>&nbsp;<span class="op" id="6407541">=</span>&nbsp;<span class="num" id="6407543">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6407546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407549">e</span><span class="op" id="6407550">.</span><span class="ident" id="6407551">writeByte</span><span class="op" id="6407560">(</span><span class="builtintype" id="6407561">uint8</span><span class="op" id="6407566">(</span><span class="ident" id="6407567">litWidth</span><span class="op" id="6407575">)</span><span class="op" id="6407576">)</span>&nbsp;<span class="comment" id="6407578">//&nbsp;LZW&nbsp;Minimum&nbsp;Code&nbsp;Size.</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407606">lzww</span>&nbsp;<span class="op" id="6407611">:=</span>&nbsp;<span class="ident" id="6407614">lzw</span><span class="op" id="6407617">.</span><span class="ident" id="6407618">NewWriter</span><span class="op" id="6407627">(</span><span class="ident" id="6407628">blockWriter</span><span class="op" id="6407639">{</span><span class="ident" id="6407640">e</span><span class="op" id="6407641">:</span>&nbsp;<span class="ident" id="6407643">e</span><span class="op" id="6407644">}</span><span class="op" id="6407645">,</span>&nbsp;<span class="ident" id="6407647">lzw</span><span class="op" id="6407650">.</span><span class="ident" id="6407651">LSB</span><span class="op" id="6407654">,</span>&nbsp;<span class="ident" id="6407656">litWidth</span><span class="op" id="6407664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407667">if</span>&nbsp;<span class="ident" id="6407670">dx</span>&nbsp;<span class="op" id="6407673">:=</span>&nbsp;<span class="ident" id="6407676">b</span><span class="op" id="6407677">.</span><span class="ident" id="6407678">Dx</span><span class="op" id="6407680">(</span><span class="op" id="6407681">)</span><span class="op" id="6407682">;</span>&nbsp;<span class="ident" id="6407684">dx</span>&nbsp;<span class="op" id="6407687">==</span>&nbsp;<span class="ident" id="6407690">pm</span><span class="op" id="6407692">.</span><span class="ident" id="6407693">Stride</span>&nbsp;<span class="op" id="6407700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407704">_</span><span class="op" id="6407705">,</span>&nbsp;<span class="ident" id="6407707">e</span><span class="op" id="6407708">.</span><span class="ident" id="6407709">err</span>&nbsp;<span class="op" id="6407713">=</span>&nbsp;<span class="ident" id="6407715">lzww</span><span class="op" id="6407719">.</span><span class="ident" id="6407720">Write</span><span class="op" id="6407725">(</span><span class="ident" id="6407726">pm</span><span class="op" id="6407728">.</span><span class="ident" id="6407729">Pix</span><span class="op" id="6407732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407736">if</span>&nbsp;<span class="ident" id="6407739">e</span><span class="op" id="6407740">.</span><span class="ident" id="6407741">err</span>&nbsp;<span class="op" id="6407745">!=</span>&nbsp;<span class="ident" id="6407748">nil</span>&nbsp;<span class="op" id="6407752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407757">lzww</span><span class="op" id="6407761">.</span><span class="ident" id="6407762">Close</span><span class="op" id="6407767">(</span><span class="op" id="6407768">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407773">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6407782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6407785">}</span>&nbsp;<span class="keyword" id="6407787">else</span>&nbsp;<span class="op" id="6407792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407796">for</span>&nbsp;<span class="ident" id="6407800">i</span><span class="op" id="6407801">,</span>&nbsp;<span class="ident" id="6407803">y</span>&nbsp;<span class="op" id="6407805">:=</span>&nbsp;<span class="num" id="6407808">0</span><span class="op" id="6407809">,</span>&nbsp;<span class="ident" id="6407811">b</span><span class="op" id="6407812">.</span><span class="ident" id="6407813">Min</span><span class="op" id="6407816">.</span><span class="ident" id="6407817">Y</span><span class="op" id="6407818">;</span>&nbsp;<span class="ident" id="6407820">y</span>&nbsp;<span class="op" id="6407822">&lt;</span>&nbsp;<span class="ident" id="6407824">b</span><span class="op" id="6407825">.</span><span class="ident" id="6407826">Max</span><span class="op" id="6407829">.</span><span class="ident" id="6407830">Y</span><span class="op" id="6407831">;</span>&nbsp;<span class="ident" id="6407833">i</span><span class="op" id="6407834">,</span>&nbsp;<span class="ident" id="6407836">y</span>&nbsp;<span class="op" id="6407838">=</span>&nbsp;<span class="ident" id="6407840">i</span><span class="op" id="6407841">+</span><span class="ident" id="6407842">pm</span><span class="op" id="6407844">.</span><span class="ident" id="6407845">Stride</span><span class="op" id="6407851">,</span>&nbsp;<span class="ident" id="6407853">y</span><span class="op" id="6407854">+</span><span class="num" id="6407855">1</span>&nbsp;<span class="op" id="6407857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407862">_</span><span class="op" id="6407863">,</span>&nbsp;<span class="ident" id="6407865">e</span><span class="op" id="6407866">.</span><span class="ident" id="6407867">err</span>&nbsp;<span class="op" id="6407871">=</span>&nbsp;<span class="ident" id="6407873">lzww</span><span class="op" id="6407877">.</span><span class="ident" id="6407878">Write</span><span class="op" id="6407883">(</span><span class="ident" id="6407884">pm</span><span class="op" id="6407886">.</span><span class="ident" id="6407887">Pix</span><span class="op" id="6407890">[</span><span class="ident" id="6407891">i</span>&nbsp;<span class="op" id="6407893">:</span>&nbsp;<span class="ident" id="6407895">i</span><span class="op" id="6407896">+</span><span class="ident" id="6407897">dx</span><span class="op" id="6407899">]</span><span class="op" id="6407900">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407905">if</span>&nbsp;<span class="ident" id="6407908">e</span><span class="op" id="6407909">.</span><span class="ident" id="6407910">err</span>&nbsp;<span class="op" id="6407914">!=</span>&nbsp;<span class="ident" id="6407917">nil</span>&nbsp;<span class="op" id="6407921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407927">lzww</span><span class="op" id="6407931">.</span><span class="ident" id="6407932">Close</span><span class="op" id="6407937">(</span><span class="op" id="6407938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6407944">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6407954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6407958">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6407961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407964">lzww</span><span class="op" id="6407968">.</span><span class="ident" id="6407969">Close</span><span class="op" id="6407974">(</span><span class="op" id="6407975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6407978">e</span><span class="op" id="6407979">.</span><span class="ident" id="6407980">writeByte</span><span class="op" id="6407989">(</span><span class="num" id="6407990">0x00</span><span class="op" id="6407994">)</span>&nbsp;<span class="comment" id="6407996">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span><span class="op" id="6408017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="6408020">//&nbsp;Options&nbsp;are&nbsp;the&nbsp;encoding&nbsp;parameters.</span><br>
<span class="lineno"></span><span class="keyword" id="6408060">type</span>&nbsp;<span class="ident" id="6408065">Options</span>&nbsp;<span class="keyword" id="6408073">struct</span>&nbsp;<span class="op" id="6408080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6408083">//&nbsp;NumColors&nbsp;is&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;colors&nbsp;used&nbsp;in&nbsp;the&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6408148">//&nbsp;It&nbsp;ranges&nbsp;from&nbsp;1&nbsp;to&nbsp;256.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408177">NumColors</span>&nbsp;<span class="builtintype" id="6408187">int</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6408193">//&nbsp;Quantizer&nbsp;is&nbsp;used&nbsp;to&nbsp;produce&nbsp;a&nbsp;palette&nbsp;with&nbsp;size&nbsp;NumColors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6408257">//&nbsp;palette.Plan9&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Quantizer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408312">Quantizer</span>&nbsp;<span class="ident" id="6408322">draw</span><span class="op" id="6408326">.</span><span class="ident" id="6408327">Quantizer</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6408339">//&nbsp;Drawer&nbsp;is&nbsp;used&nbsp;to&nbsp;convert&nbsp;the&nbsp;source&nbsp;image&nbsp;to&nbsp;the&nbsp;desired&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6408410">//&nbsp;draw.FloydSteinberg&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Drawer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408468">Drawer</span>&nbsp;<span class="ident" id="6408475">draw</span><span class="op" id="6408479">.</span><span class="ident" id="6408480">Drawer</span><br>
<span class="lineno"></span><span class="op" id="6408487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="6408490">//&nbsp;EncodeAll&nbsp;writes&nbsp;the&nbsp;images&nbsp;in&nbsp;g&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6408554">//&nbsp;given&nbsp;loop&nbsp;count&nbsp;and&nbsp;delay&nbsp;between&nbsp;frames.</span><br>
<span class="lineno"></span><span class="keyword" id="6408600">func</span>&nbsp;<span class="ident" id="6408605">EncodeAll</span><span class="op" id="6408614">(</span><span class="ident" id="6408615">w</span>&nbsp;<span class="ident" id="6408617">io</span><span class="op" id="6408619">.</span><span class="ident" id="6408620">Writer</span><span class="op" id="6408626">,</span>&nbsp;<span class="ident" id="6408628">g</span>&nbsp;<span class="op" id="6408630">*</span><span class="ident" id="6408631">GIF</span><span class="op" id="6408634">)</span>&nbsp;<span class="builtintype" id="6408636">error</span>&nbsp;<span class="op" id="6408642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408645">if</span>&nbsp;<span class="builtinfunc" id="6408648">len</span><span class="op" id="6408651">(</span><span class="ident" id="6408652">g</span><span class="op" id="6408653">.</span><span class="ident" id="6408654">Image</span><span class="op" id="6408659">)</span>&nbsp;<span class="op" id="6408661">==</span>&nbsp;<span class="num" id="6408664">0</span>&nbsp;<span class="op" id="6408666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408670">return</span>&nbsp;<span class="ident" id="6408677">errors</span><span class="op" id="6408683">.</span><span class="ident" id="6408684">New</span><span class="op" id="6408687">(</span><span class="string" id="6408688">&#34;gif:&nbsp;must&nbsp;provide&nbsp;at&nbsp;least&nbsp;one&nbsp;image&#34;</span><span class="op" id="6408726">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6408729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408733">if</span>&nbsp;<span class="builtinfunc" id="6408736">len</span><span class="op" id="6408739">(</span><span class="ident" id="6408740">g</span><span class="op" id="6408741">.</span><span class="ident" id="6408742">Image</span><span class="op" id="6408747">)</span>&nbsp;<span class="op" id="6408749">!=</span>&nbsp;<span class="builtinfunc" id="6408752">len</span><span class="op" id="6408755">(</span><span class="ident" id="6408756">g</span><span class="op" id="6408757">.</span><span class="ident" id="6408758">Delay</span><span class="op" id="6408763">)</span>&nbsp;<span class="op" id="6408765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408769">return</span>&nbsp;<span class="ident" id="6408776">errors</span><span class="op" id="6408782">.</span><span class="ident" id="6408783">New</span><span class="op" id="6408786">(</span><span class="string" id="6408787">&#34;gif:&nbsp;mismatched&nbsp;image&nbsp;and&nbsp;delay&nbsp;lengths&#34;</span><span class="op" id="6408828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6408831">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408834">if</span>&nbsp;<span class="ident" id="6408837">g</span><span class="op" id="6408838">.</span><span class="ident" id="6408839">LoopCount</span>&nbsp;<span class="op" id="6408849">&lt;</span>&nbsp;<span class="num" id="6408851">0</span>&nbsp;<span class="op" id="6408853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408857">g</span><span class="op" id="6408858">.</span><span class="ident" id="6408859">LoopCount</span>&nbsp;<span class="op" id="6408869">=</span>&nbsp;<span class="num" id="6408871">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6408874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408878">e</span>&nbsp;<span class="op" id="6408880">:=</span>&nbsp;<span class="ident" id="6408883">encoder</span><span class="op" id="6408890">{</span><span class="ident" id="6408891">g</span><span class="op" id="6408892">:</span>&nbsp;<span class="ident" id="6408894">g</span><span class="op" id="6408895">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408898">if</span>&nbsp;<span class="ident" id="6408901">ww</span><span class="op" id="6408903">,</span>&nbsp;<span class="ident" id="6408905">ok</span>&nbsp;<span class="op" id="6408908">:=</span>&nbsp;<span class="ident" id="6408911">w</span><span class="op" id="6408912">.</span><span class="op" id="6408913">(</span><span class="ident" id="6408914">writer</span><span class="op" id="6408920">)</span><span class="op" id="6408921">;</span>&nbsp;<span class="ident" id="6408923">ok</span>&nbsp;<span class="op" id="6408926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408930">e</span><span class="op" id="6408931">.</span><span class="ident" id="6408932">w</span>&nbsp;<span class="op" id="6408934">=</span>&nbsp;<span class="ident" id="6408936">ww</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6408940">}</span>&nbsp;<span class="keyword" id="6408942">else</span>&nbsp;<span class="op" id="6408947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408951">e</span><span class="op" id="6408952">.</span><span class="ident" id="6408953">w</span>&nbsp;<span class="op" id="6408955">=</span>&nbsp;<span class="ident" id="6408957">bufio</span><span class="op" id="6408962">.</span><span class="ident" id="6408963">NewWriter</span><span class="op" id="6408972">(</span><span class="ident" id="6408973">w</span><span class="op" id="6408974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6408977">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6408981">e</span><span class="op" id="6408982">.</span><span class="ident" id="6408983">writeHeader</span><span class="op" id="6408994">(</span><span class="op" id="6408995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6408998">for</span>&nbsp;<span class="ident" id="6409002">i</span><span class="op" id="6409003">,</span>&nbsp;<span class="ident" id="6409005">pm</span>&nbsp;<span class="op" id="6409008">:=</span>&nbsp;<span class="keyword" id="6409011">range</span>&nbsp;<span class="ident" id="6409017">g</span><span class="op" id="6409018">.</span><span class="ident" id="6409019">Image</span>&nbsp;<span class="op" id="6409025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409029">e</span><span class="op" id="6409030">.</span><span class="ident" id="6409031">writeImageBlock</span><span class="op" id="6409046">(</span><span class="ident" id="6409047">pm</span><span class="op" id="6409049">,</span>&nbsp;<span class="ident" id="6409051">g</span><span class="op" id="6409052">.</span><span class="ident" id="6409053">Delay</span><span class="op" id="6409058">[</span><span class="ident" id="6409059">i</span><span class="op" id="6409060">]</span><span class="op" id="6409061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6409064">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409067">e</span><span class="op" id="6409068">.</span><span class="ident" id="6409069">writeByte</span><span class="op" id="6409078">(</span><span class="ident" id="6409079">sTrailer</span><span class="op" id="6409087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409090">e</span><span class="op" id="6409091">.</span><span class="ident" id="6409092">flush</span><span class="op" id="6409097">(</span><span class="op" id="6409098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6409101">return</span>&nbsp;<span class="ident" id="6409108">e</span><span class="op" id="6409109">.</span><span class="ident" id="6409110">err</span><br>
<span class="lineno"></span><span class="op" id="6409114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="6409117">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="6409166">func</span>&nbsp;<span class="ident" id="6409171">Encode</span><span class="op" id="6409177">(</span><span class="ident" id="6409178">w</span>&nbsp;<span class="ident" id="6409180">io</span><span class="op" id="6409182">.</span><span class="ident" id="6409183">Writer</span><span class="op" id="6409189">,</span>&nbsp;<span class="ident" id="6409191">m</span>&nbsp;<span class="ident" id="6409193">image</span><span class="op" id="6409198">.</span><span class="ident" id="6409199">Image</span><span class="op" id="6409204">,</span>&nbsp;<span class="ident" id="6409206">o</span>&nbsp;<span class="op" id="6409208">*</span><span class="ident" id="6409209">Options</span><span class="op" id="6409216">)</span>&nbsp;<span class="builtintype" id="6409218">error</span>&nbsp;<span class="op" id="6409224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6409227">//&nbsp;Check&nbsp;for&nbsp;bounds&nbsp;and&nbsp;size&nbsp;restrictions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409271">b</span>&nbsp;<span class="op" id="6409273">:=</span>&nbsp;<span class="ident" id="6409276">m</span><span class="op" id="6409277">.</span><span class="ident" id="6409278">Bounds</span><span class="op" id="6409284">(</span><span class="op" id="6409285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6409288">if</span>&nbsp;<span class="ident" id="6409291">b</span><span class="op" id="6409292">.</span><span class="ident" id="6409293">Dx</span><span class="op" id="6409295">(</span><span class="op" id="6409296">)</span>&nbsp;<span class="op" id="6409298">&gt;=</span>&nbsp;<span class="num" id="6409301">1</span><span class="op" id="6409302">&lt;&lt;</span><span class="num" id="6409304">16</span>&nbsp;<span class="op" id="6409307">||</span>&nbsp;<span class="ident" id="6409310">b</span><span class="op" id="6409311">.</span><span class="ident" id="6409312">Dy</span><span class="op" id="6409314">(</span><span class="op" id="6409315">)</span>&nbsp;<span class="op" id="6409317">&gt;=</span>&nbsp;<span class="num" id="6409320">1</span><span class="op" id="6409321">&lt;&lt;</span><span class="num" id="6409323">16</span>&nbsp;<span class="op" id="6409326">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6409330">return</span>&nbsp;<span class="ident" id="6409337">errors</span><span class="op" id="6409343">.</span><span class="ident" id="6409344">New</span><span class="op" id="6409347">(</span><span class="string" id="6409348">&#34;gif:&nbsp;image&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="6409383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6409386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409390">opts</span>&nbsp;<span class="op" id="6409395">:=</span>&nbsp;<span class="ident" id="6409398">Options</span><span class="op" id="6409405">{</span><span class="op" id="6409406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6409409">if</span>&nbsp;<span class="ident" id="6409412">o</span>&nbsp;<span class="op" id="6409414">!=</span>&nbsp;<span class="ident" id="6409417">nil</span>&nbsp;<span class="op" id="6409421">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409425">opts</span>&nbsp;<span class="op" id="6409430">=</span>&nbsp;<span class="op" id="6409432">*</span><span class="ident" id="6409433">o</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6409436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6409439">if</span>&nbsp;<span class="ident" id="6409442">opts</span><span class="op" id="6409446">.</span><span class="ident" id="6409447">NumColors</span>&nbsp;<span class="op" id="6409457">&lt;</span>&nbsp;<span class="num" id="6409459">1</span>&nbsp;<span class="op" id="6409461">||</span>&nbsp;<span class="num" id="6409464">256</span>&nbsp;<span class="op" id="6409468">&lt;</span>&nbsp;<span class="ident" id="6409470">opts</span><span class="op" id="6409474">.</span><span class="ident" id="6409475">NumColors</span>&nbsp;<span class="op" id="6409485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409489">opts</span><span class="op" id="6409493">.</span><span class="ident" id="6409494">NumColors</span>&nbsp;<span class="op" id="6409504">=</span>&nbsp;<span class="num" id="6409506">256</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6409511">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6409514">if</span>&nbsp;<span class="ident" id="6409517">opts</span><span class="op" id="6409521">.</span><span class="ident" id="6409522">Drawer</span>&nbsp;<span class="op" id="6409529">==</span>&nbsp;<span class="ident" id="6409532">nil</span>&nbsp;<span class="op" id="6409536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409540">opts</span><span class="op" id="6409544">.</span><span class="ident" id="6409545">Drawer</span>&nbsp;<span class="op" id="6409552">=</span>&nbsp;<span class="ident" id="6409554">draw</span><span class="op" id="6409558">.</span><span class="ident" id="6409559">FloydSteinberg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6409575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409579">pm</span><span class="op" id="6409581">,</span>&nbsp;<span class="ident" id="6409583">ok</span>&nbsp;<span class="op" id="6409586">:=</span>&nbsp;<span class="ident" id="6409589">m</span><span class="op" id="6409590">.</span><span class="op" id="6409591">(</span><span class="op" id="6409592">*</span><span class="ident" id="6409593">image</span><span class="op" id="6409598">.</span><span class="ident" id="6409599">Paletted</span><span class="op" id="6409607">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6409610">if</span>&nbsp;<span class="op" id="6409613">!</span><span class="ident" id="6409614">ok</span>&nbsp;<span class="op" id="6409617">||</span>&nbsp;<span class="builtinfunc" id="6409620">len</span><span class="op" id="6409623">(</span><span class="ident" id="6409624">pm</span><span class="op" id="6409626">.</span><span class="ident" id="6409627">Palette</span><span class="op" id="6409634">)</span>&nbsp;<span class="op" id="6409636">&gt;</span>&nbsp;<span class="ident" id="6409638">opts</span><span class="op" id="6409642">.</span><span class="ident" id="6409643">NumColors</span>&nbsp;<span class="op" id="6409653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6409657">//&nbsp;TODO:&nbsp;Pick&nbsp;a&nbsp;better&nbsp;sub-sample&nbsp;of&nbsp;the&nbsp;Plan&nbsp;9&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409716">pm</span>&nbsp;<span class="op" id="6409719">=</span>&nbsp;<span class="ident" id="6409721">image</span><span class="op" id="6409726">.</span><span class="ident" id="6409727">NewPaletted</span><span class="op" id="6409738">(</span><span class="ident" id="6409739">b</span><span class="op" id="6409740">,</span>&nbsp;<span class="ident" id="6409742">palette</span><span class="op" id="6409749">.</span><span class="ident" id="6409750">Plan9</span><span class="op" id="6409755">[</span><span class="op" id="6409756">:</span><span class="ident" id="6409757">opts</span><span class="op" id="6409761">.</span><span class="ident" id="6409762">NumColors</span><span class="op" id="6409771">]</span><span class="op" id="6409772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6409776">if</span>&nbsp;<span class="ident" id="6409779">opts</span><span class="op" id="6409783">.</span><span class="ident" id="6409784">Quantizer</span>&nbsp;<span class="op" id="6409794">!=</span>&nbsp;<span class="ident" id="6409797">nil</span>&nbsp;<span class="op" id="6409801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409806">pm</span><span class="op" id="6409808">.</span><span class="ident" id="6409809">Palette</span>&nbsp;<span class="op" id="6409817">=</span>&nbsp;<span class="ident" id="6409819">opts</span><span class="op" id="6409823">.</span><span class="ident" id="6409824">Quantizer</span><span class="op" id="6409833">.</span><span class="ident" id="6409834">Quantize</span><span class="op" id="6409842">(</span><span class="builtinfunc" id="6409843">make</span><span class="op" id="6409847">(</span><span class="ident" id="6409848">color</span><span class="op" id="6409853">.</span><span class="ident" id="6409854">Palette</span><span class="op" id="6409861">,</span>&nbsp;<span class="num" id="6409863">0</span><span class="op" id="6409864">,</span>&nbsp;<span class="ident" id="6409866">opts</span><span class="op" id="6409870">.</span><span class="ident" id="6409871">NumColors</span><span class="op" id="6409880">)</span><span class="op" id="6409881">,</span>&nbsp;<span class="ident" id="6409883">m</span><span class="op" id="6409884">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6409888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409892">opts</span><span class="op" id="6409896">.</span><span class="ident" id="6409897">Drawer</span><span class="op" id="6409903">.</span><span class="ident" id="6409904">Draw</span><span class="op" id="6409908">(</span><span class="ident" id="6409909">pm</span><span class="op" id="6409911">,</span>&nbsp;<span class="ident" id="6409913">b</span><span class="op" id="6409914">,</span>&nbsp;<span class="ident" id="6409916">m</span><span class="op" id="6409917">,</span>&nbsp;<span class="ident" id="6409919">image</span><span class="op" id="6409924">.</span><span class="ident" id="6409925">ZP</span><span class="op" id="6409927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6409930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6409934">return</span>&nbsp;<span class="ident" id="6409941">EncodeAll</span><span class="op" id="6409950">(</span><span class="ident" id="6409951">w</span><span class="op" id="6409952">,</span>&nbsp;<span class="op" id="6409954">&amp;</span><span class="ident" id="6409955">GIF</span><span class="op" id="6409958">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409962">Image</span><span class="op" id="6409967">:</span>&nbsp;<span class="op" id="6409969">[</span><span class="op" id="6409970">]</span><span class="op" id="6409971">*</span><span class="ident" id="6409972">image</span><span class="op" id="6409977">.</span><span class="ident" id="6409978">Paletted</span><span class="op" id="6409986">{</span><span class="ident" id="6409987">pm</span><span class="op" id="6409989">}</span><span class="op" id="6409990">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6409994">Delay</span><span class="op" id="6409999">:</span>&nbsp;<span class="op" id="6410001">[</span><span class="op" id="6410002">]</span><span class="builtintype" id="6410003">int</span><span class="op" id="6410006">{</span><span class="num" id="6410007">0</span><span class="op" id="6410008">}</span><span class="op" id="6410009">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6410012">}</span><span class="op" id="6410013">)</span><br>
<span class="lineno"></span><span class="op" id="6410015">}</span>
</div>
</body>
</html>
