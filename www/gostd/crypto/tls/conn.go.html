<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4152249">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4152304">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4152358">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4152409">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4152455">package</span>&nbsp;<span class="ident" id="4152463">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4152468">import</span>&nbsp;<span class="op" id="4152475">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4152478">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4152487">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4152504">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4152521">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4152536">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4152546">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4152553">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4152559">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4152566">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4152574">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4152581">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4152584">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4152627">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="4152668">type</span>&nbsp;<span class="ident" id="4152673">Conn</span>&nbsp;<span class="keyword" id="4152678">struct</span>&nbsp;<span class="op" id="4152685">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4152688">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4152701">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4152710">net</span><span class="op" id="4152713">.</span><span class="ident" id="4152714">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4152720">isClient</span>&nbsp;<span class="builtintype" id="4152729">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4152736">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4152794">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4152812">sync</span><span class="op" id="4152816">.</span><span class="ident" id="4152817">Mutex</span>&nbsp;<span class="comment" id="4152823">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4152874">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4152892">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152903">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4152938">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4152956">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4152967">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4152983">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4153001">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4153012">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153044">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4153062">*</span><span class="ident" id="4153063">Config</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4153073">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153113">handshakeComplete</span>&nbsp;<span class="builtintype" id="4153131">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153137">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4153155">bool</span>&nbsp;<span class="comment" id="4153160">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153213">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4153231">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153239">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4153257">[</span><span class="op" id="4153258">]</span><span class="builtintype" id="4153259">byte</span>&nbsp;<span class="comment" id="4153264">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153290">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="4153308">[</span><span class="op" id="4153309">]</span><span class="op" id="4153310">*</span><span class="ident" id="4153311">x509</span><span class="op" id="4153315">.</span><span class="ident" id="4153316">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4153329">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4153398">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153447">verifiedChains</span>&nbsp;<span class="op" id="4153462">[</span><span class="op" id="4153463">]</span><span class="op" id="4153464">[</span><span class="op" id="4153465">]</span><span class="op" id="4153466">*</span><span class="ident" id="4153467">x509</span><span class="op" id="4153471">.</span><span class="ident" id="4153472">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4153485">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153558">serverName</span>&nbsp;<span class="builtintype" id="4153569">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4153577">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4153644">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153707">firstFinished</span>&nbsp;<span class="op" id="4153721">[</span><span class="num" id="4153722">12</span><span class="op" id="4153724">]</span><span class="builtintype" id="4153725">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153732">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4153755">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153763">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="4153786">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4153793">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153810">in</span><span class="op" id="4153812">,</span>&nbsp;<span class="ident" id="4153814">out</span>&nbsp;&nbsp;<span class="ident" id="4153819">halfConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4153832">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153857">rawInput</span>&nbsp;<span class="op" id="4153866">*</span><span class="ident" id="4153867">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4153879">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153913">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4153922">*</span><span class="ident" id="4153923">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4153935">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4153975">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4153984">bytes</span><span class="op" id="4153989">.</span><span class="ident" id="4153990">Buffer</span>&nbsp;<span class="comment" id="4153997">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4154036">tmp</span>&nbsp;<span class="op" id="4154040">[</span><span class="num" id="4154041">16</span><span class="op" id="4154043">]</span><span class="builtintype" id="4154044">byte</span><br>
<span class="lineno"></span><span class="op" id="4154049">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4154052">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="4154083">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="4154132">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4154165">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4154213">func</span>&nbsp;<span class="op" id="4154218">(</span><span class="ident" id="4154219">c</span>&nbsp;<span class="op" id="4154221">*</span><span class="ident" id="4154222">Conn</span><span class="op" id="4154226">)</span>&nbsp;<span class="ident" id="4154228">LocalAddr</span><span class="op" id="4154237">(</span><span class="op" id="4154238">)</span>&nbsp;<span class="ident" id="4154240">net</span><span class="op" id="4154243">.</span><span class="ident" id="4154244">Addr</span>&nbsp;<span class="op" id="4154249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154252">return</span>&nbsp;<span class="ident" id="4154259">c</span><span class="op" id="4154260">.</span><span class="ident" id="4154261">conn</span><span class="op" id="4154265">.</span><span class="ident" id="4154266">LocalAddr</span><span class="op" id="4154275">(</span><span class="op" id="4154276">)</span><br>
<span class="lineno"></span><span class="op" id="4154278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="4154281">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4154331">func</span>&nbsp;<span class="op" id="4154336">(</span><span class="ident" id="4154337">c</span>&nbsp;<span class="op" id="4154339">*</span><span class="ident" id="4154340">Conn</span><span class="op" id="4154344">)</span>&nbsp;<span class="ident" id="4154346">RemoteAddr</span><span class="op" id="4154356">(</span><span class="op" id="4154357">)</span>&nbsp;<span class="ident" id="4154359">net</span><span class="op" id="4154362">.</span><span class="ident" id="4154363">Addr</span>&nbsp;<span class="op" id="4154368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154371">return</span>&nbsp;<span class="ident" id="4154378">c</span><span class="op" id="4154379">.</span><span class="ident" id="4154380">conn</span><span class="op" id="4154384">.</span><span class="ident" id="4154385">RemoteAddr</span><span class="op" id="4154395">(</span><span class="op" id="4154396">)</span><br>
<span class="lineno"></span><span class="op" id="4154398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4154401">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4154482">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="4154544">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4154651">func</span>&nbsp;<span class="op" id="4154656">(</span><span class="ident" id="4154657">c</span>&nbsp;<span class="op" id="4154659">*</span><span class="ident" id="4154660">Conn</span><span class="op" id="4154664">)</span>&nbsp;<span class="ident" id="4154666">SetDeadline</span><span class="op" id="4154677">(</span><span class="ident" id="4154678">t</span>&nbsp;<span class="ident" id="4154680">time</span><span class="op" id="4154684">.</span><span class="ident" id="4154685">Time</span><span class="op" id="4154689">)</span>&nbsp;<span class="builtintype" id="4154691">error</span>&nbsp;<span class="op" id="4154697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154700">return</span>&nbsp;<span class="ident" id="4154707">c</span><span class="op" id="4154708">.</span><span class="ident" id="4154709">conn</span><span class="op" id="4154713">.</span><span class="ident" id="4154714">SetDeadline</span><span class="op" id="4154725">(</span><span class="ident" id="4154726">t</span><span class="op" id="4154727">)</span><br>
<span class="lineno">80</span><span class="op" id="4154729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4154732">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4154804">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4154856">func</span>&nbsp;<span class="op" id="4154861">(</span><span class="ident" id="4154862">c</span>&nbsp;<span class="op" id="4154864">*</span><span class="ident" id="4154865">Conn</span><span class="op" id="4154869">)</span>&nbsp;<span class="ident" id="4154871">SetReadDeadline</span><span class="op" id="4154886">(</span><span class="ident" id="4154887">t</span>&nbsp;<span class="ident" id="4154889">time</span><span class="op" id="4154893">.</span><span class="ident" id="4154894">Time</span><span class="op" id="4154898">)</span>&nbsp;<span class="builtintype" id="4154900">error</span>&nbsp;<span class="op" id="4154906">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4154909">return</span>&nbsp;<span class="ident" id="4154916">c</span><span class="op" id="4154917">.</span><span class="ident" id="4154918">conn</span><span class="op" id="4154922">.</span><span class="ident" id="4154923">SetReadDeadline</span><span class="op" id="4154938">(</span><span class="ident" id="4154939">t</span><span class="op" id="4154940">)</span><br>
<span class="lineno"></span><span class="op" id="4154942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4154945">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4155019">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="4155072">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4155179">func</span>&nbsp;<span class="op" id="4155184">(</span><span class="ident" id="4155185">c</span>&nbsp;<span class="op" id="4155187">*</span><span class="ident" id="4155188">Conn</span><span class="op" id="4155192">)</span>&nbsp;<span class="ident" id="4155194">SetWriteDeadline</span><span class="op" id="4155210">(</span><span class="ident" id="4155211">t</span>&nbsp;<span class="ident" id="4155213">time</span><span class="op" id="4155217">.</span><span class="ident" id="4155218">Time</span><span class="op" id="4155222">)</span>&nbsp;<span class="builtintype" id="4155224">error</span>&nbsp;<span class="op" id="4155230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4155233">return</span>&nbsp;<span class="ident" id="4155240">c</span><span class="op" id="4155241">.</span><span class="ident" id="4155242">conn</span><span class="op" id="4155246">.</span><span class="ident" id="4155247">SetWriteDeadline</span><span class="op" id="4155263">(</span><span class="ident" id="4155264">t</span><span class="op" id="4155265">)</span><br>
<span class="lineno"></span><span class="op" id="4155267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4155270">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="4155329">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="4155373">type</span>&nbsp;<span class="ident" id="4155378">halfConn</span>&nbsp;<span class="keyword" id="4155387">struct</span>&nbsp;<span class="op" id="4155394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155397">sync</span><span class="op" id="4155401">.</span><span class="ident" id="4155402">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155410">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4155418">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155430">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155456">version</span>&nbsp;<span class="builtintype" id="4155464">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4155476">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155497">cipher</span>&nbsp;&nbsp;<span class="keyword" id="4155505">interface</span><span class="op" id="4155514">{</span><span class="op" id="4155515">}</span>&nbsp;<span class="comment" id="4155517">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155538">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155546">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155559">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4155567">[</span><span class="num" id="4155568">8</span><span class="op" id="4155569">]</span><span class="builtintype" id="4155570">byte</span>&nbsp;<span class="comment" id="4155575">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155602">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4155610">*</span><span class="ident" id="4155611">block</span>&nbsp;&nbsp;<span class="comment" id="4155618">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155643">nextCipher</span>&nbsp;<span class="keyword" id="4155654">interface</span><span class="op" id="4155663">{</span><span class="op" id="4155664">}</span>&nbsp;<span class="comment" id="4155666">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155692">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4155703">macFunction</span>&nbsp;<span class="comment" id="4155715">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4155739">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155794">inDigestBuf</span><span class="op" id="4155805">,</span>&nbsp;<span class="ident" id="4155807">outDigestBuf</span>&nbsp;<span class="op" id="4155820">[</span><span class="op" id="4155821">]</span><span class="builtintype" id="4155822">byte</span><br>
<span class="lineno"></span><span class="op" id="4155827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4155830">func</span>&nbsp;<span class="op" id="4155835">(</span><span class="ident" id="4155836">hc</span>&nbsp;<span class="op" id="4155839">*</span><span class="ident" id="4155840">halfConn</span><span class="op" id="4155848">)</span>&nbsp;<span class="ident" id="4155850">setErrorLocked</span><span class="op" id="4155864">(</span><span class="ident" id="4155865">err</span>&nbsp;<span class="builtintype" id="4155869">error</span><span class="op" id="4155874">)</span>&nbsp;<span class="builtintype" id="4155876">error</span>&nbsp;<span class="op" id="4155882">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155885">hc</span><span class="op" id="4155887">.</span><span class="ident" id="4155888">err</span>&nbsp;<span class="op" id="4155892">=</span>&nbsp;<span class="ident" id="4155894">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4155899">return</span>&nbsp;<span class="ident" id="4155906">err</span><br>
<span class="lineno"></span><span class="op" id="4155910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4155913">func</span>&nbsp;<span class="op" id="4155918">(</span><span class="ident" id="4155919">hc</span>&nbsp;<span class="op" id="4155922">*</span><span class="ident" id="4155923">halfConn</span><span class="op" id="4155931">)</span>&nbsp;<span class="builtintype" id="4155933">error</span><span class="op" id="4155938">(</span><span class="op" id="4155939">)</span>&nbsp;<span class="builtintype" id="4155941">error</span>&nbsp;<span class="op" id="4155947">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155950">hc</span><span class="op" id="4155952">.</span><span class="ident" id="4155953">Lock</span><span class="op" id="4155957">(</span><span class="op" id="4155958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155961">err</span>&nbsp;<span class="op" id="4155965">:=</span>&nbsp;<span class="ident" id="4155968">hc</span><span class="op" id="4155970">.</span><span class="ident" id="4155971">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4155976">hc</span><span class="op" id="4155978">.</span><span class="ident" id="4155979">Unlock</span><span class="op" id="4155985">(</span><span class="op" id="4155986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4155989">return</span>&nbsp;<span class="ident" id="4155996">err</span><br>
<span class="lineno"></span><span class="op" id="4156000">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="4156003">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="4156059">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4156107">func</span>&nbsp;<span class="op" id="4156112">(</span><span class="ident" id="4156113">hc</span>&nbsp;<span class="op" id="4156116">*</span><span class="ident" id="4156117">halfConn</span><span class="op" id="4156125">)</span>&nbsp;<span class="ident" id="4156127">prepareCipherSpec</span><span class="op" id="4156144">(</span><span class="ident" id="4156145">version</span>&nbsp;<span class="builtintype" id="4156153">uint16</span><span class="op" id="4156159">,</span>&nbsp;<span class="ident" id="4156161">cipher</span>&nbsp;<span class="keyword" id="4156168">interface</span><span class="op" id="4156177">{</span><span class="op" id="4156178">}</span><span class="op" id="4156179">,</span>&nbsp;<span class="ident" id="4156181">mac</span>&nbsp;<span class="ident" id="4156185">macFunction</span><span class="op" id="4156196">)</span>&nbsp;<span class="op" id="4156198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4156201">hc</span><span class="op" id="4156203">.</span><span class="ident" id="4156204">version</span>&nbsp;<span class="op" id="4156212">=</span>&nbsp;<span class="ident" id="4156214">version</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4156223">hc</span><span class="op" id="4156225">.</span><span class="ident" id="4156226">nextCipher</span>&nbsp;<span class="op" id="4156237">=</span>&nbsp;<span class="ident" id="4156239">cipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4156247">hc</span><span class="op" id="4156249">.</span><span class="ident" id="4156250">nextMac</span>&nbsp;<span class="op" id="4156258">=</span>&nbsp;<span class="ident" id="4156260">mac</span><br>
<span class="lineno"></span><span class="op" id="4156264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4156267">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="4156325">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="4156380">func</span>&nbsp;<span class="op" id="4156385">(</span><span class="ident" id="4156386">hc</span>&nbsp;<span class="op" id="4156389">*</span><span class="ident" id="4156390">halfConn</span><span class="op" id="4156398">)</span>&nbsp;<span class="ident" id="4156400">changeCipherSpec</span><span class="op" id="4156416">(</span><span class="op" id="4156417">)</span>&nbsp;<span class="builtintype" id="4156419">error</span>&nbsp;<span class="op" id="4156425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4156428">if</span>&nbsp;<span class="ident" id="4156431">hc</span><span class="op" id="4156433">.</span><span class="ident" id="4156434">nextCipher</span>&nbsp;<span class="op" id="4156445">==</span>&nbsp;<span class="ident" id="4156448">nil</span>&nbsp;<span class="op" id="4156452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4156456">return</span>&nbsp;<span class="ident" id="4156463">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4156483">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4156486">hc</span><span class="op" id="4156488">.</span><span class="ident" id="4156489">cipher</span>&nbsp;<span class="op" id="4156496">=</span>&nbsp;<span class="ident" id="4156498">hc</span><span class="op" id="4156500">.</span><span class="ident" id="4156501">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4156513">hc</span><span class="op" id="4156515">.</span><span class="ident" id="4156516">mac</span>&nbsp;<span class="op" id="4156520">=</span>&nbsp;<span class="ident" id="4156522">hc</span><span class="op" id="4156524">.</span><span class="ident" id="4156525">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4156534">hc</span><span class="op" id="4156536">.</span><span class="ident" id="4156537">nextCipher</span>&nbsp;<span class="op" id="4156548">=</span>&nbsp;<span class="ident" id="4156550">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4156555">hc</span><span class="op" id="4156557">.</span><span class="ident" id="4156558">nextMac</span>&nbsp;<span class="op" id="4156566">=</span>&nbsp;<span class="ident" id="4156568">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4156573">for</span>&nbsp;<span class="ident" id="4156577">i</span>&nbsp;<span class="op" id="4156579">:=</span>&nbsp;<span class="keyword" id="4156582">range</span>&nbsp;<span class="ident" id="4156588">hc</span><span class="op" id="4156590">.</span><span class="ident" id="4156591">seq</span>&nbsp;<span class="op" id="4156595">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4156599">hc</span><span class="op" id="4156601">.</span><span class="ident" id="4156602">seq</span><span class="op" id="4156605">[</span><span class="ident" id="4156606">i</span><span class="op" id="4156607">]</span>&nbsp;<span class="op" id="4156609">=</span>&nbsp;<span class="num" id="4156611">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4156614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4156617">return</span>&nbsp;<span class="ident" id="4156624">nil</span><br>
<span class="lineno"></span><span class="op" id="4156628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4156631">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="4156673">func</span>&nbsp;<span class="op" id="4156678">(</span><span class="ident" id="4156679">hc</span>&nbsp;<span class="op" id="4156682">*</span><span class="ident" id="4156683">halfConn</span><span class="op" id="4156691">)</span>&nbsp;<span class="ident" id="4156693">incSeq</span><span class="op" id="4156699">(</span><span class="op" id="4156700">)</span>&nbsp;<span class="op" id="4156702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4156705">for</span>&nbsp;<span class="ident" id="4156709">i</span>&nbsp;<span class="op" id="4156711">:=</span>&nbsp;<span class="num" id="4156714">7</span><span class="op" id="4156715">;</span>&nbsp;<span class="ident" id="4156717">i</span>&nbsp;<span class="op" id="4156719">&gt;=</span>&nbsp;<span class="num" id="4156722">0</span><span class="op" id="4156723">;</span>&nbsp;<span class="ident" id="4156725">i</span><span class="op" id="4156726">--</span>&nbsp;<span class="op" id="4156729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4156733">hc</span><span class="op" id="4156735">.</span><span class="ident" id="4156736">seq</span><span class="op" id="4156739">[</span><span class="ident" id="4156740">i</span><span class="op" id="4156741">]</span><span class="op" id="4156742">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4156747">if</span>&nbsp;<span class="ident" id="4156750">hc</span><span class="op" id="4156752">.</span><span class="ident" id="4156753">seq</span><span class="op" id="4156756">[</span><span class="ident" id="4156757">i</span><span class="op" id="4156758">]</span>&nbsp;<span class="op" id="4156760">!=</span>&nbsp;<span class="num" id="4156763">0</span>&nbsp;<span class="op" id="4156765">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4156770">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4156779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4156782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4156786">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4156831">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4156877">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4156910">panic</span><span class="op" id="4156915">(</span><span class="string" id="4156916">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="4156949">)</span><br>
<span class="lineno"></span><span class="op" id="4156951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4156954">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="4157002">func</span>&nbsp;<span class="op" id="4157007">(</span><span class="ident" id="4157008">hc</span>&nbsp;<span class="op" id="4157011">*</span><span class="ident" id="4157012">halfConn</span><span class="op" id="4157020">)</span>&nbsp;<span class="ident" id="4157022">resetSeq</span><span class="op" id="4157030">(</span><span class="op" id="4157031">)</span>&nbsp;<span class="op" id="4157033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4157036">for</span>&nbsp;<span class="ident" id="4157040">i</span>&nbsp;<span class="op" id="4157042">:=</span>&nbsp;<span class="keyword" id="4157045">range</span>&nbsp;<span class="ident" id="4157051">hc</span><span class="op" id="4157053">.</span><span class="ident" id="4157054">seq</span>&nbsp;<span class="op" id="4157058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4157062">hc</span><span class="op" id="4157064">.</span><span class="ident" id="4157065">seq</span><span class="op" id="4157068">[</span><span class="ident" id="4157069">i</span><span class="op" id="4157070">]</span>&nbsp;<span class="op" id="4157072">=</span>&nbsp;<span class="num" id="4157074">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4157077">}</span><br>
<span class="lineno">170</span><span class="op" id="4157079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4157082">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="4157162">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4157239">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="4157299">func</span>&nbsp;<span class="ident" id="4157304">removePadding</span><span class="op" id="4157317">(</span><span class="ident" id="4157318">payload</span>&nbsp;<span class="op" id="4157326">[</span><span class="op" id="4157327">]</span><span class="builtintype" id="4157328">byte</span><span class="op" id="4157332">)</span>&nbsp;<span class="op" id="4157334">(</span><span class="op" id="4157335">[</span><span class="op" id="4157336">]</span><span class="builtintype" id="4157337">byte</span><span class="op" id="4157341">,</span>&nbsp;<span class="builtintype" id="4157343">byte</span><span class="op" id="4157347">)</span>&nbsp;<span class="op" id="4157349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4157352">if</span>&nbsp;<span class="builtinfunc" id="4157355">len</span><span class="op" id="4157358">(</span><span class="ident" id="4157359">payload</span><span class="op" id="4157366">)</span>&nbsp;<span class="op" id="4157368">&lt;</span>&nbsp;<span class="num" id="4157370">1</span>&nbsp;<span class="op" id="4157372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4157376">return</span>&nbsp;<span class="ident" id="4157383">payload</span><span class="op" id="4157390">,</span>&nbsp;<span class="num" id="4157392">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4157395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4157399">paddingLen</span>&nbsp;<span class="op" id="4157410">:=</span>&nbsp;<span class="ident" id="4157413">payload</span><span class="op" id="4157420">[</span><span class="builtinfunc" id="4157421">len</span><span class="op" id="4157424">(</span><span class="ident" id="4157425">payload</span><span class="op" id="4157432">)</span><span class="op" id="4157433">-</span><span class="num" id="4157434">1</span><span class="op" id="4157435">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4157438">t</span>&nbsp;<span class="op" id="4157440">:=</span>&nbsp;<span class="builtintype" id="4157443">uint</span><span class="op" id="4157447">(</span><span class="builtinfunc" id="4157448">len</span><span class="op" id="4157451">(</span><span class="ident" id="4157452">payload</span><span class="op" id="4157459">)</span><span class="op" id="4157460">-</span><span class="num" id="4157461">1</span><span class="op" id="4157462">)</span>&nbsp;<span class="op" id="4157464">-</span>&nbsp;<span class="builtintype" id="4157466">uint</span><span class="op" id="4157470">(</span><span class="ident" id="4157471">paddingLen</span><span class="op" id="4157481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4157484">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4157550">good</span>&nbsp;<span class="op" id="4157555">:=</span>&nbsp;<span class="builtintype" id="4157558">byte</span><span class="op" id="4157562">(</span><span class="builtintype" id="4157563">int32</span><span class="op" id="4157568">(</span><span class="op" id="4157569">^</span><span class="ident" id="4157570">t</span><span class="op" id="4157571">)</span>&nbsp;<span class="op" id="4157573">&gt;&gt;</span>&nbsp;<span class="num" id="4157576">31</span><span class="op" id="4157578">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4157582">toCheck</span>&nbsp;<span class="op" id="4157590">:=</span>&nbsp;<span class="num" id="4157593">255</span>&nbsp;<span class="comment" id="4157597">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4157637">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4157707">if</span>&nbsp;<span class="ident" id="4157710">toCheck</span><span class="op" id="4157717">+</span><span class="num" id="4157718">1</span>&nbsp;<span class="op" id="4157720">&gt;</span>&nbsp;<span class="builtinfunc" id="4157722">len</span><span class="op" id="4157725">(</span><span class="ident" id="4157726">payload</span><span class="op" id="4157733">)</span>&nbsp;<span class="op" id="4157735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4157739">toCheck</span>&nbsp;<span class="op" id="4157747">=</span>&nbsp;<span class="builtinfunc" id="4157749">len</span><span class="op" id="4157752">(</span><span class="ident" id="4157753">payload</span><span class="op" id="4157760">)</span>&nbsp;<span class="op" id="4157762">-</span>&nbsp;<span class="num" id="4157764">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4157767">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4157771">for</span>&nbsp;<span class="ident" id="4157775">i</span>&nbsp;<span class="op" id="4157777">:=</span>&nbsp;<span class="num" id="4157780">0</span><span class="op" id="4157781">;</span>&nbsp;<span class="ident" id="4157783">i</span>&nbsp;<span class="op" id="4157785">&lt;</span>&nbsp;<span class="ident" id="4157787">toCheck</span><span class="op" id="4157794">;</span>&nbsp;<span class="ident" id="4157796">i</span><span class="op" id="4157797">++</span>&nbsp;<span class="op" id="4157800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4157804">t</span>&nbsp;<span class="op" id="4157806">:=</span>&nbsp;<span class="builtintype" id="4157809">uint</span><span class="op" id="4157813">(</span><span class="ident" id="4157814">paddingLen</span><span class="op" id="4157824">)</span>&nbsp;<span class="op" id="4157826">-</span>&nbsp;<span class="builtintype" id="4157828">uint</span><span class="op" id="4157832">(</span><span class="ident" id="4157833">i</span><span class="op" id="4157834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4157838">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4157888">mask</span>&nbsp;<span class="op" id="4157893">:=</span>&nbsp;<span class="builtintype" id="4157896">byte</span><span class="op" id="4157900">(</span><span class="builtintype" id="4157901">int32</span><span class="op" id="4157906">(</span><span class="op" id="4157907">^</span><span class="ident" id="4157908">t</span><span class="op" id="4157909">)</span>&nbsp;<span class="op" id="4157911">&gt;&gt;</span>&nbsp;<span class="num" id="4157914">31</span><span class="op" id="4157916">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4157920">b</span>&nbsp;<span class="op" id="4157922">:=</span>&nbsp;<span class="ident" id="4157925">payload</span><span class="op" id="4157932">[</span><span class="builtinfunc" id="4157933">len</span><span class="op" id="4157936">(</span><span class="ident" id="4157937">payload</span><span class="op" id="4157944">)</span><span class="op" id="4157945">-</span><span class="num" id="4157946">1</span><span class="op" id="4157947">-</span><span class="ident" id="4157948">i</span><span class="op" id="4157949">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4157953">good</span>&nbsp;<span class="op" id="4157958">&amp;^=</span>&nbsp;<span class="ident" id="4157962">mask</span><span class="op" id="4157966">&amp;</span><span class="ident" id="4157967">paddingLen</span>&nbsp;<span class="op" id="4157978">^</span>&nbsp;<span class="ident" id="4157980">mask</span><span class="op" id="4157984">&amp;</span><span class="ident" id="4157985">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4157988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4157992">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4158061">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158079">good</span>&nbsp;<span class="op" id="4158084">&amp;=</span>&nbsp;<span class="ident" id="4158087">good</span>&nbsp;<span class="op" id="4158092">&lt;&lt;</span>&nbsp;<span class="num" id="4158095">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158098">good</span>&nbsp;<span class="op" id="4158103">&amp;=</span>&nbsp;<span class="ident" id="4158106">good</span>&nbsp;<span class="op" id="4158111">&lt;&lt;</span>&nbsp;<span class="num" id="4158114">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158117">good</span>&nbsp;<span class="op" id="4158122">&amp;=</span>&nbsp;<span class="ident" id="4158125">good</span>&nbsp;<span class="op" id="4158130">&lt;&lt;</span>&nbsp;<span class="num" id="4158133">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158136">good</span>&nbsp;<span class="op" id="4158141">=</span>&nbsp;<span class="builtintype" id="4158143">uint8</span><span class="op" id="4158148">(</span><span class="builtintype" id="4158149">int8</span><span class="op" id="4158153">(</span><span class="ident" id="4158154">good</span><span class="op" id="4158158">)</span>&nbsp;<span class="op" id="4158160">&gt;&gt;</span>&nbsp;<span class="num" id="4158163">7</span><span class="op" id="4158164">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158168">toRemove</span>&nbsp;<span class="op" id="4158177">:=</span>&nbsp;<span class="ident" id="4158180">good</span><span class="op" id="4158184">&amp;</span><span class="ident" id="4158185">paddingLen</span>&nbsp;<span class="op" id="4158196">+</span>&nbsp;<span class="num" id="4158198">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4158201">return</span>&nbsp;<span class="ident" id="4158208">payload</span><span class="op" id="4158215">[</span><span class="op" id="4158216">:</span><span class="builtinfunc" id="4158217">len</span><span class="op" id="4158220">(</span><span class="ident" id="4158221">payload</span><span class="op" id="4158228">)</span><span class="op" id="4158229">-</span><span class="builtintype" id="4158230">int</span><span class="op" id="4158233">(</span><span class="ident" id="4158234">toRemove</span><span class="op" id="4158242">)</span><span class="op" id="4158243">]</span><span class="op" id="4158244">,</span>&nbsp;<span class="ident" id="4158246">good</span><br>
<span class="lineno"></span><span class="op" id="4158251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="4158254">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4158332">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4158407">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="4158444">func</span>&nbsp;<span class="ident" id="4158449">removePaddingSSL30</span><span class="op" id="4158467">(</span><span class="ident" id="4158468">payload</span>&nbsp;<span class="op" id="4158476">[</span><span class="op" id="4158477">]</span><span class="builtintype" id="4158478">byte</span><span class="op" id="4158482">)</span>&nbsp;<span class="op" id="4158484">(</span><span class="op" id="4158485">[</span><span class="op" id="4158486">]</span><span class="builtintype" id="4158487">byte</span><span class="op" id="4158491">,</span>&nbsp;<span class="builtintype" id="4158493">byte</span><span class="op" id="4158497">)</span>&nbsp;<span class="op" id="4158499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4158502">if</span>&nbsp;<span class="builtinfunc" id="4158505">len</span><span class="op" id="4158508">(</span><span class="ident" id="4158509">payload</span><span class="op" id="4158516">)</span>&nbsp;<span class="op" id="4158518">&lt;</span>&nbsp;<span class="num" id="4158520">1</span>&nbsp;<span class="op" id="4158522">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4158526">return</span>&nbsp;<span class="ident" id="4158533">payload</span><span class="op" id="4158540">,</span>&nbsp;<span class="num" id="4158542">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4158545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158549">paddingLen</span>&nbsp;<span class="op" id="4158560">:=</span>&nbsp;<span class="builtintype" id="4158563">int</span><span class="op" id="4158566">(</span><span class="ident" id="4158567">payload</span><span class="op" id="4158574">[</span><span class="builtinfunc" id="4158575">len</span><span class="op" id="4158578">(</span><span class="ident" id="4158579">payload</span><span class="op" id="4158586">)</span><span class="op" id="4158587">-</span><span class="num" id="4158588">1</span><span class="op" id="4158589">]</span><span class="op" id="4158590">)</span>&nbsp;<span class="op" id="4158592">+</span>&nbsp;<span class="num" id="4158594">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4158597">if</span>&nbsp;<span class="ident" id="4158600">paddingLen</span>&nbsp;<span class="op" id="4158611">&gt;</span>&nbsp;<span class="builtinfunc" id="4158613">len</span><span class="op" id="4158616">(</span><span class="ident" id="4158617">payload</span><span class="op" id="4158624">)</span>&nbsp;<span class="op" id="4158626">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4158630">return</span>&nbsp;<span class="ident" id="4158637">payload</span><span class="op" id="4158644">,</span>&nbsp;<span class="num" id="4158646">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4158649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4158653">return</span>&nbsp;<span class="ident" id="4158660">payload</span><span class="op" id="4158667">[</span><span class="op" id="4158668">:</span><span class="builtinfunc" id="4158669">len</span><span class="op" id="4158672">(</span><span class="ident" id="4158673">payload</span><span class="op" id="4158680">)</span><span class="op" id="4158681">-</span><span class="ident" id="4158682">paddingLen</span><span class="op" id="4158692">]</span><span class="op" id="4158693">,</span>&nbsp;<span class="num" id="4158695">255</span><br>
<span class="lineno"></span><span class="op" id="4158699">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="4158702">func</span>&nbsp;<span class="ident" id="4158707">roundUp</span><span class="op" id="4158714">(</span><span class="ident" id="4158715">a</span><span class="op" id="4158716">,</span>&nbsp;<span class="ident" id="4158718">b</span>&nbsp;<span class="builtintype" id="4158720">int</span><span class="op" id="4158723">)</span>&nbsp;<span class="builtintype" id="4158725">int</span>&nbsp;<span class="op" id="4158729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4158732">return</span>&nbsp;<span class="ident" id="4158739">a</span>&nbsp;<span class="op" id="4158741">+</span>&nbsp;<span class="op" id="4158743">(</span><span class="ident" id="4158744">b</span><span class="op" id="4158745">-</span><span class="ident" id="4158746">a</span><span class="op" id="4158747">%</span><span class="ident" id="4158748">b</span><span class="op" id="4158749">)</span><span class="op" id="4158750">%</span><span class="ident" id="4158751">b</span><br>
<span class="lineno"></span><span class="op" id="4158753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="4158756">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="4158830">type</span>&nbsp;<span class="ident" id="4158835">cbcMode</span>&nbsp;<span class="keyword" id="4158843">interface</span>&nbsp;<span class="op" id="4158853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158856">cipher</span><span class="op" id="4158862">.</span><span class="ident" id="4158863">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4158874">SetIV</span><span class="op" id="4158879">(</span><span class="op" id="4158880">[</span><span class="op" id="4158881">]</span><span class="builtintype" id="4158882">byte</span><span class="op" id="4158886">)</span><br>
<span class="lineno"></span><span class="op" id="4158888">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4158891">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4158966">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4159046">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4159116">func</span>&nbsp;<span class="op" id="4159121">(</span><span class="ident" id="4159122">hc</span>&nbsp;<span class="op" id="4159125">*</span><span class="ident" id="4159126">halfConn</span><span class="op" id="4159134">)</span>&nbsp;<span class="ident" id="4159136">decrypt</span><span class="op" id="4159143">(</span><span class="ident" id="4159144">b</span>&nbsp;<span class="op" id="4159146">*</span><span class="ident" id="4159147">block</span><span class="op" id="4159152">)</span>&nbsp;<span class="op" id="4159154">(</span><span class="ident" id="4159155">ok</span>&nbsp;<span class="builtintype" id="4159158">bool</span><span class="op" id="4159162">,</span>&nbsp;<span class="ident" id="4159164">prefixLen</span>&nbsp;<span class="builtintype" id="4159174">int</span><span class="op" id="4159177">,</span>&nbsp;<span class="ident" id="4159179">alertValue</span>&nbsp;<span class="ident" id="4159190">alert</span><span class="op" id="4159195">)</span>&nbsp;<span class="op" id="4159197">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4159200">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159221">payload</span>&nbsp;<span class="op" id="4159229">:=</span>&nbsp;<span class="ident" id="4159232">b</span><span class="op" id="4159233">.</span><span class="ident" id="4159234">data</span><span class="op" id="4159238">[</span><span class="ident" id="4159239">recordHeaderLen</span><span class="op" id="4159254">:</span><span class="op" id="4159255">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159259">macSize</span>&nbsp;<span class="op" id="4159267">:=</span>&nbsp;<span class="num" id="4159270">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159273">if</span>&nbsp;<span class="ident" id="4159276">hc</span><span class="op" id="4159278">.</span><span class="ident" id="4159279">mac</span>&nbsp;<span class="op" id="4159283">!=</span>&nbsp;<span class="ident" id="4159286">nil</span>&nbsp;<span class="op" id="4159290">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159294">macSize</span>&nbsp;<span class="op" id="4159302">=</span>&nbsp;<span class="ident" id="4159304">hc</span><span class="op" id="4159306">.</span><span class="ident" id="4159307">mac</span><span class="op" id="4159310">.</span><span class="ident" id="4159311">Size</span><span class="op" id="4159315">(</span><span class="op" id="4159316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4159319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159323">paddingGood</span>&nbsp;<span class="op" id="4159335">:=</span>&nbsp;<span class="builtintype" id="4159338">byte</span><span class="op" id="4159342">(</span><span class="num" id="4159343">255</span><span class="op" id="4159346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159349">explicitIVLen</span>&nbsp;<span class="op" id="4159363">:=</span>&nbsp;<span class="num" id="4159366">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4159370">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159382">if</span>&nbsp;<span class="ident" id="4159385">hc</span><span class="op" id="4159387">.</span><span class="ident" id="4159388">cipher</span>&nbsp;<span class="op" id="4159395">!=</span>&nbsp;<span class="ident" id="4159398">nil</span>&nbsp;<span class="op" id="4159402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159406">switch</span>&nbsp;<span class="ident" id="4159413">c</span>&nbsp;<span class="op" id="4159415">:=</span>&nbsp;<span class="ident" id="4159418">hc</span><span class="op" id="4159420">.</span><span class="ident" id="4159421">cipher</span><span class="op" id="4159427">.</span><span class="op" id="4159428">(</span><span class="keyword" id="4159429">type</span><span class="op" id="4159433">)</span>&nbsp;<span class="op" id="4159435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159439">case</span>&nbsp;<span class="ident" id="4159444">cipher</span><span class="op" id="4159450">.</span><span class="ident" id="4159451">Stream</span><span class="op" id="4159457">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159462">c</span><span class="op" id="4159463">.</span><span class="ident" id="4159464">XORKeyStream</span><span class="op" id="4159476">(</span><span class="ident" id="4159477">payload</span><span class="op" id="4159484">,</span>&nbsp;<span class="ident" id="4159486">payload</span><span class="op" id="4159493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159497">case</span>&nbsp;<span class="ident" id="4159502">cipher</span><span class="op" id="4159508">.</span><span class="ident" id="4159509">AEAD</span><span class="op" id="4159513">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159518">explicitIVLen</span>&nbsp;<span class="op" id="4159532">=</span>&nbsp;<span class="num" id="4159534">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159539">if</span>&nbsp;<span class="builtinfunc" id="4159542">len</span><span class="op" id="4159545">(</span><span class="ident" id="4159546">payload</span><span class="op" id="4159553">)</span>&nbsp;<span class="op" id="4159555">&lt;</span>&nbsp;<span class="ident" id="4159557">explicitIVLen</span>&nbsp;<span class="op" id="4159571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159577">return</span>&nbsp;<span class="builtintype" id="4159584">false</span><span class="op" id="4159589">,</span>&nbsp;<span class="num" id="4159591">0</span><span class="op" id="4159592">,</span>&nbsp;<span class="ident" id="4159594">alertBadRecordMAC</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4159615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159620">nonce</span>&nbsp;<span class="op" id="4159626">:=</span>&nbsp;<span class="ident" id="4159629">payload</span><span class="op" id="4159636">[</span><span class="op" id="4159637">:</span><span class="num" id="4159638">8</span><span class="op" id="4159639">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159644">payload</span>&nbsp;<span class="op" id="4159652">=</span>&nbsp;<span class="ident" id="4159654">payload</span><span class="op" id="4159661">[</span><span class="num" id="4159662">8</span><span class="op" id="4159663">:</span><span class="op" id="4159664">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159670">var</span>&nbsp;<span class="ident" id="4159674">additionalData</span>&nbsp;<span class="op" id="4159689">[</span><span class="num" id="4159690">13</span><span class="op" id="4159692">]</span><span class="builtintype" id="4159693">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4159701">copy</span><span class="op" id="4159705">(</span><span class="ident" id="4159706">additionalData</span><span class="op" id="4159720">[</span><span class="op" id="4159721">:</span><span class="op" id="4159722">]</span><span class="op" id="4159723">,</span>&nbsp;<span class="ident" id="4159725">hc</span><span class="op" id="4159727">.</span><span class="ident" id="4159728">seq</span><span class="op" id="4159731">[</span><span class="op" id="4159732">:</span><span class="op" id="4159733">]</span><span class="op" id="4159734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4159739">copy</span><span class="op" id="4159743">(</span><span class="ident" id="4159744">additionalData</span><span class="op" id="4159758">[</span><span class="num" id="4159759">8</span><span class="op" id="4159760">:</span><span class="op" id="4159761">]</span><span class="op" id="4159762">,</span>&nbsp;<span class="ident" id="4159764">b</span><span class="op" id="4159765">.</span><span class="ident" id="4159766">data</span><span class="op" id="4159770">[</span><span class="op" id="4159771">:</span><span class="num" id="4159772">3</span><span class="op" id="4159773">]</span><span class="op" id="4159774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159779">n</span>&nbsp;<span class="op" id="4159781">:=</span>&nbsp;<span class="builtinfunc" id="4159784">len</span><span class="op" id="4159787">(</span><span class="ident" id="4159788">payload</span><span class="op" id="4159795">)</span>&nbsp;<span class="op" id="4159797">-</span>&nbsp;<span class="ident" id="4159799">c</span><span class="op" id="4159800">.</span><span class="ident" id="4159801">Overhead</span><span class="op" id="4159809">(</span><span class="op" id="4159810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159815">additionalData</span><span class="op" id="4159829">[</span><span class="num" id="4159830">11</span><span class="op" id="4159832">]</span>&nbsp;<span class="op" id="4159834">=</span>&nbsp;<span class="builtintype" id="4159836">byte</span><span class="op" id="4159840">(</span><span class="ident" id="4159841">n</span>&nbsp;<span class="op" id="4159843">&gt;&gt;</span>&nbsp;<span class="num" id="4159846">8</span><span class="op" id="4159847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159852">additionalData</span><span class="op" id="4159866">[</span><span class="num" id="4159867">12</span><span class="op" id="4159869">]</span>&nbsp;<span class="op" id="4159871">=</span>&nbsp;<span class="builtintype" id="4159873">byte</span><span class="op" id="4159877">(</span><span class="ident" id="4159878">n</span><span class="op" id="4159879">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159884">var</span>&nbsp;<span class="ident" id="4159888">err</span>&nbsp;<span class="builtintype" id="4159892">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4159901">payload</span><span class="op" id="4159908">,</span>&nbsp;<span class="ident" id="4159910">err</span>&nbsp;<span class="op" id="4159914">=</span>&nbsp;<span class="ident" id="4159916">c</span><span class="op" id="4159917">.</span><span class="ident" id="4159918">Open</span><span class="op" id="4159922">(</span><span class="ident" id="4159923">payload</span><span class="op" id="4159930">[</span><span class="op" id="4159931">:</span><span class="num" id="4159932">0</span><span class="op" id="4159933">]</span><span class="op" id="4159934">,</span>&nbsp;<span class="ident" id="4159936">nonce</span><span class="op" id="4159941">,</span>&nbsp;<span class="ident" id="4159943">payload</span><span class="op" id="4159950">,</span>&nbsp;<span class="ident" id="4159952">additionalData</span><span class="op" id="4159966">[</span><span class="op" id="4159967">:</span><span class="op" id="4159968">]</span><span class="op" id="4159969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159974">if</span>&nbsp;<span class="ident" id="4159977">err</span>&nbsp;<span class="op" id="4159981">!=</span>&nbsp;<span class="ident" id="4159984">nil</span>&nbsp;<span class="op" id="4159988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4159994">return</span>&nbsp;<span class="builtintype" id="4160001">false</span><span class="op" id="4160006">,</span>&nbsp;<span class="num" id="4160008">0</span><span class="op" id="4160009">,</span>&nbsp;<span class="ident" id="4160011">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4160032">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160037">b</span><span class="op" id="4160038">.</span><span class="ident" id="4160039">resize</span><span class="op" id="4160045">(</span><span class="ident" id="4160046">recordHeaderLen</span>&nbsp;<span class="op" id="4160062">+</span>&nbsp;<span class="ident" id="4160064">explicitIVLen</span>&nbsp;<span class="op" id="4160078">+</span>&nbsp;<span class="builtinfunc" id="4160080">len</span><span class="op" id="4160083">(</span><span class="ident" id="4160084">payload</span><span class="op" id="4160091">)</span><span class="op" id="4160092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4160096">case</span>&nbsp;<span class="ident" id="4160101">cbcMode</span><span class="op" id="4160108">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160113">blockSize</span>&nbsp;<span class="op" id="4160123">:=</span>&nbsp;<span class="ident" id="4160126">c</span><span class="op" id="4160127">.</span><span class="ident" id="4160128">BlockSize</span><span class="op" id="4160137">(</span><span class="op" id="4160138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4160143">if</span>&nbsp;<span class="ident" id="4160146">hc</span><span class="op" id="4160148">.</span><span class="ident" id="4160149">version</span>&nbsp;<span class="op" id="4160157">&gt;=</span>&nbsp;<span class="ident" id="4160160">VersionTLS11</span>&nbsp;<span class="op" id="4160173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160179">explicitIVLen</span>&nbsp;<span class="op" id="4160193">=</span>&nbsp;<span class="ident" id="4160195">blockSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4160208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4160214">if</span>&nbsp;<span class="builtinfunc" id="4160217">len</span><span class="op" id="4160220">(</span><span class="ident" id="4160221">payload</span><span class="op" id="4160228">)</span><span class="op" id="4160229">%</span><span class="ident" id="4160230">blockSize</span>&nbsp;<span class="op" id="4160240">!=</span>&nbsp;<span class="num" id="4160243">0</span>&nbsp;<span class="op" id="4160245">||</span>&nbsp;<span class="builtinfunc" id="4160248">len</span><span class="op" id="4160251">(</span><span class="ident" id="4160252">payload</span><span class="op" id="4160259">)</span>&nbsp;<span class="op" id="4160261">&lt;</span>&nbsp;<span class="ident" id="4160263">roundUp</span><span class="op" id="4160270">(</span><span class="ident" id="4160271">explicitIVLen</span><span class="op" id="4160284">+</span><span class="ident" id="4160285">macSize</span><span class="op" id="4160292">+</span><span class="num" id="4160293">1</span><span class="op" id="4160294">,</span>&nbsp;<span class="ident" id="4160296">blockSize</span><span class="op" id="4160305">)</span>&nbsp;<span class="op" id="4160307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4160313">return</span>&nbsp;<span class="builtintype" id="4160320">false</span><span class="op" id="4160325">,</span>&nbsp;<span class="num" id="4160327">0</span><span class="op" id="4160328">,</span>&nbsp;<span class="ident" id="4160330">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4160351">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4160357">if</span>&nbsp;<span class="ident" id="4160360">explicitIVLen</span>&nbsp;<span class="op" id="4160374">&gt;</span>&nbsp;<span class="num" id="4160376">0</span>&nbsp;<span class="op" id="4160378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160384">c</span><span class="op" id="4160385">.</span><span class="ident" id="4160386">SetIV</span><span class="op" id="4160391">(</span><span class="ident" id="4160392">payload</span><span class="op" id="4160399">[</span><span class="op" id="4160400">:</span><span class="ident" id="4160401">explicitIVLen</span><span class="op" id="4160414">]</span><span class="op" id="4160415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160421">payload</span>&nbsp;<span class="op" id="4160429">=</span>&nbsp;<span class="ident" id="4160431">payload</span><span class="op" id="4160438">[</span><span class="ident" id="4160439">explicitIVLen</span><span class="op" id="4160452">:</span><span class="op" id="4160453">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4160458">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160463">c</span><span class="op" id="4160464">.</span><span class="ident" id="4160465">CryptBlocks</span><span class="op" id="4160476">(</span><span class="ident" id="4160477">payload</span><span class="op" id="4160484">,</span>&nbsp;<span class="ident" id="4160486">payload</span><span class="op" id="4160493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4160498">if</span>&nbsp;<span class="ident" id="4160501">hc</span><span class="op" id="4160503">.</span><span class="ident" id="4160504">version</span>&nbsp;<span class="op" id="4160512">==</span>&nbsp;<span class="ident" id="4160515">VersionSSL30</span>&nbsp;<span class="op" id="4160528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160534">payload</span><span class="op" id="4160541">,</span>&nbsp;<span class="ident" id="4160543">paddingGood</span>&nbsp;<span class="op" id="4160555">=</span>&nbsp;<span class="ident" id="4160557">removePaddingSSL30</span><span class="op" id="4160575">(</span><span class="ident" id="4160576">payload</span><span class="op" id="4160583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4160588">}</span>&nbsp;<span class="keyword" id="4160590">else</span>&nbsp;<span class="op" id="4160595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160601">payload</span><span class="op" id="4160608">,</span>&nbsp;<span class="ident" id="4160610">paddingGood</span>&nbsp;<span class="op" id="4160622">=</span>&nbsp;<span class="ident" id="4160624">removePadding</span><span class="op" id="4160637">(</span><span class="ident" id="4160638">payload</span><span class="op" id="4160645">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4160650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4160655">b</span><span class="op" id="4160656">.</span><span class="ident" id="4160657">resize</span><span class="op" id="4160663">(</span><span class="ident" id="4160664">recordHeaderLen</span>&nbsp;<span class="op" id="4160680">+</span>&nbsp;<span class="ident" id="4160682">explicitIVLen</span>&nbsp;<span class="op" id="4160696">+</span>&nbsp;<span class="builtinfunc" id="4160698">len</span><span class="op" id="4160701">(</span><span class="ident" id="4160702">payload</span><span class="op" id="4160709">)</span><span class="op" id="4160710">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4160716">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4160775">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4160832">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4160889">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4160945">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4160995">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4161053">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4161073">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4161079">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4161135">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4161165">default</span><span class="op" id="4161172">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4161177">panic</span><span class="op" id="4161182">(</span><span class="string" id="4161183">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4161204">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4161208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4161211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4161215">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4161236">if</span>&nbsp;<span class="ident" id="4161239">hc</span><span class="op" id="4161241">.</span><span class="ident" id="4161242">mac</span>&nbsp;<span class="op" id="4161246">!=</span>&nbsp;<span class="ident" id="4161249">nil</span>&nbsp;<span class="op" id="4161253">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4161257">if</span>&nbsp;<span class="builtinfunc" id="4161260">len</span><span class="op" id="4161263">(</span><span class="ident" id="4161264">payload</span><span class="op" id="4161271">)</span>&nbsp;<span class="op" id="4161273">&lt;</span>&nbsp;<span class="ident" id="4161275">macSize</span>&nbsp;<span class="op" id="4161283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4161288">return</span>&nbsp;<span class="builtintype" id="4161295">false</span><span class="op" id="4161300">,</span>&nbsp;<span class="num" id="4161302">0</span><span class="op" id="4161303">,</span>&nbsp;<span class="ident" id="4161305">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4161325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4161330">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4161365">n</span>&nbsp;<span class="op" id="4161367">:=</span>&nbsp;<span class="builtinfunc" id="4161370">len</span><span class="op" id="4161373">(</span><span class="ident" id="4161374">payload</span><span class="op" id="4161381">)</span>&nbsp;<span class="op" id="4161383">-</span>&nbsp;<span class="ident" id="4161385">macSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4161395">b</span><span class="op" id="4161396">.</span><span class="ident" id="4161397">data</span><span class="op" id="4161401">[</span><span class="num" id="4161402">3</span><span class="op" id="4161403">]</span>&nbsp;<span class="op" id="4161405">=</span>&nbsp;<span class="builtintype" id="4161407">byte</span><span class="op" id="4161411">(</span><span class="ident" id="4161412">n</span>&nbsp;<span class="op" id="4161414">&gt;&gt;</span>&nbsp;<span class="num" id="4161417">8</span><span class="op" id="4161418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4161422">b</span><span class="op" id="4161423">.</span><span class="ident" id="4161424">data</span><span class="op" id="4161428">[</span><span class="num" id="4161429">4</span><span class="op" id="4161430">]</span>&nbsp;<span class="op" id="4161432">=</span>&nbsp;<span class="builtintype" id="4161434">byte</span><span class="op" id="4161438">(</span><span class="ident" id="4161439">n</span><span class="op" id="4161440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4161444">b</span><span class="op" id="4161445">.</span><span class="ident" id="4161446">resize</span><span class="op" id="4161452">(</span><span class="ident" id="4161453">recordHeaderLen</span>&nbsp;<span class="op" id="4161469">+</span>&nbsp;<span class="ident" id="4161471">explicitIVLen</span>&nbsp;<span class="op" id="4161485">+</span>&nbsp;<span class="ident" id="4161487">n</span><span class="op" id="4161488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4161492">remoteMAC</span>&nbsp;<span class="op" id="4161502">:=</span>&nbsp;<span class="ident" id="4161505">payload</span><span class="op" id="4161512">[</span><span class="ident" id="4161513">n</span><span class="op" id="4161514">:</span><span class="op" id="4161515">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4161519">localMAC</span>&nbsp;<span class="op" id="4161528">:=</span>&nbsp;<span class="ident" id="4161531">hc</span><span class="op" id="4161533">.</span><span class="ident" id="4161534">mac</span><span class="op" id="4161537">.</span><span class="ident" id="4161538">MAC</span><span class="op" id="4161541">(</span><span class="ident" id="4161542">hc</span><span class="op" id="4161544">.</span><span class="ident" id="4161545">inDigestBuf</span><span class="op" id="4161556">,</span>&nbsp;<span class="ident" id="4161558">hc</span><span class="op" id="4161560">.</span><span class="ident" id="4161561">seq</span><span class="op" id="4161564">[</span><span class="num" id="4161565">0</span><span class="op" id="4161566">:</span><span class="op" id="4161567">]</span><span class="op" id="4161568">,</span>&nbsp;<span class="ident" id="4161570">b</span><span class="op" id="4161571">.</span><span class="ident" id="4161572">data</span><span class="op" id="4161576">[</span><span class="op" id="4161577">:</span><span class="ident" id="4161578">recordHeaderLen</span><span class="op" id="4161593">]</span><span class="op" id="4161594">,</span>&nbsp;<span class="ident" id="4161596">payload</span><span class="op" id="4161603">[</span><span class="op" id="4161604">:</span><span class="ident" id="4161605">n</span><span class="op" id="4161606">]</span><span class="op" id="4161607">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4161612">if</span>&nbsp;<span class="ident" id="4161615">subtle</span><span class="op" id="4161621">.</span><span class="ident" id="4161622">ConstantTimeCompare</span><span class="op" id="4161641">(</span><span class="ident" id="4161642">localMAC</span><span class="op" id="4161650">,</span>&nbsp;<span class="ident" id="4161652">remoteMAC</span><span class="op" id="4161661">)</span>&nbsp;<span class="op" id="4161663">!=</span>&nbsp;<span class="num" id="4161666">1</span>&nbsp;<span class="op" id="4161668">||</span>&nbsp;<span class="ident" id="4161671">paddingGood</span>&nbsp;<span class="op" id="4161683">!=</span>&nbsp;<span class="num" id="4161686">255</span>&nbsp;<span class="op" id="4161690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4161695">return</span>&nbsp;<span class="builtintype" id="4161702">false</span><span class="op" id="4161707">,</span>&nbsp;<span class="num" id="4161709">0</span><span class="op" id="4161710">,</span>&nbsp;<span class="ident" id="4161712">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4161732">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4161736">hc</span><span class="op" id="4161738">.</span><span class="ident" id="4161739">inDigestBuf</span>&nbsp;<span class="op" id="4161751">=</span>&nbsp;<span class="ident" id="4161753">localMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4161763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4161766">hc</span><span class="op" id="4161768">.</span><span class="ident" id="4161769">incSeq</span><span class="op" id="4161775">(</span><span class="op" id="4161776">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4161780">return</span>&nbsp;<span class="builtintype" id="4161787">true</span><span class="op" id="4161791">,</span>&nbsp;<span class="ident" id="4161793">recordHeaderLen</span>&nbsp;<span class="op" id="4161809">+</span>&nbsp;<span class="ident" id="4161811">explicitIVLen</span><span class="op" id="4161824">,</span>&nbsp;<span class="num" id="4161826">0</span><br>
<span class="lineno">335</span><span class="op" id="4161828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4161831">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="4161909">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="4161984">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="4162064">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4162140">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="4162155">func</span>&nbsp;<span class="ident" id="4162160">padToBlockSize</span><span class="op" id="4162174">(</span><span class="ident" id="4162175">payload</span>&nbsp;<span class="op" id="4162183">[</span><span class="op" id="4162184">]</span><span class="builtintype" id="4162185">byte</span><span class="op" id="4162189">,</span>&nbsp;<span class="ident" id="4162191">blockSize</span>&nbsp;<span class="builtintype" id="4162201">int</span><span class="op" id="4162204">)</span>&nbsp;<span class="op" id="4162206">(</span><span class="ident" id="4162207">prefix</span><span class="op" id="4162213">,</span>&nbsp;<span class="ident" id="4162215">finalBlock</span>&nbsp;<span class="op" id="4162226">[</span><span class="op" id="4162227">]</span><span class="builtintype" id="4162228">byte</span><span class="op" id="4162232">)</span>&nbsp;<span class="op" id="4162234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4162237">overrun</span>&nbsp;<span class="op" id="4162245">:=</span>&nbsp;<span class="builtinfunc" id="4162248">len</span><span class="op" id="4162251">(</span><span class="ident" id="4162252">payload</span><span class="op" id="4162259">)</span>&nbsp;<span class="op" id="4162261">%</span>&nbsp;<span class="ident" id="4162263">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4162274">paddingLen</span>&nbsp;<span class="op" id="4162285">:=</span>&nbsp;<span class="ident" id="4162288">blockSize</span>&nbsp;<span class="op" id="4162298">-</span>&nbsp;<span class="ident" id="4162300">overrun</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4162309">prefix</span>&nbsp;<span class="op" id="4162316">=</span>&nbsp;<span class="ident" id="4162318">payload</span><span class="op" id="4162325">[</span><span class="op" id="4162326">:</span><span class="builtinfunc" id="4162327">len</span><span class="op" id="4162330">(</span><span class="ident" id="4162331">payload</span><span class="op" id="4162338">)</span><span class="op" id="4162339">-</span><span class="ident" id="4162340">overrun</span><span class="op" id="4162347">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4162350">finalBlock</span>&nbsp;<span class="op" id="4162361">=</span>&nbsp;<span class="builtinfunc" id="4162363">make</span><span class="op" id="4162367">(</span><span class="op" id="4162368">[</span><span class="op" id="4162369">]</span><span class="builtintype" id="4162370">byte</span><span class="op" id="4162374">,</span>&nbsp;<span class="ident" id="4162376">blockSize</span><span class="op" id="4162385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4162388">copy</span><span class="op" id="4162392">(</span><span class="ident" id="4162393">finalBlock</span><span class="op" id="4162403">,</span>&nbsp;<span class="ident" id="4162405">payload</span><span class="op" id="4162412">[</span><span class="builtinfunc" id="4162413">len</span><span class="op" id="4162416">(</span><span class="ident" id="4162417">payload</span><span class="op" id="4162424">)</span><span class="op" id="4162425">-</span><span class="ident" id="4162426">overrun</span><span class="op" id="4162433">:</span><span class="op" id="4162434">]</span><span class="op" id="4162435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4162438">for</span>&nbsp;<span class="ident" id="4162442">i</span>&nbsp;<span class="op" id="4162444">:=</span>&nbsp;<span class="ident" id="4162447">overrun</span><span class="op" id="4162454">;</span>&nbsp;<span class="ident" id="4162456">i</span>&nbsp;<span class="op" id="4162458">&lt;</span>&nbsp;<span class="ident" id="4162460">blockSize</span><span class="op" id="4162469">;</span>&nbsp;<span class="ident" id="4162471">i</span><span class="op" id="4162472">++</span>&nbsp;<span class="op" id="4162475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4162479">finalBlock</span><span class="op" id="4162489">[</span><span class="ident" id="4162490">i</span><span class="op" id="4162491">]</span>&nbsp;<span class="op" id="4162493">=</span>&nbsp;<span class="builtintype" id="4162495">byte</span><span class="op" id="4162499">(</span><span class="ident" id="4162500">paddingLen</span>&nbsp;<span class="op" id="4162511">-</span>&nbsp;<span class="num" id="4162513">1</span><span class="op" id="4162514">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4162517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4162520">return</span><br>
<span class="lineno"></span><span class="op" id="4162527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4162530">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="4162574">func</span>&nbsp;<span class="op" id="4162579">(</span><span class="ident" id="4162580">hc</span>&nbsp;<span class="op" id="4162583">*</span><span class="ident" id="4162584">halfConn</span><span class="op" id="4162592">)</span>&nbsp;<span class="ident" id="4162594">encrypt</span><span class="op" id="4162601">(</span><span class="ident" id="4162602">b</span>&nbsp;<span class="op" id="4162604">*</span><span class="ident" id="4162605">block</span><span class="op" id="4162610">,</span>&nbsp;<span class="ident" id="4162612">explicitIVLen</span>&nbsp;<span class="builtintype" id="4162626">int</span><span class="op" id="4162629">)</span>&nbsp;<span class="op" id="4162631">(</span><span class="builtintype" id="4162632">bool</span><span class="op" id="4162636">,</span>&nbsp;<span class="ident" id="4162638">alert</span><span class="op" id="4162643">)</span>&nbsp;<span class="op" id="4162645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4162648">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4162656">if</span>&nbsp;<span class="ident" id="4162659">hc</span><span class="op" id="4162661">.</span><span class="ident" id="4162662">mac</span>&nbsp;<span class="op" id="4162666">!=</span>&nbsp;<span class="ident" id="4162669">nil</span>&nbsp;<span class="op" id="4162673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4162677">mac</span>&nbsp;<span class="op" id="4162681">:=</span>&nbsp;<span class="ident" id="4162684">hc</span><span class="op" id="4162686">.</span><span class="ident" id="4162687">mac</span><span class="op" id="4162690">.</span><span class="ident" id="4162691">MAC</span><span class="op" id="4162694">(</span><span class="ident" id="4162695">hc</span><span class="op" id="4162697">.</span><span class="ident" id="4162698">outDigestBuf</span><span class="op" id="4162710">,</span>&nbsp;<span class="ident" id="4162712">hc</span><span class="op" id="4162714">.</span><span class="ident" id="4162715">seq</span><span class="op" id="4162718">[</span><span class="num" id="4162719">0</span><span class="op" id="4162720">:</span><span class="op" id="4162721">]</span><span class="op" id="4162722">,</span>&nbsp;<span class="ident" id="4162724">b</span><span class="op" id="4162725">.</span><span class="ident" id="4162726">data</span><span class="op" id="4162730">[</span><span class="op" id="4162731">:</span><span class="ident" id="4162732">recordHeaderLen</span><span class="op" id="4162747">]</span><span class="op" id="4162748">,</span>&nbsp;<span class="ident" id="4162750">b</span><span class="op" id="4162751">.</span><span class="ident" id="4162752">data</span><span class="op" id="4162756">[</span><span class="ident" id="4162757">recordHeaderLen</span><span class="op" id="4162772">+</span><span class="ident" id="4162773">explicitIVLen</span><span class="op" id="4162786">:</span><span class="op" id="4162787">]</span><span class="op" id="4162788">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4162793">n</span>&nbsp;<span class="op" id="4162795">:=</span>&nbsp;<span class="builtinfunc" id="4162798">len</span><span class="op" id="4162801">(</span><span class="ident" id="4162802">b</span><span class="op" id="4162803">.</span><span class="ident" id="4162804">data</span><span class="op" id="4162808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4162812">b</span><span class="op" id="4162813">.</span><span class="ident" id="4162814">resize</span><span class="op" id="4162820">(</span><span class="ident" id="4162821">n</span>&nbsp;<span class="op" id="4162823">+</span>&nbsp;<span class="builtinfunc" id="4162825">len</span><span class="op" id="4162828">(</span><span class="ident" id="4162829">mac</span><span class="op" id="4162832">)</span><span class="op" id="4162833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4162837">copy</span><span class="op" id="4162841">(</span><span class="ident" id="4162842">b</span><span class="op" id="4162843">.</span><span class="ident" id="4162844">data</span><span class="op" id="4162848">[</span><span class="ident" id="4162849">n</span><span class="op" id="4162850">:</span><span class="op" id="4162851">]</span><span class="op" id="4162852">,</span>&nbsp;<span class="ident" id="4162854">mac</span><span class="op" id="4162857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4162861">hc</span><span class="op" id="4162863">.</span><span class="ident" id="4162864">outDigestBuf</span>&nbsp;<span class="op" id="4162877">=</span>&nbsp;<span class="ident" id="4162879">mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4162884">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4162888">payload</span>&nbsp;<span class="op" id="4162896">:=</span>&nbsp;<span class="ident" id="4162899">b</span><span class="op" id="4162900">.</span><span class="ident" id="4162901">data</span><span class="op" id="4162905">[</span><span class="ident" id="4162906">recordHeaderLen</span><span class="op" id="4162921">:</span><span class="op" id="4162922">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4162926">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4162938">if</span>&nbsp;<span class="ident" id="4162941">hc</span><span class="op" id="4162943">.</span><span class="ident" id="4162944">cipher</span>&nbsp;<span class="op" id="4162951">!=</span>&nbsp;<span class="ident" id="4162954">nil</span>&nbsp;<span class="op" id="4162958">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4162962">switch</span>&nbsp;<span class="ident" id="4162969">c</span>&nbsp;<span class="op" id="4162971">:=</span>&nbsp;<span class="ident" id="4162974">hc</span><span class="op" id="4162976">.</span><span class="ident" id="4162977">cipher</span><span class="op" id="4162983">.</span><span class="op" id="4162984">(</span><span class="keyword" id="4162985">type</span><span class="op" id="4162989">)</span>&nbsp;<span class="op" id="4162991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4162995">case</span>&nbsp;<span class="ident" id="4163000">cipher</span><span class="op" id="4163006">.</span><span class="ident" id="4163007">Stream</span><span class="op" id="4163013">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163018">c</span><span class="op" id="4163019">.</span><span class="ident" id="4163020">XORKeyStream</span><span class="op" id="4163032">(</span><span class="ident" id="4163033">payload</span><span class="op" id="4163040">,</span>&nbsp;<span class="ident" id="4163042">payload</span><span class="op" id="4163049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4163053">case</span>&nbsp;<span class="ident" id="4163058">cipher</span><span class="op" id="4163064">.</span><span class="ident" id="4163065">AEAD</span><span class="op" id="4163069">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163074">payloadLen</span>&nbsp;<span class="op" id="4163085">:=</span>&nbsp;<span class="builtinfunc" id="4163088">len</span><span class="op" id="4163091">(</span><span class="ident" id="4163092">b</span><span class="op" id="4163093">.</span><span class="ident" id="4163094">data</span><span class="op" id="4163098">)</span>&nbsp;<span class="op" id="4163100">-</span>&nbsp;<span class="ident" id="4163102">recordHeaderLen</span>&nbsp;<span class="op" id="4163118">-</span>&nbsp;<span class="ident" id="4163120">explicitIVLen</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163137">b</span><span class="op" id="4163138">.</span><span class="ident" id="4163139">resize</span><span class="op" id="4163145">(</span><span class="builtinfunc" id="4163146">len</span><span class="op" id="4163149">(</span><span class="ident" id="4163150">b</span><span class="op" id="4163151">.</span><span class="ident" id="4163152">data</span><span class="op" id="4163156">)</span>&nbsp;<span class="op" id="4163158">+</span>&nbsp;<span class="ident" id="4163160">c</span><span class="op" id="4163161">.</span><span class="ident" id="4163162">Overhead</span><span class="op" id="4163170">(</span><span class="op" id="4163171">)</span><span class="op" id="4163172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163177">nonce</span>&nbsp;<span class="op" id="4163183">:=</span>&nbsp;<span class="ident" id="4163186">b</span><span class="op" id="4163187">.</span><span class="ident" id="4163188">data</span><span class="op" id="4163192">[</span><span class="ident" id="4163193">recordHeaderLen</span>&nbsp;<span class="op" id="4163209">:</span>&nbsp;<span class="ident" id="4163211">recordHeaderLen</span><span class="op" id="4163226">+</span><span class="ident" id="4163227">explicitIVLen</span><span class="op" id="4163240">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163245">payload</span>&nbsp;<span class="op" id="4163253">:=</span>&nbsp;<span class="ident" id="4163256">b</span><span class="op" id="4163257">.</span><span class="ident" id="4163258">data</span><span class="op" id="4163262">[</span><span class="ident" id="4163263">recordHeaderLen</span><span class="op" id="4163278">+</span><span class="ident" id="4163279">explicitIVLen</span><span class="op" id="4163292">:</span><span class="op" id="4163293">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163298">payload</span>&nbsp;<span class="op" id="4163306">=</span>&nbsp;<span class="ident" id="4163308">payload</span><span class="op" id="4163315">[</span><span class="op" id="4163316">:</span><span class="ident" id="4163317">payloadLen</span><span class="op" id="4163327">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4163333">var</span>&nbsp;<span class="ident" id="4163337">additionalData</span>&nbsp;<span class="op" id="4163352">[</span><span class="num" id="4163353">13</span><span class="op" id="4163355">]</span><span class="builtintype" id="4163356">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4163364">copy</span><span class="op" id="4163368">(</span><span class="ident" id="4163369">additionalData</span><span class="op" id="4163383">[</span><span class="op" id="4163384">:</span><span class="op" id="4163385">]</span><span class="op" id="4163386">,</span>&nbsp;<span class="ident" id="4163388">hc</span><span class="op" id="4163390">.</span><span class="ident" id="4163391">seq</span><span class="op" id="4163394">[</span><span class="op" id="4163395">:</span><span class="op" id="4163396">]</span><span class="op" id="4163397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4163402">copy</span><span class="op" id="4163406">(</span><span class="ident" id="4163407">additionalData</span><span class="op" id="4163421">[</span><span class="num" id="4163422">8</span><span class="op" id="4163423">:</span><span class="op" id="4163424">]</span><span class="op" id="4163425">,</span>&nbsp;<span class="ident" id="4163427">b</span><span class="op" id="4163428">.</span><span class="ident" id="4163429">data</span><span class="op" id="4163433">[</span><span class="op" id="4163434">:</span><span class="num" id="4163435">3</span><span class="op" id="4163436">]</span><span class="op" id="4163437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163442">additionalData</span><span class="op" id="4163456">[</span><span class="num" id="4163457">11</span><span class="op" id="4163459">]</span>&nbsp;<span class="op" id="4163461">=</span>&nbsp;<span class="builtintype" id="4163463">byte</span><span class="op" id="4163467">(</span><span class="ident" id="4163468">payloadLen</span>&nbsp;<span class="op" id="4163479">&gt;&gt;</span>&nbsp;<span class="num" id="4163482">8</span><span class="op" id="4163483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163488">additionalData</span><span class="op" id="4163502">[</span><span class="num" id="4163503">12</span><span class="op" id="4163505">]</span>&nbsp;<span class="op" id="4163507">=</span>&nbsp;<span class="builtintype" id="4163509">byte</span><span class="op" id="4163513">(</span><span class="ident" id="4163514">payloadLen</span><span class="op" id="4163524">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163530">c</span><span class="op" id="4163531">.</span><span class="ident" id="4163532">Seal</span><span class="op" id="4163536">(</span><span class="ident" id="4163537">payload</span><span class="op" id="4163544">[</span><span class="op" id="4163545">:</span><span class="num" id="4163546">0</span><span class="op" id="4163547">]</span><span class="op" id="4163548">,</span>&nbsp;<span class="ident" id="4163550">nonce</span><span class="op" id="4163555">,</span>&nbsp;<span class="ident" id="4163557">payload</span><span class="op" id="4163564">,</span>&nbsp;<span class="ident" id="4163566">additionalData</span><span class="op" id="4163580">[</span><span class="op" id="4163581">:</span><span class="op" id="4163582">]</span><span class="op" id="4163583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4163587">case</span>&nbsp;<span class="ident" id="4163592">cbcMode</span><span class="op" id="4163599">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163604">blockSize</span>&nbsp;<span class="op" id="4163614">:=</span>&nbsp;<span class="ident" id="4163617">c</span><span class="op" id="4163618">.</span><span class="ident" id="4163619">BlockSize</span><span class="op" id="4163628">(</span><span class="op" id="4163629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4163634">if</span>&nbsp;<span class="ident" id="4163637">explicitIVLen</span>&nbsp;<span class="op" id="4163651">&gt;</span>&nbsp;<span class="num" id="4163653">0</span>&nbsp;<span class="op" id="4163655">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163661">c</span><span class="op" id="4163662">.</span><span class="ident" id="4163663">SetIV</span><span class="op" id="4163668">(</span><span class="ident" id="4163669">payload</span><span class="op" id="4163676">[</span><span class="op" id="4163677">:</span><span class="ident" id="4163678">explicitIVLen</span><span class="op" id="4163691">]</span><span class="op" id="4163692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163698">payload</span>&nbsp;<span class="op" id="4163706">=</span>&nbsp;<span class="ident" id="4163708">payload</span><span class="op" id="4163715">[</span><span class="ident" id="4163716">explicitIVLen</span><span class="op" id="4163729">:</span><span class="op" id="4163730">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4163735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163740">prefix</span><span class="op" id="4163746">,</span>&nbsp;<span class="ident" id="4163748">finalBlock</span>&nbsp;<span class="op" id="4163759">:=</span>&nbsp;<span class="ident" id="4163762">padToBlockSize</span><span class="op" id="4163776">(</span><span class="ident" id="4163777">payload</span><span class="op" id="4163784">,</span>&nbsp;<span class="ident" id="4163786">blockSize</span><span class="op" id="4163795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163800">b</span><span class="op" id="4163801">.</span><span class="ident" id="4163802">resize</span><span class="op" id="4163808">(</span><span class="ident" id="4163809">recordHeaderLen</span>&nbsp;<span class="op" id="4163825">+</span>&nbsp;<span class="ident" id="4163827">explicitIVLen</span>&nbsp;<span class="op" id="4163841">+</span>&nbsp;<span class="builtinfunc" id="4163843">len</span><span class="op" id="4163846">(</span><span class="ident" id="4163847">prefix</span><span class="op" id="4163853">)</span>&nbsp;<span class="op" id="4163855">+</span>&nbsp;<span class="builtinfunc" id="4163857">len</span><span class="op" id="4163860">(</span><span class="ident" id="4163861">finalBlock</span><span class="op" id="4163871">)</span><span class="op" id="4163872">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163877">c</span><span class="op" id="4163878">.</span><span class="ident" id="4163879">CryptBlocks</span><span class="op" id="4163890">(</span><span class="ident" id="4163891">b</span><span class="op" id="4163892">.</span><span class="ident" id="4163893">data</span><span class="op" id="4163897">[</span><span class="ident" id="4163898">recordHeaderLen</span><span class="op" id="4163913">+</span><span class="ident" id="4163914">explicitIVLen</span><span class="op" id="4163927">:</span><span class="op" id="4163928">]</span><span class="op" id="4163929">,</span>&nbsp;<span class="ident" id="4163931">prefix</span><span class="op" id="4163937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4163942">c</span><span class="op" id="4163943">.</span><span class="ident" id="4163944">CryptBlocks</span><span class="op" id="4163955">(</span><span class="ident" id="4163956">b</span><span class="op" id="4163957">.</span><span class="ident" id="4163958">data</span><span class="op" id="4163962">[</span><span class="ident" id="4163963">recordHeaderLen</span><span class="op" id="4163978">+</span><span class="ident" id="4163979">explicitIVLen</span><span class="op" id="4163992">+</span><span class="builtinfunc" id="4163993">len</span><span class="op" id="4163996">(</span><span class="ident" id="4163997">prefix</span><span class="op" id="4164003">)</span><span class="op" id="4164004">:</span><span class="op" id="4164005">]</span><span class="op" id="4164006">,</span>&nbsp;<span class="ident" id="4164008">finalBlock</span><span class="op" id="4164018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4164022">default</span><span class="op" id="4164029">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4164034">panic</span><span class="op" id="4164039">(</span><span class="string" id="4164040">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4164061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4164065">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4164068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4164072">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164135">n</span>&nbsp;<span class="op" id="4164137">:=</span>&nbsp;<span class="builtinfunc" id="4164140">len</span><span class="op" id="4164143">(</span><span class="ident" id="4164144">b</span><span class="op" id="4164145">.</span><span class="ident" id="4164146">data</span><span class="op" id="4164150">)</span>&nbsp;<span class="op" id="4164152">-</span>&nbsp;<span class="ident" id="4164154">recordHeaderLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164171">b</span><span class="op" id="4164172">.</span><span class="ident" id="4164173">data</span><span class="op" id="4164177">[</span><span class="num" id="4164178">3</span><span class="op" id="4164179">]</span>&nbsp;<span class="op" id="4164181">=</span>&nbsp;<span class="builtintype" id="4164183">byte</span><span class="op" id="4164187">(</span><span class="ident" id="4164188">n</span>&nbsp;<span class="op" id="4164190">&gt;&gt;</span>&nbsp;<span class="num" id="4164193">8</span><span class="op" id="4164194">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164197">b</span><span class="op" id="4164198">.</span><span class="ident" id="4164199">data</span><span class="op" id="4164203">[</span><span class="num" id="4164204">4</span><span class="op" id="4164205">]</span>&nbsp;<span class="op" id="4164207">=</span>&nbsp;<span class="builtintype" id="4164209">byte</span><span class="op" id="4164213">(</span><span class="ident" id="4164214">n</span><span class="op" id="4164215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164218">hc</span><span class="op" id="4164220">.</span><span class="ident" id="4164221">incSeq</span><span class="op" id="4164227">(</span><span class="op" id="4164228">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4164232">return</span>&nbsp;<span class="builtintype" id="4164239">true</span><span class="op" id="4164243">,</span>&nbsp;<span class="num" id="4164245">0</span><br>
<span class="lineno"></span><span class="op" id="4164247">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="4164250">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4164286">type</span>&nbsp;<span class="ident" id="4164291">block</span>&nbsp;<span class="keyword" id="4164297">struct</span>&nbsp;<span class="op" id="4164304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164307">data</span>&nbsp;<span class="op" id="4164312">[</span><span class="op" id="4164313">]</span><span class="builtintype" id="4164314">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164320">off</span>&nbsp;&nbsp;<span class="builtintype" id="4164325">int</span>&nbsp;<span class="comment" id="4164329">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164348">link</span>&nbsp;<span class="op" id="4164353">*</span><span class="ident" id="4164354">block</span><br>
<span class="lineno"></span><span class="op" id="4164360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4164363">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4164424">func</span>&nbsp;<span class="op" id="4164429">(</span><span class="ident" id="4164430">b</span>&nbsp;<span class="op" id="4164432">*</span><span class="ident" id="4164433">block</span><span class="op" id="4164438">)</span>&nbsp;<span class="ident" id="4164440">resize</span><span class="op" id="4164446">(</span><span class="ident" id="4164447">n</span>&nbsp;<span class="builtintype" id="4164449">int</span><span class="op" id="4164452">)</span>&nbsp;<span class="op" id="4164454">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4164457">if</span>&nbsp;<span class="ident" id="4164460">n</span>&nbsp;<span class="op" id="4164462">&gt;</span>&nbsp;<span class="builtinfunc" id="4164464">cap</span><span class="op" id="4164467">(</span><span class="ident" id="4164468">b</span><span class="op" id="4164469">.</span><span class="ident" id="4164470">data</span><span class="op" id="4164474">)</span>&nbsp;<span class="op" id="4164476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164480">b</span><span class="op" id="4164481">.</span><span class="ident" id="4164482">reserve</span><span class="op" id="4164489">(</span><span class="ident" id="4164490">n</span><span class="op" id="4164491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4164494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164497">b</span><span class="op" id="4164498">.</span><span class="ident" id="4164499">data</span>&nbsp;<span class="op" id="4164504">=</span>&nbsp;<span class="ident" id="4164506">b</span><span class="op" id="4164507">.</span><span class="ident" id="4164508">data</span><span class="op" id="4164512">[</span><span class="num" id="4164513">0</span><span class="op" id="4164514">:</span><span class="ident" id="4164515">n</span><span class="op" id="4164516">]</span><br>
<span class="lineno"></span><span class="op" id="4164518">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="4164521">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4164595">func</span>&nbsp;<span class="op" id="4164600">(</span><span class="ident" id="4164601">b</span>&nbsp;<span class="op" id="4164603">*</span><span class="ident" id="4164604">block</span><span class="op" id="4164609">)</span>&nbsp;<span class="ident" id="4164611">reserve</span><span class="op" id="4164618">(</span><span class="ident" id="4164619">n</span>&nbsp;<span class="builtintype" id="4164621">int</span><span class="op" id="4164624">)</span>&nbsp;<span class="op" id="4164626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4164629">if</span>&nbsp;<span class="builtinfunc" id="4164632">cap</span><span class="op" id="4164635">(</span><span class="ident" id="4164636">b</span><span class="op" id="4164637">.</span><span class="ident" id="4164638">data</span><span class="op" id="4164642">)</span>&nbsp;<span class="op" id="4164644">&gt;=</span>&nbsp;<span class="ident" id="4164647">n</span>&nbsp;<span class="op" id="4164649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4164653">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4164661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164664">m</span>&nbsp;<span class="op" id="4164666">:=</span>&nbsp;<span class="builtinfunc" id="4164669">cap</span><span class="op" id="4164672">(</span><span class="ident" id="4164673">b</span><span class="op" id="4164674">.</span><span class="ident" id="4164675">data</span><span class="op" id="4164679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4164682">if</span>&nbsp;<span class="ident" id="4164685">m</span>&nbsp;<span class="op" id="4164687">==</span>&nbsp;<span class="num" id="4164690">0</span>&nbsp;<span class="op" id="4164692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164696">m</span>&nbsp;<span class="op" id="4164698">=</span>&nbsp;<span class="num" id="4164700">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4164706">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4164709">for</span>&nbsp;<span class="ident" id="4164713">m</span>&nbsp;<span class="op" id="4164715">&lt;</span>&nbsp;<span class="ident" id="4164717">n</span>&nbsp;<span class="op" id="4164719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164723">m</span>&nbsp;<span class="op" id="4164725">*=</span>&nbsp;<span class="num" id="4164728">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4164731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164734">data</span>&nbsp;<span class="op" id="4164739">:=</span>&nbsp;<span class="builtinfunc" id="4164742">make</span><span class="op" id="4164746">(</span><span class="op" id="4164747">[</span><span class="op" id="4164748">]</span><span class="builtintype" id="4164749">byte</span><span class="op" id="4164753">,</span>&nbsp;<span class="builtinfunc" id="4164755">len</span><span class="op" id="4164758">(</span><span class="ident" id="4164759">b</span><span class="op" id="4164760">.</span><span class="ident" id="4164761">data</span><span class="op" id="4164765">)</span><span class="op" id="4164766">,</span>&nbsp;<span class="ident" id="4164768">m</span><span class="op" id="4164769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4164772">copy</span><span class="op" id="4164776">(</span><span class="ident" id="4164777">data</span><span class="op" id="4164781">,</span>&nbsp;<span class="ident" id="4164783">b</span><span class="op" id="4164784">.</span><span class="ident" id="4164785">data</span><span class="op" id="4164789">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4164792">b</span><span class="op" id="4164793">.</span><span class="ident" id="4164794">data</span>&nbsp;<span class="op" id="4164799">=</span>&nbsp;<span class="ident" id="4164801">data</span><br>
<span class="lineno"></span><span class="op" id="4164806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4164809">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="4164880">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="4164909">func</span>&nbsp;<span class="op" id="4164914">(</span><span class="ident" id="4164915">b</span>&nbsp;<span class="op" id="4164917">*</span><span class="ident" id="4164918">block</span><span class="op" id="4164923">)</span>&nbsp;<span class="ident" id="4164925">readFromUntil</span><span class="op" id="4164938">(</span><span class="ident" id="4164939">r</span>&nbsp;<span class="ident" id="4164941">io</span><span class="op" id="4164943">.</span><span class="ident" id="4164944">Reader</span><span class="op" id="4164950">,</span>&nbsp;<span class="ident" id="4164952">n</span>&nbsp;<span class="builtintype" id="4164954">int</span><span class="op" id="4164957">)</span>&nbsp;<span class="builtintype" id="4164959">error</span>&nbsp;<span class="op" id="4164965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4164968">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4164983">if</span>&nbsp;<span class="builtinfunc" id="4164986">len</span><span class="op" id="4164989">(</span><span class="ident" id="4164990">b</span><span class="op" id="4164991">.</span><span class="ident" id="4164992">data</span><span class="op" id="4164996">)</span>&nbsp;<span class="op" id="4164998">&gt;=</span>&nbsp;<span class="ident" id="4165001">n</span>&nbsp;<span class="op" id="4165003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4165007">return</span>&nbsp;<span class="ident" id="4165014">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4165019">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4165023">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4165051">b</span><span class="op" id="4165052">.</span><span class="ident" id="4165053">reserve</span><span class="op" id="4165060">(</span><span class="ident" id="4165061">n</span><span class="op" id="4165062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4165065">for</span>&nbsp;<span class="op" id="4165069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4165073">m</span><span class="op" id="4165074">,</span>&nbsp;<span class="ident" id="4165076">err</span>&nbsp;<span class="op" id="4165080">:=</span>&nbsp;<span class="ident" id="4165083">r</span><span class="op" id="4165084">.</span><span class="ident" id="4165085">Read</span><span class="op" id="4165089">(</span><span class="ident" id="4165090">b</span><span class="op" id="4165091">.</span><span class="ident" id="4165092">data</span><span class="op" id="4165096">[</span><span class="builtinfunc" id="4165097">len</span><span class="op" id="4165100">(</span><span class="ident" id="4165101">b</span><span class="op" id="4165102">.</span><span class="ident" id="4165103">data</span><span class="op" id="4165107">)</span><span class="op" id="4165108">:</span><span class="builtinfunc" id="4165109">cap</span><span class="op" id="4165112">(</span><span class="ident" id="4165113">b</span><span class="op" id="4165114">.</span><span class="ident" id="4165115">data</span><span class="op" id="4165119">)</span><span class="op" id="4165120">]</span><span class="op" id="4165121">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4165125">b</span><span class="op" id="4165126">.</span><span class="ident" id="4165127">data</span>&nbsp;<span class="op" id="4165132">=</span>&nbsp;<span class="ident" id="4165134">b</span><span class="op" id="4165135">.</span><span class="ident" id="4165136">data</span><span class="op" id="4165140">[</span><span class="num" id="4165141">0</span>&nbsp;<span class="op" id="4165143">:</span>&nbsp;<span class="builtinfunc" id="4165145">len</span><span class="op" id="4165148">(</span><span class="ident" id="4165149">b</span><span class="op" id="4165150">.</span><span class="ident" id="4165151">data</span><span class="op" id="4165155">)</span><span class="op" id="4165156">+</span><span class="ident" id="4165157">m</span><span class="op" id="4165158">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4165162">if</span>&nbsp;<span class="builtinfunc" id="4165165">len</span><span class="op" id="4165168">(</span><span class="ident" id="4165169">b</span><span class="op" id="4165170">.</span><span class="ident" id="4165171">data</span><span class="op" id="4165175">)</span>&nbsp;<span class="op" id="4165177">&gt;=</span>&nbsp;<span class="ident" id="4165180">n</span>&nbsp;<span class="op" id="4165182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4165187">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4165233">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4165283">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4165291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4165295">if</span>&nbsp;<span class="ident" id="4165298">err</span>&nbsp;<span class="op" id="4165302">!=</span>&nbsp;<span class="ident" id="4165305">nil</span>&nbsp;<span class="op" id="4165309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4165314">return</span>&nbsp;<span class="ident" id="4165321">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4165327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4165330">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4165333">return</span>&nbsp;<span class="ident" id="4165340">nil</span><br>
<span class="lineno"></span><span class="op" id="4165344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4165347">func</span>&nbsp;<span class="op" id="4165352">(</span><span class="ident" id="4165353">b</span>&nbsp;<span class="op" id="4165355">*</span><span class="ident" id="4165356">block</span><span class="op" id="4165361">)</span>&nbsp;<span class="ident" id="4165363">Read</span><span class="op" id="4165367">(</span><span class="ident" id="4165368">p</span>&nbsp;<span class="op" id="4165370">[</span><span class="op" id="4165371">]</span><span class="builtintype" id="4165372">byte</span><span class="op" id="4165376">)</span>&nbsp;<span class="op" id="4165378">(</span><span class="ident" id="4165379">n</span>&nbsp;<span class="builtintype" id="4165381">int</span><span class="op" id="4165384">,</span>&nbsp;<span class="ident" id="4165386">err</span>&nbsp;<span class="builtintype" id="4165390">error</span><span class="op" id="4165395">)</span>&nbsp;<span class="op" id="4165397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4165400">n</span>&nbsp;<span class="op" id="4165402">=</span>&nbsp;<span class="builtinfunc" id="4165404">copy</span><span class="op" id="4165408">(</span><span class="ident" id="4165409">p</span><span class="op" id="4165410">,</span>&nbsp;<span class="ident" id="4165412">b</span><span class="op" id="4165413">.</span><span class="ident" id="4165414">data</span><span class="op" id="4165418">[</span><span class="ident" id="4165419">b</span><span class="op" id="4165420">.</span><span class="ident" id="4165421">off</span><span class="op" id="4165424">:</span><span class="op" id="4165425">]</span><span class="op" id="4165426">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4165429">b</span><span class="op" id="4165430">.</span><span class="ident" id="4165431">off</span>&nbsp;<span class="op" id="4165435">+=</span>&nbsp;<span class="ident" id="4165438">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4165441">return</span><br>
<span class="lineno"></span><span class="op" id="4165448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4165451">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="4165519">func</span>&nbsp;<span class="op" id="4165524">(</span><span class="ident" id="4165525">hc</span>&nbsp;<span class="op" id="4165528">*</span><span class="ident" id="4165529">halfConn</span><span class="op" id="4165537">)</span>&nbsp;<span class="ident" id="4165539">newBlock</span><span class="op" id="4165547">(</span><span class="op" id="4165548">)</span>&nbsp;<span class="op" id="4165550">*</span><span class="ident" id="4165551">block</span>&nbsp;<span class="op" id="4165557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4165560">b</span>&nbsp;<span class="op" id="4165562">:=</span>&nbsp;<span class="ident" id="4165565">hc</span><span class="op" id="4165567">.</span><span class="ident" id="4165568">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4165575">if</span>&nbsp;<span class="ident" id="4165578">b</span>&nbsp;<span class="op" id="4165580">==</span>&nbsp;<span class="ident" id="4165583">nil</span>&nbsp;<span class="op" id="4165587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4165591">return</span>&nbsp;<span class="builtinfunc" id="4165598">new</span><span class="op" id="4165601">(</span><span class="ident" id="4165602">block</span><span class="op" id="4165607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4165610">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4165613">hc</span><span class="op" id="4165615">.</span><span class="ident" id="4165616">bfree</span>&nbsp;<span class="op" id="4165622">=</span>&nbsp;<span class="ident" id="4165624">b</span><span class="op" id="4165625">.</span><span class="ident" id="4165626">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4165632">b</span><span class="op" id="4165633">.</span><span class="ident" id="4165634">link</span>&nbsp;<span class="op" id="4165639">=</span>&nbsp;<span class="ident" id="4165641">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4165646">b</span><span class="op" id="4165647">.</span><span class="ident" id="4165648">resize</span><span class="op" id="4165654">(</span><span class="num" id="4165655">0</span><span class="op" id="4165656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4165659">return</span>&nbsp;<span class="ident" id="4165666">b</span><br>
<span class="lineno"></span><span class="op" id="4165668">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="4165671">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="4165719">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4165785">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="4165847">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="4165874">func</span>&nbsp;<span class="op" id="4165879">(</span><span class="ident" id="4165880">hc</span>&nbsp;<span class="op" id="4165883">*</span><span class="ident" id="4165884">halfConn</span><span class="op" id="4165892">)</span>&nbsp;<span class="ident" id="4165894">freeBlock</span><span class="op" id="4165903">(</span><span class="ident" id="4165904">b</span>&nbsp;<span class="op" id="4165906">*</span><span class="ident" id="4165907">block</span><span class="op" id="4165912">)</span>&nbsp;<span class="op" id="4165914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4165917">b</span><span class="op" id="4165918">.</span><span class="ident" id="4165919">link</span>&nbsp;<span class="op" id="4165924">=</span>&nbsp;<span class="ident" id="4165926">hc</span><span class="op" id="4165928">.</span><span class="ident" id="4165929">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4165936">hc</span><span class="op" id="4165938">.</span><span class="ident" id="4165939">bfree</span>&nbsp;<span class="op" id="4165945">=</span>&nbsp;<span class="ident" id="4165947">b</span><br>
<span class="lineno"></span><span class="op" id="4165949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="4165952">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="4166006">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4166052">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4166105">func</span>&nbsp;<span class="op" id="4166110">(</span><span class="ident" id="4166111">hc</span>&nbsp;<span class="op" id="4166114">*</span><span class="ident" id="4166115">halfConn</span><span class="op" id="4166123">)</span>&nbsp;<span class="ident" id="4166125">splitBlock</span><span class="op" id="4166135">(</span><span class="ident" id="4166136">b</span>&nbsp;<span class="op" id="4166138">*</span><span class="ident" id="4166139">block</span><span class="op" id="4166144">,</span>&nbsp;<span class="ident" id="4166146">n</span>&nbsp;<span class="builtintype" id="4166148">int</span><span class="op" id="4166151">)</span>&nbsp;<span class="op" id="4166153">(</span><span class="op" id="4166154">*</span><span class="ident" id="4166155">block</span><span class="op" id="4166160">,</span>&nbsp;<span class="op" id="4166162">*</span><span class="ident" id="4166163">block</span><span class="op" id="4166168">)</span>&nbsp;<span class="op" id="4166170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166173">if</span>&nbsp;<span class="builtinfunc" id="4166176">len</span><span class="op" id="4166179">(</span><span class="ident" id="4166180">b</span><span class="op" id="4166181">.</span><span class="ident" id="4166182">data</span><span class="op" id="4166186">)</span>&nbsp;<span class="op" id="4166188">&lt;=</span>&nbsp;<span class="ident" id="4166191">n</span>&nbsp;<span class="op" id="4166193">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166197">return</span>&nbsp;<span class="ident" id="4166204">b</span><span class="op" id="4166205">,</span>&nbsp;<span class="ident" id="4166207">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4166212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166215">bb</span>&nbsp;<span class="op" id="4166218">:=</span>&nbsp;<span class="ident" id="4166221">hc</span><span class="op" id="4166223">.</span><span class="ident" id="4166224">newBlock</span><span class="op" id="4166232">(</span><span class="op" id="4166233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166236">bb</span><span class="op" id="4166238">.</span><span class="ident" id="4166239">resize</span><span class="op" id="4166245">(</span><span class="builtinfunc" id="4166246">len</span><span class="op" id="4166249">(</span><span class="ident" id="4166250">b</span><span class="op" id="4166251">.</span><span class="ident" id="4166252">data</span><span class="op" id="4166256">)</span>&nbsp;<span class="op" id="4166258">-</span>&nbsp;<span class="ident" id="4166260">n</span><span class="op" id="4166261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4166264">copy</span><span class="op" id="4166268">(</span><span class="ident" id="4166269">bb</span><span class="op" id="4166271">.</span><span class="ident" id="4166272">data</span><span class="op" id="4166276">,</span>&nbsp;<span class="ident" id="4166278">b</span><span class="op" id="4166279">.</span><span class="ident" id="4166280">data</span><span class="op" id="4166284">[</span><span class="ident" id="4166285">n</span><span class="op" id="4166286">:</span><span class="op" id="4166287">]</span><span class="op" id="4166288">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166291">b</span><span class="op" id="4166292">.</span><span class="ident" id="4166293">data</span>&nbsp;<span class="op" id="4166298">=</span>&nbsp;<span class="ident" id="4166300">b</span><span class="op" id="4166301">.</span><span class="ident" id="4166302">data</span><span class="op" id="4166306">[</span><span class="num" id="4166307">0</span><span class="op" id="4166308">:</span><span class="ident" id="4166309">n</span><span class="op" id="4166310">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166313">return</span>&nbsp;<span class="ident" id="4166320">b</span><span class="op" id="4166321">,</span>&nbsp;<span class="ident" id="4166323">bb</span><br>
<span class="lineno"></span><span class="op" id="4166326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4166329">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="4166389">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4166428">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4166464">func</span>&nbsp;<span class="op" id="4166469">(</span><span class="ident" id="4166470">c</span>&nbsp;<span class="op" id="4166472">*</span><span class="ident" id="4166473">Conn</span><span class="op" id="4166477">)</span>&nbsp;<span class="ident" id="4166479">readRecord</span><span class="op" id="4166489">(</span><span class="ident" id="4166490">want</span>&nbsp;<span class="ident" id="4166495">recordType</span><span class="op" id="4166505">)</span>&nbsp;<span class="builtintype" id="4166507">error</span>&nbsp;<span class="op" id="4166513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4166516">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4166560">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4166611">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166673">switch</span>&nbsp;<span class="ident" id="4166680">want</span>&nbsp;<span class="op" id="4166685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166688">default</span><span class="op" id="4166695">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166699">c</span><span class="op" id="4166700">.</span><span class="ident" id="4166701">sendAlert</span><span class="op" id="4166710">(</span><span class="ident" id="4166711">alertInternalError</span><span class="op" id="4166729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166733">return</span>&nbsp;<span class="ident" id="4166740">c</span><span class="op" id="4166741">.</span><span class="ident" id="4166742">in</span><span class="op" id="4166744">.</span><span class="ident" id="4166745">setErrorLocked</span><span class="op" id="4166759">(</span><span class="ident" id="4166760">errors</span><span class="op" id="4166766">.</span><span class="ident" id="4166767">New</span><span class="op" id="4166770">(</span><span class="string" id="4166771">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="4166807">)</span><span class="op" id="4166808">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166811">case</span>&nbsp;<span class="ident" id="4166816">recordTypeHandshake</span><span class="op" id="4166835">,</span>&nbsp;<span class="ident" id="4166837">recordTypeChangeCipherSpec</span><span class="op" id="4166863">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166867">if</span>&nbsp;<span class="ident" id="4166870">c</span><span class="op" id="4166871">.</span><span class="ident" id="4166872">handshakeComplete</span>&nbsp;<span class="op" id="4166890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166895">c</span><span class="op" id="4166896">.</span><span class="ident" id="4166897">sendAlert</span><span class="op" id="4166906">(</span><span class="ident" id="4166907">alertInternalError</span><span class="op" id="4166925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166930">return</span>&nbsp;<span class="ident" id="4166937">c</span><span class="op" id="4166938">.</span><span class="ident" id="4166939">in</span><span class="op" id="4166941">.</span><span class="ident" id="4166942">setErrorLocked</span><span class="op" id="4166956">(</span><span class="ident" id="4166957">errors</span><span class="op" id="4166963">.</span><span class="ident" id="4166964">New</span><span class="op" id="4166967">(</span><span class="string" id="4166968">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4167039">)</span><span class="op" id="4167040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167044">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167047">case</span>&nbsp;<span class="ident" id="4167052">recordTypeApplicationData</span><span class="op" id="4167077">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167081">if</span>&nbsp;<span class="op" id="4167084">!</span><span class="ident" id="4167085">c</span><span class="op" id="4167086">.</span><span class="ident" id="4167087">handshakeComplete</span>&nbsp;<span class="op" id="4167105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4167110">c</span><span class="op" id="4167111">.</span><span class="ident" id="4167112">sendAlert</span><span class="op" id="4167121">(</span><span class="ident" id="4167122">alertInternalError</span><span class="op" id="4167140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167145">return</span>&nbsp;<span class="ident" id="4167152">c</span><span class="op" id="4167153">.</span><span class="ident" id="4167154">in</span><span class="op" id="4167156">.</span><span class="ident" id="4167157">setErrorLocked</span><span class="op" id="4167171">(</span><span class="ident" id="4167172">errors</span><span class="op" id="4167178">.</span><span class="ident" id="4167179">New</span><span class="op" id="4167182">(</span><span class="string" id="4167183">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4167249">)</span><span class="op" id="4167250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167254">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4167260">Again</span><span class="op" id="4167265">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167268">if</span>&nbsp;<span class="ident" id="4167271">c</span><span class="op" id="4167272">.</span><span class="ident" id="4167273">rawInput</span>&nbsp;<span class="op" id="4167282">==</span>&nbsp;<span class="ident" id="4167285">nil</span>&nbsp;<span class="op" id="4167289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4167293">c</span><span class="op" id="4167294">.</span><span class="ident" id="4167295">rawInput</span>&nbsp;<span class="op" id="4167304">=</span>&nbsp;<span class="ident" id="4167306">c</span><span class="op" id="4167307">.</span><span class="ident" id="4167308">in</span><span class="op" id="4167310">.</span><span class="ident" id="4167311">newBlock</span><span class="op" id="4167319">(</span><span class="op" id="4167320">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4167326">b</span>&nbsp;<span class="op" id="4167328">:=</span>&nbsp;<span class="ident" id="4167331">c</span><span class="op" id="4167332">.</span><span class="ident" id="4167333">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167344">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167370">if</span>&nbsp;<span class="ident" id="4167373">err</span>&nbsp;<span class="op" id="4167377">:=</span>&nbsp;<span class="ident" id="4167380">b</span><span class="op" id="4167381">.</span><span class="ident" id="4167382">readFromUntil</span><span class="op" id="4167395">(</span><span class="ident" id="4167396">c</span><span class="op" id="4167397">.</span><span class="ident" id="4167398">conn</span><span class="op" id="4167402">,</span>&nbsp;<span class="ident" id="4167404">recordHeaderLen</span><span class="op" id="4167419">)</span><span class="op" id="4167420">;</span>&nbsp;<span class="ident" id="4167422">err</span>&nbsp;<span class="op" id="4167426">!=</span>&nbsp;<span class="ident" id="4167429">nil</span>&nbsp;<span class="op" id="4167433">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167437">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167495">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167549">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167584">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167608">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167640">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167647">if</span>&nbsp;<span class="ident" id="4167650">e</span><span class="op" id="4167651">,</span>&nbsp;<span class="ident" id="4167653">ok</span>&nbsp;<span class="op" id="4167656">:=</span>&nbsp;<span class="ident" id="4167659">err</span><span class="op" id="4167662">.</span><span class="op" id="4167663">(</span><span class="ident" id="4167664">net</span><span class="op" id="4167667">.</span><span class="ident" id="4167668">Error</span><span class="op" id="4167673">)</span><span class="op" id="4167674">;</span>&nbsp;<span class="op" id="4167676">!</span><span class="ident" id="4167677">ok</span>&nbsp;<span class="op" id="4167680">||</span>&nbsp;<span class="op" id="4167683">!</span><span class="ident" id="4167684">e</span><span class="op" id="4167685">.</span><span class="ident" id="4167686">Temporary</span><span class="op" id="4167695">(</span><span class="op" id="4167696">)</span>&nbsp;<span class="op" id="4167698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4167703">c</span><span class="op" id="4167704">.</span><span class="ident" id="4167705">in</span><span class="op" id="4167707">.</span><span class="ident" id="4167708">setErrorLocked</span><span class="op" id="4167722">(</span><span class="ident" id="4167723">err</span><span class="op" id="4167726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167734">return</span>&nbsp;<span class="ident" id="4167741">err</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4167749">typ</span>&nbsp;<span class="op" id="4167753">:=</span>&nbsp;<span class="ident" id="4167756">recordType</span><span class="op" id="4167766">(</span><span class="ident" id="4167767">b</span><span class="op" id="4167768">.</span><span class="ident" id="4167769">data</span><span class="op" id="4167773">[</span><span class="num" id="4167774">0</span><span class="op" id="4167775">]</span><span class="op" id="4167776">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167780">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167849">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167922">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167994">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168015">if</span>&nbsp;<span class="ident" id="4168018">want</span>&nbsp;<span class="op" id="4168023">==</span>&nbsp;<span class="ident" id="4168026">recordTypeHandshake</span>&nbsp;<span class="op" id="4168046">&amp;&amp;</span>&nbsp;<span class="ident" id="4168049">typ</span>&nbsp;<span class="op" id="4168053">==</span>&nbsp;<span class="num" id="4168056">0x80</span>&nbsp;<span class="op" id="4168061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168065">c</span><span class="op" id="4168066">.</span><span class="ident" id="4168067">sendAlert</span><span class="op" id="4168076">(</span><span class="ident" id="4168077">alertProtocolVersion</span><span class="op" id="4168097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168101">return</span>&nbsp;<span class="ident" id="4168108">c</span><span class="op" id="4168109">.</span><span class="ident" id="4168110">in</span><span class="op" id="4168112">.</span><span class="ident" id="4168113">setErrorLocked</span><span class="op" id="4168127">(</span><span class="ident" id="4168128">errors</span><span class="op" id="4168134">.</span><span class="ident" id="4168135">New</span><span class="op" id="4168138">(</span><span class="string" id="4168139">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="4168182">)</span><span class="op" id="4168183">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4168186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168190">vers</span>&nbsp;<span class="op" id="4168195">:=</span>&nbsp;<span class="builtintype" id="4168198">uint16</span><span class="op" id="4168204">(</span><span class="ident" id="4168205">b</span><span class="op" id="4168206">.</span><span class="ident" id="4168207">data</span><span class="op" id="4168211">[</span><span class="num" id="4168212">1</span><span class="op" id="4168213">]</span><span class="op" id="4168214">)</span><span class="op" id="4168215">&lt;&lt;</span><span class="num" id="4168217">8</span>&nbsp;<span class="op" id="4168219">|</span>&nbsp;<span class="builtintype" id="4168221">uint16</span><span class="op" id="4168227">(</span><span class="ident" id="4168228">b</span><span class="op" id="4168229">.</span><span class="ident" id="4168230">data</span><span class="op" id="4168234">[</span><span class="num" id="4168235">2</span><span class="op" id="4168236">]</span><span class="op" id="4168237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168240">n</span>&nbsp;<span class="op" id="4168242">:=</span>&nbsp;<span class="builtintype" id="4168245">int</span><span class="op" id="4168248">(</span><span class="ident" id="4168249">b</span><span class="op" id="4168250">.</span><span class="ident" id="4168251">data</span><span class="op" id="4168255">[</span><span class="num" id="4168256">3</span><span class="op" id="4168257">]</span><span class="op" id="4168258">)</span><span class="op" id="4168259">&lt;&lt;</span><span class="num" id="4168261">8</span>&nbsp;<span class="op" id="4168263">|</span>&nbsp;<span class="builtintype" id="4168265">int</span><span class="op" id="4168268">(</span><span class="ident" id="4168269">b</span><span class="op" id="4168270">.</span><span class="ident" id="4168271">data</span><span class="op" id="4168275">[</span><span class="num" id="4168276">4</span><span class="op" id="4168277">]</span><span class="op" id="4168278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168281">if</span>&nbsp;<span class="ident" id="4168284">c</span><span class="op" id="4168285">.</span><span class="ident" id="4168286">haveVers</span>&nbsp;<span class="op" id="4168295">&amp;&amp;</span>&nbsp;<span class="ident" id="4168298">vers</span>&nbsp;<span class="op" id="4168303">!=</span>&nbsp;<span class="ident" id="4168306">c</span><span class="op" id="4168307">.</span><span class="ident" id="4168308">vers</span>&nbsp;<span class="op" id="4168313">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168317">c</span><span class="op" id="4168318">.</span><span class="ident" id="4168319">sendAlert</span><span class="op" id="4168328">(</span><span class="ident" id="4168329">alertProtocolVersion</span><span class="op" id="4168349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168353">return</span>&nbsp;<span class="ident" id="4168360">c</span><span class="op" id="4168361">.</span><span class="ident" id="4168362">in</span><span class="op" id="4168364">.</span><span class="ident" id="4168365">setErrorLocked</span><span class="op" id="4168379">(</span><span class="ident" id="4168380">fmt</span><span class="op" id="4168383">.</span><span class="ident" id="4168384">Errorf</span><span class="op" id="4168390">(</span><span class="string" id="4168391">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4168455">,</span>&nbsp;<span class="ident" id="4168457">vers</span><span class="op" id="4168461">,</span>&nbsp;<span class="ident" id="4168463">c</span><span class="op" id="4168464">.</span><span class="ident" id="4168465">vers</span><span class="op" id="4168469">)</span><span class="op" id="4168470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4168473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168476">if</span>&nbsp;<span class="ident" id="4168479">n</span>&nbsp;<span class="op" id="4168481">&gt;</span>&nbsp;<span class="ident" id="4168483">maxCiphertext</span>&nbsp;<span class="op" id="4168497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168501">c</span><span class="op" id="4168502">.</span><span class="ident" id="4168503">sendAlert</span><span class="op" id="4168512">(</span><span class="ident" id="4168513">alertRecordOverflow</span><span class="op" id="4168532">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168536">return</span>&nbsp;<span class="ident" id="4168543">c</span><span class="op" id="4168544">.</span><span class="ident" id="4168545">in</span><span class="op" id="4168547">.</span><span class="ident" id="4168548">setErrorLocked</span><span class="op" id="4168562">(</span><span class="ident" id="4168563">fmt</span><span class="op" id="4168566">.</span><span class="ident" id="4168567">Errorf</span><span class="op" id="4168573">(</span><span class="string" id="4168574">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="4168621">,</span>&nbsp;<span class="ident" id="4168623">n</span><span class="op" id="4168624">)</span><span class="op" id="4168625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4168628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168631">if</span>&nbsp;<span class="op" id="4168634">!</span><span class="ident" id="4168635">c</span><span class="op" id="4168636">.</span><span class="ident" id="4168637">haveVers</span>&nbsp;<span class="op" id="4168646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4168650">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4168691">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4168728">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4168785">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4168822">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4168878">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4168927">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4168983">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169012">if</span>&nbsp;<span class="op" id="4169015">(</span><span class="ident" id="4169016">typ</span>&nbsp;<span class="op" id="4169020">!=</span>&nbsp;<span class="ident" id="4169023">recordTypeAlert</span>&nbsp;<span class="op" id="4169039">&amp;&amp;</span>&nbsp;<span class="ident" id="4169042">typ</span>&nbsp;<span class="op" id="4169046">!=</span>&nbsp;<span class="ident" id="4169049">want</span><span class="op" id="4169053">)</span>&nbsp;<span class="op" id="4169055">||</span>&nbsp;<span class="ident" id="4169058">vers</span>&nbsp;<span class="op" id="4169063">&gt;=</span>&nbsp;<span class="num" id="4169066">0x1000</span>&nbsp;<span class="op" id="4169073">||</span>&nbsp;<span class="ident" id="4169076">n</span>&nbsp;<span class="op" id="4169078">&gt;=</span>&nbsp;<span class="num" id="4169081">0x3000</span>&nbsp;<span class="op" id="4169088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169093">c</span><span class="op" id="4169094">.</span><span class="ident" id="4169095">sendAlert</span><span class="op" id="4169104">(</span><span class="ident" id="4169105">alertUnexpectedMessage</span><span class="op" id="4169127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169132">return</span>&nbsp;<span class="ident" id="4169139">c</span><span class="op" id="4169140">.</span><span class="ident" id="4169141">in</span><span class="op" id="4169143">.</span><span class="ident" id="4169144">setErrorLocked</span><span class="op" id="4169158">(</span><span class="ident" id="4169159">fmt</span><span class="op" id="4169162">.</span><span class="ident" id="4169163">Errorf</span><span class="op" id="4169169">(</span><span class="string" id="4169170">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="4169224">)</span><span class="op" id="4169225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169229">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169235">if</span>&nbsp;<span class="ident" id="4169238">err</span>&nbsp;<span class="op" id="4169242">:=</span>&nbsp;<span class="ident" id="4169245">b</span><span class="op" id="4169246">.</span><span class="ident" id="4169247">readFromUntil</span><span class="op" id="4169260">(</span><span class="ident" id="4169261">c</span><span class="op" id="4169262">.</span><span class="ident" id="4169263">conn</span><span class="op" id="4169267">,</span>&nbsp;<span class="ident" id="4169269">recordHeaderLen</span><span class="op" id="4169284">+</span><span class="ident" id="4169285">n</span><span class="op" id="4169286">)</span><span class="op" id="4169287">;</span>&nbsp;<span class="ident" id="4169289">err</span>&nbsp;<span class="op" id="4169293">!=</span>&nbsp;<span class="ident" id="4169296">nil</span>&nbsp;<span class="op" id="4169300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169304">if</span>&nbsp;<span class="ident" id="4169307">err</span>&nbsp;<span class="op" id="4169311">==</span>&nbsp;<span class="ident" id="4169314">io</span><span class="op" id="4169316">.</span><span class="ident" id="4169317">EOF</span>&nbsp;<span class="op" id="4169321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169326">err</span>&nbsp;<span class="op" id="4169330">=</span>&nbsp;<span class="ident" id="4169332">io</span><span class="op" id="4169334">.</span><span class="ident" id="4169335">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169354">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169358">if</span>&nbsp;<span class="ident" id="4169361">e</span><span class="op" id="4169362">,</span>&nbsp;<span class="ident" id="4169364">ok</span>&nbsp;<span class="op" id="4169367">:=</span>&nbsp;<span class="ident" id="4169370">err</span><span class="op" id="4169373">.</span><span class="op" id="4169374">(</span><span class="ident" id="4169375">net</span><span class="op" id="4169378">.</span><span class="ident" id="4169379">Error</span><span class="op" id="4169384">)</span><span class="op" id="4169385">;</span>&nbsp;<span class="op" id="4169387">!</span><span class="ident" id="4169388">ok</span>&nbsp;<span class="op" id="4169391">||</span>&nbsp;<span class="op" id="4169394">!</span><span class="ident" id="4169395">e</span><span class="op" id="4169396">.</span><span class="ident" id="4169397">Temporary</span><span class="op" id="4169406">(</span><span class="op" id="4169407">)</span>&nbsp;<span class="op" id="4169409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169414">c</span><span class="op" id="4169415">.</span><span class="ident" id="4169416">in</span><span class="op" id="4169418">.</span><span class="ident" id="4169419">setErrorLocked</span><span class="op" id="4169433">(</span><span class="ident" id="4169434">err</span><span class="op" id="4169437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169445">return</span>&nbsp;<span class="ident" id="4169452">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169457">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4169461">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169482">b</span><span class="op" id="4169483">,</span>&nbsp;<span class="ident" id="4169485">c</span><span class="op" id="4169486">.</span><span class="ident" id="4169487">rawInput</span>&nbsp;<span class="op" id="4169496">=</span>&nbsp;<span class="ident" id="4169498">c</span><span class="op" id="4169499">.</span><span class="ident" id="4169500">in</span><span class="op" id="4169502">.</span><span class="ident" id="4169503">splitBlock</span><span class="op" id="4169513">(</span><span class="ident" id="4169514">b</span><span class="op" id="4169515">,</span>&nbsp;<span class="ident" id="4169517">recordHeaderLen</span><span class="op" id="4169532">+</span><span class="ident" id="4169533">n</span><span class="op" id="4169534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169537">ok</span><span class="op" id="4169539">,</span>&nbsp;<span class="ident" id="4169541">off</span><span class="op" id="4169544">,</span>&nbsp;<span class="ident" id="4169546">err</span>&nbsp;<span class="op" id="4169550">:=</span>&nbsp;<span class="ident" id="4169553">c</span><span class="op" id="4169554">.</span><span class="ident" id="4169555">in</span><span class="op" id="4169557">.</span><span class="ident" id="4169558">decrypt</span><span class="op" id="4169565">(</span><span class="ident" id="4169566">b</span><span class="op" id="4169567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169570">if</span>&nbsp;<span class="op" id="4169573">!</span><span class="ident" id="4169574">ok</span>&nbsp;<span class="op" id="4169577">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169581">c</span><span class="op" id="4169582">.</span><span class="ident" id="4169583">in</span><span class="op" id="4169585">.</span><span class="ident" id="4169586">setErrorLocked</span><span class="op" id="4169600">(</span><span class="ident" id="4169601">c</span><span class="op" id="4169602">.</span><span class="ident" id="4169603">sendAlert</span><span class="op" id="4169612">(</span><span class="ident" id="4169613">err</span><span class="op" id="4169616">)</span><span class="op" id="4169617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169623">b</span><span class="op" id="4169624">.</span><span class="ident" id="4169625">off</span>&nbsp;<span class="op" id="4169629">=</span>&nbsp;<span class="ident" id="4169631">off</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169636">data</span>&nbsp;<span class="op" id="4169641">:=</span>&nbsp;<span class="ident" id="4169644">b</span><span class="op" id="4169645">.</span><span class="ident" id="4169646">data</span><span class="op" id="4169650">[</span><span class="ident" id="4169651">b</span><span class="op" id="4169652">.</span><span class="ident" id="4169653">off</span><span class="op" id="4169656">:</span><span class="op" id="4169657">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169660">if</span>&nbsp;<span class="builtinfunc" id="4169663">len</span><span class="op" id="4169666">(</span><span class="ident" id="4169667">data</span><span class="op" id="4169671">)</span>&nbsp;<span class="op" id="4169673">&gt;</span>&nbsp;<span class="ident" id="4169675">maxPlaintext</span>&nbsp;<span class="op" id="4169688">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169692">err</span>&nbsp;<span class="op" id="4169696">:=</span>&nbsp;<span class="ident" id="4169699">c</span><span class="op" id="4169700">.</span><span class="ident" id="4169701">sendAlert</span><span class="op" id="4169710">(</span><span class="ident" id="4169711">alertRecordOverflow</span><span class="op" id="4169730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169734">c</span><span class="op" id="4169735">.</span><span class="ident" id="4169736">in</span><span class="op" id="4169738">.</span><span class="ident" id="4169739">freeBlock</span><span class="op" id="4169748">(</span><span class="ident" id="4169749">b</span><span class="op" id="4169750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169754">return</span>&nbsp;<span class="ident" id="4169761">c</span><span class="op" id="4169762">.</span><span class="ident" id="4169763">in</span><span class="op" id="4169765">.</span><span class="ident" id="4169766">setErrorLocked</span><span class="op" id="4169780">(</span><span class="ident" id="4169781">err</span><span class="op" id="4169784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169791">switch</span>&nbsp;<span class="ident" id="4169798">typ</span>&nbsp;<span class="op" id="4169802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169805">default</span><span class="op" id="4169812">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169816">c</span><span class="op" id="4169817">.</span><span class="ident" id="4169818">in</span><span class="op" id="4169820">.</span><span class="ident" id="4169821">setErrorLocked</span><span class="op" id="4169835">(</span><span class="ident" id="4169836">c</span><span class="op" id="4169837">.</span><span class="ident" id="4169838">sendAlert</span><span class="op" id="4169847">(</span><span class="ident" id="4169848">alertUnexpectedMessage</span><span class="op" id="4169870">)</span><span class="op" id="4169871">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169875">case</span>&nbsp;<span class="ident" id="4169880">recordTypeAlert</span><span class="op" id="4169895">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169899">if</span>&nbsp;<span class="builtinfunc" id="4169902">len</span><span class="op" id="4169905">(</span><span class="ident" id="4169906">data</span><span class="op" id="4169910">)</span>&nbsp;<span class="op" id="4169912">!=</span>&nbsp;<span class="num" id="4169915">2</span>&nbsp;<span class="op" id="4169917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169922">c</span><span class="op" id="4169923">.</span><span class="ident" id="4169924">in</span><span class="op" id="4169926">.</span><span class="ident" id="4169927">setErrorLocked</span><span class="op" id="4169941">(</span><span class="ident" id="4169942">c</span><span class="op" id="4169943">.</span><span class="ident" id="4169944">sendAlert</span><span class="op" id="4169953">(</span><span class="ident" id="4169954">alertUnexpectedMessage</span><span class="op" id="4169976">)</span><span class="op" id="4169977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169982">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169994">if</span>&nbsp;<span class="ident" id="4169997">alert</span><span class="op" id="4170002">(</span><span class="ident" id="4170003">data</span><span class="op" id="4170007">[</span><span class="num" id="4170008">1</span><span class="op" id="4170009">]</span><span class="op" id="4170010">)</span>&nbsp;<span class="op" id="4170012">==</span>&nbsp;<span class="ident" id="4170015">alertCloseNotify</span>&nbsp;<span class="op" id="4170032">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170037">c</span><span class="op" id="4170038">.</span><span class="ident" id="4170039">in</span><span class="op" id="4170041">.</span><span class="ident" id="4170042">setErrorLocked</span><span class="op" id="4170056">(</span><span class="ident" id="4170057">io</span><span class="op" id="4170059">.</span><span class="ident" id="4170060">EOF</span><span class="op" id="4170063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170068">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170080">switch</span>&nbsp;<span class="ident" id="4170087">data</span><span class="op" id="4170091">[</span><span class="num" id="4170092">0</span><span class="op" id="4170093">]</span>&nbsp;<span class="op" id="4170095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170099">case</span>&nbsp;<span class="ident" id="4170104">alertLevelWarning</span><span class="op" id="4170121">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170126">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170150">c</span><span class="op" id="4170151">.</span><span class="ident" id="4170152">in</span><span class="op" id="4170154">.</span><span class="ident" id="4170155">freeBlock</span><span class="op" id="4170164">(</span><span class="ident" id="4170165">b</span><span class="op" id="4170166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170171">goto</span>&nbsp;<span class="ident" id="4170176">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170184">case</span>&nbsp;<span class="ident" id="4170189">alertLevelError</span><span class="op" id="4170204">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170209">c</span><span class="op" id="4170210">.</span><span class="ident" id="4170211">in</span><span class="op" id="4170213">.</span><span class="ident" id="4170214">setErrorLocked</span><span class="op" id="4170228">(</span><span class="op" id="4170229">&amp;</span><span class="ident" id="4170230">net</span><span class="op" id="4170233">.</span><span class="ident" id="4170234">OpError</span><span class="op" id="4170241">{</span><span class="ident" id="4170242">Op</span><span class="op" id="4170244">:</span>&nbsp;<span class="string" id="4170246">&#34;remote&nbsp;error&#34;</span><span class="op" id="4170260">,</span>&nbsp;<span class="ident" id="4170262">Err</span><span class="op" id="4170265">:</span>&nbsp;<span class="ident" id="4170267">alert</span><span class="op" id="4170272">(</span><span class="ident" id="4170273">data</span><span class="op" id="4170277">[</span><span class="num" id="4170278">1</span><span class="op" id="4170279">]</span><span class="op" id="4170280">)</span><span class="op" id="4170281">}</span><span class="op" id="4170282">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170286">default</span><span class="op" id="4170293">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170298">c</span><span class="op" id="4170299">.</span><span class="ident" id="4170300">in</span><span class="op" id="4170302">.</span><span class="ident" id="4170303">setErrorLocked</span><span class="op" id="4170317">(</span><span class="ident" id="4170318">c</span><span class="op" id="4170319">.</span><span class="ident" id="4170320">sendAlert</span><span class="op" id="4170329">(</span><span class="ident" id="4170330">alertUnexpectedMessage</span><span class="op" id="4170352">)</span><span class="op" id="4170353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170361">case</span>&nbsp;<span class="ident" id="4170366">recordTypeChangeCipherSpec</span><span class="op" id="4170392">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170396">if</span>&nbsp;<span class="ident" id="4170399">typ</span>&nbsp;<span class="op" id="4170403">!=</span>&nbsp;<span class="ident" id="4170406">want</span>&nbsp;<span class="op" id="4170411">||</span>&nbsp;<span class="builtinfunc" id="4170414">len</span><span class="op" id="4170417">(</span><span class="ident" id="4170418">data</span><span class="op" id="4170422">)</span>&nbsp;<span class="op" id="4170424">!=</span>&nbsp;<span class="num" id="4170427">1</span>&nbsp;<span class="op" id="4170429">||</span>&nbsp;<span class="ident" id="4170432">data</span><span class="op" id="4170436">[</span><span class="num" id="4170437">0</span><span class="op" id="4170438">]</span>&nbsp;<span class="op" id="4170440">!=</span>&nbsp;<span class="num" id="4170443">1</span>&nbsp;<span class="op" id="4170445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170450">c</span><span class="op" id="4170451">.</span><span class="ident" id="4170452">in</span><span class="op" id="4170454">.</span><span class="ident" id="4170455">setErrorLocked</span><span class="op" id="4170469">(</span><span class="ident" id="4170470">c</span><span class="op" id="4170471">.</span><span class="ident" id="4170472">sendAlert</span><span class="op" id="4170481">(</span><span class="ident" id="4170482">alertUnexpectedMessage</span><span class="op" id="4170504">)</span><span class="op" id="4170505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170510">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170522">err</span>&nbsp;<span class="op" id="4170526">:=</span>&nbsp;<span class="ident" id="4170529">c</span><span class="op" id="4170530">.</span><span class="ident" id="4170531">in</span><span class="op" id="4170533">.</span><span class="ident" id="4170534">changeCipherSpec</span><span class="op" id="4170550">(</span><span class="op" id="4170551">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170555">if</span>&nbsp;<span class="ident" id="4170558">err</span>&nbsp;<span class="op" id="4170562">!=</span>&nbsp;<span class="ident" id="4170565">nil</span>&nbsp;<span class="op" id="4170569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170574">c</span><span class="op" id="4170575">.</span><span class="ident" id="4170576">in</span><span class="op" id="4170578">.</span><span class="ident" id="4170579">setErrorLocked</span><span class="op" id="4170593">(</span><span class="ident" id="4170594">c</span><span class="op" id="4170595">.</span><span class="ident" id="4170596">sendAlert</span><span class="op" id="4170605">(</span><span class="ident" id="4170606">err</span><span class="op" id="4170609">.</span><span class="op" id="4170610">(</span><span class="ident" id="4170611">alert</span><span class="op" id="4170616">)</span><span class="op" id="4170617">)</span><span class="op" id="4170618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170626">case</span>&nbsp;<span class="ident" id="4170631">recordTypeApplicationData</span><span class="op" id="4170656">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170660">if</span>&nbsp;<span class="ident" id="4170663">typ</span>&nbsp;<span class="op" id="4170667">!=</span>&nbsp;<span class="ident" id="4170670">want</span>&nbsp;<span class="op" id="4170675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170680">c</span><span class="op" id="4170681">.</span><span class="ident" id="4170682">in</span><span class="op" id="4170684">.</span><span class="ident" id="4170685">setErrorLocked</span><span class="op" id="4170699">(</span><span class="ident" id="4170700">c</span><span class="op" id="4170701">.</span><span class="ident" id="4170702">sendAlert</span><span class="op" id="4170711">(</span><span class="ident" id="4170712">alertUnexpectedMessage</span><span class="op" id="4170734">)</span><span class="op" id="4170735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170740">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170752">c</span><span class="op" id="4170753">.</span><span class="ident" id="4170754">input</span>&nbsp;<span class="op" id="4170760">=</span>&nbsp;<span class="ident" id="4170762">b</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170766">b</span>&nbsp;<span class="op" id="4170768">=</span>&nbsp;<span class="ident" id="4170770">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170776">case</span>&nbsp;<span class="ident" id="4170781">recordTypeHandshake</span><span class="op" id="4170800">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170804">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170863">if</span>&nbsp;<span class="ident" id="4170866">typ</span>&nbsp;<span class="op" id="4170870">!=</span>&nbsp;<span class="ident" id="4170873">want</span>&nbsp;<span class="op" id="4170878">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170883">return</span>&nbsp;<span class="ident" id="4170890">c</span><span class="op" id="4170891">.</span><span class="ident" id="4170892">in</span><span class="op" id="4170894">.</span><span class="ident" id="4170895">setErrorLocked</span><span class="op" id="4170909">(</span><span class="ident" id="4170910">c</span><span class="op" id="4170911">.</span><span class="ident" id="4170912">sendAlert</span><span class="op" id="4170921">(</span><span class="ident" id="4170922">alertNoRenegotiation</span><span class="op" id="4170942">)</span><span class="op" id="4170943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170951">c</span><span class="op" id="4170952">.</span><span class="ident" id="4170953">hand</span><span class="op" id="4170957">.</span><span class="ident" id="4170958">Write</span><span class="op" id="4170963">(</span><span class="ident" id="4170964">data</span><span class="op" id="4170968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170975">if</span>&nbsp;<span class="ident" id="4170978">b</span>&nbsp;<span class="op" id="4170980">!=</span>&nbsp;<span class="ident" id="4170983">nil</span>&nbsp;<span class="op" id="4170987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170991">c</span><span class="op" id="4170992">.</span><span class="ident" id="4170993">in</span><span class="op" id="4170995">.</span><span class="ident" id="4170996">freeBlock</span><span class="op" id="4171005">(</span><span class="ident" id="4171006">b</span><span class="op" id="4171007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171013">return</span>&nbsp;<span class="ident" id="4171020">c</span><span class="op" id="4171021">.</span><span class="ident" id="4171022">in</span><span class="op" id="4171024">.</span><span class="ident" id="4171025">err</span><br>
<span class="lineno"></span><span class="op" id="4171029">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="4171032">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="4171072">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4171093">func</span>&nbsp;<span class="op" id="4171098">(</span><span class="ident" id="4171099">c</span>&nbsp;<span class="op" id="4171101">*</span><span class="ident" id="4171102">Conn</span><span class="op" id="4171106">)</span>&nbsp;<span class="ident" id="4171108">sendAlertLocked</span><span class="op" id="4171123">(</span><span class="ident" id="4171124">err</span>&nbsp;<span class="ident" id="4171128">alert</span><span class="op" id="4171133">)</span>&nbsp;<span class="builtintype" id="4171135">error</span>&nbsp;<span class="op" id="4171141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171144">switch</span>&nbsp;<span class="ident" id="4171151">err</span>&nbsp;<span class="op" id="4171155">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171158">case</span>&nbsp;<span class="ident" id="4171163">alertNoRenegotiation</span><span class="op" id="4171183">,</span>&nbsp;<span class="ident" id="4171185">alertCloseNotify</span><span class="op" id="4171201">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171205">c</span><span class="op" id="4171206">.</span><span class="ident" id="4171207">tmp</span><span class="op" id="4171210">[</span><span class="num" id="4171211">0</span><span class="op" id="4171212">]</span>&nbsp;<span class="op" id="4171214">=</span>&nbsp;<span class="ident" id="4171216">alertLevelWarning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171235">default</span><span class="op" id="4171242">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171246">c</span><span class="op" id="4171247">.</span><span class="ident" id="4171248">tmp</span><span class="op" id="4171251">[</span><span class="num" id="4171252">0</span><span class="op" id="4171253">]</span>&nbsp;<span class="op" id="4171255">=</span>&nbsp;<span class="ident" id="4171257">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171274">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171277">c</span><span class="op" id="4171278">.</span><span class="ident" id="4171279">tmp</span><span class="op" id="4171282">[</span><span class="num" id="4171283">1</span><span class="op" id="4171284">]</span>&nbsp;<span class="op" id="4171286">=</span>&nbsp;<span class="builtintype" id="4171288">byte</span><span class="op" id="4171292">(</span><span class="ident" id="4171293">err</span><span class="op" id="4171296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171299">c</span><span class="op" id="4171300">.</span><span class="ident" id="4171301">writeRecord</span><span class="op" id="4171312">(</span><span class="ident" id="4171313">recordTypeAlert</span><span class="op" id="4171328">,</span>&nbsp;<span class="ident" id="4171330">c</span><span class="op" id="4171331">.</span><span class="ident" id="4171332">tmp</span><span class="op" id="4171335">[</span><span class="num" id="4171336">0</span><span class="op" id="4171337">:</span><span class="num" id="4171338">2</span><span class="op" id="4171339">]</span><span class="op" id="4171340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171343">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171404">if</span>&nbsp;<span class="ident" id="4171407">err</span>&nbsp;<span class="op" id="4171411">!=</span>&nbsp;<span class="ident" id="4171414">alertCloseNotify</span>&nbsp;<span class="op" id="4171431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171435">return</span>&nbsp;<span class="ident" id="4171442">c</span><span class="op" id="4171443">.</span><span class="ident" id="4171444">out</span><span class="op" id="4171447">.</span><span class="ident" id="4171448">setErrorLocked</span><span class="op" id="4171462">(</span><span class="op" id="4171463">&amp;</span><span class="ident" id="4171464">net</span><span class="op" id="4171467">.</span><span class="ident" id="4171468">OpError</span><span class="op" id="4171475">{</span><span class="ident" id="4171476">Op</span><span class="op" id="4171478">:</span>&nbsp;<span class="string" id="4171480">&#34;local&nbsp;error&#34;</span><span class="op" id="4171493">,</span>&nbsp;<span class="ident" id="4171495">Err</span><span class="op" id="4171498">:</span>&nbsp;<span class="ident" id="4171500">err</span><span class="op" id="4171503">}</span><span class="op" id="4171504">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171510">return</span>&nbsp;<span class="ident" id="4171517">nil</span><br>
<span class="lineno"></span><span class="op" id="4171521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4171524">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="4171564">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="4171584">func</span>&nbsp;<span class="op" id="4171589">(</span><span class="ident" id="4171590">c</span>&nbsp;<span class="op" id="4171592">*</span><span class="ident" id="4171593">Conn</span><span class="op" id="4171597">)</span>&nbsp;<span class="ident" id="4171599">sendAlert</span><span class="op" id="4171608">(</span><span class="ident" id="4171609">err</span>&nbsp;<span class="ident" id="4171613">alert</span><span class="op" id="4171618">)</span>&nbsp;<span class="builtintype" id="4171620">error</span>&nbsp;<span class="op" id="4171626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171629">c</span><span class="op" id="4171630">.</span><span class="ident" id="4171631">out</span><span class="op" id="4171634">.</span><span class="ident" id="4171635">Lock</span><span class="op" id="4171639">(</span><span class="op" id="4171640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171643">defer</span>&nbsp;<span class="ident" id="4171649">c</span><span class="op" id="4171650">.</span><span class="ident" id="4171651">out</span><span class="op" id="4171654">.</span><span class="ident" id="4171655">Unlock</span><span class="op" id="4171661">(</span><span class="op" id="4171662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171665">return</span>&nbsp;<span class="ident" id="4171672">c</span><span class="op" id="4171673">.</span><span class="ident" id="4171674">sendAlertLocked</span><span class="op" id="4171689">(</span><span class="ident" id="4171690">err</span><span class="op" id="4171693">)</span><br>
<span class="lineno">690</span><span class="op" id="4171695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4171698">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="4171765">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4171822">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="4171843">func</span>&nbsp;<span class="op" id="4171848">(</span><span class="ident" id="4171849">c</span>&nbsp;<span class="op" id="4171851">*</span><span class="ident" id="4171852">Conn</span><span class="op" id="4171856">)</span>&nbsp;<span class="ident" id="4171858">writeRecord</span><span class="op" id="4171869">(</span><span class="ident" id="4171870">typ</span>&nbsp;<span class="ident" id="4171874">recordType</span><span class="op" id="4171884">,</span>&nbsp;<span class="ident" id="4171886">data</span>&nbsp;<span class="op" id="4171891">[</span><span class="op" id="4171892">]</span><span class="builtintype" id="4171893">byte</span><span class="op" id="4171897">)</span>&nbsp;<span class="op" id="4171899">(</span><span class="ident" id="4171900">n</span>&nbsp;<span class="builtintype" id="4171902">int</span><span class="op" id="4171905">,</span>&nbsp;<span class="ident" id="4171907">err</span>&nbsp;<span class="builtintype" id="4171911">error</span><span class="op" id="4171916">)</span>&nbsp;<span class="op" id="4171918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171921">b</span>&nbsp;<span class="op" id="4171923">:=</span>&nbsp;<span class="ident" id="4171926">c</span><span class="op" id="4171927">.</span><span class="ident" id="4171928">out</span><span class="op" id="4171931">.</span><span class="ident" id="4171932">newBlock</span><span class="op" id="4171940">(</span><span class="op" id="4171941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171944">for</span>&nbsp;<span class="builtinfunc" id="4171948">len</span><span class="op" id="4171951">(</span><span class="ident" id="4171952">data</span><span class="op" id="4171956">)</span>&nbsp;<span class="op" id="4171958">&gt;</span>&nbsp;<span class="num" id="4171960">0</span>&nbsp;<span class="op" id="4171962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171966">m</span>&nbsp;<span class="op" id="4171968">:=</span>&nbsp;<span class="builtinfunc" id="4171971">len</span><span class="op" id="4171974">(</span><span class="ident" id="4171975">data</span><span class="op" id="4171979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171983">if</span>&nbsp;<span class="ident" id="4171986">m</span>&nbsp;<span class="op" id="4171988">&gt;</span>&nbsp;<span class="ident" id="4171990">maxPlaintext</span>&nbsp;<span class="op" id="4172003">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172008">m</span>&nbsp;<span class="op" id="4172010">=</span>&nbsp;<span class="ident" id="4172012">maxPlaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172031">explicitIVLen</span>&nbsp;<span class="op" id="4172045">:=</span>&nbsp;<span class="num" id="4172048">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172052">explicitIVIsSeq</span>&nbsp;<span class="op" id="4172068">:=</span>&nbsp;<span class="builtintype" id="4172071">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172080">var</span>&nbsp;<span class="ident" id="4172084">cbc</span>&nbsp;<span class="ident" id="4172088">cbcMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172098">if</span>&nbsp;<span class="ident" id="4172101">c</span><span class="op" id="4172102">.</span><span class="ident" id="4172103">out</span><span class="op" id="4172106">.</span><span class="ident" id="4172107">version</span>&nbsp;<span class="op" id="4172115">&gt;=</span>&nbsp;<span class="ident" id="4172118">VersionTLS11</span>&nbsp;<span class="op" id="4172131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172136">var</span>&nbsp;<span class="ident" id="4172140">ok</span>&nbsp;<span class="builtintype" id="4172143">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172151">if</span>&nbsp;<span class="ident" id="4172154">cbc</span><span class="op" id="4172157">,</span>&nbsp;<span class="ident" id="4172159">ok</span>&nbsp;<span class="op" id="4172162">=</span>&nbsp;<span class="ident" id="4172164">c</span><span class="op" id="4172165">.</span><span class="ident" id="4172166">out</span><span class="op" id="4172169">.</span><span class="ident" id="4172170">cipher</span><span class="op" id="4172176">.</span><span class="op" id="4172177">(</span><span class="ident" id="4172178">cbcMode</span><span class="op" id="4172185">)</span><span class="op" id="4172186">;</span>&nbsp;<span class="ident" id="4172188">ok</span>&nbsp;<span class="op" id="4172191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172197">explicitIVLen</span>&nbsp;<span class="op" id="4172211">=</span>&nbsp;<span class="ident" id="4172213">cbc</span><span class="op" id="4172216">.</span><span class="ident" id="4172217">BlockSize</span><span class="op" id="4172226">(</span><span class="op" id="4172227">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172240">if</span>&nbsp;<span class="ident" id="4172243">explicitIVLen</span>&nbsp;<span class="op" id="4172257">==</span>&nbsp;<span class="num" id="4172260">0</span>&nbsp;<span class="op" id="4172262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172267">if</span>&nbsp;<span class="ident" id="4172270">_</span><span class="op" id="4172271">,</span>&nbsp;<span class="ident" id="4172273">ok</span>&nbsp;<span class="op" id="4172276">:=</span>&nbsp;<span class="ident" id="4172279">c</span><span class="op" id="4172280">.</span><span class="ident" id="4172281">out</span><span class="op" id="4172284">.</span><span class="ident" id="4172285">cipher</span><span class="op" id="4172291">.</span><span class="op" id="4172292">(</span><span class="ident" id="4172293">cipher</span><span class="op" id="4172299">.</span><span class="ident" id="4172300">AEAD</span><span class="op" id="4172304">)</span><span class="op" id="4172305">;</span>&nbsp;<span class="ident" id="4172307">ok</span>&nbsp;<span class="op" id="4172310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172316">explicitIVLen</span>&nbsp;<span class="op" id="4172330">=</span>&nbsp;<span class="num" id="4172332">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172338">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172384">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172431">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172481">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172528">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172579">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172600">explicitIVIsSeq</span>&nbsp;<span class="op" id="4172616">=</span>&nbsp;<span class="builtintype" id="4172618">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172634">b</span><span class="op" id="4172635">.</span><span class="ident" id="4172636">resize</span><span class="op" id="4172642">(</span><span class="ident" id="4172643">recordHeaderLen</span>&nbsp;<span class="op" id="4172659">+</span>&nbsp;<span class="ident" id="4172661">explicitIVLen</span>&nbsp;<span class="op" id="4172675">+</span>&nbsp;<span class="ident" id="4172677">m</span><span class="op" id="4172678">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172682">b</span><span class="op" id="4172683">.</span><span class="ident" id="4172684">data</span><span class="op" id="4172688">[</span><span class="num" id="4172689">0</span><span class="op" id="4172690">]</span>&nbsp;<span class="op" id="4172692">=</span>&nbsp;<span class="builtintype" id="4172694">byte</span><span class="op" id="4172698">(</span><span class="ident" id="4172699">typ</span><span class="op" id="4172702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172706">vers</span>&nbsp;<span class="op" id="4172711">:=</span>&nbsp;<span class="ident" id="4172714">c</span><span class="op" id="4172715">.</span><span class="ident" id="4172716">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172723">if</span>&nbsp;<span class="ident" id="4172726">vers</span>&nbsp;<span class="op" id="4172731">==</span>&nbsp;<span class="num" id="4172734">0</span>&nbsp;<span class="op" id="4172736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172741">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172794">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172850">vers</span>&nbsp;<span class="op" id="4172855">=</span>&nbsp;<span class="ident" id="4172857">VersionTLS10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172876">b</span><span class="op" id="4172877">.</span><span class="ident" id="4172878">data</span><span class="op" id="4172882">[</span><span class="num" id="4172883">1</span><span class="op" id="4172884">]</span>&nbsp;<span class="op" id="4172886">=</span>&nbsp;<span class="builtintype" id="4172888">byte</span><span class="op" id="4172892">(</span><span class="ident" id="4172893">vers</span>&nbsp;<span class="op" id="4172898">&gt;&gt;</span>&nbsp;<span class="num" id="4172901">8</span><span class="op" id="4172902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172906">b</span><span class="op" id="4172907">.</span><span class="ident" id="4172908">data</span><span class="op" id="4172912">[</span><span class="num" id="4172913">2</span><span class="op" id="4172914">]</span>&nbsp;<span class="op" id="4172916">=</span>&nbsp;<span class="builtintype" id="4172918">byte</span><span class="op" id="4172922">(</span><span class="ident" id="4172923">vers</span><span class="op" id="4172927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172931">b</span><span class="op" id="4172932">.</span><span class="ident" id="4172933">data</span><span class="op" id="4172937">[</span><span class="num" id="4172938">3</span><span class="op" id="4172939">]</span>&nbsp;<span class="op" id="4172941">=</span>&nbsp;<span class="builtintype" id="4172943">byte</span><span class="op" id="4172947">(</span><span class="ident" id="4172948">m</span>&nbsp;<span class="op" id="4172950">&gt;&gt;</span>&nbsp;<span class="num" id="4172953">8</span><span class="op" id="4172954">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172958">b</span><span class="op" id="4172959">.</span><span class="ident" id="4172960">data</span><span class="op" id="4172964">[</span><span class="num" id="4172965">4</span><span class="op" id="4172966">]</span>&nbsp;<span class="op" id="4172968">=</span>&nbsp;<span class="builtintype" id="4172970">byte</span><span class="op" id="4172974">(</span><span class="ident" id="4172975">m</span><span class="op" id="4172976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172980">if</span>&nbsp;<span class="ident" id="4172983">explicitIVLen</span>&nbsp;<span class="op" id="4172997">&gt;</span>&nbsp;<span class="num" id="4172999">0</span>&nbsp;<span class="op" id="4173001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173006">explicitIV</span>&nbsp;<span class="op" id="4173017">:=</span>&nbsp;<span class="ident" id="4173020">b</span><span class="op" id="4173021">.</span><span class="ident" id="4173022">data</span><span class="op" id="4173026">[</span><span class="ident" id="4173027">recordHeaderLen</span>&nbsp;<span class="op" id="4173043">:</span>&nbsp;<span class="ident" id="4173045">recordHeaderLen</span><span class="op" id="4173060">+</span><span class="ident" id="4173061">explicitIVLen</span><span class="op" id="4173074">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173079">if</span>&nbsp;<span class="ident" id="4173082">explicitIVIsSeq</span>&nbsp;<span class="op" id="4173098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4173104">copy</span><span class="op" id="4173108">(</span><span class="ident" id="4173109">explicitIV</span><span class="op" id="4173119">,</span>&nbsp;<span class="ident" id="4173121">c</span><span class="op" id="4173122">.</span><span class="ident" id="4173123">out</span><span class="op" id="4173126">.</span><span class="ident" id="4173127">seq</span><span class="op" id="4173130">[</span><span class="op" id="4173131">:</span><span class="op" id="4173132">]</span><span class="op" id="4173133">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173138">}</span>&nbsp;<span class="keyword" id="4173140">else</span>&nbsp;<span class="op" id="4173145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173151">if</span>&nbsp;<span class="ident" id="4173154">_</span><span class="op" id="4173155">,</span>&nbsp;<span class="ident" id="4173157">err</span>&nbsp;<span class="op" id="4173161">=</span>&nbsp;<span class="ident" id="4173163">io</span><span class="op" id="4173165">.</span><span class="ident" id="4173166">ReadFull</span><span class="op" id="4173174">(</span><span class="ident" id="4173175">c</span><span class="op" id="4173176">.</span><span class="ident" id="4173177">config</span><span class="op" id="4173183">.</span><span class="ident" id="4173184">rand</span><span class="op" id="4173188">(</span><span class="op" id="4173189">)</span><span class="op" id="4173190">,</span>&nbsp;<span class="ident" id="4173192">explicitIV</span><span class="op" id="4173202">)</span><span class="op" id="4173203">;</span>&nbsp;<span class="ident" id="4173205">err</span>&nbsp;<span class="op" id="4173209">!=</span>&nbsp;<span class="ident" id="4173212">nil</span>&nbsp;<span class="op" id="4173216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173223">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173238">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4173246">copy</span><span class="op" id="4173250">(</span><span class="ident" id="4173251">b</span><span class="op" id="4173252">.</span><span class="ident" id="4173253">data</span><span class="op" id="4173257">[</span><span class="ident" id="4173258">recordHeaderLen</span><span class="op" id="4173273">+</span><span class="ident" id="4173274">explicitIVLen</span><span class="op" id="4173287">:</span><span class="op" id="4173288">]</span><span class="op" id="4173289">,</span>&nbsp;<span class="ident" id="4173291">data</span><span class="op" id="4173295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173299">c</span><span class="op" id="4173300">.</span><span class="ident" id="4173301">out</span><span class="op" id="4173304">.</span><span class="ident" id="4173305">encrypt</span><span class="op" id="4173312">(</span><span class="ident" id="4173313">b</span><span class="op" id="4173314">,</span>&nbsp;<span class="ident" id="4173316">explicitIVLen</span><span class="op" id="4173329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173333">_</span><span class="op" id="4173334">,</span>&nbsp;<span class="ident" id="4173336">err</span>&nbsp;<span class="op" id="4173340">=</span>&nbsp;<span class="ident" id="4173342">c</span><span class="op" id="4173343">.</span><span class="ident" id="4173344">conn</span><span class="op" id="4173348">.</span><span class="ident" id="4173349">Write</span><span class="op" id="4173354">(</span><span class="ident" id="4173355">b</span><span class="op" id="4173356">.</span><span class="ident" id="4173357">data</span><span class="op" id="4173361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173365">if</span>&nbsp;<span class="ident" id="4173368">err</span>&nbsp;<span class="op" id="4173372">!=</span>&nbsp;<span class="ident" id="4173375">nil</span>&nbsp;<span class="op" id="4173379">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173384">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173396">n</span>&nbsp;<span class="op" id="4173398">+=</span>&nbsp;<span class="ident" id="4173401">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173405">data</span>&nbsp;<span class="op" id="4173410">=</span>&nbsp;<span class="ident" id="4173412">data</span><span class="op" id="4173416">[</span><span class="ident" id="4173417">m</span><span class="op" id="4173418">:</span><span class="op" id="4173419">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173422">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173425">c</span><span class="op" id="4173426">.</span><span class="ident" id="4173427">out</span><span class="op" id="4173430">.</span><span class="ident" id="4173431">freeBlock</span><span class="op" id="4173440">(</span><span class="ident" id="4173441">b</span><span class="op" id="4173442">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173446">if</span>&nbsp;<span class="ident" id="4173449">typ</span>&nbsp;<span class="op" id="4173453">==</span>&nbsp;<span class="ident" id="4173456">recordTypeChangeCipherSpec</span>&nbsp;<span class="op" id="4173483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173487">err</span>&nbsp;<span class="op" id="4173491">=</span>&nbsp;<span class="ident" id="4173493">c</span><span class="op" id="4173494">.</span><span class="ident" id="4173495">out</span><span class="op" id="4173498">.</span><span class="ident" id="4173499">changeCipherSpec</span><span class="op" id="4173515">(</span><span class="op" id="4173516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173520">if</span>&nbsp;<span class="ident" id="4173523">err</span>&nbsp;<span class="op" id="4173527">!=</span>&nbsp;<span class="ident" id="4173530">nil</span>&nbsp;<span class="op" id="4173534">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4173539">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4173577">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173620">c</span><span class="op" id="4173621">.</span><span class="ident" id="4173622">tmp</span><span class="op" id="4173625">[</span><span class="num" id="4173626">0</span><span class="op" id="4173627">]</span>&nbsp;<span class="op" id="4173629">=</span>&nbsp;<span class="ident" id="4173631">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173650">c</span><span class="op" id="4173651">.</span><span class="ident" id="4173652">tmp</span><span class="op" id="4173655">[</span><span class="num" id="4173656">1</span><span class="op" id="4173657">]</span>&nbsp;<span class="op" id="4173659">=</span>&nbsp;<span class="builtintype" id="4173661">byte</span><span class="op" id="4173665">(</span><span class="ident" id="4173666">err</span><span class="op" id="4173669">.</span><span class="op" id="4173670">(</span><span class="ident" id="4173671">alert</span><span class="op" id="4173676">)</span><span class="op" id="4173677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173682">c</span><span class="op" id="4173683">.</span><span class="ident" id="4173684">writeRecord</span><span class="op" id="4173695">(</span><span class="ident" id="4173696">recordTypeAlert</span><span class="op" id="4173711">,</span>&nbsp;<span class="ident" id="4173713">c</span><span class="op" id="4173714">.</span><span class="ident" id="4173715">tmp</span><span class="op" id="4173718">[</span><span class="num" id="4173719">0</span><span class="op" id="4173720">:</span><span class="num" id="4173721">2</span><span class="op" id="4173722">]</span><span class="op" id="4173723">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173728">return</span>&nbsp;<span class="ident" id="4173735">n</span><span class="op" id="4173736">,</span>&nbsp;<span class="ident" id="4173738">c</span><span class="op" id="4173739">.</span><span class="ident" id="4173740">out</span><span class="op" id="4173743">.</span><span class="ident" id="4173744">setErrorLocked</span><span class="op" id="4173758">(</span><span class="op" id="4173759">&amp;</span><span class="ident" id="4173760">net</span><span class="op" id="4173763">.</span><span class="ident" id="4173764">OpError</span><span class="op" id="4173771">{</span><span class="ident" id="4173772">Op</span><span class="op" id="4173774">:</span>&nbsp;<span class="string" id="4173776">&#34;local&nbsp;error&#34;</span><span class="op" id="4173789">,</span>&nbsp;<span class="ident" id="4173791">Err</span><span class="op" id="4173794">:</span>&nbsp;<span class="ident" id="4173796">err</span><span class="op" id="4173799">}</span><span class="op" id="4173800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173810">return</span><br>
<span class="lineno"></span><span class="op" id="4173817">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="4173820">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4173875">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="4173896">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4173932">func</span>&nbsp;<span class="op" id="4173937">(</span><span class="ident" id="4173938">c</span>&nbsp;<span class="op" id="4173940">*</span><span class="ident" id="4173941">Conn</span><span class="op" id="4173945">)</span>&nbsp;<span class="ident" id="4173947">readHandshake</span><span class="op" id="4173960">(</span><span class="op" id="4173961">)</span>&nbsp;<span class="op" id="4173963">(</span><span class="keyword" id="4173964">interface</span><span class="op" id="4173973">{</span><span class="op" id="4173974">}</span><span class="op" id="4173975">,</span>&nbsp;<span class="builtintype" id="4173977">error</span><span class="op" id="4173982">)</span>&nbsp;<span class="op" id="4173984">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173987">for</span>&nbsp;<span class="ident" id="4173991">c</span><span class="op" id="4173992">.</span><span class="ident" id="4173993">hand</span><span class="op" id="4173997">.</span><span class="ident" id="4173998">Len</span><span class="op" id="4174001">(</span><span class="op" id="4174002">)</span>&nbsp;<span class="op" id="4174004">&lt;</span>&nbsp;<span class="num" id="4174006">4</span>&nbsp;<span class="op" id="4174008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174012">if</span>&nbsp;<span class="ident" id="4174015">err</span>&nbsp;<span class="op" id="4174019">:=</span>&nbsp;<span class="ident" id="4174022">c</span><span class="op" id="4174023">.</span><span class="ident" id="4174024">in</span><span class="op" id="4174026">.</span><span class="ident" id="4174027">err</span><span class="op" id="4174030">;</span>&nbsp;<span class="ident" id="4174032">err</span>&nbsp;<span class="op" id="4174036">!=</span>&nbsp;<span class="ident" id="4174039">nil</span>&nbsp;<span class="op" id="4174043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174048">return</span>&nbsp;<span class="ident" id="4174055">nil</span><span class="op" id="4174058">,</span>&nbsp;<span class="ident" id="4174060">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174070">if</span>&nbsp;<span class="ident" id="4174073">err</span>&nbsp;<span class="op" id="4174077">:=</span>&nbsp;<span class="ident" id="4174080">c</span><span class="op" id="4174081">.</span><span class="ident" id="4174082">readRecord</span><span class="op" id="4174092">(</span><span class="ident" id="4174093">recordTypeHandshake</span><span class="op" id="4174112">)</span><span class="op" id="4174113">;</span>&nbsp;<span class="ident" id="4174115">err</span>&nbsp;<span class="op" id="4174119">!=</span>&nbsp;<span class="ident" id="4174122">nil</span>&nbsp;<span class="op" id="4174126">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174131">return</span>&nbsp;<span class="ident" id="4174138">nil</span><span class="op" id="4174141">,</span>&nbsp;<span class="ident" id="4174143">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174156">data</span>&nbsp;<span class="op" id="4174161">:=</span>&nbsp;<span class="ident" id="4174164">c</span><span class="op" id="4174165">.</span><span class="ident" id="4174166">hand</span><span class="op" id="4174170">.</span><span class="ident" id="4174171">Bytes</span><span class="op" id="4174176">(</span><span class="op" id="4174177">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174180">n</span>&nbsp;<span class="op" id="4174182">:=</span>&nbsp;<span class="builtintype" id="4174185">int</span><span class="op" id="4174188">(</span><span class="ident" id="4174189">data</span><span class="op" id="4174193">[</span><span class="num" id="4174194">1</span><span class="op" id="4174195">]</span><span class="op" id="4174196">)</span><span class="op" id="4174197">&lt;&lt;</span><span class="num" id="4174199">16</span>&nbsp;<span class="op" id="4174202">|</span>&nbsp;<span class="builtintype" id="4174204">int</span><span class="op" id="4174207">(</span><span class="ident" id="4174208">data</span><span class="op" id="4174212">[</span><span class="num" id="4174213">2</span><span class="op" id="4174214">]</span><span class="op" id="4174215">)</span><span class="op" id="4174216">&lt;&lt;</span><span class="num" id="4174218">8</span>&nbsp;<span class="op" id="4174220">|</span>&nbsp;<span class="builtintype" id="4174222">int</span><span class="op" id="4174225">(</span><span class="ident" id="4174226">data</span><span class="op" id="4174230">[</span><span class="num" id="4174231">3</span><span class="op" id="4174232">]</span><span class="op" id="4174233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174236">if</span>&nbsp;<span class="ident" id="4174239">n</span>&nbsp;<span class="op" id="4174241">&gt;</span>&nbsp;<span class="ident" id="4174243">maxHandshake</span>&nbsp;<span class="op" id="4174256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174260">return</span>&nbsp;<span class="ident" id="4174267">nil</span><span class="op" id="4174270">,</span>&nbsp;<span class="ident" id="4174272">c</span><span class="op" id="4174273">.</span><span class="ident" id="4174274">in</span><span class="op" id="4174276">.</span><span class="ident" id="4174277">setErrorLocked</span><span class="op" id="4174291">(</span><span class="ident" id="4174292">c</span><span class="op" id="4174293">.</span><span class="ident" id="4174294">sendAlert</span><span class="op" id="4174303">(</span><span class="ident" id="4174304">alertInternalError</span><span class="op" id="4174322">)</span><span class="op" id="4174323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174329">for</span>&nbsp;<span class="ident" id="4174333">c</span><span class="op" id="4174334">.</span><span class="ident" id="4174335">hand</span><span class="op" id="4174339">.</span><span class="ident" id="4174340">Len</span><span class="op" id="4174343">(</span><span class="op" id="4174344">)</span>&nbsp;<span class="op" id="4174346">&lt;</span>&nbsp;<span class="num" id="4174348">4</span><span class="op" id="4174349">+</span><span class="ident" id="4174350">n</span>&nbsp;<span class="op" id="4174352">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174356">if</span>&nbsp;<span class="ident" id="4174359">err</span>&nbsp;<span class="op" id="4174363">:=</span>&nbsp;<span class="ident" id="4174366">c</span><span class="op" id="4174367">.</span><span class="ident" id="4174368">in</span><span class="op" id="4174370">.</span><span class="ident" id="4174371">err</span><span class="op" id="4174374">;</span>&nbsp;<span class="ident" id="4174376">err</span>&nbsp;<span class="op" id="4174380">!=</span>&nbsp;<span class="ident" id="4174383">nil</span>&nbsp;<span class="op" id="4174387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174392">return</span>&nbsp;<span class="ident" id="4174399">nil</span><span class="op" id="4174402">,</span>&nbsp;<span class="ident" id="4174404">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174414">if</span>&nbsp;<span class="ident" id="4174417">err</span>&nbsp;<span class="op" id="4174421">:=</span>&nbsp;<span class="ident" id="4174424">c</span><span class="op" id="4174425">.</span><span class="ident" id="4174426">readRecord</span><span class="op" id="4174436">(</span><span class="ident" id="4174437">recordTypeHandshake</span><span class="op" id="4174456">)</span><span class="op" id="4174457">;</span>&nbsp;<span class="ident" id="4174459">err</span>&nbsp;<span class="op" id="4174463">!=</span>&nbsp;<span class="ident" id="4174466">nil</span>&nbsp;<span class="op" id="4174470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174475">return</span>&nbsp;<span class="ident" id="4174482">nil</span><span class="op" id="4174485">,</span>&nbsp;<span class="ident" id="4174487">err</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174499">data</span>&nbsp;<span class="op" id="4174504">=</span>&nbsp;<span class="ident" id="4174506">c</span><span class="op" id="4174507">.</span><span class="ident" id="4174508">hand</span><span class="op" id="4174512">.</span><span class="ident" id="4174513">Next</span><span class="op" id="4174517">(</span><span class="num" id="4174518">4</span>&nbsp;<span class="op" id="4174520">+</span>&nbsp;<span class="ident" id="4174522">n</span><span class="op" id="4174523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174526">var</span>&nbsp;<span class="ident" id="4174530">m</span>&nbsp;<span class="ident" id="4174532">handshakeMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174550">switch</span>&nbsp;<span class="ident" id="4174557">data</span><span class="op" id="4174561">[</span><span class="num" id="4174562">0</span><span class="op" id="4174563">]</span>&nbsp;<span class="op" id="4174565">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174568">case</span>&nbsp;<span class="ident" id="4174573">typeClientHello</span><span class="op" id="4174588">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174592">m</span>&nbsp;<span class="op" id="4174594">=</span>&nbsp;<span class="builtinfunc" id="4174596">new</span><span class="op" id="4174599">(</span><span class="ident" id="4174600">clientHelloMsg</span><span class="op" id="4174614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174617">case</span>&nbsp;<span class="ident" id="4174622">typeServerHello</span><span class="op" id="4174637">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174641">m</span>&nbsp;<span class="op" id="4174643">=</span>&nbsp;<span class="builtinfunc" id="4174645">new</span><span class="op" id="4174648">(</span><span class="ident" id="4174649">serverHelloMsg</span><span class="op" id="4174663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174666">case</span>&nbsp;<span class="ident" id="4174671">typeNewSessionTicket</span><span class="op" id="4174691">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174695">m</span>&nbsp;<span class="op" id="4174697">=</span>&nbsp;<span class="builtinfunc" id="4174699">new</span><span class="op" id="4174702">(</span><span class="ident" id="4174703">newSessionTicketMsg</span><span class="op" id="4174722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174725">case</span>&nbsp;<span class="ident" id="4174730">typeCertificate</span><span class="op" id="4174745">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174749">m</span>&nbsp;<span class="op" id="4174751">=</span>&nbsp;<span class="builtinfunc" id="4174753">new</span><span class="op" id="4174756">(</span><span class="ident" id="4174757">certificateMsg</span><span class="op" id="4174771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174774">case</span>&nbsp;<span class="ident" id="4174779">typeCertificateRequest</span><span class="op" id="4174801">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174805">m</span>&nbsp;<span class="op" id="4174807">=</span>&nbsp;<span class="op" id="4174809">&amp;</span><span class="ident" id="4174810">certificateRequestMsg</span><span class="op" id="4174831">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174836">hasSignatureAndHash</span><span class="op" id="4174855">:</span>&nbsp;<span class="ident" id="4174857">c</span><span class="op" id="4174858">.</span><span class="ident" id="4174859">vers</span>&nbsp;<span class="op" id="4174864">&gt;=</span>&nbsp;<span class="ident" id="4174867">VersionTLS12</span><span class="op" id="4174879">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174886">case</span>&nbsp;<span class="ident" id="4174891">typeCertificateStatus</span><span class="op" id="4174912">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174916">m</span>&nbsp;<span class="op" id="4174918">=</span>&nbsp;<span class="builtinfunc" id="4174920">new</span><span class="op" id="4174923">(</span><span class="ident" id="4174924">certificateStatusMsg</span><span class="op" id="4174944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174947">case</span>&nbsp;<span class="ident" id="4174952">typeServerKeyExchange</span><span class="op" id="4174973">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174977">m</span>&nbsp;<span class="op" id="4174979">=</span>&nbsp;<span class="builtinfunc" id="4174981">new</span><span class="op" id="4174984">(</span><span class="ident" id="4174985">serverKeyExchangeMsg</span><span class="op" id="4175005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175008">case</span>&nbsp;<span class="ident" id="4175013">typeServerHelloDone</span><span class="op" id="4175032">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175036">m</span>&nbsp;<span class="op" id="4175038">=</span>&nbsp;<span class="builtinfunc" id="4175040">new</span><span class="op" id="4175043">(</span><span class="ident" id="4175044">serverHelloDoneMsg</span><span class="op" id="4175062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175065">case</span>&nbsp;<span class="ident" id="4175070">typeClientKeyExchange</span><span class="op" id="4175091">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175095">m</span>&nbsp;<span class="op" id="4175097">=</span>&nbsp;<span class="builtinfunc" id="4175099">new</span><span class="op" id="4175102">(</span><span class="ident" id="4175103">clientKeyExchangeMsg</span><span class="op" id="4175123">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175126">case</span>&nbsp;<span class="ident" id="4175131">typeCertificateVerify</span><span class="op" id="4175152">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175156">m</span>&nbsp;<span class="op" id="4175158">=</span>&nbsp;<span class="op" id="4175160">&amp;</span><span class="ident" id="4175161">certificateVerifyMsg</span><span class="op" id="4175181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175186">hasSignatureAndHash</span><span class="op" id="4175205">:</span>&nbsp;<span class="ident" id="4175207">c</span><span class="op" id="4175208">.</span><span class="ident" id="4175209">vers</span>&nbsp;<span class="op" id="4175214">&gt;=</span>&nbsp;<span class="ident" id="4175217">VersionTLS12</span><span class="op" id="4175229">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175236">case</span>&nbsp;<span class="ident" id="4175241">typeNextProtocol</span><span class="op" id="4175257">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175261">m</span>&nbsp;<span class="op" id="4175263">=</span>&nbsp;<span class="builtinfunc" id="4175265">new</span><span class="op" id="4175268">(</span><span class="ident" id="4175269">nextProtoMsg</span><span class="op" id="4175281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175284">case</span>&nbsp;<span class="ident" id="4175289">typeFinished</span><span class="op" id="4175301">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175305">m</span>&nbsp;<span class="op" id="4175307">=</span>&nbsp;<span class="builtinfunc" id="4175309">new</span><span class="op" id="4175312">(</span><span class="ident" id="4175313">finishedMsg</span><span class="op" id="4175324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175327">default</span><span class="op" id="4175334">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175338">return</span>&nbsp;<span class="ident" id="4175345">nil</span><span class="op" id="4175348">,</span>&nbsp;<span class="ident" id="4175350">c</span><span class="op" id="4175351">.</span><span class="ident" id="4175352">in</span><span class="op" id="4175354">.</span><span class="ident" id="4175355">setErrorLocked</span><span class="op" id="4175369">(</span><span class="ident" id="4175370">c</span><span class="op" id="4175371">.</span><span class="ident" id="4175372">sendAlert</span><span class="op" id="4175381">(</span><span class="ident" id="4175382">alertUnexpectedMessage</span><span class="op" id="4175404">)</span><span class="op" id="4175405">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4175412">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4175452">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4175502">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175557">data</span>&nbsp;<span class="op" id="4175562">=</span>&nbsp;<span class="builtinfunc" id="4175564">append</span><span class="op" id="4175570">(</span><span class="op" id="4175571">[</span><span class="op" id="4175572">]</span><span class="builtintype" id="4175573">byte</span><span class="op" id="4175577">(</span><span class="ident" id="4175578">nil</span><span class="op" id="4175581">)</span><span class="op" id="4175582">,</span>&nbsp;<span class="ident" id="4175584">data</span><span class="op" id="4175588">...</span><span class="op" id="4175591">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175595">if</span>&nbsp;<span class="op" id="4175598">!</span><span class="ident" id="4175599">m</span><span class="op" id="4175600">.</span><span class="ident" id="4175601">unmarshal</span><span class="op" id="4175610">(</span><span class="ident" id="4175611">data</span><span class="op" id="4175615">)</span>&nbsp;<span class="op" id="4175617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175621">return</span>&nbsp;<span class="ident" id="4175628">nil</span><span class="op" id="4175631">,</span>&nbsp;<span class="ident" id="4175633">c</span><span class="op" id="4175634">.</span><span class="ident" id="4175635">in</span><span class="op" id="4175637">.</span><span class="ident" id="4175638">setErrorLocked</span><span class="op" id="4175652">(</span><span class="ident" id="4175653">c</span><span class="op" id="4175654">.</span><span class="ident" id="4175655">sendAlert</span><span class="op" id="4175664">(</span><span class="ident" id="4175665">alertUnexpectedMessage</span><span class="op" id="4175687">)</span><span class="op" id="4175688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175691">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175694">return</span>&nbsp;<span class="ident" id="4175701">m</span><span class="op" id="4175702">,</span>&nbsp;<span class="ident" id="4175704">nil</span><br>
<span class="lineno"></span><span class="op" id="4175708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4175711">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4175751">func</span>&nbsp;<span class="op" id="4175756">(</span><span class="ident" id="4175757">c</span>&nbsp;<span class="op" id="4175759">*</span><span class="ident" id="4175760">Conn</span><span class="op" id="4175764">)</span>&nbsp;<span class="ident" id="4175766">Write</span><span class="op" id="4175771">(</span><span class="ident" id="4175772">b</span>&nbsp;<span class="op" id="4175774">[</span><span class="op" id="4175775">]</span><span class="builtintype" id="4175776">byte</span><span class="op" id="4175780">)</span>&nbsp;<span class="op" id="4175782">(</span><span class="builtintype" id="4175783">int</span><span class="op" id="4175786">,</span>&nbsp;<span class="builtintype" id="4175788">error</span><span class="op" id="4175793">)</span>&nbsp;<span class="op" id="4175795">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175798">if</span>&nbsp;<span class="ident" id="4175801">err</span>&nbsp;<span class="op" id="4175805">:=</span>&nbsp;<span class="ident" id="4175808">c</span><span class="op" id="4175809">.</span><span class="ident" id="4175810">Handshake</span><span class="op" id="4175819">(</span><span class="op" id="4175820">)</span><span class="op" id="4175821">;</span>&nbsp;<span class="ident" id="4175823">err</span>&nbsp;<span class="op" id="4175827">!=</span>&nbsp;<span class="ident" id="4175830">nil</span>&nbsp;<span class="op" id="4175834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175838">return</span>&nbsp;<span class="num" id="4175845">0</span><span class="op" id="4175846">,</span>&nbsp;<span class="ident" id="4175848">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175857">c</span><span class="op" id="4175858">.</span><span class="ident" id="4175859">out</span><span class="op" id="4175862">.</span><span class="ident" id="4175863">Lock</span><span class="op" id="4175867">(</span><span class="op" id="4175868">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175871">defer</span>&nbsp;<span class="ident" id="4175877">c</span><span class="op" id="4175878">.</span><span class="ident" id="4175879">out</span><span class="op" id="4175882">.</span><span class="ident" id="4175883">Unlock</span><span class="op" id="4175889">(</span><span class="op" id="4175890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175894">if</span>&nbsp;<span class="ident" id="4175897">err</span>&nbsp;<span class="op" id="4175901">:=</span>&nbsp;<span class="ident" id="4175904">c</span><span class="op" id="4175905">.</span><span class="ident" id="4175906">out</span><span class="op" id="4175909">.</span><span class="ident" id="4175910">err</span><span class="op" id="4175913">;</span>&nbsp;<span class="ident" id="4175915">err</span>&nbsp;<span class="op" id="4175919">!=</span>&nbsp;<span class="ident" id="4175922">nil</span>&nbsp;<span class="op" id="4175926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175930">return</span>&nbsp;<span class="num" id="4175937">0</span><span class="op" id="4175938">,</span>&nbsp;<span class="ident" id="4175940">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175945">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175949">if</span>&nbsp;<span class="op" id="4175952">!</span><span class="ident" id="4175953">c</span><span class="op" id="4175954">.</span><span class="ident" id="4175955">handshakeComplete</span>&nbsp;<span class="op" id="4175973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175977">return</span>&nbsp;<span class="num" id="4175984">0</span><span class="op" id="4175985">,</span>&nbsp;<span class="ident" id="4175987">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4176007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4176011">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4176073">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4176138">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4176199">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4176260">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4176264">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4176309">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4176365">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176430">var</span>&nbsp;<span class="ident" id="4176434">m</span>&nbsp;<span class="builtintype" id="4176436">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176441">if</span>&nbsp;<span class="builtinfunc" id="4176444">len</span><span class="op" id="4176447">(</span><span class="ident" id="4176448">b</span><span class="op" id="4176449">)</span>&nbsp;<span class="op" id="4176451">&gt;</span>&nbsp;<span class="num" id="4176453">1</span>&nbsp;<span class="op" id="4176455">&amp;&amp;</span>&nbsp;<span class="ident" id="4176458">c</span><span class="op" id="4176459">.</span><span class="ident" id="4176460">vers</span>&nbsp;<span class="op" id="4176465">&lt;=</span>&nbsp;<span class="ident" id="4176468">VersionTLS10</span>&nbsp;<span class="op" id="4176481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176485">if</span>&nbsp;<span class="ident" id="4176488">_</span><span class="op" id="4176489">,</span>&nbsp;<span class="ident" id="4176491">ok</span>&nbsp;<span class="op" id="4176494">:=</span>&nbsp;<span class="ident" id="4176497">c</span><span class="op" id="4176498">.</span><span class="ident" id="4176499">out</span><span class="op" id="4176502">.</span><span class="ident" id="4176503">cipher</span><span class="op" id="4176509">.</span><span class="op" id="4176510">(</span><span class="ident" id="4176511">cipher</span><span class="op" id="4176517">.</span><span class="ident" id="4176518">BlockMode</span><span class="op" id="4176527">)</span><span class="op" id="4176528">;</span>&nbsp;<span class="ident" id="4176530">ok</span>&nbsp;<span class="op" id="4176533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176538">n</span><span class="op" id="4176539">,</span>&nbsp;<span class="ident" id="4176541">err</span>&nbsp;<span class="op" id="4176545">:=</span>&nbsp;<span class="ident" id="4176548">c</span><span class="op" id="4176549">.</span><span class="ident" id="4176550">writeRecord</span><span class="op" id="4176561">(</span><span class="ident" id="4176562">recordTypeApplicationData</span><span class="op" id="4176587">,</span>&nbsp;<span class="ident" id="4176589">b</span><span class="op" id="4176590">[</span><span class="op" id="4176591">:</span><span class="num" id="4176592">1</span><span class="op" id="4176593">]</span><span class="op" id="4176594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176599">if</span>&nbsp;<span class="ident" id="4176602">err</span>&nbsp;<span class="op" id="4176606">!=</span>&nbsp;<span class="ident" id="4176609">nil</span>&nbsp;<span class="op" id="4176613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176619">return</span>&nbsp;<span class="ident" id="4176626">n</span><span class="op" id="4176627">,</span>&nbsp;<span class="ident" id="4176629">c</span><span class="op" id="4176630">.</span><span class="ident" id="4176631">out</span><span class="op" id="4176634">.</span><span class="ident" id="4176635">setErrorLocked</span><span class="op" id="4176649">(</span><span class="ident" id="4176650">err</span><span class="op" id="4176653">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4176658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176663">m</span><span class="op" id="4176664">,</span>&nbsp;<span class="ident" id="4176666">b</span>&nbsp;<span class="op" id="4176668">=</span>&nbsp;<span class="num" id="4176670">1</span><span class="op" id="4176671">,</span>&nbsp;<span class="ident" id="4176673">b</span><span class="op" id="4176674">[</span><span class="num" id="4176675">1</span><span class="op" id="4176676">:</span><span class="op" id="4176677">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4176681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4176684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176688">n</span><span class="op" id="4176689">,</span>&nbsp;<span class="ident" id="4176691">err</span>&nbsp;<span class="op" id="4176695">:=</span>&nbsp;<span class="ident" id="4176698">c</span><span class="op" id="4176699">.</span><span class="ident" id="4176700">writeRecord</span><span class="op" id="4176711">(</span><span class="ident" id="4176712">recordTypeApplicationData</span><span class="op" id="4176737">,</span>&nbsp;<span class="ident" id="4176739">b</span><span class="op" id="4176740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176743">return</span>&nbsp;<span class="ident" id="4176750">n</span>&nbsp;<span class="op" id="4176752">+</span>&nbsp;<span class="ident" id="4176754">m</span><span class="op" id="4176755">,</span>&nbsp;<span class="ident" id="4176757">c</span><span class="op" id="4176758">.</span><span class="ident" id="4176759">out</span><span class="op" id="4176762">.</span><span class="ident" id="4176763">setErrorLocked</span><span class="op" id="4176777">(</span><span class="ident" id="4176778">err</span><span class="op" id="4176781">)</span><br>
<span class="lineno"></span><span class="op" id="4176783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4176786">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="4176864">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="4176930">func</span>&nbsp;<span class="op" id="4176935">(</span><span class="ident" id="4176936">c</span>&nbsp;<span class="op" id="4176938">*</span><span class="ident" id="4176939">Conn</span><span class="op" id="4176943">)</span>&nbsp;<span class="ident" id="4176945">Read</span><span class="op" id="4176949">(</span><span class="ident" id="4176950">b</span>&nbsp;<span class="op" id="4176952">[</span><span class="op" id="4176953">]</span><span class="builtintype" id="4176954">byte</span><span class="op" id="4176958">)</span>&nbsp;<span class="op" id="4176960">(</span><span class="ident" id="4176961">n</span>&nbsp;<span class="builtintype" id="4176963">int</span><span class="op" id="4176966">,</span>&nbsp;<span class="ident" id="4176968">err</span>&nbsp;<span class="builtintype" id="4176972">error</span><span class="op" id="4176977">)</span>&nbsp;<span class="op" id="4176979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176982">if</span>&nbsp;<span class="ident" id="4176985">err</span>&nbsp;<span class="op" id="4176989">=</span>&nbsp;<span class="ident" id="4176991">c</span><span class="op" id="4176992">.</span><span class="ident" id="4176993">Handshake</span><span class="op" id="4177002">(</span><span class="op" id="4177003">)</span><span class="op" id="4177004">;</span>&nbsp;<span class="ident" id="4177006">err</span>&nbsp;<span class="op" id="4177010">!=</span>&nbsp;<span class="ident" id="4177013">nil</span>&nbsp;<span class="op" id="4177017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177021">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177029">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177032">if</span>&nbsp;<span class="builtinfunc" id="4177035">len</span><span class="op" id="4177038">(</span><span class="ident" id="4177039">b</span><span class="op" id="4177040">)</span>&nbsp;<span class="op" id="4177042">==</span>&nbsp;<span class="num" id="4177045">0</span>&nbsp;<span class="op" id="4177047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177051">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177110">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177163">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177171">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177175">c</span><span class="op" id="4177176">.</span><span class="ident" id="4177177">in</span><span class="op" id="4177179">.</span><span class="ident" id="4177180">Lock</span><span class="op" id="4177184">(</span><span class="op" id="4177185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177188">defer</span>&nbsp;<span class="ident" id="4177194">c</span><span class="op" id="4177195">.</span><span class="ident" id="4177196">in</span><span class="op" id="4177198">.</span><span class="ident" id="4177199">Unlock</span><span class="op" id="4177205">(</span><span class="op" id="4177206">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177210">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177280">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177348">const</span>&nbsp;<span class="ident" id="4177354">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="4177381">=</span>&nbsp;<span class="num" id="4177383">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177388">for</span>&nbsp;<span class="ident" id="4177392">emptyRecordCount</span>&nbsp;<span class="op" id="4177409">:=</span>&nbsp;<span class="num" id="4177412">0</span><span class="op" id="4177413">;</span>&nbsp;<span class="ident" id="4177415">emptyRecordCount</span>&nbsp;<span class="op" id="4177432">&lt;=</span>&nbsp;<span class="ident" id="4177435">maxConsecutiveEmptyRecords</span><span class="op" id="4177461">;</span>&nbsp;<span class="ident" id="4177463">emptyRecordCount</span><span class="op" id="4177479">++</span>&nbsp;<span class="op" id="4177482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177486">for</span>&nbsp;<span class="ident" id="4177490">c</span><span class="op" id="4177491">.</span><span class="ident" id="4177492">input</span>&nbsp;<span class="op" id="4177498">==</span>&nbsp;<span class="ident" id="4177501">nil</span>&nbsp;<span class="op" id="4177505">&amp;&amp;</span>&nbsp;<span class="ident" id="4177508">c</span><span class="op" id="4177509">.</span><span class="ident" id="4177510">in</span><span class="op" id="4177512">.</span><span class="ident" id="4177513">err</span>&nbsp;<span class="op" id="4177517">==</span>&nbsp;<span class="ident" id="4177520">nil</span>&nbsp;<span class="op" id="4177524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177529">if</span>&nbsp;<span class="ident" id="4177532">err</span>&nbsp;<span class="op" id="4177536">:=</span>&nbsp;<span class="ident" id="4177539">c</span><span class="op" id="4177540">.</span><span class="ident" id="4177541">readRecord</span><span class="op" id="4177551">(</span><span class="ident" id="4177552">recordTypeApplicationData</span><span class="op" id="4177577">)</span><span class="op" id="4177578">;</span>&nbsp;<span class="ident" id="4177580">err</span>&nbsp;<span class="op" id="4177584">!=</span>&nbsp;<span class="ident" id="4177587">nil</span>&nbsp;<span class="op" id="4177591">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177597">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177628">return</span>&nbsp;<span class="num" id="4177635">0</span><span class="op" id="4177636">,</span>&nbsp;<span class="ident" id="4177638">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177653">if</span>&nbsp;<span class="ident" id="4177656">err</span>&nbsp;<span class="op" id="4177660">:=</span>&nbsp;<span class="ident" id="4177663">c</span><span class="op" id="4177664">.</span><span class="ident" id="4177665">in</span><span class="op" id="4177667">.</span><span class="ident" id="4177668">err</span><span class="op" id="4177671">;</span>&nbsp;<span class="ident" id="4177673">err</span>&nbsp;<span class="op" id="4177677">!=</span>&nbsp;<span class="ident" id="4177680">nil</span>&nbsp;<span class="op" id="4177684">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177689">return</span>&nbsp;<span class="num" id="4177696">0</span><span class="op" id="4177697">,</span>&nbsp;<span class="ident" id="4177699">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177710">n</span><span class="op" id="4177711">,</span>&nbsp;<span class="ident" id="4177713">err</span>&nbsp;<span class="op" id="4177717">=</span>&nbsp;<span class="ident" id="4177719">c</span><span class="op" id="4177720">.</span><span class="ident" id="4177721">input</span><span class="op" id="4177726">.</span><span class="ident" id="4177727">Read</span><span class="op" id="4177731">(</span><span class="ident" id="4177732">b</span><span class="op" id="4177733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177737">if</span>&nbsp;<span class="ident" id="4177740">c</span><span class="op" id="4177741">.</span><span class="ident" id="4177742">input</span><span class="op" id="4177747">.</span><span class="ident" id="4177748">off</span>&nbsp;<span class="op" id="4177752">&gt;=</span>&nbsp;<span class="builtinfunc" id="4177755">len</span><span class="op" id="4177758">(</span><span class="ident" id="4177759">c</span><span class="op" id="4177760">.</span><span class="ident" id="4177761">input</span><span class="op" id="4177766">.</span><span class="ident" id="4177767">data</span><span class="op" id="4177771">)</span>&nbsp;<span class="op" id="4177773">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177778">c</span><span class="op" id="4177779">.</span><span class="ident" id="4177780">in</span><span class="op" id="4177782">.</span><span class="ident" id="4177783">freeBlock</span><span class="op" id="4177792">(</span><span class="ident" id="4177793">c</span><span class="op" id="4177794">.</span><span class="ident" id="4177795">input</span><span class="op" id="4177800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177805">c</span><span class="op" id="4177806">.</span><span class="ident" id="4177807">input</span>&nbsp;<span class="op" id="4177813">=</span>&nbsp;<span class="ident" id="4177815">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177826">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177883">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177942">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177995">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4178049">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4178102">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4178158">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4178215">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4178265">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4178279">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4178328">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178366">if</span>&nbsp;<span class="ident" id="4178369">ri</span>&nbsp;<span class="op" id="4178372">:=</span>&nbsp;<span class="ident" id="4178375">c</span><span class="op" id="4178376">.</span><span class="ident" id="4178377">rawInput</span><span class="op" id="4178385">;</span>&nbsp;<span class="ident" id="4178387">ri</span>&nbsp;<span class="op" id="4178390">!=</span>&nbsp;<span class="ident" id="4178393">nil</span>&nbsp;<span class="op" id="4178397">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178403">n</span>&nbsp;<span class="op" id="4178405">!=</span>&nbsp;<span class="num" id="4178408">0</span>&nbsp;<span class="op" id="4178410">&amp;&amp;</span>&nbsp;<span class="ident" id="4178413">err</span>&nbsp;<span class="op" id="4178417">==</span>&nbsp;<span class="ident" id="4178420">nil</span>&nbsp;<span class="op" id="4178424">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178430">c</span><span class="op" id="4178431">.</span><span class="ident" id="4178432">input</span>&nbsp;<span class="op" id="4178438">==</span>&nbsp;<span class="ident" id="4178441">nil</span>&nbsp;<span class="op" id="4178445">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4178448">len</span><span class="op" id="4178451">(</span><span class="ident" id="4178452">ri</span><span class="op" id="4178454">.</span><span class="ident" id="4178455">data</span><span class="op" id="4178459">)</span>&nbsp;<span class="op" id="4178461">&gt;</span>&nbsp;<span class="num" id="4178463">0</span>&nbsp;<span class="op" id="4178465">&amp;&amp;</span>&nbsp;<span class="ident" id="4178468">recordType</span><span class="op" id="4178478">(</span><span class="ident" id="4178479">ri</span><span class="op" id="4178481">.</span><span class="ident" id="4178482">data</span><span class="op" id="4178486">[</span><span class="num" id="4178487">0</span><span class="op" id="4178488">]</span><span class="op" id="4178489">)</span>&nbsp;<span class="op" id="4178491">==</span>&nbsp;<span class="ident" id="4178494">recordTypeAlert</span>&nbsp;<span class="op" id="4178510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178515">if</span>&nbsp;<span class="ident" id="4178518">recErr</span>&nbsp;<span class="op" id="4178525">:=</span>&nbsp;<span class="ident" id="4178528">c</span><span class="op" id="4178529">.</span><span class="ident" id="4178530">readRecord</span><span class="op" id="4178540">(</span><span class="ident" id="4178541">recordTypeApplicationData</span><span class="op" id="4178566">)</span><span class="op" id="4178567">;</span>&nbsp;<span class="ident" id="4178569">recErr</span>&nbsp;<span class="op" id="4178576">!=</span>&nbsp;<span class="ident" id="4178579">nil</span>&nbsp;<span class="op" id="4178583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178589">err</span>&nbsp;<span class="op" id="4178593">=</span>&nbsp;<span class="ident" id="4178595">recErr</span>&nbsp;<span class="comment" id="4178602">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4178638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4178642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178647">if</span>&nbsp;<span class="ident" id="4178650">n</span>&nbsp;<span class="op" id="4178652">!=</span>&nbsp;<span class="num" id="4178655">0</span>&nbsp;<span class="op" id="4178657">||</span>&nbsp;<span class="ident" id="4178660">err</span>&nbsp;<span class="op" id="4178664">!=</span>&nbsp;<span class="ident" id="4178667">nil</span>&nbsp;<span class="op" id="4178671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178676">return</span>&nbsp;<span class="ident" id="4178683">n</span><span class="op" id="4178684">,</span>&nbsp;<span class="ident" id="4178686">err</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4178692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4178695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178699">return</span>&nbsp;<span class="num" id="4178706">0</span><span class="op" id="4178707">,</span>&nbsp;<span class="ident" id="4178709">io</span><span class="op" id="4178711">.</span><span class="ident" id="4178712">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="4178726">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="4178729">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4178761">func</span>&nbsp;<span class="op" id="4178766">(</span><span class="ident" id="4178767">c</span>&nbsp;<span class="op" id="4178769">*</span><span class="ident" id="4178770">Conn</span><span class="op" id="4178774">)</span>&nbsp;<span class="ident" id="4178776">Close</span><span class="op" id="4178781">(</span><span class="op" id="4178782">)</span>&nbsp;<span class="builtintype" id="4178784">error</span>&nbsp;<span class="op" id="4178790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178793">var</span>&nbsp;<span class="ident" id="4178797">alertErr</span>&nbsp;<span class="builtintype" id="4178806">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178814">c</span><span class="op" id="4178815">.</span><span class="ident" id="4178816">handshakeMutex</span><span class="op" id="4178830">.</span><span class="ident" id="4178831">Lock</span><span class="op" id="4178835">(</span><span class="op" id="4178836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178839">defer</span>&nbsp;<span class="ident" id="4178845">c</span><span class="op" id="4178846">.</span><span class="ident" id="4178847">handshakeMutex</span><span class="op" id="4178861">.</span><span class="ident" id="4178862">Unlock</span><span class="op" id="4178868">(</span><span class="op" id="4178869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178872">if</span>&nbsp;<span class="ident" id="4178875">c</span><span class="op" id="4178876">.</span><span class="ident" id="4178877">handshakeComplete</span>&nbsp;<span class="op" id="4178895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178899">alertErr</span>&nbsp;<span class="op" id="4178908">=</span>&nbsp;<span class="ident" id="4178910">c</span><span class="op" id="4178911">.</span><span class="ident" id="4178912">sendAlert</span><span class="op" id="4178921">(</span><span class="ident" id="4178922">alertCloseNotify</span><span class="op" id="4178938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4178941">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178945">if</span>&nbsp;<span class="ident" id="4178948">err</span>&nbsp;<span class="op" id="4178952">:=</span>&nbsp;<span class="ident" id="4178955">c</span><span class="op" id="4178956">.</span><span class="ident" id="4178957">conn</span><span class="op" id="4178961">.</span><span class="ident" id="4178962">Close</span><span class="op" id="4178967">(</span><span class="op" id="4178968">)</span><span class="op" id="4178969">;</span>&nbsp;<span class="ident" id="4178971">err</span>&nbsp;<span class="op" id="4178975">!=</span>&nbsp;<span class="ident" id="4178978">nil</span>&nbsp;<span class="op" id="4178982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178986">return</span>&nbsp;<span class="ident" id="4178993">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4178998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179001">return</span>&nbsp;<span class="ident" id="4179008">alertErr</span><br>
<span class="lineno">960</span><span class="op" id="4179017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4179020">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="4179069">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="4179109">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="4179162">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="4179229">func</span>&nbsp;<span class="op" id="4179234">(</span><span class="ident" id="4179235">c</span>&nbsp;<span class="op" id="4179237">*</span><span class="ident" id="4179238">Conn</span><span class="op" id="4179242">)</span>&nbsp;<span class="ident" id="4179244">Handshake</span><span class="op" id="4179253">(</span><span class="op" id="4179254">)</span>&nbsp;<span class="builtintype" id="4179256">error</span>&nbsp;<span class="op" id="4179262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179265">c</span><span class="op" id="4179266">.</span><span class="ident" id="4179267">handshakeMutex</span><span class="op" id="4179281">.</span><span class="ident" id="4179282">Lock</span><span class="op" id="4179286">(</span><span class="op" id="4179287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179290">defer</span>&nbsp;<span class="ident" id="4179296">c</span><span class="op" id="4179297">.</span><span class="ident" id="4179298">handshakeMutex</span><span class="op" id="4179312">.</span><span class="ident" id="4179313">Unlock</span><span class="op" id="4179319">(</span><span class="op" id="4179320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179323">if</span>&nbsp;<span class="ident" id="4179326">err</span>&nbsp;<span class="op" id="4179330">:=</span>&nbsp;<span class="ident" id="4179333">c</span><span class="op" id="4179334">.</span><span class="ident" id="4179335">handshakeErr</span><span class="op" id="4179347">;</span>&nbsp;<span class="ident" id="4179349">err</span>&nbsp;<span class="op" id="4179353">!=</span>&nbsp;<span class="ident" id="4179356">nil</span>&nbsp;<span class="op" id="4179360">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179364">return</span>&nbsp;<span class="ident" id="4179371">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179379">if</span>&nbsp;<span class="ident" id="4179382">c</span><span class="op" id="4179383">.</span><span class="ident" id="4179384">handshakeComplete</span>&nbsp;<span class="op" id="4179402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179406">return</span>&nbsp;<span class="ident" id="4179413">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179418">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179422">if</span>&nbsp;<span class="ident" id="4179425">c</span><span class="op" id="4179426">.</span><span class="ident" id="4179427">isClient</span>&nbsp;<span class="op" id="4179436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179440">c</span><span class="op" id="4179441">.</span><span class="ident" id="4179442">handshakeErr</span>&nbsp;<span class="op" id="4179455">=</span>&nbsp;<span class="ident" id="4179457">c</span><span class="op" id="4179458">.</span><span class="ident" id="4179459">clientHandshake</span><span class="op" id="4179474">(</span><span class="op" id="4179475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179478">}</span>&nbsp;<span class="keyword" id="4179480">else</span>&nbsp;<span class="op" id="4179485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179489">c</span><span class="op" id="4179490">.</span><span class="ident" id="4179491">handshakeErr</span>&nbsp;<span class="op" id="4179504">=</span>&nbsp;<span class="ident" id="4179506">c</span><span class="op" id="4179507">.</span><span class="ident" id="4179508">serverHandshake</span><span class="op" id="4179523">(</span><span class="op" id="4179524">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179530">return</span>&nbsp;<span class="ident" id="4179537">c</span><span class="op" id="4179538">.</span><span class="ident" id="4179539">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="4179552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4179555">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="4179622">func</span>&nbsp;<span class="op" id="4179627">(</span><span class="ident" id="4179628">c</span>&nbsp;<span class="op" id="4179630">*</span><span class="ident" id="4179631">Conn</span><span class="op" id="4179635">)</span>&nbsp;<span class="ident" id="4179637">ConnectionState</span><span class="op" id="4179652">(</span><span class="op" id="4179653">)</span>&nbsp;<span class="ident" id="4179655">ConnectionState</span>&nbsp;<span class="op" id="4179671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179674">c</span><span class="op" id="4179675">.</span><span class="ident" id="4179676">handshakeMutex</span><span class="op" id="4179690">.</span><span class="ident" id="4179691">Lock</span><span class="op" id="4179695">(</span><span class="op" id="4179696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179699">defer</span>&nbsp;<span class="ident" id="4179705">c</span><span class="op" id="4179706">.</span><span class="ident" id="4179707">handshakeMutex</span><span class="op" id="4179721">.</span><span class="ident" id="4179722">Unlock</span><span class="op" id="4179728">(</span><span class="op" id="4179729">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179733">var</span>&nbsp;<span class="ident" id="4179737">state</span>&nbsp;<span class="ident" id="4179743">ConnectionState</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179760">state</span><span class="op" id="4179765">.</span><span class="ident" id="4179766">HandshakeComplete</span>&nbsp;<span class="op" id="4179784">=</span>&nbsp;<span class="ident" id="4179786">c</span><span class="op" id="4179787">.</span><span class="ident" id="4179788">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179807">if</span>&nbsp;<span class="ident" id="4179810">c</span><span class="op" id="4179811">.</span><span class="ident" id="4179812">handshakeComplete</span>&nbsp;<span class="op" id="4179830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179834">state</span><span class="op" id="4179839">.</span><span class="ident" id="4179840">Version</span>&nbsp;<span class="op" id="4179848">=</span>&nbsp;<span class="ident" id="4179850">c</span><span class="op" id="4179851">.</span><span class="ident" id="4179852">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179859">state</span><span class="op" id="4179864">.</span><span class="ident" id="4179865">NegotiatedProtocol</span>&nbsp;<span class="op" id="4179884">=</span>&nbsp;<span class="ident" id="4179886">c</span><span class="op" id="4179887">.</span><span class="ident" id="4179888">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179905">state</span><span class="op" id="4179910">.</span><span class="ident" id="4179911">DidResume</span>&nbsp;<span class="op" id="4179921">=</span>&nbsp;<span class="ident" id="4179923">c</span><span class="op" id="4179924">.</span><span class="ident" id="4179925">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179937">state</span><span class="op" id="4179942">.</span><span class="ident" id="4179943">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="4179970">=</span>&nbsp;<span class="op" id="4179972">!</span><span class="ident" id="4179973">c</span><span class="op" id="4179974">.</span><span class="ident" id="4179975">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180000">state</span><span class="op" id="4180005">.</span><span class="ident" id="4180006">CipherSuite</span>&nbsp;<span class="op" id="4180018">=</span>&nbsp;<span class="ident" id="4180020">c</span><span class="op" id="4180021">.</span><span class="ident" id="4180022">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180036">state</span><span class="op" id="4180041">.</span><span class="ident" id="4180042">PeerCertificates</span>&nbsp;<span class="op" id="4180059">=</span>&nbsp;<span class="ident" id="4180061">c</span><span class="op" id="4180062">.</span><span class="ident" id="4180063">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180082">state</span><span class="op" id="4180087">.</span><span class="ident" id="4180088">VerifiedChains</span>&nbsp;<span class="op" id="4180103">=</span>&nbsp;<span class="ident" id="4180105">c</span><span class="op" id="4180106">.</span><span class="ident" id="4180107">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180124">state</span><span class="op" id="4180129">.</span><span class="ident" id="4180130">ServerName</span>&nbsp;<span class="op" id="4180141">=</span>&nbsp;<span class="ident" id="4180143">c</span><span class="op" id="4180144">.</span><span class="ident" id="4180145">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180158">if</span>&nbsp;<span class="op" id="4180161">!</span><span class="ident" id="4180162">c</span><span class="op" id="4180163">.</span><span class="ident" id="4180164">didResume</span>&nbsp;<span class="op" id="4180174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180179">state</span><span class="op" id="4180184">.</span><span class="ident" id="4180185">TLSUnique</span>&nbsp;<span class="op" id="4180195">=</span>&nbsp;<span class="ident" id="4180197">c</span><span class="op" id="4180198">.</span><span class="ident" id="4180199">firstFinished</span><span class="op" id="4180212">[</span><span class="op" id="4180213">:</span><span class="op" id="4180214">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4180218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4180221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180225">return</span>&nbsp;<span class="ident" id="4180232">state</span><br>
<span class="lineno"></span><span class="op" id="4180238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4180241">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4180315">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="4180360">func</span>&nbsp;<span class="op" id="4180365">(</span><span class="ident" id="4180366">c</span>&nbsp;<span class="op" id="4180368">*</span><span class="ident" id="4180369">Conn</span><span class="op" id="4180373">)</span>&nbsp;<span class="ident" id="4180375">OCSPResponse</span><span class="op" id="4180387">(</span><span class="op" id="4180388">)</span>&nbsp;<span class="op" id="4180390">[</span><span class="op" id="4180391">]</span><span class="builtintype" id="4180392">byte</span>&nbsp;<span class="op" id="4180397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180400">c</span><span class="op" id="4180401">.</span><span class="ident" id="4180402">handshakeMutex</span><span class="op" id="4180416">.</span><span class="ident" id="4180417">Lock</span><span class="op" id="4180421">(</span><span class="op" id="4180422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180425">defer</span>&nbsp;<span class="ident" id="4180431">c</span><span class="op" id="4180432">.</span><span class="ident" id="4180433">handshakeMutex</span><span class="op" id="4180447">.</span><span class="ident" id="4180448">Unlock</span><span class="op" id="4180454">(</span><span class="op" id="4180455">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180459">return</span>&nbsp;<span class="ident" id="4180466">c</span><span class="op" id="4180467">.</span><span class="ident" id="4180468">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="4180481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4180484">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4180554">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4180629">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="4180656">func</span>&nbsp;<span class="op" id="4180661">(</span><span class="ident" id="4180662">c</span>&nbsp;<span class="op" id="4180664">*</span><span class="ident" id="4180665">Conn</span><span class="op" id="4180669">)</span>&nbsp;<span class="ident" id="4180671">VerifyHostname</span><span class="op" id="4180685">(</span><span class="ident" id="4180686">host</span>&nbsp;<span class="builtintype" id="4180691">string</span><span class="op" id="4180697">)</span>&nbsp;<span class="builtintype" id="4180699">error</span>&nbsp;<span class="op" id="4180705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180708">c</span><span class="op" id="4180709">.</span><span class="ident" id="4180710">handshakeMutex</span><span class="op" id="4180724">.</span><span class="ident" id="4180725">Lock</span><span class="op" id="4180729">(</span><span class="op" id="4180730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180733">defer</span>&nbsp;<span class="ident" id="4180739">c</span><span class="op" id="4180740">.</span><span class="ident" id="4180741">handshakeMutex</span><span class="op" id="4180755">.</span><span class="ident" id="4180756">Unlock</span><span class="op" id="4180762">(</span><span class="op" id="4180763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180766">if</span>&nbsp;<span class="op" id="4180769">!</span><span class="ident" id="4180770">c</span><span class="op" id="4180771">.</span><span class="ident" id="4180772">isClient</span>&nbsp;<span class="op" id="4180781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180785">return</span>&nbsp;<span class="ident" id="4180792">errors</span><span class="op" id="4180798">.</span><span class="ident" id="4180799">New</span><span class="op" id="4180802">(</span><span class="string" id="4180803">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="4180856">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4180859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180862">if</span>&nbsp;<span class="op" id="4180865">!</span><span class="ident" id="4180866">c</span><span class="op" id="4180867">.</span><span class="ident" id="4180868">handshakeComplete</span>&nbsp;<span class="op" id="4180886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180890">return</span>&nbsp;<span class="ident" id="4180897">errors</span><span class="op" id="4180903">.</span><span class="ident" id="4180904">New</span><span class="op" id="4180907">(</span><span class="string" id="4180908">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="4180951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4180954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180957">return</span>&nbsp;<span class="ident" id="4180964">c</span><span class="op" id="4180965">.</span><span class="ident" id="4180966">peerCertificates</span><span class="op" id="4180982">[</span><span class="num" id="4180983">0</span><span class="op" id="4180984">]</span><span class="op" id="4180985">.</span><span class="ident" id="4180986">VerifyHostname</span><span class="op" id="4181000">(</span><span class="ident" id="4181001">host</span><span class="op" id="4181005">)</span><br>
<span class="lineno">1030</span><span class="op" id="4181007">}</span>
</div>
</body>
</html>
