<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/parser</h2>
<ul>
<li><a href="/gostd/go/parser/error_test.go.html">error_test.go</a></li>
<li><a href="/gostd/go/parser/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/parser/interface.go.html" class="current">interface.go</a></li>
<li><a href="/gostd/go/parser/parser.go.html">parser.go</a></li>
<li><a href="/gostd/go/parser/parser_test.go.html">parser_test.go</a></li>
<li><a href="/gostd/go/parser/performance_test.go.html">performance_test.go</a></li>
<li><a href="/gostd/go/parser/short_test.go.html">short_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3350157">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3350212">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3350266">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3350317">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;exported&nbsp;entry&nbsp;points&nbsp;for&nbsp;invoking&nbsp;the&nbsp;parser.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3350391">package</span>&nbsp;<span class="ident" id="3350399">parser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3350407">import</span>&nbsp;<span class="op" id="3350414">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3350417">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3350426">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3350436">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3350446">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3350458">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3350464">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3350477">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3350483">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3350500">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="3350510">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="3350513">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;readSource&nbsp;converts&nbsp;src&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;possible;</span><br>
<span class="lineno"></span><span class="comment" id="3350580">//&nbsp;otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error.&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;readSource&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3350648">//&nbsp;the&nbsp;result&nbsp;of&nbsp;reading&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="3350705">//</span><br>
<span class="lineno">25</span><span class="keyword" id="3350708">func</span>&nbsp;<span class="ident" id="3350713">readSource</span><span class="op" id="3350723">(</span><span class="ident" id="3350724">filename</span>&nbsp;<span class="builtintype" id="3350733">string</span><span class="op" id="3350739">,</span>&nbsp;<span class="ident" id="3350741">src</span>&nbsp;<span class="keyword" id="3350745">interface</span><span class="op" id="3350754">{</span><span class="op" id="3350755">}</span><span class="op" id="3350756">)</span>&nbsp;<span class="op" id="3350758">(</span><span class="op" id="3350759">[</span><span class="op" id="3350760">]</span><span class="builtintype" id="3350761">byte</span><span class="op" id="3350765">,</span>&nbsp;<span class="builtintype" id="3350767">error</span><span class="op" id="3350772">)</span>&nbsp;<span class="op" id="3350774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350777">if</span>&nbsp;<span class="ident" id="3350780">src</span>&nbsp;<span class="op" id="3350784">!=</span>&nbsp;<span class="ident" id="3350787">nil</span>&nbsp;<span class="op" id="3350791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350795">switch</span>&nbsp;<span class="ident" id="3350802">s</span>&nbsp;<span class="op" id="3350804">:=</span>&nbsp;<span class="ident" id="3350807">src</span><span class="op" id="3350810">.</span><span class="op" id="3350811">(</span><span class="keyword" id="3350812">type</span><span class="op" id="3350816">)</span>&nbsp;<span class="op" id="3350818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350822">case</span>&nbsp;<span class="builtintype" id="3350827">string</span><span class="op" id="3350833">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350838">return</span>&nbsp;<span class="op" id="3350845">[</span><span class="op" id="3350846">]</span><span class="builtintype" id="3350847">byte</span><span class="op" id="3350851">(</span><span class="ident" id="3350852">s</span><span class="op" id="3350853">)</span><span class="op" id="3350854">,</span>&nbsp;<span class="ident" id="3350856">nil</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350862">case</span>&nbsp;<span class="op" id="3350867">[</span><span class="op" id="3350868">]</span><span class="builtintype" id="3350869">byte</span><span class="op" id="3350873">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350878">return</span>&nbsp;<span class="ident" id="3350885">s</span><span class="op" id="3350886">,</span>&nbsp;<span class="ident" id="3350888">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350894">case</span>&nbsp;<span class="op" id="3350899">*</span><span class="ident" id="3350900">bytes</span><span class="op" id="3350905">.</span><span class="ident" id="3350906">Buffer</span><span class="op" id="3350912">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3350917">//&nbsp;is&nbsp;io.Reader,&nbsp;but&nbsp;src&nbsp;is&nbsp;already&nbsp;available&nbsp;in&nbsp;[]byte&nbsp;form</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350981">if</span>&nbsp;<span class="ident" id="3350984">s</span>&nbsp;<span class="op" id="3350986">!=</span>&nbsp;<span class="ident" id="3350989">nil</span>&nbsp;<span class="op" id="3350993">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350999">return</span>&nbsp;<span class="ident" id="3351006">s</span><span class="op" id="3351007">.</span><span class="ident" id="3351008">Bytes</span><span class="op" id="3351013">(</span><span class="op" id="3351014">)</span><span class="op" id="3351015">,</span>&nbsp;<span class="ident" id="3351017">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3351024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351028">case</span>&nbsp;<span class="ident" id="3351033">io</span><span class="op" id="3351035">.</span><span class="ident" id="3351036">Reader</span><span class="op" id="3351042">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351047">var</span>&nbsp;<span class="ident" id="3351051">buf</span>&nbsp;<span class="ident" id="3351055">bytes</span><span class="op" id="3351060">.</span><span class="ident" id="3351061">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351071">if</span>&nbsp;<span class="ident" id="3351074">_</span><span class="op" id="3351075">,</span>&nbsp;<span class="ident" id="3351077">err</span>&nbsp;<span class="op" id="3351081">:=</span>&nbsp;<span class="ident" id="3351084">io</span><span class="op" id="3351086">.</span><span class="ident" id="3351087">Copy</span><span class="op" id="3351091">(</span><span class="op" id="3351092">&amp;</span><span class="ident" id="3351093">buf</span><span class="op" id="3351096">,</span>&nbsp;<span class="ident" id="3351098">s</span><span class="op" id="3351099">)</span><span class="op" id="3351100">;</span>&nbsp;<span class="ident" id="3351102">err</span>&nbsp;<span class="op" id="3351106">!=</span>&nbsp;<span class="ident" id="3351109">nil</span>&nbsp;<span class="op" id="3351113">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351119">return</span>&nbsp;<span class="ident" id="3351126">nil</span><span class="op" id="3351129">,</span>&nbsp;<span class="ident" id="3351131">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3351138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351143">return</span>&nbsp;<span class="ident" id="3351150">buf</span><span class="op" id="3351153">.</span><span class="ident" id="3351154">Bytes</span><span class="op" id="3351159">(</span><span class="op" id="3351160">)</span><span class="op" id="3351161">,</span>&nbsp;<span class="ident" id="3351163">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3351169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351173">return</span>&nbsp;<span class="ident" id="3351180">nil</span><span class="op" id="3351183">,</span>&nbsp;<span class="ident" id="3351185">errors</span><span class="op" id="3351191">.</span><span class="ident" id="3351192">New</span><span class="op" id="3351195">(</span><span class="string" id="3351196">&#34;invalid&nbsp;source&#34;</span><span class="op" id="3351212">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3351215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351218">return</span>&nbsp;<span class="ident" id="3351225">ioutil</span><span class="op" id="3351231">.</span><span class="ident" id="3351232">ReadFile</span><span class="op" id="3351240">(</span><span class="ident" id="3351241">filename</span><span class="op" id="3351249">)</span><br>
<span class="lineno"></span><span class="op" id="3351251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3351254">//&nbsp;A&nbsp;Mode&nbsp;value&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;flags&nbsp;(or&nbsp;0).</span><br>
<span class="lineno">50</span><span class="comment" id="3351296">//&nbsp;They&nbsp;control&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;code&nbsp;parsed&nbsp;and&nbsp;other&nbsp;optional</span><br>
<span class="lineno"></span><span class="comment" id="3351364">//&nbsp;parser&nbsp;functionality.</span><br>
<span class="lineno"></span><span class="comment" id="3351389">//</span><br>
<span class="lineno"></span><span class="keyword" id="3351392">type</span>&nbsp;<span class="ident" id="3351397">Mode</span>&nbsp;<span class="builtintype" id="3351402">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="3351408">const</span>&nbsp;<span class="op" id="3351414">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351417">PackageClauseOnly</span>&nbsp;<span class="ident" id="3351435">Mode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3351452">=</span>&nbsp;<span class="num" id="3351454">1</span>&nbsp;<span class="op" id="3351456">&lt;&lt;</span>&nbsp;<span class="ident" id="3351459">iota</span>&nbsp;<span class="comment" id="3351464">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;package&nbsp;clause</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351502">ImportsOnly</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3351549">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;import&nbsp;declarations</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351592">ParseComments</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3351639">//&nbsp;parse&nbsp;comments&nbsp;and&nbsp;add&nbsp;them&nbsp;to&nbsp;AST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351678">Trace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3351725">//&nbsp;print&nbsp;a&nbsp;trace&nbsp;of&nbsp;parsed&nbsp;productions</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351765">DeclarationErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3351812">//&nbsp;report&nbsp;declaration&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351842">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3351889">//&nbsp;same&nbsp;as&nbsp;AllErrors,&nbsp;for&nbsp;backward-compatibility</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351939">AllErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3351957">=</span>&nbsp;<span class="ident" id="3351959">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3351986">//&nbsp;report&nbsp;all&nbsp;errors&nbsp;(not&nbsp;just&nbsp;the&nbsp;first&nbsp;10&nbsp;on&nbsp;different&nbsp;lines)</span><br>
<span class="lineno"></span><span class="op" id="3352050">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3352053">//&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;code&nbsp;of&nbsp;a&nbsp;single&nbsp;Go&nbsp;source&nbsp;file&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3352128">//&nbsp;the&nbsp;corresponding&nbsp;ast.File&nbsp;node.&nbsp;The&nbsp;source&nbsp;code&nbsp;may&nbsp;be&nbsp;provided&nbsp;via</span><br>
<span class="lineno"></span><span class="comment" id="3352200">//&nbsp;the&nbsp;filename&nbsp;of&nbsp;the&nbsp;source&nbsp;file,&nbsp;or&nbsp;via&nbsp;the&nbsp;src&nbsp;parameter.</span><br>
<span class="lineno"></span><span class="comment" id="3352262">//</span><br>
<span class="lineno"></span><span class="comment" id="3352265">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;from&nbsp;src&nbsp;and&nbsp;the&nbsp;filename&nbsp;is</span><br>
<span class="lineno">70</span><span class="comment" id="3352340">//&nbsp;only&nbsp;used&nbsp;when&nbsp;recording&nbsp;position&nbsp;information.&nbsp;The&nbsp;type&nbsp;of&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="3352415">//&nbsp;for&nbsp;the&nbsp;src&nbsp;parameter&nbsp;must&nbsp;be&nbsp;string,&nbsp;[]byte,&nbsp;or&nbsp;io.Reader.</span><br>
<span class="lineno"></span><span class="comment" id="3352478">//&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="3352545">//</span><br>
<span class="lineno"></span><span class="comment" id="3352548">//&nbsp;The&nbsp;mode&nbsp;parameter&nbsp;controls&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;text&nbsp;parsed&nbsp;and&nbsp;other</span><br>
<span class="lineno">75</span><span class="comment" id="3352622">//&nbsp;optional&nbsp;parser&nbsp;functionality.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3352696">//&nbsp;file&nbsp;set&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="3352714">//</span><br>
<span class="lineno"></span><span class="comment" id="3352717">//&nbsp;If&nbsp;the&nbsp;source&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;the&nbsp;returned&nbsp;AST&nbsp;is&nbsp;nil&nbsp;and&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3352790">//&nbsp;indicates&nbsp;the&nbsp;specific&nbsp;failure.&nbsp;If&nbsp;the&nbsp;source&nbsp;was&nbsp;read&nbsp;but&nbsp;syntax</span><br>
<span class="lineno">80</span><span class="comment" id="3352859">//&nbsp;errors&nbsp;were&nbsp;found,&nbsp;the&nbsp;result&nbsp;is&nbsp;a&nbsp;partial&nbsp;AST&nbsp;(with&nbsp;ast.Bad*&nbsp;nodes</span><br>
<span class="lineno"></span><span class="comment" id="3352930">//&nbsp;representing&nbsp;the&nbsp;fragments&nbsp;of&nbsp;erroneous&nbsp;source&nbsp;code).&nbsp;Multiple&nbsp;errors</span><br>
<span class="lineno"></span><span class="comment" id="3353003">//&nbsp;are&nbsp;returned&nbsp;via&nbsp;a&nbsp;scanner.ErrorList&nbsp;which&nbsp;is&nbsp;sorted&nbsp;by&nbsp;file&nbsp;position.</span><br>
<span class="lineno"></span><span class="comment" id="3353077">//</span><br>
<span class="lineno"></span><span class="keyword" id="3353080">func</span>&nbsp;<span class="ident" id="3353085">ParseFile</span><span class="op" id="3353094">(</span><span class="ident" id="3353095">fset</span>&nbsp;<span class="op" id="3353100">*</span><span class="ident" id="3353101">token</span><span class="op" id="3353106">.</span><span class="ident" id="3353107">FileSet</span><span class="op" id="3353114">,</span>&nbsp;<span class="ident" id="3353116">filename</span>&nbsp;<span class="builtintype" id="3353125">string</span><span class="op" id="3353131">,</span>&nbsp;<span class="ident" id="3353133">src</span>&nbsp;<span class="keyword" id="3353137">interface</span><span class="op" id="3353146">{</span><span class="op" id="3353147">}</span><span class="op" id="3353148">,</span>&nbsp;<span class="ident" id="3353150">mode</span>&nbsp;<span class="ident" id="3353155">Mode</span><span class="op" id="3353159">)</span>&nbsp;<span class="op" id="3353161">(</span><span class="ident" id="3353162">f</span>&nbsp;<span class="op" id="3353164">*</span><span class="ident" id="3353165">ast</span><span class="op" id="3353168">.</span><span class="ident" id="3353169">File</span><span class="op" id="3353173">,</span>&nbsp;<span class="ident" id="3353175">err</span>&nbsp;<span class="builtintype" id="3353179">error</span><span class="op" id="3353184">)</span>&nbsp;<span class="op" id="3353186">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3353189">//&nbsp;get&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353204">text</span><span class="op" id="3353208">,</span>&nbsp;<span class="ident" id="3353210">err</span>&nbsp;<span class="op" id="3353214">:=</span>&nbsp;<span class="ident" id="3353217">readSource</span><span class="op" id="3353227">(</span><span class="ident" id="3353228">filename</span><span class="op" id="3353236">,</span>&nbsp;<span class="ident" id="3353238">src</span><span class="op" id="3353241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353244">if</span>&nbsp;<span class="ident" id="3353247">err</span>&nbsp;<span class="op" id="3353251">!=</span>&nbsp;<span class="ident" id="3353254">nil</span>&nbsp;<span class="op" id="3353258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353262">return</span>&nbsp;<span class="ident" id="3353269">nil</span><span class="op" id="3353272">,</span>&nbsp;<span class="ident" id="3353274">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3353279">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353283">var</span>&nbsp;<span class="ident" id="3353287">p</span>&nbsp;<span class="ident" id="3353289">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353297">defer</span>&nbsp;<span class="keyword" id="3353303">func</span><span class="op" id="3353307">(</span><span class="op" id="3353308">)</span>&nbsp;<span class="op" id="3353310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353314">if</span>&nbsp;<span class="ident" id="3353317">e</span>&nbsp;<span class="op" id="3353319">:=</span>&nbsp;<span class="builtinfunc" id="3353322">recover</span><span class="op" id="3353329">(</span><span class="op" id="3353330">)</span><span class="op" id="3353331">;</span>&nbsp;<span class="ident" id="3353333">e</span>&nbsp;<span class="op" id="3353335">!=</span>&nbsp;<span class="ident" id="3353338">nil</span>&nbsp;<span class="op" id="3353342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353347">_</span>&nbsp;<span class="op" id="3353349">=</span>&nbsp;<span class="ident" id="3353351">e</span><span class="op" id="3353352">.</span><span class="op" id="3353353">(</span><span class="ident" id="3353354">bailout</span><span class="op" id="3353361">)</span>&nbsp;<span class="comment" id="3353363">//&nbsp;re-panics&nbsp;if&nbsp;it&#39;s&nbsp;not&nbsp;a&nbsp;bailout</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3353400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3353405">//&nbsp;set&nbsp;result&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353428">if</span>&nbsp;<span class="ident" id="3353431">f</span>&nbsp;<span class="op" id="3353433">==</span>&nbsp;<span class="ident" id="3353436">nil</span>&nbsp;<span class="op" id="3353440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3353445">//&nbsp;source&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;Go&nbsp;source&nbsp;file&nbsp;-&nbsp;satisfy</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3353498">//&nbsp;ParseFile&nbsp;API&nbsp;and&nbsp;return&nbsp;a&nbsp;valid&nbsp;(but)&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3353549">//&nbsp;*ast.File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353565">f</span>&nbsp;<span class="op" id="3353567">=</span>&nbsp;<span class="op" id="3353569">&amp;</span><span class="ident" id="3353570">ast</span><span class="op" id="3353573">.</span><span class="ident" id="3353574">File</span><span class="op" id="3353578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353584">Name</span><span class="op" id="3353588">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="3353591">new</span><span class="op" id="3353594">(</span><span class="ident" id="3353595">ast</span><span class="op" id="3353598">.</span><span class="ident" id="3353599">Ident</span><span class="op" id="3353604">)</span><span class="op" id="3353605">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353611">Scope</span><span class="op" id="3353616">:</span>&nbsp;<span class="ident" id="3353618">ast</span><span class="op" id="3353621">.</span><span class="ident" id="3353622">NewScope</span><span class="op" id="3353630">(</span><span class="ident" id="3353631">nil</span><span class="op" id="3353634">)</span><span class="op" id="3353635">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3353640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3353644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353649">p</span><span class="op" id="3353650">.</span><span class="ident" id="3353651">errors</span><span class="op" id="3353657">.</span><span class="ident" id="3353658">Sort</span><span class="op" id="3353662">(</span><span class="op" id="3353663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353667">err</span>&nbsp;<span class="op" id="3353671">=</span>&nbsp;<span class="ident" id="3353673">p</span><span class="op" id="3353674">.</span><span class="ident" id="3353675">errors</span><span class="op" id="3353681">.</span><span class="ident" id="3353682">Err</span><span class="op" id="3353685">(</span><span class="op" id="3353686">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3353689">}</span><span class="op" id="3353690">(</span><span class="op" id="3353691">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3353695">//&nbsp;parse&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353712">p</span><span class="op" id="3353713">.</span><span class="ident" id="3353714">init</span><span class="op" id="3353718">(</span><span class="ident" id="3353719">fset</span><span class="op" id="3353723">,</span>&nbsp;<span class="ident" id="3353725">filename</span><span class="op" id="3353733">,</span>&nbsp;<span class="ident" id="3353735">text</span><span class="op" id="3353739">,</span>&nbsp;<span class="ident" id="3353741">mode</span><span class="op" id="3353745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353748">f</span>&nbsp;<span class="op" id="3353750">=</span>&nbsp;<span class="ident" id="3353752">p</span><span class="op" id="3353753">.</span><span class="ident" id="3353754">parseFile</span><span class="op" id="3353763">(</span><span class="op" id="3353764">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353768">return</span><br>
<span class="lineno"></span><span class="op" id="3353775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3353778">//&nbsp;ParseDir&nbsp;calls&nbsp;ParseFile&nbsp;for&nbsp;all&nbsp;files&nbsp;with&nbsp;names&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;&nbsp;in&nbsp;the</span><br>
<span class="lineno">120</span><span class="comment" id="3353854">//&nbsp;directory&nbsp;specified&nbsp;by&nbsp;path&nbsp;and&nbsp;returns&nbsp;a&nbsp;map&nbsp;of&nbsp;package&nbsp;name&nbsp;-&gt;&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="3353930">//&nbsp;AST&nbsp;with&nbsp;all&nbsp;the&nbsp;packages&nbsp;found.</span><br>
<span class="lineno"></span><span class="comment" id="3353966">//</span><br>
<span class="lineno"></span><span class="comment" id="3353969">//&nbsp;If&nbsp;filter&nbsp;!=&nbsp;nil,&nbsp;only&nbsp;the&nbsp;files&nbsp;with&nbsp;os.FileInfo&nbsp;entries&nbsp;passing&nbsp;through</span><br>
<span class="lineno"></span><span class="comment" id="3354046">//&nbsp;the&nbsp;filter&nbsp;(and&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;)&nbsp;are&nbsp;considered.&nbsp;The&nbsp;mode&nbsp;bits&nbsp;are&nbsp;passed</span><br>
<span class="lineno">125</span><span class="comment" id="3354123">//&nbsp;to&nbsp;ParseFile&nbsp;unchanged.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="3354192">//</span><br>
<span class="lineno"></span><span class="comment" id="3354195">//&nbsp;If&nbsp;the&nbsp;directory&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;a&nbsp;nil&nbsp;map&nbsp;and&nbsp;the&nbsp;respective&nbsp;error&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3354272">//&nbsp;returned.&nbsp;If&nbsp;a&nbsp;parse&nbsp;error&nbsp;occurred,&nbsp;a&nbsp;non-nil&nbsp;but&nbsp;incomplete&nbsp;map&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3354349">//&nbsp;first&nbsp;error&nbsp;encountered&nbsp;are&nbsp;returned.</span><br>
<span class="lineno">130</span><span class="comment" id="3354390">//</span><br>
<span class="lineno"></span><span class="keyword" id="3354393">func</span>&nbsp;<span class="ident" id="3354398">ParseDir</span><span class="op" id="3354406">(</span><span class="ident" id="3354407">fset</span>&nbsp;<span class="op" id="3354412">*</span><span class="ident" id="3354413">token</span><span class="op" id="3354418">.</span><span class="ident" id="3354419">FileSet</span><span class="op" id="3354426">,</span>&nbsp;<span class="ident" id="3354428">path</span>&nbsp;<span class="builtintype" id="3354433">string</span><span class="op" id="3354439">,</span>&nbsp;<span class="ident" id="3354441">filter</span>&nbsp;<span class="keyword" id="3354448">func</span><span class="op" id="3354452">(</span><span class="ident" id="3354453">os</span><span class="op" id="3354455">.</span><span class="ident" id="3354456">FileInfo</span><span class="op" id="3354464">)</span>&nbsp;<span class="builtintype" id="3354466">bool</span><span class="op" id="3354470">,</span>&nbsp;<span class="ident" id="3354472">mode</span>&nbsp;<span class="ident" id="3354477">Mode</span><span class="op" id="3354481">)</span>&nbsp;<span class="op" id="3354483">(</span><span class="ident" id="3354484">pkgs</span>&nbsp;<span class="keyword" id="3354489">map</span><span class="op" id="3354492">[</span><span class="builtintype" id="3354493">string</span><span class="op" id="3354499">]</span><span class="op" id="3354500">*</span><span class="ident" id="3354501">ast</span><span class="op" id="3354504">.</span><span class="ident" id="3354505">Package</span><span class="op" id="3354512">,</span>&nbsp;<span class="ident" id="3354514">first</span>&nbsp;<span class="builtintype" id="3354520">error</span><span class="op" id="3354525">)</span>&nbsp;<span class="op" id="3354527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354530">fd</span><span class="op" id="3354532">,</span>&nbsp;<span class="ident" id="3354534">err</span>&nbsp;<span class="op" id="3354538">:=</span>&nbsp;<span class="ident" id="3354541">os</span><span class="op" id="3354543">.</span><span class="ident" id="3354544">Open</span><span class="op" id="3354548">(</span><span class="ident" id="3354549">path</span><span class="op" id="3354553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354556">if</span>&nbsp;<span class="ident" id="3354559">err</span>&nbsp;<span class="op" id="3354563">!=</span>&nbsp;<span class="ident" id="3354566">nil</span>&nbsp;<span class="op" id="3354570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354574">return</span>&nbsp;<span class="ident" id="3354581">nil</span><span class="op" id="3354584">,</span>&nbsp;<span class="ident" id="3354586">err</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3354591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354594">defer</span>&nbsp;<span class="ident" id="3354600">fd</span><span class="op" id="3354602">.</span><span class="ident" id="3354603">Close</span><span class="op" id="3354608">(</span><span class="op" id="3354609">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354613">list</span><span class="op" id="3354617">,</span>&nbsp;<span class="ident" id="3354619">err</span>&nbsp;<span class="op" id="3354623">:=</span>&nbsp;<span class="ident" id="3354626">fd</span><span class="op" id="3354628">.</span><span class="ident" id="3354629">Readdir</span><span class="op" id="3354636">(</span><span class="op" id="3354637">-</span><span class="num" id="3354638">1</span><span class="op" id="3354639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354642">if</span>&nbsp;<span class="ident" id="3354645">err</span>&nbsp;<span class="op" id="3354649">!=</span>&nbsp;<span class="ident" id="3354652">nil</span>&nbsp;<span class="op" id="3354656">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354660">return</span>&nbsp;<span class="ident" id="3354667">nil</span><span class="op" id="3354670">,</span>&nbsp;<span class="ident" id="3354672">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3354677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354681">pkgs</span>&nbsp;<span class="op" id="3354686">=</span>&nbsp;<span class="builtinfunc" id="3354688">make</span><span class="op" id="3354692">(</span><span class="keyword" id="3354693">map</span><span class="op" id="3354696">[</span><span class="builtintype" id="3354697">string</span><span class="op" id="3354703">]</span><span class="op" id="3354704">*</span><span class="ident" id="3354705">ast</span><span class="op" id="3354708">.</span><span class="ident" id="3354709">Package</span><span class="op" id="3354716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354719">for</span>&nbsp;<span class="ident" id="3354723">_</span><span class="op" id="3354724">,</span>&nbsp;<span class="ident" id="3354726">d</span>&nbsp;<span class="op" id="3354728">:=</span>&nbsp;<span class="keyword" id="3354731">range</span>&nbsp;<span class="ident" id="3354737">list</span>&nbsp;<span class="op" id="3354742">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354746">if</span>&nbsp;<span class="ident" id="3354749">strings</span><span class="op" id="3354756">.</span><span class="ident" id="3354757">HasSuffix</span><span class="op" id="3354766">(</span><span class="ident" id="3354767">d</span><span class="op" id="3354768">.</span><span class="ident" id="3354769">Name</span><span class="op" id="3354773">(</span><span class="op" id="3354774">)</span><span class="op" id="3354775">,</span>&nbsp;<span class="string" id="3354777">&#34;.go&#34;</span><span class="op" id="3354782">)</span>&nbsp;<span class="op" id="3354784">&amp;&amp;</span>&nbsp;<span class="op" id="3354787">(</span><span class="ident" id="3354788">filter</span>&nbsp;<span class="op" id="3354795">==</span>&nbsp;<span class="ident" id="3354798">nil</span>&nbsp;<span class="op" id="3354802">||</span>&nbsp;<span class="ident" id="3354805">filter</span><span class="op" id="3354811">(</span><span class="ident" id="3354812">d</span><span class="op" id="3354813">)</span><span class="op" id="3354814">)</span>&nbsp;<span class="op" id="3354816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354821">filename</span>&nbsp;<span class="op" id="3354830">:=</span>&nbsp;<span class="ident" id="3354833">filepath</span><span class="op" id="3354841">.</span><span class="ident" id="3354842">Join</span><span class="op" id="3354846">(</span><span class="ident" id="3354847">path</span><span class="op" id="3354851">,</span>&nbsp;<span class="ident" id="3354853">d</span><span class="op" id="3354854">.</span><span class="ident" id="3354855">Name</span><span class="op" id="3354859">(</span><span class="op" id="3354860">)</span><span class="op" id="3354861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354866">if</span>&nbsp;<span class="ident" id="3354869">src</span><span class="op" id="3354872">,</span>&nbsp;<span class="ident" id="3354874">err</span>&nbsp;<span class="op" id="3354878">:=</span>&nbsp;<span class="ident" id="3354881">ParseFile</span><span class="op" id="3354890">(</span><span class="ident" id="3354891">fset</span><span class="op" id="3354895">,</span>&nbsp;<span class="ident" id="3354897">filename</span><span class="op" id="3354905">,</span>&nbsp;<span class="ident" id="3354907">nil</span><span class="op" id="3354910">,</span>&nbsp;<span class="ident" id="3354912">mode</span><span class="op" id="3354916">)</span><span class="op" id="3354917">;</span>&nbsp;<span class="ident" id="3354919">err</span>&nbsp;<span class="op" id="3354923">==</span>&nbsp;<span class="ident" id="3354926">nil</span>&nbsp;<span class="op" id="3354930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354936">name</span>&nbsp;<span class="op" id="3354941">:=</span>&nbsp;<span class="ident" id="3354944">src</span><span class="op" id="3354947">.</span><span class="ident" id="3354948">Name</span><span class="op" id="3354952">.</span><span class="ident" id="3354953">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354962">pkg</span><span class="op" id="3354965">,</span>&nbsp;<span class="ident" id="3354967">found</span>&nbsp;<span class="op" id="3354973">:=</span>&nbsp;<span class="ident" id="3354976">pkgs</span><span class="op" id="3354980">[</span><span class="ident" id="3354981">name</span><span class="op" id="3354985">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354991">if</span>&nbsp;<span class="op" id="3354994">!</span><span class="ident" id="3354995">found</span>&nbsp;<span class="op" id="3355001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355008">pkg</span>&nbsp;<span class="op" id="3355012">=</span>&nbsp;<span class="op" id="3355014">&amp;</span><span class="ident" id="3355015">ast</span><span class="op" id="3355018">.</span><span class="ident" id="3355019">Package</span><span class="op" id="3355026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355034">Name</span><span class="op" id="3355038">:</span>&nbsp;&nbsp;<span class="ident" id="3355041">name</span><span class="op" id="3355045">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355053">Files</span><span class="op" id="3355058">:</span>&nbsp;<span class="builtinfunc" id="3355060">make</span><span class="op" id="3355064">(</span><span class="keyword" id="3355065">map</span><span class="op" id="3355068">[</span><span class="builtintype" id="3355069">string</span><span class="op" id="3355075">]</span><span class="op" id="3355076">*</span><span class="ident" id="3355077">ast</span><span class="op" id="3355080">.</span><span class="ident" id="3355081">File</span><span class="op" id="3355085">)</span><span class="op" id="3355086">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3355093">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355100">pkgs</span><span class="op" id="3355104">[</span><span class="ident" id="3355105">name</span><span class="op" id="3355109">]</span>&nbsp;<span class="op" id="3355111">=</span>&nbsp;<span class="ident" id="3355113">pkg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3355121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355127">pkg</span><span class="op" id="3355130">.</span><span class="ident" id="3355131">Files</span><span class="op" id="3355136">[</span><span class="ident" id="3355137">filename</span><span class="op" id="3355145">]</span>&nbsp;<span class="op" id="3355147">=</span>&nbsp;<span class="ident" id="3355149">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3355156">}</span>&nbsp;<span class="keyword" id="3355158">else</span>&nbsp;<span class="keyword" id="3355163">if</span>&nbsp;<span class="ident" id="3355166">first</span>&nbsp;<span class="op" id="3355172">==</span>&nbsp;<span class="ident" id="3355175">nil</span>&nbsp;<span class="op" id="3355179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355185">first</span>&nbsp;<span class="op" id="3355191">=</span>&nbsp;<span class="ident" id="3355193">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3355200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3355204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3355207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355211">return</span><br>
<span class="lineno">165</span><span class="op" id="3355218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3355221">//&nbsp;ParseExpr&nbsp;is&nbsp;a&nbsp;convenience&nbsp;function&nbsp;for&nbsp;obtaining&nbsp;the&nbsp;AST&nbsp;of&nbsp;an&nbsp;expression&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="3355302">//&nbsp;The&nbsp;position&nbsp;information&nbsp;recorded&nbsp;in&nbsp;the&nbsp;AST&nbsp;is&nbsp;undefined.&nbsp;The&nbsp;filename&nbsp;used</span><br>
<span class="lineno"></span><span class="comment" id="3355382">//&nbsp;in&nbsp;error&nbsp;messages&nbsp;is&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno">170</span><span class="comment" id="3355424">//</span><br>
<span class="lineno"></span><span class="keyword" id="3355427">func</span>&nbsp;<span class="ident" id="3355432">ParseExpr</span><span class="op" id="3355441">(</span><span class="ident" id="3355442">x</span>&nbsp;<span class="builtintype" id="3355444">string</span><span class="op" id="3355450">)</span>&nbsp;<span class="op" id="3355452">(</span><span class="ident" id="3355453">ast</span><span class="op" id="3355456">.</span><span class="ident" id="3355457">Expr</span><span class="op" id="3355461">,</span>&nbsp;<span class="builtintype" id="3355463">error</span><span class="op" id="3355468">)</span>&nbsp;<span class="op" id="3355470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355473">var</span>&nbsp;<span class="ident" id="3355477">p</span>&nbsp;<span class="ident" id="3355479">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355487">p</span><span class="op" id="3355488">.</span><span class="ident" id="3355489">init</span><span class="op" id="3355493">(</span><span class="ident" id="3355494">token</span><span class="op" id="3355499">.</span><span class="ident" id="3355500">NewFileSet</span><span class="op" id="3355510">(</span><span class="op" id="3355511">)</span><span class="op" id="3355512">,</span>&nbsp;<span class="string" id="3355514">&#34;&#34;</span><span class="op" id="3355516">,</span>&nbsp;<span class="op" id="3355518">[</span><span class="op" id="3355519">]</span><span class="builtintype" id="3355520">byte</span><span class="op" id="3355524">(</span><span class="ident" id="3355525">x</span><span class="op" id="3355526">)</span><span class="op" id="3355527">,</span>&nbsp;<span class="num" id="3355529">0</span><span class="op" id="3355530">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3355534">//&nbsp;Set&nbsp;up&nbsp;pkg-level&nbsp;scopes&nbsp;to&nbsp;avoid&nbsp;nil-pointer&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3355591">//&nbsp;This&nbsp;is&nbsp;not&nbsp;needed&nbsp;for&nbsp;a&nbsp;correct&nbsp;expression&nbsp;x&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3355648">//&nbsp;parser&nbsp;will&nbsp;be&nbsp;ok&nbsp;with&nbsp;a&nbsp;nil&nbsp;topScope,&nbsp;but&nbsp;be&nbsp;cautious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3355707">//&nbsp;in&nbsp;case&nbsp;of&nbsp;an&nbsp;erroneous&nbsp;x.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355738">p</span><span class="op" id="3355739">.</span><span class="ident" id="3355740">openScope</span><span class="op" id="3355749">(</span><span class="op" id="3355750">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355753">p</span><span class="op" id="3355754">.</span><span class="ident" id="3355755">pkgScope</span>&nbsp;<span class="op" id="3355764">=</span>&nbsp;<span class="ident" id="3355766">p</span><span class="op" id="3355767">.</span><span class="ident" id="3355768">topScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355778">e</span>&nbsp;<span class="op" id="3355780">:=</span>&nbsp;<span class="ident" id="3355783">p</span><span class="op" id="3355784">.</span><span class="ident" id="3355785">parseRhsOrType</span><span class="op" id="3355799">(</span><span class="op" id="3355800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355803">p</span><span class="op" id="3355804">.</span><span class="ident" id="3355805">closeScope</span><span class="op" id="3355815">(</span><span class="op" id="3355816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355819">assert</span><span class="op" id="3355825">(</span><span class="ident" id="3355826">p</span><span class="op" id="3355827">.</span><span class="ident" id="3355828">topScope</span>&nbsp;<span class="op" id="3355837">==</span>&nbsp;<span class="ident" id="3355840">nil</span><span class="op" id="3355843">,</span>&nbsp;<span class="string" id="3355845">&#34;unbalanced&nbsp;scopes&#34;</span><span class="op" id="3355864">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3355868">//&nbsp;If&nbsp;a&nbsp;semicolon&nbsp;was&nbsp;inserted,&nbsp;consume&nbsp;it;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3355913">//&nbsp;report&nbsp;an&nbsp;error&nbsp;if&nbsp;there&#39;s&nbsp;more&nbsp;tokens.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355957">if</span>&nbsp;<span class="ident" id="3355960">p</span><span class="op" id="3355961">.</span><span class="ident" id="3355962">tok</span>&nbsp;<span class="op" id="3355966">==</span>&nbsp;<span class="ident" id="3355969">token</span><span class="op" id="3355974">.</span><span class="ident" id="3355975">SEMICOLON</span>&nbsp;<span class="op" id="3355985">&amp;&amp;</span>&nbsp;<span class="ident" id="3355988">p</span><span class="op" id="3355989">.</span><span class="ident" id="3355990">lit</span>&nbsp;<span class="op" id="3355994">==</span>&nbsp;<span class="string" id="3355997">&#34;\n&#34;</span>&nbsp;<span class="op" id="3356002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356006">p</span><span class="op" id="3356007">.</span><span class="ident" id="3356008">next</span><span class="op" id="3356012">(</span><span class="op" id="3356013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3356016">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356019">p</span><span class="op" id="3356020">.</span><span class="ident" id="3356021">expect</span><span class="op" id="3356027">(</span><span class="ident" id="3356028">token</span><span class="op" id="3356033">.</span><span class="ident" id="3356034">EOF</span><span class="op" id="3356037">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3356041">if</span>&nbsp;<span class="ident" id="3356044">p</span><span class="op" id="3356045">.</span><span class="ident" id="3356046">errors</span><span class="op" id="3356052">.</span><span class="ident" id="3356053">Len</span><span class="op" id="3356056">(</span><span class="op" id="3356057">)</span>&nbsp;<span class="op" id="3356059">&gt;</span>&nbsp;<span class="num" id="3356061">0</span>&nbsp;<span class="op" id="3356063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356067">p</span><span class="op" id="3356068">.</span><span class="ident" id="3356069">errors</span><span class="op" id="3356075">.</span><span class="ident" id="3356076">Sort</span><span class="op" id="3356080">(</span><span class="op" id="3356081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3356085">return</span>&nbsp;<span class="ident" id="3356092">nil</span><span class="op" id="3356095">,</span>&nbsp;<span class="ident" id="3356097">p</span><span class="op" id="3356098">.</span><span class="ident" id="3356099">errors</span><span class="op" id="3356105">.</span><span class="ident" id="3356106">Err</span><span class="op" id="3356109">(</span><span class="op" id="3356110">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3356113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3356117">return</span>&nbsp;<span class="ident" id="3356124">e</span><span class="op" id="3356125">,</span>&nbsp;<span class="ident" id="3356127">nil</span><br>
<span class="lineno"></span><span class="op" id="3356131">}</span>
</div>
</body>
</html>
