<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5144216">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5144271">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5144325">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5144376">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspPackage&nbsp;rpc&nbsp;provides&nbsp;access&nbsp;to&nbsp;the&nbsp;exported&nbsp;methods&nbsp;of&nbsp;an&nbsp;object&nbsp;across&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspnetwork&nbsp;or&nbsp;other&nbsp;I/O&nbsp;connection.&nbsp;&nbsp;A&nbsp;server&nbsp;registers&nbsp;an&nbsp;object,&nbsp;making&nbsp;it&nbsp;visible<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspas&nbsp;a&nbsp;service&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;After&nbsp;registration,&nbsp;exported<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspmethods&nbsp;of&nbsp;the&nbsp;object&nbsp;will&nbsp;be&nbsp;accessible&nbsp;remotely.&nbsp;&nbsp;A&nbsp;server&nbsp;may&nbsp;register&nbsp;multiple<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;(services)&nbsp;of&nbsp;different&nbsp;types&nbsp;but&nbsp;it&nbsp;is&nbsp;an&nbsp;error&nbsp;to&nbsp;register&nbsp;multiple<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;of&nbsp;the&nbsp;same&nbsp;type.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspOnly&nbsp;methods&nbsp;that&nbsp;satisfy&nbsp;these&nbsp;criteria&nbsp;will&nbsp;be&nbsp;made&nbsp;available&nbsp;for&nbsp;remote&nbsp;access;<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspother&nbsp;methods&nbsp;will&nbsp;be&nbsp;ignored:<br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;is&nbsp;exported.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;exported&nbsp;(or&nbsp;builtin)&nbsp;types.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&#39;s&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;return&nbsp;type&nbsp;error.<br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspIn&nbsp;effect,&nbsp;the&nbsp;method&nbsp;must&nbsp;look&nbsp;schematically&nbsp;like<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*T)&nbsp;MethodName(argType&nbsp;T1,&nbsp;replyType&nbsp;*T2)&nbsp;error<br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbspwhere&nbsp;T,&nbsp;T1&nbsp;and&nbsp;T2&nbsp;can&nbsp;be&nbsp;marshaled&nbsp;by&nbsp;encoding/gob.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThese&nbsp;requirements&nbsp;apply&nbsp;even&nbsp;if&nbsp;a&nbsp;different&nbsp;codec&nbsp;is&nbsp;used.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp(In&nbsp;the&nbsp;future,&nbsp;these&nbsp;requirements&nbsp;may&nbsp;soften&nbsp;for&nbsp;custom&nbsp;codecs.)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;first&nbsp;argument&nbsp;represents&nbsp;the&nbsp;arguments&nbsp;provided&nbsp;by&nbsp;the&nbsp;caller;&nbsp;the<br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbspsecond&nbsp;argument&nbsp;represents&nbsp;the&nbsp;result&nbsp;parameters&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;caller.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;return&nbsp;value,&nbsp;if&nbsp;non-nil,&nbsp;is&nbsp;passed&nbsp;back&nbsp;as&nbsp;a&nbsp;string&nbsp;that&nbsp;the&nbsp;client<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspsees&nbsp;as&nbsp;if&nbsp;created&nbsp;by&nbsp;errors.New.&nbsp;&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;returned,&nbsp;the&nbsp;reply&nbsp;parameter<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspwill&nbsp;not&nbsp;be&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;may&nbsp;handle&nbsp;requests&nbsp;on&nbsp;a&nbsp;single&nbsp;connection&nbsp;by&nbsp;calling&nbsp;ServeConn.&nbsp;&nbsp;More<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptypically&nbsp;it&nbsp;will&nbsp;create&nbsp;a&nbsp;network&nbsp;listener&nbsp;and&nbsp;call&nbsp;Accept&nbsp;or,&nbsp;for&nbsp;an&nbsp;HTTP<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplistener,&nbsp;HandleHTTP&nbsp;and&nbsp;http.Serve.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;client&nbsp;wishing&nbsp;to&nbsp;use&nbsp;the&nbsp;service&nbsp;establishes&nbsp;a&nbsp;connection&nbsp;and&nbsp;then&nbsp;invokes<br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbspNewClient&nbsp;on&nbsp;the&nbsp;connection.&nbsp;&nbsp;The&nbsp;convenience&nbsp;function&nbsp;Dial&nbsp;(DialHTTP)&nbsp;performs<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;steps&nbsp;for&nbsp;a&nbsp;raw&nbsp;network&nbsp;connection&nbsp;(an&nbsp;HTTP&nbsp;connection).&nbsp;&nbsp;The&nbsp;resulting<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspClient&nbsp;object&nbsp;has&nbsp;two&nbsp;methods,&nbsp;Call&nbsp;and&nbsp;Go,&nbsp;that&nbsp;specify&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspcall,&nbsp;a&nbsp;pointer&nbsp;containing&nbsp;the&nbsp;arguments,&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;receive&nbsp;the&nbsp;result<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspparameters.<br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;Call&nbsp;method&nbsp;waits&nbsp;for&nbsp;the&nbsp;remote&nbsp;call&nbsp;to&nbsp;complete&nbsp;while&nbsp;the&nbsp;Go&nbsp;method<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplaunches&nbsp;the&nbsp;call&nbsp;asynchronously&nbsp;and&nbsp;signals&nbsp;completion&nbsp;using&nbsp;the&nbsp;Call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspstructure&#39;s&nbsp;Done&nbsp;channel.<br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbspUnless&nbsp;an&nbsp;explicit&nbsp;codec&nbsp;is&nbsp;set&nbsp;up,&nbsp;package&nbsp;encoding/gob&nbsp;is&nbsp;used&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptransport&nbsp;the&nbsp;data.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspHere&nbsp;is&nbsp;a&nbsp;simple&nbsp;example.&nbsp;&nbsp;A&nbsp;server&nbsp;wishes&nbsp;to&nbsp;export&nbsp;an&nbsp;object&nbsp;of&nbsp;type&nbsp;Arith:<br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;server<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Args&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspA,&nbsp;B&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Quotient&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspQuo,&nbsp;Rem&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Arith&nbsp;int<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Multiply(args&nbsp;*Args,&nbsp;reply&nbsp;*int)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp*reply&nbsp;=&nbsp;args.A&nbsp;*&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Divide(args&nbsp;*Args,&nbsp;quo&nbsp;*Quotient)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;args.B&nbsp;==&nbsp;0&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;errors.New(&#34;divide&nbsp;by&nbsp;zero&#34;)<br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Quo&nbsp;=&nbsp;args.A&nbsp;/&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Rem&nbsp;=&nbsp;args.A&nbsp;%&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;calls&nbsp;(for&nbsp;HTTP&nbsp;service):<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsparith&nbsp;:=&nbsp;new(Arith)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.Register(arith)<br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.HandleHTTP()<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspl,&nbsp;e&nbsp;:=&nbsp;net.Listen(&#34;tcp&#34;,&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;e&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;listen&nbsp;error:&#34;,&nbsp;e)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;http.Serve(l,&nbsp;nil)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspAt&nbsp;this&nbsp;point,&nbsp;clients&nbsp;can&nbsp;see&nbsp;a&nbsp;service&nbsp;&#34;Arith&#34;&nbsp;with&nbsp;methods&nbsp;&#34;Arith.Multiply&#34;&nbsp;and<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&#34;Arith.Divide&#34;.&nbsp;&nbsp;To&nbsp;invoke&nbsp;one,&nbsp;a&nbsp;client&nbsp;first&nbsp;dials&nbsp;the&nbsp;server:<br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspclient,&nbsp;err&nbsp;:=&nbsp;rpc.DialHTTP(&#34;tcp&#34;,&nbsp;serverAddress&nbsp;+&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;dialing:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbspThen&nbsp;it&nbsp;can&nbsp;make&nbsp;a&nbsp;remote&nbsp;call:<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Synchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspargs&nbsp;:=&nbsp;&amp;server.Args{7,8}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;reply&nbsp;int<br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;client.Call(&#34;Arith.Multiply&#34;,&nbsp;args,&nbsp;&amp;reply)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;arith&nbsp;error:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfmt.Printf(&#34;Arith:&nbsp;%d*%d=%d&#34;,&nbsp;args.A,&nbsp;args.B,&nbsp;reply)<br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspor<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Asynchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquotient&nbsp;:=&nbsp;new(Quotient)<br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspdivCall&nbsp;:=&nbsp;client.Go(&#34;Arith.Divide&#34;,&nbsp;args,&nbsp;quotient,&nbsp;nil)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreplyCall&nbsp;:=&nbsp;&lt;-divCall.Done&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;will&nbsp;be&nbsp;equal&nbsp;to&nbsp;divCall<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;check&nbsp;errors,&nbsp;print,&nbsp;etc.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;server&nbsp;implementation&nbsp;will&nbsp;often&nbsp;provide&nbsp;a&nbsp;simple,&nbsp;type-safe&nbsp;wrapper&nbsp;for&nbsp;the<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbspclient.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5148205">package</span>&nbsp;<span class="ident" id="5148213">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5148218">import</span>&nbsp;<span class="op" id="5148225">(</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5148228">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5148237">&#34;encoding/gob&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5148253">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5148263">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5148269">&#34;log&#34;</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5148276">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5148283">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5148295">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5148306">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5148317">&#34;sync&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5148325">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5148336">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5148351">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5148354">const</span>&nbsp;<span class="op" id="5148360">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5148363">//&nbsp;Defaults&nbsp;used&nbsp;by&nbsp;HandleHTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148395">DefaultRPCPath</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5148412">=</span>&nbsp;<span class="string" id="5148414">&#34;/_goRPC_&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148426">DefaultDebugPath</span>&nbsp;<span class="op" id="5148443">=</span>&nbsp;<span class="string" id="5148445">&#34;/debug/rpc&#34;</span><br>
<span class="lineno"></span><span class="op" id="5148458">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="5148461">//&nbsp;Precompute&nbsp;the&nbsp;reflect&nbsp;type&nbsp;for&nbsp;error.&nbsp;&nbsp;Can&#39;t&nbsp;use&nbsp;error&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="5148529">//&nbsp;because&nbsp;Typeof&nbsp;takes&nbsp;an&nbsp;empty&nbsp;interface&nbsp;value.&nbsp;&nbsp;This&nbsp;is&nbsp;annoying.</span><br>
<span class="lineno"></span><span class="keyword" id="5148598">var</span>&nbsp;<span class="ident" id="5148602">typeOfError</span>&nbsp;<span class="op" id="5148614">=</span>&nbsp;<span class="ident" id="5148616">reflect</span><span class="op" id="5148623">.</span><span class="ident" id="5148624">TypeOf</span><span class="op" id="5148630">(</span><span class="op" id="5148631">(</span><span class="op" id="5148632">*</span><span class="builtintype" id="5148633">error</span><span class="op" id="5148638">)</span><span class="op" id="5148639">(</span><span class="ident" id="5148640">nil</span><span class="op" id="5148643">)</span><span class="op" id="5148644">)</span><span class="op" id="5148645">.</span><span class="ident" id="5148646">Elem</span><span class="op" id="5148650">(</span><span class="op" id="5148651">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5148654">type</span>&nbsp;<span class="ident" id="5148659">methodType</span>&nbsp;<span class="keyword" id="5148670">struct</span>&nbsp;<span class="op" id="5148677">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148680">sync</span><span class="op" id="5148684">.</span><span class="ident" id="5148685">Mutex</span>&nbsp;<span class="comment" id="5148691">//&nbsp;protects&nbsp;counters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148713">method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5148724">reflect</span><span class="op" id="5148731">.</span><span class="ident" id="5148732">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148740">ArgType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5148751">reflect</span><span class="op" id="5148758">.</span><span class="ident" id="5148759">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148765">ReplyType</span>&nbsp;&nbsp;<span class="ident" id="5148776">reflect</span><span class="op" id="5148783">.</span><span class="ident" id="5148784">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148790">numCalls</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5148801">uint</span><br>
<span class="lineno">155</span><span class="op" id="5148806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5148809">type</span>&nbsp;<span class="ident" id="5148814">service</span>&nbsp;<span class="keyword" id="5148822">struct</span>&nbsp;<span class="op" id="5148829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148832">name</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5148839">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5148862">//&nbsp;name&nbsp;of&nbsp;service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148882">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5148889">reflect</span><span class="op" id="5148896">.</span><span class="ident" id="5148897">Value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5148912">//&nbsp;receiver&nbsp;of&nbsp;methods&nbsp;for&nbsp;the&nbsp;service</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148952">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5148959">reflect</span><span class="op" id="5148966">.</span><span class="ident" id="5148967">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5148982">//&nbsp;type&nbsp;of&nbsp;the&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149007">method</span>&nbsp;<span class="keyword" id="5149014">map</span><span class="op" id="5149017">[</span><span class="builtintype" id="5149018">string</span><span class="op" id="5149024">]</span><span class="op" id="5149025">*</span><span class="ident" id="5149026">methodType</span>&nbsp;<span class="comment" id="5149037">//&nbsp;registered&nbsp;methods</span><br>
<span class="lineno"></span><span class="op" id="5149059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5149062">//&nbsp;Request&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;call.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno">165</span><span class="comment" id="5149139">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno"></span><span class="comment" id="5149209">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5149229">type</span>&nbsp;<span class="ident" id="5149234">Request</span>&nbsp;<span class="keyword" id="5149242">struct</span>&nbsp;<span class="op" id="5149249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149252">ServiceMethod</span>&nbsp;<span class="builtintype" id="5149266">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5149275">//&nbsp;format:&nbsp;&#34;Service.Method&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149304">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5149318">uint64</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5149327">//&nbsp;sequence&nbsp;number&nbsp;chosen&nbsp;by&nbsp;client</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149364">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5149378">*</span><span class="ident" id="5149379">Request</span>&nbsp;<span class="comment" id="5149387">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5149414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5149417">//&nbsp;Response&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;return.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno"></span><span class="comment" id="5149497">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno">175</span><span class="comment" id="5149567">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5149587">type</span>&nbsp;<span class="ident" id="5149592">Response</span>&nbsp;<span class="keyword" id="5149601">struct</span>&nbsp;<span class="op" id="5149608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149611">ServiceMethod</span>&nbsp;<span class="builtintype" id="5149625">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5149635">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149666">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5149680">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5149690">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149721">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5149735">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5149745">//&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149764">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5149778">*</span><span class="ident" id="5149779">Response</span>&nbsp;<span class="comment" id="5149788">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5149815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5149818">//&nbsp;Server&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5149854">type</span>&nbsp;<span class="ident" id="5149859">Server</span>&nbsp;<span class="keyword" id="5149866">struct</span>&nbsp;<span class="op" id="5149873">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149876">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5149887">sync</span><span class="op" id="5149891">.</span><span class="ident" id="5149892">RWMutex</span>&nbsp;<span class="comment" id="5149900">//&nbsp;protects&nbsp;the&nbsp;serviceMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149928">serviceMap</span>&nbsp;<span class="keyword" id="5149939">map</span><span class="op" id="5149942">[</span><span class="builtintype" id="5149943">string</span><span class="op" id="5149949">]</span><span class="op" id="5149950">*</span><span class="ident" id="5149951">service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149960">reqLock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5149971">sync</span><span class="op" id="5149975">.</span><span class="ident" id="5149976">Mutex</span>&nbsp;<span class="comment" id="5149982">//&nbsp;protects&nbsp;freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150003">freeReq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5150014">*</span><span class="ident" id="5150015">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150024">respLock</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5150035">sync</span><span class="op" id="5150039">.</span><span class="ident" id="5150040">Mutex</span>&nbsp;<span class="comment" id="5150046">//&nbsp;protects&nbsp;freeResp</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150068">freeResp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5150079">*</span><span class="ident" id="5150080">Response</span><br>
<span class="lineno"></span><span class="op" id="5150089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5150092">//&nbsp;NewServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5150127">func</span>&nbsp;<span class="ident" id="5150132">NewServer</span><span class="op" id="5150141">(</span><span class="op" id="5150142">)</span>&nbsp;<span class="op" id="5150144">*</span><span class="ident" id="5150145">Server</span>&nbsp;<span class="op" id="5150152">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150155">return</span>&nbsp;<span class="op" id="5150162">&amp;</span><span class="ident" id="5150163">Server</span><span class="op" id="5150169">{</span><span class="ident" id="5150170">serviceMap</span><span class="op" id="5150180">:</span>&nbsp;<span class="builtinfunc" id="5150182">make</span><span class="op" id="5150186">(</span><span class="keyword" id="5150187">map</span><span class="op" id="5150190">[</span><span class="builtintype" id="5150191">string</span><span class="op" id="5150197">]</span><span class="op" id="5150198">*</span><span class="ident" id="5150199">service</span><span class="op" id="5150206">)</span><span class="op" id="5150207">}</span><br>
<span class="lineno"></span><span class="op" id="5150209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5150212">//&nbsp;DefaultServer&nbsp;is&nbsp;the&nbsp;default&nbsp;instance&nbsp;of&nbsp;*Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5150265">var</span>&nbsp;<span class="ident" id="5150269">DefaultServer</span>&nbsp;<span class="op" id="5150283">=</span>&nbsp;<span class="ident" id="5150285">NewServer</span><span class="op" id="5150294">(</span><span class="op" id="5150295">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5150298">//&nbsp;Is&nbsp;this&nbsp;an&nbsp;exported&nbsp;-&nbsp;upper&nbsp;case&nbsp;-&nbsp;name?</span><br>
<span class="lineno"></span><span class="keyword" id="5150342">func</span>&nbsp;<span class="ident" id="5150347">isExported</span><span class="op" id="5150357">(</span><span class="ident" id="5150358">name</span>&nbsp;<span class="builtintype" id="5150363">string</span><span class="op" id="5150369">)</span>&nbsp;<span class="builtintype" id="5150371">bool</span>&nbsp;<span class="op" id="5150376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5150379">rune</span><span class="op" id="5150383">,</span>&nbsp;<span class="ident" id="5150385">_</span>&nbsp;<span class="op" id="5150387">:=</span>&nbsp;<span class="ident" id="5150390">utf8</span><span class="op" id="5150394">.</span><span class="ident" id="5150395">DecodeRuneInString</span><span class="op" id="5150413">(</span><span class="ident" id="5150414">name</span><span class="op" id="5150418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150421">return</span>&nbsp;<span class="ident" id="5150428">unicode</span><span class="op" id="5150435">.</span><span class="ident" id="5150436">IsUpper</span><span class="op" id="5150443">(</span><span class="builtintype" id="5150444">rune</span><span class="op" id="5150448">)</span><br>
<span class="lineno">205</span><span class="op" id="5150450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5150453">//&nbsp;Is&nbsp;this&nbsp;type&nbsp;exported&nbsp;or&nbsp;a&nbsp;builtin?</span><br>
<span class="lineno"></span><span class="keyword" id="5150492">func</span>&nbsp;<span class="ident" id="5150497">isExportedOrBuiltinType</span><span class="op" id="5150520">(</span><span class="ident" id="5150521">t</span>&nbsp;<span class="ident" id="5150523">reflect</span><span class="op" id="5150530">.</span><span class="ident" id="5150531">Type</span><span class="op" id="5150535">)</span>&nbsp;<span class="builtintype" id="5150537">bool</span>&nbsp;<span class="op" id="5150542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150545">for</span>&nbsp;<span class="ident" id="5150549">t</span><span class="op" id="5150550">.</span><span class="ident" id="5150551">Kind</span><span class="op" id="5150555">(</span><span class="op" id="5150556">)</span>&nbsp;<span class="op" id="5150558">==</span>&nbsp;<span class="ident" id="5150561">reflect</span><span class="op" id="5150568">.</span><span class="ident" id="5150569">Ptr</span>&nbsp;<span class="op" id="5150573">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150577">t</span>&nbsp;<span class="op" id="5150579">=</span>&nbsp;<span class="ident" id="5150581">t</span><span class="op" id="5150582">.</span><span class="ident" id="5150583">Elem</span><span class="op" id="5150587">(</span><span class="op" id="5150588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5150594">//&nbsp;PkgPath&nbsp;will&nbsp;be&nbsp;non-empty&nbsp;even&nbsp;for&nbsp;an&nbsp;exported&nbsp;type,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5150651">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;the&nbsp;type&nbsp;name&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150698">return</span>&nbsp;<span class="ident" id="5150705">isExported</span><span class="op" id="5150715">(</span><span class="ident" id="5150716">t</span><span class="op" id="5150717">.</span><span class="ident" id="5150718">Name</span><span class="op" id="5150722">(</span><span class="op" id="5150723">)</span><span class="op" id="5150724">)</span>&nbsp;<span class="op" id="5150726">||</span>&nbsp;<span class="ident" id="5150729">t</span><span class="op" id="5150730">.</span><span class="ident" id="5150731">PkgPath</span><span class="op" id="5150738">(</span><span class="op" id="5150739">)</span>&nbsp;<span class="op" id="5150741">==</span>&nbsp;<span class="string" id="5150744">&#34;&#34;</span><br>
<span class="lineno">215</span><span class="op" id="5150747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5150750">//&nbsp;Register&nbsp;publishes&nbsp;in&nbsp;the&nbsp;server&nbsp;the&nbsp;set&nbsp;of&nbsp;methods&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5150812">//&nbsp;receiver&nbsp;value&nbsp;that&nbsp;satisfy&nbsp;the&nbsp;following&nbsp;conditions:</span><br>
<span class="lineno"></span><span class="comment" id="5150869">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;exported&nbsp;method</span><br>
<span class="lineno">220</span><span class="comment" id="5150890">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;of&nbsp;exported&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5150932">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span><span class="comment" id="5150970">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;one&nbsp;return&nbsp;value,&nbsp;of&nbsp;type&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5151007">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;receiver&nbsp;is&nbsp;not&nbsp;an&nbsp;exported&nbsp;type&nbsp;or&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="5151077">//&nbsp;no&nbsp;suitable&nbsp;methods.&nbsp;It&nbsp;also&nbsp;logs&nbsp;the&nbsp;error&nbsp;using&nbsp;package&nbsp;log.</span><br>
<span class="lineno">225</span><span class="comment" id="5151143">//&nbsp;The&nbsp;client&nbsp;accesses&nbsp;each&nbsp;method&nbsp;using&nbsp;a&nbsp;string&nbsp;of&nbsp;the&nbsp;form&nbsp;&#34;Type.Method&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="5151220">//&nbsp;where&nbsp;Type&nbsp;is&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5151267">func</span>&nbsp;<span class="op" id="5151272">(</span><span class="ident" id="5151273">server</span>&nbsp;<span class="op" id="5151280">*</span><span class="ident" id="5151281">Server</span><span class="op" id="5151287">)</span>&nbsp;<span class="ident" id="5151289">Register</span><span class="op" id="5151297">(</span><span class="ident" id="5151298">rcvr</span>&nbsp;<span class="keyword" id="5151303">interface</span><span class="op" id="5151312">{</span><span class="op" id="5151313">}</span><span class="op" id="5151314">)</span>&nbsp;<span class="builtintype" id="5151316">error</span>&nbsp;<span class="op" id="5151322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151325">return</span>&nbsp;<span class="ident" id="5151332">server</span><span class="op" id="5151338">.</span><span class="ident" id="5151339">register</span><span class="op" id="5151347">(</span><span class="ident" id="5151348">rcvr</span><span class="op" id="5151352">,</span>&nbsp;<span class="string" id="5151354">&#34;&#34;</span><span class="op" id="5151356">,</span>&nbsp;<span class="builtintype" id="5151358">false</span><span class="op" id="5151363">)</span><br>
<span class="lineno"></span><span class="op" id="5151365">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5151368">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5151441">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5151485">func</span>&nbsp;<span class="op" id="5151490">(</span><span class="ident" id="5151491">server</span>&nbsp;<span class="op" id="5151498">*</span><span class="ident" id="5151499">Server</span><span class="op" id="5151505">)</span>&nbsp;<span class="ident" id="5151507">RegisterName</span><span class="op" id="5151519">(</span><span class="ident" id="5151520">name</span>&nbsp;<span class="builtintype" id="5151525">string</span><span class="op" id="5151531">,</span>&nbsp;<span class="ident" id="5151533">rcvr</span>&nbsp;<span class="keyword" id="5151538">interface</span><span class="op" id="5151547">{</span><span class="op" id="5151548">}</span><span class="op" id="5151549">)</span>&nbsp;<span class="builtintype" id="5151551">error</span>&nbsp;<span class="op" id="5151557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151560">return</span>&nbsp;<span class="ident" id="5151567">server</span><span class="op" id="5151573">.</span><span class="ident" id="5151574">register</span><span class="op" id="5151582">(</span><span class="ident" id="5151583">rcvr</span><span class="op" id="5151587">,</span>&nbsp;<span class="ident" id="5151589">name</span><span class="op" id="5151593">,</span>&nbsp;<span class="builtintype" id="5151595">true</span><span class="op" id="5151599">)</span><br>
<span class="lineno">235</span><span class="op" id="5151601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5151604">func</span>&nbsp;<span class="op" id="5151609">(</span><span class="ident" id="5151610">server</span>&nbsp;<span class="op" id="5151617">*</span><span class="ident" id="5151618">Server</span><span class="op" id="5151624">)</span>&nbsp;<span class="ident" id="5151626">register</span><span class="op" id="5151634">(</span><span class="ident" id="5151635">rcvr</span>&nbsp;<span class="keyword" id="5151640">interface</span><span class="op" id="5151649">{</span><span class="op" id="5151650">}</span><span class="op" id="5151651">,</span>&nbsp;<span class="ident" id="5151653">name</span>&nbsp;<span class="builtintype" id="5151658">string</span><span class="op" id="5151664">,</span>&nbsp;<span class="ident" id="5151666">useName</span>&nbsp;<span class="builtintype" id="5151674">bool</span><span class="op" id="5151678">)</span>&nbsp;<span class="builtintype" id="5151680">error</span>&nbsp;<span class="op" id="5151686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151689">server</span><span class="op" id="5151695">.</span><span class="ident" id="5151696">mu</span><span class="op" id="5151698">.</span><span class="ident" id="5151699">Lock</span><span class="op" id="5151703">(</span><span class="op" id="5151704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151707">defer</span>&nbsp;<span class="ident" id="5151713">server</span><span class="op" id="5151719">.</span><span class="ident" id="5151720">mu</span><span class="op" id="5151722">.</span><span class="ident" id="5151723">Unlock</span><span class="op" id="5151729">(</span><span class="op" id="5151730">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151733">if</span>&nbsp;<span class="ident" id="5151736">server</span><span class="op" id="5151742">.</span><span class="ident" id="5151743">serviceMap</span>&nbsp;<span class="op" id="5151754">==</span>&nbsp;<span class="ident" id="5151757">nil</span>&nbsp;<span class="op" id="5151761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151765">server</span><span class="op" id="5151771">.</span><span class="ident" id="5151772">serviceMap</span>&nbsp;<span class="op" id="5151783">=</span>&nbsp;<span class="builtinfunc" id="5151785">make</span><span class="op" id="5151789">(</span><span class="keyword" id="5151790">map</span><span class="op" id="5151793">[</span><span class="builtintype" id="5151794">string</span><span class="op" id="5151800">]</span><span class="op" id="5151801">*</span><span class="ident" id="5151802">service</span><span class="op" id="5151809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151815">s</span>&nbsp;<span class="op" id="5151817">:=</span>&nbsp;<span class="builtinfunc" id="5151820">new</span><span class="op" id="5151823">(</span><span class="ident" id="5151824">service</span><span class="op" id="5151831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151834">s</span><span class="op" id="5151835">.</span><span class="ident" id="5151836">typ</span>&nbsp;<span class="op" id="5151840">=</span>&nbsp;<span class="ident" id="5151842">reflect</span><span class="op" id="5151849">.</span><span class="ident" id="5151850">TypeOf</span><span class="op" id="5151856">(</span><span class="ident" id="5151857">rcvr</span><span class="op" id="5151861">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151864">s</span><span class="op" id="5151865">.</span><span class="ident" id="5151866">rcvr</span>&nbsp;<span class="op" id="5151871">=</span>&nbsp;<span class="ident" id="5151873">reflect</span><span class="op" id="5151880">.</span><span class="ident" id="5151881">ValueOf</span><span class="op" id="5151888">(</span><span class="ident" id="5151889">rcvr</span><span class="op" id="5151893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151896">sname</span>&nbsp;<span class="op" id="5151902">:=</span>&nbsp;<span class="ident" id="5151905">reflect</span><span class="op" id="5151912">.</span><span class="ident" id="5151913">Indirect</span><span class="op" id="5151921">(</span><span class="ident" id="5151922">s</span><span class="op" id="5151923">.</span><span class="ident" id="5151924">rcvr</span><span class="op" id="5151928">)</span><span class="op" id="5151929">.</span><span class="ident" id="5151930">Type</span><span class="op" id="5151934">(</span><span class="op" id="5151935">)</span><span class="op" id="5151936">.</span><span class="ident" id="5151937">Name</span><span class="op" id="5151941">(</span><span class="op" id="5151942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151945">if</span>&nbsp;<span class="ident" id="5151948">useName</span>&nbsp;<span class="op" id="5151956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151960">sname</span>&nbsp;<span class="op" id="5151966">=</span>&nbsp;<span class="ident" id="5151968">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151974">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151977">if</span>&nbsp;<span class="ident" id="5151980">sname</span>&nbsp;<span class="op" id="5151986">==</span>&nbsp;<span class="string" id="5151989">&#34;&#34;</span>&nbsp;<span class="op" id="5151992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151996">s</span>&nbsp;<span class="op" id="5151998">:=</span>&nbsp;<span class="string" id="5152001">&#34;rpc.Register:&nbsp;no&nbsp;service&nbsp;name&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5152043">+</span>&nbsp;<span class="ident" id="5152045">s</span><span class="op" id="5152046">.</span><span class="ident" id="5152047">typ</span><span class="op" id="5152050">.</span><span class="ident" id="5152051">String</span><span class="op" id="5152057">(</span><span class="op" id="5152058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152062">log</span><span class="op" id="5152065">.</span><span class="ident" id="5152066">Print</span><span class="op" id="5152071">(</span><span class="ident" id="5152072">s</span><span class="op" id="5152073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152077">return</span>&nbsp;<span class="ident" id="5152084">errors</span><span class="op" id="5152090">.</span><span class="ident" id="5152091">New</span><span class="op" id="5152094">(</span><span class="ident" id="5152095">s</span><span class="op" id="5152096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152099">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152102">if</span>&nbsp;<span class="op" id="5152105">!</span><span class="ident" id="5152106">isExported</span><span class="op" id="5152116">(</span><span class="ident" id="5152117">sname</span><span class="op" id="5152122">)</span>&nbsp;<span class="op" id="5152124">&amp;&amp;</span>&nbsp;<span class="op" id="5152127">!</span><span class="ident" id="5152128">useName</span>&nbsp;<span class="op" id="5152136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152140">s</span>&nbsp;<span class="op" id="5152142">:=</span>&nbsp;<span class="string" id="5152145">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5152167">+</span>&nbsp;<span class="ident" id="5152169">sname</span>&nbsp;<span class="op" id="5152175">+</span>&nbsp;<span class="string" id="5152177">&#34;&nbsp;is&nbsp;not&nbsp;exported&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152198">log</span><span class="op" id="5152201">.</span><span class="ident" id="5152202">Print</span><span class="op" id="5152207">(</span><span class="ident" id="5152208">s</span><span class="op" id="5152209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152213">return</span>&nbsp;<span class="ident" id="5152220">errors</span><span class="op" id="5152226">.</span><span class="ident" id="5152227">New</span><span class="op" id="5152230">(</span><span class="ident" id="5152231">s</span><span class="op" id="5152232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152235">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152238">if</span>&nbsp;<span class="ident" id="5152241">_</span><span class="op" id="5152242">,</span>&nbsp;<span class="ident" id="5152244">present</span>&nbsp;<span class="op" id="5152252">:=</span>&nbsp;<span class="ident" id="5152255">server</span><span class="op" id="5152261">.</span><span class="ident" id="5152262">serviceMap</span><span class="op" id="5152272">[</span><span class="ident" id="5152273">sname</span><span class="op" id="5152278">]</span><span class="op" id="5152279">;</span>&nbsp;<span class="ident" id="5152281">present</span>&nbsp;<span class="op" id="5152289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152293">return</span>&nbsp;<span class="ident" id="5152300">errors</span><span class="op" id="5152306">.</span><span class="ident" id="5152307">New</span><span class="op" id="5152310">(</span><span class="string" id="5152311">&#34;rpc:&nbsp;service&nbsp;already&nbsp;defined:&nbsp;&#34;</span>&nbsp;<span class="op" id="5152344">+</span>&nbsp;<span class="ident" id="5152346">sname</span><span class="op" id="5152351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152357">s</span><span class="op" id="5152358">.</span><span class="ident" id="5152359">name</span>&nbsp;<span class="op" id="5152364">=</span>&nbsp;<span class="ident" id="5152366">sname</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5152374">//&nbsp;Install&nbsp;the&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152398">s</span><span class="op" id="5152399">.</span><span class="ident" id="5152400">method</span>&nbsp;<span class="op" id="5152407">=</span>&nbsp;<span class="ident" id="5152409">suitableMethods</span><span class="op" id="5152424">(</span><span class="ident" id="5152425">s</span><span class="op" id="5152426">.</span><span class="ident" id="5152427">typ</span><span class="op" id="5152430">,</span>&nbsp;<span class="builtintype" id="5152432">true</span><span class="op" id="5152436">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152440">if</span>&nbsp;<span class="builtinfunc" id="5152443">len</span><span class="op" id="5152446">(</span><span class="ident" id="5152447">s</span><span class="op" id="5152448">.</span><span class="ident" id="5152449">method</span><span class="op" id="5152455">)</span>&nbsp;<span class="op" id="5152457">==</span>&nbsp;<span class="num" id="5152460">0</span>&nbsp;<span class="op" id="5152462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152466">str</span>&nbsp;<span class="op" id="5152470">:=</span>&nbsp;<span class="string" id="5152473">&#34;&#34;</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5152479">//&nbsp;To&nbsp;help&nbsp;the&nbsp;user,&nbsp;see&nbsp;if&nbsp;a&nbsp;pointer&nbsp;receiver&nbsp;would&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152540">method</span>&nbsp;<span class="op" id="5152547">:=</span>&nbsp;<span class="ident" id="5152550">suitableMethods</span><span class="op" id="5152565">(</span><span class="ident" id="5152566">reflect</span><span class="op" id="5152573">.</span><span class="ident" id="5152574">PtrTo</span><span class="op" id="5152579">(</span><span class="ident" id="5152580">s</span><span class="op" id="5152581">.</span><span class="ident" id="5152582">typ</span><span class="op" id="5152585">)</span><span class="op" id="5152586">,</span>&nbsp;<span class="builtintype" id="5152588">false</span><span class="op" id="5152593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152597">if</span>&nbsp;<span class="builtinfunc" id="5152600">len</span><span class="op" id="5152603">(</span><span class="ident" id="5152604">method</span><span class="op" id="5152610">)</span>&nbsp;<span class="op" id="5152612">!=</span>&nbsp;<span class="num" id="5152615">0</span>&nbsp;<span class="op" id="5152617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152622">str</span>&nbsp;<span class="op" id="5152626">=</span>&nbsp;<span class="string" id="5152628">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5152650">+</span>&nbsp;<span class="ident" id="5152652">sname</span>&nbsp;<span class="op" id="5152658">+</span>&nbsp;<span class="string" id="5152660">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&nbsp;(hint:&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;value&nbsp;of&nbsp;that&nbsp;type)&#34;</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152751">}</span>&nbsp;<span class="keyword" id="5152753">else</span>&nbsp;<span class="op" id="5152758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152763">str</span>&nbsp;<span class="op" id="5152767">=</span>&nbsp;<span class="string" id="5152769">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5152791">+</span>&nbsp;<span class="ident" id="5152793">sname</span>&nbsp;<span class="op" id="5152799">+</span>&nbsp;<span class="string" id="5152801">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152851">log</span><span class="op" id="5152854">.</span><span class="ident" id="5152855">Print</span><span class="op" id="5152860">(</span><span class="ident" id="5152861">str</span><span class="op" id="5152864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152868">return</span>&nbsp;<span class="ident" id="5152875">errors</span><span class="op" id="5152881">.</span><span class="ident" id="5152882">New</span><span class="op" id="5152885">(</span><span class="ident" id="5152886">str</span><span class="op" id="5152889">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152895">server</span><span class="op" id="5152901">.</span><span class="ident" id="5152902">serviceMap</span><span class="op" id="5152912">[</span><span class="ident" id="5152913">s</span><span class="op" id="5152914">.</span><span class="ident" id="5152915">name</span><span class="op" id="5152919">]</span>&nbsp;<span class="op" id="5152921">=</span>&nbsp;<span class="ident" id="5152923">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152926">return</span>&nbsp;<span class="ident" id="5152933">nil</span><br>
<span class="lineno"></span><span class="op" id="5152937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="5152940">//&nbsp;suitableMethods&nbsp;returns&nbsp;suitable&nbsp;Rpc&nbsp;methods&nbsp;of&nbsp;typ,&nbsp;it&nbsp;will&nbsp;report</span><br>
<span class="lineno"></span><span class="comment" id="5153011">//&nbsp;error&nbsp;using&nbsp;log&nbsp;if&nbsp;reportErr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="5153052">func</span>&nbsp;<span class="ident" id="5153057">suitableMethods</span><span class="op" id="5153072">(</span><span class="ident" id="5153073">typ</span>&nbsp;<span class="ident" id="5153077">reflect</span><span class="op" id="5153084">.</span><span class="ident" id="5153085">Type</span><span class="op" id="5153089">,</span>&nbsp;<span class="ident" id="5153091">reportErr</span>&nbsp;<span class="builtintype" id="5153101">bool</span><span class="op" id="5153105">)</span>&nbsp;<span class="keyword" id="5153107">map</span><span class="op" id="5153110">[</span><span class="builtintype" id="5153111">string</span><span class="op" id="5153117">]</span><span class="op" id="5153118">*</span><span class="ident" id="5153119">methodType</span>&nbsp;<span class="op" id="5153130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153133">methods</span>&nbsp;<span class="op" id="5153141">:=</span>&nbsp;<span class="builtinfunc" id="5153144">make</span><span class="op" id="5153148">(</span><span class="keyword" id="5153149">map</span><span class="op" id="5153152">[</span><span class="builtintype" id="5153153">string</span><span class="op" id="5153159">]</span><span class="op" id="5153160">*</span><span class="ident" id="5153161">methodType</span><span class="op" id="5153171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153174">for</span>&nbsp;<span class="ident" id="5153178">m</span>&nbsp;<span class="op" id="5153180">:=</span>&nbsp;<span class="num" id="5153183">0</span><span class="op" id="5153184">;</span>&nbsp;<span class="ident" id="5153186">m</span>&nbsp;<span class="op" id="5153188">&lt;</span>&nbsp;<span class="ident" id="5153190">typ</span><span class="op" id="5153193">.</span><span class="ident" id="5153194">NumMethod</span><span class="op" id="5153203">(</span><span class="op" id="5153204">)</span><span class="op" id="5153205">;</span>&nbsp;<span class="ident" id="5153207">m</span><span class="op" id="5153208">++</span>&nbsp;<span class="op" id="5153211">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153215">method</span>&nbsp;<span class="op" id="5153222">:=</span>&nbsp;<span class="ident" id="5153225">typ</span><span class="op" id="5153228">.</span><span class="ident" id="5153229">Method</span><span class="op" id="5153235">(</span><span class="ident" id="5153236">m</span><span class="op" id="5153237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153241">mtype</span>&nbsp;<span class="op" id="5153247">:=</span>&nbsp;<span class="ident" id="5153250">method</span><span class="op" id="5153256">.</span><span class="ident" id="5153257">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153264">mname</span>&nbsp;<span class="op" id="5153270">:=</span>&nbsp;<span class="ident" id="5153273">method</span><span class="op" id="5153279">.</span><span class="ident" id="5153280">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5153287">//&nbsp;Method&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153317">if</span>&nbsp;<span class="ident" id="5153320">method</span><span class="op" id="5153326">.</span><span class="ident" id="5153327">PkgPath</span>&nbsp;<span class="op" id="5153335">!=</span>&nbsp;<span class="string" id="5153338">&#34;&#34;</span>&nbsp;<span class="op" id="5153341">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153346">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5153361">//&nbsp;Method&nbsp;needs&nbsp;three&nbsp;ins:&nbsp;receiver,&nbsp;*args,&nbsp;*reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153415">if</span>&nbsp;<span class="ident" id="5153418">mtype</span><span class="op" id="5153423">.</span><span class="ident" id="5153424">NumIn</span><span class="op" id="5153429">(</span><span class="op" id="5153430">)</span>&nbsp;<span class="op" id="5153432">!=</span>&nbsp;<span class="num" id="5153435">3</span>&nbsp;<span class="op" id="5153437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153442">if</span>&nbsp;<span class="ident" id="5153445">reportErr</span>&nbsp;<span class="op" id="5153455">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153461">log</span><span class="op" id="5153464">.</span><span class="ident" id="5153465">Println</span><span class="op" id="5153472">(</span><span class="string" id="5153473">&#34;method&#34;</span><span class="op" id="5153481">,</span>&nbsp;<span class="ident" id="5153483">mname</span><span class="op" id="5153488">,</span>&nbsp;<span class="string" id="5153490">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;ins:&#34;</span><span class="op" id="5153516">,</span>&nbsp;<span class="ident" id="5153518">mtype</span><span class="op" id="5153523">.</span><span class="ident" id="5153524">NumIn</span><span class="op" id="5153529">(</span><span class="op" id="5153530">)</span><span class="op" id="5153531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153541">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5153556">//&nbsp;First&nbsp;arg&nbsp;need&nbsp;not&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153594">argType</span>&nbsp;<span class="op" id="5153602">:=</span>&nbsp;<span class="ident" id="5153605">mtype</span><span class="op" id="5153610">.</span><span class="ident" id="5153611">In</span><span class="op" id="5153613">(</span><span class="num" id="5153614">1</span><span class="op" id="5153615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153619">if</span>&nbsp;<span class="op" id="5153622">!</span><span class="ident" id="5153623">isExportedOrBuiltinType</span><span class="op" id="5153646">(</span><span class="ident" id="5153647">argType</span><span class="op" id="5153654">)</span>&nbsp;<span class="op" id="5153656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153661">if</span>&nbsp;<span class="ident" id="5153664">reportErr</span>&nbsp;<span class="op" id="5153674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153680">log</span><span class="op" id="5153683">.</span><span class="ident" id="5153684">Println</span><span class="op" id="5153691">(</span><span class="ident" id="5153692">mname</span><span class="op" id="5153697">,</span>&nbsp;<span class="string" id="5153699">&#34;argument&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5153728">,</span>&nbsp;<span class="ident" id="5153730">argType</span><span class="op" id="5153737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153742">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153747">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5153762">//&nbsp;Second&nbsp;arg&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153797">replyType</span>&nbsp;<span class="op" id="5153807">:=</span>&nbsp;<span class="ident" id="5153810">mtype</span><span class="op" id="5153815">.</span><span class="ident" id="5153816">In</span><span class="op" id="5153818">(</span><span class="num" id="5153819">2</span><span class="op" id="5153820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153824">if</span>&nbsp;<span class="ident" id="5153827">replyType</span><span class="op" id="5153836">.</span><span class="ident" id="5153837">Kind</span><span class="op" id="5153841">(</span><span class="op" id="5153842">)</span>&nbsp;<span class="op" id="5153844">!=</span>&nbsp;<span class="ident" id="5153847">reflect</span><span class="op" id="5153854">.</span><span class="ident" id="5153855">Ptr</span>&nbsp;<span class="op" id="5153859">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153864">if</span>&nbsp;<span class="ident" id="5153867">reportErr</span>&nbsp;<span class="op" id="5153877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153883">log</span><span class="op" id="5153886">.</span><span class="ident" id="5153887">Println</span><span class="op" id="5153894">(</span><span class="string" id="5153895">&#34;method&#34;</span><span class="op" id="5153903">,</span>&nbsp;<span class="ident" id="5153905">mname</span><span class="op" id="5153910">,</span>&nbsp;<span class="string" id="5153912">&#34;reply&nbsp;type&nbsp;not&nbsp;a&nbsp;pointer:&#34;</span><span class="op" id="5153939">,</span>&nbsp;<span class="ident" id="5153941">replyType</span><span class="op" id="5153950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153960">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153971">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5153975">//&nbsp;Reply&nbsp;type&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154009">if</span>&nbsp;<span class="op" id="5154012">!</span><span class="ident" id="5154013">isExportedOrBuiltinType</span><span class="op" id="5154036">(</span><span class="ident" id="5154037">replyType</span><span class="op" id="5154046">)</span>&nbsp;<span class="op" id="5154048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154053">if</span>&nbsp;<span class="ident" id="5154056">reportErr</span>&nbsp;<span class="op" id="5154066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154072">log</span><span class="op" id="5154075">.</span><span class="ident" id="5154076">Println</span><span class="op" id="5154083">(</span><span class="string" id="5154084">&#34;method&#34;</span><span class="op" id="5154092">,</span>&nbsp;<span class="ident" id="5154094">mname</span><span class="op" id="5154099">,</span>&nbsp;<span class="string" id="5154101">&#34;reply&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5154127">,</span>&nbsp;<span class="ident" id="5154129">replyType</span><span class="op" id="5154138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5154143">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154148">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5154159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5154163">//&nbsp;Method&nbsp;needs&nbsp;one&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154190">if</span>&nbsp;<span class="ident" id="5154193">mtype</span><span class="op" id="5154198">.</span><span class="ident" id="5154199">NumOut</span><span class="op" id="5154205">(</span><span class="op" id="5154206">)</span>&nbsp;<span class="op" id="5154208">!=</span>&nbsp;<span class="num" id="5154211">1</span>&nbsp;<span class="op" id="5154213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154218">if</span>&nbsp;<span class="ident" id="5154221">reportErr</span>&nbsp;<span class="op" id="5154231">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154237">log</span><span class="op" id="5154240">.</span><span class="ident" id="5154241">Println</span><span class="op" id="5154248">(</span><span class="string" id="5154249">&#34;method&#34;</span><span class="op" id="5154257">,</span>&nbsp;<span class="ident" id="5154259">mname</span><span class="op" id="5154264">,</span>&nbsp;<span class="string" id="5154266">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;outs:&#34;</span><span class="op" id="5154293">,</span>&nbsp;<span class="ident" id="5154295">mtype</span><span class="op" id="5154300">.</span><span class="ident" id="5154301">NumOut</span><span class="op" id="5154307">(</span><span class="op" id="5154308">)</span><span class="op" id="5154309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5154314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154319">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5154330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5154334">//&nbsp;The&nbsp;return&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;must&nbsp;be&nbsp;error.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154384">if</span>&nbsp;<span class="ident" id="5154387">returnType</span>&nbsp;<span class="op" id="5154398">:=</span>&nbsp;<span class="ident" id="5154401">mtype</span><span class="op" id="5154406">.</span><span class="ident" id="5154407">Out</span><span class="op" id="5154410">(</span><span class="num" id="5154411">0</span><span class="op" id="5154412">)</span><span class="op" id="5154413">;</span>&nbsp;<span class="ident" id="5154415">returnType</span>&nbsp;<span class="op" id="5154426">!=</span>&nbsp;<span class="ident" id="5154429">typeOfError</span>&nbsp;<span class="op" id="5154441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154446">if</span>&nbsp;<span class="ident" id="5154449">reportErr</span>&nbsp;<span class="op" id="5154459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154465">log</span><span class="op" id="5154468">.</span><span class="ident" id="5154469">Println</span><span class="op" id="5154476">(</span><span class="string" id="5154477">&#34;method&#34;</span><span class="op" id="5154485">,</span>&nbsp;<span class="ident" id="5154487">mname</span><span class="op" id="5154492">,</span>&nbsp;<span class="string" id="5154494">&#34;returns&#34;</span><span class="op" id="5154503">,</span>&nbsp;<span class="ident" id="5154505">returnType</span><span class="op" id="5154515">.</span><span class="ident" id="5154516">String</span><span class="op" id="5154522">(</span><span class="op" id="5154523">)</span><span class="op" id="5154524">,</span>&nbsp;<span class="string" id="5154526">&#34;not&nbsp;error&#34;</span><span class="op" id="5154537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5154542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154547">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5154558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154562">methods</span><span class="op" id="5154569">[</span><span class="ident" id="5154570">mname</span><span class="op" id="5154575">]</span>&nbsp;<span class="op" id="5154577">=</span>&nbsp;<span class="op" id="5154579">&amp;</span><span class="ident" id="5154580">methodType</span><span class="op" id="5154590">{</span><span class="ident" id="5154591">method</span><span class="op" id="5154597">:</span>&nbsp;<span class="ident" id="5154599">method</span><span class="op" id="5154605">,</span>&nbsp;<span class="ident" id="5154607">ArgType</span><span class="op" id="5154614">:</span>&nbsp;<span class="ident" id="5154616">argType</span><span class="op" id="5154623">,</span>&nbsp;<span class="ident" id="5154625">ReplyType</span><span class="op" id="5154634">:</span>&nbsp;<span class="ident" id="5154636">replyType</span><span class="op" id="5154645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5154648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154651">return</span>&nbsp;<span class="ident" id="5154658">methods</span><br>
<span class="lineno"></span><span class="op" id="5154666">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span><span class="comment" id="5154669">//&nbsp;A&nbsp;value&nbsp;sent&nbsp;as&nbsp;a&nbsp;placeholder&nbsp;for&nbsp;the&nbsp;server&#39;s&nbsp;response&nbsp;value&nbsp;when&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="5154750">//&nbsp;receives&nbsp;an&nbsp;invalid&nbsp;request.&nbsp;It&nbsp;is&nbsp;never&nbsp;decoded&nbsp;by&nbsp;the&nbsp;client&nbsp;since&nbsp;the&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="5154835">//&nbsp;contains&nbsp;an&nbsp;error&nbsp;when&nbsp;it&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5154873">var</span>&nbsp;<span class="ident" id="5154877">invalidRequest</span>&nbsp;<span class="op" id="5154892">=</span>&nbsp;<span class="keyword" id="5154894">struct</span><span class="op" id="5154900">{</span><span class="op" id="5154901">}</span><span class="op" id="5154902">{</span><span class="op" id="5154903">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="5154906">func</span>&nbsp;<span class="op" id="5154911">(</span><span class="ident" id="5154912">server</span>&nbsp;<span class="op" id="5154919">*</span><span class="ident" id="5154920">Server</span><span class="op" id="5154926">)</span>&nbsp;<span class="ident" id="5154928">sendResponse</span><span class="op" id="5154940">(</span><span class="ident" id="5154941">sending</span>&nbsp;<span class="op" id="5154949">*</span><span class="ident" id="5154950">sync</span><span class="op" id="5154954">.</span><span class="ident" id="5154955">Mutex</span><span class="op" id="5154960">,</span>&nbsp;<span class="ident" id="5154962">req</span>&nbsp;<span class="op" id="5154966">*</span><span class="ident" id="5154967">Request</span><span class="op" id="5154974">,</span>&nbsp;<span class="ident" id="5154976">reply</span>&nbsp;<span class="keyword" id="5154982">interface</span><span class="op" id="5154991">{</span><span class="op" id="5154992">}</span><span class="op" id="5154993">,</span>&nbsp;<span class="ident" id="5154995">codec</span>&nbsp;<span class="ident" id="5155001">ServerCodec</span><span class="op" id="5155012">,</span>&nbsp;<span class="ident" id="5155014">errmsg</span>&nbsp;<span class="builtintype" id="5155021">string</span><span class="op" id="5155027">)</span>&nbsp;<span class="op" id="5155029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155032">resp</span>&nbsp;<span class="op" id="5155037">:=</span>&nbsp;<span class="ident" id="5155040">server</span><span class="op" id="5155046">.</span><span class="ident" id="5155047">getResponse</span><span class="op" id="5155058">(</span><span class="op" id="5155059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5155062">//&nbsp;Encode&nbsp;the&nbsp;response&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155093">resp</span><span class="op" id="5155097">.</span><span class="ident" id="5155098">ServiceMethod</span>&nbsp;<span class="op" id="5155112">=</span>&nbsp;<span class="ident" id="5155114">req</span><span class="op" id="5155117">.</span><span class="ident" id="5155118">ServiceMethod</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155133">if</span>&nbsp;<span class="ident" id="5155136">errmsg</span>&nbsp;<span class="op" id="5155143">!=</span>&nbsp;<span class="string" id="5155146">&#34;&#34;</span>&nbsp;<span class="op" id="5155149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155153">resp</span><span class="op" id="5155157">.</span><span class="ident" id="5155158">Error</span>&nbsp;<span class="op" id="5155164">=</span>&nbsp;<span class="ident" id="5155166">errmsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155175">reply</span>&nbsp;<span class="op" id="5155181">=</span>&nbsp;<span class="ident" id="5155183">invalidRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5155199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155202">resp</span><span class="op" id="5155206">.</span><span class="ident" id="5155207">Seq</span>&nbsp;<span class="op" id="5155211">=</span>&nbsp;<span class="ident" id="5155213">req</span><span class="op" id="5155216">.</span><span class="ident" id="5155217">Seq</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155222">sending</span><span class="op" id="5155229">.</span><span class="ident" id="5155230">Lock</span><span class="op" id="5155234">(</span><span class="op" id="5155235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155238">err</span>&nbsp;<span class="op" id="5155242">:=</span>&nbsp;<span class="ident" id="5155245">codec</span><span class="op" id="5155250">.</span><span class="ident" id="5155251">WriteResponse</span><span class="op" id="5155264">(</span><span class="ident" id="5155265">resp</span><span class="op" id="5155269">,</span>&nbsp;<span class="ident" id="5155271">reply</span><span class="op" id="5155276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155279">if</span>&nbsp;<span class="ident" id="5155282">debugLog</span>&nbsp;<span class="op" id="5155291">&amp;&amp;</span>&nbsp;<span class="ident" id="5155294">err</span>&nbsp;<span class="op" id="5155298">!=</span>&nbsp;<span class="ident" id="5155301">nil</span>&nbsp;<span class="op" id="5155305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155309">log</span><span class="op" id="5155312">.</span><span class="ident" id="5155313">Println</span><span class="op" id="5155320">(</span><span class="string" id="5155321">&#34;rpc:&nbsp;writing&nbsp;response:&#34;</span><span class="op" id="5155345">,</span>&nbsp;<span class="ident" id="5155347">err</span><span class="op" id="5155350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5155353">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155356">sending</span><span class="op" id="5155363">.</span><span class="ident" id="5155364">Unlock</span><span class="op" id="5155370">(</span><span class="op" id="5155371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155374">server</span><span class="op" id="5155380">.</span><span class="ident" id="5155381">freeResponse</span><span class="op" id="5155393">(</span><span class="ident" id="5155394">resp</span><span class="op" id="5155398">)</span><br>
<span class="lineno"></span><span class="op" id="5155400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5155403">func</span>&nbsp;<span class="op" id="5155408">(</span><span class="ident" id="5155409">m</span>&nbsp;<span class="op" id="5155411">*</span><span class="ident" id="5155412">methodType</span><span class="op" id="5155422">)</span>&nbsp;<span class="ident" id="5155424">NumCalls</span><span class="op" id="5155432">(</span><span class="op" id="5155433">)</span>&nbsp;<span class="op" id="5155435">(</span><span class="ident" id="5155436">n</span>&nbsp;<span class="builtintype" id="5155438">uint</span><span class="op" id="5155442">)</span>&nbsp;<span class="op" id="5155444">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155447">m</span><span class="op" id="5155448">.</span><span class="ident" id="5155449">Lock</span><span class="op" id="5155453">(</span><span class="op" id="5155454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155457">n</span>&nbsp;<span class="op" id="5155459">=</span>&nbsp;<span class="ident" id="5155461">m</span><span class="op" id="5155462">.</span><span class="ident" id="5155463">numCalls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155473">m</span><span class="op" id="5155474">.</span><span class="ident" id="5155475">Unlock</span><span class="op" id="5155481">(</span><span class="op" id="5155482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155485">return</span>&nbsp;<span class="ident" id="5155492">n</span><br>
<span class="lineno"></span><span class="op" id="5155494">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="5155497">func</span>&nbsp;<span class="op" id="5155502">(</span><span class="ident" id="5155503">s</span>&nbsp;<span class="op" id="5155505">*</span><span class="ident" id="5155506">service</span><span class="op" id="5155513">)</span>&nbsp;<span class="ident" id="5155515">call</span><span class="op" id="5155519">(</span><span class="ident" id="5155520">server</span>&nbsp;<span class="op" id="5155527">*</span><span class="ident" id="5155528">Server</span><span class="op" id="5155534">,</span>&nbsp;<span class="ident" id="5155536">sending</span>&nbsp;<span class="op" id="5155544">*</span><span class="ident" id="5155545">sync</span><span class="op" id="5155549">.</span><span class="ident" id="5155550">Mutex</span><span class="op" id="5155555">,</span>&nbsp;<span class="ident" id="5155557">mtype</span>&nbsp;<span class="op" id="5155563">*</span><span class="ident" id="5155564">methodType</span><span class="op" id="5155574">,</span>&nbsp;<span class="ident" id="5155576">req</span>&nbsp;<span class="op" id="5155580">*</span><span class="ident" id="5155581">Request</span><span class="op" id="5155588">,</span>&nbsp;<span class="ident" id="5155590">argv</span><span class="op" id="5155594">,</span>&nbsp;<span class="ident" id="5155596">replyv</span>&nbsp;<span class="ident" id="5155603">reflect</span><span class="op" id="5155610">.</span><span class="ident" id="5155611">Value</span><span class="op" id="5155616">,</span>&nbsp;<span class="ident" id="5155618">codec</span>&nbsp;<span class="ident" id="5155624">ServerCodec</span><span class="op" id="5155635">)</span>&nbsp;<span class="op" id="5155637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155640">mtype</span><span class="op" id="5155645">.</span><span class="ident" id="5155646">Lock</span><span class="op" id="5155650">(</span><span class="op" id="5155651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155654">mtype</span><span class="op" id="5155659">.</span><span class="ident" id="5155660">numCalls</span><span class="op" id="5155668">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155672">mtype</span><span class="op" id="5155677">.</span><span class="ident" id="5155678">Unlock</span><span class="op" id="5155684">(</span><span class="op" id="5155685">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155688">function</span>&nbsp;<span class="op" id="5155697">:=</span>&nbsp;<span class="ident" id="5155700">mtype</span><span class="op" id="5155705">.</span><span class="ident" id="5155706">method</span><span class="op" id="5155712">.</span><span class="ident" id="5155713">Func</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5155719">//&nbsp;Invoke&nbsp;the&nbsp;method,&nbsp;providing&nbsp;a&nbsp;new&nbsp;value&nbsp;for&nbsp;the&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155779">returnValues</span>&nbsp;<span class="op" id="5155792">:=</span>&nbsp;<span class="ident" id="5155795">function</span><span class="op" id="5155803">.</span><span class="ident" id="5155804">Call</span><span class="op" id="5155808">(</span><span class="op" id="5155809">[</span><span class="op" id="5155810">]</span><span class="ident" id="5155811">reflect</span><span class="op" id="5155818">.</span><span class="ident" id="5155819">Value</span><span class="op" id="5155824">{</span><span class="ident" id="5155825">s</span><span class="op" id="5155826">.</span><span class="ident" id="5155827">rcvr</span><span class="op" id="5155831">,</span>&nbsp;<span class="ident" id="5155833">argv</span><span class="op" id="5155837">,</span>&nbsp;<span class="ident" id="5155839">replyv</span><span class="op" id="5155845">}</span><span class="op" id="5155846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5155849">//&nbsp;The&nbsp;return&nbsp;value&nbsp;for&nbsp;the&nbsp;method&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155898">errInter</span>&nbsp;<span class="op" id="5155907">:=</span>&nbsp;<span class="ident" id="5155910">returnValues</span><span class="op" id="5155922">[</span><span class="num" id="5155923">0</span><span class="op" id="5155924">]</span><span class="op" id="5155925">.</span><span class="ident" id="5155926">Interface</span><span class="op" id="5155935">(</span><span class="op" id="5155936">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155939">errmsg</span>&nbsp;<span class="op" id="5155946">:=</span>&nbsp;<span class="string" id="5155949">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155953">if</span>&nbsp;<span class="ident" id="5155956">errInter</span>&nbsp;<span class="op" id="5155965">!=</span>&nbsp;<span class="ident" id="5155968">nil</span>&nbsp;<span class="op" id="5155972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155976">errmsg</span>&nbsp;<span class="op" id="5155983">=</span>&nbsp;<span class="ident" id="5155985">errInter</span><span class="op" id="5155993">.</span><span class="op" id="5155994">(</span><span class="builtintype" id="5155995">error</span><span class="op" id="5156000">)</span><span class="op" id="5156001">.</span><span class="ident" id="5156002">Error</span><span class="op" id="5156007">(</span><span class="op" id="5156008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5156011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156014">server</span><span class="op" id="5156020">.</span><span class="ident" id="5156021">sendResponse</span><span class="op" id="5156033">(</span><span class="ident" id="5156034">sending</span><span class="op" id="5156041">,</span>&nbsp;<span class="ident" id="5156043">req</span><span class="op" id="5156046">,</span>&nbsp;<span class="ident" id="5156048">replyv</span><span class="op" id="5156054">.</span><span class="ident" id="5156055">Interface</span><span class="op" id="5156064">(</span><span class="op" id="5156065">)</span><span class="op" id="5156066">,</span>&nbsp;<span class="ident" id="5156068">codec</span><span class="op" id="5156073">,</span>&nbsp;<span class="ident" id="5156075">errmsg</span><span class="op" id="5156081">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156084">server</span><span class="op" id="5156090">.</span><span class="ident" id="5156091">freeRequest</span><span class="op" id="5156102">(</span><span class="ident" id="5156103">req</span><span class="op" id="5156106">)</span><br>
<span class="lineno"></span><span class="op" id="5156108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5156111">type</span>&nbsp;<span class="ident" id="5156116">gobServerCodec</span>&nbsp;<span class="keyword" id="5156131">struct</span>&nbsp;<span class="op" id="5156138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156141">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156148">io</span><span class="op" id="5156150">.</span><span class="ident" id="5156151">ReadWriteCloser</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156168">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156175">*</span><span class="ident" id="5156176">gob</span><span class="op" id="5156179">.</span><span class="ident" id="5156180">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156189">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156196">*</span><span class="ident" id="5156197">gob</span><span class="op" id="5156200">.</span><span class="ident" id="5156201">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156210">encBuf</span>&nbsp;<span class="op" id="5156217">*</span><span class="ident" id="5156218">bufio</span><span class="op" id="5156223">.</span><span class="ident" id="5156224">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156232">closed</span>&nbsp;<span class="builtintype" id="5156239">bool</span><br>
<span class="lineno"></span><span class="op" id="5156244">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="5156247">func</span>&nbsp;<span class="op" id="5156252">(</span><span class="ident" id="5156253">c</span>&nbsp;<span class="op" id="5156255">*</span><span class="ident" id="5156256">gobServerCodec</span><span class="op" id="5156270">)</span>&nbsp;<span class="ident" id="5156272">ReadRequestHeader</span><span class="op" id="5156289">(</span><span class="ident" id="5156290">r</span>&nbsp;<span class="op" id="5156292">*</span><span class="ident" id="5156293">Request</span><span class="op" id="5156300">)</span>&nbsp;<span class="builtintype" id="5156302">error</span>&nbsp;<span class="op" id="5156308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156311">return</span>&nbsp;<span class="ident" id="5156318">c</span><span class="op" id="5156319">.</span><span class="ident" id="5156320">dec</span><span class="op" id="5156323">.</span><span class="ident" id="5156324">Decode</span><span class="op" id="5156330">(</span><span class="ident" id="5156331">r</span><span class="op" id="5156332">)</span><br>
<span class="lineno"></span><span class="op" id="5156334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="5156337">func</span>&nbsp;<span class="op" id="5156342">(</span><span class="ident" id="5156343">c</span>&nbsp;<span class="op" id="5156345">*</span><span class="ident" id="5156346">gobServerCodec</span><span class="op" id="5156360">)</span>&nbsp;<span class="ident" id="5156362">ReadRequestBody</span><span class="op" id="5156377">(</span><span class="ident" id="5156378">body</span>&nbsp;<span class="keyword" id="5156383">interface</span><span class="op" id="5156392">{</span><span class="op" id="5156393">}</span><span class="op" id="5156394">)</span>&nbsp;<span class="builtintype" id="5156396">error</span>&nbsp;<span class="op" id="5156402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156405">return</span>&nbsp;<span class="ident" id="5156412">c</span><span class="op" id="5156413">.</span><span class="ident" id="5156414">dec</span><span class="op" id="5156417">.</span><span class="ident" id="5156418">Decode</span><span class="op" id="5156424">(</span><span class="ident" id="5156425">body</span><span class="op" id="5156429">)</span><br>
<span class="lineno"></span><span class="op" id="5156431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5156434">func</span>&nbsp;<span class="op" id="5156439">(</span><span class="ident" id="5156440">c</span>&nbsp;<span class="op" id="5156442">*</span><span class="ident" id="5156443">gobServerCodec</span><span class="op" id="5156457">)</span>&nbsp;<span class="ident" id="5156459">WriteResponse</span><span class="op" id="5156472">(</span><span class="ident" id="5156473">r</span>&nbsp;<span class="op" id="5156475">*</span><span class="ident" id="5156476">Response</span><span class="op" id="5156484">,</span>&nbsp;<span class="ident" id="5156486">body</span>&nbsp;<span class="keyword" id="5156491">interface</span><span class="op" id="5156500">{</span><span class="op" id="5156501">}</span><span class="op" id="5156502">)</span>&nbsp;<span class="op" id="5156504">(</span><span class="ident" id="5156505">err</span>&nbsp;<span class="builtintype" id="5156509">error</span><span class="op" id="5156514">)</span>&nbsp;<span class="op" id="5156516">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156519">if</span>&nbsp;<span class="ident" id="5156522">err</span>&nbsp;<span class="op" id="5156526">=</span>&nbsp;<span class="ident" id="5156528">c</span><span class="op" id="5156529">.</span><span class="ident" id="5156530">enc</span><span class="op" id="5156533">.</span><span class="ident" id="5156534">Encode</span><span class="op" id="5156540">(</span><span class="ident" id="5156541">r</span><span class="op" id="5156542">)</span><span class="op" id="5156543">;</span>&nbsp;<span class="ident" id="5156545">err</span>&nbsp;<span class="op" id="5156549">!=</span>&nbsp;<span class="ident" id="5156552">nil</span>&nbsp;<span class="op" id="5156556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156560">if</span>&nbsp;<span class="ident" id="5156563">c</span><span class="op" id="5156564">.</span><span class="ident" id="5156565">encBuf</span><span class="op" id="5156571">.</span><span class="ident" id="5156572">Flush</span><span class="op" id="5156577">(</span><span class="op" id="5156578">)</span>&nbsp;<span class="op" id="5156580">==</span>&nbsp;<span class="ident" id="5156583">nil</span>&nbsp;<span class="op" id="5156587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5156592">//&nbsp;Gob&nbsp;couldn&#39;t&nbsp;encode&nbsp;the&nbsp;header.&nbsp;Should&nbsp;not&nbsp;happen,&nbsp;so&nbsp;if&nbsp;it&nbsp;does,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5156664">//&nbsp;shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156736">log</span><span class="op" id="5156739">.</span><span class="ident" id="5156740">Println</span><span class="op" id="5156747">(</span><span class="string" id="5156748">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;response:&#34;</span><span class="op" id="5156783">,</span>&nbsp;<span class="ident" id="5156785">err</span><span class="op" id="5156788">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156793">c</span><span class="op" id="5156794">.</span><span class="ident" id="5156795">Close</span><span class="op" id="5156800">(</span><span class="op" id="5156801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5156805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156809">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5156817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156820">if</span>&nbsp;<span class="ident" id="5156823">err</span>&nbsp;<span class="op" id="5156827">=</span>&nbsp;<span class="ident" id="5156829">c</span><span class="op" id="5156830">.</span><span class="ident" id="5156831">enc</span><span class="op" id="5156834">.</span><span class="ident" id="5156835">Encode</span><span class="op" id="5156841">(</span><span class="ident" id="5156842">body</span><span class="op" id="5156846">)</span><span class="op" id="5156847">;</span>&nbsp;<span class="ident" id="5156849">err</span>&nbsp;<span class="op" id="5156853">!=</span>&nbsp;<span class="ident" id="5156856">nil</span>&nbsp;<span class="op" id="5156860">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156864">if</span>&nbsp;<span class="ident" id="5156867">c</span><span class="op" id="5156868">.</span><span class="ident" id="5156869">encBuf</span><span class="op" id="5156875">.</span><span class="ident" id="5156876">Flush</span><span class="op" id="5156881">(</span><span class="op" id="5156882">)</span>&nbsp;<span class="op" id="5156884">==</span>&nbsp;<span class="ident" id="5156887">nil</span>&nbsp;<span class="op" id="5156891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5156896">//&nbsp;Was&nbsp;a&nbsp;gob&nbsp;problem&nbsp;encoding&nbsp;the&nbsp;body&nbsp;but&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5156971">//&nbsp;Shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157043">log</span><span class="op" id="5157046">.</span><span class="ident" id="5157047">Println</span><span class="op" id="5157054">(</span><span class="string" id="5157055">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;body:&#34;</span><span class="op" id="5157086">,</span>&nbsp;<span class="ident" id="5157088">err</span><span class="op" id="5157091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157096">c</span><span class="op" id="5157097">.</span><span class="ident" id="5157098">Close</span><span class="op" id="5157103">(</span><span class="op" id="5157104">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5157108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157112">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5157120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157123">return</span>&nbsp;<span class="ident" id="5157130">c</span><span class="op" id="5157131">.</span><span class="ident" id="5157132">encBuf</span><span class="op" id="5157138">.</span><span class="ident" id="5157139">Flush</span><span class="op" id="5157144">(</span><span class="op" id="5157145">)</span><br>
<span class="lineno"></span><span class="op" id="5157147">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5157150">func</span>&nbsp;<span class="op" id="5157155">(</span><span class="ident" id="5157156">c</span>&nbsp;<span class="op" id="5157158">*</span><span class="ident" id="5157159">gobServerCodec</span><span class="op" id="5157173">)</span>&nbsp;<span class="ident" id="5157175">Close</span><span class="op" id="5157180">(</span><span class="op" id="5157181">)</span>&nbsp;<span class="builtintype" id="5157183">error</span>&nbsp;<span class="op" id="5157189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157192">if</span>&nbsp;<span class="ident" id="5157195">c</span><span class="op" id="5157196">.</span><span class="ident" id="5157197">closed</span>&nbsp;<span class="op" id="5157204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5157208">//&nbsp;Only&nbsp;call&nbsp;c.rwc.Close&nbsp;once;&nbsp;otherwise&nbsp;the&nbsp;semantics&nbsp;are&nbsp;undefined.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157280">return</span>&nbsp;<span class="ident" id="5157287">nil</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5157292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157295">c</span><span class="op" id="5157296">.</span><span class="ident" id="5157297">closed</span>&nbsp;<span class="op" id="5157304">=</span>&nbsp;<span class="builtintype" id="5157306">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157312">return</span>&nbsp;<span class="ident" id="5157319">c</span><span class="op" id="5157320">.</span><span class="ident" id="5157321">rwc</span><span class="op" id="5157324">.</span><span class="ident" id="5157325">Close</span><span class="op" id="5157330">(</span><span class="op" id="5157331">)</span><br>
<span class="lineno"></span><span class="op" id="5157333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span><span class="comment" id="5157336">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5157389">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5157460">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5157521">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5157584">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">445</span><span class="keyword" id="5157643">func</span>&nbsp;<span class="op" id="5157648">(</span><span class="ident" id="5157649">server</span>&nbsp;<span class="op" id="5157656">*</span><span class="ident" id="5157657">Server</span><span class="op" id="5157663">)</span>&nbsp;<span class="ident" id="5157665">ServeConn</span><span class="op" id="5157674">(</span><span class="ident" id="5157675">conn</span>&nbsp;<span class="ident" id="5157680">io</span><span class="op" id="5157682">.</span><span class="ident" id="5157683">ReadWriteCloser</span><span class="op" id="5157698">)</span>&nbsp;<span class="op" id="5157700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157703">buf</span>&nbsp;<span class="op" id="5157707">:=</span>&nbsp;<span class="ident" id="5157710">bufio</span><span class="op" id="5157715">.</span><span class="ident" id="5157716">NewWriter</span><span class="op" id="5157725">(</span><span class="ident" id="5157726">conn</span><span class="op" id="5157730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157733">srv</span>&nbsp;<span class="op" id="5157737">:=</span>&nbsp;<span class="op" id="5157740">&amp;</span><span class="ident" id="5157741">gobServerCodec</span><span class="op" id="5157755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157759">rwc</span><span class="op" id="5157762">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157767">conn</span><span class="op" id="5157771">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157775">dec</span><span class="op" id="5157778">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157783">gob</span><span class="op" id="5157786">.</span><span class="ident" id="5157787">NewDecoder</span><span class="op" id="5157797">(</span><span class="ident" id="5157798">conn</span><span class="op" id="5157802">)</span><span class="op" id="5157803">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157807">enc</span><span class="op" id="5157810">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157815">gob</span><span class="op" id="5157818">.</span><span class="ident" id="5157819">NewEncoder</span><span class="op" id="5157829">(</span><span class="ident" id="5157830">buf</span><span class="op" id="5157833">)</span><span class="op" id="5157834">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157838">encBuf</span><span class="op" id="5157844">:</span>&nbsp;<span class="ident" id="5157846">buf</span><span class="op" id="5157849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5157852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157855">server</span><span class="op" id="5157861">.</span><span class="ident" id="5157862">ServeCodec</span><span class="op" id="5157872">(</span><span class="ident" id="5157873">srv</span><span class="op" id="5157876">)</span><br>
<span class="lineno"></span><span class="op" id="5157878">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5157881">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5157945">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5157986">func</span>&nbsp;<span class="op" id="5157991">(</span><span class="ident" id="5157992">server</span>&nbsp;<span class="op" id="5157999">*</span><span class="ident" id="5158000">Server</span><span class="op" id="5158006">)</span>&nbsp;<span class="ident" id="5158008">ServeCodec</span><span class="op" id="5158018">(</span><span class="ident" id="5158019">codec</span>&nbsp;<span class="ident" id="5158025">ServerCodec</span><span class="op" id="5158036">)</span>&nbsp;<span class="op" id="5158038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158041">sending</span>&nbsp;<span class="op" id="5158049">:=</span>&nbsp;<span class="builtinfunc" id="5158052">new</span><span class="op" id="5158055">(</span><span class="ident" id="5158056">sync</span><span class="op" id="5158060">.</span><span class="ident" id="5158061">Mutex</span><span class="op" id="5158066">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158069">for</span>&nbsp;<span class="op" id="5158073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158077">service</span><span class="op" id="5158084">,</span>&nbsp;<span class="ident" id="5158086">mtype</span><span class="op" id="5158091">,</span>&nbsp;<span class="ident" id="5158093">req</span><span class="op" id="5158096">,</span>&nbsp;<span class="ident" id="5158098">argv</span><span class="op" id="5158102">,</span>&nbsp;<span class="ident" id="5158104">replyv</span><span class="op" id="5158110">,</span>&nbsp;<span class="ident" id="5158112">keepReading</span><span class="op" id="5158123">,</span>&nbsp;<span class="ident" id="5158125">err</span>&nbsp;<span class="op" id="5158129">:=</span>&nbsp;<span class="ident" id="5158132">server</span><span class="op" id="5158138">.</span><span class="ident" id="5158139">readRequest</span><span class="op" id="5158150">(</span><span class="ident" id="5158151">codec</span><span class="op" id="5158156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158160">if</span>&nbsp;<span class="ident" id="5158163">err</span>&nbsp;<span class="op" id="5158167">!=</span>&nbsp;<span class="ident" id="5158170">nil</span>&nbsp;<span class="op" id="5158174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158179">if</span>&nbsp;<span class="ident" id="5158182">debugLog</span>&nbsp;<span class="op" id="5158191">&amp;&amp;</span>&nbsp;<span class="ident" id="5158194">err</span>&nbsp;<span class="op" id="5158198">!=</span>&nbsp;<span class="ident" id="5158201">io</span><span class="op" id="5158203">.</span><span class="ident" id="5158204">EOF</span>&nbsp;<span class="op" id="5158208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158214">log</span><span class="op" id="5158217">.</span><span class="ident" id="5158218">Println</span><span class="op" id="5158225">(</span><span class="string" id="5158226">&#34;rpc:&#34;</span><span class="op" id="5158232">,</span>&nbsp;<span class="ident" id="5158234">err</span><span class="op" id="5158237">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5158242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158247">if</span>&nbsp;<span class="op" id="5158250">!</span><span class="ident" id="5158251">keepReading</span>&nbsp;<span class="op" id="5158263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158269">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5158278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5158283">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158346">if</span>&nbsp;<span class="ident" id="5158349">req</span>&nbsp;<span class="op" id="5158353">!=</span>&nbsp;<span class="ident" id="5158356">nil</span>&nbsp;<span class="op" id="5158360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158366">server</span><span class="op" id="5158372">.</span><span class="ident" id="5158373">sendResponse</span><span class="op" id="5158385">(</span><span class="ident" id="5158386">sending</span><span class="op" id="5158393">,</span>&nbsp;<span class="ident" id="5158395">req</span><span class="op" id="5158398">,</span>&nbsp;<span class="ident" id="5158400">invalidRequest</span><span class="op" id="5158414">,</span>&nbsp;<span class="ident" id="5158416">codec</span><span class="op" id="5158421">,</span>&nbsp;<span class="ident" id="5158423">err</span><span class="op" id="5158426">.</span><span class="ident" id="5158427">Error</span><span class="op" id="5158432">(</span><span class="op" id="5158433">)</span><span class="op" id="5158434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158440">server</span><span class="op" id="5158446">.</span><span class="ident" id="5158447">freeRequest</span><span class="op" id="5158458">(</span><span class="ident" id="5158459">req</span><span class="op" id="5158462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5158467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158472">continue</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5158483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158487">go</span>&nbsp;<span class="ident" id="5158490">service</span><span class="op" id="5158497">.</span><span class="ident" id="5158498">call</span><span class="op" id="5158502">(</span><span class="ident" id="5158503">server</span><span class="op" id="5158509">,</span>&nbsp;<span class="ident" id="5158511">sending</span><span class="op" id="5158518">,</span>&nbsp;<span class="ident" id="5158520">mtype</span><span class="op" id="5158525">,</span>&nbsp;<span class="ident" id="5158527">req</span><span class="op" id="5158530">,</span>&nbsp;<span class="ident" id="5158532">argv</span><span class="op" id="5158536">,</span>&nbsp;<span class="ident" id="5158538">replyv</span><span class="op" id="5158544">,</span>&nbsp;<span class="ident" id="5158546">codec</span><span class="op" id="5158551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5158554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158557">codec</span><span class="op" id="5158562">.</span><span class="ident" id="5158563">Close</span><span class="op" id="5158568">(</span><span class="op" id="5158569">)</span><br>
<span class="lineno"></span><span class="op" id="5158571">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5158574">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5158652">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5158700">func</span>&nbsp;<span class="op" id="5158705">(</span><span class="ident" id="5158706">server</span>&nbsp;<span class="op" id="5158713">*</span><span class="ident" id="5158714">Server</span><span class="op" id="5158720">)</span>&nbsp;<span class="ident" id="5158722">ServeRequest</span><span class="op" id="5158734">(</span><span class="ident" id="5158735">codec</span>&nbsp;<span class="ident" id="5158741">ServerCodec</span><span class="op" id="5158752">)</span>&nbsp;<span class="builtintype" id="5158754">error</span>&nbsp;<span class="op" id="5158760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158763">sending</span>&nbsp;<span class="op" id="5158771">:=</span>&nbsp;<span class="builtinfunc" id="5158774">new</span><span class="op" id="5158777">(</span><span class="ident" id="5158778">sync</span><span class="op" id="5158782">.</span><span class="ident" id="5158783">Mutex</span><span class="op" id="5158788">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158791">service</span><span class="op" id="5158798">,</span>&nbsp;<span class="ident" id="5158800">mtype</span><span class="op" id="5158805">,</span>&nbsp;<span class="ident" id="5158807">req</span><span class="op" id="5158810">,</span>&nbsp;<span class="ident" id="5158812">argv</span><span class="op" id="5158816">,</span>&nbsp;<span class="ident" id="5158818">replyv</span><span class="op" id="5158824">,</span>&nbsp;<span class="ident" id="5158826">keepReading</span><span class="op" id="5158837">,</span>&nbsp;<span class="ident" id="5158839">err</span>&nbsp;<span class="op" id="5158843">:=</span>&nbsp;<span class="ident" id="5158846">server</span><span class="op" id="5158852">.</span><span class="ident" id="5158853">readRequest</span><span class="op" id="5158864">(</span><span class="ident" id="5158865">codec</span><span class="op" id="5158870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158873">if</span>&nbsp;<span class="ident" id="5158876">err</span>&nbsp;<span class="op" id="5158880">!=</span>&nbsp;<span class="ident" id="5158883">nil</span>&nbsp;<span class="op" id="5158887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158891">if</span>&nbsp;<span class="op" id="5158894">!</span><span class="ident" id="5158895">keepReading</span>&nbsp;<span class="op" id="5158907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158912">return</span>&nbsp;<span class="ident" id="5158919">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5158925">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5158929">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158991">if</span>&nbsp;<span class="ident" id="5158994">req</span>&nbsp;<span class="op" id="5158998">!=</span>&nbsp;<span class="ident" id="5159001">nil</span>&nbsp;<span class="op" id="5159005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159010">server</span><span class="op" id="5159016">.</span><span class="ident" id="5159017">sendResponse</span><span class="op" id="5159029">(</span><span class="ident" id="5159030">sending</span><span class="op" id="5159037">,</span>&nbsp;<span class="ident" id="5159039">req</span><span class="op" id="5159042">,</span>&nbsp;<span class="ident" id="5159044">invalidRequest</span><span class="op" id="5159058">,</span>&nbsp;<span class="ident" id="5159060">codec</span><span class="op" id="5159065">,</span>&nbsp;<span class="ident" id="5159067">err</span><span class="op" id="5159070">.</span><span class="ident" id="5159071">Error</span><span class="op" id="5159076">(</span><span class="op" id="5159077">)</span><span class="op" id="5159078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159083">server</span><span class="op" id="5159089">.</span><span class="ident" id="5159090">freeRequest</span><span class="op" id="5159101">(</span><span class="ident" id="5159102">req</span><span class="op" id="5159105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159109">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5159113">return</span>&nbsp;<span class="ident" id="5159120">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159128">service</span><span class="op" id="5159135">.</span><span class="ident" id="5159136">call</span><span class="op" id="5159140">(</span><span class="ident" id="5159141">server</span><span class="op" id="5159147">,</span>&nbsp;<span class="ident" id="5159149">sending</span><span class="op" id="5159156">,</span>&nbsp;<span class="ident" id="5159158">mtype</span><span class="op" id="5159163">,</span>&nbsp;<span class="ident" id="5159165">req</span><span class="op" id="5159168">,</span>&nbsp;<span class="ident" id="5159170">argv</span><span class="op" id="5159174">,</span>&nbsp;<span class="ident" id="5159176">replyv</span><span class="op" id="5159182">,</span>&nbsp;<span class="ident" id="5159184">codec</span><span class="op" id="5159189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5159192">return</span>&nbsp;<span class="ident" id="5159199">nil</span><br>
<span class="lineno"></span><span class="op" id="5159203">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5159206">func</span>&nbsp;<span class="op" id="5159211">(</span><span class="ident" id="5159212">server</span>&nbsp;<span class="op" id="5159219">*</span><span class="ident" id="5159220">Server</span><span class="op" id="5159226">)</span>&nbsp;<span class="ident" id="5159228">getRequest</span><span class="op" id="5159238">(</span><span class="op" id="5159239">)</span>&nbsp;<span class="op" id="5159241">*</span><span class="ident" id="5159242">Request</span>&nbsp;<span class="op" id="5159250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159253">server</span><span class="op" id="5159259">.</span><span class="ident" id="5159260">reqLock</span><span class="op" id="5159267">.</span><span class="ident" id="5159268">Lock</span><span class="op" id="5159272">(</span><span class="op" id="5159273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159276">req</span>&nbsp;<span class="op" id="5159280">:=</span>&nbsp;<span class="ident" id="5159283">server</span><span class="op" id="5159289">.</span><span class="ident" id="5159290">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5159299">if</span>&nbsp;<span class="ident" id="5159302">req</span>&nbsp;<span class="op" id="5159306">==</span>&nbsp;<span class="ident" id="5159309">nil</span>&nbsp;<span class="op" id="5159313">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159317">req</span>&nbsp;<span class="op" id="5159321">=</span>&nbsp;<span class="builtinfunc" id="5159323">new</span><span class="op" id="5159326">(</span><span class="ident" id="5159327">Request</span><span class="op" id="5159334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159337">}</span>&nbsp;<span class="keyword" id="5159339">else</span>&nbsp;<span class="op" id="5159344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159348">server</span><span class="op" id="5159354">.</span><span class="ident" id="5159355">freeReq</span>&nbsp;<span class="op" id="5159363">=</span>&nbsp;<span class="ident" id="5159365">req</span><span class="op" id="5159368">.</span><span class="ident" id="5159369">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159376">*</span><span class="ident" id="5159377">req</span>&nbsp;<span class="op" id="5159381">=</span>&nbsp;<span class="ident" id="5159383">Request</span><span class="op" id="5159390">{</span><span class="op" id="5159391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159394">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159397">server</span><span class="op" id="5159403">.</span><span class="ident" id="5159404">reqLock</span><span class="op" id="5159411">.</span><span class="ident" id="5159412">Unlock</span><span class="op" id="5159418">(</span><span class="op" id="5159419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5159422">return</span>&nbsp;<span class="ident" id="5159429">req</span><br>
<span class="lineno"></span><span class="op" id="5159433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5159436">func</span>&nbsp;<span class="op" id="5159441">(</span><span class="ident" id="5159442">server</span>&nbsp;<span class="op" id="5159449">*</span><span class="ident" id="5159450">Server</span><span class="op" id="5159456">)</span>&nbsp;<span class="ident" id="5159458">freeRequest</span><span class="op" id="5159469">(</span><span class="ident" id="5159470">req</span>&nbsp;<span class="op" id="5159474">*</span><span class="ident" id="5159475">Request</span><span class="op" id="5159482">)</span>&nbsp;<span class="op" id="5159484">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159487">server</span><span class="op" id="5159493">.</span><span class="ident" id="5159494">reqLock</span><span class="op" id="5159501">.</span><span class="ident" id="5159502">Lock</span><span class="op" id="5159506">(</span><span class="op" id="5159507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159510">req</span><span class="op" id="5159513">.</span><span class="ident" id="5159514">next</span>&nbsp;<span class="op" id="5159519">=</span>&nbsp;<span class="ident" id="5159521">server</span><span class="op" id="5159527">.</span><span class="ident" id="5159528">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159537">server</span><span class="op" id="5159543">.</span><span class="ident" id="5159544">freeReq</span>&nbsp;<span class="op" id="5159552">=</span>&nbsp;<span class="ident" id="5159554">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159559">server</span><span class="op" id="5159565">.</span><span class="ident" id="5159566">reqLock</span><span class="op" id="5159573">.</span><span class="ident" id="5159574">Unlock</span><span class="op" id="5159580">(</span><span class="op" id="5159581">)</span><br>
<span class="lineno"></span><span class="op" id="5159583">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span><span class="keyword" id="5159586">func</span>&nbsp;<span class="op" id="5159591">(</span><span class="ident" id="5159592">server</span>&nbsp;<span class="op" id="5159599">*</span><span class="ident" id="5159600">Server</span><span class="op" id="5159606">)</span>&nbsp;<span class="ident" id="5159608">getResponse</span><span class="op" id="5159619">(</span><span class="op" id="5159620">)</span>&nbsp;<span class="op" id="5159622">*</span><span class="ident" id="5159623">Response</span>&nbsp;<span class="op" id="5159632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159635">server</span><span class="op" id="5159641">.</span><span class="ident" id="5159642">respLock</span><span class="op" id="5159650">.</span><span class="ident" id="5159651">Lock</span><span class="op" id="5159655">(</span><span class="op" id="5159656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159659">resp</span>&nbsp;<span class="op" id="5159664">:=</span>&nbsp;<span class="ident" id="5159667">server</span><span class="op" id="5159673">.</span><span class="ident" id="5159674">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5159684">if</span>&nbsp;<span class="ident" id="5159687">resp</span>&nbsp;<span class="op" id="5159692">==</span>&nbsp;<span class="ident" id="5159695">nil</span>&nbsp;<span class="op" id="5159699">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159703">resp</span>&nbsp;<span class="op" id="5159708">=</span>&nbsp;<span class="builtinfunc" id="5159710">new</span><span class="op" id="5159713">(</span><span class="ident" id="5159714">Response</span><span class="op" id="5159722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159725">}</span>&nbsp;<span class="keyword" id="5159727">else</span>&nbsp;<span class="op" id="5159732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159736">server</span><span class="op" id="5159742">.</span><span class="ident" id="5159743">freeResp</span>&nbsp;<span class="op" id="5159752">=</span>&nbsp;<span class="ident" id="5159754">resp</span><span class="op" id="5159758">.</span><span class="ident" id="5159759">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159766">*</span><span class="ident" id="5159767">resp</span>&nbsp;<span class="op" id="5159772">=</span>&nbsp;<span class="ident" id="5159774">Response</span><span class="op" id="5159782">{</span><span class="op" id="5159783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159786">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159789">server</span><span class="op" id="5159795">.</span><span class="ident" id="5159796">respLock</span><span class="op" id="5159804">.</span><span class="ident" id="5159805">Unlock</span><span class="op" id="5159811">(</span><span class="op" id="5159812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5159815">return</span>&nbsp;<span class="ident" id="5159822">resp</span><br>
<span class="lineno"></span><span class="op" id="5159827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5159830">func</span>&nbsp;<span class="op" id="5159835">(</span><span class="ident" id="5159836">server</span>&nbsp;<span class="op" id="5159843">*</span><span class="ident" id="5159844">Server</span><span class="op" id="5159850">)</span>&nbsp;<span class="ident" id="5159852">freeResponse</span><span class="op" id="5159864">(</span><span class="ident" id="5159865">resp</span>&nbsp;<span class="op" id="5159870">*</span><span class="ident" id="5159871">Response</span><span class="op" id="5159879">)</span>&nbsp;<span class="op" id="5159881">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159884">server</span><span class="op" id="5159890">.</span><span class="ident" id="5159891">respLock</span><span class="op" id="5159899">.</span><span class="ident" id="5159900">Lock</span><span class="op" id="5159904">(</span><span class="op" id="5159905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159908">resp</span><span class="op" id="5159912">.</span><span class="ident" id="5159913">next</span>&nbsp;<span class="op" id="5159918">=</span>&nbsp;<span class="ident" id="5159920">server</span><span class="op" id="5159926">.</span><span class="ident" id="5159927">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159937">server</span><span class="op" id="5159943">.</span><span class="ident" id="5159944">freeResp</span>&nbsp;<span class="op" id="5159953">=</span>&nbsp;<span class="ident" id="5159955">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159961">server</span><span class="op" id="5159967">.</span><span class="ident" id="5159968">respLock</span><span class="op" id="5159976">.</span><span class="ident" id="5159977">Unlock</span><span class="op" id="5159983">(</span><span class="op" id="5159984">)</span><br>
<span class="lineno"></span><span class="op" id="5159986">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="5159989">func</span>&nbsp;<span class="op" id="5159994">(</span><span class="ident" id="5159995">server</span>&nbsp;<span class="op" id="5160002">*</span><span class="ident" id="5160003">Server</span><span class="op" id="5160009">)</span>&nbsp;<span class="ident" id="5160011">readRequest</span><span class="op" id="5160022">(</span><span class="ident" id="5160023">codec</span>&nbsp;<span class="ident" id="5160029">ServerCodec</span><span class="op" id="5160040">)</span>&nbsp;<span class="op" id="5160042">(</span><span class="ident" id="5160043">service</span>&nbsp;<span class="op" id="5160051">*</span><span class="ident" id="5160052">service</span><span class="op" id="5160059">,</span>&nbsp;<span class="ident" id="5160061">mtype</span>&nbsp;<span class="op" id="5160067">*</span><span class="ident" id="5160068">methodType</span><span class="op" id="5160078">,</span>&nbsp;<span class="ident" id="5160080">req</span>&nbsp;<span class="op" id="5160084">*</span><span class="ident" id="5160085">Request</span><span class="op" id="5160092">,</span>&nbsp;<span class="ident" id="5160094">argv</span><span class="op" id="5160098">,</span>&nbsp;<span class="ident" id="5160100">replyv</span>&nbsp;<span class="ident" id="5160107">reflect</span><span class="op" id="5160114">.</span><span class="ident" id="5160115">Value</span><span class="op" id="5160120">,</span>&nbsp;<span class="ident" id="5160122">keepReading</span>&nbsp;<span class="builtintype" id="5160134">bool</span><span class="op" id="5160138">,</span>&nbsp;<span class="ident" id="5160140">err</span>&nbsp;<span class="builtintype" id="5160144">error</span><span class="op" id="5160149">)</span>&nbsp;<span class="op" id="5160151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5160154">service</span><span class="op" id="5160161">,</span>&nbsp;<span class="ident" id="5160163">mtype</span><span class="op" id="5160168">,</span>&nbsp;<span class="ident" id="5160170">req</span><span class="op" id="5160173">,</span>&nbsp;<span class="ident" id="5160175">keepReading</span><span class="op" id="5160186">,</span>&nbsp;<span class="ident" id="5160188">err</span>&nbsp;<span class="op" id="5160192">=</span>&nbsp;<span class="ident" id="5160194">server</span><span class="op" id="5160200">.</span><span class="ident" id="5160201">readRequestHeader</span><span class="op" id="5160218">(</span><span class="ident" id="5160219">codec</span><span class="op" id="5160224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160227">if</span>&nbsp;<span class="ident" id="5160230">err</span>&nbsp;<span class="op" id="5160234">!=</span>&nbsp;<span class="ident" id="5160237">nil</span>&nbsp;<span class="op" id="5160241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160245">if</span>&nbsp;<span class="op" id="5160248">!</span><span class="ident" id="5160249">keepReading</span>&nbsp;<span class="op" id="5160261">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160266">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5160275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5160279">//&nbsp;discard&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5160297">codec</span><span class="op" id="5160302">.</span><span class="ident" id="5160303">ReadRequestBody</span><span class="op" id="5160318">(</span><span class="ident" id="5160319">nil</span><span class="op" id="5160322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160326">return</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5160334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5160338">//&nbsp;Decode&nbsp;the&nbsp;argument&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5160369">argIsValue</span>&nbsp;<span class="op" id="5160380">:=</span>&nbsp;<span class="builtintype" id="5160383">false</span>&nbsp;<span class="comment" id="5160389">//&nbsp;if&nbsp;true,&nbsp;need&nbsp;to&nbsp;indirect&nbsp;before&nbsp;calling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160435">if</span>&nbsp;<span class="ident" id="5160438">mtype</span><span class="op" id="5160443">.</span><span class="ident" id="5160444">ArgType</span><span class="op" id="5160451">.</span><span class="ident" id="5160452">Kind</span><span class="op" id="5160456">(</span><span class="op" id="5160457">)</span>&nbsp;<span class="op" id="5160459">==</span>&nbsp;<span class="ident" id="5160462">reflect</span><span class="op" id="5160469">.</span><span class="ident" id="5160470">Ptr</span>&nbsp;<span class="op" id="5160474">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5160478">argv</span>&nbsp;<span class="op" id="5160483">=</span>&nbsp;<span class="ident" id="5160485">reflect</span><span class="op" id="5160492">.</span><span class="ident" id="5160493">New</span><span class="op" id="5160496">(</span><span class="ident" id="5160497">mtype</span><span class="op" id="5160502">.</span><span class="ident" id="5160503">ArgType</span><span class="op" id="5160510">.</span><span class="ident" id="5160511">Elem</span><span class="op" id="5160515">(</span><span class="op" id="5160516">)</span><span class="op" id="5160517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5160520">}</span>&nbsp;<span class="keyword" id="5160522">else</span>&nbsp;<span class="op" id="5160527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5160531">argv</span>&nbsp;<span class="op" id="5160536">=</span>&nbsp;<span class="ident" id="5160538">reflect</span><span class="op" id="5160545">.</span><span class="ident" id="5160546">New</span><span class="op" id="5160549">(</span><span class="ident" id="5160550">mtype</span><span class="op" id="5160555">.</span><span class="ident" id="5160556">ArgType</span><span class="op" id="5160563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5160567">argIsValue</span>&nbsp;<span class="op" id="5160578">=</span>&nbsp;<span class="builtintype" id="5160580">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5160586">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5160589">//&nbsp;argv&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;a&nbsp;pointer&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160630">if</span>&nbsp;<span class="ident" id="5160633">err</span>&nbsp;<span class="op" id="5160637">=</span>&nbsp;<span class="ident" id="5160639">codec</span><span class="op" id="5160644">.</span><span class="ident" id="5160645">ReadRequestBody</span><span class="op" id="5160660">(</span><span class="ident" id="5160661">argv</span><span class="op" id="5160665">.</span><span class="ident" id="5160666">Interface</span><span class="op" id="5160675">(</span><span class="op" id="5160676">)</span><span class="op" id="5160677">)</span><span class="op" id="5160678">;</span>&nbsp;<span class="ident" id="5160680">err</span>&nbsp;<span class="op" id="5160684">!=</span>&nbsp;<span class="ident" id="5160687">nil</span>&nbsp;<span class="op" id="5160691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160695">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5160703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160706">if</span>&nbsp;<span class="ident" id="5160709">argIsValue</span>&nbsp;<span class="op" id="5160720">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5160724">argv</span>&nbsp;<span class="op" id="5160729">=</span>&nbsp;<span class="ident" id="5160731">argv</span><span class="op" id="5160735">.</span><span class="ident" id="5160736">Elem</span><span class="op" id="5160740">(</span><span class="op" id="5160741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5160744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5160748">replyv</span>&nbsp;<span class="op" id="5160755">=</span>&nbsp;<span class="ident" id="5160757">reflect</span><span class="op" id="5160764">.</span><span class="ident" id="5160765">New</span><span class="op" id="5160768">(</span><span class="ident" id="5160769">mtype</span><span class="op" id="5160774">.</span><span class="ident" id="5160775">ReplyType</span><span class="op" id="5160784">.</span><span class="ident" id="5160785">Elem</span><span class="op" id="5160789">(</span><span class="op" id="5160790">)</span><span class="op" id="5160791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160794">return</span><br>
<span class="lineno">570</span><span class="op" id="5160801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5160804">func</span>&nbsp;<span class="op" id="5160809">(</span><span class="ident" id="5160810">server</span>&nbsp;<span class="op" id="5160817">*</span><span class="ident" id="5160818">Server</span><span class="op" id="5160824">)</span>&nbsp;<span class="ident" id="5160826">readRequestHeader</span><span class="op" id="5160843">(</span><span class="ident" id="5160844">codec</span>&nbsp;<span class="ident" id="5160850">ServerCodec</span><span class="op" id="5160861">)</span>&nbsp;<span class="op" id="5160863">(</span><span class="ident" id="5160864">service</span>&nbsp;<span class="op" id="5160872">*</span><span class="ident" id="5160873">service</span><span class="op" id="5160880">,</span>&nbsp;<span class="ident" id="5160882">mtype</span>&nbsp;<span class="op" id="5160888">*</span><span class="ident" id="5160889">methodType</span><span class="op" id="5160899">,</span>&nbsp;<span class="ident" id="5160901">req</span>&nbsp;<span class="op" id="5160905">*</span><span class="ident" id="5160906">Request</span><span class="op" id="5160913">,</span>&nbsp;<span class="ident" id="5160915">keepReading</span>&nbsp;<span class="builtintype" id="5160927">bool</span><span class="op" id="5160931">,</span>&nbsp;<span class="ident" id="5160933">err</span>&nbsp;<span class="builtintype" id="5160937">error</span><span class="op" id="5160942">)</span>&nbsp;<span class="op" id="5160944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5160947">//&nbsp;Grab&nbsp;the&nbsp;request&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5160976">req</span>&nbsp;<span class="op" id="5160980">=</span>&nbsp;<span class="ident" id="5160982">server</span><span class="op" id="5160988">.</span><span class="ident" id="5160989">getRequest</span><span class="op" id="5160999">(</span><span class="op" id="5161000">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161003">err</span>&nbsp;<span class="op" id="5161007">=</span>&nbsp;<span class="ident" id="5161009">codec</span><span class="op" id="5161014">.</span><span class="ident" id="5161015">ReadRequestHeader</span><span class="op" id="5161032">(</span><span class="ident" id="5161033">req</span><span class="op" id="5161036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5161039">if</span>&nbsp;<span class="ident" id="5161042">err</span>&nbsp;<span class="op" id="5161046">!=</span>&nbsp;<span class="ident" id="5161049">nil</span>&nbsp;<span class="op" id="5161053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161057">req</span>&nbsp;<span class="op" id="5161061">=</span>&nbsp;<span class="ident" id="5161063">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5161069">if</span>&nbsp;<span class="ident" id="5161072">err</span>&nbsp;<span class="op" id="5161076">==</span>&nbsp;<span class="ident" id="5161079">io</span><span class="op" id="5161081">.</span><span class="ident" id="5161082">EOF</span>&nbsp;<span class="op" id="5161086">||</span>&nbsp;<span class="ident" id="5161089">err</span>&nbsp;<span class="op" id="5161093">==</span>&nbsp;<span class="ident" id="5161096">io</span><span class="op" id="5161098">.</span><span class="ident" id="5161099">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5161116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5161121">return</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5161130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161134">err</span>&nbsp;<span class="op" id="5161138">=</span>&nbsp;<span class="ident" id="5161140">errors</span><span class="op" id="5161146">.</span><span class="ident" id="5161147">New</span><span class="op" id="5161150">(</span><span class="string" id="5161151">&#34;rpc:&nbsp;server&nbsp;cannot&nbsp;decode&nbsp;request:&nbsp;&#34;</span>&nbsp;<span class="op" id="5161189">+</span>&nbsp;<span class="ident" id="5161191">err</span><span class="op" id="5161194">.</span><span class="ident" id="5161195">Error</span><span class="op" id="5161200">(</span><span class="op" id="5161201">)</span><span class="op" id="5161202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5161206">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5161214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5161218">//&nbsp;We&nbsp;read&nbsp;the&nbsp;header&nbsp;successfully.&nbsp;&nbsp;If&nbsp;we&nbsp;see&nbsp;an&nbsp;error&nbsp;now,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5161280">//&nbsp;we&nbsp;can&nbsp;still&nbsp;recover&nbsp;and&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161338">keepReading</span>&nbsp;<span class="op" id="5161350">=</span>&nbsp;<span class="builtintype" id="5161352">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161359">dot</span>&nbsp;<span class="op" id="5161363">:=</span>&nbsp;<span class="ident" id="5161366">strings</span><span class="op" id="5161373">.</span><span class="ident" id="5161374">LastIndex</span><span class="op" id="5161383">(</span><span class="ident" id="5161384">req</span><span class="op" id="5161387">.</span><span class="ident" id="5161388">ServiceMethod</span><span class="op" id="5161401">,</span>&nbsp;<span class="string" id="5161403">&#34;.&#34;</span><span class="op" id="5161406">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5161409">if</span>&nbsp;<span class="ident" id="5161412">dot</span>&nbsp;<span class="op" id="5161416">&lt;</span>&nbsp;<span class="num" id="5161418">0</span>&nbsp;<span class="op" id="5161420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161424">err</span>&nbsp;<span class="op" id="5161428">=</span>&nbsp;<span class="ident" id="5161430">errors</span><span class="op" id="5161436">.</span><span class="ident" id="5161437">New</span><span class="op" id="5161440">(</span><span class="string" id="5161441">&#34;rpc:&nbsp;service/method&nbsp;request&nbsp;ill-formed:&nbsp;&#34;</span>&nbsp;<span class="op" id="5161484">+</span>&nbsp;<span class="ident" id="5161486">req</span><span class="op" id="5161489">.</span><span class="ident" id="5161490">ServiceMethod</span><span class="op" id="5161503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5161507">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5161515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161518">serviceName</span>&nbsp;<span class="op" id="5161530">:=</span>&nbsp;<span class="ident" id="5161533">req</span><span class="op" id="5161536">.</span><span class="ident" id="5161537">ServiceMethod</span><span class="op" id="5161550">[</span><span class="op" id="5161551">:</span><span class="ident" id="5161552">dot</span><span class="op" id="5161555">]</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161558">methodName</span>&nbsp;<span class="op" id="5161569">:=</span>&nbsp;<span class="ident" id="5161572">req</span><span class="op" id="5161575">.</span><span class="ident" id="5161576">ServiceMethod</span><span class="op" id="5161589">[</span><span class="ident" id="5161590">dot</span><span class="op" id="5161593">+</span><span class="num" id="5161594">1</span><span class="op" id="5161595">:</span><span class="op" id="5161596">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5161600">//&nbsp;Look&nbsp;up&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161625">server</span><span class="op" id="5161631">.</span><span class="ident" id="5161632">mu</span><span class="op" id="5161634">.</span><span class="ident" id="5161635">RLock</span><span class="op" id="5161640">(</span><span class="op" id="5161641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161644">service</span>&nbsp;<span class="op" id="5161652">=</span>&nbsp;<span class="ident" id="5161654">server</span><span class="op" id="5161660">.</span><span class="ident" id="5161661">serviceMap</span><span class="op" id="5161671">[</span><span class="ident" id="5161672">serviceName</span><span class="op" id="5161683">]</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161686">server</span><span class="op" id="5161692">.</span><span class="ident" id="5161693">mu</span><span class="op" id="5161695">.</span><span class="ident" id="5161696">RUnlock</span><span class="op" id="5161703">(</span><span class="op" id="5161704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5161707">if</span>&nbsp;<span class="ident" id="5161710">service</span>&nbsp;<span class="op" id="5161718">==</span>&nbsp;<span class="ident" id="5161721">nil</span>&nbsp;<span class="op" id="5161725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161729">err</span>&nbsp;<span class="op" id="5161733">=</span>&nbsp;<span class="ident" id="5161735">errors</span><span class="op" id="5161741">.</span><span class="ident" id="5161742">New</span><span class="op" id="5161745">(</span><span class="string" id="5161746">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;service&nbsp;&#34;</span>&nbsp;<span class="op" id="5161773">+</span>&nbsp;<span class="ident" id="5161775">req</span><span class="op" id="5161778">.</span><span class="ident" id="5161779">ServiceMethod</span><span class="op" id="5161792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5161796">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5161804">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161807">mtype</span>&nbsp;<span class="op" id="5161813">=</span>&nbsp;<span class="ident" id="5161815">service</span><span class="op" id="5161822">.</span><span class="ident" id="5161823">method</span><span class="op" id="5161829">[</span><span class="ident" id="5161830">methodName</span><span class="op" id="5161840">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5161843">if</span>&nbsp;<span class="ident" id="5161846">mtype</span>&nbsp;<span class="op" id="5161852">==</span>&nbsp;<span class="ident" id="5161855">nil</span>&nbsp;<span class="op" id="5161859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161863">err</span>&nbsp;<span class="op" id="5161867">=</span>&nbsp;<span class="ident" id="5161869">errors</span><span class="op" id="5161875">.</span><span class="ident" id="5161876">New</span><span class="op" id="5161879">(</span><span class="string" id="5161880">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;method&nbsp;&#34;</span>&nbsp;<span class="op" id="5161906">+</span>&nbsp;<span class="ident" id="5161908">req</span><span class="op" id="5161911">.</span><span class="ident" id="5161912">ServiceMethod</span><span class="op" id="5161925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5161928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5161931">return</span><br>
<span class="lineno">610</span><span class="op" id="5161938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5161941">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5162007">//&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.&nbsp;&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="5162077">//&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno">615</span><span class="keyword" id="5162110">func</span>&nbsp;<span class="op" id="5162115">(</span><span class="ident" id="5162116">server</span>&nbsp;<span class="op" id="5162123">*</span><span class="ident" id="5162124">Server</span><span class="op" id="5162130">)</span>&nbsp;<span class="ident" id="5162132">Accept</span><span class="op" id="5162138">(</span><span class="ident" id="5162139">lis</span>&nbsp;<span class="ident" id="5162143">net</span><span class="op" id="5162146">.</span><span class="ident" id="5162147">Listener</span><span class="op" id="5162155">)</span>&nbsp;<span class="op" id="5162157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162160">for</span>&nbsp;<span class="op" id="5162164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5162168">conn</span><span class="op" id="5162172">,</span>&nbsp;<span class="ident" id="5162174">err</span>&nbsp;<span class="op" id="5162178">:=</span>&nbsp;<span class="ident" id="5162181">lis</span><span class="op" id="5162184">.</span><span class="ident" id="5162185">Accept</span><span class="op" id="5162191">(</span><span class="op" id="5162192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162196">if</span>&nbsp;<span class="ident" id="5162199">err</span>&nbsp;<span class="op" id="5162203">!=</span>&nbsp;<span class="ident" id="5162206">nil</span>&nbsp;<span class="op" id="5162210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5162215">log</span><span class="op" id="5162218">.</span><span class="ident" id="5162219">Fatal</span><span class="op" id="5162224">(</span><span class="string" id="5162225">&#34;rpc.Serve:&nbsp;accept:&#34;</span><span class="op" id="5162245">,</span>&nbsp;<span class="ident" id="5162247">err</span><span class="op" id="5162250">.</span><span class="ident" id="5162251">Error</span><span class="op" id="5162256">(</span><span class="op" id="5162257">)</span><span class="op" id="5162258">)</span>&nbsp;<span class="comment" id="5162260">//&nbsp;TODO(r):&nbsp;exit?</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5162280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162284">go</span>&nbsp;<span class="ident" id="5162287">server</span><span class="op" id="5162293">.</span><span class="ident" id="5162294">ServeConn</span><span class="op" id="5162303">(</span><span class="ident" id="5162304">conn</span><span class="op" id="5162308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5162311">}</span><br>
<span class="lineno"></span><span class="op" id="5162313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span><span class="comment" id="5162316">//&nbsp;Register&nbsp;publishes&nbsp;the&nbsp;receiver&#39;s&nbsp;methods&nbsp;in&nbsp;the&nbsp;DefaultServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5162383">func</span>&nbsp;<span class="ident" id="5162388">Register</span><span class="op" id="5162396">(</span><span class="ident" id="5162397">rcvr</span>&nbsp;<span class="keyword" id="5162402">interface</span><span class="op" id="5162411">{</span><span class="op" id="5162412">}</span><span class="op" id="5162413">)</span>&nbsp;<span class="builtintype" id="5162415">error</span>&nbsp;<span class="op" id="5162421">{</span>&nbsp;<span class="keyword" id="5162423">return</span>&nbsp;<span class="ident" id="5162430">DefaultServer</span><span class="op" id="5162443">.</span><span class="ident" id="5162444">Register</span><span class="op" id="5162452">(</span><span class="ident" id="5162453">rcvr</span><span class="op" id="5162457">)</span>&nbsp;<span class="op" id="5162459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5162462">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5162535">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno">630</span><span class="keyword" id="5162579">func</span>&nbsp;<span class="ident" id="5162584">RegisterName</span><span class="op" id="5162596">(</span><span class="ident" id="5162597">name</span>&nbsp;<span class="builtintype" id="5162602">string</span><span class="op" id="5162608">,</span>&nbsp;<span class="ident" id="5162610">rcvr</span>&nbsp;<span class="keyword" id="5162615">interface</span><span class="op" id="5162624">{</span><span class="op" id="5162625">}</span><span class="op" id="5162626">)</span>&nbsp;<span class="builtintype" id="5162628">error</span>&nbsp;<span class="op" id="5162634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162637">return</span>&nbsp;<span class="ident" id="5162644">DefaultServer</span><span class="op" id="5162657">.</span><span class="ident" id="5162658">RegisterName</span><span class="op" id="5162670">(</span><span class="ident" id="5162671">name</span><span class="op" id="5162675">,</span>&nbsp;<span class="ident" id="5162677">rcvr</span><span class="op" id="5162681">)</span><br>
<span class="lineno"></span><span class="op" id="5162683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5162686">//&nbsp;A&nbsp;ServerCodec&nbsp;implements&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and&nbsp;writing&nbsp;of</span><br>
<span class="lineno">635</span><span class="comment" id="5162753">//&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="5162809">//&nbsp;The&nbsp;server&nbsp;calls&nbsp;ReadRequestHeader&nbsp;and&nbsp;ReadRequestBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="5162876">//&nbsp;to&nbsp;read&nbsp;requests&nbsp;from&nbsp;the&nbsp;connection,&nbsp;and&nbsp;it&nbsp;calls&nbsp;WriteResponse&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5162947">//&nbsp;write&nbsp;a&nbsp;response&nbsp;back.&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5163020">//&nbsp;connection.&nbsp;ReadRequestBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">640</span><span class="comment" id="5163076">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;request&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="5163147">type</span>&nbsp;<span class="ident" id="5163152">ServerCodec</span>&nbsp;<span class="keyword" id="5163164">interface</span>&nbsp;<span class="op" id="5163174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163177">ReadRequestHeader</span><span class="op" id="5163194">(</span><span class="op" id="5163195">*</span><span class="ident" id="5163196">Request</span><span class="op" id="5163203">)</span>&nbsp;<span class="builtintype" id="5163205">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163212">ReadRequestBody</span><span class="op" id="5163227">(</span><span class="keyword" id="5163228">interface</span><span class="op" id="5163237">{</span><span class="op" id="5163238">}</span><span class="op" id="5163239">)</span>&nbsp;<span class="builtintype" id="5163241">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5163248">//&nbsp;WriteResponse&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163322">WriteResponse</span><span class="op" id="5163335">(</span><span class="op" id="5163336">*</span><span class="ident" id="5163337">Response</span><span class="op" id="5163345">,</span>&nbsp;<span class="keyword" id="5163347">interface</span><span class="op" id="5163356">{</span><span class="op" id="5163357">}</span><span class="op" id="5163358">)</span>&nbsp;<span class="builtintype" id="5163360">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163368">Close</span><span class="op" id="5163373">(</span><span class="op" id="5163374">)</span>&nbsp;<span class="builtintype" id="5163376">error</span><br>
<span class="lineno"></span><span class="op" id="5163382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="5163385">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;DefaultServer&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5163445">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5163516">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5163577">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5163640">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">655</span><span class="keyword" id="5163699">func</span>&nbsp;<span class="ident" id="5163704">ServeConn</span><span class="op" id="5163713">(</span><span class="ident" id="5163714">conn</span>&nbsp;<span class="ident" id="5163719">io</span><span class="op" id="5163721">.</span><span class="ident" id="5163722">ReadWriteCloser</span><span class="op" id="5163737">)</span>&nbsp;<span class="op" id="5163739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163742">DefaultServer</span><span class="op" id="5163755">.</span><span class="ident" id="5163756">ServeConn</span><span class="op" id="5163765">(</span><span class="ident" id="5163766">conn</span><span class="op" id="5163770">)</span><br>
<span class="lineno"></span><span class="op" id="5163772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5163775">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno">660</span><span class="comment" id="5163839">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5163880">func</span>&nbsp;<span class="ident" id="5163885">ServeCodec</span><span class="op" id="5163895">(</span><span class="ident" id="5163896">codec</span>&nbsp;<span class="ident" id="5163902">ServerCodec</span><span class="op" id="5163913">)</span>&nbsp;<span class="op" id="5163915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163918">DefaultServer</span><span class="op" id="5163931">.</span><span class="ident" id="5163932">ServeCodec</span><span class="op" id="5163942">(</span><span class="ident" id="5163943">codec</span><span class="op" id="5163948">)</span><br>
<span class="lineno"></span><span class="op" id="5163950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="5163953">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5164031">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5164079">func</span>&nbsp;<span class="ident" id="5164084">ServeRequest</span><span class="op" id="5164096">(</span><span class="ident" id="5164097">codec</span>&nbsp;<span class="ident" id="5164103">ServerCodec</span><span class="op" id="5164114">)</span>&nbsp;<span class="builtintype" id="5164116">error</span>&nbsp;<span class="op" id="5164122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5164125">return</span>&nbsp;<span class="ident" id="5164132">DefaultServer</span><span class="op" id="5164145">.</span><span class="ident" id="5164146">ServeRequest</span><span class="op" id="5164158">(</span><span class="ident" id="5164159">codec</span><span class="op" id="5164164">)</span><br>
<span class="lineno"></span><span class="op" id="5164166">}</span><br>
<span class="lineno">670</span><br>
<span class="lineno"></span><span class="comment" id="5164169">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5164235">//&nbsp;to&nbsp;DefaultServer&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5164285">//&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5164354">func</span>&nbsp;<span class="ident" id="5164359">Accept</span><span class="op" id="5164365">(</span><span class="ident" id="5164366">lis</span>&nbsp;<span class="ident" id="5164370">net</span><span class="op" id="5164373">.</span><span class="ident" id="5164374">Listener</span><span class="op" id="5164382">)</span>&nbsp;<span class="op" id="5164384">{</span>&nbsp;<span class="ident" id="5164386">DefaultServer</span><span class="op" id="5164399">.</span><span class="ident" id="5164400">Accept</span><span class="op" id="5164406">(</span><span class="ident" id="5164407">lis</span><span class="op" id="5164410">)</span>&nbsp;<span class="op" id="5164412">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="comment" id="5164415">//&nbsp;Can&nbsp;connect&nbsp;to&nbsp;RPC&nbsp;service&nbsp;using&nbsp;HTTP&nbsp;CONNECT&nbsp;to&nbsp;rpcPath.</span><br>
<span class="lineno"></span><span class="keyword" id="5164476">var</span>&nbsp;<span class="ident" id="5164480">connected</span>&nbsp;<span class="op" id="5164490">=</span>&nbsp;<span class="string" id="5164492">&#34;200&nbsp;Connected&nbsp;to&nbsp;Go&nbsp;RPC&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5164519">//&nbsp;ServeHTTP&nbsp;implements&nbsp;an&nbsp;http.Handler&nbsp;that&nbsp;answers&nbsp;RPC&nbsp;requests.</span><br>
<span class="lineno">680</span><span class="keyword" id="5164586">func</span>&nbsp;<span class="op" id="5164591">(</span><span class="ident" id="5164592">server</span>&nbsp;<span class="op" id="5164599">*</span><span class="ident" id="5164600">Server</span><span class="op" id="5164606">)</span>&nbsp;<span class="ident" id="5164608">ServeHTTP</span><span class="op" id="5164617">(</span><span class="ident" id="5164618">w</span>&nbsp;<span class="ident" id="5164620">http</span><span class="op" id="5164624">.</span><span class="ident" id="5164625">ResponseWriter</span><span class="op" id="5164639">,</span>&nbsp;<span class="ident" id="5164641">req</span>&nbsp;<span class="op" id="5164645">*</span><span class="ident" id="5164646">http</span><span class="op" id="5164650">.</span><span class="ident" id="5164651">Request</span><span class="op" id="5164658">)</span>&nbsp;<span class="op" id="5164660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5164663">if</span>&nbsp;<span class="ident" id="5164666">req</span><span class="op" id="5164669">.</span><span class="ident" id="5164670">Method</span>&nbsp;<span class="op" id="5164677">!=</span>&nbsp;<span class="string" id="5164680">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="5164690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5164694">w</span><span class="op" id="5164695">.</span><span class="ident" id="5164696">Header</span><span class="op" id="5164702">(</span><span class="op" id="5164703">)</span><span class="op" id="5164704">.</span><span class="ident" id="5164705">Set</span><span class="op" id="5164708">(</span><span class="string" id="5164709">&#34;Content-Type&#34;</span><span class="op" id="5164723">,</span>&nbsp;<span class="string" id="5164725">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="5164752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5164756">w</span><span class="op" id="5164757">.</span><span class="ident" id="5164758">WriteHeader</span><span class="op" id="5164769">(</span><span class="ident" id="5164770">http</span><span class="op" id="5164774">.</span><span class="ident" id="5164775">StatusMethodNotAllowed</span><span class="op" id="5164797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5164801">io</span><span class="op" id="5164803">.</span><span class="ident" id="5164804">WriteString</span><span class="op" id="5164815">(</span><span class="ident" id="5164816">w</span><span class="op" id="5164817">,</span>&nbsp;<span class="string" id="5164819">&#34;405&nbsp;must&nbsp;CONNECT\n&#34;</span><span class="op" id="5164839">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5164843">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5164851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5164854">conn</span><span class="op" id="5164858">,</span>&nbsp;<span class="ident" id="5164860">_</span><span class="op" id="5164861">,</span>&nbsp;<span class="ident" id="5164863">err</span>&nbsp;<span class="op" id="5164867">:=</span>&nbsp;<span class="ident" id="5164870">w</span><span class="op" id="5164871">.</span><span class="op" id="5164872">(</span><span class="ident" id="5164873">http</span><span class="op" id="5164877">.</span><span class="ident" id="5164878">Hijacker</span><span class="op" id="5164886">)</span><span class="op" id="5164887">.</span><span class="ident" id="5164888">Hijack</span><span class="op" id="5164894">(</span><span class="op" id="5164895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5164898">if</span>&nbsp;<span class="ident" id="5164901">err</span>&nbsp;<span class="op" id="5164905">!=</span>&nbsp;<span class="ident" id="5164908">nil</span>&nbsp;<span class="op" id="5164912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5164916">log</span><span class="op" id="5164919">.</span><span class="ident" id="5164920">Print</span><span class="op" id="5164925">(</span><span class="string" id="5164926">&#34;rpc&nbsp;hijacking&nbsp;&#34;</span><span class="op" id="5164942">,</span>&nbsp;<span class="ident" id="5164944">req</span><span class="op" id="5164947">.</span><span class="ident" id="5164948">RemoteAddr</span><span class="op" id="5164958">,</span>&nbsp;<span class="string" id="5164960">&#34;:&nbsp;&#34;</span><span class="op" id="5164964">,</span>&nbsp;<span class="ident" id="5164966">err</span><span class="op" id="5164969">.</span><span class="ident" id="5164970">Error</span><span class="op" id="5164975">(</span><span class="op" id="5164976">)</span><span class="op" id="5164977">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5164981">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5164989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5164992">io</span><span class="op" id="5164994">.</span><span class="ident" id="5164995">WriteString</span><span class="op" id="5165006">(</span><span class="ident" id="5165007">conn</span><span class="op" id="5165011">,</span>&nbsp;<span class="string" id="5165013">&#34;HTTP/1.0&nbsp;&#34;</span><span class="op" id="5165024">+</span><span class="ident" id="5165025">connected</span><span class="op" id="5165034">+</span><span class="string" id="5165035">&#34;\n\n&#34;</span><span class="op" id="5165041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5165044">server</span><span class="op" id="5165050">.</span><span class="ident" id="5165051">ServeConn</span><span class="op" id="5165060">(</span><span class="ident" id="5165061">conn</span><span class="op" id="5165065">)</span><br>
<span class="lineno"></span><span class="op" id="5165067">}</span><br>
<span class="lineno">695</span><br>
<span class="lineno"></span><span class="comment" id="5165070">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;on&nbsp;rpcPath,</span><br>
<span class="lineno"></span><span class="comment" id="5165139">//&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;debugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5165180">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5165258">func</span>&nbsp;<span class="op" id="5165263">(</span><span class="ident" id="5165264">server</span>&nbsp;<span class="op" id="5165271">*</span><span class="ident" id="5165272">Server</span><span class="op" id="5165278">)</span>&nbsp;<span class="ident" id="5165280">HandleHTTP</span><span class="op" id="5165290">(</span><span class="ident" id="5165291">rpcPath</span><span class="op" id="5165298">,</span>&nbsp;<span class="ident" id="5165300">debugPath</span>&nbsp;<span class="builtintype" id="5165310">string</span><span class="op" id="5165316">)</span>&nbsp;<span class="op" id="5165318">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5165321">http</span><span class="op" id="5165325">.</span><span class="ident" id="5165326">Handle</span><span class="op" id="5165332">(</span><span class="ident" id="5165333">rpcPath</span><span class="op" id="5165340">,</span>&nbsp;<span class="ident" id="5165342">server</span><span class="op" id="5165348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5165351">http</span><span class="op" id="5165355">.</span><span class="ident" id="5165356">Handle</span><span class="op" id="5165362">(</span><span class="ident" id="5165363">debugPath</span><span class="op" id="5165372">,</span>&nbsp;<span class="ident" id="5165374">debugHTTP</span><span class="op" id="5165383">{</span><span class="ident" id="5165384">server</span><span class="op" id="5165390">}</span><span class="op" id="5165391">)</span><br>
<span class="lineno"></span><span class="op" id="5165393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5165396">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;to&nbsp;DefaultServer</span><br>
<span class="lineno">705</span><span class="comment" id="5165470">//&nbsp;on&nbsp;DefaultRPCPath&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;DefaultDebugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5165536">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5165614">func</span>&nbsp;<span class="ident" id="5165619">HandleHTTP</span><span class="op" id="5165629">(</span><span class="op" id="5165630">)</span>&nbsp;<span class="op" id="5165632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5165635">DefaultServer</span><span class="op" id="5165648">.</span><span class="ident" id="5165649">HandleHTTP</span><span class="op" id="5165659">(</span><span class="ident" id="5165660">DefaultRPCPath</span><span class="op" id="5165674">,</span>&nbsp;<span class="ident" id="5165676">DefaultDebugPath</span><span class="op" id="5165692">)</span><br>
<span class="lineno"></span><span class="op" id="5165694">}</span>
</div>
</body>
</html>
