<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1399282">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1399337">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1399391">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1399442">//&nbsp;Package&nbsp;sync&nbsp;provides&nbsp;basic&nbsp;synchronization&nbsp;primitives&nbsp;such&nbsp;as&nbsp;mutual</span><br>
<span class="lineno"></span><span class="comment" id="1399515">//&nbsp;exclusion&nbsp;locks.&nbsp;&nbsp;Other&nbsp;than&nbsp;the&nbsp;Once&nbsp;and&nbsp;WaitGroup&nbsp;types,&nbsp;most&nbsp;are&nbsp;intended</span><br>
<span class="lineno"></span><span class="comment" id="1399595">//&nbsp;for&nbsp;use&nbsp;by&nbsp;low-level&nbsp;library&nbsp;routines.&nbsp;&nbsp;Higher-level&nbsp;synchronization&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1399670">//&nbsp;better&nbsp;done&nbsp;via&nbsp;channels&nbsp;and&nbsp;communication.</span><br>
<span class="lineno"></span><span class="comment" id="1399717">//</span><br>
<span class="lineno">10</span><span class="comment" id="1399720">//&nbsp;Values&nbsp;containing&nbsp;the&nbsp;types&nbsp;defined&nbsp;in&nbsp;this&nbsp;package&nbsp;should&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno"></span><span class="keyword" id="1399797">package</span>&nbsp;<span class="ident" id="1399805">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1399811">import</span>&nbsp;<span class="op" id="1399818">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1399821">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1399836">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1399845">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1399848">//&nbsp;A&nbsp;Mutex&nbsp;is&nbsp;a&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1399887">//&nbsp;Mutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures;</span><br>
<span class="lineno">20</span><span class="comment" id="1399942">//&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Mutex&nbsp;is&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1399994">type</span>&nbsp;<span class="ident" id="1399999">Mutex</span>&nbsp;<span class="keyword" id="1400005">struct</span>&nbsp;<span class="op" id="1400012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400015">state</span>&nbsp;<span class="builtintype" id="1400021">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400028">sema</span>&nbsp;&nbsp;<span class="builtintype" id="1400034">uint32</span><br>
<span class="lineno"></span><span class="op" id="1400041">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="1400044">//&nbsp;A&nbsp;Locker&nbsp;represents&nbsp;an&nbsp;object&nbsp;that&nbsp;can&nbsp;be&nbsp;locked&nbsp;and&nbsp;unlocked.</span><br>
<span class="lineno"></span><span class="keyword" id="1400110">type</span>&nbsp;<span class="ident" id="1400115">Locker</span>&nbsp;<span class="keyword" id="1400122">interface</span>&nbsp;<span class="op" id="1400132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400135">Lock</span><span class="op" id="1400139">(</span><span class="op" id="1400140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400143">Unlock</span><span class="op" id="1400149">(</span><span class="op" id="1400150">)</span><br>
<span class="lineno">30</span><span class="op" id="1400152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1400155">const</span>&nbsp;<span class="op" id="1400161">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400164">mutexLocked</span>&nbsp;<span class="op" id="1400176">=</span>&nbsp;<span class="num" id="1400178">1</span>&nbsp;<span class="op" id="1400180">&lt;&lt;</span>&nbsp;<span class="ident" id="1400183">iota</span>&nbsp;<span class="comment" id="1400188">//&nbsp;mutex&nbsp;is&nbsp;locked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400208">mutexWoken</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400220">mutexWaiterShift</span>&nbsp;<span class="op" id="1400237">=</span>&nbsp;<span class="ident" id="1400239">iota</span><br>
<span class="lineno"></span><span class="op" id="1400244">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1400247">//&nbsp;Lock&nbsp;locks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1400264">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;in&nbsp;use,&nbsp;the&nbsp;calling&nbsp;goroutine</span><br>
<span class="lineno">40</span><span class="comment" id="1400320">//&nbsp;blocks&nbsp;until&nbsp;the&nbsp;mutex&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1400360">func</span>&nbsp;<span class="op" id="1400365">(</span><span class="ident" id="1400366">m</span>&nbsp;<span class="op" id="1400368">*</span><span class="ident" id="1400369">Mutex</span><span class="op" id="1400374">)</span>&nbsp;<span class="ident" id="1400376">Lock</span><span class="op" id="1400380">(</span><span class="op" id="1400381">)</span>&nbsp;<span class="op" id="1400383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1400386">//&nbsp;Fast&nbsp;path:&nbsp;grab&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400422">if</span>&nbsp;<span class="ident" id="1400425">atomic</span><span class="op" id="1400431">.</span><span class="ident" id="1400432">CompareAndSwapInt32</span><span class="op" id="1400451">(</span><span class="op" id="1400452">&amp;</span><span class="ident" id="1400453">m</span><span class="op" id="1400454">.</span><span class="ident" id="1400455">state</span><span class="op" id="1400460">,</span>&nbsp;<span class="num" id="1400462">0</span><span class="op" id="1400463">,</span>&nbsp;<span class="ident" id="1400465">mutexLocked</span><span class="op" id="1400476">)</span>&nbsp;<span class="op" id="1400478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400482">if</span>&nbsp;<span class="ident" id="1400485">raceenabled</span>&nbsp;<span class="op" id="1400497">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400502">raceAcquire</span><span class="op" id="1400513">(</span><span class="ident" id="1400514">unsafe</span><span class="op" id="1400520">.</span><span class="ident" id="1400521">Pointer</span><span class="op" id="1400528">(</span><span class="ident" id="1400529">m</span><span class="op" id="1400530">)</span><span class="op" id="1400531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1400535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400539">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1400547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400551">awoke</span>&nbsp;<span class="op" id="1400557">:=</span>&nbsp;<span class="builtintype" id="1400560">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400567">for</span>&nbsp;<span class="op" id="1400571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400575">old</span>&nbsp;<span class="op" id="1400579">:=</span>&nbsp;<span class="ident" id="1400582">m</span><span class="op" id="1400583">.</span><span class="ident" id="1400584">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1400592">new</span>&nbsp;<span class="op" id="1400596">:=</span>&nbsp;<span class="ident" id="1400599">old</span>&nbsp;<span class="op" id="1400603">|</span>&nbsp;<span class="ident" id="1400605">mutexLocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400619">if</span>&nbsp;<span class="ident" id="1400622">old</span><span class="op" id="1400625">&amp;</span><span class="ident" id="1400626">mutexLocked</span>&nbsp;<span class="op" id="1400638">!=</span>&nbsp;<span class="num" id="1400641">0</span>&nbsp;<span class="op" id="1400643">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1400648">new</span>&nbsp;<span class="op" id="1400652">=</span>&nbsp;<span class="ident" id="1400654">old</span>&nbsp;<span class="op" id="1400658">+</span>&nbsp;<span class="num" id="1400660">1</span><span class="op" id="1400661">&lt;&lt;</span><span class="ident" id="1400663">mutexWaiterShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1400682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400686">if</span>&nbsp;<span class="ident" id="1400689">awoke</span>&nbsp;<span class="op" id="1400695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1400700">//&nbsp;The&nbsp;goroutine&nbsp;has&nbsp;been&nbsp;woken&nbsp;from&nbsp;sleep,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1400747">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;reset&nbsp;the&nbsp;flag&nbsp;in&nbsp;either&nbsp;case.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1400798">new</span>&nbsp;<span class="op" id="1400802">&amp;^=</span>&nbsp;<span class="ident" id="1400806">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1400819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400823">if</span>&nbsp;<span class="ident" id="1400826">atomic</span><span class="op" id="1400832">.</span><span class="ident" id="1400833">CompareAndSwapInt32</span><span class="op" id="1400852">(</span><span class="op" id="1400853">&amp;</span><span class="ident" id="1400854">m</span><span class="op" id="1400855">.</span><span class="ident" id="1400856">state</span><span class="op" id="1400861">,</span>&nbsp;<span class="ident" id="1400863">old</span><span class="op" id="1400866">,</span>&nbsp;<span class="builtinfunc" id="1400868">new</span><span class="op" id="1400871">)</span>&nbsp;<span class="op" id="1400873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400878">if</span>&nbsp;<span class="ident" id="1400881">old</span><span class="op" id="1400884">&amp;</span><span class="ident" id="1400885">mutexLocked</span>&nbsp;<span class="op" id="1400897">==</span>&nbsp;<span class="num" id="1400900">0</span>&nbsp;<span class="op" id="1400902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400908">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1400917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400922">runtime_Semacquire</span><span class="op" id="1400940">(</span><span class="op" id="1400941">&amp;</span><span class="ident" id="1400942">m</span><span class="op" id="1400943">.</span><span class="ident" id="1400944">sema</span><span class="op" id="1400948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400953">awoke</span>&nbsp;<span class="op" id="1400959">=</span>&nbsp;<span class="builtintype" id="1400961">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1400968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1400971">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400975">if</span>&nbsp;<span class="ident" id="1400978">raceenabled</span>&nbsp;<span class="op" id="1400990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400994">raceAcquire</span><span class="op" id="1401005">(</span><span class="ident" id="1401006">unsafe</span><span class="op" id="1401012">.</span><span class="ident" id="1401013">Pointer</span><span class="op" id="1401020">(</span><span class="ident" id="1401021">m</span><span class="op" id="1401022">)</span><span class="op" id="1401023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1401026">}</span><br>
<span class="lineno"></span><span class="op" id="1401028">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="1401031">//&nbsp;Unlock&nbsp;unlocks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1401052">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;m&nbsp;is&nbsp;not&nbsp;locked&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1401117">//</span><br>
<span class="lineno"></span><span class="comment" id="1401120">//&nbsp;A&nbsp;locked&nbsp;Mutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular&nbsp;goroutine.</span><br>
<span class="lineno">80</span><span class="comment" id="1401185">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;for&nbsp;one&nbsp;goroutine&nbsp;to&nbsp;lock&nbsp;a&nbsp;Mutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1401245">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;unlock&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1401292">func</span>&nbsp;<span class="op" id="1401297">(</span><span class="ident" id="1401298">m</span>&nbsp;<span class="op" id="1401300">*</span><span class="ident" id="1401301">Mutex</span><span class="op" id="1401306">)</span>&nbsp;<span class="ident" id="1401308">Unlock</span><span class="op" id="1401314">(</span><span class="op" id="1401315">)</span>&nbsp;<span class="op" id="1401317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1401320">if</span>&nbsp;<span class="ident" id="1401323">raceenabled</span>&nbsp;<span class="op" id="1401335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1401339">_</span>&nbsp;<span class="op" id="1401341">=</span>&nbsp;<span class="ident" id="1401343">m</span><span class="op" id="1401344">.</span><span class="ident" id="1401345">state</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1401353">raceRelease</span><span class="op" id="1401364">(</span><span class="ident" id="1401365">unsafe</span><span class="op" id="1401371">.</span><span class="ident" id="1401372">Pointer</span><span class="op" id="1401379">(</span><span class="ident" id="1401380">m</span><span class="op" id="1401381">)</span><span class="op" id="1401382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1401385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1401389">//&nbsp;Fast&nbsp;path:&nbsp;drop&nbsp;lock&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1401419">new</span>&nbsp;<span class="op" id="1401423">:=</span>&nbsp;<span class="ident" id="1401426">atomic</span><span class="op" id="1401432">.</span><span class="ident" id="1401433">AddInt32</span><span class="op" id="1401441">(</span><span class="op" id="1401442">&amp;</span><span class="ident" id="1401443">m</span><span class="op" id="1401444">.</span><span class="ident" id="1401445">state</span><span class="op" id="1401450">,</span>&nbsp;<span class="op" id="1401452">-</span><span class="ident" id="1401453">mutexLocked</span><span class="op" id="1401464">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1401467">if</span>&nbsp;<span class="op" id="1401470">(</span><span class="builtinfunc" id="1401471">new</span><span class="op" id="1401474">+</span><span class="ident" id="1401475">mutexLocked</span><span class="op" id="1401486">)</span><span class="op" id="1401487">&amp;</span><span class="ident" id="1401488">mutexLocked</span>&nbsp;<span class="op" id="1401500">==</span>&nbsp;<span class="num" id="1401503">0</span>&nbsp;<span class="op" id="1401505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1401509">panic</span><span class="op" id="1401514">(</span><span class="string" id="1401515">&#34;sync:&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;mutex&#34;</span><span class="op" id="1401547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1401550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1401554">old</span>&nbsp;<span class="op" id="1401558">:=</span>&nbsp;<span class="builtinfunc" id="1401561">new</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1401566">for</span>&nbsp;<span class="op" id="1401570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1401574">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;waiters&nbsp;or&nbsp;a&nbsp;goroutine&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1401630">//&nbsp;been&nbsp;woken&nbsp;or&nbsp;grabbed&nbsp;the&nbsp;lock,&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;anyone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1401691">if</span>&nbsp;<span class="ident" id="1401694">old</span><span class="op" id="1401697">&gt;&gt;</span><span class="ident" id="1401699">mutexWaiterShift</span>&nbsp;<span class="op" id="1401716">==</span>&nbsp;<span class="num" id="1401719">0</span>&nbsp;<span class="op" id="1401721">||</span>&nbsp;<span class="ident" id="1401724">old</span><span class="op" id="1401727">&amp;</span><span class="op" id="1401728">(</span><span class="ident" id="1401729">mutexLocked</span><span class="op" id="1401740">|</span><span class="ident" id="1401741">mutexWoken</span><span class="op" id="1401751">)</span>&nbsp;<span class="op" id="1401753">!=</span>&nbsp;<span class="num" id="1401756">0</span>&nbsp;<span class="op" id="1401758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1401763">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1401772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1401776">//&nbsp;Grab&nbsp;the&nbsp;right&nbsp;to&nbsp;wake&nbsp;someone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1401813">new</span>&nbsp;<span class="op" id="1401817">=</span>&nbsp;<span class="op" id="1401819">(</span><span class="ident" id="1401820">old</span>&nbsp;<span class="op" id="1401824">-</span>&nbsp;<span class="num" id="1401826">1</span><span class="op" id="1401827">&lt;&lt;</span><span class="ident" id="1401829">mutexWaiterShift</span><span class="op" id="1401845">)</span>&nbsp;<span class="op" id="1401847">|</span>&nbsp;<span class="ident" id="1401849">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1401862">if</span>&nbsp;<span class="ident" id="1401865">atomic</span><span class="op" id="1401871">.</span><span class="ident" id="1401872">CompareAndSwapInt32</span><span class="op" id="1401891">(</span><span class="op" id="1401892">&amp;</span><span class="ident" id="1401893">m</span><span class="op" id="1401894">.</span><span class="ident" id="1401895">state</span><span class="op" id="1401900">,</span>&nbsp;<span class="ident" id="1401902">old</span><span class="op" id="1401905">,</span>&nbsp;<span class="builtinfunc" id="1401907">new</span><span class="op" id="1401910">)</span>&nbsp;<span class="op" id="1401912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1401917">runtime_Semrelease</span><span class="op" id="1401935">(</span><span class="op" id="1401936">&amp;</span><span class="ident" id="1401937">m</span><span class="op" id="1401938">.</span><span class="ident" id="1401939">sema</span><span class="op" id="1401943">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1401948">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1401957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1401961">old</span>&nbsp;<span class="op" id="1401965">=</span>&nbsp;<span class="ident" id="1401967">m</span><span class="op" id="1401968">.</span><span class="ident" id="1401969">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1401976">}</span><br>
<span class="lineno"></span><span class="op" id="1401978">}</span>
</div>
</body>
</html>
