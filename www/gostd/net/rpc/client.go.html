<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html" class="current">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4840183">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4840238">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4840292">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4840343">package</span>&nbsp;<span class="ident" id="4840351">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4840356">import</span>&nbsp;<span class="op" id="4840363">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4840366">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4840375">&#34;encoding/gob&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4840391">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4840401">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4840407">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4840414">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4840421">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4840433">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4840440">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4840443">//&nbsp;ServerError&nbsp;represents&nbsp;an&nbsp;error&nbsp;that&nbsp;has&nbsp;been&nbsp;returned&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4840506">//&nbsp;the&nbsp;remote&nbsp;side&nbsp;of&nbsp;the&nbsp;RPC&nbsp;connection.</span><br>
<span class="lineno">20</span><span class="keyword" id="4840548">type</span>&nbsp;<span class="ident" id="4840553">ServerError</span>&nbsp;<span class="builtintype" id="4840565">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4840573">func</span>&nbsp;<span class="op" id="4840578">(</span><span class="ident" id="4840579">e</span>&nbsp;<span class="ident" id="4840581">ServerError</span><span class="op" id="4840592">)</span>&nbsp;<span class="ident" id="4840594">Error</span><span class="op" id="4840599">(</span><span class="op" id="4840600">)</span>&nbsp;<span class="builtintype" id="4840602">string</span>&nbsp;<span class="op" id="4840609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4840612">return</span>&nbsp;<span class="builtintype" id="4840619">string</span><span class="op" id="4840625">(</span><span class="ident" id="4840626">e</span><span class="op" id="4840627">)</span><br>
<span class="lineno"></span><span class="op" id="4840629">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="4840632">var</span>&nbsp;<span class="ident" id="4840636">ErrShutdown</span>&nbsp;<span class="op" id="4840648">=</span>&nbsp;<span class="ident" id="4840650">errors</span><span class="op" id="4840656">.</span><span class="ident" id="4840657">New</span><span class="op" id="4840660">(</span><span class="string" id="4840661">&#34;connection&nbsp;is&nbsp;shut&nbsp;down&#34;</span><span class="op" id="4840686">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4840689">//&nbsp;Call&nbsp;represents&nbsp;an&nbsp;active&nbsp;RPC.</span><br>
<span class="lineno"></span><span class="keyword" id="4840723">type</span>&nbsp;<span class="ident" id="4840728">Call</span>&nbsp;<span class="keyword" id="4840733">struct</span>&nbsp;<span class="op" id="4840740">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4840743">ServiceMethod</span>&nbsp;<span class="builtintype" id="4840757">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4840769">//&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4840817">Args</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4840831">interface</span><span class="op" id="4840840">{</span><span class="op" id="4840841">}</span>&nbsp;<span class="comment" id="4840843">//&nbsp;The&nbsp;argument&nbsp;to&nbsp;the&nbsp;function&nbsp;(*struct).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4840887">Reply</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4840901">interface</span><span class="op" id="4840910">{</span><span class="op" id="4840911">}</span>&nbsp;<span class="comment" id="4840913">//&nbsp;The&nbsp;reply&nbsp;from&nbsp;the&nbsp;function&nbsp;(*struct).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4840956">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4840970">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4840982">//&nbsp;After&nbsp;completion,&nbsp;the&nbsp;error&nbsp;status.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4841022">Done</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4841036">chan</span>&nbsp;<span class="op" id="4841041">*</span><span class="ident" id="4841042">Call</span>&nbsp;&nbsp;<span class="comment" id="4841048">//&nbsp;Strobes&nbsp;when&nbsp;call&nbsp;is&nbsp;complete.</span><br>
<span class="lineno">35</span><span class="op" id="4841082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4841085">//&nbsp;Client&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Client.</span><br>
<span class="lineno"></span><span class="comment" id="4841121">//&nbsp;There&nbsp;may&nbsp;be&nbsp;multiple&nbsp;outstanding&nbsp;Calls&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment" id="4841175">//&nbsp;with&nbsp;a&nbsp;single&nbsp;Client,&nbsp;and&nbsp;a&nbsp;Client&nbsp;may&nbsp;be&nbsp;used&nbsp;by</span><br>
<span class="lineno">40</span><span class="comment" id="4841228">//&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="keyword" id="4841267">type</span>&nbsp;<span class="ident" id="4841272">Client</span>&nbsp;<span class="keyword" id="4841279">struct</span>&nbsp;<span class="op" id="4841286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4841289">codec</span>&nbsp;<span class="ident" id="4841295">ClientCodec</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4841309">reqMutex</span>&nbsp;<span class="ident" id="4841318">sync</span><span class="op" id="4841322">.</span><span class="ident" id="4841323">Mutex</span>&nbsp;<span class="comment" id="4841329">//&nbsp;protects&nbsp;following</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4841352">request</span>&nbsp;&nbsp;<span class="ident" id="4841361">Request</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4841371">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4841380">sync</span><span class="op" id="4841384">.</span><span class="ident" id="4841385">Mutex</span>&nbsp;<span class="comment" id="4841391">//&nbsp;protects&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4841414">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4841423">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4841431">pending</span>&nbsp;&nbsp;<span class="keyword" id="4841440">map</span><span class="op" id="4841443">[</span><span class="ident" id="4841444">uint64</span><span class="op" id="4841450">]</span><span class="op" id="4841451">*</span><span class="ident" id="4841452">Call</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4841458">closing</span>&nbsp;&nbsp;<span class="builtintype" id="4841467">bool</span>&nbsp;<span class="comment" id="4841472">//&nbsp;user&nbsp;has&nbsp;called&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4841498">shutdown</span>&nbsp;<span class="builtintype" id="4841507">bool</span>&nbsp;<span class="comment" id="4841512">//&nbsp;server&nbsp;has&nbsp;told&nbsp;us&nbsp;to&nbsp;stop</span><br>
<span class="lineno"></span><span class="op" id="4841542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4841545">//&nbsp;A&nbsp;ClientCodec&nbsp;implements&nbsp;writing&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and</span><br>
<span class="lineno">55</span><span class="comment" id="4841601">//&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;client&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="4841668">//&nbsp;The&nbsp;client&nbsp;calls&nbsp;WriteRequest&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;to&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="4841738">//&nbsp;and&nbsp;calls&nbsp;ReadResponseHeader&nbsp;and&nbsp;ReadResponseBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="4841800">//&nbsp;to&nbsp;read&nbsp;responses.&nbsp;&nbsp;The&nbsp;client&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4841869">//&nbsp;connection.&nbsp;ReadResponseBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">60</span><span class="comment" id="4841926">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;response&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4841992">//&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="4842006">type</span>&nbsp;<span class="ident" id="4842011">ClientCodec</span>&nbsp;<span class="keyword" id="4842023">interface</span>&nbsp;<span class="op" id="4842033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4842036">//&nbsp;WriteRequest&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842109">WriteRequest</span><span class="op" id="4842121">(</span><span class="op" id="4842122">*</span><span class="ident" id="4842123">Request</span><span class="op" id="4842130">,</span>&nbsp;<span class="keyword" id="4842132">interface</span><span class="op" id="4842141">{</span><span class="op" id="4842142">}</span><span class="op" id="4842143">)</span>&nbsp;<span class="builtintype" id="4842145">error</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842152">ReadResponseHeader</span><span class="op" id="4842170">(</span><span class="op" id="4842171">*</span><span class="ident" id="4842172">Response</span><span class="op" id="4842180">)</span>&nbsp;<span class="builtintype" id="4842182">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842189">ReadResponseBody</span><span class="op" id="4842205">(</span><span class="keyword" id="4842206">interface</span><span class="op" id="4842215">{</span><span class="op" id="4842216">}</span><span class="op" id="4842217">)</span>&nbsp;<span class="builtintype" id="4842219">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842227">Close</span><span class="op" id="4842232">(</span><span class="op" id="4842233">)</span>&nbsp;<span class="builtintype" id="4842235">error</span><br>
<span class="lineno"></span><span class="op" id="4842241">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="4842244">func</span>&nbsp;<span class="op" id="4842249">(</span><span class="ident" id="4842250">client</span>&nbsp;<span class="op" id="4842257">*</span><span class="ident" id="4842258">Client</span><span class="op" id="4842264">)</span>&nbsp;<span class="ident" id="4842266">send</span><span class="op" id="4842270">(</span><span class="ident" id="4842271">call</span>&nbsp;<span class="op" id="4842276">*</span><span class="ident" id="4842277">Call</span><span class="op" id="4842281">)</span>&nbsp;<span class="op" id="4842283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842286">client</span><span class="op" id="4842292">.</span><span class="ident" id="4842293">reqMutex</span><span class="op" id="4842301">.</span><span class="ident" id="4842302">Lock</span><span class="op" id="4842306">(</span><span class="op" id="4842307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4842310">defer</span>&nbsp;<span class="ident" id="4842316">client</span><span class="op" id="4842322">.</span><span class="ident" id="4842323">reqMutex</span><span class="op" id="4842331">.</span><span class="ident" id="4842332">Unlock</span><span class="op" id="4842338">(</span><span class="op" id="4842339">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4842343">//&nbsp;Register&nbsp;this&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842367">client</span><span class="op" id="4842373">.</span><span class="ident" id="4842374">mutex</span><span class="op" id="4842379">.</span><span class="ident" id="4842380">Lock</span><span class="op" id="4842384">(</span><span class="op" id="4842385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4842388">if</span>&nbsp;<span class="ident" id="4842391">client</span><span class="op" id="4842397">.</span><span class="ident" id="4842398">shutdown</span>&nbsp;<span class="op" id="4842407">||</span>&nbsp;<span class="ident" id="4842410">client</span><span class="op" id="4842416">.</span><span class="ident" id="4842417">closing</span>&nbsp;<span class="op" id="4842425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842429">call</span><span class="op" id="4842433">.</span><span class="ident" id="4842434">Error</span>&nbsp;<span class="op" id="4842440">=</span>&nbsp;<span class="ident" id="4842442">ErrShutdown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842456">client</span><span class="op" id="4842462">.</span><span class="ident" id="4842463">mutex</span><span class="op" id="4842468">.</span><span class="ident" id="4842469">Unlock</span><span class="op" id="4842475">(</span><span class="op" id="4842476">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842480">call</span><span class="op" id="4842484">.</span><span class="ident" id="4842485">done</span><span class="op" id="4842489">(</span><span class="op" id="4842490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4842494">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4842502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842505">seq</span>&nbsp;<span class="op" id="4842509">:=</span>&nbsp;<span class="ident" id="4842512">client</span><span class="op" id="4842518">.</span><span class="ident" id="4842519">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842524">client</span><span class="op" id="4842530">.</span><span class="ident" id="4842531">seq</span><span class="op" id="4842534">++</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842538">client</span><span class="op" id="4842544">.</span><span class="ident" id="4842545">pending</span><span class="op" id="4842552">[</span><span class="ident" id="4842553">seq</span><span class="op" id="4842556">]</span>&nbsp;<span class="op" id="4842558">=</span>&nbsp;<span class="ident" id="4842560">call</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842566">client</span><span class="op" id="4842572">.</span><span class="ident" id="4842573">mutex</span><span class="op" id="4842578">.</span><span class="ident" id="4842579">Unlock</span><span class="op" id="4842585">(</span><span class="op" id="4842586">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4842590">//&nbsp;Encode&nbsp;and&nbsp;send&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842623">client</span><span class="op" id="4842629">.</span><span class="ident" id="4842630">request</span><span class="op" id="4842637">.</span><span class="ident" id="4842638">Seq</span>&nbsp;<span class="op" id="4842642">=</span>&nbsp;<span class="ident" id="4842644">seq</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842649">client</span><span class="op" id="4842655">.</span><span class="ident" id="4842656">request</span><span class="op" id="4842663">.</span><span class="ident" id="4842664">ServiceMethod</span>&nbsp;<span class="op" id="4842678">=</span>&nbsp;<span class="ident" id="4842680">call</span><span class="op" id="4842684">.</span><span class="ident" id="4842685">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842700">err</span>&nbsp;<span class="op" id="4842704">:=</span>&nbsp;<span class="ident" id="4842707">client</span><span class="op" id="4842713">.</span><span class="ident" id="4842714">codec</span><span class="op" id="4842719">.</span><span class="ident" id="4842720">WriteRequest</span><span class="op" id="4842732">(</span><span class="op" id="4842733">&amp;</span><span class="ident" id="4842734">client</span><span class="op" id="4842740">.</span><span class="ident" id="4842741">request</span><span class="op" id="4842748">,</span>&nbsp;<span class="ident" id="4842750">call</span><span class="op" id="4842754">.</span><span class="ident" id="4842755">Args</span><span class="op" id="4842759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4842762">if</span>&nbsp;<span class="ident" id="4842765">err</span>&nbsp;<span class="op" id="4842769">!=</span>&nbsp;<span class="ident" id="4842772">nil</span>&nbsp;<span class="op" id="4842776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842780">client</span><span class="op" id="4842786">.</span><span class="ident" id="4842787">mutex</span><span class="op" id="4842792">.</span><span class="ident" id="4842793">Lock</span><span class="op" id="4842797">(</span><span class="op" id="4842798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842802">call</span>&nbsp;<span class="op" id="4842807">=</span>&nbsp;<span class="ident" id="4842809">client</span><span class="op" id="4842815">.</span><span class="ident" id="4842816">pending</span><span class="op" id="4842823">[</span><span class="ident" id="4842824">seq</span><span class="op" id="4842827">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4842831">delete</span><span class="op" id="4842837">(</span><span class="ident" id="4842838">client</span><span class="op" id="4842844">.</span><span class="ident" id="4842845">pending</span><span class="op" id="4842852">,</span>&nbsp;<span class="ident" id="4842854">seq</span><span class="op" id="4842857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842861">client</span><span class="op" id="4842867">.</span><span class="ident" id="4842868">mutex</span><span class="op" id="4842873">.</span><span class="ident" id="4842874">Unlock</span><span class="op" id="4842880">(</span><span class="op" id="4842881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4842885">if</span>&nbsp;<span class="ident" id="4842888">call</span>&nbsp;<span class="op" id="4842893">!=</span>&nbsp;<span class="ident" id="4842896">nil</span>&nbsp;<span class="op" id="4842900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842905">call</span><span class="op" id="4842909">.</span><span class="ident" id="4842910">Error</span>&nbsp;<span class="op" id="4842916">=</span>&nbsp;<span class="ident" id="4842918">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4842925">call</span><span class="op" id="4842929">.</span><span class="ident" id="4842930">done</span><span class="op" id="4842934">(</span><span class="op" id="4842935">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4842939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4842942">}</span><br>
<span class="lineno"></span><span class="op" id="4842944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4842947">func</span>&nbsp;<span class="op" id="4842952">(</span><span class="ident" id="4842953">client</span>&nbsp;<span class="op" id="4842960">*</span><span class="ident" id="4842961">Client</span><span class="op" id="4842967">)</span>&nbsp;<span class="ident" id="4842969">input</span><span class="op" id="4842974">(</span><span class="op" id="4842975">)</span>&nbsp;<span class="op" id="4842977">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4842980">var</span>&nbsp;<span class="ident" id="4842984">err</span>&nbsp;<span class="builtintype" id="4842988">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4842995">var</span>&nbsp;<span class="ident" id="4842999">response</span>&nbsp;<span class="ident" id="4843008">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4843018">for</span>&nbsp;<span class="ident" id="4843022">err</span>&nbsp;<span class="op" id="4843026">==</span>&nbsp;<span class="ident" id="4843029">nil</span>&nbsp;<span class="op" id="4843033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4843037">response</span>&nbsp;<span class="op" id="4843046">=</span>&nbsp;<span class="ident" id="4843048">Response</span><span class="op" id="4843056">{</span><span class="op" id="4843057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4843061">err</span>&nbsp;<span class="op" id="4843065">=</span>&nbsp;<span class="ident" id="4843067">client</span><span class="op" id="4843073">.</span><span class="ident" id="4843074">codec</span><span class="op" id="4843079">.</span><span class="ident" id="4843080">ReadResponseHeader</span><span class="op" id="4843098">(</span><span class="op" id="4843099">&amp;</span><span class="ident" id="4843100">response</span><span class="op" id="4843108">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4843112">if</span>&nbsp;<span class="ident" id="4843115">err</span>&nbsp;<span class="op" id="4843119">!=</span>&nbsp;<span class="ident" id="4843122">nil</span>&nbsp;<span class="op" id="4843126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4843131">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4843139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4843143">seq</span>&nbsp;<span class="op" id="4843147">:=</span>&nbsp;<span class="ident" id="4843150">response</span><span class="op" id="4843158">.</span><span class="ident" id="4843159">Seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4843165">client</span><span class="op" id="4843171">.</span><span class="ident" id="4843172">mutex</span><span class="op" id="4843177">.</span><span class="ident" id="4843178">Lock</span><span class="op" id="4843182">(</span><span class="op" id="4843183">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4843187">call</span>&nbsp;<span class="op" id="4843192">:=</span>&nbsp;<span class="ident" id="4843195">client</span><span class="op" id="4843201">.</span><span class="ident" id="4843202">pending</span><span class="op" id="4843209">[</span><span class="ident" id="4843210">seq</span><span class="op" id="4843213">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4843217">delete</span><span class="op" id="4843223">(</span><span class="ident" id="4843224">client</span><span class="op" id="4843230">.</span><span class="ident" id="4843231">pending</span><span class="op" id="4843238">,</span>&nbsp;<span class="ident" id="4843240">seq</span><span class="op" id="4843243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4843247">client</span><span class="op" id="4843253">.</span><span class="ident" id="4843254">mutex</span><span class="op" id="4843259">.</span><span class="ident" id="4843260">Unlock</span><span class="op" id="4843266">(</span><span class="op" id="4843267">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4843272">switch</span>&nbsp;<span class="op" id="4843279">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4843283">case</span>&nbsp;<span class="ident" id="4843288">call</span>&nbsp;<span class="op" id="4843293">==</span>&nbsp;<span class="ident" id="4843296">nil</span><span class="op" id="4843299">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4843304">//&nbsp;We&#39;ve&nbsp;got&nbsp;no&nbsp;pending&nbsp;call.&nbsp;That&nbsp;usually&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4843361">//&nbsp;WriteRequest&nbsp;partially&nbsp;failed,&nbsp;and&nbsp;call&nbsp;was&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4843419">//&nbsp;removed;&nbsp;response&nbsp;is&nbsp;a&nbsp;server&nbsp;telling&nbsp;us&nbsp;about&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4843475">//&nbsp;error&nbsp;reading&nbsp;request&nbsp;body.&nbsp;We&nbsp;should&nbsp;still&nbsp;attempt</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4843533">//&nbsp;to&nbsp;read&nbsp;error&nbsp;body,&nbsp;but&nbsp;there&#39;s&nbsp;no&nbsp;one&nbsp;to&nbsp;give&nbsp;it&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4843593">err</span>&nbsp;<span class="op" id="4843597">=</span>&nbsp;<span class="ident" id="4843599">client</span><span class="op" id="4843605">.</span><span class="ident" id="4843606">codec</span><span class="op" id="4843611">.</span><span class="ident" id="4843612">ReadResponseBody</span><span class="op" id="4843628">(</span><span class="ident" id="4843629">nil</span><span class="op" id="4843632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4843637">if</span>&nbsp;<span class="ident" id="4843640">err</span>&nbsp;<span class="op" id="4843644">!=</span>&nbsp;<span class="ident" id="4843647">nil</span>&nbsp;<span class="op" id="4843651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4843657">err</span>&nbsp;<span class="op" id="4843661">=</span>&nbsp;<span class="ident" id="4843663">errors</span><span class="op" id="4843669">.</span><span class="ident" id="4843670">New</span><span class="op" id="4843673">(</span><span class="string" id="4843674">&#34;reading&nbsp;error&nbsp;body:&nbsp;&#34;</span>&nbsp;<span class="op" id="4843697">+</span>&nbsp;<span class="ident" id="4843699">err</span><span class="op" id="4843702">.</span><span class="ident" id="4843703">Error</span><span class="op" id="4843708">(</span><span class="op" id="4843709">)</span><span class="op" id="4843710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4843715">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4843719">case</span>&nbsp;<span class="ident" id="4843724">response</span><span class="op" id="4843732">.</span><span class="ident" id="4843733">Error</span>&nbsp;<span class="op" id="4843739">!=</span>&nbsp;<span class="string" id="4843742">&#34;&#34;</span><span class="op" id="4843744">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4843749">//&nbsp;We&#39;ve&nbsp;got&nbsp;an&nbsp;error&nbsp;response.&nbsp;Give&nbsp;this&nbsp;to&nbsp;the&nbsp;request;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4843810">//&nbsp;any&nbsp;subsequent&nbsp;requests&nbsp;will&nbsp;get&nbsp;the&nbsp;ReadResponseBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4843870">//&nbsp;error&nbsp;if&nbsp;there&nbsp;is&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4843899">call</span><span class="op" id="4843903">.</span><span class="ident" id="4843904">Error</span>&nbsp;<span class="op" id="4843910">=</span>&nbsp;<span class="ident" id="4843912">ServerError</span><span class="op" id="4843923">(</span><span class="ident" id="4843924">response</span><span class="op" id="4843932">.</span><span class="ident" id="4843933">Error</span><span class="op" id="4843938">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4843943">err</span>&nbsp;<span class="op" id="4843947">=</span>&nbsp;<span class="ident" id="4843949">client</span><span class="op" id="4843955">.</span><span class="ident" id="4843956">codec</span><span class="op" id="4843961">.</span><span class="ident" id="4843962">ReadResponseBody</span><span class="op" id="4843978">(</span><span class="ident" id="4843979">nil</span><span class="op" id="4843982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4843987">if</span>&nbsp;<span class="ident" id="4843990">err</span>&nbsp;<span class="op" id="4843994">!=</span>&nbsp;<span class="ident" id="4843997">nil</span>&nbsp;<span class="op" id="4844001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844007">err</span>&nbsp;<span class="op" id="4844011">=</span>&nbsp;<span class="ident" id="4844013">errors</span><span class="op" id="4844019">.</span><span class="ident" id="4844020">New</span><span class="op" id="4844023">(</span><span class="string" id="4844024">&#34;reading&nbsp;error&nbsp;body:&nbsp;&#34;</span>&nbsp;<span class="op" id="4844047">+</span>&nbsp;<span class="ident" id="4844049">err</span><span class="op" id="4844052">.</span><span class="ident" id="4844053">Error</span><span class="op" id="4844058">(</span><span class="op" id="4844059">)</span><span class="op" id="4844060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4844065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844070">call</span><span class="op" id="4844074">.</span><span class="ident" id="4844075">done</span><span class="op" id="4844079">(</span><span class="op" id="4844080">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4844084">default</span><span class="op" id="4844091">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844096">err</span>&nbsp;<span class="op" id="4844100">=</span>&nbsp;<span class="ident" id="4844102">client</span><span class="op" id="4844108">.</span><span class="ident" id="4844109">codec</span><span class="op" id="4844114">.</span><span class="ident" id="4844115">ReadResponseBody</span><span class="op" id="4844131">(</span><span class="ident" id="4844132">call</span><span class="op" id="4844136">.</span><span class="ident" id="4844137">Reply</span><span class="op" id="4844142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4844147">if</span>&nbsp;<span class="ident" id="4844150">err</span>&nbsp;<span class="op" id="4844154">!=</span>&nbsp;<span class="ident" id="4844157">nil</span>&nbsp;<span class="op" id="4844161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844167">call</span><span class="op" id="4844171">.</span><span class="ident" id="4844172">Error</span>&nbsp;<span class="op" id="4844178">=</span>&nbsp;<span class="ident" id="4844180">errors</span><span class="op" id="4844186">.</span><span class="ident" id="4844187">New</span><span class="op" id="4844190">(</span><span class="string" id="4844191">&#34;reading&nbsp;body&nbsp;&#34;</span>&nbsp;<span class="op" id="4844207">+</span>&nbsp;<span class="ident" id="4844209">err</span><span class="op" id="4844212">.</span><span class="ident" id="4844213">Error</span><span class="op" id="4844218">(</span><span class="op" id="4844219">)</span><span class="op" id="4844220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4844225">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844230">call</span><span class="op" id="4844234">.</span><span class="ident" id="4844235">done</span><span class="op" id="4844239">(</span><span class="op" id="4844240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4844244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4844247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4844250">//&nbsp;Terminate&nbsp;pending&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844279">client</span><span class="op" id="4844285">.</span><span class="ident" id="4844286">reqMutex</span><span class="op" id="4844294">.</span><span class="ident" id="4844295">Lock</span><span class="op" id="4844299">(</span><span class="op" id="4844300">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844303">client</span><span class="op" id="4844309">.</span><span class="ident" id="4844310">mutex</span><span class="op" id="4844315">.</span><span class="ident" id="4844316">Lock</span><span class="op" id="4844320">(</span><span class="op" id="4844321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844324">client</span><span class="op" id="4844330">.</span><span class="ident" id="4844331">shutdown</span>&nbsp;<span class="op" id="4844340">=</span>&nbsp;<span class="builtintype" id="4844342">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844348">closing</span>&nbsp;<span class="op" id="4844356">:=</span>&nbsp;<span class="ident" id="4844359">client</span><span class="op" id="4844365">.</span><span class="ident" id="4844366">closing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4844375">if</span>&nbsp;<span class="ident" id="4844378">err</span>&nbsp;<span class="op" id="4844382">==</span>&nbsp;<span class="ident" id="4844385">io</span><span class="op" id="4844387">.</span><span class="ident" id="4844388">EOF</span>&nbsp;<span class="op" id="4844392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4844396">if</span>&nbsp;<span class="ident" id="4844399">closing</span>&nbsp;<span class="op" id="4844407">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844412">err</span>&nbsp;<span class="op" id="4844416">=</span>&nbsp;<span class="ident" id="4844418">ErrShutdown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4844432">}</span>&nbsp;<span class="keyword" id="4844434">else</span>&nbsp;<span class="op" id="4844439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844444">err</span>&nbsp;<span class="op" id="4844448">=</span>&nbsp;<span class="ident" id="4844450">io</span><span class="op" id="4844452">.</span><span class="ident" id="4844453">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4844472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4844475">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4844478">for</span>&nbsp;<span class="ident" id="4844482">_</span><span class="op" id="4844483">,</span>&nbsp;<span class="ident" id="4844485">call</span>&nbsp;<span class="op" id="4844490">:=</span>&nbsp;<span class="keyword" id="4844493">range</span>&nbsp;<span class="ident" id="4844499">client</span><span class="op" id="4844505">.</span><span class="ident" id="4844506">pending</span>&nbsp;<span class="op" id="4844514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844518">call</span><span class="op" id="4844522">.</span><span class="ident" id="4844523">Error</span>&nbsp;<span class="op" id="4844529">=</span>&nbsp;<span class="ident" id="4844531">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844537">call</span><span class="op" id="4844541">.</span><span class="ident" id="4844542">done</span><span class="op" id="4844546">(</span><span class="op" id="4844547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4844550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844553">client</span><span class="op" id="4844559">.</span><span class="ident" id="4844560">mutex</span><span class="op" id="4844565">.</span><span class="ident" id="4844566">Unlock</span><span class="op" id="4844572">(</span><span class="op" id="4844573">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844576">client</span><span class="op" id="4844582">.</span><span class="ident" id="4844583">reqMutex</span><span class="op" id="4844591">.</span><span class="ident" id="4844592">Unlock</span><span class="op" id="4844598">(</span><span class="op" id="4844599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4844602">if</span>&nbsp;<span class="ident" id="4844605">debugLog</span>&nbsp;<span class="op" id="4844614">&amp;&amp;</span>&nbsp;<span class="ident" id="4844617">err</span>&nbsp;<span class="op" id="4844621">!=</span>&nbsp;<span class="ident" id="4844624">io</span><span class="op" id="4844626">.</span><span class="ident" id="4844627">EOF</span>&nbsp;<span class="op" id="4844631">&amp;&amp;</span>&nbsp;<span class="op" id="4844634">!</span><span class="ident" id="4844635">closing</span>&nbsp;<span class="op" id="4844643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844647">log</span><span class="op" id="4844650">.</span><span class="ident" id="4844651">Println</span><span class="op" id="4844658">(</span><span class="string" id="4844659">&#34;rpc:&nbsp;client&nbsp;protocol&nbsp;error:&#34;</span><span class="op" id="4844688">,</span>&nbsp;<span class="ident" id="4844690">err</span><span class="op" id="4844693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4844696">}</span><br>
<span class="lineno"></span><span class="op" id="4844698">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="4844701">func</span>&nbsp;<span class="op" id="4844706">(</span><span class="ident" id="4844707">call</span>&nbsp;<span class="op" id="4844712">*</span><span class="ident" id="4844713">Call</span><span class="op" id="4844717">)</span>&nbsp;<span class="ident" id="4844719">done</span><span class="op" id="4844723">(</span><span class="op" id="4844724">)</span>&nbsp;<span class="op" id="4844726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4844729">select</span>&nbsp;<span class="op" id="4844736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4844739">case</span>&nbsp;<span class="ident" id="4844744">call</span><span class="op" id="4844748">.</span><span class="ident" id="4844749">Done</span>&nbsp;<span class="op" id="4844754">&lt;-</span>&nbsp;<span class="ident" id="4844757">call</span><span class="op" id="4844761">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4844765">//&nbsp;ok</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4844772">default</span><span class="op" id="4844779">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4844783">//&nbsp;We&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;block&nbsp;here.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4844860">//&nbsp;sure&nbsp;the&nbsp;channel&nbsp;has&nbsp;enough&nbsp;buffer&nbsp;space.&nbsp;See&nbsp;comment&nbsp;in&nbsp;Go().</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4844928">if</span>&nbsp;<span class="ident" id="4844931">debugLog</span>&nbsp;<span class="op" id="4844940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4844945">log</span><span class="op" id="4844948">.</span><span class="ident" id="4844949">Println</span><span class="op" id="4844956">(</span><span class="string" id="4844957">&#34;rpc:&nbsp;discarding&nbsp;Call&nbsp;reply&nbsp;due&nbsp;to&nbsp;insufficient&nbsp;Done&nbsp;chan&nbsp;capacity&#34;</span><span class="op" id="4845024">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4845028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4845031">}</span><br>
<span class="lineno"></span><span class="op" id="4845033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4845036">//&nbsp;NewClient&nbsp;returns&nbsp;a&nbsp;new&nbsp;Client&nbsp;to&nbsp;handle&nbsp;requests&nbsp;to&nbsp;the</span><br>
<span class="lineno">185</span><span class="comment" id="4845096">//&nbsp;set&nbsp;of&nbsp;services&nbsp;at&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4845151">//&nbsp;It&nbsp;adds&nbsp;a&nbsp;buffer&nbsp;to&nbsp;the&nbsp;write&nbsp;side&nbsp;of&nbsp;the&nbsp;connection&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="4845210">//&nbsp;the&nbsp;header&nbsp;and&nbsp;payload&nbsp;are&nbsp;sent&nbsp;as&nbsp;a&nbsp;unit.</span><br>
<span class="lineno"></span><span class="keyword" id="4845256">func</span>&nbsp;<span class="ident" id="4845261">NewClient</span><span class="op" id="4845270">(</span><span class="ident" id="4845271">conn</span>&nbsp;<span class="ident" id="4845276">io</span><span class="op" id="4845278">.</span><span class="ident" id="4845279">ReadWriteCloser</span><span class="op" id="4845294">)</span>&nbsp;<span class="op" id="4845296">*</span><span class="ident" id="4845297">Client</span>&nbsp;<span class="op" id="4845304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4845307">encBuf</span>&nbsp;<span class="op" id="4845314">:=</span>&nbsp;<span class="ident" id="4845317">bufio</span><span class="op" id="4845322">.</span><span class="ident" id="4845323">NewWriter</span><span class="op" id="4845332">(</span><span class="ident" id="4845333">conn</span><span class="op" id="4845337">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4845340">client</span>&nbsp;<span class="op" id="4845347">:=</span>&nbsp;<span class="op" id="4845350">&amp;</span><span class="ident" id="4845351">gobClientCodec</span><span class="op" id="4845365">{</span><span class="ident" id="4845366">conn</span><span class="op" id="4845370">,</span>&nbsp;<span class="ident" id="4845372">gob</span><span class="op" id="4845375">.</span><span class="ident" id="4845376">NewDecoder</span><span class="op" id="4845386">(</span><span class="ident" id="4845387">conn</span><span class="op" id="4845391">)</span><span class="op" id="4845392">,</span>&nbsp;<span class="ident" id="4845394">gob</span><span class="op" id="4845397">.</span><span class="ident" id="4845398">NewEncoder</span><span class="op" id="4845408">(</span><span class="ident" id="4845409">encBuf</span><span class="op" id="4845415">)</span><span class="op" id="4845416">,</span>&nbsp;<span class="ident" id="4845418">encBuf</span><span class="op" id="4845424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4845427">return</span>&nbsp;<span class="ident" id="4845434">NewClientWithCodec</span><span class="op" id="4845452">(</span><span class="ident" id="4845453">client</span><span class="op" id="4845459">)</span><br>
<span class="lineno"></span><span class="op" id="4845461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4845464">//&nbsp;NewClientWithCodec&nbsp;is&nbsp;like&nbsp;NewClient&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified</span><br>
<span class="lineno">195</span><span class="comment" id="4845527">//&nbsp;codec&nbsp;to&nbsp;encode&nbsp;requests&nbsp;and&nbsp;decode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="4845577">func</span>&nbsp;<span class="ident" id="4845582">NewClientWithCodec</span><span class="op" id="4845600">(</span><span class="ident" id="4845601">codec</span>&nbsp;<span class="ident" id="4845607">ClientCodec</span><span class="op" id="4845618">)</span>&nbsp;<span class="op" id="4845620">*</span><span class="ident" id="4845621">Client</span>&nbsp;<span class="op" id="4845628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4845631">client</span>&nbsp;<span class="op" id="4845638">:=</span>&nbsp;<span class="op" id="4845641">&amp;</span><span class="ident" id="4845642">Client</span><span class="op" id="4845648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4845652">codec</span><span class="op" id="4845657">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4845661">codec</span><span class="op" id="4845666">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4845670">pending</span><span class="op" id="4845677">:</span>&nbsp;<span class="builtinfunc" id="4845679">make</span><span class="op" id="4845683">(</span><span class="keyword" id="4845684">map</span><span class="op" id="4845687">[</span><span class="ident" id="4845688">uint64</span><span class="op" id="4845694">]</span><span class="op" id="4845695">*</span><span class="ident" id="4845696">Call</span><span class="op" id="4845700">)</span><span class="op" id="4845701">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4845704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4845707">go</span>&nbsp;<span class="ident" id="4845710">client</span><span class="op" id="4845716">.</span><span class="ident" id="4845717">input</span><span class="op" id="4845722">(</span><span class="op" id="4845723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4845726">return</span>&nbsp;<span class="ident" id="4845733">client</span><br>
<span class="lineno"></span><span class="op" id="4845740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="keyword" id="4845743">type</span>&nbsp;<span class="ident" id="4845748">gobClientCodec</span>&nbsp;<span class="keyword" id="4845763">struct</span>&nbsp;<span class="op" id="4845770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4845773">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4845780">io</span><span class="op" id="4845782">.</span><span class="ident" id="4845783">ReadWriteCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4845800">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4845807">*</span><span class="ident" id="4845808">gob</span><span class="op" id="4845811">.</span><span class="ident" id="4845812">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4845821">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4845828">*</span><span class="ident" id="4845829">gob</span><span class="op" id="4845832">.</span><span class="ident" id="4845833">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4845842">encBuf</span>&nbsp;<span class="op" id="4845849">*</span><span class="ident" id="4845850">bufio</span><span class="op" id="4845855">.</span><span class="ident" id="4845856">Writer</span><br>
<span class="lineno">210</span><span class="op" id="4845863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4845866">func</span>&nbsp;<span class="op" id="4845871">(</span><span class="ident" id="4845872">c</span>&nbsp;<span class="op" id="4845874">*</span><span class="ident" id="4845875">gobClientCodec</span><span class="op" id="4845889">)</span>&nbsp;<span class="ident" id="4845891">WriteRequest</span><span class="op" id="4845903">(</span><span class="ident" id="4845904">r</span>&nbsp;<span class="op" id="4845906">*</span><span class="ident" id="4845907">Request</span><span class="op" id="4845914">,</span>&nbsp;<span class="ident" id="4845916">body</span>&nbsp;<span class="keyword" id="4845921">interface</span><span class="op" id="4845930">{</span><span class="op" id="4845931">}</span><span class="op" id="4845932">)</span>&nbsp;<span class="op" id="4845934">(</span><span class="ident" id="4845935">err</span>&nbsp;<span class="builtintype" id="4845939">error</span><span class="op" id="4845944">)</span>&nbsp;<span class="op" id="4845946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4845949">if</span>&nbsp;<span class="ident" id="4845952">err</span>&nbsp;<span class="op" id="4845956">=</span>&nbsp;<span class="ident" id="4845958">c</span><span class="op" id="4845959">.</span><span class="ident" id="4845960">enc</span><span class="op" id="4845963">.</span><span class="ident" id="4845964">Encode</span><span class="op" id="4845970">(</span><span class="ident" id="4845971">r</span><span class="op" id="4845972">)</span><span class="op" id="4845973">;</span>&nbsp;<span class="ident" id="4845975">err</span>&nbsp;<span class="op" id="4845979">!=</span>&nbsp;<span class="ident" id="4845982">nil</span>&nbsp;<span class="op" id="4845986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4845990">return</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4845998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4846001">if</span>&nbsp;<span class="ident" id="4846004">err</span>&nbsp;<span class="op" id="4846008">=</span>&nbsp;<span class="ident" id="4846010">c</span><span class="op" id="4846011">.</span><span class="ident" id="4846012">enc</span><span class="op" id="4846015">.</span><span class="ident" id="4846016">Encode</span><span class="op" id="4846022">(</span><span class="ident" id="4846023">body</span><span class="op" id="4846027">)</span><span class="op" id="4846028">;</span>&nbsp;<span class="ident" id="4846030">err</span>&nbsp;<span class="op" id="4846034">!=</span>&nbsp;<span class="ident" id="4846037">nil</span>&nbsp;<span class="op" id="4846041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4846045">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4846053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4846056">return</span>&nbsp;<span class="ident" id="4846063">c</span><span class="op" id="4846064">.</span><span class="ident" id="4846065">encBuf</span><span class="op" id="4846071">.</span><span class="ident" id="4846072">Flush</span><span class="op" id="4846077">(</span><span class="op" id="4846078">)</span><br>
<span class="lineno">220</span><span class="op" id="4846080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4846083">func</span>&nbsp;<span class="op" id="4846088">(</span><span class="ident" id="4846089">c</span>&nbsp;<span class="op" id="4846091">*</span><span class="ident" id="4846092">gobClientCodec</span><span class="op" id="4846106">)</span>&nbsp;<span class="ident" id="4846108">ReadResponseHeader</span><span class="op" id="4846126">(</span><span class="ident" id="4846127">r</span>&nbsp;<span class="op" id="4846129">*</span><span class="ident" id="4846130">Response</span><span class="op" id="4846138">)</span>&nbsp;<span class="builtintype" id="4846140">error</span>&nbsp;<span class="op" id="4846146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4846149">return</span>&nbsp;<span class="ident" id="4846156">c</span><span class="op" id="4846157">.</span><span class="ident" id="4846158">dec</span><span class="op" id="4846161">.</span><span class="ident" id="4846162">Decode</span><span class="op" id="4846168">(</span><span class="ident" id="4846169">r</span><span class="op" id="4846170">)</span><br>
<span class="lineno"></span><span class="op" id="4846172">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="4846175">func</span>&nbsp;<span class="op" id="4846180">(</span><span class="ident" id="4846181">c</span>&nbsp;<span class="op" id="4846183">*</span><span class="ident" id="4846184">gobClientCodec</span><span class="op" id="4846198">)</span>&nbsp;<span class="ident" id="4846200">ReadResponseBody</span><span class="op" id="4846216">(</span><span class="ident" id="4846217">body</span>&nbsp;<span class="keyword" id="4846222">interface</span><span class="op" id="4846231">{</span><span class="op" id="4846232">}</span><span class="op" id="4846233">)</span>&nbsp;<span class="builtintype" id="4846235">error</span>&nbsp;<span class="op" id="4846241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4846244">return</span>&nbsp;<span class="ident" id="4846251">c</span><span class="op" id="4846252">.</span><span class="ident" id="4846253">dec</span><span class="op" id="4846256">.</span><span class="ident" id="4846257">Decode</span><span class="op" id="4846263">(</span><span class="ident" id="4846264">body</span><span class="op" id="4846268">)</span><br>
<span class="lineno"></span><span class="op" id="4846270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="4846273">func</span>&nbsp;<span class="op" id="4846278">(</span><span class="ident" id="4846279">c</span>&nbsp;<span class="op" id="4846281">*</span><span class="ident" id="4846282">gobClientCodec</span><span class="op" id="4846296">)</span>&nbsp;<span class="ident" id="4846298">Close</span><span class="op" id="4846303">(</span><span class="op" id="4846304">)</span>&nbsp;<span class="builtintype" id="4846306">error</span>&nbsp;<span class="op" id="4846312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4846315">return</span>&nbsp;<span class="ident" id="4846322">c</span><span class="op" id="4846323">.</span><span class="ident" id="4846324">rwc</span><span class="op" id="4846327">.</span><span class="ident" id="4846328">Close</span><span class="op" id="4846333">(</span><span class="op" id="4846334">)</span><br>
<span class="lineno"></span><span class="op" id="4846336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4846339">//&nbsp;DialHTTP&nbsp;connects&nbsp;to&nbsp;an&nbsp;HTTP&nbsp;RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address</span><br>
<span class="lineno">235</span><span class="comment" id="4846415">//&nbsp;listening&nbsp;on&nbsp;the&nbsp;default&nbsp;HTTP&nbsp;RPC&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="4846458">func</span>&nbsp;<span class="ident" id="4846463">DialHTTP</span><span class="op" id="4846471">(</span><span class="ident" id="4846472">network</span><span class="op" id="4846479">,</span>&nbsp;<span class="ident" id="4846481">address</span>&nbsp;<span class="builtintype" id="4846489">string</span><span class="op" id="4846495">)</span>&nbsp;<span class="op" id="4846497">(</span><span class="op" id="4846498">*</span><span class="ident" id="4846499">Client</span><span class="op" id="4846505">,</span>&nbsp;<span class="builtintype" id="4846507">error</span><span class="op" id="4846512">)</span>&nbsp;<span class="op" id="4846514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4846517">return</span>&nbsp;<span class="ident" id="4846524">DialHTTPPath</span><span class="op" id="4846536">(</span><span class="ident" id="4846537">network</span><span class="op" id="4846544">,</span>&nbsp;<span class="ident" id="4846546">address</span><span class="op" id="4846553">,</span>&nbsp;<span class="ident" id="4846555">DefaultRPCPath</span><span class="op" id="4846569">)</span><br>
<span class="lineno"></span><span class="op" id="4846571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="comment" id="4846574">//&nbsp;DialHTTPPath&nbsp;connects&nbsp;to&nbsp;an&nbsp;HTTP&nbsp;RPC&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="4846621">//&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address&nbsp;and&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="4846667">func</span>&nbsp;<span class="ident" id="4846672">DialHTTPPath</span><span class="op" id="4846684">(</span><span class="ident" id="4846685">network</span><span class="op" id="4846692">,</span>&nbsp;<span class="ident" id="4846694">address</span><span class="op" id="4846701">,</span>&nbsp;<span class="ident" id="4846703">path</span>&nbsp;<span class="builtintype" id="4846708">string</span><span class="op" id="4846714">)</span>&nbsp;<span class="op" id="4846716">(</span><span class="op" id="4846717">*</span><span class="ident" id="4846718">Client</span><span class="op" id="4846724">,</span>&nbsp;<span class="builtintype" id="4846726">error</span><span class="op" id="4846731">)</span>&nbsp;<span class="op" id="4846733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4846736">var</span>&nbsp;<span class="ident" id="4846740">err</span>&nbsp;<span class="builtintype" id="4846744">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4846751">conn</span><span class="op" id="4846755">,</span>&nbsp;<span class="ident" id="4846757">err</span>&nbsp;<span class="op" id="4846761">:=</span>&nbsp;<span class="ident" id="4846764">net</span><span class="op" id="4846767">.</span><span class="ident" id="4846768">Dial</span><span class="op" id="4846772">(</span><span class="ident" id="4846773">network</span><span class="op" id="4846780">,</span>&nbsp;<span class="ident" id="4846782">address</span><span class="op" id="4846789">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4846792">if</span>&nbsp;<span class="ident" id="4846795">err</span>&nbsp;<span class="op" id="4846799">!=</span>&nbsp;<span class="ident" id="4846802">nil</span>&nbsp;<span class="op" id="4846806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4846810">return</span>&nbsp;<span class="ident" id="4846817">nil</span><span class="op" id="4846820">,</span>&nbsp;<span class="ident" id="4846822">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4846827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4846830">io</span><span class="op" id="4846832">.</span><span class="ident" id="4846833">WriteString</span><span class="op" id="4846844">(</span><span class="ident" id="4846845">conn</span><span class="op" id="4846849">,</span>&nbsp;<span class="string" id="4846851">&#34;CONNECT&nbsp;&#34;</span><span class="op" id="4846861">+</span><span class="ident" id="4846862">path</span><span class="op" id="4846866">+</span><span class="string" id="4846867">&#34;&nbsp;HTTP/1.0\n\n&#34;</span><span class="op" id="4846882">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4846886">//&nbsp;Require&nbsp;successful&nbsp;HTTP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4846923">//&nbsp;before&nbsp;switching&nbsp;to&nbsp;RPC&nbsp;protocol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4846961">resp</span><span class="op" id="4846965">,</span>&nbsp;<span class="ident" id="4846967">err</span>&nbsp;<span class="op" id="4846971">:=</span>&nbsp;<span class="ident" id="4846974">http</span><span class="op" id="4846978">.</span><span class="ident" id="4846979">ReadResponse</span><span class="op" id="4846991">(</span><span class="ident" id="4846992">bufio</span><span class="op" id="4846997">.</span><span class="ident" id="4846998">NewReader</span><span class="op" id="4847007">(</span><span class="ident" id="4847008">conn</span><span class="op" id="4847012">)</span><span class="op" id="4847013">,</span>&nbsp;<span class="op" id="4847015">&amp;</span><span class="ident" id="4847016">http</span><span class="op" id="4847020">.</span><span class="ident" id="4847021">Request</span><span class="op" id="4847028">{</span><span class="ident" id="4847029">Method</span><span class="op" id="4847035">:</span>&nbsp;<span class="string" id="4847037">&#34;CONNECT&#34;</span><span class="op" id="4847046">}</span><span class="op" id="4847047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4847050">if</span>&nbsp;<span class="ident" id="4847053">err</span>&nbsp;<span class="op" id="4847057">==</span>&nbsp;<span class="ident" id="4847060">nil</span>&nbsp;<span class="op" id="4847064">&amp;&amp;</span>&nbsp;<span class="ident" id="4847067">resp</span><span class="op" id="4847071">.</span><span class="ident" id="4847072">Status</span>&nbsp;<span class="op" id="4847079">==</span>&nbsp;<span class="ident" id="4847082">connected</span>&nbsp;<span class="op" id="4847092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4847096">return</span>&nbsp;<span class="ident" id="4847103">NewClient</span><span class="op" id="4847112">(</span><span class="ident" id="4847113">conn</span><span class="op" id="4847117">)</span><span class="op" id="4847118">,</span>&nbsp;<span class="ident" id="4847120">nil</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4847125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4847128">if</span>&nbsp;<span class="ident" id="4847131">err</span>&nbsp;<span class="op" id="4847135">==</span>&nbsp;<span class="ident" id="4847138">nil</span>&nbsp;<span class="op" id="4847142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4847146">err</span>&nbsp;<span class="op" id="4847150">=</span>&nbsp;<span class="ident" id="4847152">errors</span><span class="op" id="4847158">.</span><span class="ident" id="4847159">New</span><span class="op" id="4847162">(</span><span class="string" id="4847163">&#34;unexpected&nbsp;HTTP&nbsp;response:&nbsp;&#34;</span>&nbsp;<span class="op" id="4847192">+</span>&nbsp;<span class="ident" id="4847194">resp</span><span class="op" id="4847198">.</span><span class="ident" id="4847199">Status</span><span class="op" id="4847205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4847208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4847211">conn</span><span class="op" id="4847215">.</span><span class="ident" id="4847216">Close</span><span class="op" id="4847221">(</span><span class="op" id="4847222">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4847225">return</span>&nbsp;<span class="ident" id="4847232">nil</span><span class="op" id="4847235">,</span>&nbsp;<span class="op" id="4847237">&amp;</span><span class="ident" id="4847238">net</span><span class="op" id="4847241">.</span><span class="ident" id="4847242">OpError</span><span class="op" id="4847249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4847253">Op</span><span class="op" id="4847255">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="4847259">&#34;dial-http&#34;</span><span class="op" id="4847270">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4847274">Net</span><span class="op" id="4847277">:</span>&nbsp;&nbsp;<span class="ident" id="4847280">network</span>&nbsp;<span class="op" id="4847288">+</span>&nbsp;<span class="string" id="4847290">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="4847294">+</span>&nbsp;<span class="ident" id="4847296">address</span><span class="op" id="4847303">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4847307">Addr</span><span class="op" id="4847311">:</span>&nbsp;<span class="ident" id="4847313">nil</span><span class="op" id="4847316">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4847320">Err</span><span class="op" id="4847323">:</span>&nbsp;&nbsp;<span class="ident" id="4847326">err</span><span class="op" id="4847329">,</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4847332">}</span><br>
<span class="lineno"></span><span class="op" id="4847334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4847337">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;an&nbsp;RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4847405">func</span>&nbsp;<span class="ident" id="4847410">Dial</span><span class="op" id="4847414">(</span><span class="ident" id="4847415">network</span><span class="op" id="4847422">,</span>&nbsp;<span class="ident" id="4847424">address</span>&nbsp;<span class="builtintype" id="4847432">string</span><span class="op" id="4847438">)</span>&nbsp;<span class="op" id="4847440">(</span><span class="op" id="4847441">*</span><span class="ident" id="4847442">Client</span><span class="op" id="4847448">,</span>&nbsp;<span class="builtintype" id="4847450">error</span><span class="op" id="4847455">)</span>&nbsp;<span class="op" id="4847457">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4847460">conn</span><span class="op" id="4847464">,</span>&nbsp;<span class="ident" id="4847466">err</span>&nbsp;<span class="op" id="4847470">:=</span>&nbsp;<span class="ident" id="4847473">net</span><span class="op" id="4847476">.</span><span class="ident" id="4847477">Dial</span><span class="op" id="4847481">(</span><span class="ident" id="4847482">network</span><span class="op" id="4847489">,</span>&nbsp;<span class="ident" id="4847491">address</span><span class="op" id="4847498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4847501">if</span>&nbsp;<span class="ident" id="4847504">err</span>&nbsp;<span class="op" id="4847508">!=</span>&nbsp;<span class="ident" id="4847511">nil</span>&nbsp;<span class="op" id="4847515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4847519">return</span>&nbsp;<span class="ident" id="4847526">nil</span><span class="op" id="4847529">,</span>&nbsp;<span class="ident" id="4847531">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4847536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4847539">return</span>&nbsp;<span class="ident" id="4847546">NewClient</span><span class="op" id="4847555">(</span><span class="ident" id="4847556">conn</span><span class="op" id="4847560">)</span><span class="op" id="4847561">,</span>&nbsp;<span class="ident" id="4847563">nil</span><br>
<span class="lineno">275</span><span class="op" id="4847567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4847570">func</span>&nbsp;<span class="op" id="4847575">(</span><span class="ident" id="4847576">client</span>&nbsp;<span class="op" id="4847583">*</span><span class="ident" id="4847584">Client</span><span class="op" id="4847590">)</span>&nbsp;<span class="ident" id="4847592">Close</span><span class="op" id="4847597">(</span><span class="op" id="4847598">)</span>&nbsp;<span class="builtintype" id="4847600">error</span>&nbsp;<span class="op" id="4847606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4847609">client</span><span class="op" id="4847615">.</span><span class="ident" id="4847616">mutex</span><span class="op" id="4847621">.</span><span class="ident" id="4847622">Lock</span><span class="op" id="4847626">(</span><span class="op" id="4847627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4847630">if</span>&nbsp;<span class="ident" id="4847633">client</span><span class="op" id="4847639">.</span><span class="ident" id="4847640">closing</span>&nbsp;<span class="op" id="4847648">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4847652">client</span><span class="op" id="4847658">.</span><span class="ident" id="4847659">mutex</span><span class="op" id="4847664">.</span><span class="ident" id="4847665">Unlock</span><span class="op" id="4847671">(</span><span class="op" id="4847672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4847676">return</span>&nbsp;<span class="ident" id="4847683">ErrShutdown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4847696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4847699">client</span><span class="op" id="4847705">.</span><span class="ident" id="4847706">closing</span>&nbsp;<span class="op" id="4847714">=</span>&nbsp;<span class="builtintype" id="4847716">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4847722">client</span><span class="op" id="4847728">.</span><span class="ident" id="4847729">mutex</span><span class="op" id="4847734">.</span><span class="ident" id="4847735">Unlock</span><span class="op" id="4847741">(</span><span class="op" id="4847742">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4847745">return</span>&nbsp;<span class="ident" id="4847752">client</span><span class="op" id="4847758">.</span><span class="ident" id="4847759">codec</span><span class="op" id="4847764">.</span><span class="ident" id="4847765">Close</span><span class="op" id="4847770">(</span><span class="op" id="4847771">)</span><br>
<span class="lineno"></span><span class="op" id="4847773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4847776">//&nbsp;Go&nbsp;invokes&nbsp;the&nbsp;function&nbsp;asynchronously.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;Call&nbsp;structure&nbsp;representing</span><br>
<span class="lineno"></span><span class="comment" id="4847863">//&nbsp;the&nbsp;invocation.&nbsp;&nbsp;The&nbsp;done&nbsp;channel&nbsp;will&nbsp;signal&nbsp;when&nbsp;the&nbsp;call&nbsp;is&nbsp;complete&nbsp;by&nbsp;returning</span><br>
<span class="lineno">290</span><span class="comment" id="4847951">//&nbsp;the&nbsp;same&nbsp;Call&nbsp;object.&nbsp;&nbsp;If&nbsp;done&nbsp;is&nbsp;nil,&nbsp;Go&nbsp;will&nbsp;allocate&nbsp;a&nbsp;new&nbsp;channel.</span><br>
<span class="lineno"></span><span class="comment" id="4848025">//&nbsp;If&nbsp;non-nil,&nbsp;done&nbsp;must&nbsp;be&nbsp;buffered&nbsp;or&nbsp;Go&nbsp;will&nbsp;deliberately&nbsp;crash.</span><br>
<span class="lineno"></span><span class="keyword" id="4848093">func</span>&nbsp;<span class="op" id="4848098">(</span><span class="ident" id="4848099">client</span>&nbsp;<span class="op" id="4848106">*</span><span class="ident" id="4848107">Client</span><span class="op" id="4848113">)</span>&nbsp;<span class="ident" id="4848115">Go</span><span class="op" id="4848117">(</span><span class="ident" id="4848118">serviceMethod</span>&nbsp;<span class="builtintype" id="4848132">string</span><span class="op" id="4848138">,</span>&nbsp;<span class="ident" id="4848140">args</span>&nbsp;<span class="keyword" id="4848145">interface</span><span class="op" id="4848154">{</span><span class="op" id="4848155">}</span><span class="op" id="4848156">,</span>&nbsp;<span class="ident" id="4848158">reply</span>&nbsp;<span class="keyword" id="4848164">interface</span><span class="op" id="4848173">{</span><span class="op" id="4848174">}</span><span class="op" id="4848175">,</span>&nbsp;<span class="ident" id="4848177">done</span>&nbsp;<span class="keyword" id="4848182">chan</span>&nbsp;<span class="op" id="4848187">*</span><span class="ident" id="4848188">Call</span><span class="op" id="4848192">)</span>&nbsp;<span class="op" id="4848194">*</span><span class="ident" id="4848195">Call</span>&nbsp;<span class="op" id="4848200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4848203">call</span>&nbsp;<span class="op" id="4848208">:=</span>&nbsp;<span class="builtinfunc" id="4848211">new</span><span class="op" id="4848214">(</span><span class="ident" id="4848215">Call</span><span class="op" id="4848219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4848222">call</span><span class="op" id="4848226">.</span><span class="ident" id="4848227">ServiceMethod</span>&nbsp;<span class="op" id="4848241">=</span>&nbsp;<span class="ident" id="4848243">serviceMethod</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4848258">call</span><span class="op" id="4848262">.</span><span class="ident" id="4848263">Args</span>&nbsp;<span class="op" id="4848268">=</span>&nbsp;<span class="ident" id="4848270">args</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4848276">call</span><span class="op" id="4848280">.</span><span class="ident" id="4848281">Reply</span>&nbsp;<span class="op" id="4848287">=</span>&nbsp;<span class="ident" id="4848289">reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4848296">if</span>&nbsp;<span class="ident" id="4848299">done</span>&nbsp;<span class="op" id="4848304">==</span>&nbsp;<span class="ident" id="4848307">nil</span>&nbsp;<span class="op" id="4848311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4848315">done</span>&nbsp;<span class="op" id="4848320">=</span>&nbsp;<span class="builtinfunc" id="4848322">make</span><span class="op" id="4848326">(</span><span class="keyword" id="4848327">chan</span>&nbsp;<span class="op" id="4848332">*</span><span class="ident" id="4848333">Call</span><span class="op" id="4848337">,</span>&nbsp;<span class="num" id="4848339">10</span><span class="op" id="4848341">)</span>&nbsp;<span class="comment" id="4848343">//&nbsp;buffered.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4848357">}</span>&nbsp;<span class="keyword" id="4848359">else</span>&nbsp;<span class="op" id="4848364">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4848368">//&nbsp;If&nbsp;caller&nbsp;passes&nbsp;done&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;must&nbsp;arrange&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4848424">//&nbsp;done&nbsp;has&nbsp;enough&nbsp;buffer&nbsp;for&nbsp;the&nbsp;number&nbsp;of&nbsp;simultaneous</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4848483">//&nbsp;RPCs&nbsp;that&nbsp;will&nbsp;be&nbsp;using&nbsp;that&nbsp;channel.&nbsp;&nbsp;If&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4848542">//&nbsp;is&nbsp;totally&nbsp;unbuffered,&nbsp;it&#39;s&nbsp;best&nbsp;not&nbsp;to&nbsp;run&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4848599">if</span>&nbsp;<span class="builtinfunc" id="4848602">cap</span><span class="op" id="4848605">(</span><span class="ident" id="4848606">done</span><span class="op" id="4848610">)</span>&nbsp;<span class="op" id="4848612">==</span>&nbsp;<span class="num" id="4848615">0</span>&nbsp;<span class="op" id="4848617">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4848622">log</span><span class="op" id="4848625">.</span><span class="ident" id="4848626">Panic</span><span class="op" id="4848631">(</span><span class="string" id="4848632">&#34;rpc:&nbsp;done&nbsp;channel&nbsp;is&nbsp;unbuffered&#34;</span><span class="op" id="4848665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4848669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4848672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4848675">call</span><span class="op" id="4848679">.</span><span class="ident" id="4848680">Done</span>&nbsp;<span class="op" id="4848685">=</span>&nbsp;<span class="ident" id="4848687">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4848693">client</span><span class="op" id="4848699">.</span><span class="ident" id="4848700">send</span><span class="op" id="4848704">(</span><span class="ident" id="4848705">call</span><span class="op" id="4848709">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4848712">return</span>&nbsp;<span class="ident" id="4848719">call</span><br>
<span class="lineno"></span><span class="op" id="4848724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4848727">//&nbsp;Call&nbsp;invokes&nbsp;the&nbsp;named&nbsp;function,&nbsp;waits&nbsp;for&nbsp;it&nbsp;to&nbsp;complete,&nbsp;and&nbsp;returns&nbsp;its&nbsp;error&nbsp;status.</span><br>
<span class="lineno"></span><span class="keyword" id="4848819">func</span>&nbsp;<span class="op" id="4848824">(</span><span class="ident" id="4848825">client</span>&nbsp;<span class="op" id="4848832">*</span><span class="ident" id="4848833">Client</span><span class="op" id="4848839">)</span>&nbsp;<span class="ident" id="4848841">Call</span><span class="op" id="4848845">(</span><span class="ident" id="4848846">serviceMethod</span>&nbsp;<span class="builtintype" id="4848860">string</span><span class="op" id="4848866">,</span>&nbsp;<span class="ident" id="4848868">args</span>&nbsp;<span class="keyword" id="4848873">interface</span><span class="op" id="4848882">{</span><span class="op" id="4848883">}</span><span class="op" id="4848884">,</span>&nbsp;<span class="ident" id="4848886">reply</span>&nbsp;<span class="keyword" id="4848892">interface</span><span class="op" id="4848901">{</span><span class="op" id="4848902">}</span><span class="op" id="4848903">)</span>&nbsp;<span class="builtintype" id="4848905">error</span>&nbsp;<span class="op" id="4848911">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4848914">call</span>&nbsp;<span class="op" id="4848919">:=</span>&nbsp;<span class="op" id="4848922">&lt;-</span><span class="ident" id="4848924">client</span><span class="op" id="4848930">.</span><span class="ident" id="4848931">Go</span><span class="op" id="4848933">(</span><span class="ident" id="4848934">serviceMethod</span><span class="op" id="4848947">,</span>&nbsp;<span class="ident" id="4848949">args</span><span class="op" id="4848953">,</span>&nbsp;<span class="ident" id="4848955">reply</span><span class="op" id="4848960">,</span>&nbsp;<span class="builtinfunc" id="4848962">make</span><span class="op" id="4848966">(</span><span class="keyword" id="4848967">chan</span>&nbsp;<span class="op" id="4848972">*</span><span class="ident" id="4848973">Call</span><span class="op" id="4848977">,</span>&nbsp;<span class="num" id="4848979">1</span><span class="op" id="4848980">)</span><span class="op" id="4848981">)</span><span class="op" id="4848982">.</span><span class="ident" id="4848983">Done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4848989">return</span>&nbsp;<span class="ident" id="4848996">call</span><span class="op" id="4849000">.</span><span class="ident" id="4849001">Error</span><br>
<span class="lineno"></span><span class="op" id="4849007">}</span>
</div>
</body>
</html>
