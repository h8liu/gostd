<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>bufio</h2>
<ul>
<li><a href="/gostd/bufio/bufio.go.html">bufio.go</a></li>
<li><a href="/gostd/bufio/bufio_test.go.html">bufio_test.go</a></li>
<li><a href="/gostd/bufio/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/bufio/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/bufio/scan.go.html">scan.go</a></li>
<li><a href="/gostd/bufio/scan_test.go.html">scan_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2917502">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2917557">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2917611">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2917662">//&nbsp;Package&nbsp;bufio&nbsp;implements&nbsp;buffered&nbsp;I/O.&nbsp;&nbsp;It&nbsp;wraps&nbsp;an&nbsp;io.Reader&nbsp;or&nbsp;io.Writer</span><br>
<span class="lineno"></span><span class="comment" id="2917740">//&nbsp;object,&nbsp;creating&nbsp;another&nbsp;object&nbsp;(Reader&nbsp;or&nbsp;Writer)&nbsp;that&nbsp;also&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="2917815">//&nbsp;the&nbsp;interface&nbsp;but&nbsp;provides&nbsp;buffering&nbsp;and&nbsp;some&nbsp;help&nbsp;for&nbsp;textual&nbsp;I/O.</span><br>
<span class="lineno"></span><span class="keyword" id="2917886">package</span>&nbsp;<span class="ident" id="2917894">bufio</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="2917901">import</span>&nbsp;<span class="op" id="2917908">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2917911">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2917920">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2917930">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2917936">&#34;unicode/utf8&#34;</span><br>
<span class="lineno">15</span><span class="op" id="2917951">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2917954">const</span>&nbsp;<span class="op" id="2917960">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917963">defaultBufSize</span>&nbsp;<span class="op" id="2917978">=</span>&nbsp;<span class="num" id="2917980">4096</span><br>
<span class="lineno"></span><span class="op" id="2917985">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2917988">var</span>&nbsp;<span class="op" id="2917992">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2917995">ErrInvalidUnreadByte</span>&nbsp;<span class="op" id="2918016">=</span>&nbsp;<span class="ident" id="2918018">errors</span><span class="op" id="2918024">.</span><span class="ident" id="2918025">New</span><span class="op" id="2918028">(</span><span class="string" id="2918029">&#34;bufio:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;UnreadByte&#34;</span><span class="op" id="2918063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918066">ErrInvalidUnreadRune</span>&nbsp;<span class="op" id="2918087">=</span>&nbsp;<span class="ident" id="2918089">errors</span><span class="op" id="2918095">.</span><span class="ident" id="2918096">New</span><span class="op" id="2918099">(</span><span class="string" id="2918100">&#34;bufio:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;UnreadRune&#34;</span><span class="op" id="2918134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918137">ErrBufferFull</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2918158">=</span>&nbsp;<span class="ident" id="2918160">errors</span><span class="op" id="2918166">.</span><span class="ident" id="2918167">New</span><span class="op" id="2918170">(</span><span class="string" id="2918171">&#34;bufio:&nbsp;buffer&nbsp;full&#34;</span><span class="op" id="2918191">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918194">ErrNegativeCount</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2918215">=</span>&nbsp;<span class="ident" id="2918217">errors</span><span class="op" id="2918223">.</span><span class="ident" id="2918224">New</span><span class="op" id="2918227">(</span><span class="string" id="2918228">&#34;bufio:&nbsp;negative&nbsp;count&#34;</span><span class="op" id="2918251">)</span><br>
<span class="lineno"></span><span class="op" id="2918253">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2918256">//&nbsp;Buffered&nbsp;input.</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="2918276">//&nbsp;Reader&nbsp;implements&nbsp;buffering&nbsp;for&nbsp;an&nbsp;io.Reader&nbsp;object.</span><br>
<span class="lineno"></span><span class="keyword" id="2918332">type</span>&nbsp;<span class="ident" id="2918337">Reader</span>&nbsp;<span class="keyword" id="2918344">struct</span>&nbsp;<span class="op" id="2918351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918354">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2918367">[</span><span class="op" id="2918368">]</span><span class="builtintype" id="2918369">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918375">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2918388">io</span><span class="op" id="2918390">.</span><span class="ident" id="2918391">Reader</span>&nbsp;<span class="comment" id="2918398">//&nbsp;reader&nbsp;provided&nbsp;by&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918432">r</span><span class="op" id="2918433">,</span>&nbsp;<span class="ident" id="2918435">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2918445">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2918455">//&nbsp;buf&nbsp;read&nbsp;and&nbsp;write&nbsp;positions</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918488">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2918501">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918508">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2918521">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918526">lastRuneSize</span>&nbsp;<span class="builtintype" id="2918539">int</span><br>
<span class="lineno"></span><span class="op" id="2918543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="2918546">const</span>&nbsp;<span class="ident" id="2918552">minReadBufferSize</span>&nbsp;<span class="op" id="2918570">=</span>&nbsp;<span class="num" id="2918572">16</span><br>
<span class="lineno"></span><span class="keyword" id="2918575">const</span>&nbsp;<span class="ident" id="2918581">maxConsecutiveEmptyReads</span>&nbsp;<span class="op" id="2918606">=</span>&nbsp;<span class="num" id="2918608">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2918613">//&nbsp;NewReaderSize&nbsp;returns&nbsp;a&nbsp;new&nbsp;Reader&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;at&nbsp;least&nbsp;the&nbsp;specified</span><br>
<span class="lineno"></span><span class="comment" id="2918691">//&nbsp;size.&nbsp;If&nbsp;the&nbsp;argument&nbsp;io.Reader&nbsp;is&nbsp;already&nbsp;a&nbsp;Reader&nbsp;with&nbsp;large&nbsp;enough</span><br>
<span class="lineno">45</span><span class="comment" id="2918764">//&nbsp;size,&nbsp;it&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;Reader.</span><br>
<span class="lineno"></span><span class="keyword" id="2918807">func</span>&nbsp;<span class="ident" id="2918812">NewReaderSize</span><span class="op" id="2918825">(</span><span class="ident" id="2918826">rd</span>&nbsp;<span class="ident" id="2918829">io</span><span class="op" id="2918831">.</span><span class="ident" id="2918832">Reader</span><span class="op" id="2918838">,</span>&nbsp;<span class="ident" id="2918840">size</span>&nbsp;<span class="builtintype" id="2918845">int</span><span class="op" id="2918848">)</span>&nbsp;<span class="op" id="2918850">*</span><span class="ident" id="2918851">Reader</span>&nbsp;<span class="op" id="2918858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2918861">//&nbsp;Is&nbsp;it&nbsp;already&nbsp;a&nbsp;Reader?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918889">b</span><span class="op" id="2918890">,</span>&nbsp;<span class="ident" id="2918892">ok</span>&nbsp;<span class="op" id="2918895">:=</span>&nbsp;<span class="ident" id="2918898">rd</span><span class="op" id="2918900">.</span><span class="op" id="2918901">(</span><span class="op" id="2918902">*</span><span class="ident" id="2918903">Reader</span><span class="op" id="2918909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918912">if</span>&nbsp;<span class="ident" id="2918915">ok</span>&nbsp;<span class="op" id="2918918">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2918921">len</span><span class="op" id="2918924">(</span><span class="ident" id="2918925">b</span><span class="op" id="2918926">.</span><span class="ident" id="2918927">buf</span><span class="op" id="2918930">)</span>&nbsp;<span class="op" id="2918932">&gt;=</span>&nbsp;<span class="ident" id="2918935">size</span>&nbsp;<span class="op" id="2918940">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918944">return</span>&nbsp;<span class="ident" id="2918951">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2918954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2918957">if</span>&nbsp;<span class="ident" id="2918960">size</span>&nbsp;<span class="op" id="2918965">&lt;</span>&nbsp;<span class="ident" id="2918967">minReadBufferSize</span>&nbsp;<span class="op" id="2918985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2918989">size</span>&nbsp;<span class="op" id="2918994">=</span>&nbsp;<span class="ident" id="2918996">minReadBufferSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919015">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919018">r</span>&nbsp;<span class="op" id="2919020">:=</span>&nbsp;<span class="builtinfunc" id="2919023">new</span><span class="op" id="2919026">(</span><span class="ident" id="2919027">Reader</span><span class="op" id="2919033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919036">r</span><span class="op" id="2919037">.</span><span class="ident" id="2919038">reset</span><span class="op" id="2919043">(</span><span class="builtinfunc" id="2919044">make</span><span class="op" id="2919048">(</span><span class="op" id="2919049">[</span><span class="op" id="2919050">]</span><span class="builtintype" id="2919051">byte</span><span class="op" id="2919055">,</span>&nbsp;<span class="ident" id="2919057">size</span><span class="op" id="2919061">)</span><span class="op" id="2919062">,</span>&nbsp;<span class="ident" id="2919064">rd</span><span class="op" id="2919066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919069">return</span>&nbsp;<span class="ident" id="2919076">r</span><br>
<span class="lineno"></span><span class="op" id="2919078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="2919081">//&nbsp;NewReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;Reader&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;the&nbsp;default&nbsp;size.</span><br>
<span class="lineno"></span><span class="keyword" id="2919150">func</span>&nbsp;<span class="ident" id="2919155">NewReader</span><span class="op" id="2919164">(</span><span class="ident" id="2919165">rd</span>&nbsp;<span class="ident" id="2919168">io</span><span class="op" id="2919170">.</span><span class="ident" id="2919171">Reader</span><span class="op" id="2919177">)</span>&nbsp;<span class="op" id="2919179">*</span><span class="ident" id="2919180">Reader</span>&nbsp;<span class="op" id="2919187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919190">return</span>&nbsp;<span class="ident" id="2919197">NewReaderSize</span><span class="op" id="2919210">(</span><span class="ident" id="2919211">rd</span><span class="op" id="2919213">,</span>&nbsp;<span class="ident" id="2919215">defaultBufSize</span><span class="op" id="2919229">)</span><br>
<span class="lineno"></span><span class="op" id="2919231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="2919234">//&nbsp;Reset&nbsp;discards&nbsp;any&nbsp;buffered&nbsp;data,&nbsp;resets&nbsp;all&nbsp;state,&nbsp;and&nbsp;switches</span><br>
<span class="lineno"></span><span class="comment" id="2919302">//&nbsp;the&nbsp;buffered&nbsp;reader&nbsp;to&nbsp;read&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="2919341">func</span>&nbsp;<span class="op" id="2919346">(</span><span class="ident" id="2919347">b</span>&nbsp;<span class="op" id="2919349">*</span><span class="ident" id="2919350">Reader</span><span class="op" id="2919356">)</span>&nbsp;<span class="ident" id="2919358">Reset</span><span class="op" id="2919363">(</span><span class="ident" id="2919364">r</span>&nbsp;<span class="ident" id="2919366">io</span><span class="op" id="2919368">.</span><span class="ident" id="2919369">Reader</span><span class="op" id="2919375">)</span>&nbsp;<span class="op" id="2919377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919380">b</span><span class="op" id="2919381">.</span><span class="ident" id="2919382">reset</span><span class="op" id="2919387">(</span><span class="ident" id="2919388">b</span><span class="op" id="2919389">.</span><span class="ident" id="2919390">buf</span><span class="op" id="2919393">,</span>&nbsp;<span class="ident" id="2919395">r</span><span class="op" id="2919396">)</span><br>
<span class="lineno"></span><span class="op" id="2919398">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="2919401">func</span>&nbsp;<span class="op" id="2919406">(</span><span class="ident" id="2919407">b</span>&nbsp;<span class="op" id="2919409">*</span><span class="ident" id="2919410">Reader</span><span class="op" id="2919416">)</span>&nbsp;<span class="ident" id="2919418">reset</span><span class="op" id="2919423">(</span><span class="ident" id="2919424">buf</span>&nbsp;<span class="op" id="2919428">[</span><span class="op" id="2919429">]</span><span class="builtintype" id="2919430">byte</span><span class="op" id="2919434">,</span>&nbsp;<span class="ident" id="2919436">r</span>&nbsp;<span class="ident" id="2919438">io</span><span class="op" id="2919440">.</span><span class="ident" id="2919441">Reader</span><span class="op" id="2919447">)</span>&nbsp;<span class="op" id="2919449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919452">*</span><span class="ident" id="2919453">b</span>&nbsp;<span class="op" id="2919455">=</span>&nbsp;<span class="ident" id="2919457">Reader</span><span class="op" id="2919463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919467">buf</span><span class="op" id="2919470">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2919481">buf</span><span class="op" id="2919484">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919488">rd</span><span class="op" id="2919490">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2919502">r</span><span class="op" id="2919503">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919507">lastByte</span><span class="op" id="2919515">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2919521">-</span><span class="num" id="2919522">1</span><span class="op" id="2919523">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919527">lastRuneSize</span><span class="op" id="2919539">:</span>&nbsp;<span class="op" id="2919541">-</span><span class="num" id="2919542">1</span><span class="op" id="2919543">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919546">}</span><br>
<span class="lineno"></span><span class="op" id="2919548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="2919551">var</span>&nbsp;<span class="ident" id="2919555">errNegativeRead</span>&nbsp;<span class="op" id="2919571">=</span>&nbsp;<span class="ident" id="2919573">errors</span><span class="op" id="2919579">.</span><span class="ident" id="2919580">New</span><span class="op" id="2919583">(</span><span class="string" id="2919584">&#34;bufio:&nbsp;reader&nbsp;returned&nbsp;negative&nbsp;count&nbsp;from&nbsp;Read&#34;</span><span class="op" id="2919633">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2919636">//&nbsp;fill&nbsp;reads&nbsp;a&nbsp;new&nbsp;chunk&nbsp;into&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="2919679">func</span>&nbsp;<span class="op" id="2919684">(</span><span class="ident" id="2919685">b</span>&nbsp;<span class="op" id="2919687">*</span><span class="ident" id="2919688">Reader</span><span class="op" id="2919694">)</span>&nbsp;<span class="ident" id="2919696">fill</span><span class="op" id="2919700">(</span><span class="op" id="2919701">)</span>&nbsp;<span class="op" id="2919703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2919706">//&nbsp;Slide&nbsp;existing&nbsp;data&nbsp;to&nbsp;beginning.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919744">if</span>&nbsp;<span class="ident" id="2919747">b</span><span class="op" id="2919748">.</span><span class="ident" id="2919749">r</span>&nbsp;<span class="op" id="2919751">&gt;</span>&nbsp;<span class="num" id="2919753">0</span>&nbsp;<span class="op" id="2919755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2919759">copy</span><span class="op" id="2919763">(</span><span class="ident" id="2919764">b</span><span class="op" id="2919765">.</span><span class="ident" id="2919766">buf</span><span class="op" id="2919769">,</span>&nbsp;<span class="ident" id="2919771">b</span><span class="op" id="2919772">.</span><span class="ident" id="2919773">buf</span><span class="op" id="2919776">[</span><span class="ident" id="2919777">b</span><span class="op" id="2919778">.</span><span class="ident" id="2919779">r</span><span class="op" id="2919780">:</span><span class="ident" id="2919781">b</span><span class="op" id="2919782">.</span><span class="ident" id="2919783">w</span><span class="op" id="2919784">]</span><span class="op" id="2919785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919789">b</span><span class="op" id="2919790">.</span><span class="ident" id="2919791">w</span>&nbsp;<span class="op" id="2919793">-=</span>&nbsp;<span class="ident" id="2919796">b</span><span class="op" id="2919797">.</span><span class="ident" id="2919798">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919802">b</span><span class="op" id="2919803">.</span><span class="ident" id="2919804">r</span>&nbsp;<span class="op" id="2919806">=</span>&nbsp;<span class="num" id="2919808">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919811">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919815">if</span>&nbsp;<span class="ident" id="2919818">b</span><span class="op" id="2919819">.</span><span class="ident" id="2919820">w</span>&nbsp;<span class="op" id="2919822">&gt;=</span>&nbsp;<span class="builtinfunc" id="2919825">len</span><span class="op" id="2919828">(</span><span class="ident" id="2919829">b</span><span class="op" id="2919830">.</span><span class="ident" id="2919831">buf</span><span class="op" id="2919834">)</span>&nbsp;<span class="op" id="2919836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2919840">panic</span><span class="op" id="2919845">(</span><span class="string" id="2919846">&#34;bufio:&nbsp;tried&nbsp;to&nbsp;fill&nbsp;full&nbsp;buffer&#34;</span><span class="op" id="2919880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2919883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2919887">//&nbsp;Read&nbsp;new&nbsp;data:&nbsp;try&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2919937">for</span>&nbsp;<span class="ident" id="2919941">i</span>&nbsp;<span class="op" id="2919943">:=</span>&nbsp;<span class="ident" id="2919946">maxConsecutiveEmptyReads</span><span class="op" id="2919970">;</span>&nbsp;<span class="ident" id="2919972">i</span>&nbsp;<span class="op" id="2919974">&gt;</span>&nbsp;<span class="num" id="2919976">0</span><span class="op" id="2919977">;</span>&nbsp;<span class="ident" id="2919979">i</span><span class="op" id="2919980">--</span>&nbsp;<span class="op" id="2919983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2919987">n</span><span class="op" id="2919988">,</span>&nbsp;<span class="ident" id="2919990">err</span>&nbsp;<span class="op" id="2919994">:=</span>&nbsp;<span class="ident" id="2919997">b</span><span class="op" id="2919998">.</span><span class="ident" id="2919999">rd</span><span class="op" id="2920001">.</span><span class="ident" id="2920002">Read</span><span class="op" id="2920006">(</span><span class="ident" id="2920007">b</span><span class="op" id="2920008">.</span><span class="ident" id="2920009">buf</span><span class="op" id="2920012">[</span><span class="ident" id="2920013">b</span><span class="op" id="2920014">.</span><span class="ident" id="2920015">w</span><span class="op" id="2920016">:</span><span class="op" id="2920017">]</span><span class="op" id="2920018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920022">if</span>&nbsp;<span class="ident" id="2920025">n</span>&nbsp;<span class="op" id="2920027">&lt;</span>&nbsp;<span class="num" id="2920029">0</span>&nbsp;<span class="op" id="2920031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2920036">panic</span><span class="op" id="2920041">(</span><span class="ident" id="2920042">errNegativeRead</span><span class="op" id="2920057">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920065">b</span><span class="op" id="2920066">.</span><span class="ident" id="2920067">w</span>&nbsp;<span class="op" id="2920069">+=</span>&nbsp;<span class="ident" id="2920072">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920076">if</span>&nbsp;<span class="ident" id="2920079">err</span>&nbsp;<span class="op" id="2920083">!=</span>&nbsp;<span class="ident" id="2920086">nil</span>&nbsp;<span class="op" id="2920090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920095">b</span><span class="op" id="2920096">.</span><span class="ident" id="2920097">err</span>&nbsp;<span class="op" id="2920101">=</span>&nbsp;<span class="ident" id="2920103">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920110">return</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920123">if</span>&nbsp;<span class="ident" id="2920126">n</span>&nbsp;<span class="op" id="2920128">&gt;</span>&nbsp;<span class="num" id="2920130">0</span>&nbsp;<span class="op" id="2920132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920137">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920149">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920152">b</span><span class="op" id="2920153">.</span><span class="ident" id="2920154">err</span>&nbsp;<span class="op" id="2920158">=</span>&nbsp;<span class="ident" id="2920160">io</span><span class="op" id="2920162">.</span><span class="ident" id="2920163">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="2920177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2920180">func</span>&nbsp;<span class="op" id="2920185">(</span><span class="ident" id="2920186">b</span>&nbsp;<span class="op" id="2920188">*</span><span class="ident" id="2920189">Reader</span><span class="op" id="2920195">)</span>&nbsp;<span class="ident" id="2920197">readErr</span><span class="op" id="2920204">(</span><span class="op" id="2920205">)</span>&nbsp;<span class="builtintype" id="2920207">error</span>&nbsp;<span class="op" id="2920213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920216">err</span>&nbsp;<span class="op" id="2920220">:=</span>&nbsp;<span class="ident" id="2920223">b</span><span class="op" id="2920224">.</span><span class="ident" id="2920225">err</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920230">b</span><span class="op" id="2920231">.</span><span class="ident" id="2920232">err</span>&nbsp;<span class="op" id="2920236">=</span>&nbsp;<span class="ident" id="2920238">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920243">return</span>&nbsp;<span class="ident" id="2920250">err</span><br>
<span class="lineno"></span><span class="op" id="2920254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2920257">//&nbsp;Peek&nbsp;returns&nbsp;the&nbsp;next&nbsp;n&nbsp;bytes&nbsp;without&nbsp;advancing&nbsp;the&nbsp;reader.&nbsp;The&nbsp;bytes&nbsp;stop</span><br>
<span class="lineno">120</span><span class="comment" id="2920335">//&nbsp;being&nbsp;valid&nbsp;at&nbsp;the&nbsp;next&nbsp;read&nbsp;call.&nbsp;If&nbsp;Peek&nbsp;returns&nbsp;fewer&nbsp;than&nbsp;n&nbsp;bytes,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="2920412">//&nbsp;also&nbsp;returns&nbsp;an&nbsp;error&nbsp;explaining&nbsp;why&nbsp;the&nbsp;read&nbsp;is&nbsp;short.&nbsp;The&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2920484">//&nbsp;ErrBufferFull&nbsp;if&nbsp;n&nbsp;is&nbsp;larger&nbsp;than&nbsp;b&#39;s&nbsp;buffer&nbsp;size.</span><br>
<span class="lineno"></span><span class="keyword" id="2920538">func</span>&nbsp;<span class="op" id="2920543">(</span><span class="ident" id="2920544">b</span>&nbsp;<span class="op" id="2920546">*</span><span class="ident" id="2920547">Reader</span><span class="op" id="2920553">)</span>&nbsp;<span class="ident" id="2920555">Peek</span><span class="op" id="2920559">(</span><span class="ident" id="2920560">n</span>&nbsp;<span class="builtintype" id="2920562">int</span><span class="op" id="2920565">)</span>&nbsp;<span class="op" id="2920567">(</span><span class="op" id="2920568">[</span><span class="op" id="2920569">]</span><span class="builtintype" id="2920570">byte</span><span class="op" id="2920574">,</span>&nbsp;<span class="builtintype" id="2920576">error</span><span class="op" id="2920581">)</span>&nbsp;<span class="op" id="2920583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920586">if</span>&nbsp;<span class="ident" id="2920589">n</span>&nbsp;<span class="op" id="2920591">&lt;</span>&nbsp;<span class="num" id="2920593">0</span>&nbsp;<span class="op" id="2920595">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920599">return</span>&nbsp;<span class="ident" id="2920606">nil</span><span class="op" id="2920609">,</span>&nbsp;<span class="ident" id="2920611">ErrNegativeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920632">if</span>&nbsp;<span class="ident" id="2920635">n</span>&nbsp;<span class="op" id="2920637">&gt;</span>&nbsp;<span class="builtinfunc" id="2920639">len</span><span class="op" id="2920642">(</span><span class="ident" id="2920643">b</span><span class="op" id="2920644">.</span><span class="ident" id="2920645">buf</span><span class="op" id="2920648">)</span>&nbsp;<span class="op" id="2920650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920654">return</span>&nbsp;<span class="ident" id="2920661">nil</span><span class="op" id="2920664">,</span>&nbsp;<span class="ident" id="2920666">ErrBufferFull</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920681">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2920684">//&nbsp;0&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;len(b.buf)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920709">for</span>&nbsp;<span class="ident" id="2920713">b</span><span class="op" id="2920714">.</span><span class="ident" id="2920715">w</span><span class="op" id="2920716">-</span><span class="ident" id="2920717">b</span><span class="op" id="2920718">.</span><span class="ident" id="2920719">r</span>&nbsp;<span class="op" id="2920721">&lt;</span>&nbsp;<span class="ident" id="2920723">n</span>&nbsp;<span class="op" id="2920725">&amp;&amp;</span>&nbsp;<span class="ident" id="2920728">b</span><span class="op" id="2920729">.</span><span class="ident" id="2920730">err</span>&nbsp;<span class="op" id="2920734">==</span>&nbsp;<span class="ident" id="2920737">nil</span>&nbsp;<span class="op" id="2920741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920745">b</span><span class="op" id="2920746">.</span><span class="ident" id="2920747">fill</span><span class="op" id="2920751">(</span><span class="op" id="2920752">)</span>&nbsp;<span class="comment" id="2920754">//&nbsp;b.w-b.r&nbsp;&lt;&nbsp;len(b.buf)&nbsp;=&gt;&nbsp;buffer&nbsp;is&nbsp;not&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920805">var</span>&nbsp;<span class="ident" id="2920809">err</span>&nbsp;<span class="builtintype" id="2920813">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920820">if</span>&nbsp;<span class="ident" id="2920823">avail</span>&nbsp;<span class="op" id="2920829">:=</span>&nbsp;<span class="ident" id="2920832">b</span><span class="op" id="2920833">.</span><span class="ident" id="2920834">w</span>&nbsp;<span class="op" id="2920836">-</span>&nbsp;<span class="ident" id="2920838">b</span><span class="op" id="2920839">.</span><span class="ident" id="2920840">r</span><span class="op" id="2920841">;</span>&nbsp;<span class="ident" id="2920843">avail</span>&nbsp;<span class="op" id="2920849">&lt;</span>&nbsp;<span class="ident" id="2920851">n</span>&nbsp;<span class="op" id="2920853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2920857">//&nbsp;not&nbsp;enough&nbsp;data&nbsp;in&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920888">n</span>&nbsp;<span class="op" id="2920890">=</span>&nbsp;<span class="ident" id="2920892">avail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920900">err</span>&nbsp;<span class="op" id="2920904">=</span>&nbsp;<span class="ident" id="2920906">b</span><span class="op" id="2920907">.</span><span class="ident" id="2920908">readErr</span><span class="op" id="2920915">(</span><span class="op" id="2920916">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920920">if</span>&nbsp;<span class="ident" id="2920923">err</span>&nbsp;<span class="op" id="2920927">==</span>&nbsp;<span class="ident" id="2920930">nil</span>&nbsp;<span class="op" id="2920934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2920939">err</span>&nbsp;<span class="op" id="2920943">=</span>&nbsp;<span class="ident" id="2920945">ErrBufferFull</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2920964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2920967">return</span>&nbsp;<span class="ident" id="2920974">b</span><span class="op" id="2920975">.</span><span class="ident" id="2920976">buf</span><span class="op" id="2920979">[</span><span class="ident" id="2920980">b</span><span class="op" id="2920981">.</span><span class="ident" id="2920982">r</span>&nbsp;<span class="op" id="2920984">:</span>&nbsp;<span class="ident" id="2920986">b</span><span class="op" id="2920987">.</span><span class="ident" id="2920988">r</span><span class="op" id="2920989">+</span><span class="ident" id="2920990">n</span><span class="op" id="2920991">]</span><span class="op" id="2920992">,</span>&nbsp;<span class="ident" id="2920994">err</span><br>
<span class="lineno">145</span><span class="op" id="2920998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2921001">//&nbsp;Read&nbsp;reads&nbsp;data&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="2921028">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;read&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="2921075">//&nbsp;It&nbsp;calls&nbsp;Read&nbsp;at&nbsp;most&nbsp;once&nbsp;on&nbsp;the&nbsp;underlying&nbsp;Reader,</span><br>
<span class="lineno">150</span><span class="comment" id="2921131">//&nbsp;hence&nbsp;n&nbsp;may&nbsp;be&nbsp;less&nbsp;than&nbsp;len(p).</span><br>
<span class="lineno"></span><span class="comment" id="2921167">//&nbsp;At&nbsp;EOF,&nbsp;the&nbsp;count&nbsp;will&nbsp;be&nbsp;zero&nbsp;and&nbsp;err&nbsp;will&nbsp;be&nbsp;io.EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="2921225">func</span>&nbsp;<span class="op" id="2921230">(</span><span class="ident" id="2921231">b</span>&nbsp;<span class="op" id="2921233">*</span><span class="ident" id="2921234">Reader</span><span class="op" id="2921240">)</span>&nbsp;<span class="ident" id="2921242">Read</span><span class="op" id="2921246">(</span><span class="ident" id="2921247">p</span>&nbsp;<span class="op" id="2921249">[</span><span class="op" id="2921250">]</span><span class="builtintype" id="2921251">byte</span><span class="op" id="2921255">)</span>&nbsp;<span class="op" id="2921257">(</span><span class="ident" id="2921258">n</span>&nbsp;<span class="builtintype" id="2921260">int</span><span class="op" id="2921263">,</span>&nbsp;<span class="ident" id="2921265">err</span>&nbsp;<span class="builtintype" id="2921269">error</span><span class="op" id="2921274">)</span>&nbsp;<span class="op" id="2921276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921279">n</span>&nbsp;<span class="op" id="2921281">=</span>&nbsp;<span class="builtinfunc" id="2921283">len</span><span class="op" id="2921286">(</span><span class="ident" id="2921287">p</span><span class="op" id="2921288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921291">if</span>&nbsp;<span class="ident" id="2921294">n</span>&nbsp;<span class="op" id="2921296">==</span>&nbsp;<span class="num" id="2921299">0</span>&nbsp;<span class="op" id="2921301">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921305">return</span>&nbsp;<span class="num" id="2921312">0</span><span class="op" id="2921313">,</span>&nbsp;<span class="ident" id="2921315">b</span><span class="op" id="2921316">.</span><span class="ident" id="2921317">readErr</span><span class="op" id="2921324">(</span><span class="op" id="2921325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921331">if</span>&nbsp;<span class="ident" id="2921334">b</span><span class="op" id="2921335">.</span><span class="ident" id="2921336">r</span>&nbsp;<span class="op" id="2921338">==</span>&nbsp;<span class="ident" id="2921341">b</span><span class="op" id="2921342">.</span><span class="ident" id="2921343">w</span>&nbsp;<span class="op" id="2921345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921349">if</span>&nbsp;<span class="ident" id="2921352">b</span><span class="op" id="2921353">.</span><span class="ident" id="2921354">err</span>&nbsp;<span class="op" id="2921358">!=</span>&nbsp;<span class="ident" id="2921361">nil</span>&nbsp;<span class="op" id="2921365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921370">return</span>&nbsp;<span class="num" id="2921377">0</span><span class="op" id="2921378">,</span>&nbsp;<span class="ident" id="2921380">b</span><span class="op" id="2921381">.</span><span class="ident" id="2921382">readErr</span><span class="op" id="2921389">(</span><span class="op" id="2921390">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921398">if</span>&nbsp;<span class="builtinfunc" id="2921401">len</span><span class="op" id="2921404">(</span><span class="ident" id="2921405">p</span><span class="op" id="2921406">)</span>&nbsp;<span class="op" id="2921408">&gt;=</span>&nbsp;<span class="builtinfunc" id="2921411">len</span><span class="op" id="2921414">(</span><span class="ident" id="2921415">b</span><span class="op" id="2921416">.</span><span class="ident" id="2921417">buf</span><span class="op" id="2921420">)</span>&nbsp;<span class="op" id="2921422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2921427">//&nbsp;Large&nbsp;read,&nbsp;empty&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2921459">//&nbsp;Read&nbsp;directly&nbsp;into&nbsp;p&nbsp;to&nbsp;avoid&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921501">n</span><span class="op" id="2921502">,</span>&nbsp;<span class="ident" id="2921504">b</span><span class="op" id="2921505">.</span><span class="ident" id="2921506">err</span>&nbsp;<span class="op" id="2921510">=</span>&nbsp;<span class="ident" id="2921512">b</span><span class="op" id="2921513">.</span><span class="ident" id="2921514">rd</span><span class="op" id="2921516">.</span><span class="ident" id="2921517">Read</span><span class="op" id="2921521">(</span><span class="ident" id="2921522">p</span><span class="op" id="2921523">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921528">if</span>&nbsp;<span class="ident" id="2921531">n</span>&nbsp;<span class="op" id="2921533">&lt;</span>&nbsp;<span class="num" id="2921535">0</span>&nbsp;<span class="op" id="2921537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2921543">panic</span><span class="op" id="2921548">(</span><span class="ident" id="2921549">errNegativeRead</span><span class="op" id="2921564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921574">if</span>&nbsp;<span class="ident" id="2921577">n</span>&nbsp;<span class="op" id="2921579">&gt;</span>&nbsp;<span class="num" id="2921581">0</span>&nbsp;<span class="op" id="2921583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921589">b</span><span class="op" id="2921590">.</span><span class="ident" id="2921591">lastByte</span>&nbsp;<span class="op" id="2921600">=</span>&nbsp;<span class="builtintype" id="2921602">int</span><span class="op" id="2921605">(</span><span class="ident" id="2921606">p</span><span class="op" id="2921607">[</span><span class="ident" id="2921608">n</span><span class="op" id="2921609">-</span><span class="num" id="2921610">1</span><span class="op" id="2921611">]</span><span class="op" id="2921612">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921618">b</span><span class="op" id="2921619">.</span><span class="ident" id="2921620">lastRuneSize</span>&nbsp;<span class="op" id="2921633">=</span>&nbsp;<span class="op" id="2921635">-</span><span class="num" id="2921636">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921646">return</span>&nbsp;<span class="ident" id="2921653">n</span><span class="op" id="2921654">,</span>&nbsp;<span class="ident" id="2921656">b</span><span class="op" id="2921657">.</span><span class="ident" id="2921658">readErr</span><span class="op" id="2921665">(</span><span class="op" id="2921666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921674">b</span><span class="op" id="2921675">.</span><span class="ident" id="2921676">fill</span><span class="op" id="2921680">(</span><span class="op" id="2921681">)</span>&nbsp;<span class="comment" id="2921683">//&nbsp;buffer&nbsp;is&nbsp;empty</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921704">if</span>&nbsp;<span class="ident" id="2921707">b</span><span class="op" id="2921708">.</span><span class="ident" id="2921709">r</span>&nbsp;<span class="op" id="2921711">==</span>&nbsp;<span class="ident" id="2921714">b</span><span class="op" id="2921715">.</span><span class="ident" id="2921716">w</span>&nbsp;<span class="op" id="2921718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921723">return</span>&nbsp;<span class="num" id="2921730">0</span><span class="op" id="2921731">,</span>&nbsp;<span class="ident" id="2921733">b</span><span class="op" id="2921734">.</span><span class="ident" id="2921735">readErr</span><span class="op" id="2921742">(</span><span class="op" id="2921743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2921750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2921754">//&nbsp;copy&nbsp;as&nbsp;much&nbsp;as&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921781">n</span>&nbsp;<span class="op" id="2921783">=</span>&nbsp;<span class="builtinfunc" id="2921785">copy</span><span class="op" id="2921789">(</span><span class="ident" id="2921790">p</span><span class="op" id="2921791">,</span>&nbsp;<span class="ident" id="2921793">b</span><span class="op" id="2921794">.</span><span class="ident" id="2921795">buf</span><span class="op" id="2921798">[</span><span class="ident" id="2921799">b</span><span class="op" id="2921800">.</span><span class="ident" id="2921801">r</span><span class="op" id="2921802">:</span><span class="ident" id="2921803">b</span><span class="op" id="2921804">.</span><span class="ident" id="2921805">w</span><span class="op" id="2921806">]</span><span class="op" id="2921807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921810">b</span><span class="op" id="2921811">.</span><span class="ident" id="2921812">r</span>&nbsp;<span class="op" id="2921814">+=</span>&nbsp;<span class="ident" id="2921817">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921820">b</span><span class="op" id="2921821">.</span><span class="ident" id="2921822">lastByte</span>&nbsp;<span class="op" id="2921831">=</span>&nbsp;<span class="builtintype" id="2921833">int</span><span class="op" id="2921836">(</span><span class="ident" id="2921837">b</span><span class="op" id="2921838">.</span><span class="ident" id="2921839">buf</span><span class="op" id="2921842">[</span><span class="ident" id="2921843">b</span><span class="op" id="2921844">.</span><span class="ident" id="2921845">r</span><span class="op" id="2921846">-</span><span class="num" id="2921847">1</span><span class="op" id="2921848">]</span><span class="op" id="2921849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2921852">b</span><span class="op" id="2921853">.</span><span class="ident" id="2921854">lastRuneSize</span>&nbsp;<span class="op" id="2921867">=</span>&nbsp;<span class="op" id="2921869">-</span><span class="num" id="2921870">1</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2921873">return</span>&nbsp;<span class="ident" id="2921880">n</span><span class="op" id="2921881">,</span>&nbsp;<span class="ident" id="2921883">nil</span><br>
<span class="lineno"></span><span class="op" id="2921887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2921890">//&nbsp;ReadByte&nbsp;reads&nbsp;and&nbsp;returns&nbsp;a&nbsp;single&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="2921935">//&nbsp;If&nbsp;no&nbsp;byte&nbsp;is&nbsp;available,&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">190</span><span class="keyword" id="2921981">func</span>&nbsp;<span class="op" id="2921986">(</span><span class="ident" id="2921987">b</span>&nbsp;<span class="op" id="2921989">*</span><span class="ident" id="2921990">Reader</span><span class="op" id="2921996">)</span>&nbsp;<span class="ident" id="2921998">ReadByte</span><span class="op" id="2922006">(</span><span class="op" id="2922007">)</span>&nbsp;<span class="op" id="2922009">(</span><span class="ident" id="2922010">c</span>&nbsp;<span class="builtintype" id="2922012">byte</span><span class="op" id="2922016">,</span>&nbsp;<span class="ident" id="2922018">err</span>&nbsp;<span class="builtintype" id="2922022">error</span><span class="op" id="2922027">)</span>&nbsp;<span class="op" id="2922029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922032">b</span><span class="op" id="2922033">.</span><span class="ident" id="2922034">lastRuneSize</span>&nbsp;<span class="op" id="2922047">=</span>&nbsp;<span class="op" id="2922049">-</span><span class="num" id="2922050">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922053">for</span>&nbsp;<span class="ident" id="2922057">b</span><span class="op" id="2922058">.</span><span class="ident" id="2922059">r</span>&nbsp;<span class="op" id="2922061">==</span>&nbsp;<span class="ident" id="2922064">b</span><span class="op" id="2922065">.</span><span class="ident" id="2922066">w</span>&nbsp;<span class="op" id="2922068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922072">if</span>&nbsp;<span class="ident" id="2922075">b</span><span class="op" id="2922076">.</span><span class="ident" id="2922077">err</span>&nbsp;<span class="op" id="2922081">!=</span>&nbsp;<span class="ident" id="2922084">nil</span>&nbsp;<span class="op" id="2922088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922093">return</span>&nbsp;<span class="num" id="2922100">0</span><span class="op" id="2922101">,</span>&nbsp;<span class="ident" id="2922103">b</span><span class="op" id="2922104">.</span><span class="ident" id="2922105">readErr</span><span class="op" id="2922112">(</span><span class="op" id="2922113">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922121">b</span><span class="op" id="2922122">.</span><span class="ident" id="2922123">fill</span><span class="op" id="2922127">(</span><span class="op" id="2922128">)</span>&nbsp;<span class="comment" id="2922130">//&nbsp;buffer&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922153">c</span>&nbsp;<span class="op" id="2922155">=</span>&nbsp;<span class="ident" id="2922157">b</span><span class="op" id="2922158">.</span><span class="ident" id="2922159">buf</span><span class="op" id="2922162">[</span><span class="ident" id="2922163">b</span><span class="op" id="2922164">.</span><span class="ident" id="2922165">r</span><span class="op" id="2922166">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922169">b</span><span class="op" id="2922170">.</span><span class="ident" id="2922171">r</span><span class="op" id="2922172">++</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922176">b</span><span class="op" id="2922177">.</span><span class="ident" id="2922178">lastByte</span>&nbsp;<span class="op" id="2922187">=</span>&nbsp;<span class="builtintype" id="2922189">int</span><span class="op" id="2922192">(</span><span class="ident" id="2922193">c</span><span class="op" id="2922194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922197">return</span>&nbsp;<span class="ident" id="2922204">c</span><span class="op" id="2922205">,</span>&nbsp;<span class="ident" id="2922207">nil</span><br>
<span class="lineno"></span><span class="op" id="2922211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2922214">//&nbsp;UnreadByte&nbsp;unreads&nbsp;the&nbsp;last&nbsp;byte.&nbsp;&nbsp;Only&nbsp;the&nbsp;most&nbsp;recently&nbsp;read&nbsp;byte&nbsp;can&nbsp;be&nbsp;unread.</span><br>
<span class="lineno">205</span><span class="keyword" id="2922300">func</span>&nbsp;<span class="op" id="2922305">(</span><span class="ident" id="2922306">b</span>&nbsp;<span class="op" id="2922308">*</span><span class="ident" id="2922309">Reader</span><span class="op" id="2922315">)</span>&nbsp;<span class="ident" id="2922317">UnreadByte</span><span class="op" id="2922327">(</span><span class="op" id="2922328">)</span>&nbsp;<span class="builtintype" id="2922330">error</span>&nbsp;<span class="op" id="2922336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922339">if</span>&nbsp;<span class="ident" id="2922342">b</span><span class="op" id="2922343">.</span><span class="ident" id="2922344">lastByte</span>&nbsp;<span class="op" id="2922353">&lt;</span>&nbsp;<span class="num" id="2922355">0</span>&nbsp;<span class="op" id="2922357">||</span>&nbsp;<span class="ident" id="2922360">b</span><span class="op" id="2922361">.</span><span class="ident" id="2922362">r</span>&nbsp;<span class="op" id="2922364">==</span>&nbsp;<span class="num" id="2922367">0</span>&nbsp;<span class="op" id="2922369">&amp;&amp;</span>&nbsp;<span class="ident" id="2922372">b</span><span class="op" id="2922373">.</span><span class="ident" id="2922374">w</span>&nbsp;<span class="op" id="2922376">&gt;</span>&nbsp;<span class="num" id="2922378">0</span>&nbsp;<span class="op" id="2922380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922384">return</span>&nbsp;<span class="ident" id="2922391">ErrInvalidUnreadByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2922416">//&nbsp;b.r&nbsp;&gt;&nbsp;0&nbsp;||&nbsp;b.w&nbsp;==&nbsp;0</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922440">if</span>&nbsp;<span class="ident" id="2922443">b</span><span class="op" id="2922444">.</span><span class="ident" id="2922445">r</span>&nbsp;<span class="op" id="2922447">&gt;</span>&nbsp;<span class="num" id="2922449">0</span>&nbsp;<span class="op" id="2922451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922455">b</span><span class="op" id="2922456">.</span><span class="ident" id="2922457">r</span><span class="op" id="2922458">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922462">}</span>&nbsp;<span class="keyword" id="2922464">else</span>&nbsp;<span class="op" id="2922469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2922473">//&nbsp;b.r&nbsp;==&nbsp;0&nbsp;&amp;&amp;&nbsp;b.w&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922499">b</span><span class="op" id="2922500">.</span><span class="ident" id="2922501">w</span>&nbsp;<span class="op" id="2922503">=</span>&nbsp;<span class="num" id="2922505">1</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2922508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922511">b</span><span class="op" id="2922512">.</span><span class="ident" id="2922513">buf</span><span class="op" id="2922516">[</span><span class="ident" id="2922517">b</span><span class="op" id="2922518">.</span><span class="ident" id="2922519">r</span><span class="op" id="2922520">]</span>&nbsp;<span class="op" id="2922522">=</span>&nbsp;<span class="builtintype" id="2922524">byte</span><span class="op" id="2922528">(</span><span class="ident" id="2922529">b</span><span class="op" id="2922530">.</span><span class="ident" id="2922531">lastByte</span><span class="op" id="2922539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922542">b</span><span class="op" id="2922543">.</span><span class="ident" id="2922544">lastByte</span>&nbsp;<span class="op" id="2922553">=</span>&nbsp;<span class="op" id="2922555">-</span><span class="num" id="2922556">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922559">b</span><span class="op" id="2922560">.</span><span class="ident" id="2922561">lastRuneSize</span>&nbsp;<span class="op" id="2922574">=</span>&nbsp;<span class="op" id="2922576">-</span><span class="num" id="2922577">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922580">return</span>&nbsp;<span class="ident" id="2922587">nil</span><br>
<span class="lineno">220</span><span class="op" id="2922591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2922594">//&nbsp;ReadRune&nbsp;reads&nbsp;a&nbsp;single&nbsp;UTF-8&nbsp;encoded&nbsp;Unicode&nbsp;character&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2922669">//&nbsp;rune&nbsp;and&nbsp;its&nbsp;size&nbsp;in&nbsp;bytes.&nbsp;If&nbsp;the&nbsp;encoded&nbsp;rune&nbsp;is&nbsp;invalid,&nbsp;it&nbsp;consumes&nbsp;one&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="2922753">//&nbsp;and&nbsp;returns&nbsp;unicode.ReplacementChar&nbsp;(U+FFFD)&nbsp;with&nbsp;a&nbsp;size&nbsp;of&nbsp;1.</span><br>
<span class="lineno">225</span><span class="keyword" id="2922819">func</span>&nbsp;<span class="op" id="2922824">(</span><span class="ident" id="2922825">b</span>&nbsp;<span class="op" id="2922827">*</span><span class="ident" id="2922828">Reader</span><span class="op" id="2922834">)</span>&nbsp;<span class="ident" id="2922836">ReadRune</span><span class="op" id="2922844">(</span><span class="op" id="2922845">)</span>&nbsp;<span class="op" id="2922847">(</span><span class="ident" id="2922848">r</span>&nbsp;<span class="builtintype" id="2922850">rune</span><span class="op" id="2922854">,</span>&nbsp;<span class="ident" id="2922856">size</span>&nbsp;<span class="builtintype" id="2922861">int</span><span class="op" id="2922864">,</span>&nbsp;<span class="ident" id="2922866">err</span>&nbsp;<span class="builtintype" id="2922870">error</span><span class="op" id="2922875">)</span>&nbsp;<span class="op" id="2922877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2922880">for</span>&nbsp;<span class="ident" id="2922884">b</span><span class="op" id="2922885">.</span><span class="ident" id="2922886">r</span><span class="op" id="2922887">+</span><span class="ident" id="2922888">utf8</span><span class="op" id="2922892">.</span><span class="ident" id="2922893">UTFMax</span>&nbsp;<span class="op" id="2922900">&gt;</span>&nbsp;<span class="ident" id="2922902">b</span><span class="op" id="2922903">.</span><span class="ident" id="2922904">w</span>&nbsp;<span class="op" id="2922906">&amp;&amp;</span>&nbsp;<span class="op" id="2922909">!</span><span class="ident" id="2922910">utf8</span><span class="op" id="2922914">.</span><span class="ident" id="2922915">FullRune</span><span class="op" id="2922923">(</span><span class="ident" id="2922924">b</span><span class="op" id="2922925">.</span><span class="ident" id="2922926">buf</span><span class="op" id="2922929">[</span><span class="ident" id="2922930">b</span><span class="op" id="2922931">.</span><span class="ident" id="2922932">r</span><span class="op" id="2922933">:</span><span class="ident" id="2922934">b</span><span class="op" id="2922935">.</span><span class="ident" id="2922936">w</span><span class="op" id="2922937">]</span><span class="op" id="2922938">)</span>&nbsp;<span class="op" id="2922940">&amp;&amp;</span>&nbsp;<span class="ident" id="2922943">b</span><span class="op" id="2922944">.</span><span class="ident" id="2922945">err</span>&nbsp;<span class="op" id="2922949">==</span>&nbsp;<span class="ident" id="2922952">nil</span>&nbsp;<span class="op" id="2922956">&amp;&amp;</span>&nbsp;<span class="ident" id="2922959">b</span><span class="op" id="2922960">.</span><span class="ident" id="2922961">w</span><span class="op" id="2922962">-</span><span class="ident" id="2922963">b</span><span class="op" id="2922964">.</span><span class="ident" id="2922965">r</span>&nbsp;<span class="op" id="2922967">&lt;</span>&nbsp;<span class="builtinfunc" id="2922969">len</span><span class="op" id="2922972">(</span><span class="ident" id="2922973">b</span><span class="op" id="2922974">.</span><span class="ident" id="2922975">buf</span><span class="op" id="2922978">)</span>&nbsp;<span class="op" id="2922980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2922984">b</span><span class="op" id="2922985">.</span><span class="ident" id="2922986">fill</span><span class="op" id="2922990">(</span><span class="op" id="2922991">)</span>&nbsp;<span class="comment" id="2922993">//&nbsp;b.w-b.r&nbsp;&lt;&nbsp;len(buf)&nbsp;=&gt;&nbsp;buffer&nbsp;is&nbsp;not&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2923038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923041">b</span><span class="op" id="2923042">.</span><span class="ident" id="2923043">lastRuneSize</span>&nbsp;<span class="op" id="2923056">=</span>&nbsp;<span class="op" id="2923058">-</span><span class="num" id="2923059">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923062">if</span>&nbsp;<span class="ident" id="2923065">b</span><span class="op" id="2923066">.</span><span class="ident" id="2923067">r</span>&nbsp;<span class="op" id="2923069">==</span>&nbsp;<span class="ident" id="2923072">b</span><span class="op" id="2923073">.</span><span class="ident" id="2923074">w</span>&nbsp;<span class="op" id="2923076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923080">return</span>&nbsp;<span class="num" id="2923087">0</span><span class="op" id="2923088">,</span>&nbsp;<span class="num" id="2923090">0</span><span class="op" id="2923091">,</span>&nbsp;<span class="ident" id="2923093">b</span><span class="op" id="2923094">.</span><span class="ident" id="2923095">readErr</span><span class="op" id="2923102">(</span><span class="op" id="2923103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2923106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923109">r</span><span class="op" id="2923110">,</span>&nbsp;<span class="ident" id="2923112">size</span>&nbsp;<span class="op" id="2923117">=</span>&nbsp;<span class="builtintype" id="2923119">rune</span><span class="op" id="2923123">(</span><span class="ident" id="2923124">b</span><span class="op" id="2923125">.</span><span class="ident" id="2923126">buf</span><span class="op" id="2923129">[</span><span class="ident" id="2923130">b</span><span class="op" id="2923131">.</span><span class="ident" id="2923132">r</span><span class="op" id="2923133">]</span><span class="op" id="2923134">)</span><span class="op" id="2923135">,</span>&nbsp;<span class="num" id="2923137">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923140">if</span>&nbsp;<span class="ident" id="2923143">r</span>&nbsp;<span class="op" id="2923145">&gt;=</span>&nbsp;<span class="num" id="2923148">0x80</span>&nbsp;<span class="op" id="2923153">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923157">r</span><span class="op" id="2923158">,</span>&nbsp;<span class="ident" id="2923160">size</span>&nbsp;<span class="op" id="2923165">=</span>&nbsp;<span class="ident" id="2923167">utf8</span><span class="op" id="2923171">.</span><span class="ident" id="2923172">DecodeRune</span><span class="op" id="2923182">(</span><span class="ident" id="2923183">b</span><span class="op" id="2923184">.</span><span class="ident" id="2923185">buf</span><span class="op" id="2923188">[</span><span class="ident" id="2923189">b</span><span class="op" id="2923190">.</span><span class="ident" id="2923191">r</span><span class="op" id="2923192">:</span><span class="ident" id="2923193">b</span><span class="op" id="2923194">.</span><span class="ident" id="2923195">w</span><span class="op" id="2923196">]</span><span class="op" id="2923197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2923200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923203">b</span><span class="op" id="2923204">.</span><span class="ident" id="2923205">r</span>&nbsp;<span class="op" id="2923207">+=</span>&nbsp;<span class="ident" id="2923210">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923216">b</span><span class="op" id="2923217">.</span><span class="ident" id="2923218">lastByte</span>&nbsp;<span class="op" id="2923227">=</span>&nbsp;<span class="builtintype" id="2923229">int</span><span class="op" id="2923232">(</span><span class="ident" id="2923233">b</span><span class="op" id="2923234">.</span><span class="ident" id="2923235">buf</span><span class="op" id="2923238">[</span><span class="ident" id="2923239">b</span><span class="op" id="2923240">.</span><span class="ident" id="2923241">r</span><span class="op" id="2923242">-</span><span class="num" id="2923243">1</span><span class="op" id="2923244">]</span><span class="op" id="2923245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923248">b</span><span class="op" id="2923249">.</span><span class="ident" id="2923250">lastRuneSize</span>&nbsp;<span class="op" id="2923263">=</span>&nbsp;<span class="ident" id="2923265">size</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923271">return</span>&nbsp;<span class="ident" id="2923278">r</span><span class="op" id="2923279">,</span>&nbsp;<span class="ident" id="2923281">size</span><span class="op" id="2923285">,</span>&nbsp;<span class="ident" id="2923287">nil</span><br>
<span class="lineno"></span><span class="op" id="2923291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2923294">//&nbsp;UnreadRune&nbsp;unreads&nbsp;the&nbsp;last&nbsp;rune.&nbsp;&nbsp;If&nbsp;the&nbsp;most&nbsp;recent&nbsp;read&nbsp;operation&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="2923369">//&nbsp;the&nbsp;buffer&nbsp;was&nbsp;not&nbsp;a&nbsp;ReadRune,&nbsp;UnreadRune&nbsp;returns&nbsp;an&nbsp;error.&nbsp;&nbsp;(In&nbsp;this</span><br>
<span class="lineno">245</span><span class="comment" id="2923442">//&nbsp;regard&nbsp;it&nbsp;is&nbsp;stricter&nbsp;than&nbsp;UnreadByte,&nbsp;which&nbsp;will&nbsp;unread&nbsp;the&nbsp;last&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="2923516">//&nbsp;from&nbsp;any&nbsp;read&nbsp;operation.)</span><br>
<span class="lineno"></span><span class="keyword" id="2923545">func</span>&nbsp;<span class="op" id="2923550">(</span><span class="ident" id="2923551">b</span>&nbsp;<span class="op" id="2923553">*</span><span class="ident" id="2923554">Reader</span><span class="op" id="2923560">)</span>&nbsp;<span class="ident" id="2923562">UnreadRune</span><span class="op" id="2923572">(</span><span class="op" id="2923573">)</span>&nbsp;<span class="builtintype" id="2923575">error</span>&nbsp;<span class="op" id="2923581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923584">if</span>&nbsp;<span class="ident" id="2923587">b</span><span class="op" id="2923588">.</span><span class="ident" id="2923589">lastRuneSize</span>&nbsp;<span class="op" id="2923602">&lt;</span>&nbsp;<span class="num" id="2923604">0</span>&nbsp;<span class="op" id="2923606">||</span>&nbsp;<span class="ident" id="2923609">b</span><span class="op" id="2923610">.</span><span class="ident" id="2923611">r</span>&nbsp;<span class="op" id="2923613">&lt;</span>&nbsp;<span class="ident" id="2923615">b</span><span class="op" id="2923616">.</span><span class="ident" id="2923617">lastRuneSize</span>&nbsp;<span class="op" id="2923630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923634">return</span>&nbsp;<span class="ident" id="2923641">ErrInvalidUnreadRune</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2923663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923666">b</span><span class="op" id="2923667">.</span><span class="ident" id="2923668">r</span>&nbsp;<span class="op" id="2923670">-=</span>&nbsp;<span class="ident" id="2923673">b</span><span class="op" id="2923674">.</span><span class="ident" id="2923675">lastRuneSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923689">b</span><span class="op" id="2923690">.</span><span class="ident" id="2923691">lastByte</span>&nbsp;<span class="op" id="2923700">=</span>&nbsp;<span class="op" id="2923702">-</span><span class="num" id="2923703">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2923706">b</span><span class="op" id="2923707">.</span><span class="ident" id="2923708">lastRuneSize</span>&nbsp;<span class="op" id="2923721">=</span>&nbsp;<span class="op" id="2923723">-</span><span class="num" id="2923724">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2923727">return</span>&nbsp;<span class="ident" id="2923734">nil</span><br>
<span class="lineno">255</span><span class="op" id="2923738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2923741">//&nbsp;Buffered&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;that&nbsp;can&nbsp;be&nbsp;read&nbsp;from&nbsp;the&nbsp;current&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="2923823">func</span>&nbsp;<span class="op" id="2923828">(</span><span class="ident" id="2923829">b</span>&nbsp;<span class="op" id="2923831">*</span><span class="ident" id="2923832">Reader</span><span class="op" id="2923838">)</span>&nbsp;<span class="ident" id="2923840">Buffered</span><span class="op" id="2923848">(</span><span class="op" id="2923849">)</span>&nbsp;<span class="builtintype" id="2923851">int</span>&nbsp;<span class="op" id="2923855">{</span>&nbsp;<span class="keyword" id="2923857">return</span>&nbsp;<span class="ident" id="2923864">b</span><span class="op" id="2923865">.</span><span class="ident" id="2923866">w</span>&nbsp;<span class="op" id="2923868">-</span>&nbsp;<span class="ident" id="2923870">b</span><span class="op" id="2923871">.</span><span class="ident" id="2923872">r</span>&nbsp;<span class="op" id="2923874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="2923877">//&nbsp;ReadSlice&nbsp;reads&nbsp;until&nbsp;the&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;delim&nbsp;in&nbsp;the&nbsp;input,</span><br>
<span class="lineno"></span><span class="comment" id="2923946">//&nbsp;returning&nbsp;a&nbsp;slice&nbsp;pointing&nbsp;at&nbsp;the&nbsp;bytes&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="2924004">//&nbsp;The&nbsp;bytes&nbsp;stop&nbsp;being&nbsp;valid&nbsp;at&nbsp;the&nbsp;next&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="2924052">//&nbsp;If&nbsp;ReadSlice&nbsp;encounters&nbsp;an&nbsp;error&nbsp;before&nbsp;finding&nbsp;a&nbsp;delimiter,</span><br>
<span class="lineno"></span><span class="comment" id="2924116">//&nbsp;it&nbsp;returns&nbsp;all&nbsp;the&nbsp;data&nbsp;in&nbsp;the&nbsp;buffer&nbsp;and&nbsp;the&nbsp;error&nbsp;itself&nbsp;(often&nbsp;io.EOF).</span><br>
<span class="lineno">265</span><span class="comment" id="2924194">//&nbsp;ReadSlice&nbsp;fails&nbsp;with&nbsp;error&nbsp;ErrBufferFull&nbsp;if&nbsp;the&nbsp;buffer&nbsp;fills&nbsp;without&nbsp;a&nbsp;delim.</span><br>
<span class="lineno"></span><span class="comment" id="2924275">//&nbsp;Because&nbsp;the&nbsp;data&nbsp;returned&nbsp;from&nbsp;ReadSlice&nbsp;will&nbsp;be&nbsp;overwritten</span><br>
<span class="lineno"></span><span class="comment" id="2924339">//&nbsp;by&nbsp;the&nbsp;next&nbsp;I/O&nbsp;operation,&nbsp;most&nbsp;clients&nbsp;should&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="2924393">//&nbsp;ReadBytes&nbsp;or&nbsp;ReadString&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="2924429">//&nbsp;ReadSlice&nbsp;returns&nbsp;err&nbsp;!=&nbsp;nil&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;line&nbsp;does&nbsp;not&nbsp;end&nbsp;in&nbsp;delim.</span><br>
<span class="lineno">270</span><span class="keyword" id="2924504">func</span>&nbsp;<span class="op" id="2924509">(</span><span class="ident" id="2924510">b</span>&nbsp;<span class="op" id="2924512">*</span><span class="ident" id="2924513">Reader</span><span class="op" id="2924519">)</span>&nbsp;<span class="ident" id="2924521">ReadSlice</span><span class="op" id="2924530">(</span><span class="ident" id="2924531">delim</span>&nbsp;<span class="builtintype" id="2924537">byte</span><span class="op" id="2924541">)</span>&nbsp;<span class="op" id="2924543">(</span><span class="ident" id="2924544">line</span>&nbsp;<span class="op" id="2924549">[</span><span class="op" id="2924550">]</span><span class="builtintype" id="2924551">byte</span><span class="op" id="2924555">,</span>&nbsp;<span class="ident" id="2924557">err</span>&nbsp;<span class="builtintype" id="2924561">error</span><span class="op" id="2924566">)</span>&nbsp;<span class="op" id="2924568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924571">for</span>&nbsp;<span class="op" id="2924575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2924579">//&nbsp;Search&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924599">if</span>&nbsp;<span class="ident" id="2924602">i</span>&nbsp;<span class="op" id="2924604">:=</span>&nbsp;<span class="ident" id="2924607">bytes</span><span class="op" id="2924612">.</span><span class="ident" id="2924613">IndexByte</span><span class="op" id="2924622">(</span><span class="ident" id="2924623">b</span><span class="op" id="2924624">.</span><span class="ident" id="2924625">buf</span><span class="op" id="2924628">[</span><span class="ident" id="2924629">b</span><span class="op" id="2924630">.</span><span class="ident" id="2924631">r</span><span class="op" id="2924632">:</span><span class="ident" id="2924633">b</span><span class="op" id="2924634">.</span><span class="ident" id="2924635">w</span><span class="op" id="2924636">]</span><span class="op" id="2924637">,</span>&nbsp;<span class="ident" id="2924639">delim</span><span class="op" id="2924644">)</span><span class="op" id="2924645">;</span>&nbsp;<span class="ident" id="2924647">i</span>&nbsp;<span class="op" id="2924649">&gt;=</span>&nbsp;<span class="num" id="2924652">0</span>&nbsp;<span class="op" id="2924654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924659">line</span>&nbsp;<span class="op" id="2924664">=</span>&nbsp;<span class="ident" id="2924666">b</span><span class="op" id="2924667">.</span><span class="ident" id="2924668">buf</span><span class="op" id="2924671">[</span><span class="ident" id="2924672">b</span><span class="op" id="2924673">.</span><span class="ident" id="2924674">r</span>&nbsp;<span class="op" id="2924676">:</span>&nbsp;<span class="ident" id="2924678">b</span><span class="op" id="2924679">.</span><span class="ident" id="2924680">r</span><span class="op" id="2924681">+</span><span class="ident" id="2924682">i</span><span class="op" id="2924683">+</span><span class="num" id="2924684">1</span><span class="op" id="2924685">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924690">b</span><span class="op" id="2924691">.</span><span class="ident" id="2924692">r</span>&nbsp;<span class="op" id="2924694">+=</span>&nbsp;<span class="ident" id="2924697">i</span>&nbsp;<span class="op" id="2924699">+</span>&nbsp;<span class="num" id="2924701">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924706">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2924714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2924719">//&nbsp;Pending&nbsp;error?</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924739">if</span>&nbsp;<span class="ident" id="2924742">b</span><span class="op" id="2924743">.</span><span class="ident" id="2924744">err</span>&nbsp;<span class="op" id="2924748">!=</span>&nbsp;<span class="ident" id="2924751">nil</span>&nbsp;<span class="op" id="2924755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924760">line</span>&nbsp;<span class="op" id="2924765">=</span>&nbsp;<span class="ident" id="2924767">b</span><span class="op" id="2924768">.</span><span class="ident" id="2924769">buf</span><span class="op" id="2924772">[</span><span class="ident" id="2924773">b</span><span class="op" id="2924774">.</span><span class="ident" id="2924775">r</span><span class="op" id="2924776">:</span><span class="ident" id="2924777">b</span><span class="op" id="2924778">.</span><span class="ident" id="2924779">w</span><span class="op" id="2924780">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924785">b</span><span class="op" id="2924786">.</span><span class="ident" id="2924787">r</span>&nbsp;<span class="op" id="2924789">=</span>&nbsp;<span class="ident" id="2924791">b</span><span class="op" id="2924792">.</span><span class="ident" id="2924793">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924798">err</span>&nbsp;<span class="op" id="2924802">=</span>&nbsp;<span class="ident" id="2924804">b</span><span class="op" id="2924805">.</span><span class="ident" id="2924806">readErr</span><span class="op" id="2924813">(</span><span class="op" id="2924814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924819">break</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2924827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2924832">//&nbsp;Buffer&nbsp;full?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924850">if</span>&nbsp;<span class="ident" id="2924853">b</span><span class="op" id="2924854">.</span><span class="ident" id="2924855">Buffered</span><span class="op" id="2924863">(</span><span class="op" id="2924864">)</span>&nbsp;<span class="op" id="2924866">&gt;=</span>&nbsp;<span class="builtinfunc" id="2924869">len</span><span class="op" id="2924872">(</span><span class="ident" id="2924873">b</span><span class="op" id="2924874">.</span><span class="ident" id="2924875">buf</span><span class="op" id="2924878">)</span>&nbsp;<span class="op" id="2924880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924885">b</span><span class="op" id="2924886">.</span><span class="ident" id="2924887">r</span>&nbsp;<span class="op" id="2924889">=</span>&nbsp;<span class="ident" id="2924891">b</span><span class="op" id="2924892">.</span><span class="ident" id="2924893">w</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924898">line</span>&nbsp;<span class="op" id="2924903">=</span>&nbsp;<span class="ident" id="2924905">b</span><span class="op" id="2924906">.</span><span class="ident" id="2924907">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924914">err</span>&nbsp;<span class="op" id="2924918">=</span>&nbsp;<span class="ident" id="2924920">ErrBufferFull</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2924937">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2924945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2924950">b</span><span class="op" id="2924951">.</span><span class="ident" id="2924952">fill</span><span class="op" id="2924956">(</span><span class="op" id="2924957">)</span>&nbsp;<span class="comment" id="2924959">//&nbsp;buffer&nbsp;is&nbsp;not&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2924982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2924986">//&nbsp;Handle&nbsp;last&nbsp;byte,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925016">if</span>&nbsp;<span class="ident" id="2925019">i</span>&nbsp;<span class="op" id="2925021">:=</span>&nbsp;<span class="builtinfunc" id="2925024">len</span><span class="op" id="2925027">(</span><span class="ident" id="2925028">line</span><span class="op" id="2925032">)</span>&nbsp;<span class="op" id="2925034">-</span>&nbsp;<span class="num" id="2925036">1</span><span class="op" id="2925037">;</span>&nbsp;<span class="ident" id="2925039">i</span>&nbsp;<span class="op" id="2925041">&gt;=</span>&nbsp;<span class="num" id="2925044">0</span>&nbsp;<span class="op" id="2925046">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925050">b</span><span class="op" id="2925051">.</span><span class="ident" id="2925052">lastByte</span>&nbsp;<span class="op" id="2925061">=</span>&nbsp;<span class="builtintype" id="2925063">int</span><span class="op" id="2925066">(</span><span class="ident" id="2925067">line</span><span class="op" id="2925071">[</span><span class="ident" id="2925072">i</span><span class="op" id="2925073">]</span><span class="op" id="2925074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2925078">b</span><span class="op" id="2925079">.</span><span class="ident" id="2925080">lastRuneSize</span>&nbsp;<span class="op" id="2925093">=</span>&nbsp;<span class="op" id="2925095">-</span><span class="num" id="2925096">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2925099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2925103">return</span><br>
<span class="lineno">305</span><span class="op" id="2925110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2925113">//&nbsp;ReadLine&nbsp;is&nbsp;a&nbsp;low-level&nbsp;line-reading&nbsp;primitive.&nbsp;Most&nbsp;callers&nbsp;should&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="2925188">//&nbsp;ReadBytes(&#39;\n&#39;)&nbsp;or&nbsp;ReadString(&#39;\n&#39;)&nbsp;instead&nbsp;or&nbsp;use&nbsp;a&nbsp;Scanner.</span><br>
<span class="lineno"></span><span class="comment" id="2925253">//</span><br>
<span class="lineno">310</span><span class="comment" id="2925256">//&nbsp;ReadLine&nbsp;tries&nbsp;to&nbsp;return&nbsp;a&nbsp;single&nbsp;line,&nbsp;not&nbsp;including&nbsp;the&nbsp;end-of-line&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2925336">//&nbsp;If&nbsp;the&nbsp;line&nbsp;was&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;buffer&nbsp;then&nbsp;isPrefix&nbsp;is&nbsp;set&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2925408">//&nbsp;beginning&nbsp;of&nbsp;the&nbsp;line&nbsp;is&nbsp;returned.&nbsp;The&nbsp;rest&nbsp;of&nbsp;the&nbsp;line&nbsp;will&nbsp;be&nbsp;returned</span><br>
<span class="lineno"></span><span class="comment" id="2925484">//&nbsp;from&nbsp;future&nbsp;calls.&nbsp;isPrefix&nbsp;will&nbsp;be&nbsp;false&nbsp;when&nbsp;returning&nbsp;the&nbsp;last&nbsp;fragment</span><br>
<span class="lineno"></span><span class="comment" id="2925562">//&nbsp;of&nbsp;the&nbsp;line.&nbsp;The&nbsp;returned&nbsp;buffer&nbsp;is&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to</span><br>
<span class="lineno">315</span><span class="comment" id="2925635">//&nbsp;ReadLine.&nbsp;ReadLine&nbsp;either&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;line&nbsp;or&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span><span class="comment" id="2925711">//&nbsp;never&nbsp;both.</span><br>
<span class="lineno"></span><span class="comment" id="2925726">//</span><br>
<span class="lineno"></span><span class="comment" id="2925729">//&nbsp;The&nbsp;text&nbsp;returned&nbsp;from&nbsp;ReadLine&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;line&nbsp;end&nbsp;(&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;).</span><br>
<span class="lineno"></span><span class="comment" id="2925812">//&nbsp;No&nbsp;indication&nbsp;or&nbsp;error&nbsp;is&nbsp;given&nbsp;if&nbsp;the&nbsp;input&nbsp;ends&nbsp;without&nbsp;a&nbsp;final&nbsp;line&nbsp;end.</span><br>
<span class="lineno">320</span><span class="comment" id="2925891">//&nbsp;Calling&nbsp;UnreadByte&nbsp;after&nbsp;ReadLine&nbsp;will&nbsp;always&nbsp;unread&nbsp;the&nbsp;last&nbsp;byte&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="2925966">//&nbsp;(possibly&nbsp;a&nbsp;character&nbsp;belonging&nbsp;to&nbsp;the&nbsp;line&nbsp;end)&nbsp;even&nbsp;if&nbsp;that&nbsp;byte&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="2926043">//&nbsp;part&nbsp;of&nbsp;the&nbsp;line&nbsp;returned&nbsp;by&nbsp;ReadLine.</span><br>
<span class="lineno"></span><span class="keyword" id="2926085">func</span>&nbsp;<span class="op" id="2926090">(</span><span class="ident" id="2926091">b</span>&nbsp;<span class="op" id="2926093">*</span><span class="ident" id="2926094">Reader</span><span class="op" id="2926100">)</span>&nbsp;<span class="ident" id="2926102">ReadLine</span><span class="op" id="2926110">(</span><span class="op" id="2926111">)</span>&nbsp;<span class="op" id="2926113">(</span><span class="ident" id="2926114">line</span>&nbsp;<span class="op" id="2926119">[</span><span class="op" id="2926120">]</span><span class="builtintype" id="2926121">byte</span><span class="op" id="2926125">,</span>&nbsp;<span class="ident" id="2926127">isPrefix</span>&nbsp;<span class="builtintype" id="2926136">bool</span><span class="op" id="2926140">,</span>&nbsp;<span class="ident" id="2926142">err</span>&nbsp;<span class="builtintype" id="2926146">error</span><span class="op" id="2926151">)</span>&nbsp;<span class="op" id="2926153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926156">line</span><span class="op" id="2926160">,</span>&nbsp;<span class="ident" id="2926162">err</span>&nbsp;<span class="op" id="2926166">=</span>&nbsp;<span class="ident" id="2926168">b</span><span class="op" id="2926169">.</span><span class="ident" id="2926170">ReadSlice</span><span class="op" id="2926179">(</span><span class="string" id="2926180">&#39;\n&#39;</span><span class="op" id="2926184">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926187">if</span>&nbsp;<span class="ident" id="2926190">err</span>&nbsp;<span class="op" id="2926194">==</span>&nbsp;<span class="ident" id="2926197">ErrBufferFull</span>&nbsp;<span class="op" id="2926211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2926215">//&nbsp;Handle&nbsp;the&nbsp;case&nbsp;where&nbsp;&#34;\r\n&#34;&nbsp;straddles&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926271">if</span>&nbsp;<span class="builtinfunc" id="2926274">len</span><span class="op" id="2926277">(</span><span class="ident" id="2926278">line</span><span class="op" id="2926282">)</span>&nbsp;<span class="op" id="2926284">&gt;</span>&nbsp;<span class="num" id="2926286">0</span>&nbsp;<span class="op" id="2926288">&amp;&amp;</span>&nbsp;<span class="ident" id="2926291">line</span><span class="op" id="2926295">[</span><span class="builtinfunc" id="2926296">len</span><span class="op" id="2926299">(</span><span class="ident" id="2926300">line</span><span class="op" id="2926304">)</span><span class="op" id="2926305">-</span><span class="num" id="2926306">1</span><span class="op" id="2926307">]</span>&nbsp;<span class="op" id="2926309">==</span>&nbsp;<span class="string" id="2926312">&#39;\r&#39;</span>&nbsp;<span class="op" id="2926317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2926322">//&nbsp;Put&nbsp;the&nbsp;&#39;\r&#39;&nbsp;back&nbsp;on&nbsp;buf&nbsp;and&nbsp;drop&nbsp;it&nbsp;from&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2926376">//&nbsp;Let&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;ReadLine&nbsp;check&nbsp;for&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926430">if</span>&nbsp;<span class="ident" id="2926433">b</span><span class="op" id="2926434">.</span><span class="ident" id="2926435">r</span>&nbsp;<span class="op" id="2926437">==</span>&nbsp;<span class="num" id="2926440">0</span>&nbsp;<span class="op" id="2926442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2926448">//&nbsp;should&nbsp;be&nbsp;unreachable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2926477">panic</span><span class="op" id="2926482">(</span><span class="string" id="2926483">&#34;bufio:&nbsp;tried&nbsp;to&nbsp;rewind&nbsp;past&nbsp;start&nbsp;of&nbsp;buffer&#34;</span><span class="op" id="2926528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2926533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926538">b</span><span class="op" id="2926539">.</span><span class="ident" id="2926540">r</span><span class="op" id="2926541">--</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926547">line</span>&nbsp;<span class="op" id="2926552">=</span>&nbsp;<span class="ident" id="2926554">line</span><span class="op" id="2926558">[</span><span class="op" id="2926559">:</span><span class="builtinfunc" id="2926560">len</span><span class="op" id="2926563">(</span><span class="ident" id="2926564">line</span><span class="op" id="2926568">)</span><span class="op" id="2926569">-</span><span class="num" id="2926570">1</span><span class="op" id="2926571">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2926575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926579">return</span>&nbsp;<span class="ident" id="2926586">line</span><span class="op" id="2926590">,</span>&nbsp;<span class="builtintype" id="2926592">true</span><span class="op" id="2926596">,</span>&nbsp;<span class="ident" id="2926598">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2926603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926607">if</span>&nbsp;<span class="builtinfunc" id="2926610">len</span><span class="op" id="2926613">(</span><span class="ident" id="2926614">line</span><span class="op" id="2926618">)</span>&nbsp;<span class="op" id="2926620">==</span>&nbsp;<span class="num" id="2926623">0</span>&nbsp;<span class="op" id="2926625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926629">if</span>&nbsp;<span class="ident" id="2926632">err</span>&nbsp;<span class="op" id="2926636">!=</span>&nbsp;<span class="ident" id="2926639">nil</span>&nbsp;<span class="op" id="2926643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926648">line</span>&nbsp;<span class="op" id="2926653">=</span>&nbsp;<span class="ident" id="2926655">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2926661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926665">return</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2926673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926676">err</span>&nbsp;<span class="op" id="2926680">=</span>&nbsp;<span class="ident" id="2926682">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926688">if</span>&nbsp;<span class="ident" id="2926691">line</span><span class="op" id="2926695">[</span><span class="builtinfunc" id="2926696">len</span><span class="op" id="2926699">(</span><span class="ident" id="2926700">line</span><span class="op" id="2926704">)</span><span class="op" id="2926705">-</span><span class="num" id="2926706">1</span><span class="op" id="2926707">]</span>&nbsp;<span class="op" id="2926709">==</span>&nbsp;<span class="string" id="2926712">&#39;\n&#39;</span>&nbsp;<span class="op" id="2926717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926721">drop</span>&nbsp;<span class="op" id="2926726">:=</span>&nbsp;<span class="num" id="2926729">1</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926733">if</span>&nbsp;<span class="builtinfunc" id="2926736">len</span><span class="op" id="2926739">(</span><span class="ident" id="2926740">line</span><span class="op" id="2926744">)</span>&nbsp;<span class="op" id="2926746">&gt;</span>&nbsp;<span class="num" id="2926748">1</span>&nbsp;<span class="op" id="2926750">&amp;&amp;</span>&nbsp;<span class="ident" id="2926753">line</span><span class="op" id="2926757">[</span><span class="builtinfunc" id="2926758">len</span><span class="op" id="2926761">(</span><span class="ident" id="2926762">line</span><span class="op" id="2926766">)</span><span class="op" id="2926767">-</span><span class="num" id="2926768">2</span><span class="op" id="2926769">]</span>&nbsp;<span class="op" id="2926771">==</span>&nbsp;<span class="string" id="2926774">&#39;\r&#39;</span>&nbsp;<span class="op" id="2926779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926784">drop</span>&nbsp;<span class="op" id="2926789">=</span>&nbsp;<span class="num" id="2926791">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2926795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2926799">line</span>&nbsp;<span class="op" id="2926804">=</span>&nbsp;<span class="ident" id="2926806">line</span><span class="op" id="2926810">[</span><span class="op" id="2926811">:</span><span class="builtinfunc" id="2926812">len</span><span class="op" id="2926815">(</span><span class="ident" id="2926816">line</span><span class="op" id="2926820">)</span><span class="op" id="2926821">-</span><span class="ident" id="2926822">drop</span><span class="op" id="2926826">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2926829">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2926832">return</span><br>
<span class="lineno"></span><span class="op" id="2926839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2926842">//&nbsp;ReadBytes&nbsp;reads&nbsp;until&nbsp;the&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;delim&nbsp;in&nbsp;the&nbsp;input,</span><br>
<span class="lineno"></span><span class="comment" id="2926911">//&nbsp;returning&nbsp;a&nbsp;slice&nbsp;containing&nbsp;the&nbsp;data&nbsp;up&nbsp;to&nbsp;and&nbsp;including&nbsp;the&nbsp;delimiter.</span><br>
<span class="lineno">360</span><span class="comment" id="2926987">//&nbsp;If&nbsp;ReadBytes&nbsp;encounters&nbsp;an&nbsp;error&nbsp;before&nbsp;finding&nbsp;a&nbsp;delimiter,</span><br>
<span class="lineno"></span><span class="comment" id="2927051">//&nbsp;it&nbsp;returns&nbsp;the&nbsp;data&nbsp;read&nbsp;before&nbsp;the&nbsp;error&nbsp;and&nbsp;the&nbsp;error&nbsp;itself&nbsp;(often&nbsp;io.EOF).</span><br>
<span class="lineno"></span><span class="comment" id="2927133">//&nbsp;ReadBytes&nbsp;returns&nbsp;err&nbsp;!=&nbsp;nil&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;the&nbsp;returned&nbsp;data&nbsp;does&nbsp;not&nbsp;end&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="2927214">//&nbsp;delim.</span><br>
<span class="lineno"></span><span class="comment" id="2927224">//&nbsp;For&nbsp;simple&nbsp;uses,&nbsp;a&nbsp;Scanner&nbsp;may&nbsp;be&nbsp;more&nbsp;convenient.</span><br>
<span class="lineno">365</span><span class="keyword" id="2927278">func</span>&nbsp;<span class="op" id="2927283">(</span><span class="ident" id="2927284">b</span>&nbsp;<span class="op" id="2927286">*</span><span class="ident" id="2927287">Reader</span><span class="op" id="2927293">)</span>&nbsp;<span class="ident" id="2927295">ReadBytes</span><span class="op" id="2927304">(</span><span class="ident" id="2927305">delim</span>&nbsp;<span class="builtintype" id="2927311">byte</span><span class="op" id="2927315">)</span>&nbsp;<span class="op" id="2927317">(</span><span class="ident" id="2927318">line</span>&nbsp;<span class="op" id="2927323">[</span><span class="op" id="2927324">]</span><span class="builtintype" id="2927325">byte</span><span class="op" id="2927329">,</span>&nbsp;<span class="ident" id="2927331">err</span>&nbsp;<span class="builtintype" id="2927335">error</span><span class="op" id="2927340">)</span>&nbsp;<span class="op" id="2927342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2927345">//&nbsp;Use&nbsp;ReadSlice&nbsp;to&nbsp;look&nbsp;for&nbsp;array,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2927382">//&nbsp;accumulating&nbsp;full&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927413">var</span>&nbsp;<span class="ident" id="2927417">frag</span>&nbsp;<span class="op" id="2927422">[</span><span class="op" id="2927423">]</span><span class="builtintype" id="2927424">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927430">var</span>&nbsp;<span class="ident" id="2927434">full</span>&nbsp;<span class="op" id="2927439">[</span><span class="op" id="2927440">]</span><span class="op" id="2927441">[</span><span class="op" id="2927442">]</span><span class="builtintype" id="2927443">byte</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927449">err</span>&nbsp;<span class="op" id="2927453">=</span>&nbsp;<span class="ident" id="2927455">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927461">for</span>&nbsp;<span class="op" id="2927465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927469">var</span>&nbsp;<span class="ident" id="2927473">e</span>&nbsp;<span class="builtintype" id="2927475">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927483">frag</span><span class="op" id="2927487">,</span>&nbsp;<span class="ident" id="2927489">e</span>&nbsp;<span class="op" id="2927491">=</span>&nbsp;<span class="ident" id="2927493">b</span><span class="op" id="2927494">.</span><span class="ident" id="2927495">ReadSlice</span><span class="op" id="2927504">(</span><span class="ident" id="2927505">delim</span><span class="op" id="2927510">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927514">if</span>&nbsp;<span class="ident" id="2927517">e</span>&nbsp;<span class="op" id="2927519">==</span>&nbsp;<span class="ident" id="2927522">nil</span>&nbsp;<span class="op" id="2927526">{</span>&nbsp;<span class="comment" id="2927528">//&nbsp;got&nbsp;final&nbsp;fragment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927553">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927565">if</span>&nbsp;<span class="ident" id="2927568">e</span>&nbsp;<span class="op" id="2927570">!=</span>&nbsp;<span class="ident" id="2927573">ErrBufferFull</span>&nbsp;<span class="op" id="2927587">{</span>&nbsp;<span class="comment" id="2927589">//&nbsp;unexpected&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927612">err</span>&nbsp;<span class="op" id="2927616">=</span>&nbsp;<span class="ident" id="2927618">e</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927623">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2927636">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927668">buf</span>&nbsp;<span class="op" id="2927672">:=</span>&nbsp;<span class="builtinfunc" id="2927675">make</span><span class="op" id="2927679">(</span><span class="op" id="2927680">[</span><span class="op" id="2927681">]</span><span class="builtintype" id="2927682">byte</span><span class="op" id="2927686">,</span>&nbsp;<span class="builtinfunc" id="2927688">len</span><span class="op" id="2927691">(</span><span class="ident" id="2927692">frag</span><span class="op" id="2927696">)</span><span class="op" id="2927697">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2927701">copy</span><span class="op" id="2927705">(</span><span class="ident" id="2927706">buf</span><span class="op" id="2927709">,</span>&nbsp;<span class="ident" id="2927711">frag</span><span class="op" id="2927715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927719">full</span>&nbsp;<span class="op" id="2927724">=</span>&nbsp;<span class="builtinfunc" id="2927726">append</span><span class="op" id="2927732">(</span><span class="ident" id="2927733">full</span><span class="op" id="2927737">,</span>&nbsp;<span class="ident" id="2927739">buf</span><span class="op" id="2927742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2927749">//&nbsp;Allocate&nbsp;new&nbsp;buffer&nbsp;to&nbsp;hold&nbsp;the&nbsp;full&nbsp;pieces&nbsp;and&nbsp;the&nbsp;fragment.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927815">n</span>&nbsp;<span class="op" id="2927817">:=</span>&nbsp;<span class="num" id="2927820">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927823">for</span>&nbsp;<span class="ident" id="2927827">i</span>&nbsp;<span class="op" id="2927829">:=</span>&nbsp;<span class="keyword" id="2927832">range</span>&nbsp;<span class="ident" id="2927838">full</span>&nbsp;<span class="op" id="2927843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927847">n</span>&nbsp;<span class="op" id="2927849">+=</span>&nbsp;<span class="builtinfunc" id="2927852">len</span><span class="op" id="2927855">(</span><span class="ident" id="2927856">full</span><span class="op" id="2927860">[</span><span class="ident" id="2927861">i</span><span class="op" id="2927862">]</span><span class="op" id="2927863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2927866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927869">n</span>&nbsp;<span class="op" id="2927871">+=</span>&nbsp;<span class="builtinfunc" id="2927874">len</span><span class="op" id="2927877">(</span><span class="ident" id="2927878">frag</span><span class="op" id="2927882">)</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2927886">//&nbsp;Copy&nbsp;full&nbsp;pieces&nbsp;and&nbsp;fragment&nbsp;in.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927924">buf</span>&nbsp;<span class="op" id="2927928">:=</span>&nbsp;<span class="builtinfunc" id="2927931">make</span><span class="op" id="2927935">(</span><span class="op" id="2927936">[</span><span class="op" id="2927937">]</span><span class="builtintype" id="2927938">byte</span><span class="op" id="2927942">,</span>&nbsp;<span class="ident" id="2927944">n</span><span class="op" id="2927945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927948">n</span>&nbsp;<span class="op" id="2927950">=</span>&nbsp;<span class="num" id="2927952">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2927955">for</span>&nbsp;<span class="ident" id="2927959">i</span>&nbsp;<span class="op" id="2927961">:=</span>&nbsp;<span class="keyword" id="2927964">range</span>&nbsp;<span class="ident" id="2927970">full</span>&nbsp;<span class="op" id="2927975">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2927979">n</span>&nbsp;<span class="op" id="2927981">+=</span>&nbsp;<span class="builtinfunc" id="2927984">copy</span><span class="op" id="2927988">(</span><span class="ident" id="2927989">buf</span><span class="op" id="2927992">[</span><span class="ident" id="2927993">n</span><span class="op" id="2927994">:</span><span class="op" id="2927995">]</span><span class="op" id="2927996">,</span>&nbsp;<span class="ident" id="2927998">full</span><span class="op" id="2928002">[</span><span class="ident" id="2928003">i</span><span class="op" id="2928004">]</span><span class="op" id="2928005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2928008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2928011">copy</span><span class="op" id="2928015">(</span><span class="ident" id="2928016">buf</span><span class="op" id="2928019">[</span><span class="ident" id="2928020">n</span><span class="op" id="2928021">:</span><span class="op" id="2928022">]</span><span class="op" id="2928023">,</span>&nbsp;<span class="ident" id="2928025">frag</span><span class="op" id="2928029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2928032">return</span>&nbsp;<span class="ident" id="2928039">buf</span><span class="op" id="2928042">,</span>&nbsp;<span class="ident" id="2928044">err</span><br>
<span class="lineno"></span><span class="op" id="2928048">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span><span class="comment" id="2928051">//&nbsp;ReadString&nbsp;reads&nbsp;until&nbsp;the&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;delim&nbsp;in&nbsp;the&nbsp;input,</span><br>
<span class="lineno"></span><span class="comment" id="2928121">//&nbsp;returning&nbsp;a&nbsp;string&nbsp;containing&nbsp;the&nbsp;data&nbsp;up&nbsp;to&nbsp;and&nbsp;including&nbsp;the&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="2928198">//&nbsp;If&nbsp;ReadString&nbsp;encounters&nbsp;an&nbsp;error&nbsp;before&nbsp;finding&nbsp;a&nbsp;delimiter,</span><br>
<span class="lineno"></span><span class="comment" id="2928263">//&nbsp;it&nbsp;returns&nbsp;the&nbsp;data&nbsp;read&nbsp;before&nbsp;the&nbsp;error&nbsp;and&nbsp;the&nbsp;error&nbsp;itself&nbsp;(often&nbsp;io.EOF).</span><br>
<span class="lineno">410</span><span class="comment" id="2928345">//&nbsp;ReadString&nbsp;returns&nbsp;err&nbsp;!=&nbsp;nil&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;the&nbsp;returned&nbsp;data&nbsp;does&nbsp;not&nbsp;end&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="2928427">//&nbsp;delim.</span><br>
<span class="lineno"></span><span class="comment" id="2928437">//&nbsp;For&nbsp;simple&nbsp;uses,&nbsp;a&nbsp;Scanner&nbsp;may&nbsp;be&nbsp;more&nbsp;convenient.</span><br>
<span class="lineno"></span><span class="keyword" id="2928491">func</span>&nbsp;<span class="op" id="2928496">(</span><span class="ident" id="2928497">b</span>&nbsp;<span class="op" id="2928499">*</span><span class="ident" id="2928500">Reader</span><span class="op" id="2928506">)</span>&nbsp;<span class="ident" id="2928508">ReadString</span><span class="op" id="2928518">(</span><span class="ident" id="2928519">delim</span>&nbsp;<span class="builtintype" id="2928525">byte</span><span class="op" id="2928529">)</span>&nbsp;<span class="op" id="2928531">(</span><span class="ident" id="2928532">line</span>&nbsp;<span class="builtintype" id="2928537">string</span><span class="op" id="2928543">,</span>&nbsp;<span class="ident" id="2928545">err</span>&nbsp;<span class="builtintype" id="2928549">error</span><span class="op" id="2928554">)</span>&nbsp;<span class="op" id="2928556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2928559">bytes</span><span class="op" id="2928564">,</span>&nbsp;<span class="ident" id="2928566">err</span>&nbsp;<span class="op" id="2928570">:=</span>&nbsp;<span class="ident" id="2928573">b</span><span class="op" id="2928574">.</span><span class="ident" id="2928575">ReadBytes</span><span class="op" id="2928584">(</span><span class="ident" id="2928585">delim</span><span class="op" id="2928590">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2928593">line</span>&nbsp;<span class="op" id="2928598">=</span>&nbsp;<span class="builtintype" id="2928600">string</span><span class="op" id="2928606">(</span><span class="ident" id="2928607">bytes</span><span class="op" id="2928612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2928615">return</span>&nbsp;<span class="ident" id="2928622">line</span><span class="op" id="2928626">,</span>&nbsp;<span class="ident" id="2928628">err</span><br>
<span class="lineno"></span><span class="op" id="2928632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2928635">//&nbsp;WriteTo&nbsp;implements&nbsp;io.WriterTo.</span><br>
<span class="lineno">420</span><span class="keyword" id="2928670">func</span>&nbsp;<span class="op" id="2928675">(</span><span class="ident" id="2928676">b</span>&nbsp;<span class="op" id="2928678">*</span><span class="ident" id="2928679">Reader</span><span class="op" id="2928685">)</span>&nbsp;<span class="ident" id="2928687">WriteTo</span><span class="op" id="2928694">(</span><span class="ident" id="2928695">w</span>&nbsp;<span class="ident" id="2928697">io</span><span class="op" id="2928699">.</span><span class="ident" id="2928700">Writer</span><span class="op" id="2928706">)</span>&nbsp;<span class="op" id="2928708">(</span><span class="ident" id="2928709">n</span>&nbsp;<span class="ident" id="2928711">int64</span><span class="op" id="2928716">,</span>&nbsp;<span class="ident" id="2928718">err</span>&nbsp;<span class="builtintype" id="2928722">error</span><span class="op" id="2928727">)</span>&nbsp;<span class="op" id="2928729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2928732">n</span><span class="op" id="2928733">,</span>&nbsp;<span class="ident" id="2928735">err</span>&nbsp;<span class="op" id="2928739">=</span>&nbsp;<span class="ident" id="2928741">b</span><span class="op" id="2928742">.</span><span class="ident" id="2928743">writeBuf</span><span class="op" id="2928751">(</span><span class="ident" id="2928752">w</span><span class="op" id="2928753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2928756">if</span>&nbsp;<span class="ident" id="2928759">err</span>&nbsp;<span class="op" id="2928763">!=</span>&nbsp;<span class="ident" id="2928766">nil</span>&nbsp;<span class="op" id="2928770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2928774">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2928782">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2928786">if</span>&nbsp;<span class="ident" id="2928789">r</span><span class="op" id="2928790">,</span>&nbsp;<span class="ident" id="2928792">ok</span>&nbsp;<span class="op" id="2928795">:=</span>&nbsp;<span class="ident" id="2928798">b</span><span class="op" id="2928799">.</span><span class="ident" id="2928800">rd</span><span class="op" id="2928802">.</span><span class="op" id="2928803">(</span><span class="ident" id="2928804">io</span><span class="op" id="2928806">.</span><span class="ident" id="2928807">WriterTo</span><span class="op" id="2928815">)</span><span class="op" id="2928816">;</span>&nbsp;<span class="ident" id="2928818">ok</span>&nbsp;<span class="op" id="2928821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2928825">m</span><span class="op" id="2928826">,</span>&nbsp;<span class="ident" id="2928828">err</span>&nbsp;<span class="op" id="2928832">:=</span>&nbsp;<span class="ident" id="2928835">r</span><span class="op" id="2928836">.</span><span class="ident" id="2928837">WriteTo</span><span class="op" id="2928844">(</span><span class="ident" id="2928845">w</span><span class="op" id="2928846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2928850">n</span>&nbsp;<span class="op" id="2928852">+=</span>&nbsp;<span class="ident" id="2928855">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2928859">return</span>&nbsp;<span class="ident" id="2928866">n</span><span class="op" id="2928867">,</span>&nbsp;<span class="ident" id="2928869">err</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2928874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2928878">if</span>&nbsp;<span class="ident" id="2928881">w</span><span class="op" id="2928882">,</span>&nbsp;<span class="ident" id="2928884">ok</span>&nbsp;<span class="op" id="2928887">:=</span>&nbsp;<span class="ident" id="2928890">w</span><span class="op" id="2928891">.</span><span class="op" id="2928892">(</span><span class="ident" id="2928893">io</span><span class="op" id="2928895">.</span><span class="ident" id="2928896">ReaderFrom</span><span class="op" id="2928906">)</span><span class="op" id="2928907">;</span>&nbsp;<span class="ident" id="2928909">ok</span>&nbsp;<span class="op" id="2928912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2928916">m</span><span class="op" id="2928917">,</span>&nbsp;<span class="ident" id="2928919">err</span>&nbsp;<span class="op" id="2928923">:=</span>&nbsp;<span class="ident" id="2928926">w</span><span class="op" id="2928927">.</span><span class="ident" id="2928928">ReadFrom</span><span class="op" id="2928936">(</span><span class="ident" id="2928937">b</span><span class="op" id="2928938">.</span><span class="ident" id="2928939">rd</span><span class="op" id="2928941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2928945">n</span>&nbsp;<span class="op" id="2928947">+=</span>&nbsp;<span class="ident" id="2928950">m</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2928954">return</span>&nbsp;<span class="ident" id="2928961">n</span><span class="op" id="2928962">,</span>&nbsp;<span class="ident" id="2928964">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2928969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2928973">if</span>&nbsp;<span class="ident" id="2928976">b</span><span class="op" id="2928977">.</span><span class="ident" id="2928978">w</span><span class="op" id="2928979">-</span><span class="ident" id="2928980">b</span><span class="op" id="2928981">.</span><span class="ident" id="2928982">r</span>&nbsp;<span class="op" id="2928984">&lt;</span>&nbsp;<span class="builtinfunc" id="2928986">len</span><span class="op" id="2928989">(</span><span class="ident" id="2928990">b</span><span class="op" id="2928991">.</span><span class="ident" id="2928992">buf</span><span class="op" id="2928995">)</span>&nbsp;<span class="op" id="2928997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2929001">b</span><span class="op" id="2929002">.</span><span class="ident" id="2929003">fill</span><span class="op" id="2929007">(</span><span class="op" id="2929008">)</span>&nbsp;<span class="comment" id="2929010">//&nbsp;buffer&nbsp;not&nbsp;full</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2929030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2929034">for</span>&nbsp;<span class="ident" id="2929038">b</span><span class="op" id="2929039">.</span><span class="ident" id="2929040">r</span>&nbsp;<span class="op" id="2929042">&lt;</span>&nbsp;<span class="ident" id="2929044">b</span><span class="op" id="2929045">.</span><span class="ident" id="2929046">w</span>&nbsp;<span class="op" id="2929048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2929052">//&nbsp;b.r&nbsp;&lt;&nbsp;b.w&nbsp;=&gt;&nbsp;buffer&nbsp;is&nbsp;not&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2929090">m</span><span class="op" id="2929091">,</span>&nbsp;<span class="ident" id="2929093">err</span>&nbsp;<span class="op" id="2929097">:=</span>&nbsp;<span class="ident" id="2929100">b</span><span class="op" id="2929101">.</span><span class="ident" id="2929102">writeBuf</span><span class="op" id="2929110">(</span><span class="ident" id="2929111">w</span><span class="op" id="2929112">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2929116">n</span>&nbsp;<span class="op" id="2929118">+=</span>&nbsp;<span class="ident" id="2929121">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2929125">if</span>&nbsp;<span class="ident" id="2929128">err</span>&nbsp;<span class="op" id="2929132">!=</span>&nbsp;<span class="ident" id="2929135">nil</span>&nbsp;<span class="op" id="2929139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2929144">return</span>&nbsp;<span class="ident" id="2929151">n</span><span class="op" id="2929152">,</span>&nbsp;<span class="ident" id="2929154">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2929160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2929164">b</span><span class="op" id="2929165">.</span><span class="ident" id="2929166">fill</span><span class="op" id="2929170">(</span><span class="op" id="2929171">)</span>&nbsp;<span class="comment" id="2929173">//&nbsp;buffer&nbsp;is&nbsp;empty</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2929193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2929197">if</span>&nbsp;<span class="ident" id="2929200">b</span><span class="op" id="2929201">.</span><span class="ident" id="2929202">err</span>&nbsp;<span class="op" id="2929206">==</span>&nbsp;<span class="ident" id="2929209">io</span><span class="op" id="2929211">.</span><span class="ident" id="2929212">EOF</span>&nbsp;<span class="op" id="2929216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2929220">b</span><span class="op" id="2929221">.</span><span class="ident" id="2929222">err</span>&nbsp;<span class="op" id="2929226">=</span>&nbsp;<span class="ident" id="2929228">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2929233">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2929237">return</span>&nbsp;<span class="ident" id="2929244">n</span><span class="op" id="2929245">,</span>&nbsp;<span class="ident" id="2929247">b</span><span class="op" id="2929248">.</span><span class="ident" id="2929249">readErr</span><span class="op" id="2929256">(</span><span class="op" id="2929257">)</span><br>
<span class="lineno"></span><span class="op" id="2929259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2929262">var</span>&nbsp;<span class="ident" id="2929266">errNegativeWrite</span>&nbsp;<span class="op" id="2929283">=</span>&nbsp;<span class="ident" id="2929285">errors</span><span class="op" id="2929291">.</span><span class="ident" id="2929292">New</span><span class="op" id="2929295">(</span><span class="string" id="2929296">&#34;bufio:&nbsp;writer&nbsp;returned&nbsp;negative&nbsp;count&nbsp;from&nbsp;Write&#34;</span><span class="op" id="2929346">)</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="comment" id="2929349">//&nbsp;writeBuf&nbsp;writes&nbsp;the&nbsp;Reader&#39;s&nbsp;buffer&nbsp;to&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="2929403">func</span>&nbsp;<span class="op" id="2929408">(</span><span class="ident" id="2929409">b</span>&nbsp;<span class="op" id="2929411">*</span><span class="ident" id="2929412">Reader</span><span class="op" id="2929418">)</span>&nbsp;<span class="ident" id="2929420">writeBuf</span><span class="op" id="2929428">(</span><span class="ident" id="2929429">w</span>&nbsp;<span class="ident" id="2929431">io</span><span class="op" id="2929433">.</span><span class="ident" id="2929434">Writer</span><span class="op" id="2929440">)</span>&nbsp;<span class="op" id="2929442">(</span><span class="ident" id="2929443">int64</span><span class="op" id="2929448">,</span>&nbsp;<span class="builtintype" id="2929450">error</span><span class="op" id="2929455">)</span>&nbsp;<span class="op" id="2929457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2929460">n</span><span class="op" id="2929461">,</span>&nbsp;<span class="ident" id="2929463">err</span>&nbsp;<span class="op" id="2929467">:=</span>&nbsp;<span class="ident" id="2929470">w</span><span class="op" id="2929471">.</span><span class="ident" id="2929472">Write</span><span class="op" id="2929477">(</span><span class="ident" id="2929478">b</span><span class="op" id="2929479">.</span><span class="ident" id="2929480">buf</span><span class="op" id="2929483">[</span><span class="ident" id="2929484">b</span><span class="op" id="2929485">.</span><span class="ident" id="2929486">r</span><span class="op" id="2929487">:</span><span class="ident" id="2929488">b</span><span class="op" id="2929489">.</span><span class="ident" id="2929490">w</span><span class="op" id="2929491">]</span><span class="op" id="2929492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2929495">if</span>&nbsp;<span class="ident" id="2929498">n</span>&nbsp;<span class="op" id="2929500">&lt;</span>&nbsp;<span class="num" id="2929502">0</span>&nbsp;<span class="op" id="2929504">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2929508">panic</span><span class="op" id="2929513">(</span><span class="ident" id="2929514">errNegativeWrite</span><span class="op" id="2929530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2929533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2929536">b</span><span class="op" id="2929537">.</span><span class="ident" id="2929538">r</span>&nbsp;<span class="op" id="2929540">+=</span>&nbsp;<span class="ident" id="2929543">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2929546">return</span>&nbsp;<span class="ident" id="2929553">int64</span><span class="op" id="2929558">(</span><span class="ident" id="2929559">n</span><span class="op" id="2929560">)</span><span class="op" id="2929561">,</span>&nbsp;<span class="ident" id="2929563">err</span><br>
<span class="lineno"></span><span class="op" id="2929567">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="2929570">//&nbsp;buffered&nbsp;output</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2929590">//&nbsp;Writer&nbsp;implements&nbsp;buffering&nbsp;for&nbsp;an&nbsp;io.Writer&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="2929646">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;writing&nbsp;to&nbsp;a&nbsp;Writer,&nbsp;no&nbsp;more&nbsp;data&nbsp;will&nbsp;be</span><br>
<span class="lineno">475</span><span class="comment" id="2929710">//&nbsp;accepted&nbsp;and&nbsp;all&nbsp;subsequent&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="2929771">//&nbsp;After&nbsp;all&nbsp;data&nbsp;has&nbsp;been&nbsp;written,&nbsp;the&nbsp;client&nbsp;should&nbsp;call&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2929834">//&nbsp;Flush&nbsp;method&nbsp;to&nbsp;guarantee&nbsp;all&nbsp;data&nbsp;has&nbsp;been&nbsp;forwarded&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2929894">//&nbsp;the&nbsp;underlying&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="2929923">type</span>&nbsp;<span class="ident" id="2929928">Writer</span>&nbsp;<span class="keyword" id="2929935">struct</span>&nbsp;<span class="op" id="2929942">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2929945">err</span>&nbsp;<span class="builtintype" id="2929949">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2929956">buf</span>&nbsp;<span class="op" id="2929960">[</span><span class="op" id="2929961">]</span><span class="builtintype" id="2929962">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2929968">n</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2929972">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2929977">wr</span>&nbsp;&nbsp;<span class="ident" id="2929981">io</span><span class="op" id="2929983">.</span><span class="ident" id="2929984">Writer</span><br>
<span class="lineno"></span><span class="op" id="2929991">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="2929994">//&nbsp;NewWriterSize&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;at&nbsp;least&nbsp;the&nbsp;specified</span><br>
<span class="lineno"></span><span class="comment" id="2930072">//&nbsp;size.&nbsp;If&nbsp;the&nbsp;argument&nbsp;io.Writer&nbsp;is&nbsp;already&nbsp;a&nbsp;Writer&nbsp;with&nbsp;large&nbsp;enough</span><br>
<span class="lineno"></span><span class="comment" id="2930145">//&nbsp;size,&nbsp;it&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="2930188">func</span>&nbsp;<span class="ident" id="2930193">NewWriterSize</span><span class="op" id="2930206">(</span><span class="ident" id="2930207">w</span>&nbsp;<span class="ident" id="2930209">io</span><span class="op" id="2930211">.</span><span class="ident" id="2930212">Writer</span><span class="op" id="2930218">,</span>&nbsp;<span class="ident" id="2930220">size</span>&nbsp;<span class="builtintype" id="2930225">int</span><span class="op" id="2930228">)</span>&nbsp;<span class="op" id="2930230">*</span><span class="ident" id="2930231">Writer</span>&nbsp;<span class="op" id="2930238">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2930241">//&nbsp;Is&nbsp;it&nbsp;already&nbsp;a&nbsp;Writer?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2930269">b</span><span class="op" id="2930270">,</span>&nbsp;<span class="ident" id="2930272">ok</span>&nbsp;<span class="op" id="2930275">:=</span>&nbsp;<span class="ident" id="2930278">w</span><span class="op" id="2930279">.</span><span class="op" id="2930280">(</span><span class="op" id="2930281">*</span><span class="ident" id="2930282">Writer</span><span class="op" id="2930288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2930291">if</span>&nbsp;<span class="ident" id="2930294">ok</span>&nbsp;<span class="op" id="2930297">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2930300">len</span><span class="op" id="2930303">(</span><span class="ident" id="2930304">b</span><span class="op" id="2930305">.</span><span class="ident" id="2930306">buf</span><span class="op" id="2930309">)</span>&nbsp;<span class="op" id="2930311">&gt;=</span>&nbsp;<span class="ident" id="2930314">size</span>&nbsp;<span class="op" id="2930319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2930323">return</span>&nbsp;<span class="ident" id="2930330">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2930333">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2930336">if</span>&nbsp;<span class="ident" id="2930339">size</span>&nbsp;<span class="op" id="2930344">&lt;=</span>&nbsp;<span class="num" id="2930347">0</span>&nbsp;<span class="op" id="2930349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2930353">size</span>&nbsp;<span class="op" id="2930358">=</span>&nbsp;<span class="ident" id="2930360">defaultBufSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2930376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2930379">return</span>&nbsp;<span class="op" id="2930386">&amp;</span><span class="ident" id="2930387">Writer</span><span class="op" id="2930393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2930397">buf</span><span class="op" id="2930400">:</span>&nbsp;<span class="builtinfunc" id="2930402">make</span><span class="op" id="2930406">(</span><span class="op" id="2930407">[</span><span class="op" id="2930408">]</span><span class="builtintype" id="2930409">byte</span><span class="op" id="2930413">,</span>&nbsp;<span class="ident" id="2930415">size</span><span class="op" id="2930419">)</span><span class="op" id="2930420">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2930424">wr</span><span class="op" id="2930426">:</span>&nbsp;&nbsp;<span class="ident" id="2930429">w</span><span class="op" id="2930430">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2930433">}</span><br>
<span class="lineno"></span><span class="op" id="2930435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2930438">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;the&nbsp;default&nbsp;size.</span><br>
<span class="lineno">505</span><span class="keyword" id="2930507">func</span>&nbsp;<span class="ident" id="2930512">NewWriter</span><span class="op" id="2930521">(</span><span class="ident" id="2930522">w</span>&nbsp;<span class="ident" id="2930524">io</span><span class="op" id="2930526">.</span><span class="ident" id="2930527">Writer</span><span class="op" id="2930533">)</span>&nbsp;<span class="op" id="2930535">*</span><span class="ident" id="2930536">Writer</span>&nbsp;<span class="op" id="2930543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2930546">return</span>&nbsp;<span class="ident" id="2930553">NewWriterSize</span><span class="op" id="2930566">(</span><span class="ident" id="2930567">w</span><span class="op" id="2930568">,</span>&nbsp;<span class="ident" id="2930570">defaultBufSize</span><span class="op" id="2930584">)</span><br>
<span class="lineno"></span><span class="op" id="2930586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2930589">//&nbsp;Reset&nbsp;discards&nbsp;any&nbsp;unflushed&nbsp;buffered&nbsp;data,&nbsp;clears&nbsp;any&nbsp;error,&nbsp;and</span><br>
<span class="lineno">510</span><span class="comment" id="2930658">//&nbsp;resets&nbsp;b&nbsp;to&nbsp;write&nbsp;its&nbsp;output&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="2930696">func</span>&nbsp;<span class="op" id="2930701">(</span><span class="ident" id="2930702">b</span>&nbsp;<span class="op" id="2930704">*</span><span class="ident" id="2930705">Writer</span><span class="op" id="2930711">)</span>&nbsp;<span class="ident" id="2930713">Reset</span><span class="op" id="2930718">(</span><span class="ident" id="2930719">w</span>&nbsp;<span class="ident" id="2930721">io</span><span class="op" id="2930723">.</span><span class="ident" id="2930724">Writer</span><span class="op" id="2930730">)</span>&nbsp;<span class="op" id="2930732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2930735">b</span><span class="op" id="2930736">.</span><span class="ident" id="2930737">err</span>&nbsp;<span class="op" id="2930741">=</span>&nbsp;<span class="ident" id="2930743">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2930748">b</span><span class="op" id="2930749">.</span><span class="ident" id="2930750">n</span>&nbsp;<span class="op" id="2930752">=</span>&nbsp;<span class="num" id="2930754">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2930757">b</span><span class="op" id="2930758">.</span><span class="ident" id="2930759">wr</span>&nbsp;<span class="op" id="2930762">=</span>&nbsp;<span class="ident" id="2930764">w</span><br>
<span class="lineno">515</span><span class="op" id="2930766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2930769">//&nbsp;Flush&nbsp;writes&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="2930832">func</span>&nbsp;<span class="op" id="2930837">(</span><span class="ident" id="2930838">b</span>&nbsp;<span class="op" id="2930840">*</span><span class="ident" id="2930841">Writer</span><span class="op" id="2930847">)</span>&nbsp;<span class="ident" id="2930849">Flush</span><span class="op" id="2930854">(</span><span class="op" id="2930855">)</span>&nbsp;<span class="builtintype" id="2930857">error</span>&nbsp;<span class="op" id="2930863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2930866">err</span>&nbsp;<span class="op" id="2930870">:=</span>&nbsp;<span class="ident" id="2930873">b</span><span class="op" id="2930874">.</span><span class="ident" id="2930875">flush</span><span class="op" id="2930880">(</span><span class="op" id="2930881">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2930884">return</span>&nbsp;<span class="ident" id="2930891">err</span><br>
<span class="lineno"></span><span class="op" id="2930895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2930898">func</span>&nbsp;<span class="op" id="2930903">(</span><span class="ident" id="2930904">b</span>&nbsp;<span class="op" id="2930906">*</span><span class="ident" id="2930907">Writer</span><span class="op" id="2930913">)</span>&nbsp;<span class="ident" id="2930915">flush</span><span class="op" id="2930920">(</span><span class="op" id="2930921">)</span>&nbsp;<span class="builtintype" id="2930923">error</span>&nbsp;<span class="op" id="2930929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2930932">if</span>&nbsp;<span class="ident" id="2930935">b</span><span class="op" id="2930936">.</span><span class="ident" id="2930937">err</span>&nbsp;<span class="op" id="2930941">!=</span>&nbsp;<span class="ident" id="2930944">nil</span>&nbsp;<span class="op" id="2930948">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2930952">return</span>&nbsp;<span class="ident" id="2930959">b</span><span class="op" id="2930960">.</span><span class="ident" id="2930961">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2930966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2930969">if</span>&nbsp;<span class="ident" id="2930972">b</span><span class="op" id="2930973">.</span><span class="ident" id="2930974">n</span>&nbsp;<span class="op" id="2930976">==</span>&nbsp;<span class="num" id="2930979">0</span>&nbsp;<span class="op" id="2930981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2930985">return</span>&nbsp;<span class="ident" id="2930992">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2930997">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2931000">n</span><span class="op" id="2931001">,</span>&nbsp;<span class="ident" id="2931003">err</span>&nbsp;<span class="op" id="2931007">:=</span>&nbsp;<span class="ident" id="2931010">b</span><span class="op" id="2931011">.</span><span class="ident" id="2931012">wr</span><span class="op" id="2931014">.</span><span class="ident" id="2931015">Write</span><span class="op" id="2931020">(</span><span class="ident" id="2931021">b</span><span class="op" id="2931022">.</span><span class="ident" id="2931023">buf</span><span class="op" id="2931026">[</span><span class="num" id="2931027">0</span><span class="op" id="2931028">:</span><span class="ident" id="2931029">b</span><span class="op" id="2931030">.</span><span class="ident" id="2931031">n</span><span class="op" id="2931032">]</span><span class="op" id="2931033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2931036">if</span>&nbsp;<span class="ident" id="2931039">n</span>&nbsp;<span class="op" id="2931041">&lt;</span>&nbsp;<span class="ident" id="2931043">b</span><span class="op" id="2931044">.</span><span class="ident" id="2931045">n</span>&nbsp;<span class="op" id="2931047">&amp;&amp;</span>&nbsp;<span class="ident" id="2931050">err</span>&nbsp;<span class="op" id="2931054">==</span>&nbsp;<span class="ident" id="2931057">nil</span>&nbsp;<span class="op" id="2931061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2931065">err</span>&nbsp;<span class="op" id="2931069">=</span>&nbsp;<span class="ident" id="2931071">io</span><span class="op" id="2931073">.</span><span class="ident" id="2931074">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2931089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2931092">if</span>&nbsp;<span class="ident" id="2931095">err</span>&nbsp;<span class="op" id="2931099">!=</span>&nbsp;<span class="ident" id="2931102">nil</span>&nbsp;<span class="op" id="2931106">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2931110">if</span>&nbsp;<span class="ident" id="2931113">n</span>&nbsp;<span class="op" id="2931115">&gt;</span>&nbsp;<span class="num" id="2931117">0</span>&nbsp;<span class="op" id="2931119">&amp;&amp;</span>&nbsp;<span class="ident" id="2931122">n</span>&nbsp;<span class="op" id="2931124">&lt;</span>&nbsp;<span class="ident" id="2931126">b</span><span class="op" id="2931127">.</span><span class="ident" id="2931128">n</span>&nbsp;<span class="op" id="2931130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2931135">copy</span><span class="op" id="2931139">(</span><span class="ident" id="2931140">b</span><span class="op" id="2931141">.</span><span class="ident" id="2931142">buf</span><span class="op" id="2931145">[</span><span class="num" id="2931146">0</span><span class="op" id="2931147">:</span><span class="ident" id="2931148">b</span><span class="op" id="2931149">.</span><span class="ident" id="2931150">n</span><span class="op" id="2931151">-</span><span class="ident" id="2931152">n</span><span class="op" id="2931153">]</span><span class="op" id="2931154">,</span>&nbsp;<span class="ident" id="2931156">b</span><span class="op" id="2931157">.</span><span class="ident" id="2931158">buf</span><span class="op" id="2931161">[</span><span class="ident" id="2931162">n</span><span class="op" id="2931163">:</span><span class="ident" id="2931164">b</span><span class="op" id="2931165">.</span><span class="ident" id="2931166">n</span><span class="op" id="2931167">]</span><span class="op" id="2931168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2931172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2931176">b</span><span class="op" id="2931177">.</span><span class="ident" id="2931178">n</span>&nbsp;<span class="op" id="2931180">-=</span>&nbsp;<span class="ident" id="2931183">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2931187">b</span><span class="op" id="2931188">.</span><span class="ident" id="2931189">err</span>&nbsp;<span class="op" id="2931193">=</span>&nbsp;<span class="ident" id="2931195">err</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2931201">return</span>&nbsp;<span class="ident" id="2931208">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2931213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2931216">b</span><span class="op" id="2931217">.</span><span class="ident" id="2931218">n</span>&nbsp;<span class="op" id="2931220">=</span>&nbsp;<span class="num" id="2931222">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2931225">return</span>&nbsp;<span class="ident" id="2931232">nil</span><br>
<span class="lineno"></span><span class="op" id="2931236">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment" id="2931239">//&nbsp;Available&nbsp;returns&nbsp;how&nbsp;many&nbsp;bytes&nbsp;are&nbsp;unused&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="2931301">func</span>&nbsp;<span class="op" id="2931306">(</span><span class="ident" id="2931307">b</span>&nbsp;<span class="op" id="2931309">*</span><span class="ident" id="2931310">Writer</span><span class="op" id="2931316">)</span>&nbsp;<span class="ident" id="2931318">Available</span><span class="op" id="2931327">(</span><span class="op" id="2931328">)</span>&nbsp;<span class="builtintype" id="2931330">int</span>&nbsp;<span class="op" id="2931334">{</span>&nbsp;<span class="keyword" id="2931336">return</span>&nbsp;<span class="builtinfunc" id="2931343">len</span><span class="op" id="2931346">(</span><span class="ident" id="2931347">b</span><span class="op" id="2931348">.</span><span class="ident" id="2931349">buf</span><span class="op" id="2931352">)</span>&nbsp;<span class="op" id="2931354">-</span>&nbsp;<span class="ident" id="2931356">b</span><span class="op" id="2931357">.</span><span class="ident" id="2931358">n</span>&nbsp;<span class="op" id="2931360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2931363">//&nbsp;Buffered&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;that&nbsp;have&nbsp;been&nbsp;written&nbsp;into&nbsp;the&nbsp;current&nbsp;buffer.</span><br>
<span class="lineno">550</span><span class="keyword" id="2931451">func</span>&nbsp;<span class="op" id="2931456">(</span><span class="ident" id="2931457">b</span>&nbsp;<span class="op" id="2931459">*</span><span class="ident" id="2931460">Writer</span><span class="op" id="2931466">)</span>&nbsp;<span class="ident" id="2931468">Buffered</span><span class="op" id="2931476">(</span><span class="op" id="2931477">)</span>&nbsp;<span class="builtintype" id="2931479">int</span>&nbsp;<span class="op" id="2931483">{</span>&nbsp;<span class="keyword" id="2931485">return</span>&nbsp;<span class="ident" id="2931492">b</span><span class="op" id="2931493">.</span><span class="ident" id="2931494">n</span>&nbsp;<span class="op" id="2931496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2931499">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;contents&nbsp;of&nbsp;p&nbsp;into&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="2931550">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="2931593">//&nbsp;If&nbsp;nn&nbsp;&lt;&nbsp;len(p),&nbsp;it&nbsp;also&nbsp;returns&nbsp;an&nbsp;error&nbsp;explaining</span><br>
<span class="lineno">555</span><span class="comment" id="2931648">//&nbsp;why&nbsp;the&nbsp;write&nbsp;is&nbsp;short.</span><br>
<span class="lineno"></span><span class="keyword" id="2931675">func</span>&nbsp;<span class="op" id="2931680">(</span><span class="ident" id="2931681">b</span>&nbsp;<span class="op" id="2931683">*</span><span class="ident" id="2931684">Writer</span><span class="op" id="2931690">)</span>&nbsp;<span class="ident" id="2931692">Write</span><span class="op" id="2931697">(</span><span class="ident" id="2931698">p</span>&nbsp;<span class="op" id="2931700">[</span><span class="op" id="2931701">]</span><span class="builtintype" id="2931702">byte</span><span class="op" id="2931706">)</span>&nbsp;<span class="op" id="2931708">(</span><span class="ident" id="2931709">nn</span>&nbsp;<span class="builtintype" id="2931712">int</span><span class="op" id="2931715">,</span>&nbsp;<span class="ident" id="2931717">err</span>&nbsp;<span class="builtintype" id="2931721">error</span><span class="op" id="2931726">)</span>&nbsp;<span class="op" id="2931728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2931731">for</span>&nbsp;<span class="builtinfunc" id="2931735">len</span><span class="op" id="2931738">(</span><span class="ident" id="2931739">p</span><span class="op" id="2931740">)</span>&nbsp;<span class="op" id="2931742">&gt;</span>&nbsp;<span class="ident" id="2931744">b</span><span class="op" id="2931745">.</span><span class="ident" id="2931746">Available</span><span class="op" id="2931755">(</span><span class="op" id="2931756">)</span>&nbsp;<span class="op" id="2931758">&amp;&amp;</span>&nbsp;<span class="ident" id="2931761">b</span><span class="op" id="2931762">.</span><span class="ident" id="2931763">err</span>&nbsp;<span class="op" id="2931767">==</span>&nbsp;<span class="ident" id="2931770">nil</span>&nbsp;<span class="op" id="2931774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2931778">var</span>&nbsp;<span class="ident" id="2931782">n</span>&nbsp;<span class="builtintype" id="2931784">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2931790">if</span>&nbsp;<span class="ident" id="2931793">b</span><span class="op" id="2931794">.</span><span class="ident" id="2931795">Buffered</span><span class="op" id="2931803">(</span><span class="op" id="2931804">)</span>&nbsp;<span class="op" id="2931806">==</span>&nbsp;<span class="num" id="2931809">0</span>&nbsp;<span class="op" id="2931811">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2931816">//&nbsp;Large&nbsp;write,&nbsp;empty&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2931849">//&nbsp;Write&nbsp;directly&nbsp;from&nbsp;p&nbsp;to&nbsp;avoid&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2931892">n</span><span class="op" id="2931893">,</span>&nbsp;<span class="ident" id="2931895">b</span><span class="op" id="2931896">.</span><span class="ident" id="2931897">err</span>&nbsp;<span class="op" id="2931901">=</span>&nbsp;<span class="ident" id="2931903">b</span><span class="op" id="2931904">.</span><span class="ident" id="2931905">wr</span><span class="op" id="2931907">.</span><span class="ident" id="2931908">Write</span><span class="op" id="2931913">(</span><span class="ident" id="2931914">p</span><span class="op" id="2931915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2931919">}</span>&nbsp;<span class="keyword" id="2931921">else</span>&nbsp;<span class="op" id="2931926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2931931">n</span>&nbsp;<span class="op" id="2931933">=</span>&nbsp;<span class="builtinfunc" id="2931935">copy</span><span class="op" id="2931939">(</span><span class="ident" id="2931940">b</span><span class="op" id="2931941">.</span><span class="ident" id="2931942">buf</span><span class="op" id="2931945">[</span><span class="ident" id="2931946">b</span><span class="op" id="2931947">.</span><span class="ident" id="2931948">n</span><span class="op" id="2931949">:</span><span class="op" id="2931950">]</span><span class="op" id="2931951">,</span>&nbsp;<span class="ident" id="2931953">p</span><span class="op" id="2931954">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2931959">b</span><span class="op" id="2931960">.</span><span class="ident" id="2931961">n</span>&nbsp;<span class="op" id="2931963">+=</span>&nbsp;<span class="ident" id="2931966">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2931971">b</span><span class="op" id="2931972">.</span><span class="ident" id="2931973">flush</span><span class="op" id="2931978">(</span><span class="op" id="2931979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2931983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2931987">nn</span>&nbsp;<span class="op" id="2931990">+=</span>&nbsp;<span class="ident" id="2931993">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2931997">p</span>&nbsp;<span class="op" id="2931999">=</span>&nbsp;<span class="ident" id="2932001">p</span><span class="op" id="2932002">[</span><span class="ident" id="2932003">n</span><span class="op" id="2932004">:</span><span class="op" id="2932005">]</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2932008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932011">if</span>&nbsp;<span class="ident" id="2932014">b</span><span class="op" id="2932015">.</span><span class="ident" id="2932016">err</span>&nbsp;<span class="op" id="2932020">!=</span>&nbsp;<span class="ident" id="2932023">nil</span>&nbsp;<span class="op" id="2932027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932031">return</span>&nbsp;<span class="ident" id="2932038">nn</span><span class="op" id="2932040">,</span>&nbsp;<span class="ident" id="2932042">b</span><span class="op" id="2932043">.</span><span class="ident" id="2932044">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2932049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2932052">n</span>&nbsp;<span class="op" id="2932054">:=</span>&nbsp;<span class="builtinfunc" id="2932057">copy</span><span class="op" id="2932061">(</span><span class="ident" id="2932062">b</span><span class="op" id="2932063">.</span><span class="ident" id="2932064">buf</span><span class="op" id="2932067">[</span><span class="ident" id="2932068">b</span><span class="op" id="2932069">.</span><span class="ident" id="2932070">n</span><span class="op" id="2932071">:</span><span class="op" id="2932072">]</span><span class="op" id="2932073">,</span>&nbsp;<span class="ident" id="2932075">p</span><span class="op" id="2932076">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2932079">b</span><span class="op" id="2932080">.</span><span class="ident" id="2932081">n</span>&nbsp;<span class="op" id="2932083">+=</span>&nbsp;<span class="ident" id="2932086">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2932089">nn</span>&nbsp;<span class="op" id="2932092">+=</span>&nbsp;<span class="ident" id="2932095">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932098">return</span>&nbsp;<span class="ident" id="2932105">nn</span><span class="op" id="2932107">,</span>&nbsp;<span class="ident" id="2932109">nil</span><br>
<span class="lineno"></span><span class="op" id="2932113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span><span class="comment" id="2932116">//&nbsp;WriteByte&nbsp;writes&nbsp;a&nbsp;single&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="2932151">func</span>&nbsp;<span class="op" id="2932156">(</span><span class="ident" id="2932157">b</span>&nbsp;<span class="op" id="2932159">*</span><span class="ident" id="2932160">Writer</span><span class="op" id="2932166">)</span>&nbsp;<span class="ident" id="2932168">WriteByte</span><span class="op" id="2932177">(</span><span class="ident" id="2932178">c</span>&nbsp;<span class="builtintype" id="2932180">byte</span><span class="op" id="2932184">)</span>&nbsp;<span class="builtintype" id="2932186">error</span>&nbsp;<span class="op" id="2932192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932195">if</span>&nbsp;<span class="ident" id="2932198">b</span><span class="op" id="2932199">.</span><span class="ident" id="2932200">err</span>&nbsp;<span class="op" id="2932204">!=</span>&nbsp;<span class="ident" id="2932207">nil</span>&nbsp;<span class="op" id="2932211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932215">return</span>&nbsp;<span class="ident" id="2932222">b</span><span class="op" id="2932223">.</span><span class="ident" id="2932224">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2932229">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932232">if</span>&nbsp;<span class="ident" id="2932235">b</span><span class="op" id="2932236">.</span><span class="ident" id="2932237">Available</span><span class="op" id="2932246">(</span><span class="op" id="2932247">)</span>&nbsp;<span class="op" id="2932249">&lt;=</span>&nbsp;<span class="num" id="2932252">0</span>&nbsp;<span class="op" id="2932254">&amp;&amp;</span>&nbsp;<span class="ident" id="2932257">b</span><span class="op" id="2932258">.</span><span class="ident" id="2932259">flush</span><span class="op" id="2932264">(</span><span class="op" id="2932265">)</span>&nbsp;<span class="op" id="2932267">!=</span>&nbsp;<span class="ident" id="2932270">nil</span>&nbsp;<span class="op" id="2932274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932278">return</span>&nbsp;<span class="ident" id="2932285">b</span><span class="op" id="2932286">.</span><span class="ident" id="2932287">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2932292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2932295">b</span><span class="op" id="2932296">.</span><span class="ident" id="2932297">buf</span><span class="op" id="2932300">[</span><span class="ident" id="2932301">b</span><span class="op" id="2932302">.</span><span class="ident" id="2932303">n</span><span class="op" id="2932304">]</span>&nbsp;<span class="op" id="2932306">=</span>&nbsp;<span class="ident" id="2932308">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2932311">b</span><span class="op" id="2932312">.</span><span class="ident" id="2932313">n</span><span class="op" id="2932314">++</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932318">return</span>&nbsp;<span class="ident" id="2932325">nil</span><br>
<span class="lineno"></span><span class="op" id="2932329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2932332">//&nbsp;WriteRune&nbsp;writes&nbsp;a&nbsp;single&nbsp;Unicode&nbsp;code&nbsp;point,&nbsp;returning</span><br>
<span class="lineno"></span><span class="comment" id="2932391">//&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;and&nbsp;any&nbsp;error.</span><br>
<span class="lineno">595</span><span class="keyword" id="2932437">func</span>&nbsp;<span class="op" id="2932442">(</span><span class="ident" id="2932443">b</span>&nbsp;<span class="op" id="2932445">*</span><span class="ident" id="2932446">Writer</span><span class="op" id="2932452">)</span>&nbsp;<span class="ident" id="2932454">WriteRune</span><span class="op" id="2932463">(</span><span class="ident" id="2932464">r</span>&nbsp;<span class="builtintype" id="2932466">rune</span><span class="op" id="2932470">)</span>&nbsp;<span class="op" id="2932472">(</span><span class="ident" id="2932473">size</span>&nbsp;<span class="builtintype" id="2932478">int</span><span class="op" id="2932481">,</span>&nbsp;<span class="ident" id="2932483">err</span>&nbsp;<span class="builtintype" id="2932487">error</span><span class="op" id="2932492">)</span>&nbsp;<span class="op" id="2932494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932497">if</span>&nbsp;<span class="ident" id="2932500">r</span>&nbsp;<span class="op" id="2932502">&lt;</span>&nbsp;<span class="ident" id="2932504">utf8</span><span class="op" id="2932508">.</span><span class="ident" id="2932509">RuneSelf</span>&nbsp;<span class="op" id="2932518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2932522">err</span>&nbsp;<span class="op" id="2932526">=</span>&nbsp;<span class="ident" id="2932528">b</span><span class="op" id="2932529">.</span><span class="ident" id="2932530">WriteByte</span><span class="op" id="2932539">(</span><span class="builtintype" id="2932540">byte</span><span class="op" id="2932544">(</span><span class="ident" id="2932545">r</span><span class="op" id="2932546">)</span><span class="op" id="2932547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932551">if</span>&nbsp;<span class="ident" id="2932554">err</span>&nbsp;<span class="op" id="2932558">!=</span>&nbsp;<span class="ident" id="2932561">nil</span>&nbsp;<span class="op" id="2932565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932570">return</span>&nbsp;<span class="num" id="2932577">0</span><span class="op" id="2932578">,</span>&nbsp;<span class="ident" id="2932580">err</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2932586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932590">return</span>&nbsp;<span class="num" id="2932597">1</span><span class="op" id="2932598">,</span>&nbsp;<span class="ident" id="2932600">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2932605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932608">if</span>&nbsp;<span class="ident" id="2932611">b</span><span class="op" id="2932612">.</span><span class="ident" id="2932613">err</span>&nbsp;<span class="op" id="2932617">!=</span>&nbsp;<span class="ident" id="2932620">nil</span>&nbsp;<span class="op" id="2932624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932628">return</span>&nbsp;<span class="num" id="2932635">0</span><span class="op" id="2932636">,</span>&nbsp;<span class="ident" id="2932638">b</span><span class="op" id="2932639">.</span><span class="ident" id="2932640">err</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2932645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2932648">n</span>&nbsp;<span class="op" id="2932650">:=</span>&nbsp;<span class="ident" id="2932653">b</span><span class="op" id="2932654">.</span><span class="ident" id="2932655">Available</span><span class="op" id="2932664">(</span><span class="op" id="2932665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932668">if</span>&nbsp;<span class="ident" id="2932671">n</span>&nbsp;<span class="op" id="2932673">&lt;</span>&nbsp;<span class="ident" id="2932675">utf8</span><span class="op" id="2932679">.</span><span class="ident" id="2932680">UTFMax</span>&nbsp;<span class="op" id="2932687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932691">if</span>&nbsp;<span class="ident" id="2932694">b</span><span class="op" id="2932695">.</span><span class="ident" id="2932696">flush</span><span class="op" id="2932701">(</span><span class="op" id="2932702">)</span><span class="op" id="2932703">;</span>&nbsp;<span class="ident" id="2932705">b</span><span class="op" id="2932706">.</span><span class="ident" id="2932707">err</span>&nbsp;<span class="op" id="2932711">!=</span>&nbsp;<span class="ident" id="2932714">nil</span>&nbsp;<span class="op" id="2932718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932723">return</span>&nbsp;<span class="num" id="2932730">0</span><span class="op" id="2932731">,</span>&nbsp;<span class="ident" id="2932733">b</span><span class="op" id="2932734">.</span><span class="ident" id="2932735">err</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2932741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2932745">n</span>&nbsp;<span class="op" id="2932747">=</span>&nbsp;<span class="ident" id="2932749">b</span><span class="op" id="2932750">.</span><span class="ident" id="2932751">Available</span><span class="op" id="2932760">(</span><span class="op" id="2932761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932765">if</span>&nbsp;<span class="ident" id="2932768">n</span>&nbsp;<span class="op" id="2932770">&lt;</span>&nbsp;<span class="ident" id="2932772">utf8</span><span class="op" id="2932776">.</span><span class="ident" id="2932777">UTFMax</span>&nbsp;<span class="op" id="2932784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2932789">//&nbsp;Can&nbsp;only&nbsp;happen&nbsp;if&nbsp;buffer&nbsp;is&nbsp;silly&nbsp;small.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932837">return</span>&nbsp;<span class="ident" id="2932844">b</span><span class="op" id="2932845">.</span><span class="ident" id="2932846">WriteString</span><span class="op" id="2932857">(</span><span class="builtintype" id="2932858">string</span><span class="op" id="2932864">(</span><span class="ident" id="2932865">r</span><span class="op" id="2932866">)</span><span class="op" id="2932867">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2932871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2932874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2932877">size</span>&nbsp;<span class="op" id="2932882">=</span>&nbsp;<span class="ident" id="2932884">utf8</span><span class="op" id="2932888">.</span><span class="ident" id="2932889">EncodeRune</span><span class="op" id="2932899">(</span><span class="ident" id="2932900">b</span><span class="op" id="2932901">.</span><span class="ident" id="2932902">buf</span><span class="op" id="2932905">[</span><span class="ident" id="2932906">b</span><span class="op" id="2932907">.</span><span class="ident" id="2932908">n</span><span class="op" id="2932909">:</span><span class="op" id="2932910">]</span><span class="op" id="2932911">,</span>&nbsp;<span class="ident" id="2932913">r</span><span class="op" id="2932914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2932917">b</span><span class="op" id="2932918">.</span><span class="ident" id="2932919">n</span>&nbsp;<span class="op" id="2932921">+=</span>&nbsp;<span class="ident" id="2932924">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2932930">return</span>&nbsp;<span class="ident" id="2932937">size</span><span class="op" id="2932941">,</span>&nbsp;<span class="ident" id="2932943">nil</span><br>
<span class="lineno">620</span><span class="op" id="2932947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2932950">//&nbsp;WriteString&nbsp;writes&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="comment" id="2932982">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="2933025">//&nbsp;If&nbsp;the&nbsp;count&nbsp;is&nbsp;less&nbsp;than&nbsp;len(s),&nbsp;it&nbsp;also&nbsp;returns&nbsp;an&nbsp;error&nbsp;explaining</span><br>
<span class="lineno">625</span><span class="comment" id="2933098">//&nbsp;why&nbsp;the&nbsp;write&nbsp;is&nbsp;short.</span><br>
<span class="lineno"></span><span class="keyword" id="2933125">func</span>&nbsp;<span class="op" id="2933130">(</span><span class="ident" id="2933131">b</span>&nbsp;<span class="op" id="2933133">*</span><span class="ident" id="2933134">Writer</span><span class="op" id="2933140">)</span>&nbsp;<span class="ident" id="2933142">WriteString</span><span class="op" id="2933153">(</span><span class="ident" id="2933154">s</span>&nbsp;<span class="builtintype" id="2933156">string</span><span class="op" id="2933162">)</span>&nbsp;<span class="op" id="2933164">(</span><span class="builtintype" id="2933165">int</span><span class="op" id="2933168">,</span>&nbsp;<span class="builtintype" id="2933170">error</span><span class="op" id="2933175">)</span>&nbsp;<span class="op" id="2933177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933180">nn</span>&nbsp;<span class="op" id="2933183">:=</span>&nbsp;<span class="num" id="2933186">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933189">for</span>&nbsp;<span class="builtinfunc" id="2933193">len</span><span class="op" id="2933196">(</span><span class="ident" id="2933197">s</span><span class="op" id="2933198">)</span>&nbsp;<span class="op" id="2933200">&gt;</span>&nbsp;<span class="ident" id="2933202">b</span><span class="op" id="2933203">.</span><span class="ident" id="2933204">Available</span><span class="op" id="2933213">(</span><span class="op" id="2933214">)</span>&nbsp;<span class="op" id="2933216">&amp;&amp;</span>&nbsp;<span class="ident" id="2933219">b</span><span class="op" id="2933220">.</span><span class="ident" id="2933221">err</span>&nbsp;<span class="op" id="2933225">==</span>&nbsp;<span class="ident" id="2933228">nil</span>&nbsp;<span class="op" id="2933232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933236">n</span>&nbsp;<span class="op" id="2933238">:=</span>&nbsp;<span class="builtinfunc" id="2933241">copy</span><span class="op" id="2933245">(</span><span class="ident" id="2933246">b</span><span class="op" id="2933247">.</span><span class="ident" id="2933248">buf</span><span class="op" id="2933251">[</span><span class="ident" id="2933252">b</span><span class="op" id="2933253">.</span><span class="ident" id="2933254">n</span><span class="op" id="2933255">:</span><span class="op" id="2933256">]</span><span class="op" id="2933257">,</span>&nbsp;<span class="ident" id="2933259">s</span><span class="op" id="2933260">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933264">b</span><span class="op" id="2933265">.</span><span class="ident" id="2933266">n</span>&nbsp;<span class="op" id="2933268">+=</span>&nbsp;<span class="ident" id="2933271">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933275">nn</span>&nbsp;<span class="op" id="2933278">+=</span>&nbsp;<span class="ident" id="2933281">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933285">s</span>&nbsp;<span class="op" id="2933287">=</span>&nbsp;<span class="ident" id="2933289">s</span><span class="op" id="2933290">[</span><span class="ident" id="2933291">n</span><span class="op" id="2933292">:</span><span class="op" id="2933293">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933297">b</span><span class="op" id="2933298">.</span><span class="ident" id="2933299">flush</span><span class="op" id="2933304">(</span><span class="op" id="2933305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2933308">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933311">if</span>&nbsp;<span class="ident" id="2933314">b</span><span class="op" id="2933315">.</span><span class="ident" id="2933316">err</span>&nbsp;<span class="op" id="2933320">!=</span>&nbsp;<span class="ident" id="2933323">nil</span>&nbsp;<span class="op" id="2933327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933331">return</span>&nbsp;<span class="ident" id="2933338">nn</span><span class="op" id="2933340">,</span>&nbsp;<span class="ident" id="2933342">b</span><span class="op" id="2933343">.</span><span class="ident" id="2933344">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2933349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933352">n</span>&nbsp;<span class="op" id="2933354">:=</span>&nbsp;<span class="builtinfunc" id="2933357">copy</span><span class="op" id="2933361">(</span><span class="ident" id="2933362">b</span><span class="op" id="2933363">.</span><span class="ident" id="2933364">buf</span><span class="op" id="2933367">[</span><span class="ident" id="2933368">b</span><span class="op" id="2933369">.</span><span class="ident" id="2933370">n</span><span class="op" id="2933371">:</span><span class="op" id="2933372">]</span><span class="op" id="2933373">,</span>&nbsp;<span class="ident" id="2933375">s</span><span class="op" id="2933376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933379">b</span><span class="op" id="2933380">.</span><span class="ident" id="2933381">n</span>&nbsp;<span class="op" id="2933383">+=</span>&nbsp;<span class="ident" id="2933386">n</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933389">nn</span>&nbsp;<span class="op" id="2933392">+=</span>&nbsp;<span class="ident" id="2933395">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933398">return</span>&nbsp;<span class="ident" id="2933405">nn</span><span class="op" id="2933407">,</span>&nbsp;<span class="ident" id="2933409">nil</span><br>
<span class="lineno"></span><span class="op" id="2933413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2933416">//&nbsp;ReadFrom&nbsp;implements&nbsp;io.ReaderFrom.</span><br>
<span class="lineno">645</span><span class="keyword" id="2933454">func</span>&nbsp;<span class="op" id="2933459">(</span><span class="ident" id="2933460">b</span>&nbsp;<span class="op" id="2933462">*</span><span class="ident" id="2933463">Writer</span><span class="op" id="2933469">)</span>&nbsp;<span class="ident" id="2933471">ReadFrom</span><span class="op" id="2933479">(</span><span class="ident" id="2933480">r</span>&nbsp;<span class="ident" id="2933482">io</span><span class="op" id="2933484">.</span><span class="ident" id="2933485">Reader</span><span class="op" id="2933491">)</span>&nbsp;<span class="op" id="2933493">(</span><span class="ident" id="2933494">n</span>&nbsp;<span class="ident" id="2933496">int64</span><span class="op" id="2933501">,</span>&nbsp;<span class="ident" id="2933503">err</span>&nbsp;<span class="builtintype" id="2933507">error</span><span class="op" id="2933512">)</span>&nbsp;<span class="op" id="2933514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933517">if</span>&nbsp;<span class="ident" id="2933520">b</span><span class="op" id="2933521">.</span><span class="ident" id="2933522">Buffered</span><span class="op" id="2933530">(</span><span class="op" id="2933531">)</span>&nbsp;<span class="op" id="2933533">==</span>&nbsp;<span class="num" id="2933536">0</span>&nbsp;<span class="op" id="2933538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933542">if</span>&nbsp;<span class="ident" id="2933545">w</span><span class="op" id="2933546">,</span>&nbsp;<span class="ident" id="2933548">ok</span>&nbsp;<span class="op" id="2933551">:=</span>&nbsp;<span class="ident" id="2933554">b</span><span class="op" id="2933555">.</span><span class="ident" id="2933556">wr</span><span class="op" id="2933558">.</span><span class="op" id="2933559">(</span><span class="ident" id="2933560">io</span><span class="op" id="2933562">.</span><span class="ident" id="2933563">ReaderFrom</span><span class="op" id="2933573">)</span><span class="op" id="2933574">;</span>&nbsp;<span class="ident" id="2933576">ok</span>&nbsp;<span class="op" id="2933579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933584">return</span>&nbsp;<span class="ident" id="2933591">w</span><span class="op" id="2933592">.</span><span class="ident" id="2933593">ReadFrom</span><span class="op" id="2933601">(</span><span class="ident" id="2933602">r</span><span class="op" id="2933603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2933607">}</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2933610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933613">var</span>&nbsp;<span class="ident" id="2933617">m</span>&nbsp;<span class="builtintype" id="2933619">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933624">for</span>&nbsp;<span class="op" id="2933628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933632">if</span>&nbsp;<span class="ident" id="2933635">b</span><span class="op" id="2933636">.</span><span class="ident" id="2933637">Available</span><span class="op" id="2933646">(</span><span class="op" id="2933647">)</span>&nbsp;<span class="op" id="2933649">==</span>&nbsp;<span class="num" id="2933652">0</span>&nbsp;<span class="op" id="2933654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933659">if</span>&nbsp;<span class="ident" id="2933662">err1</span>&nbsp;<span class="op" id="2933667">:=</span>&nbsp;<span class="ident" id="2933670">b</span><span class="op" id="2933671">.</span><span class="ident" id="2933672">flush</span><span class="op" id="2933677">(</span><span class="op" id="2933678">)</span><span class="op" id="2933679">;</span>&nbsp;<span class="ident" id="2933681">err1</span>&nbsp;<span class="op" id="2933686">!=</span>&nbsp;<span class="ident" id="2933689">nil</span>&nbsp;<span class="op" id="2933693">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933699">return</span>&nbsp;<span class="ident" id="2933706">n</span><span class="op" id="2933707">,</span>&nbsp;<span class="ident" id="2933709">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2933717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2933721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933725">nr</span>&nbsp;<span class="op" id="2933728">:=</span>&nbsp;<span class="num" id="2933731">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933735">for</span>&nbsp;<span class="ident" id="2933739">nr</span>&nbsp;<span class="op" id="2933742">&lt;</span>&nbsp;<span class="ident" id="2933744">maxConsecutiveEmptyReads</span>&nbsp;<span class="op" id="2933769">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933774">m</span><span class="op" id="2933775">,</span>&nbsp;<span class="ident" id="2933777">err</span>&nbsp;<span class="op" id="2933781">=</span>&nbsp;<span class="ident" id="2933783">r</span><span class="op" id="2933784">.</span><span class="ident" id="2933785">Read</span><span class="op" id="2933789">(</span><span class="ident" id="2933790">b</span><span class="op" id="2933791">.</span><span class="ident" id="2933792">buf</span><span class="op" id="2933795">[</span><span class="ident" id="2933796">b</span><span class="op" id="2933797">.</span><span class="ident" id="2933798">n</span><span class="op" id="2933799">:</span><span class="op" id="2933800">]</span><span class="op" id="2933801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933806">if</span>&nbsp;<span class="ident" id="2933809">m</span>&nbsp;<span class="op" id="2933811">!=</span>&nbsp;<span class="num" id="2933814">0</span>&nbsp;<span class="op" id="2933816">||</span>&nbsp;<span class="ident" id="2933819">err</span>&nbsp;<span class="op" id="2933823">!=</span>&nbsp;<span class="ident" id="2933826">nil</span>&nbsp;<span class="op" id="2933830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933836">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2933845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933850">nr</span><span class="op" id="2933852">++</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2933857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933861">if</span>&nbsp;<span class="ident" id="2933864">nr</span>&nbsp;<span class="op" id="2933867">==</span>&nbsp;<span class="ident" id="2933870">maxConsecutiveEmptyReads</span>&nbsp;<span class="op" id="2933895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933900">return</span>&nbsp;<span class="ident" id="2933907">n</span><span class="op" id="2933908">,</span>&nbsp;<span class="ident" id="2933910">io</span><span class="op" id="2933912">.</span><span class="ident" id="2933913">ErrNoProgress</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2933929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933933">b</span><span class="op" id="2933934">.</span><span class="ident" id="2933935">n</span>&nbsp;<span class="op" id="2933937">+=</span>&nbsp;<span class="ident" id="2933940">m</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2933944">n</span>&nbsp;<span class="op" id="2933946">+=</span>&nbsp;<span class="ident" id="2933949">int64</span><span class="op" id="2933954">(</span><span class="ident" id="2933955">m</span><span class="op" id="2933956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933960">if</span>&nbsp;<span class="ident" id="2933963">err</span>&nbsp;<span class="op" id="2933967">!=</span>&nbsp;<span class="ident" id="2933970">nil</span>&nbsp;<span class="op" id="2933974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933979">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2933987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2933990">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2933993">if</span>&nbsp;<span class="ident" id="2933996">err</span>&nbsp;<span class="op" id="2934000">==</span>&nbsp;<span class="ident" id="2934003">io</span><span class="op" id="2934005">.</span><span class="ident" id="2934006">EOF</span>&nbsp;<span class="op" id="2934010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2934014">//&nbsp;If&nbsp;we&nbsp;filled&nbsp;the&nbsp;buffer&nbsp;exactly,&nbsp;flush&nbsp;pre-emptively.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2934073">if</span>&nbsp;<span class="ident" id="2934076">b</span><span class="op" id="2934077">.</span><span class="ident" id="2934078">Available</span><span class="op" id="2934087">(</span><span class="op" id="2934088">)</span>&nbsp;<span class="op" id="2934090">==</span>&nbsp;<span class="num" id="2934093">0</span>&nbsp;<span class="op" id="2934095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2934100">err</span>&nbsp;<span class="op" id="2934104">=</span>&nbsp;<span class="ident" id="2934106">b</span><span class="op" id="2934107">.</span><span class="ident" id="2934108">flush</span><span class="op" id="2934113">(</span><span class="op" id="2934114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2934118">}</span>&nbsp;<span class="keyword" id="2934120">else</span>&nbsp;<span class="op" id="2934125">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2934130">err</span>&nbsp;<span class="op" id="2934134">=</span>&nbsp;<span class="ident" id="2934136">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2934142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2934145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2934148">return</span>&nbsp;<span class="ident" id="2934155">n</span><span class="op" id="2934156">,</span>&nbsp;<span class="ident" id="2934158">err</span><br>
<span class="lineno"></span><span class="op" id="2934162">}</span><br>
<span class="lineno">685</span><br>
<span class="lineno"></span><span class="comment" id="2934165">//&nbsp;buffered&nbsp;input&nbsp;and&nbsp;output</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2934195">//&nbsp;ReadWriter&nbsp;stores&nbsp;pointers&nbsp;to&nbsp;a&nbsp;Reader&nbsp;and&nbsp;a&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="comment" id="2934251">//&nbsp;It&nbsp;implements&nbsp;io.ReadWriter.</span><br>
<span class="lineno">690</span><span class="keyword" id="2934283">type</span>&nbsp;<span class="ident" id="2934288">ReadWriter</span>&nbsp;<span class="keyword" id="2934299">struct</span>&nbsp;<span class="op" id="2934306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2934309">*</span><span class="ident" id="2934310">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2934318">*</span><span class="ident" id="2934319">Writer</span><br>
<span class="lineno"></span><span class="op" id="2934326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span><span class="comment" id="2934329">//&nbsp;NewReadWriter&nbsp;allocates&nbsp;a&nbsp;new&nbsp;ReadWriter&nbsp;that&nbsp;dispatches&nbsp;to&nbsp;r&nbsp;and&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="2934401">func</span>&nbsp;<span class="ident" id="2934406">NewReadWriter</span><span class="op" id="2934419">(</span><span class="ident" id="2934420">r</span>&nbsp;<span class="op" id="2934422">*</span><span class="ident" id="2934423">Reader</span><span class="op" id="2934429">,</span>&nbsp;<span class="ident" id="2934431">w</span>&nbsp;<span class="op" id="2934433">*</span><span class="ident" id="2934434">Writer</span><span class="op" id="2934440">)</span>&nbsp;<span class="op" id="2934442">*</span><span class="ident" id="2934443">ReadWriter</span>&nbsp;<span class="op" id="2934454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2934457">return</span>&nbsp;<span class="op" id="2934464">&amp;</span><span class="ident" id="2934465">ReadWriter</span><span class="op" id="2934475">{</span><span class="ident" id="2934476">r</span><span class="op" id="2934477">,</span>&nbsp;<span class="ident" id="2934479">w</span><span class="op" id="2934480">}</span><br>
<span class="lineno"></span><span class="op" id="2934482">}</span>
</div>
</body>
</html>
