<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html" class="current">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1402640">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1402695">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1402749">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1402800">//&nbsp;Package&nbsp;sync&nbsp;provides&nbsp;basic&nbsp;synchronization&nbsp;primitives&nbsp;such&nbsp;as&nbsp;mutual</span><br>
<span class="lineno"></span><span class="comment" id="1402873">//&nbsp;exclusion&nbsp;locks.&nbsp;&nbsp;Other&nbsp;than&nbsp;the&nbsp;Once&nbsp;and&nbsp;WaitGroup&nbsp;types,&nbsp;most&nbsp;are&nbsp;intended</span><br>
<span class="lineno"></span><span class="comment" id="1402953">//&nbsp;for&nbsp;use&nbsp;by&nbsp;low-level&nbsp;library&nbsp;routines.&nbsp;&nbsp;Higher-level&nbsp;synchronization&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1403028">//&nbsp;better&nbsp;done&nbsp;via&nbsp;channels&nbsp;and&nbsp;communication.</span><br>
<span class="lineno"></span><span class="comment" id="1403075">//</span><br>
<span class="lineno">10</span><span class="comment" id="1403078">//&nbsp;Values&nbsp;containing&nbsp;the&nbsp;types&nbsp;defined&nbsp;in&nbsp;this&nbsp;package&nbsp;should&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno"></span><span class="keyword" id="1403155">package</span>&nbsp;<span class="ident" id="1403163">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1403169">import</span>&nbsp;<span class="op" id="1403176">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1403179">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1403194">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1403203">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1403206">//&nbsp;A&nbsp;Mutex&nbsp;is&nbsp;a&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1403245">//&nbsp;Mutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures;</span><br>
<span class="lineno">20</span><span class="comment" id="1403300">//&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Mutex&nbsp;is&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1403352">type</span>&nbsp;<span class="ident" id="1403357">Mutex</span>&nbsp;<span class="keyword" id="1403363">struct</span>&nbsp;<span class="op" id="1403370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403373">state</span>&nbsp;<span class="builtintype" id="1403379">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403386">sema</span>&nbsp;&nbsp;<span class="builtintype" id="1403392">uint32</span><br>
<span class="lineno"></span><span class="op" id="1403399">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="1403402">//&nbsp;A&nbsp;Locker&nbsp;represents&nbsp;an&nbsp;object&nbsp;that&nbsp;can&nbsp;be&nbsp;locked&nbsp;and&nbsp;unlocked.</span><br>
<span class="lineno"></span><span class="keyword" id="1403468">type</span>&nbsp;<span class="ident" id="1403473">Locker</span>&nbsp;<span class="keyword" id="1403480">interface</span>&nbsp;<span class="op" id="1403490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403493">Lock</span><span class="op" id="1403497">(</span><span class="op" id="1403498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403501">Unlock</span><span class="op" id="1403507">(</span><span class="op" id="1403508">)</span><br>
<span class="lineno">30</span><span class="op" id="1403510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1403513">const</span>&nbsp;<span class="op" id="1403519">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403522">mutexLocked</span>&nbsp;<span class="op" id="1403534">=</span>&nbsp;<span class="num" id="1403536">1</span>&nbsp;<span class="op" id="1403538">&lt;&lt;</span>&nbsp;<span class="ident" id="1403541">iota</span>&nbsp;<span class="comment" id="1403546">//&nbsp;mutex&nbsp;is&nbsp;locked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403566">mutexWoken</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403578">mutexWaiterShift</span>&nbsp;<span class="op" id="1403595">=</span>&nbsp;<span class="ident" id="1403597">iota</span><br>
<span class="lineno"></span><span class="op" id="1403602">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1403605">//&nbsp;Lock&nbsp;locks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1403622">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;in&nbsp;use,&nbsp;the&nbsp;calling&nbsp;goroutine</span><br>
<span class="lineno">40</span><span class="comment" id="1403678">//&nbsp;blocks&nbsp;until&nbsp;the&nbsp;mutex&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1403718">func</span>&nbsp;<span class="op" id="1403723">(</span><span class="ident" id="1403724">m</span>&nbsp;<span class="op" id="1403726">*</span><span class="ident" id="1403727">Mutex</span><span class="op" id="1403732">)</span>&nbsp;<span class="ident" id="1403734">Lock</span><span class="op" id="1403738">(</span><span class="op" id="1403739">)</span>&nbsp;<span class="op" id="1403741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1403744">//&nbsp;Fast&nbsp;path:&nbsp;grab&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403780">if</span>&nbsp;<span class="ident" id="1403783">atomic</span><span class="op" id="1403789">.</span><span class="ident" id="1403790">CompareAndSwapInt32</span><span class="op" id="1403809">(</span><span class="op" id="1403810">&amp;</span><span class="ident" id="1403811">m</span><span class="op" id="1403812">.</span><span class="ident" id="1403813">state</span><span class="op" id="1403818">,</span>&nbsp;<span class="num" id="1403820">0</span><span class="op" id="1403821">,</span>&nbsp;<span class="ident" id="1403823">mutexLocked</span><span class="op" id="1403834">)</span>&nbsp;<span class="op" id="1403836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403840">if</span>&nbsp;<span class="ident" id="1403843">raceenabled</span>&nbsp;<span class="op" id="1403855">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403860">raceAcquire</span><span class="op" id="1403871">(</span><span class="ident" id="1403872">unsafe</span><span class="op" id="1403878">.</span><span class="ident" id="1403879">Pointer</span><span class="op" id="1403886">(</span><span class="ident" id="1403887">m</span><span class="op" id="1403888">)</span><span class="op" id="1403889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1403893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403897">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1403905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403909">awoke</span>&nbsp;<span class="op" id="1403915">:=</span>&nbsp;<span class="builtintype" id="1403918">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403925">for</span>&nbsp;<span class="op" id="1403929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403933">old</span>&nbsp;<span class="op" id="1403937">:=</span>&nbsp;<span class="ident" id="1403940">m</span><span class="op" id="1403941">.</span><span class="ident" id="1403942">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1403950">new</span>&nbsp;<span class="op" id="1403954">:=</span>&nbsp;<span class="ident" id="1403957">old</span>&nbsp;<span class="op" id="1403961">|</span>&nbsp;<span class="ident" id="1403963">mutexLocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403977">if</span>&nbsp;<span class="ident" id="1403980">old</span><span class="op" id="1403983">&amp;</span><span class="ident" id="1403984">mutexLocked</span>&nbsp;<span class="op" id="1403996">!=</span>&nbsp;<span class="num" id="1403999">0</span>&nbsp;<span class="op" id="1404001">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1404006">new</span>&nbsp;<span class="op" id="1404010">=</span>&nbsp;<span class="ident" id="1404012">old</span>&nbsp;<span class="op" id="1404016">+</span>&nbsp;<span class="num" id="1404018">1</span><span class="op" id="1404019">&lt;&lt;</span><span class="ident" id="1404021">mutexWaiterShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404044">if</span>&nbsp;<span class="ident" id="1404047">awoke</span>&nbsp;<span class="op" id="1404053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1404058">//&nbsp;The&nbsp;goroutine&nbsp;has&nbsp;been&nbsp;woken&nbsp;from&nbsp;sleep,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1404105">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;reset&nbsp;the&nbsp;flag&nbsp;in&nbsp;either&nbsp;case.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1404156">new</span>&nbsp;<span class="op" id="1404160">&amp;^=</span>&nbsp;<span class="ident" id="1404164">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404181">if</span>&nbsp;<span class="ident" id="1404184">atomic</span><span class="op" id="1404190">.</span><span class="ident" id="1404191">CompareAndSwapInt32</span><span class="op" id="1404210">(</span><span class="op" id="1404211">&amp;</span><span class="ident" id="1404212">m</span><span class="op" id="1404213">.</span><span class="ident" id="1404214">state</span><span class="op" id="1404219">,</span>&nbsp;<span class="ident" id="1404221">old</span><span class="op" id="1404224">,</span>&nbsp;<span class="builtinfunc" id="1404226">new</span><span class="op" id="1404229">)</span>&nbsp;<span class="op" id="1404231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404236">if</span>&nbsp;<span class="ident" id="1404239">old</span><span class="op" id="1404242">&amp;</span><span class="ident" id="1404243">mutexLocked</span>&nbsp;<span class="op" id="1404255">==</span>&nbsp;<span class="num" id="1404258">0</span>&nbsp;<span class="op" id="1404260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404266">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404280">runtime_Semacquire</span><span class="op" id="1404298">(</span><span class="op" id="1404299">&amp;</span><span class="ident" id="1404300">m</span><span class="op" id="1404301">.</span><span class="ident" id="1404302">sema</span><span class="op" id="1404306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404311">awoke</span>&nbsp;<span class="op" id="1404317">=</span>&nbsp;<span class="builtintype" id="1404319">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404329">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404333">if</span>&nbsp;<span class="ident" id="1404336">raceenabled</span>&nbsp;<span class="op" id="1404348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404352">raceAcquire</span><span class="op" id="1404363">(</span><span class="ident" id="1404364">unsafe</span><span class="op" id="1404370">.</span><span class="ident" id="1404371">Pointer</span><span class="op" id="1404378">(</span><span class="ident" id="1404379">m</span><span class="op" id="1404380">)</span><span class="op" id="1404381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404384">}</span><br>
<span class="lineno"></span><span class="op" id="1404386">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="1404389">//&nbsp;Unlock&nbsp;unlocks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1404410">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;m&nbsp;is&nbsp;not&nbsp;locked&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1404475">//</span><br>
<span class="lineno"></span><span class="comment" id="1404478">//&nbsp;A&nbsp;locked&nbsp;Mutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular&nbsp;goroutine.</span><br>
<span class="lineno">80</span><span class="comment" id="1404543">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;for&nbsp;one&nbsp;goroutine&nbsp;to&nbsp;lock&nbsp;a&nbsp;Mutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1404603">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;unlock&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1404650">func</span>&nbsp;<span class="op" id="1404655">(</span><span class="ident" id="1404656">m</span>&nbsp;<span class="op" id="1404658">*</span><span class="ident" id="1404659">Mutex</span><span class="op" id="1404664">)</span>&nbsp;<span class="ident" id="1404666">Unlock</span><span class="op" id="1404672">(</span><span class="op" id="1404673">)</span>&nbsp;<span class="op" id="1404675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404678">if</span>&nbsp;<span class="ident" id="1404681">raceenabled</span>&nbsp;<span class="op" id="1404693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404697">_</span>&nbsp;<span class="op" id="1404699">=</span>&nbsp;<span class="ident" id="1404701">m</span><span class="op" id="1404702">.</span><span class="ident" id="1404703">state</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404711">raceRelease</span><span class="op" id="1404722">(</span><span class="ident" id="1404723">unsafe</span><span class="op" id="1404729">.</span><span class="ident" id="1404730">Pointer</span><span class="op" id="1404737">(</span><span class="ident" id="1404738">m</span><span class="op" id="1404739">)</span><span class="op" id="1404740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1404747">//&nbsp;Fast&nbsp;path:&nbsp;drop&nbsp;lock&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1404777">new</span>&nbsp;<span class="op" id="1404781">:=</span>&nbsp;<span class="ident" id="1404784">atomic</span><span class="op" id="1404790">.</span><span class="ident" id="1404791">AddInt32</span><span class="op" id="1404799">(</span><span class="op" id="1404800">&amp;</span><span class="ident" id="1404801">m</span><span class="op" id="1404802">.</span><span class="ident" id="1404803">state</span><span class="op" id="1404808">,</span>&nbsp;<span class="op" id="1404810">-</span><span class="ident" id="1404811">mutexLocked</span><span class="op" id="1404822">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404825">if</span>&nbsp;<span class="op" id="1404828">(</span><span class="builtinfunc" id="1404829">new</span><span class="op" id="1404832">+</span><span class="ident" id="1404833">mutexLocked</span><span class="op" id="1404844">)</span><span class="op" id="1404845">&amp;</span><span class="ident" id="1404846">mutexLocked</span>&nbsp;<span class="op" id="1404858">==</span>&nbsp;<span class="num" id="1404861">0</span>&nbsp;<span class="op" id="1404863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1404867">panic</span><span class="op" id="1404872">(</span><span class="string" id="1404873">&#34;sync:&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;mutex&#34;</span><span class="op" id="1404905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404912">old</span>&nbsp;<span class="op" id="1404916">:=</span>&nbsp;<span class="builtinfunc" id="1404919">new</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404924">for</span>&nbsp;<span class="op" id="1404928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1404932">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;waiters&nbsp;or&nbsp;a&nbsp;goroutine&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1404988">//&nbsp;been&nbsp;woken&nbsp;or&nbsp;grabbed&nbsp;the&nbsp;lock,&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;anyone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405049">if</span>&nbsp;<span class="ident" id="1405052">old</span><span class="op" id="1405055">&gt;&gt;</span><span class="ident" id="1405057">mutexWaiterShift</span>&nbsp;<span class="op" id="1405074">==</span>&nbsp;<span class="num" id="1405077">0</span>&nbsp;<span class="op" id="1405079">||</span>&nbsp;<span class="ident" id="1405082">old</span><span class="op" id="1405085">&amp;</span><span class="op" id="1405086">(</span><span class="ident" id="1405087">mutexLocked</span><span class="op" id="1405098">|</span><span class="ident" id="1405099">mutexWoken</span><span class="op" id="1405109">)</span>&nbsp;<span class="op" id="1405111">!=</span>&nbsp;<span class="num" id="1405114">0</span>&nbsp;<span class="op" id="1405116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405121">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1405134">//&nbsp;Grab&nbsp;the&nbsp;right&nbsp;to&nbsp;wake&nbsp;someone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1405171">new</span>&nbsp;<span class="op" id="1405175">=</span>&nbsp;<span class="op" id="1405177">(</span><span class="ident" id="1405178">old</span>&nbsp;<span class="op" id="1405182">-</span>&nbsp;<span class="num" id="1405184">1</span><span class="op" id="1405185">&lt;&lt;</span><span class="ident" id="1405187">mutexWaiterShift</span><span class="op" id="1405203">)</span>&nbsp;<span class="op" id="1405205">|</span>&nbsp;<span class="ident" id="1405207">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405220">if</span>&nbsp;<span class="ident" id="1405223">atomic</span><span class="op" id="1405229">.</span><span class="ident" id="1405230">CompareAndSwapInt32</span><span class="op" id="1405249">(</span><span class="op" id="1405250">&amp;</span><span class="ident" id="1405251">m</span><span class="op" id="1405252">.</span><span class="ident" id="1405253">state</span><span class="op" id="1405258">,</span>&nbsp;<span class="ident" id="1405260">old</span><span class="op" id="1405263">,</span>&nbsp;<span class="builtinfunc" id="1405265">new</span><span class="op" id="1405268">)</span>&nbsp;<span class="op" id="1405270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405275">runtime_Semrelease</span><span class="op" id="1405293">(</span><span class="op" id="1405294">&amp;</span><span class="ident" id="1405295">m</span><span class="op" id="1405296">.</span><span class="ident" id="1405297">sema</span><span class="op" id="1405301">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405306">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405319">old</span>&nbsp;<span class="op" id="1405323">=</span>&nbsp;<span class="ident" id="1405325">m</span><span class="op" id="1405326">.</span><span class="ident" id="1405327">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405334">}</span><br>
<span class="lineno"></span><span class="op" id="1405336">}</span>
</div>
</body>
</html>
