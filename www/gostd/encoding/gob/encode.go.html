<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html" class="current">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5636610">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5636665">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5636719">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5636770">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5636825">package</span>&nbsp;<span class="ident" id="5636833">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5636838">import</span>&nbsp;<span class="op" id="5636845">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5636848">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5636860">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5636868">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op" id="5636878">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5636881">const</span>&nbsp;<span class="ident" id="5636887">uint64Size</span>&nbsp;<span class="op" id="5636898">=</span>&nbsp;<span class="num" id="5636900">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5636903">type</span>&nbsp;<span class="ident" id="5636908">encHelper</span>&nbsp;<span class="keyword" id="5636918">func</span><span class="op" id="5636922">(</span><span class="ident" id="5636923">state</span>&nbsp;<span class="op" id="5636929">*</span><span class="ident" id="5636930">encoderState</span><span class="op" id="5636942">,</span>&nbsp;<span class="ident" id="5636944">v</span>&nbsp;<span class="ident" id="5636946">reflect</span><span class="op" id="5636953">.</span><span class="ident" id="5636954">Value</span><span class="op" id="5636959">)</span>&nbsp;<span class="builtintype" id="5636961">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5636967">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment" id="5637044">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="5637110">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5637180">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="5637211">type</span>&nbsp;<span class="ident" id="5637216">encoderState</span>&nbsp;<span class="keyword" id="5637229">struct</span>&nbsp;<span class="op" id="5637236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637239">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637248">*</span><span class="ident" id="5637249">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637258">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637267">*</span><span class="ident" id="5637268">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637279">sendZero</span>&nbsp;<span class="builtintype" id="5637288">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5637309">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637379">fieldnum</span>&nbsp;<span class="builtintype" id="5637388">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5637409">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637444">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637453">[</span><span class="num" id="5637454">1</span>&nbsp;<span class="op" id="5637456">+</span>&nbsp;<span class="ident" id="5637458">uint64Size</span><span class="op" id="5637468">]</span><span class="builtintype" id="5637469">byte</span>&nbsp;<span class="comment" id="5637474">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637532">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637541">*</span><span class="ident" id="5637542">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5637562">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op" id="5637579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5637582">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="5637668">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5637763">type</span>&nbsp;<span class="ident" id="5637768">encBuffer</span>&nbsp;<span class="keyword" id="5637778">struct</span>&nbsp;<span class="op" id="5637785">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637788">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5637796">[</span><span class="op" id="5637797">]</span><span class="builtintype" id="5637798">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637804">scratch</span>&nbsp;<span class="op" id="5637812">[</span><span class="num" id="5637813">64</span><span class="op" id="5637815">]</span><span class="builtintype" id="5637816">byte</span><br>
<span class="lineno"></span><span class="op" id="5637821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5637824">func</span>&nbsp;<span class="op" id="5637829">(</span><span class="ident" id="5637830">e</span>&nbsp;<span class="op" id="5637832">*</span><span class="ident" id="5637833">encBuffer</span><span class="op" id="5637842">)</span>&nbsp;<span class="ident" id="5637844">WriteByte</span><span class="op" id="5637853">(</span><span class="ident" id="5637854">c</span>&nbsp;<span class="builtintype" id="5637856">byte</span><span class="op" id="5637860">)</span>&nbsp;<span class="op" id="5637862">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637865">e</span><span class="op" id="5637866">.</span><span class="ident" id="5637867">data</span>&nbsp;<span class="op" id="5637872">=</span>&nbsp;<span class="builtinfunc" id="5637874">append</span><span class="op" id="5637880">(</span><span class="ident" id="5637881">e</span><span class="op" id="5637882">.</span><span class="ident" id="5637883">data</span><span class="op" id="5637887">,</span>&nbsp;<span class="ident" id="5637889">c</span><span class="op" id="5637890">)</span><br>
<span class="lineno"></span><span class="op" id="5637892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5637895">func</span>&nbsp;<span class="op" id="5637900">(</span><span class="ident" id="5637901">e</span>&nbsp;<span class="op" id="5637903">*</span><span class="ident" id="5637904">encBuffer</span><span class="op" id="5637913">)</span>&nbsp;<span class="ident" id="5637915">Write</span><span class="op" id="5637920">(</span><span class="ident" id="5637921">p</span>&nbsp;<span class="op" id="5637923">[</span><span class="op" id="5637924">]</span><span class="builtintype" id="5637925">byte</span><span class="op" id="5637929">)</span>&nbsp;<span class="op" id="5637931">(</span><span class="builtintype" id="5637932">int</span><span class="op" id="5637935">,</span>&nbsp;<span class="builtintype" id="5637937">error</span><span class="op" id="5637942">)</span>&nbsp;<span class="op" id="5637944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5637947">e</span><span class="op" id="5637948">.</span><span class="ident" id="5637949">data</span>&nbsp;<span class="op" id="5637954">=</span>&nbsp;<span class="builtinfunc" id="5637956">append</span><span class="op" id="5637962">(</span><span class="ident" id="5637963">e</span><span class="op" id="5637964">.</span><span class="ident" id="5637965">data</span><span class="op" id="5637969">,</span>&nbsp;<span class="ident" id="5637971">p</span><span class="op" id="5637972">...</span><span class="op" id="5637975">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5637978">return</span>&nbsp;<span class="builtinfunc" id="5637985">len</span><span class="op" id="5637988">(</span><span class="ident" id="5637989">p</span><span class="op" id="5637990">)</span><span class="op" id="5637991">,</span>&nbsp;<span class="builtintype" id="5637993">nil</span><br>
<span class="lineno"></span><span class="op" id="5637997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5638000">func</span>&nbsp;<span class="op" id="5638005">(</span><span class="ident" id="5638006">e</span>&nbsp;<span class="op" id="5638008">*</span><span class="ident" id="5638009">encBuffer</span><span class="op" id="5638018">)</span>&nbsp;<span class="ident" id="5638020">WriteString</span><span class="op" id="5638031">(</span><span class="ident" id="5638032">s</span>&nbsp;<span class="builtintype" id="5638034">string</span><span class="op" id="5638040">)</span>&nbsp;<span class="op" id="5638042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638045">e</span><span class="op" id="5638046">.</span><span class="ident" id="5638047">data</span>&nbsp;<span class="op" id="5638052">=</span>&nbsp;<span class="builtinfunc" id="5638054">append</span><span class="op" id="5638060">(</span><span class="ident" id="5638061">e</span><span class="op" id="5638062">.</span><span class="ident" id="5638063">data</span><span class="op" id="5638067">,</span>&nbsp;<span class="ident" id="5638069">s</span><span class="op" id="5638070">...</span><span class="op" id="5638073">)</span><br>
<span class="lineno">50</span><span class="op" id="5638075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5638078">func</span>&nbsp;<span class="op" id="5638083">(</span><span class="ident" id="5638084">e</span>&nbsp;<span class="op" id="5638086">*</span><span class="ident" id="5638087">encBuffer</span><span class="op" id="5638096">)</span>&nbsp;<span class="ident" id="5638098">Len</span><span class="op" id="5638101">(</span><span class="op" id="5638102">)</span>&nbsp;<span class="builtintype" id="5638104">int</span>&nbsp;<span class="op" id="5638108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638111">return</span>&nbsp;<span class="builtinfunc" id="5638118">len</span><span class="op" id="5638121">(</span><span class="ident" id="5638122">e</span><span class="op" id="5638123">.</span><span class="ident" id="5638124">data</span><span class="op" id="5638128">)</span><br>
<span class="lineno"></span><span class="op" id="5638130">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="5638133">func</span>&nbsp;<span class="op" id="5638138">(</span><span class="ident" id="5638139">e</span>&nbsp;<span class="op" id="5638141">*</span><span class="ident" id="5638142">encBuffer</span><span class="op" id="5638151">)</span>&nbsp;<span class="ident" id="5638153">Bytes</span><span class="op" id="5638158">(</span><span class="op" id="5638159">)</span>&nbsp;<span class="op" id="5638161">[</span><span class="op" id="5638162">]</span><span class="builtintype" id="5638163">byte</span>&nbsp;<span class="op" id="5638168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638171">return</span>&nbsp;<span class="ident" id="5638178">e</span><span class="op" id="5638179">.</span><span class="ident" id="5638180">data</span><br>
<span class="lineno"></span><span class="op" id="5638185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5638188">func</span>&nbsp;<span class="op" id="5638193">(</span><span class="ident" id="5638194">e</span>&nbsp;<span class="op" id="5638196">*</span><span class="ident" id="5638197">encBuffer</span><span class="op" id="5638206">)</span>&nbsp;<span class="ident" id="5638208">Reset</span><span class="op" id="5638213">(</span><span class="op" id="5638214">)</span>&nbsp;<span class="op" id="5638216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638219">e</span><span class="op" id="5638220">.</span><span class="ident" id="5638221">data</span>&nbsp;<span class="op" id="5638226">=</span>&nbsp;<span class="ident" id="5638228">e</span><span class="op" id="5638229">.</span><span class="ident" id="5638230">data</span><span class="op" id="5638234">[</span><span class="num" id="5638235">0</span><span class="op" id="5638236">:</span><span class="num" id="5638237">0</span><span class="op" id="5638238">]</span><br>
<span class="lineno"></span><span class="op" id="5638240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5638243">func</span>&nbsp;<span class="op" id="5638248">(</span><span class="ident" id="5638249">enc</span>&nbsp;<span class="op" id="5638253">*</span><span class="ident" id="5638254">Encoder</span><span class="op" id="5638261">)</span>&nbsp;<span class="ident" id="5638263">newEncoderState</span><span class="op" id="5638278">(</span><span class="ident" id="5638279">b</span>&nbsp;<span class="op" id="5638281">*</span><span class="ident" id="5638282">encBuffer</span><span class="op" id="5638291">)</span>&nbsp;<span class="op" id="5638293">*</span><span class="ident" id="5638294">encoderState</span>&nbsp;<span class="op" id="5638307">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638310">e</span>&nbsp;<span class="op" id="5638312">:=</span>&nbsp;<span class="ident" id="5638315">enc</span><span class="op" id="5638318">.</span><span class="ident" id="5638319">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638329">if</span>&nbsp;<span class="ident" id="5638332">e</span>&nbsp;<span class="op" id="5638334">==</span>&nbsp;<span class="builtintype" id="5638337">nil</span>&nbsp;<span class="op" id="5638341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638345">e</span>&nbsp;<span class="op" id="5638347">=</span>&nbsp;<span class="builtinfunc" id="5638349">new</span><span class="op" id="5638352">(</span><span class="ident" id="5638353">encoderState</span><span class="op" id="5638365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638369">e</span><span class="op" id="5638370">.</span><span class="ident" id="5638371">enc</span>&nbsp;<span class="op" id="5638375">=</span>&nbsp;<span class="ident" id="5638377">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638382">}</span>&nbsp;<span class="keyword" id="5638384">else</span>&nbsp;<span class="op" id="5638389">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638393">enc</span><span class="op" id="5638396">.</span><span class="ident" id="5638397">freeList</span>&nbsp;<span class="op" id="5638406">=</span>&nbsp;<span class="ident" id="5638408">e</span><span class="op" id="5638409">.</span><span class="ident" id="5638410">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638419">e</span><span class="op" id="5638420">.</span><span class="ident" id="5638421">sendZero</span>&nbsp;<span class="op" id="5638430">=</span>&nbsp;<span class="builtintype" id="5638432">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638439">e</span><span class="op" id="5638440">.</span><span class="ident" id="5638441">fieldnum</span>&nbsp;<span class="op" id="5638450">=</span>&nbsp;<span class="num" id="5638452">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638455">e</span><span class="op" id="5638456">.</span><span class="ident" id="5638457">b</span>&nbsp;<span class="op" id="5638459">=</span>&nbsp;<span class="ident" id="5638461">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638464">if</span>&nbsp;<span class="builtinfunc" id="5638467">len</span><span class="op" id="5638470">(</span><span class="ident" id="5638471">b</span><span class="op" id="5638472">.</span><span class="ident" id="5638473">data</span><span class="op" id="5638477">)</span>&nbsp;<span class="op" id="5638479">==</span>&nbsp;<span class="num" id="5638482">0</span>&nbsp;<span class="op" id="5638484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638488">b</span><span class="op" id="5638489">.</span><span class="ident" id="5638490">data</span>&nbsp;<span class="op" id="5638495">=</span>&nbsp;<span class="ident" id="5638497">b</span><span class="op" id="5638498">.</span><span class="ident" id="5638499">scratch</span><span class="op" id="5638506">[</span><span class="num" id="5638507">0</span><span class="op" id="5638508">:</span><span class="num" id="5638509">0</span><span class="op" id="5638510">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5638513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638516">return</span>&nbsp;<span class="ident" id="5638523">e</span><br>
<span class="lineno"></span><span class="op" id="5638525">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="5638528">func</span>&nbsp;<span class="op" id="5638533">(</span><span class="ident" id="5638534">enc</span>&nbsp;<span class="op" id="5638538">*</span><span class="ident" id="5638539">Encoder</span><span class="op" id="5638546">)</span>&nbsp;<span class="ident" id="5638548">freeEncoderState</span><span class="op" id="5638564">(</span><span class="ident" id="5638565">e</span>&nbsp;<span class="op" id="5638567">*</span><span class="ident" id="5638568">encoderState</span><span class="op" id="5638580">)</span>&nbsp;<span class="op" id="5638582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638585">e</span><span class="op" id="5638586">.</span><span class="ident" id="5638587">next</span>&nbsp;<span class="op" id="5638592">=</span>&nbsp;<span class="ident" id="5638594">enc</span><span class="op" id="5638597">.</span><span class="ident" id="5638598">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638608">enc</span><span class="op" id="5638611">.</span><span class="ident" id="5638612">freeList</span>&nbsp;<span class="op" id="5638621">=</span>&nbsp;<span class="ident" id="5638623">e</span><br>
<span class="lineno"></span><span class="op" id="5638625">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="5638628">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment" id="5638699">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment" id="5638760">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment" id="5638828">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="5638861">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword" id="5638922">func</span>&nbsp;<span class="op" id="5638927">(</span><span class="ident" id="5638928">state</span>&nbsp;<span class="op" id="5638934">*</span><span class="ident" id="5638935">encoderState</span><span class="op" id="5638947">)</span>&nbsp;<span class="ident" id="5638949">encodeUint</span><span class="op" id="5638959">(</span><span class="ident" id="5638960">x</span>&nbsp;<span class="builtintype" id="5638962">uint64</span><span class="op" id="5638968">)</span>&nbsp;<span class="op" id="5638970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5638973">if</span>&nbsp;<span class="ident" id="5638976">x</span>&nbsp;<span class="op" id="5638978">&lt;=</span>&nbsp;<span class="num" id="5638981">0x7F</span>&nbsp;<span class="op" id="5638986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5638990">state</span><span class="op" id="5638995">.</span><span class="ident" id="5638996">b</span><span class="op" id="5638997">.</span><span class="ident" id="5638998">WriteByte</span><span class="op" id="5639007">(</span><span class="builtintype" id="5639008">uint8</span><span class="op" id="5639013">(</span><span class="ident" id="5639014">x</span><span class="op" id="5639015">)</span><span class="op" id="5639016">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639020">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639031">i</span>&nbsp;<span class="op" id="5639033">:=</span>&nbsp;<span class="ident" id="5639036">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639048">for</span>&nbsp;<span class="ident" id="5639052">x</span>&nbsp;<span class="op" id="5639054">&gt;</span>&nbsp;<span class="num" id="5639056">0</span>&nbsp;<span class="op" id="5639058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639062">state</span><span class="op" id="5639067">.</span><span class="ident" id="5639068">buf</span><span class="op" id="5639071">[</span><span class="ident" id="5639072">i</span><span class="op" id="5639073">]</span>&nbsp;<span class="op" id="5639075">=</span>&nbsp;<span class="builtintype" id="5639077">uint8</span><span class="op" id="5639082">(</span><span class="ident" id="5639083">x</span><span class="op" id="5639084">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639088">x</span>&nbsp;<span class="op" id="5639090">&gt;&gt;=</span>&nbsp;<span class="num" id="5639094">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639098">i</span><span class="op" id="5639099">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639106">state</span><span class="op" id="5639111">.</span><span class="ident" id="5639112">buf</span><span class="op" id="5639115">[</span><span class="ident" id="5639116">i</span><span class="op" id="5639117">]</span>&nbsp;<span class="op" id="5639119">=</span>&nbsp;<span class="builtintype" id="5639121">uint8</span><span class="op" id="5639126">(</span><span class="ident" id="5639127">i</span>&nbsp;<span class="op" id="5639129">-</span>&nbsp;<span class="ident" id="5639131">uint64Size</span><span class="op" id="5639141">)</span>&nbsp;<span class="comment" id="5639143">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639169">state</span><span class="op" id="5639174">.</span><span class="ident" id="5639175">b</span><span class="op" id="5639176">.</span><span class="ident" id="5639177">Write</span><span class="op" id="5639182">(</span><span class="ident" id="5639183">state</span><span class="op" id="5639188">.</span><span class="ident" id="5639189">buf</span><span class="op" id="5639192">[</span><span class="ident" id="5639193">i</span>&nbsp;<span class="op" id="5639195">:</span>&nbsp;<span class="ident" id="5639197">uint64Size</span><span class="op" id="5639207">+</span><span class="num" id="5639208">1</span><span class="op" id="5639209">]</span><span class="op" id="5639210">)</span><br>
<span class="lineno">105</span><span class="op" id="5639212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5639215">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment" id="5639273">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment" id="5639359">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword" id="5639387">func</span>&nbsp;<span class="op" id="5639392">(</span><span class="ident" id="5639393">state</span>&nbsp;<span class="op" id="5639399">*</span><span class="ident" id="5639400">encoderState</span><span class="op" id="5639412">)</span>&nbsp;<span class="ident" id="5639414">encodeInt</span><span class="op" id="5639423">(</span><span class="ident" id="5639424">i</span>&nbsp;<span class="builtintype" id="5639426">int64</span><span class="op" id="5639431">)</span>&nbsp;<span class="op" id="5639433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639436">var</span>&nbsp;<span class="ident" id="5639440">x</span>&nbsp;<span class="builtintype" id="5639442">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5639450">if</span>&nbsp;<span class="ident" id="5639453">i</span>&nbsp;<span class="op" id="5639455">&lt;</span>&nbsp;<span class="num" id="5639457">0</span>&nbsp;<span class="op" id="5639459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639463">x</span>&nbsp;<span class="op" id="5639465">=</span>&nbsp;<span class="builtintype" id="5639467">uint64</span><span class="op" id="5639473">(</span><span class="op" id="5639474">^</span><span class="ident" id="5639475">i</span><span class="op" id="5639476">&lt;&lt;</span><span class="num" id="5639478">1</span><span class="op" id="5639479">)</span>&nbsp;<span class="op" id="5639481">|</span>&nbsp;<span class="num" id="5639483">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639486">}</span>&nbsp;<span class="keyword" id="5639488">else</span>&nbsp;<span class="op" id="5639493">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639497">x</span>&nbsp;<span class="op" id="5639499">=</span>&nbsp;<span class="builtintype" id="5639501">uint64</span><span class="op" id="5639507">(</span><span class="ident" id="5639508">i</span>&nbsp;<span class="op" id="5639510">&lt;&lt;</span>&nbsp;<span class="num" id="5639513">1</span><span class="op" id="5639514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5639517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639520">state</span><span class="op" id="5639525">.</span><span class="ident" id="5639526">encodeUint</span><span class="op" id="5639536">(</span><span class="builtintype" id="5639537">uint64</span><span class="op" id="5639543">(</span><span class="ident" id="5639544">x</span><span class="op" id="5639545">)</span><span class="op" id="5639546">)</span><br>
<span class="lineno"></span><span class="op" id="5639548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="5639551">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5639619">type</span>&nbsp;<span class="ident" id="5639624">encOp</span>&nbsp;<span class="keyword" id="5639630">func</span><span class="op" id="5639634">(</span><span class="ident" id="5639635">i</span>&nbsp;<span class="op" id="5639637">*</span><span class="ident" id="5639638">encInstr</span><span class="op" id="5639646">,</span>&nbsp;<span class="ident" id="5639648">state</span>&nbsp;<span class="op" id="5639654">*</span><span class="ident" id="5639655">encoderState</span><span class="op" id="5639667">,</span>&nbsp;<span class="ident" id="5639669">v</span>&nbsp;<span class="ident" id="5639671">reflect</span><span class="op" id="5639678">.</span><span class="ident" id="5639679">Value</span><span class="op" id="5639684">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5639687">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword" id="5639733">type</span>&nbsp;<span class="ident" id="5639738">encInstr</span>&nbsp;<span class="keyword" id="5639747">struct</span>&nbsp;<span class="op" id="5639754">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639757">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639763">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639770">field</span>&nbsp;<span class="builtintype" id="5639776">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5639782">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639808">index</span>&nbsp;<span class="op" id="5639814">[</span><span class="op" id="5639815">]</span><span class="builtintype" id="5639816">int</span>&nbsp;<span class="comment" id="5639820">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639837">indir</span>&nbsp;<span class="builtintype" id="5639843">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5639849">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op" id="5639915">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5639918">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment" id="5640011">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword" id="5640065">func</span>&nbsp;<span class="op" id="5640070">(</span><span class="ident" id="5640071">state</span>&nbsp;<span class="op" id="5640077">*</span><span class="ident" id="5640078">encoderState</span><span class="op" id="5640090">)</span>&nbsp;<span class="ident" id="5640092">update</span><span class="op" id="5640098">(</span><span class="ident" id="5640099">instr</span>&nbsp;<span class="op" id="5640105">*</span><span class="ident" id="5640106">encInstr</span><span class="op" id="5640114">)</span>&nbsp;<span class="op" id="5640116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640119">if</span>&nbsp;<span class="ident" id="5640122">instr</span>&nbsp;<span class="op" id="5640128">!=</span>&nbsp;<span class="builtintype" id="5640131">nil</span>&nbsp;<span class="op" id="5640135">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640139">state</span><span class="op" id="5640144">.</span><span class="ident" id="5640145">encodeUint</span><span class="op" id="5640155">(</span><span class="builtintype" id="5640156">uint64</span><span class="op" id="5640162">(</span><span class="ident" id="5640163">instr</span><span class="op" id="5640168">.</span><span class="ident" id="5640169">field</span>&nbsp;<span class="op" id="5640175">-</span>&nbsp;<span class="ident" id="5640177">state</span><span class="op" id="5640182">.</span><span class="ident" id="5640183">fieldnum</span><span class="op" id="5640191">)</span><span class="op" id="5640192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640196">state</span><span class="op" id="5640201">.</span><span class="ident" id="5640202">fieldnum</span>&nbsp;<span class="op" id="5640211">=</span>&nbsp;<span class="ident" id="5640213">instr</span><span class="op" id="5640218">.</span><span class="ident" id="5640219">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5640226">}</span><br>
<span class="lineno"></span><span class="op" id="5640228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="5640231">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="5640295">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="5640363">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5640430">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment" id="5640497">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment" id="5640561">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5640628">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment" id="5640694">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5640706">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword" id="5640773">func</span>&nbsp;<span class="ident" id="5640778">encIndirect</span><span class="op" id="5640789">(</span><span class="ident" id="5640790">pv</span>&nbsp;<span class="ident" id="5640793">reflect</span><span class="op" id="5640800">.</span><span class="ident" id="5640801">Value</span><span class="op" id="5640806">,</span>&nbsp;<span class="ident" id="5640808">indir</span>&nbsp;<span class="builtintype" id="5640814">int</span><span class="op" id="5640817">)</span>&nbsp;<span class="ident" id="5640819">reflect</span><span class="op" id="5640826">.</span><span class="ident" id="5640827">Value</span>&nbsp;<span class="op" id="5640833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640836">for</span>&nbsp;<span class="op" id="5640840">;</span>&nbsp;<span class="ident" id="5640842">indir</span>&nbsp;<span class="op" id="5640848">&gt;</span>&nbsp;<span class="num" id="5640850">0</span><span class="op" id="5640851">;</span>&nbsp;<span class="ident" id="5640853">indir</span><span class="op" id="5640858">--</span>&nbsp;<span class="op" id="5640861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640865">if</span>&nbsp;<span class="ident" id="5640868">pv</span><span class="op" id="5640870">.</span><span class="ident" id="5640871">IsNil</span><span class="op" id="5640876">(</span><span class="op" id="5640877">)</span>&nbsp;<span class="op" id="5640879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640884">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5640892">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5640896">pv</span>&nbsp;<span class="op" id="5640899">=</span>&nbsp;<span class="ident" id="5640901">pv</span><span class="op" id="5640903">.</span><span class="ident" id="5640904">Elem</span><span class="op" id="5640908">(</span><span class="op" id="5640909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5640912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5640915">return</span>&nbsp;<span class="ident" id="5640922">pv</span><br>
<span class="lineno"></span><span class="op" id="5640925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="5640928">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="5640995">func</span>&nbsp;<span class="ident" id="5641000">encBool</span><span class="op" id="5641007">(</span><span class="ident" id="5641008">i</span>&nbsp;<span class="op" id="5641010">*</span><span class="ident" id="5641011">encInstr</span><span class="op" id="5641019">,</span>&nbsp;<span class="ident" id="5641021">state</span>&nbsp;<span class="op" id="5641027">*</span><span class="ident" id="5641028">encoderState</span><span class="op" id="5641040">,</span>&nbsp;<span class="ident" id="5641042">v</span>&nbsp;<span class="ident" id="5641044">reflect</span><span class="op" id="5641051">.</span><span class="ident" id="5641052">Value</span><span class="op" id="5641057">)</span>&nbsp;<span class="op" id="5641059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641062">b</span>&nbsp;<span class="op" id="5641064">:=</span>&nbsp;<span class="ident" id="5641067">v</span><span class="op" id="5641068">.</span><span class="ident" id="5641069">Bool</span><span class="op" id="5641073">(</span><span class="op" id="5641074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641077">if</span>&nbsp;<span class="ident" id="5641080">b</span>&nbsp;<span class="op" id="5641082">||</span>&nbsp;<span class="ident" id="5641085">state</span><span class="op" id="5641090">.</span><span class="ident" id="5641091">sendZero</span>&nbsp;<span class="op" id="5641100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641104">state</span><span class="op" id="5641109">.</span><span class="ident" id="5641110">update</span><span class="op" id="5641116">(</span><span class="ident" id="5641117">i</span><span class="op" id="5641118">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641122">if</span>&nbsp;<span class="ident" id="5641125">b</span>&nbsp;<span class="op" id="5641127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641132">state</span><span class="op" id="5641137">.</span><span class="ident" id="5641138">encodeUint</span><span class="op" id="5641148">(</span><span class="num" id="5641149">1</span><span class="op" id="5641150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641154">}</span>&nbsp;<span class="keyword" id="5641156">else</span>&nbsp;<span class="op" id="5641161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641166">state</span><span class="op" id="5641171">.</span><span class="ident" id="5641172">encodeUint</span><span class="op" id="5641182">(</span><span class="num" id="5641183">0</span><span class="op" id="5641184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641188">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641191">}</span><br>
<span class="lineno"></span><span class="op" id="5641193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5641196">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5641279">func</span>&nbsp;<span class="ident" id="5641284">encInt</span><span class="op" id="5641290">(</span><span class="ident" id="5641291">i</span>&nbsp;<span class="op" id="5641293">*</span><span class="ident" id="5641294">encInstr</span><span class="op" id="5641302">,</span>&nbsp;<span class="ident" id="5641304">state</span>&nbsp;<span class="op" id="5641310">*</span><span class="ident" id="5641311">encoderState</span><span class="op" id="5641323">,</span>&nbsp;<span class="ident" id="5641325">v</span>&nbsp;<span class="ident" id="5641327">reflect</span><span class="op" id="5641334">.</span><span class="ident" id="5641335">Value</span><span class="op" id="5641340">)</span>&nbsp;<span class="op" id="5641342">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641345">value</span>&nbsp;<span class="op" id="5641351">:=</span>&nbsp;<span class="ident" id="5641354">v</span><span class="op" id="5641355">.</span><span class="ident" id="5641356">Int</span><span class="op" id="5641359">(</span><span class="op" id="5641360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641363">if</span>&nbsp;<span class="ident" id="5641366">value</span>&nbsp;<span class="op" id="5641372">!=</span>&nbsp;<span class="num" id="5641375">0</span>&nbsp;<span class="op" id="5641377">||</span>&nbsp;<span class="ident" id="5641380">state</span><span class="op" id="5641385">.</span><span class="ident" id="5641386">sendZero</span>&nbsp;<span class="op" id="5641395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641399">state</span><span class="op" id="5641404">.</span><span class="ident" id="5641405">update</span><span class="op" id="5641411">(</span><span class="ident" id="5641412">i</span><span class="op" id="5641413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641417">state</span><span class="op" id="5641422">.</span><span class="ident" id="5641423">encodeInt</span><span class="op" id="5641432">(</span><span class="ident" id="5641433">value</span><span class="op" id="5641438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641441">}</span><br>
<span class="lineno">180</span><span class="op" id="5641443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5641446">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5641545">func</span>&nbsp;<span class="ident" id="5641550">encUint</span><span class="op" id="5641557">(</span><span class="ident" id="5641558">i</span>&nbsp;<span class="op" id="5641560">*</span><span class="ident" id="5641561">encInstr</span><span class="op" id="5641569">,</span>&nbsp;<span class="ident" id="5641571">state</span>&nbsp;<span class="op" id="5641577">*</span><span class="ident" id="5641578">encoderState</span><span class="op" id="5641590">,</span>&nbsp;<span class="ident" id="5641592">v</span>&nbsp;<span class="ident" id="5641594">reflect</span><span class="op" id="5641601">.</span><span class="ident" id="5641602">Value</span><span class="op" id="5641607">)</span>&nbsp;<span class="op" id="5641609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641612">value</span>&nbsp;<span class="op" id="5641618">:=</span>&nbsp;<span class="ident" id="5641621">v</span><span class="op" id="5641622">.</span><span class="ident" id="5641623">Uint</span><span class="op" id="5641627">(</span><span class="op" id="5641628">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5641631">if</span>&nbsp;<span class="ident" id="5641634">value</span>&nbsp;<span class="op" id="5641640">!=</span>&nbsp;<span class="num" id="5641643">0</span>&nbsp;<span class="op" id="5641645">||</span>&nbsp;<span class="ident" id="5641648">state</span><span class="op" id="5641653">.</span><span class="ident" id="5641654">sendZero</span>&nbsp;<span class="op" id="5641663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641667">state</span><span class="op" id="5641672">.</span><span class="ident" id="5641673">update</span><span class="op" id="5641679">(</span><span class="ident" id="5641680">i</span><span class="op" id="5641681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5641685">state</span><span class="op" id="5641690">.</span><span class="ident" id="5641691">encodeUint</span><span class="op" id="5641701">(</span><span class="ident" id="5641702">value</span><span class="op" id="5641707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5641710">}</span><br>
<span class="lineno"></span><span class="op" id="5641712">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5641715">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment" id="5641790">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="5641860">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5641932">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment" id="5642004">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5642069">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword" id="5642083">func</span>&nbsp;<span class="ident" id="5642088">floatBits</span><span class="op" id="5642097">(</span><span class="ident" id="5642098">f</span>&nbsp;<span class="builtintype" id="5642100">float64</span><span class="op" id="5642107">)</span>&nbsp;<span class="builtintype" id="5642109">uint64</span>&nbsp;<span class="op" id="5642116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642119">u</span>&nbsp;<span class="op" id="5642121">:=</span>&nbsp;<span class="ident" id="5642124">math</span><span class="op" id="5642128">.</span><span class="ident" id="5642129">Float64bits</span><span class="op" id="5642140">(</span><span class="ident" id="5642141">f</span><span class="op" id="5642142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642145">var</span>&nbsp;<span class="ident" id="5642149">v</span>&nbsp;<span class="builtintype" id="5642151">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642159">for</span>&nbsp;<span class="ident" id="5642163">i</span>&nbsp;<span class="op" id="5642165">:=</span>&nbsp;<span class="num" id="5642168">0</span><span class="op" id="5642169">;</span>&nbsp;<span class="ident" id="5642171">i</span>&nbsp;<span class="op" id="5642173">&lt;</span>&nbsp;<span class="num" id="5642175">8</span><span class="op" id="5642176">;</span>&nbsp;<span class="ident" id="5642178">i</span><span class="op" id="5642179">++</span>&nbsp;<span class="op" id="5642182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642186">v</span>&nbsp;<span class="op" id="5642188">&lt;&lt;=</span>&nbsp;<span class="num" id="5642192">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642196">v</span>&nbsp;<span class="op" id="5642198">|=</span>&nbsp;<span class="ident" id="5642201">u</span>&nbsp;<span class="op" id="5642203">&amp;</span>&nbsp;<span class="num" id="5642205">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642212">u</span>&nbsp;<span class="op" id="5642214">&gt;&gt;=</span>&nbsp;<span class="num" id="5642218">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642221">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642224">return</span>&nbsp;<span class="ident" id="5642231">v</span><br>
<span class="lineno"></span><span class="op" id="5642233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5642236">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5642316">func</span>&nbsp;<span class="ident" id="5642321">encFloat</span><span class="op" id="5642329">(</span><span class="ident" id="5642330">i</span>&nbsp;<span class="op" id="5642332">*</span><span class="ident" id="5642333">encInstr</span><span class="op" id="5642341">,</span>&nbsp;<span class="ident" id="5642343">state</span>&nbsp;<span class="op" id="5642349">*</span><span class="ident" id="5642350">encoderState</span><span class="op" id="5642362">,</span>&nbsp;<span class="ident" id="5642364">v</span>&nbsp;<span class="ident" id="5642366">reflect</span><span class="op" id="5642373">.</span><span class="ident" id="5642374">Value</span><span class="op" id="5642379">)</span>&nbsp;<span class="op" id="5642381">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642384">f</span>&nbsp;<span class="op" id="5642386">:=</span>&nbsp;<span class="ident" id="5642389">v</span><span class="op" id="5642390">.</span><span class="ident" id="5642391">Float</span><span class="op" id="5642396">(</span><span class="op" id="5642397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642400">if</span>&nbsp;<span class="ident" id="5642403">f</span>&nbsp;<span class="op" id="5642405">!=</span>&nbsp;<span class="num" id="5642408">0</span>&nbsp;<span class="op" id="5642410">||</span>&nbsp;<span class="ident" id="5642413">state</span><span class="op" id="5642418">.</span><span class="ident" id="5642419">sendZero</span>&nbsp;<span class="op" id="5642428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642432">bits</span>&nbsp;<span class="op" id="5642437">:=</span>&nbsp;<span class="ident" id="5642440">floatBits</span><span class="op" id="5642449">(</span><span class="ident" id="5642450">f</span><span class="op" id="5642451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642455">state</span><span class="op" id="5642460">.</span><span class="ident" id="5642461">update</span><span class="op" id="5642467">(</span><span class="ident" id="5642468">i</span><span class="op" id="5642469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642473">state</span><span class="op" id="5642478">.</span><span class="ident" id="5642479">encodeUint</span><span class="op" id="5642489">(</span><span class="ident" id="5642490">bits</span><span class="op" id="5642494">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642497">}</span><br>
<span class="lineno"></span><span class="op" id="5642499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5642502">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5642582">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword" id="5642661">func</span>&nbsp;<span class="ident" id="5642666">encComplex</span><span class="op" id="5642676">(</span><span class="ident" id="5642677">i</span>&nbsp;<span class="op" id="5642679">*</span><span class="ident" id="5642680">encInstr</span><span class="op" id="5642688">,</span>&nbsp;<span class="ident" id="5642690">state</span>&nbsp;<span class="op" id="5642696">*</span><span class="ident" id="5642697">encoderState</span><span class="op" id="5642709">,</span>&nbsp;<span class="ident" id="5642711">v</span>&nbsp;<span class="ident" id="5642713">reflect</span><span class="op" id="5642720">.</span><span class="ident" id="5642721">Value</span><span class="op" id="5642726">)</span>&nbsp;<span class="op" id="5642728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642731">c</span>&nbsp;<span class="op" id="5642733">:=</span>&nbsp;<span class="ident" id="5642736">v</span><span class="op" id="5642737">.</span><span class="ident" id="5642738">Complex</span><span class="op" id="5642745">(</span><span class="op" id="5642746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5642749">if</span>&nbsp;<span class="ident" id="5642752">c</span>&nbsp;<span class="op" id="5642754">!=</span>&nbsp;<span class="num" id="5642757">0</span><span class="op" id="5642758">+</span><span class="num" id="5642759">0i</span>&nbsp;<span class="op" id="5642762">||</span>&nbsp;<span class="ident" id="5642765">state</span><span class="op" id="5642770">.</span><span class="ident" id="5642771">sendZero</span>&nbsp;<span class="op" id="5642780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642784">rpart</span>&nbsp;<span class="op" id="5642790">:=</span>&nbsp;<span class="ident" id="5642793">floatBits</span><span class="op" id="5642802">(</span><span class="builtinfunc" id="5642803">real</span><span class="op" id="5642807">(</span><span class="ident" id="5642808">c</span><span class="op" id="5642809">)</span><span class="op" id="5642810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642814">ipart</span>&nbsp;<span class="op" id="5642820">:=</span>&nbsp;<span class="ident" id="5642823">floatBits</span><span class="op" id="5642832">(</span><span class="builtinfunc" id="5642833">imag</span><span class="op" id="5642837">(</span><span class="ident" id="5642838">c</span><span class="op" id="5642839">)</span><span class="op" id="5642840">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642844">state</span><span class="op" id="5642849">.</span><span class="ident" id="5642850">update</span><span class="op" id="5642856">(</span><span class="ident" id="5642857">i</span><span class="op" id="5642858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642862">state</span><span class="op" id="5642867">.</span><span class="ident" id="5642868">encodeUint</span><span class="op" id="5642878">(</span><span class="ident" id="5642879">rpart</span><span class="op" id="5642884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5642888">state</span><span class="op" id="5642893">.</span><span class="ident" id="5642894">encodeUint</span><span class="op" id="5642904">(</span><span class="ident" id="5642905">ipart</span><span class="op" id="5642910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5642913">}</span><br>
<span class="lineno"></span><span class="op" id="5642915">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5642918">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5642975">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5643050">func</span>&nbsp;<span class="ident" id="5643055">encUint8Array</span><span class="op" id="5643068">(</span><span class="ident" id="5643069">i</span>&nbsp;<span class="op" id="5643071">*</span><span class="ident" id="5643072">encInstr</span><span class="op" id="5643080">,</span>&nbsp;<span class="ident" id="5643082">state</span>&nbsp;<span class="op" id="5643088">*</span><span class="ident" id="5643089">encoderState</span><span class="op" id="5643101">,</span>&nbsp;<span class="ident" id="5643103">v</span>&nbsp;<span class="ident" id="5643105">reflect</span><span class="op" id="5643112">.</span><span class="ident" id="5643113">Value</span><span class="op" id="5643118">)</span>&nbsp;<span class="op" id="5643120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643123">b</span>&nbsp;<span class="op" id="5643125">:=</span>&nbsp;<span class="ident" id="5643128">v</span><span class="op" id="5643129">.</span><span class="ident" id="5643130">Bytes</span><span class="op" id="5643135">(</span><span class="op" id="5643136">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643139">if</span>&nbsp;<span class="builtinfunc" id="5643142">len</span><span class="op" id="5643145">(</span><span class="ident" id="5643146">b</span><span class="op" id="5643147">)</span>&nbsp;<span class="op" id="5643149">&gt;</span>&nbsp;<span class="num" id="5643151">0</span>&nbsp;<span class="op" id="5643153">||</span>&nbsp;<span class="ident" id="5643156">state</span><span class="op" id="5643161">.</span><span class="ident" id="5643162">sendZero</span>&nbsp;<span class="op" id="5643171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643175">state</span><span class="op" id="5643180">.</span><span class="ident" id="5643181">update</span><span class="op" id="5643187">(</span><span class="ident" id="5643188">i</span><span class="op" id="5643189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643193">state</span><span class="op" id="5643198">.</span><span class="ident" id="5643199">encodeUint</span><span class="op" id="5643209">(</span><span class="builtintype" id="5643210">uint64</span><span class="op" id="5643216">(</span><span class="builtinfunc" id="5643217">len</span><span class="op" id="5643220">(</span><span class="ident" id="5643221">b</span><span class="op" id="5643222">)</span><span class="op" id="5643223">)</span><span class="op" id="5643224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643228">state</span><span class="op" id="5643233">.</span><span class="ident" id="5643234">b</span><span class="op" id="5643235">.</span><span class="ident" id="5643236">Write</span><span class="op" id="5643241">(</span><span class="ident" id="5643242">b</span><span class="op" id="5643243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5643246">}</span><br>
<span class="lineno">240</span><span class="op" id="5643248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5643251">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5643300">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5643371">func</span>&nbsp;<span class="ident" id="5643376">encString</span><span class="op" id="5643385">(</span><span class="ident" id="5643386">i</span>&nbsp;<span class="op" id="5643388">*</span><span class="ident" id="5643389">encInstr</span><span class="op" id="5643397">,</span>&nbsp;<span class="ident" id="5643399">state</span>&nbsp;<span class="op" id="5643405">*</span><span class="ident" id="5643406">encoderState</span><span class="op" id="5643418">,</span>&nbsp;<span class="ident" id="5643420">v</span>&nbsp;<span class="ident" id="5643422">reflect</span><span class="op" id="5643429">.</span><span class="ident" id="5643430">Value</span><span class="op" id="5643435">)</span>&nbsp;<span class="op" id="5643437">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643440">s</span>&nbsp;<span class="op" id="5643442">:=</span>&nbsp;<span class="ident" id="5643445">v</span><span class="op" id="5643446">.</span><span class="ident" id="5643447">String</span><span class="op" id="5643453">(</span><span class="op" id="5643454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5643457">if</span>&nbsp;<span class="builtinfunc" id="5643460">len</span><span class="op" id="5643463">(</span><span class="ident" id="5643464">s</span><span class="op" id="5643465">)</span>&nbsp;<span class="op" id="5643467">&gt;</span>&nbsp;<span class="num" id="5643469">0</span>&nbsp;<span class="op" id="5643471">||</span>&nbsp;<span class="ident" id="5643474">state</span><span class="op" id="5643479">.</span><span class="ident" id="5643480">sendZero</span>&nbsp;<span class="op" id="5643489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643493">state</span><span class="op" id="5643498">.</span><span class="ident" id="5643499">update</span><span class="op" id="5643505">(</span><span class="ident" id="5643506">i</span><span class="op" id="5643507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643511">state</span><span class="op" id="5643516">.</span><span class="ident" id="5643517">encodeUint</span><span class="op" id="5643527">(</span><span class="builtintype" id="5643528">uint64</span><span class="op" id="5643534">(</span><span class="builtinfunc" id="5643535">len</span><span class="op" id="5643538">(</span><span class="ident" id="5643539">s</span><span class="op" id="5643540">)</span><span class="op" id="5643541">)</span><span class="op" id="5643542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643546">state</span><span class="op" id="5643551">.</span><span class="ident" id="5643552">b</span><span class="op" id="5643553">.</span><span class="ident" id="5643554">WriteString</span><span class="op" id="5643565">(</span><span class="ident" id="5643566">s</span><span class="op" id="5643567">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5643570">}</span><br>
<span class="lineno"></span><span class="op" id="5643572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5643575">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="5643635">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword" id="5643666">func</span>&nbsp;<span class="ident" id="5643671">encStructTerminator</span><span class="op" id="5643690">(</span><span class="ident" id="5643691">i</span>&nbsp;<span class="op" id="5643693">*</span><span class="ident" id="5643694">encInstr</span><span class="op" id="5643702">,</span>&nbsp;<span class="ident" id="5643704">state</span>&nbsp;<span class="op" id="5643710">*</span><span class="ident" id="5643711">encoderState</span><span class="op" id="5643723">,</span>&nbsp;<span class="ident" id="5643725">v</span>&nbsp;<span class="ident" id="5643727">reflect</span><span class="op" id="5643734">.</span><span class="ident" id="5643735">Value</span><span class="op" id="5643740">)</span>&nbsp;<span class="op" id="5643742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643745">state</span><span class="op" id="5643750">.</span><span class="ident" id="5643751">encodeUint</span><span class="op" id="5643761">(</span><span class="num" id="5643762">0</span><span class="op" id="5643763">)</span><br>
<span class="lineno"></span><span class="op" id="5643765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5643768">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="5643789">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment" id="5643867">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="5643947">type</span>&nbsp;<span class="ident" id="5643952">encEngine</span>&nbsp;<span class="keyword" id="5643962">struct</span>&nbsp;<span class="op" id="5643969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5643972">instr</span>&nbsp;<span class="op" id="5643978">[</span><span class="op" id="5643979">]</span><span class="ident" id="5643980">encInstr</span><br>
<span class="lineno">265</span><span class="op" id="5643989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5643992">const</span>&nbsp;<span class="ident" id="5643998">singletonField</span>&nbsp;<span class="op" id="5644013">=</span>&nbsp;<span class="num" id="5644015">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5644018">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment" id="5644085">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword" id="5644139">func</span>&nbsp;<span class="ident" id="5644144">valid</span><span class="op" id="5644149">(</span><span class="ident" id="5644150">v</span>&nbsp;<span class="ident" id="5644152">reflect</span><span class="op" id="5644159">.</span><span class="ident" id="5644160">Value</span><span class="op" id="5644165">)</span>&nbsp;<span class="builtintype" id="5644167">bool</span>&nbsp;<span class="op" id="5644172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644175">switch</span>&nbsp;<span class="ident" id="5644182">v</span><span class="op" id="5644183">.</span><span class="ident" id="5644184">Kind</span><span class="op" id="5644188">(</span><span class="op" id="5644189">)</span>&nbsp;<span class="op" id="5644191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644194">case</span>&nbsp;<span class="ident" id="5644199">reflect</span><span class="op" id="5644206">.</span><span class="ident" id="5644207">Invalid</span><span class="op" id="5644214">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644218">return</span>&nbsp;<span class="builtintype" id="5644225">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644232">case</span>&nbsp;<span class="ident" id="5644237">reflect</span><span class="op" id="5644244">.</span><span class="ident" id="5644245">Ptr</span><span class="op" id="5644248">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644252">return</span>&nbsp;<span class="op" id="5644259">!</span><span class="ident" id="5644260">v</span><span class="op" id="5644261">.</span><span class="ident" id="5644262">IsNil</span><span class="op" id="5644267">(</span><span class="op" id="5644268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5644271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644274">return</span>&nbsp;<span class="builtintype" id="5644281">true</span><br>
<span class="lineno"></span><span class="op" id="5644286">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="5644289">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5644350">func</span>&nbsp;<span class="op" id="5644355">(</span><span class="ident" id="5644356">enc</span>&nbsp;<span class="op" id="5644360">*</span><span class="ident" id="5644361">Encoder</span><span class="op" id="5644368">)</span>&nbsp;<span class="ident" id="5644370">encodeSingle</span><span class="op" id="5644382">(</span><span class="ident" id="5644383">b</span>&nbsp;<span class="op" id="5644385">*</span><span class="ident" id="5644386">encBuffer</span><span class="op" id="5644395">,</span>&nbsp;<span class="ident" id="5644397">engine</span>&nbsp;<span class="op" id="5644404">*</span><span class="ident" id="5644405">encEngine</span><span class="op" id="5644414">,</span>&nbsp;<span class="ident" id="5644416">value</span>&nbsp;<span class="ident" id="5644422">reflect</span><span class="op" id="5644429">.</span><span class="ident" id="5644430">Value</span><span class="op" id="5644435">)</span>&nbsp;<span class="op" id="5644437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644440">state</span>&nbsp;<span class="op" id="5644446">:=</span>&nbsp;<span class="ident" id="5644449">enc</span><span class="op" id="5644452">.</span><span class="ident" id="5644453">newEncoderState</span><span class="op" id="5644468">(</span><span class="ident" id="5644469">b</span><span class="op" id="5644470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644473">defer</span>&nbsp;<span class="ident" id="5644479">enc</span><span class="op" id="5644482">.</span><span class="ident" id="5644483">freeEncoderState</span><span class="op" id="5644499">(</span><span class="ident" id="5644500">state</span><span class="op" id="5644505">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644508">state</span><span class="op" id="5644513">.</span><span class="ident" id="5644514">fieldnum</span>&nbsp;<span class="op" id="5644523">=</span>&nbsp;<span class="ident" id="5644525">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644541">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5644614">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644685">state</span><span class="op" id="5644690">.</span><span class="ident" id="5644691">sendZero</span>&nbsp;<span class="op" id="5644700">=</span>&nbsp;<span class="builtintype" id="5644702">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644708">instr</span>&nbsp;<span class="op" id="5644714">:=</span>&nbsp;<span class="op" id="5644717">&amp;</span><span class="ident" id="5644718">engine</span><span class="op" id="5644724">.</span><span class="ident" id="5644725">instr</span><span class="op" id="5644730">[</span><span class="ident" id="5644731">singletonField</span><span class="op" id="5644745">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644748">if</span>&nbsp;<span class="ident" id="5644751">instr</span><span class="op" id="5644756">.</span><span class="ident" id="5644757">indir</span>&nbsp;<span class="op" id="5644763">&gt;</span>&nbsp;<span class="num" id="5644765">0</span>&nbsp;<span class="op" id="5644767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644771">value</span>&nbsp;<span class="op" id="5644777">=</span>&nbsp;<span class="ident" id="5644779">encIndirect</span><span class="op" id="5644790">(</span><span class="ident" id="5644791">value</span><span class="op" id="5644796">,</span>&nbsp;<span class="ident" id="5644798">instr</span><span class="op" id="5644803">.</span><span class="ident" id="5644804">indir</span><span class="op" id="5644809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5644812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5644815">if</span>&nbsp;<span class="ident" id="5644818">valid</span><span class="op" id="5644823">(</span><span class="ident" id="5644824">value</span><span class="op" id="5644829">)</span>&nbsp;<span class="op" id="5644831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5644835">instr</span><span class="op" id="5644840">.</span><span class="ident" id="5644841">op</span><span class="op" id="5644843">(</span><span class="ident" id="5644844">instr</span><span class="op" id="5644849">,</span>&nbsp;<span class="ident" id="5644851">state</span><span class="op" id="5644856">,</span>&nbsp;<span class="ident" id="5644858">value</span><span class="op" id="5644863">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5644866">}</span><br>
<span class="lineno"></span><span class="op" id="5644868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5644871">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5644918">func</span>&nbsp;<span class="op" id="5644923">(</span><span class="ident" id="5644924">enc</span>&nbsp;<span class="op" id="5644928">*</span><span class="ident" id="5644929">Encoder</span><span class="op" id="5644936">)</span>&nbsp;<span class="ident" id="5644938">encodeStruct</span><span class="op" id="5644950">(</span><span class="ident" id="5644951">b</span>&nbsp;<span class="op" id="5644953">*</span><span class="ident" id="5644954">encBuffer</span><span class="op" id="5644963">,</span>&nbsp;<span class="ident" id="5644965">engine</span>&nbsp;<span class="op" id="5644972">*</span><span class="ident" id="5644973">encEngine</span><span class="op" id="5644982">,</span>&nbsp;<span class="ident" id="5644984">value</span>&nbsp;<span class="ident" id="5644990">reflect</span><span class="op" id="5644997">.</span><span class="ident" id="5644998">Value</span><span class="op" id="5645003">)</span>&nbsp;<span class="op" id="5645005">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645008">if</span>&nbsp;<span class="op" id="5645011">!</span><span class="ident" id="5645012">valid</span><span class="op" id="5645017">(</span><span class="ident" id="5645018">value</span><span class="op" id="5645023">)</span>&nbsp;<span class="op" id="5645025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645029">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5645037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645040">state</span>&nbsp;<span class="op" id="5645046">:=</span>&nbsp;<span class="ident" id="5645049">enc</span><span class="op" id="5645052">.</span><span class="ident" id="5645053">newEncoderState</span><span class="op" id="5645068">(</span><span class="ident" id="5645069">b</span><span class="op" id="5645070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645073">defer</span>&nbsp;<span class="ident" id="5645079">enc</span><span class="op" id="5645082">.</span><span class="ident" id="5645083">freeEncoderState</span><span class="op" id="5645099">(</span><span class="ident" id="5645100">state</span><span class="op" id="5645105">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645108">state</span><span class="op" id="5645113">.</span><span class="ident" id="5645114">fieldnum</span>&nbsp;<span class="op" id="5645123">=</span>&nbsp;<span class="op" id="5645125">-</span><span class="num" id="5645126">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645129">for</span>&nbsp;<span class="ident" id="5645133">i</span>&nbsp;<span class="op" id="5645135">:=</span>&nbsp;<span class="num" id="5645138">0</span><span class="op" id="5645139">;</span>&nbsp;<span class="ident" id="5645141">i</span>&nbsp;<span class="op" id="5645143">&lt;</span>&nbsp;<span class="builtinfunc" id="5645145">len</span><span class="op" id="5645148">(</span><span class="ident" id="5645149">engine</span><span class="op" id="5645155">.</span><span class="ident" id="5645156">instr</span><span class="op" id="5645161">)</span><span class="op" id="5645162">;</span>&nbsp;<span class="ident" id="5645164">i</span><span class="op" id="5645165">++</span>&nbsp;<span class="op" id="5645168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645172">instr</span>&nbsp;<span class="op" id="5645178">:=</span>&nbsp;<span class="op" id="5645181">&amp;</span><span class="ident" id="5645182">engine</span><span class="op" id="5645188">.</span><span class="ident" id="5645189">instr</span><span class="op" id="5645194">[</span><span class="ident" id="5645195">i</span><span class="op" id="5645196">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645200">if</span>&nbsp;<span class="ident" id="5645203">i</span>&nbsp;<span class="op" id="5645205">&gt;=</span>&nbsp;<span class="ident" id="5645208">value</span><span class="op" id="5645213">.</span><span class="ident" id="5645214">NumField</span><span class="op" id="5645222">(</span><span class="op" id="5645223">)</span>&nbsp;<span class="op" id="5645225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5645230">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645256">instr</span><span class="op" id="5645261">.</span><span class="ident" id="5645262">op</span><span class="op" id="5645264">(</span><span class="ident" id="5645265">instr</span><span class="op" id="5645270">,</span>&nbsp;<span class="ident" id="5645272">state</span><span class="op" id="5645277">,</span>&nbsp;<span class="ident" id="5645279">reflect</span><span class="op" id="5645286">.</span><span class="ident" id="5645287">Value</span><span class="op" id="5645292">{</span><span class="op" id="5645293">}</span><span class="op" id="5645294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645299">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5645307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645311">field</span>&nbsp;<span class="op" id="5645317">:=</span>&nbsp;<span class="ident" id="5645320">value</span><span class="op" id="5645325">.</span><span class="ident" id="5645326">FieldByIndex</span><span class="op" id="5645338">(</span><span class="ident" id="5645339">instr</span><span class="op" id="5645344">.</span><span class="ident" id="5645345">index</span><span class="op" id="5645350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645354">if</span>&nbsp;<span class="ident" id="5645357">instr</span><span class="op" id="5645362">.</span><span class="ident" id="5645363">indir</span>&nbsp;<span class="op" id="5645369">&gt;</span>&nbsp;<span class="num" id="5645371">0</span>&nbsp;<span class="op" id="5645373">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645378">field</span>&nbsp;<span class="op" id="5645384">=</span>&nbsp;<span class="ident" id="5645386">encIndirect</span><span class="op" id="5645397">(</span><span class="ident" id="5645398">field</span><span class="op" id="5645403">,</span>&nbsp;<span class="ident" id="5645405">instr</span><span class="op" id="5645410">.</span><span class="ident" id="5645411">indir</span><span class="op" id="5645416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5645421">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645493">if</span>&nbsp;<span class="op" id="5645496">!</span><span class="ident" id="5645497">valid</span><span class="op" id="5645502">(</span><span class="ident" id="5645503">field</span><span class="op" id="5645508">)</span>&nbsp;<span class="op" id="5645510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645516">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5645528">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5645532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645536">instr</span><span class="op" id="5645541">.</span><span class="ident" id="5645542">op</span><span class="op" id="5645544">(</span><span class="ident" id="5645545">instr</span><span class="op" id="5645550">,</span>&nbsp;<span class="ident" id="5645552">state</span><span class="op" id="5645557">,</span>&nbsp;<span class="ident" id="5645559">field</span><span class="op" id="5645564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5645567">}</span><br>
<span class="lineno"></span><span class="op" id="5645569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="5645572">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="5645605">func</span>&nbsp;<span class="op" id="5645610">(</span><span class="ident" id="5645611">enc</span>&nbsp;<span class="op" id="5645615">*</span><span class="ident" id="5645616">Encoder</span><span class="op" id="5645623">)</span>&nbsp;<span class="ident" id="5645625">encodeArray</span><span class="op" id="5645636">(</span><span class="ident" id="5645637">b</span>&nbsp;<span class="op" id="5645639">*</span><span class="ident" id="5645640">encBuffer</span><span class="op" id="5645649">,</span>&nbsp;<span class="ident" id="5645651">value</span>&nbsp;<span class="ident" id="5645657">reflect</span><span class="op" id="5645664">.</span><span class="ident" id="5645665">Value</span><span class="op" id="5645670">,</span>&nbsp;<span class="ident" id="5645672">op</span>&nbsp;<span class="ident" id="5645675">encOp</span><span class="op" id="5645680">,</span>&nbsp;<span class="ident" id="5645682">elemIndir</span>&nbsp;<span class="builtintype" id="5645692">int</span><span class="op" id="5645695">,</span>&nbsp;<span class="ident" id="5645697">length</span>&nbsp;<span class="builtintype" id="5645704">int</span><span class="op" id="5645707">,</span>&nbsp;<span class="ident" id="5645709">helper</span>&nbsp;<span class="ident" id="5645716">encHelper</span><span class="op" id="5645725">)</span>&nbsp;<span class="op" id="5645727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645730">state</span>&nbsp;<span class="op" id="5645736">:=</span>&nbsp;<span class="ident" id="5645739">enc</span><span class="op" id="5645742">.</span><span class="ident" id="5645743">newEncoderState</span><span class="op" id="5645758">(</span><span class="ident" id="5645759">b</span><span class="op" id="5645760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645763">defer</span>&nbsp;<span class="ident" id="5645769">enc</span><span class="op" id="5645772">.</span><span class="ident" id="5645773">freeEncoderState</span><span class="op" id="5645789">(</span><span class="ident" id="5645790">state</span><span class="op" id="5645795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645798">state</span><span class="op" id="5645803">.</span><span class="ident" id="5645804">fieldnum</span>&nbsp;<span class="op" id="5645813">=</span>&nbsp;<span class="op" id="5645815">-</span><span class="num" id="5645816">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645819">state</span><span class="op" id="5645824">.</span><span class="ident" id="5645825">sendZero</span>&nbsp;<span class="op" id="5645834">=</span>&nbsp;<span class="builtintype" id="5645836">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645842">state</span><span class="op" id="5645847">.</span><span class="ident" id="5645848">encodeUint</span><span class="op" id="5645858">(</span><span class="builtintype" id="5645859">uint64</span><span class="op" id="5645865">(</span><span class="ident" id="5645866">length</span><span class="op" id="5645872">)</span><span class="op" id="5645873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645876">if</span>&nbsp;<span class="ident" id="5645879">helper</span>&nbsp;<span class="op" id="5645886">!=</span>&nbsp;<span class="builtintype" id="5645889">nil</span>&nbsp;<span class="op" id="5645893">&amp;&amp;</span>&nbsp;<span class="ident" id="5645896">helper</span><span class="op" id="5645902">(</span><span class="ident" id="5645903">state</span><span class="op" id="5645908">,</span>&nbsp;<span class="ident" id="5645910">value</span><span class="op" id="5645915">)</span>&nbsp;<span class="op" id="5645917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645921">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5645929">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645932">for</span>&nbsp;<span class="ident" id="5645936">i</span>&nbsp;<span class="op" id="5645938">:=</span>&nbsp;<span class="num" id="5645941">0</span><span class="op" id="5645942">;</span>&nbsp;<span class="ident" id="5645944">i</span>&nbsp;<span class="op" id="5645946">&lt;</span>&nbsp;<span class="ident" id="5645948">length</span><span class="op" id="5645954">;</span>&nbsp;<span class="ident" id="5645956">i</span><span class="op" id="5645957">++</span>&nbsp;<span class="op" id="5645960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5645964">elem</span>&nbsp;<span class="op" id="5645969">:=</span>&nbsp;<span class="ident" id="5645972">value</span><span class="op" id="5645977">.</span><span class="ident" id="5645978">Index</span><span class="op" id="5645983">(</span><span class="ident" id="5645984">i</span><span class="op" id="5645985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5645989">if</span>&nbsp;<span class="ident" id="5645992">elemIndir</span>&nbsp;<span class="op" id="5646002">&gt;</span>&nbsp;<span class="num" id="5646004">0</span>&nbsp;<span class="op" id="5646006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646011">elem</span>&nbsp;<span class="op" id="5646016">=</span>&nbsp;<span class="ident" id="5646018">encIndirect</span><span class="op" id="5646029">(</span><span class="ident" id="5646030">elem</span><span class="op" id="5646034">,</span>&nbsp;<span class="ident" id="5646036">elemIndir</span><span class="op" id="5646045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5646050">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646121">if</span>&nbsp;<span class="op" id="5646124">!</span><span class="ident" id="5646125">valid</span><span class="op" id="5646130">(</span><span class="ident" id="5646131">elem</span><span class="op" id="5646135">)</span>&nbsp;<span class="op" id="5646137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646143">errorf</span><span class="op" id="5646149">(</span><span class="string" id="5646150">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="5646176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646189">op</span><span class="op" id="5646191">(</span><span class="builtintype" id="5646192">nil</span><span class="op" id="5646195">,</span>&nbsp;<span class="ident" id="5646197">state</span><span class="op" id="5646202">,</span>&nbsp;<span class="ident" id="5646204">elem</span><span class="op" id="5646208">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646211">}</span><br>
<span class="lineno"></span><span class="op" id="5646213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5646216">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5646284">func</span>&nbsp;<span class="ident" id="5646289">encodeReflectValue</span><span class="op" id="5646307">(</span><span class="ident" id="5646308">state</span>&nbsp;<span class="op" id="5646314">*</span><span class="ident" id="5646315">encoderState</span><span class="op" id="5646327">,</span>&nbsp;<span class="ident" id="5646329">v</span>&nbsp;<span class="ident" id="5646331">reflect</span><span class="op" id="5646338">.</span><span class="ident" id="5646339">Value</span><span class="op" id="5646344">,</span>&nbsp;<span class="ident" id="5646346">op</span>&nbsp;<span class="ident" id="5646349">encOp</span><span class="op" id="5646354">,</span>&nbsp;<span class="ident" id="5646356">indir</span>&nbsp;<span class="builtintype" id="5646362">int</span><span class="op" id="5646365">)</span>&nbsp;<span class="op" id="5646367">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646370">for</span>&nbsp;<span class="ident" id="5646374">i</span>&nbsp;<span class="op" id="5646376">:=</span>&nbsp;<span class="num" id="5646379">0</span><span class="op" id="5646380">;</span>&nbsp;<span class="ident" id="5646382">i</span>&nbsp;<span class="op" id="5646384">&lt;</span>&nbsp;<span class="ident" id="5646386">indir</span>&nbsp;<span class="op" id="5646392">&amp;&amp;</span>&nbsp;<span class="ident" id="5646395">v</span><span class="op" id="5646396">.</span><span class="ident" id="5646397">IsValid</span><span class="op" id="5646404">(</span><span class="op" id="5646405">)</span><span class="op" id="5646406">;</span>&nbsp;<span class="ident" id="5646408">i</span><span class="op" id="5646409">++</span>&nbsp;<span class="op" id="5646412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646416">v</span>&nbsp;<span class="op" id="5646418">=</span>&nbsp;<span class="ident" id="5646420">reflect</span><span class="op" id="5646427">.</span><span class="ident" id="5646428">Indirect</span><span class="op" id="5646436">(</span><span class="ident" id="5646437">v</span><span class="op" id="5646438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646444">if</span>&nbsp;<span class="op" id="5646447">!</span><span class="ident" id="5646448">v</span><span class="op" id="5646449">.</span><span class="ident" id="5646450">IsValid</span><span class="op" id="5646457">(</span><span class="op" id="5646458">)</span>&nbsp;<span class="op" id="5646460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646464">errorf</span><span class="op" id="5646470">(</span><span class="string" id="5646471">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="5646504">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646510">op</span><span class="op" id="5646512">(</span><span class="builtintype" id="5646513">nil</span><span class="op" id="5646516">,</span>&nbsp;<span class="ident" id="5646518">state</span><span class="op" id="5646523">,</span>&nbsp;<span class="ident" id="5646525">v</span><span class="op" id="5646526">)</span><br>
<span class="lineno"></span><span class="op" id="5646528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5646531">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword" id="5646605">func</span>&nbsp;<span class="op" id="5646610">(</span><span class="ident" id="5646611">enc</span>&nbsp;<span class="op" id="5646615">*</span><span class="ident" id="5646616">Encoder</span><span class="op" id="5646623">)</span>&nbsp;<span class="ident" id="5646625">encodeMap</span><span class="op" id="5646634">(</span><span class="ident" id="5646635">b</span>&nbsp;<span class="op" id="5646637">*</span><span class="ident" id="5646638">encBuffer</span><span class="op" id="5646647">,</span>&nbsp;<span class="ident" id="5646649">mv</span>&nbsp;<span class="ident" id="5646652">reflect</span><span class="op" id="5646659">.</span><span class="ident" id="5646660">Value</span><span class="op" id="5646665">,</span>&nbsp;<span class="ident" id="5646667">keyOp</span><span class="op" id="5646672">,</span>&nbsp;<span class="ident" id="5646674">elemOp</span>&nbsp;<span class="ident" id="5646681">encOp</span><span class="op" id="5646686">,</span>&nbsp;<span class="ident" id="5646688">keyIndir</span><span class="op" id="5646696">,</span>&nbsp;<span class="ident" id="5646698">elemIndir</span>&nbsp;<span class="builtintype" id="5646708">int</span><span class="op" id="5646711">)</span>&nbsp;<span class="op" id="5646713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646716">state</span>&nbsp;<span class="op" id="5646722">:=</span>&nbsp;<span class="ident" id="5646725">enc</span><span class="op" id="5646728">.</span><span class="ident" id="5646729">newEncoderState</span><span class="op" id="5646744">(</span><span class="ident" id="5646745">b</span><span class="op" id="5646746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646749">state</span><span class="op" id="5646754">.</span><span class="ident" id="5646755">fieldnum</span>&nbsp;<span class="op" id="5646764">=</span>&nbsp;<span class="op" id="5646766">-</span><span class="num" id="5646767">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646770">state</span><span class="op" id="5646775">.</span><span class="ident" id="5646776">sendZero</span>&nbsp;<span class="op" id="5646785">=</span>&nbsp;<span class="builtintype" id="5646787">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646793">keys</span>&nbsp;<span class="op" id="5646798">:=</span>&nbsp;<span class="ident" id="5646801">mv</span><span class="op" id="5646803">.</span><span class="ident" id="5646804">MapKeys</span><span class="op" id="5646811">(</span><span class="op" id="5646812">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646815">state</span><span class="op" id="5646820">.</span><span class="ident" id="5646821">encodeUint</span><span class="op" id="5646831">(</span><span class="builtintype" id="5646832">uint64</span><span class="op" id="5646838">(</span><span class="builtinfunc" id="5646839">len</span><span class="op" id="5646842">(</span><span class="ident" id="5646843">keys</span><span class="op" id="5646847">)</span><span class="op" id="5646848">)</span><span class="op" id="5646849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5646852">for</span>&nbsp;<span class="ident" id="5646856">_</span><span class="op" id="5646857">,</span>&nbsp;<span class="ident" id="5646859">key</span>&nbsp;<span class="op" id="5646863">:=</span>&nbsp;<span class="keyword" id="5646866">range</span>&nbsp;<span class="ident" id="5646872">keys</span>&nbsp;<span class="op" id="5646877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646881">encodeReflectValue</span><span class="op" id="5646899">(</span><span class="ident" id="5646900">state</span><span class="op" id="5646905">,</span>&nbsp;<span class="ident" id="5646907">key</span><span class="op" id="5646910">,</span>&nbsp;<span class="ident" id="5646912">keyOp</span><span class="op" id="5646917">,</span>&nbsp;<span class="ident" id="5646919">keyIndir</span><span class="op" id="5646927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646931">encodeReflectValue</span><span class="op" id="5646949">(</span><span class="ident" id="5646950">state</span><span class="op" id="5646955">,</span>&nbsp;<span class="ident" id="5646957">mv</span><span class="op" id="5646959">.</span><span class="ident" id="5646960">MapIndex</span><span class="op" id="5646968">(</span><span class="ident" id="5646969">key</span><span class="op" id="5646972">)</span><span class="op" id="5646973">,</span>&nbsp;<span class="ident" id="5646975">elemOp</span><span class="op" id="5646981">,</span>&nbsp;<span class="ident" id="5646983">elemIndir</span><span class="op" id="5646992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5646995">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5646998">enc</span><span class="op" id="5647001">.</span><span class="ident" id="5647002">freeEncoderState</span><span class="op" id="5647018">(</span><span class="ident" id="5647019">state</span><span class="op" id="5647024">)</span><br>
<span class="lineno"></span><span class="op" id="5647026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5647029">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment" id="5647080">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment" id="5647162">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment" id="5647249">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment" id="5647332">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5647357">func</span>&nbsp;<span class="op" id="5647362">(</span><span class="ident" id="5647363">enc</span>&nbsp;<span class="op" id="5647367">*</span><span class="ident" id="5647368">Encoder</span><span class="op" id="5647375">)</span>&nbsp;<span class="ident" id="5647377">encodeInterface</span><span class="op" id="5647392">(</span><span class="ident" id="5647393">b</span>&nbsp;<span class="op" id="5647395">*</span><span class="ident" id="5647396">encBuffer</span><span class="op" id="5647405">,</span>&nbsp;<span class="ident" id="5647407">iv</span>&nbsp;<span class="ident" id="5647410">reflect</span><span class="op" id="5647417">.</span><span class="ident" id="5647418">Value</span><span class="op" id="5647423">)</span>&nbsp;<span class="op" id="5647425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5647428">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5647493">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5647564">elem</span>&nbsp;<span class="op" id="5647569">:=</span>&nbsp;<span class="ident" id="5647572">iv</span><span class="op" id="5647574">.</span><span class="ident" id="5647575">Elem</span><span class="op" id="5647579">(</span><span class="op" id="5647580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5647583">if</span>&nbsp;<span class="ident" id="5647586">elem</span><span class="op" id="5647590">.</span><span class="ident" id="5647591">Kind</span><span class="op" id="5647595">(</span><span class="op" id="5647596">)</span>&nbsp;<span class="op" id="5647598">==</span>&nbsp;<span class="ident" id="5647601">reflect</span><span class="op" id="5647608">.</span><span class="ident" id="5647609">Ptr</span>&nbsp;<span class="op" id="5647613">&amp;&amp;</span>&nbsp;<span class="ident" id="5647616">elem</span><span class="op" id="5647620">.</span><span class="ident" id="5647621">IsNil</span><span class="op" id="5647626">(</span><span class="op" id="5647627">)</span>&nbsp;<span class="op" id="5647629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5647633">errorf</span><span class="op" id="5647639">(</span><span class="string" id="5647640">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op" id="5647700">,</span>&nbsp;<span class="ident" id="5647702">iv</span><span class="op" id="5647704">.</span><span class="ident" id="5647705">Elem</span><span class="op" id="5647709">(</span><span class="op" id="5647710">)</span><span class="op" id="5647711">.</span><span class="ident" id="5647712">Type</span><span class="op" id="5647716">(</span><span class="op" id="5647717">)</span><span class="op" id="5647718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5647721">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5647724">state</span>&nbsp;<span class="op" id="5647730">:=</span>&nbsp;<span class="ident" id="5647733">enc</span><span class="op" id="5647736">.</span><span class="ident" id="5647737">newEncoderState</span><span class="op" id="5647752">(</span><span class="ident" id="5647753">b</span><span class="op" id="5647754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5647757">state</span><span class="op" id="5647762">.</span><span class="ident" id="5647763">fieldnum</span>&nbsp;<span class="op" id="5647772">=</span>&nbsp;<span class="op" id="5647774">-</span><span class="num" id="5647775">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5647778">state</span><span class="op" id="5647783">.</span><span class="ident" id="5647784">sendZero</span>&nbsp;<span class="op" id="5647793">=</span>&nbsp;<span class="builtintype" id="5647795">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5647801">if</span>&nbsp;<span class="ident" id="5647804">iv</span><span class="op" id="5647806">.</span><span class="ident" id="5647807">IsNil</span><span class="op" id="5647812">(</span><span class="op" id="5647813">)</span>&nbsp;<span class="op" id="5647815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5647819">state</span><span class="op" id="5647824">.</span><span class="ident" id="5647825">encodeUint</span><span class="op" id="5647835">(</span><span class="num" id="5647836">0</span><span class="op" id="5647837">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5647841">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5647849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5647853">ut</span>&nbsp;<span class="op" id="5647856">:=</span>&nbsp;<span class="ident" id="5647859">userType</span><span class="op" id="5647867">(</span><span class="ident" id="5647868">iv</span><span class="op" id="5647870">.</span><span class="ident" id="5647871">Elem</span><span class="op" id="5647875">(</span><span class="op" id="5647876">)</span><span class="op" id="5647877">.</span><span class="ident" id="5647878">Type</span><span class="op" id="5647882">(</span><span class="op" id="5647883">)</span><span class="op" id="5647884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5647887">registerLock</span><span class="op" id="5647899">.</span><span class="ident" id="5647900">RLock</span><span class="op" id="5647905">(</span><span class="op" id="5647906">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5647909">name</span><span class="op" id="5647913">,</span>&nbsp;<span class="ident" id="5647915">ok</span>&nbsp;<span class="op" id="5647918">:=</span>&nbsp;<span class="ident" id="5647921">concreteTypeToName</span><span class="op" id="5647939">[</span><span class="ident" id="5647940">ut</span><span class="op" id="5647942">.</span><span class="ident" id="5647943">base</span><span class="op" id="5647947">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5647950">registerLock</span><span class="op" id="5647962">.</span><span class="ident" id="5647963">RUnlock</span><span class="op" id="5647970">(</span><span class="op" id="5647971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5647974">if</span>&nbsp;<span class="op" id="5647977">!</span><span class="ident" id="5647978">ok</span>&nbsp;<span class="op" id="5647981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5647985">errorf</span><span class="op" id="5647991">(</span><span class="string" id="5647992">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op" id="5648031">,</span>&nbsp;<span class="ident" id="5648033">ut</span><span class="op" id="5648035">.</span><span class="ident" id="5648036">base</span><span class="op" id="5648040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5648043">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5648046">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5648065">state</span><span class="op" id="5648070">.</span><span class="ident" id="5648071">encodeUint</span><span class="op" id="5648081">(</span><span class="builtintype" id="5648082">uint64</span><span class="op" id="5648088">(</span><span class="builtinfunc" id="5648089">len</span><span class="op" id="5648092">(</span><span class="ident" id="5648093">name</span><span class="op" id="5648097">)</span><span class="op" id="5648098">)</span><span class="op" id="5648099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5648102">state</span><span class="op" id="5648107">.</span><span class="ident" id="5648108">b</span><span class="op" id="5648109">.</span><span class="ident" id="5648110">WriteString</span><span class="op" id="5648121">(</span><span class="ident" id="5648122">name</span><span class="op" id="5648126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5648129">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5648166">enc</span><span class="op" id="5648169">.</span><span class="ident" id="5648170">sendTypeDescriptor</span><span class="op" id="5648188">(</span><span class="ident" id="5648189">enc</span><span class="op" id="5648192">.</span><span class="ident" id="5648193">writer</span><span class="op" id="5648199">(</span><span class="op" id="5648200">)</span><span class="op" id="5648201">,</span>&nbsp;<span class="ident" id="5648203">state</span><span class="op" id="5648208">,</span>&nbsp;<span class="ident" id="5648210">ut</span><span class="op" id="5648212">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5648215">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5648237">enc</span><span class="op" id="5648240">.</span><span class="ident" id="5648241">sendTypeId</span><span class="op" id="5648251">(</span><span class="ident" id="5648252">state</span><span class="op" id="5648257">,</span>&nbsp;<span class="ident" id="5648259">ut</span><span class="op" id="5648261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5648264">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5648333">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5648387">enc</span><span class="op" id="5648390">.</span><span class="ident" id="5648391">pushWriter</span><span class="op" id="5648401">(</span><span class="ident" id="5648402">b</span><span class="op" id="5648403">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5648406">data</span>&nbsp;<span class="op" id="5648411">:=</span>&nbsp;<span class="builtinfunc" id="5648414">new</span><span class="op" id="5648417">(</span><span class="ident" id="5648418">encBuffer</span><span class="op" id="5648427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5648430">data</span><span class="op" id="5648434">.</span><span class="ident" id="5648435">Write</span><span class="op" id="5648440">(</span><span class="ident" id="5648441">spaceForLength</span><span class="op" id="5648455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5648458">enc</span><span class="op" id="5648461">.</span><span class="ident" id="5648462">encode</span><span class="op" id="5648468">(</span><span class="ident" id="5648469">data</span><span class="op" id="5648473">,</span>&nbsp;<span class="ident" id="5648475">elem</span><span class="op" id="5648479">,</span>&nbsp;<span class="ident" id="5648481">ut</span><span class="op" id="5648483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5648486">if</span>&nbsp;<span class="ident" id="5648489">enc</span><span class="op" id="5648492">.</span><span class="ident" id="5648493">err</span>&nbsp;<span class="op" id="5648497">!=</span>&nbsp;<span class="builtintype" id="5648500">nil</span>&nbsp;<span class="op" id="5648504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5648508">error_</span><span class="op" id="5648514">(</span><span class="ident" id="5648515">enc</span><span class="op" id="5648518">.</span><span class="ident" id="5648519">err</span><span class="op" id="5648522">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5648525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5648528">enc</span><span class="op" id="5648531">.</span><span class="ident" id="5648532">popWriter</span><span class="op" id="5648541">(</span><span class="op" id="5648542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5648545">enc</span><span class="op" id="5648548">.</span><span class="ident" id="5648549">writeMessage</span><span class="op" id="5648561">(</span><span class="ident" id="5648562">b</span><span class="op" id="5648563">,</span>&nbsp;<span class="ident" id="5648565">data</span><span class="op" id="5648569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5648572">if</span>&nbsp;<span class="ident" id="5648575">enc</span><span class="op" id="5648578">.</span><span class="ident" id="5648579">err</span>&nbsp;<span class="op" id="5648583">!=</span>&nbsp;<span class="builtintype" id="5648586">nil</span>&nbsp;<span class="op" id="5648590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5648594">error_</span><span class="op" id="5648600">(</span><span class="ident" id="5648601">enc</span><span class="op" id="5648604">.</span><span class="ident" id="5648605">err</span><span class="op" id="5648608">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5648611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5648614">enc</span><span class="op" id="5648617">.</span><span class="ident" id="5648618">freeEncoderState</span><span class="op" id="5648634">(</span><span class="ident" id="5648635">state</span><span class="op" id="5648640">)</span><br>
<span class="lineno"></span><span class="op" id="5648642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5648645">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword" id="5648706">func</span>&nbsp;<span class="ident" id="5648711">isZero</span><span class="op" id="5648717">(</span><span class="ident" id="5648718">val</span>&nbsp;<span class="ident" id="5648722">reflect</span><span class="op" id="5648729">.</span><span class="ident" id="5648730">Value</span><span class="op" id="5648735">)</span>&nbsp;<span class="builtintype" id="5648737">bool</span>&nbsp;<span class="op" id="5648742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5648745">switch</span>&nbsp;<span class="ident" id="5648752">val</span><span class="op" id="5648755">.</span><span class="ident" id="5648756">Kind</span><span class="op" id="5648760">(</span><span class="op" id="5648761">)</span>&nbsp;<span class="op" id="5648763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5648766">case</span>&nbsp;<span class="ident" id="5648771">reflect</span><span class="op" id="5648778">.</span><span class="ident" id="5648779">Array</span><span class="op" id="5648784">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5648788">for</span>&nbsp;<span class="ident" id="5648792">i</span>&nbsp;<span class="op" id="5648794">:=</span>&nbsp;<span class="num" id="5648797">0</span><span class="op" id="5648798">;</span>&nbsp;<span class="ident" id="5648800">i</span>&nbsp;<span class="op" id="5648802">&lt;</span>&nbsp;<span class="ident" id="5648804">val</span><span class="op" id="5648807">.</span><span class="ident" id="5648808">Len</span><span class="op" id="5648811">(</span><span class="op" id="5648812">)</span><span class="op" id="5648813">;</span>&nbsp;<span class="ident" id="5648815">i</span><span class="op" id="5648816">++</span>&nbsp;<span class="op" id="5648819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5648824">if</span>&nbsp;<span class="op" id="5648827">!</span><span class="ident" id="5648828">isZero</span><span class="op" id="5648834">(</span><span class="ident" id="5648835">val</span><span class="op" id="5648838">.</span><span class="ident" id="5648839">Index</span><span class="op" id="5648844">(</span><span class="ident" id="5648845">i</span><span class="op" id="5648846">)</span><span class="op" id="5648847">)</span>&nbsp;<span class="op" id="5648849">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5648855">return</span>&nbsp;<span class="builtintype" id="5648862">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5648871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5648875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5648879">return</span>&nbsp;<span class="builtintype" id="5648886">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5648892">case</span>&nbsp;<span class="ident" id="5648897">reflect</span><span class="op" id="5648904">.</span><span class="ident" id="5648905">Map</span><span class="op" id="5648908">,</span>&nbsp;<span class="ident" id="5648910">reflect</span><span class="op" id="5648917">.</span><span class="ident" id="5648918">Slice</span><span class="op" id="5648923">,</span>&nbsp;<span class="ident" id="5648925">reflect</span><span class="op" id="5648932">.</span><span class="ident" id="5648933">String</span><span class="op" id="5648939">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5648943">return</span>&nbsp;<span class="ident" id="5648950">val</span><span class="op" id="5648953">.</span><span class="ident" id="5648954">Len</span><span class="op" id="5648957">(</span><span class="op" id="5648958">)</span>&nbsp;<span class="op" id="5648960">==</span>&nbsp;<span class="num" id="5648963">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5648966">case</span>&nbsp;<span class="ident" id="5648971">reflect</span><span class="op" id="5648978">.</span><span class="ident" id="5648979">Bool</span><span class="op" id="5648983">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5648987">return</span>&nbsp;<span class="op" id="5648994">!</span><span class="ident" id="5648995">val</span><span class="op" id="5648998">.</span><span class="ident" id="5648999">Bool</span><span class="op" id="5649003">(</span><span class="op" id="5649004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649007">case</span>&nbsp;<span class="ident" id="5649012">reflect</span><span class="op" id="5649019">.</span><span class="ident" id="5649020">Complex64</span><span class="op" id="5649029">,</span>&nbsp;<span class="ident" id="5649031">reflect</span><span class="op" id="5649038">.</span><span class="ident" id="5649039">Complex128</span><span class="op" id="5649049">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649053">return</span>&nbsp;<span class="ident" id="5649060">val</span><span class="op" id="5649063">.</span><span class="ident" id="5649064">Complex</span><span class="op" id="5649071">(</span><span class="op" id="5649072">)</span>&nbsp;<span class="op" id="5649074">==</span>&nbsp;<span class="num" id="5649077">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649080">case</span>&nbsp;<span class="ident" id="5649085">reflect</span><span class="op" id="5649092">.</span><span class="ident" id="5649093">Chan</span><span class="op" id="5649097">,</span>&nbsp;<span class="ident" id="5649099">reflect</span><span class="op" id="5649106">.</span><span class="ident" id="5649107">Func</span><span class="op" id="5649111">,</span>&nbsp;<span class="ident" id="5649113">reflect</span><span class="op" id="5649120">.</span><span class="ident" id="5649121">Interface</span><span class="op" id="5649130">,</span>&nbsp;<span class="ident" id="5649132">reflect</span><span class="op" id="5649139">.</span><span class="ident" id="5649140">Ptr</span><span class="op" id="5649143">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649147">return</span>&nbsp;<span class="ident" id="5649154">val</span><span class="op" id="5649157">.</span><span class="ident" id="5649158">IsNil</span><span class="op" id="5649163">(</span><span class="op" id="5649164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649167">case</span>&nbsp;<span class="ident" id="5649172">reflect</span><span class="op" id="5649179">.</span><span class="ident" id="5649180">Int</span><span class="op" id="5649183">,</span>&nbsp;<span class="ident" id="5649185">reflect</span><span class="op" id="5649192">.</span><span class="ident" id="5649193">Int8</span><span class="op" id="5649197">,</span>&nbsp;<span class="ident" id="5649199">reflect</span><span class="op" id="5649206">.</span><span class="ident" id="5649207">Int16</span><span class="op" id="5649212">,</span>&nbsp;<span class="ident" id="5649214">reflect</span><span class="op" id="5649221">.</span><span class="ident" id="5649222">Int32</span><span class="op" id="5649227">,</span>&nbsp;<span class="ident" id="5649229">reflect</span><span class="op" id="5649236">.</span><span class="ident" id="5649237">Int64</span><span class="op" id="5649242">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649246">return</span>&nbsp;<span class="ident" id="5649253">val</span><span class="op" id="5649256">.</span><span class="ident" id="5649257">Int</span><span class="op" id="5649260">(</span><span class="op" id="5649261">)</span>&nbsp;<span class="op" id="5649263">==</span>&nbsp;<span class="num" id="5649266">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649269">case</span>&nbsp;<span class="ident" id="5649274">reflect</span><span class="op" id="5649281">.</span><span class="ident" id="5649282">Float32</span><span class="op" id="5649289">,</span>&nbsp;<span class="ident" id="5649291">reflect</span><span class="op" id="5649298">.</span><span class="ident" id="5649299">Float64</span><span class="op" id="5649306">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649310">return</span>&nbsp;<span class="ident" id="5649317">val</span><span class="op" id="5649320">.</span><span class="ident" id="5649321">Float</span><span class="op" id="5649326">(</span><span class="op" id="5649327">)</span>&nbsp;<span class="op" id="5649329">==</span>&nbsp;<span class="num" id="5649332">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649335">case</span>&nbsp;<span class="ident" id="5649340">reflect</span><span class="op" id="5649347">.</span><span class="ident" id="5649348">Uint</span><span class="op" id="5649352">,</span>&nbsp;<span class="ident" id="5649354">reflect</span><span class="op" id="5649361">.</span><span class="ident" id="5649362">Uint8</span><span class="op" id="5649367">,</span>&nbsp;<span class="ident" id="5649369">reflect</span><span class="op" id="5649376">.</span><span class="ident" id="5649377">Uint16</span><span class="op" id="5649383">,</span>&nbsp;<span class="ident" id="5649385">reflect</span><span class="op" id="5649392">.</span><span class="ident" id="5649393">Uint32</span><span class="op" id="5649399">,</span>&nbsp;<span class="ident" id="5649401">reflect</span><span class="op" id="5649408">.</span><span class="ident" id="5649409">Uint64</span><span class="op" id="5649415">,</span>&nbsp;<span class="ident" id="5649417">reflect</span><span class="op" id="5649424">.</span><span class="ident" id="5649425">Uintptr</span><span class="op" id="5649432">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649436">return</span>&nbsp;<span class="ident" id="5649443">val</span><span class="op" id="5649446">.</span><span class="ident" id="5649447">Uint</span><span class="op" id="5649451">(</span><span class="op" id="5649452">)</span>&nbsp;<span class="op" id="5649454">==</span>&nbsp;<span class="num" id="5649457">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649460">case</span>&nbsp;<span class="ident" id="5649465">reflect</span><span class="op" id="5649472">.</span><span class="ident" id="5649473">Struct</span><span class="op" id="5649479">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649483">for</span>&nbsp;<span class="ident" id="5649487">i</span>&nbsp;<span class="op" id="5649489">:=</span>&nbsp;<span class="num" id="5649492">0</span><span class="op" id="5649493">;</span>&nbsp;<span class="ident" id="5649495">i</span>&nbsp;<span class="op" id="5649497">&lt;</span>&nbsp;<span class="ident" id="5649499">val</span><span class="op" id="5649502">.</span><span class="ident" id="5649503">NumField</span><span class="op" id="5649511">(</span><span class="op" id="5649512">)</span><span class="op" id="5649513">;</span>&nbsp;<span class="ident" id="5649515">i</span><span class="op" id="5649516">++</span>&nbsp;<span class="op" id="5649519">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649524">if</span>&nbsp;<span class="op" id="5649527">!</span><span class="ident" id="5649528">isZero</span><span class="op" id="5649534">(</span><span class="ident" id="5649535">val</span><span class="op" id="5649538">.</span><span class="ident" id="5649539">Field</span><span class="op" id="5649544">(</span><span class="ident" id="5649545">i</span><span class="op" id="5649546">)</span><span class="op" id="5649547">)</span>&nbsp;<span class="op" id="5649549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649555">return</span>&nbsp;<span class="builtintype" id="5649562">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5649571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5649575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649579">return</span>&nbsp;<span class="builtintype" id="5649586">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5649592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5649595">panic</span><span class="op" id="5649600">(</span><span class="string" id="5649601">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op" id="5649627">+</span>&nbsp;<span class="ident" id="5649629">val</span><span class="op" id="5649632">.</span><span class="ident" id="5649633">Type</span><span class="op" id="5649637">(</span><span class="op" id="5649638">)</span><span class="op" id="5649639">.</span><span class="ident" id="5649640">String</span><span class="op" id="5649646">(</span><span class="op" id="5649647">)</span><span class="op" id="5649648">)</span><br>
<span class="lineno"></span><span class="op" id="5649650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5649653">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment" id="5649728">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="5649765">func</span>&nbsp;<span class="op" id="5649770">(</span><span class="ident" id="5649771">enc</span>&nbsp;<span class="op" id="5649775">*</span><span class="ident" id="5649776">Encoder</span><span class="op" id="5649783">)</span>&nbsp;<span class="ident" id="5649785">encodeGobEncoder</span><span class="op" id="5649801">(</span><span class="ident" id="5649802">b</span>&nbsp;<span class="op" id="5649804">*</span><span class="ident" id="5649805">encBuffer</span><span class="op" id="5649814">,</span>&nbsp;<span class="ident" id="5649816">ut</span>&nbsp;<span class="op" id="5649819">*</span><span class="ident" id="5649820">userTypeInfo</span><span class="op" id="5649832">,</span>&nbsp;<span class="ident" id="5649834">v</span>&nbsp;<span class="ident" id="5649836">reflect</span><span class="op" id="5649843">.</span><span class="ident" id="5649844">Value</span><span class="op" id="5649849">)</span>&nbsp;<span class="op" id="5649851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5649854">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649912">var</span>&nbsp;<span class="ident" id="5649916">data</span>&nbsp;<span class="op" id="5649921">[</span><span class="op" id="5649922">]</span><span class="builtintype" id="5649923">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649929">var</span>&nbsp;<span class="ident" id="5649933">err</span>&nbsp;<span class="builtintype" id="5649937">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5649944">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5649975">switch</span>&nbsp;<span class="ident" id="5649982">ut</span><span class="op" id="5649984">.</span><span class="ident" id="5649985">externalEnc</span>&nbsp;<span class="op" id="5649997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5650000">case</span>&nbsp;<span class="ident" id="5650005">xGob</span><span class="op" id="5650009">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650013">data</span><span class="op" id="5650017">,</span>&nbsp;<span class="ident" id="5650019">err</span>&nbsp;<span class="op" id="5650023">=</span>&nbsp;<span class="ident" id="5650025">v</span><span class="op" id="5650026">.</span><span class="ident" id="5650027">Interface</span><span class="op" id="5650036">(</span><span class="op" id="5650037">)</span><span class="op" id="5650038">.</span><span class="op" id="5650039">(</span><span class="ident" id="5650040">GobEncoder</span><span class="op" id="5650050">)</span><span class="op" id="5650051">.</span><span class="ident" id="5650052">GobEncode</span><span class="op" id="5650061">(</span><span class="op" id="5650062">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5650065">case</span>&nbsp;<span class="ident" id="5650070">xBinary</span><span class="op" id="5650077">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650081">data</span><span class="op" id="5650085">,</span>&nbsp;<span class="ident" id="5650087">err</span>&nbsp;<span class="op" id="5650091">=</span>&nbsp;<span class="ident" id="5650093">v</span><span class="op" id="5650094">.</span><span class="ident" id="5650095">Interface</span><span class="op" id="5650104">(</span><span class="op" id="5650105">)</span><span class="op" id="5650106">.</span><span class="op" id="5650107">(</span><span class="ident" id="5650108">encoding</span><span class="op" id="5650116">.</span><span class="ident" id="5650117">BinaryMarshaler</span><span class="op" id="5650132">)</span><span class="op" id="5650133">.</span><span class="ident" id="5650134">MarshalBinary</span><span class="op" id="5650147">(</span><span class="op" id="5650148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5650151">case</span>&nbsp;<span class="ident" id="5650156">xText</span><span class="op" id="5650161">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650165">data</span><span class="op" id="5650169">,</span>&nbsp;<span class="ident" id="5650171">err</span>&nbsp;<span class="op" id="5650175">=</span>&nbsp;<span class="ident" id="5650177">v</span><span class="op" id="5650178">.</span><span class="ident" id="5650179">Interface</span><span class="op" id="5650188">(</span><span class="op" id="5650189">)</span><span class="op" id="5650190">.</span><span class="op" id="5650191">(</span><span class="ident" id="5650192">encoding</span><span class="op" id="5650200">.</span><span class="ident" id="5650201">TextMarshaler</span><span class="op" id="5650214">)</span><span class="op" id="5650215">.</span><span class="ident" id="5650216">MarshalText</span><span class="op" id="5650227">(</span><span class="op" id="5650228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5650231">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5650234">if</span>&nbsp;<span class="ident" id="5650237">err</span>&nbsp;<span class="op" id="5650241">!=</span>&nbsp;<span class="builtintype" id="5650244">nil</span>&nbsp;<span class="op" id="5650248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650252">error_</span><span class="op" id="5650258">(</span><span class="ident" id="5650259">err</span><span class="op" id="5650262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5650265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650268">state</span>&nbsp;<span class="op" id="5650274">:=</span>&nbsp;<span class="ident" id="5650277">enc</span><span class="op" id="5650280">.</span><span class="ident" id="5650281">newEncoderState</span><span class="op" id="5650296">(</span><span class="ident" id="5650297">b</span><span class="op" id="5650298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650301">state</span><span class="op" id="5650306">.</span><span class="ident" id="5650307">fieldnum</span>&nbsp;<span class="op" id="5650316">=</span>&nbsp;<span class="op" id="5650318">-</span><span class="num" id="5650319">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650322">state</span><span class="op" id="5650327">.</span><span class="ident" id="5650328">encodeUint</span><span class="op" id="5650338">(</span><span class="builtintype" id="5650339">uint64</span><span class="op" id="5650345">(</span><span class="builtinfunc" id="5650346">len</span><span class="op" id="5650349">(</span><span class="ident" id="5650350">data</span><span class="op" id="5650354">)</span><span class="op" id="5650355">)</span><span class="op" id="5650356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650359">state</span><span class="op" id="5650364">.</span><span class="ident" id="5650365">b</span><span class="op" id="5650366">.</span><span class="ident" id="5650367">Write</span><span class="op" id="5650372">(</span><span class="ident" id="5650373">data</span><span class="op" id="5650377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650380">enc</span><span class="op" id="5650383">.</span><span class="ident" id="5650384">freeEncoderState</span><span class="op" id="5650400">(</span><span class="ident" id="5650401">state</span><span class="op" id="5650406">)</span><br>
<span class="lineno"></span><span class="op" id="5650408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword" id="5650411">var</span>&nbsp;<span class="ident" id="5650415">encOpTable</span>&nbsp;<span class="op" id="5650426">=</span>&nbsp;<span class="op" id="5650428">[</span><span class="op" id="5650429">...</span><span class="op" id="5650432">]</span><span class="ident" id="5650433">encOp</span><span class="op" id="5650438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650441">reflect</span><span class="op" id="5650448">.</span><span class="ident" id="5650449">Bool</span><span class="op" id="5650453">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650461">encBool</span><span class="op" id="5650468">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650471">reflect</span><span class="op" id="5650478">.</span><span class="ident" id="5650479">Int</span><span class="op" id="5650482">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650491">encInt</span><span class="op" id="5650497">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650500">reflect</span><span class="op" id="5650507">.</span><span class="ident" id="5650508">Int8</span><span class="op" id="5650512">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650520">encInt</span><span class="op" id="5650526">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650529">reflect</span><span class="op" id="5650536">.</span><span class="ident" id="5650537">Int16</span><span class="op" id="5650542">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650549">encInt</span><span class="op" id="5650555">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650558">reflect</span><span class="op" id="5650565">.</span><span class="ident" id="5650566">Int32</span><span class="op" id="5650571">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650578">encInt</span><span class="op" id="5650584">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650587">reflect</span><span class="op" id="5650594">.</span><span class="ident" id="5650595">Int64</span><span class="op" id="5650600">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650607">encInt</span><span class="op" id="5650613">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650616">reflect</span><span class="op" id="5650623">.</span><span class="ident" id="5650624">Uint</span><span class="op" id="5650628">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650636">encUint</span><span class="op" id="5650643">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650646">reflect</span><span class="op" id="5650653">.</span><span class="ident" id="5650654">Uint8</span><span class="op" id="5650659">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650666">encUint</span><span class="op" id="5650673">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650676">reflect</span><span class="op" id="5650683">.</span><span class="ident" id="5650684">Uint16</span><span class="op" id="5650690">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650696">encUint</span><span class="op" id="5650703">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650706">reflect</span><span class="op" id="5650713">.</span><span class="ident" id="5650714">Uint32</span><span class="op" id="5650720">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650726">encUint</span><span class="op" id="5650733">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650736">reflect</span><span class="op" id="5650743">.</span><span class="ident" id="5650744">Uint64</span><span class="op" id="5650750">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650756">encUint</span><span class="op" id="5650763">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650766">reflect</span><span class="op" id="5650773">.</span><span class="ident" id="5650774">Uintptr</span><span class="op" id="5650781">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650786">encUint</span><span class="op" id="5650793">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650796">reflect</span><span class="op" id="5650803">.</span><span class="ident" id="5650804">Float32</span><span class="op" id="5650811">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650816">encFloat</span><span class="op" id="5650824">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650827">reflect</span><span class="op" id="5650834">.</span><span class="ident" id="5650835">Float64</span><span class="op" id="5650842">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650847">encFloat</span><span class="op" id="5650855">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650858">reflect</span><span class="op" id="5650865">.</span><span class="ident" id="5650866">Complex64</span><span class="op" id="5650875">:</span>&nbsp;&nbsp;<span class="ident" id="5650878">encComplex</span><span class="op" id="5650888">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650891">reflect</span><span class="op" id="5650898">.</span><span class="ident" id="5650899">Complex128</span><span class="op" id="5650909">:</span>&nbsp;<span class="ident" id="5650911">encComplex</span><span class="op" id="5650921">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650924">reflect</span><span class="op" id="5650931">.</span><span class="ident" id="5650932">String</span><span class="op" id="5650938">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5650944">encString</span><span class="op" id="5650953">,</span><br>
<span class="lineno"></span><span class="op" id="5650955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment" id="5650958">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5651040">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5651078">func</span>&nbsp;<span class="ident" id="5651083">encOpFor</span><span class="op" id="5651091">(</span><span class="ident" id="5651092">rt</span>&nbsp;<span class="ident" id="5651095">reflect</span><span class="op" id="5651102">.</span><span class="ident" id="5651103">Type</span><span class="op" id="5651107">,</span>&nbsp;<span class="ident" id="5651109">inProgress</span>&nbsp;<span class="keyword" id="5651120">map</span><span class="op" id="5651123">[</span><span class="ident" id="5651124">reflect</span><span class="op" id="5651131">.</span><span class="ident" id="5651132">Type</span><span class="op" id="5651136">]</span><span class="op" id="5651137">*</span><span class="ident" id="5651138">encOp</span><span class="op" id="5651143">,</span>&nbsp;<span class="ident" id="5651145">building</span>&nbsp;<span class="keyword" id="5651154">map</span><span class="op" id="5651157">[</span><span class="op" id="5651158">*</span><span class="ident" id="5651159">typeInfo</span><span class="op" id="5651167">]</span><span class="builtintype" id="5651168">bool</span><span class="op" id="5651172">)</span>&nbsp;<span class="op" id="5651174">(</span><span class="op" id="5651175">*</span><span class="ident" id="5651176">encOp</span><span class="op" id="5651181">,</span>&nbsp;<span class="builtintype" id="5651183">int</span><span class="op" id="5651186">)</span>&nbsp;<span class="op" id="5651188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5651191">ut</span>&nbsp;<span class="op" id="5651194">:=</span>&nbsp;<span class="ident" id="5651197">userType</span><span class="op" id="5651205">(</span><span class="ident" id="5651206">rt</span><span class="op" id="5651208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5651211">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5651291">if</span>&nbsp;<span class="ident" id="5651294">ut</span><span class="op" id="5651296">.</span><span class="ident" id="5651297">externalEnc</span>&nbsp;<span class="op" id="5651309">!=</span>&nbsp;<span class="num" id="5651312">0</span>&nbsp;<span class="op" id="5651314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5651318">return</span>&nbsp;<span class="ident" id="5651325">gobEncodeOpFor</span><span class="op" id="5651339">(</span><span class="ident" id="5651340">ut</span><span class="op" id="5651342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5651345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5651348">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5651433">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5651490">if</span>&nbsp;<span class="ident" id="5651493">opPtr</span>&nbsp;<span class="op" id="5651499">:=</span>&nbsp;<span class="ident" id="5651502">inProgress</span><span class="op" id="5651512">[</span><span class="ident" id="5651513">rt</span><span class="op" id="5651515">]</span><span class="op" id="5651516">;</span>&nbsp;<span class="ident" id="5651518">opPtr</span>&nbsp;<span class="op" id="5651524">!=</span>&nbsp;<span class="builtintype" id="5651527">nil</span>&nbsp;<span class="op" id="5651531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5651535">return</span>&nbsp;<span class="ident" id="5651542">opPtr</span><span class="op" id="5651547">,</span>&nbsp;<span class="ident" id="5651549">ut</span><span class="op" id="5651551">.</span><span class="ident" id="5651552">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5651559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5651562">typ</span>&nbsp;<span class="op" id="5651566">:=</span>&nbsp;<span class="ident" id="5651569">ut</span><span class="op" id="5651571">.</span><span class="ident" id="5651572">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5651578">indir</span>&nbsp;<span class="op" id="5651584">:=</span>&nbsp;<span class="ident" id="5651587">ut</span><span class="op" id="5651589">.</span><span class="ident" id="5651590">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5651597">k</span>&nbsp;<span class="op" id="5651599">:=</span>&nbsp;<span class="ident" id="5651602">typ</span><span class="op" id="5651605">.</span><span class="ident" id="5651606">Kind</span><span class="op" id="5651610">(</span><span class="op" id="5651611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5651614">var</span>&nbsp;<span class="ident" id="5651618">op</span>&nbsp;<span class="ident" id="5651621">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5651628">if</span>&nbsp;<span class="builtintype" id="5651631">int</span><span class="op" id="5651634">(</span><span class="ident" id="5651635">k</span><span class="op" id="5651636">)</span>&nbsp;<span class="op" id="5651638">&lt;</span>&nbsp;<span class="builtinfunc" id="5651640">len</span><span class="op" id="5651643">(</span><span class="ident" id="5651644">encOpTable</span><span class="op" id="5651654">)</span>&nbsp;<span class="op" id="5651656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5651660">op</span>&nbsp;<span class="op" id="5651663">=</span>&nbsp;<span class="ident" id="5651665">encOpTable</span><span class="op" id="5651675">[</span><span class="ident" id="5651676">k</span><span class="op" id="5651677">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5651680">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5651683">if</span>&nbsp;<span class="ident" id="5651686">op</span>&nbsp;<span class="op" id="5651689">==</span>&nbsp;<span class="builtintype" id="5651692">nil</span>&nbsp;<span class="op" id="5651696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5651700">inProgress</span><span class="op" id="5651710">[</span><span class="ident" id="5651711">rt</span><span class="op" id="5651713">]</span>&nbsp;<span class="op" id="5651715">=</span>&nbsp;<span class="op" id="5651717">&amp;</span><span class="ident" id="5651718">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5651723">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5651742">switch</span>&nbsp;<span class="ident" id="5651749">t</span>&nbsp;<span class="op" id="5651751">:=</span>&nbsp;<span class="ident" id="5651754">typ</span><span class="op" id="5651757">;</span>&nbsp;<span class="ident" id="5651759">t</span><span class="op" id="5651760">.</span><span class="ident" id="5651761">Kind</span><span class="op" id="5651765">(</span><span class="op" id="5651766">)</span>&nbsp;<span class="op" id="5651768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5651772">case</span>&nbsp;<span class="ident" id="5651777">reflect</span><span class="op" id="5651784">.</span><span class="ident" id="5651785">Slice</span><span class="op" id="5651790">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5651795">if</span>&nbsp;<span class="ident" id="5651798">t</span><span class="op" id="5651799">.</span><span class="ident" id="5651800">Elem</span><span class="op" id="5651804">(</span><span class="op" id="5651805">)</span><span class="op" id="5651806">.</span><span class="ident" id="5651807">Kind</span><span class="op" id="5651811">(</span><span class="op" id="5651812">)</span>&nbsp;<span class="op" id="5651814">==</span>&nbsp;<span class="ident" id="5651817">reflect</span><span class="op" id="5651824">.</span><span class="ident" id="5651825">Uint8</span>&nbsp;<span class="op" id="5651831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5651837">op</span>&nbsp;<span class="op" id="5651840">=</span>&nbsp;<span class="ident" id="5651842">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5651860">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5651869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5651874">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5651945">elemOp</span><span class="op" id="5651951">,</span>&nbsp;<span class="ident" id="5651953">elemIndir</span>&nbsp;<span class="op" id="5651963">:=</span>&nbsp;<span class="ident" id="5651966">encOpFor</span><span class="op" id="5651974">(</span><span class="ident" id="5651975">t</span><span class="op" id="5651976">.</span><span class="ident" id="5651977">Elem</span><span class="op" id="5651981">(</span><span class="op" id="5651982">)</span><span class="op" id="5651983">,</span>&nbsp;<span class="ident" id="5651985">inProgress</span><span class="op" id="5651995">,</span>&nbsp;<span class="ident" id="5651997">building</span><span class="op" id="5652005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5652010">helper</span>&nbsp;<span class="op" id="5652017">:=</span>&nbsp;<span class="ident" id="5652020">encSliceHelper</span><span class="op" id="5652034">[</span><span class="ident" id="5652035">t</span><span class="op" id="5652036">.</span><span class="ident" id="5652037">Elem</span><span class="op" id="5652041">(</span><span class="op" id="5652042">)</span><span class="op" id="5652043">.</span><span class="ident" id="5652044">Kind</span><span class="op" id="5652048">(</span><span class="op" id="5652049">)</span><span class="op" id="5652050">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5652055">op</span>&nbsp;<span class="op" id="5652058">=</span>&nbsp;<span class="keyword" id="5652060">func</span><span class="op" id="5652064">(</span><span class="ident" id="5652065">i</span>&nbsp;<span class="op" id="5652067">*</span><span class="ident" id="5652068">encInstr</span><span class="op" id="5652076">,</span>&nbsp;<span class="ident" id="5652078">state</span>&nbsp;<span class="op" id="5652084">*</span><span class="ident" id="5652085">encoderState</span><span class="op" id="5652097">,</span>&nbsp;<span class="ident" id="5652099">slice</span>&nbsp;<span class="ident" id="5652105">reflect</span><span class="op" id="5652112">.</span><span class="ident" id="5652113">Value</span><span class="op" id="5652118">)</span>&nbsp;<span class="op" id="5652120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5652126">if</span>&nbsp;<span class="op" id="5652129">!</span><span class="ident" id="5652130">state</span><span class="op" id="5652135">.</span><span class="ident" id="5652136">sendZero</span>&nbsp;<span class="op" id="5652145">&amp;&amp;</span>&nbsp;<span class="ident" id="5652148">slice</span><span class="op" id="5652153">.</span><span class="ident" id="5652154">Len</span><span class="op" id="5652157">(</span><span class="op" id="5652158">)</span>&nbsp;<span class="op" id="5652160">==</span>&nbsp;<span class="num" id="5652163">0</span>&nbsp;<span class="op" id="5652165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5652172">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5652183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5652189">state</span><span class="op" id="5652194">.</span><span class="ident" id="5652195">update</span><span class="op" id="5652201">(</span><span class="ident" id="5652202">i</span><span class="op" id="5652203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5652209">state</span><span class="op" id="5652214">.</span><span class="ident" id="5652215">enc</span><span class="op" id="5652218">.</span><span class="ident" id="5652219">encodeArray</span><span class="op" id="5652230">(</span><span class="ident" id="5652231">state</span><span class="op" id="5652236">.</span><span class="ident" id="5652237">b</span><span class="op" id="5652238">,</span>&nbsp;<span class="ident" id="5652240">slice</span><span class="op" id="5652245">,</span>&nbsp;<span class="op" id="5652247">*</span><span class="ident" id="5652248">elemOp</span><span class="op" id="5652254">,</span>&nbsp;<span class="ident" id="5652256">elemIndir</span><span class="op" id="5652265">,</span>&nbsp;<span class="ident" id="5652267">slice</span><span class="op" id="5652272">.</span><span class="ident" id="5652273">Len</span><span class="op" id="5652276">(</span><span class="op" id="5652277">)</span><span class="op" id="5652278">,</span>&nbsp;<span class="ident" id="5652280">helper</span><span class="op" id="5652286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5652291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5652295">case</span>&nbsp;<span class="ident" id="5652300">reflect</span><span class="op" id="5652307">.</span><span class="ident" id="5652308">Array</span><span class="op" id="5652313">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5652318">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5652359">elemOp</span><span class="op" id="5652365">,</span>&nbsp;<span class="ident" id="5652367">elemIndir</span>&nbsp;<span class="op" id="5652377">:=</span>&nbsp;<span class="ident" id="5652380">encOpFor</span><span class="op" id="5652388">(</span><span class="ident" id="5652389">t</span><span class="op" id="5652390">.</span><span class="ident" id="5652391">Elem</span><span class="op" id="5652395">(</span><span class="op" id="5652396">)</span><span class="op" id="5652397">,</span>&nbsp;<span class="ident" id="5652399">inProgress</span><span class="op" id="5652409">,</span>&nbsp;<span class="ident" id="5652411">building</span><span class="op" id="5652419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5652424">helper</span>&nbsp;<span class="op" id="5652431">:=</span>&nbsp;<span class="ident" id="5652434">encArrayHelper</span><span class="op" id="5652448">[</span><span class="ident" id="5652449">t</span><span class="op" id="5652450">.</span><span class="ident" id="5652451">Elem</span><span class="op" id="5652455">(</span><span class="op" id="5652456">)</span><span class="op" id="5652457">.</span><span class="ident" id="5652458">Kind</span><span class="op" id="5652462">(</span><span class="op" id="5652463">)</span><span class="op" id="5652464">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5652469">op</span>&nbsp;<span class="op" id="5652472">=</span>&nbsp;<span class="keyword" id="5652474">func</span><span class="op" id="5652478">(</span><span class="ident" id="5652479">i</span>&nbsp;<span class="op" id="5652481">*</span><span class="ident" id="5652482">encInstr</span><span class="op" id="5652490">,</span>&nbsp;<span class="ident" id="5652492">state</span>&nbsp;<span class="op" id="5652498">*</span><span class="ident" id="5652499">encoderState</span><span class="op" id="5652511">,</span>&nbsp;<span class="ident" id="5652513">array</span>&nbsp;<span class="ident" id="5652519">reflect</span><span class="op" id="5652526">.</span><span class="ident" id="5652527">Value</span><span class="op" id="5652532">)</span>&nbsp;<span class="op" id="5652534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5652540">state</span><span class="op" id="5652545">.</span><span class="ident" id="5652546">update</span><span class="op" id="5652552">(</span><span class="ident" id="5652553">i</span><span class="op" id="5652554">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5652560">state</span><span class="op" id="5652565">.</span><span class="ident" id="5652566">enc</span><span class="op" id="5652569">.</span><span class="ident" id="5652570">encodeArray</span><span class="op" id="5652581">(</span><span class="ident" id="5652582">state</span><span class="op" id="5652587">.</span><span class="ident" id="5652588">b</span><span class="op" id="5652589">,</span>&nbsp;<span class="ident" id="5652591">array</span><span class="op" id="5652596">,</span>&nbsp;<span class="op" id="5652598">*</span><span class="ident" id="5652599">elemOp</span><span class="op" id="5652605">,</span>&nbsp;<span class="ident" id="5652607">elemIndir</span><span class="op" id="5652616">,</span>&nbsp;<span class="ident" id="5652618">array</span><span class="op" id="5652623">.</span><span class="ident" id="5652624">Len</span><span class="op" id="5652627">(</span><span class="op" id="5652628">)</span><span class="op" id="5652629">,</span>&nbsp;<span class="ident" id="5652631">helper</span><span class="op" id="5652637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5652642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5652646">case</span>&nbsp;<span class="ident" id="5652651">reflect</span><span class="op" id="5652658">.</span><span class="ident" id="5652659">Map</span><span class="op" id="5652662">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5652667">keyOp</span><span class="op" id="5652672">,</span>&nbsp;<span class="ident" id="5652674">keyIndir</span>&nbsp;<span class="op" id="5652683">:=</span>&nbsp;<span class="ident" id="5652686">encOpFor</span><span class="op" id="5652694">(</span><span class="ident" id="5652695">t</span><span class="op" id="5652696">.</span><span class="ident" id="5652697">Key</span><span class="op" id="5652700">(</span><span class="op" id="5652701">)</span><span class="op" id="5652702">,</span>&nbsp;<span class="ident" id="5652704">inProgress</span><span class="op" id="5652714">,</span>&nbsp;<span class="ident" id="5652716">building</span><span class="op" id="5652724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5652729">elemOp</span><span class="op" id="5652735">,</span>&nbsp;<span class="ident" id="5652737">elemIndir</span>&nbsp;<span class="op" id="5652747">:=</span>&nbsp;<span class="ident" id="5652750">encOpFor</span><span class="op" id="5652758">(</span><span class="ident" id="5652759">t</span><span class="op" id="5652760">.</span><span class="ident" id="5652761">Elem</span><span class="op" id="5652765">(</span><span class="op" id="5652766">)</span><span class="op" id="5652767">,</span>&nbsp;<span class="ident" id="5652769">inProgress</span><span class="op" id="5652779">,</span>&nbsp;<span class="ident" id="5652781">building</span><span class="op" id="5652789">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5652794">op</span>&nbsp;<span class="op" id="5652797">=</span>&nbsp;<span class="keyword" id="5652799">func</span><span class="op" id="5652803">(</span><span class="ident" id="5652804">i</span>&nbsp;<span class="op" id="5652806">*</span><span class="ident" id="5652807">encInstr</span><span class="op" id="5652815">,</span>&nbsp;<span class="ident" id="5652817">state</span>&nbsp;<span class="op" id="5652823">*</span><span class="ident" id="5652824">encoderState</span><span class="op" id="5652836">,</span>&nbsp;<span class="ident" id="5652838">mv</span>&nbsp;<span class="ident" id="5652841">reflect</span><span class="op" id="5652848">.</span><span class="ident" id="5652849">Value</span><span class="op" id="5652854">)</span>&nbsp;<span class="op" id="5652856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5652862">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5652920">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5652989">if</span>&nbsp;<span class="op" id="5652992">!</span><span class="ident" id="5652993">state</span><span class="op" id="5652998">.</span><span class="ident" id="5652999">sendZero</span>&nbsp;<span class="op" id="5653008">&amp;&amp;</span>&nbsp;<span class="ident" id="5653011">mv</span><span class="op" id="5653013">.</span><span class="ident" id="5653014">IsNil</span><span class="op" id="5653019">(</span><span class="op" id="5653020">)</span>&nbsp;<span class="op" id="5653022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5653029">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5653040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5653046">state</span><span class="op" id="5653051">.</span><span class="ident" id="5653052">update</span><span class="op" id="5653058">(</span><span class="ident" id="5653059">i</span><span class="op" id="5653060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5653066">state</span><span class="op" id="5653071">.</span><span class="ident" id="5653072">enc</span><span class="op" id="5653075">.</span><span class="ident" id="5653076">encodeMap</span><span class="op" id="5653085">(</span><span class="ident" id="5653086">state</span><span class="op" id="5653091">.</span><span class="ident" id="5653092">b</span><span class="op" id="5653093">,</span>&nbsp;<span class="ident" id="5653095">mv</span><span class="op" id="5653097">,</span>&nbsp;<span class="op" id="5653099">*</span><span class="ident" id="5653100">keyOp</span><span class="op" id="5653105">,</span>&nbsp;<span class="op" id="5653107">*</span><span class="ident" id="5653108">elemOp</span><span class="op" id="5653114">,</span>&nbsp;<span class="ident" id="5653116">keyIndir</span><span class="op" id="5653124">,</span>&nbsp;<span class="ident" id="5653126">elemIndir</span><span class="op" id="5653135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5653140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5653144">case</span>&nbsp;<span class="ident" id="5653149">reflect</span><span class="op" id="5653156">.</span><span class="ident" id="5653157">Struct</span><span class="op" id="5653163">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5653168">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5653243">getEncEngine</span><span class="op" id="5653255">(</span><span class="ident" id="5653256">userType</span><span class="op" id="5653264">(</span><span class="ident" id="5653265">typ</span><span class="op" id="5653268">)</span><span class="op" id="5653269">,</span>&nbsp;<span class="ident" id="5653271">building</span><span class="op" id="5653279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5653284">info</span>&nbsp;<span class="op" id="5653289">:=</span>&nbsp;<span class="ident" id="5653292">mustGetTypeInfo</span><span class="op" id="5653307">(</span><span class="ident" id="5653308">typ</span><span class="op" id="5653311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5653316">op</span>&nbsp;<span class="op" id="5653319">=</span>&nbsp;<span class="keyword" id="5653321">func</span><span class="op" id="5653325">(</span><span class="ident" id="5653326">i</span>&nbsp;<span class="op" id="5653328">*</span><span class="ident" id="5653329">encInstr</span><span class="op" id="5653337">,</span>&nbsp;<span class="ident" id="5653339">state</span>&nbsp;<span class="op" id="5653345">*</span><span class="ident" id="5653346">encoderState</span><span class="op" id="5653358">,</span>&nbsp;<span class="ident" id="5653360">sv</span>&nbsp;<span class="ident" id="5653363">reflect</span><span class="op" id="5653370">.</span><span class="ident" id="5653371">Value</span><span class="op" id="5653376">)</span>&nbsp;<span class="op" id="5653378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5653384">state</span><span class="op" id="5653389">.</span><span class="ident" id="5653390">update</span><span class="op" id="5653396">(</span><span class="ident" id="5653397">i</span><span class="op" id="5653398">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5653404">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5653475">enc</span>&nbsp;<span class="op" id="5653479">:=</span>&nbsp;<span class="ident" id="5653482">info</span><span class="op" id="5653486">.</span><span class="ident" id="5653487">encoder</span><span class="op" id="5653494">.</span><span class="ident" id="5653495">Load</span><span class="op" id="5653499">(</span><span class="op" id="5653500">)</span><span class="op" id="5653501">.</span><span class="op" id="5653502">(</span><span class="op" id="5653503">*</span><span class="ident" id="5653504">encEngine</span><span class="op" id="5653513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5653519">state</span><span class="op" id="5653524">.</span><span class="ident" id="5653525">enc</span><span class="op" id="5653528">.</span><span class="ident" id="5653529">encodeStruct</span><span class="op" id="5653541">(</span><span class="ident" id="5653542">state</span><span class="op" id="5653547">.</span><span class="ident" id="5653548">b</span><span class="op" id="5653549">,</span>&nbsp;<span class="ident" id="5653551">enc</span><span class="op" id="5653554">,</span>&nbsp;<span class="ident" id="5653556">sv</span><span class="op" id="5653558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5653563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5653567">case</span>&nbsp;<span class="ident" id="5653572">reflect</span><span class="op" id="5653579">.</span><span class="ident" id="5653580">Interface</span><span class="op" id="5653589">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5653594">op</span>&nbsp;<span class="op" id="5653597">=</span>&nbsp;<span class="keyword" id="5653599">func</span><span class="op" id="5653603">(</span><span class="ident" id="5653604">i</span>&nbsp;<span class="op" id="5653606">*</span><span class="ident" id="5653607">encInstr</span><span class="op" id="5653615">,</span>&nbsp;<span class="ident" id="5653617">state</span>&nbsp;<span class="op" id="5653623">*</span><span class="ident" id="5653624">encoderState</span><span class="op" id="5653636">,</span>&nbsp;<span class="ident" id="5653638">iv</span>&nbsp;<span class="ident" id="5653641">reflect</span><span class="op" id="5653648">.</span><span class="ident" id="5653649">Value</span><span class="op" id="5653654">)</span>&nbsp;<span class="op" id="5653656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5653662">if</span>&nbsp;<span class="op" id="5653665">!</span><span class="ident" id="5653666">state</span><span class="op" id="5653671">.</span><span class="ident" id="5653672">sendZero</span>&nbsp;<span class="op" id="5653681">&amp;&amp;</span>&nbsp;<span class="op" id="5653684">(</span><span class="op" id="5653685">!</span><span class="ident" id="5653686">iv</span><span class="op" id="5653688">.</span><span class="ident" id="5653689">IsValid</span><span class="op" id="5653696">(</span><span class="op" id="5653697">)</span>&nbsp;<span class="op" id="5653699">||</span>&nbsp;<span class="ident" id="5653702">iv</span><span class="op" id="5653704">.</span><span class="ident" id="5653705">IsNil</span><span class="op" id="5653710">(</span><span class="op" id="5653711">)</span><span class="op" id="5653712">)</span>&nbsp;<span class="op" id="5653714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5653721">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5653732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5653738">state</span><span class="op" id="5653743">.</span><span class="ident" id="5653744">update</span><span class="op" id="5653750">(</span><span class="ident" id="5653751">i</span><span class="op" id="5653752">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5653758">state</span><span class="op" id="5653763">.</span><span class="ident" id="5653764">enc</span><span class="op" id="5653767">.</span><span class="ident" id="5653768">encodeInterface</span><span class="op" id="5653783">(</span><span class="ident" id="5653784">state</span><span class="op" id="5653789">.</span><span class="ident" id="5653790">b</span><span class="op" id="5653791">,</span>&nbsp;<span class="ident" id="5653793">iv</span><span class="op" id="5653795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5653800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5653804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5653807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5653810">if</span>&nbsp;<span class="ident" id="5653813">op</span>&nbsp;<span class="op" id="5653816">==</span>&nbsp;<span class="builtintype" id="5653819">nil</span>&nbsp;<span class="op" id="5653823">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5653827">errorf</span><span class="op" id="5653833">(</span><span class="string" id="5653834">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op" id="5653864">,</span>&nbsp;<span class="ident" id="5653866">rt</span><span class="op" id="5653868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5653871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5653874">return</span>&nbsp;<span class="op" id="5653881">&amp;</span><span class="ident" id="5653882">op</span><span class="op" id="5653884">,</span>&nbsp;<span class="ident" id="5653886">indir</span><br>
<span class="lineno"></span><span class="op" id="5653892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment" id="5653895">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword" id="5653978">func</span>&nbsp;<span class="ident" id="5653983">gobEncodeOpFor</span><span class="op" id="5653997">(</span><span class="ident" id="5653998">ut</span>&nbsp;<span class="op" id="5654001">*</span><span class="ident" id="5654002">userTypeInfo</span><span class="op" id="5654014">)</span>&nbsp;<span class="op" id="5654016">(</span><span class="op" id="5654017">*</span><span class="ident" id="5654018">encOp</span><span class="op" id="5654023">,</span>&nbsp;<span class="builtintype" id="5654025">int</span><span class="op" id="5654028">)</span>&nbsp;<span class="op" id="5654030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5654033">rt</span>&nbsp;<span class="op" id="5654036">:=</span>&nbsp;<span class="ident" id="5654039">ut</span><span class="op" id="5654041">.</span><span class="ident" id="5654042">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5654048">if</span>&nbsp;<span class="ident" id="5654051">ut</span><span class="op" id="5654053">.</span><span class="ident" id="5654054">encIndir</span>&nbsp;<span class="op" id="5654063">==</span>&nbsp;<span class="op" id="5654066">-</span><span class="num" id="5654067">1</span>&nbsp;<span class="op" id="5654069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5654073">rt</span>&nbsp;<span class="op" id="5654076">=</span>&nbsp;<span class="ident" id="5654078">reflect</span><span class="op" id="5654085">.</span><span class="ident" id="5654086">PtrTo</span><span class="op" id="5654091">(</span><span class="ident" id="5654092">rt</span><span class="op" id="5654094">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5654097">}</span>&nbsp;<span class="keyword" id="5654099">else</span>&nbsp;<span class="keyword" id="5654104">if</span>&nbsp;<span class="ident" id="5654107">ut</span><span class="op" id="5654109">.</span><span class="ident" id="5654110">encIndir</span>&nbsp;<span class="op" id="5654119">&gt;</span>&nbsp;<span class="num" id="5654121">0</span>&nbsp;<span class="op" id="5654123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5654127">for</span>&nbsp;<span class="ident" id="5654131">i</span>&nbsp;<span class="op" id="5654133">:=</span>&nbsp;<span class="builtintype" id="5654136">int8</span><span class="op" id="5654140">(</span><span class="num" id="5654141">0</span><span class="op" id="5654142">)</span><span class="op" id="5654143">;</span>&nbsp;<span class="ident" id="5654145">i</span>&nbsp;<span class="op" id="5654147">&lt;</span>&nbsp;<span class="ident" id="5654149">ut</span><span class="op" id="5654151">.</span><span class="ident" id="5654152">encIndir</span><span class="op" id="5654160">;</span>&nbsp;<span class="ident" id="5654162">i</span><span class="op" id="5654163">++</span>&nbsp;<span class="op" id="5654166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5654171">rt</span>&nbsp;<span class="op" id="5654174">=</span>&nbsp;<span class="ident" id="5654176">rt</span><span class="op" id="5654178">.</span><span class="ident" id="5654179">Elem</span><span class="op" id="5654183">(</span><span class="op" id="5654184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5654188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5654191">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5654194">var</span>&nbsp;<span class="ident" id="5654198">op</span>&nbsp;<span class="ident" id="5654201">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5654208">op</span>&nbsp;<span class="op" id="5654211">=</span>&nbsp;<span class="keyword" id="5654213">func</span><span class="op" id="5654217">(</span><span class="ident" id="5654218">i</span>&nbsp;<span class="op" id="5654220">*</span><span class="ident" id="5654221">encInstr</span><span class="op" id="5654229">,</span>&nbsp;<span class="ident" id="5654231">state</span>&nbsp;<span class="op" id="5654237">*</span><span class="ident" id="5654238">encoderState</span><span class="op" id="5654250">,</span>&nbsp;<span class="ident" id="5654252">v</span>&nbsp;<span class="ident" id="5654254">reflect</span><span class="op" id="5654261">.</span><span class="ident" id="5654262">Value</span><span class="op" id="5654267">)</span>&nbsp;<span class="op" id="5654269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5654273">if</span>&nbsp;<span class="ident" id="5654276">ut</span><span class="op" id="5654278">.</span><span class="ident" id="5654279">encIndir</span>&nbsp;<span class="op" id="5654288">==</span>&nbsp;<span class="op" id="5654291">-</span><span class="num" id="5654292">1</span>&nbsp;<span class="op" id="5654294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5654299">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5654360">if</span>&nbsp;<span class="op" id="5654363">!</span><span class="ident" id="5654364">v</span><span class="op" id="5654365">.</span><span class="ident" id="5654366">CanAddr</span><span class="op" id="5654373">(</span><span class="op" id="5654374">)</span>&nbsp;<span class="op" id="5654376">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5654382">errorf</span><span class="op" id="5654388">(</span><span class="string" id="5654389">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op" id="5654421">,</span>&nbsp;<span class="ident" id="5654423">rt</span><span class="op" id="5654425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5654430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5654435">v</span>&nbsp;<span class="op" id="5654437">=</span>&nbsp;<span class="ident" id="5654439">v</span><span class="op" id="5654440">.</span><span class="ident" id="5654441">Addr</span><span class="op" id="5654445">(</span><span class="op" id="5654446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5654450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5654454">if</span>&nbsp;<span class="op" id="5654457">!</span><span class="ident" id="5654458">state</span><span class="op" id="5654463">.</span><span class="ident" id="5654464">sendZero</span>&nbsp;<span class="op" id="5654473">&amp;&amp;</span>&nbsp;<span class="ident" id="5654476">isZero</span><span class="op" id="5654482">(</span><span class="ident" id="5654483">v</span><span class="op" id="5654484">)</span>&nbsp;<span class="op" id="5654486">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5654491">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5654500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5654504">state</span><span class="op" id="5654509">.</span><span class="ident" id="5654510">update</span><span class="op" id="5654516">(</span><span class="ident" id="5654517">i</span><span class="op" id="5654518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5654522">state</span><span class="op" id="5654527">.</span><span class="ident" id="5654528">enc</span><span class="op" id="5654531">.</span><span class="ident" id="5654532">encodeGobEncoder</span><span class="op" id="5654548">(</span><span class="ident" id="5654549">state</span><span class="op" id="5654554">.</span><span class="ident" id="5654555">b</span><span class="op" id="5654556">,</span>&nbsp;<span class="ident" id="5654558">ut</span><span class="op" id="5654560">,</span>&nbsp;<span class="ident" id="5654562">v</span><span class="op" id="5654563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5654566">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5654569">return</span>&nbsp;<span class="op" id="5654576">&amp;</span><span class="ident" id="5654577">op</span><span class="op" id="5654579">,</span>&nbsp;<span class="builtintype" id="5654581">int</span><span class="op" id="5654584">(</span><span class="ident" id="5654585">ut</span><span class="op" id="5654587">.</span><span class="ident" id="5654588">encIndir</span><span class="op" id="5654596">)</span>&nbsp;<span class="comment" id="5654598">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op" id="5654661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5654664">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5654718">func</span>&nbsp;<span class="ident" id="5654723">compileEnc</span><span class="op" id="5654733">(</span><span class="ident" id="5654734">ut</span>&nbsp;<span class="op" id="5654737">*</span><span class="ident" id="5654738">userTypeInfo</span><span class="op" id="5654750">,</span>&nbsp;<span class="ident" id="5654752">building</span>&nbsp;<span class="keyword" id="5654761">map</span><span class="op" id="5654764">[</span><span class="op" id="5654765">*</span><span class="ident" id="5654766">typeInfo</span><span class="op" id="5654774">]</span><span class="builtintype" id="5654775">bool</span><span class="op" id="5654779">)</span>&nbsp;<span class="op" id="5654781">*</span><span class="ident" id="5654782">encEngine</span>&nbsp;<span class="op" id="5654792">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5654795">srt</span>&nbsp;<span class="op" id="5654799">:=</span>&nbsp;<span class="ident" id="5654802">ut</span><span class="op" id="5654804">.</span><span class="ident" id="5654805">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5654811">engine</span>&nbsp;<span class="op" id="5654818">:=</span>&nbsp;<span class="builtinfunc" id="5654821">new</span><span class="op" id="5654824">(</span><span class="ident" id="5654825">encEngine</span><span class="op" id="5654834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5654837">seen</span>&nbsp;<span class="op" id="5654842">:=</span>&nbsp;<span class="builtinfunc" id="5654845">make</span><span class="op" id="5654849">(</span><span class="keyword" id="5654850">map</span><span class="op" id="5654853">[</span><span class="ident" id="5654854">reflect</span><span class="op" id="5654861">.</span><span class="ident" id="5654862">Type</span><span class="op" id="5654866">]</span><span class="op" id="5654867">*</span><span class="ident" id="5654868">encOp</span><span class="op" id="5654873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5654876">rt</span>&nbsp;<span class="op" id="5654879">:=</span>&nbsp;<span class="ident" id="5654882">ut</span><span class="op" id="5654884">.</span><span class="ident" id="5654885">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5654891">if</span>&nbsp;<span class="ident" id="5654894">ut</span><span class="op" id="5654896">.</span><span class="ident" id="5654897">externalEnc</span>&nbsp;<span class="op" id="5654909">!=</span>&nbsp;<span class="num" id="5654912">0</span>&nbsp;<span class="op" id="5654914">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5654918">rt</span>&nbsp;<span class="op" id="5654921">=</span>&nbsp;<span class="ident" id="5654923">ut</span><span class="op" id="5654925">.</span><span class="ident" id="5654926">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5654932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5654935">if</span>&nbsp;<span class="ident" id="5654938">ut</span><span class="op" id="5654940">.</span><span class="ident" id="5654941">externalEnc</span>&nbsp;<span class="op" id="5654953">==</span>&nbsp;<span class="num" id="5654956">0</span>&nbsp;<span class="op" id="5654958">&amp;&amp;</span>&nbsp;<span class="ident" id="5654961">srt</span><span class="op" id="5654964">.</span><span class="ident" id="5654965">Kind</span><span class="op" id="5654969">(</span><span class="op" id="5654970">)</span>&nbsp;<span class="op" id="5654972">==</span>&nbsp;<span class="ident" id="5654975">reflect</span><span class="op" id="5654982">.</span><span class="ident" id="5654983">Struct</span>&nbsp;<span class="op" id="5654990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5654994">for</span>&nbsp;<span class="ident" id="5654998">fieldNum</span><span class="op" id="5655006">,</span>&nbsp;<span class="ident" id="5655008">wireFieldNum</span>&nbsp;<span class="op" id="5655021">:=</span>&nbsp;<span class="num" id="5655024">0</span><span class="op" id="5655025">,</span>&nbsp;<span class="num" id="5655027">0</span><span class="op" id="5655028">;</span>&nbsp;<span class="ident" id="5655030">fieldNum</span>&nbsp;<span class="op" id="5655039">&lt;</span>&nbsp;<span class="ident" id="5655041">srt</span><span class="op" id="5655044">.</span><span class="ident" id="5655045">NumField</span><span class="op" id="5655053">(</span><span class="op" id="5655054">)</span><span class="op" id="5655055">;</span>&nbsp;<span class="ident" id="5655057">fieldNum</span><span class="op" id="5655065">++</span>&nbsp;<span class="op" id="5655068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5655073">f</span>&nbsp;<span class="op" id="5655075">:=</span>&nbsp;<span class="ident" id="5655078">srt</span><span class="op" id="5655081">.</span><span class="ident" id="5655082">Field</span><span class="op" id="5655087">(</span><span class="ident" id="5655088">fieldNum</span><span class="op" id="5655096">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5655101">if</span>&nbsp;<span class="op" id="5655104">!</span><span class="ident" id="5655105">isSent</span><span class="op" id="5655111">(</span><span class="op" id="5655112">&amp;</span><span class="ident" id="5655113">f</span><span class="op" id="5655114">)</span>&nbsp;<span class="op" id="5655116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5655122">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5655134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5655139">op</span><span class="op" id="5655141">,</span>&nbsp;<span class="ident" id="5655143">indir</span>&nbsp;<span class="op" id="5655149">:=</span>&nbsp;<span class="ident" id="5655152">encOpFor</span><span class="op" id="5655160">(</span><span class="ident" id="5655161">f</span><span class="op" id="5655162">.</span><span class="ident" id="5655163">Type</span><span class="op" id="5655167">,</span>&nbsp;<span class="ident" id="5655169">seen</span><span class="op" id="5655173">,</span>&nbsp;<span class="ident" id="5655175">building</span><span class="op" id="5655183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5655188">engine</span><span class="op" id="5655194">.</span><span class="ident" id="5655195">instr</span>&nbsp;<span class="op" id="5655201">=</span>&nbsp;<span class="builtinfunc" id="5655203">append</span><span class="op" id="5655209">(</span><span class="ident" id="5655210">engine</span><span class="op" id="5655216">.</span><span class="ident" id="5655217">instr</span><span class="op" id="5655222">,</span>&nbsp;<span class="ident" id="5655224">encInstr</span><span class="op" id="5655232">{</span><span class="op" id="5655233">*</span><span class="ident" id="5655234">op</span><span class="op" id="5655236">,</span>&nbsp;<span class="ident" id="5655238">wireFieldNum</span><span class="op" id="5655250">,</span>&nbsp;<span class="ident" id="5655252">f</span><span class="op" id="5655253">.</span><span class="ident" id="5655254">Index</span><span class="op" id="5655259">,</span>&nbsp;<span class="ident" id="5655261">indir</span><span class="op" id="5655266">}</span><span class="op" id="5655267">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5655272">wireFieldNum</span><span class="op" id="5655284">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5655289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5655293">if</span>&nbsp;<span class="ident" id="5655296">srt</span><span class="op" id="5655299">.</span><span class="ident" id="5655300">NumField</span><span class="op" id="5655308">(</span><span class="op" id="5655309">)</span>&nbsp;<span class="op" id="5655311">&gt;</span>&nbsp;<span class="num" id="5655313">0</span>&nbsp;<span class="op" id="5655315">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5655318">len</span><span class="op" id="5655321">(</span><span class="ident" id="5655322">engine</span><span class="op" id="5655328">.</span><span class="ident" id="5655329">instr</span><span class="op" id="5655334">)</span>&nbsp;<span class="op" id="5655336">==</span>&nbsp;<span class="num" id="5655339">0</span>&nbsp;<span class="op" id="5655341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5655346">errorf</span><span class="op" id="5655352">(</span><span class="string" id="5655353">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op" id="5655385">,</span>&nbsp;<span class="ident" id="5655387">rt</span><span class="op" id="5655389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5655393">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5655397">engine</span><span class="op" id="5655403">.</span><span class="ident" id="5655404">instr</span>&nbsp;<span class="op" id="5655410">=</span>&nbsp;<span class="builtinfunc" id="5655412">append</span><span class="op" id="5655418">(</span><span class="ident" id="5655419">engine</span><span class="op" id="5655425">.</span><span class="ident" id="5655426">instr</span><span class="op" id="5655431">,</span>&nbsp;<span class="ident" id="5655433">encInstr</span><span class="op" id="5655441">{</span><span class="ident" id="5655442">encStructTerminator</span><span class="op" id="5655461">,</span>&nbsp;<span class="num" id="5655463">0</span><span class="op" id="5655464">,</span>&nbsp;<span class="builtintype" id="5655466">nil</span><span class="op" id="5655469">,</span>&nbsp;<span class="num" id="5655471">0</span><span class="op" id="5655472">}</span><span class="op" id="5655473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5655476">}</span>&nbsp;<span class="keyword" id="5655478">else</span>&nbsp;<span class="op" id="5655483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5655487">engine</span><span class="op" id="5655493">.</span><span class="ident" id="5655494">instr</span>&nbsp;<span class="op" id="5655500">=</span>&nbsp;<span class="builtinfunc" id="5655502">make</span><span class="op" id="5655506">(</span><span class="op" id="5655507">[</span><span class="op" id="5655508">]</span><span class="ident" id="5655509">encInstr</span><span class="op" id="5655517">,</span>&nbsp;<span class="num" id="5655519">1</span><span class="op" id="5655520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5655524">op</span><span class="op" id="5655526">,</span>&nbsp;<span class="ident" id="5655528">indir</span>&nbsp;<span class="op" id="5655534">:=</span>&nbsp;<span class="ident" id="5655537">encOpFor</span><span class="op" id="5655545">(</span><span class="ident" id="5655546">rt</span><span class="op" id="5655548">,</span>&nbsp;<span class="ident" id="5655550">seen</span><span class="op" id="5655554">,</span>&nbsp;<span class="ident" id="5655556">building</span><span class="op" id="5655564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5655568">engine</span><span class="op" id="5655574">.</span><span class="ident" id="5655575">instr</span><span class="op" id="5655580">[</span><span class="num" id="5655581">0</span><span class="op" id="5655582">]</span>&nbsp;<span class="op" id="5655584">=</span>&nbsp;<span class="ident" id="5655586">encInstr</span><span class="op" id="5655594">{</span><span class="op" id="5655595">*</span><span class="ident" id="5655596">op</span><span class="op" id="5655598">,</span>&nbsp;<span class="ident" id="5655600">singletonField</span><span class="op" id="5655614">,</span>&nbsp;<span class="builtintype" id="5655616">nil</span><span class="op" id="5655619">,</span>&nbsp;<span class="ident" id="5655621">indir</span><span class="op" id="5655626">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5655629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5655632">return</span>&nbsp;<span class="ident" id="5655639">engine</span><br>
<span class="lineno"></span><span class="op" id="5655646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5655649">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword" id="5655705">func</span>&nbsp;<span class="ident" id="5655710">getEncEngine</span><span class="op" id="5655722">(</span><span class="ident" id="5655723">ut</span>&nbsp;<span class="op" id="5655726">*</span><span class="ident" id="5655727">userTypeInfo</span><span class="op" id="5655739">,</span>&nbsp;<span class="ident" id="5655741">building</span>&nbsp;<span class="keyword" id="5655750">map</span><span class="op" id="5655753">[</span><span class="op" id="5655754">*</span><span class="ident" id="5655755">typeInfo</span><span class="op" id="5655763">]</span><span class="builtintype" id="5655764">bool</span><span class="op" id="5655768">)</span>&nbsp;<span class="op" id="5655770">*</span><span class="ident" id="5655771">encEngine</span>&nbsp;<span class="op" id="5655781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5655784">info</span><span class="op" id="5655788">,</span>&nbsp;<span class="ident" id="5655790">err</span>&nbsp;<span class="op" id="5655794">:=</span>&nbsp;<span class="ident" id="5655797">getTypeInfo</span><span class="op" id="5655808">(</span><span class="ident" id="5655809">ut</span><span class="op" id="5655811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5655814">if</span>&nbsp;<span class="ident" id="5655817">err</span>&nbsp;<span class="op" id="5655821">!=</span>&nbsp;<span class="builtintype" id="5655824">nil</span>&nbsp;<span class="op" id="5655828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5655832">error_</span><span class="op" id="5655838">(</span><span class="ident" id="5655839">err</span><span class="op" id="5655842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5655845">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5655848">enc</span><span class="op" id="5655851">,</span>&nbsp;<span class="ident" id="5655853">ok</span>&nbsp;<span class="op" id="5655856">:=</span>&nbsp;<span class="ident" id="5655859">info</span><span class="op" id="5655863">.</span><span class="ident" id="5655864">encoder</span><span class="op" id="5655871">.</span><span class="ident" id="5655872">Load</span><span class="op" id="5655876">(</span><span class="op" id="5655877">)</span><span class="op" id="5655878">.</span><span class="op" id="5655879">(</span><span class="op" id="5655880">*</span><span class="ident" id="5655881">encEngine</span><span class="op" id="5655890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5655893">if</span>&nbsp;<span class="op" id="5655896">!</span><span class="ident" id="5655897">ok</span>&nbsp;<span class="op" id="5655900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5655904">enc</span>&nbsp;<span class="op" id="5655908">=</span>&nbsp;<span class="ident" id="5655910">buildEncEngine</span><span class="op" id="5655924">(</span><span class="ident" id="5655925">info</span><span class="op" id="5655929">,</span>&nbsp;<span class="ident" id="5655931">ut</span><span class="op" id="5655933">,</span>&nbsp;<span class="ident" id="5655935">building</span><span class="op" id="5655943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5655946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5655949">return</span>&nbsp;<span class="ident" id="5655956">enc</span><br>
<span class="lineno">660</span><span class="op" id="5655960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5655963">func</span>&nbsp;<span class="ident" id="5655968">buildEncEngine</span><span class="op" id="5655982">(</span><span class="ident" id="5655983">info</span>&nbsp;<span class="op" id="5655988">*</span><span class="ident" id="5655989">typeInfo</span><span class="op" id="5655997">,</span>&nbsp;<span class="ident" id="5655999">ut</span>&nbsp;<span class="op" id="5656002">*</span><span class="ident" id="5656003">userTypeInfo</span><span class="op" id="5656015">,</span>&nbsp;<span class="ident" id="5656017">building</span>&nbsp;<span class="keyword" id="5656026">map</span><span class="op" id="5656029">[</span><span class="op" id="5656030">*</span><span class="ident" id="5656031">typeInfo</span><span class="op" id="5656039">]</span><span class="builtintype" id="5656040">bool</span><span class="op" id="5656044">)</span>&nbsp;<span class="op" id="5656046">*</span><span class="ident" id="5656047">encEngine</span>&nbsp;<span class="op" id="5656057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5656060">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5656091">if</span>&nbsp;<span class="ident" id="5656094">building</span>&nbsp;<span class="op" id="5656103">!=</span>&nbsp;<span class="builtintype" id="5656106">nil</span>&nbsp;<span class="op" id="5656110">&amp;&amp;</span>&nbsp;<span class="ident" id="5656113">building</span><span class="op" id="5656121">[</span><span class="ident" id="5656122">info</span><span class="op" id="5656126">]</span>&nbsp;<span class="op" id="5656128">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5656132">return</span>&nbsp;<span class="builtintype" id="5656139">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5656144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5656147">info</span><span class="op" id="5656151">.</span><span class="ident" id="5656152">encInit</span><span class="op" id="5656159">.</span><span class="ident" id="5656160">Lock</span><span class="op" id="5656164">(</span><span class="op" id="5656165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5656168">defer</span>&nbsp;<span class="ident" id="5656174">info</span><span class="op" id="5656178">.</span><span class="ident" id="5656179">encInit</span><span class="op" id="5656186">.</span><span class="ident" id="5656187">Unlock</span><span class="op" id="5656193">(</span><span class="op" id="5656194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5656197">enc</span><span class="op" id="5656200">,</span>&nbsp;<span class="ident" id="5656202">ok</span>&nbsp;<span class="op" id="5656205">:=</span>&nbsp;<span class="ident" id="5656208">info</span><span class="op" id="5656212">.</span><span class="ident" id="5656213">encoder</span><span class="op" id="5656220">.</span><span class="ident" id="5656221">Load</span><span class="op" id="5656225">(</span><span class="op" id="5656226">)</span><span class="op" id="5656227">.</span><span class="op" id="5656228">(</span><span class="op" id="5656229">*</span><span class="ident" id="5656230">encEngine</span><span class="op" id="5656239">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5656242">if</span>&nbsp;<span class="op" id="5656245">!</span><span class="ident" id="5656246">ok</span>&nbsp;<span class="op" id="5656249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5656253">if</span>&nbsp;<span class="ident" id="5656256">building</span>&nbsp;<span class="op" id="5656265">==</span>&nbsp;<span class="builtintype" id="5656268">nil</span>&nbsp;<span class="op" id="5656272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5656277">building</span>&nbsp;<span class="op" id="5656286">=</span>&nbsp;<span class="builtinfunc" id="5656288">make</span><span class="op" id="5656292">(</span><span class="keyword" id="5656293">map</span><span class="op" id="5656296">[</span><span class="op" id="5656297">*</span><span class="ident" id="5656298">typeInfo</span><span class="op" id="5656306">]</span><span class="builtintype" id="5656307">bool</span><span class="op" id="5656311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5656315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5656319">building</span><span class="op" id="5656327">[</span><span class="ident" id="5656328">info</span><span class="op" id="5656332">]</span>&nbsp;<span class="op" id="5656334">=</span>&nbsp;<span class="builtintype" id="5656336">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5656343">enc</span>&nbsp;<span class="op" id="5656347">=</span>&nbsp;<span class="ident" id="5656349">compileEnc</span><span class="op" id="5656359">(</span><span class="ident" id="5656360">ut</span><span class="op" id="5656362">,</span>&nbsp;<span class="ident" id="5656364">building</span><span class="op" id="5656372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5656376">info</span><span class="op" id="5656380">.</span><span class="ident" id="5656381">encoder</span><span class="op" id="5656388">.</span><span class="ident" id="5656389">Store</span><span class="op" id="5656394">(</span><span class="ident" id="5656395">enc</span><span class="op" id="5656398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5656401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5656404">return</span>&nbsp;<span class="ident" id="5656411">enc</span><br>
<span class="lineno"></span><span class="op" id="5656415">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="5656418">func</span>&nbsp;<span class="op" id="5656423">(</span><span class="ident" id="5656424">enc</span>&nbsp;<span class="op" id="5656428">*</span><span class="ident" id="5656429">Encoder</span><span class="op" id="5656436">)</span>&nbsp;<span class="ident" id="5656438">encode</span><span class="op" id="5656444">(</span><span class="ident" id="5656445">b</span>&nbsp;<span class="op" id="5656447">*</span><span class="ident" id="5656448">encBuffer</span><span class="op" id="5656457">,</span>&nbsp;<span class="ident" id="5656459">value</span>&nbsp;<span class="ident" id="5656465">reflect</span><span class="op" id="5656472">.</span><span class="ident" id="5656473">Value</span><span class="op" id="5656478">,</span>&nbsp;<span class="ident" id="5656480">ut</span>&nbsp;<span class="op" id="5656483">*</span><span class="ident" id="5656484">userTypeInfo</span><span class="op" id="5656496">)</span>&nbsp;<span class="op" id="5656498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5656501">defer</span>&nbsp;<span class="ident" id="5656507">catchError</span><span class="op" id="5656517">(</span><span class="op" id="5656518">&amp;</span><span class="ident" id="5656519">enc</span><span class="op" id="5656522">.</span><span class="ident" id="5656523">err</span><span class="op" id="5656526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5656529">engine</span>&nbsp;<span class="op" id="5656536">:=</span>&nbsp;<span class="ident" id="5656539">getEncEngine</span><span class="op" id="5656551">(</span><span class="ident" id="5656552">ut</span><span class="op" id="5656554">,</span>&nbsp;<span class="builtintype" id="5656556">nil</span><span class="op" id="5656559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5656562">indir</span>&nbsp;<span class="op" id="5656568">:=</span>&nbsp;<span class="ident" id="5656571">ut</span><span class="op" id="5656573">.</span><span class="ident" id="5656574">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5656581">if</span>&nbsp;<span class="ident" id="5656584">ut</span><span class="op" id="5656586">.</span><span class="ident" id="5656587">externalEnc</span>&nbsp;<span class="op" id="5656599">!=</span>&nbsp;<span class="num" id="5656602">0</span>&nbsp;<span class="op" id="5656604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5656608">indir</span>&nbsp;<span class="op" id="5656614">=</span>&nbsp;<span class="builtintype" id="5656616">int</span><span class="op" id="5656619">(</span><span class="ident" id="5656620">ut</span><span class="op" id="5656622">.</span><span class="ident" id="5656623">encIndir</span><span class="op" id="5656631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5656634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5656637">for</span>&nbsp;<span class="ident" id="5656641">i</span>&nbsp;<span class="op" id="5656643">:=</span>&nbsp;<span class="num" id="5656646">0</span><span class="op" id="5656647">;</span>&nbsp;<span class="ident" id="5656649">i</span>&nbsp;<span class="op" id="5656651">&lt;</span>&nbsp;<span class="ident" id="5656653">indir</span><span class="op" id="5656658">;</span>&nbsp;<span class="ident" id="5656660">i</span><span class="op" id="5656661">++</span>&nbsp;<span class="op" id="5656664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5656668">value</span>&nbsp;<span class="op" id="5656674">=</span>&nbsp;<span class="ident" id="5656676">reflect</span><span class="op" id="5656683">.</span><span class="ident" id="5656684">Indirect</span><span class="op" id="5656692">(</span><span class="ident" id="5656693">value</span><span class="op" id="5656698">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5656701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5656704">if</span>&nbsp;<span class="ident" id="5656707">ut</span><span class="op" id="5656709">.</span><span class="ident" id="5656710">externalEnc</span>&nbsp;<span class="op" id="5656722">==</span>&nbsp;<span class="num" id="5656725">0</span>&nbsp;<span class="op" id="5656727">&amp;&amp;</span>&nbsp;<span class="ident" id="5656730">value</span><span class="op" id="5656735">.</span><span class="ident" id="5656736">Type</span><span class="op" id="5656740">(</span><span class="op" id="5656741">)</span><span class="op" id="5656742">.</span><span class="ident" id="5656743">Kind</span><span class="op" id="5656747">(</span><span class="op" id="5656748">)</span>&nbsp;<span class="op" id="5656750">==</span>&nbsp;<span class="ident" id="5656753">reflect</span><span class="op" id="5656760">.</span><span class="ident" id="5656761">Struct</span>&nbsp;<span class="op" id="5656768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5656772">enc</span><span class="op" id="5656775">.</span><span class="ident" id="5656776">encodeStruct</span><span class="op" id="5656788">(</span><span class="ident" id="5656789">b</span><span class="op" id="5656790">,</span>&nbsp;<span class="ident" id="5656792">engine</span><span class="op" id="5656798">,</span>&nbsp;<span class="ident" id="5656800">value</span><span class="op" id="5656805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5656808">}</span>&nbsp;<span class="keyword" id="5656810">else</span>&nbsp;<span class="op" id="5656815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5656819">enc</span><span class="op" id="5656822">.</span><span class="ident" id="5656823">encodeSingle</span><span class="op" id="5656835">(</span><span class="ident" id="5656836">b</span><span class="op" id="5656837">,</span>&nbsp;<span class="ident" id="5656839">engine</span><span class="op" id="5656845">,</span>&nbsp;<span class="ident" id="5656847">value</span><span class="op" id="5656852">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5656855">}</span><br>
<span class="lineno"></span><span class="op" id="5656857">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
