<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/pem</h2>
<ul>
<li><a href="/gostd/encoding/pem/pem.go.html">pem.go</a></li>
<li><a href="/gostd/encoding/pem/pem_test.go.html">pem_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4391111">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4391166">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4391220">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4391271">//&nbsp;Package&nbsp;pem&nbsp;implements&nbsp;the&nbsp;PEM&nbsp;data&nbsp;encoding,&nbsp;which&nbsp;originated&nbsp;in&nbsp;Privacy</span><br>
<span class="lineno"></span><span class="comment" id="4391348">//&nbsp;Enhanced&nbsp;Mail.&nbsp;The&nbsp;most&nbsp;common&nbsp;use&nbsp;of&nbsp;PEM&nbsp;encoding&nbsp;today&nbsp;is&nbsp;in&nbsp;TLS&nbsp;keys&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4391427">//&nbsp;certificates.&nbsp;See&nbsp;RFC&nbsp;1421.</span><br>
<span class="lineno"></span><span class="keyword" id="4391458">package</span>&nbsp;<span class="ident" id="4391466">pem</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="4391471">import</span>&nbsp;<span class="op" id="4391478">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4391481">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4391490">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4391509">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4391515">&#34;sort&#34;</span><br>
<span class="lineno">15</span><span class="op" id="4391522">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4391525">//&nbsp;A&nbsp;Block&nbsp;represents&nbsp;a&nbsp;PEM&nbsp;encoded&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="4391572">//</span><br>
<span class="lineno"></span><span class="comment" id="4391575">//&nbsp;The&nbsp;encoded&nbsp;form&nbsp;is:</span><br>
<span class="lineno">20</span><span class="comment" id="4391599">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;Type-----</span><br>
<span class="lineno"></span><span class="comment" id="4391626">//&nbsp;&nbsp;&nbsp;&nbsp;Headers</span><br>
<span class="lineno"></span><span class="comment" id="4391640">//&nbsp;&nbsp;&nbsp;&nbsp;base64-encoded&nbsp;Bytes</span><br>
<span class="lineno"></span><span class="comment" id="4391667">//&nbsp;&nbsp;&nbsp;&nbsp;-----END&nbsp;Type-----</span><br>
<span class="lineno"></span><span class="comment" id="4391692">//&nbsp;where&nbsp;Headers&nbsp;is&nbsp;a&nbsp;possibly&nbsp;empty&nbsp;sequence&nbsp;of&nbsp;Key:&nbsp;Value&nbsp;lines.</span><br>
<span class="lineno">25</span><span class="keyword" id="4391759">type</span>&nbsp;<span class="ident" id="4391764">Block</span>&nbsp;<span class="keyword" id="4391770">struct</span>&nbsp;<span class="op" id="4391777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4391780">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4391788">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4391806">//&nbsp;The&nbsp;type,&nbsp;taken&nbsp;from&nbsp;the&nbsp;preamble&nbsp;(i.e.&nbsp;&#34;RSA&nbsp;PRIVATE&nbsp;KEY&#34;).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4391870">Headers</span>&nbsp;<span class="keyword" id="4391878">map</span><span class="op" id="4391881">[</span><span class="builtintype" id="4391882">string</span><span class="op" id="4391888">]</span><span class="builtintype" id="4391889">string</span>&nbsp;<span class="comment" id="4391896">//&nbsp;Optional&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4391918">Bytes</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4391926">[</span><span class="op" id="4391927">]</span><span class="builtintype" id="4391928">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4391944">//&nbsp;The&nbsp;decoded&nbsp;bytes&nbsp;of&nbsp;the&nbsp;contents.&nbsp;Typically&nbsp;a&nbsp;DER&nbsp;encoded&nbsp;ASN.1&nbsp;structure.</span><br>
<span class="lineno"></span><span class="op" id="4392023">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="4392026">//&nbsp;getLine&nbsp;results&nbsp;the&nbsp;first&nbsp;\r\n&nbsp;or&nbsp;\n&nbsp;delineated&nbsp;line&nbsp;from&nbsp;the&nbsp;given&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="4392102">//&nbsp;array.&nbsp;The&nbsp;line&nbsp;does&nbsp;not&nbsp;include&nbsp;trailing&nbsp;whitespace&nbsp;or&nbsp;the&nbsp;trailing&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4392178">//&nbsp;line&nbsp;bytes.&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;byte&nbsp;array&nbsp;(also&nbsp;not&nbsp;including&nbsp;the&nbsp;new&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="4392258">//&nbsp;bytes)&nbsp;is&nbsp;also&nbsp;returned&nbsp;and&nbsp;this&nbsp;will&nbsp;always&nbsp;be&nbsp;smaller&nbsp;than&nbsp;the&nbsp;original</span><br>
<span class="lineno">35</span><span class="comment" id="4392335">//&nbsp;argument.</span><br>
<span class="lineno"></span><span class="keyword" id="4392348">func</span>&nbsp;<span class="ident" id="4392353">getLine</span><span class="op" id="4392360">(</span><span class="ident" id="4392361">data</span>&nbsp;<span class="op" id="4392366">[</span><span class="op" id="4392367">]</span><span class="builtintype" id="4392368">byte</span><span class="op" id="4392372">)</span>&nbsp;<span class="op" id="4392374">(</span><span class="ident" id="4392375">line</span><span class="op" id="4392379">,</span>&nbsp;<span class="ident" id="4392381">rest</span>&nbsp;<span class="op" id="4392386">[</span><span class="op" id="4392387">]</span><span class="builtintype" id="4392388">byte</span><span class="op" id="4392392">)</span>&nbsp;<span class="op" id="4392394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4392397">i</span>&nbsp;<span class="op" id="4392399">:=</span>&nbsp;<span class="ident" id="4392402">bytes</span><span class="op" id="4392407">.</span><span class="ident" id="4392408">Index</span><span class="op" id="4392413">(</span><span class="ident" id="4392414">data</span><span class="op" id="4392418">,</span>&nbsp;<span class="op" id="4392420">[</span><span class="op" id="4392421">]</span><span class="builtintype" id="4392422">byte</span><span class="op" id="4392426">{</span><span class="string" id="4392427">&#39;\n&#39;</span><span class="op" id="4392431">}</span><span class="op" id="4392432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4392435">var</span>&nbsp;<span class="ident" id="4392439">j</span>&nbsp;<span class="builtintype" id="4392441">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4392446">if</span>&nbsp;<span class="ident" id="4392449">i</span>&nbsp;<span class="op" id="4392451">&lt;</span>&nbsp;<span class="num" id="4392453">0</span>&nbsp;<span class="op" id="4392455">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4392459">i</span>&nbsp;<span class="op" id="4392461">=</span>&nbsp;<span class="builtinfunc" id="4392463">len</span><span class="op" id="4392466">(</span><span class="ident" id="4392467">data</span><span class="op" id="4392471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4392475">j</span>&nbsp;<span class="op" id="4392477">=</span>&nbsp;<span class="ident" id="4392479">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4392482">}</span>&nbsp;<span class="keyword" id="4392484">else</span>&nbsp;<span class="op" id="4392489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4392493">j</span>&nbsp;<span class="op" id="4392495">=</span>&nbsp;<span class="ident" id="4392497">i</span>&nbsp;<span class="op" id="4392499">+</span>&nbsp;<span class="num" id="4392501">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4392505">if</span>&nbsp;<span class="ident" id="4392508">i</span>&nbsp;<span class="op" id="4392510">&gt;</span>&nbsp;<span class="num" id="4392512">0</span>&nbsp;<span class="op" id="4392514">&amp;&amp;</span>&nbsp;<span class="ident" id="4392517">data</span><span class="op" id="4392521">[</span><span class="ident" id="4392522">i</span><span class="op" id="4392523">-</span><span class="num" id="4392524">1</span><span class="op" id="4392525">]</span>&nbsp;<span class="op" id="4392527">==</span>&nbsp;<span class="string" id="4392530">&#39;\r&#39;</span>&nbsp;<span class="op" id="4392535">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4392540">i</span><span class="op" id="4392541">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4392546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4392549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4392552">return</span>&nbsp;<span class="ident" id="4392559">bytes</span><span class="op" id="4392564">.</span><span class="ident" id="4392565">TrimRight</span><span class="op" id="4392574">(</span><span class="ident" id="4392575">data</span><span class="op" id="4392579">[</span><span class="num" id="4392580">0</span><span class="op" id="4392581">:</span><span class="ident" id="4392582">i</span><span class="op" id="4392583">]</span><span class="op" id="4392584">,</span>&nbsp;<span class="string" id="4392586">&#34;&nbsp;\t&#34;</span><span class="op" id="4392591">)</span><span class="op" id="4392592">,</span>&nbsp;<span class="ident" id="4392594">data</span><span class="op" id="4392598">[</span><span class="ident" id="4392599">j</span><span class="op" id="4392600">:</span><span class="op" id="4392601">]</span><br>
<span class="lineno"></span><span class="op" id="4392603">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="4392606">//&nbsp;removeWhitespace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;its&nbsp;input&nbsp;with&nbsp;all&nbsp;spaces,&nbsp;tab&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4392679">//&nbsp;newline&nbsp;characters&nbsp;removed.</span><br>
<span class="lineno"></span><span class="keyword" id="4392710">func</span>&nbsp;<span class="ident" id="4392715">removeWhitespace</span><span class="op" id="4392731">(</span><span class="ident" id="4392732">data</span>&nbsp;<span class="op" id="4392737">[</span><span class="op" id="4392738">]</span><span class="builtintype" id="4392739">byte</span><span class="op" id="4392743">)</span>&nbsp;<span class="op" id="4392745">[</span><span class="op" id="4392746">]</span><span class="builtintype" id="4392747">byte</span>&nbsp;<span class="op" id="4392752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4392755">result</span>&nbsp;<span class="op" id="4392762">:=</span>&nbsp;<span class="builtinfunc" id="4392765">make</span><span class="op" id="4392769">(</span><span class="op" id="4392770">[</span><span class="op" id="4392771">]</span><span class="builtintype" id="4392772">byte</span><span class="op" id="4392776">,</span>&nbsp;<span class="builtinfunc" id="4392778">len</span><span class="op" id="4392781">(</span><span class="ident" id="4392782">data</span><span class="op" id="4392786">)</span><span class="op" id="4392787">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4392790">n</span>&nbsp;<span class="op" id="4392792">:=</span>&nbsp;<span class="num" id="4392795">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4392799">for</span>&nbsp;<span class="ident" id="4392803">_</span><span class="op" id="4392804">,</span>&nbsp;<span class="ident" id="4392806">b</span>&nbsp;<span class="op" id="4392808">:=</span>&nbsp;<span class="keyword" id="4392811">range</span>&nbsp;<span class="ident" id="4392817">data</span>&nbsp;<span class="op" id="4392822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4392826">if</span>&nbsp;<span class="ident" id="4392829">b</span>&nbsp;<span class="op" id="4392831">==</span>&nbsp;<span class="string" id="4392834">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4392838">||</span>&nbsp;<span class="ident" id="4392841">b</span>&nbsp;<span class="op" id="4392843">==</span>&nbsp;<span class="string" id="4392846">&#39;\t&#39;</span>&nbsp;<span class="op" id="4392851">||</span>&nbsp;<span class="ident" id="4392854">b</span>&nbsp;<span class="op" id="4392856">==</span>&nbsp;<span class="string" id="4392859">&#39;\r&#39;</span>&nbsp;<span class="op" id="4392864">||</span>&nbsp;<span class="ident" id="4392867">b</span>&nbsp;<span class="op" id="4392869">==</span>&nbsp;<span class="string" id="4392872">&#39;\n&#39;</span>&nbsp;<span class="op" id="4392877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4392882">continue</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4392893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4392897">result</span><span class="op" id="4392903">[</span><span class="ident" id="4392904">n</span><span class="op" id="4392905">]</span>&nbsp;<span class="op" id="4392907">=</span>&nbsp;<span class="ident" id="4392909">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4392913">n</span><span class="op" id="4392914">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4392918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4392922">return</span>&nbsp;<span class="ident" id="4392929">result</span><span class="op" id="4392935">[</span><span class="num" id="4392936">0</span><span class="op" id="4392937">:</span><span class="ident" id="4392938">n</span><span class="op" id="4392939">]</span><br>
<span class="lineno"></span><span class="op" id="4392941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4392944">var</span>&nbsp;<span class="ident" id="4392948">pemStart</span>&nbsp;<span class="op" id="4392957">=</span>&nbsp;<span class="op" id="4392959">[</span><span class="op" id="4392960">]</span><span class="builtintype" id="4392961">byte</span><span class="op" id="4392965">(</span><span class="string" id="4392966">&#34;\n-----BEGIN&nbsp;&#34;</span><span class="op" id="4392981">)</span><br>
<span class="lineno"></span><span class="keyword" id="4392983">var</span>&nbsp;<span class="ident" id="4392987">pemEnd</span>&nbsp;<span class="op" id="4392994">=</span>&nbsp;<span class="op" id="4392996">[</span><span class="op" id="4392997">]</span><span class="builtintype" id="4392998">byte</span><span class="op" id="4393002">(</span><span class="string" id="4393003">&#34;\n-----END&nbsp;&#34;</span><span class="op" id="4393016">)</span><br>
<span class="lineno">70</span><span class="keyword" id="4393018">var</span>&nbsp;<span class="ident" id="4393022">pemEndOfLine</span>&nbsp;<span class="op" id="4393035">=</span>&nbsp;<span class="op" id="4393037">[</span><span class="op" id="4393038">]</span><span class="builtintype" id="4393039">byte</span><span class="op" id="4393043">(</span><span class="string" id="4393044">&#34;-----&#34;</span><span class="op" id="4393051">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4393054">//&nbsp;Decode&nbsp;will&nbsp;find&nbsp;the&nbsp;next&nbsp;PEM&nbsp;formatted&nbsp;block&nbsp;(certificate,&nbsp;private&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="4393129">//&nbsp;etc)&nbsp;in&nbsp;the&nbsp;input.&nbsp;It&nbsp;returns&nbsp;that&nbsp;block&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;input.&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="4393208">//&nbsp;no&nbsp;PEM&nbsp;data&nbsp;is&nbsp;found,&nbsp;p&nbsp;is&nbsp;nil&nbsp;and&nbsp;the&nbsp;whole&nbsp;of&nbsp;the&nbsp;input&nbsp;is&nbsp;returned&nbsp;in</span><br>
<span class="lineno">75</span><span class="comment" id="4393284">//&nbsp;rest.</span><br>
<span class="lineno"></span><span class="keyword" id="4393293">func</span>&nbsp;<span class="ident" id="4393298">Decode</span><span class="op" id="4393304">(</span><span class="ident" id="4393305">data</span>&nbsp;<span class="op" id="4393310">[</span><span class="op" id="4393311">]</span><span class="builtintype" id="4393312">byte</span><span class="op" id="4393316">)</span>&nbsp;<span class="op" id="4393318">(</span><span class="ident" id="4393319">p</span>&nbsp;<span class="op" id="4393321">*</span><span class="ident" id="4393322">Block</span><span class="op" id="4393327">,</span>&nbsp;<span class="ident" id="4393329">rest</span>&nbsp;<span class="op" id="4393334">[</span><span class="op" id="4393335">]</span><span class="builtintype" id="4393336">byte</span><span class="op" id="4393340">)</span>&nbsp;<span class="op" id="4393342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4393345">//&nbsp;pemStart&nbsp;begins&nbsp;with&nbsp;a&nbsp;newline.&nbsp;However,&nbsp;at&nbsp;the&nbsp;very&nbsp;beginning&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4393415">//&nbsp;the&nbsp;byte&nbsp;array,&nbsp;we&#39;ll&nbsp;accept&nbsp;the&nbsp;start&nbsp;string&nbsp;without&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4393477">rest</span>&nbsp;<span class="op" id="4393482">=</span>&nbsp;<span class="ident" id="4393484">data</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4393490">if</span>&nbsp;<span class="ident" id="4393493">bytes</span><span class="op" id="4393498">.</span><span class="ident" id="4393499">HasPrefix</span><span class="op" id="4393508">(</span><span class="ident" id="4393509">data</span><span class="op" id="4393513">,</span>&nbsp;<span class="ident" id="4393515">pemStart</span><span class="op" id="4393523">[</span><span class="num" id="4393524">1</span><span class="op" id="4393525">:</span><span class="op" id="4393526">]</span><span class="op" id="4393527">)</span>&nbsp;<span class="op" id="4393529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4393533">rest</span>&nbsp;<span class="op" id="4393538">=</span>&nbsp;<span class="ident" id="4393540">rest</span><span class="op" id="4393544">[</span><span class="builtinfunc" id="4393545">len</span><span class="op" id="4393548">(</span><span class="ident" id="4393549">pemStart</span><span class="op" id="4393557">)</span><span class="op" id="4393558">-</span><span class="num" id="4393559">1</span>&nbsp;<span class="op" id="4393561">:</span>&nbsp;<span class="builtinfunc" id="4393563">len</span><span class="op" id="4393566">(</span><span class="ident" id="4393567">data</span><span class="op" id="4393571">)</span><span class="op" id="4393572">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4393575">}</span>&nbsp;<span class="keyword" id="4393577">else</span>&nbsp;<span class="keyword" id="4393582">if</span>&nbsp;<span class="ident" id="4393585">i</span>&nbsp;<span class="op" id="4393587">:=</span>&nbsp;<span class="ident" id="4393590">bytes</span><span class="op" id="4393595">.</span><span class="ident" id="4393596">Index</span><span class="op" id="4393601">(</span><span class="ident" id="4393602">data</span><span class="op" id="4393606">,</span>&nbsp;<span class="ident" id="4393608">pemStart</span><span class="op" id="4393616">)</span><span class="op" id="4393617">;</span>&nbsp;<span class="ident" id="4393619">i</span>&nbsp;<span class="op" id="4393621">&gt;=</span>&nbsp;<span class="num" id="4393624">0</span>&nbsp;<span class="op" id="4393626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4393630">rest</span>&nbsp;<span class="op" id="4393635">=</span>&nbsp;<span class="ident" id="4393637">rest</span><span class="op" id="4393641">[</span><span class="ident" id="4393642">i</span><span class="op" id="4393643">+</span><span class="builtinfunc" id="4393644">len</span><span class="op" id="4393647">(</span><span class="ident" id="4393648">pemStart</span><span class="op" id="4393656">)</span>&nbsp;<span class="op" id="4393658">:</span>&nbsp;<span class="builtinfunc" id="4393660">len</span><span class="op" id="4393663">(</span><span class="ident" id="4393664">data</span><span class="op" id="4393668">)</span><span class="op" id="4393669">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4393672">}</span>&nbsp;<span class="keyword" id="4393674">else</span>&nbsp;<span class="op" id="4393679">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4393683">return</span>&nbsp;<span class="ident" id="4393690">nil</span><span class="op" id="4393693">,</span>&nbsp;<span class="ident" id="4393695">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4393701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4393705">typeLine</span><span class="op" id="4393713">,</span>&nbsp;<span class="ident" id="4393715">rest</span>&nbsp;<span class="op" id="4393720">:=</span>&nbsp;<span class="ident" id="4393723">getLine</span><span class="op" id="4393730">(</span><span class="ident" id="4393731">rest</span><span class="op" id="4393735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4393738">if</span>&nbsp;<span class="op" id="4393741">!</span><span class="ident" id="4393742">bytes</span><span class="op" id="4393747">.</span><span class="ident" id="4393748">HasSuffix</span><span class="op" id="4393757">(</span><span class="ident" id="4393758">typeLine</span><span class="op" id="4393766">,</span>&nbsp;<span class="ident" id="4393768">pemEndOfLine</span><span class="op" id="4393780">)</span>&nbsp;<span class="op" id="4393782">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4393786">return</span>&nbsp;<span class="ident" id="4393793">decodeError</span><span class="op" id="4393804">(</span><span class="ident" id="4393805">data</span><span class="op" id="4393809">,</span>&nbsp;<span class="ident" id="4393811">rest</span><span class="op" id="4393815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4393818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4393821">typeLine</span>&nbsp;<span class="op" id="4393830">=</span>&nbsp;<span class="ident" id="4393832">typeLine</span><span class="op" id="4393840">[</span><span class="num" id="4393841">0</span>&nbsp;<span class="op" id="4393843">:</span>&nbsp;<span class="builtinfunc" id="4393845">len</span><span class="op" id="4393848">(</span><span class="ident" id="4393849">typeLine</span><span class="op" id="4393857">)</span><span class="op" id="4393858">-</span><span class="builtinfunc" id="4393859">len</span><span class="op" id="4393862">(</span><span class="ident" id="4393863">pemEndOfLine</span><span class="op" id="4393875">)</span><span class="op" id="4393876">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4393880">p</span>&nbsp;<span class="op" id="4393882">=</span>&nbsp;<span class="op" id="4393884">&amp;</span><span class="ident" id="4393885">Block</span><span class="op" id="4393890">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4393894">Headers</span><span class="op" id="4393901">:</span>&nbsp;<span class="builtinfunc" id="4393903">make</span><span class="op" id="4393907">(</span><span class="keyword" id="4393908">map</span><span class="op" id="4393911">[</span><span class="builtintype" id="4393912">string</span><span class="op" id="4393918">]</span><span class="builtintype" id="4393919">string</span><span class="op" id="4393925">)</span><span class="op" id="4393926">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4393930">Type</span><span class="op" id="4393934">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4393939">string</span><span class="op" id="4393945">(</span><span class="ident" id="4393946">typeLine</span><span class="op" id="4393954">)</span><span class="op" id="4393955">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4393958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4393962">for</span>&nbsp;<span class="op" id="4393966">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4393970">//&nbsp;This&nbsp;loop&nbsp;terminates&nbsp;because&nbsp;getLine&#39;s&nbsp;second&nbsp;result&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4394031">//&nbsp;always&nbsp;smaller&nbsp;than&nbsp;its&nbsp;argument.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4394070">if</span>&nbsp;<span class="builtinfunc" id="4394073">len</span><span class="op" id="4394076">(</span><span class="ident" id="4394077">rest</span><span class="op" id="4394081">)</span>&nbsp;<span class="op" id="4394083">==</span>&nbsp;<span class="num" id="4394086">0</span>&nbsp;<span class="op" id="4394088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4394093">return</span>&nbsp;<span class="ident" id="4394100">nil</span><span class="op" id="4394103">,</span>&nbsp;<span class="ident" id="4394105">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4394112">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4394116">line</span><span class="op" id="4394120">,</span>&nbsp;<span class="ident" id="4394122">next</span>&nbsp;<span class="op" id="4394127">:=</span>&nbsp;<span class="ident" id="4394130">getLine</span><span class="op" id="4394137">(</span><span class="ident" id="4394138">rest</span><span class="op" id="4394142">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4394147">i</span>&nbsp;<span class="op" id="4394149">:=</span>&nbsp;<span class="ident" id="4394152">bytes</span><span class="op" id="4394157">.</span><span class="ident" id="4394158">Index</span><span class="op" id="4394163">(</span><span class="ident" id="4394164">line</span><span class="op" id="4394168">,</span>&nbsp;<span class="op" id="4394170">[</span><span class="op" id="4394171">]</span><span class="builtintype" id="4394172">byte</span><span class="op" id="4394176">{</span><span class="string" id="4394177">&#39;:&#39;</span><span class="op" id="4394180">}</span><span class="op" id="4394181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4394185">if</span>&nbsp;<span class="ident" id="4394188">i</span>&nbsp;<span class="op" id="4394190">==</span>&nbsp;<span class="op" id="4394193">-</span><span class="num" id="4394194">1</span>&nbsp;<span class="op" id="4394196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4394201">break</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4394209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4394214">//&nbsp;TODO(agl):&nbsp;need&nbsp;to&nbsp;cope&nbsp;with&nbsp;values&nbsp;that&nbsp;spread&nbsp;across&nbsp;lines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4394281">key</span><span class="op" id="4394284">,</span>&nbsp;<span class="ident" id="4394286">val</span>&nbsp;<span class="op" id="4394290">:=</span>&nbsp;<span class="ident" id="4394293">line</span><span class="op" id="4394297">[</span><span class="num" id="4394298">0</span><span class="op" id="4394299">:</span><span class="ident" id="4394300">i</span><span class="op" id="4394301">]</span><span class="op" id="4394302">,</span>&nbsp;<span class="ident" id="4394304">line</span><span class="op" id="4394308">[</span><span class="ident" id="4394309">i</span><span class="op" id="4394310">+</span><span class="num" id="4394311">1</span><span class="op" id="4394312">:</span><span class="op" id="4394313">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4394317">key</span>&nbsp;<span class="op" id="4394321">=</span>&nbsp;<span class="ident" id="4394323">bytes</span><span class="op" id="4394328">.</span><span class="ident" id="4394329">TrimSpace</span><span class="op" id="4394338">(</span><span class="ident" id="4394339">key</span><span class="op" id="4394342">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4394346">val</span>&nbsp;<span class="op" id="4394350">=</span>&nbsp;<span class="ident" id="4394352">bytes</span><span class="op" id="4394357">.</span><span class="ident" id="4394358">TrimSpace</span><span class="op" id="4394367">(</span><span class="ident" id="4394368">val</span><span class="op" id="4394371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4394375">p</span><span class="op" id="4394376">.</span><span class="ident" id="4394377">Headers</span><span class="op" id="4394384">[</span><span class="builtintype" id="4394385">string</span><span class="op" id="4394391">(</span><span class="ident" id="4394392">key</span><span class="op" id="4394395">)</span><span class="op" id="4394396">]</span>&nbsp;<span class="op" id="4394398">=</span>&nbsp;<span class="builtintype" id="4394400">string</span><span class="op" id="4394406">(</span><span class="ident" id="4394407">val</span><span class="op" id="4394410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4394414">rest</span>&nbsp;<span class="op" id="4394419">=</span>&nbsp;<span class="ident" id="4394421">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4394427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4394431">i</span>&nbsp;<span class="op" id="4394433">:=</span>&nbsp;<span class="ident" id="4394436">bytes</span><span class="op" id="4394441">.</span><span class="ident" id="4394442">Index</span><span class="op" id="4394447">(</span><span class="ident" id="4394448">rest</span><span class="op" id="4394452">,</span>&nbsp;<span class="ident" id="4394454">pemEnd</span><span class="op" id="4394460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4394463">if</span>&nbsp;<span class="ident" id="4394466">i</span>&nbsp;<span class="op" id="4394468">&lt;</span>&nbsp;<span class="num" id="4394470">0</span>&nbsp;<span class="op" id="4394472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4394476">return</span>&nbsp;<span class="ident" id="4394483">decodeError</span><span class="op" id="4394494">(</span><span class="ident" id="4394495">data</span><span class="op" id="4394499">,</span>&nbsp;<span class="ident" id="4394501">rest</span><span class="op" id="4394505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4394508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4394511">base64Data</span>&nbsp;<span class="op" id="4394522">:=</span>&nbsp;<span class="ident" id="4394525">removeWhitespace</span><span class="op" id="4394541">(</span><span class="ident" id="4394542">rest</span><span class="op" id="4394546">[</span><span class="num" id="4394547">0</span><span class="op" id="4394548">:</span><span class="ident" id="4394549">i</span><span class="op" id="4394550">]</span><span class="op" id="4394551">)</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4394555">p</span><span class="op" id="4394556">.</span><span class="ident" id="4394557">Bytes</span>&nbsp;<span class="op" id="4394563">=</span>&nbsp;<span class="builtinfunc" id="4394565">make</span><span class="op" id="4394569">(</span><span class="op" id="4394570">[</span><span class="op" id="4394571">]</span><span class="builtintype" id="4394572">byte</span><span class="op" id="4394576">,</span>&nbsp;<span class="ident" id="4394578">base64</span><span class="op" id="4394584">.</span><span class="ident" id="4394585">StdEncoding</span><span class="op" id="4394596">.</span><span class="ident" id="4394597">DecodedLen</span><span class="op" id="4394607">(</span><span class="builtinfunc" id="4394608">len</span><span class="op" id="4394611">(</span><span class="ident" id="4394612">base64Data</span><span class="op" id="4394622">)</span><span class="op" id="4394623">)</span><span class="op" id="4394624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4394627">n</span><span class="op" id="4394628">,</span>&nbsp;<span class="ident" id="4394630">err</span>&nbsp;<span class="op" id="4394634">:=</span>&nbsp;<span class="ident" id="4394637">base64</span><span class="op" id="4394643">.</span><span class="ident" id="4394644">StdEncoding</span><span class="op" id="4394655">.</span><span class="ident" id="4394656">Decode</span><span class="op" id="4394662">(</span><span class="ident" id="4394663">p</span><span class="op" id="4394664">.</span><span class="ident" id="4394665">Bytes</span><span class="op" id="4394670">,</span>&nbsp;<span class="ident" id="4394672">base64Data</span><span class="op" id="4394682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4394685">if</span>&nbsp;<span class="ident" id="4394688">err</span>&nbsp;<span class="op" id="4394692">!=</span>&nbsp;<span class="ident" id="4394695">nil</span>&nbsp;<span class="op" id="4394699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4394703">return</span>&nbsp;<span class="ident" id="4394710">decodeError</span><span class="op" id="4394721">(</span><span class="ident" id="4394722">data</span><span class="op" id="4394726">,</span>&nbsp;<span class="ident" id="4394728">rest</span><span class="op" id="4394732">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4394735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4394738">p</span><span class="op" id="4394739">.</span><span class="ident" id="4394740">Bytes</span>&nbsp;<span class="op" id="4394746">=</span>&nbsp;<span class="ident" id="4394748">p</span><span class="op" id="4394749">.</span><span class="ident" id="4394750">Bytes</span><span class="op" id="4394755">[</span><span class="num" id="4394756">0</span><span class="op" id="4394757">:</span><span class="ident" id="4394758">n</span><span class="op" id="4394759">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4394763">_</span><span class="op" id="4394764">,</span>&nbsp;<span class="ident" id="4394766">rest</span>&nbsp;<span class="op" id="4394771">=</span>&nbsp;<span class="ident" id="4394773">getLine</span><span class="op" id="4394780">(</span><span class="ident" id="4394781">rest</span><span class="op" id="4394785">[</span><span class="ident" id="4394786">i</span><span class="op" id="4394787">+</span><span class="builtinfunc" id="4394788">len</span><span class="op" id="4394791">(</span><span class="ident" id="4394792">pemEnd</span><span class="op" id="4394798">)</span><span class="op" id="4394799">:</span><span class="op" id="4394800">]</span><span class="op" id="4394801">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4394805">return</span><br>
<span class="lineno"></span><span class="op" id="4394812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4394815">func</span>&nbsp;<span class="ident" id="4394820">decodeError</span><span class="op" id="4394831">(</span><span class="ident" id="4394832">data</span><span class="op" id="4394836">,</span>&nbsp;<span class="ident" id="4394838">rest</span>&nbsp;<span class="op" id="4394843">[</span><span class="op" id="4394844">]</span><span class="builtintype" id="4394845">byte</span><span class="op" id="4394849">)</span>&nbsp;<span class="op" id="4394851">(</span><span class="op" id="4394852">*</span><span class="ident" id="4394853">Block</span><span class="op" id="4394858">,</span>&nbsp;<span class="op" id="4394860">[</span><span class="op" id="4394861">]</span><span class="builtintype" id="4394862">byte</span><span class="op" id="4394866">)</span>&nbsp;<span class="op" id="4394868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4394871">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here&nbsp;then&nbsp;we&nbsp;have&nbsp;rejected&nbsp;a&nbsp;likely&nbsp;looking,&nbsp;but</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4394934">//&nbsp;ultimately&nbsp;invalid&nbsp;PEM&nbsp;block.&nbsp;We&nbsp;need&nbsp;to&nbsp;start&nbsp;over&nbsp;from&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395001">//&nbsp;position.&nbsp;&nbsp;We&nbsp;have&nbsp;consumed&nbsp;the&nbsp;preamble&nbsp;line&nbsp;and&nbsp;will&nbsp;have&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395074">//&nbsp;any&nbsp;lines&nbsp;which&nbsp;could&nbsp;be&nbsp;header&nbsp;lines.&nbsp;However,&nbsp;a&nbsp;valid&nbsp;preamble</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395143">//&nbsp;line&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;header&nbsp;line,&nbsp;therefore&nbsp;we&nbsp;cannot&nbsp;have&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395214">//&nbsp;the&nbsp;preamble&nbsp;line&nbsp;for&nbsp;the&nbsp;any&nbsp;subsequent&nbsp;block.&nbsp;Thus,&nbsp;we&nbsp;will&nbsp;always</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395287">//&nbsp;find&nbsp;any&nbsp;valid&nbsp;block,&nbsp;no&nbsp;matter&nbsp;what&nbsp;bytes&nbsp;precede&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395346">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395350">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;the&nbsp;input&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395383">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395387">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;MALFORMED&nbsp;BLOCK-----</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395426">//&nbsp;&nbsp;&nbsp;&nbsp;junk&nbsp;that&nbsp;may&nbsp;look&nbsp;like&nbsp;header&nbsp;lines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395470">//&nbsp;&nbsp;&nbsp;or&nbsp;data&nbsp;lines,&nbsp;but&nbsp;no&nbsp;END&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395507">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395511">//&nbsp;&nbsp;&nbsp;&nbsp;-----BEGIN&nbsp;ACTUAL&nbsp;BLOCK-----</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395547">//&nbsp;&nbsp;&nbsp;&nbsp;realdata</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395563">//&nbsp;&nbsp;&nbsp;&nbsp;-----END&nbsp;ACTUAL&nbsp;BLOCK-----</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395597">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395601">//&nbsp;we&#39;ve&nbsp;failed&nbsp;to&nbsp;parse&nbsp;using&nbsp;the&nbsp;first&nbsp;BEGIN&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4395654">//&nbsp;and&nbsp;now&nbsp;will&nbsp;try&nbsp;again,&nbsp;using&nbsp;the&nbsp;second&nbsp;BEGIN&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4395711">p</span><span class="op" id="4395712">,</span>&nbsp;<span class="ident" id="4395714">rest</span>&nbsp;<span class="op" id="4395719">:=</span>&nbsp;<span class="ident" id="4395722">Decode</span><span class="op" id="4395728">(</span><span class="ident" id="4395729">rest</span><span class="op" id="4395733">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4395736">if</span>&nbsp;<span class="ident" id="4395739">p</span>&nbsp;<span class="op" id="4395741">==</span>&nbsp;<span class="ident" id="4395744">nil</span>&nbsp;<span class="op" id="4395748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4395752">rest</span>&nbsp;<span class="op" id="4395757">=</span>&nbsp;<span class="ident" id="4395759">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4395765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4395768">return</span>&nbsp;<span class="ident" id="4395775">p</span><span class="op" id="4395776">,</span>&nbsp;<span class="ident" id="4395778">rest</span><br>
<span class="lineno"></span><span class="op" id="4395783">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="4395786">const</span>&nbsp;<span class="ident" id="4395792">pemLineLength</span>&nbsp;<span class="op" id="4395806">=</span>&nbsp;<span class="num" id="4395808">64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4395812">type</span>&nbsp;<span class="ident" id="4395817">lineBreaker</span>&nbsp;<span class="keyword" id="4395829">struct</span>&nbsp;<span class="op" id="4395836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4395839">line</span>&nbsp;<span class="op" id="4395844">[</span><span class="ident" id="4395845">pemLineLength</span><span class="op" id="4395858">]</span><span class="builtintype" id="4395859">byte</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4395865">used</span>&nbsp;<span class="builtintype" id="4395870">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4395875">out</span>&nbsp;&nbsp;<span class="ident" id="4395880">io</span><span class="op" id="4395882">.</span><span class="ident" id="4395883">Writer</span><br>
<span class="lineno"></span><span class="op" id="4395890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4395893">func</span>&nbsp;<span class="op" id="4395898">(</span><span class="ident" id="4395899">l</span>&nbsp;<span class="op" id="4395901">*</span><span class="ident" id="4395902">lineBreaker</span><span class="op" id="4395913">)</span>&nbsp;<span class="ident" id="4395915">Write</span><span class="op" id="4395920">(</span><span class="ident" id="4395921">b</span>&nbsp;<span class="op" id="4395923">[</span><span class="op" id="4395924">]</span><span class="builtintype" id="4395925">byte</span><span class="op" id="4395929">)</span>&nbsp;<span class="op" id="4395931">(</span><span class="ident" id="4395932">n</span>&nbsp;<span class="builtintype" id="4395934">int</span><span class="op" id="4395937">,</span>&nbsp;<span class="ident" id="4395939">err</span>&nbsp;<span class="builtintype" id="4395943">error</span><span class="op" id="4395948">)</span>&nbsp;<span class="op" id="4395950">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4395953">if</span>&nbsp;<span class="ident" id="4395956">l</span><span class="op" id="4395957">.</span><span class="ident" id="4395958">used</span><span class="op" id="4395962">+</span><span class="builtinfunc" id="4395963">len</span><span class="op" id="4395966">(</span><span class="ident" id="4395967">b</span><span class="op" id="4395968">)</span>&nbsp;<span class="op" id="4395970">&lt;</span>&nbsp;<span class="ident" id="4395972">pemLineLength</span>&nbsp;<span class="op" id="4395986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4395990">copy</span><span class="op" id="4395994">(</span><span class="ident" id="4395995">l</span><span class="op" id="4395996">.</span><span class="ident" id="4395997">line</span><span class="op" id="4396001">[</span><span class="ident" id="4396002">l</span><span class="op" id="4396003">.</span><span class="ident" id="4396004">used</span><span class="op" id="4396008">:</span><span class="op" id="4396009">]</span><span class="op" id="4396010">,</span>&nbsp;<span class="ident" id="4396012">b</span><span class="op" id="4396013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4396017">l</span><span class="op" id="4396018">.</span><span class="ident" id="4396019">used</span>&nbsp;<span class="op" id="4396024">+=</span>&nbsp;<span class="builtinfunc" id="4396027">len</span><span class="op" id="4396030">(</span><span class="ident" id="4396031">b</span><span class="op" id="4396032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396036">return</span>&nbsp;<span class="builtinfunc" id="4396043">len</span><span class="op" id="4396046">(</span><span class="ident" id="4396047">b</span><span class="op" id="4396048">)</span><span class="op" id="4396049">,</span>&nbsp;<span class="ident" id="4396051">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4396056">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4396060">n</span><span class="op" id="4396061">,</span>&nbsp;<span class="ident" id="4396063">err</span>&nbsp;<span class="op" id="4396067">=</span>&nbsp;<span class="ident" id="4396069">l</span><span class="op" id="4396070">.</span><span class="ident" id="4396071">out</span><span class="op" id="4396074">.</span><span class="ident" id="4396075">Write</span><span class="op" id="4396080">(</span><span class="ident" id="4396081">l</span><span class="op" id="4396082">.</span><span class="ident" id="4396083">line</span><span class="op" id="4396087">[</span><span class="num" id="4396088">0</span><span class="op" id="4396089">:</span><span class="ident" id="4396090">l</span><span class="op" id="4396091">.</span><span class="ident" id="4396092">used</span><span class="op" id="4396096">]</span><span class="op" id="4396097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396100">if</span>&nbsp;<span class="ident" id="4396103">err</span>&nbsp;<span class="op" id="4396107">!=</span>&nbsp;<span class="ident" id="4396110">nil</span>&nbsp;<span class="op" id="4396114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396118">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4396126">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4396129">excess</span>&nbsp;<span class="op" id="4396136">:=</span>&nbsp;<span class="ident" id="4396139">pemLineLength</span>&nbsp;<span class="op" id="4396153">-</span>&nbsp;<span class="ident" id="4396155">l</span><span class="op" id="4396156">.</span><span class="ident" id="4396157">used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4396163">l</span><span class="op" id="4396164">.</span><span class="ident" id="4396165">used</span>&nbsp;<span class="op" id="4396170">=</span>&nbsp;<span class="num" id="4396172">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4396176">n</span><span class="op" id="4396177">,</span>&nbsp;<span class="ident" id="4396179">err</span>&nbsp;<span class="op" id="4396183">=</span>&nbsp;<span class="ident" id="4396185">l</span><span class="op" id="4396186">.</span><span class="ident" id="4396187">out</span><span class="op" id="4396190">.</span><span class="ident" id="4396191">Write</span><span class="op" id="4396196">(</span><span class="ident" id="4396197">b</span><span class="op" id="4396198">[</span><span class="num" id="4396199">0</span><span class="op" id="4396200">:</span><span class="ident" id="4396201">excess</span><span class="op" id="4396207">]</span><span class="op" id="4396208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396211">if</span>&nbsp;<span class="ident" id="4396214">err</span>&nbsp;<span class="op" id="4396218">!=</span>&nbsp;<span class="ident" id="4396221">nil</span>&nbsp;<span class="op" id="4396225">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396229">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4396237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4396241">n</span><span class="op" id="4396242">,</span>&nbsp;<span class="ident" id="4396244">err</span>&nbsp;<span class="op" id="4396248">=</span>&nbsp;<span class="ident" id="4396250">l</span><span class="op" id="4396251">.</span><span class="ident" id="4396252">out</span><span class="op" id="4396255">.</span><span class="ident" id="4396256">Write</span><span class="op" id="4396261">(</span><span class="op" id="4396262">[</span><span class="op" id="4396263">]</span><span class="builtintype" id="4396264">byte</span><span class="op" id="4396268">{</span><span class="string" id="4396269">&#39;\n&#39;</span><span class="op" id="4396273">}</span><span class="op" id="4396274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396277">if</span>&nbsp;<span class="ident" id="4396280">err</span>&nbsp;<span class="op" id="4396284">!=</span>&nbsp;<span class="ident" id="4396287">nil</span>&nbsp;<span class="op" id="4396291">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396295">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4396303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396307">return</span>&nbsp;<span class="ident" id="4396314">l</span><span class="op" id="4396315">.</span><span class="ident" id="4396316">Write</span><span class="op" id="4396321">(</span><span class="ident" id="4396322">b</span><span class="op" id="4396323">[</span><span class="ident" id="4396324">excess</span><span class="op" id="4396330">:</span><span class="op" id="4396331">]</span><span class="op" id="4396332">)</span><br>
<span class="lineno"></span><span class="op" id="4396334">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="4396337">func</span>&nbsp;<span class="op" id="4396342">(</span><span class="ident" id="4396343">l</span>&nbsp;<span class="op" id="4396345">*</span><span class="ident" id="4396346">lineBreaker</span><span class="op" id="4396357">)</span>&nbsp;<span class="ident" id="4396359">Close</span><span class="op" id="4396364">(</span><span class="op" id="4396365">)</span>&nbsp;<span class="op" id="4396367">(</span><span class="ident" id="4396368">err</span>&nbsp;<span class="builtintype" id="4396372">error</span><span class="op" id="4396377">)</span>&nbsp;<span class="op" id="4396379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396382">if</span>&nbsp;<span class="ident" id="4396385">l</span><span class="op" id="4396386">.</span><span class="ident" id="4396387">used</span>&nbsp;<span class="op" id="4396392">&gt;</span>&nbsp;<span class="num" id="4396394">0</span>&nbsp;<span class="op" id="4396396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4396400">_</span><span class="op" id="4396401">,</span>&nbsp;<span class="ident" id="4396403">err</span>&nbsp;<span class="op" id="4396407">=</span>&nbsp;<span class="ident" id="4396409">l</span><span class="op" id="4396410">.</span><span class="ident" id="4396411">out</span><span class="op" id="4396414">.</span><span class="ident" id="4396415">Write</span><span class="op" id="4396420">(</span><span class="ident" id="4396421">l</span><span class="op" id="4396422">.</span><span class="ident" id="4396423">line</span><span class="op" id="4396427">[</span><span class="num" id="4396428">0</span><span class="op" id="4396429">:</span><span class="ident" id="4396430">l</span><span class="op" id="4396431">.</span><span class="ident" id="4396432">used</span><span class="op" id="4396436">]</span><span class="op" id="4396437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396441">if</span>&nbsp;<span class="ident" id="4396444">err</span>&nbsp;<span class="op" id="4396448">!=</span>&nbsp;<span class="ident" id="4396451">nil</span>&nbsp;<span class="op" id="4396455">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396460">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4396469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4396473">_</span><span class="op" id="4396474">,</span>&nbsp;<span class="ident" id="4396476">err</span>&nbsp;<span class="op" id="4396480">=</span>&nbsp;<span class="ident" id="4396482">l</span><span class="op" id="4396483">.</span><span class="ident" id="4396484">out</span><span class="op" id="4396487">.</span><span class="ident" id="4396488">Write</span><span class="op" id="4396493">(</span><span class="op" id="4396494">[</span><span class="op" id="4396495">]</span><span class="builtintype" id="4396496">byte</span><span class="op" id="4396500">{</span><span class="string" id="4396501">&#39;\n&#39;</span><span class="op" id="4396505">}</span><span class="op" id="4396506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4396509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396513">return</span><br>
<span class="lineno"></span><span class="op" id="4396520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4396523">func</span>&nbsp;<span class="ident" id="4396528">writeHeader</span><span class="op" id="4396539">(</span><span class="ident" id="4396540">out</span>&nbsp;<span class="ident" id="4396544">io</span><span class="op" id="4396546">.</span><span class="ident" id="4396547">Writer</span><span class="op" id="4396553">,</span>&nbsp;<span class="ident" id="4396555">k</span><span class="op" id="4396556">,</span>&nbsp;<span class="ident" id="4396558">v</span>&nbsp;<span class="builtintype" id="4396560">string</span><span class="op" id="4396566">)</span>&nbsp;<span class="builtintype" id="4396568">error</span>&nbsp;<span class="op" id="4396574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4396577">_</span><span class="op" id="4396578">,</span>&nbsp;<span class="ident" id="4396580">err</span>&nbsp;<span class="op" id="4396584">:=</span>&nbsp;<span class="ident" id="4396587">out</span><span class="op" id="4396590">.</span><span class="ident" id="4396591">Write</span><span class="op" id="4396596">(</span><span class="op" id="4396597">[</span><span class="op" id="4396598">]</span><span class="builtintype" id="4396599">byte</span><span class="op" id="4396603">(</span><span class="ident" id="4396604">k</span>&nbsp;<span class="op" id="4396606">+</span>&nbsp;<span class="string" id="4396608">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="4396613">+</span>&nbsp;<span class="ident" id="4396615">v</span>&nbsp;<span class="op" id="4396617">+</span>&nbsp;<span class="string" id="4396619">&#34;\n&#34;</span><span class="op" id="4396623">)</span><span class="op" id="4396624">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396627">return</span>&nbsp;<span class="ident" id="4396634">err</span><br>
<span class="lineno"></span><span class="op" id="4396638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4396641">func</span>&nbsp;<span class="ident" id="4396646">Encode</span><span class="op" id="4396652">(</span><span class="ident" id="4396653">out</span>&nbsp;<span class="ident" id="4396657">io</span><span class="op" id="4396659">.</span><span class="ident" id="4396660">Writer</span><span class="op" id="4396666">,</span>&nbsp;<span class="ident" id="4396668">b</span>&nbsp;<span class="op" id="4396670">*</span><span class="ident" id="4396671">Block</span><span class="op" id="4396676">)</span>&nbsp;<span class="builtintype" id="4396678">error</span>&nbsp;<span class="op" id="4396684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396687">if</span>&nbsp;<span class="ident" id="4396690">_</span><span class="op" id="4396691">,</span>&nbsp;<span class="ident" id="4396693">err</span>&nbsp;<span class="op" id="4396697">:=</span>&nbsp;<span class="ident" id="4396700">out</span><span class="op" id="4396703">.</span><span class="ident" id="4396704">Write</span><span class="op" id="4396709">(</span><span class="ident" id="4396710">pemStart</span><span class="op" id="4396718">[</span><span class="num" id="4396719">1</span><span class="op" id="4396720">:</span><span class="op" id="4396721">]</span><span class="op" id="4396722">)</span><span class="op" id="4396723">;</span>&nbsp;<span class="ident" id="4396725">err</span>&nbsp;<span class="op" id="4396729">!=</span>&nbsp;<span class="ident" id="4396732">nil</span>&nbsp;<span class="op" id="4396736">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396740">return</span>&nbsp;<span class="ident" id="4396747">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4396752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396755">if</span>&nbsp;<span class="ident" id="4396758">_</span><span class="op" id="4396759">,</span>&nbsp;<span class="ident" id="4396761">err</span>&nbsp;<span class="op" id="4396765">:=</span>&nbsp;<span class="ident" id="4396768">out</span><span class="op" id="4396771">.</span><span class="ident" id="4396772">Write</span><span class="op" id="4396777">(</span><span class="op" id="4396778">[</span><span class="op" id="4396779">]</span><span class="builtintype" id="4396780">byte</span><span class="op" id="4396784">(</span><span class="ident" id="4396785">b</span><span class="op" id="4396786">.</span><span class="ident" id="4396787">Type</span>&nbsp;<span class="op" id="4396792">+</span>&nbsp;<span class="string" id="4396794">&#34;-----\n&#34;</span><span class="op" id="4396803">)</span><span class="op" id="4396804">)</span><span class="op" id="4396805">;</span>&nbsp;<span class="ident" id="4396807">err</span>&nbsp;<span class="op" id="4396811">!=</span>&nbsp;<span class="ident" id="4396814">nil</span>&nbsp;<span class="op" id="4396818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396822">return</span>&nbsp;<span class="ident" id="4396829">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4396834">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396838">if</span>&nbsp;<span class="builtinfunc" id="4396841">len</span><span class="op" id="4396844">(</span><span class="ident" id="4396845">b</span><span class="op" id="4396846">.</span><span class="ident" id="4396847">Headers</span><span class="op" id="4396854">)</span>&nbsp;<span class="op" id="4396856">&gt;</span>&nbsp;<span class="num" id="4396858">0</span>&nbsp;<span class="op" id="4396860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396864">const</span>&nbsp;<span class="ident" id="4396870">procType</span>&nbsp;<span class="op" id="4396879">=</span>&nbsp;<span class="string" id="4396881">&#34;Proc-Type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4396895">h</span>&nbsp;<span class="op" id="4396897">:=</span>&nbsp;<span class="builtinfunc" id="4396900">make</span><span class="op" id="4396904">(</span><span class="op" id="4396905">[</span><span class="op" id="4396906">]</span><span class="builtintype" id="4396907">string</span><span class="op" id="4396913">,</span>&nbsp;<span class="num" id="4396915">0</span><span class="op" id="4396916">,</span>&nbsp;<span class="builtinfunc" id="4396918">len</span><span class="op" id="4396921">(</span><span class="ident" id="4396922">b</span><span class="op" id="4396923">.</span><span class="ident" id="4396924">Headers</span><span class="op" id="4396931">)</span><span class="op" id="4396932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4396936">hasProcType</span>&nbsp;<span class="op" id="4396948">:=</span>&nbsp;<span class="builtintype" id="4396951">false</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396959">for</span>&nbsp;<span class="ident" id="4396963">k</span>&nbsp;<span class="op" id="4396965">:=</span>&nbsp;<span class="keyword" id="4396968">range</span>&nbsp;<span class="ident" id="4396974">b</span><span class="op" id="4396975">.</span><span class="ident" id="4396976">Headers</span>&nbsp;<span class="op" id="4396984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4396989">if</span>&nbsp;<span class="ident" id="4396992">k</span>&nbsp;<span class="op" id="4396994">==</span>&nbsp;<span class="ident" id="4396997">procType</span>&nbsp;<span class="op" id="4397006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4397012">hasProcType</span>&nbsp;<span class="op" id="4397024">=</span>&nbsp;<span class="builtintype" id="4397026">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397035">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4397047">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4397052">h</span>&nbsp;<span class="op" id="4397054">=</span>&nbsp;<span class="builtinfunc" id="4397056">append</span><span class="op" id="4397062">(</span><span class="ident" id="4397063">h</span><span class="op" id="4397064">,</span>&nbsp;<span class="ident" id="4397066">k</span><span class="op" id="4397067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4397071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4397075">//&nbsp;The&nbsp;Proc-Type&nbsp;header&nbsp;must&nbsp;be&nbsp;written&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4397124">//&nbsp;See&nbsp;RFC&nbsp;1421,&nbsp;section&nbsp;4.6.1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397159">if</span>&nbsp;<span class="ident" id="4397162">hasProcType</span>&nbsp;<span class="op" id="4397174">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397179">if</span>&nbsp;<span class="ident" id="4397182">err</span>&nbsp;<span class="op" id="4397186">:=</span>&nbsp;<span class="ident" id="4397189">writeHeader</span><span class="op" id="4397200">(</span><span class="ident" id="4397201">out</span><span class="op" id="4397204">,</span>&nbsp;<span class="ident" id="4397206">procType</span><span class="op" id="4397214">,</span>&nbsp;<span class="ident" id="4397216">b</span><span class="op" id="4397217">.</span><span class="ident" id="4397218">Headers</span><span class="op" id="4397225">[</span><span class="ident" id="4397226">procType</span><span class="op" id="4397234">]</span><span class="op" id="4397235">)</span><span class="op" id="4397236">;</span>&nbsp;<span class="ident" id="4397238">err</span>&nbsp;<span class="op" id="4397242">!=</span>&nbsp;<span class="ident" id="4397245">nil</span>&nbsp;<span class="op" id="4397249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397255">return</span>&nbsp;<span class="ident" id="4397262">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4397269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4397273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4397277">//&nbsp;For&nbsp;consistency&nbsp;of&nbsp;output,&nbsp;write&nbsp;other&nbsp;headers&nbsp;sorted&nbsp;by&nbsp;key.</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4397344">sort</span><span class="op" id="4397348">.</span><span class="ident" id="4397349">Strings</span><span class="op" id="4397356">(</span><span class="ident" id="4397357">h</span><span class="op" id="4397358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397362">for</span>&nbsp;<span class="ident" id="4397366">_</span><span class="op" id="4397367">,</span>&nbsp;<span class="ident" id="4397369">k</span>&nbsp;<span class="op" id="4397371">:=</span>&nbsp;<span class="keyword" id="4397374">range</span>&nbsp;<span class="ident" id="4397380">h</span>&nbsp;<span class="op" id="4397382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397387">if</span>&nbsp;<span class="ident" id="4397390">err</span>&nbsp;<span class="op" id="4397394">:=</span>&nbsp;<span class="ident" id="4397397">writeHeader</span><span class="op" id="4397408">(</span><span class="ident" id="4397409">out</span><span class="op" id="4397412">,</span>&nbsp;<span class="ident" id="4397414">k</span><span class="op" id="4397415">,</span>&nbsp;<span class="ident" id="4397417">b</span><span class="op" id="4397418">.</span><span class="ident" id="4397419">Headers</span><span class="op" id="4397426">[</span><span class="ident" id="4397427">k</span><span class="op" id="4397428">]</span><span class="op" id="4397429">)</span><span class="op" id="4397430">;</span>&nbsp;<span class="ident" id="4397432">err</span>&nbsp;<span class="op" id="4397436">!=</span>&nbsp;<span class="ident" id="4397439">nil</span>&nbsp;<span class="op" id="4397443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397449">return</span>&nbsp;<span class="ident" id="4397456">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4397463">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4397467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397471">if</span>&nbsp;<span class="ident" id="4397474">_</span><span class="op" id="4397475">,</span>&nbsp;<span class="ident" id="4397477">err</span>&nbsp;<span class="op" id="4397481">:=</span>&nbsp;<span class="ident" id="4397484">out</span><span class="op" id="4397487">.</span><span class="ident" id="4397488">Write</span><span class="op" id="4397493">(</span><span class="op" id="4397494">[</span><span class="op" id="4397495">]</span><span class="builtintype" id="4397496">byte</span><span class="op" id="4397500">{</span><span class="string" id="4397501">&#39;\n&#39;</span><span class="op" id="4397505">}</span><span class="op" id="4397506">)</span><span class="op" id="4397507">;</span>&nbsp;<span class="ident" id="4397509">err</span>&nbsp;<span class="op" id="4397513">!=</span>&nbsp;<span class="ident" id="4397516">nil</span>&nbsp;<span class="op" id="4397520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397525">return</span>&nbsp;<span class="ident" id="4397532">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4397538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4397541">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397545">var</span>&nbsp;<span class="ident" id="4397549">breaker</span>&nbsp;<span class="ident" id="4397557">lineBreaker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4397570">breaker</span><span class="op" id="4397577">.</span><span class="ident" id="4397578">out</span>&nbsp;<span class="op" id="4397582">=</span>&nbsp;<span class="ident" id="4397584">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4397590">b64</span>&nbsp;<span class="op" id="4397594">:=</span>&nbsp;<span class="ident" id="4397597">base64</span><span class="op" id="4397603">.</span><span class="ident" id="4397604">NewEncoder</span><span class="op" id="4397614">(</span><span class="ident" id="4397615">base64</span><span class="op" id="4397621">.</span><span class="ident" id="4397622">StdEncoding</span><span class="op" id="4397633">,</span>&nbsp;<span class="op" id="4397635">&amp;</span><span class="ident" id="4397636">breaker</span><span class="op" id="4397643">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397646">if</span>&nbsp;<span class="ident" id="4397649">_</span><span class="op" id="4397650">,</span>&nbsp;<span class="ident" id="4397652">err</span>&nbsp;<span class="op" id="4397656">:=</span>&nbsp;<span class="ident" id="4397659">b64</span><span class="op" id="4397662">.</span><span class="ident" id="4397663">Write</span><span class="op" id="4397668">(</span><span class="ident" id="4397669">b</span><span class="op" id="4397670">.</span><span class="ident" id="4397671">Bytes</span><span class="op" id="4397676">)</span><span class="op" id="4397677">;</span>&nbsp;<span class="ident" id="4397679">err</span>&nbsp;<span class="op" id="4397683">!=</span>&nbsp;<span class="ident" id="4397686">nil</span>&nbsp;<span class="op" id="4397690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397694">return</span>&nbsp;<span class="ident" id="4397701">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4397706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4397709">b64</span><span class="op" id="4397712">.</span><span class="ident" id="4397713">Close</span><span class="op" id="4397718">(</span><span class="op" id="4397719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4397722">breaker</span><span class="op" id="4397729">.</span><span class="ident" id="4397730">Close</span><span class="op" id="4397735">(</span><span class="op" id="4397736">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397740">if</span>&nbsp;<span class="ident" id="4397743">_</span><span class="op" id="4397744">,</span>&nbsp;<span class="ident" id="4397746">err</span>&nbsp;<span class="op" id="4397750">:=</span>&nbsp;<span class="ident" id="4397753">out</span><span class="op" id="4397756">.</span><span class="ident" id="4397757">Write</span><span class="op" id="4397762">(</span><span class="ident" id="4397763">pemEnd</span><span class="op" id="4397769">[</span><span class="num" id="4397770">1</span><span class="op" id="4397771">:</span><span class="op" id="4397772">]</span><span class="op" id="4397773">)</span><span class="op" id="4397774">;</span>&nbsp;<span class="ident" id="4397776">err</span>&nbsp;<span class="op" id="4397780">!=</span>&nbsp;<span class="ident" id="4397783">nil</span>&nbsp;<span class="op" id="4397787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397791">return</span>&nbsp;<span class="ident" id="4397798">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4397803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4397806">_</span><span class="op" id="4397807">,</span>&nbsp;<span class="ident" id="4397809">err</span>&nbsp;<span class="op" id="4397813">:=</span>&nbsp;<span class="ident" id="4397816">out</span><span class="op" id="4397819">.</span><span class="ident" id="4397820">Write</span><span class="op" id="4397825">(</span><span class="op" id="4397826">[</span><span class="op" id="4397827">]</span><span class="builtintype" id="4397828">byte</span><span class="op" id="4397832">(</span><span class="ident" id="4397833">b</span><span class="op" id="4397834">.</span><span class="ident" id="4397835">Type</span>&nbsp;<span class="op" id="4397840">+</span>&nbsp;<span class="string" id="4397842">&#34;-----\n&#34;</span><span class="op" id="4397851">)</span><span class="op" id="4397852">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397855">return</span>&nbsp;<span class="ident" id="4397862">err</span><br>
<span class="lineno"></span><span class="op" id="4397866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4397869">func</span>&nbsp;<span class="ident" id="4397874">EncodeToMemory</span><span class="op" id="4397888">(</span><span class="ident" id="4397889">b</span>&nbsp;<span class="op" id="4397891">*</span><span class="ident" id="4397892">Block</span><span class="op" id="4397897">)</span>&nbsp;<span class="op" id="4397899">[</span><span class="op" id="4397900">]</span><span class="builtintype" id="4397901">byte</span>&nbsp;<span class="op" id="4397906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397909">var</span>&nbsp;<span class="ident" id="4397913">buf</span>&nbsp;<span class="ident" id="4397917">bytes</span><span class="op" id="4397922">.</span><span class="ident" id="4397923">Buffer</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4397931">Encode</span><span class="op" id="4397937">(</span><span class="op" id="4397938">&amp;</span><span class="ident" id="4397939">buf</span><span class="op" id="4397942">,</span>&nbsp;<span class="ident" id="4397944">b</span><span class="op" id="4397945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4397948">return</span>&nbsp;<span class="ident" id="4397955">buf</span><span class="op" id="4397958">.</span><span class="ident" id="4397959">Bytes</span><span class="op" id="4397964">(</span><span class="op" id="4397965">)</span><br>
<span class="lineno"></span><span class="op" id="4397967">}</span>
</div>
</body>
</html>
