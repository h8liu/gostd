<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/bzip2</h2>
<ul>
<li><a href="/gostd/compress/bzip2/bit_reader.go.html">bit_reader.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2.go.html" class="current">bzip2.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2_test.go.html">bzip2_test.go</a></li>
<li><a href="/gostd/compress/bzip2/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/compress/bzip2/move_to_front.go.html">move_to_front.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5967111">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5967166">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5967220">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5967271">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword" id="5967320">package</span>&nbsp;<span class="ident" id="5967328">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5967335">import</span>&nbsp;<span class="string" id="5967342">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="5967348">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment" id="5967427">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment" id="5967478">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment" id="5967534">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="5967582">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5967650">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword" id="5967676">type</span>&nbsp;<span class="ident" id="5967681">StructuralError</span>&nbsp;<span class="builtintype" id="5967697">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5967705">func</span>&nbsp;<span class="op" id="5967710">(</span><span class="ident" id="5967711">s</span>&nbsp;<span class="ident" id="5967713">StructuralError</span><span class="op" id="5967728">)</span>&nbsp;<span class="ident" id="5967730">Error</span><span class="op" id="5967735">(</span><span class="op" id="5967736">)</span>&nbsp;<span class="builtintype" id="5967738">string</span>&nbsp;<span class="op" id="5967745">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5967748">return</span>&nbsp;<span class="string" id="5967755">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op" id="5967778">+</span>&nbsp;<span class="builtintype" id="5967780">string</span><span class="op" id="5967786">(</span><span class="ident" id="5967787">s</span><span class="op" id="5967788">)</span><br>
<span class="lineno"></span><span class="op" id="5967790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5967793">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5967841">type</span>&nbsp;<span class="ident" id="5967846">reader</span>&nbsp;<span class="keyword" id="5967853">struct</span>&nbsp;<span class="op" id="5967860">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967863">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967876">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967887">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5967900">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967908">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5967921">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967929">wantBlockCRC</span>&nbsp;<span class="builtintype" id="5967942">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5967950">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5967963">bool</span>&nbsp;<span class="comment" id="5967968">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968013">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5968026">int</span>&nbsp;&nbsp;<span class="comment" id="5968031">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968072">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5968085">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968091">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5968104">[</span><span class="op" id="5968105">]</span><span class="builtintype" id="5968106">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5968114">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968159">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5968172">[</span><span class="num" id="5968173">256</span><span class="op" id="5968176">]</span><span class="builtintype" id="5968177">uint</span>&nbsp;<span class="comment" id="5968182">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968221">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5968234">[</span><span class="op" id="5968235">]</span><span class="builtintype" id="5968236">uint32</span>&nbsp;&nbsp;<span class="comment" id="5968244">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968338">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5968351">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5968361">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968403">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5968415">[</span><span class="op" id="5968416">]</span><span class="builtintype" id="5968417">uint32</span>&nbsp;<span class="comment" id="5968424">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968473">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype" id="5968485">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5968494">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968532">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5968544">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5968553">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968583">byteRepeats</span>&nbsp;<span class="builtintype" id="5968595">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5968604">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968648">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5968660">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5968669">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op" id="5968716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5968719">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment" id="5968791">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="5968838">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5968900">func</span>&nbsp;<span class="ident" id="5968905">NewReader</span><span class="op" id="5968914">(</span><span class="ident" id="5968915">r</span>&nbsp;<span class="ident" id="5968917">io</span><span class="op" id="5968919">.</span><span class="ident" id="5968920">Reader</span><span class="op" id="5968926">)</span>&nbsp;<span class="ident" id="5968928">io</span><span class="op" id="5968930">.</span><span class="ident" id="5968931">Reader</span>&nbsp;<span class="op" id="5968938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968941">bz2</span>&nbsp;<span class="op" id="5968945">:=</span>&nbsp;<span class="builtinfunc" id="5968948">new</span><span class="op" id="5968951">(</span><span class="ident" id="5968952">reader</span><span class="op" id="5968958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5968961">bz2</span><span class="op" id="5968964">.</span><span class="ident" id="5968965">br</span>&nbsp;<span class="op" id="5968968">=</span>&nbsp;<span class="ident" id="5968970">newBitReader</span><span class="op" id="5968982">(</span><span class="ident" id="5968983">r</span><span class="op" id="5968984">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5968987">return</span>&nbsp;<span class="ident" id="5968994">bz2</span><br>
<span class="lineno"></span><span class="op" id="5968998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5969001">const</span>&nbsp;<span class="ident" id="5969007">bzip2FileMagic</span>&nbsp;<span class="op" id="5969022">=</span>&nbsp;<span class="num" id="5969024">0x425a</span>&nbsp;<span class="comment" id="5969031">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="5969039">const</span>&nbsp;<span class="ident" id="5969045">bzip2BlockMagic</span>&nbsp;<span class="op" id="5969061">=</span>&nbsp;<span class="num" id="5969063">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword" id="5969078">const</span>&nbsp;<span class="ident" id="5969084">bzip2FinalMagic</span>&nbsp;<span class="op" id="5969100">=</span>&nbsp;<span class="num" id="5969102">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5969118">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5969152">func</span>&nbsp;<span class="op" id="5969157">(</span><span class="ident" id="5969158">bz2</span>&nbsp;<span class="op" id="5969162">*</span><span class="ident" id="5969163">reader</span><span class="op" id="5969169">)</span>&nbsp;<span class="ident" id="5969171">setup</span><span class="op" id="5969176">(</span><span class="ident" id="5969177">needMagic</span>&nbsp;<span class="builtintype" id="5969187">bool</span><span class="op" id="5969191">)</span>&nbsp;<span class="builtintype" id="5969193">error</span>&nbsp;<span class="op" id="5969199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969202">br</span>&nbsp;<span class="op" id="5969205">:=</span>&nbsp;<span class="op" id="5969208">&amp;</span><span class="ident" id="5969209">bz2</span><span class="op" id="5969212">.</span><span class="ident" id="5969213">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969218">if</span>&nbsp;<span class="ident" id="5969221">needMagic</span>&nbsp;<span class="op" id="5969231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969235">magic</span>&nbsp;<span class="op" id="5969241">:=</span>&nbsp;<span class="ident" id="5969244">br</span><span class="op" id="5969246">.</span><span class="ident" id="5969247">ReadBits</span><span class="op" id="5969255">(</span><span class="num" id="5969256">16</span><span class="op" id="5969258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969262">if</span>&nbsp;<span class="ident" id="5969265">magic</span>&nbsp;<span class="op" id="5969271">!=</span>&nbsp;<span class="ident" id="5969274">bzip2FileMagic</span>&nbsp;<span class="op" id="5969289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969294">return</span>&nbsp;<span class="ident" id="5969301">StructuralError</span><span class="op" id="5969316">(</span><span class="string" id="5969317">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op" id="5969334">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969345">t</span>&nbsp;<span class="op" id="5969347">:=</span>&nbsp;<span class="ident" id="5969350">br</span><span class="op" id="5969352">.</span><span class="ident" id="5969353">ReadBits</span><span class="op" id="5969361">(</span><span class="num" id="5969362">8</span><span class="op" id="5969363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969366">if</span>&nbsp;<span class="ident" id="5969369">t</span>&nbsp;<span class="op" id="5969371">!=</span>&nbsp;<span class="string" id="5969374">&#39;h&#39;</span>&nbsp;<span class="op" id="5969378">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969382">return</span>&nbsp;<span class="ident" id="5969389">StructuralError</span><span class="op" id="5969404">(</span><span class="string" id="5969405">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op" id="5969435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969442">level</span>&nbsp;<span class="op" id="5969448">:=</span>&nbsp;<span class="ident" id="5969451">br</span><span class="op" id="5969453">.</span><span class="ident" id="5969454">ReadBits</span><span class="op" id="5969462">(</span><span class="num" id="5969463">8</span><span class="op" id="5969464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969467">if</span>&nbsp;<span class="ident" id="5969470">level</span>&nbsp;<span class="op" id="5969476">&lt;</span>&nbsp;<span class="string" id="5969478">&#39;1&#39;</span>&nbsp;<span class="op" id="5969482">||</span>&nbsp;<span class="ident" id="5969485">level</span>&nbsp;<span class="op" id="5969491">&gt;</span>&nbsp;<span class="string" id="5969493">&#39;9&#39;</span>&nbsp;<span class="op" id="5969497">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969501">return</span>&nbsp;<span class="ident" id="5969508">StructuralError</span><span class="op" id="5969523">(</span><span class="string" id="5969524">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op" id="5969551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969558">bz2</span><span class="op" id="5969561">.</span><span class="ident" id="5969562">fileCRC</span>&nbsp;<span class="op" id="5969570">=</span>&nbsp;<span class="num" id="5969572">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969575">bz2</span><span class="op" id="5969578">.</span><span class="ident" id="5969579">blockSize</span>&nbsp;<span class="op" id="5969589">=</span>&nbsp;<span class="num" id="5969591">100</span>&nbsp;<span class="op" id="5969595">*</span>&nbsp;<span class="num" id="5969597">1024</span>&nbsp;<span class="op" id="5969602">*</span>&nbsp;<span class="op" id="5969604">(</span><span class="builtintype" id="5969605">int</span><span class="op" id="5969608">(</span><span class="ident" id="5969609">level</span><span class="op" id="5969614">)</span>&nbsp;<span class="op" id="5969616">-</span>&nbsp;<span class="string" id="5969618">&#39;0&#39;</span><span class="op" id="5969621">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969624">if</span>&nbsp;<span class="ident" id="5969627">bz2</span><span class="op" id="5969630">.</span><span class="ident" id="5969631">blockSize</span>&nbsp;<span class="op" id="5969641">&gt;</span>&nbsp;<span class="builtinfunc" id="5969643">len</span><span class="op" id="5969646">(</span><span class="ident" id="5969647">bz2</span><span class="op" id="5969650">.</span><span class="ident" id="5969651">tt</span><span class="op" id="5969653">)</span>&nbsp;<span class="op" id="5969655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969659">bz2</span><span class="op" id="5969662">.</span><span class="ident" id="5969663">tt</span>&nbsp;<span class="op" id="5969666">=</span>&nbsp;<span class="builtinfunc" id="5969668">make</span><span class="op" id="5969672">(</span><span class="op" id="5969673">[</span><span class="op" id="5969674">]</span><span class="builtintype" id="5969675">uint32</span><span class="op" id="5969681">,</span>&nbsp;<span class="ident" id="5969683">bz2</span><span class="op" id="5969686">.</span><span class="ident" id="5969687">blockSize</span><span class="op" id="5969696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969702">return</span>&nbsp;<span class="builtintype" id="5969709">nil</span><br>
<span class="lineno"></span><span class="op" id="5969713">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="5969716">func</span>&nbsp;<span class="op" id="5969721">(</span><span class="ident" id="5969722">bz2</span>&nbsp;<span class="op" id="5969726">*</span><span class="ident" id="5969727">reader</span><span class="op" id="5969733">)</span>&nbsp;<span class="ident" id="5969735">Read</span><span class="op" id="5969739">(</span><span class="ident" id="5969740">buf</span>&nbsp;<span class="op" id="5969744">[</span><span class="op" id="5969745">]</span><span class="builtintype" id="5969746">byte</span><span class="op" id="5969750">)</span>&nbsp;<span class="op" id="5969752">(</span><span class="ident" id="5969753">n</span>&nbsp;<span class="builtintype" id="5969755">int</span><span class="op" id="5969758">,</span>&nbsp;<span class="ident" id="5969760">err</span>&nbsp;<span class="builtintype" id="5969764">error</span><span class="op" id="5969769">)</span>&nbsp;<span class="op" id="5969771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969774">if</span>&nbsp;<span class="ident" id="5969777">bz2</span><span class="op" id="5969780">.</span><span class="ident" id="5969781">eof</span>&nbsp;<span class="op" id="5969785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969789">return</span>&nbsp;<span class="num" id="5969796">0</span><span class="op" id="5969797">,</span>&nbsp;<span class="ident" id="5969799">io</span><span class="op" id="5969801">.</span><span class="ident" id="5969802">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969807">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969811">if</span>&nbsp;<span class="op" id="5969814">!</span><span class="ident" id="5969815">bz2</span><span class="op" id="5969818">.</span><span class="ident" id="5969819">setupDone</span>&nbsp;<span class="op" id="5969829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969833">err</span>&nbsp;<span class="op" id="5969837">=</span>&nbsp;<span class="ident" id="5969839">bz2</span><span class="op" id="5969842">.</span><span class="ident" id="5969843">setup</span><span class="op" id="5969848">(</span><span class="builtintype" id="5969849">true</span><span class="op" id="5969853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969857">brErr</span>&nbsp;<span class="op" id="5969863">:=</span>&nbsp;<span class="ident" id="5969866">bz2</span><span class="op" id="5969869">.</span><span class="ident" id="5969870">br</span><span class="op" id="5969872">.</span><span class="ident" id="5969873">Err</span><span class="op" id="5969876">(</span><span class="op" id="5969877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969881">if</span>&nbsp;<span class="ident" id="5969884">brErr</span>&nbsp;<span class="op" id="5969890">!=</span>&nbsp;<span class="builtintype" id="5969893">nil</span>&nbsp;<span class="op" id="5969897">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969902">err</span>&nbsp;<span class="op" id="5969906">=</span>&nbsp;<span class="ident" id="5969908">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969920">if</span>&nbsp;<span class="ident" id="5969923">err</span>&nbsp;<span class="op" id="5969927">!=</span>&nbsp;<span class="builtintype" id="5969930">nil</span>&nbsp;<span class="op" id="5969934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5969939">return</span>&nbsp;<span class="num" id="5969946">0</span><span class="op" id="5969947">,</span>&nbsp;<span class="ident" id="5969949">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969955">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969959">bz2</span><span class="op" id="5969962">.</span><span class="ident" id="5969963">setupDone</span>&nbsp;<span class="op" id="5969973">=</span>&nbsp;<span class="builtintype" id="5969975">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5969981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5969985">n</span><span class="op" id="5969986">,</span>&nbsp;<span class="ident" id="5969988">err</span>&nbsp;<span class="op" id="5969992">=</span>&nbsp;<span class="ident" id="5969994">bz2</span><span class="op" id="5969997">.</span><span class="ident" id="5969998">read</span><span class="op" id="5970002">(</span><span class="ident" id="5970003">buf</span><span class="op" id="5970006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970009">brErr</span>&nbsp;<span class="op" id="5970015">:=</span>&nbsp;<span class="ident" id="5970018">bz2</span><span class="op" id="5970021">.</span><span class="ident" id="5970022">br</span><span class="op" id="5970024">.</span><span class="ident" id="5970025">Err</span><span class="op" id="5970028">(</span><span class="op" id="5970029">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5970032">if</span>&nbsp;<span class="ident" id="5970035">brErr</span>&nbsp;<span class="op" id="5970041">!=</span>&nbsp;<span class="builtintype" id="5970044">nil</span>&nbsp;<span class="op" id="5970048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970052">err</span>&nbsp;<span class="op" id="5970056">=</span>&nbsp;<span class="ident" id="5970058">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5970065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5970068">return</span><br>
<span class="lineno"></span><span class="op" id="5970075">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5970078">func</span>&nbsp;<span class="op" id="5970083">(</span><span class="ident" id="5970084">bz2</span>&nbsp;<span class="op" id="5970088">*</span><span class="ident" id="5970089">reader</span><span class="op" id="5970095">)</span>&nbsp;<span class="ident" id="5970097">readFromBlock</span><span class="op" id="5970110">(</span><span class="ident" id="5970111">buf</span>&nbsp;<span class="op" id="5970115">[</span><span class="op" id="5970116">]</span><span class="builtintype" id="5970117">byte</span><span class="op" id="5970121">)</span>&nbsp;<span class="builtintype" id="5970123">int</span>&nbsp;<span class="op" id="5970127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970130">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970201">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970266">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970334">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970403">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970473">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970518">n</span>&nbsp;<span class="op" id="5970520">:=</span>&nbsp;<span class="num" id="5970523">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5970526">for</span>&nbsp;<span class="op" id="5970530">(</span><span class="ident" id="5970531">bz2</span><span class="op" id="5970534">.</span><span class="ident" id="5970535">repeats</span>&nbsp;<span class="op" id="5970543">&gt;</span>&nbsp;<span class="num" id="5970545">0</span>&nbsp;<span class="op" id="5970547">||</span>&nbsp;<span class="ident" id="5970550">bz2</span><span class="op" id="5970553">.</span><span class="ident" id="5970554">preRLEUsed</span>&nbsp;<span class="op" id="5970565">&lt;</span>&nbsp;<span class="builtinfunc" id="5970567">len</span><span class="op" id="5970570">(</span><span class="ident" id="5970571">bz2</span><span class="op" id="5970574">.</span><span class="ident" id="5970575">preRLE</span><span class="op" id="5970581">)</span><span class="op" id="5970582">)</span>&nbsp;<span class="op" id="5970584">&amp;&amp;</span>&nbsp;<span class="ident" id="5970587">n</span>&nbsp;<span class="op" id="5970589">&lt;</span>&nbsp;<span class="builtinfunc" id="5970591">len</span><span class="op" id="5970594">(</span><span class="ident" id="5970595">buf</span><span class="op" id="5970598">)</span>&nbsp;<span class="op" id="5970600">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970604">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970636">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970682">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970744">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970807">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970873">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5970934">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5970948">if</span>&nbsp;<span class="ident" id="5970951">bz2</span><span class="op" id="5970954">.</span><span class="ident" id="5970955">repeats</span>&nbsp;<span class="op" id="5970963">&gt;</span>&nbsp;<span class="num" id="5970965">0</span>&nbsp;<span class="op" id="5970967">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5970972">buf</span><span class="op" id="5970975">[</span><span class="ident" id="5970976">n</span><span class="op" id="5970977">]</span>&nbsp;<span class="op" id="5970979">=</span>&nbsp;<span class="builtintype" id="5970981">byte</span><span class="op" id="5970985">(</span><span class="ident" id="5970986">bz2</span><span class="op" id="5970989">.</span><span class="ident" id="5970990">lastByte</span><span class="op" id="5970998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971003">n</span><span class="op" id="5971004">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971010">bz2</span><span class="op" id="5971013">.</span><span class="ident" id="5971014">repeats</span><span class="op" id="5971021">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971027">if</span>&nbsp;<span class="ident" id="5971030">bz2</span><span class="op" id="5971033">.</span><span class="ident" id="5971034">repeats</span>&nbsp;<span class="op" id="5971042">==</span>&nbsp;<span class="num" id="5971045">0</span>&nbsp;<span class="op" id="5971047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971053">bz2</span><span class="op" id="5971056">.</span><span class="ident" id="5971057">lastByte</span>&nbsp;<span class="op" id="5971066">=</span>&nbsp;<span class="op" id="5971068">-</span><span class="num" id="5971069">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971079">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971095">bz2</span><span class="op" id="5971098">.</span><span class="ident" id="5971099">tPos</span>&nbsp;<span class="op" id="5971104">=</span>&nbsp;<span class="ident" id="5971106">bz2</span><span class="op" id="5971109">.</span><span class="ident" id="5971110">preRLE</span><span class="op" id="5971116">[</span><span class="ident" id="5971117">bz2</span><span class="op" id="5971120">.</span><span class="ident" id="5971121">tPos</span><span class="op" id="5971125">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971129">b</span>&nbsp;<span class="op" id="5971131">:=</span>&nbsp;<span class="builtintype" id="5971134">byte</span><span class="op" id="5971138">(</span><span class="ident" id="5971139">bz2</span><span class="op" id="5971142">.</span><span class="ident" id="5971143">tPos</span><span class="op" id="5971147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971151">bz2</span><span class="op" id="5971154">.</span><span class="ident" id="5971155">tPos</span>&nbsp;<span class="op" id="5971160">&gt;&gt;=</span>&nbsp;<span class="num" id="5971164">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971168">bz2</span><span class="op" id="5971171">.</span><span class="ident" id="5971172">preRLEUsed</span><span class="op" id="5971182">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971188">if</span>&nbsp;<span class="ident" id="5971191">bz2</span><span class="op" id="5971194">.</span><span class="ident" id="5971195">byteRepeats</span>&nbsp;<span class="op" id="5971207">==</span>&nbsp;<span class="num" id="5971210">3</span>&nbsp;<span class="op" id="5971212">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971217">bz2</span><span class="op" id="5971220">.</span><span class="ident" id="5971221">repeats</span>&nbsp;<span class="op" id="5971229">=</span>&nbsp;<span class="builtintype" id="5971231">uint</span><span class="op" id="5971235">(</span><span class="ident" id="5971236">b</span><span class="op" id="5971237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971242">bz2</span><span class="op" id="5971245">.</span><span class="ident" id="5971246">byteRepeats</span>&nbsp;<span class="op" id="5971258">=</span>&nbsp;<span class="num" id="5971260">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971265">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971281">if</span>&nbsp;<span class="ident" id="5971284">bz2</span><span class="op" id="5971287">.</span><span class="ident" id="5971288">lastByte</span>&nbsp;<span class="op" id="5971297">==</span>&nbsp;<span class="builtintype" id="5971300">int</span><span class="op" id="5971303">(</span><span class="ident" id="5971304">b</span><span class="op" id="5971305">)</span>&nbsp;<span class="op" id="5971307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971312">bz2</span><span class="op" id="5971315">.</span><span class="ident" id="5971316">byteRepeats</span><span class="op" id="5971327">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971332">}</span>&nbsp;<span class="keyword" id="5971334">else</span>&nbsp;<span class="op" id="5971339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971344">bz2</span><span class="op" id="5971347">.</span><span class="ident" id="5971348">byteRepeats</span>&nbsp;<span class="op" id="5971360">=</span>&nbsp;<span class="num" id="5971362">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971366">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971370">bz2</span><span class="op" id="5971373">.</span><span class="ident" id="5971374">lastByte</span>&nbsp;<span class="op" id="5971383">=</span>&nbsp;<span class="builtintype" id="5971385">int</span><span class="op" id="5971388">(</span><span class="ident" id="5971389">b</span><span class="op" id="5971390">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971395">buf</span><span class="op" id="5971398">[</span><span class="ident" id="5971399">n</span><span class="op" id="5971400">]</span>&nbsp;<span class="op" id="5971402">=</span>&nbsp;<span class="ident" id="5971404">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971408">n</span><span class="op" id="5971409">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971413">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971417">return</span>&nbsp;<span class="ident" id="5971424">n</span><br>
<span class="lineno"></span><span class="op" id="5971426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5971429">func</span>&nbsp;<span class="op" id="5971434">(</span><span class="ident" id="5971435">bz2</span>&nbsp;<span class="op" id="5971439">*</span><span class="ident" id="5971440">reader</span><span class="op" id="5971446">)</span>&nbsp;<span class="ident" id="5971448">read</span><span class="op" id="5971452">(</span><span class="ident" id="5971453">buf</span>&nbsp;<span class="op" id="5971457">[</span><span class="op" id="5971458">]</span><span class="builtintype" id="5971459">byte</span><span class="op" id="5971463">)</span>&nbsp;<span class="op" id="5971465">(</span><span class="builtintype" id="5971466">int</span><span class="op" id="5971469">,</span>&nbsp;<span class="builtintype" id="5971471">error</span><span class="op" id="5971476">)</span>&nbsp;<span class="op" id="5971478">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971481">for</span>&nbsp;<span class="op" id="5971485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971489">n</span>&nbsp;<span class="op" id="5971491">:=</span>&nbsp;<span class="ident" id="5971494">bz2</span><span class="op" id="5971497">.</span><span class="ident" id="5971498">readFromBlock</span><span class="op" id="5971511">(</span><span class="ident" id="5971512">buf</span><span class="op" id="5971515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971519">if</span>&nbsp;<span class="ident" id="5971522">n</span>&nbsp;<span class="op" id="5971524">&gt;</span>&nbsp;<span class="num" id="5971526">0</span>&nbsp;<span class="op" id="5971528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971533">bz2</span><span class="op" id="5971536">.</span><span class="ident" id="5971537">blockCRC</span>&nbsp;<span class="op" id="5971546">=</span>&nbsp;<span class="ident" id="5971548">updateCRC</span><span class="op" id="5971557">(</span><span class="ident" id="5971558">bz2</span><span class="op" id="5971561">.</span><span class="ident" id="5971562">blockCRC</span><span class="op" id="5971570">,</span>&nbsp;<span class="ident" id="5971572">buf</span><span class="op" id="5971575">[</span><span class="op" id="5971576">:</span><span class="ident" id="5971577">n</span><span class="op" id="5971578">]</span><span class="op" id="5971579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971584">return</span>&nbsp;<span class="ident" id="5971591">n</span><span class="op" id="5971592">,</span>&nbsp;<span class="builtintype" id="5971594">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5971605">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971635">if</span>&nbsp;<span class="ident" id="5971638">bz2</span><span class="op" id="5971641">.</span><span class="ident" id="5971642">blockCRC</span>&nbsp;<span class="op" id="5971651">!=</span>&nbsp;<span class="ident" id="5971654">bz2</span><span class="op" id="5971657">.</span><span class="ident" id="5971658">wantBlockCRC</span>&nbsp;<span class="op" id="5971671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971676">bz2</span><span class="op" id="5971679">.</span><span class="ident" id="5971680">br</span><span class="op" id="5971682">.</span><span class="ident" id="5971683">err</span>&nbsp;<span class="op" id="5971687">=</span>&nbsp;<span class="ident" id="5971689">StructuralError</span><span class="op" id="5971704">(</span><span class="string" id="5971705">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5971730">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971735">return</span>&nbsp;<span class="num" id="5971742">0</span><span class="op" id="5971743">,</span>&nbsp;<span class="ident" id="5971745">bz2</span><span class="op" id="5971748">.</span><span class="ident" id="5971749">br</span><span class="op" id="5971751">.</span><span class="ident" id="5971752">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5971758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5971763">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971785">br</span>&nbsp;<span class="op" id="5971788">:=</span>&nbsp;<span class="op" id="5971791">&amp;</span><span class="ident" id="5971792">bz2</span><span class="op" id="5971795">.</span><span class="ident" id="5971796">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971801">switch</span>&nbsp;<span class="ident" id="5971808">br</span><span class="op" id="5971810">.</span><span class="ident" id="5971811">ReadBits64</span><span class="op" id="5971821">(</span><span class="num" id="5971822">48</span><span class="op" id="5971824">)</span>&nbsp;<span class="op" id="5971826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971830">default</span><span class="op" id="5971837">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971842">return</span>&nbsp;<span class="num" id="5971849">0</span><span class="op" id="5971850">,</span>&nbsp;<span class="ident" id="5971852">StructuralError</span><span class="op" id="5971867">(</span><span class="string" id="5971868">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op" id="5971891">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971896">case</span>&nbsp;<span class="ident" id="5971901">bzip2BlockMagic</span><span class="op" id="5971916">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5971921">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5971943">err</span>&nbsp;<span class="op" id="5971947">:=</span>&nbsp;<span class="ident" id="5971950">bz2</span><span class="op" id="5971953">.</span><span class="ident" id="5971954">readBlock</span><span class="op" id="5971963">(</span><span class="op" id="5971964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971969">if</span>&nbsp;<span class="ident" id="5971972">err</span>&nbsp;<span class="op" id="5971976">!=</span>&nbsp;<span class="builtintype" id="5971979">nil</span>&nbsp;<span class="op" id="5971983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5971989">return</span>&nbsp;<span class="num" id="5971996">0</span><span class="op" id="5971997">,</span>&nbsp;<span class="ident" id="5971999">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972006">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972011">case</span>&nbsp;<span class="ident" id="5972016">bzip2FinalMagic</span><span class="op" id="5972031">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5972036">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5972065">wantFileCRC</span>&nbsp;<span class="op" id="5972077">:=</span>&nbsp;<span class="builtintype" id="5972080">uint32</span><span class="op" id="5972086">(</span><span class="ident" id="5972087">br</span><span class="op" id="5972089">.</span><span class="ident" id="5972090">ReadBits64</span><span class="op" id="5972100">(</span><span class="num" id="5972101">32</span><span class="op" id="5972103">)</span><span class="op" id="5972104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972109">if</span>&nbsp;<span class="ident" id="5972112">br</span><span class="op" id="5972114">.</span><span class="ident" id="5972115">err</span>&nbsp;<span class="op" id="5972119">!=</span>&nbsp;<span class="builtintype" id="5972122">nil</span>&nbsp;<span class="op" id="5972126">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972132">return</span>&nbsp;<span class="num" id="5972139">0</span><span class="op" id="5972140">,</span>&nbsp;<span class="ident" id="5972142">br</span><span class="op" id="5972144">.</span><span class="ident" id="5972145">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972157">if</span>&nbsp;<span class="ident" id="5972160">bz2</span><span class="op" id="5972163">.</span><span class="ident" id="5972164">fileCRC</span>&nbsp;<span class="op" id="5972172">!=</span>&nbsp;<span class="ident" id="5972175">wantFileCRC</span>&nbsp;<span class="op" id="5972187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5972193">br</span><span class="op" id="5972195">.</span><span class="ident" id="5972196">err</span>&nbsp;<span class="op" id="5972200">=</span>&nbsp;<span class="ident" id="5972202">StructuralError</span><span class="op" id="5972217">(</span><span class="string" id="5972218">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5972242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972248">return</span>&nbsp;<span class="num" id="5972255">0</span><span class="op" id="5972256">,</span>&nbsp;<span class="ident" id="5972258">br</span><span class="op" id="5972260">.</span><span class="ident" id="5972261">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5972274">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5972309">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5972357">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972387">if</span>&nbsp;<span class="ident" id="5972390">br</span><span class="op" id="5972392">.</span><span class="ident" id="5972393">bits</span><span class="op" id="5972397">%</span><span class="num" id="5972398">8</span>&nbsp;<span class="op" id="5972400">!=</span>&nbsp;<span class="num" id="5972403">0</span>&nbsp;<span class="op" id="5972405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5972411">br</span><span class="op" id="5972413">.</span><span class="ident" id="5972414">ReadBits</span><span class="op" id="5972422">(</span><span class="ident" id="5972423">br</span><span class="op" id="5972425">.</span><span class="ident" id="5972426">bits</span>&nbsp;<span class="op" id="5972431">%</span>&nbsp;<span class="num" id="5972433">8</span><span class="op" id="5972434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5972444">b</span><span class="op" id="5972445">,</span>&nbsp;<span class="ident" id="5972447">err</span>&nbsp;<span class="op" id="5972451">:=</span>&nbsp;<span class="ident" id="5972454">br</span><span class="op" id="5972456">.</span><span class="ident" id="5972457">r</span><span class="op" id="5972458">.</span><span class="ident" id="5972459">ReadByte</span><span class="op" id="5972467">(</span><span class="op" id="5972468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972473">if</span>&nbsp;<span class="ident" id="5972476">err</span>&nbsp;<span class="op" id="5972480">==</span>&nbsp;<span class="ident" id="5972483">io</span><span class="op" id="5972485">.</span><span class="ident" id="5972486">EOF</span>&nbsp;<span class="op" id="5972490">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5972496">br</span><span class="op" id="5972498">.</span><span class="ident" id="5972499">err</span>&nbsp;<span class="op" id="5972503">=</span>&nbsp;<span class="ident" id="5972505">io</span><span class="op" id="5972507">.</span><span class="ident" id="5972508">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5972516">bz2</span><span class="op" id="5972519">.</span><span class="ident" id="5972520">eof</span>&nbsp;<span class="op" id="5972524">=</span>&nbsp;<span class="builtintype" id="5972526">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972535">return</span>&nbsp;<span class="num" id="5972542">0</span><span class="op" id="5972543">,</span>&nbsp;<span class="ident" id="5972545">io</span><span class="op" id="5972547">.</span><span class="ident" id="5972548">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972560">if</span>&nbsp;<span class="ident" id="5972563">err</span>&nbsp;<span class="op" id="5972567">!=</span>&nbsp;<span class="builtintype" id="5972570">nil</span>&nbsp;<span class="op" id="5972574">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5972580">br</span><span class="op" id="5972582">.</span><span class="ident" id="5972583">err</span>&nbsp;<span class="op" id="5972587">=</span>&nbsp;<span class="ident" id="5972589">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972597">return</span>&nbsp;<span class="num" id="5972604">0</span><span class="op" id="5972605">,</span>&nbsp;<span class="ident" id="5972607">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5972619">z</span><span class="op" id="5972620">,</span>&nbsp;<span class="ident" id="5972622">err</span>&nbsp;<span class="op" id="5972626">:=</span>&nbsp;<span class="ident" id="5972629">br</span><span class="op" id="5972631">.</span><span class="ident" id="5972632">r</span><span class="op" id="5972633">.</span><span class="ident" id="5972634">ReadByte</span><span class="op" id="5972642">(</span><span class="op" id="5972643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972648">if</span>&nbsp;<span class="ident" id="5972651">err</span>&nbsp;<span class="op" id="5972655">!=</span>&nbsp;<span class="builtintype" id="5972658">nil</span>&nbsp;<span class="op" id="5972662">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972668">if</span>&nbsp;<span class="ident" id="5972671">err</span>&nbsp;<span class="op" id="5972675">==</span>&nbsp;<span class="ident" id="5972678">io</span><span class="op" id="5972680">.</span><span class="ident" id="5972681">EOF</span>&nbsp;<span class="op" id="5972685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5972692">err</span>&nbsp;<span class="op" id="5972696">=</span>&nbsp;<span class="ident" id="5972698">io</span><span class="op" id="5972700">.</span><span class="ident" id="5972701">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5972728">br</span><span class="op" id="5972730">.</span><span class="ident" id="5972731">err</span>&nbsp;<span class="op" id="5972735">=</span>&nbsp;<span class="ident" id="5972737">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972745">return</span>&nbsp;<span class="num" id="5972752">0</span><span class="op" id="5972753">,</span>&nbsp;<span class="ident" id="5972755">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972767">if</span>&nbsp;<span class="ident" id="5972770">b</span>&nbsp;<span class="op" id="5972772">!=</span>&nbsp;<span class="string" id="5972775">&#39;B&#39;</span>&nbsp;<span class="op" id="5972779">||</span>&nbsp;<span class="ident" id="5972782">z</span>&nbsp;<span class="op" id="5972784">!=</span>&nbsp;<span class="string" id="5972787">&#39;Z&#39;</span>&nbsp;<span class="op" id="5972791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972797">return</span>&nbsp;<span class="num" id="5972804">0</span><span class="op" id="5972805">,</span>&nbsp;<span class="ident" id="5972807">StructuralError</span><span class="op" id="5972822">(</span><span class="string" id="5972823">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op" id="5972861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972871">if</span>&nbsp;<span class="ident" id="5972874">err</span>&nbsp;<span class="op" id="5972878">:=</span>&nbsp;<span class="ident" id="5972881">bz2</span><span class="op" id="5972884">.</span><span class="ident" id="5972885">setup</span><span class="op" id="5972890">(</span><span class="builtintype" id="5972891">false</span><span class="op" id="5972896">)</span><span class="op" id="5972897">;</span>&nbsp;<span class="ident" id="5972899">err</span>&nbsp;<span class="op" id="5972903">!=</span>&nbsp;<span class="builtintype" id="5972906">nil</span>&nbsp;<span class="op" id="5972910">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5972916">return</span>&nbsp;<span class="num" id="5972923">0</span><span class="op" id="5972924">,</span>&nbsp;<span class="ident" id="5972926">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5972940">}</span><br>
<span class="lineno"></span><span class="op" id="5972942">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="5972945">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword" id="5973031">func</span>&nbsp;<span class="op" id="5973036">(</span><span class="ident" id="5973037">bz2</span>&nbsp;<span class="op" id="5973041">*</span><span class="ident" id="5973042">reader</span><span class="op" id="5973048">)</span>&nbsp;<span class="ident" id="5973050">readBlock</span><span class="op" id="5973059">(</span><span class="op" id="5973060">)</span>&nbsp;<span class="op" id="5973062">(</span><span class="ident" id="5973063">err</span>&nbsp;<span class="builtintype" id="5973067">error</span><span class="op" id="5973072">)</span>&nbsp;<span class="op" id="5973074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973077">br</span>&nbsp;<span class="op" id="5973080">:=</span>&nbsp;<span class="op" id="5973083">&amp;</span><span class="ident" id="5973084">bz2</span><span class="op" id="5973087">.</span><span class="ident" id="5973088">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973092">bz2</span><span class="op" id="5973095">.</span><span class="ident" id="5973096">wantBlockCRC</span>&nbsp;<span class="op" id="5973109">=</span>&nbsp;<span class="builtintype" id="5973111">uint32</span><span class="op" id="5973117">(</span><span class="ident" id="5973118">br</span><span class="op" id="5973120">.</span><span class="ident" id="5973121">ReadBits64</span><span class="op" id="5973131">(</span><span class="num" id="5973132">32</span><span class="op" id="5973134">)</span><span class="op" id="5973135">)</span>&nbsp;<span class="comment" id="5973137">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973204">bz2</span><span class="op" id="5973207">.</span><span class="ident" id="5973208">blockCRC</span>&nbsp;<span class="op" id="5973217">=</span>&nbsp;<span class="num" id="5973219">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973222">bz2</span><span class="op" id="5973225">.</span><span class="ident" id="5973226">fileCRC</span>&nbsp;<span class="op" id="5973234">=</span>&nbsp;<span class="op" id="5973236">(</span><span class="ident" id="5973237">bz2</span><span class="op" id="5973240">.</span><span class="ident" id="5973241">fileCRC</span><span class="op" id="5973248">&lt;&lt;</span><span class="num" id="5973250">1</span>&nbsp;<span class="op" id="5973252">|</span>&nbsp;<span class="ident" id="5973254">bz2</span><span class="op" id="5973257">.</span><span class="ident" id="5973258">fileCRC</span><span class="op" id="5973265">&gt;&gt;</span><span class="num" id="5973267">31</span><span class="op" id="5973269">)</span>&nbsp;<span class="op" id="5973271">^</span>&nbsp;<span class="ident" id="5973273">bz2</span><span class="op" id="5973276">.</span><span class="ident" id="5973277">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973291">randomized</span>&nbsp;<span class="op" id="5973302">:=</span>&nbsp;<span class="ident" id="5973305">br</span><span class="op" id="5973307">.</span><span class="ident" id="5973308">ReadBits</span><span class="op" id="5973316">(</span><span class="num" id="5973317">1</span><span class="op" id="5973318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973321">if</span>&nbsp;<span class="ident" id="5973324">randomized</span>&nbsp;<span class="op" id="5973335">!=</span>&nbsp;<span class="num" id="5973338">0</span>&nbsp;<span class="op" id="5973340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973344">return</span>&nbsp;<span class="ident" id="5973351">StructuralError</span><span class="op" id="5973366">(</span><span class="string" id="5973367">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op" id="5973396">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973402">origPtr</span>&nbsp;<span class="op" id="5973410">:=</span>&nbsp;<span class="builtintype" id="5973413">uint</span><span class="op" id="5973417">(</span><span class="ident" id="5973418">br</span><span class="op" id="5973420">.</span><span class="ident" id="5973421">ReadBits</span><span class="op" id="5973429">(</span><span class="num" id="5973430">24</span><span class="op" id="5973432">)</span><span class="op" id="5973433">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5973437">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5973509">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5973573">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973602">symbolRangeUsedBitmap</span>&nbsp;<span class="op" id="5973624">:=</span>&nbsp;<span class="ident" id="5973627">br</span><span class="op" id="5973629">.</span><span class="ident" id="5973630">ReadBits</span><span class="op" id="5973638">(</span><span class="num" id="5973639">16</span><span class="op" id="5973641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973644">symbolPresent</span>&nbsp;<span class="op" id="5973658">:=</span>&nbsp;<span class="builtinfunc" id="5973661">make</span><span class="op" id="5973665">(</span><span class="op" id="5973666">[</span><span class="op" id="5973667">]</span><span class="builtintype" id="5973668">bool</span><span class="op" id="5973672">,</span>&nbsp;<span class="num" id="5973674">256</span><span class="op" id="5973677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973680">numSymbols</span>&nbsp;<span class="op" id="5973691">:=</span>&nbsp;<span class="num" id="5973694">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973697">for</span>&nbsp;<span class="ident" id="5973701">symRange</span>&nbsp;<span class="op" id="5973710">:=</span>&nbsp;<span class="builtintype" id="5973713">uint</span><span class="op" id="5973717">(</span><span class="num" id="5973718">0</span><span class="op" id="5973719">)</span><span class="op" id="5973720">;</span>&nbsp;<span class="ident" id="5973722">symRange</span>&nbsp;<span class="op" id="5973731">&lt;</span>&nbsp;<span class="num" id="5973733">16</span><span class="op" id="5973735">;</span>&nbsp;<span class="ident" id="5973737">symRange</span><span class="op" id="5973745">++</span>&nbsp;<span class="op" id="5973748">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973752">if</span>&nbsp;<span class="ident" id="5973755">symbolRangeUsedBitmap</span><span class="op" id="5973776">&amp;</span><span class="op" id="5973777">(</span><span class="num" id="5973778">1</span><span class="op" id="5973779">&lt;&lt;</span><span class="op" id="5973781">(</span><span class="num" id="5973782">15</span><span class="op" id="5973784">-</span><span class="ident" id="5973785">symRange</span><span class="op" id="5973793">)</span><span class="op" id="5973794">)</span>&nbsp;<span class="op" id="5973796">!=</span>&nbsp;<span class="num" id="5973799">0</span>&nbsp;<span class="op" id="5973801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973806">bits</span>&nbsp;<span class="op" id="5973811">:=</span>&nbsp;<span class="ident" id="5973814">br</span><span class="op" id="5973816">.</span><span class="ident" id="5973817">ReadBits</span><span class="op" id="5973825">(</span><span class="num" id="5973826">16</span><span class="op" id="5973828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973833">for</span>&nbsp;<span class="ident" id="5973837">symbol</span>&nbsp;<span class="op" id="5973844">:=</span>&nbsp;<span class="builtintype" id="5973847">uint</span><span class="op" id="5973851">(</span><span class="num" id="5973852">0</span><span class="op" id="5973853">)</span><span class="op" id="5973854">;</span>&nbsp;<span class="ident" id="5973856">symbol</span>&nbsp;<span class="op" id="5973863">&lt;</span>&nbsp;<span class="num" id="5973865">16</span><span class="op" id="5973867">;</span>&nbsp;<span class="ident" id="5973869">symbol</span><span class="op" id="5973875">++</span>&nbsp;<span class="op" id="5973878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5973884">if</span>&nbsp;<span class="ident" id="5973887">bits</span><span class="op" id="5973891">&amp;</span><span class="op" id="5973892">(</span><span class="num" id="5973893">1</span><span class="op" id="5973894">&lt;&lt;</span><span class="op" id="5973896">(</span><span class="num" id="5973897">15</span><span class="op" id="5973899">-</span><span class="ident" id="5973900">symbol</span><span class="op" id="5973906">)</span><span class="op" id="5973907">)</span>&nbsp;<span class="op" id="5973909">!=</span>&nbsp;<span class="num" id="5973912">0</span>&nbsp;<span class="op" id="5973914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973921">symbolPresent</span><span class="op" id="5973934">[</span><span class="num" id="5973935">16</span><span class="op" id="5973937">*</span><span class="ident" id="5973938">symRange</span><span class="op" id="5973946">+</span><span class="ident" id="5973947">symbol</span><span class="op" id="5973953">]</span>&nbsp;<span class="op" id="5973955">=</span>&nbsp;<span class="builtintype" id="5973957">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5973967">numSymbols</span><span class="op" id="5973977">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5973996">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5974000">if</span>&nbsp;<span class="ident" id="5974003">numSymbols</span>&nbsp;<span class="op" id="5974014">==</span>&nbsp;<span class="num" id="5974017">0</span>&nbsp;<span class="op" id="5974019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5974023">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5974057">return</span>&nbsp;<span class="ident" id="5974064">StructuralError</span><span class="op" id="5974079">(</span><span class="string" id="5974080">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op" id="5974101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5974104">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5974108">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5974170">numHuffmanTrees</span>&nbsp;<span class="op" id="5974186">:=</span>&nbsp;<span class="ident" id="5974189">br</span><span class="op" id="5974191">.</span><span class="ident" id="5974192">ReadBits</span><span class="op" id="5974200">(</span><span class="num" id="5974201">3</span><span class="op" id="5974202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5974205">if</span>&nbsp;<span class="ident" id="5974208">numHuffmanTrees</span>&nbsp;<span class="op" id="5974224">&lt;</span>&nbsp;<span class="num" id="5974226">2</span>&nbsp;<span class="op" id="5974228">||</span>&nbsp;<span class="ident" id="5974231">numHuffmanTrees</span>&nbsp;<span class="op" id="5974247">&gt;</span>&nbsp;<span class="num" id="5974249">6</span>&nbsp;<span class="op" id="5974251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5974255">return</span>&nbsp;<span class="ident" id="5974262">StructuralError</span><span class="op" id="5974277">(</span><span class="string" id="5974278">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op" id="5974311">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5974314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5974318">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5974388">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5974460">numSelectors</span>&nbsp;<span class="op" id="5974473">:=</span>&nbsp;<span class="ident" id="5974476">br</span><span class="op" id="5974478">.</span><span class="ident" id="5974479">ReadBits</span><span class="op" id="5974487">(</span><span class="num" id="5974488">15</span><span class="op" id="5974490">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5974493">treeIndexes</span>&nbsp;<span class="op" id="5974505">:=</span>&nbsp;<span class="builtinfunc" id="5974508">make</span><span class="op" id="5974512">(</span><span class="op" id="5974513">[</span><span class="op" id="5974514">]</span><span class="builtintype" id="5974515">uint8</span><span class="op" id="5974520">,</span>&nbsp;<span class="ident" id="5974522">numSelectors</span><span class="op" id="5974534">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5974538">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5974609">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5974622">mtfTreeDecoder</span>&nbsp;<span class="op" id="5974637">:=</span>&nbsp;<span class="ident" id="5974640">newMTFDecoderWithRange</span><span class="op" id="5974662">(</span><span class="ident" id="5974663">numHuffmanTrees</span><span class="op" id="5974678">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5974681">for</span>&nbsp;<span class="ident" id="5974685">i</span>&nbsp;<span class="op" id="5974687">:=</span>&nbsp;<span class="keyword" id="5974690">range</span>&nbsp;<span class="ident" id="5974696">treeIndexes</span>&nbsp;<span class="op" id="5974708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5974712">c</span>&nbsp;<span class="op" id="5974714">:=</span>&nbsp;<span class="num" id="5974717">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5974721">for</span>&nbsp;<span class="op" id="5974725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5974730">inc</span>&nbsp;<span class="op" id="5974734">:=</span>&nbsp;<span class="ident" id="5974737">br</span><span class="op" id="5974739">.</span><span class="ident" id="5974740">ReadBits</span><span class="op" id="5974748">(</span><span class="num" id="5974749">1</span><span class="op" id="5974750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5974755">if</span>&nbsp;<span class="ident" id="5974758">inc</span>&nbsp;<span class="op" id="5974762">==</span>&nbsp;<span class="num" id="5974765">0</span>&nbsp;<span class="op" id="5974767">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5974773">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5974782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5974787">c</span><span class="op" id="5974788">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5974793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5974797">if</span>&nbsp;<span class="ident" id="5974800">c</span>&nbsp;<span class="op" id="5974802">&gt;=</span>&nbsp;<span class="ident" id="5974805">numHuffmanTrees</span>&nbsp;<span class="op" id="5974821">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5974826">return</span>&nbsp;<span class="ident" id="5974833">StructuralError</span><span class="op" id="5974848">(</span><span class="string" id="5974849">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op" id="5974871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5974875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5974879">treeIndexes</span><span class="op" id="5974890">[</span><span class="ident" id="5974891">i</span><span class="op" id="5974892">]</span>&nbsp;<span class="op" id="5974894">=</span>&nbsp;<span class="builtintype" id="5974896">uint8</span><span class="op" id="5974901">(</span><span class="ident" id="5974902">mtfTreeDecoder</span><span class="op" id="5974916">.</span><span class="ident" id="5974917">Decode</span><span class="op" id="5974923">(</span><span class="ident" id="5974924">c</span><span class="op" id="5974925">)</span><span class="op" id="5974926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5974929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5974933">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5975003">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975045">symbols</span>&nbsp;<span class="op" id="5975053">:=</span>&nbsp;<span class="builtinfunc" id="5975056">make</span><span class="op" id="5975060">(</span><span class="op" id="5975061">[</span><span class="op" id="5975062">]</span><span class="builtintype" id="5975063">byte</span><span class="op" id="5975067">,</span>&nbsp;<span class="ident" id="5975069">numSymbols</span><span class="op" id="5975079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975082">nextSymbol</span>&nbsp;<span class="op" id="5975093">:=</span>&nbsp;<span class="num" id="5975096">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5975099">for</span>&nbsp;<span class="ident" id="5975103">i</span>&nbsp;<span class="op" id="5975105">:=</span>&nbsp;<span class="num" id="5975108">0</span><span class="op" id="5975109">;</span>&nbsp;<span class="ident" id="5975111">i</span>&nbsp;<span class="op" id="5975113">&lt;</span>&nbsp;<span class="num" id="5975115">256</span><span class="op" id="5975118">;</span>&nbsp;<span class="ident" id="5975120">i</span><span class="op" id="5975121">++</span>&nbsp;<span class="op" id="5975124">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5975128">if</span>&nbsp;<span class="ident" id="5975131">symbolPresent</span><span class="op" id="5975144">[</span><span class="ident" id="5975145">i</span><span class="op" id="5975146">]</span>&nbsp;<span class="op" id="5975148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975153">symbols</span><span class="op" id="5975160">[</span><span class="ident" id="5975161">nextSymbol</span><span class="op" id="5975171">]</span>&nbsp;<span class="op" id="5975173">=</span>&nbsp;<span class="builtintype" id="5975175">byte</span><span class="op" id="5975179">(</span><span class="ident" id="5975180">i</span><span class="op" id="5975181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975186">nextSymbol</span><span class="op" id="5975196">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5975201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5975204">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975207">mtf</span>&nbsp;<span class="op" id="5975211">:=</span>&nbsp;<span class="ident" id="5975214">newMTFDecoder</span><span class="op" id="5975227">(</span><span class="ident" id="5975228">symbols</span><span class="op" id="5975235">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975239">numSymbols</span>&nbsp;<span class="op" id="5975250">+=</span>&nbsp;<span class="num" id="5975253">2</span>&nbsp;<span class="comment" id="5975255">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975296">huffmanTrees</span>&nbsp;<span class="op" id="5975309">:=</span>&nbsp;<span class="builtinfunc" id="5975312">make</span><span class="op" id="5975316">(</span><span class="op" id="5975317">[</span><span class="op" id="5975318">]</span><span class="ident" id="5975319">huffmanTree</span><span class="op" id="5975330">,</span>&nbsp;<span class="ident" id="5975332">numHuffmanTrees</span><span class="op" id="5975347">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5975351">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975411">lengths</span>&nbsp;<span class="op" id="5975419">:=</span>&nbsp;<span class="builtinfunc" id="5975422">make</span><span class="op" id="5975426">(</span><span class="op" id="5975427">[</span><span class="op" id="5975428">]</span><span class="builtintype" id="5975429">uint8</span><span class="op" id="5975434">,</span>&nbsp;<span class="ident" id="5975436">numSymbols</span><span class="op" id="5975446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5975449">for</span>&nbsp;<span class="ident" id="5975453">i</span>&nbsp;<span class="op" id="5975455">:=</span>&nbsp;<span class="keyword" id="5975458">range</span>&nbsp;<span class="ident" id="5975464">huffmanTrees</span>&nbsp;<span class="op" id="5975477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5975481">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975546">length</span>&nbsp;<span class="op" id="5975553">:=</span>&nbsp;<span class="ident" id="5975556">br</span><span class="op" id="5975558">.</span><span class="ident" id="5975559">ReadBits</span><span class="op" id="5975567">(</span><span class="num" id="5975568">5</span><span class="op" id="5975569">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5975573">for</span>&nbsp;<span class="ident" id="5975577">j</span>&nbsp;<span class="op" id="5975579">:=</span>&nbsp;<span class="keyword" id="5975582">range</span>&nbsp;<span class="ident" id="5975588">lengths</span>&nbsp;<span class="op" id="5975596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5975601">for</span>&nbsp;<span class="op" id="5975605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5975611">if</span>&nbsp;<span class="op" id="5975614">!</span><span class="ident" id="5975615">br</span><span class="op" id="5975617">.</span><span class="ident" id="5975618">ReadBit</span><span class="op" id="5975625">(</span><span class="op" id="5975626">)</span>&nbsp;<span class="op" id="5975628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5975635">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5975645">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5975651">if</span>&nbsp;<span class="ident" id="5975654">br</span><span class="op" id="5975656">.</span><span class="ident" id="5975657">ReadBit</span><span class="op" id="5975664">(</span><span class="op" id="5975665">)</span>&nbsp;<span class="op" id="5975667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975674">length</span><span class="op" id="5975680">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5975687">}</span>&nbsp;<span class="keyword" id="5975689">else</span>&nbsp;<span class="op" id="5975694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975701">length</span><span class="op" id="5975707">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5975714">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5975719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5975724">if</span>&nbsp;<span class="ident" id="5975727">length</span>&nbsp;<span class="op" id="5975734">&lt;</span>&nbsp;<span class="num" id="5975736">0</span>&nbsp;<span class="op" id="5975738">||</span>&nbsp;<span class="ident" id="5975741">length</span>&nbsp;<span class="op" id="5975748">&gt;</span>&nbsp;<span class="num" id="5975750">20</span>&nbsp;<span class="op" id="5975753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5975759">return</span>&nbsp;<span class="ident" id="5975766">StructuralError</span><span class="op" id="5975781">(</span><span class="string" id="5975782">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5975811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5975816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975821">lengths</span><span class="op" id="5975828">[</span><span class="ident" id="5975829">j</span><span class="op" id="5975830">]</span>&nbsp;<span class="op" id="5975832">=</span>&nbsp;<span class="builtintype" id="5975834">uint8</span><span class="op" id="5975839">(</span><span class="ident" id="5975840">length</span><span class="op" id="5975846">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5975850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975854">huffmanTrees</span><span class="op" id="5975866">[</span><span class="ident" id="5975867">i</span><span class="op" id="5975868">]</span><span class="op" id="5975869">,</span>&nbsp;<span class="ident" id="5975871">err</span>&nbsp;<span class="op" id="5975875">=</span>&nbsp;<span class="ident" id="5975877">newHuffmanTree</span><span class="op" id="5975891">(</span><span class="ident" id="5975892">lengths</span><span class="op" id="5975899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5975903">if</span>&nbsp;<span class="ident" id="5975906">err</span>&nbsp;<span class="op" id="5975910">!=</span>&nbsp;<span class="builtintype" id="5975913">nil</span>&nbsp;<span class="op" id="5975917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5975922">return</span>&nbsp;<span class="ident" id="5975929">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5975935">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5975938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5975942">selectorIndex</span>&nbsp;<span class="op" id="5975956">:=</span>&nbsp;<span class="num" id="5975959">1</span>&nbsp;<span class="comment" id="5975961">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5975992">if</span>&nbsp;<span class="builtinfunc" id="5975995">len</span><span class="op" id="5975998">(</span><span class="ident" id="5975999">treeIndexes</span><span class="op" id="5976010">)</span>&nbsp;<span class="op" id="5976012">==</span>&nbsp;<span class="num" id="5976015">0</span>&nbsp;<span class="op" id="5976017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5976021">return</span>&nbsp;<span class="ident" id="5976028">StructuralError</span><span class="op" id="5976043">(</span><span class="string" id="5976044">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op" id="5976069">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5976072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5976075">if</span>&nbsp;<span class="builtintype" id="5976078">int</span><span class="op" id="5976081">(</span><span class="ident" id="5976082">treeIndexes</span><span class="op" id="5976093">[</span><span class="num" id="5976094">0</span><span class="op" id="5976095">]</span><span class="op" id="5976096">)</span>&nbsp;<span class="op" id="5976098">&gt;=</span>&nbsp;<span class="builtinfunc" id="5976101">len</span><span class="op" id="5976104">(</span><span class="ident" id="5976105">huffmanTrees</span><span class="op" id="5976117">)</span>&nbsp;<span class="op" id="5976119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5976123">return</span>&nbsp;<span class="ident" id="5976130">StructuralError</span><span class="op" id="5976145">(</span><span class="string" id="5976146">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5976174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5976177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5976180">currentHuffmanTree</span>&nbsp;<span class="op" id="5976199">:=</span>&nbsp;<span class="ident" id="5976202">huffmanTrees</span><span class="op" id="5976214">[</span><span class="ident" id="5976215">treeIndexes</span><span class="op" id="5976226">[</span><span class="num" id="5976227">0</span><span class="op" id="5976228">]</span><span class="op" id="5976229">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5976232">bufIndex</span>&nbsp;<span class="op" id="5976241">:=</span>&nbsp;<span class="num" id="5976244">0</span>&nbsp;<span class="comment" id="5976246">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5976286">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5976358">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5976425">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5976495">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5976508">repeat</span>&nbsp;<span class="op" id="5976515">:=</span>&nbsp;<span class="num" id="5976518">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5976521">repeat_power</span>&nbsp;<span class="op" id="5976534">:=</span>&nbsp;<span class="num" id="5976537">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5976541">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5976615">for</span>&nbsp;<span class="ident" id="5976619">i</span>&nbsp;<span class="op" id="5976621">:=</span>&nbsp;<span class="keyword" id="5976624">range</span>&nbsp;<span class="ident" id="5976630">bz2</span><span class="op" id="5976633">.</span><span class="ident" id="5976634">c</span>&nbsp;<span class="op" id="5976636">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5976640">bz2</span><span class="op" id="5976643">.</span><span class="ident" id="5976644">c</span><span class="op" id="5976645">[</span><span class="ident" id="5976646">i</span><span class="op" id="5976647">]</span>&nbsp;<span class="op" id="5976649">=</span>&nbsp;<span class="num" id="5976651">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5976654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5976658">decoded</span>&nbsp;<span class="op" id="5976666">:=</span>&nbsp;<span class="num" id="5976669">0</span>&nbsp;<span class="comment" id="5976671">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5976733">for</span>&nbsp;<span class="op" id="5976737">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5976741">if</span>&nbsp;<span class="ident" id="5976744">decoded</span>&nbsp;<span class="op" id="5976752">==</span>&nbsp;<span class="num" id="5976755">50</span>&nbsp;<span class="op" id="5976758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5976763">if</span>&nbsp;<span class="ident" id="5976766">selectorIndex</span>&nbsp;<span class="op" id="5976780">&gt;=</span>&nbsp;<span class="ident" id="5976783">numSelectors</span>&nbsp;<span class="op" id="5976796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5976802">return</span>&nbsp;<span class="ident" id="5976809">StructuralError</span><span class="op" id="5976824">(</span><span class="string" id="5976825">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op" id="5976878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5976883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5976888">if</span>&nbsp;<span class="builtintype" id="5976891">int</span><span class="op" id="5976894">(</span><span class="ident" id="5976895">treeIndexes</span><span class="op" id="5976906">[</span><span class="ident" id="5976907">selectorIndex</span><span class="op" id="5976920">]</span><span class="op" id="5976921">)</span>&nbsp;<span class="op" id="5976923">&gt;=</span>&nbsp;<span class="builtinfunc" id="5976926">len</span><span class="op" id="5976929">(</span><span class="ident" id="5976930">huffmanTrees</span><span class="op" id="5976942">)</span>&nbsp;<span class="op" id="5976944">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5976950">return</span>&nbsp;<span class="ident" id="5976957">StructuralError</span><span class="op" id="5976972">(</span><span class="string" id="5976973">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5977001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5977006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5977011">currentHuffmanTree</span>&nbsp;<span class="op" id="5977030">=</span>&nbsp;<span class="ident" id="5977032">huffmanTrees</span><span class="op" id="5977044">[</span><span class="ident" id="5977045">treeIndexes</span><span class="op" id="5977056">[</span><span class="ident" id="5977057">selectorIndex</span><span class="op" id="5977070">]</span><span class="op" id="5977071">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5977076">selectorIndex</span><span class="op" id="5977089">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5977095">decoded</span>&nbsp;<span class="op" id="5977103">=</span>&nbsp;<span class="num" id="5977105">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5977109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5977114">v</span>&nbsp;<span class="op" id="5977116">:=</span>&nbsp;<span class="ident" id="5977119">currentHuffmanTree</span><span class="op" id="5977137">.</span><span class="ident" id="5977138">Decode</span><span class="op" id="5977144">(</span><span class="ident" id="5977145">br</span><span class="op" id="5977147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5977151">decoded</span><span class="op" id="5977158">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5977164">if</span>&nbsp;<span class="ident" id="5977167">v</span>&nbsp;<span class="op" id="5977169">&lt;</span>&nbsp;<span class="num" id="5977171">2</span>&nbsp;<span class="op" id="5977173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5977178">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5977224">if</span>&nbsp;<span class="ident" id="5977227">repeat</span>&nbsp;<span class="op" id="5977234">==</span>&nbsp;<span class="num" id="5977237">0</span>&nbsp;<span class="op" id="5977239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5977245">repeat_power</span>&nbsp;<span class="op" id="5977258">=</span>&nbsp;<span class="num" id="5977260">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5977265">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5977270">repeat</span>&nbsp;<span class="op" id="5977277">+=</span>&nbsp;<span class="ident" id="5977280">repeat_power</span>&nbsp;<span class="op" id="5977293">&lt;&lt;</span>&nbsp;<span class="ident" id="5977296">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5977301">repeat_power</span>&nbsp;<span class="op" id="5977314">&lt;&lt;=</span>&nbsp;<span class="num" id="5977318">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5977324">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5977382">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5977431">if</span>&nbsp;<span class="ident" id="5977434">repeat</span>&nbsp;<span class="op" id="5977441">&gt;</span>&nbsp;<span class="num" id="5977443">2</span><span class="op" id="5977444">*</span><span class="num" id="5977445">1024</span><span class="op" id="5977449">*</span><span class="num" id="5977450">1024</span>&nbsp;<span class="op" id="5977455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5977461">return</span>&nbsp;<span class="ident" id="5977468">StructuralError</span><span class="op" id="5977483">(</span><span class="string" id="5977484">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op" id="5977508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5977513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5977518">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5977529">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5977534">if</span>&nbsp;<span class="ident" id="5977537">repeat</span>&nbsp;<span class="op" id="5977544">&gt;</span>&nbsp;<span class="num" id="5977546">0</span>&nbsp;<span class="op" id="5977548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5977553">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5977611">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5977651">if</span>&nbsp;<span class="ident" id="5977654">repeat</span>&nbsp;<span class="op" id="5977661">&gt;</span>&nbsp;<span class="ident" id="5977663">bz2</span><span class="op" id="5977666">.</span><span class="ident" id="5977667">blockSize</span><span class="op" id="5977676">-</span><span class="ident" id="5977677">bufIndex</span>&nbsp;<span class="op" id="5977686">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5977692">return</span>&nbsp;<span class="ident" id="5977699">StructuralError</span><span class="op" id="5977714">(</span><span class="string" id="5977715">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op" id="5977742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5977747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5977752">for</span>&nbsp;<span class="ident" id="5977756">i</span>&nbsp;<span class="op" id="5977758">:=</span>&nbsp;<span class="num" id="5977761">0</span><span class="op" id="5977762">;</span>&nbsp;<span class="ident" id="5977764">i</span>&nbsp;<span class="op" id="5977766">&lt;</span>&nbsp;<span class="ident" id="5977768">repeat</span><span class="op" id="5977774">;</span>&nbsp;<span class="ident" id="5977776">i</span><span class="op" id="5977777">++</span>&nbsp;<span class="op" id="5977780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5977786">b</span>&nbsp;<span class="op" id="5977788">:=</span>&nbsp;<span class="builtintype" id="5977791">byte</span><span class="op" id="5977795">(</span><span class="ident" id="5977796">mtf</span><span class="op" id="5977799">.</span><span class="ident" id="5977800">First</span><span class="op" id="5977805">(</span><span class="op" id="5977806">)</span><span class="op" id="5977807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5977813">bz2</span><span class="op" id="5977816">.</span><span class="ident" id="5977817">tt</span><span class="op" id="5977819">[</span><span class="ident" id="5977820">bufIndex</span><span class="op" id="5977828">]</span>&nbsp;<span class="op" id="5977830">=</span>&nbsp;<span class="builtintype" id="5977832">uint32</span><span class="op" id="5977838">(</span><span class="ident" id="5977839">b</span><span class="op" id="5977840">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5977846">bz2</span><span class="op" id="5977849">.</span><span class="ident" id="5977850">c</span><span class="op" id="5977851">[</span><span class="ident" id="5977852">b</span><span class="op" id="5977853">]</span><span class="op" id="5977854">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5977861">bufIndex</span><span class="op" id="5977869">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5977875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5977880">repeat</span>&nbsp;<span class="op" id="5977887">=</span>&nbsp;<span class="num" id="5977889">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5977893">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5977898">if</span>&nbsp;<span class="builtintype" id="5977901">int</span><span class="op" id="5977904">(</span><span class="ident" id="5977905">v</span><span class="op" id="5977906">)</span>&nbsp;<span class="op" id="5977908">==</span>&nbsp;<span class="ident" id="5977911">numSymbols</span><span class="op" id="5977921">-</span><span class="num" id="5977922">1</span>&nbsp;<span class="op" id="5977924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5977929">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5977986">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5978044">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5978090">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5978098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5978103">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5978167">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5978228">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5978294">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5978353">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5978415">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5978426">b</span>&nbsp;<span class="op" id="5978428">:=</span>&nbsp;<span class="builtintype" id="5978431">byte</span><span class="op" id="5978435">(</span><span class="ident" id="5978436">mtf</span><span class="op" id="5978439">.</span><span class="ident" id="5978440">Decode</span><span class="op" id="5978446">(</span><span class="builtintype" id="5978447">int</span><span class="op" id="5978450">(</span><span class="ident" id="5978451">v</span>&nbsp;<span class="op" id="5978453">-</span>&nbsp;<span class="num" id="5978455">1</span><span class="op" id="5978456">)</span><span class="op" id="5978457">)</span><span class="op" id="5978458">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5978462">if</span>&nbsp;<span class="ident" id="5978465">bufIndex</span>&nbsp;<span class="op" id="5978474">&gt;=</span>&nbsp;<span class="ident" id="5978477">bz2</span><span class="op" id="5978480">.</span><span class="ident" id="5978481">blockSize</span>&nbsp;<span class="op" id="5978491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5978496">return</span>&nbsp;<span class="ident" id="5978503">StructuralError</span><span class="op" id="5978518">(</span><span class="string" id="5978519">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op" id="5978544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5978548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5978552">bz2</span><span class="op" id="5978555">.</span><span class="ident" id="5978556">tt</span><span class="op" id="5978558">[</span><span class="ident" id="5978559">bufIndex</span><span class="op" id="5978567">]</span>&nbsp;<span class="op" id="5978569">=</span>&nbsp;<span class="builtintype" id="5978571">uint32</span><span class="op" id="5978577">(</span><span class="ident" id="5978578">b</span><span class="op" id="5978579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5978583">bz2</span><span class="op" id="5978586">.</span><span class="ident" id="5978587">c</span><span class="op" id="5978588">[</span><span class="ident" id="5978589">b</span><span class="op" id="5978590">]</span><span class="op" id="5978591">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5978596">bufIndex</span><span class="op" id="5978604">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5978608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5978612">if</span>&nbsp;<span class="ident" id="5978615">origPtr</span>&nbsp;<span class="op" id="5978623">&gt;=</span>&nbsp;<span class="builtintype" id="5978626">uint</span><span class="op" id="5978630">(</span><span class="ident" id="5978631">bufIndex</span><span class="op" id="5978639">)</span>&nbsp;<span class="op" id="5978641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5978645">return</span>&nbsp;<span class="ident" id="5978652">StructuralError</span><span class="op" id="5978667">(</span><span class="string" id="5978668">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op" id="5978691">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5978694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5978698">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5978765">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5978807">bz2</span><span class="op" id="5978810">.</span><span class="ident" id="5978811">preRLE</span>&nbsp;<span class="op" id="5978818">=</span>&nbsp;<span class="ident" id="5978820">bz2</span><span class="op" id="5978823">.</span><span class="ident" id="5978824">tt</span><span class="op" id="5978826">[</span><span class="op" id="5978827">:</span><span class="ident" id="5978828">bufIndex</span><span class="op" id="5978836">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5978839">bz2</span><span class="op" id="5978842">.</span><span class="ident" id="5978843">preRLEUsed</span>&nbsp;<span class="op" id="5978854">=</span>&nbsp;<span class="num" id="5978856">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5978859">bz2</span><span class="op" id="5978862">.</span><span class="ident" id="5978863">tPos</span>&nbsp;<span class="op" id="5978868">=</span>&nbsp;<span class="ident" id="5978870">inverseBWT</span><span class="op" id="5978880">(</span><span class="ident" id="5978881">bz2</span><span class="op" id="5978884">.</span><span class="ident" id="5978885">preRLE</span><span class="op" id="5978891">,</span>&nbsp;<span class="ident" id="5978893">origPtr</span><span class="op" id="5978900">,</span>&nbsp;<span class="ident" id="5978902">bz2</span><span class="op" id="5978905">.</span><span class="ident" id="5978906">c</span><span class="op" id="5978907">[</span><span class="op" id="5978908">:</span><span class="op" id="5978909">]</span><span class="op" id="5978910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5978913">bz2</span><span class="op" id="5978916">.</span><span class="ident" id="5978917">lastByte</span>&nbsp;<span class="op" id="5978926">=</span>&nbsp;<span class="op" id="5978928">-</span><span class="num" id="5978929">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5978932">bz2</span><span class="op" id="5978935">.</span><span class="ident" id="5978936">byteRepeats</span>&nbsp;<span class="op" id="5978948">=</span>&nbsp;<span class="num" id="5978950">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5978953">bz2</span><span class="op" id="5978956">.</span><span class="ident" id="5978957">repeats</span>&nbsp;<span class="op" id="5978965">=</span>&nbsp;<span class="num" id="5978967">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5978971">return</span>&nbsp;<span class="builtintype" id="5978978">nil</span><br>
<span class="lineno"></span><span class="op" id="5978982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5978985">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment" id="5979064">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment" id="5979141">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5979217">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5979295">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment" id="5979330">//</span><br>
<span class="lineno">455</span><span class="comment" id="5979333">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="5979410">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5979490">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5979567">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5979580">func</span>&nbsp;<span class="ident" id="5979585">inverseBWT</span><span class="op" id="5979595">(</span><span class="ident" id="5979596">tt</span>&nbsp;<span class="op" id="5979599">[</span><span class="op" id="5979600">]</span><span class="builtintype" id="5979601">uint32</span><span class="op" id="5979607">,</span>&nbsp;<span class="ident" id="5979609">origPtr</span>&nbsp;<span class="builtintype" id="5979617">uint</span><span class="op" id="5979621">,</span>&nbsp;<span class="ident" id="5979623">c</span>&nbsp;<span class="op" id="5979625">[</span><span class="op" id="5979626">]</span><span class="builtintype" id="5979627">uint</span><span class="op" id="5979631">)</span>&nbsp;<span class="builtintype" id="5979633">uint32</span>&nbsp;<span class="op" id="5979640">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5979643">sum</span>&nbsp;<span class="op" id="5979647">:=</span>&nbsp;<span class="builtintype" id="5979650">uint</span><span class="op" id="5979654">(</span><span class="num" id="5979655">0</span><span class="op" id="5979656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5979659">for</span>&nbsp;<span class="ident" id="5979663">i</span>&nbsp;<span class="op" id="5979665">:=</span>&nbsp;<span class="num" id="5979668">0</span><span class="op" id="5979669">;</span>&nbsp;<span class="ident" id="5979671">i</span>&nbsp;<span class="op" id="5979673">&lt;</span>&nbsp;<span class="num" id="5979675">256</span><span class="op" id="5979678">;</span>&nbsp;<span class="ident" id="5979680">i</span><span class="op" id="5979681">++</span>&nbsp;<span class="op" id="5979684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5979688">sum</span>&nbsp;<span class="op" id="5979692">+=</span>&nbsp;<span class="ident" id="5979695">c</span><span class="op" id="5979696">[</span><span class="ident" id="5979697">i</span><span class="op" id="5979698">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5979702">c</span><span class="op" id="5979703">[</span><span class="ident" id="5979704">i</span><span class="op" id="5979705">]</span>&nbsp;<span class="op" id="5979707">=</span>&nbsp;<span class="ident" id="5979709">sum</span>&nbsp;<span class="op" id="5979713">-</span>&nbsp;<span class="ident" id="5979715">c</span><span class="op" id="5979716">[</span><span class="ident" id="5979717">i</span><span class="op" id="5979718">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5979721">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5979725">for</span>&nbsp;<span class="ident" id="5979729">i</span>&nbsp;<span class="op" id="5979731">:=</span>&nbsp;<span class="keyword" id="5979734">range</span>&nbsp;<span class="ident" id="5979740">tt</span>&nbsp;<span class="op" id="5979743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5979747">b</span>&nbsp;<span class="op" id="5979749">:=</span>&nbsp;<span class="ident" id="5979752">tt</span><span class="op" id="5979754">[</span><span class="ident" id="5979755">i</span><span class="op" id="5979756">]</span>&nbsp;<span class="op" id="5979758">&amp;</span>&nbsp;<span class="num" id="5979760">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5979767">tt</span><span class="op" id="5979769">[</span><span class="ident" id="5979770">c</span><span class="op" id="5979771">[</span><span class="ident" id="5979772">b</span><span class="op" id="5979773">]</span><span class="op" id="5979774">]</span>&nbsp;<span class="op" id="5979776">|=</span>&nbsp;<span class="builtintype" id="5979779">uint32</span><span class="op" id="5979785">(</span><span class="ident" id="5979786">i</span><span class="op" id="5979787">)</span>&nbsp;<span class="op" id="5979789">&lt;&lt;</span>&nbsp;<span class="num" id="5979792">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5979796">c</span><span class="op" id="5979797">[</span><span class="ident" id="5979798">b</span><span class="op" id="5979799">]</span><span class="op" id="5979800">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5979804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5979808">return</span>&nbsp;<span class="ident" id="5979815">tt</span><span class="op" id="5979817">[</span><span class="ident" id="5979818">origPtr</span><span class="op" id="5979825">]</span>&nbsp;<span class="op" id="5979827">&gt;&gt;</span>&nbsp;<span class="num" id="5979830">8</span><br>
<span class="lineno"></span><span class="op" id="5979832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment" id="5979835">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment" id="5979923">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5980008">var</span>&nbsp;<span class="ident" id="5980012">crctab</span>&nbsp;<span class="op" id="5980019">[</span><span class="num" id="5980020">256</span><span class="op" id="5980023">]</span><span class="builtintype" id="5980024">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword" id="5980032">func</span>&nbsp;<span class="ident" id="5980037">init</span><span class="op" id="5980041">(</span><span class="op" id="5980042">)</span>&nbsp;<span class="op" id="5980044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5980047">const</span>&nbsp;<span class="ident" id="5980053">poly</span>&nbsp;<span class="op" id="5980058">=</span>&nbsp;<span class="num" id="5980060">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5980072">for</span>&nbsp;<span class="ident" id="5980076">i</span>&nbsp;<span class="op" id="5980078">:=</span>&nbsp;<span class="keyword" id="5980081">range</span>&nbsp;<span class="ident" id="5980087">crctab</span>&nbsp;<span class="op" id="5980094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5980098">crc</span>&nbsp;<span class="op" id="5980102">:=</span>&nbsp;<span class="builtintype" id="5980105">uint32</span><span class="op" id="5980111">(</span><span class="ident" id="5980112">i</span><span class="op" id="5980113">)</span>&nbsp;<span class="op" id="5980115">&lt;&lt;</span>&nbsp;<span class="num" id="5980118">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5980123">for</span>&nbsp;<span class="ident" id="5980127">j</span>&nbsp;<span class="op" id="5980129">:=</span>&nbsp;<span class="num" id="5980132">0</span><span class="op" id="5980133">;</span>&nbsp;<span class="ident" id="5980135">j</span>&nbsp;<span class="op" id="5980137">&lt;</span>&nbsp;<span class="num" id="5980139">8</span><span class="op" id="5980140">;</span>&nbsp;<span class="ident" id="5980142">j</span><span class="op" id="5980143">++</span>&nbsp;<span class="op" id="5980146">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5980151">if</span>&nbsp;<span class="ident" id="5980154">crc</span><span class="op" id="5980157">&amp;</span><span class="num" id="5980158">0x80000000</span>&nbsp;<span class="op" id="5980169">!=</span>&nbsp;<span class="num" id="5980172">0</span>&nbsp;<span class="op" id="5980174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5980180">crc</span>&nbsp;<span class="op" id="5980184">=</span>&nbsp;<span class="op" id="5980186">(</span><span class="ident" id="5980187">crc</span>&nbsp;<span class="op" id="5980191">&lt;&lt;</span>&nbsp;<span class="num" id="5980194">1</span><span class="op" id="5980195">)</span>&nbsp;<span class="op" id="5980197">^</span>&nbsp;<span class="ident" id="5980199">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5980207">}</span>&nbsp;<span class="keyword" id="5980209">else</span>&nbsp;<span class="op" id="5980214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5980220">crc</span>&nbsp;<span class="op" id="5980224">&lt;&lt;=</span>&nbsp;<span class="num" id="5980228">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5980233">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5980237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5980241">crctab</span><span class="op" id="5980247">[</span><span class="ident" id="5980248">i</span><span class="op" id="5980249">]</span>&nbsp;<span class="op" id="5980251">=</span>&nbsp;<span class="ident" id="5980253">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5980258">}</span><br>
<span class="lineno"></span><span class="op" id="5980260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="5980263">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="5980328">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="5980355">func</span>&nbsp;<span class="ident" id="5980360">updateCRC</span><span class="op" id="5980369">(</span><span class="ident" id="5980370">val</span>&nbsp;<span class="builtintype" id="5980374">uint32</span><span class="op" id="5980380">,</span>&nbsp;<span class="ident" id="5980382">b</span>&nbsp;<span class="op" id="5980384">[</span><span class="op" id="5980385">]</span><span class="builtintype" id="5980386">byte</span><span class="op" id="5980390">)</span>&nbsp;<span class="builtintype" id="5980392">uint32</span>&nbsp;<span class="op" id="5980399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5980402">crc</span>&nbsp;<span class="op" id="5980406">:=</span>&nbsp;<span class="op" id="5980409">^</span><span class="ident" id="5980410">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5980415">for</span>&nbsp;<span class="ident" id="5980419">_</span><span class="op" id="5980420">,</span>&nbsp;<span class="ident" id="5980422">v</span>&nbsp;<span class="op" id="5980424">:=</span>&nbsp;<span class="keyword" id="5980427">range</span>&nbsp;<span class="ident" id="5980433">b</span>&nbsp;<span class="op" id="5980435">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5980439">crc</span>&nbsp;<span class="op" id="5980443">=</span>&nbsp;<span class="ident" id="5980445">crctab</span><span class="op" id="5980451">[</span><span class="builtintype" id="5980452">byte</span><span class="op" id="5980456">(</span><span class="ident" id="5980457">crc</span><span class="op" id="5980460">&gt;&gt;</span><span class="num" id="5980462">24</span><span class="op" id="5980464">)</span><span class="op" id="5980465">^</span><span class="ident" id="5980466">v</span><span class="op" id="5980467">]</span>&nbsp;<span class="op" id="5980469">^</span>&nbsp;<span class="op" id="5980471">(</span><span class="ident" id="5980472">crc</span>&nbsp;<span class="op" id="5980476">&lt;&lt;</span>&nbsp;<span class="num" id="5980479">8</span><span class="op" id="5980480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5980483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5980486">return</span>&nbsp;<span class="op" id="5980493">^</span><span class="ident" id="5980494">crc</span><br>
<span class="lineno"></span><span class="op" id="5980498">}</span>
</div>
</body>
</html>
