<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html" class="current">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7166112">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7166167">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7166221">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7166272">package</span>&nbsp;<span class="ident" id="7166280">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7166286">import</span>&nbsp;<span class="op" id="7166293">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166296">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166305">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166312">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166321">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166336">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166342">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166355">&#34;math/rand&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166368">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166374">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166385">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7166395">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="7166398">//&nbsp;TestDecodeProgressive&nbsp;tests&nbsp;that&nbsp;decoding&nbsp;the&nbsp;baseline&nbsp;and&nbsp;progressive</span><br>
<span class="lineno"></span><span class="comment" id="7166472">//&nbsp;versions&nbsp;of&nbsp;the&nbsp;same&nbsp;image&nbsp;result&nbsp;in&nbsp;exactly&nbsp;the&nbsp;same&nbsp;pixel&nbsp;data,&nbsp;in&nbsp;YCbCr</span><br>
<span class="lineno"></span><span class="comment" id="7166550">//&nbsp;space&nbsp;for&nbsp;color&nbsp;images,&nbsp;and&nbsp;Y&nbsp;space&nbsp;for&nbsp;grayscale&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="7166611">func</span>&nbsp;<span class="ident" id="7166616">TestDecodeProgressive</span><span class="op" id="7166637">(</span><span class="ident" id="7166638">t</span>&nbsp;<span class="op" id="7166640">*</span><span class="ident" id="7166641">testing</span><span class="op" id="7166648">.</span><span class="ident" id="7166649">T</span><span class="op" id="7166650">)</span>&nbsp;<span class="op" id="7166652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7166655">testCases</span>&nbsp;<span class="op" id="7166665">:=</span>&nbsp;<span class="op" id="7166668">[</span><span class="op" id="7166669">]</span><span class="builtintype" id="7166670">string</span><span class="op" id="7166676">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166680">&#34;../testdata/video-001&#34;</span><span class="op" id="7166703">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166707">&#34;../testdata/video-001.q50.420&#34;</span><span class="op" id="7166738">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166742">&#34;../testdata/video-001.q50.422&#34;</span><span class="op" id="7166773">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166777">&#34;../testdata/video-001.q50.440&#34;</span><span class="op" id="7166808">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166812">&#34;../testdata/video-001.q50.444&#34;</span><span class="op" id="7166843">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166847">&#34;../testdata/video-005.gray.q50&#34;</span><span class="op" id="7166879">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166883">&#34;../testdata/video-005.gray.q50.2x2&#34;</span><span class="op" id="7166919">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7166923">&#34;../testdata/video-001.separate.dc.progression&#34;</span><span class="op" id="7166970">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7166973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7166976">for</span>&nbsp;<span class="ident" id="7166980">_</span><span class="op" id="7166981">,</span>&nbsp;<span class="ident" id="7166983">tc</span>&nbsp;<span class="op" id="7166986">:=</span>&nbsp;<span class="keyword" id="7166989">range</span>&nbsp;<span class="ident" id="7166995">testCases</span>&nbsp;<span class="op" id="7167005">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7167009">m0</span><span class="op" id="7167011">,</span>&nbsp;<span class="ident" id="7167013">err</span>&nbsp;<span class="op" id="7167017">:=</span>&nbsp;<span class="ident" id="7167020">decodeFile</span><span class="op" id="7167030">(</span><span class="ident" id="7167031">tc</span>&nbsp;<span class="op" id="7167034">+</span>&nbsp;<span class="string" id="7167036">&#34;.jpeg&#34;</span><span class="op" id="7167043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167047">if</span>&nbsp;<span class="ident" id="7167050">err</span>&nbsp;<span class="op" id="7167054">!=</span>&nbsp;<span class="ident" id="7167057">nil</span>&nbsp;<span class="op" id="7167061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7167066">t</span><span class="op" id="7167067">.</span><span class="ident" id="7167068">Errorf</span><span class="op" id="7167074">(</span><span class="string" id="7167075">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7167083">,</span>&nbsp;<span class="ident" id="7167085">tc</span><span class="op" id="7167087">+</span><span class="string" id="7167088">&#34;.jpeg&#34;</span><span class="op" id="7167095">,</span>&nbsp;<span class="ident" id="7167097">err</span><span class="op" id="7167100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167105">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7167116">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7167120">m1</span><span class="op" id="7167122">,</span>&nbsp;<span class="ident" id="7167124">err</span>&nbsp;<span class="op" id="7167128">:=</span>&nbsp;<span class="ident" id="7167131">decodeFile</span><span class="op" id="7167141">(</span><span class="ident" id="7167142">tc</span>&nbsp;<span class="op" id="7167145">+</span>&nbsp;<span class="string" id="7167147">&#34;.progressive.jpeg&#34;</span><span class="op" id="7167166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167170">if</span>&nbsp;<span class="ident" id="7167173">err</span>&nbsp;<span class="op" id="7167177">!=</span>&nbsp;<span class="ident" id="7167180">nil</span>&nbsp;<span class="op" id="7167184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7167189">t</span><span class="op" id="7167190">.</span><span class="ident" id="7167191">Errorf</span><span class="op" id="7167197">(</span><span class="string" id="7167198">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7167206">,</span>&nbsp;<span class="ident" id="7167208">tc</span><span class="op" id="7167210">+</span><span class="string" id="7167211">&#34;.progressive.jpeg&#34;</span><span class="op" id="7167230">,</span>&nbsp;<span class="ident" id="7167232">err</span><span class="op" id="7167235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167240">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7167251">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167255">if</span>&nbsp;<span class="ident" id="7167258">m0</span><span class="op" id="7167260">.</span><span class="ident" id="7167261">Bounds</span><span class="op" id="7167267">(</span><span class="op" id="7167268">)</span>&nbsp;<span class="op" id="7167270">!=</span>&nbsp;<span class="ident" id="7167273">m1</span><span class="op" id="7167275">.</span><span class="ident" id="7167276">Bounds</span><span class="op" id="7167282">(</span><span class="op" id="7167283">)</span>&nbsp;<span class="op" id="7167285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7167290">t</span><span class="op" id="7167291">.</span><span class="ident" id="7167292">Errorf</span><span class="op" id="7167298">(</span><span class="string" id="7167299">&#34;%s:&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7167329">,</span>&nbsp;<span class="ident" id="7167331">tc</span><span class="op" id="7167333">,</span>&nbsp;<span class="ident" id="7167335">m0</span><span class="op" id="7167337">.</span><span class="ident" id="7167338">Bounds</span><span class="op" id="7167344">(</span><span class="op" id="7167345">)</span><span class="op" id="7167346">,</span>&nbsp;<span class="ident" id="7167348">m1</span><span class="op" id="7167350">.</span><span class="ident" id="7167351">Bounds</span><span class="op" id="7167357">(</span><span class="op" id="7167358">)</span><span class="op" id="7167359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167364">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7167375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7167379">//&nbsp;All&nbsp;of&nbsp;the&nbsp;video-*.jpeg&nbsp;files&nbsp;are&nbsp;150x103.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167427">if</span>&nbsp;<span class="ident" id="7167430">m0</span><span class="op" id="7167432">.</span><span class="ident" id="7167433">Bounds</span><span class="op" id="7167439">(</span><span class="op" id="7167440">)</span>&nbsp;<span class="op" id="7167442">!=</span>&nbsp;<span class="ident" id="7167445">image</span><span class="op" id="7167450">.</span><span class="ident" id="7167451">Rect</span><span class="op" id="7167455">(</span><span class="num" id="7167456">0</span><span class="op" id="7167457">,</span>&nbsp;<span class="num" id="7167459">0</span><span class="op" id="7167460">,</span>&nbsp;<span class="num" id="7167462">150</span><span class="op" id="7167465">,</span>&nbsp;<span class="num" id="7167467">103</span><span class="op" id="7167470">)</span>&nbsp;<span class="op" id="7167472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7167477">t</span><span class="op" id="7167478">.</span><span class="ident" id="7167479">Errorf</span><span class="op" id="7167485">(</span><span class="string" id="7167486">&#34;%s:&nbsp;bad&nbsp;bounds:&nbsp;%v&#34;</span><span class="op" id="7167506">,</span>&nbsp;<span class="ident" id="7167508">tc</span><span class="op" id="7167510">,</span>&nbsp;<span class="ident" id="7167512">m0</span><span class="op" id="7167514">.</span><span class="ident" id="7167515">Bounds</span><span class="op" id="7167521">(</span><span class="op" id="7167522">)</span><span class="op" id="7167523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167528">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7167539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167544">switch</span>&nbsp;<span class="ident" id="7167551">m0</span>&nbsp;<span class="op" id="7167554">:=</span>&nbsp;<span class="ident" id="7167557">m0</span><span class="op" id="7167559">.</span><span class="op" id="7167560">(</span><span class="keyword" id="7167561">type</span><span class="op" id="7167565">)</span>&nbsp;<span class="op" id="7167567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167571">case</span>&nbsp;<span class="op" id="7167576">*</span><span class="ident" id="7167577">image</span><span class="op" id="7167582">.</span><span class="ident" id="7167583">YCbCr</span><span class="op" id="7167588">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7167593">m1</span>&nbsp;<span class="op" id="7167596">:=</span>&nbsp;<span class="ident" id="7167599">m1</span><span class="op" id="7167601">.</span><span class="op" id="7167602">(</span><span class="op" id="7167603">*</span><span class="ident" id="7167604">image</span><span class="op" id="7167609">.</span><span class="ident" id="7167610">YCbCr</span><span class="op" id="7167615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167620">if</span>&nbsp;<span class="ident" id="7167623">err</span>&nbsp;<span class="op" id="7167627">:=</span>&nbsp;<span class="ident" id="7167630">check</span><span class="op" id="7167635">(</span><span class="ident" id="7167636">m0</span><span class="op" id="7167638">.</span><span class="ident" id="7167639">Bounds</span><span class="op" id="7167645">(</span><span class="op" id="7167646">)</span><span class="op" id="7167647">,</span>&nbsp;<span class="ident" id="7167649">m0</span><span class="op" id="7167651">.</span><span class="ident" id="7167652">Y</span><span class="op" id="7167653">,</span>&nbsp;<span class="ident" id="7167655">m1</span><span class="op" id="7167657">.</span><span class="ident" id="7167658">Y</span><span class="op" id="7167659">,</span>&nbsp;<span class="ident" id="7167661">m0</span><span class="op" id="7167663">.</span><span class="ident" id="7167664">YStride</span><span class="op" id="7167671">,</span>&nbsp;<span class="ident" id="7167673">m1</span><span class="op" id="7167675">.</span><span class="ident" id="7167676">YStride</span><span class="op" id="7167683">)</span><span class="op" id="7167684">;</span>&nbsp;<span class="ident" id="7167686">err</span>&nbsp;<span class="op" id="7167690">!=</span>&nbsp;<span class="ident" id="7167693">nil</span>&nbsp;<span class="op" id="7167697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7167703">t</span><span class="op" id="7167704">.</span><span class="ident" id="7167705">Errorf</span><span class="op" id="7167711">(</span><span class="string" id="7167712">&#34;%s&nbsp;(Y):&nbsp;%v&#34;</span><span class="op" id="7167724">,</span>&nbsp;<span class="ident" id="7167726">tc</span><span class="op" id="7167728">,</span>&nbsp;<span class="ident" id="7167730">err</span><span class="op" id="7167733">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167739">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7167751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167756">if</span>&nbsp;<span class="ident" id="7167759">err</span>&nbsp;<span class="op" id="7167763">:=</span>&nbsp;<span class="ident" id="7167766">check</span><span class="op" id="7167771">(</span><span class="ident" id="7167772">m0</span><span class="op" id="7167774">.</span><span class="ident" id="7167775">Bounds</span><span class="op" id="7167781">(</span><span class="op" id="7167782">)</span><span class="op" id="7167783">,</span>&nbsp;<span class="ident" id="7167785">m0</span><span class="op" id="7167787">.</span><span class="ident" id="7167788">Cb</span><span class="op" id="7167790">,</span>&nbsp;<span class="ident" id="7167792">m1</span><span class="op" id="7167794">.</span><span class="ident" id="7167795">Cb</span><span class="op" id="7167797">,</span>&nbsp;<span class="ident" id="7167799">m0</span><span class="op" id="7167801">.</span><span class="ident" id="7167802">CStride</span><span class="op" id="7167809">,</span>&nbsp;<span class="ident" id="7167811">m1</span><span class="op" id="7167813">.</span><span class="ident" id="7167814">CStride</span><span class="op" id="7167821">)</span><span class="op" id="7167822">;</span>&nbsp;<span class="ident" id="7167824">err</span>&nbsp;<span class="op" id="7167828">!=</span>&nbsp;<span class="ident" id="7167831">nil</span>&nbsp;<span class="op" id="7167835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7167841">t</span><span class="op" id="7167842">.</span><span class="ident" id="7167843">Errorf</span><span class="op" id="7167849">(</span><span class="string" id="7167850">&#34;%s&nbsp;(Cb):&nbsp;%v&#34;</span><span class="op" id="7167863">,</span>&nbsp;<span class="ident" id="7167865">tc</span><span class="op" id="7167867">,</span>&nbsp;<span class="ident" id="7167869">err</span><span class="op" id="7167872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167878">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7167890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7167895">if</span>&nbsp;<span class="ident" id="7167898">err</span>&nbsp;<span class="op" id="7167902">:=</span>&nbsp;<span class="ident" id="7167905">check</span><span class="op" id="7167910">(</span><span class="ident" id="7167911">m0</span><span class="op" id="7167913">.</span><span class="ident" id="7167914">Bounds</span><span class="op" id="7167920">(</span><span class="op" id="7167921">)</span><span class="op" id="7167922">,</span>&nbsp;<span class="ident" id="7167924">m0</span><span class="op" id="7167926">.</span><span class="ident" id="7167927">Cr</span><span class="op" id="7167929">,</span>&nbsp;<span class="ident" id="7167931">m1</span><span class="op" id="7167933">.</span><span class="ident" id="7167934">Cr</span><span class="op" id="7167936">,</span>&nbsp;<span class="ident" id="7167938">m0</span><span class="op" id="7167940">.</span><span class="ident" id="7167941">CStride</span><span class="op" id="7167948">,</span>&nbsp;<span class="ident" id="7167950">m1</span><span class="op" id="7167952">.</span><span class="ident" id="7167953">CStride</span><span class="op" id="7167960">)</span><span class="op" id="7167961">;</span>&nbsp;<span class="ident" id="7167963">err</span>&nbsp;<span class="op" id="7167967">!=</span>&nbsp;<span class="ident" id="7167970">nil</span>&nbsp;<span class="op" id="7167974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7167980">t</span><span class="op" id="7167981">.</span><span class="ident" id="7167982">Errorf</span><span class="op" id="7167988">(</span><span class="string" id="7167989">&#34;%s&nbsp;(Cr):&nbsp;%v&#34;</span><span class="op" id="7168002">,</span>&nbsp;<span class="ident" id="7168004">tc</span><span class="op" id="7168006">,</span>&nbsp;<span class="ident" id="7168008">err</span><span class="op" id="7168011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168017">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7168029">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168033">case</span>&nbsp;<span class="op" id="7168038">*</span><span class="ident" id="7168039">image</span><span class="op" id="7168044">.</span><span class="ident" id="7168045">Gray</span><span class="op" id="7168049">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7168054">m1</span>&nbsp;<span class="op" id="7168057">:=</span>&nbsp;<span class="ident" id="7168060">m1</span><span class="op" id="7168062">.</span><span class="op" id="7168063">(</span><span class="op" id="7168064">*</span><span class="ident" id="7168065">image</span><span class="op" id="7168070">.</span><span class="ident" id="7168071">Gray</span><span class="op" id="7168075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168080">if</span>&nbsp;<span class="ident" id="7168083">err</span>&nbsp;<span class="op" id="7168087">:=</span>&nbsp;<span class="ident" id="7168090">check</span><span class="op" id="7168095">(</span><span class="ident" id="7168096">m0</span><span class="op" id="7168098">.</span><span class="ident" id="7168099">Bounds</span><span class="op" id="7168105">(</span><span class="op" id="7168106">)</span><span class="op" id="7168107">,</span>&nbsp;<span class="ident" id="7168109">m0</span><span class="op" id="7168111">.</span><span class="ident" id="7168112">Pix</span><span class="op" id="7168115">,</span>&nbsp;<span class="ident" id="7168117">m1</span><span class="op" id="7168119">.</span><span class="ident" id="7168120">Pix</span><span class="op" id="7168123">,</span>&nbsp;<span class="ident" id="7168125">m0</span><span class="op" id="7168127">.</span><span class="ident" id="7168128">Stride</span><span class="op" id="7168134">,</span>&nbsp;<span class="ident" id="7168136">m1</span><span class="op" id="7168138">.</span><span class="ident" id="7168139">Stride</span><span class="op" id="7168145">)</span><span class="op" id="7168146">;</span>&nbsp;<span class="ident" id="7168148">err</span>&nbsp;<span class="op" id="7168152">!=</span>&nbsp;<span class="ident" id="7168155">nil</span>&nbsp;<span class="op" id="7168159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7168165">t</span><span class="op" id="7168166">.</span><span class="ident" id="7168167">Errorf</span><span class="op" id="7168173">(</span><span class="string" id="7168174">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7168182">,</span>&nbsp;<span class="ident" id="7168184">tc</span><span class="op" id="7168186">,</span>&nbsp;<span class="ident" id="7168188">err</span><span class="op" id="7168191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168197">continue</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7168209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168213">default</span><span class="op" id="7168220">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7168225">t</span><span class="op" id="7168226">.</span><span class="ident" id="7168227">Errorf</span><span class="op" id="7168233">(</span><span class="string" id="7168234">&#34;%s:&nbsp;unexpected&nbsp;image&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7168264">,</span>&nbsp;<span class="ident" id="7168266">tc</span><span class="op" id="7168268">,</span>&nbsp;<span class="ident" id="7168270">m0</span><span class="op" id="7168272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168277">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7168288">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7168291">}</span><br>
<span class="lineno"></span><span class="op" id="7168293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7168296">func</span>&nbsp;<span class="ident" id="7168301">decodeFile</span><span class="op" id="7168311">(</span><span class="ident" id="7168312">filename</span>&nbsp;<span class="builtintype" id="7168321">string</span><span class="op" id="7168327">)</span>&nbsp;<span class="op" id="7168329">(</span><span class="ident" id="7168330">image</span><span class="op" id="7168335">.</span><span class="ident" id="7168336">Image</span><span class="op" id="7168341">,</span>&nbsp;<span class="builtintype" id="7168343">error</span><span class="op" id="7168348">)</span>&nbsp;<span class="op" id="7168350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7168353">f</span><span class="op" id="7168354">,</span>&nbsp;<span class="ident" id="7168356">err</span>&nbsp;<span class="op" id="7168360">:=</span>&nbsp;<span class="ident" id="7168363">os</span><span class="op" id="7168365">.</span><span class="ident" id="7168366">Open</span><span class="op" id="7168370">(</span><span class="ident" id="7168371">filename</span><span class="op" id="7168379">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168382">if</span>&nbsp;<span class="ident" id="7168385">err</span>&nbsp;<span class="op" id="7168389">!=</span>&nbsp;<span class="ident" id="7168392">nil</span>&nbsp;<span class="op" id="7168396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168400">return</span>&nbsp;<span class="ident" id="7168407">nil</span><span class="op" id="7168410">,</span>&nbsp;<span class="ident" id="7168412">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7168417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168420">defer</span>&nbsp;<span class="ident" id="7168426">f</span><span class="op" id="7168427">.</span><span class="ident" id="7168428">Close</span><span class="op" id="7168433">(</span><span class="op" id="7168434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168437">return</span>&nbsp;<span class="ident" id="7168444">Decode</span><span class="op" id="7168450">(</span><span class="ident" id="7168451">f</span><span class="op" id="7168452">)</span><br>
<span class="lineno">90</span><span class="op" id="7168454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7168457">type</span>&nbsp;<span class="ident" id="7168462">eofReader</span>&nbsp;<span class="keyword" id="7168472">struct</span>&nbsp;<span class="op" id="7168479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7168482">data</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7168491">[</span><span class="op" id="7168492">]</span><span class="builtintype" id="7168493">byte</span>&nbsp;<span class="comment" id="7168498">//&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;without&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7168532">dataEOF</span>&nbsp;&nbsp;<span class="op" id="7168541">[</span><span class="op" id="7168542">]</span><span class="builtintype" id="7168543">byte</span>&nbsp;<span class="comment" id="7168548">//&nbsp;then&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;with&nbsp;EOF&nbsp;on&nbsp;last&nbsp;chunk</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7168598">lenAtEOF</span>&nbsp;<span class="builtintype" id="7168607">int</span><br>
<span class="lineno"></span><span class="op" id="7168611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7168614">func</span>&nbsp;<span class="op" id="7168619">(</span><span class="ident" id="7168620">r</span>&nbsp;<span class="op" id="7168622">*</span><span class="ident" id="7168623">eofReader</span><span class="op" id="7168632">)</span>&nbsp;<span class="ident" id="7168634">Read</span><span class="op" id="7168638">(</span><span class="ident" id="7168639">b</span>&nbsp;<span class="op" id="7168641">[</span><span class="op" id="7168642">]</span><span class="builtintype" id="7168643">byte</span><span class="op" id="7168647">)</span>&nbsp;<span class="op" id="7168649">(</span><span class="ident" id="7168650">n</span>&nbsp;<span class="builtintype" id="7168652">int</span><span class="op" id="7168655">,</span>&nbsp;<span class="ident" id="7168657">err</span>&nbsp;<span class="builtintype" id="7168661">error</span><span class="op" id="7168666">)</span>&nbsp;<span class="op" id="7168668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168671">if</span>&nbsp;<span class="builtinfunc" id="7168674">len</span><span class="op" id="7168677">(</span><span class="ident" id="7168678">r</span><span class="op" id="7168679">.</span><span class="ident" id="7168680">data</span><span class="op" id="7168684">)</span>&nbsp;<span class="op" id="7168686">&gt;</span>&nbsp;<span class="num" id="7168688">0</span>&nbsp;<span class="op" id="7168690">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7168694">n</span>&nbsp;<span class="op" id="7168696">=</span>&nbsp;<span class="builtinfunc" id="7168698">copy</span><span class="op" id="7168702">(</span><span class="ident" id="7168703">b</span><span class="op" id="7168704">,</span>&nbsp;<span class="ident" id="7168706">r</span><span class="op" id="7168707">.</span><span class="ident" id="7168708">data</span><span class="op" id="7168712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7168716">r</span><span class="op" id="7168717">.</span><span class="ident" id="7168718">data</span>&nbsp;<span class="op" id="7168723">=</span>&nbsp;<span class="ident" id="7168725">r</span><span class="op" id="7168726">.</span><span class="ident" id="7168727">data</span><span class="op" id="7168731">[</span><span class="ident" id="7168732">n</span><span class="op" id="7168733">:</span><span class="op" id="7168734">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7168737">}</span>&nbsp;<span class="keyword" id="7168739">else</span>&nbsp;<span class="op" id="7168744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7168748">n</span>&nbsp;<span class="op" id="7168750">=</span>&nbsp;<span class="builtinfunc" id="7168752">copy</span><span class="op" id="7168756">(</span><span class="ident" id="7168757">b</span><span class="op" id="7168758">,</span>&nbsp;<span class="ident" id="7168760">r</span><span class="op" id="7168761">.</span><span class="ident" id="7168762">dataEOF</span><span class="op" id="7168769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7168773">r</span><span class="op" id="7168774">.</span><span class="ident" id="7168775">dataEOF</span>&nbsp;<span class="op" id="7168783">=</span>&nbsp;<span class="ident" id="7168785">r</span><span class="op" id="7168786">.</span><span class="ident" id="7168787">dataEOF</span><span class="op" id="7168794">[</span><span class="ident" id="7168795">n</span><span class="op" id="7168796">:</span><span class="op" id="7168797">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168801">if</span>&nbsp;<span class="builtinfunc" id="7168804">len</span><span class="op" id="7168807">(</span><span class="ident" id="7168808">r</span><span class="op" id="7168809">.</span><span class="ident" id="7168810">dataEOF</span><span class="op" id="7168817">)</span>&nbsp;<span class="op" id="7168819">==</span>&nbsp;<span class="num" id="7168822">0</span>&nbsp;<span class="op" id="7168824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7168829">err</span>&nbsp;<span class="op" id="7168833">=</span>&nbsp;<span class="ident" id="7168835">io</span><span class="op" id="7168837">.</span><span class="ident" id="7168838">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168845">if</span>&nbsp;<span class="ident" id="7168848">r</span><span class="op" id="7168849">.</span><span class="ident" id="7168850">lenAtEOF</span>&nbsp;<span class="op" id="7168859">==</span>&nbsp;<span class="op" id="7168862">-</span><span class="num" id="7168863">1</span>&nbsp;<span class="op" id="7168865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7168871">r</span><span class="op" id="7168872">.</span><span class="ident" id="7168873">lenAtEOF</span>&nbsp;<span class="op" id="7168882">=</span>&nbsp;<span class="ident" id="7168884">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7168889">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7168893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7168896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7168899">return</span><br>
<span class="lineno"></span><span class="op" id="7168906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="7168909">func</span>&nbsp;<span class="ident" id="7168914">TestDecodeEOF</span><span class="op" id="7168927">(</span><span class="ident" id="7168928">t</span>&nbsp;<span class="op" id="7168930">*</span><span class="ident" id="7168931">testing</span><span class="op" id="7168938">.</span><span class="ident" id="7168939">T</span><span class="op" id="7168940">)</span>&nbsp;<span class="op" id="7168942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7168945">//&nbsp;Check&nbsp;that&nbsp;if&nbsp;reader&nbsp;returns&nbsp;final&nbsp;data&nbsp;and&nbsp;EOF&nbsp;at&nbsp;same&nbsp;time,&nbsp;jpeg&nbsp;handles&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7169028">data</span><span class="op" id="7169032">,</span>&nbsp;<span class="ident" id="7169034">err</span>&nbsp;<span class="op" id="7169038">:=</span>&nbsp;<span class="ident" id="7169041">ioutil</span><span class="op" id="7169047">.</span><span class="ident" id="7169048">ReadFile</span><span class="op" id="7169056">(</span><span class="string" id="7169057">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7169085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7169088">if</span>&nbsp;<span class="ident" id="7169091">err</span>&nbsp;<span class="op" id="7169095">!=</span>&nbsp;<span class="ident" id="7169098">nil</span>&nbsp;<span class="op" id="7169102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7169106">t</span><span class="op" id="7169107">.</span><span class="ident" id="7169108">Fatal</span><span class="op" id="7169113">(</span><span class="ident" id="7169114">err</span><span class="op" id="7169117">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7169120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7169124">n</span>&nbsp;<span class="op" id="7169126">:=</span>&nbsp;<span class="builtinfunc" id="7169129">len</span><span class="op" id="7169132">(</span><span class="ident" id="7169133">data</span><span class="op" id="7169137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7169140">for</span>&nbsp;<span class="ident" id="7169144">i</span>&nbsp;<span class="op" id="7169146">:=</span>&nbsp;<span class="num" id="7169149">0</span><span class="op" id="7169150">;</span>&nbsp;<span class="ident" id="7169152">i</span>&nbsp;<span class="op" id="7169154">&lt;</span>&nbsp;<span class="ident" id="7169156">n</span><span class="op" id="7169157">;</span>&nbsp;<span class="op" id="7169159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7169163">r</span>&nbsp;<span class="op" id="7169165">:=</span>&nbsp;<span class="op" id="7169168">&amp;</span><span class="ident" id="7169169">eofReader</span><span class="op" id="7169178">{</span><span class="ident" id="7169179">data</span><span class="op" id="7169183">[</span><span class="op" id="7169184">:</span><span class="ident" id="7169185">n</span><span class="op" id="7169186">-</span><span class="ident" id="7169187">i</span><span class="op" id="7169188">]</span><span class="op" id="7169189">,</span>&nbsp;<span class="ident" id="7169191">data</span><span class="op" id="7169195">[</span><span class="ident" id="7169196">n</span><span class="op" id="7169197">-</span><span class="ident" id="7169198">i</span><span class="op" id="7169199">:</span><span class="op" id="7169200">]</span><span class="op" id="7169201">,</span>&nbsp;<span class="op" id="7169203">-</span><span class="num" id="7169204">1</span><span class="op" id="7169205">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7169209">_</span><span class="op" id="7169210">,</span>&nbsp;<span class="ident" id="7169212">err</span>&nbsp;<span class="op" id="7169216">:=</span>&nbsp;<span class="ident" id="7169219">Decode</span><span class="op" id="7169225">(</span><span class="ident" id="7169226">r</span><span class="op" id="7169227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7169231">if</span>&nbsp;<span class="ident" id="7169234">err</span>&nbsp;<span class="op" id="7169238">!=</span>&nbsp;<span class="ident" id="7169241">nil</span>&nbsp;<span class="op" id="7169245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7169250">t</span><span class="op" id="7169251">.</span><span class="ident" id="7169252">Errorf</span><span class="op" id="7169258">(</span><span class="string" id="7169259">&#34;Decode&nbsp;with&nbsp;Read()&nbsp;=&nbsp;%d,&nbsp;EOF:&nbsp;%v&#34;</span><span class="op" id="7169293">,</span>&nbsp;<span class="ident" id="7169295">r</span><span class="op" id="7169296">.</span><span class="ident" id="7169297">lenAtEOF</span><span class="op" id="7169305">,</span>&nbsp;<span class="ident" id="7169307">err</span><span class="op" id="7169310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7169314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7169318">if</span>&nbsp;<span class="ident" id="7169321">i</span>&nbsp;<span class="op" id="7169323">==</span>&nbsp;<span class="num" id="7169326">0</span>&nbsp;<span class="op" id="7169328">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7169333">i</span>&nbsp;<span class="op" id="7169335">=</span>&nbsp;<span class="num" id="7169337">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7169341">}</span>&nbsp;<span class="keyword" id="7169343">else</span>&nbsp;<span class="op" id="7169348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7169353">i</span>&nbsp;<span class="op" id="7169355">*=</span>&nbsp;<span class="num" id="7169358">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7169362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7169365">}</span><br>
<span class="lineno">135</span><span class="op" id="7169367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7169370">//&nbsp;check&nbsp;checks&nbsp;that&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;are&nbsp;equal,&nbsp;within&nbsp;the&nbsp;given&nbsp;bounds.</span><br>
<span class="lineno"></span><span class="keyword" id="7169444">func</span>&nbsp;<span class="ident" id="7169449">check</span><span class="op" id="7169454">(</span><span class="ident" id="7169455">bounds</span>&nbsp;<span class="ident" id="7169462">image</span><span class="op" id="7169467">.</span><span class="ident" id="7169468">Rectangle</span><span class="op" id="7169477">,</span>&nbsp;<span class="ident" id="7169479">pix0</span><span class="op" id="7169483">,</span>&nbsp;<span class="ident" id="7169485">pix1</span>&nbsp;<span class="op" id="7169490">[</span><span class="op" id="7169491">]</span><span class="builtintype" id="7169492">byte</span><span class="op" id="7169496">,</span>&nbsp;<span class="ident" id="7169498">stride0</span><span class="op" id="7169505">,</span>&nbsp;<span class="ident" id="7169507">stride1</span>&nbsp;<span class="builtintype" id="7169515">int</span><span class="op" id="7169518">)</span>&nbsp;<span class="builtintype" id="7169520">error</span>&nbsp;<span class="op" id="7169526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7169529">if</span>&nbsp;<span class="ident" id="7169532">stride0</span>&nbsp;<span class="op" id="7169540">&lt;=</span>&nbsp;<span class="num" id="7169543">0</span>&nbsp;<span class="op" id="7169545">||</span>&nbsp;<span class="ident" id="7169548">stride0</span><span class="op" id="7169555">%</span><span class="num" id="7169556">8</span>&nbsp;<span class="op" id="7169558">!=</span>&nbsp;<span class="num" id="7169561">0</span>&nbsp;<span class="op" id="7169563">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7169567">return</span>&nbsp;<span class="ident" id="7169574">fmt</span><span class="op" id="7169577">.</span><span class="ident" id="7169578">Errorf</span><span class="op" id="7169584">(</span><span class="string" id="7169585">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7169600">,</span>&nbsp;<span class="ident" id="7169602">stride0</span><span class="op" id="7169609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7169612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7169615">if</span>&nbsp;<span class="ident" id="7169618">stride1</span>&nbsp;<span class="op" id="7169626">&lt;=</span>&nbsp;<span class="num" id="7169629">0</span>&nbsp;<span class="op" id="7169631">||</span>&nbsp;<span class="ident" id="7169634">stride1</span><span class="op" id="7169641">%</span><span class="num" id="7169642">8</span>&nbsp;<span class="op" id="7169644">!=</span>&nbsp;<span class="num" id="7169647">0</span>&nbsp;<span class="op" id="7169649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7169653">return</span>&nbsp;<span class="ident" id="7169660">fmt</span><span class="op" id="7169663">.</span><span class="ident" id="7169664">Errorf</span><span class="op" id="7169670">(</span><span class="string" id="7169671">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7169686">,</span>&nbsp;<span class="ident" id="7169688">stride1</span><span class="op" id="7169695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7169698">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7169701">//&nbsp;Compare&nbsp;the&nbsp;two&nbsp;pix&nbsp;data,&nbsp;one&nbsp;8x8&nbsp;block&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7169756">for</span>&nbsp;<span class="ident" id="7169760">y</span>&nbsp;<span class="op" id="7169762">:=</span>&nbsp;<span class="num" id="7169765">0</span><span class="op" id="7169766">;</span>&nbsp;<span class="ident" id="7169768">y</span>&nbsp;<span class="op" id="7169770">&lt;</span>&nbsp;<span class="builtinfunc" id="7169772">len</span><span class="op" id="7169775">(</span><span class="ident" id="7169776">pix0</span><span class="op" id="7169780">)</span><span class="op" id="7169781">/</span><span class="ident" id="7169782">stride0</span>&nbsp;<span class="op" id="7169790">&amp;&amp;</span>&nbsp;<span class="ident" id="7169793">y</span>&nbsp;<span class="op" id="7169795">&lt;</span>&nbsp;<span class="builtinfunc" id="7169797">len</span><span class="op" id="7169800">(</span><span class="ident" id="7169801">pix1</span><span class="op" id="7169805">)</span><span class="op" id="7169806">/</span><span class="ident" id="7169807">stride1</span><span class="op" id="7169814">;</span>&nbsp;<span class="ident" id="7169816">y</span>&nbsp;<span class="op" id="7169818">+=</span>&nbsp;<span class="num" id="7169821">8</span>&nbsp;<span class="op" id="7169823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7169827">for</span>&nbsp;<span class="ident" id="7169831">x</span>&nbsp;<span class="op" id="7169833">:=</span>&nbsp;<span class="num" id="7169836">0</span><span class="op" id="7169837">;</span>&nbsp;<span class="ident" id="7169839">x</span>&nbsp;<span class="op" id="7169841">&lt;</span>&nbsp;<span class="ident" id="7169843">stride0</span>&nbsp;<span class="op" id="7169851">&amp;&amp;</span>&nbsp;<span class="ident" id="7169854">x</span>&nbsp;<span class="op" id="7169856">&lt;</span>&nbsp;<span class="ident" id="7169858">stride1</span><span class="op" id="7169865">;</span>&nbsp;<span class="ident" id="7169867">x</span>&nbsp;<span class="op" id="7169869">+=</span>&nbsp;<span class="num" id="7169872">8</span>&nbsp;<span class="op" id="7169874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7169879">if</span>&nbsp;<span class="ident" id="7169882">x</span>&nbsp;<span class="op" id="7169884">&gt;=</span>&nbsp;<span class="ident" id="7169887">bounds</span><span class="op" id="7169893">.</span><span class="ident" id="7169894">Max</span><span class="op" id="7169897">.</span><span class="ident" id="7169898">X</span>&nbsp;<span class="op" id="7169900">||</span>&nbsp;<span class="ident" id="7169903">y</span>&nbsp;<span class="op" id="7169905">&gt;=</span>&nbsp;<span class="ident" id="7169908">bounds</span><span class="op" id="7169914">.</span><span class="ident" id="7169915">Max</span><span class="op" id="7169918">.</span><span class="ident" id="7169919">Y</span>&nbsp;<span class="op" id="7169921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7169927">//&nbsp;We&nbsp;don&#39;t&nbsp;care&nbsp;if&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;differ&nbsp;if&nbsp;the&nbsp;8x8&nbsp;block&nbsp;is</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7169995">//&nbsp;entirely&nbsp;outside&nbsp;of&nbsp;the&nbsp;image&#39;s&nbsp;bounds.&nbsp;For&nbsp;example,&nbsp;this&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7170064">//&nbsp;occur&nbsp;with&nbsp;a&nbsp;4:2:0&nbsp;chroma&nbsp;subsampling&nbsp;and&nbsp;a&nbsp;1x1&nbsp;image.&nbsp;Baseline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7170135">//&nbsp;decoding&nbsp;works&nbsp;on&nbsp;the&nbsp;one&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole;&nbsp;progressive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7170202">//&nbsp;decoding&#39;s&nbsp;first&nbsp;pass&nbsp;works&nbsp;on&nbsp;that&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7170270">//&nbsp;refinement&nbsp;passes&nbsp;only&nbsp;process&nbsp;one&nbsp;8x8&nbsp;block&nbsp;within&nbsp;the&nbsp;MCU.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7170338">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7170350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7170356">for</span>&nbsp;<span class="ident" id="7170360">j</span>&nbsp;<span class="op" id="7170362">:=</span>&nbsp;<span class="num" id="7170365">0</span><span class="op" id="7170366">;</span>&nbsp;<span class="ident" id="7170368">j</span>&nbsp;<span class="op" id="7170370">&lt;</span>&nbsp;<span class="num" id="7170372">8</span><span class="op" id="7170373">;</span>&nbsp;<span class="ident" id="7170375">j</span><span class="op" id="7170376">++</span>&nbsp;<span class="op" id="7170379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7170385">for</span>&nbsp;<span class="ident" id="7170389">i</span>&nbsp;<span class="op" id="7170391">:=</span>&nbsp;<span class="num" id="7170394">0</span><span class="op" id="7170395">;</span>&nbsp;<span class="ident" id="7170397">i</span>&nbsp;<span class="op" id="7170399">&lt;</span>&nbsp;<span class="num" id="7170401">8</span><span class="op" id="7170402">;</span>&nbsp;<span class="ident" id="7170404">i</span><span class="op" id="7170405">++</span>&nbsp;<span class="op" id="7170408">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7170415">index0</span>&nbsp;<span class="op" id="7170422">:=</span>&nbsp;<span class="op" id="7170425">(</span><span class="ident" id="7170426">y</span><span class="op" id="7170427">+</span><span class="ident" id="7170428">j</span><span class="op" id="7170429">)</span><span class="op" id="7170430">*</span><span class="ident" id="7170431">stride0</span>&nbsp;<span class="op" id="7170439">+</span>&nbsp;<span class="op" id="7170441">(</span><span class="ident" id="7170442">x</span>&nbsp;<span class="op" id="7170444">+</span>&nbsp;<span class="ident" id="7170446">i</span><span class="op" id="7170447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7170454">index1</span>&nbsp;<span class="op" id="7170461">:=</span>&nbsp;<span class="op" id="7170464">(</span><span class="ident" id="7170465">y</span><span class="op" id="7170466">+</span><span class="ident" id="7170467">j</span><span class="op" id="7170468">)</span><span class="op" id="7170469">*</span><span class="ident" id="7170470">stride1</span>&nbsp;<span class="op" id="7170478">+</span>&nbsp;<span class="op" id="7170480">(</span><span class="ident" id="7170481">x</span>&nbsp;<span class="op" id="7170483">+</span>&nbsp;<span class="ident" id="7170485">i</span><span class="op" id="7170486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7170493">if</span>&nbsp;<span class="ident" id="7170496">pix0</span><span class="op" id="7170500">[</span><span class="ident" id="7170501">index0</span><span class="op" id="7170507">]</span>&nbsp;<span class="op" id="7170509">!=</span>&nbsp;<span class="ident" id="7170512">pix1</span><span class="op" id="7170516">[</span><span class="ident" id="7170517">index1</span><span class="op" id="7170523">]</span>&nbsp;<span class="op" id="7170525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7170533">return</span>&nbsp;<span class="ident" id="7170540">fmt</span><span class="op" id="7170543">.</span><span class="ident" id="7170544">Errorf</span><span class="op" id="7170550">(</span><span class="string" id="7170551">&#34;blocks&nbsp;at&nbsp;(%d,&nbsp;%d)&nbsp;differ:\n%sand\n%s&#34;</span><span class="op" id="7170590">,</span>&nbsp;<span class="ident" id="7170592">x</span><span class="op" id="7170593">,</span>&nbsp;<span class="ident" id="7170595">y</span><span class="op" id="7170596">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7170605">pixString</span><span class="op" id="7170614">(</span><span class="ident" id="7170615">pix0</span><span class="op" id="7170619">,</span>&nbsp;<span class="ident" id="7170621">stride0</span><span class="op" id="7170628">,</span>&nbsp;<span class="ident" id="7170630">x</span><span class="op" id="7170631">,</span>&nbsp;<span class="ident" id="7170633">y</span><span class="op" id="7170634">)</span><span class="op" id="7170635">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7170644">pixString</span><span class="op" id="7170653">(</span><span class="ident" id="7170654">pix1</span><span class="op" id="7170658">,</span>&nbsp;<span class="ident" id="7170660">stride1</span><span class="op" id="7170667">,</span>&nbsp;<span class="ident" id="7170669">x</span><span class="op" id="7170670">,</span>&nbsp;<span class="ident" id="7170672">y</span><span class="op" id="7170673">)</span><span class="op" id="7170674">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7170682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7170689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7170695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7170700">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7170704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7170707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7170710">return</span>&nbsp;<span class="ident" id="7170717">nil</span><br>
<span class="lineno"></span><span class="op" id="7170721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="7170724">func</span>&nbsp;<span class="ident" id="7170729">pixString</span><span class="op" id="7170738">(</span><span class="ident" id="7170739">pix</span>&nbsp;<span class="op" id="7170743">[</span><span class="op" id="7170744">]</span><span class="builtintype" id="7170745">byte</span><span class="op" id="7170749">,</span>&nbsp;<span class="ident" id="7170751">stride</span><span class="op" id="7170757">,</span>&nbsp;<span class="ident" id="7170759">x</span><span class="op" id="7170760">,</span>&nbsp;<span class="ident" id="7170762">y</span>&nbsp;<span class="builtintype" id="7170764">int</span><span class="op" id="7170767">)</span>&nbsp;<span class="builtintype" id="7170769">string</span>&nbsp;<span class="op" id="7170776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7170779">s</span>&nbsp;<span class="op" id="7170781">:=</span>&nbsp;<span class="ident" id="7170784">bytes</span><span class="op" id="7170789">.</span><span class="ident" id="7170790">NewBuffer</span><span class="op" id="7170799">(</span><span class="ident" id="7170800">nil</span><span class="op" id="7170803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7170806">for</span>&nbsp;<span class="ident" id="7170810">j</span>&nbsp;<span class="op" id="7170812">:=</span>&nbsp;<span class="num" id="7170815">0</span><span class="op" id="7170816">;</span>&nbsp;<span class="ident" id="7170818">j</span>&nbsp;<span class="op" id="7170820">&lt;</span>&nbsp;<span class="num" id="7170822">8</span><span class="op" id="7170823">;</span>&nbsp;<span class="ident" id="7170825">j</span><span class="op" id="7170826">++</span>&nbsp;<span class="op" id="7170829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7170833">fmt</span><span class="op" id="7170836">.</span><span class="ident" id="7170837">Fprintf</span><span class="op" id="7170844">(</span><span class="ident" id="7170845">s</span><span class="op" id="7170846">,</span>&nbsp;<span class="string" id="7170848">&#34;\t&#34;</span><span class="op" id="7170852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7170856">for</span>&nbsp;<span class="ident" id="7170860">i</span>&nbsp;<span class="op" id="7170862">:=</span>&nbsp;<span class="num" id="7170865">0</span><span class="op" id="7170866">;</span>&nbsp;<span class="ident" id="7170868">i</span>&nbsp;<span class="op" id="7170870">&lt;</span>&nbsp;<span class="num" id="7170872">8</span><span class="op" id="7170873">;</span>&nbsp;<span class="ident" id="7170875">i</span><span class="op" id="7170876">++</span>&nbsp;<span class="op" id="7170879">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7170884">fmt</span><span class="op" id="7170887">.</span><span class="ident" id="7170888">Fprintf</span><span class="op" id="7170895">(</span><span class="ident" id="7170896">s</span><span class="op" id="7170897">,</span>&nbsp;<span class="string" id="7170899">&#34;%02x&nbsp;&#34;</span><span class="op" id="7170906">,</span>&nbsp;<span class="ident" id="7170908">pix</span><span class="op" id="7170911">[</span><span class="op" id="7170912">(</span><span class="ident" id="7170913">y</span><span class="op" id="7170914">+</span><span class="ident" id="7170915">j</span><span class="op" id="7170916">)</span><span class="op" id="7170917">*</span><span class="ident" id="7170918">stride</span><span class="op" id="7170924">+</span><span class="op" id="7170925">(</span><span class="ident" id="7170926">x</span><span class="op" id="7170927">+</span><span class="ident" id="7170928">i</span><span class="op" id="7170929">)</span><span class="op" id="7170930">]</span><span class="op" id="7170931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7170935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7170939">fmt</span><span class="op" id="7170942">.</span><span class="ident" id="7170943">Fprintf</span><span class="op" id="7170950">(</span><span class="ident" id="7170951">s</span><span class="op" id="7170952">,</span>&nbsp;<span class="string" id="7170954">&#34;\n&#34;</span><span class="op" id="7170958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7170961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7170964">return</span>&nbsp;<span class="ident" id="7170971">s</span><span class="op" id="7170972">.</span><span class="ident" id="7170973">String</span><span class="op" id="7170979">(</span><span class="op" id="7170980">)</span><br>
<span class="lineno">185</span><span class="op" id="7170982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7170985">func</span>&nbsp;<span class="ident" id="7170990">TestExtraneousData</span><span class="op" id="7171008">(</span><span class="ident" id="7171009">t</span>&nbsp;<span class="op" id="7171011">*</span><span class="ident" id="7171012">testing</span><span class="op" id="7171019">.</span><span class="ident" id="7171020">T</span><span class="op" id="7171021">)</span>&nbsp;<span class="op" id="7171023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7171026">//&nbsp;Encode&nbsp;a&nbsp;1x1&nbsp;red&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7171054">src</span>&nbsp;<span class="op" id="7171058">:=</span>&nbsp;<span class="ident" id="7171061">image</span><span class="op" id="7171066">.</span><span class="ident" id="7171067">NewRGBA</span><span class="op" id="7171074">(</span><span class="ident" id="7171075">image</span><span class="op" id="7171080">.</span><span class="ident" id="7171081">Rect</span><span class="op" id="7171085">(</span><span class="num" id="7171086">0</span><span class="op" id="7171087">,</span>&nbsp;<span class="num" id="7171089">0</span><span class="op" id="7171090">,</span>&nbsp;<span class="num" id="7171092">1</span><span class="op" id="7171093">,</span>&nbsp;<span class="num" id="7171095">1</span><span class="op" id="7171096">)</span><span class="op" id="7171097">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7171100">src</span><span class="op" id="7171103">.</span><span class="ident" id="7171104">Set</span><span class="op" id="7171107">(</span><span class="num" id="7171108">0</span><span class="op" id="7171109">,</span>&nbsp;<span class="num" id="7171111">0</span><span class="op" id="7171112">,</span>&nbsp;<span class="ident" id="7171114">color</span><span class="op" id="7171119">.</span><span class="ident" id="7171120">RGBA</span><span class="op" id="7171124">{</span><span class="num" id="7171125">0xff</span><span class="op" id="7171129">,</span>&nbsp;<span class="num" id="7171131">0x00</span><span class="op" id="7171135">,</span>&nbsp;<span class="num" id="7171137">0x00</span><span class="op" id="7171141">,</span>&nbsp;<span class="num" id="7171143">0xff</span><span class="op" id="7171147">}</span><span class="op" id="7171148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7171151">buf</span>&nbsp;<span class="op" id="7171155">:=</span>&nbsp;<span class="builtinfunc" id="7171158">new</span><span class="op" id="7171161">(</span><span class="ident" id="7171162">bytes</span><span class="op" id="7171167">.</span><span class="ident" id="7171168">Buffer</span><span class="op" id="7171174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7171177">if</span>&nbsp;<span class="ident" id="7171180">err</span>&nbsp;<span class="op" id="7171184">:=</span>&nbsp;<span class="ident" id="7171187">Encode</span><span class="op" id="7171193">(</span><span class="ident" id="7171194">buf</span><span class="op" id="7171197">,</span>&nbsp;<span class="ident" id="7171199">src</span><span class="op" id="7171202">,</span>&nbsp;<span class="ident" id="7171204">nil</span><span class="op" id="7171207">)</span><span class="op" id="7171208">;</span>&nbsp;<span class="ident" id="7171210">err</span>&nbsp;<span class="op" id="7171214">!=</span>&nbsp;<span class="ident" id="7171217">nil</span>&nbsp;<span class="op" id="7171221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7171225">t</span><span class="op" id="7171226">.</span><span class="ident" id="7171227">Fatalf</span><span class="op" id="7171233">(</span><span class="string" id="7171234">&#34;encode:&nbsp;%v&#34;</span><span class="op" id="7171246">,</span>&nbsp;<span class="ident" id="7171248">err</span><span class="op" id="7171251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7171254">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7171257">enc</span>&nbsp;<span class="op" id="7171261">:=</span>&nbsp;<span class="ident" id="7171264">buf</span><span class="op" id="7171267">.</span><span class="ident" id="7171268">String</span><span class="op" id="7171274">(</span><span class="op" id="7171275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7171278">//&nbsp;Sanity&nbsp;check&nbsp;that&nbsp;the&nbsp;encoded&nbsp;JPEG&nbsp;is&nbsp;long&nbsp;enough,&nbsp;that&nbsp;it&nbsp;ends&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7171351">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker,&nbsp;and&nbsp;that&nbsp;it&nbsp;contains&nbsp;a&nbsp;&#34;\xff\xda&#34;&nbsp;SOS&nbsp;marker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7171423">//&nbsp;somewhere&nbsp;in&nbsp;the&nbsp;final&nbsp;64&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7171460">if</span>&nbsp;<span class="builtinfunc" id="7171463">len</span><span class="op" id="7171466">(</span><span class="ident" id="7171467">enc</span><span class="op" id="7171470">)</span>&nbsp;<span class="op" id="7171472">&lt;</span>&nbsp;<span class="num" id="7171474">64</span>&nbsp;<span class="op" id="7171477">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7171481">t</span><span class="op" id="7171482">.</span><span class="ident" id="7171483">Fatalf</span><span class="op" id="7171489">(</span><span class="string" id="7171490">&#34;encoded&nbsp;JPEG&nbsp;is&nbsp;too&nbsp;short:&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="7171527">,</span>&nbsp;<span class="builtinfunc" id="7171529">len</span><span class="op" id="7171532">(</span><span class="ident" id="7171533">enc</span><span class="op" id="7171536">)</span><span class="op" id="7171537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7171540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7171543">if</span>&nbsp;<span class="ident" id="7171546">got</span><span class="op" id="7171549">,</span>&nbsp;<span class="ident" id="7171551">want</span>&nbsp;<span class="op" id="7171556">:=</span>&nbsp;<span class="ident" id="7171559">enc</span><span class="op" id="7171562">[</span><span class="builtinfunc" id="7171563">len</span><span class="op" id="7171566">(</span><span class="ident" id="7171567">enc</span><span class="op" id="7171570">)</span><span class="op" id="7171571">-</span><span class="num" id="7171572">2</span><span class="op" id="7171573">:</span><span class="op" id="7171574">]</span><span class="op" id="7171575">,</span>&nbsp;<span class="string" id="7171577">&#34;\xff\xd9&#34;</span><span class="op" id="7171587">;</span>&nbsp;<span class="ident" id="7171589">got</span>&nbsp;<span class="op" id="7171593">!=</span>&nbsp;<span class="ident" id="7171596">want</span>&nbsp;<span class="op" id="7171601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7171605">t</span><span class="op" id="7171606">.</span><span class="ident" id="7171607">Fatalf</span><span class="op" id="7171613">(</span><span class="string" id="7171614">&#34;encoded&nbsp;JPEG&nbsp;ends&nbsp;with&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7171650">,</span>&nbsp;<span class="ident" id="7171652">got</span><span class="op" id="7171655">,</span>&nbsp;<span class="ident" id="7171657">want</span><span class="op" id="7171661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7171664">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7171667">if</span>&nbsp;<span class="ident" id="7171670">s</span>&nbsp;<span class="op" id="7171672">:=</span>&nbsp;<span class="ident" id="7171675">enc</span><span class="op" id="7171678">[</span><span class="builtinfunc" id="7171679">len</span><span class="op" id="7171682">(</span><span class="ident" id="7171683">enc</span><span class="op" id="7171686">)</span><span class="op" id="7171687">-</span><span class="num" id="7171688">64</span><span class="op" id="7171690">:</span><span class="op" id="7171691">]</span><span class="op" id="7171692">;</span>&nbsp;<span class="op" id="7171694">!</span><span class="ident" id="7171695">strings</span><span class="op" id="7171702">.</span><span class="ident" id="7171703">Contains</span><span class="op" id="7171711">(</span><span class="ident" id="7171712">s</span><span class="op" id="7171713">,</span>&nbsp;<span class="string" id="7171715">&#34;\xff\xda&#34;</span><span class="op" id="7171725">)</span>&nbsp;<span class="op" id="7171727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7171731">t</span><span class="op" id="7171732">.</span><span class="ident" id="7171733">Fatalf</span><span class="op" id="7171739">(</span><span class="string" id="7171740">&#34;encoded&nbsp;JPEG&nbsp;does&nbsp;not&nbsp;contain&nbsp;a&nbsp;SOS&nbsp;marker&nbsp;(ff&nbsp;da)&nbsp;near&nbsp;the&nbsp;end:&nbsp;%&nbsp;x&#34;</span><span class="op" id="7171810">,</span>&nbsp;<span class="ident" id="7171812">s</span><span class="op" id="7171813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7171816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7171819">//&nbsp;Test&nbsp;that&nbsp;adding&nbsp;some&nbsp;random&nbsp;junk&nbsp;between&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7171888">//&nbsp;EOI&nbsp;marker&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;decoding.</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7171933">rnd</span>&nbsp;<span class="op" id="7171937">:=</span>&nbsp;<span class="ident" id="7171940">rand</span><span class="op" id="7171944">.</span><span class="ident" id="7171945">New</span><span class="op" id="7171948">(</span><span class="ident" id="7171949">rand</span><span class="op" id="7171953">.</span><span class="ident" id="7171954">NewSource</span><span class="op" id="7171963">(</span><span class="num" id="7171964">1</span><span class="op" id="7171965">)</span><span class="op" id="7171966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7171969">for</span>&nbsp;<span class="ident" id="7171973">i</span><span class="op" id="7171974">,</span>&nbsp;<span class="ident" id="7171976">nerr</span>&nbsp;<span class="op" id="7171981">:=</span>&nbsp;<span class="num" id="7171984">0</span><span class="op" id="7171985">,</span>&nbsp;<span class="num" id="7171987">0</span><span class="op" id="7171988">;</span>&nbsp;<span class="ident" id="7171990">i</span>&nbsp;<span class="op" id="7171992">&lt;</span>&nbsp;<span class="num" id="7171994">1000</span>&nbsp;<span class="op" id="7171999">&amp;&amp;</span>&nbsp;<span class="ident" id="7172002">nerr</span>&nbsp;<span class="op" id="7172007">&lt;</span>&nbsp;<span class="num" id="7172009">10</span><span class="op" id="7172011">;</span>&nbsp;<span class="ident" id="7172013">i</span><span class="op" id="7172014">++</span>&nbsp;<span class="op" id="7172017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172021">buf</span><span class="op" id="7172024">.</span><span class="ident" id="7172025">Reset</span><span class="op" id="7172030">(</span><span class="op" id="7172031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7172035">//&nbsp;Write&nbsp;all&nbsp;but&nbsp;the&nbsp;trailing&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172090">buf</span><span class="op" id="7172093">.</span><span class="ident" id="7172094">WriteString</span><span class="op" id="7172105">(</span><span class="ident" id="7172106">enc</span><span class="op" id="7172109">[</span><span class="op" id="7172110">:</span><span class="builtinfunc" id="7172111">len</span><span class="op" id="7172114">(</span><span class="ident" id="7172115">enc</span><span class="op" id="7172118">)</span><span class="op" id="7172119">-</span><span class="num" id="7172120">2</span><span class="op" id="7172121">]</span><span class="op" id="7172122">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7172126">//&nbsp;Write&nbsp;some&nbsp;random&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7172166">for</span>&nbsp;<span class="ident" id="7172170">n</span>&nbsp;<span class="op" id="7172172">:=</span>&nbsp;<span class="ident" id="7172175">rnd</span><span class="op" id="7172178">.</span><span class="ident" id="7172179">Intn</span><span class="op" id="7172183">(</span><span class="num" id="7172184">10</span><span class="op" id="7172186">)</span><span class="op" id="7172187">;</span>&nbsp;<span class="ident" id="7172189">n</span>&nbsp;<span class="op" id="7172191">&gt;</span>&nbsp;<span class="num" id="7172193">0</span><span class="op" id="7172194">;</span>&nbsp;<span class="ident" id="7172196">n</span><span class="op" id="7172197">--</span>&nbsp;<span class="op" id="7172200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7172205">if</span>&nbsp;<span class="ident" id="7172208">x</span>&nbsp;<span class="op" id="7172210">:=</span>&nbsp;<span class="builtintype" id="7172213">byte</span><span class="op" id="7172217">(</span><span class="ident" id="7172218">rnd</span><span class="op" id="7172221">.</span><span class="ident" id="7172222">Intn</span><span class="op" id="7172226">(</span><span class="num" id="7172227">256</span><span class="op" id="7172230">)</span><span class="op" id="7172231">)</span><span class="op" id="7172232">;</span>&nbsp;<span class="ident" id="7172234">x</span>&nbsp;<span class="op" id="7172236">!=</span>&nbsp;<span class="num" id="7172239">0xff</span>&nbsp;<span class="op" id="7172244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172250">buf</span><span class="op" id="7172253">.</span><span class="ident" id="7172254">WriteByte</span><span class="op" id="7172263">(</span><span class="ident" id="7172264">x</span><span class="op" id="7172265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7172270">}</span>&nbsp;<span class="keyword" id="7172272">else</span>&nbsp;<span class="op" id="7172277">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7172283">//&nbsp;The&nbsp;JPEG&nbsp;format&nbsp;escapes&nbsp;a&nbsp;SOS&nbsp;0xff&nbsp;data&nbsp;byte&nbsp;as&nbsp;&#34;\xff\x00&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172350">buf</span><span class="op" id="7172353">.</span><span class="ident" id="7172354">WriteString</span><span class="op" id="7172365">(</span><span class="string" id="7172366">&#34;\xff\x00&#34;</span><span class="op" id="7172376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7172381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7172385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7172389">//&nbsp;Write&nbsp;the&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172427">buf</span><span class="op" id="7172430">.</span><span class="ident" id="7172431">WriteString</span><span class="op" id="7172442">(</span><span class="string" id="7172443">&#34;\xff\xd9&#34;</span><span class="op" id="7172453">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7172458">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;can&nbsp;still&nbsp;decode&nbsp;the&nbsp;resultant&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172515">got</span><span class="op" id="7172518">,</span>&nbsp;<span class="ident" id="7172520">err</span>&nbsp;<span class="op" id="7172524">:=</span>&nbsp;<span class="ident" id="7172527">Decode</span><span class="op" id="7172533">(</span><span class="ident" id="7172534">buf</span><span class="op" id="7172537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7172541">if</span>&nbsp;<span class="ident" id="7172544">err</span>&nbsp;<span class="op" id="7172548">!=</span>&nbsp;<span class="ident" id="7172551">nil</span>&nbsp;<span class="op" id="7172555">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172560">t</span><span class="op" id="7172561">.</span><span class="ident" id="7172562">Errorf</span><span class="op" id="7172568">(</span><span class="string" id="7172569">&#34;could&nbsp;not&nbsp;decode&nbsp;image&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="7172601">,</span>&nbsp;<span class="ident" id="7172603">i</span><span class="op" id="7172604">,</span>&nbsp;<span class="ident" id="7172606">err</span><span class="op" id="7172609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172614">nerr</span><span class="op" id="7172618">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7172624">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7172635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7172639">if</span>&nbsp;<span class="ident" id="7172642">got</span><span class="op" id="7172645">.</span><span class="ident" id="7172646">Bounds</span><span class="op" id="7172652">(</span><span class="op" id="7172653">)</span>&nbsp;<span class="op" id="7172655">!=</span>&nbsp;<span class="ident" id="7172658">src</span><span class="op" id="7172661">.</span><span class="ident" id="7172662">Bounds</span><span class="op" id="7172668">(</span><span class="op" id="7172669">)</span>&nbsp;<span class="op" id="7172671">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172676">t</span><span class="op" id="7172677">.</span><span class="ident" id="7172678">Errorf</span><span class="op" id="7172684">(</span><span class="string" id="7172685">&#34;image&nbsp;#%d,&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7172722">,</span>&nbsp;<span class="ident" id="7172724">i</span><span class="op" id="7172725">,</span>&nbsp;<span class="ident" id="7172727">got</span><span class="op" id="7172730">.</span><span class="ident" id="7172731">Bounds</span><span class="op" id="7172737">(</span><span class="op" id="7172738">)</span><span class="op" id="7172739">,</span>&nbsp;<span class="ident" id="7172741">src</span><span class="op" id="7172744">.</span><span class="ident" id="7172745">Bounds</span><span class="op" id="7172751">(</span><span class="op" id="7172752">)</span><span class="op" id="7172753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172758">nerr</span><span class="op" id="7172762">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7172768">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7172779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7172783">if</span>&nbsp;<span class="ident" id="7172786">averageDelta</span><span class="op" id="7172798">(</span><span class="ident" id="7172799">got</span><span class="op" id="7172802">,</span>&nbsp;<span class="ident" id="7172804">src</span><span class="op" id="7172807">)</span>&nbsp;<span class="op" id="7172809">&gt;</span>&nbsp;<span class="num" id="7172811">2</span><span class="op" id="7172812">&lt;&lt;</span><span class="num" id="7172814">8</span>&nbsp;<span class="op" id="7172816">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172821">t</span><span class="op" id="7172822">.</span><span class="ident" id="7172823">Errorf</span><span class="op" id="7172829">(</span><span class="string" id="7172830">&#34;image&nbsp;#%d&nbsp;changed&nbsp;too&nbsp;much&nbsp;after&nbsp;a&nbsp;round&nbsp;trip&#34;</span><span class="op" id="7172877">,</span>&nbsp;<span class="ident" id="7172879">i</span><span class="op" id="7172880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172885">nerr</span><span class="op" id="7172889">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7172895">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7172906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7172909">}</span><br>
<span class="lineno">245</span><span class="op" id="7172911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7172914">func</span>&nbsp;<span class="ident" id="7172919">benchmarkDecode</span><span class="op" id="7172934">(</span><span class="ident" id="7172935">b</span>&nbsp;<span class="op" id="7172937">*</span><span class="ident" id="7172938">testing</span><span class="op" id="7172945">.</span><span class="ident" id="7172946">B</span><span class="op" id="7172947">,</span>&nbsp;<span class="ident" id="7172949">filename</span>&nbsp;<span class="builtintype" id="7172958">string</span><span class="op" id="7172964">)</span>&nbsp;<span class="op" id="7172966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172969">b</span><span class="op" id="7172970">.</span><span class="ident" id="7172971">StopTimer</span><span class="op" id="7172980">(</span><span class="op" id="7172981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7172984">data</span><span class="op" id="7172988">,</span>&nbsp;<span class="ident" id="7172990">err</span>&nbsp;<span class="op" id="7172994">:=</span>&nbsp;<span class="ident" id="7172997">ioutil</span><span class="op" id="7173003">.</span><span class="ident" id="7173004">ReadFile</span><span class="op" id="7173012">(</span><span class="ident" id="7173013">filename</span><span class="op" id="7173021">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7173024">if</span>&nbsp;<span class="ident" id="7173027">err</span>&nbsp;<span class="op" id="7173031">!=</span>&nbsp;<span class="ident" id="7173034">nil</span>&nbsp;<span class="op" id="7173038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7173042">b</span><span class="op" id="7173043">.</span><span class="ident" id="7173044">Fatal</span><span class="op" id="7173049">(</span><span class="ident" id="7173050">err</span><span class="op" id="7173053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7173056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7173059">cfg</span><span class="op" id="7173062">,</span>&nbsp;<span class="ident" id="7173064">err</span>&nbsp;<span class="op" id="7173068">:=</span>&nbsp;<span class="ident" id="7173071">DecodeConfig</span><span class="op" id="7173083">(</span><span class="ident" id="7173084">bytes</span><span class="op" id="7173089">.</span><span class="ident" id="7173090">NewReader</span><span class="op" id="7173099">(</span><span class="ident" id="7173100">data</span><span class="op" id="7173104">)</span><span class="op" id="7173105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7173108">if</span>&nbsp;<span class="ident" id="7173111">err</span>&nbsp;<span class="op" id="7173115">!=</span>&nbsp;<span class="ident" id="7173118">nil</span>&nbsp;<span class="op" id="7173122">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7173126">b</span><span class="op" id="7173127">.</span><span class="ident" id="7173128">Fatal</span><span class="op" id="7173133">(</span><span class="ident" id="7173134">err</span><span class="op" id="7173137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7173140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7173143">b</span><span class="op" id="7173144">.</span><span class="ident" id="7173145">SetBytes</span><span class="op" id="7173153">(</span><span class="ident" id="7173154">int64</span><span class="op" id="7173159">(</span><span class="ident" id="7173160">cfg</span><span class="op" id="7173163">.</span><span class="ident" id="7173164">Width</span>&nbsp;<span class="op" id="7173170">*</span>&nbsp;<span class="ident" id="7173172">cfg</span><span class="op" id="7173175">.</span><span class="ident" id="7173176">Height</span>&nbsp;<span class="op" id="7173183">*</span>&nbsp;<span class="num" id="7173185">4</span><span class="op" id="7173186">)</span><span class="op" id="7173187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7173190">b</span><span class="op" id="7173191">.</span><span class="ident" id="7173192">StartTimer</span><span class="op" id="7173202">(</span><span class="op" id="7173203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7173206">for</span>&nbsp;<span class="ident" id="7173210">i</span>&nbsp;<span class="op" id="7173212">:=</span>&nbsp;<span class="num" id="7173215">0</span><span class="op" id="7173216">;</span>&nbsp;<span class="ident" id="7173218">i</span>&nbsp;<span class="op" id="7173220">&lt;</span>&nbsp;<span class="ident" id="7173222">b</span><span class="op" id="7173223">.</span><span class="ident" id="7173224">N</span><span class="op" id="7173225">;</span>&nbsp;<span class="ident" id="7173227">i</span><span class="op" id="7173228">++</span>&nbsp;<span class="op" id="7173231">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7173235">Decode</span><span class="op" id="7173241">(</span><span class="ident" id="7173242">bytes</span><span class="op" id="7173247">.</span><span class="ident" id="7173248">NewReader</span><span class="op" id="7173257">(</span><span class="ident" id="7173258">data</span><span class="op" id="7173262">)</span><span class="op" id="7173263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7173266">}</span><br>
<span class="lineno"></span><span class="op" id="7173268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7173271">func</span>&nbsp;<span class="ident" id="7173276">BenchmarkDecodeBaseline</span><span class="op" id="7173299">(</span><span class="ident" id="7173300">b</span>&nbsp;<span class="op" id="7173302">*</span><span class="ident" id="7173303">testing</span><span class="op" id="7173310">.</span><span class="ident" id="7173311">B</span><span class="op" id="7173312">)</span>&nbsp;<span class="op" id="7173314">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7173317">benchmarkDecode</span><span class="op" id="7173332">(</span><span class="ident" id="7173333">b</span><span class="op" id="7173334">,</span>&nbsp;<span class="string" id="7173336">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7173364">)</span><br>
<span class="lineno"></span><span class="op" id="7173366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7173369">func</span>&nbsp;<span class="ident" id="7173374">BenchmarkDecodeProgressive</span><span class="op" id="7173400">(</span><span class="ident" id="7173401">b</span>&nbsp;<span class="op" id="7173403">*</span><span class="ident" id="7173404">testing</span><span class="op" id="7173411">.</span><span class="ident" id="7173412">B</span><span class="op" id="7173413">)</span>&nbsp;<span class="op" id="7173415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7173418">benchmarkDecode</span><span class="op" id="7173433">(</span><span class="ident" id="7173434">b</span><span class="op" id="7173435">,</span>&nbsp;<span class="string" id="7173437">&#34;../testdata/video-001.progressive.jpeg&#34;</span><span class="op" id="7173477">)</span><br>
<span class="lineno">270</span><span class="op" id="7173479">}</span>
</div>
</body>
</html>
