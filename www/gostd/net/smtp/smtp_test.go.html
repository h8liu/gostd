<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8506511">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8506566">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8506620">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8506671">package</span>&nbsp;<span class="ident" id="8506679">smtp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8506685">import</span>&nbsp;<span class="op" id="8506692">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8506695">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8506704">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8506713">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8506727">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8506742">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8506748">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8506755">&#34;net/textproto&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8506772">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8506783">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8506794">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8506801">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="8506804">type</span>&nbsp;<span class="ident" id="8506809">authTest</span>&nbsp;<span class="keyword" id="8506818">struct</span>&nbsp;<span class="op" id="8506825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8506828">auth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8506839">Auth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8506845">challenges</span>&nbsp;<span class="op" id="8506856">[</span><span class="op" id="8506857">]</span><span class="builtintype" id="8506858">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8506866">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8506877">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8506885">responses</span>&nbsp;&nbsp;<span class="op" id="8506896">[</span><span class="op" id="8506897">]</span><span class="builtintype" id="8506898">string</span><br>
<span class="lineno">25</span><span class="op" id="8506905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8506908">var</span>&nbsp;<span class="ident" id="8506912">authTests</span>&nbsp;<span class="op" id="8506922">=</span>&nbsp;<span class="op" id="8506924">[</span><span class="op" id="8506925">]</span><span class="ident" id="8506926">authTest</span><span class="op" id="8506934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8506937">{</span><span class="ident" id="8506938">PlainAuth</span><span class="op" id="8506947">(</span><span class="string" id="8506948">&#34;&#34;</span><span class="op" id="8506950">,</span>&nbsp;<span class="string" id="8506952">&#34;user&#34;</span><span class="op" id="8506958">,</span>&nbsp;<span class="string" id="8506960">&#34;pass&#34;</span><span class="op" id="8506966">,</span>&nbsp;<span class="string" id="8506968">&#34;testserver&#34;</span><span class="op" id="8506980">)</span><span class="op" id="8506981">,</span>&nbsp;<span class="op" id="8506983">[</span><span class="op" id="8506984">]</span><span class="builtintype" id="8506985">string</span><span class="op" id="8506991">{</span><span class="op" id="8506992">}</span><span class="op" id="8506993">,</span>&nbsp;<span class="string" id="8506995">&#34;PLAIN&#34;</span><span class="op" id="8507002">,</span>&nbsp;<span class="op" id="8507004">[</span><span class="op" id="8507005">]</span><span class="builtintype" id="8507006">string</span><span class="op" id="8507012">{</span><span class="string" id="8507013">&#34;\x00user\x00pass&#34;</span><span class="op" id="8507031">}</span><span class="op" id="8507032">}</span><span class="op" id="8507033">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8507036">{</span><span class="ident" id="8507037">PlainAuth</span><span class="op" id="8507046">(</span><span class="string" id="8507047">&#34;foo&#34;</span><span class="op" id="8507052">,</span>&nbsp;<span class="string" id="8507054">&#34;bar&#34;</span><span class="op" id="8507059">,</span>&nbsp;<span class="string" id="8507061">&#34;baz&#34;</span><span class="op" id="8507066">,</span>&nbsp;<span class="string" id="8507068">&#34;testserver&#34;</span><span class="op" id="8507080">)</span><span class="op" id="8507081">,</span>&nbsp;<span class="op" id="8507083">[</span><span class="op" id="8507084">]</span><span class="builtintype" id="8507085">string</span><span class="op" id="8507091">{</span><span class="op" id="8507092">}</span><span class="op" id="8507093">,</span>&nbsp;<span class="string" id="8507095">&#34;PLAIN&#34;</span><span class="op" id="8507102">,</span>&nbsp;<span class="op" id="8507104">[</span><span class="op" id="8507105">]</span><span class="builtintype" id="8507106">string</span><span class="op" id="8507112">{</span><span class="string" id="8507113">&#34;foo\x00bar\x00baz&#34;</span><span class="op" id="8507132">}</span><span class="op" id="8507133">}</span><span class="op" id="8507134">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8507137">{</span><span class="ident" id="8507138">CRAMMD5Auth</span><span class="op" id="8507149">(</span><span class="string" id="8507150">&#34;user&#34;</span><span class="op" id="8507156">,</span>&nbsp;<span class="string" id="8507158">&#34;pass&#34;</span><span class="op" id="8507164">)</span><span class="op" id="8507165">,</span>&nbsp;<span class="op" id="8507167">[</span><span class="op" id="8507168">]</span><span class="builtintype" id="8507169">string</span><span class="op" id="8507175">{</span><span class="string" id="8507176">&#34;&lt;123456.1322876914@testserver&gt;&#34;</span><span class="op" id="8507208">}</span><span class="op" id="8507209">,</span>&nbsp;<span class="string" id="8507211">&#34;CRAM-MD5&#34;</span><span class="op" id="8507221">,</span>&nbsp;<span class="op" id="8507223">[</span><span class="op" id="8507224">]</span><span class="builtintype" id="8507225">string</span><span class="op" id="8507231">{</span><span class="string" id="8507232">&#34;&#34;</span><span class="op" id="8507234">,</span>&nbsp;<span class="string" id="8507236">&#34;user&nbsp;287eb355114cf5c471c26a875f1ca4ae&#34;</span><span class="op" id="8507275">}</span><span class="op" id="8507276">}</span><span class="op" id="8507277">,</span><br>
<span class="lineno"></span><span class="op" id="8507279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8507282">func</span>&nbsp;<span class="ident" id="8507287">TestAuth</span><span class="op" id="8507295">(</span><span class="ident" id="8507296">t</span>&nbsp;<span class="op" id="8507298">*</span><span class="ident" id="8507299">testing</span><span class="op" id="8507306">.</span><span class="ident" id="8507307">T</span><span class="op" id="8507308">)</span>&nbsp;<span class="op" id="8507310">{</span><br>
<span class="lineno"></span><span class="ident" id="8507312">testLoop</span><span class="op" id="8507320">:</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8507323">for</span>&nbsp;<span class="ident" id="8507327">i</span><span class="op" id="8507328">,</span>&nbsp;<span class="ident" id="8507330">test</span>&nbsp;<span class="op" id="8507335">:=</span>&nbsp;<span class="keyword" id="8507338">range</span>&nbsp;<span class="ident" id="8507344">authTests</span>&nbsp;<span class="op" id="8507354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8507358">name</span><span class="op" id="8507362">,</span>&nbsp;<span class="ident" id="8507364">resp</span><span class="op" id="8507368">,</span>&nbsp;<span class="ident" id="8507370">err</span>&nbsp;<span class="op" id="8507374">:=</span>&nbsp;<span class="ident" id="8507377">test</span><span class="op" id="8507381">.</span><span class="ident" id="8507382">auth</span><span class="op" id="8507386">.</span><span class="ident" id="8507387">Start</span><span class="op" id="8507392">(</span><span class="op" id="8507393">&amp;</span><span class="ident" id="8507394">ServerInfo</span><span class="op" id="8507404">{</span><span class="string" id="8507405">&#34;testserver&#34;</span><span class="op" id="8507417">,</span>&nbsp;<span class="builtintype" id="8507419">true</span><span class="op" id="8507423">,</span>&nbsp;<span class="ident" id="8507425">nil</span><span class="op" id="8507428">}</span><span class="op" id="8507429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8507433">if</span>&nbsp;<span class="ident" id="8507436">name</span>&nbsp;<span class="op" id="8507441">!=</span>&nbsp;<span class="ident" id="8507444">test</span><span class="op" id="8507448">.</span><span class="ident" id="8507449">name</span>&nbsp;<span class="op" id="8507454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8507459">t</span><span class="op" id="8507460">.</span><span class="ident" id="8507461">Errorf</span><span class="op" id="8507467">(</span><span class="string" id="8507468">&#34;#%d&nbsp;got&nbsp;name&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8507498">,</span>&nbsp;<span class="ident" id="8507500">i</span><span class="op" id="8507501">,</span>&nbsp;<span class="ident" id="8507503">name</span><span class="op" id="8507507">,</span>&nbsp;<span class="ident" id="8507509">test</span><span class="op" id="8507513">.</span><span class="ident" id="8507514">name</span><span class="op" id="8507518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8507522">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8507526">if</span>&nbsp;<span class="op" id="8507529">!</span><span class="ident" id="8507530">bytes</span><span class="op" id="8507535">.</span><span class="ident" id="8507536">Equal</span><span class="op" id="8507541">(</span><span class="ident" id="8507542">resp</span><span class="op" id="8507546">,</span>&nbsp;<span class="op" id="8507548">[</span><span class="op" id="8507549">]</span><span class="builtintype" id="8507550">byte</span><span class="op" id="8507554">(</span><span class="ident" id="8507555">test</span><span class="op" id="8507559">.</span><span class="ident" id="8507560">responses</span><span class="op" id="8507569">[</span><span class="num" id="8507570">0</span><span class="op" id="8507571">]</span><span class="op" id="8507572">)</span><span class="op" id="8507573">)</span>&nbsp;<span class="op" id="8507575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8507580">t</span><span class="op" id="8507581">.</span><span class="ident" id="8507582">Errorf</span><span class="op" id="8507588">(</span><span class="string" id="8507589">&#34;#%d&nbsp;got&nbsp;response&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8507623">,</span>&nbsp;<span class="ident" id="8507625">i</span><span class="op" id="8507626">,</span>&nbsp;<span class="ident" id="8507628">resp</span><span class="op" id="8507632">,</span>&nbsp;<span class="ident" id="8507634">test</span><span class="op" id="8507638">.</span><span class="ident" id="8507639">responses</span><span class="op" id="8507648">[</span><span class="num" id="8507649">0</span><span class="op" id="8507650">]</span><span class="op" id="8507651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8507655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8507659">if</span>&nbsp;<span class="ident" id="8507662">err</span>&nbsp;<span class="op" id="8507666">!=</span>&nbsp;<span class="ident" id="8507669">nil</span>&nbsp;<span class="op" id="8507673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8507678">t</span><span class="op" id="8507679">.</span><span class="ident" id="8507680">Errorf</span><span class="op" id="8507686">(</span><span class="string" id="8507687">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="8507702">,</span>&nbsp;<span class="ident" id="8507704">i</span><span class="op" id="8507705">,</span>&nbsp;<span class="ident" id="8507707">err</span><span class="op" id="8507710">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8507714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8507718">for</span>&nbsp;<span class="ident" id="8507722">j</span>&nbsp;<span class="op" id="8507724">:=</span>&nbsp;<span class="keyword" id="8507727">range</span>&nbsp;<span class="ident" id="8507733">test</span><span class="op" id="8507737">.</span><span class="ident" id="8507738">challenges</span>&nbsp;<span class="op" id="8507749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8507754">challenge</span>&nbsp;<span class="op" id="8507764">:=</span>&nbsp;<span class="op" id="8507767">[</span><span class="op" id="8507768">]</span><span class="builtintype" id="8507769">byte</span><span class="op" id="8507773">(</span><span class="ident" id="8507774">test</span><span class="op" id="8507778">.</span><span class="ident" id="8507779">challenges</span><span class="op" id="8507789">[</span><span class="ident" id="8507790">j</span><span class="op" id="8507791">]</span><span class="op" id="8507792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8507797">expected</span>&nbsp;<span class="op" id="8507806">:=</span>&nbsp;<span class="op" id="8507809">[</span><span class="op" id="8507810">]</span><span class="builtintype" id="8507811">byte</span><span class="op" id="8507815">(</span><span class="ident" id="8507816">test</span><span class="op" id="8507820">.</span><span class="ident" id="8507821">responses</span><span class="op" id="8507830">[</span><span class="ident" id="8507831">j</span><span class="op" id="8507832">+</span><span class="num" id="8507833">1</span><span class="op" id="8507834">]</span><span class="op" id="8507835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8507840">resp</span><span class="op" id="8507844">,</span>&nbsp;<span class="ident" id="8507846">err</span>&nbsp;<span class="op" id="8507850">:=</span>&nbsp;<span class="ident" id="8507853">test</span><span class="op" id="8507857">.</span><span class="ident" id="8507858">auth</span><span class="op" id="8507862">.</span><span class="ident" id="8507863">Next</span><span class="op" id="8507867">(</span><span class="ident" id="8507868">challenge</span><span class="op" id="8507877">,</span>&nbsp;<span class="builtintype" id="8507879">true</span><span class="op" id="8507883">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8507888">if</span>&nbsp;<span class="ident" id="8507891">err</span>&nbsp;<span class="op" id="8507895">!=</span>&nbsp;<span class="ident" id="8507898">nil</span>&nbsp;<span class="op" id="8507902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8507908">t</span><span class="op" id="8507909">.</span><span class="ident" id="8507910">Errorf</span><span class="op" id="8507916">(</span><span class="string" id="8507917">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="8507932">,</span>&nbsp;<span class="ident" id="8507934">i</span><span class="op" id="8507935">,</span>&nbsp;<span class="ident" id="8507937">err</span><span class="op" id="8507940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8507946">continue</span>&nbsp;<span class="ident" id="8507955">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8507967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8507972">if</span>&nbsp;<span class="op" id="8507975">!</span><span class="ident" id="8507976">bytes</span><span class="op" id="8507981">.</span><span class="ident" id="8507982">Equal</span><span class="op" id="8507987">(</span><span class="ident" id="8507988">resp</span><span class="op" id="8507992">,</span>&nbsp;<span class="ident" id="8507994">expected</span><span class="op" id="8508002">)</span>&nbsp;<span class="op" id="8508004">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508010">t</span><span class="op" id="8508011">.</span><span class="ident" id="8508012">Errorf</span><span class="op" id="8508018">(</span><span class="string" id="8508019">&#34;#%d&nbsp;got&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="8508044">,</span>&nbsp;<span class="ident" id="8508046">i</span><span class="op" id="8508047">,</span>&nbsp;<span class="ident" id="8508049">resp</span><span class="op" id="8508053">,</span>&nbsp;<span class="ident" id="8508055">expected</span><span class="op" id="8508063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8508069">continue</span>&nbsp;<span class="ident" id="8508078">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508097">}</span><br>
<span class="lineno">60</span><span class="op" id="8508099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8508102">func</span>&nbsp;<span class="ident" id="8508107">TestAuthPlain</span><span class="op" id="8508120">(</span><span class="ident" id="8508121">t</span>&nbsp;<span class="op" id="8508123">*</span><span class="ident" id="8508124">testing</span><span class="op" id="8508131">.</span><span class="ident" id="8508132">T</span><span class="op" id="8508133">)</span>&nbsp;<span class="op" id="8508135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508138">auth</span>&nbsp;<span class="op" id="8508143">:=</span>&nbsp;<span class="ident" id="8508146">PlainAuth</span><span class="op" id="8508155">(</span><span class="string" id="8508156">&#34;foo&#34;</span><span class="op" id="8508161">,</span>&nbsp;<span class="string" id="8508163">&#34;bar&#34;</span><span class="op" id="8508168">,</span>&nbsp;<span class="string" id="8508170">&#34;baz&#34;</span><span class="op" id="8508175">,</span>&nbsp;<span class="string" id="8508177">&#34;servername&#34;</span><span class="op" id="8508189">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508193">tests</span>&nbsp;<span class="op" id="8508199">:=</span>&nbsp;<span class="op" id="8508202">[</span><span class="op" id="8508203">]</span><span class="keyword" id="8508204">struct</span>&nbsp;<span class="op" id="8508211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508215">server</span>&nbsp;<span class="op" id="8508222">*</span><span class="ident" id="8508223">ServerInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508236">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8508243">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508251">}</span><span class="op" id="8508252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508256">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508261">server</span><span class="op" id="8508267">:</span>&nbsp;<span class="op" id="8508269">&amp;</span><span class="ident" id="8508270">ServerInfo</span><span class="op" id="8508280">{</span><span class="ident" id="8508281">Name</span><span class="op" id="8508285">:</span>&nbsp;<span class="string" id="8508287">&#34;servername&#34;</span><span class="op" id="8508299">,</span>&nbsp;<span class="ident" id="8508301">TLS</span><span class="op" id="8508304">:</span>&nbsp;<span class="builtintype" id="8508306">true</span><span class="op" id="8508310">}</span><span class="op" id="8508311">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508315">}</span><span class="op" id="8508316">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8508325">//&nbsp;Okay;&nbsp;explicitly&nbsp;advertised&nbsp;by&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508370">server</span><span class="op" id="8508376">:</span>&nbsp;<span class="op" id="8508378">&amp;</span><span class="ident" id="8508379">ServerInfo</span><span class="op" id="8508389">{</span><span class="ident" id="8508390">Name</span><span class="op" id="8508394">:</span>&nbsp;<span class="string" id="8508396">&#34;servername&#34;</span><span class="op" id="8508408">,</span>&nbsp;<span class="ident" id="8508410">Auth</span><span class="op" id="8508414">:</span>&nbsp;<span class="op" id="8508416">[</span><span class="op" id="8508417">]</span><span class="builtintype" id="8508418">string</span><span class="op" id="8508424">{</span><span class="string" id="8508425">&#34;PLAIN&#34;</span><span class="op" id="8508432">}</span><span class="op" id="8508433">}</span><span class="op" id="8508434">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508438">}</span><span class="op" id="8508439">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508448">server</span><span class="op" id="8508454">:</span>&nbsp;<span class="op" id="8508456">&amp;</span><span class="ident" id="8508457">ServerInfo</span><span class="op" id="8508467">{</span><span class="ident" id="8508468">Name</span><span class="op" id="8508472">:</span>&nbsp;<span class="string" id="8508474">&#34;servername&#34;</span><span class="op" id="8508486">,</span>&nbsp;<span class="ident" id="8508488">Auth</span><span class="op" id="8508492">:</span>&nbsp;<span class="op" id="8508494">[</span><span class="op" id="8508495">]</span><span class="builtintype" id="8508496">string</span><span class="op" id="8508502">{</span><span class="string" id="8508503">&#34;CRAM-MD5&#34;</span><span class="op" id="8508513">}</span><span class="op" id="8508514">}</span><span class="op" id="8508515">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508520">err</span><span class="op" id="8508523">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8508528">&#34;unencrypted&nbsp;connection&#34;</span><span class="op" id="8508552">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508556">}</span><span class="op" id="8508557">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508566">server</span><span class="op" id="8508572">:</span>&nbsp;<span class="op" id="8508574">&amp;</span><span class="ident" id="8508575">ServerInfo</span><span class="op" id="8508585">{</span><span class="ident" id="8508586">Name</span><span class="op" id="8508590">:</span>&nbsp;<span class="string" id="8508592">&#34;attacker&#34;</span><span class="op" id="8508602">,</span>&nbsp;<span class="ident" id="8508604">TLS</span><span class="op" id="8508607">:</span>&nbsp;<span class="builtintype" id="8508609">true</span><span class="op" id="8508613">}</span><span class="op" id="8508614">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508619">err</span><span class="op" id="8508622">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8508627">&#34;wrong&nbsp;host&nbsp;name&#34;</span><span class="op" id="8508644">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508648">}</span><span class="op" id="8508649">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508652">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8508655">for</span>&nbsp;<span class="ident" id="8508659">i</span><span class="op" id="8508660">,</span>&nbsp;<span class="ident" id="8508662">tt</span>&nbsp;<span class="op" id="8508665">:=</span>&nbsp;<span class="keyword" id="8508668">range</span>&nbsp;<span class="ident" id="8508674">tests</span>&nbsp;<span class="op" id="8508680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508684">_</span><span class="op" id="8508685">,</span>&nbsp;<span class="ident" id="8508687">_</span><span class="op" id="8508688">,</span>&nbsp;<span class="ident" id="8508690">err</span>&nbsp;<span class="op" id="8508694">:=</span>&nbsp;<span class="ident" id="8508697">auth</span><span class="op" id="8508701">.</span><span class="ident" id="8508702">Start</span><span class="op" id="8508707">(</span><span class="ident" id="8508708">tt</span><span class="op" id="8508710">.</span><span class="ident" id="8508711">server</span><span class="op" id="8508717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508721">got</span>&nbsp;<span class="op" id="8508725">:=</span>&nbsp;<span class="string" id="8508728">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8508733">if</span>&nbsp;<span class="ident" id="8508736">err</span>&nbsp;<span class="op" id="8508740">!=</span>&nbsp;<span class="ident" id="8508743">nil</span>&nbsp;<span class="op" id="8508747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508752">got</span>&nbsp;<span class="op" id="8508756">=</span>&nbsp;<span class="ident" id="8508758">err</span><span class="op" id="8508761">.</span><span class="ident" id="8508762">Error</span><span class="op" id="8508767">(</span><span class="op" id="8508768">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8508776">if</span>&nbsp;<span class="ident" id="8508779">got</span>&nbsp;<span class="op" id="8508783">!=</span>&nbsp;<span class="ident" id="8508786">tt</span><span class="op" id="8508788">.</span><span class="ident" id="8508789">err</span>&nbsp;<span class="op" id="8508793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508798">t</span><span class="op" id="8508799">.</span><span class="ident" id="8508800">Errorf</span><span class="op" id="8508806">(</span><span class="string" id="8508807">&#34;%d.&nbsp;got&nbsp;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8508836">,</span>&nbsp;<span class="ident" id="8508838">i</span><span class="op" id="8508839">,</span>&nbsp;<span class="ident" id="8508841">got</span><span class="op" id="8508844">,</span>&nbsp;<span class="ident" id="8508846">tt</span><span class="op" id="8508848">.</span><span class="ident" id="8508849">err</span><span class="op" id="8508852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8508859">}</span><br>
<span class="lineno">95</span><span class="op" id="8508861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8508864">type</span>&nbsp;<span class="ident" id="8508869">faker</span>&nbsp;<span class="keyword" id="8508875">struct</span>&nbsp;<span class="op" id="8508882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8508885">io</span><span class="op" id="8508887">.</span><span class="ident" id="8508888">ReadWriter</span><br>
<span class="lineno"></span><span class="op" id="8508899">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="8508902">func</span>&nbsp;<span class="op" id="8508907">(</span><span class="ident" id="8508908">f</span>&nbsp;<span class="ident" id="8508910">faker</span><span class="op" id="8508915">)</span>&nbsp;<span class="ident" id="8508917">Close</span><span class="op" id="8508922">(</span><span class="op" id="8508923">)</span>&nbsp;<span class="builtintype" id="8508925">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8508951">{</span>&nbsp;<span class="keyword" id="8508953">return</span>&nbsp;<span class="ident" id="8508960">nil</span>&nbsp;<span class="op" id="8508964">}</span><br>
<span class="lineno"></span><span class="keyword" id="8508966">func</span>&nbsp;<span class="op" id="8508971">(</span><span class="ident" id="8508972">f</span>&nbsp;<span class="ident" id="8508974">faker</span><span class="op" id="8508979">)</span>&nbsp;<span class="ident" id="8508981">LocalAddr</span><span class="op" id="8508990">(</span><span class="op" id="8508991">)</span>&nbsp;<span class="ident" id="8508993">net</span><span class="op" id="8508996">.</span><span class="ident" id="8508997">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8509015">{</span>&nbsp;<span class="keyword" id="8509017">return</span>&nbsp;<span class="ident" id="8509024">nil</span>&nbsp;<span class="op" id="8509028">}</span><br>
<span class="lineno"></span><span class="keyword" id="8509030">func</span>&nbsp;<span class="op" id="8509035">(</span><span class="ident" id="8509036">f</span>&nbsp;<span class="ident" id="8509038">faker</span><span class="op" id="8509043">)</span>&nbsp;<span class="ident" id="8509045">RemoteAddr</span><span class="op" id="8509055">(</span><span class="op" id="8509056">)</span>&nbsp;<span class="ident" id="8509058">net</span><span class="op" id="8509061">.</span><span class="ident" id="8509062">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8509079">{</span>&nbsp;<span class="keyword" id="8509081">return</span>&nbsp;<span class="ident" id="8509088">nil</span>&nbsp;<span class="op" id="8509092">}</span><br>
<span class="lineno"></span><span class="keyword" id="8509094">func</span>&nbsp;<span class="op" id="8509099">(</span><span class="ident" id="8509100">f</span>&nbsp;<span class="ident" id="8509102">faker</span><span class="op" id="8509107">)</span>&nbsp;<span class="ident" id="8509109">SetDeadline</span><span class="op" id="8509120">(</span><span class="ident" id="8509121">time</span><span class="op" id="8509125">.</span><span class="ident" id="8509126">Time</span><span class="op" id="8509130">)</span>&nbsp;<span class="builtintype" id="8509132">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8509143">{</span>&nbsp;<span class="keyword" id="8509145">return</span>&nbsp;<span class="ident" id="8509152">nil</span>&nbsp;<span class="op" id="8509156">}</span><br>
<span class="lineno">105</span><span class="keyword" id="8509158">func</span>&nbsp;<span class="op" id="8509163">(</span><span class="ident" id="8509164">f</span>&nbsp;<span class="ident" id="8509166">faker</span><span class="op" id="8509171">)</span>&nbsp;<span class="ident" id="8509173">SetReadDeadline</span><span class="op" id="8509188">(</span><span class="ident" id="8509189">time</span><span class="op" id="8509193">.</span><span class="ident" id="8509194">Time</span><span class="op" id="8509198">)</span>&nbsp;<span class="builtintype" id="8509200">error</span>&nbsp;&nbsp;<span class="op" id="8509207">{</span>&nbsp;<span class="keyword" id="8509209">return</span>&nbsp;<span class="ident" id="8509216">nil</span>&nbsp;<span class="op" id="8509220">}</span><br>
<span class="lineno"></span><span class="keyword" id="8509222">func</span>&nbsp;<span class="op" id="8509227">(</span><span class="ident" id="8509228">f</span>&nbsp;<span class="ident" id="8509230">faker</span><span class="op" id="8509235">)</span>&nbsp;<span class="ident" id="8509237">SetWriteDeadline</span><span class="op" id="8509253">(</span><span class="ident" id="8509254">time</span><span class="op" id="8509258">.</span><span class="ident" id="8509259">Time</span><span class="op" id="8509263">)</span>&nbsp;<span class="builtintype" id="8509265">error</span>&nbsp;<span class="op" id="8509271">{</span>&nbsp;<span class="keyword" id="8509273">return</span>&nbsp;<span class="ident" id="8509280">nil</span>&nbsp;<span class="op" id="8509284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8509287">func</span>&nbsp;<span class="ident" id="8509292">TestBasic</span><span class="op" id="8509301">(</span><span class="ident" id="8509302">t</span>&nbsp;<span class="op" id="8509304">*</span><span class="ident" id="8509305">testing</span><span class="op" id="8509312">.</span><span class="ident" id="8509313">T</span><span class="op" id="8509314">)</span>&nbsp;<span class="op" id="8509316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8509319">server</span>&nbsp;<span class="op" id="8509326">:=</span>&nbsp;<span class="ident" id="8509329">strings</span><span class="op" id="8509336">.</span><span class="ident" id="8509337">Join</span><span class="op" id="8509341">(</span><span class="ident" id="8509342">strings</span><span class="op" id="8509349">.</span><span class="ident" id="8509350">Split</span><span class="op" id="8509355">(</span><span class="ident" id="8509356">basicServer</span><span class="op" id="8509367">,</span>&nbsp;<span class="string" id="8509369">&#34;\n&#34;</span><span class="op" id="8509373">)</span><span class="op" id="8509374">,</span>&nbsp;<span class="string" id="8509376">&#34;\r\n&#34;</span><span class="op" id="8509382">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8509385">client</span>&nbsp;<span class="op" id="8509392">:=</span>&nbsp;<span class="ident" id="8509395">strings</span><span class="op" id="8509402">.</span><span class="ident" id="8509403">Join</span><span class="op" id="8509407">(</span><span class="ident" id="8509408">strings</span><span class="op" id="8509415">.</span><span class="ident" id="8509416">Split</span><span class="op" id="8509421">(</span><span class="ident" id="8509422">basicClient</span><span class="op" id="8509433">,</span>&nbsp;<span class="string" id="8509435">&#34;\n&#34;</span><span class="op" id="8509439">)</span><span class="op" id="8509440">,</span>&nbsp;<span class="string" id="8509442">&#34;\r\n&#34;</span><span class="op" id="8509448">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8509452">var</span>&nbsp;<span class="ident" id="8509456">cmdbuf</span>&nbsp;<span class="ident" id="8509463">bytes</span><span class="op" id="8509468">.</span><span class="ident" id="8509469">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8509477">bcmdbuf</span>&nbsp;<span class="op" id="8509485">:=</span>&nbsp;<span class="ident" id="8509488">bufio</span><span class="op" id="8509493">.</span><span class="ident" id="8509494">NewWriter</span><span class="op" id="8509503">(</span><span class="op" id="8509504">&amp;</span><span class="ident" id="8509505">cmdbuf</span><span class="op" id="8509511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8509514">var</span>&nbsp;<span class="ident" id="8509518">fake</span>&nbsp;<span class="ident" id="8509523">faker</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8509530">fake</span><span class="op" id="8509534">.</span><span class="ident" id="8509535">ReadWriter</span>&nbsp;<span class="op" id="8509546">=</span>&nbsp;<span class="ident" id="8509548">bufio</span><span class="op" id="8509553">.</span><span class="ident" id="8509554">NewReadWriter</span><span class="op" id="8509567">(</span><span class="ident" id="8509568">bufio</span><span class="op" id="8509573">.</span><span class="ident" id="8509574">NewReader</span><span class="op" id="8509583">(</span><span class="ident" id="8509584">strings</span><span class="op" id="8509591">.</span><span class="ident" id="8509592">NewReader</span><span class="op" id="8509601">(</span><span class="ident" id="8509602">server</span><span class="op" id="8509608">)</span><span class="op" id="8509609">)</span><span class="op" id="8509610">,</span>&nbsp;<span class="ident" id="8509612">bcmdbuf</span><span class="op" id="8509619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8509622">c</span>&nbsp;<span class="op" id="8509624">:=</span>&nbsp;<span class="op" id="8509627">&amp;</span><span class="ident" id="8509628">Client</span><span class="op" id="8509634">{</span><span class="ident" id="8509635">Text</span><span class="op" id="8509639">:</span>&nbsp;<span class="ident" id="8509641">textproto</span><span class="op" id="8509650">.</span><span class="ident" id="8509651">NewConn</span><span class="op" id="8509658">(</span><span class="ident" id="8509659">fake</span><span class="op" id="8509663">)</span><span class="op" id="8509664">,</span>&nbsp;<span class="ident" id="8509666">localName</span><span class="op" id="8509675">:</span>&nbsp;<span class="string" id="8509677">&#34;localhost&#34;</span><span class="op" id="8509688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8509692">if</span>&nbsp;<span class="ident" id="8509695">err</span>&nbsp;<span class="op" id="8509699">:=</span>&nbsp;<span class="ident" id="8509702">c</span><span class="op" id="8509703">.</span><span class="ident" id="8509704">helo</span><span class="op" id="8509708">(</span><span class="op" id="8509709">)</span><span class="op" id="8509710">;</span>&nbsp;<span class="ident" id="8509712">err</span>&nbsp;<span class="op" id="8509716">!=</span>&nbsp;<span class="ident" id="8509719">nil</span>&nbsp;<span class="op" id="8509723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8509727">t</span><span class="op" id="8509728">.</span><span class="ident" id="8509729">Fatalf</span><span class="op" id="8509735">(</span><span class="string" id="8509736">&#34;HELO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8509753">,</span>&nbsp;<span class="ident" id="8509755">err</span><span class="op" id="8509758">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8509761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8509764">if</span>&nbsp;<span class="ident" id="8509767">err</span>&nbsp;<span class="op" id="8509771">:=</span>&nbsp;<span class="ident" id="8509774">c</span><span class="op" id="8509775">.</span><span class="ident" id="8509776">ehlo</span><span class="op" id="8509780">(</span><span class="op" id="8509781">)</span><span class="op" id="8509782">;</span>&nbsp;<span class="ident" id="8509784">err</span>&nbsp;<span class="op" id="8509788">==</span>&nbsp;<span class="ident" id="8509791">nil</span>&nbsp;<span class="op" id="8509795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8509799">t</span><span class="op" id="8509800">.</span><span class="ident" id="8509801">Fatalf</span><span class="op" id="8509807">(</span><span class="string" id="8509808">&#34;Expected&nbsp;first&nbsp;EHLO&nbsp;to&nbsp;fail&#34;</span><span class="op" id="8509837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8509840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8509843">if</span>&nbsp;<span class="ident" id="8509846">err</span>&nbsp;<span class="op" id="8509850">:=</span>&nbsp;<span class="ident" id="8509853">c</span><span class="op" id="8509854">.</span><span class="ident" id="8509855">ehlo</span><span class="op" id="8509859">(</span><span class="op" id="8509860">)</span><span class="op" id="8509861">;</span>&nbsp;<span class="ident" id="8509863">err</span>&nbsp;<span class="op" id="8509867">!=</span>&nbsp;<span class="ident" id="8509870">nil</span>&nbsp;<span class="op" id="8509874">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8509878">t</span><span class="op" id="8509879">.</span><span class="ident" id="8509880">Fatalf</span><span class="op" id="8509886">(</span><span class="string" id="8509887">&#34;Second&nbsp;EHLO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8509911">,</span>&nbsp;<span class="ident" id="8509913">err</span><span class="op" id="8509916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8509919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8509923">c</span><span class="op" id="8509924">.</span><span class="ident" id="8509925">didHello</span>&nbsp;<span class="op" id="8509934">=</span>&nbsp;<span class="builtintype" id="8509936">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8509942">if</span>&nbsp;<span class="ident" id="8509945">ok</span><span class="op" id="8509947">,</span>&nbsp;<span class="ident" id="8509949">args</span>&nbsp;<span class="op" id="8509954">:=</span>&nbsp;<span class="ident" id="8509957">c</span><span class="op" id="8509958">.</span><span class="ident" id="8509959">Extension</span><span class="op" id="8509968">(</span><span class="string" id="8509969">&#34;aUtH&#34;</span><span class="op" id="8509975">)</span><span class="op" id="8509976">;</span>&nbsp;<span class="op" id="8509978">!</span><span class="ident" id="8509979">ok</span>&nbsp;<span class="op" id="8509982">||</span>&nbsp;<span class="ident" id="8509985">args</span>&nbsp;<span class="op" id="8509990">!=</span>&nbsp;<span class="string" id="8509993">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="8510007">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510011">t</span><span class="op" id="8510012">.</span><span class="ident" id="8510013">Fatalf</span><span class="op" id="8510019">(</span><span class="string" id="8510020">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="8510045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8510048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8510051">if</span>&nbsp;<span class="ident" id="8510054">ok</span><span class="op" id="8510056">,</span>&nbsp;<span class="ident" id="8510058">_</span>&nbsp;<span class="op" id="8510060">:=</span>&nbsp;<span class="ident" id="8510063">c</span><span class="op" id="8510064">.</span><span class="ident" id="8510065">Extension</span><span class="op" id="8510074">(</span><span class="string" id="8510075">&#34;DSN&#34;</span><span class="op" id="8510080">)</span><span class="op" id="8510081">;</span>&nbsp;<span class="ident" id="8510083">ok</span>&nbsp;<span class="op" id="8510086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510090">t</span><span class="op" id="8510091">.</span><span class="ident" id="8510092">Fatalf</span><span class="op" id="8510098">(</span><span class="string" id="8510099">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8510122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8510125">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8510129">if</span>&nbsp;<span class="ident" id="8510132">err</span>&nbsp;<span class="op" id="8510136">:=</span>&nbsp;<span class="ident" id="8510139">c</span><span class="op" id="8510140">.</span><span class="ident" id="8510141">Mail</span><span class="op" id="8510145">(</span><span class="string" id="8510146">&#34;user@gmail.com&#34;</span><span class="op" id="8510162">)</span><span class="op" id="8510163">;</span>&nbsp;<span class="ident" id="8510165">err</span>&nbsp;<span class="op" id="8510169">==</span>&nbsp;<span class="ident" id="8510172">nil</span>&nbsp;<span class="op" id="8510176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510180">t</span><span class="op" id="8510181">.</span><span class="ident" id="8510182">Fatalf</span><span class="op" id="8510188">(</span><span class="string" id="8510189">&#34;MAIL&nbsp;should&nbsp;require&nbsp;authentication&#34;</span><span class="op" id="8510225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8510228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8510232">if</span>&nbsp;<span class="ident" id="8510235">err</span>&nbsp;<span class="op" id="8510239">:=</span>&nbsp;<span class="ident" id="8510242">c</span><span class="op" id="8510243">.</span><span class="ident" id="8510244">Verify</span><span class="op" id="8510250">(</span><span class="string" id="8510251">&#34;user1@gmail.com&#34;</span><span class="op" id="8510268">)</span><span class="op" id="8510269">;</span>&nbsp;<span class="ident" id="8510271">err</span>&nbsp;<span class="op" id="8510275">==</span>&nbsp;<span class="ident" id="8510278">nil</span>&nbsp;<span class="op" id="8510282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510286">t</span><span class="op" id="8510287">.</span><span class="ident" id="8510288">Fatalf</span><span class="op" id="8510294">(</span><span class="string" id="8510295">&#34;First&nbsp;VRFY:&nbsp;expected&nbsp;no&nbsp;verification&#34;</span><span class="op" id="8510333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8510336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8510339">if</span>&nbsp;<span class="ident" id="8510342">err</span>&nbsp;<span class="op" id="8510346">:=</span>&nbsp;<span class="ident" id="8510349">c</span><span class="op" id="8510350">.</span><span class="ident" id="8510351">Verify</span><span class="op" id="8510357">(</span><span class="string" id="8510358">&#34;user2@gmail.com&#34;</span><span class="op" id="8510375">)</span><span class="op" id="8510376">;</span>&nbsp;<span class="ident" id="8510378">err</span>&nbsp;<span class="op" id="8510382">!=</span>&nbsp;<span class="ident" id="8510385">nil</span>&nbsp;<span class="op" id="8510389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510393">t</span><span class="op" id="8510394">.</span><span class="ident" id="8510395">Fatalf</span><span class="op" id="8510401">(</span><span class="string" id="8510402">&#34;Second&nbsp;VRFY:&nbsp;expected&nbsp;verification,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="8510446">,</span>&nbsp;<span class="ident" id="8510448">err</span><span class="op" id="8510451">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8510454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8510458">//&nbsp;fake&nbsp;TLS&nbsp;so&nbsp;authentication&nbsp;won&#39;t&nbsp;complain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510504">c</span><span class="op" id="8510505">.</span><span class="ident" id="8510506">tls</span>&nbsp;<span class="op" id="8510510">=</span>&nbsp;<span class="builtintype" id="8510512">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510518">c</span><span class="op" id="8510519">.</span><span class="ident" id="8510520">serverName</span>&nbsp;<span class="op" id="8510531">=</span>&nbsp;<span class="string" id="8510533">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8510552">if</span>&nbsp;<span class="ident" id="8510555">err</span>&nbsp;<span class="op" id="8510559">:=</span>&nbsp;<span class="ident" id="8510562">c</span><span class="op" id="8510563">.</span><span class="ident" id="8510564">Auth</span><span class="op" id="8510568">(</span><span class="ident" id="8510569">PlainAuth</span><span class="op" id="8510578">(</span><span class="string" id="8510579">&#34;&#34;</span><span class="op" id="8510581">,</span>&nbsp;<span class="string" id="8510583">&#34;user&#34;</span><span class="op" id="8510589">,</span>&nbsp;<span class="string" id="8510591">&#34;pass&#34;</span><span class="op" id="8510597">,</span>&nbsp;<span class="string" id="8510599">&#34;smtp.google.com&#34;</span><span class="op" id="8510616">)</span><span class="op" id="8510617">)</span><span class="op" id="8510618">;</span>&nbsp;<span class="ident" id="8510620">err</span>&nbsp;<span class="op" id="8510624">!=</span>&nbsp;<span class="ident" id="8510627">nil</span>&nbsp;<span class="op" id="8510631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510635">t</span><span class="op" id="8510636">.</span><span class="ident" id="8510637">Fatalf</span><span class="op" id="8510643">(</span><span class="string" id="8510644">&#34;AUTH&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8510661">,</span>&nbsp;<span class="ident" id="8510663">err</span><span class="op" id="8510666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8510669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8510673">if</span>&nbsp;<span class="ident" id="8510676">err</span>&nbsp;<span class="op" id="8510680">:=</span>&nbsp;<span class="ident" id="8510683">c</span><span class="op" id="8510684">.</span><span class="ident" id="8510685">Mail</span><span class="op" id="8510689">(</span><span class="string" id="8510690">&#34;user@gmail.com&#34;</span><span class="op" id="8510706">)</span><span class="op" id="8510707">;</span>&nbsp;<span class="ident" id="8510709">err</span>&nbsp;<span class="op" id="8510713">!=</span>&nbsp;<span class="ident" id="8510716">nil</span>&nbsp;<span class="op" id="8510720">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510724">t</span><span class="op" id="8510725">.</span><span class="ident" id="8510726">Fatalf</span><span class="op" id="8510732">(</span><span class="string" id="8510733">&#34;MAIL&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8510750">,</span>&nbsp;<span class="ident" id="8510752">err</span><span class="op" id="8510755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8510758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8510761">if</span>&nbsp;<span class="ident" id="8510764">err</span>&nbsp;<span class="op" id="8510768">:=</span>&nbsp;<span class="ident" id="8510771">c</span><span class="op" id="8510772">.</span><span class="ident" id="8510773">Rcpt</span><span class="op" id="8510777">(</span><span class="string" id="8510778">&#34;golang-nuts@googlegroups.com&#34;</span><span class="op" id="8510808">)</span><span class="op" id="8510809">;</span>&nbsp;<span class="ident" id="8510811">err</span>&nbsp;<span class="op" id="8510815">!=</span>&nbsp;<span class="ident" id="8510818">nil</span>&nbsp;<span class="op" id="8510822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510826">t</span><span class="op" id="8510827">.</span><span class="ident" id="8510828">Fatalf</span><span class="op" id="8510834">(</span><span class="string" id="8510835">&#34;RCPT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8510852">,</span>&nbsp;<span class="ident" id="8510854">err</span><span class="op" id="8510857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8510860">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510863">msg</span>&nbsp;<span class="op" id="8510867">:=</span>&nbsp;<span class="string" id="8510870">`From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno"></span>Line&nbsp;1<br>
<span class="lineno">165</span>.Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8510987">w</span><span class="op" id="8510988">,</span>&nbsp;<span class="ident" id="8510990">err</span>&nbsp;<span class="op" id="8510994">:=</span>&nbsp;<span class="ident" id="8510997">c</span><span class="op" id="8510998">.</span><span class="ident" id="8510999">Data</span><span class="op" id="8511003">(</span><span class="op" id="8511004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511007">if</span>&nbsp;<span class="ident" id="8511010">err</span>&nbsp;<span class="op" id="8511014">!=</span>&nbsp;<span class="ident" id="8511017">nil</span>&nbsp;<span class="op" id="8511021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511025">t</span><span class="op" id="8511026">.</span><span class="ident" id="8511027">Fatalf</span><span class="op" id="8511033">(</span><span class="string" id="8511034">&#34;DATA&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8511051">,</span>&nbsp;<span class="ident" id="8511053">err</span><span class="op" id="8511056">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8511059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511062">if</span>&nbsp;<span class="ident" id="8511065">_</span><span class="op" id="8511066">,</span>&nbsp;<span class="ident" id="8511068">err</span>&nbsp;<span class="op" id="8511072">:=</span>&nbsp;<span class="ident" id="8511075">w</span><span class="op" id="8511076">.</span><span class="ident" id="8511077">Write</span><span class="op" id="8511082">(</span><span class="op" id="8511083">[</span><span class="op" id="8511084">]</span><span class="builtintype" id="8511085">byte</span><span class="op" id="8511089">(</span><span class="ident" id="8511090">msg</span><span class="op" id="8511093">)</span><span class="op" id="8511094">)</span><span class="op" id="8511095">;</span>&nbsp;<span class="ident" id="8511097">err</span>&nbsp;<span class="op" id="8511101">!=</span>&nbsp;<span class="ident" id="8511104">nil</span>&nbsp;<span class="op" id="8511108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511112">t</span><span class="op" id="8511113">.</span><span class="ident" id="8511114">Fatalf</span><span class="op" id="8511120">(</span><span class="string" id="8511121">&#34;Data&nbsp;write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8511144">,</span>&nbsp;<span class="ident" id="8511146">err</span><span class="op" id="8511149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8511152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511155">if</span>&nbsp;<span class="ident" id="8511158">err</span>&nbsp;<span class="op" id="8511162">:=</span>&nbsp;<span class="ident" id="8511165">w</span><span class="op" id="8511166">.</span><span class="ident" id="8511167">Close</span><span class="op" id="8511172">(</span><span class="op" id="8511173">)</span><span class="op" id="8511174">;</span>&nbsp;<span class="ident" id="8511176">err</span>&nbsp;<span class="op" id="8511180">!=</span>&nbsp;<span class="ident" id="8511183">nil</span>&nbsp;<span class="op" id="8511187">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511191">t</span><span class="op" id="8511192">.</span><span class="ident" id="8511193">Fatalf</span><span class="op" id="8511199">(</span><span class="string" id="8511200">&#34;Bad&nbsp;data&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="8511223">,</span>&nbsp;<span class="ident" id="8511225">err</span><span class="op" id="8511228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8511231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511235">if</span>&nbsp;<span class="ident" id="8511238">err</span>&nbsp;<span class="op" id="8511242">:=</span>&nbsp;<span class="ident" id="8511245">c</span><span class="op" id="8511246">.</span><span class="ident" id="8511247">Quit</span><span class="op" id="8511251">(</span><span class="op" id="8511252">)</span><span class="op" id="8511253">;</span>&nbsp;<span class="ident" id="8511255">err</span>&nbsp;<span class="op" id="8511259">!=</span>&nbsp;<span class="ident" id="8511262">nil</span>&nbsp;<span class="op" id="8511266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511270">t</span><span class="op" id="8511271">.</span><span class="ident" id="8511272">Fatalf</span><span class="op" id="8511278">(</span><span class="string" id="8511279">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8511296">,</span>&nbsp;<span class="ident" id="8511298">err</span><span class="op" id="8511301">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8511304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511308">bcmdbuf</span><span class="op" id="8511315">.</span><span class="ident" id="8511316">Flush</span><span class="op" id="8511321">(</span><span class="op" id="8511322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511325">actualcmds</span>&nbsp;<span class="op" id="8511336">:=</span>&nbsp;<span class="ident" id="8511339">cmdbuf</span><span class="op" id="8511345">.</span><span class="ident" id="8511346">String</span><span class="op" id="8511352">(</span><span class="op" id="8511353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8511356">if</span>&nbsp;<span class="ident" id="8511359">client</span>&nbsp;<span class="op" id="8511366">!=</span>&nbsp;<span class="ident" id="8511369">actualcmds</span>&nbsp;<span class="op" id="8511380">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8511384">t</span><span class="op" id="8511385">.</span><span class="ident" id="8511386">Fatalf</span><span class="op" id="8511392">(</span><span class="string" id="8511393">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8511418">,</span>&nbsp;<span class="ident" id="8511420">actualcmds</span><span class="op" id="8511430">,</span>&nbsp;<span class="ident" id="8511432">client</span><span class="op" id="8511438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8511441">}</span><br>
<span class="lineno"></span><span class="op" id="8511443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8511446">var</span>&nbsp;<span class="ident" id="8511450">basicServer</span>&nbsp;<span class="op" id="8511462">=</span>&nbsp;<span class="string" id="8511464">`250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno">190</span>502&nbsp;Unrecognized&nbsp;command.<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">195</span>530&nbsp;Authentication&nbsp;required<br>
<span class="lineno"></span>252&nbsp;Send&nbsp;some&nbsp;mail,&nbsp;I&#39;ll&nbsp;try&nbsp;my&nbsp;best<br>
<span class="lineno"></span>250&nbsp;User&nbsp;is&nbsp;valid<br>
<span class="lineno"></span>235&nbsp;Accepted<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;OK<br>
<span class="lineno">200</span>250&nbsp;Receiver&nbsp;OK<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;OK<br>
<span class="lineno"></span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="8511772">var</span>&nbsp;<span class="ident" id="8511776">basicClient</span>&nbsp;<span class="op" id="8511788">=</span>&nbsp;<span class="string" id="8511790">`HELO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno">210</span>VRFY&nbsp;user1@gmail.com<br>
<span class="lineno"></span>VRFY&nbsp;user2@gmail.com<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;golang-nuts@googlegroups.com&gt;<br>
<span class="lineno">215</span>DATA<br>
<span class="lineno"></span>From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno">220</span>Line&nbsp;1<br>
<span class="lineno"></span>..Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">225</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8512157">func</span>&nbsp;<span class="ident" id="8512162">TestNewClient</span><span class="op" id="8512175">(</span><span class="ident" id="8512176">t</span>&nbsp;<span class="op" id="8512178">*</span><span class="ident" id="8512179">testing</span><span class="op" id="8512186">.</span><span class="ident" id="8512187">T</span><span class="op" id="8512188">)</span>&nbsp;<span class="op" id="8512190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512193">server</span>&nbsp;<span class="op" id="8512200">:=</span>&nbsp;<span class="ident" id="8512203">strings</span><span class="op" id="8512210">.</span><span class="ident" id="8512211">Join</span><span class="op" id="8512215">(</span><span class="ident" id="8512216">strings</span><span class="op" id="8512223">.</span><span class="ident" id="8512224">Split</span><span class="op" id="8512229">(</span><span class="ident" id="8512230">newClientServer</span><span class="op" id="8512245">,</span>&nbsp;<span class="string" id="8512247">&#34;\n&#34;</span><span class="op" id="8512251">)</span><span class="op" id="8512252">,</span>&nbsp;<span class="string" id="8512254">&#34;\r\n&#34;</span><span class="op" id="8512260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512263">client</span>&nbsp;<span class="op" id="8512270">:=</span>&nbsp;<span class="ident" id="8512273">strings</span><span class="op" id="8512280">.</span><span class="ident" id="8512281">Join</span><span class="op" id="8512285">(</span><span class="ident" id="8512286">strings</span><span class="op" id="8512293">.</span><span class="ident" id="8512294">Split</span><span class="op" id="8512299">(</span><span class="ident" id="8512300">newClientClient</span><span class="op" id="8512315">,</span>&nbsp;<span class="string" id="8512317">&#34;\n&#34;</span><span class="op" id="8512321">)</span><span class="op" id="8512322">,</span>&nbsp;<span class="string" id="8512324">&#34;\r\n&#34;</span><span class="op" id="8512330">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8512334">var</span>&nbsp;<span class="ident" id="8512338">cmdbuf</span>&nbsp;<span class="ident" id="8512345">bytes</span><span class="op" id="8512350">.</span><span class="ident" id="8512351">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512359">bcmdbuf</span>&nbsp;<span class="op" id="8512367">:=</span>&nbsp;<span class="ident" id="8512370">bufio</span><span class="op" id="8512375">.</span><span class="ident" id="8512376">NewWriter</span><span class="op" id="8512385">(</span><span class="op" id="8512386">&amp;</span><span class="ident" id="8512387">cmdbuf</span><span class="op" id="8512393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512396">out</span>&nbsp;<span class="op" id="8512400">:=</span>&nbsp;<span class="keyword" id="8512403">func</span><span class="op" id="8512407">(</span><span class="op" id="8512408">)</span>&nbsp;<span class="builtintype" id="8512410">string</span>&nbsp;<span class="op" id="8512417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512421">bcmdbuf</span><span class="op" id="8512428">.</span><span class="ident" id="8512429">Flush</span><span class="op" id="8512434">(</span><span class="op" id="8512435">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8512439">return</span>&nbsp;<span class="ident" id="8512446">cmdbuf</span><span class="op" id="8512452">.</span><span class="ident" id="8512453">String</span><span class="op" id="8512459">(</span><span class="op" id="8512460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8512463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8512466">var</span>&nbsp;<span class="ident" id="8512470">fake</span>&nbsp;<span class="ident" id="8512475">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512482">fake</span><span class="op" id="8512486">.</span><span class="ident" id="8512487">ReadWriter</span>&nbsp;<span class="op" id="8512498">=</span>&nbsp;<span class="ident" id="8512500">bufio</span><span class="op" id="8512505">.</span><span class="ident" id="8512506">NewReadWriter</span><span class="op" id="8512519">(</span><span class="ident" id="8512520">bufio</span><span class="op" id="8512525">.</span><span class="ident" id="8512526">NewReader</span><span class="op" id="8512535">(</span><span class="ident" id="8512536">strings</span><span class="op" id="8512543">.</span><span class="ident" id="8512544">NewReader</span><span class="op" id="8512553">(</span><span class="ident" id="8512554">server</span><span class="op" id="8512560">)</span><span class="op" id="8512561">)</span><span class="op" id="8512562">,</span>&nbsp;<span class="ident" id="8512564">bcmdbuf</span><span class="op" id="8512571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512574">c</span><span class="op" id="8512575">,</span>&nbsp;<span class="ident" id="8512577">err</span>&nbsp;<span class="op" id="8512581">:=</span>&nbsp;<span class="ident" id="8512584">NewClient</span><span class="op" id="8512593">(</span><span class="ident" id="8512594">fake</span><span class="op" id="8512598">,</span>&nbsp;<span class="string" id="8512600">&#34;fake.host&#34;</span><span class="op" id="8512611">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8512614">if</span>&nbsp;<span class="ident" id="8512617">err</span>&nbsp;<span class="op" id="8512621">!=</span>&nbsp;<span class="ident" id="8512624">nil</span>&nbsp;<span class="op" id="8512628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512632">t</span><span class="op" id="8512633">.</span><span class="ident" id="8512634">Fatalf</span><span class="op" id="8512640">(</span><span class="string" id="8512641">&#34;NewClient:&nbsp;%v\n(after&nbsp;%v)&#34;</span><span class="op" id="8512668">,</span>&nbsp;<span class="ident" id="8512670">err</span><span class="op" id="8512673">,</span>&nbsp;<span class="ident" id="8512675">out</span><span class="op" id="8512678">(</span><span class="op" id="8512679">)</span><span class="op" id="8512680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8512683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8512686">defer</span>&nbsp;<span class="ident" id="8512692">c</span><span class="op" id="8512693">.</span><span class="ident" id="8512694">Close</span><span class="op" id="8512699">(</span><span class="op" id="8512700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8512703">if</span>&nbsp;<span class="ident" id="8512706">ok</span><span class="op" id="8512708">,</span>&nbsp;<span class="ident" id="8512710">args</span>&nbsp;<span class="op" id="8512715">:=</span>&nbsp;<span class="ident" id="8512718">c</span><span class="op" id="8512719">.</span><span class="ident" id="8512720">Extension</span><span class="op" id="8512729">(</span><span class="string" id="8512730">&#34;aUtH&#34;</span><span class="op" id="8512736">)</span><span class="op" id="8512737">;</span>&nbsp;<span class="op" id="8512739">!</span><span class="ident" id="8512740">ok</span>&nbsp;<span class="op" id="8512743">||</span>&nbsp;<span class="ident" id="8512746">args</span>&nbsp;<span class="op" id="8512751">!=</span>&nbsp;<span class="string" id="8512754">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="8512768">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512772">t</span><span class="op" id="8512773">.</span><span class="ident" id="8512774">Fatalf</span><span class="op" id="8512780">(</span><span class="string" id="8512781">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="8512806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8512809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8512812">if</span>&nbsp;<span class="ident" id="8512815">ok</span><span class="op" id="8512817">,</span>&nbsp;<span class="ident" id="8512819">_</span>&nbsp;<span class="op" id="8512821">:=</span>&nbsp;<span class="ident" id="8512824">c</span><span class="op" id="8512825">.</span><span class="ident" id="8512826">Extension</span><span class="op" id="8512835">(</span><span class="string" id="8512836">&#34;DSN&#34;</span><span class="op" id="8512841">)</span><span class="op" id="8512842">;</span>&nbsp;<span class="ident" id="8512844">ok</span>&nbsp;<span class="op" id="8512847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512851">t</span><span class="op" id="8512852">.</span><span class="ident" id="8512853">Fatalf</span><span class="op" id="8512859">(</span><span class="string" id="8512860">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8512883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8512886">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8512889">if</span>&nbsp;<span class="ident" id="8512892">err</span>&nbsp;<span class="op" id="8512896">:=</span>&nbsp;<span class="ident" id="8512899">c</span><span class="op" id="8512900">.</span><span class="ident" id="8512901">Quit</span><span class="op" id="8512905">(</span><span class="op" id="8512906">)</span><span class="op" id="8512907">;</span>&nbsp;<span class="ident" id="8512909">err</span>&nbsp;<span class="op" id="8512913">!=</span>&nbsp;<span class="ident" id="8512916">nil</span>&nbsp;<span class="op" id="8512920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512924">t</span><span class="op" id="8512925">.</span><span class="ident" id="8512926">Fatalf</span><span class="op" id="8512932">(</span><span class="string" id="8512933">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8512950">,</span>&nbsp;<span class="ident" id="8512952">err</span><span class="op" id="8512955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8512958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8512962">actualcmds</span>&nbsp;<span class="op" id="8512973">:=</span>&nbsp;<span class="ident" id="8512976">out</span><span class="op" id="8512979">(</span><span class="op" id="8512980">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8512983">if</span>&nbsp;<span class="ident" id="8512986">client</span>&nbsp;<span class="op" id="8512993">!=</span>&nbsp;<span class="ident" id="8512996">actualcmds</span>&nbsp;<span class="op" id="8513007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513011">t</span><span class="op" id="8513012">.</span><span class="ident" id="8513013">Fatalf</span><span class="op" id="8513019">(</span><span class="string" id="8513020">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8513045">,</span>&nbsp;<span class="ident" id="8513047">actualcmds</span><span class="op" id="8513057">,</span>&nbsp;<span class="ident" id="8513059">client</span><span class="op" id="8513065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8513068">}</span><br>
<span class="lineno"></span><span class="op" id="8513070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="8513073">var</span>&nbsp;<span class="ident" id="8513077">newClientServer</span>&nbsp;<span class="op" id="8513093">=</span>&nbsp;<span class="string" id="8513095">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">265</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8513208">var</span>&nbsp;<span class="ident" id="8513212">newClientClient</span>&nbsp;<span class="op" id="8513228">=</span>&nbsp;<span class="string" id="8513230">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">270</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8513254">func</span>&nbsp;<span class="ident" id="8513259">TestNewClient2</span><span class="op" id="8513273">(</span><span class="ident" id="8513274">t</span>&nbsp;<span class="op" id="8513276">*</span><span class="ident" id="8513277">testing</span><span class="op" id="8513284">.</span><span class="ident" id="8513285">T</span><span class="op" id="8513286">)</span>&nbsp;<span class="op" id="8513288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513291">server</span>&nbsp;<span class="op" id="8513298">:=</span>&nbsp;<span class="ident" id="8513301">strings</span><span class="op" id="8513308">.</span><span class="ident" id="8513309">Join</span><span class="op" id="8513313">(</span><span class="ident" id="8513314">strings</span><span class="op" id="8513321">.</span><span class="ident" id="8513322">Split</span><span class="op" id="8513327">(</span><span class="ident" id="8513328">newClient2Server</span><span class="op" id="8513344">,</span>&nbsp;<span class="string" id="8513346">&#34;\n&#34;</span><span class="op" id="8513350">)</span><span class="op" id="8513351">,</span>&nbsp;<span class="string" id="8513353">&#34;\r\n&#34;</span><span class="op" id="8513359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513362">client</span>&nbsp;<span class="op" id="8513369">:=</span>&nbsp;<span class="ident" id="8513372">strings</span><span class="op" id="8513379">.</span><span class="ident" id="8513380">Join</span><span class="op" id="8513384">(</span><span class="ident" id="8513385">strings</span><span class="op" id="8513392">.</span><span class="ident" id="8513393">Split</span><span class="op" id="8513398">(</span><span class="ident" id="8513399">newClient2Client</span><span class="op" id="8513415">,</span>&nbsp;<span class="string" id="8513417">&#34;\n&#34;</span><span class="op" id="8513421">)</span><span class="op" id="8513422">,</span>&nbsp;<span class="string" id="8513424">&#34;\r\n&#34;</span><span class="op" id="8513430">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8513434">var</span>&nbsp;<span class="ident" id="8513438">cmdbuf</span>&nbsp;<span class="ident" id="8513445">bytes</span><span class="op" id="8513450">.</span><span class="ident" id="8513451">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513459">bcmdbuf</span>&nbsp;<span class="op" id="8513467">:=</span>&nbsp;<span class="ident" id="8513470">bufio</span><span class="op" id="8513475">.</span><span class="ident" id="8513476">NewWriter</span><span class="op" id="8513485">(</span><span class="op" id="8513486">&amp;</span><span class="ident" id="8513487">cmdbuf</span><span class="op" id="8513493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8513496">var</span>&nbsp;<span class="ident" id="8513500">fake</span>&nbsp;<span class="ident" id="8513505">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513512">fake</span><span class="op" id="8513516">.</span><span class="ident" id="8513517">ReadWriter</span>&nbsp;<span class="op" id="8513528">=</span>&nbsp;<span class="ident" id="8513530">bufio</span><span class="op" id="8513535">.</span><span class="ident" id="8513536">NewReadWriter</span><span class="op" id="8513549">(</span><span class="ident" id="8513550">bufio</span><span class="op" id="8513555">.</span><span class="ident" id="8513556">NewReader</span><span class="op" id="8513565">(</span><span class="ident" id="8513566">strings</span><span class="op" id="8513573">.</span><span class="ident" id="8513574">NewReader</span><span class="op" id="8513583">(</span><span class="ident" id="8513584">server</span><span class="op" id="8513590">)</span><span class="op" id="8513591">)</span><span class="op" id="8513592">,</span>&nbsp;<span class="ident" id="8513594">bcmdbuf</span><span class="op" id="8513601">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513604">c</span><span class="op" id="8513605">,</span>&nbsp;<span class="ident" id="8513607">err</span>&nbsp;<span class="op" id="8513611">:=</span>&nbsp;<span class="ident" id="8513614">NewClient</span><span class="op" id="8513623">(</span><span class="ident" id="8513624">fake</span><span class="op" id="8513628">,</span>&nbsp;<span class="string" id="8513630">&#34;fake.host&#34;</span><span class="op" id="8513641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8513644">if</span>&nbsp;<span class="ident" id="8513647">err</span>&nbsp;<span class="op" id="8513651">!=</span>&nbsp;<span class="ident" id="8513654">nil</span>&nbsp;<span class="op" id="8513658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513662">t</span><span class="op" id="8513663">.</span><span class="ident" id="8513664">Fatalf</span><span class="op" id="8513670">(</span><span class="string" id="8513671">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8513686">,</span>&nbsp;<span class="ident" id="8513688">err</span><span class="op" id="8513691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8513694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8513697">defer</span>&nbsp;<span class="ident" id="8513703">c</span><span class="op" id="8513704">.</span><span class="ident" id="8513705">Close</span><span class="op" id="8513710">(</span><span class="op" id="8513711">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8513714">if</span>&nbsp;<span class="ident" id="8513717">ok</span><span class="op" id="8513719">,</span>&nbsp;<span class="ident" id="8513721">_</span>&nbsp;<span class="op" id="8513723">:=</span>&nbsp;<span class="ident" id="8513726">c</span><span class="op" id="8513727">.</span><span class="ident" id="8513728">Extension</span><span class="op" id="8513737">(</span><span class="string" id="8513738">&#34;DSN&#34;</span><span class="op" id="8513743">)</span><span class="op" id="8513744">;</span>&nbsp;<span class="ident" id="8513746">ok</span>&nbsp;<span class="op" id="8513749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513753">t</span><span class="op" id="8513754">.</span><span class="ident" id="8513755">Fatalf</span><span class="op" id="8513761">(</span><span class="string" id="8513762">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="8513785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8513788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8513791">if</span>&nbsp;<span class="ident" id="8513794">err</span>&nbsp;<span class="op" id="8513798">:=</span>&nbsp;<span class="ident" id="8513801">c</span><span class="op" id="8513802">.</span><span class="ident" id="8513803">Quit</span><span class="op" id="8513807">(</span><span class="op" id="8513808">)</span><span class="op" id="8513809">;</span>&nbsp;<span class="ident" id="8513811">err</span>&nbsp;<span class="op" id="8513815">!=</span>&nbsp;<span class="ident" id="8513818">nil</span>&nbsp;<span class="op" id="8513822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513826">t</span><span class="op" id="8513827">.</span><span class="ident" id="8513828">Fatalf</span><span class="op" id="8513834">(</span><span class="string" id="8513835">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="8513852">,</span>&nbsp;<span class="ident" id="8513854">err</span><span class="op" id="8513857">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8513860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513864">bcmdbuf</span><span class="op" id="8513871">.</span><span class="ident" id="8513872">Flush</span><span class="op" id="8513877">(</span><span class="op" id="8513878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513881">actualcmds</span>&nbsp;<span class="op" id="8513892">:=</span>&nbsp;<span class="ident" id="8513895">cmdbuf</span><span class="op" id="8513901">.</span><span class="ident" id="8513902">String</span><span class="op" id="8513908">(</span><span class="op" id="8513909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8513912">if</span>&nbsp;<span class="ident" id="8513915">client</span>&nbsp;<span class="op" id="8513922">!=</span>&nbsp;<span class="ident" id="8513925">actualcmds</span>&nbsp;<span class="op" id="8513936">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8513940">t</span><span class="op" id="8513941">.</span><span class="ident" id="8513942">Fatalf</span><span class="op" id="8513948">(</span><span class="string" id="8513949">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8513974">,</span>&nbsp;<span class="ident" id="8513976">actualcmds</span><span class="op" id="8513986">,</span>&nbsp;<span class="ident" id="8513988">client</span><span class="op" id="8513994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8513997">}</span><br>
<span class="lineno"></span><span class="op" id="8513999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8514002">var</span>&nbsp;<span class="ident" id="8514006">newClient2Server</span>&nbsp;<span class="op" id="8514023">=</span>&nbsp;<span class="string" id="8514025">`220&nbsp;hello&nbsp;world<br>
<span class="lineno">300</span>502&nbsp;EH?<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">305</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8514146">var</span>&nbsp;<span class="ident" id="8514150">newClient2Client</span>&nbsp;<span class="op" id="8514167">=</span>&nbsp;<span class="string" id="8514169">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno">310</span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8514208">func</span>&nbsp;<span class="ident" id="8514213">TestHello</span><span class="op" id="8514222">(</span><span class="ident" id="8514223">t</span>&nbsp;<span class="op" id="8514225">*</span><span class="ident" id="8514226">testing</span><span class="op" id="8514233">.</span><span class="ident" id="8514234">T</span><span class="op" id="8514235">)</span>&nbsp;<span class="op" id="8514237">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8514241">if</span>&nbsp;<span class="builtinfunc" id="8514244">len</span><span class="op" id="8514247">(</span><span class="ident" id="8514248">helloServer</span><span class="op" id="8514259">)</span>&nbsp;<span class="op" id="8514261">!=</span>&nbsp;<span class="builtinfunc" id="8514264">len</span><span class="op" id="8514267">(</span><span class="ident" id="8514268">helloClient</span><span class="op" id="8514279">)</span>&nbsp;<span class="op" id="8514281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514285">t</span><span class="op" id="8514286">.</span><span class="ident" id="8514287">Fatalf</span><span class="op" id="8514293">(</span><span class="string" id="8514294">&#34;Hello&nbsp;server&nbsp;and&nbsp;client&nbsp;size&nbsp;mismatch&#34;</span><span class="op" id="8514333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8514336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8514340">for</span>&nbsp;<span class="ident" id="8514344">i</span>&nbsp;<span class="op" id="8514346">:=</span>&nbsp;<span class="num" id="8514349">0</span><span class="op" id="8514350">;</span>&nbsp;<span class="ident" id="8514352">i</span>&nbsp;<span class="op" id="8514354">&lt;</span>&nbsp;<span class="builtinfunc" id="8514356">len</span><span class="op" id="8514359">(</span><span class="ident" id="8514360">helloServer</span><span class="op" id="8514371">)</span><span class="op" id="8514372">;</span>&nbsp;<span class="ident" id="8514374">i</span><span class="op" id="8514375">++</span>&nbsp;<span class="op" id="8514378">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514382">server</span>&nbsp;<span class="op" id="8514389">:=</span>&nbsp;<span class="ident" id="8514392">strings</span><span class="op" id="8514399">.</span><span class="ident" id="8514400">Join</span><span class="op" id="8514404">(</span><span class="ident" id="8514405">strings</span><span class="op" id="8514412">.</span><span class="ident" id="8514413">Split</span><span class="op" id="8514418">(</span><span class="ident" id="8514419">baseHelloServer</span><span class="op" id="8514434">+</span><span class="ident" id="8514435">helloServer</span><span class="op" id="8514446">[</span><span class="ident" id="8514447">i</span><span class="op" id="8514448">]</span><span class="op" id="8514449">,</span>&nbsp;<span class="string" id="8514451">&#34;\n&#34;</span><span class="op" id="8514455">)</span><span class="op" id="8514456">,</span>&nbsp;<span class="string" id="8514458">&#34;\r\n&#34;</span><span class="op" id="8514464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514468">client</span>&nbsp;<span class="op" id="8514475">:=</span>&nbsp;<span class="ident" id="8514478">strings</span><span class="op" id="8514485">.</span><span class="ident" id="8514486">Join</span><span class="op" id="8514490">(</span><span class="ident" id="8514491">strings</span><span class="op" id="8514498">.</span><span class="ident" id="8514499">Split</span><span class="op" id="8514504">(</span><span class="ident" id="8514505">baseHelloClient</span><span class="op" id="8514520">+</span><span class="ident" id="8514521">helloClient</span><span class="op" id="8514532">[</span><span class="ident" id="8514533">i</span><span class="op" id="8514534">]</span><span class="op" id="8514535">,</span>&nbsp;<span class="string" id="8514537">&#34;\n&#34;</span><span class="op" id="8514541">)</span><span class="op" id="8514542">,</span>&nbsp;<span class="string" id="8514544">&#34;\r\n&#34;</span><span class="op" id="8514550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8514554">var</span>&nbsp;<span class="ident" id="8514558">cmdbuf</span>&nbsp;<span class="ident" id="8514565">bytes</span><span class="op" id="8514570">.</span><span class="ident" id="8514571">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514580">bcmdbuf</span>&nbsp;<span class="op" id="8514588">:=</span>&nbsp;<span class="ident" id="8514591">bufio</span><span class="op" id="8514596">.</span><span class="ident" id="8514597">NewWriter</span><span class="op" id="8514606">(</span><span class="op" id="8514607">&amp;</span><span class="ident" id="8514608">cmdbuf</span><span class="op" id="8514614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8514618">var</span>&nbsp;<span class="ident" id="8514622">fake</span>&nbsp;<span class="ident" id="8514627">faker</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514635">fake</span><span class="op" id="8514639">.</span><span class="ident" id="8514640">ReadWriter</span>&nbsp;<span class="op" id="8514651">=</span>&nbsp;<span class="ident" id="8514653">bufio</span><span class="op" id="8514658">.</span><span class="ident" id="8514659">NewReadWriter</span><span class="op" id="8514672">(</span><span class="ident" id="8514673">bufio</span><span class="op" id="8514678">.</span><span class="ident" id="8514679">NewReader</span><span class="op" id="8514688">(</span><span class="ident" id="8514689">strings</span><span class="op" id="8514696">.</span><span class="ident" id="8514697">NewReader</span><span class="op" id="8514706">(</span><span class="ident" id="8514707">server</span><span class="op" id="8514713">)</span><span class="op" id="8514714">)</span><span class="op" id="8514715">,</span>&nbsp;<span class="ident" id="8514717">bcmdbuf</span><span class="op" id="8514724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514728">c</span><span class="op" id="8514729">,</span>&nbsp;<span class="ident" id="8514731">err</span>&nbsp;<span class="op" id="8514735">:=</span>&nbsp;<span class="ident" id="8514738">NewClient</span><span class="op" id="8514747">(</span><span class="ident" id="8514748">fake</span><span class="op" id="8514752">,</span>&nbsp;<span class="string" id="8514754">&#34;fake.host&#34;</span><span class="op" id="8514765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8514769">if</span>&nbsp;<span class="ident" id="8514772">err</span>&nbsp;<span class="op" id="8514776">!=</span>&nbsp;<span class="ident" id="8514779">nil</span>&nbsp;<span class="op" id="8514783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514788">t</span><span class="op" id="8514789">.</span><span class="ident" id="8514790">Fatalf</span><span class="op" id="8514796">(</span><span class="string" id="8514797">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8514812">,</span>&nbsp;<span class="ident" id="8514814">err</span><span class="op" id="8514817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8514821">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8514825">defer</span>&nbsp;<span class="ident" id="8514831">c</span><span class="op" id="8514832">.</span><span class="ident" id="8514833">Close</span><span class="op" id="8514838">(</span><span class="op" id="8514839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514843">c</span><span class="op" id="8514844">.</span><span class="ident" id="8514845">localName</span>&nbsp;<span class="op" id="8514855">=</span>&nbsp;<span class="string" id="8514857">&#34;customhost&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514872">err</span>&nbsp;<span class="op" id="8514876">=</span>&nbsp;<span class="ident" id="8514878">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8514885">switch</span>&nbsp;<span class="ident" id="8514892">i</span>&nbsp;<span class="op" id="8514894">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8514898">case</span>&nbsp;<span class="num" id="8514903">0</span><span class="op" id="8514904">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514909">err</span>&nbsp;<span class="op" id="8514913">=</span>&nbsp;<span class="ident" id="8514915">c</span><span class="op" id="8514916">.</span><span class="ident" id="8514917">Hello</span><span class="op" id="8514922">(</span><span class="string" id="8514923">&#34;customhost&#34;</span><span class="op" id="8514935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8514939">case</span>&nbsp;<span class="num" id="8514944">1</span><span class="op" id="8514945">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8514950">err</span>&nbsp;<span class="op" id="8514954">=</span>&nbsp;<span class="ident" id="8514956">c</span><span class="op" id="8514957">.</span><span class="ident" id="8514958">StartTLS</span><span class="op" id="8514966">(</span><span class="ident" id="8514967">nil</span><span class="op" id="8514970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8514975">if</span>&nbsp;<span class="ident" id="8514978">err</span><span class="op" id="8514981">.</span><span class="ident" id="8514982">Error</span><span class="op" id="8514987">(</span><span class="op" id="8514988">)</span>&nbsp;<span class="op" id="8514990">==</span>&nbsp;<span class="string" id="8514993">&#34;502&nbsp;Not&nbsp;implemented&#34;</span>&nbsp;<span class="op" id="8515015">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515021">err</span>&nbsp;<span class="op" id="8515025">=</span>&nbsp;<span class="ident" id="8515027">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8515034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8515038">case</span>&nbsp;<span class="num" id="8515043">2</span><span class="op" id="8515044">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515049">err</span>&nbsp;<span class="op" id="8515053">=</span>&nbsp;<span class="ident" id="8515055">c</span><span class="op" id="8515056">.</span><span class="ident" id="8515057">Verify</span><span class="op" id="8515063">(</span><span class="string" id="8515064">&#34;test@example.com&#34;</span><span class="op" id="8515082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8515086">case</span>&nbsp;<span class="num" id="8515091">3</span><span class="op" id="8515092">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515097">c</span><span class="op" id="8515098">.</span><span class="ident" id="8515099">tls</span>&nbsp;<span class="op" id="8515103">=</span>&nbsp;<span class="builtintype" id="8515105">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515113">c</span><span class="op" id="8515114">.</span><span class="ident" id="8515115">serverName</span>&nbsp;<span class="op" id="8515126">=</span>&nbsp;<span class="string" id="8515128">&#34;smtp.google.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515149">err</span>&nbsp;<span class="op" id="8515153">=</span>&nbsp;<span class="ident" id="8515155">c</span><span class="op" id="8515156">.</span><span class="ident" id="8515157">Auth</span><span class="op" id="8515161">(</span><span class="ident" id="8515162">PlainAuth</span><span class="op" id="8515171">(</span><span class="string" id="8515172">&#34;&#34;</span><span class="op" id="8515174">,</span>&nbsp;<span class="string" id="8515176">&#34;user&#34;</span><span class="op" id="8515182">,</span>&nbsp;<span class="string" id="8515184">&#34;pass&#34;</span><span class="op" id="8515190">,</span>&nbsp;<span class="string" id="8515192">&#34;smtp.google.com&#34;</span><span class="op" id="8515209">)</span><span class="op" id="8515210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8515214">case</span>&nbsp;<span class="num" id="8515219">4</span><span class="op" id="8515220">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515225">err</span>&nbsp;<span class="op" id="8515229">=</span>&nbsp;<span class="ident" id="8515231">c</span><span class="op" id="8515232">.</span><span class="ident" id="8515233">Mail</span><span class="op" id="8515237">(</span><span class="string" id="8515238">&#34;test@example.com&#34;</span><span class="op" id="8515256">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8515260">case</span>&nbsp;<span class="num" id="8515265">5</span><span class="op" id="8515266">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515271">ok</span><span class="op" id="8515273">,</span>&nbsp;<span class="ident" id="8515275">_</span>&nbsp;<span class="op" id="8515277">:=</span>&nbsp;<span class="ident" id="8515280">c</span><span class="op" id="8515281">.</span><span class="ident" id="8515282">Extension</span><span class="op" id="8515291">(</span><span class="string" id="8515292">&#34;feature&#34;</span><span class="op" id="8515301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8515306">if</span>&nbsp;<span class="ident" id="8515309">ok</span>&nbsp;<span class="op" id="8515312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515318">t</span><span class="op" id="8515319">.</span><span class="ident" id="8515320">Errorf</span><span class="op" id="8515326">(</span><span class="string" id="8515327">&#34;Expected&nbsp;FEATURE&nbsp;not&nbsp;to&nbsp;be&nbsp;supported&#34;</span><span class="op" id="8515365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8515370">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8515374">case</span>&nbsp;<span class="num" id="8515379">6</span><span class="op" id="8515380">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515385">err</span>&nbsp;<span class="op" id="8515389">=</span>&nbsp;<span class="ident" id="8515391">c</span><span class="op" id="8515392">.</span><span class="ident" id="8515393">Reset</span><span class="op" id="8515398">(</span><span class="op" id="8515399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8515403">case</span>&nbsp;<span class="num" id="8515408">7</span><span class="op" id="8515409">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515414">err</span>&nbsp;<span class="op" id="8515418">=</span>&nbsp;<span class="ident" id="8515420">c</span><span class="op" id="8515421">.</span><span class="ident" id="8515422">Quit</span><span class="op" id="8515426">(</span><span class="op" id="8515427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8515431">case</span>&nbsp;<span class="num" id="8515436">8</span><span class="op" id="8515437">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515442">err</span>&nbsp;<span class="op" id="8515446">=</span>&nbsp;<span class="ident" id="8515448">c</span><span class="op" id="8515449">.</span><span class="ident" id="8515450">Verify</span><span class="op" id="8515456">(</span><span class="string" id="8515457">&#34;test@example.com&#34;</span><span class="op" id="8515475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8515480">if</span>&nbsp;<span class="ident" id="8515483">err</span>&nbsp;<span class="op" id="8515487">!=</span>&nbsp;<span class="ident" id="8515490">nil</span>&nbsp;<span class="op" id="8515494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515500">err</span>&nbsp;<span class="op" id="8515504">=</span>&nbsp;<span class="ident" id="8515506">c</span><span class="op" id="8515507">.</span><span class="ident" id="8515508">Hello</span><span class="op" id="8515513">(</span><span class="string" id="8515514">&#34;customhost&#34;</span><span class="op" id="8515526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8515532">if</span>&nbsp;<span class="ident" id="8515535">err</span>&nbsp;<span class="op" id="8515539">!=</span>&nbsp;<span class="ident" id="8515542">nil</span>&nbsp;<span class="op" id="8515546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515553">t</span><span class="op" id="8515554">.</span><span class="ident" id="8515555">Errorf</span><span class="op" id="8515561">(</span><span class="string" id="8515562">&#34;Want&nbsp;error,&nbsp;got&nbsp;none&#34;</span><span class="op" id="8515584">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8515590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8515595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8515599">default</span><span class="op" id="8515606">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515611">t</span><span class="op" id="8515612">.</span><span class="ident" id="8515613">Fatalf</span><span class="op" id="8515619">(</span><span class="string" id="8515620">&#34;Unhandled&nbsp;command&#34;</span><span class="op" id="8515639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8515643">}</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8515648">if</span>&nbsp;<span class="ident" id="8515651">err</span>&nbsp;<span class="op" id="8515655">!=</span>&nbsp;<span class="ident" id="8515658">nil</span>&nbsp;<span class="op" id="8515662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515667">t</span><span class="op" id="8515668">.</span><span class="ident" id="8515669">Errorf</span><span class="op" id="8515675">(</span><span class="string" id="8515676">&#34;Command&nbsp;%d&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8515699">,</span>&nbsp;<span class="ident" id="8515701">i</span><span class="op" id="8515702">,</span>&nbsp;<span class="ident" id="8515704">err</span><span class="op" id="8515707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8515711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515716">bcmdbuf</span><span class="op" id="8515723">.</span><span class="ident" id="8515724">Flush</span><span class="op" id="8515729">(</span><span class="op" id="8515730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515734">actualcmds</span>&nbsp;<span class="op" id="8515745">:=</span>&nbsp;<span class="ident" id="8515748">cmdbuf</span><span class="op" id="8515754">.</span><span class="ident" id="8515755">String</span><span class="op" id="8515761">(</span><span class="op" id="8515762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8515766">if</span>&nbsp;<span class="ident" id="8515769">client</span>&nbsp;<span class="op" id="8515776">!=</span>&nbsp;<span class="ident" id="8515779">actualcmds</span>&nbsp;<span class="op" id="8515790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8515795">t</span><span class="op" id="8515796">.</span><span class="ident" id="8515797">Errorf</span><span class="op" id="8515803">(</span><span class="string" id="8515804">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8515829">,</span>&nbsp;<span class="ident" id="8515831">actualcmds</span><span class="op" id="8515841">,</span>&nbsp;<span class="ident" id="8515843">client</span><span class="op" id="8515849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8515853">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8515856">}</span><br>
<span class="lineno"></span><span class="op" id="8515858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8515861">var</span>&nbsp;<span class="ident" id="8515865">baseHelloServer</span>&nbsp;<span class="op" id="8515881">=</span>&nbsp;<span class="string" id="8515883">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno">385</span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;FEATURE<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8515957">var</span>&nbsp;<span class="ident" id="8515961">helloServer</span>&nbsp;<span class="op" id="8515973">=</span>&nbsp;<span class="op" id="8515975">[</span><span class="op" id="8515976">]</span><span class="builtintype" id="8515977">string</span><span class="op" id="8515983">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515986">&#34;&#34;</span><span class="op" id="8515988">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8515991">&#34;502&nbsp;Not&nbsp;implemented\n&#34;</span><span class="op" id="8516014">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516017">&#34;250&nbsp;User&nbsp;is&nbsp;valid\n&#34;</span><span class="op" id="8516038">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516041">&#34;235&nbsp;Accepted\n&#34;</span><span class="op" id="8516057">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516060">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="8516077">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516080">&#34;&#34;</span><span class="op" id="8516082">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516085">&#34;250&nbsp;Reset&nbsp;ok\n&#34;</span><span class="op" id="8516101">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516104">&#34;221&nbsp;Goodbye\n&#34;</span><span class="op" id="8516119">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516122">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="8516139">,</span><br>
<span class="lineno"></span><span class="op" id="8516141">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="8516144">var</span>&nbsp;<span class="ident" id="8516148">baseHelloClient</span>&nbsp;<span class="op" id="8516164">=</span>&nbsp;<span class="string" id="8516166">`EHLO&nbsp;customhost<br>
<span class="lineno"></span>HELO&nbsp;customhost<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="8516202">var</span>&nbsp;<span class="ident" id="8516206">helloClient</span>&nbsp;<span class="op" id="8516218">=</span>&nbsp;<span class="op" id="8516220">[</span><span class="op" id="8516221">]</span><span class="builtintype" id="8516222">string</span><span class="op" id="8516228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516231">&#34;&#34;</span><span class="op" id="8516233">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516236">&#34;STARTTLS\n&#34;</span><span class="op" id="8516248">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516251">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="8516276">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516279">&#34;AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==\n&#34;</span><span class="op" id="8516310">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516313">&#34;MAIL&nbsp;FROM:&lt;test@example.com&gt;\n&#34;</span><span class="op" id="8516345">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516348">&#34;&#34;</span><span class="op" id="8516350">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516353">&#34;RSET\n&#34;</span><span class="op" id="8516361">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516364">&#34;QUIT\n&#34;</span><span class="op" id="8516372">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8516375">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="8516400">,</span><br>
<span class="lineno">415</span><span class="op" id="8516402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8516405">func</span>&nbsp;<span class="ident" id="8516410">TestSendMail</span><span class="op" id="8516422">(</span><span class="ident" id="8516423">t</span>&nbsp;<span class="op" id="8516425">*</span><span class="ident" id="8516426">testing</span><span class="op" id="8516433">.</span><span class="ident" id="8516434">T</span><span class="op" id="8516435">)</span>&nbsp;<span class="op" id="8516437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516440">server</span>&nbsp;<span class="op" id="8516447">:=</span>&nbsp;<span class="ident" id="8516450">strings</span><span class="op" id="8516457">.</span><span class="ident" id="8516458">Join</span><span class="op" id="8516462">(</span><span class="ident" id="8516463">strings</span><span class="op" id="8516470">.</span><span class="ident" id="8516471">Split</span><span class="op" id="8516476">(</span><span class="ident" id="8516477">sendMailServer</span><span class="op" id="8516491">,</span>&nbsp;<span class="string" id="8516493">&#34;\n&#34;</span><span class="op" id="8516497">)</span><span class="op" id="8516498">,</span>&nbsp;<span class="string" id="8516500">&#34;\r\n&#34;</span><span class="op" id="8516506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516509">client</span>&nbsp;<span class="op" id="8516516">:=</span>&nbsp;<span class="ident" id="8516519">strings</span><span class="op" id="8516526">.</span><span class="ident" id="8516527">Join</span><span class="op" id="8516531">(</span><span class="ident" id="8516532">strings</span><span class="op" id="8516539">.</span><span class="ident" id="8516540">Split</span><span class="op" id="8516545">(</span><span class="ident" id="8516546">sendMailClient</span><span class="op" id="8516560">,</span>&nbsp;<span class="string" id="8516562">&#34;\n&#34;</span><span class="op" id="8516566">)</span><span class="op" id="8516567">,</span>&nbsp;<span class="string" id="8516569">&#34;\r\n&#34;</span><span class="op" id="8516575">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8516578">var</span>&nbsp;<span class="ident" id="8516582">cmdbuf</span>&nbsp;<span class="ident" id="8516589">bytes</span><span class="op" id="8516594">.</span><span class="ident" id="8516595">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516603">bcmdbuf</span>&nbsp;<span class="op" id="8516611">:=</span>&nbsp;<span class="ident" id="8516614">bufio</span><span class="op" id="8516619">.</span><span class="ident" id="8516620">NewWriter</span><span class="op" id="8516629">(</span><span class="op" id="8516630">&amp;</span><span class="ident" id="8516631">cmdbuf</span><span class="op" id="8516637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516640">l</span><span class="op" id="8516641">,</span>&nbsp;<span class="ident" id="8516643">err</span>&nbsp;<span class="op" id="8516647">:=</span>&nbsp;<span class="ident" id="8516650">net</span><span class="op" id="8516653">.</span><span class="ident" id="8516654">Listen</span><span class="op" id="8516660">(</span><span class="string" id="8516661">&#34;tcp&#34;</span><span class="op" id="8516666">,</span>&nbsp;<span class="string" id="8516668">&#34;127.0.0.1:0&#34;</span><span class="op" id="8516681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8516684">if</span>&nbsp;<span class="ident" id="8516687">err</span>&nbsp;<span class="op" id="8516691">!=</span>&nbsp;<span class="ident" id="8516694">nil</span>&nbsp;<span class="op" id="8516698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516702">t</span><span class="op" id="8516703">.</span><span class="ident" id="8516704">Fatalf</span><span class="op" id="8516710">(</span><span class="string" id="8516711">&#34;Unable&nbsp;to&nbsp;to&nbsp;create&nbsp;listener:&nbsp;%v&#34;</span><span class="op" id="8516745">,</span>&nbsp;<span class="ident" id="8516747">err</span><span class="op" id="8516750">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8516753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8516756">defer</span>&nbsp;<span class="ident" id="8516762">l</span><span class="op" id="8516763">.</span><span class="ident" id="8516764">Close</span><span class="op" id="8516769">(</span><span class="op" id="8516770">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8516774">//&nbsp;prevent&nbsp;data&nbsp;race&nbsp;on&nbsp;bcmdbuf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8516807">var</span>&nbsp;<span class="ident" id="8516811">done</span>&nbsp;<span class="op" id="8516816">=</span>&nbsp;<span class="builtinfunc" id="8516818">make</span><span class="op" id="8516822">(</span><span class="keyword" id="8516823">chan</span>&nbsp;<span class="keyword" id="8516828">struct</span><span class="op" id="8516834">{</span><span class="op" id="8516835">}</span><span class="op" id="8516836">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8516839">go</span>&nbsp;<span class="keyword" id="8516842">func</span><span class="op" id="8516846">(</span><span class="ident" id="8516847">data</span>&nbsp;<span class="op" id="8516852">[</span><span class="op" id="8516853">]</span><span class="builtintype" id="8516854">string</span><span class="op" id="8516860">)</span>&nbsp;<span class="op" id="8516862">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8516867">defer</span>&nbsp;<span class="builtinfunc" id="8516873">close</span><span class="op" id="8516878">(</span><span class="ident" id="8516879">done</span><span class="op" id="8516883">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516888">conn</span><span class="op" id="8516892">,</span>&nbsp;<span class="ident" id="8516894">err</span>&nbsp;<span class="op" id="8516898">:=</span>&nbsp;<span class="ident" id="8516901">l</span><span class="op" id="8516902">.</span><span class="ident" id="8516903">Accept</span><span class="op" id="8516909">(</span><span class="op" id="8516910">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8516914">if</span>&nbsp;<span class="ident" id="8516917">err</span>&nbsp;<span class="op" id="8516921">!=</span>&nbsp;<span class="ident" id="8516924">nil</span>&nbsp;<span class="op" id="8516928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8516933">t</span><span class="op" id="8516934">.</span><span class="ident" id="8516935">Errorf</span><span class="op" id="8516941">(</span><span class="string" id="8516942">&#34;Accept&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8516960">,</span>&nbsp;<span class="ident" id="8516962">err</span><span class="op" id="8516965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8516970">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8516979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8516983">defer</span>&nbsp;<span class="ident" id="8516989">conn</span><span class="op" id="8516993">.</span><span class="ident" id="8516994">Close</span><span class="op" id="8516999">(</span><span class="op" id="8517000">)</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517005">tc</span>&nbsp;<span class="op" id="8517008">:=</span>&nbsp;<span class="ident" id="8517011">textproto</span><span class="op" id="8517020">.</span><span class="ident" id="8517021">NewConn</span><span class="op" id="8517028">(</span><span class="ident" id="8517029">conn</span><span class="op" id="8517033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8517037">for</span>&nbsp;<span class="ident" id="8517041">i</span>&nbsp;<span class="op" id="8517043">:=</span>&nbsp;<span class="num" id="8517046">0</span><span class="op" id="8517047">;</span>&nbsp;<span class="ident" id="8517049">i</span>&nbsp;<span class="op" id="8517051">&lt;</span>&nbsp;<span class="builtinfunc" id="8517053">len</span><span class="op" id="8517056">(</span><span class="ident" id="8517057">data</span><span class="op" id="8517061">)</span>&nbsp;<span class="op" id="8517063">&amp;&amp;</span>&nbsp;<span class="ident" id="8517066">data</span><span class="op" id="8517070">[</span><span class="ident" id="8517071">i</span><span class="op" id="8517072">]</span>&nbsp;<span class="op" id="8517074">!=</span>&nbsp;<span class="string" id="8517077">&#34;&#34;</span><span class="op" id="8517079">;</span>&nbsp;<span class="ident" id="8517081">i</span><span class="op" id="8517082">++</span>&nbsp;<span class="op" id="8517085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517090">tc</span><span class="op" id="8517092">.</span><span class="ident" id="8517093">PrintfLine</span><span class="op" id="8517103">(</span><span class="ident" id="8517104">data</span><span class="op" id="8517108">[</span><span class="ident" id="8517109">i</span><span class="op" id="8517110">]</span><span class="op" id="8517111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8517116">for</span>&nbsp;<span class="builtinfunc" id="8517120">len</span><span class="op" id="8517123">(</span><span class="ident" id="8517124">data</span><span class="op" id="8517128">[</span><span class="ident" id="8517129">i</span><span class="op" id="8517130">]</span><span class="op" id="8517131">)</span>&nbsp;<span class="op" id="8517133">&gt;=</span>&nbsp;<span class="num" id="8517136">4</span>&nbsp;<span class="op" id="8517138">&amp;&amp;</span>&nbsp;<span class="ident" id="8517141">data</span><span class="op" id="8517145">[</span><span class="ident" id="8517146">i</span><span class="op" id="8517147">]</span><span class="op" id="8517148">[</span><span class="num" id="8517149">3</span><span class="op" id="8517150">]</span>&nbsp;<span class="op" id="8517152">==</span>&nbsp;<span class="string" id="8517155">&#39;-&#39;</span>&nbsp;<span class="op" id="8517159">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517165">i</span><span class="op" id="8517166">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517173">tc</span><span class="op" id="8517175">.</span><span class="ident" id="8517176">PrintfLine</span><span class="op" id="8517186">(</span><span class="ident" id="8517187">data</span><span class="op" id="8517191">[</span><span class="ident" id="8517192">i</span><span class="op" id="8517193">]</span><span class="op" id="8517194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8517204">if</span>&nbsp;<span class="ident" id="8517207">data</span><span class="op" id="8517211">[</span><span class="ident" id="8517212">i</span><span class="op" id="8517213">]</span>&nbsp;<span class="op" id="8517215">==</span>&nbsp;<span class="string" id="8517218">&#34;221&nbsp;Goodbye&#34;</span>&nbsp;<span class="op" id="8517232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8517238">return</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517253">read</span>&nbsp;<span class="op" id="8517258">:=</span>&nbsp;<span class="builtintype" id="8517261">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8517270">for</span>&nbsp;<span class="op" id="8517274">!</span><span class="ident" id="8517275">read</span>&nbsp;<span class="op" id="8517280">||</span>&nbsp;<span class="ident" id="8517283">data</span><span class="op" id="8517287">[</span><span class="ident" id="8517288">i</span><span class="op" id="8517289">]</span>&nbsp;<span class="op" id="8517291">==</span>&nbsp;<span class="string" id="8517294">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="8517309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517315">msg</span><span class="op" id="8517318">,</span>&nbsp;<span class="ident" id="8517320">err</span>&nbsp;<span class="op" id="8517324">:=</span>&nbsp;<span class="ident" id="8517327">tc</span><span class="op" id="8517329">.</span><span class="ident" id="8517330">ReadLine</span><span class="op" id="8517338">(</span><span class="op" id="8517339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517345">bcmdbuf</span><span class="op" id="8517352">.</span><span class="ident" id="8517353">Write</span><span class="op" id="8517358">(</span><span class="op" id="8517359">[</span><span class="op" id="8517360">]</span><span class="builtintype" id="8517361">byte</span><span class="op" id="8517365">(</span><span class="ident" id="8517366">msg</span>&nbsp;<span class="op" id="8517370">+</span>&nbsp;<span class="string" id="8517372">&#34;\r\n&#34;</span><span class="op" id="8517378">)</span><span class="op" id="8517379">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517385">read</span>&nbsp;<span class="op" id="8517390">=</span>&nbsp;<span class="builtintype" id="8517392">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8517401">if</span>&nbsp;<span class="ident" id="8517404">err</span>&nbsp;<span class="op" id="8517408">!=</span>&nbsp;<span class="ident" id="8517411">nil</span>&nbsp;<span class="op" id="8517415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517422">t</span><span class="op" id="8517423">.</span><span class="ident" id="8517424">Errorf</span><span class="op" id="8517430">(</span><span class="string" id="8517431">&#34;Read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8517447">,</span>&nbsp;<span class="ident" id="8517449">err</span><span class="op" id="8517452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8517459">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517470">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8517476">if</span>&nbsp;<span class="ident" id="8517479">data</span><span class="op" id="8517483">[</span><span class="ident" id="8517484">i</span><span class="op" id="8517485">]</span>&nbsp;<span class="op" id="8517487">==</span>&nbsp;<span class="string" id="8517490">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="8517505">&amp;&amp;</span>&nbsp;<span class="ident" id="8517508">msg</span>&nbsp;<span class="op" id="8517512">==</span>&nbsp;<span class="string" id="8517515">&#34;.&#34;</span>&nbsp;<span class="op" id="8517519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8517526">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517545">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517548">}</span><span class="op" id="8517549">(</span><span class="ident" id="8517550">strings</span><span class="op" id="8517557">.</span><span class="ident" id="8517558">Split</span><span class="op" id="8517563">(</span><span class="ident" id="8517564">server</span><span class="op" id="8517570">,</span>&nbsp;<span class="string" id="8517572">&#34;\r\n&#34;</span><span class="op" id="8517578">)</span><span class="op" id="8517579">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517583">err</span>&nbsp;<span class="op" id="8517587">=</span>&nbsp;<span class="ident" id="8517589">SendMail</span><span class="op" id="8517597">(</span><span class="ident" id="8517598">l</span><span class="op" id="8517599">.</span><span class="ident" id="8517600">Addr</span><span class="op" id="8517604">(</span><span class="op" id="8517605">)</span><span class="op" id="8517606">.</span><span class="ident" id="8517607">String</span><span class="op" id="8517613">(</span><span class="op" id="8517614">)</span><span class="op" id="8517615">,</span>&nbsp;<span class="ident" id="8517617">nil</span><span class="op" id="8517620">,</span>&nbsp;<span class="string" id="8517622">&#34;test@example.com&#34;</span><span class="op" id="8517640">,</span>&nbsp;<span class="op" id="8517642">[</span><span class="op" id="8517643">]</span><span class="builtintype" id="8517644">string</span><span class="op" id="8517650">{</span><span class="string" id="8517651">&#34;other@example.com&#34;</span><span class="op" id="8517670">}</span><span class="op" id="8517671">,</span>&nbsp;<span class="op" id="8517673">[</span><span class="op" id="8517674">]</span><span class="builtintype" id="8517675">byte</span><span class="op" id="8517679">(</span><span class="ident" id="8517680">strings</span><span class="op" id="8517687">.</span><span class="ident" id="8517688">Replace</span><span class="op" id="8517695">(</span><span class="string" id="8517696">`From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno">470</span><br>
<span class="lineno"></span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>`</span><span class="op" id="8517795">,</span>&nbsp;<span class="string" id="8517797">&#34;\n&#34;</span><span class="op" id="8517801">,</span>&nbsp;<span class="string" id="8517803">&#34;\r\n&#34;</span><span class="op" id="8517809">,</span>&nbsp;<span class="op" id="8517811">-</span><span class="num" id="8517812">1</span><span class="op" id="8517813">)</span><span class="op" id="8517814">)</span><span class="op" id="8517815">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8517819">if</span>&nbsp;<span class="ident" id="8517822">err</span>&nbsp;<span class="op" id="8517826">!=</span>&nbsp;<span class="ident" id="8517829">nil</span>&nbsp;<span class="op" id="8517833">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517837">t</span><span class="op" id="8517838">.</span><span class="ident" id="8517839">Errorf</span><span class="op" id="8517845">(</span><span class="string" id="8517846">&#34;%v&#34;</span><span class="op" id="8517850">,</span>&nbsp;<span class="ident" id="8517852">err</span><span class="op" id="8517855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8517862">&lt;-</span><span class="ident" id="8517864">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517870">bcmdbuf</span><span class="op" id="8517877">.</span><span class="ident" id="8517878">Flush</span><span class="op" id="8517883">(</span><span class="op" id="8517884">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517887">actualcmds</span>&nbsp;<span class="op" id="8517898">:=</span>&nbsp;<span class="ident" id="8517901">cmdbuf</span><span class="op" id="8517907">.</span><span class="ident" id="8517908">String</span><span class="op" id="8517914">(</span><span class="op" id="8517915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8517918">if</span>&nbsp;<span class="ident" id="8517921">client</span>&nbsp;<span class="op" id="8517928">!=</span>&nbsp;<span class="ident" id="8517931">actualcmds</span>&nbsp;<span class="op" id="8517942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8517946">t</span><span class="op" id="8517947">.</span><span class="ident" id="8517948">Errorf</span><span class="op" id="8517954">(</span><span class="string" id="8517955">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8517980">,</span>&nbsp;<span class="ident" id="8517982">actualcmds</span><span class="op" id="8517992">,</span>&nbsp;<span class="ident" id="8517994">client</span><span class="op" id="8518000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8518003">}</span><br>
<span class="lineno"></span><span class="op" id="8518005">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="8518008">var</span>&nbsp;<span class="ident" id="8518012">sendMailServer</span>&nbsp;<span class="op" id="8518027">=</span>&nbsp;<span class="string" id="8518029">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno"></span>250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;ok<br>
<span class="lineno">490</span>250&nbsp;Receiver&nbsp;ok<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;ok<br>
<span class="lineno"></span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword" id="8518158">var</span>&nbsp;<span class="ident" id="8518162">sendMailClient</span>&nbsp;<span class="op" id="8518177">=</span>&nbsp;<span class="string" id="8518179">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;test@example.com&gt;<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;other@example.com&gt;<br>
<span class="lineno">500</span>DATA<br>
<span class="lineno"></span>From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">505</span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="8518379">func</span>&nbsp;<span class="ident" id="8518384">TestAuthFailed</span><span class="op" id="8518398">(</span><span class="ident" id="8518399">t</span>&nbsp;<span class="op" id="8518401">*</span><span class="ident" id="8518402">testing</span><span class="op" id="8518409">.</span><span class="ident" id="8518410">T</span><span class="op" id="8518411">)</span>&nbsp;<span class="op" id="8518413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518416">server</span>&nbsp;<span class="op" id="8518423">:=</span>&nbsp;<span class="ident" id="8518426">strings</span><span class="op" id="8518433">.</span><span class="ident" id="8518434">Join</span><span class="op" id="8518438">(</span><span class="ident" id="8518439">strings</span><span class="op" id="8518446">.</span><span class="ident" id="8518447">Split</span><span class="op" id="8518452">(</span><span class="ident" id="8518453">authFailedServer</span><span class="op" id="8518469">,</span>&nbsp;<span class="string" id="8518471">&#34;\n&#34;</span><span class="op" id="8518475">)</span><span class="op" id="8518476">,</span>&nbsp;<span class="string" id="8518478">&#34;\r\n&#34;</span><span class="op" id="8518484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518487">client</span>&nbsp;<span class="op" id="8518494">:=</span>&nbsp;<span class="ident" id="8518497">strings</span><span class="op" id="8518504">.</span><span class="ident" id="8518505">Join</span><span class="op" id="8518509">(</span><span class="ident" id="8518510">strings</span><span class="op" id="8518517">.</span><span class="ident" id="8518518">Split</span><span class="op" id="8518523">(</span><span class="ident" id="8518524">authFailedClient</span><span class="op" id="8518540">,</span>&nbsp;<span class="string" id="8518542">&#34;\n&#34;</span><span class="op" id="8518546">)</span><span class="op" id="8518547">,</span>&nbsp;<span class="string" id="8518549">&#34;\r\n&#34;</span><span class="op" id="8518555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518558">var</span>&nbsp;<span class="ident" id="8518562">cmdbuf</span>&nbsp;<span class="ident" id="8518569">bytes</span><span class="op" id="8518574">.</span><span class="ident" id="8518575">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518583">bcmdbuf</span>&nbsp;<span class="op" id="8518591">:=</span>&nbsp;<span class="ident" id="8518594">bufio</span><span class="op" id="8518599">.</span><span class="ident" id="8518600">NewWriter</span><span class="op" id="8518609">(</span><span class="op" id="8518610">&amp;</span><span class="ident" id="8518611">cmdbuf</span><span class="op" id="8518617">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518620">var</span>&nbsp;<span class="ident" id="8518624">fake</span>&nbsp;<span class="ident" id="8518629">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518636">fake</span><span class="op" id="8518640">.</span><span class="ident" id="8518641">ReadWriter</span>&nbsp;<span class="op" id="8518652">=</span>&nbsp;<span class="ident" id="8518654">bufio</span><span class="op" id="8518659">.</span><span class="ident" id="8518660">NewReadWriter</span><span class="op" id="8518673">(</span><span class="ident" id="8518674">bufio</span><span class="op" id="8518679">.</span><span class="ident" id="8518680">NewReader</span><span class="op" id="8518689">(</span><span class="ident" id="8518690">strings</span><span class="op" id="8518697">.</span><span class="ident" id="8518698">NewReader</span><span class="op" id="8518707">(</span><span class="ident" id="8518708">server</span><span class="op" id="8518714">)</span><span class="op" id="8518715">)</span><span class="op" id="8518716">,</span>&nbsp;<span class="ident" id="8518718">bcmdbuf</span><span class="op" id="8518725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518728">c</span><span class="op" id="8518729">,</span>&nbsp;<span class="ident" id="8518731">err</span>&nbsp;<span class="op" id="8518735">:=</span>&nbsp;<span class="ident" id="8518738">NewClient</span><span class="op" id="8518747">(</span><span class="ident" id="8518748">fake</span><span class="op" id="8518752">,</span>&nbsp;<span class="string" id="8518754">&#34;fake.host&#34;</span><span class="op" id="8518765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518768">if</span>&nbsp;<span class="ident" id="8518771">err</span>&nbsp;<span class="op" id="8518775">!=</span>&nbsp;<span class="ident" id="8518778">nil</span>&nbsp;<span class="op" id="8518782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518786">t</span><span class="op" id="8518787">.</span><span class="ident" id="8518788">Fatalf</span><span class="op" id="8518794">(</span><span class="string" id="8518795">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="8518810">,</span>&nbsp;<span class="ident" id="8518812">err</span><span class="op" id="8518815">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8518818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518821">defer</span>&nbsp;<span class="ident" id="8518827">c</span><span class="op" id="8518828">.</span><span class="ident" id="8518829">Close</span><span class="op" id="8518834">(</span><span class="op" id="8518835">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518839">c</span><span class="op" id="8518840">.</span><span class="ident" id="8518841">tls</span>&nbsp;<span class="op" id="8518845">=</span>&nbsp;<span class="builtintype" id="8518847">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518853">c</span><span class="op" id="8518854">.</span><span class="ident" id="8518855">serverName</span>&nbsp;<span class="op" id="8518866">=</span>&nbsp;<span class="string" id="8518868">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518887">err</span>&nbsp;<span class="op" id="8518891">=</span>&nbsp;<span class="ident" id="8518893">c</span><span class="op" id="8518894">.</span><span class="ident" id="8518895">Auth</span><span class="op" id="8518899">(</span><span class="ident" id="8518900">PlainAuth</span><span class="op" id="8518909">(</span><span class="string" id="8518910">&#34;&#34;</span><span class="op" id="8518912">,</span>&nbsp;<span class="string" id="8518914">&#34;user&#34;</span><span class="op" id="8518920">,</span>&nbsp;<span class="string" id="8518922">&#34;pass&#34;</span><span class="op" id="8518928">,</span>&nbsp;<span class="string" id="8518930">&#34;smtp.google.com&#34;</span><span class="op" id="8518947">)</span><span class="op" id="8518948">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8518952">if</span>&nbsp;<span class="ident" id="8518955">err</span>&nbsp;<span class="op" id="8518959">==</span>&nbsp;<span class="ident" id="8518962">nil</span>&nbsp;<span class="op" id="8518966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8518970">t</span><span class="op" id="8518971">.</span><span class="ident" id="8518972">Error</span><span class="op" id="8518977">(</span><span class="string" id="8518978">&#34;Auth:&nbsp;expected&nbsp;error;&nbsp;got&nbsp;none&#34;</span><span class="op" id="8519010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519013">}</span>&nbsp;<span class="keyword" id="8519015">else</span>&nbsp;<span class="keyword" id="8519020">if</span>&nbsp;<span class="ident" id="8519023">err</span><span class="op" id="8519026">.</span><span class="ident" id="8519027">Error</span><span class="op" id="8519032">(</span><span class="op" id="8519033">)</span>&nbsp;<span class="op" id="8519035">!=</span>&nbsp;<span class="string" id="8519038">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span>&nbsp;<span class="op" id="8519092">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519096">t</span><span class="op" id="8519097">.</span><span class="ident" id="8519098">Errorf</span><span class="op" id="8519104">(</span><span class="string" id="8519105">&#34;Auth:&nbsp;got&nbsp;error:&nbsp;%v,&nbsp;want:&nbsp;%s&#34;</span><span class="op" id="8519136">,</span>&nbsp;<span class="ident" id="8519138">err</span><span class="op" id="8519141">,</span>&nbsp;<span class="string" id="8519143">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span><span class="op" id="8519196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519203">bcmdbuf</span><span class="op" id="8519210">.</span><span class="ident" id="8519211">Flush</span><span class="op" id="8519216">(</span><span class="op" id="8519217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519220">actualcmds</span>&nbsp;<span class="op" id="8519231">:=</span>&nbsp;<span class="ident" id="8519234">cmdbuf</span><span class="op" id="8519240">.</span><span class="ident" id="8519241">String</span><span class="op" id="8519247">(</span><span class="op" id="8519248">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519251">if</span>&nbsp;<span class="ident" id="8519254">client</span>&nbsp;<span class="op" id="8519261">!=</span>&nbsp;<span class="ident" id="8519264">actualcmds</span>&nbsp;<span class="op" id="8519275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519279">t</span><span class="op" id="8519280">.</span><span class="ident" id="8519281">Errorf</span><span class="op" id="8519287">(</span><span class="string" id="8519288">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="8519313">,</span>&nbsp;<span class="ident" id="8519315">actualcmds</span><span class="op" id="8519325">,</span>&nbsp;<span class="ident" id="8519327">client</span><span class="op" id="8519333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519336">}</span><br>
<span class="lineno"></span><span class="op" id="8519338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="keyword" id="8519341">var</span>&nbsp;<span class="ident" id="8519345">authFailedServer</span>&nbsp;<span class="op" id="8519362">=</span>&nbsp;<span class="string" id="8519364">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>535-Invalid&nbsp;credentials<br>
<span class="lineno"></span>535&nbsp;please&nbsp;see&nbsp;www.example.com<br>
<span class="lineno">545</span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8519506">var</span>&nbsp;<span class="ident" id="8519510">authFailedClient</span>&nbsp;<span class="op" id="8519527">=</span>&nbsp;<span class="string" id="8519529">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno">550</span>*<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8519583">func</span>&nbsp;<span class="ident" id="8519588">TestTLSClient</span><span class="op" id="8519601">(</span><span class="ident" id="8519602">t</span>&nbsp;<span class="op" id="8519604">*</span><span class="ident" id="8519605">testing</span><span class="op" id="8519612">.</span><span class="ident" id="8519613">T</span><span class="op" id="8519614">)</span>&nbsp;<span class="op" id="8519616">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519619">ln</span>&nbsp;<span class="op" id="8519622">:=</span>&nbsp;<span class="ident" id="8519625">newLocalListener</span><span class="op" id="8519641">(</span><span class="ident" id="8519642">t</span><span class="op" id="8519643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519646">defer</span>&nbsp;<span class="ident" id="8519652">ln</span><span class="op" id="8519654">.</span><span class="ident" id="8519655">Close</span><span class="op" id="8519660">(</span><span class="op" id="8519661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519664">errc</span>&nbsp;<span class="op" id="8519669">:=</span>&nbsp;<span class="builtinfunc" id="8519672">make</span><span class="op" id="8519676">(</span><span class="keyword" id="8519677">chan</span>&nbsp;<span class="builtintype" id="8519682">error</span><span class="op" id="8519687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519690">go</span>&nbsp;<span class="keyword" id="8519693">func</span><span class="op" id="8519697">(</span><span class="op" id="8519698">)</span>&nbsp;<span class="op" id="8519700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519704">errc</span>&nbsp;<span class="op" id="8519709">&lt;-</span>&nbsp;<span class="ident" id="8519712">sendMail</span><span class="op" id="8519720">(</span><span class="ident" id="8519721">ln</span><span class="op" id="8519723">.</span><span class="ident" id="8519724">Addr</span><span class="op" id="8519728">(</span><span class="op" id="8519729">)</span><span class="op" id="8519730">.</span><span class="ident" id="8519731">String</span><span class="op" id="8519737">(</span><span class="op" id="8519738">)</span><span class="op" id="8519739">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519742">}</span><span class="op" id="8519743">(</span><span class="op" id="8519744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519747">conn</span><span class="op" id="8519751">,</span>&nbsp;<span class="ident" id="8519753">err</span>&nbsp;<span class="op" id="8519757">:=</span>&nbsp;<span class="ident" id="8519760">ln</span><span class="op" id="8519762">.</span><span class="ident" id="8519763">Accept</span><span class="op" id="8519769">(</span><span class="op" id="8519770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519773">if</span>&nbsp;<span class="ident" id="8519776">err</span>&nbsp;<span class="op" id="8519780">!=</span>&nbsp;<span class="ident" id="8519783">nil</span>&nbsp;<span class="op" id="8519787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519791">t</span><span class="op" id="8519792">.</span><span class="ident" id="8519793">Fatalf</span><span class="op" id="8519799">(</span><span class="string" id="8519800">&#34;failed&nbsp;to&nbsp;accept&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="8519833">,</span>&nbsp;<span class="ident" id="8519835">err</span><span class="op" id="8519838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519841">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519844">defer</span>&nbsp;<span class="ident" id="8519850">conn</span><span class="op" id="8519854">.</span><span class="ident" id="8519855">Close</span><span class="op" id="8519860">(</span><span class="op" id="8519861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519864">if</span>&nbsp;<span class="ident" id="8519867">err</span>&nbsp;<span class="op" id="8519871">:=</span>&nbsp;<span class="ident" id="8519874">serverHandle</span><span class="op" id="8519886">(</span><span class="ident" id="8519887">conn</span><span class="op" id="8519891">,</span>&nbsp;<span class="ident" id="8519893">t</span><span class="op" id="8519894">)</span><span class="op" id="8519895">;</span>&nbsp;<span class="ident" id="8519897">err</span>&nbsp;<span class="op" id="8519901">!=</span>&nbsp;<span class="ident" id="8519904">nil</span>&nbsp;<span class="op" id="8519908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519912">t</span><span class="op" id="8519913">.</span><span class="ident" id="8519914">Fatalf</span><span class="op" id="8519920">(</span><span class="string" id="8519921">&#34;failed&nbsp;to&nbsp;handle&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="8519954">,</span>&nbsp;<span class="ident" id="8519956">err</span><span class="op" id="8519959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8519962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8519965">if</span>&nbsp;<span class="ident" id="8519968">err</span>&nbsp;<span class="op" id="8519972">:=</span>&nbsp;<span class="op" id="8519975">&lt;-</span><span class="ident" id="8519977">errc</span><span class="op" id="8519981">;</span>&nbsp;<span class="ident" id="8519983">err</span>&nbsp;<span class="op" id="8519987">!=</span>&nbsp;<span class="ident" id="8519990">nil</span>&nbsp;<span class="op" id="8519994">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8519998">t</span><span class="op" id="8519999">.</span><span class="ident" id="8520000">Fatalf</span><span class="op" id="8520006">(</span><span class="string" id="8520007">&#34;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8520025">,</span>&nbsp;<span class="ident" id="8520027">err</span><span class="op" id="8520030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520033">}</span><br>
<span class="lineno"></span><span class="op" id="8520035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8520038">func</span>&nbsp;<span class="ident" id="8520043">newLocalListener</span><span class="op" id="8520059">(</span><span class="ident" id="8520060">t</span>&nbsp;<span class="op" id="8520062">*</span><span class="ident" id="8520063">testing</span><span class="op" id="8520070">.</span><span class="ident" id="8520071">T</span><span class="op" id="8520072">)</span>&nbsp;<span class="ident" id="8520074">net</span><span class="op" id="8520077">.</span><span class="ident" id="8520078">Listener</span>&nbsp;<span class="op" id="8520087">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520090">ln</span><span class="op" id="8520092">,</span>&nbsp;<span class="ident" id="8520094">err</span>&nbsp;<span class="op" id="8520098">:=</span>&nbsp;<span class="ident" id="8520101">net</span><span class="op" id="8520104">.</span><span class="ident" id="8520105">Listen</span><span class="op" id="8520111">(</span><span class="string" id="8520112">&#34;tcp&#34;</span><span class="op" id="8520117">,</span>&nbsp;<span class="string" id="8520119">&#34;127.0.0.1:0&#34;</span><span class="op" id="8520132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520135">if</span>&nbsp;<span class="ident" id="8520138">err</span>&nbsp;<span class="op" id="8520142">!=</span>&nbsp;<span class="ident" id="8520145">nil</span>&nbsp;<span class="op" id="8520149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520153">ln</span><span class="op" id="8520155">,</span>&nbsp;<span class="ident" id="8520157">err</span>&nbsp;<span class="op" id="8520161">=</span>&nbsp;<span class="ident" id="8520163">net</span><span class="op" id="8520166">.</span><span class="ident" id="8520167">Listen</span><span class="op" id="8520173">(</span><span class="string" id="8520174">&#34;tcp6&#34;</span><span class="op" id="8520180">,</span>&nbsp;<span class="string" id="8520182">&#34;[::1]:0&#34;</span><span class="op" id="8520191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520197">if</span>&nbsp;<span class="ident" id="8520200">err</span>&nbsp;<span class="op" id="8520204">!=</span>&nbsp;<span class="ident" id="8520207">nil</span>&nbsp;<span class="op" id="8520211">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520215">t</span><span class="op" id="8520216">.</span><span class="ident" id="8520217">Fatal</span><span class="op" id="8520222">(</span><span class="ident" id="8520223">err</span><span class="op" id="8520226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520232">return</span>&nbsp;<span class="ident" id="8520239">ln</span><br>
<span class="lineno"></span><span class="op" id="8520242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword" id="8520245">type</span>&nbsp;<span class="ident" id="8520250">smtpSender</span>&nbsp;<span class="keyword" id="8520261">struct</span>&nbsp;<span class="op" id="8520268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520271">w</span>&nbsp;<span class="ident" id="8520273">io</span><span class="op" id="8520275">.</span><span class="ident" id="8520276">Writer</span><br>
<span class="lineno"></span><span class="op" id="8520283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8520286">func</span>&nbsp;<span class="op" id="8520291">(</span><span class="ident" id="8520292">s</span>&nbsp;<span class="ident" id="8520294">smtpSender</span><span class="op" id="8520304">)</span>&nbsp;<span class="ident" id="8520306">send</span><span class="op" id="8520310">(</span><span class="ident" id="8520311">f</span>&nbsp;<span class="builtintype" id="8520313">string</span><span class="op" id="8520319">)</span>&nbsp;<span class="op" id="8520321">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520324">s</span><span class="op" id="8520325">.</span><span class="ident" id="8520326">w</span><span class="op" id="8520327">.</span><span class="ident" id="8520328">Write</span><span class="op" id="8520333">(</span><span class="op" id="8520334">[</span><span class="op" id="8520335">]</span><span class="builtintype" id="8520336">byte</span><span class="op" id="8520340">(</span><span class="ident" id="8520341">f</span>&nbsp;<span class="op" id="8520343">+</span>&nbsp;<span class="string" id="8520345">&#34;\r\n&#34;</span><span class="op" id="8520351">)</span><span class="op" id="8520352">)</span><br>
<span class="lineno"></span><span class="op" id="8520354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8520357">//&nbsp;smtp&nbsp;server,&nbsp;finely&nbsp;tailored&nbsp;to&nbsp;deal&nbsp;with&nbsp;our&nbsp;own&nbsp;client&nbsp;only!</span><br>
<span class="lineno"></span><span class="keyword" id="8520423">func</span>&nbsp;<span class="ident" id="8520428">serverHandle</span><span class="op" id="8520440">(</span><span class="ident" id="8520441">c</span>&nbsp;<span class="ident" id="8520443">net</span><span class="op" id="8520446">.</span><span class="ident" id="8520447">Conn</span><span class="op" id="8520451">,</span>&nbsp;<span class="ident" id="8520453">t</span>&nbsp;<span class="op" id="8520455">*</span><span class="ident" id="8520456">testing</span><span class="op" id="8520463">.</span><span class="ident" id="8520464">T</span><span class="op" id="8520465">)</span>&nbsp;<span class="builtintype" id="8520467">error</span>&nbsp;<span class="op" id="8520473">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520476">send</span>&nbsp;<span class="op" id="8520481">:=</span>&nbsp;<span class="ident" id="8520484">smtpSender</span><span class="op" id="8520494">{</span><span class="ident" id="8520495">c</span><span class="op" id="8520496">}</span><span class="op" id="8520497">.</span><span class="ident" id="8520498">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520504">send</span><span class="op" id="8520508">(</span><span class="string" id="8520509">&#34;220&nbsp;127.0.0.1&nbsp;ESMTP&nbsp;service&nbsp;ready&#34;</span><span class="op" id="8520544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520547">s</span>&nbsp;<span class="op" id="8520549">:=</span>&nbsp;<span class="ident" id="8520552">bufio</span><span class="op" id="8520557">.</span><span class="ident" id="8520558">NewScanner</span><span class="op" id="8520568">(</span><span class="ident" id="8520569">c</span><span class="op" id="8520570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520573">for</span>&nbsp;<span class="ident" id="8520577">s</span><span class="op" id="8520578">.</span><span class="ident" id="8520579">Scan</span><span class="op" id="8520583">(</span><span class="op" id="8520584">)</span>&nbsp;<span class="op" id="8520586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520590">switch</span>&nbsp;<span class="ident" id="8520597">s</span><span class="op" id="8520598">.</span><span class="ident" id="8520599">Text</span><span class="op" id="8520603">(</span><span class="op" id="8520604">)</span>&nbsp;<span class="op" id="8520606">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520610">case</span>&nbsp;<span class="string" id="8520615">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="8520631">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520636">send</span><span class="op" id="8520640">(</span><span class="string" id="8520641">&#34;250-127.0.0.1&nbsp;ESMTP&nbsp;offers&nbsp;a&nbsp;warm&nbsp;hug&nbsp;of&nbsp;welcome&#34;</span><span class="op" id="8520691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520696">send</span><span class="op" id="8520700">(</span><span class="string" id="8520701">&#34;250-STARTTLS&#34;</span><span class="op" id="8520715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520720">send</span><span class="op" id="8520724">(</span><span class="string" id="8520725">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8520733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520737">case</span>&nbsp;<span class="string" id="8520742">&#34;STARTTLS&#34;</span><span class="op" id="8520752">:</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520757">send</span><span class="op" id="8520761">(</span><span class="string" id="8520762">&#34;220&nbsp;Go&nbsp;ahead&#34;</span><span class="op" id="8520776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520781">keypair</span><span class="op" id="8520788">,</span>&nbsp;<span class="ident" id="8520790">err</span>&nbsp;<span class="op" id="8520794">:=</span>&nbsp;<span class="ident" id="8520797">tls</span><span class="op" id="8520800">.</span><span class="ident" id="8520801">X509KeyPair</span><span class="op" id="8520812">(</span><span class="ident" id="8520813">localhostCert</span><span class="op" id="8520826">,</span>&nbsp;<span class="ident" id="8520828">localhostKey</span><span class="op" id="8520840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520845">if</span>&nbsp;<span class="ident" id="8520848">err</span>&nbsp;<span class="op" id="8520852">!=</span>&nbsp;<span class="ident" id="8520855">nil</span>&nbsp;<span class="op" id="8520859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520865">return</span>&nbsp;<span class="ident" id="8520872">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8520879">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520884">config</span>&nbsp;<span class="op" id="8520891">:=</span>&nbsp;<span class="op" id="8520894">&amp;</span><span class="ident" id="8520895">tls</span><span class="op" id="8520898">.</span><span class="ident" id="8520899">Config</span><span class="op" id="8520905">{</span><span class="ident" id="8520906">Certificates</span><span class="op" id="8520918">:</span>&nbsp;<span class="op" id="8520920">[</span><span class="op" id="8520921">]</span><span class="ident" id="8520922">tls</span><span class="op" id="8520925">.</span><span class="ident" id="8520926">Certificate</span><span class="op" id="8520937">{</span><span class="ident" id="8520938">keypair</span><span class="op" id="8520945">}</span><span class="op" id="8520946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8520951">c</span>&nbsp;<span class="op" id="8520953">=</span>&nbsp;<span class="ident" id="8520955">tls</span><span class="op" id="8520958">.</span><span class="ident" id="8520959">Server</span><span class="op" id="8520965">(</span><span class="ident" id="8520966">c</span><span class="op" id="8520967">,</span>&nbsp;<span class="ident" id="8520969">config</span><span class="op" id="8520975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520980">defer</span>&nbsp;<span class="ident" id="8520986">c</span><span class="op" id="8520987">.</span><span class="ident" id="8520988">Close</span><span class="op" id="8520993">(</span><span class="op" id="8520994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8520999">return</span>&nbsp;<span class="ident" id="8521006">serverHandleTLS</span><span class="op" id="8521021">(</span><span class="ident" id="8521022">c</span><span class="op" id="8521023">,</span>&nbsp;<span class="ident" id="8521025">t</span><span class="op" id="8521026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521030">default</span><span class="op" id="8521037">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521042">t</span><span class="op" id="8521043">.</span><span class="ident" id="8521044">Fatalf</span><span class="op" id="8521050">(</span><span class="string" id="8521051">&#34;unrecognized&nbsp;command:&nbsp;%q&#34;</span><span class="op" id="8521077">,</span>&nbsp;<span class="ident" id="8521079">s</span><span class="op" id="8521080">.</span><span class="ident" id="8521081">Text</span><span class="op" id="8521085">(</span><span class="op" id="8521086">)</span><span class="op" id="8521087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521097">return</span>&nbsp;<span class="ident" id="8521104">s</span><span class="op" id="8521105">.</span><span class="ident" id="8521106">Err</span><span class="op" id="8521109">(</span><span class="op" id="8521110">)</span><br>
<span class="lineno"></span><span class="op" id="8521112">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="8521115">func</span>&nbsp;<span class="ident" id="8521120">serverHandleTLS</span><span class="op" id="8521135">(</span><span class="ident" id="8521136">c</span>&nbsp;<span class="ident" id="8521138">net</span><span class="op" id="8521141">.</span><span class="ident" id="8521142">Conn</span><span class="op" id="8521146">,</span>&nbsp;<span class="ident" id="8521148">t</span>&nbsp;<span class="op" id="8521150">*</span><span class="ident" id="8521151">testing</span><span class="op" id="8521158">.</span><span class="ident" id="8521159">T</span><span class="op" id="8521160">)</span>&nbsp;<span class="builtintype" id="8521162">error</span>&nbsp;<span class="op" id="8521168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521171">send</span>&nbsp;<span class="op" id="8521176">:=</span>&nbsp;<span class="ident" id="8521179">smtpSender</span><span class="op" id="8521189">{</span><span class="ident" id="8521190">c</span><span class="op" id="8521191">}</span><span class="op" id="8521192">.</span><span class="ident" id="8521193">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521199">s</span>&nbsp;<span class="op" id="8521201">:=</span>&nbsp;<span class="ident" id="8521204">bufio</span><span class="op" id="8521209">.</span><span class="ident" id="8521210">NewScanner</span><span class="op" id="8521220">(</span><span class="ident" id="8521221">c</span><span class="op" id="8521222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521225">for</span>&nbsp;<span class="ident" id="8521229">s</span><span class="op" id="8521230">.</span><span class="ident" id="8521231">Scan</span><span class="op" id="8521235">(</span><span class="op" id="8521236">)</span>&nbsp;<span class="op" id="8521238">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521242">switch</span>&nbsp;<span class="ident" id="8521249">s</span><span class="op" id="8521250">.</span><span class="ident" id="8521251">Text</span><span class="op" id="8521255">(</span><span class="op" id="8521256">)</span>&nbsp;<span class="op" id="8521258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521262">case</span>&nbsp;<span class="string" id="8521267">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="8521283">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521288">send</span><span class="op" id="8521292">(</span><span class="string" id="8521293">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8521301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521305">case</span>&nbsp;<span class="string" id="8521310">&#34;MAIL&nbsp;FROM:&lt;joe1@example.com&gt;&#34;</span><span class="op" id="8521340">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521345">send</span><span class="op" id="8521349">(</span><span class="string" id="8521350">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8521358">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521362">case</span>&nbsp;<span class="string" id="8521367">&#34;RCPT&nbsp;TO:&lt;joe2@example.com&gt;&#34;</span><span class="op" id="8521395">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521400">send</span><span class="op" id="8521404">(</span><span class="string" id="8521405">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8521413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521417">case</span>&nbsp;<span class="string" id="8521422">&#34;DATA&#34;</span><span class="op" id="8521428">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521433">send</span><span class="op" id="8521437">(</span><span class="string" id="8521438">&#34;354&nbsp;send&nbsp;the&nbsp;mail&nbsp;data,&nbsp;end&nbsp;with&nbsp;.&#34;</span><span class="op" id="8521474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521479">send</span><span class="op" id="8521483">(</span><span class="string" id="8521484">&#34;250&nbsp;Ok&#34;</span><span class="op" id="8521492">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521496">case</span>&nbsp;<span class="string" id="8521501">&#34;Subject:&nbsp;test&#34;</span><span class="op" id="8521516">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521520">case</span>&nbsp;<span class="string" id="8521525">&#34;&#34;</span><span class="op" id="8521527">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521531">case</span>&nbsp;<span class="string" id="8521536">&#34;howdy!&#34;</span><span class="op" id="8521544">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521548">case</span>&nbsp;<span class="string" id="8521553">&#34;.&#34;</span><span class="op" id="8521556">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521560">case</span>&nbsp;<span class="string" id="8521565">&#34;QUIT&#34;</span><span class="op" id="8521571">:</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521576">send</span><span class="op" id="8521580">(</span><span class="string" id="8521581">&#34;221&nbsp;127.0.0.1&nbsp;Service&nbsp;closing&nbsp;transmission&nbsp;channel&#34;</span><span class="op" id="8521633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521638">return</span>&nbsp;<span class="ident" id="8521645">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521651">default</span><span class="op" id="8521658">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521663">t</span><span class="op" id="8521664">.</span><span class="ident" id="8521665">Fatalf</span><span class="op" id="8521671">(</span><span class="string" id="8521672">&#34;unrecognized&nbsp;command&nbsp;during&nbsp;TLS:&nbsp;%q&#34;</span><span class="op" id="8521709">,</span>&nbsp;<span class="ident" id="8521711">s</span><span class="op" id="8521712">.</span><span class="ident" id="8521713">Text</span><span class="op" id="8521717">(</span><span class="op" id="8521718">)</span><span class="op" id="8521719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521723">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8521729">return</span>&nbsp;<span class="ident" id="8521736">s</span><span class="op" id="8521737">.</span><span class="ident" id="8521738">Err</span><span class="op" id="8521741">(</span><span class="op" id="8521742">)</span><br>
<span class="lineno"></span><span class="op" id="8521744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8521747">func</span>&nbsp;<span class="ident" id="8521752">init</span><span class="op" id="8521756">(</span><span class="op" id="8521757">)</span>&nbsp;<span class="op" id="8521759">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521762">testRootCAs</span>&nbsp;<span class="op" id="8521774">:=</span>&nbsp;<span class="ident" id="8521777">x509</span><span class="op" id="8521781">.</span><span class="ident" id="8521782">NewCertPool</span><span class="op" id="8521793">(</span><span class="op" id="8521794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521797">testRootCAs</span><span class="op" id="8521808">.</span><span class="ident" id="8521809">AppendCertsFromPEM</span><span class="op" id="8521827">(</span><span class="ident" id="8521828">localhostCert</span><span class="op" id="8521841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521844">testHookStartTLS</span>&nbsp;<span class="op" id="8521861">=</span>&nbsp;<span class="keyword" id="8521863">func</span><span class="op" id="8521867">(</span><span class="ident" id="8521868">config</span>&nbsp;<span class="op" id="8521875">*</span><span class="ident" id="8521876">tls</span><span class="op" id="8521879">.</span><span class="ident" id="8521880">Config</span><span class="op" id="8521886">)</span>&nbsp;<span class="op" id="8521888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521892">config</span><span class="op" id="8521898">.</span><span class="ident" id="8521899">RootCAs</span>&nbsp;<span class="op" id="8521907">=</span>&nbsp;<span class="ident" id="8521909">testRootCAs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8521922">}</span><br>
<span class="lineno">655</span><span class="op" id="8521924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8521927">func</span>&nbsp;<span class="ident" id="8521932">sendMail</span><span class="op" id="8521940">(</span><span class="ident" id="8521941">hostPort</span>&nbsp;<span class="builtintype" id="8521950">string</span><span class="op" id="8521956">)</span>&nbsp;<span class="builtintype" id="8521958">error</span>&nbsp;<span class="op" id="8521964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8521967">host</span><span class="op" id="8521971">,</span>&nbsp;<span class="ident" id="8521973">_</span><span class="op" id="8521974">,</span>&nbsp;<span class="ident" id="8521976">err</span>&nbsp;<span class="op" id="8521980">:=</span>&nbsp;<span class="ident" id="8521983">net</span><span class="op" id="8521986">.</span><span class="ident" id="8521987">SplitHostPort</span><span class="op" id="8522000">(</span><span class="ident" id="8522001">hostPort</span><span class="op" id="8522009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522012">if</span>&nbsp;<span class="ident" id="8522015">err</span>&nbsp;<span class="op" id="8522019">!=</span>&nbsp;<span class="ident" id="8522022">nil</span>&nbsp;<span class="op" id="8522026">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522030">return</span>&nbsp;<span class="ident" id="8522037">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8522042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522045">auth</span>&nbsp;<span class="op" id="8522050">:=</span>&nbsp;<span class="ident" id="8522053">PlainAuth</span><span class="op" id="8522062">(</span><span class="string" id="8522063">&#34;&#34;</span><span class="op" id="8522065">,</span>&nbsp;<span class="string" id="8522067">&#34;&#34;</span><span class="op" id="8522069">,</span>&nbsp;<span class="string" id="8522071">&#34;&#34;</span><span class="op" id="8522073">,</span>&nbsp;<span class="ident" id="8522075">host</span><span class="op" id="8522079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522082">from</span>&nbsp;<span class="op" id="8522087">:=</span>&nbsp;<span class="string" id="8522090">&#34;joe1@example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522110">to</span>&nbsp;<span class="op" id="8522113">:=</span>&nbsp;<span class="op" id="8522116">[</span><span class="op" id="8522117">]</span><span class="builtintype" id="8522118">string</span><span class="op" id="8522124">{</span><span class="string" id="8522125">&#34;joe2@example.com&#34;</span><span class="op" id="8522143">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522146">return</span>&nbsp;<span class="ident" id="8522153">SendMail</span><span class="op" id="8522161">(</span><span class="ident" id="8522162">hostPort</span><span class="op" id="8522170">,</span>&nbsp;<span class="ident" id="8522172">auth</span><span class="op" id="8522176">,</span>&nbsp;<span class="ident" id="8522178">from</span><span class="op" id="8522182">,</span>&nbsp;<span class="ident" id="8522184">to</span><span class="op" id="8522186">,</span>&nbsp;<span class="op" id="8522188">[</span><span class="op" id="8522189">]</span><span class="builtintype" id="8522190">byte</span><span class="op" id="8522194">(</span><span class="string" id="8522195">&#34;Subject:&nbsp;test\n\nhowdy!&#34;</span><span class="op" id="8522220">)</span><span class="op" id="8522221">)</span><br>
<span class="lineno"></span><span class="op" id="8522223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8522226">//&nbsp;(copied&nbsp;from&nbsp;net/http/httptest)</span><br>
<span class="lineno"></span><span class="comment" id="8522261">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno">670</span><span class="comment" id="8522317">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno"></span><span class="comment" id="8522390">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="8522409">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="8522443">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="8522579">var</span>&nbsp;<span class="ident" id="8522583">localhostCert</span>&nbsp;<span class="op" id="8522597">=</span>&nbsp;<span class="op" id="8522599">[</span><span class="op" id="8522600">]</span><span class="builtintype" id="8522601">byte</span><span class="op" id="8522605">(</span><span class="string" id="8522606">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno">675</span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno"></span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno">680</span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno"></span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="8523177">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span><span class="comment" id="8523180">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno"></span><span class="keyword" id="8523234">var</span>&nbsp;<span class="ident" id="8523238">localhostKey</span>&nbsp;<span class="op" id="8523251">=</span>&nbsp;<span class="op" id="8523253">[</span><span class="op" id="8523254">]</span><span class="builtintype" id="8523255">byte</span><span class="op" id="8523259">(</span><span class="string" id="8523260">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno">690</span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno"></span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="8523758">)</span>
</div>
</body>
</html>
