<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3429832">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3429887">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3429941">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3429992">package</span>&nbsp;<span class="ident" id="3430000">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3430005">import</span>&nbsp;<span class="op" id="3430012">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3430015">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3430025">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3430041">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3430055">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3430072">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3430087">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3430104">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3430114">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3430121">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="3430126">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3430129">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="3430205">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="3430257">type</span>&nbsp;<span class="ident" id="3430262">serverHandshakeState</span>&nbsp;<span class="keyword" id="3430283">struct</span>&nbsp;<span class="op" id="3430290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430293">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3430309">*</span><span class="ident" id="3430310">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430316">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3430332">*</span><span class="ident" id="3430333">clientHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430349">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3430365">*</span><span class="ident" id="3430366">serverHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430382">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3430398">*</span><span class="ident" id="3430399">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430412">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3430428">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430434">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3430450">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430456">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3430472">*</span><span class="ident" id="3430473">sessionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430487">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3430503">finishedHash</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430517">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3430533">[</span><span class="op" id="3430534">]</span><span class="builtintype" id="3430535">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430541">certsFromClient</span>&nbsp;<span class="op" id="3430557">[</span><span class="op" id="3430558">]</span><span class="op" id="3430559">[</span><span class="op" id="3430560">]</span><span class="builtintype" id="3430561">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430567">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3430583">*</span><span class="ident" id="3430584">Certificate</span><br>
<span class="lineno"></span><span class="op" id="3430596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3430599">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="3430656">func</span>&nbsp;<span class="op" id="3430661">(</span><span class="ident" id="3430662">c</span>&nbsp;<span class="op" id="3430664">*</span><span class="ident" id="3430665">Conn</span><span class="op" id="3430669">)</span>&nbsp;<span class="ident" id="3430671">serverHandshake</span><span class="op" id="3430686">(</span><span class="op" id="3430687">)</span>&nbsp;<span class="builtintype" id="3430689">error</span>&nbsp;<span class="op" id="3430695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430698">config</span>&nbsp;<span class="op" id="3430705">:=</span>&nbsp;<span class="ident" id="3430708">c</span><span class="op" id="3430709">.</span><span class="ident" id="3430710">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430719">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430790">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430820">config</span><span class="op" id="3430826">.</span><span class="ident" id="3430827">serverInitOnce</span><span class="op" id="3430841">.</span><span class="ident" id="3430842">Do</span><span class="op" id="3430844">(</span><span class="ident" id="3430845">config</span><span class="op" id="3430851">.</span><span class="ident" id="3430852">serverInit</span><span class="op" id="3430862">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430866">hs</span>&nbsp;<span class="op" id="3430869">:=</span>&nbsp;<span class="ident" id="3430872">serverHandshakeState</span><span class="op" id="3430892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430896">c</span><span class="op" id="3430897">:</span>&nbsp;<span class="ident" id="3430899">c</span><span class="op" id="3430900">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430906">isResume</span><span class="op" id="3430914">,</span>&nbsp;<span class="ident" id="3430916">err</span>&nbsp;<span class="op" id="3430920">:=</span>&nbsp;<span class="ident" id="3430923">hs</span><span class="op" id="3430925">.</span><span class="ident" id="3430926">readClientHello</span><span class="op" id="3430941">(</span><span class="op" id="3430942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430945">if</span>&nbsp;<span class="ident" id="3430948">err</span>&nbsp;<span class="op" id="3430952">!=</span>&nbsp;<span class="ident" id="3430955">nil</span>&nbsp;<span class="op" id="3430959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430963">return</span>&nbsp;<span class="ident" id="3430970">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430975">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430979">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431071">if</span>&nbsp;<span class="ident" id="3431074">isResume</span>&nbsp;<span class="op" id="3431083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3431087">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431172">if</span>&nbsp;<span class="ident" id="3431175">err</span>&nbsp;<span class="op" id="3431179">:=</span>&nbsp;<span class="ident" id="3431182">hs</span><span class="op" id="3431184">.</span><span class="ident" id="3431185">doResumeHandshake</span><span class="op" id="3431202">(</span><span class="op" id="3431203">)</span><span class="op" id="3431204">;</span>&nbsp;<span class="ident" id="3431206">err</span>&nbsp;<span class="op" id="3431210">!=</span>&nbsp;<span class="ident" id="3431213">nil</span>&nbsp;<span class="op" id="3431217">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431222">return</span>&nbsp;<span class="ident" id="3431229">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431239">if</span>&nbsp;<span class="ident" id="3431242">err</span>&nbsp;<span class="op" id="3431246">:=</span>&nbsp;<span class="ident" id="3431249">hs</span><span class="op" id="3431251">.</span><span class="ident" id="3431252">establishKeys</span><span class="op" id="3431265">(</span><span class="op" id="3431266">)</span><span class="op" id="3431267">;</span>&nbsp;<span class="ident" id="3431269">err</span>&nbsp;<span class="op" id="3431273">!=</span>&nbsp;<span class="ident" id="3431276">nil</span>&nbsp;<span class="op" id="3431280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431285">return</span>&nbsp;<span class="ident" id="3431292">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431298">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431302">if</span>&nbsp;<span class="ident" id="3431305">err</span>&nbsp;<span class="op" id="3431309">:=</span>&nbsp;<span class="ident" id="3431312">hs</span><span class="op" id="3431314">.</span><span class="ident" id="3431315">sendFinished</span><span class="op" id="3431327">(</span><span class="ident" id="3431328">c</span><span class="op" id="3431329">.</span><span class="ident" id="3431330">firstFinished</span><span class="op" id="3431343">[</span><span class="op" id="3431344">:</span><span class="op" id="3431345">]</span><span class="op" id="3431346">)</span><span class="op" id="3431347">;</span>&nbsp;<span class="ident" id="3431349">err</span>&nbsp;<span class="op" id="3431353">!=</span>&nbsp;<span class="ident" id="3431356">nil</span>&nbsp;<span class="op" id="3431360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431365">return</span>&nbsp;<span class="ident" id="3431372">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431382">if</span>&nbsp;<span class="ident" id="3431385">err</span>&nbsp;<span class="op" id="3431389">:=</span>&nbsp;<span class="ident" id="3431392">hs</span><span class="op" id="3431394">.</span><span class="ident" id="3431395">readFinished</span><span class="op" id="3431407">(</span><span class="ident" id="3431408">nil</span><span class="op" id="3431411">)</span><span class="op" id="3431412">;</span>&nbsp;<span class="ident" id="3431414">err</span>&nbsp;<span class="op" id="3431418">!=</span>&nbsp;<span class="ident" id="3431421">nil</span>&nbsp;<span class="op" id="3431425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431430">return</span>&nbsp;<span class="ident" id="3431437">err</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431447">c</span><span class="op" id="3431448">.</span><span class="ident" id="3431449">didResume</span>&nbsp;<span class="op" id="3431459">=</span>&nbsp;<span class="builtintype" id="3431461">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431467">}</span>&nbsp;<span class="keyword" id="3431469">else</span>&nbsp;<span class="op" id="3431474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3431478">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3431540">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431578">if</span>&nbsp;<span class="ident" id="3431581">err</span>&nbsp;<span class="op" id="3431585">:=</span>&nbsp;<span class="ident" id="3431588">hs</span><span class="op" id="3431590">.</span><span class="ident" id="3431591">doFullHandshake</span><span class="op" id="3431606">(</span><span class="op" id="3431607">)</span><span class="op" id="3431608">;</span>&nbsp;<span class="ident" id="3431610">err</span>&nbsp;<span class="op" id="3431614">!=</span>&nbsp;<span class="ident" id="3431617">nil</span>&nbsp;<span class="op" id="3431621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431626">return</span>&nbsp;<span class="ident" id="3431633">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431643">if</span>&nbsp;<span class="ident" id="3431646">err</span>&nbsp;<span class="op" id="3431650">:=</span>&nbsp;<span class="ident" id="3431653">hs</span><span class="op" id="3431655">.</span><span class="ident" id="3431656">establishKeys</span><span class="op" id="3431669">(</span><span class="op" id="3431670">)</span><span class="op" id="3431671">;</span>&nbsp;<span class="ident" id="3431673">err</span>&nbsp;<span class="op" id="3431677">!=</span>&nbsp;<span class="ident" id="3431680">nil</span>&nbsp;<span class="op" id="3431684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431689">return</span>&nbsp;<span class="ident" id="3431696">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431706">if</span>&nbsp;<span class="ident" id="3431709">err</span>&nbsp;<span class="op" id="3431713">:=</span>&nbsp;<span class="ident" id="3431716">hs</span><span class="op" id="3431718">.</span><span class="ident" id="3431719">readFinished</span><span class="op" id="3431731">(</span><span class="ident" id="3431732">c</span><span class="op" id="3431733">.</span><span class="ident" id="3431734">firstFinished</span><span class="op" id="3431747">[</span><span class="op" id="3431748">:</span><span class="op" id="3431749">]</span><span class="op" id="3431750">)</span><span class="op" id="3431751">;</span>&nbsp;<span class="ident" id="3431753">err</span>&nbsp;<span class="op" id="3431757">!=</span>&nbsp;<span class="ident" id="3431760">nil</span>&nbsp;<span class="op" id="3431764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431769">return</span>&nbsp;<span class="ident" id="3431776">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431786">if</span>&nbsp;<span class="ident" id="3431789">err</span>&nbsp;<span class="op" id="3431793">:=</span>&nbsp;<span class="ident" id="3431796">hs</span><span class="op" id="3431798">.</span><span class="ident" id="3431799">sendSessionTicket</span><span class="op" id="3431816">(</span><span class="op" id="3431817">)</span><span class="op" id="3431818">;</span>&nbsp;<span class="ident" id="3431820">err</span>&nbsp;<span class="op" id="3431824">!=</span>&nbsp;<span class="ident" id="3431827">nil</span>&nbsp;<span class="op" id="3431831">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431836">return</span>&nbsp;<span class="ident" id="3431843">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431853">if</span>&nbsp;<span class="ident" id="3431856">err</span>&nbsp;<span class="op" id="3431860">:=</span>&nbsp;<span class="ident" id="3431863">hs</span><span class="op" id="3431865">.</span><span class="ident" id="3431866">sendFinished</span><span class="op" id="3431878">(</span><span class="ident" id="3431879">nil</span><span class="op" id="3431882">)</span><span class="op" id="3431883">;</span>&nbsp;<span class="ident" id="3431885">err</span>&nbsp;<span class="op" id="3431889">!=</span>&nbsp;<span class="ident" id="3431892">nil</span>&nbsp;<span class="op" id="3431896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431901">return</span>&nbsp;<span class="ident" id="3431908">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431914">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431920">c</span><span class="op" id="3431921">.</span><span class="ident" id="3431922">handshakeComplete</span>&nbsp;<span class="op" id="3431940">=</span>&nbsp;<span class="builtintype" id="3431942">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431949">return</span>&nbsp;<span class="ident" id="3431956">nil</span><br>
<span class="lineno"></span><span class="op" id="3431960">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3431963">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="3432038">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="3432085">func</span>&nbsp;<span class="op" id="3432090">(</span><span class="ident" id="3432091">hs</span>&nbsp;<span class="op" id="3432094">*</span><span class="ident" id="3432095">serverHandshakeState</span><span class="op" id="3432115">)</span>&nbsp;<span class="ident" id="3432117">readClientHello</span><span class="op" id="3432132">(</span><span class="op" id="3432133">)</span>&nbsp;<span class="op" id="3432135">(</span><span class="ident" id="3432136">isResume</span>&nbsp;<span class="builtintype" id="3432145">bool</span><span class="op" id="3432149">,</span>&nbsp;<span class="ident" id="3432151">err</span>&nbsp;<span class="builtintype" id="3432155">error</span><span class="op" id="3432160">)</span>&nbsp;<span class="op" id="3432162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432165">config</span>&nbsp;<span class="op" id="3432172">:=</span>&nbsp;<span class="ident" id="3432175">hs</span><span class="op" id="3432177">.</span><span class="ident" id="3432178">c</span><span class="op" id="3432179">.</span><span class="ident" id="3432180">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432188">c</span>&nbsp;<span class="op" id="3432190">:=</span>&nbsp;<span class="ident" id="3432193">hs</span><span class="op" id="3432195">.</span><span class="ident" id="3432196">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432200">msg</span><span class="op" id="3432203">,</span>&nbsp;<span class="ident" id="3432205">err</span>&nbsp;<span class="op" id="3432209">:=</span>&nbsp;<span class="ident" id="3432212">c</span><span class="op" id="3432213">.</span><span class="ident" id="3432214">readHandshake</span><span class="op" id="3432227">(</span><span class="op" id="3432228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432231">if</span>&nbsp;<span class="ident" id="3432234">err</span>&nbsp;<span class="op" id="3432238">!=</span>&nbsp;<span class="ident" id="3432241">nil</span>&nbsp;<span class="op" id="3432245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432249">return</span>&nbsp;<span class="builtintype" id="3432256">false</span><span class="op" id="3432261">,</span>&nbsp;<span class="ident" id="3432263">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432271">var</span>&nbsp;<span class="ident" id="3432275">ok</span>&nbsp;<span class="builtintype" id="3432278">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432284">hs</span><span class="op" id="3432286">.</span><span class="ident" id="3432287">clientHello</span><span class="op" id="3432298">,</span>&nbsp;<span class="ident" id="3432300">ok</span>&nbsp;<span class="op" id="3432303">=</span>&nbsp;<span class="ident" id="3432305">msg</span><span class="op" id="3432308">.</span><span class="op" id="3432309">(</span><span class="op" id="3432310">*</span><span class="ident" id="3432311">clientHelloMsg</span><span class="op" id="3432325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432328">if</span>&nbsp;<span class="op" id="3432331">!</span><span class="ident" id="3432332">ok</span>&nbsp;<span class="op" id="3432335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432339">c</span><span class="op" id="3432340">.</span><span class="ident" id="3432341">sendAlert</span><span class="op" id="3432350">(</span><span class="ident" id="3432351">alertUnexpectedMessage</span><span class="op" id="3432373">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432377">return</span>&nbsp;<span class="builtintype" id="3432384">false</span><span class="op" id="3432389">,</span>&nbsp;<span class="ident" id="3432391">unexpectedMessageError</span><span class="op" id="3432413">(</span><span class="ident" id="3432414">hs</span><span class="op" id="3432416">.</span><span class="ident" id="3432417">clientHello</span><span class="op" id="3432428">,</span>&nbsp;<span class="ident" id="3432430">msg</span><span class="op" id="3432433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432439">c</span><span class="op" id="3432440">.</span><span class="ident" id="3432441">vers</span><span class="op" id="3432445">,</span>&nbsp;<span class="ident" id="3432447">ok</span>&nbsp;<span class="op" id="3432450">=</span>&nbsp;<span class="ident" id="3432452">config</span><span class="op" id="3432458">.</span><span class="ident" id="3432459">mutualVersion</span><span class="op" id="3432472">(</span><span class="ident" id="3432473">hs</span><span class="op" id="3432475">.</span><span class="ident" id="3432476">clientHello</span><span class="op" id="3432487">.</span><span class="ident" id="3432488">vers</span><span class="op" id="3432492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432495">if</span>&nbsp;<span class="op" id="3432498">!</span><span class="ident" id="3432499">ok</span>&nbsp;<span class="op" id="3432502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432506">c</span><span class="op" id="3432507">.</span><span class="ident" id="3432508">sendAlert</span><span class="op" id="3432517">(</span><span class="ident" id="3432518">alertProtocolVersion</span><span class="op" id="3432538">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432542">return</span>&nbsp;<span class="builtintype" id="3432549">false</span><span class="op" id="3432554">,</span>&nbsp;<span class="ident" id="3432556">fmt</span><span class="op" id="3432559">.</span><span class="ident" id="3432560">Errorf</span><span class="op" id="3432566">(</span><span class="string" id="3432567">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="3432635">,</span>&nbsp;<span class="ident" id="3432637">hs</span><span class="op" id="3432639">.</span><span class="ident" id="3432640">clientHello</span><span class="op" id="3432651">.</span><span class="ident" id="3432652">vers</span><span class="op" id="3432656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432662">c</span><span class="op" id="3432663">.</span><span class="ident" id="3432664">haveVers</span>&nbsp;<span class="op" id="3432673">=</span>&nbsp;<span class="builtintype" id="3432675">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432682">hs</span><span class="op" id="3432684">.</span><span class="ident" id="3432685">finishedHash</span>&nbsp;<span class="op" id="3432698">=</span>&nbsp;<span class="ident" id="3432700">newFinishedHash</span><span class="op" id="3432715">(</span><span class="ident" id="3432716">c</span><span class="op" id="3432717">.</span><span class="ident" id="3432718">vers</span><span class="op" id="3432722">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432725">hs</span><span class="op" id="3432727">.</span><span class="ident" id="3432728">finishedHash</span><span class="op" id="3432740">.</span><span class="ident" id="3432741">Write</span><span class="op" id="3432746">(</span><span class="ident" id="3432747">hs</span><span class="op" id="3432749">.</span><span class="ident" id="3432750">clientHello</span><span class="op" id="3432761">.</span><span class="ident" id="3432762">marshal</span><span class="op" id="3432769">(</span><span class="op" id="3432770">)</span><span class="op" id="3432771">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432775">hs</span><span class="op" id="3432777">.</span><span class="ident" id="3432778">hello</span>&nbsp;<span class="op" id="3432784">=</span>&nbsp;<span class="builtinfunc" id="3432786">new</span><span class="op" id="3432789">(</span><span class="ident" id="3432790">serverHelloMsg</span><span class="op" id="3432804">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432808">supportedCurve</span>&nbsp;<span class="op" id="3432823">:=</span>&nbsp;<span class="builtintype" id="3432826">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432833">preferredCurves</span>&nbsp;<span class="op" id="3432849">:=</span>&nbsp;<span class="ident" id="3432852">config</span><span class="op" id="3432858">.</span><span class="ident" id="3432859">curvePreferences</span><span class="op" id="3432875">(</span><span class="op" id="3432876">)</span><br>
<span class="lineno"></span><span class="ident" id="3432878">Curves</span><span class="op" id="3432884">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432887">for</span>&nbsp;<span class="ident" id="3432891">_</span><span class="op" id="3432892">,</span>&nbsp;<span class="ident" id="3432894">curve</span>&nbsp;<span class="op" id="3432900">:=</span>&nbsp;<span class="keyword" id="3432903">range</span>&nbsp;<span class="ident" id="3432909">hs</span><span class="op" id="3432911">.</span><span class="ident" id="3432912">clientHello</span><span class="op" id="3432923">.</span><span class="ident" id="3432924">supportedCurves</span>&nbsp;<span class="op" id="3432940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432944">for</span>&nbsp;<span class="ident" id="3432948">_</span><span class="op" id="3432949">,</span>&nbsp;<span class="ident" id="3432951">supported</span>&nbsp;<span class="op" id="3432961">:=</span>&nbsp;<span class="keyword" id="3432964">range</span>&nbsp;<span class="ident" id="3432970">preferredCurves</span>&nbsp;<span class="op" id="3432986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432991">if</span>&nbsp;<span class="ident" id="3432994">supported</span>&nbsp;<span class="op" id="3433004">==</span>&nbsp;<span class="ident" id="3433007">curve</span>&nbsp;<span class="op" id="3433013">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433019">supportedCurve</span>&nbsp;<span class="op" id="3433034">=</span>&nbsp;<span class="builtintype" id="3433036">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433045">break</span>&nbsp;<span class="ident" id="3433051">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433068">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433072">supportedPointFormat</span>&nbsp;<span class="op" id="3433093">:=</span>&nbsp;<span class="builtintype" id="3433096">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433103">for</span>&nbsp;<span class="ident" id="3433107">_</span><span class="op" id="3433108">,</span>&nbsp;<span class="ident" id="3433110">pointFormat</span>&nbsp;<span class="op" id="3433122">:=</span>&nbsp;<span class="keyword" id="3433125">range</span>&nbsp;<span class="ident" id="3433131">hs</span><span class="op" id="3433133">.</span><span class="ident" id="3433134">clientHello</span><span class="op" id="3433145">.</span><span class="ident" id="3433146">supportedPoints</span>&nbsp;<span class="op" id="3433162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433166">if</span>&nbsp;<span class="ident" id="3433169">pointFormat</span>&nbsp;<span class="op" id="3433181">==</span>&nbsp;<span class="ident" id="3433184">pointFormatUncompressed</span>&nbsp;<span class="op" id="3433208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433213">supportedPointFormat</span>&nbsp;<span class="op" id="3433234">=</span>&nbsp;<span class="builtintype" id="3433236">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433244">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433258">hs</span><span class="op" id="3433260">.</span><span class="ident" id="3433261">ellipticOk</span>&nbsp;<span class="op" id="3433272">=</span>&nbsp;<span class="ident" id="3433274">supportedCurve</span>&nbsp;<span class="op" id="3433289">&amp;&amp;</span>&nbsp;<span class="ident" id="3433292">supportedPointFormat</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433315">foundCompression</span>&nbsp;<span class="op" id="3433332">:=</span>&nbsp;<span class="builtintype" id="3433335">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433342">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433417">for</span>&nbsp;<span class="ident" id="3433421">_</span><span class="op" id="3433422">,</span>&nbsp;<span class="ident" id="3433424">compression</span>&nbsp;<span class="op" id="3433436">:=</span>&nbsp;<span class="keyword" id="3433439">range</span>&nbsp;<span class="ident" id="3433445">hs</span><span class="op" id="3433447">.</span><span class="ident" id="3433448">clientHello</span><span class="op" id="3433459">.</span><span class="ident" id="3433460">compressionMethods</span>&nbsp;<span class="op" id="3433479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433483">if</span>&nbsp;<span class="ident" id="3433486">compression</span>&nbsp;<span class="op" id="3433498">==</span>&nbsp;<span class="ident" id="3433501">compressionNone</span>&nbsp;<span class="op" id="3433517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433522">foundCompression</span>&nbsp;<span class="op" id="3433539">=</span>&nbsp;<span class="builtintype" id="3433541">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433549">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433564">if</span>&nbsp;<span class="op" id="3433567">!</span><span class="ident" id="3433568">foundCompression</span>&nbsp;<span class="op" id="3433585">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433589">c</span><span class="op" id="3433590">.</span><span class="ident" id="3433591">sendAlert</span><span class="op" id="3433600">(</span><span class="ident" id="3433601">alertHandshakeFailure</span><span class="op" id="3433622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433626">return</span>&nbsp;<span class="builtintype" id="3433633">false</span><span class="op" id="3433638">,</span>&nbsp;<span class="ident" id="3433640">errors</span><span class="op" id="3433646">.</span><span class="ident" id="3433647">New</span><span class="op" id="3433650">(</span><span class="string" id="3433651">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="3433706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433713">hs</span><span class="op" id="3433715">.</span><span class="ident" id="3433716">hello</span><span class="op" id="3433721">.</span><span class="ident" id="3433722">vers</span>&nbsp;<span class="op" id="3433727">=</span>&nbsp;<span class="ident" id="3433729">c</span><span class="op" id="3433730">.</span><span class="ident" id="3433731">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433737">hs</span><span class="op" id="3433739">.</span><span class="ident" id="3433740">hello</span><span class="op" id="3433745">.</span><span class="ident" id="3433746">random</span>&nbsp;<span class="op" id="3433753">=</span>&nbsp;<span class="builtinfunc" id="3433755">make</span><span class="op" id="3433759">(</span><span class="op" id="3433760">[</span><span class="op" id="3433761">]</span><span class="builtintype" id="3433762">byte</span><span class="op" id="3433766">,</span>&nbsp;<span class="num" id="3433768">32</span><span class="op" id="3433770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433773">_</span><span class="op" id="3433774">,</span>&nbsp;<span class="ident" id="3433776">err</span>&nbsp;<span class="op" id="3433780">=</span>&nbsp;<span class="ident" id="3433782">io</span><span class="op" id="3433784">.</span><span class="ident" id="3433785">ReadFull</span><span class="op" id="3433793">(</span><span class="ident" id="3433794">config</span><span class="op" id="3433800">.</span><span class="ident" id="3433801">rand</span><span class="op" id="3433805">(</span><span class="op" id="3433806">)</span><span class="op" id="3433807">,</span>&nbsp;<span class="ident" id="3433809">hs</span><span class="op" id="3433811">.</span><span class="ident" id="3433812">hello</span><span class="op" id="3433817">.</span><span class="ident" id="3433818">random</span><span class="op" id="3433824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433827">if</span>&nbsp;<span class="ident" id="3433830">err</span>&nbsp;<span class="op" id="3433834">!=</span>&nbsp;<span class="ident" id="3433837">nil</span>&nbsp;<span class="op" id="3433841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433845">c</span><span class="op" id="3433846">.</span><span class="ident" id="3433847">sendAlert</span><span class="op" id="3433856">(</span><span class="ident" id="3433857">alertInternalError</span><span class="op" id="3433875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433879">return</span>&nbsp;<span class="builtintype" id="3433886">false</span><span class="op" id="3433891">,</span>&nbsp;<span class="ident" id="3433893">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433901">hs</span><span class="op" id="3433903">.</span><span class="ident" id="3433904">hello</span><span class="op" id="3433909">.</span><span class="ident" id="3433910">secureRenegotiation</span>&nbsp;<span class="op" id="3433930">=</span>&nbsp;<span class="ident" id="3433932">hs</span><span class="op" id="3433934">.</span><span class="ident" id="3433935">clientHello</span><span class="op" id="3433946">.</span><span class="ident" id="3433947">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433968">hs</span><span class="op" id="3433970">.</span><span class="ident" id="3433971">hello</span><span class="op" id="3433976">.</span><span class="ident" id="3433977">compressionMethod</span>&nbsp;<span class="op" id="3433995">=</span>&nbsp;<span class="ident" id="3433997">compressionNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3434014">if</span>&nbsp;<span class="builtinfunc" id="3434017">len</span><span class="op" id="3434020">(</span><span class="ident" id="3434021">hs</span><span class="op" id="3434023">.</span><span class="ident" id="3434024">clientHello</span><span class="op" id="3434035">.</span><span class="ident" id="3434036">serverName</span><span class="op" id="3434046">)</span>&nbsp;<span class="op" id="3434048">&gt;</span>&nbsp;<span class="num" id="3434050">0</span>&nbsp;<span class="op" id="3434052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434056">c</span><span class="op" id="3434057">.</span><span class="ident" id="3434058">serverName</span>&nbsp;<span class="op" id="3434069">=</span>&nbsp;<span class="ident" id="3434071">hs</span><span class="op" id="3434073">.</span><span class="ident" id="3434074">clientHello</span><span class="op" id="3434085">.</span><span class="ident" id="3434086">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3434098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3434102">if</span>&nbsp;<span class="builtinfunc" id="3434105">len</span><span class="op" id="3434108">(</span><span class="ident" id="3434109">hs</span><span class="op" id="3434111">.</span><span class="ident" id="3434112">clientHello</span><span class="op" id="3434123">.</span><span class="ident" id="3434124">alpnProtocols</span><span class="op" id="3434137">)</span>&nbsp;<span class="op" id="3434139">&gt;</span>&nbsp;<span class="num" id="3434141">0</span>&nbsp;<span class="op" id="3434143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3434147">if</span>&nbsp;<span class="ident" id="3434150">selectedProto</span><span class="op" id="3434163">,</span>&nbsp;<span class="ident" id="3434165">fallback</span>&nbsp;<span class="op" id="3434174">:=</span>&nbsp;<span class="ident" id="3434177">mutualProtocol</span><span class="op" id="3434191">(</span><span class="ident" id="3434192">hs</span><span class="op" id="3434194">.</span><span class="ident" id="3434195">clientHello</span><span class="op" id="3434206">.</span><span class="ident" id="3434207">alpnProtocols</span><span class="op" id="3434220">,</span>&nbsp;<span class="ident" id="3434222">c</span><span class="op" id="3434223">.</span><span class="ident" id="3434224">config</span><span class="op" id="3434230">.</span><span class="ident" id="3434231">NextProtos</span><span class="op" id="3434241">)</span><span class="op" id="3434242">;</span>&nbsp;<span class="op" id="3434244">!</span><span class="ident" id="3434245">fallback</span>&nbsp;<span class="op" id="3434254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434259">hs</span><span class="op" id="3434261">.</span><span class="ident" id="3434262">hello</span><span class="op" id="3434267">.</span><span class="ident" id="3434268">alpnProtocol</span>&nbsp;<span class="op" id="3434281">=</span>&nbsp;<span class="ident" id="3434283">selectedProto</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434300">c</span><span class="op" id="3434301">.</span><span class="ident" id="3434302">clientProtocol</span>&nbsp;<span class="op" id="3434317">=</span>&nbsp;<span class="ident" id="3434319">selectedProto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3434335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3434338">}</span>&nbsp;<span class="keyword" id="3434340">else</span>&nbsp;<span class="op" id="3434345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434349">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434421">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434480">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3434517">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3434574">if</span>&nbsp;<span class="ident" id="3434577">hs</span><span class="op" id="3434579">.</span><span class="ident" id="3434580">clientHello</span><span class="op" id="3434591">.</span><span class="ident" id="3434592">nextProtoNeg</span>&nbsp;<span class="op" id="3434605">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3434608">len</span><span class="op" id="3434611">(</span><span class="ident" id="3434612">config</span><span class="op" id="3434618">.</span><span class="ident" id="3434619">NextProtos</span><span class="op" id="3434629">)</span>&nbsp;<span class="op" id="3434631">&gt;</span>&nbsp;<span class="num" id="3434633">0</span>&nbsp;<span class="op" id="3434635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434640">hs</span><span class="op" id="3434642">.</span><span class="ident" id="3434643">hello</span><span class="op" id="3434648">.</span><span class="ident" id="3434649">nextProtoNeg</span>&nbsp;<span class="op" id="3434662">=</span>&nbsp;<span class="builtintype" id="3434664">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434672">hs</span><span class="op" id="3434674">.</span><span class="ident" id="3434675">hello</span><span class="op" id="3434680">.</span><span class="ident" id="3434681">nextProtos</span>&nbsp;<span class="op" id="3434692">=</span>&nbsp;<span class="ident" id="3434694">config</span><span class="op" id="3434700">.</span><span class="ident" id="3434701">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3434714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3434717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3434721">if</span>&nbsp;<span class="builtinfunc" id="3434724">len</span><span class="op" id="3434727">(</span><span class="ident" id="3434728">config</span><span class="op" id="3434734">.</span><span class="ident" id="3434735">Certificates</span><span class="op" id="3434747">)</span>&nbsp;<span class="op" id="3434749">==</span>&nbsp;<span class="num" id="3434752">0</span>&nbsp;<span class="op" id="3434754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434758">c</span><span class="op" id="3434759">.</span><span class="ident" id="3434760">sendAlert</span><span class="op" id="3434769">(</span><span class="ident" id="3434770">alertInternalError</span><span class="op" id="3434788">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3434792">return</span>&nbsp;<span class="builtintype" id="3434799">false</span><span class="op" id="3434804">,</span>&nbsp;<span class="ident" id="3434806">errors</span><span class="op" id="3434812">.</span><span class="ident" id="3434813">New</span><span class="op" id="3434816">(</span><span class="string" id="3434817">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="3434850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3434853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434856">hs</span><span class="op" id="3434858">.</span><span class="ident" id="3434859">cert</span>&nbsp;<span class="op" id="3434864">=</span>&nbsp;<span class="op" id="3434866">&amp;</span><span class="ident" id="3434867">config</span><span class="op" id="3434873">.</span><span class="ident" id="3434874">Certificates</span><span class="op" id="3434886">[</span><span class="num" id="3434887">0</span><span class="op" id="3434888">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3434891">if</span>&nbsp;<span class="builtinfunc" id="3434894">len</span><span class="op" id="3434897">(</span><span class="ident" id="3434898">hs</span><span class="op" id="3434900">.</span><span class="ident" id="3434901">clientHello</span><span class="op" id="3434912">.</span><span class="ident" id="3434913">serverName</span><span class="op" id="3434923">)</span>&nbsp;<span class="op" id="3434925">&gt;</span>&nbsp;<span class="num" id="3434927">0</span>&nbsp;<span class="op" id="3434929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434933">chi</span>&nbsp;<span class="op" id="3434937">:=</span>&nbsp;<span class="op" id="3434940">&amp;</span><span class="ident" id="3434941">ClientHelloInfo</span><span class="op" id="3434956">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434961">CipherSuites</span><span class="op" id="3434973">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3434978">hs</span><span class="op" id="3434980">.</span><span class="ident" id="3434981">clientHello</span><span class="op" id="3434992">.</span><span class="ident" id="3434993">cipherSuites</span><span class="op" id="3435005">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435010">ServerName</span><span class="op" id="3435020">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3435027">hs</span><span class="op" id="3435029">.</span><span class="ident" id="3435030">clientHello</span><span class="op" id="3435041">.</span><span class="ident" id="3435042">serverName</span><span class="op" id="3435052">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435057">SupportedCurves</span><span class="op" id="3435072">:</span>&nbsp;<span class="ident" id="3435074">hs</span><span class="op" id="3435076">.</span><span class="ident" id="3435077">clientHello</span><span class="op" id="3435088">.</span><span class="ident" id="3435089">supportedCurves</span><span class="op" id="3435104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435109">SupportedPoints</span><span class="op" id="3435124">:</span>&nbsp;<span class="ident" id="3435126">hs</span><span class="op" id="3435128">.</span><span class="ident" id="3435129">clientHello</span><span class="op" id="3435140">.</span><span class="ident" id="3435141">supportedPoints</span><span class="op" id="3435156">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3435160">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435164">if</span>&nbsp;<span class="ident" id="3435167">hs</span><span class="op" id="3435169">.</span><span class="ident" id="3435170">cert</span><span class="op" id="3435174">,</span>&nbsp;<span class="ident" id="3435176">err</span>&nbsp;<span class="op" id="3435180">=</span>&nbsp;<span class="ident" id="3435182">config</span><span class="op" id="3435188">.</span><span class="ident" id="3435189">getCertificate</span><span class="op" id="3435203">(</span><span class="ident" id="3435204">chi</span><span class="op" id="3435207">)</span><span class="op" id="3435208">;</span>&nbsp;<span class="ident" id="3435210">err</span>&nbsp;<span class="op" id="3435214">!=</span>&nbsp;<span class="ident" id="3435217">nil</span>&nbsp;<span class="op" id="3435221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435226">c</span><span class="op" id="3435227">.</span><span class="ident" id="3435228">sendAlert</span><span class="op" id="3435237">(</span><span class="ident" id="3435238">alertInternalError</span><span class="op" id="3435256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435261">return</span>&nbsp;<span class="builtintype" id="3435268">false</span><span class="op" id="3435273">,</span>&nbsp;<span class="ident" id="3435275">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3435281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3435284">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435288">_</span><span class="op" id="3435289">,</span>&nbsp;<span class="ident" id="3435291">hs</span><span class="op" id="3435293">.</span><span class="ident" id="3435294">ecdsaOk</span>&nbsp;<span class="op" id="3435302">=</span>&nbsp;<span class="ident" id="3435304">hs</span><span class="op" id="3435306">.</span><span class="ident" id="3435307">cert</span><span class="op" id="3435311">.</span><span class="ident" id="3435312">PrivateKey</span><span class="op" id="3435322">.</span><span class="op" id="3435323">(</span><span class="op" id="3435324">*</span><span class="ident" id="3435325">ecdsa</span><span class="op" id="3435330">.</span><span class="ident" id="3435331">PrivateKey</span><span class="op" id="3435341">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435345">if</span>&nbsp;<span class="ident" id="3435348">hs</span><span class="op" id="3435350">.</span><span class="ident" id="3435351">checkForResumption</span><span class="op" id="3435369">(</span><span class="op" id="3435370">)</span>&nbsp;<span class="op" id="3435372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435376">return</span>&nbsp;<span class="builtintype" id="3435383">true</span><span class="op" id="3435387">,</span>&nbsp;<span class="ident" id="3435389">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3435394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435398">var</span>&nbsp;<span class="ident" id="3435402">preferenceList</span><span class="op" id="3435416">,</span>&nbsp;<span class="ident" id="3435418">supportedList</span>&nbsp;<span class="op" id="3435432">[</span><span class="op" id="3435433">]</span><span class="builtintype" id="3435434">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435442">if</span>&nbsp;<span class="ident" id="3435445">c</span><span class="op" id="3435446">.</span><span class="ident" id="3435447">config</span><span class="op" id="3435453">.</span><span class="ident" id="3435454">PreferServerCipherSuites</span>&nbsp;<span class="op" id="3435479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435483">preferenceList</span>&nbsp;<span class="op" id="3435498">=</span>&nbsp;<span class="ident" id="3435500">c</span><span class="op" id="3435501">.</span><span class="ident" id="3435502">config</span><span class="op" id="3435508">.</span><span class="ident" id="3435509">cipherSuites</span><span class="op" id="3435521">(</span><span class="op" id="3435522">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435526">supportedList</span>&nbsp;<span class="op" id="3435540">=</span>&nbsp;<span class="ident" id="3435542">hs</span><span class="op" id="3435544">.</span><span class="ident" id="3435545">clientHello</span><span class="op" id="3435556">.</span><span class="ident" id="3435557">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3435571">}</span>&nbsp;<span class="keyword" id="3435573">else</span>&nbsp;<span class="op" id="3435578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435582">preferenceList</span>&nbsp;<span class="op" id="3435597">=</span>&nbsp;<span class="ident" id="3435599">hs</span><span class="op" id="3435601">.</span><span class="ident" id="3435602">clientHello</span><span class="op" id="3435613">.</span><span class="ident" id="3435614">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435629">supportedList</span>&nbsp;<span class="op" id="3435643">=</span>&nbsp;<span class="ident" id="3435645">c</span><span class="op" id="3435646">.</span><span class="ident" id="3435647">config</span><span class="op" id="3435653">.</span><span class="ident" id="3435654">cipherSuites</span><span class="op" id="3435666">(</span><span class="op" id="3435667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3435670">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435674">for</span>&nbsp;<span class="ident" id="3435678">_</span><span class="op" id="3435679">,</span>&nbsp;<span class="ident" id="3435681">id</span>&nbsp;<span class="op" id="3435684">:=</span>&nbsp;<span class="keyword" id="3435687">range</span>&nbsp;<span class="ident" id="3435693">preferenceList</span>&nbsp;<span class="op" id="3435708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435712">if</span>&nbsp;<span class="ident" id="3435715">hs</span><span class="op" id="3435717">.</span><span class="ident" id="3435718">suite</span>&nbsp;<span class="op" id="3435724">=</span>&nbsp;<span class="ident" id="3435726">c</span><span class="op" id="3435727">.</span><span class="ident" id="3435728">tryCipherSuite</span><span class="op" id="3435742">(</span><span class="ident" id="3435743">id</span><span class="op" id="3435745">,</span>&nbsp;<span class="ident" id="3435747">supportedList</span><span class="op" id="3435760">,</span>&nbsp;<span class="ident" id="3435762">c</span><span class="op" id="3435763">.</span><span class="ident" id="3435764">vers</span><span class="op" id="3435768">,</span>&nbsp;<span class="ident" id="3435770">hs</span><span class="op" id="3435772">.</span><span class="ident" id="3435773">ellipticOk</span><span class="op" id="3435783">,</span>&nbsp;<span class="ident" id="3435785">hs</span><span class="op" id="3435787">.</span><span class="ident" id="3435788">ecdsaOk</span><span class="op" id="3435795">)</span><span class="op" id="3435796">;</span>&nbsp;<span class="ident" id="3435798">hs</span><span class="op" id="3435800">.</span><span class="ident" id="3435801">suite</span>&nbsp;<span class="op" id="3435807">!=</span>&nbsp;<span class="ident" id="3435810">nil</span>&nbsp;<span class="op" id="3435814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435819">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3435827">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3435830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435834">if</span>&nbsp;<span class="ident" id="3435837">hs</span><span class="op" id="3435839">.</span><span class="ident" id="3435840">suite</span>&nbsp;<span class="op" id="3435846">==</span>&nbsp;<span class="ident" id="3435849">nil</span>&nbsp;<span class="op" id="3435853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435857">c</span><span class="op" id="3435858">.</span><span class="ident" id="3435859">sendAlert</span><span class="op" id="3435868">(</span><span class="ident" id="3435869">alertHandshakeFailure</span><span class="op" id="3435890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3435894">return</span>&nbsp;<span class="builtintype" id="3435901">false</span><span class="op" id="3435906">,</span>&nbsp;<span class="ident" id="3435908">errors</span><span class="op" id="3435914">.</span><span class="ident" id="3435915">New</span><span class="op" id="3435918">(</span><span class="string" id="3435919">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="3435977">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3435980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435984">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436054">for</span>&nbsp;<span class="ident" id="3436058">_</span><span class="op" id="3436059">,</span>&nbsp;<span class="ident" id="3436061">id</span>&nbsp;<span class="op" id="3436064">:=</span>&nbsp;<span class="keyword" id="3436067">range</span>&nbsp;<span class="ident" id="3436073">hs</span><span class="op" id="3436075">.</span><span class="ident" id="3436076">clientHello</span><span class="op" id="3436087">.</span><span class="ident" id="3436088">cipherSuites</span>&nbsp;<span class="op" id="3436101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436105">if</span>&nbsp;<span class="ident" id="3436108">id</span>&nbsp;<span class="op" id="3436111">==</span>&nbsp;<span class="ident" id="3436114">TLS_FALLBACK_SCSV</span>&nbsp;<span class="op" id="3436132">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3436137">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436186">if</span>&nbsp;<span class="ident" id="3436189">hs</span><span class="op" id="3436191">.</span><span class="ident" id="3436192">clientHello</span><span class="op" id="3436203">.</span><span class="ident" id="3436204">vers</span>&nbsp;<span class="op" id="3436209">&lt;</span>&nbsp;<span class="ident" id="3436211">c</span><span class="op" id="3436212">.</span><span class="ident" id="3436213">config</span><span class="op" id="3436219">.</span><span class="ident" id="3436220">MaxVersion</span>&nbsp;<span class="op" id="3436231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3436237">c</span><span class="op" id="3436238">.</span><span class="ident" id="3436239">sendAlert</span><span class="op" id="3436248">(</span><span class="ident" id="3436249">alertInappropriateFallback</span><span class="op" id="3436275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436281">return</span>&nbsp;<span class="builtintype" id="3436288">false</span><span class="op" id="3436293">,</span>&nbsp;<span class="ident" id="3436295">errors</span><span class="op" id="3436301">.</span><span class="ident" id="3436302">New</span><span class="op" id="3436305">(</span><span class="string" id="3436306">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="3436356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3436361">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436366">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3436374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3436377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436381">return</span>&nbsp;<span class="builtintype" id="3436388">false</span><span class="op" id="3436393">,</span>&nbsp;<span class="ident" id="3436395">nil</span><br>
<span class="lineno">240</span><span class="op" id="3436399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3436402">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3436489">func</span>&nbsp;<span class="op" id="3436494">(</span><span class="ident" id="3436495">hs</span>&nbsp;<span class="op" id="3436498">*</span><span class="ident" id="3436499">serverHandshakeState</span><span class="op" id="3436519">)</span>&nbsp;<span class="ident" id="3436521">checkForResumption</span><span class="op" id="3436539">(</span><span class="op" id="3436540">)</span>&nbsp;<span class="builtintype" id="3436542">bool</span>&nbsp;<span class="op" id="3436547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3436550">c</span>&nbsp;<span class="op" id="3436552">:=</span>&nbsp;<span class="ident" id="3436555">hs</span><span class="op" id="3436557">.</span><span class="ident" id="3436558">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436562">if</span>&nbsp;<span class="ident" id="3436565">c</span><span class="op" id="3436566">.</span><span class="ident" id="3436567">config</span><span class="op" id="3436573">.</span><span class="ident" id="3436574">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3436597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436601">return</span>&nbsp;<span class="builtintype" id="3436608">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3436615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436619">var</span>&nbsp;<span class="ident" id="3436623">ok</span>&nbsp;<span class="builtintype" id="3436626">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436632">if</span>&nbsp;<span class="ident" id="3436635">hs</span><span class="op" id="3436637">.</span><span class="ident" id="3436638">sessionState</span><span class="op" id="3436650">,</span>&nbsp;<span class="ident" id="3436652">ok</span>&nbsp;<span class="op" id="3436655">=</span>&nbsp;<span class="ident" id="3436657">c</span><span class="op" id="3436658">.</span><span class="ident" id="3436659">decryptTicket</span><span class="op" id="3436672">(</span><span class="ident" id="3436673">hs</span><span class="op" id="3436675">.</span><span class="ident" id="3436676">clientHello</span><span class="op" id="3436687">.</span><span class="ident" id="3436688">sessionTicket</span><span class="op" id="3436701">)</span><span class="op" id="3436702">;</span>&nbsp;<span class="op" id="3436704">!</span><span class="ident" id="3436705">ok</span>&nbsp;<span class="op" id="3436708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436712">return</span>&nbsp;<span class="builtintype" id="3436719">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3436726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436730">if</span>&nbsp;<span class="ident" id="3436733">hs</span><span class="op" id="3436735">.</span><span class="ident" id="3436736">sessionState</span><span class="op" id="3436748">.</span><span class="ident" id="3436749">vers</span>&nbsp;<span class="op" id="3436754">&gt;</span>&nbsp;<span class="ident" id="3436756">hs</span><span class="op" id="3436758">.</span><span class="ident" id="3436759">clientHello</span><span class="op" id="3436770">.</span><span class="ident" id="3436771">vers</span>&nbsp;<span class="op" id="3436776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436780">return</span>&nbsp;<span class="builtintype" id="3436787">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3436794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436797">if</span>&nbsp;<span class="ident" id="3436800">vers</span><span class="op" id="3436804">,</span>&nbsp;<span class="ident" id="3436806">ok</span>&nbsp;<span class="op" id="3436809">:=</span>&nbsp;<span class="ident" id="3436812">c</span><span class="op" id="3436813">.</span><span class="ident" id="3436814">config</span><span class="op" id="3436820">.</span><span class="ident" id="3436821">mutualVersion</span><span class="op" id="3436834">(</span><span class="ident" id="3436835">hs</span><span class="op" id="3436837">.</span><span class="ident" id="3436838">sessionState</span><span class="op" id="3436850">.</span><span class="ident" id="3436851">vers</span><span class="op" id="3436855">)</span><span class="op" id="3436856">;</span>&nbsp;<span class="op" id="3436858">!</span><span class="ident" id="3436859">ok</span>&nbsp;<span class="op" id="3436862">||</span>&nbsp;<span class="ident" id="3436865">vers</span>&nbsp;<span class="op" id="3436870">!=</span>&nbsp;<span class="ident" id="3436873">hs</span><span class="op" id="3436875">.</span><span class="ident" id="3436876">sessionState</span><span class="op" id="3436888">.</span><span class="ident" id="3436889">vers</span>&nbsp;<span class="op" id="3436894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3436898">return</span>&nbsp;<span class="builtintype" id="3436905">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3436912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3436916">cipherSuiteOk</span>&nbsp;<span class="op" id="3436930">:=</span>&nbsp;<span class="builtintype" id="3436933">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3436940">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437016">for</span>&nbsp;<span class="ident" id="3437020">_</span><span class="op" id="3437021">,</span>&nbsp;<span class="ident" id="3437023">id</span>&nbsp;<span class="op" id="3437026">:=</span>&nbsp;<span class="keyword" id="3437029">range</span>&nbsp;<span class="ident" id="3437035">hs</span><span class="op" id="3437037">.</span><span class="ident" id="3437038">clientHello</span><span class="op" id="3437049">.</span><span class="ident" id="3437050">cipherSuites</span>&nbsp;<span class="op" id="3437063">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437067">if</span>&nbsp;<span class="ident" id="3437070">id</span>&nbsp;<span class="op" id="3437073">==</span>&nbsp;<span class="ident" id="3437076">hs</span><span class="op" id="3437078">.</span><span class="ident" id="3437079">sessionState</span><span class="op" id="3437091">.</span><span class="ident" id="3437092">cipherSuite</span>&nbsp;<span class="op" id="3437104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437109">cipherSuiteOk</span>&nbsp;<span class="op" id="3437123">=</span>&nbsp;<span class="builtintype" id="3437125">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437133">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3437141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3437144">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437147">if</span>&nbsp;<span class="op" id="3437150">!</span><span class="ident" id="3437151">cipherSuiteOk</span>&nbsp;<span class="op" id="3437165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437169">return</span>&nbsp;<span class="builtintype" id="3437176">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3437183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437187">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437252">hs</span><span class="op" id="3437254">.</span><span class="ident" id="3437255">suite</span>&nbsp;<span class="op" id="3437261">=</span>&nbsp;<span class="ident" id="3437263">c</span><span class="op" id="3437264">.</span><span class="ident" id="3437265">tryCipherSuite</span><span class="op" id="3437279">(</span><span class="ident" id="3437280">hs</span><span class="op" id="3437282">.</span><span class="ident" id="3437283">sessionState</span><span class="op" id="3437295">.</span><span class="ident" id="3437296">cipherSuite</span><span class="op" id="3437307">,</span>&nbsp;<span class="ident" id="3437309">c</span><span class="op" id="3437310">.</span><span class="ident" id="3437311">config</span><span class="op" id="3437317">.</span><span class="ident" id="3437318">cipherSuites</span><span class="op" id="3437330">(</span><span class="op" id="3437331">)</span><span class="op" id="3437332">,</span>&nbsp;<span class="ident" id="3437334">hs</span><span class="op" id="3437336">.</span><span class="ident" id="3437337">sessionState</span><span class="op" id="3437349">.</span><span class="ident" id="3437350">vers</span><span class="op" id="3437354">,</span>&nbsp;<span class="ident" id="3437356">hs</span><span class="op" id="3437358">.</span><span class="ident" id="3437359">ellipticOk</span><span class="op" id="3437369">,</span>&nbsp;<span class="ident" id="3437371">hs</span><span class="op" id="3437373">.</span><span class="ident" id="3437374">ecdsaOk</span><span class="op" id="3437381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437384">if</span>&nbsp;<span class="ident" id="3437387">hs</span><span class="op" id="3437389">.</span><span class="ident" id="3437390">suite</span>&nbsp;<span class="op" id="3437396">==</span>&nbsp;<span class="ident" id="3437399">nil</span>&nbsp;<span class="op" id="3437403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437407">return</span>&nbsp;<span class="builtintype" id="3437414">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3437421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437425">sessionHasClientCerts</span>&nbsp;<span class="op" id="3437447">:=</span>&nbsp;<span class="builtinfunc" id="3437450">len</span><span class="op" id="3437453">(</span><span class="ident" id="3437454">hs</span><span class="op" id="3437456">.</span><span class="ident" id="3437457">sessionState</span><span class="op" id="3437469">.</span><span class="ident" id="3437470">certificates</span><span class="op" id="3437482">)</span>&nbsp;<span class="op" id="3437484">!=</span>&nbsp;<span class="num" id="3437487">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437490">needClientCerts</span>&nbsp;<span class="op" id="3437506">:=</span>&nbsp;<span class="ident" id="3437509">c</span><span class="op" id="3437510">.</span><span class="ident" id="3437511">config</span><span class="op" id="3437517">.</span><span class="ident" id="3437518">ClientAuth</span>&nbsp;<span class="op" id="3437529">==</span>&nbsp;<span class="ident" id="3437532">RequireAnyClientCert</span>&nbsp;<span class="op" id="3437553">||</span>&nbsp;<span class="ident" id="3437556">c</span><span class="op" id="3437557">.</span><span class="ident" id="3437558">config</span><span class="op" id="3437564">.</span><span class="ident" id="3437565">ClientAuth</span>&nbsp;<span class="op" id="3437576">==</span>&nbsp;<span class="ident" id="3437579">RequireAndVerifyClientCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437607">if</span>&nbsp;<span class="ident" id="3437610">needClientCerts</span>&nbsp;<span class="op" id="3437626">&amp;&amp;</span>&nbsp;<span class="op" id="3437629">!</span><span class="ident" id="3437630">sessionHasClientCerts</span>&nbsp;<span class="op" id="3437652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437656">return</span>&nbsp;<span class="builtintype" id="3437663">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3437670">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437673">if</span>&nbsp;<span class="ident" id="3437676">sessionHasClientCerts</span>&nbsp;<span class="op" id="3437698">&amp;&amp;</span>&nbsp;<span class="ident" id="3437701">c</span><span class="op" id="3437702">.</span><span class="ident" id="3437703">config</span><span class="op" id="3437709">.</span><span class="ident" id="3437710">ClientAuth</span>&nbsp;<span class="op" id="3437721">==</span>&nbsp;<span class="ident" id="3437724">NoClientCert</span>&nbsp;<span class="op" id="3437737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437741">return</span>&nbsp;<span class="builtintype" id="3437748">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3437755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3437759">return</span>&nbsp;<span class="builtintype" id="3437766">true</span><br>
<span class="lineno">290</span><span class="op" id="3437771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3437774">func</span>&nbsp;<span class="op" id="3437779">(</span><span class="ident" id="3437780">hs</span>&nbsp;<span class="op" id="3437783">*</span><span class="ident" id="3437784">serverHandshakeState</span><span class="op" id="3437804">)</span>&nbsp;<span class="ident" id="3437806">doResumeHandshake</span><span class="op" id="3437823">(</span><span class="op" id="3437824">)</span>&nbsp;<span class="builtintype" id="3437826">error</span>&nbsp;<span class="op" id="3437832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437835">c</span>&nbsp;<span class="op" id="3437837">:=</span>&nbsp;<span class="ident" id="3437840">hs</span><span class="op" id="3437842">.</span><span class="ident" id="3437843">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437847">hs</span><span class="op" id="3437849">.</span><span class="ident" id="3437850">hello</span><span class="op" id="3437855">.</span><span class="ident" id="3437856">cipherSuite</span>&nbsp;<span class="op" id="3437868">=</span>&nbsp;<span class="ident" id="3437870">hs</span><span class="op" id="3437872">.</span><span class="ident" id="3437873">suite</span><span class="op" id="3437878">.</span><span class="ident" id="3437879">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437883">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437953">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437988">hs</span><span class="op" id="3437990">.</span><span class="ident" id="3437991">hello</span><span class="op" id="3437996">.</span><span class="ident" id="3437997">sessionId</span>&nbsp;<span class="op" id="3438007">=</span>&nbsp;<span class="ident" id="3438009">hs</span><span class="op" id="3438011">.</span><span class="ident" id="3438012">clientHello</span><span class="op" id="3438023">.</span><span class="ident" id="3438024">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438035">hs</span><span class="op" id="3438037">.</span><span class="ident" id="3438038">finishedHash</span><span class="op" id="3438050">.</span><span class="ident" id="3438051">Write</span><span class="op" id="3438056">(</span><span class="ident" id="3438057">hs</span><span class="op" id="3438059">.</span><span class="ident" id="3438060">hello</span><span class="op" id="3438065">.</span><span class="ident" id="3438066">marshal</span><span class="op" id="3438073">(</span><span class="op" id="3438074">)</span><span class="op" id="3438075">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438078">c</span><span class="op" id="3438079">.</span><span class="ident" id="3438080">writeRecord</span><span class="op" id="3438091">(</span><span class="ident" id="3438092">recordTypeHandshake</span><span class="op" id="3438111">,</span>&nbsp;<span class="ident" id="3438113">hs</span><span class="op" id="3438115">.</span><span class="ident" id="3438116">hello</span><span class="op" id="3438121">.</span><span class="ident" id="3438122">marshal</span><span class="op" id="3438129">(</span><span class="op" id="3438130">)</span><span class="op" id="3438131">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438135">if</span>&nbsp;<span class="builtinfunc" id="3438138">len</span><span class="op" id="3438141">(</span><span class="ident" id="3438142">hs</span><span class="op" id="3438144">.</span><span class="ident" id="3438145">sessionState</span><span class="op" id="3438157">.</span><span class="ident" id="3438158">certificates</span><span class="op" id="3438170">)</span>&nbsp;<span class="op" id="3438172">&gt;</span>&nbsp;<span class="num" id="3438174">0</span>&nbsp;<span class="op" id="3438176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438180">if</span>&nbsp;<span class="ident" id="3438183">_</span><span class="op" id="3438184">,</span>&nbsp;<span class="ident" id="3438186">err</span>&nbsp;<span class="op" id="3438190">:=</span>&nbsp;<span class="ident" id="3438193">hs</span><span class="op" id="3438195">.</span><span class="ident" id="3438196">processCertsFromClient</span><span class="op" id="3438218">(</span><span class="ident" id="3438219">hs</span><span class="op" id="3438221">.</span><span class="ident" id="3438222">sessionState</span><span class="op" id="3438234">.</span><span class="ident" id="3438235">certificates</span><span class="op" id="3438247">)</span><span class="op" id="3438248">;</span>&nbsp;<span class="ident" id="3438250">err</span>&nbsp;<span class="op" id="3438254">!=</span>&nbsp;<span class="ident" id="3438257">nil</span>&nbsp;<span class="op" id="3438261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438266">return</span>&nbsp;<span class="ident" id="3438273">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3438279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3438282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438286">hs</span><span class="op" id="3438288">.</span><span class="ident" id="3438289">masterSecret</span>&nbsp;<span class="op" id="3438302">=</span>&nbsp;<span class="ident" id="3438304">hs</span><span class="op" id="3438306">.</span><span class="ident" id="3438307">sessionState</span><span class="op" id="3438319">.</span><span class="ident" id="3438320">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438335">return</span>&nbsp;<span class="ident" id="3438342">nil</span><br>
<span class="lineno"></span><span class="op" id="3438346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3438349">func</span>&nbsp;<span class="op" id="3438354">(</span><span class="ident" id="3438355">hs</span>&nbsp;<span class="op" id="3438358">*</span><span class="ident" id="3438359">serverHandshakeState</span><span class="op" id="3438379">)</span>&nbsp;<span class="ident" id="3438381">doFullHandshake</span><span class="op" id="3438396">(</span><span class="op" id="3438397">)</span>&nbsp;<span class="builtintype" id="3438399">error</span>&nbsp;<span class="op" id="3438405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438408">config</span>&nbsp;<span class="op" id="3438415">:=</span>&nbsp;<span class="ident" id="3438418">hs</span><span class="op" id="3438420">.</span><span class="ident" id="3438421">c</span><span class="op" id="3438422">.</span><span class="ident" id="3438423">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438431">c</span>&nbsp;<span class="op" id="3438433">:=</span>&nbsp;<span class="ident" id="3438436">hs</span><span class="op" id="3438438">.</span><span class="ident" id="3438439">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438443">if</span>&nbsp;<span class="ident" id="3438446">hs</span><span class="op" id="3438448">.</span><span class="ident" id="3438449">clientHello</span><span class="op" id="3438460">.</span><span class="ident" id="3438461">ocspStapling</span>&nbsp;<span class="op" id="3438474">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3438477">len</span><span class="op" id="3438480">(</span><span class="ident" id="3438481">hs</span><span class="op" id="3438483">.</span><span class="ident" id="3438484">cert</span><span class="op" id="3438488">.</span><span class="ident" id="3438489">OCSPStaple</span><span class="op" id="3438499">)</span>&nbsp;<span class="op" id="3438501">&gt;</span>&nbsp;<span class="num" id="3438503">0</span>&nbsp;<span class="op" id="3438505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438509">hs</span><span class="op" id="3438511">.</span><span class="ident" id="3438512">hello</span><span class="op" id="3438517">.</span><span class="ident" id="3438518">ocspStapling</span>&nbsp;<span class="op" id="3438531">=</span>&nbsp;<span class="builtintype" id="3438533">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3438539">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438543">hs</span><span class="op" id="3438545">.</span><span class="ident" id="3438546">hello</span><span class="op" id="3438551">.</span><span class="ident" id="3438552">ticketSupported</span>&nbsp;<span class="op" id="3438568">=</span>&nbsp;<span class="ident" id="3438570">hs</span><span class="op" id="3438572">.</span><span class="ident" id="3438573">clientHello</span><span class="op" id="3438584">.</span><span class="ident" id="3438585">ticketSupported</span>&nbsp;<span class="op" id="3438601">&amp;&amp;</span>&nbsp;<span class="op" id="3438604">!</span><span class="ident" id="3438605">config</span><span class="op" id="3438611">.</span><span class="ident" id="3438612">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438636">hs</span><span class="op" id="3438638">.</span><span class="ident" id="3438639">hello</span><span class="op" id="3438644">.</span><span class="ident" id="3438645">cipherSuite</span>&nbsp;<span class="op" id="3438657">=</span>&nbsp;<span class="ident" id="3438659">hs</span><span class="op" id="3438661">.</span><span class="ident" id="3438662">suite</span><span class="op" id="3438667">.</span><span class="ident" id="3438668">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438672">hs</span><span class="op" id="3438674">.</span><span class="ident" id="3438675">finishedHash</span><span class="op" id="3438687">.</span><span class="ident" id="3438688">Write</span><span class="op" id="3438693">(</span><span class="ident" id="3438694">hs</span><span class="op" id="3438696">.</span><span class="ident" id="3438697">hello</span><span class="op" id="3438702">.</span><span class="ident" id="3438703">marshal</span><span class="op" id="3438710">(</span><span class="op" id="3438711">)</span><span class="op" id="3438712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438715">c</span><span class="op" id="3438716">.</span><span class="ident" id="3438717">writeRecord</span><span class="op" id="3438728">(</span><span class="ident" id="3438729">recordTypeHandshake</span><span class="op" id="3438748">,</span>&nbsp;<span class="ident" id="3438750">hs</span><span class="op" id="3438752">.</span><span class="ident" id="3438753">hello</span><span class="op" id="3438758">.</span><span class="ident" id="3438759">marshal</span><span class="op" id="3438766">(</span><span class="op" id="3438767">)</span><span class="op" id="3438768">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438772">certMsg</span>&nbsp;<span class="op" id="3438780">:=</span>&nbsp;<span class="builtinfunc" id="3438783">new</span><span class="op" id="3438786">(</span><span class="ident" id="3438787">certificateMsg</span><span class="op" id="3438801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438804">certMsg</span><span class="op" id="3438811">.</span><span class="ident" id="3438812">certificates</span>&nbsp;<span class="op" id="3438825">=</span>&nbsp;<span class="ident" id="3438827">hs</span><span class="op" id="3438829">.</span><span class="ident" id="3438830">cert</span><span class="op" id="3438834">.</span><span class="ident" id="3438835">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438848">hs</span><span class="op" id="3438850">.</span><span class="ident" id="3438851">finishedHash</span><span class="op" id="3438863">.</span><span class="ident" id="3438864">Write</span><span class="op" id="3438869">(</span><span class="ident" id="3438870">certMsg</span><span class="op" id="3438877">.</span><span class="ident" id="3438878">marshal</span><span class="op" id="3438885">(</span><span class="op" id="3438886">)</span><span class="op" id="3438887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438890">c</span><span class="op" id="3438891">.</span><span class="ident" id="3438892">writeRecord</span><span class="op" id="3438903">(</span><span class="ident" id="3438904">recordTypeHandshake</span><span class="op" id="3438923">,</span>&nbsp;<span class="ident" id="3438925">certMsg</span><span class="op" id="3438932">.</span><span class="ident" id="3438933">marshal</span><span class="op" id="3438940">(</span><span class="op" id="3438941">)</span><span class="op" id="3438942">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438946">if</span>&nbsp;<span class="ident" id="3438949">hs</span><span class="op" id="3438951">.</span><span class="ident" id="3438952">hello</span><span class="op" id="3438957">.</span><span class="ident" id="3438958">ocspStapling</span>&nbsp;<span class="op" id="3438971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438975">certStatus</span>&nbsp;<span class="op" id="3438986">:=</span>&nbsp;<span class="builtinfunc" id="3438989">new</span><span class="op" id="3438992">(</span><span class="ident" id="3438993">certificateStatusMsg</span><span class="op" id="3439013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439017">certStatus</span><span class="op" id="3439027">.</span><span class="ident" id="3439028">statusType</span>&nbsp;<span class="op" id="3439039">=</span>&nbsp;<span class="ident" id="3439041">statusTypeOCSP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439058">certStatus</span><span class="op" id="3439068">.</span><span class="ident" id="3439069">response</span>&nbsp;<span class="op" id="3439078">=</span>&nbsp;<span class="ident" id="3439080">hs</span><span class="op" id="3439082">.</span><span class="ident" id="3439083">cert</span><span class="op" id="3439087">.</span><span class="ident" id="3439088">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439101">hs</span><span class="op" id="3439103">.</span><span class="ident" id="3439104">finishedHash</span><span class="op" id="3439116">.</span><span class="ident" id="3439117">Write</span><span class="op" id="3439122">(</span><span class="ident" id="3439123">certStatus</span><span class="op" id="3439133">.</span><span class="ident" id="3439134">marshal</span><span class="op" id="3439141">(</span><span class="op" id="3439142">)</span><span class="op" id="3439143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439147">c</span><span class="op" id="3439148">.</span><span class="ident" id="3439149">writeRecord</span><span class="op" id="3439160">(</span><span class="ident" id="3439161">recordTypeHandshake</span><span class="op" id="3439180">,</span>&nbsp;<span class="ident" id="3439182">certStatus</span><span class="op" id="3439192">.</span><span class="ident" id="3439193">marshal</span><span class="op" id="3439200">(</span><span class="op" id="3439201">)</span><span class="op" id="3439202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439209">keyAgreement</span>&nbsp;<span class="op" id="3439222">:=</span>&nbsp;<span class="ident" id="3439225">hs</span><span class="op" id="3439227">.</span><span class="ident" id="3439228">suite</span><span class="op" id="3439233">.</span><span class="ident" id="3439234">ka</span><span class="op" id="3439236">(</span><span class="ident" id="3439237">c</span><span class="op" id="3439238">.</span><span class="ident" id="3439239">vers</span><span class="op" id="3439243">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439246">skx</span><span class="op" id="3439249">,</span>&nbsp;<span class="ident" id="3439251">err</span>&nbsp;<span class="op" id="3439255">:=</span>&nbsp;<span class="ident" id="3439258">keyAgreement</span><span class="op" id="3439270">.</span><span class="ident" id="3439271">generateServerKeyExchange</span><span class="op" id="3439296">(</span><span class="ident" id="3439297">config</span><span class="op" id="3439303">,</span>&nbsp;<span class="ident" id="3439305">hs</span><span class="op" id="3439307">.</span><span class="ident" id="3439308">cert</span><span class="op" id="3439312">,</span>&nbsp;<span class="ident" id="3439314">hs</span><span class="op" id="3439316">.</span><span class="ident" id="3439317">clientHello</span><span class="op" id="3439328">,</span>&nbsp;<span class="ident" id="3439330">hs</span><span class="op" id="3439332">.</span><span class="ident" id="3439333">hello</span><span class="op" id="3439338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439341">if</span>&nbsp;<span class="ident" id="3439344">err</span>&nbsp;<span class="op" id="3439348">!=</span>&nbsp;<span class="ident" id="3439351">nil</span>&nbsp;<span class="op" id="3439355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439359">c</span><span class="op" id="3439360">.</span><span class="ident" id="3439361">sendAlert</span><span class="op" id="3439370">(</span><span class="ident" id="3439371">alertHandshakeFailure</span><span class="op" id="3439392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439396">return</span>&nbsp;<span class="ident" id="3439403">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439408">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439411">if</span>&nbsp;<span class="ident" id="3439414">skx</span>&nbsp;<span class="op" id="3439418">!=</span>&nbsp;<span class="ident" id="3439421">nil</span>&nbsp;<span class="op" id="3439425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439429">hs</span><span class="op" id="3439431">.</span><span class="ident" id="3439432">finishedHash</span><span class="op" id="3439444">.</span><span class="ident" id="3439445">Write</span><span class="op" id="3439450">(</span><span class="ident" id="3439451">skx</span><span class="op" id="3439454">.</span><span class="ident" id="3439455">marshal</span><span class="op" id="3439462">(</span><span class="op" id="3439463">)</span><span class="op" id="3439464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439468">c</span><span class="op" id="3439469">.</span><span class="ident" id="3439470">writeRecord</span><span class="op" id="3439481">(</span><span class="ident" id="3439482">recordTypeHandshake</span><span class="op" id="3439501">,</span>&nbsp;<span class="ident" id="3439503">skx</span><span class="op" id="3439506">.</span><span class="ident" id="3439507">marshal</span><span class="op" id="3439514">(</span><span class="op" id="3439515">)</span><span class="op" id="3439516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439523">if</span>&nbsp;<span class="ident" id="3439526">config</span><span class="op" id="3439532">.</span><span class="ident" id="3439533">ClientAuth</span>&nbsp;<span class="op" id="3439544">&gt;=</span>&nbsp;<span class="ident" id="3439547">RequestClientCert</span>&nbsp;<span class="op" id="3439565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3439569">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439603">certReq</span>&nbsp;<span class="op" id="3439611">:=</span>&nbsp;<span class="builtinfunc" id="3439614">new</span><span class="op" id="3439617">(</span><span class="ident" id="3439618">certificateRequestMsg</span><span class="op" id="3439639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439643">certReq</span><span class="op" id="3439650">.</span><span class="ident" id="3439651">certificateTypes</span>&nbsp;<span class="op" id="3439668">=</span>&nbsp;<span class="op" id="3439670">[</span><span class="op" id="3439671">]</span><span class="builtintype" id="3439672">byte</span><span class="op" id="3439676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3439681">byte</span><span class="op" id="3439685">(</span><span class="ident" id="3439686">certTypeRSASign</span><span class="op" id="3439701">)</span><span class="op" id="3439702">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3439707">byte</span><span class="op" id="3439711">(</span><span class="ident" id="3439712">certTypeECDSASign</span><span class="op" id="3439729">)</span><span class="op" id="3439730">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439738">if</span>&nbsp;<span class="ident" id="3439741">c</span><span class="op" id="3439742">.</span><span class="ident" id="3439743">vers</span>&nbsp;<span class="op" id="3439748">&gt;=</span>&nbsp;<span class="ident" id="3439751">VersionTLS12</span>&nbsp;<span class="op" id="3439764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439769">certReq</span><span class="op" id="3439776">.</span><span class="ident" id="3439777">hasSignatureAndHash</span>&nbsp;<span class="op" id="3439797">=</span>&nbsp;<span class="builtintype" id="3439799">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439807">certReq</span><span class="op" id="3439814">.</span><span class="ident" id="3439815">signatureAndHashes</span>&nbsp;<span class="op" id="3439834">=</span>&nbsp;<span class="ident" id="3439836">supportedClientCertSignatureAlgorithms</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3439882">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3439938">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3439999">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3440056">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3440114">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3440161">if</span>&nbsp;<span class="ident" id="3440164">config</span><span class="op" id="3440170">.</span><span class="ident" id="3440171">ClientCAs</span>&nbsp;<span class="op" id="3440181">!=</span>&nbsp;<span class="ident" id="3440184">nil</span>&nbsp;<span class="op" id="3440188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440193">certReq</span><span class="op" id="3440200">.</span><span class="ident" id="3440201">certificateAuthorities</span>&nbsp;<span class="op" id="3440224">=</span>&nbsp;<span class="ident" id="3440226">config</span><span class="op" id="3440232">.</span><span class="ident" id="3440233">ClientCAs</span><span class="op" id="3440242">.</span><span class="ident" id="3440243">Subjects</span><span class="op" id="3440251">(</span><span class="op" id="3440252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3440256">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440260">hs</span><span class="op" id="3440262">.</span><span class="ident" id="3440263">finishedHash</span><span class="op" id="3440275">.</span><span class="ident" id="3440276">Write</span><span class="op" id="3440281">(</span><span class="ident" id="3440282">certReq</span><span class="op" id="3440289">.</span><span class="ident" id="3440290">marshal</span><span class="op" id="3440297">(</span><span class="op" id="3440298">)</span><span class="op" id="3440299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440303">c</span><span class="op" id="3440304">.</span><span class="ident" id="3440305">writeRecord</span><span class="op" id="3440316">(</span><span class="ident" id="3440317">recordTypeHandshake</span><span class="op" id="3440336">,</span>&nbsp;<span class="ident" id="3440338">certReq</span><span class="op" id="3440345">.</span><span class="ident" id="3440346">marshal</span><span class="op" id="3440353">(</span><span class="op" id="3440354">)</span><span class="op" id="3440355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3440358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440362">helloDone</span>&nbsp;<span class="op" id="3440372">:=</span>&nbsp;<span class="builtinfunc" id="3440375">new</span><span class="op" id="3440378">(</span><span class="ident" id="3440379">serverHelloDoneMsg</span><span class="op" id="3440397">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440400">hs</span><span class="op" id="3440402">.</span><span class="ident" id="3440403">finishedHash</span><span class="op" id="3440415">.</span><span class="ident" id="3440416">Write</span><span class="op" id="3440421">(</span><span class="ident" id="3440422">helloDone</span><span class="op" id="3440431">.</span><span class="ident" id="3440432">marshal</span><span class="op" id="3440439">(</span><span class="op" id="3440440">)</span><span class="op" id="3440441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440444">c</span><span class="op" id="3440445">.</span><span class="ident" id="3440446">writeRecord</span><span class="op" id="3440457">(</span><span class="ident" id="3440458">recordTypeHandshake</span><span class="op" id="3440477">,</span>&nbsp;<span class="ident" id="3440479">helloDone</span><span class="op" id="3440488">.</span><span class="ident" id="3440489">marshal</span><span class="op" id="3440496">(</span><span class="op" id="3440497">)</span><span class="op" id="3440498">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3440502">var</span>&nbsp;<span class="ident" id="3440506">pub</span>&nbsp;<span class="ident" id="3440510">crypto</span><span class="op" id="3440516">.</span><span class="ident" id="3440517">PublicKey</span>&nbsp;<span class="comment" id="3440527">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440567">msg</span><span class="op" id="3440570">,</span>&nbsp;<span class="ident" id="3440572">err</span>&nbsp;<span class="op" id="3440576">:=</span>&nbsp;<span class="ident" id="3440579">c</span><span class="op" id="3440580">.</span><span class="ident" id="3440581">readHandshake</span><span class="op" id="3440594">(</span><span class="op" id="3440595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3440598">if</span>&nbsp;<span class="ident" id="3440601">err</span>&nbsp;<span class="op" id="3440605">!=</span>&nbsp;<span class="ident" id="3440608">nil</span>&nbsp;<span class="op" id="3440612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3440616">return</span>&nbsp;<span class="ident" id="3440623">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3440628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3440632">var</span>&nbsp;<span class="ident" id="3440636">ok</span>&nbsp;<span class="builtintype" id="3440639">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3440645">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3440715">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3440760">if</span>&nbsp;<span class="ident" id="3440763">config</span><span class="op" id="3440769">.</span><span class="ident" id="3440770">ClientAuth</span>&nbsp;<span class="op" id="3440781">&gt;=</span>&nbsp;<span class="ident" id="3440784">RequestClientCert</span>&nbsp;<span class="op" id="3440802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3440806">if</span>&nbsp;<span class="ident" id="3440809">certMsg</span><span class="op" id="3440816">,</span>&nbsp;<span class="ident" id="3440818">ok</span>&nbsp;<span class="op" id="3440821">=</span>&nbsp;<span class="ident" id="3440823">msg</span><span class="op" id="3440826">.</span><span class="op" id="3440827">(</span><span class="op" id="3440828">*</span><span class="ident" id="3440829">certificateMsg</span><span class="op" id="3440843">)</span><span class="op" id="3440844">;</span>&nbsp;<span class="op" id="3440846">!</span><span class="ident" id="3440847">ok</span>&nbsp;<span class="op" id="3440850">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440855">c</span><span class="op" id="3440856">.</span><span class="ident" id="3440857">sendAlert</span><span class="op" id="3440866">(</span><span class="ident" id="3440867">alertUnexpectedMessage</span><span class="op" id="3440889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3440894">return</span>&nbsp;<span class="ident" id="3440901">unexpectedMessageError</span><span class="op" id="3440923">(</span><span class="ident" id="3440924">certMsg</span><span class="op" id="3440931">,</span>&nbsp;<span class="ident" id="3440933">msg</span><span class="op" id="3440936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3440940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440944">hs</span><span class="op" id="3440946">.</span><span class="ident" id="3440947">finishedHash</span><span class="op" id="3440959">.</span><span class="ident" id="3440960">Write</span><span class="op" id="3440965">(</span><span class="ident" id="3440966">certMsg</span><span class="op" id="3440973">.</span><span class="ident" id="3440974">marshal</span><span class="op" id="3440981">(</span><span class="op" id="3440982">)</span><span class="op" id="3440983">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3440988">if</span>&nbsp;<span class="builtinfunc" id="3440991">len</span><span class="op" id="3440994">(</span><span class="ident" id="3440995">certMsg</span><span class="op" id="3441002">.</span><span class="ident" id="3441003">certificates</span><span class="op" id="3441015">)</span>&nbsp;<span class="op" id="3441017">==</span>&nbsp;<span class="num" id="3441020">0</span>&nbsp;<span class="op" id="3441022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441027">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441079">switch</span>&nbsp;<span class="ident" id="3441086">config</span><span class="op" id="3441092">.</span><span class="ident" id="3441093">ClientAuth</span>&nbsp;<span class="op" id="3441104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441109">case</span>&nbsp;<span class="ident" id="3441114">RequireAnyClientCert</span><span class="op" id="3441134">,</span>&nbsp;<span class="ident" id="3441136">RequireAndVerifyClientCert</span><span class="op" id="3441162">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441168">c</span><span class="op" id="3441169">.</span><span class="ident" id="3441170">sendAlert</span><span class="op" id="3441179">(</span><span class="ident" id="3441180">alertBadCertificate</span><span class="op" id="3441199">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441205">return</span>&nbsp;<span class="ident" id="3441212">errors</span><span class="op" id="3441218">.</span><span class="ident" id="3441219">New</span><span class="op" id="3441222">(</span><span class="string" id="3441223">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="3441265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441279">pub</span><span class="op" id="3441282">,</span>&nbsp;<span class="ident" id="3441284">err</span>&nbsp;<span class="op" id="3441288">=</span>&nbsp;<span class="ident" id="3441290">hs</span><span class="op" id="3441292">.</span><span class="ident" id="3441293">processCertsFromClient</span><span class="op" id="3441315">(</span><span class="ident" id="3441316">certMsg</span><span class="op" id="3441323">.</span><span class="ident" id="3441324">certificates</span><span class="op" id="3441336">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441340">if</span>&nbsp;<span class="ident" id="3441343">err</span>&nbsp;<span class="op" id="3441347">!=</span>&nbsp;<span class="ident" id="3441350">nil</span>&nbsp;<span class="op" id="3441354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441359">return</span>&nbsp;<span class="ident" id="3441366">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441377">msg</span><span class="op" id="3441380">,</span>&nbsp;<span class="ident" id="3441382">err</span>&nbsp;<span class="op" id="3441386">=</span>&nbsp;<span class="ident" id="3441388">c</span><span class="op" id="3441389">.</span><span class="ident" id="3441390">readHandshake</span><span class="op" id="3441403">(</span><span class="op" id="3441404">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441408">if</span>&nbsp;<span class="ident" id="3441411">err</span>&nbsp;<span class="op" id="3441415">!=</span>&nbsp;<span class="ident" id="3441418">nil</span>&nbsp;<span class="op" id="3441422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441427">return</span>&nbsp;<span class="ident" id="3441434">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441447">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441475">ckx</span><span class="op" id="3441478">,</span>&nbsp;<span class="ident" id="3441480">ok</span>&nbsp;<span class="op" id="3441483">:=</span>&nbsp;<span class="ident" id="3441486">msg</span><span class="op" id="3441489">.</span><span class="op" id="3441490">(</span><span class="op" id="3441491">*</span><span class="ident" id="3441492">clientKeyExchangeMsg</span><span class="op" id="3441512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441515">if</span>&nbsp;<span class="op" id="3441518">!</span><span class="ident" id="3441519">ok</span>&nbsp;<span class="op" id="3441522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441526">c</span><span class="op" id="3441527">.</span><span class="ident" id="3441528">sendAlert</span><span class="op" id="3441537">(</span><span class="ident" id="3441538">alertUnexpectedMessage</span><span class="op" id="3441560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441564">return</span>&nbsp;<span class="ident" id="3441571">unexpectedMessageError</span><span class="op" id="3441593">(</span><span class="ident" id="3441594">ckx</span><span class="op" id="3441597">,</span>&nbsp;<span class="ident" id="3441599">msg</span><span class="op" id="3441602">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441608">hs</span><span class="op" id="3441610">.</span><span class="ident" id="3441611">finishedHash</span><span class="op" id="3441623">.</span><span class="ident" id="3441624">Write</span><span class="op" id="3441629">(</span><span class="ident" id="3441630">ckx</span><span class="op" id="3441633">.</span><span class="ident" id="3441634">marshal</span><span class="op" id="3441641">(</span><span class="op" id="3441642">)</span><span class="op" id="3441643">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441647">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441728">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441801">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441870">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441950">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3442030">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442084">if</span>&nbsp;<span class="builtinfunc" id="3442087">len</span><span class="op" id="3442090">(</span><span class="ident" id="3442091">c</span><span class="op" id="3442092">.</span><span class="ident" id="3442093">peerCertificates</span><span class="op" id="3442109">)</span>&nbsp;<span class="op" id="3442111">&gt;</span>&nbsp;<span class="num" id="3442113">0</span>&nbsp;<span class="op" id="3442115">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442119">msg</span><span class="op" id="3442122">,</span>&nbsp;<span class="ident" id="3442124">err</span>&nbsp;<span class="op" id="3442128">=</span>&nbsp;<span class="ident" id="3442130">c</span><span class="op" id="3442131">.</span><span class="ident" id="3442132">readHandshake</span><span class="op" id="3442145">(</span><span class="op" id="3442146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442150">if</span>&nbsp;<span class="ident" id="3442153">err</span>&nbsp;<span class="op" id="3442157">!=</span>&nbsp;<span class="ident" id="3442160">nil</span>&nbsp;<span class="op" id="3442164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442169">return</span>&nbsp;<span class="ident" id="3442176">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442186">certVerify</span><span class="op" id="3442196">,</span>&nbsp;<span class="ident" id="3442198">ok</span>&nbsp;<span class="op" id="3442201">:=</span>&nbsp;<span class="ident" id="3442204">msg</span><span class="op" id="3442207">.</span><span class="op" id="3442208">(</span><span class="op" id="3442209">*</span><span class="ident" id="3442210">certificateVerifyMsg</span><span class="op" id="3442230">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442234">if</span>&nbsp;<span class="op" id="3442237">!</span><span class="ident" id="3442238">ok</span>&nbsp;<span class="op" id="3442241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442246">c</span><span class="op" id="3442247">.</span><span class="ident" id="3442248">sendAlert</span><span class="op" id="3442257">(</span><span class="ident" id="3442258">alertUnexpectedMessage</span><span class="op" id="3442280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442285">return</span>&nbsp;<span class="ident" id="3442292">unexpectedMessageError</span><span class="op" id="3442314">(</span><span class="ident" id="3442315">certVerify</span><span class="op" id="3442325">,</span>&nbsp;<span class="ident" id="3442327">msg</span><span class="op" id="3442330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442339">switch</span>&nbsp;<span class="ident" id="3442346">key</span>&nbsp;<span class="op" id="3442350">:=</span>&nbsp;<span class="ident" id="3442353">pub</span><span class="op" id="3442356">.</span><span class="op" id="3442357">(</span><span class="keyword" id="3442358">type</span><span class="op" id="3442362">)</span>&nbsp;<span class="op" id="3442364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442368">case</span>&nbsp;<span class="op" id="3442373">*</span><span class="ident" id="3442374">ecdsa</span><span class="op" id="3442379">.</span><span class="ident" id="3442380">PublicKey</span><span class="op" id="3442389">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442394">ecdsaSig</span>&nbsp;<span class="op" id="3442403">:=</span>&nbsp;<span class="builtinfunc" id="3442406">new</span><span class="op" id="3442409">(</span><span class="ident" id="3442410">ecdsaSignature</span><span class="op" id="3442424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442429">if</span>&nbsp;<span class="ident" id="3442432">_</span><span class="op" id="3442433">,</span>&nbsp;<span class="ident" id="3442435">err</span>&nbsp;<span class="op" id="3442439">=</span>&nbsp;<span class="ident" id="3442441">asn1</span><span class="op" id="3442445">.</span><span class="ident" id="3442446">Unmarshal</span><span class="op" id="3442455">(</span><span class="ident" id="3442456">certVerify</span><span class="op" id="3442466">.</span><span class="ident" id="3442467">signature</span><span class="op" id="3442476">,</span>&nbsp;<span class="ident" id="3442478">ecdsaSig</span><span class="op" id="3442486">)</span><span class="op" id="3442487">;</span>&nbsp;<span class="ident" id="3442489">err</span>&nbsp;<span class="op" id="3442493">!=</span>&nbsp;<span class="ident" id="3442496">nil</span>&nbsp;<span class="op" id="3442500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442506">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442520">if</span>&nbsp;<span class="ident" id="3442523">ecdsaSig</span><span class="op" id="3442531">.</span><span class="ident" id="3442532">R</span><span class="op" id="3442533">.</span><span class="ident" id="3442534">Sign</span><span class="op" id="3442538">(</span><span class="op" id="3442539">)</span>&nbsp;<span class="op" id="3442541">&lt;=</span>&nbsp;<span class="num" id="3442544">0</span>&nbsp;<span class="op" id="3442546">||</span>&nbsp;<span class="ident" id="3442549">ecdsaSig</span><span class="op" id="3442557">.</span><span class="ident" id="3442558">S</span><span class="op" id="3442559">.</span><span class="ident" id="3442560">Sign</span><span class="op" id="3442564">(</span><span class="op" id="3442565">)</span>&nbsp;<span class="op" id="3442567">&lt;=</span>&nbsp;<span class="num" id="3442570">0</span>&nbsp;<span class="op" id="3442572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442578">err</span>&nbsp;<span class="op" id="3442582">=</span>&nbsp;<span class="ident" id="3442584">errors</span><span class="op" id="3442590">.</span><span class="ident" id="3442591">New</span><span class="op" id="3442594">(</span><span class="string" id="3442595">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="3442646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442652">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442661">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442666">digest</span><span class="op" id="3442672">,</span>&nbsp;<span class="ident" id="3442674">_</span><span class="op" id="3442675">,</span>&nbsp;<span class="ident" id="3442677">_</span>&nbsp;<span class="op" id="3442679">:=</span>&nbsp;<span class="ident" id="3442682">hs</span><span class="op" id="3442684">.</span><span class="ident" id="3442685">finishedHash</span><span class="op" id="3442697">.</span><span class="ident" id="3442698">hashForClientCertificate</span><span class="op" id="3442722">(</span><span class="ident" id="3442723">signatureECDSA</span><span class="op" id="3442737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442742">if</span>&nbsp;<span class="op" id="3442745">!</span><span class="ident" id="3442746">ecdsa</span><span class="op" id="3442751">.</span><span class="ident" id="3442752">Verify</span><span class="op" id="3442758">(</span><span class="ident" id="3442759">key</span><span class="op" id="3442762">,</span>&nbsp;<span class="ident" id="3442764">digest</span><span class="op" id="3442770">,</span>&nbsp;<span class="ident" id="3442772">ecdsaSig</span><span class="op" id="3442780">.</span><span class="ident" id="3442781">R</span><span class="op" id="3442782">,</span>&nbsp;<span class="ident" id="3442784">ecdsaSig</span><span class="op" id="3442792">.</span><span class="ident" id="3442793">S</span><span class="op" id="3442794">)</span>&nbsp;<span class="op" id="3442796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442802">err</span>&nbsp;<span class="op" id="3442806">=</span>&nbsp;<span class="ident" id="3442808">errors</span><span class="op" id="3442814">.</span><span class="ident" id="3442815">New</span><span class="op" id="3442818">(</span><span class="string" id="3442819">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="3442847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442853">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442862">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442866">case</span>&nbsp;<span class="op" id="3442871">*</span><span class="ident" id="3442872">rsa</span><span class="op" id="3442875">.</span><span class="ident" id="3442876">PublicKey</span><span class="op" id="3442885">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442890">digest</span><span class="op" id="3442896">,</span>&nbsp;<span class="ident" id="3442898">hashFunc</span><span class="op" id="3442906">,</span>&nbsp;<span class="ident" id="3442908">_</span>&nbsp;<span class="op" id="3442910">:=</span>&nbsp;<span class="ident" id="3442913">hs</span><span class="op" id="3442915">.</span><span class="ident" id="3442916">finishedHash</span><span class="op" id="3442928">.</span><span class="ident" id="3442929">hashForClientCertificate</span><span class="op" id="3442953">(</span><span class="ident" id="3442954">signatureRSA</span><span class="op" id="3442966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442971">err</span>&nbsp;<span class="op" id="3442975">=</span>&nbsp;<span class="ident" id="3442977">rsa</span><span class="op" id="3442980">.</span><span class="ident" id="3442981">VerifyPKCS1v15</span><span class="op" id="3442995">(</span><span class="ident" id="3442996">key</span><span class="op" id="3442999">,</span>&nbsp;<span class="ident" id="3443001">hashFunc</span><span class="op" id="3443009">,</span>&nbsp;<span class="ident" id="3443011">digest</span><span class="op" id="3443017">,</span>&nbsp;<span class="ident" id="3443019">certVerify</span><span class="op" id="3443029">.</span><span class="ident" id="3443030">signature</span><span class="op" id="3443039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3443043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443047">if</span>&nbsp;<span class="ident" id="3443050">err</span>&nbsp;<span class="op" id="3443054">!=</span>&nbsp;<span class="ident" id="3443057">nil</span>&nbsp;<span class="op" id="3443061">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443066">c</span><span class="op" id="3443067">.</span><span class="ident" id="3443068">sendAlert</span><span class="op" id="3443077">(</span><span class="ident" id="3443078">alertBadCertificate</span><span class="op" id="3443097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443102">return</span>&nbsp;<span class="ident" id="3443109">errors</span><span class="op" id="3443115">.</span><span class="ident" id="3443116">New</span><span class="op" id="3443119">(</span><span class="string" id="3443120">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="3443174">+</span>&nbsp;<span class="ident" id="3443176">err</span><span class="op" id="3443179">.</span><span class="ident" id="3443180">Error</span><span class="op" id="3443185">(</span><span class="op" id="3443186">)</span><span class="op" id="3443187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3443191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443196">hs</span><span class="op" id="3443198">.</span><span class="ident" id="3443199">finishedHash</span><span class="op" id="3443211">.</span><span class="ident" id="3443212">Write</span><span class="op" id="3443217">(</span><span class="ident" id="3443218">certVerify</span><span class="op" id="3443228">.</span><span class="ident" id="3443229">marshal</span><span class="op" id="3443236">(</span><span class="op" id="3443237">)</span><span class="op" id="3443238">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3443241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443245">preMasterSecret</span><span class="op" id="3443260">,</span>&nbsp;<span class="ident" id="3443262">err</span>&nbsp;<span class="op" id="3443266">:=</span>&nbsp;<span class="ident" id="3443269">keyAgreement</span><span class="op" id="3443281">.</span><span class="ident" id="3443282">processClientKeyExchange</span><span class="op" id="3443306">(</span><span class="ident" id="3443307">config</span><span class="op" id="3443313">,</span>&nbsp;<span class="ident" id="3443315">hs</span><span class="op" id="3443317">.</span><span class="ident" id="3443318">cert</span><span class="op" id="3443322">,</span>&nbsp;<span class="ident" id="3443324">ckx</span><span class="op" id="3443327">,</span>&nbsp;<span class="ident" id="3443329">c</span><span class="op" id="3443330">.</span><span class="ident" id="3443331">vers</span><span class="op" id="3443335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443338">if</span>&nbsp;<span class="ident" id="3443341">err</span>&nbsp;<span class="op" id="3443345">!=</span>&nbsp;<span class="ident" id="3443348">nil</span>&nbsp;<span class="op" id="3443352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443356">c</span><span class="op" id="3443357">.</span><span class="ident" id="3443358">sendAlert</span><span class="op" id="3443367">(</span><span class="ident" id="3443368">alertHandshakeFailure</span><span class="op" id="3443389">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443393">return</span>&nbsp;<span class="ident" id="3443400">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3443405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443408">hs</span><span class="op" id="3443410">.</span><span class="ident" id="3443411">masterSecret</span>&nbsp;<span class="op" id="3443424">=</span>&nbsp;<span class="ident" id="3443426">masterFromPreMasterSecret</span><span class="op" id="3443451">(</span><span class="ident" id="3443452">c</span><span class="op" id="3443453">.</span><span class="ident" id="3443454">vers</span><span class="op" id="3443458">,</span>&nbsp;<span class="ident" id="3443460">preMasterSecret</span><span class="op" id="3443475">,</span>&nbsp;<span class="ident" id="3443477">hs</span><span class="op" id="3443479">.</span><span class="ident" id="3443480">clientHello</span><span class="op" id="3443491">.</span><span class="ident" id="3443492">random</span><span class="op" id="3443498">,</span>&nbsp;<span class="ident" id="3443500">hs</span><span class="op" id="3443502">.</span><span class="ident" id="3443503">hello</span><span class="op" id="3443508">.</span><span class="ident" id="3443509">random</span><span class="op" id="3443515">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443519">return</span>&nbsp;<span class="ident" id="3443526">nil</span><br>
<span class="lineno">475</span><span class="op" id="3443530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3443533">func</span>&nbsp;<span class="op" id="3443538">(</span><span class="ident" id="3443539">hs</span>&nbsp;<span class="op" id="3443542">*</span><span class="ident" id="3443543">serverHandshakeState</span><span class="op" id="3443563">)</span>&nbsp;<span class="ident" id="3443565">establishKeys</span><span class="op" id="3443578">(</span><span class="op" id="3443579">)</span>&nbsp;<span class="builtintype" id="3443581">error</span>&nbsp;<span class="op" id="3443587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443590">c</span>&nbsp;<span class="op" id="3443592">:=</span>&nbsp;<span class="ident" id="3443595">hs</span><span class="op" id="3443597">.</span><span class="ident" id="3443598">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443602">clientMAC</span><span class="op" id="3443611">,</span>&nbsp;<span class="ident" id="3443613">serverMAC</span><span class="op" id="3443622">,</span>&nbsp;<span class="ident" id="3443624">clientKey</span><span class="op" id="3443633">,</span>&nbsp;<span class="ident" id="3443635">serverKey</span><span class="op" id="3443644">,</span>&nbsp;<span class="ident" id="3443646">clientIV</span><span class="op" id="3443654">,</span>&nbsp;<span class="ident" id="3443656">serverIV</span>&nbsp;<span class="op" id="3443665">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443670">keysFromMasterSecret</span><span class="op" id="3443690">(</span><span class="ident" id="3443691">c</span><span class="op" id="3443692">.</span><span class="ident" id="3443693">vers</span><span class="op" id="3443697">,</span>&nbsp;<span class="ident" id="3443699">hs</span><span class="op" id="3443701">.</span><span class="ident" id="3443702">masterSecret</span><span class="op" id="3443714">,</span>&nbsp;<span class="ident" id="3443716">hs</span><span class="op" id="3443718">.</span><span class="ident" id="3443719">clientHello</span><span class="op" id="3443730">.</span><span class="ident" id="3443731">random</span><span class="op" id="3443737">,</span>&nbsp;<span class="ident" id="3443739">hs</span><span class="op" id="3443741">.</span><span class="ident" id="3443742">hello</span><span class="op" id="3443747">.</span><span class="ident" id="3443748">random</span><span class="op" id="3443754">,</span>&nbsp;<span class="ident" id="3443756">hs</span><span class="op" id="3443758">.</span><span class="ident" id="3443759">suite</span><span class="op" id="3443764">.</span><span class="ident" id="3443765">macLen</span><span class="op" id="3443771">,</span>&nbsp;<span class="ident" id="3443773">hs</span><span class="op" id="3443775">.</span><span class="ident" id="3443776">suite</span><span class="op" id="3443781">.</span><span class="ident" id="3443782">keyLen</span><span class="op" id="3443788">,</span>&nbsp;<span class="ident" id="3443790">hs</span><span class="op" id="3443792">.</span><span class="ident" id="3443793">suite</span><span class="op" id="3443798">.</span><span class="ident" id="3443799">ivLen</span><span class="op" id="3443804">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443808">var</span>&nbsp;<span class="ident" id="3443812">clientCipher</span><span class="op" id="3443824">,</span>&nbsp;<span class="ident" id="3443826">serverCipher</span>&nbsp;<span class="keyword" id="3443839">interface</span><span class="op" id="3443848">{</span><span class="op" id="3443849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443852">var</span>&nbsp;<span class="ident" id="3443856">clientHash</span><span class="op" id="3443866">,</span>&nbsp;<span class="ident" id="3443868">serverHash</span>&nbsp;<span class="ident" id="3443879">macFunction</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3443893">if</span>&nbsp;<span class="ident" id="3443896">hs</span><span class="op" id="3443898">.</span><span class="ident" id="3443899">suite</span><span class="op" id="3443904">.</span><span class="ident" id="3443905">aead</span>&nbsp;<span class="op" id="3443910">==</span>&nbsp;<span class="ident" id="3443913">nil</span>&nbsp;<span class="op" id="3443917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443921">clientCipher</span>&nbsp;<span class="op" id="3443934">=</span>&nbsp;<span class="ident" id="3443936">hs</span><span class="op" id="3443938">.</span><span class="ident" id="3443939">suite</span><span class="op" id="3443944">.</span><span class="ident" id="3443945">cipher</span><span class="op" id="3443951">(</span><span class="ident" id="3443952">clientKey</span><span class="op" id="3443961">,</span>&nbsp;<span class="ident" id="3443963">clientIV</span><span class="op" id="3443971">,</span>&nbsp;<span class="builtintype" id="3443973">true</span>&nbsp;<span class="comment" id="3443978">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3443995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443999">clientHash</span>&nbsp;<span class="op" id="3444010">=</span>&nbsp;<span class="ident" id="3444012">hs</span><span class="op" id="3444014">.</span><span class="ident" id="3444015">suite</span><span class="op" id="3444020">.</span><span class="ident" id="3444021">mac</span><span class="op" id="3444024">(</span><span class="ident" id="3444025">c</span><span class="op" id="3444026">.</span><span class="ident" id="3444027">vers</span><span class="op" id="3444031">,</span>&nbsp;<span class="ident" id="3444033">clientMAC</span><span class="op" id="3444042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444046">serverCipher</span>&nbsp;<span class="op" id="3444059">=</span>&nbsp;<span class="ident" id="3444061">hs</span><span class="op" id="3444063">.</span><span class="ident" id="3444064">suite</span><span class="op" id="3444069">.</span><span class="ident" id="3444070">cipher</span><span class="op" id="3444076">(</span><span class="ident" id="3444077">serverKey</span><span class="op" id="3444086">,</span>&nbsp;<span class="ident" id="3444088">serverIV</span><span class="op" id="3444096">,</span>&nbsp;<span class="builtintype" id="3444098">false</span>&nbsp;<span class="comment" id="3444104">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3444125">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444129">serverHash</span>&nbsp;<span class="op" id="3444140">=</span>&nbsp;<span class="ident" id="3444142">hs</span><span class="op" id="3444144">.</span><span class="ident" id="3444145">suite</span><span class="op" id="3444150">.</span><span class="ident" id="3444151">mac</span><span class="op" id="3444154">(</span><span class="ident" id="3444155">c</span><span class="op" id="3444156">.</span><span class="ident" id="3444157">vers</span><span class="op" id="3444161">,</span>&nbsp;<span class="ident" id="3444163">serverMAC</span><span class="op" id="3444172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444175">}</span>&nbsp;<span class="keyword" id="3444177">else</span>&nbsp;<span class="op" id="3444182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444186">clientCipher</span>&nbsp;<span class="op" id="3444199">=</span>&nbsp;<span class="ident" id="3444201">hs</span><span class="op" id="3444203">.</span><span class="ident" id="3444204">suite</span><span class="op" id="3444209">.</span><span class="ident" id="3444210">aead</span><span class="op" id="3444214">(</span><span class="ident" id="3444215">clientKey</span><span class="op" id="3444224">,</span>&nbsp;<span class="ident" id="3444226">clientIV</span><span class="op" id="3444234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444238">serverCipher</span>&nbsp;<span class="op" id="3444251">=</span>&nbsp;<span class="ident" id="3444253">hs</span><span class="op" id="3444255">.</span><span class="ident" id="3444256">suite</span><span class="op" id="3444261">.</span><span class="ident" id="3444262">aead</span><span class="op" id="3444266">(</span><span class="ident" id="3444267">serverKey</span><span class="op" id="3444276">,</span>&nbsp;<span class="ident" id="3444278">serverIV</span><span class="op" id="3444286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444289">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444293">c</span><span class="op" id="3444294">.</span><span class="ident" id="3444295">in</span><span class="op" id="3444297">.</span><span class="ident" id="3444298">prepareCipherSpec</span><span class="op" id="3444315">(</span><span class="ident" id="3444316">c</span><span class="op" id="3444317">.</span><span class="ident" id="3444318">vers</span><span class="op" id="3444322">,</span>&nbsp;<span class="ident" id="3444324">clientCipher</span><span class="op" id="3444336">,</span>&nbsp;<span class="ident" id="3444338">clientHash</span><span class="op" id="3444348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444351">c</span><span class="op" id="3444352">.</span><span class="ident" id="3444353">out</span><span class="op" id="3444356">.</span><span class="ident" id="3444357">prepareCipherSpec</span><span class="op" id="3444374">(</span><span class="ident" id="3444375">c</span><span class="op" id="3444376">.</span><span class="ident" id="3444377">vers</span><span class="op" id="3444381">,</span>&nbsp;<span class="ident" id="3444383">serverCipher</span><span class="op" id="3444395">,</span>&nbsp;<span class="ident" id="3444397">serverHash</span><span class="op" id="3444407">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444411">return</span>&nbsp;<span class="ident" id="3444418">nil</span><br>
<span class="lineno">500</span><span class="op" id="3444422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3444425">func</span>&nbsp;<span class="op" id="3444430">(</span><span class="ident" id="3444431">hs</span>&nbsp;<span class="op" id="3444434">*</span><span class="ident" id="3444435">serverHandshakeState</span><span class="op" id="3444455">)</span>&nbsp;<span class="ident" id="3444457">readFinished</span><span class="op" id="3444469">(</span><span class="ident" id="3444470">out</span>&nbsp;<span class="op" id="3444474">[</span><span class="op" id="3444475">]</span><span class="builtintype" id="3444476">byte</span><span class="op" id="3444480">)</span>&nbsp;<span class="builtintype" id="3444482">error</span>&nbsp;<span class="op" id="3444488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444491">c</span>&nbsp;<span class="op" id="3444493">:=</span>&nbsp;<span class="ident" id="3444496">hs</span><span class="op" id="3444498">.</span><span class="ident" id="3444499">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444503">c</span><span class="op" id="3444504">.</span><span class="ident" id="3444505">readRecord</span><span class="op" id="3444515">(</span><span class="ident" id="3444516">recordTypeChangeCipherSpec</span><span class="op" id="3444542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444545">if</span>&nbsp;<span class="ident" id="3444548">err</span>&nbsp;<span class="op" id="3444552">:=</span>&nbsp;<span class="ident" id="3444555">c</span><span class="op" id="3444556">.</span><span class="ident" id="3444557">in</span><span class="op" id="3444559">.</span><span class="builtintype" id="3444560">error</span><span class="op" id="3444565">(</span><span class="op" id="3444566">)</span><span class="op" id="3444567">;</span>&nbsp;<span class="ident" id="3444569">err</span>&nbsp;<span class="op" id="3444573">!=</span>&nbsp;<span class="ident" id="3444576">nil</span>&nbsp;<span class="op" id="3444580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444584">return</span>&nbsp;<span class="ident" id="3444591">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444600">if</span>&nbsp;<span class="ident" id="3444603">hs</span><span class="op" id="3444605">.</span><span class="ident" id="3444606">hello</span><span class="op" id="3444611">.</span><span class="ident" id="3444612">nextProtoNeg</span>&nbsp;<span class="op" id="3444625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444629">msg</span><span class="op" id="3444632">,</span>&nbsp;<span class="ident" id="3444634">err</span>&nbsp;<span class="op" id="3444638">:=</span>&nbsp;<span class="ident" id="3444641">c</span><span class="op" id="3444642">.</span><span class="ident" id="3444643">readHandshake</span><span class="op" id="3444656">(</span><span class="op" id="3444657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444661">if</span>&nbsp;<span class="ident" id="3444664">err</span>&nbsp;<span class="op" id="3444668">!=</span>&nbsp;<span class="ident" id="3444671">nil</span>&nbsp;<span class="op" id="3444675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444680">return</span>&nbsp;<span class="ident" id="3444687">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444693">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444697">nextProto</span><span class="op" id="3444706">,</span>&nbsp;<span class="ident" id="3444708">ok</span>&nbsp;<span class="op" id="3444711">:=</span>&nbsp;<span class="ident" id="3444714">msg</span><span class="op" id="3444717">.</span><span class="op" id="3444718">(</span><span class="op" id="3444719">*</span><span class="ident" id="3444720">nextProtoMsg</span><span class="op" id="3444732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444736">if</span>&nbsp;<span class="op" id="3444739">!</span><span class="ident" id="3444740">ok</span>&nbsp;<span class="op" id="3444743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444748">c</span><span class="op" id="3444749">.</span><span class="ident" id="3444750">sendAlert</span><span class="op" id="3444759">(</span><span class="ident" id="3444760">alertUnexpectedMessage</span><span class="op" id="3444782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444787">return</span>&nbsp;<span class="ident" id="3444794">unexpectedMessageError</span><span class="op" id="3444816">(</span><span class="ident" id="3444817">nextProto</span><span class="op" id="3444826">,</span>&nbsp;<span class="ident" id="3444828">msg</span><span class="op" id="3444831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444835">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444839">hs</span><span class="op" id="3444841">.</span><span class="ident" id="3444842">finishedHash</span><span class="op" id="3444854">.</span><span class="ident" id="3444855">Write</span><span class="op" id="3444860">(</span><span class="ident" id="3444861">nextProto</span><span class="op" id="3444870">.</span><span class="ident" id="3444871">marshal</span><span class="op" id="3444878">(</span><span class="op" id="3444879">)</span><span class="op" id="3444880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444884">c</span><span class="op" id="3444885">.</span><span class="ident" id="3444886">clientProtocol</span>&nbsp;<span class="op" id="3444901">=</span>&nbsp;<span class="ident" id="3444903">nextProto</span><span class="op" id="3444912">.</span><span class="ident" id="3444913">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444924">msg</span><span class="op" id="3444927">,</span>&nbsp;<span class="ident" id="3444929">err</span>&nbsp;<span class="op" id="3444933">:=</span>&nbsp;<span class="ident" id="3444936">c</span><span class="op" id="3444937">.</span><span class="ident" id="3444938">readHandshake</span><span class="op" id="3444951">(</span><span class="op" id="3444952">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444955">if</span>&nbsp;<span class="ident" id="3444958">err</span>&nbsp;<span class="op" id="3444962">!=</span>&nbsp;<span class="ident" id="3444965">nil</span>&nbsp;<span class="op" id="3444969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444973">return</span>&nbsp;<span class="ident" id="3444980">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444988">clientFinished</span><span class="op" id="3445002">,</span>&nbsp;<span class="ident" id="3445004">ok</span>&nbsp;<span class="op" id="3445007">:=</span>&nbsp;<span class="ident" id="3445010">msg</span><span class="op" id="3445013">.</span><span class="op" id="3445014">(</span><span class="op" id="3445015">*</span><span class="ident" id="3445016">finishedMsg</span><span class="op" id="3445027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445030">if</span>&nbsp;<span class="op" id="3445033">!</span><span class="ident" id="3445034">ok</span>&nbsp;<span class="op" id="3445037">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445041">c</span><span class="op" id="3445042">.</span><span class="ident" id="3445043">sendAlert</span><span class="op" id="3445052">(</span><span class="ident" id="3445053">alertUnexpectedMessage</span><span class="op" id="3445075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445079">return</span>&nbsp;<span class="ident" id="3445086">unexpectedMessageError</span><span class="op" id="3445108">(</span><span class="ident" id="3445109">clientFinished</span><span class="op" id="3445123">,</span>&nbsp;<span class="ident" id="3445125">msg</span><span class="op" id="3445128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445135">verify</span>&nbsp;<span class="op" id="3445142">:=</span>&nbsp;<span class="ident" id="3445145">hs</span><span class="op" id="3445147">.</span><span class="ident" id="3445148">finishedHash</span><span class="op" id="3445160">.</span><span class="ident" id="3445161">clientSum</span><span class="op" id="3445170">(</span><span class="ident" id="3445171">hs</span><span class="op" id="3445173">.</span><span class="ident" id="3445174">masterSecret</span><span class="op" id="3445186">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445189">if</span>&nbsp;<span class="builtinfunc" id="3445192">len</span><span class="op" id="3445195">(</span><span class="ident" id="3445196">verify</span><span class="op" id="3445202">)</span>&nbsp;<span class="op" id="3445204">!=</span>&nbsp;<span class="builtinfunc" id="3445207">len</span><span class="op" id="3445210">(</span><span class="ident" id="3445211">clientFinished</span><span class="op" id="3445225">.</span><span class="ident" id="3445226">verifyData</span><span class="op" id="3445236">)</span>&nbsp;<span class="op" id="3445238">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445243">subtle</span><span class="op" id="3445249">.</span><span class="ident" id="3445250">ConstantTimeCompare</span><span class="op" id="3445269">(</span><span class="ident" id="3445270">verify</span><span class="op" id="3445276">,</span>&nbsp;<span class="ident" id="3445278">clientFinished</span><span class="op" id="3445292">.</span><span class="ident" id="3445293">verifyData</span><span class="op" id="3445303">)</span>&nbsp;<span class="op" id="3445305">!=</span>&nbsp;<span class="num" id="3445308">1</span>&nbsp;<span class="op" id="3445310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445314">c</span><span class="op" id="3445315">.</span><span class="ident" id="3445316">sendAlert</span><span class="op" id="3445325">(</span><span class="ident" id="3445326">alertHandshakeFailure</span><span class="op" id="3445347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445351">return</span>&nbsp;<span class="ident" id="3445358">errors</span><span class="op" id="3445364">.</span><span class="ident" id="3445365">New</span><span class="op" id="3445368">(</span><span class="string" id="3445369">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="3445414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445417">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445421">hs</span><span class="op" id="3445423">.</span><span class="ident" id="3445424">finishedHash</span><span class="op" id="3445436">.</span><span class="ident" id="3445437">Write</span><span class="op" id="3445442">(</span><span class="ident" id="3445443">clientFinished</span><span class="op" id="3445457">.</span><span class="ident" id="3445458">marshal</span><span class="op" id="3445465">(</span><span class="op" id="3445466">)</span><span class="op" id="3445467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3445470">copy</span><span class="op" id="3445474">(</span><span class="ident" id="3445475">out</span><span class="op" id="3445478">,</span>&nbsp;<span class="ident" id="3445480">verify</span><span class="op" id="3445486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445489">return</span>&nbsp;<span class="ident" id="3445496">nil</span><br>
<span class="lineno"></span><span class="op" id="3445500">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="3445503">func</span>&nbsp;<span class="op" id="3445508">(</span><span class="ident" id="3445509">hs</span>&nbsp;<span class="op" id="3445512">*</span><span class="ident" id="3445513">serverHandshakeState</span><span class="op" id="3445533">)</span>&nbsp;<span class="ident" id="3445535">sendSessionTicket</span><span class="op" id="3445552">(</span><span class="op" id="3445553">)</span>&nbsp;<span class="builtintype" id="3445555">error</span>&nbsp;<span class="op" id="3445561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445564">if</span>&nbsp;<span class="op" id="3445567">!</span><span class="ident" id="3445568">hs</span><span class="op" id="3445570">.</span><span class="ident" id="3445571">hello</span><span class="op" id="3445576">.</span><span class="ident" id="3445577">ticketSupported</span>&nbsp;<span class="op" id="3445593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445597">return</span>&nbsp;<span class="ident" id="3445604">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445609">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445613">c</span>&nbsp;<span class="op" id="3445615">:=</span>&nbsp;<span class="ident" id="3445618">hs</span><span class="op" id="3445620">.</span><span class="ident" id="3445621">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445624">m</span>&nbsp;<span class="op" id="3445626">:=</span>&nbsp;<span class="builtinfunc" id="3445629">new</span><span class="op" id="3445632">(</span><span class="ident" id="3445633">newSessionTicketMsg</span><span class="op" id="3445652">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445656">var</span>&nbsp;<span class="ident" id="3445660">err</span>&nbsp;<span class="builtintype" id="3445664">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445671">state</span>&nbsp;<span class="op" id="3445677">:=</span>&nbsp;<span class="ident" id="3445680">sessionState</span><span class="op" id="3445692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445696">vers</span><span class="op" id="3445700">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3445710">c</span><span class="op" id="3445711">.</span><span class="ident" id="3445712">vers</span><span class="op" id="3445716">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445720">cipherSuite</span><span class="op" id="3445731">:</span>&nbsp;&nbsp;<span class="ident" id="3445734">hs</span><span class="op" id="3445736">.</span><span class="ident" id="3445737">suite</span><span class="op" id="3445742">.</span><span class="ident" id="3445743">id</span><span class="op" id="3445745">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445749">masterSecret</span><span class="op" id="3445761">:</span>&nbsp;<span class="ident" id="3445763">hs</span><span class="op" id="3445765">.</span><span class="ident" id="3445766">masterSecret</span><span class="op" id="3445778">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445782">certificates</span><span class="op" id="3445794">:</span>&nbsp;<span class="ident" id="3445796">hs</span><span class="op" id="3445798">.</span><span class="ident" id="3445799">certsFromClient</span><span class="op" id="3445814">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445820">m</span><span class="op" id="3445821">.</span><span class="ident" id="3445822">ticket</span><span class="op" id="3445828">,</span>&nbsp;<span class="ident" id="3445830">err</span>&nbsp;<span class="op" id="3445834">=</span>&nbsp;<span class="ident" id="3445836">c</span><span class="op" id="3445837">.</span><span class="ident" id="3445838">encryptTicket</span><span class="op" id="3445851">(</span><span class="op" id="3445852">&amp;</span><span class="ident" id="3445853">state</span><span class="op" id="3445858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445861">if</span>&nbsp;<span class="ident" id="3445864">err</span>&nbsp;<span class="op" id="3445868">!=</span>&nbsp;<span class="ident" id="3445871">nil</span>&nbsp;<span class="op" id="3445875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445879">return</span>&nbsp;<span class="ident" id="3445886">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445891">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445895">hs</span><span class="op" id="3445897">.</span><span class="ident" id="3445898">finishedHash</span><span class="op" id="3445910">.</span><span class="ident" id="3445911">Write</span><span class="op" id="3445916">(</span><span class="ident" id="3445917">m</span><span class="op" id="3445918">.</span><span class="ident" id="3445919">marshal</span><span class="op" id="3445926">(</span><span class="op" id="3445927">)</span><span class="op" id="3445928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445931">c</span><span class="op" id="3445932">.</span><span class="ident" id="3445933">writeRecord</span><span class="op" id="3445944">(</span><span class="ident" id="3445945">recordTypeHandshake</span><span class="op" id="3445964">,</span>&nbsp;<span class="ident" id="3445966">m</span><span class="op" id="3445967">.</span><span class="ident" id="3445968">marshal</span><span class="op" id="3445975">(</span><span class="op" id="3445976">)</span><span class="op" id="3445977">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445981">return</span>&nbsp;<span class="ident" id="3445988">nil</span><br>
<span class="lineno">570</span><span class="op" id="3445992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3445995">func</span>&nbsp;<span class="op" id="3446000">(</span><span class="ident" id="3446001">hs</span>&nbsp;<span class="op" id="3446004">*</span><span class="ident" id="3446005">serverHandshakeState</span><span class="op" id="3446025">)</span>&nbsp;<span class="ident" id="3446027">sendFinished</span><span class="op" id="3446039">(</span><span class="ident" id="3446040">out</span>&nbsp;<span class="op" id="3446044">[</span><span class="op" id="3446045">]</span><span class="builtintype" id="3446046">byte</span><span class="op" id="3446050">)</span>&nbsp;<span class="builtintype" id="3446052">error</span>&nbsp;<span class="op" id="3446058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446061">c</span>&nbsp;<span class="op" id="3446063">:=</span>&nbsp;<span class="ident" id="3446066">hs</span><span class="op" id="3446068">.</span><span class="ident" id="3446069">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446073">c</span><span class="op" id="3446074">.</span><span class="ident" id="3446075">writeRecord</span><span class="op" id="3446086">(</span><span class="ident" id="3446087">recordTypeChangeCipherSpec</span><span class="op" id="3446113">,</span>&nbsp;<span class="op" id="3446115">[</span><span class="op" id="3446116">]</span><span class="builtintype" id="3446117">byte</span><span class="op" id="3446121">{</span><span class="num" id="3446122">1</span><span class="op" id="3446123">}</span><span class="op" id="3446124">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446128">finished</span>&nbsp;<span class="op" id="3446137">:=</span>&nbsp;<span class="builtinfunc" id="3446140">new</span><span class="op" id="3446143">(</span><span class="ident" id="3446144">finishedMsg</span><span class="op" id="3446155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446158">finished</span><span class="op" id="3446166">.</span><span class="ident" id="3446167">verifyData</span>&nbsp;<span class="op" id="3446178">=</span>&nbsp;<span class="ident" id="3446180">hs</span><span class="op" id="3446182">.</span><span class="ident" id="3446183">finishedHash</span><span class="op" id="3446195">.</span><span class="ident" id="3446196">serverSum</span><span class="op" id="3446205">(</span><span class="ident" id="3446206">hs</span><span class="op" id="3446208">.</span><span class="ident" id="3446209">masterSecret</span><span class="op" id="3446221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446224">hs</span><span class="op" id="3446226">.</span><span class="ident" id="3446227">finishedHash</span><span class="op" id="3446239">.</span><span class="ident" id="3446240">Write</span><span class="op" id="3446245">(</span><span class="ident" id="3446246">finished</span><span class="op" id="3446254">.</span><span class="ident" id="3446255">marshal</span><span class="op" id="3446262">(</span><span class="op" id="3446263">)</span><span class="op" id="3446264">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446267">c</span><span class="op" id="3446268">.</span><span class="ident" id="3446269">writeRecord</span><span class="op" id="3446280">(</span><span class="ident" id="3446281">recordTypeHandshake</span><span class="op" id="3446300">,</span>&nbsp;<span class="ident" id="3446302">finished</span><span class="op" id="3446310">.</span><span class="ident" id="3446311">marshal</span><span class="op" id="3446318">(</span><span class="op" id="3446319">)</span><span class="op" id="3446320">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446324">c</span><span class="op" id="3446325">.</span><span class="ident" id="3446326">cipherSuite</span>&nbsp;<span class="op" id="3446338">=</span>&nbsp;<span class="ident" id="3446340">hs</span><span class="op" id="3446342">.</span><span class="ident" id="3446343">suite</span><span class="op" id="3446348">.</span><span class="ident" id="3446349">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3446353">copy</span><span class="op" id="3446357">(</span><span class="ident" id="3446358">out</span><span class="op" id="3446361">,</span>&nbsp;<span class="ident" id="3446363">finished</span><span class="op" id="3446371">.</span><span class="ident" id="3446372">verifyData</span><span class="op" id="3446382">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446386">return</span>&nbsp;<span class="ident" id="3446393">nil</span><br>
<span class="lineno"></span><span class="op" id="3446397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3446400">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3446477">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="3446554">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3446597">func</span>&nbsp;<span class="op" id="3446602">(</span><span class="ident" id="3446603">hs</span>&nbsp;<span class="op" id="3446606">*</span><span class="ident" id="3446607">serverHandshakeState</span><span class="op" id="3446627">)</span>&nbsp;<span class="ident" id="3446629">processCertsFromClient</span><span class="op" id="3446651">(</span><span class="ident" id="3446652">certificates</span>&nbsp;<span class="op" id="3446665">[</span><span class="op" id="3446666">]</span><span class="op" id="3446667">[</span><span class="op" id="3446668">]</span><span class="builtintype" id="3446669">byte</span><span class="op" id="3446673">)</span>&nbsp;<span class="op" id="3446675">(</span><span class="ident" id="3446676">crypto</span><span class="op" id="3446682">.</span><span class="ident" id="3446683">PublicKey</span><span class="op" id="3446692">,</span>&nbsp;<span class="builtintype" id="3446694">error</span><span class="op" id="3446699">)</span>&nbsp;<span class="op" id="3446701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446704">c</span>&nbsp;<span class="op" id="3446706">:=</span>&nbsp;<span class="ident" id="3446709">hs</span><span class="op" id="3446711">.</span><span class="ident" id="3446712">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446716">hs</span><span class="op" id="3446718">.</span><span class="ident" id="3446719">certsFromClient</span>&nbsp;<span class="op" id="3446735">=</span>&nbsp;<span class="ident" id="3446737">certificates</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446751">certs</span>&nbsp;<span class="op" id="3446757">:=</span>&nbsp;<span class="builtinfunc" id="3446760">make</span><span class="op" id="3446764">(</span><span class="op" id="3446765">[</span><span class="op" id="3446766">]</span><span class="op" id="3446767">*</span><span class="ident" id="3446768">x509</span><span class="op" id="3446772">.</span><span class="ident" id="3446773">Certificate</span><span class="op" id="3446784">,</span>&nbsp;<span class="builtinfunc" id="3446786">len</span><span class="op" id="3446789">(</span><span class="ident" id="3446790">certificates</span><span class="op" id="3446802">)</span><span class="op" id="3446803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446806">var</span>&nbsp;<span class="ident" id="3446810">err</span>&nbsp;<span class="builtintype" id="3446814">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446821">for</span>&nbsp;<span class="ident" id="3446825">i</span><span class="op" id="3446826">,</span>&nbsp;<span class="ident" id="3446828">asn1Data</span>&nbsp;<span class="op" id="3446837">:=</span>&nbsp;<span class="keyword" id="3446840">range</span>&nbsp;<span class="ident" id="3446846">certificates</span>&nbsp;<span class="op" id="3446859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446863">if</span>&nbsp;<span class="ident" id="3446866">certs</span><span class="op" id="3446871">[</span><span class="ident" id="3446872">i</span><span class="op" id="3446873">]</span><span class="op" id="3446874">,</span>&nbsp;<span class="ident" id="3446876">err</span>&nbsp;<span class="op" id="3446880">=</span>&nbsp;<span class="ident" id="3446882">x509</span><span class="op" id="3446886">.</span><span class="ident" id="3446887">ParseCertificate</span><span class="op" id="3446903">(</span><span class="ident" id="3446904">asn1Data</span><span class="op" id="3446912">)</span><span class="op" id="3446913">;</span>&nbsp;<span class="ident" id="3446915">err</span>&nbsp;<span class="op" id="3446919">!=</span>&nbsp;<span class="ident" id="3446922">nil</span>&nbsp;<span class="op" id="3446926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446931">c</span><span class="op" id="3446932">.</span><span class="ident" id="3446933">sendAlert</span><span class="op" id="3446942">(</span><span class="ident" id="3446943">alertBadCertificate</span><span class="op" id="3446962">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446967">return</span>&nbsp;<span class="ident" id="3446974">nil</span><span class="op" id="3446977">,</span>&nbsp;<span class="ident" id="3446979">errors</span><span class="op" id="3446985">.</span><span class="ident" id="3446986">New</span><span class="op" id="3446989">(</span><span class="string" id="3446990">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3447034">+</span>&nbsp;<span class="ident" id="3447036">err</span><span class="op" id="3447039">.</span><span class="ident" id="3447040">Error</span><span class="op" id="3447045">(</span><span class="op" id="3447046">)</span><span class="op" id="3447047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447058">if</span>&nbsp;<span class="ident" id="3447061">c</span><span class="op" id="3447062">.</span><span class="ident" id="3447063">config</span><span class="op" id="3447069">.</span><span class="ident" id="3447070">ClientAuth</span>&nbsp;<span class="op" id="3447081">&gt;=</span>&nbsp;<span class="ident" id="3447084">VerifyClientCertIfGiven</span>&nbsp;<span class="op" id="3447108">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3447111">len</span><span class="op" id="3447114">(</span><span class="ident" id="3447115">certs</span><span class="op" id="3447120">)</span>&nbsp;<span class="op" id="3447122">&gt;</span>&nbsp;<span class="num" id="3447124">0</span>&nbsp;<span class="op" id="3447126">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447130">opts</span>&nbsp;<span class="op" id="3447135">:=</span>&nbsp;<span class="ident" id="3447138">x509</span><span class="op" id="3447142">.</span><span class="ident" id="3447143">VerifyOptions</span><span class="op" id="3447156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447161">Roots</span><span class="op" id="3447166">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3447176">c</span><span class="op" id="3447177">.</span><span class="ident" id="3447178">config</span><span class="op" id="3447184">.</span><span class="ident" id="3447185">ClientCAs</span><span class="op" id="3447194">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447199">CurrentTime</span><span class="op" id="3447210">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3447214">c</span><span class="op" id="3447215">.</span><span class="ident" id="3447216">config</span><span class="op" id="3447222">.</span><span class="ident" id="3447223">time</span><span class="op" id="3447227">(</span><span class="op" id="3447228">)</span><span class="op" id="3447229">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447234">Intermediates</span><span class="op" id="3447247">:</span>&nbsp;<span class="ident" id="3447249">x509</span><span class="op" id="3447253">.</span><span class="ident" id="3447254">NewCertPool</span><span class="op" id="3447265">(</span><span class="op" id="3447266">)</span><span class="op" id="3447267">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447272">KeyUsages</span><span class="op" id="3447281">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3447287">[</span><span class="op" id="3447288">]</span><span class="ident" id="3447289">x509</span><span class="op" id="3447293">.</span><span class="ident" id="3447294">ExtKeyUsage</span><span class="op" id="3447305">{</span><span class="ident" id="3447306">x509</span><span class="op" id="3447310">.</span><span class="ident" id="3447311">ExtKeyUsageClientAuth</span><span class="op" id="3447332">}</span><span class="op" id="3447333">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447342">for</span>&nbsp;<span class="ident" id="3447346">_</span><span class="op" id="3447347">,</span>&nbsp;<span class="ident" id="3447349">cert</span>&nbsp;<span class="op" id="3447354">:=</span>&nbsp;<span class="keyword" id="3447357">range</span>&nbsp;<span class="ident" id="3447363">certs</span><span class="op" id="3447368">[</span><span class="num" id="3447369">1</span><span class="op" id="3447370">:</span><span class="op" id="3447371">]</span>&nbsp;<span class="op" id="3447373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447378">opts</span><span class="op" id="3447382">.</span><span class="ident" id="3447383">Intermediates</span><span class="op" id="3447396">.</span><span class="ident" id="3447397">AddCert</span><span class="op" id="3447404">(</span><span class="ident" id="3447405">cert</span><span class="op" id="3447409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447413">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447418">chains</span><span class="op" id="3447424">,</span>&nbsp;<span class="ident" id="3447426">err</span>&nbsp;<span class="op" id="3447430">:=</span>&nbsp;<span class="ident" id="3447433">certs</span><span class="op" id="3447438">[</span><span class="num" id="3447439">0</span><span class="op" id="3447440">]</span><span class="op" id="3447441">.</span><span class="ident" id="3447442">Verify</span><span class="op" id="3447448">(</span><span class="ident" id="3447449">opts</span><span class="op" id="3447453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447457">if</span>&nbsp;<span class="ident" id="3447460">err</span>&nbsp;<span class="op" id="3447464">!=</span>&nbsp;<span class="ident" id="3447467">nil</span>&nbsp;<span class="op" id="3447471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447476">c</span><span class="op" id="3447477">.</span><span class="ident" id="3447478">sendAlert</span><span class="op" id="3447487">(</span><span class="ident" id="3447488">alertBadCertificate</span><span class="op" id="3447507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447512">return</span>&nbsp;<span class="ident" id="3447519">nil</span><span class="op" id="3447522">,</span>&nbsp;<span class="ident" id="3447524">errors</span><span class="op" id="3447530">.</span><span class="ident" id="3447531">New</span><span class="op" id="3447534">(</span><span class="string" id="3447535">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3447582">+</span>&nbsp;<span class="ident" id="3447584">err</span><span class="op" id="3447587">.</span><span class="ident" id="3447588">Error</span><span class="op" id="3447593">(</span><span class="op" id="3447594">)</span><span class="op" id="3447595">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447604">ok</span>&nbsp;<span class="op" id="3447607">:=</span>&nbsp;<span class="builtintype" id="3447610">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447618">for</span>&nbsp;<span class="ident" id="3447622">_</span><span class="op" id="3447623">,</span>&nbsp;<span class="ident" id="3447625">ku</span>&nbsp;<span class="op" id="3447628">:=</span>&nbsp;<span class="keyword" id="3447631">range</span>&nbsp;<span class="ident" id="3447637">certs</span><span class="op" id="3447642">[</span><span class="num" id="3447643">0</span><span class="op" id="3447644">]</span><span class="op" id="3447645">.</span><span class="ident" id="3447646">ExtKeyUsage</span>&nbsp;<span class="op" id="3447658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447663">if</span>&nbsp;<span class="ident" id="3447666">ku</span>&nbsp;<span class="op" id="3447669">==</span>&nbsp;<span class="ident" id="3447672">x509</span><span class="op" id="3447676">.</span><span class="ident" id="3447677">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="3447699">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447705">ok</span>&nbsp;<span class="op" id="3447708">=</span>&nbsp;<span class="builtintype" id="3447710">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447719">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447736">if</span>&nbsp;<span class="op" id="3447739">!</span><span class="ident" id="3447740">ok</span>&nbsp;<span class="op" id="3447743">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447748">c</span><span class="op" id="3447749">.</span><span class="ident" id="3447750">sendAlert</span><span class="op" id="3447759">(</span><span class="ident" id="3447760">alertHandshakeFailure</span><span class="op" id="3447781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447786">return</span>&nbsp;<span class="ident" id="3447793">nil</span><span class="op" id="3447796">,</span>&nbsp;<span class="ident" id="3447798">errors</span><span class="op" id="3447804">.</span><span class="ident" id="3447805">New</span><span class="op" id="3447808">(</span><span class="string" id="3447809">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="3447912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447921">c</span><span class="op" id="3447922">.</span><span class="ident" id="3447923">verifiedChains</span>&nbsp;<span class="op" id="3447938">=</span>&nbsp;<span class="ident" id="3447940">chains</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447952">if</span>&nbsp;<span class="builtinfunc" id="3447955">len</span><span class="op" id="3447958">(</span><span class="ident" id="3447959">certs</span><span class="op" id="3447964">)</span>&nbsp;<span class="op" id="3447966">&gt;</span>&nbsp;<span class="num" id="3447968">0</span>&nbsp;<span class="op" id="3447970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447974">var</span>&nbsp;<span class="ident" id="3447978">pub</span>&nbsp;<span class="ident" id="3447982">crypto</span><span class="op" id="3447988">.</span><span class="ident" id="3447989">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448001">switch</span>&nbsp;<span class="ident" id="3448008">key</span>&nbsp;<span class="op" id="3448012">:=</span>&nbsp;<span class="ident" id="3448015">certs</span><span class="op" id="3448020">[</span><span class="num" id="3448021">0</span><span class="op" id="3448022">]</span><span class="op" id="3448023">.</span><span class="ident" id="3448024">PublicKey</span><span class="op" id="3448033">.</span><span class="op" id="3448034">(</span><span class="keyword" id="3448035">type</span><span class="op" id="3448039">)</span>&nbsp;<span class="op" id="3448041">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448045">case</span>&nbsp;<span class="op" id="3448050">*</span><span class="ident" id="3448051">ecdsa</span><span class="op" id="3448056">.</span><span class="ident" id="3448057">PublicKey</span><span class="op" id="3448066">,</span>&nbsp;<span class="op" id="3448068">*</span><span class="ident" id="3448069">rsa</span><span class="op" id="3448072">.</span><span class="ident" id="3448073">PublicKey</span><span class="op" id="3448082">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448087">pub</span>&nbsp;<span class="op" id="3448091">=</span>&nbsp;<span class="ident" id="3448093">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448099">default</span><span class="op" id="3448106">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448111">c</span><span class="op" id="3448112">.</span><span class="ident" id="3448113">sendAlert</span><span class="op" id="3448122">(</span><span class="ident" id="3448123">alertUnsupportedCertificate</span><span class="op" id="3448150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448155">return</span>&nbsp;<span class="ident" id="3448162">nil</span><span class="op" id="3448165">,</span>&nbsp;<span class="ident" id="3448167">fmt</span><span class="op" id="3448170">.</span><span class="ident" id="3448171">Errorf</span><span class="op" id="3448177">(</span><span class="string" id="3448178">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="3448251">,</span>&nbsp;<span class="ident" id="3448253">certs</span><span class="op" id="3448258">[</span><span class="num" id="3448259">0</span><span class="op" id="3448260">]</span><span class="op" id="3448261">.</span><span class="ident" id="3448262">PublicKey</span><span class="op" id="3448271">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448279">c</span><span class="op" id="3448280">.</span><span class="ident" id="3448281">peerCertificates</span>&nbsp;<span class="op" id="3448298">=</span>&nbsp;<span class="ident" id="3448300">certs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448308">return</span>&nbsp;<span class="ident" id="3448315">pub</span><span class="op" id="3448318">,</span>&nbsp;<span class="ident" id="3448320">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448329">return</span>&nbsp;<span class="ident" id="3448336">nil</span><span class="op" id="3448339">,</span>&nbsp;<span class="ident" id="3448341">nil</span><br>
<span class="lineno"></span><span class="op" id="3448345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3448348">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="3448427">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="3448452">func</span>&nbsp;<span class="op" id="3448457">(</span><span class="ident" id="3448458">c</span>&nbsp;<span class="op" id="3448460">*</span><span class="ident" id="3448461">Conn</span><span class="op" id="3448465">)</span>&nbsp;<span class="ident" id="3448467">tryCipherSuite</span><span class="op" id="3448481">(</span><span class="ident" id="3448482">id</span>&nbsp;<span class="builtintype" id="3448485">uint16</span><span class="op" id="3448491">,</span>&nbsp;<span class="ident" id="3448493">supportedCipherSuites</span>&nbsp;<span class="op" id="3448515">[</span><span class="op" id="3448516">]</span><span class="builtintype" id="3448517">uint16</span><span class="op" id="3448523">,</span>&nbsp;<span class="ident" id="3448525">version</span>&nbsp;<span class="builtintype" id="3448533">uint16</span><span class="op" id="3448539">,</span>&nbsp;<span class="ident" id="3448541">ellipticOk</span><span class="op" id="3448551">,</span>&nbsp;<span class="ident" id="3448553">ecdsaOk</span>&nbsp;<span class="builtintype" id="3448561">bool</span><span class="op" id="3448565">)</span>&nbsp;<span class="op" id="3448567">*</span><span class="ident" id="3448568">cipherSuite</span>&nbsp;<span class="op" id="3448580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448583">for</span>&nbsp;<span class="ident" id="3448587">_</span><span class="op" id="3448588">,</span>&nbsp;<span class="ident" id="3448590">supported</span>&nbsp;<span class="op" id="3448600">:=</span>&nbsp;<span class="keyword" id="3448603">range</span>&nbsp;<span class="ident" id="3448609">supportedCipherSuites</span>&nbsp;<span class="op" id="3448631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448635">if</span>&nbsp;<span class="ident" id="3448638">id</span>&nbsp;<span class="op" id="3448641">==</span>&nbsp;<span class="ident" id="3448644">supported</span>&nbsp;<span class="op" id="3448654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448659">var</span>&nbsp;<span class="ident" id="3448663">candidate</span>&nbsp;<span class="op" id="3448673">*</span><span class="ident" id="3448674">cipherSuite</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448690">for</span>&nbsp;<span class="ident" id="3448694">_</span><span class="op" id="3448695">,</span>&nbsp;<span class="ident" id="3448697">s</span>&nbsp;<span class="op" id="3448699">:=</span>&nbsp;<span class="keyword" id="3448702">range</span>&nbsp;<span class="ident" id="3448708">cipherSuites</span>&nbsp;<span class="op" id="3448721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448727">if</span>&nbsp;<span class="ident" id="3448730">s</span><span class="op" id="3448731">.</span><span class="ident" id="3448732">id</span>&nbsp;<span class="op" id="3448735">==</span>&nbsp;<span class="ident" id="3448738">id</span>&nbsp;<span class="op" id="3448741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448748">candidate</span>&nbsp;<span class="op" id="3448758">=</span>&nbsp;<span class="ident" id="3448760">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448767">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448777">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448787">if</span>&nbsp;<span class="ident" id="3448790">candidate</span>&nbsp;<span class="op" id="3448800">==</span>&nbsp;<span class="ident" id="3448803">nil</span>&nbsp;<span class="op" id="3448807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448813">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448830">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3448878">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448909">if</span>&nbsp;<span class="op" id="3448912">(</span><span class="ident" id="3448913">candidate</span><span class="op" id="3448922">.</span><span class="ident" id="3448923">flags</span><span class="op" id="3448928">&amp;</span><span class="ident" id="3448929">suiteECDHE</span>&nbsp;<span class="op" id="3448940">!=</span>&nbsp;<span class="num" id="3448943">0</span><span class="op" id="3448944">)</span>&nbsp;<span class="op" id="3448946">&amp;&amp;</span>&nbsp;<span class="op" id="3448949">!</span><span class="ident" id="3448950">ellipticOk</span>&nbsp;<span class="op" id="3448961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448967">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448984">if</span>&nbsp;<span class="op" id="3448987">(</span><span class="ident" id="3448988">candidate</span><span class="op" id="3448997">.</span><span class="ident" id="3448998">flags</span><span class="op" id="3449003">&amp;</span><span class="ident" id="3449004">suiteECDSA</span>&nbsp;<span class="op" id="3449015">!=</span>&nbsp;<span class="num" id="3449018">0</span><span class="op" id="3449019">)</span>&nbsp;<span class="op" id="3449021">!=</span>&nbsp;<span class="ident" id="3449024">ecdsaOk</span>&nbsp;<span class="op" id="3449032">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449038">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3449050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449055">if</span>&nbsp;<span class="ident" id="3449058">version</span>&nbsp;<span class="op" id="3449066">&lt;</span>&nbsp;<span class="ident" id="3449068">VersionTLS12</span>&nbsp;<span class="op" id="3449081">&amp;&amp;</span>&nbsp;<span class="ident" id="3449084">candidate</span><span class="op" id="3449093">.</span><span class="ident" id="3449094">flags</span><span class="op" id="3449099">&amp;</span><span class="ident" id="3449100">suiteTLS12</span>&nbsp;<span class="op" id="3449111">!=</span>&nbsp;<span class="num" id="3449114">0</span>&nbsp;<span class="op" id="3449116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449122">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3449134">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449139">return</span>&nbsp;<span class="ident" id="3449146">candidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3449158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3449161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449165">return</span>&nbsp;<span class="ident" id="3449172">nil</span><br>
<span class="lineno">685</span><span class="op" id="3449176">}</span>
</div>
</body>
</html>
