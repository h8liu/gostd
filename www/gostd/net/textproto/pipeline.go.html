<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/textproto</h2>
<ul>
<li><a href="/gostd/net/textproto/header.go.html">header.go</a></li>
<li><a href="/gostd/net/textproto/pipeline.go.html" class="current">pipeline.go</a></li>
<li><a href="/gostd/net/textproto/reader.go.html">reader.go</a></li>
<li><a href="/gostd/net/textproto/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/net/textproto/textproto.go.html">textproto.go</a></li>
<li><a href="/gostd/net/textproto/writer.go.html">writer.go</a></li>
<li><a href="/gostd/net/textproto/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3500594">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3500650">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3500704">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3500755">package</span>&nbsp;<span class="ident" id="3500763">textproto</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3500774">import</span>&nbsp;<span class="op" id="3500781">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3500784">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="3500791">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="3500794">//&nbsp;A&nbsp;Pipeline&nbsp;manages&nbsp;a&nbsp;pipelined&nbsp;in-order&nbsp;request/response&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="comment" id="3500864">//</span><br>
<span class="lineno"></span><span class="comment" id="3500867">//&nbsp;To&nbsp;use&nbsp;a&nbsp;Pipeline&nbsp;p&nbsp;to&nbsp;manage&nbsp;multiple&nbsp;clients&nbsp;on&nbsp;a&nbsp;connection,</span><br>
<span class="lineno"></span><span class="comment" id="3500934">//&nbsp;each&nbsp;client&nbsp;should&nbsp;run:</span><br>
<span class="lineno">15</span><span class="comment" id="3500961">//</span><br>
<span class="lineno"></span><span class="comment" id="3500964">//&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;:=&nbsp;p.Next()&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;take&nbsp;a&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="3500999">//</span><br>
<span class="lineno"></span><span class="comment" id="3501002">//&nbsp;&nbsp;&nbsp;&nbsp;p.StartRequest(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;send&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3501057">//&nbsp;&nbsp;&nbsp;&nbsp;«send&nbsp;request»</span><br>
<span class="lineno">20</span><span class="comment" id="3501077">//&nbsp;&nbsp;&nbsp;&nbsp;p.EndRequest(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;request&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="3501137">//</span><br>
<span class="lineno"></span><span class="comment" id="3501140">//&nbsp;&nbsp;&nbsp;&nbsp;p.StartResponse(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;read&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3501197">//&nbsp;&nbsp;&nbsp;&nbsp;«read&nbsp;response»</span><br>
<span class="lineno"></span><span class="comment" id="3501218">//&nbsp;&nbsp;&nbsp;&nbsp;p.EndResponse(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;response&nbsp;is&nbsp;read</span><br>
<span class="lineno">25</span><span class="comment" id="3501280">//</span><br>
<span class="lineno"></span><span class="comment" id="3501283">//&nbsp;A&nbsp;pipelined&nbsp;server&nbsp;can&nbsp;use&nbsp;the&nbsp;same&nbsp;calls&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3501343">//&nbsp;responses&nbsp;computed&nbsp;in&nbsp;parallel&nbsp;are&nbsp;written&nbsp;in&nbsp;the&nbsp;correct&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="3501411">type</span>&nbsp;<span class="ident" id="3501416">Pipeline</span>&nbsp;<span class="keyword" id="3501425">struct</span>&nbsp;<span class="op" id="3501432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501435">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501444">sync</span><span class="op" id="3501448">.</span><span class="ident" id="3501449">Mutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501456">id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3501465">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501471">request</span>&nbsp;&nbsp;<span class="ident" id="3501480">sequencer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501491">response</span>&nbsp;<span class="ident" id="3501500">sequencer</span><br>
<span class="lineno"></span><span class="op" id="3501510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3501513">//&nbsp;Next&nbsp;returns&nbsp;the&nbsp;next&nbsp;id&nbsp;for&nbsp;a&nbsp;request/response&nbsp;pair.</span><br>
<span class="lineno"></span><span class="keyword" id="3501570">func</span>&nbsp;<span class="op" id="3501575">(</span><span class="ident" id="3501576">p</span>&nbsp;<span class="op" id="3501578">*</span><span class="ident" id="3501579">Pipeline</span><span class="op" id="3501587">)</span>&nbsp;<span class="ident" id="3501589">Next</span><span class="op" id="3501593">(</span><span class="op" id="3501594">)</span>&nbsp;<span class="builtintype" id="3501596">uint</span>&nbsp;<span class="op" id="3501601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501604">p</span><span class="op" id="3501605">.</span><span class="ident" id="3501606">mu</span><span class="op" id="3501608">.</span><span class="ident" id="3501609">Lock</span><span class="op" id="3501613">(</span><span class="op" id="3501614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501617">id</span>&nbsp;<span class="op" id="3501620">:=</span>&nbsp;<span class="ident" id="3501623">p</span><span class="op" id="3501624">.</span><span class="ident" id="3501625">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501629">p</span><span class="op" id="3501630">.</span><span class="ident" id="3501631">id</span><span class="op" id="3501633">++</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501637">p</span><span class="op" id="3501638">.</span><span class="ident" id="3501639">mu</span><span class="op" id="3501641">.</span><span class="ident" id="3501642">Unlock</span><span class="op" id="3501648">(</span><span class="op" id="3501649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3501652">return</span>&nbsp;<span class="ident" id="3501659">id</span><br>
<span class="lineno"></span><span class="op" id="3501662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3501665">//&nbsp;StartRequest&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;send&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;receive)</span><br>
<span class="lineno">45</span><span class="comment" id="3501748">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="3501782">func</span>&nbsp;<span class="op" id="3501787">(</span><span class="ident" id="3501788">p</span>&nbsp;<span class="op" id="3501790">*</span><span class="ident" id="3501791">Pipeline</span><span class="op" id="3501799">)</span>&nbsp;<span class="ident" id="3501801">StartRequest</span><span class="op" id="3501813">(</span><span class="ident" id="3501814">id</span>&nbsp;<span class="builtintype" id="3501817">uint</span><span class="op" id="3501821">)</span>&nbsp;<span class="op" id="3501823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3501826">p</span><span class="op" id="3501827">.</span><span class="ident" id="3501828">request</span><span class="op" id="3501835">.</span><span class="ident" id="3501836">Start</span><span class="op" id="3501841">(</span><span class="ident" id="3501842">id</span><span class="op" id="3501844">)</span><br>
<span class="lineno"></span><span class="op" id="3501846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3501849">//&nbsp;EndRequest&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="3501923">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;received).</span><br>
<span class="lineno"></span><span class="keyword" id="3501963">func</span>&nbsp;<span class="op" id="3501968">(</span><span class="ident" id="3501969">p</span>&nbsp;<span class="op" id="3501971">*</span><span class="ident" id="3501972">Pipeline</span><span class="op" id="3501980">)</span>&nbsp;<span class="ident" id="3501982">EndRequest</span><span class="op" id="3501992">(</span><span class="ident" id="3501993">id</span>&nbsp;<span class="builtintype" id="3501996">uint</span><span class="op" id="3502000">)</span>&nbsp;<span class="op" id="3502002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502005">p</span><span class="op" id="3502006">.</span><span class="ident" id="3502007">request</span><span class="op" id="3502014">.</span><span class="ident" id="3502015">End</span><span class="op" id="3502018">(</span><span class="ident" id="3502019">id</span><span class="op" id="3502021">)</span><br>
<span class="lineno"></span><span class="op" id="3502023">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="3502026">//&nbsp;StartResponse&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;receive&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;send)</span><br>
<span class="lineno"></span><span class="comment" id="3502110">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="3502144">func</span>&nbsp;<span class="op" id="3502149">(</span><span class="ident" id="3502150">p</span>&nbsp;<span class="op" id="3502152">*</span><span class="ident" id="3502153">Pipeline</span><span class="op" id="3502161">)</span>&nbsp;<span class="ident" id="3502163">StartResponse</span><span class="op" id="3502176">(</span><span class="ident" id="3502177">id</span>&nbsp;<span class="builtintype" id="3502180">uint</span><span class="op" id="3502184">)</span>&nbsp;<span class="op" id="3502186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502189">p</span><span class="op" id="3502190">.</span><span class="ident" id="3502191">response</span><span class="op" id="3502199">.</span><span class="ident" id="3502200">Start</span><span class="op" id="3502205">(</span><span class="ident" id="3502206">id</span><span class="op" id="3502208">)</span><br>
<span class="lineno">60</span><span class="op" id="3502210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3502213">//&nbsp;EndResponse&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;response&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;received</span><br>
<span class="lineno"></span><span class="comment" id="3502293">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;sent).</span><br>
<span class="lineno"></span><span class="keyword" id="3502329">func</span>&nbsp;<span class="op" id="3502334">(</span><span class="ident" id="3502335">p</span>&nbsp;<span class="op" id="3502337">*</span><span class="ident" id="3502338">Pipeline</span><span class="op" id="3502346">)</span>&nbsp;<span class="ident" id="3502348">EndResponse</span><span class="op" id="3502359">(</span><span class="ident" id="3502360">id</span>&nbsp;<span class="builtintype" id="3502363">uint</span><span class="op" id="3502367">)</span>&nbsp;<span class="op" id="3502369">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502372">p</span><span class="op" id="3502373">.</span><span class="ident" id="3502374">response</span><span class="op" id="3502382">.</span><span class="ident" id="3502383">End</span><span class="op" id="3502386">(</span><span class="ident" id="3502387">id</span><span class="op" id="3502389">)</span><br>
<span class="lineno"></span><span class="op" id="3502391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3502394">//&nbsp;A&nbsp;sequencer&nbsp;schedules&nbsp;a&nbsp;sequence&nbsp;of&nbsp;numbered&nbsp;events&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="3502459">//&nbsp;happen&nbsp;in&nbsp;order,&nbsp;one&nbsp;after&nbsp;the&nbsp;other.&nbsp;&nbsp;The&nbsp;event&nbsp;numbering&nbsp;must&nbsp;start</span><br>
<span class="lineno">70</span><span class="comment" id="3502532">//&nbsp;at&nbsp;0&nbsp;and&nbsp;increment&nbsp;without&nbsp;skipping.&nbsp;&nbsp;The&nbsp;event&nbsp;number&nbsp;wraps&nbsp;around</span><br>
<span class="lineno"></span><span class="comment" id="3502603">//&nbsp;safely&nbsp;as&nbsp;long&nbsp;as&nbsp;there&nbsp;are&nbsp;not&nbsp;2^32&nbsp;simultaneous&nbsp;events&nbsp;pending.</span><br>
<span class="lineno"></span><span class="keyword" id="3502672">type</span>&nbsp;<span class="ident" id="3502677">sequencer</span>&nbsp;<span class="keyword" id="3502687">struct</span>&nbsp;<span class="op" id="3502694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502697">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3502702">sync</span><span class="op" id="3502706">.</span><span class="ident" id="3502707">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502714">id</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3502719">uint</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502725">wait</span>&nbsp;<span class="keyword" id="3502730">map</span><span class="op" id="3502733">[</span><span class="builtintype" id="3502734">uint</span><span class="op" id="3502738">]</span><span class="keyword" id="3502739">chan</span>&nbsp;<span class="builtintype" id="3502744">uint</span><br>
<span class="lineno"></span><span class="op" id="3502749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3502752">//&nbsp;Start&nbsp;waits&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;for&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;to&nbsp;begin.</span><br>
<span class="lineno"></span><span class="comment" id="3502820">//&nbsp;That&nbsp;is,&nbsp;except&nbsp;for&nbsp;the&nbsp;first&nbsp;event,&nbsp;it&nbsp;waits&nbsp;until&nbsp;End(id-1)&nbsp;has</span><br>
<span class="lineno">80</span><span class="comment" id="3502889">//&nbsp;been&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="3502905">func</span>&nbsp;<span class="op" id="3502910">(</span><span class="ident" id="3502911">s</span>&nbsp;<span class="op" id="3502913">*</span><span class="ident" id="3502914">sequencer</span><span class="op" id="3502923">)</span>&nbsp;<span class="ident" id="3502925">Start</span><span class="op" id="3502930">(</span><span class="ident" id="3502931">id</span>&nbsp;<span class="builtintype" id="3502934">uint</span><span class="op" id="3502938">)</span>&nbsp;<span class="op" id="3502940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502943">s</span><span class="op" id="3502944">.</span><span class="ident" id="3502945">mu</span><span class="op" id="3502947">.</span><span class="ident" id="3502948">Lock</span><span class="op" id="3502952">(</span><span class="op" id="3502953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502956">if</span>&nbsp;<span class="ident" id="3502959">s</span><span class="op" id="3502960">.</span><span class="ident" id="3502961">id</span>&nbsp;<span class="op" id="3502964">==</span>&nbsp;<span class="ident" id="3502967">id</span>&nbsp;<span class="op" id="3502970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3502974">s</span><span class="op" id="3502975">.</span><span class="ident" id="3502976">mu</span><span class="op" id="3502978">.</span><span class="ident" id="3502979">Unlock</span><span class="op" id="3502985">(</span><span class="op" id="3502986">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3502990">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3502998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503001">c</span>&nbsp;<span class="op" id="3503003">:=</span>&nbsp;<span class="builtinfunc" id="3503006">make</span><span class="op" id="3503010">(</span><span class="keyword" id="3503011">chan</span>&nbsp;<span class="builtintype" id="3503016">uint</span><span class="op" id="3503020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3503023">if</span>&nbsp;<span class="ident" id="3503026">s</span><span class="op" id="3503027">.</span><span class="ident" id="3503028">wait</span>&nbsp;<span class="op" id="3503033">==</span>&nbsp;<span class="builtintype" id="3503036">nil</span>&nbsp;<span class="op" id="3503040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503044">s</span><span class="op" id="3503045">.</span><span class="ident" id="3503046">wait</span>&nbsp;<span class="op" id="3503051">=</span>&nbsp;<span class="builtinfunc" id="3503053">make</span><span class="op" id="3503057">(</span><span class="keyword" id="3503058">map</span><span class="op" id="3503061">[</span><span class="builtintype" id="3503062">uint</span><span class="op" id="3503066">]</span><span class="keyword" id="3503067">chan</span>&nbsp;<span class="builtintype" id="3503072">uint</span><span class="op" id="3503076">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3503079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503082">s</span><span class="op" id="3503083">.</span><span class="ident" id="3503084">wait</span><span class="op" id="3503088">[</span><span class="ident" id="3503089">id</span><span class="op" id="3503091">]</span>&nbsp;<span class="op" id="3503093">=</span>&nbsp;<span class="ident" id="3503095">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503098">s</span><span class="op" id="3503099">.</span><span class="ident" id="3503100">mu</span><span class="op" id="3503102">.</span><span class="ident" id="3503103">Unlock</span><span class="op" id="3503109">(</span><span class="op" id="3503110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3503113">&lt;-</span><span class="ident" id="3503115">c</span><br>
<span class="lineno"></span><span class="op" id="3503117">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="3503120">//&nbsp;End&nbsp;notifies&nbsp;the&nbsp;sequencer&nbsp;that&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;has&nbsp;completed,</span><br>
<span class="lineno"></span><span class="comment" id="3503192">//&nbsp;allowing&nbsp;it&nbsp;to&nbsp;schedule&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id+1.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3503268">//&nbsp;to&nbsp;call&nbsp;End&nbsp;with&nbsp;an&nbsp;id&nbsp;that&nbsp;is&nbsp;not&nbsp;the&nbsp;number&nbsp;of&nbsp;the&nbsp;active&nbsp;event.</span><br>
<span class="lineno"></span><span class="keyword" id="3503338">func</span>&nbsp;<span class="op" id="3503343">(</span><span class="ident" id="3503344">s</span>&nbsp;<span class="op" id="3503346">*</span><span class="ident" id="3503347">sequencer</span><span class="op" id="3503356">)</span>&nbsp;<span class="ident" id="3503358">End</span><span class="op" id="3503361">(</span><span class="ident" id="3503362">id</span>&nbsp;<span class="builtintype" id="3503365">uint</span><span class="op" id="3503369">)</span>&nbsp;<span class="op" id="3503371">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503374">s</span><span class="op" id="3503375">.</span><span class="ident" id="3503376">mu</span><span class="op" id="3503378">.</span><span class="ident" id="3503379">Lock</span><span class="op" id="3503383">(</span><span class="op" id="3503384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3503387">if</span>&nbsp;<span class="ident" id="3503390">s</span><span class="op" id="3503391">.</span><span class="ident" id="3503392">id</span>&nbsp;<span class="op" id="3503395">!=</span>&nbsp;<span class="ident" id="3503398">id</span>&nbsp;<span class="op" id="3503401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3503405">panic</span><span class="op" id="3503410">(</span><span class="string" id="3503411">&#34;out&nbsp;of&nbsp;sync&#34;</span><span class="op" id="3503424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3503427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503430">id</span><span class="op" id="3503432">++</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503436">s</span><span class="op" id="3503437">.</span><span class="ident" id="3503438">id</span>&nbsp;<span class="op" id="3503441">=</span>&nbsp;<span class="ident" id="3503443">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3503447">if</span>&nbsp;<span class="ident" id="3503450">s</span><span class="op" id="3503451">.</span><span class="ident" id="3503452">wait</span>&nbsp;<span class="op" id="3503457">==</span>&nbsp;<span class="builtintype" id="3503460">nil</span>&nbsp;<span class="op" id="3503464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503468">s</span><span class="op" id="3503469">.</span><span class="ident" id="3503470">wait</span>&nbsp;<span class="op" id="3503475">=</span>&nbsp;<span class="builtinfunc" id="3503477">make</span><span class="op" id="3503481">(</span><span class="keyword" id="3503482">map</span><span class="op" id="3503485">[</span><span class="builtintype" id="3503486">uint</span><span class="op" id="3503490">]</span><span class="keyword" id="3503491">chan</span>&nbsp;<span class="builtintype" id="3503496">uint</span><span class="op" id="3503500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3503503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503506">c</span><span class="op" id="3503507">,</span>&nbsp;<span class="ident" id="3503509">ok</span>&nbsp;<span class="op" id="3503512">:=</span>&nbsp;<span class="ident" id="3503515">s</span><span class="op" id="3503516">.</span><span class="ident" id="3503517">wait</span><span class="op" id="3503521">[</span><span class="ident" id="3503522">id</span><span class="op" id="3503524">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3503527">if</span>&nbsp;<span class="ident" id="3503530">ok</span>&nbsp;<span class="op" id="3503533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3503537">delete</span><span class="op" id="3503543">(</span><span class="ident" id="3503544">s</span><span class="op" id="3503545">.</span><span class="ident" id="3503546">wait</span><span class="op" id="3503550">,</span>&nbsp;<span class="ident" id="3503552">id</span><span class="op" id="3503554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3503557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503560">s</span><span class="op" id="3503561">.</span><span class="ident" id="3503562">mu</span><span class="op" id="3503564">.</span><span class="ident" id="3503565">Unlock</span><span class="op" id="3503571">(</span><span class="op" id="3503572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3503575">if</span>&nbsp;<span class="ident" id="3503578">ok</span>&nbsp;<span class="op" id="3503581">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3503585">c</span>&nbsp;<span class="op" id="3503587">&lt;-</span>&nbsp;<span class="num" id="3503590">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3503593">}</span><br>
<span class="lineno"></span><span class="op" id="3503595">}</span>
</div>
</body>
</html>
