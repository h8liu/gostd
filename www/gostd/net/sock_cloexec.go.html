<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html" class="current">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3163630">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3163685">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3163739">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3163790">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;sysSocket&nbsp;and&nbsp;accept&nbsp;for&nbsp;platforms&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3163854">//&nbsp;provide&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;setting&nbsp;SetNonblock&nbsp;and&nbsp;CloseOnExec.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3163919">//&nbsp;+build&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="3163944">package</span>&nbsp;<span class="ident" id="3163952">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3163957">import</span>&nbsp;<span class="string" id="3163964">&#34;syscall&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3163975">//&nbsp;Wrapper&nbsp;around&nbsp;the&nbsp;socket&nbsp;system&nbsp;call&nbsp;that&nbsp;marks&nbsp;the&nbsp;returned&nbsp;file</span><br>
<span class="lineno">15</span><span class="comment" id="3164045">//&nbsp;descriptor&nbsp;as&nbsp;nonblocking&nbsp;and&nbsp;close-on-exec.</span><br>
<span class="lineno"></span><span class="keyword" id="3164093">func</span>&nbsp;<span class="ident" id="3164098">sysSocket</span><span class="op" id="3164107">(</span><span class="ident" id="3164108">family</span><span class="op" id="3164114">,</span>&nbsp;<span class="ident" id="3164116">sotype</span><span class="op" id="3164122">,</span>&nbsp;<span class="ident" id="3164124">proto</span>&nbsp;<span class="builtintype" id="3164130">int</span><span class="op" id="3164133">)</span>&nbsp;<span class="op" id="3164135">(</span><span class="builtintype" id="3164136">int</span><span class="op" id="3164139">,</span>&nbsp;<span class="builtintype" id="3164141">error</span><span class="op" id="3164146">)</span>&nbsp;<span class="op" id="3164148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3164151">s</span><span class="op" id="3164152">,</span>&nbsp;<span class="ident" id="3164154">err</span>&nbsp;<span class="op" id="3164158">:=</span>&nbsp;<span class="ident" id="3164161">syscall</span><span class="op" id="3164168">.</span><span class="ident" id="3164169">Socket</span><span class="op" id="3164175">(</span><span class="ident" id="3164176">family</span><span class="op" id="3164182">,</span>&nbsp;<span class="ident" id="3164184">sotype</span><span class="op" id="3164190">|</span><span class="ident" id="3164191">syscall</span><span class="op" id="3164198">.</span><span class="ident" id="3164199">SOCK_NONBLOCK</span><span class="op" id="3164212">|</span><span class="ident" id="3164213">syscall</span><span class="op" id="3164220">.</span><span class="ident" id="3164221">SOCK_CLOEXEC</span><span class="op" id="3164233">,</span>&nbsp;<span class="ident" id="3164235">proto</span><span class="op" id="3164240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3164243">//&nbsp;On&nbsp;Linux&nbsp;the&nbsp;SOCK_NONBLOCK&nbsp;and&nbsp;SOCK_CLOEXEC&nbsp;flags&nbsp;were</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3164302">//&nbsp;introduced&nbsp;in&nbsp;2.6.27&nbsp;kernel&nbsp;and&nbsp;on&nbsp;FreeBSD&nbsp;both&nbsp;flags&nbsp;were</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3164365">//&nbsp;introduced&nbsp;in&nbsp;10&nbsp;kernel.&nbsp;If&nbsp;we&nbsp;get&nbsp;an&nbsp;EINVAL&nbsp;error&nbsp;on&nbsp;Linux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3164429">//&nbsp;or&nbsp;EPROTONOSUPPORT&nbsp;error&nbsp;on&nbsp;FreeBSD,&nbsp;fall&nbsp;back&nbsp;to&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3164489">//&nbsp;socket&nbsp;without&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3164514">if</span>&nbsp;<span class="ident" id="3164517">err</span>&nbsp;<span class="op" id="3164521">==</span>&nbsp;<span class="ident" id="3164524">nil</span>&nbsp;<span class="op" id="3164528">||</span>&nbsp;<span class="op" id="3164531">(</span><span class="ident" id="3164532">err</span>&nbsp;<span class="op" id="3164536">!=</span>&nbsp;<span class="ident" id="3164539">syscall</span><span class="op" id="3164546">.</span><span class="ident" id="3164547">EPROTONOSUPPORT</span>&nbsp;<span class="op" id="3164563">&amp;&amp;</span>&nbsp;<span class="ident" id="3164566">err</span>&nbsp;<span class="op" id="3164570">!=</span>&nbsp;<span class="ident" id="3164573">syscall</span><span class="op" id="3164580">.</span><span class="ident" id="3164581">EINVAL</span><span class="op" id="3164587">)</span>&nbsp;<span class="op" id="3164589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3164593">return</span>&nbsp;<span class="ident" id="3164600">s</span><span class="op" id="3164601">,</span>&nbsp;<span class="ident" id="3164603">err</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3164608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3164612">//&nbsp;See&nbsp;../syscall/exec_unix.go&nbsp;for&nbsp;description&nbsp;of&nbsp;ForkLock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3164673">syscall</span><span class="op" id="3164680">.</span><span class="ident" id="3164681">ForkLock</span><span class="op" id="3164689">.</span><span class="ident" id="3164690">RLock</span><span class="op" id="3164695">(</span><span class="op" id="3164696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3164699">s</span><span class="op" id="3164700">,</span>&nbsp;<span class="ident" id="3164702">err</span>&nbsp;<span class="op" id="3164706">=</span>&nbsp;<span class="ident" id="3164708">syscall</span><span class="op" id="3164715">.</span><span class="ident" id="3164716">Socket</span><span class="op" id="3164722">(</span><span class="ident" id="3164723">family</span><span class="op" id="3164729">,</span>&nbsp;<span class="ident" id="3164731">sotype</span><span class="op" id="3164737">,</span>&nbsp;<span class="ident" id="3164739">proto</span><span class="op" id="3164744">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3164747">if</span>&nbsp;<span class="ident" id="3164750">err</span>&nbsp;<span class="op" id="3164754">==</span>&nbsp;<span class="ident" id="3164757">nil</span>&nbsp;<span class="op" id="3164761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3164765">syscall</span><span class="op" id="3164772">.</span><span class="ident" id="3164773">CloseOnExec</span><span class="op" id="3164784">(</span><span class="ident" id="3164785">s</span><span class="op" id="3164786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3164789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3164792">syscall</span><span class="op" id="3164799">.</span><span class="ident" id="3164800">ForkLock</span><span class="op" id="3164808">.</span><span class="ident" id="3164809">RUnlock</span><span class="op" id="3164816">(</span><span class="op" id="3164817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3164820">if</span>&nbsp;<span class="ident" id="3164823">err</span>&nbsp;<span class="op" id="3164827">!=</span>&nbsp;<span class="ident" id="3164830">nil</span>&nbsp;<span class="op" id="3164834">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3164838">return</span>&nbsp;<span class="op" id="3164845">-</span><span class="num" id="3164846">1</span><span class="op" id="3164847">,</span>&nbsp;<span class="ident" id="3164849">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3164854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3164857">if</span>&nbsp;<span class="ident" id="3164860">err</span>&nbsp;<span class="op" id="3164864">=</span>&nbsp;<span class="ident" id="3164866">syscall</span><span class="op" id="3164873">.</span><span class="ident" id="3164874">SetNonblock</span><span class="op" id="3164885">(</span><span class="ident" id="3164886">s</span><span class="op" id="3164887">,</span>&nbsp;<span class="builtintype" id="3164889">true</span><span class="op" id="3164893">)</span><span class="op" id="3164894">;</span>&nbsp;<span class="ident" id="3164896">err</span>&nbsp;<span class="op" id="3164900">!=</span>&nbsp;<span class="ident" id="3164903">nil</span>&nbsp;<span class="op" id="3164907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3164911">syscall</span><span class="op" id="3164918">.</span><span class="ident" id="3164919">Close</span><span class="op" id="3164924">(</span><span class="ident" id="3164925">s</span><span class="op" id="3164926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3164930">return</span>&nbsp;<span class="op" id="3164937">-</span><span class="num" id="3164938">1</span><span class="op" id="3164939">,</span>&nbsp;<span class="ident" id="3164941">err</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3164946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3164949">return</span>&nbsp;<span class="ident" id="3164956">s</span><span class="op" id="3164957">,</span>&nbsp;<span class="ident" id="3164959">nil</span><br>
<span class="lineno"></span><span class="op" id="3164963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3164966">//&nbsp;Wrapper&nbsp;around&nbsp;the&nbsp;accept&nbsp;system&nbsp;call&nbsp;that&nbsp;marks&nbsp;the&nbsp;returned&nbsp;file</span><br>
<span class="lineno">45</span><span class="comment" id="3165036">//&nbsp;descriptor&nbsp;as&nbsp;nonblocking&nbsp;and&nbsp;close-on-exec.</span><br>
<span class="lineno"></span><span class="keyword" id="3165084">func</span>&nbsp;<span class="ident" id="3165089">accept</span><span class="op" id="3165095">(</span><span class="ident" id="3165096">s</span>&nbsp;<span class="builtintype" id="3165098">int</span><span class="op" id="3165101">)</span>&nbsp;<span class="op" id="3165103">(</span><span class="builtintype" id="3165104">int</span><span class="op" id="3165107">,</span>&nbsp;<span class="ident" id="3165109">syscall</span><span class="op" id="3165116">.</span><span class="ident" id="3165117">Sockaddr</span><span class="op" id="3165125">,</span>&nbsp;<span class="builtintype" id="3165127">error</span><span class="op" id="3165132">)</span>&nbsp;<span class="op" id="3165134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3165137">ns</span><span class="op" id="3165139">,</span>&nbsp;<span class="ident" id="3165141">sa</span><span class="op" id="3165143">,</span>&nbsp;<span class="ident" id="3165145">err</span>&nbsp;<span class="op" id="3165149">:=</span>&nbsp;<span class="ident" id="3165152">syscall</span><span class="op" id="3165159">.</span><span class="ident" id="3165160">Accept4</span><span class="op" id="3165167">(</span><span class="ident" id="3165168">s</span><span class="op" id="3165169">,</span>&nbsp;<span class="ident" id="3165171">syscall</span><span class="op" id="3165178">.</span><span class="ident" id="3165179">SOCK_NONBLOCK</span><span class="op" id="3165192">|</span><span class="ident" id="3165193">syscall</span><span class="op" id="3165200">.</span><span class="ident" id="3165201">SOCK_CLOEXEC</span><span class="op" id="3165213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3165216">//&nbsp;On&nbsp;Linux&nbsp;the&nbsp;accept4&nbsp;system&nbsp;call&nbsp;was&nbsp;introduced&nbsp;in&nbsp;2.6.28</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3165278">//&nbsp;kernel&nbsp;and&nbsp;on&nbsp;FreeBSD&nbsp;it&nbsp;was&nbsp;introduced&nbsp;in&nbsp;10&nbsp;kernel.&nbsp;If&nbsp;we</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3165342">//&nbsp;get&nbsp;an&nbsp;ENOSYS&nbsp;error&nbsp;on&nbsp;both&nbsp;Linux&nbsp;and&nbsp;FreeBSD,&nbsp;or&nbsp;EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3165403">//&nbsp;error&nbsp;on&nbsp;Linux,&nbsp;fall&nbsp;back&nbsp;to&nbsp;using&nbsp;accept.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3165450">switch</span>&nbsp;<span class="ident" id="3165457">err</span>&nbsp;<span class="op" id="3165461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3165464">default</span><span class="op" id="3165471">:</span>&nbsp;<span class="comment" id="3165473">//&nbsp;nil&nbsp;and&nbsp;errors&nbsp;other&nbsp;than&nbsp;the&nbsp;ones&nbsp;listed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3165520">return</span>&nbsp;<span class="ident" id="3165527">ns</span><span class="op" id="3165529">,</span>&nbsp;<span class="ident" id="3165531">sa</span><span class="op" id="3165533">,</span>&nbsp;<span class="ident" id="3165535">err</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3165540">case</span>&nbsp;<span class="ident" id="3165545">syscall</span><span class="op" id="3165552">.</span><span class="ident" id="3165553">ENOSYS</span><span class="op" id="3165559">:</span>&nbsp;<span class="comment" id="3165561">//&nbsp;syscall&nbsp;missing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3165581">case</span>&nbsp;<span class="ident" id="3165586">syscall</span><span class="op" id="3165593">.</span><span class="ident" id="3165594">EINVAL</span><span class="op" id="3165600">:</span>&nbsp;<span class="comment" id="3165602">//&nbsp;some&nbsp;Linux&nbsp;use&nbsp;this&nbsp;instead&nbsp;of&nbsp;ENOSYS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3165644">case</span>&nbsp;<span class="ident" id="3165649">syscall</span><span class="op" id="3165656">.</span><span class="ident" id="3165657">EACCES</span><span class="op" id="3165663">:</span>&nbsp;<span class="comment" id="3165665">//&nbsp;some&nbsp;Linux&nbsp;use&nbsp;this&nbsp;instead&nbsp;of&nbsp;ENOSYS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3165707">case</span>&nbsp;<span class="ident" id="3165712">syscall</span><span class="op" id="3165719">.</span><span class="ident" id="3165720">EFAULT</span><span class="op" id="3165726">:</span>&nbsp;<span class="comment" id="3165728">//&nbsp;some&nbsp;Linux&nbsp;use&nbsp;this&nbsp;instead&nbsp;of&nbsp;ENOSYS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3165770">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3165774">//&nbsp;See&nbsp;../syscall/exec_unix.go&nbsp;for&nbsp;description&nbsp;of&nbsp;ForkLock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3165835">//&nbsp;It&nbsp;is&nbsp;probably&nbsp;okay&nbsp;to&nbsp;hold&nbsp;the&nbsp;lock&nbsp;across&nbsp;syscall.Accept</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3165898">//&nbsp;because&nbsp;we&nbsp;have&nbsp;put&nbsp;fd.sysfd&nbsp;into&nbsp;non-blocking&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3165955">//&nbsp;However,&nbsp;a&nbsp;call&nbsp;to&nbsp;the&nbsp;File&nbsp;method&nbsp;will&nbsp;put&nbsp;it&nbsp;back&nbsp;into</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3166016">//&nbsp;blocking&nbsp;mode.&nbsp;We&nbsp;can&#39;t&nbsp;take&nbsp;that&nbsp;risk,&nbsp;so&nbsp;no&nbsp;use&nbsp;of&nbsp;ForkLock&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3166088">ns</span><span class="op" id="3166090">,</span>&nbsp;<span class="ident" id="3166092">sa</span><span class="op" id="3166094">,</span>&nbsp;<span class="ident" id="3166096">err</span>&nbsp;<span class="op" id="3166100">=</span>&nbsp;<span class="ident" id="3166102">syscall</span><span class="op" id="3166109">.</span><span class="ident" id="3166110">Accept</span><span class="op" id="3166116">(</span><span class="ident" id="3166117">s</span><span class="op" id="3166118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3166121">if</span>&nbsp;<span class="ident" id="3166124">err</span>&nbsp;<span class="op" id="3166128">==</span>&nbsp;<span class="ident" id="3166131">nil</span>&nbsp;<span class="op" id="3166135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3166139">syscall</span><span class="op" id="3166146">.</span><span class="ident" id="3166147">CloseOnExec</span><span class="op" id="3166158">(</span><span class="ident" id="3166159">ns</span><span class="op" id="3166161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3166164">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3166167">if</span>&nbsp;<span class="ident" id="3166170">err</span>&nbsp;<span class="op" id="3166174">!=</span>&nbsp;<span class="ident" id="3166177">nil</span>&nbsp;<span class="op" id="3166181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3166185">return</span>&nbsp;<span class="op" id="3166192">-</span><span class="num" id="3166193">1</span><span class="op" id="3166194">,</span>&nbsp;<span class="ident" id="3166196">nil</span><span class="op" id="3166199">,</span>&nbsp;<span class="ident" id="3166201">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3166206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3166209">if</span>&nbsp;<span class="ident" id="3166212">err</span>&nbsp;<span class="op" id="3166216">=</span>&nbsp;<span class="ident" id="3166218">syscall</span><span class="op" id="3166225">.</span><span class="ident" id="3166226">SetNonblock</span><span class="op" id="3166237">(</span><span class="ident" id="3166238">ns</span><span class="op" id="3166240">,</span>&nbsp;<span class="builtintype" id="3166242">true</span><span class="op" id="3166246">)</span><span class="op" id="3166247">;</span>&nbsp;<span class="ident" id="3166249">err</span>&nbsp;<span class="op" id="3166253">!=</span>&nbsp;<span class="ident" id="3166256">nil</span>&nbsp;<span class="op" id="3166260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3166264">syscall</span><span class="op" id="3166271">.</span><span class="ident" id="3166272">Close</span><span class="op" id="3166277">(</span><span class="ident" id="3166278">ns</span><span class="op" id="3166280">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3166284">return</span>&nbsp;<span class="op" id="3166291">-</span><span class="num" id="3166292">1</span><span class="op" id="3166293">,</span>&nbsp;<span class="ident" id="3166295">nil</span><span class="op" id="3166298">,</span>&nbsp;<span class="ident" id="3166300">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3166305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3166308">return</span>&nbsp;<span class="ident" id="3166315">ns</span><span class="op" id="3166317">,</span>&nbsp;<span class="ident" id="3166319">sa</span><span class="op" id="3166321">,</span>&nbsp;<span class="ident" id="3166323">nil</span><br>
<span class="lineno"></span><span class="op" id="3166327">}</span>
</div>
</body>
</html>
