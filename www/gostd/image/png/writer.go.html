<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/png</h2>
<ul>
<li><a href="/gostd/image/png/paeth.go.html">paeth.go</a></li>
<li><a href="/gostd/image/png/paeth_test.go.html">paeth_test.go</a></li>
<li><a href="/gostd/image/png/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/png/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/png/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/image/png/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6341667">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6341722">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6341776">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6341827">package</span>&nbsp;<span class="ident" id="6341835">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6341840">import</span>&nbsp;<span class="op" id="6341847">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341850">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341859">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341876">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341890">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341899">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341914">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6341920">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6341930">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6341933">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="6341976">type</span>&nbsp;<span class="ident" id="6341981">Encoder</span>&nbsp;<span class="keyword" id="6341989">struct</span>&nbsp;<span class="op" id="6341996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6341999">CompressionLevel</span>&nbsp;<span class="ident" id="6342016">CompressionLevel</span><br>
<span class="lineno">20</span><span class="op" id="6342033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6342036">type</span>&nbsp;<span class="ident" id="6342041">encoder</span>&nbsp;<span class="keyword" id="6342049">struct</span>&nbsp;<span class="op" id="6342056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342059">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6342066">*</span><span class="ident" id="6342067">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342076">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342083">io</span><span class="op" id="6342085">.</span><span class="ident" id="6342086">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342094">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342101">image</span><span class="op" id="6342106">.</span><span class="ident" id="6342107">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342114">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6342121">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342126">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6342133">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342140">header</span>&nbsp;<span class="op" id="6342147">[</span><span class="num" id="6342148">8</span><span class="op" id="6342149">]</span><span class="builtintype" id="6342150">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342156">footer</span>&nbsp;<span class="op" id="6342163">[</span><span class="num" id="6342164">4</span><span class="op" id="6342165">]</span><span class="builtintype" id="6342166">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342172">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6342179">[</span><span class="num" id="6342180">4</span>&nbsp;<span class="op" id="6342182">*</span>&nbsp;<span class="num" id="6342184">256</span><span class="op" id="6342187">]</span><span class="builtintype" id="6342188">byte</span><br>
<span class="lineno"></span><span class="op" id="6342193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6342196">type</span>&nbsp;<span class="ident" id="6342201">CompressionLevel</span>&nbsp;<span class="builtintype" id="6342218">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="6342223">const</span>&nbsp;<span class="op" id="6342229">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342232">DefaultCompression</span>&nbsp;<span class="ident" id="6342251">CompressionLevel</span>&nbsp;<span class="op" id="6342268">=</span>&nbsp;<span class="num" id="6342270">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342273">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342292">CompressionLevel</span>&nbsp;<span class="op" id="6342309">=</span>&nbsp;<span class="op" id="6342311">-</span><span class="num" id="6342312">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342315">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342334">CompressionLevel</span>&nbsp;<span class="op" id="6342351">=</span>&nbsp;<span class="op" id="6342353">-</span><span class="num" id="6342354">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342357">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342376">CompressionLevel</span>&nbsp;<span class="op" id="6342393">=</span>&nbsp;<span class="op" id="6342395">-</span><span class="num" id="6342396">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6342400">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6342473">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="6342533">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="6342536">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="6342551">func</span>&nbsp;<span class="ident" id="6342556">writeUint32</span><span class="op" id="6342567">(</span><span class="ident" id="6342568">b</span>&nbsp;<span class="op" id="6342570">[</span><span class="op" id="6342571">]</span><span class="builtintype" id="6342572">uint8</span><span class="op" id="6342577">,</span>&nbsp;<span class="ident" id="6342579">u</span>&nbsp;<span class="builtintype" id="6342581">uint32</span><span class="op" id="6342587">)</span>&nbsp;<span class="op" id="6342589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342592">b</span><span class="op" id="6342593">[</span><span class="num" id="6342594">0</span><span class="op" id="6342595">]</span>&nbsp;<span class="op" id="6342597">=</span>&nbsp;<span class="builtintype" id="6342599">uint8</span><span class="op" id="6342604">(</span><span class="ident" id="6342605">u</span>&nbsp;<span class="op" id="6342607">&gt;&gt;</span>&nbsp;<span class="num" id="6342610">24</span><span class="op" id="6342612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342615">b</span><span class="op" id="6342616">[</span><span class="num" id="6342617">1</span><span class="op" id="6342618">]</span>&nbsp;<span class="op" id="6342620">=</span>&nbsp;<span class="builtintype" id="6342622">uint8</span><span class="op" id="6342627">(</span><span class="ident" id="6342628">u</span>&nbsp;<span class="op" id="6342630">&gt;&gt;</span>&nbsp;<span class="num" id="6342633">16</span><span class="op" id="6342635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342638">b</span><span class="op" id="6342639">[</span><span class="num" id="6342640">2</span><span class="op" id="6342641">]</span>&nbsp;<span class="op" id="6342643">=</span>&nbsp;<span class="builtintype" id="6342645">uint8</span><span class="op" id="6342650">(</span><span class="ident" id="6342651">u</span>&nbsp;<span class="op" id="6342653">&gt;&gt;</span>&nbsp;<span class="num" id="6342656">8</span><span class="op" id="6342657">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342660">b</span><span class="op" id="6342661">[</span><span class="num" id="6342662">3</span><span class="op" id="6342663">]</span>&nbsp;<span class="op" id="6342665">=</span>&nbsp;<span class="builtintype" id="6342667">uint8</span><span class="op" id="6342672">(</span><span class="ident" id="6342673">u</span>&nbsp;<span class="op" id="6342675">&gt;&gt;</span>&nbsp;<span class="num" id="6342678">0</span><span class="op" id="6342679">)</span><br>
<span class="lineno"></span><span class="op" id="6342681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6342684">type</span>&nbsp;<span class="ident" id="6342689">opaquer</span>&nbsp;<span class="keyword" id="6342697">interface</span>&nbsp;<span class="op" id="6342707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342710">Opaque</span><span class="op" id="6342716">(</span><span class="op" id="6342717">)</span>&nbsp;<span class="builtintype" id="6342719">bool</span><br>
<span class="lineno">55</span><span class="op" id="6342724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6342727">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="6342780">func</span>&nbsp;<span class="ident" id="6342785">opaque</span><span class="op" id="6342791">(</span><span class="ident" id="6342792">m</span>&nbsp;<span class="ident" id="6342794">image</span><span class="op" id="6342799">.</span><span class="ident" id="6342800">Image</span><span class="op" id="6342805">)</span>&nbsp;<span class="builtintype" id="6342807">bool</span>&nbsp;<span class="op" id="6342812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6342815">if</span>&nbsp;<span class="ident" id="6342818">o</span><span class="op" id="6342819">,</span>&nbsp;<span class="ident" id="6342821">ok</span>&nbsp;<span class="op" id="6342824">:=</span>&nbsp;<span class="ident" id="6342827">m</span><span class="op" id="6342828">.</span><span class="op" id="6342829">(</span><span class="ident" id="6342830">opaquer</span><span class="op" id="6342837">)</span><span class="op" id="6342838">;</span>&nbsp;<span class="ident" id="6342840">ok</span>&nbsp;<span class="op" id="6342843">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6342847">return</span>&nbsp;<span class="ident" id="6342854">o</span><span class="op" id="6342855">.</span><span class="ident" id="6342856">Opaque</span><span class="op" id="6342862">(</span><span class="op" id="6342863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6342866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342869">b</span>&nbsp;<span class="op" id="6342871">:=</span>&nbsp;<span class="ident" id="6342874">m</span><span class="op" id="6342875">.</span><span class="ident" id="6342876">Bounds</span><span class="op" id="6342882">(</span><span class="op" id="6342883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6342886">for</span>&nbsp;<span class="ident" id="6342890">y</span>&nbsp;<span class="op" id="6342892">:=</span>&nbsp;<span class="ident" id="6342895">b</span><span class="op" id="6342896">.</span><span class="ident" id="6342897">Min</span><span class="op" id="6342900">.</span><span class="ident" id="6342901">Y</span><span class="op" id="6342902">;</span>&nbsp;<span class="ident" id="6342904">y</span>&nbsp;<span class="op" id="6342906">&lt;</span>&nbsp;<span class="ident" id="6342908">b</span><span class="op" id="6342909">.</span><span class="ident" id="6342910">Max</span><span class="op" id="6342913">.</span><span class="ident" id="6342914">Y</span><span class="op" id="6342915">;</span>&nbsp;<span class="ident" id="6342917">y</span><span class="op" id="6342918">++</span>&nbsp;<span class="op" id="6342921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6342925">for</span>&nbsp;<span class="ident" id="6342929">x</span>&nbsp;<span class="op" id="6342931">:=</span>&nbsp;<span class="ident" id="6342934">b</span><span class="op" id="6342935">.</span><span class="ident" id="6342936">Min</span><span class="op" id="6342939">.</span><span class="ident" id="6342940">X</span><span class="op" id="6342941">;</span>&nbsp;<span class="ident" id="6342943">x</span>&nbsp;<span class="op" id="6342945">&lt;</span>&nbsp;<span class="ident" id="6342947">b</span><span class="op" id="6342948">.</span><span class="ident" id="6342949">Max</span><span class="op" id="6342952">.</span><span class="ident" id="6342953">X</span><span class="op" id="6342954">;</span>&nbsp;<span class="ident" id="6342956">x</span><span class="op" id="6342957">++</span>&nbsp;<span class="op" id="6342960">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6342965">_</span><span class="op" id="6342966">,</span>&nbsp;<span class="ident" id="6342968">_</span><span class="op" id="6342969">,</span>&nbsp;<span class="ident" id="6342971">_</span><span class="op" id="6342972">,</span>&nbsp;<span class="ident" id="6342974">a</span>&nbsp;<span class="op" id="6342976">:=</span>&nbsp;<span class="ident" id="6342979">m</span><span class="op" id="6342980">.</span><span class="ident" id="6342981">At</span><span class="op" id="6342983">(</span><span class="ident" id="6342984">x</span><span class="op" id="6342985">,</span>&nbsp;<span class="ident" id="6342987">y</span><span class="op" id="6342988">)</span><span class="op" id="6342989">.</span><span class="ident" id="6342990">RGBA</span><span class="op" id="6342994">(</span><span class="op" id="6342995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343000">if</span>&nbsp;<span class="ident" id="6343003">a</span>&nbsp;<span class="op" id="6343005">!=</span>&nbsp;<span class="num" id="6343008">0xffff</span>&nbsp;<span class="op" id="6343015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343021">return</span>&nbsp;<span class="builtintype" id="6343028">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6343037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6343041">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6343044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343047">return</span>&nbsp;<span class="builtintype" id="6343054">true</span><br>
<span class="lineno"></span><span class="op" id="6343059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6343062">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="6343124">func</span>&nbsp;<span class="ident" id="6343129">abs8</span><span class="op" id="6343133">(</span><span class="ident" id="6343134">d</span>&nbsp;<span class="builtintype" id="6343136">uint8</span><span class="op" id="6343141">)</span>&nbsp;<span class="builtintype" id="6343143">int</span>&nbsp;<span class="op" id="6343147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343150">if</span>&nbsp;<span class="ident" id="6343153">d</span>&nbsp;<span class="op" id="6343155">&lt;</span>&nbsp;<span class="num" id="6343157">128</span>&nbsp;<span class="op" id="6343161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343165">return</span>&nbsp;<span class="builtintype" id="6343172">int</span><span class="op" id="6343175">(</span><span class="ident" id="6343176">d</span><span class="op" id="6343177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6343180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343183">return</span>&nbsp;<span class="num" id="6343190">256</span>&nbsp;<span class="op" id="6343194">-</span>&nbsp;<span class="builtintype" id="6343196">int</span><span class="op" id="6343199">(</span><span class="ident" id="6343200">d</span><span class="op" id="6343201">)</span><br>
<span class="lineno">80</span><span class="op" id="6343203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6343206">func</span>&nbsp;<span class="op" id="6343211">(</span><span class="ident" id="6343212">e</span>&nbsp;<span class="op" id="6343214">*</span><span class="ident" id="6343215">encoder</span><span class="op" id="6343222">)</span>&nbsp;<span class="ident" id="6343224">writeChunk</span><span class="op" id="6343234">(</span><span class="ident" id="6343235">b</span>&nbsp;<span class="op" id="6343237">[</span><span class="op" id="6343238">]</span><span class="builtintype" id="6343239">byte</span><span class="op" id="6343243">,</span>&nbsp;<span class="ident" id="6343245">name</span>&nbsp;<span class="builtintype" id="6343250">string</span><span class="op" id="6343256">)</span>&nbsp;<span class="op" id="6343258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343261">if</span>&nbsp;<span class="ident" id="6343264">e</span><span class="op" id="6343265">.</span><span class="ident" id="6343266">err</span>&nbsp;<span class="op" id="6343270">!=</span>&nbsp;<span class="builtintype" id="6343273">nil</span>&nbsp;<span class="op" id="6343277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343281">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6343289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343292">n</span>&nbsp;<span class="op" id="6343294">:=</span>&nbsp;<span class="builtintype" id="6343297">uint32</span><span class="op" id="6343303">(</span><span class="builtinfunc" id="6343304">len</span><span class="op" id="6343307">(</span><span class="ident" id="6343308">b</span><span class="op" id="6343309">)</span><span class="op" id="6343310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343313">if</span>&nbsp;<span class="builtintype" id="6343316">int</span><span class="op" id="6343319">(</span><span class="ident" id="6343320">n</span><span class="op" id="6343321">)</span>&nbsp;<span class="op" id="6343323">!=</span>&nbsp;<span class="builtinfunc" id="6343326">len</span><span class="op" id="6343329">(</span><span class="ident" id="6343330">b</span><span class="op" id="6343331">)</span>&nbsp;<span class="op" id="6343333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343337">e</span><span class="op" id="6343338">.</span><span class="ident" id="6343339">err</span>&nbsp;<span class="op" id="6343343">=</span>&nbsp;<span class="ident" id="6343345">UnsupportedError</span><span class="op" id="6343361">(</span><span class="ident" id="6343362">name</span>&nbsp;<span class="op" id="6343367">+</span>&nbsp;<span class="string" id="6343369">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="6343393">+</span>&nbsp;<span class="ident" id="6343395">strconv</span><span class="op" id="6343402">.</span><span class="ident" id="6343403">Itoa</span><span class="op" id="6343407">(</span><span class="builtinfunc" id="6343408">len</span><span class="op" id="6343411">(</span><span class="ident" id="6343412">b</span><span class="op" id="6343413">)</span><span class="op" id="6343414">)</span><span class="op" id="6343415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343419">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6343427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343430">writeUint32</span><span class="op" id="6343441">(</span><span class="ident" id="6343442">e</span><span class="op" id="6343443">.</span><span class="ident" id="6343444">header</span><span class="op" id="6343450">[</span><span class="op" id="6343451">:</span><span class="num" id="6343452">4</span><span class="op" id="6343453">]</span><span class="op" id="6343454">,</span>&nbsp;<span class="ident" id="6343456">n</span><span class="op" id="6343457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343460">e</span><span class="op" id="6343461">.</span><span class="ident" id="6343462">header</span><span class="op" id="6343468">[</span><span class="num" id="6343469">4</span><span class="op" id="6343470">]</span>&nbsp;<span class="op" id="6343472">=</span>&nbsp;<span class="ident" id="6343474">name</span><span class="op" id="6343478">[</span><span class="num" id="6343479">0</span><span class="op" id="6343480">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343483">e</span><span class="op" id="6343484">.</span><span class="ident" id="6343485">header</span><span class="op" id="6343491">[</span><span class="num" id="6343492">5</span><span class="op" id="6343493">]</span>&nbsp;<span class="op" id="6343495">=</span>&nbsp;<span class="ident" id="6343497">name</span><span class="op" id="6343501">[</span><span class="num" id="6343502">1</span><span class="op" id="6343503">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343506">e</span><span class="op" id="6343507">.</span><span class="ident" id="6343508">header</span><span class="op" id="6343514">[</span><span class="num" id="6343515">6</span><span class="op" id="6343516">]</span>&nbsp;<span class="op" id="6343518">=</span>&nbsp;<span class="ident" id="6343520">name</span><span class="op" id="6343524">[</span><span class="num" id="6343525">2</span><span class="op" id="6343526">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343529">e</span><span class="op" id="6343530">.</span><span class="ident" id="6343531">header</span><span class="op" id="6343537">[</span><span class="num" id="6343538">7</span><span class="op" id="6343539">]</span>&nbsp;<span class="op" id="6343541">=</span>&nbsp;<span class="ident" id="6343543">name</span><span class="op" id="6343547">[</span><span class="num" id="6343548">3</span><span class="op" id="6343549">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343552">crc</span>&nbsp;<span class="op" id="6343556">:=</span>&nbsp;<span class="ident" id="6343559">crc32</span><span class="op" id="6343564">.</span><span class="ident" id="6343565">NewIEEE</span><span class="op" id="6343572">(</span><span class="op" id="6343573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343576">crc</span><span class="op" id="6343579">.</span><span class="ident" id="6343580">Write</span><span class="op" id="6343585">(</span><span class="ident" id="6343586">e</span><span class="op" id="6343587">.</span><span class="ident" id="6343588">header</span><span class="op" id="6343594">[</span><span class="num" id="6343595">4</span><span class="op" id="6343596">:</span><span class="num" id="6343597">8</span><span class="op" id="6343598">]</span><span class="op" id="6343599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343602">crc</span><span class="op" id="6343605">.</span><span class="ident" id="6343606">Write</span><span class="op" id="6343611">(</span><span class="ident" id="6343612">b</span><span class="op" id="6343613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343616">writeUint32</span><span class="op" id="6343627">(</span><span class="ident" id="6343628">e</span><span class="op" id="6343629">.</span><span class="ident" id="6343630">footer</span><span class="op" id="6343636">[</span><span class="op" id="6343637">:</span><span class="num" id="6343638">4</span><span class="op" id="6343639">]</span><span class="op" id="6343640">,</span>&nbsp;<span class="ident" id="6343642">crc</span><span class="op" id="6343645">.</span><span class="ident" id="6343646">Sum32</span><span class="op" id="6343651">(</span><span class="op" id="6343652">)</span><span class="op" id="6343653">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343657">_</span><span class="op" id="6343658">,</span>&nbsp;<span class="ident" id="6343660">e</span><span class="op" id="6343661">.</span><span class="ident" id="6343662">err</span>&nbsp;<span class="op" id="6343666">=</span>&nbsp;<span class="ident" id="6343668">e</span><span class="op" id="6343669">.</span><span class="ident" id="6343670">w</span><span class="op" id="6343671">.</span><span class="ident" id="6343672">Write</span><span class="op" id="6343677">(</span><span class="ident" id="6343678">e</span><span class="op" id="6343679">.</span><span class="ident" id="6343680">header</span><span class="op" id="6343686">[</span><span class="op" id="6343687">:</span><span class="num" id="6343688">8</span><span class="op" id="6343689">]</span><span class="op" id="6343690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343693">if</span>&nbsp;<span class="ident" id="6343696">e</span><span class="op" id="6343697">.</span><span class="ident" id="6343698">err</span>&nbsp;<span class="op" id="6343702">!=</span>&nbsp;<span class="builtintype" id="6343705">nil</span>&nbsp;<span class="op" id="6343709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343713">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6343721">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343724">_</span><span class="op" id="6343725">,</span>&nbsp;<span class="ident" id="6343727">e</span><span class="op" id="6343728">.</span><span class="ident" id="6343729">err</span>&nbsp;<span class="op" id="6343733">=</span>&nbsp;<span class="ident" id="6343735">e</span><span class="op" id="6343736">.</span><span class="ident" id="6343737">w</span><span class="op" id="6343738">.</span><span class="ident" id="6343739">Write</span><span class="op" id="6343744">(</span><span class="ident" id="6343745">b</span><span class="op" id="6343746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343749">if</span>&nbsp;<span class="ident" id="6343752">e</span><span class="op" id="6343753">.</span><span class="ident" id="6343754">err</span>&nbsp;<span class="op" id="6343758">!=</span>&nbsp;<span class="builtintype" id="6343761">nil</span>&nbsp;<span class="op" id="6343765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343769">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6343777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343780">_</span><span class="op" id="6343781">,</span>&nbsp;<span class="ident" id="6343783">e</span><span class="op" id="6343784">.</span><span class="ident" id="6343785">err</span>&nbsp;<span class="op" id="6343789">=</span>&nbsp;<span class="ident" id="6343791">e</span><span class="op" id="6343792">.</span><span class="ident" id="6343793">w</span><span class="op" id="6343794">.</span><span class="ident" id="6343795">Write</span><span class="op" id="6343800">(</span><span class="ident" id="6343801">e</span><span class="op" id="6343802">.</span><span class="ident" id="6343803">footer</span><span class="op" id="6343809">[</span><span class="op" id="6343810">:</span><span class="num" id="6343811">4</span><span class="op" id="6343812">]</span><span class="op" id="6343813">)</span><br>
<span class="lineno">110</span><span class="op" id="6343815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6343818">func</span>&nbsp;<span class="op" id="6343823">(</span><span class="ident" id="6343824">e</span>&nbsp;<span class="op" id="6343826">*</span><span class="ident" id="6343827">encoder</span><span class="op" id="6343834">)</span>&nbsp;<span class="ident" id="6343836">writeIHDR</span><span class="op" id="6343845">(</span><span class="op" id="6343846">)</span>&nbsp;<span class="op" id="6343848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343851">b</span>&nbsp;<span class="op" id="6343853">:=</span>&nbsp;<span class="ident" id="6343856">e</span><span class="op" id="6343857">.</span><span class="ident" id="6343858">m</span><span class="op" id="6343859">.</span><span class="ident" id="6343860">Bounds</span><span class="op" id="6343866">(</span><span class="op" id="6343867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343870">writeUint32</span><span class="op" id="6343881">(</span><span class="ident" id="6343882">e</span><span class="op" id="6343883">.</span><span class="ident" id="6343884">tmp</span><span class="op" id="6343887">[</span><span class="num" id="6343888">0</span><span class="op" id="6343889">:</span><span class="num" id="6343890">4</span><span class="op" id="6343891">]</span><span class="op" id="6343892">,</span>&nbsp;<span class="builtintype" id="6343894">uint32</span><span class="op" id="6343900">(</span><span class="ident" id="6343901">b</span><span class="op" id="6343902">.</span><span class="ident" id="6343903">Dx</span><span class="op" id="6343905">(</span><span class="op" id="6343906">)</span><span class="op" id="6343907">)</span><span class="op" id="6343908">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6343911">writeUint32</span><span class="op" id="6343922">(</span><span class="ident" id="6343923">e</span><span class="op" id="6343924">.</span><span class="ident" id="6343925">tmp</span><span class="op" id="6343928">[</span><span class="num" id="6343929">4</span><span class="op" id="6343930">:</span><span class="num" id="6343931">8</span><span class="op" id="6343932">]</span><span class="op" id="6343933">,</span>&nbsp;<span class="builtintype" id="6343935">uint32</span><span class="op" id="6343941">(</span><span class="ident" id="6343942">b</span><span class="op" id="6343943">.</span><span class="ident" id="6343944">Dy</span><span class="op" id="6343946">(</span><span class="op" id="6343947">)</span><span class="op" id="6343948">)</span><span class="op" id="6343949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6343952">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6343986">switch</span>&nbsp;<span class="ident" id="6343993">e</span><span class="op" id="6343994">.</span><span class="ident" id="6343995">cb</span>&nbsp;<span class="op" id="6343998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344001">case</span>&nbsp;<span class="ident" id="6344006">cbG8</span><span class="op" id="6344010">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344014">e</span><span class="op" id="6344015">.</span><span class="ident" id="6344016">tmp</span><span class="op" id="6344019">[</span><span class="num" id="6344020">8</span><span class="op" id="6344021">]</span>&nbsp;<span class="op" id="6344023">=</span>&nbsp;<span class="num" id="6344025">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344029">e</span><span class="op" id="6344030">.</span><span class="ident" id="6344031">tmp</span><span class="op" id="6344034">[</span><span class="num" id="6344035">9</span><span class="op" id="6344036">]</span>&nbsp;<span class="op" id="6344038">=</span>&nbsp;<span class="ident" id="6344040">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344053">case</span>&nbsp;<span class="ident" id="6344058">cbTC8</span><span class="op" id="6344063">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344067">e</span><span class="op" id="6344068">.</span><span class="ident" id="6344069">tmp</span><span class="op" id="6344072">[</span><span class="num" id="6344073">8</span><span class="op" id="6344074">]</span>&nbsp;<span class="op" id="6344076">=</span>&nbsp;<span class="num" id="6344078">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344082">e</span><span class="op" id="6344083">.</span><span class="ident" id="6344084">tmp</span><span class="op" id="6344087">[</span><span class="num" id="6344088">9</span><span class="op" id="6344089">]</span>&nbsp;<span class="op" id="6344091">=</span>&nbsp;<span class="ident" id="6344093">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344106">case</span>&nbsp;<span class="ident" id="6344111">cbP8</span><span class="op" id="6344115">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344119">e</span><span class="op" id="6344120">.</span><span class="ident" id="6344121">tmp</span><span class="op" id="6344124">[</span><span class="num" id="6344125">8</span><span class="op" id="6344126">]</span>&nbsp;<span class="op" id="6344128">=</span>&nbsp;<span class="num" id="6344130">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344134">e</span><span class="op" id="6344135">.</span><span class="ident" id="6344136">tmp</span><span class="op" id="6344139">[</span><span class="num" id="6344140">9</span><span class="op" id="6344141">]</span>&nbsp;<span class="op" id="6344143">=</span>&nbsp;<span class="ident" id="6344145">ctPaletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344157">case</span>&nbsp;<span class="ident" id="6344162">cbTCA8</span><span class="op" id="6344168">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344172">e</span><span class="op" id="6344173">.</span><span class="ident" id="6344174">tmp</span><span class="op" id="6344177">[</span><span class="num" id="6344178">8</span><span class="op" id="6344179">]</span>&nbsp;<span class="op" id="6344181">=</span>&nbsp;<span class="num" id="6344183">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344187">e</span><span class="op" id="6344188">.</span><span class="ident" id="6344189">tmp</span><span class="op" id="6344192">[</span><span class="num" id="6344193">9</span><span class="op" id="6344194">]</span>&nbsp;<span class="op" id="6344196">=</span>&nbsp;<span class="ident" id="6344198">ctTrueColorAlpha</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344216">case</span>&nbsp;<span class="ident" id="6344221">cbG16</span><span class="op" id="6344226">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344230">e</span><span class="op" id="6344231">.</span><span class="ident" id="6344232">tmp</span><span class="op" id="6344235">[</span><span class="num" id="6344236">8</span><span class="op" id="6344237">]</span>&nbsp;<span class="op" id="6344239">=</span>&nbsp;<span class="num" id="6344241">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344246">e</span><span class="op" id="6344247">.</span><span class="ident" id="6344248">tmp</span><span class="op" id="6344251">[</span><span class="num" id="6344252">9</span><span class="op" id="6344253">]</span>&nbsp;<span class="op" id="6344255">=</span>&nbsp;<span class="ident" id="6344257">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344270">case</span>&nbsp;<span class="ident" id="6344275">cbTC16</span><span class="op" id="6344281">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344285">e</span><span class="op" id="6344286">.</span><span class="ident" id="6344287">tmp</span><span class="op" id="6344290">[</span><span class="num" id="6344291">8</span><span class="op" id="6344292">]</span>&nbsp;<span class="op" id="6344294">=</span>&nbsp;<span class="num" id="6344296">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344301">e</span><span class="op" id="6344302">.</span><span class="ident" id="6344303">tmp</span><span class="op" id="6344306">[</span><span class="num" id="6344307">9</span><span class="op" id="6344308">]</span>&nbsp;<span class="op" id="6344310">=</span>&nbsp;<span class="ident" id="6344312">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344325">case</span>&nbsp;<span class="ident" id="6344330">cbTCA16</span><span class="op" id="6344337">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344341">e</span><span class="op" id="6344342">.</span><span class="ident" id="6344343">tmp</span><span class="op" id="6344346">[</span><span class="num" id="6344347">8</span><span class="op" id="6344348">]</span>&nbsp;<span class="op" id="6344350">=</span>&nbsp;<span class="num" id="6344352">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344357">e</span><span class="op" id="6344358">.</span><span class="ident" id="6344359">tmp</span><span class="op" id="6344362">[</span><span class="num" id="6344363">9</span><span class="op" id="6344364">]</span>&nbsp;<span class="op" id="6344366">=</span>&nbsp;<span class="ident" id="6344368">ctTrueColorAlpha</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344386">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344389">e</span><span class="op" id="6344390">.</span><span class="ident" id="6344391">tmp</span><span class="op" id="6344394">[</span><span class="num" id="6344395">10</span><span class="op" id="6344397">]</span>&nbsp;<span class="op" id="6344399">=</span>&nbsp;<span class="num" id="6344401">0</span>&nbsp;<span class="comment" id="6344403">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344434">e</span><span class="op" id="6344435">.</span><span class="ident" id="6344436">tmp</span><span class="op" id="6344439">[</span><span class="num" id="6344440">11</span><span class="op" id="6344442">]</span>&nbsp;<span class="op" id="6344444">=</span>&nbsp;<span class="num" id="6344446">0</span>&nbsp;<span class="comment" id="6344448">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344474">e</span><span class="op" id="6344475">.</span><span class="ident" id="6344476">tmp</span><span class="op" id="6344479">[</span><span class="num" id="6344480">12</span><span class="op" id="6344482">]</span>&nbsp;<span class="op" id="6344484">=</span>&nbsp;<span class="num" id="6344486">0</span>&nbsp;<span class="comment" id="6344488">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344507">e</span><span class="op" id="6344508">.</span><span class="ident" id="6344509">writeChunk</span><span class="op" id="6344519">(</span><span class="ident" id="6344520">e</span><span class="op" id="6344521">.</span><span class="ident" id="6344522">tmp</span><span class="op" id="6344525">[</span><span class="op" id="6344526">:</span><span class="num" id="6344527">13</span><span class="op" id="6344529">]</span><span class="op" id="6344530">,</span>&nbsp;<span class="string" id="6344532">&#34;IHDR&#34;</span><span class="op" id="6344538">)</span><br>
<span class="lineno"></span><span class="op" id="6344540">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="6344543">func</span>&nbsp;<span class="op" id="6344548">(</span><span class="ident" id="6344549">e</span>&nbsp;<span class="op" id="6344551">*</span><span class="ident" id="6344552">encoder</span><span class="op" id="6344559">)</span>&nbsp;<span class="ident" id="6344561">writePLTEAndTRNS</span><span class="op" id="6344577">(</span><span class="ident" id="6344578">p</span>&nbsp;<span class="ident" id="6344580">color</span><span class="op" id="6344585">.</span><span class="ident" id="6344586">Palette</span><span class="op" id="6344593">)</span>&nbsp;<span class="op" id="6344595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344598">if</span>&nbsp;<span class="builtinfunc" id="6344601">len</span><span class="op" id="6344604">(</span><span class="ident" id="6344605">p</span><span class="op" id="6344606">)</span>&nbsp;<span class="op" id="6344608">&lt;</span>&nbsp;<span class="num" id="6344610">1</span>&nbsp;<span class="op" id="6344612">||</span>&nbsp;<span class="builtinfunc" id="6344615">len</span><span class="op" id="6344618">(</span><span class="ident" id="6344619">p</span><span class="op" id="6344620">)</span>&nbsp;<span class="op" id="6344622">&gt;</span>&nbsp;<span class="num" id="6344624">256</span>&nbsp;<span class="op" id="6344628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344632">e</span><span class="op" id="6344633">.</span><span class="ident" id="6344634">err</span>&nbsp;<span class="op" id="6344638">=</span>&nbsp;<span class="ident" id="6344640">FormatError</span><span class="op" id="6344651">(</span><span class="string" id="6344652">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="6344675">+</span>&nbsp;<span class="ident" id="6344677">strconv</span><span class="op" id="6344684">.</span><span class="ident" id="6344685">Itoa</span><span class="op" id="6344689">(</span><span class="builtinfunc" id="6344690">len</span><span class="op" id="6344693">(</span><span class="ident" id="6344694">p</span><span class="op" id="6344695">)</span><span class="op" id="6344696">)</span><span class="op" id="6344697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344701">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344712">last</span>&nbsp;<span class="op" id="6344717">:=</span>&nbsp;<span class="op" id="6344720">-</span><span class="num" id="6344721">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344724">for</span>&nbsp;<span class="ident" id="6344728">i</span><span class="op" id="6344729">,</span>&nbsp;<span class="ident" id="6344731">c</span>&nbsp;<span class="op" id="6344733">:=</span>&nbsp;<span class="keyword" id="6344736">range</span>&nbsp;<span class="ident" id="6344742">p</span>&nbsp;<span class="op" id="6344744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344748">c1</span>&nbsp;<span class="op" id="6344751">:=</span>&nbsp;<span class="ident" id="6344754">color</span><span class="op" id="6344759">.</span><span class="ident" id="6344760">NRGBAModel</span><span class="op" id="6344770">.</span><span class="ident" id="6344771">Convert</span><span class="op" id="6344778">(</span><span class="ident" id="6344779">c</span><span class="op" id="6344780">)</span><span class="op" id="6344781">.</span><span class="op" id="6344782">(</span><span class="ident" id="6344783">color</span><span class="op" id="6344788">.</span><span class="ident" id="6344789">NRGBA</span><span class="op" id="6344794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344798">e</span><span class="op" id="6344799">.</span><span class="ident" id="6344800">tmp</span><span class="op" id="6344803">[</span><span class="num" id="6344804">3</span><span class="op" id="6344805">*</span><span class="ident" id="6344806">i</span><span class="op" id="6344807">+</span><span class="num" id="6344808">0</span><span class="op" id="6344809">]</span>&nbsp;<span class="op" id="6344811">=</span>&nbsp;<span class="ident" id="6344813">c1</span><span class="op" id="6344815">.</span><span class="ident" id="6344816">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344820">e</span><span class="op" id="6344821">.</span><span class="ident" id="6344822">tmp</span><span class="op" id="6344825">[</span><span class="num" id="6344826">3</span><span class="op" id="6344827">*</span><span class="ident" id="6344828">i</span><span class="op" id="6344829">+</span><span class="num" id="6344830">1</span><span class="op" id="6344831">]</span>&nbsp;<span class="op" id="6344833">=</span>&nbsp;<span class="ident" id="6344835">c1</span><span class="op" id="6344837">.</span><span class="ident" id="6344838">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344842">e</span><span class="op" id="6344843">.</span><span class="ident" id="6344844">tmp</span><span class="op" id="6344847">[</span><span class="num" id="6344848">3</span><span class="op" id="6344849">*</span><span class="ident" id="6344850">i</span><span class="op" id="6344851">+</span><span class="num" id="6344852">2</span><span class="op" id="6344853">]</span>&nbsp;<span class="op" id="6344855">=</span>&nbsp;<span class="ident" id="6344857">c1</span><span class="op" id="6344859">.</span><span class="ident" id="6344860">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344864">if</span>&nbsp;<span class="ident" id="6344867">c1</span><span class="op" id="6344869">.</span><span class="ident" id="6344870">A</span>&nbsp;<span class="op" id="6344872">!=</span>&nbsp;<span class="num" id="6344875">0xff</span>&nbsp;<span class="op" id="6344880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344885">last</span>&nbsp;<span class="op" id="6344890">=</span>&nbsp;<span class="ident" id="6344892">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344896">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344900">e</span><span class="op" id="6344901">.</span><span class="ident" id="6344902">tmp</span><span class="op" id="6344905">[</span><span class="num" id="6344906">3</span><span class="op" id="6344907">*</span><span class="num" id="6344908">256</span><span class="op" id="6344911">+</span><span class="ident" id="6344912">i</span><span class="op" id="6344913">]</span>&nbsp;<span class="op" id="6344915">=</span>&nbsp;<span class="ident" id="6344917">c1</span><span class="op" id="6344919">.</span><span class="ident" id="6344920">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6344923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344926">e</span><span class="op" id="6344927">.</span><span class="ident" id="6344928">writeChunk</span><span class="op" id="6344938">(</span><span class="ident" id="6344939">e</span><span class="op" id="6344940">.</span><span class="ident" id="6344941">tmp</span><span class="op" id="6344944">[</span><span class="op" id="6344945">:</span><span class="num" id="6344946">3</span><span class="op" id="6344947">*</span><span class="builtinfunc" id="6344948">len</span><span class="op" id="6344951">(</span><span class="ident" id="6344952">p</span><span class="op" id="6344953">)</span><span class="op" id="6344954">]</span><span class="op" id="6344955">,</span>&nbsp;<span class="string" id="6344957">&#34;PLTE&#34;</span><span class="op" id="6344963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6344966">if</span>&nbsp;<span class="ident" id="6344969">last</span>&nbsp;<span class="op" id="6344974">!=</span>&nbsp;<span class="op" id="6344977">-</span><span class="num" id="6344978">1</span>&nbsp;<span class="op" id="6344980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6344984">e</span><span class="op" id="6344985">.</span><span class="ident" id="6344986">writeChunk</span><span class="op" id="6344996">(</span><span class="ident" id="6344997">e</span><span class="op" id="6344998">.</span><span class="ident" id="6344999">tmp</span><span class="op" id="6345002">[</span><span class="num" id="6345003">3</span><span class="op" id="6345004">*</span><span class="num" id="6345005">256</span><span class="op" id="6345008">:</span><span class="num" id="6345009">3</span><span class="op" id="6345010">*</span><span class="num" id="6345011">256</span><span class="op" id="6345014">+</span><span class="num" id="6345015">1</span><span class="op" id="6345016">+</span><span class="ident" id="6345017">last</span><span class="op" id="6345021">]</span><span class="op" id="6345022">,</span>&nbsp;<span class="string" id="6345024">&#34;tRNS&#34;</span><span class="op" id="6345030">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345033">}</span><br>
<span class="lineno"></span><span class="op" id="6345035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6345038">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="6345118">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="6345199">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="6345273">//</span><br>
<span class="lineno"></span><span class="comment" id="6345276">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="6345347">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6345405">func</span>&nbsp;<span class="op" id="6345410">(</span><span class="ident" id="6345411">e</span>&nbsp;<span class="op" id="6345413">*</span><span class="ident" id="6345414">encoder</span><span class="op" id="6345421">)</span>&nbsp;<span class="ident" id="6345423">Write</span><span class="op" id="6345428">(</span><span class="ident" id="6345429">b</span>&nbsp;<span class="op" id="6345431">[</span><span class="op" id="6345432">]</span><span class="builtintype" id="6345433">byte</span><span class="op" id="6345437">)</span>&nbsp;<span class="op" id="6345439">(</span><span class="builtintype" id="6345440">int</span><span class="op" id="6345443">,</span>&nbsp;<span class="builtintype" id="6345445">error</span><span class="op" id="6345450">)</span>&nbsp;<span class="op" id="6345452">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6345455">e</span><span class="op" id="6345456">.</span><span class="ident" id="6345457">writeChunk</span><span class="op" id="6345467">(</span><span class="ident" id="6345468">b</span><span class="op" id="6345469">,</span>&nbsp;<span class="string" id="6345471">&#34;IDAT&#34;</span><span class="op" id="6345477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345480">if</span>&nbsp;<span class="ident" id="6345483">e</span><span class="op" id="6345484">.</span><span class="ident" id="6345485">err</span>&nbsp;<span class="op" id="6345489">!=</span>&nbsp;<span class="builtintype" id="6345492">nil</span>&nbsp;<span class="op" id="6345496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345500">return</span>&nbsp;<span class="num" id="6345507">0</span><span class="op" id="6345508">,</span>&nbsp;<span class="ident" id="6345510">e</span><span class="op" id="6345511">.</span><span class="ident" id="6345512">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6345517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6345520">return</span>&nbsp;<span class="builtinfunc" id="6345527">len</span><span class="op" id="6345530">(</span><span class="ident" id="6345531">b</span><span class="op" id="6345532">)</span><span class="op" id="6345533">,</span>&nbsp;<span class="builtintype" id="6345535">nil</span><br>
<span class="lineno">180</span><span class="op" id="6345539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6345542">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="6345617">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="6345715">func</span>&nbsp;<span class="ident" id="6345720">filter</span><span class="op" id="6345726">(</span><span class="ident" id="6345727">cr</span>&nbsp;<span class="op" id="6345730">*</span><span class="op" id="6345731">[</span><span class="ident" id="6345732">nFilter</span><span class="op" id="6345739">]</span><span class="op" id="6345740">[</span><span class="op" id="6345741">]</span><span class="builtintype" id="6345742">byte</span><span class="op" id="6345746">,</span>&nbsp;<span class="ident" id="6345748">pr</span>&nbsp;<span class="op" id="6345751">[</span><span class="op" id="6345752">]</span><span class="builtintype" id="6345753">byte</span><span class="op" id="6345757">,</span>&nbsp;<span class="ident" id="6345759">bpp</span>&nbsp;<span class="builtintype" id="6345763">int</span><span class="op" id="6345766">)</span>&nbsp;<span class="builtintype" id="6345768">int</span>&nbsp;<span class="op" id="6345772">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345775">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345874">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6345970">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6346065">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346139">cdat0</span>&nbsp;<span class="op" id="6346145">:=</span>&nbsp;<span class="ident" id="6346148">cr</span><span class="op" id="6346150">[</span><span class="num" id="6346151">0</span><span class="op" id="6346152">]</span><span class="op" id="6346153">[</span><span class="num" id="6346154">1</span><span class="op" id="6346155">:</span><span class="op" id="6346156">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346159">cdat1</span>&nbsp;<span class="op" id="6346165">:=</span>&nbsp;<span class="ident" id="6346168">cr</span><span class="op" id="6346170">[</span><span class="num" id="6346171">1</span><span class="op" id="6346172">]</span><span class="op" id="6346173">[</span><span class="num" id="6346174">1</span><span class="op" id="6346175">:</span><span class="op" id="6346176">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346179">cdat2</span>&nbsp;<span class="op" id="6346185">:=</span>&nbsp;<span class="ident" id="6346188">cr</span><span class="op" id="6346190">[</span><span class="num" id="6346191">2</span><span class="op" id="6346192">]</span><span class="op" id="6346193">[</span><span class="num" id="6346194">1</span><span class="op" id="6346195">:</span><span class="op" id="6346196">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346199">cdat3</span>&nbsp;<span class="op" id="6346205">:=</span>&nbsp;<span class="ident" id="6346208">cr</span><span class="op" id="6346210">[</span><span class="num" id="6346211">3</span><span class="op" id="6346212">]</span><span class="op" id="6346213">[</span><span class="num" id="6346214">1</span><span class="op" id="6346215">:</span><span class="op" id="6346216">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346219">cdat4</span>&nbsp;<span class="op" id="6346225">:=</span>&nbsp;<span class="ident" id="6346228">cr</span><span class="op" id="6346230">[</span><span class="num" id="6346231">4</span><span class="op" id="6346232">]</span><span class="op" id="6346233">[</span><span class="num" id="6346234">1</span><span class="op" id="6346235">:</span><span class="op" id="6346236">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346239">pdat</span>&nbsp;<span class="op" id="6346244">:=</span>&nbsp;<span class="ident" id="6346247">pr</span><span class="op" id="6346249">[</span><span class="num" id="6346250">1</span><span class="op" id="6346251">:</span><span class="op" id="6346252">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346255">n</span>&nbsp;<span class="op" id="6346257">:=</span>&nbsp;<span class="builtinfunc" id="6346260">len</span><span class="op" id="6346263">(</span><span class="ident" id="6346264">cdat0</span><span class="op" id="6346269">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6346273">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346292">sum</span>&nbsp;<span class="op" id="6346296">:=</span>&nbsp;<span class="num" id="6346299">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346302">for</span>&nbsp;<span class="ident" id="6346306">i</span>&nbsp;<span class="op" id="6346308">:=</span>&nbsp;<span class="num" id="6346311">0</span><span class="op" id="6346312">;</span>&nbsp;<span class="ident" id="6346314">i</span>&nbsp;<span class="op" id="6346316">&lt;</span>&nbsp;<span class="ident" id="6346318">n</span><span class="op" id="6346319">;</span>&nbsp;<span class="ident" id="6346321">i</span><span class="op" id="6346322">++</span>&nbsp;<span class="op" id="6346325">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346329">cdat2</span><span class="op" id="6346334">[</span><span class="ident" id="6346335">i</span><span class="op" id="6346336">]</span>&nbsp;<span class="op" id="6346338">=</span>&nbsp;<span class="ident" id="6346340">cdat0</span><span class="op" id="6346345">[</span><span class="ident" id="6346346">i</span><span class="op" id="6346347">]</span>&nbsp;<span class="op" id="6346349">-</span>&nbsp;<span class="ident" id="6346351">pdat</span><span class="op" id="6346355">[</span><span class="ident" id="6346356">i</span><span class="op" id="6346357">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346361">sum</span>&nbsp;<span class="op" id="6346365">+=</span>&nbsp;<span class="ident" id="6346368">abs8</span><span class="op" id="6346372">(</span><span class="ident" id="6346373">cdat2</span><span class="op" id="6346378">[</span><span class="ident" id="6346379">i</span><span class="op" id="6346380">]</span><span class="op" id="6346381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346387">best</span>&nbsp;<span class="op" id="6346392">:=</span>&nbsp;<span class="ident" id="6346395">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346400">filter</span>&nbsp;<span class="op" id="6346407">:=</span>&nbsp;<span class="ident" id="6346410">ftUp</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6346417">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346439">sum</span>&nbsp;<span class="op" id="6346443">=</span>&nbsp;<span class="num" id="6346445">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346448">for</span>&nbsp;<span class="ident" id="6346452">i</span>&nbsp;<span class="op" id="6346454">:=</span>&nbsp;<span class="num" id="6346457">0</span><span class="op" id="6346458">;</span>&nbsp;<span class="ident" id="6346460">i</span>&nbsp;<span class="op" id="6346462">&lt;</span>&nbsp;<span class="ident" id="6346464">bpp</span><span class="op" id="6346467">;</span>&nbsp;<span class="ident" id="6346469">i</span><span class="op" id="6346470">++</span>&nbsp;<span class="op" id="6346473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346477">cdat4</span><span class="op" id="6346482">[</span><span class="ident" id="6346483">i</span><span class="op" id="6346484">]</span>&nbsp;<span class="op" id="6346486">=</span>&nbsp;<span class="ident" id="6346488">cdat0</span><span class="op" id="6346493">[</span><span class="ident" id="6346494">i</span><span class="op" id="6346495">]</span>&nbsp;<span class="op" id="6346497">-</span>&nbsp;<span class="ident" id="6346499">pdat</span><span class="op" id="6346503">[</span><span class="ident" id="6346504">i</span><span class="op" id="6346505">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346509">sum</span>&nbsp;<span class="op" id="6346513">+=</span>&nbsp;<span class="ident" id="6346516">abs8</span><span class="op" id="6346520">(</span><span class="ident" id="6346521">cdat4</span><span class="op" id="6346526">[</span><span class="ident" id="6346527">i</span><span class="op" id="6346528">]</span><span class="op" id="6346529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346535">for</span>&nbsp;<span class="ident" id="6346539">i</span>&nbsp;<span class="op" id="6346541">:=</span>&nbsp;<span class="ident" id="6346544">bpp</span><span class="op" id="6346547">;</span>&nbsp;<span class="ident" id="6346549">i</span>&nbsp;<span class="op" id="6346551">&lt;</span>&nbsp;<span class="ident" id="6346553">n</span><span class="op" id="6346554">;</span>&nbsp;<span class="ident" id="6346556">i</span><span class="op" id="6346557">++</span>&nbsp;<span class="op" id="6346560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346564">cdat4</span><span class="op" id="6346569">[</span><span class="ident" id="6346570">i</span><span class="op" id="6346571">]</span>&nbsp;<span class="op" id="6346573">=</span>&nbsp;<span class="ident" id="6346575">cdat0</span><span class="op" id="6346580">[</span><span class="ident" id="6346581">i</span><span class="op" id="6346582">]</span>&nbsp;<span class="op" id="6346584">-</span>&nbsp;<span class="ident" id="6346586">paeth</span><span class="op" id="6346591">(</span><span class="ident" id="6346592">cdat0</span><span class="op" id="6346597">[</span><span class="ident" id="6346598">i</span><span class="op" id="6346599">-</span><span class="ident" id="6346600">bpp</span><span class="op" id="6346603">]</span><span class="op" id="6346604">,</span>&nbsp;<span class="ident" id="6346606">pdat</span><span class="op" id="6346610">[</span><span class="ident" id="6346611">i</span><span class="op" id="6346612">]</span><span class="op" id="6346613">,</span>&nbsp;<span class="ident" id="6346615">pdat</span><span class="op" id="6346619">[</span><span class="ident" id="6346620">i</span><span class="op" id="6346621">-</span><span class="ident" id="6346622">bpp</span><span class="op" id="6346625">]</span><span class="op" id="6346626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346630">sum</span>&nbsp;<span class="op" id="6346634">+=</span>&nbsp;<span class="ident" id="6346637">abs8</span><span class="op" id="6346641">(</span><span class="ident" id="6346642">cdat4</span><span class="op" id="6346647">[</span><span class="ident" id="6346648">i</span><span class="op" id="6346649">]</span><span class="op" id="6346650">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346654">if</span>&nbsp;<span class="ident" id="6346657">sum</span>&nbsp;<span class="op" id="6346661">&gt;=</span>&nbsp;<span class="ident" id="6346664">best</span>&nbsp;<span class="op" id="6346669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346674">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346688">if</span>&nbsp;<span class="ident" id="6346691">sum</span>&nbsp;<span class="op" id="6346695">&lt;</span>&nbsp;<span class="ident" id="6346697">best</span>&nbsp;<span class="op" id="6346702">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346706">best</span>&nbsp;<span class="op" id="6346711">=</span>&nbsp;<span class="ident" id="6346713">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346719">filter</span>&nbsp;<span class="op" id="6346726">=</span>&nbsp;<span class="ident" id="6346728">ftPaeth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6346741">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346762">sum</span>&nbsp;<span class="op" id="6346766">=</span>&nbsp;<span class="num" id="6346768">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346771">for</span>&nbsp;<span class="ident" id="6346775">i</span>&nbsp;<span class="op" id="6346777">:=</span>&nbsp;<span class="num" id="6346780">0</span><span class="op" id="6346781">;</span>&nbsp;<span class="ident" id="6346783">i</span>&nbsp;<span class="op" id="6346785">&lt;</span>&nbsp;<span class="ident" id="6346787">n</span><span class="op" id="6346788">;</span>&nbsp;<span class="ident" id="6346790">i</span><span class="op" id="6346791">++</span>&nbsp;<span class="op" id="6346794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346798">sum</span>&nbsp;<span class="op" id="6346802">+=</span>&nbsp;<span class="ident" id="6346805">abs8</span><span class="op" id="6346809">(</span><span class="ident" id="6346810">cdat0</span><span class="op" id="6346815">[</span><span class="ident" id="6346816">i</span><span class="op" id="6346817">]</span><span class="op" id="6346818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346822">if</span>&nbsp;<span class="ident" id="6346825">sum</span>&nbsp;<span class="op" id="6346829">&gt;=</span>&nbsp;<span class="ident" id="6346832">best</span>&nbsp;<span class="op" id="6346837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346842">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346856">if</span>&nbsp;<span class="ident" id="6346859">sum</span>&nbsp;<span class="op" id="6346863">&lt;</span>&nbsp;<span class="ident" id="6346865">best</span>&nbsp;<span class="op" id="6346870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346874">best</span>&nbsp;<span class="op" id="6346879">=</span>&nbsp;<span class="ident" id="6346881">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346887">filter</span>&nbsp;<span class="op" id="6346894">=</span>&nbsp;<span class="ident" id="6346896">ftNone</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6346904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6346908">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346928">sum</span>&nbsp;<span class="op" id="6346932">=</span>&nbsp;<span class="num" id="6346934">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6346937">for</span>&nbsp;<span class="ident" id="6346941">i</span>&nbsp;<span class="op" id="6346943">:=</span>&nbsp;<span class="num" id="6346946">0</span><span class="op" id="6346947">;</span>&nbsp;<span class="ident" id="6346949">i</span>&nbsp;<span class="op" id="6346951">&lt;</span>&nbsp;<span class="ident" id="6346953">bpp</span><span class="op" id="6346956">;</span>&nbsp;<span class="ident" id="6346958">i</span><span class="op" id="6346959">++</span>&nbsp;<span class="op" id="6346962">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346966">cdat1</span><span class="op" id="6346971">[</span><span class="ident" id="6346972">i</span><span class="op" id="6346973">]</span>&nbsp;<span class="op" id="6346975">=</span>&nbsp;<span class="ident" id="6346977">cdat0</span><span class="op" id="6346982">[</span><span class="ident" id="6346983">i</span><span class="op" id="6346984">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6346988">sum</span>&nbsp;<span class="op" id="6346992">+=</span>&nbsp;<span class="ident" id="6346995">abs8</span><span class="op" id="6346999">(</span><span class="ident" id="6347000">cdat1</span><span class="op" id="6347005">[</span><span class="ident" id="6347006">i</span><span class="op" id="6347007">]</span><span class="op" id="6347008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347014">for</span>&nbsp;<span class="ident" id="6347018">i</span>&nbsp;<span class="op" id="6347020">:=</span>&nbsp;<span class="ident" id="6347023">bpp</span><span class="op" id="6347026">;</span>&nbsp;<span class="ident" id="6347028">i</span>&nbsp;<span class="op" id="6347030">&lt;</span>&nbsp;<span class="ident" id="6347032">n</span><span class="op" id="6347033">;</span>&nbsp;<span class="ident" id="6347035">i</span><span class="op" id="6347036">++</span>&nbsp;<span class="op" id="6347039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347043">cdat1</span><span class="op" id="6347048">[</span><span class="ident" id="6347049">i</span><span class="op" id="6347050">]</span>&nbsp;<span class="op" id="6347052">=</span>&nbsp;<span class="ident" id="6347054">cdat0</span><span class="op" id="6347059">[</span><span class="ident" id="6347060">i</span><span class="op" id="6347061">]</span>&nbsp;<span class="op" id="6347063">-</span>&nbsp;<span class="ident" id="6347065">cdat0</span><span class="op" id="6347070">[</span><span class="ident" id="6347071">i</span><span class="op" id="6347072">-</span><span class="ident" id="6347073">bpp</span><span class="op" id="6347076">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347080">sum</span>&nbsp;<span class="op" id="6347084">+=</span>&nbsp;<span class="ident" id="6347087">abs8</span><span class="op" id="6347091">(</span><span class="ident" id="6347092">cdat1</span><span class="op" id="6347097">[</span><span class="ident" id="6347098">i</span><span class="op" id="6347099">]</span><span class="op" id="6347100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347104">if</span>&nbsp;<span class="ident" id="6347107">sum</span>&nbsp;<span class="op" id="6347111">&gt;=</span>&nbsp;<span class="ident" id="6347114">best</span>&nbsp;<span class="op" id="6347119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347124">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347135">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347138">if</span>&nbsp;<span class="ident" id="6347141">sum</span>&nbsp;<span class="op" id="6347145">&lt;</span>&nbsp;<span class="ident" id="6347147">best</span>&nbsp;<span class="op" id="6347152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347156">best</span>&nbsp;<span class="op" id="6347161">=</span>&nbsp;<span class="ident" id="6347163">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347169">filter</span>&nbsp;<span class="op" id="6347176">=</span>&nbsp;<span class="ident" id="6347178">ftSub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6347189">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347213">sum</span>&nbsp;<span class="op" id="6347217">=</span>&nbsp;<span class="num" id="6347219">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347222">for</span>&nbsp;<span class="ident" id="6347226">i</span>&nbsp;<span class="op" id="6347228">:=</span>&nbsp;<span class="num" id="6347231">0</span><span class="op" id="6347232">;</span>&nbsp;<span class="ident" id="6347234">i</span>&nbsp;<span class="op" id="6347236">&lt;</span>&nbsp;<span class="ident" id="6347238">bpp</span><span class="op" id="6347241">;</span>&nbsp;<span class="ident" id="6347243">i</span><span class="op" id="6347244">++</span>&nbsp;<span class="op" id="6347247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347251">cdat3</span><span class="op" id="6347256">[</span><span class="ident" id="6347257">i</span><span class="op" id="6347258">]</span>&nbsp;<span class="op" id="6347260">=</span>&nbsp;<span class="ident" id="6347262">cdat0</span><span class="op" id="6347267">[</span><span class="ident" id="6347268">i</span><span class="op" id="6347269">]</span>&nbsp;<span class="op" id="6347271">-</span>&nbsp;<span class="ident" id="6347273">pdat</span><span class="op" id="6347277">[</span><span class="ident" id="6347278">i</span><span class="op" id="6347279">]</span><span class="op" id="6347280">/</span><span class="num" id="6347281">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347285">sum</span>&nbsp;<span class="op" id="6347289">+=</span>&nbsp;<span class="ident" id="6347292">abs8</span><span class="op" id="6347296">(</span><span class="ident" id="6347297">cdat3</span><span class="op" id="6347302">[</span><span class="ident" id="6347303">i</span><span class="op" id="6347304">]</span><span class="op" id="6347305">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347311">for</span>&nbsp;<span class="ident" id="6347315">i</span>&nbsp;<span class="op" id="6347317">:=</span>&nbsp;<span class="ident" id="6347320">bpp</span><span class="op" id="6347323">;</span>&nbsp;<span class="ident" id="6347325">i</span>&nbsp;<span class="op" id="6347327">&lt;</span>&nbsp;<span class="ident" id="6347329">n</span><span class="op" id="6347330">;</span>&nbsp;<span class="ident" id="6347332">i</span><span class="op" id="6347333">++</span>&nbsp;<span class="op" id="6347336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347340">cdat3</span><span class="op" id="6347345">[</span><span class="ident" id="6347346">i</span><span class="op" id="6347347">]</span>&nbsp;<span class="op" id="6347349">=</span>&nbsp;<span class="ident" id="6347351">cdat0</span><span class="op" id="6347356">[</span><span class="ident" id="6347357">i</span><span class="op" id="6347358">]</span>&nbsp;<span class="op" id="6347360">-</span>&nbsp;<span class="builtintype" id="6347362">uint8</span><span class="op" id="6347367">(</span><span class="op" id="6347368">(</span><span class="builtintype" id="6347369">int</span><span class="op" id="6347372">(</span><span class="ident" id="6347373">cdat0</span><span class="op" id="6347378">[</span><span class="ident" id="6347379">i</span><span class="op" id="6347380">-</span><span class="ident" id="6347381">bpp</span><span class="op" id="6347384">]</span><span class="op" id="6347385">)</span><span class="op" id="6347386">+</span><span class="builtintype" id="6347387">int</span><span class="op" id="6347390">(</span><span class="ident" id="6347391">pdat</span><span class="op" id="6347395">[</span><span class="ident" id="6347396">i</span><span class="op" id="6347397">]</span><span class="op" id="6347398">)</span><span class="op" id="6347399">)</span><span class="op" id="6347400">/</span><span class="num" id="6347401">2</span><span class="op" id="6347402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347406">sum</span>&nbsp;<span class="op" id="6347410">+=</span>&nbsp;<span class="ident" id="6347413">abs8</span><span class="op" id="6347417">(</span><span class="ident" id="6347418">cdat3</span><span class="op" id="6347423">[</span><span class="ident" id="6347424">i</span><span class="op" id="6347425">]</span><span class="op" id="6347426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347430">if</span>&nbsp;<span class="ident" id="6347433">sum</span>&nbsp;<span class="op" id="6347437">&gt;=</span>&nbsp;<span class="ident" id="6347440">best</span>&nbsp;<span class="op" id="6347445">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347450">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347464">if</span>&nbsp;<span class="ident" id="6347467">sum</span>&nbsp;<span class="op" id="6347471">&lt;</span>&nbsp;<span class="ident" id="6347473">best</span>&nbsp;<span class="op" id="6347478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347482">best</span>&nbsp;<span class="op" id="6347487">=</span>&nbsp;<span class="ident" id="6347489">sum</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347495">filter</span>&nbsp;<span class="op" id="6347502">=</span>&nbsp;<span class="ident" id="6347504">ftAverage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347519">return</span>&nbsp;<span class="ident" id="6347526">filter</span><br>
<span class="lineno"></span><span class="op" id="6347533">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="6347536">func</span>&nbsp;<span class="ident" id="6347541">writeImage</span><span class="op" id="6347551">(</span><span class="ident" id="6347552">w</span>&nbsp;<span class="ident" id="6347554">io</span><span class="op" id="6347556">.</span><span class="ident" id="6347557">Writer</span><span class="op" id="6347563">,</span>&nbsp;<span class="ident" id="6347565">m</span>&nbsp;<span class="ident" id="6347567">image</span><span class="op" id="6347572">.</span><span class="ident" id="6347573">Image</span><span class="op" id="6347578">,</span>&nbsp;<span class="ident" id="6347580">cb</span>&nbsp;<span class="builtintype" id="6347583">int</span><span class="op" id="6347586">,</span>&nbsp;<span class="ident" id="6347588">level</span>&nbsp;<span class="builtintype" id="6347594">int</span><span class="op" id="6347597">)</span>&nbsp;<span class="builtintype" id="6347599">error</span>&nbsp;<span class="op" id="6347605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347608">zw</span><span class="op" id="6347610">,</span>&nbsp;<span class="ident" id="6347612">err</span>&nbsp;<span class="op" id="6347616">:=</span>&nbsp;<span class="ident" id="6347619">zlib</span><span class="op" id="6347623">.</span><span class="ident" id="6347624">NewWriterLevel</span><span class="op" id="6347638">(</span><span class="ident" id="6347639">w</span><span class="op" id="6347640">,</span>&nbsp;<span class="ident" id="6347642">level</span><span class="op" id="6347647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347650">if</span>&nbsp;<span class="ident" id="6347653">err</span>&nbsp;<span class="op" id="6347657">!=</span>&nbsp;<span class="builtintype" id="6347660">nil</span>&nbsp;<span class="op" id="6347664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347668">return</span>&nbsp;<span class="ident" id="6347675">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347683">defer</span>&nbsp;<span class="ident" id="6347689">zw</span><span class="op" id="6347691">.</span><span class="ident" id="6347692">Close</span><span class="op" id="6347697">(</span><span class="op" id="6347698">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347702">bpp</span>&nbsp;<span class="op" id="6347706">:=</span>&nbsp;<span class="num" id="6347709">0</span>&nbsp;<span class="comment" id="6347711">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347733">switch</span>&nbsp;<span class="ident" id="6347740">cb</span>&nbsp;<span class="op" id="6347743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347746">case</span>&nbsp;<span class="ident" id="6347751">cbG8</span><span class="op" id="6347755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347759">bpp</span>&nbsp;<span class="op" id="6347763">=</span>&nbsp;<span class="num" id="6347765">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347768">case</span>&nbsp;<span class="ident" id="6347773">cbTC8</span><span class="op" id="6347778">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347782">bpp</span>&nbsp;<span class="op" id="6347786">=</span>&nbsp;<span class="num" id="6347788">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347791">case</span>&nbsp;<span class="ident" id="6347796">cbP8</span><span class="op" id="6347800">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347804">bpp</span>&nbsp;<span class="op" id="6347808">=</span>&nbsp;<span class="num" id="6347810">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347813">case</span>&nbsp;<span class="ident" id="6347818">cbTCA8</span><span class="op" id="6347824">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347828">bpp</span>&nbsp;<span class="op" id="6347832">=</span>&nbsp;<span class="num" id="6347834">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347837">case</span>&nbsp;<span class="ident" id="6347842">cbTC16</span><span class="op" id="6347848">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347852">bpp</span>&nbsp;<span class="op" id="6347856">=</span>&nbsp;<span class="num" id="6347858">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347861">case</span>&nbsp;<span class="ident" id="6347866">cbTCA16</span><span class="op" id="6347873">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347877">bpp</span>&nbsp;<span class="op" id="6347881">=</span>&nbsp;<span class="num" id="6347883">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6347886">case</span>&nbsp;<span class="ident" id="6347891">cbG16</span><span class="op" id="6347896">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6347900">bpp</span>&nbsp;<span class="op" id="6347904">=</span>&nbsp;<span class="num" id="6347906">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6347909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6347912">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6347977">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348053">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348140">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348227">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348292">b</span>&nbsp;<span class="op" id="6348294">:=</span>&nbsp;<span class="ident" id="6348297">m</span><span class="op" id="6348298">.</span><span class="ident" id="6348299">Bounds</span><span class="op" id="6348305">(</span><span class="op" id="6348306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348309">var</span>&nbsp;<span class="ident" id="6348313">cr</span>&nbsp;<span class="op" id="6348316">[</span><span class="ident" id="6348317">nFilter</span><span class="op" id="6348324">]</span><span class="op" id="6348325">[</span><span class="op" id="6348326">]</span><span class="builtintype" id="6348327">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348334">for</span>&nbsp;<span class="ident" id="6348338">i</span>&nbsp;<span class="op" id="6348340">:=</span>&nbsp;<span class="keyword" id="6348343">range</span>&nbsp;<span class="ident" id="6348349">cr</span>&nbsp;<span class="op" id="6348352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348356">cr</span><span class="op" id="6348358">[</span><span class="ident" id="6348359">i</span><span class="op" id="6348360">]</span>&nbsp;<span class="op" id="6348362">=</span>&nbsp;<span class="builtinfunc" id="6348364">make</span><span class="op" id="6348368">(</span><span class="op" id="6348369">[</span><span class="op" id="6348370">]</span><span class="builtintype" id="6348371">uint8</span><span class="op" id="6348376">,</span>&nbsp;<span class="num" id="6348378">1</span><span class="op" id="6348379">+</span><span class="ident" id="6348380">bpp</span><span class="op" id="6348383">*</span><span class="ident" id="6348384">b</span><span class="op" id="6348385">.</span><span class="ident" id="6348386">Dx</span><span class="op" id="6348388">(</span><span class="op" id="6348389">)</span><span class="op" id="6348390">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348394">cr</span><span class="op" id="6348396">[</span><span class="ident" id="6348397">i</span><span class="op" id="6348398">]</span><span class="op" id="6348399">[</span><span class="num" id="6348400">0</span><span class="op" id="6348401">]</span>&nbsp;<span class="op" id="6348403">=</span>&nbsp;<span class="builtintype" id="6348405">uint8</span><span class="op" id="6348410">(</span><span class="ident" id="6348411">i</span><span class="op" id="6348412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6348415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348418">pr</span>&nbsp;<span class="op" id="6348421">:=</span>&nbsp;<span class="builtinfunc" id="6348424">make</span><span class="op" id="6348428">(</span><span class="op" id="6348429">[</span><span class="op" id="6348430">]</span><span class="builtintype" id="6348431">uint8</span><span class="op" id="6348436">,</span>&nbsp;<span class="num" id="6348438">1</span><span class="op" id="6348439">+</span><span class="ident" id="6348440">bpp</span><span class="op" id="6348443">*</span><span class="ident" id="6348444">b</span><span class="op" id="6348445">.</span><span class="ident" id="6348446">Dx</span><span class="op" id="6348448">(</span><span class="op" id="6348449">)</span><span class="op" id="6348450">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348454">gray</span><span class="op" id="6348458">,</span>&nbsp;<span class="ident" id="6348460">_</span>&nbsp;<span class="op" id="6348462">:=</span>&nbsp;<span class="ident" id="6348465">m</span><span class="op" id="6348466">.</span><span class="op" id="6348467">(</span><span class="op" id="6348468">*</span><span class="ident" id="6348469">image</span><span class="op" id="6348474">.</span><span class="ident" id="6348475">Gray</span><span class="op" id="6348479">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348482">rgba</span><span class="op" id="6348486">,</span>&nbsp;<span class="ident" id="6348488">_</span>&nbsp;<span class="op" id="6348490">:=</span>&nbsp;<span class="ident" id="6348493">m</span><span class="op" id="6348494">.</span><span class="op" id="6348495">(</span><span class="op" id="6348496">*</span><span class="ident" id="6348497">image</span><span class="op" id="6348502">.</span><span class="ident" id="6348503">RGBA</span><span class="op" id="6348507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348510">paletted</span><span class="op" id="6348518">,</span>&nbsp;<span class="ident" id="6348520">_</span>&nbsp;<span class="op" id="6348522">:=</span>&nbsp;<span class="ident" id="6348525">m</span><span class="op" id="6348526">.</span><span class="op" id="6348527">(</span><span class="op" id="6348528">*</span><span class="ident" id="6348529">image</span><span class="op" id="6348534">.</span><span class="ident" id="6348535">Paletted</span><span class="op" id="6348543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348546">nrgba</span><span class="op" id="6348551">,</span>&nbsp;<span class="ident" id="6348553">_</span>&nbsp;<span class="op" id="6348555">:=</span>&nbsp;<span class="ident" id="6348558">m</span><span class="op" id="6348559">.</span><span class="op" id="6348560">(</span><span class="op" id="6348561">*</span><span class="ident" id="6348562">image</span><span class="op" id="6348567">.</span><span class="ident" id="6348568">NRGBA</span><span class="op" id="6348573">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348577">for</span>&nbsp;<span class="ident" id="6348581">y</span>&nbsp;<span class="op" id="6348583">:=</span>&nbsp;<span class="ident" id="6348586">b</span><span class="op" id="6348587">.</span><span class="ident" id="6348588">Min</span><span class="op" id="6348591">.</span><span class="ident" id="6348592">Y</span><span class="op" id="6348593">;</span>&nbsp;<span class="ident" id="6348595">y</span>&nbsp;<span class="op" id="6348597">&lt;</span>&nbsp;<span class="ident" id="6348599">b</span><span class="op" id="6348600">.</span><span class="ident" id="6348601">Max</span><span class="op" id="6348604">.</span><span class="ident" id="6348605">Y</span><span class="op" id="6348606">;</span>&nbsp;<span class="ident" id="6348608">y</span><span class="op" id="6348609">++</span>&nbsp;<span class="op" id="6348612">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348616">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348651">i</span>&nbsp;<span class="op" id="6348653">:=</span>&nbsp;<span class="num" id="6348656">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348660">switch</span>&nbsp;<span class="ident" id="6348667">cb</span>&nbsp;<span class="op" id="6348670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348674">case</span>&nbsp;<span class="ident" id="6348679">cbG8</span><span class="op" id="6348683">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348688">if</span>&nbsp;<span class="ident" id="6348691">gray</span>&nbsp;<span class="op" id="6348696">!=</span>&nbsp;<span class="builtintype" id="6348699">nil</span>&nbsp;<span class="op" id="6348703">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348709">offset</span>&nbsp;<span class="op" id="6348716">:=</span>&nbsp;<span class="op" id="6348719">(</span><span class="ident" id="6348720">y</span>&nbsp;<span class="op" id="6348722">-</span>&nbsp;<span class="ident" id="6348724">b</span><span class="op" id="6348725">.</span><span class="ident" id="6348726">Min</span><span class="op" id="6348729">.</span><span class="ident" id="6348730">Y</span><span class="op" id="6348731">)</span>&nbsp;<span class="op" id="6348733">*</span>&nbsp;<span class="ident" id="6348735">gray</span><span class="op" id="6348739">.</span><span class="ident" id="6348740">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6348751">copy</span><span class="op" id="6348755">(</span><span class="ident" id="6348756">cr</span><span class="op" id="6348758">[</span><span class="num" id="6348759">0</span><span class="op" id="6348760">]</span><span class="op" id="6348761">[</span><span class="num" id="6348762">1</span><span class="op" id="6348763">:</span><span class="op" id="6348764">]</span><span class="op" id="6348765">,</span>&nbsp;<span class="ident" id="6348767">gray</span><span class="op" id="6348771">.</span><span class="ident" id="6348772">Pix</span><span class="op" id="6348775">[</span><span class="ident" id="6348776">offset</span><span class="op" id="6348782">:</span><span class="ident" id="6348783">offset</span><span class="op" id="6348789">+</span><span class="ident" id="6348790">b</span><span class="op" id="6348791">.</span><span class="ident" id="6348792">Dx</span><span class="op" id="6348794">(</span><span class="op" id="6348795">)</span><span class="op" id="6348796">]</span><span class="op" id="6348797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6348802">}</span>&nbsp;<span class="keyword" id="6348804">else</span>&nbsp;<span class="op" id="6348809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348815">for</span>&nbsp;<span class="ident" id="6348819">x</span>&nbsp;<span class="op" id="6348821">:=</span>&nbsp;<span class="ident" id="6348824">b</span><span class="op" id="6348825">.</span><span class="ident" id="6348826">Min</span><span class="op" id="6348829">.</span><span class="ident" id="6348830">X</span><span class="op" id="6348831">;</span>&nbsp;<span class="ident" id="6348833">x</span>&nbsp;<span class="op" id="6348835">&lt;</span>&nbsp;<span class="ident" id="6348837">b</span><span class="op" id="6348838">.</span><span class="ident" id="6348839">Max</span><span class="op" id="6348842">.</span><span class="ident" id="6348843">X</span><span class="op" id="6348844">;</span>&nbsp;<span class="ident" id="6348846">x</span><span class="op" id="6348847">++</span>&nbsp;<span class="op" id="6348850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348857">c</span>&nbsp;<span class="op" id="6348859">:=</span>&nbsp;<span class="ident" id="6348862">color</span><span class="op" id="6348867">.</span><span class="ident" id="6348868">GrayModel</span><span class="op" id="6348877">.</span><span class="ident" id="6348878">Convert</span><span class="op" id="6348885">(</span><span class="ident" id="6348886">m</span><span class="op" id="6348887">.</span><span class="ident" id="6348888">At</span><span class="op" id="6348890">(</span><span class="ident" id="6348891">x</span><span class="op" id="6348892">,</span>&nbsp;<span class="ident" id="6348894">y</span><span class="op" id="6348895">)</span><span class="op" id="6348896">)</span><span class="op" id="6348897">.</span><span class="op" id="6348898">(</span><span class="ident" id="6348899">color</span><span class="op" id="6348904">.</span><span class="ident" id="6348905">Gray</span><span class="op" id="6348909">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348916">cr</span><span class="op" id="6348918">[</span><span class="num" id="6348919">0</span><span class="op" id="6348920">]</span><span class="op" id="6348921">[</span><span class="ident" id="6348922">i</span><span class="op" id="6348923">]</span>&nbsp;<span class="op" id="6348925">=</span>&nbsp;<span class="ident" id="6348927">c</span><span class="op" id="6348928">.</span><span class="ident" id="6348929">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6348936">i</span><span class="op" id="6348937">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6348944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6348949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6348953">case</span>&nbsp;<span class="ident" id="6348958">cbTC8</span><span class="op" id="6348963">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6348968">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349040">cr0</span>&nbsp;<span class="op" id="6349044">:=</span>&nbsp;<span class="ident" id="6349047">cr</span><span class="op" id="6349049">[</span><span class="num" id="6349050">0</span><span class="op" id="6349051">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349056">stride</span><span class="op" id="6349062">,</span>&nbsp;<span class="ident" id="6349064">pix</span>&nbsp;<span class="op" id="6349068">:=</span>&nbsp;<span class="num" id="6349071">0</span><span class="op" id="6349072">,</span>&nbsp;<span class="op" id="6349074">[</span><span class="op" id="6349075">]</span><span class="builtintype" id="6349076">byte</span><span class="op" id="6349080">(</span><span class="builtintype" id="6349081">nil</span><span class="op" id="6349084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349089">if</span>&nbsp;<span class="ident" id="6349092">rgba</span>&nbsp;<span class="op" id="6349097">!=</span>&nbsp;<span class="builtintype" id="6349100">nil</span>&nbsp;<span class="op" id="6349104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349110">stride</span><span class="op" id="6349116">,</span>&nbsp;<span class="ident" id="6349118">pix</span>&nbsp;<span class="op" id="6349122">=</span>&nbsp;<span class="ident" id="6349124">rgba</span><span class="op" id="6349128">.</span><span class="ident" id="6349129">Stride</span><span class="op" id="6349135">,</span>&nbsp;<span class="ident" id="6349137">rgba</span><span class="op" id="6349141">.</span><span class="ident" id="6349142">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349149">}</span>&nbsp;<span class="keyword" id="6349151">else</span>&nbsp;<span class="keyword" id="6349156">if</span>&nbsp;<span class="ident" id="6349159">nrgba</span>&nbsp;<span class="op" id="6349165">!=</span>&nbsp;<span class="builtintype" id="6349168">nil</span>&nbsp;<span class="op" id="6349172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349178">stride</span><span class="op" id="6349184">,</span>&nbsp;<span class="ident" id="6349186">pix</span>&nbsp;<span class="op" id="6349190">=</span>&nbsp;<span class="ident" id="6349192">nrgba</span><span class="op" id="6349197">.</span><span class="ident" id="6349198">Stride</span><span class="op" id="6349204">,</span>&nbsp;<span class="ident" id="6349206">nrgba</span><span class="op" id="6349211">.</span><span class="ident" id="6349212">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349224">if</span>&nbsp;<span class="ident" id="6349227">stride</span>&nbsp;<span class="op" id="6349234">!=</span>&nbsp;<span class="num" id="6349237">0</span>&nbsp;<span class="op" id="6349239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349245">j0</span>&nbsp;<span class="op" id="6349248">:=</span>&nbsp;<span class="op" id="6349251">(</span><span class="ident" id="6349252">y</span>&nbsp;<span class="op" id="6349254">-</span>&nbsp;<span class="ident" id="6349256">b</span><span class="op" id="6349257">.</span><span class="ident" id="6349258">Min</span><span class="op" id="6349261">.</span><span class="ident" id="6349262">Y</span><span class="op" id="6349263">)</span>&nbsp;<span class="op" id="6349265">*</span>&nbsp;<span class="ident" id="6349267">stride</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349278">j1</span>&nbsp;<span class="op" id="6349281">:=</span>&nbsp;<span class="ident" id="6349284">j0</span>&nbsp;<span class="op" id="6349287">+</span>&nbsp;<span class="ident" id="6349289">b</span><span class="op" id="6349290">.</span><span class="ident" id="6349291">Dx</span><span class="op" id="6349293">(</span><span class="op" id="6349294">)</span><span class="op" id="6349295">*</span><span class="num" id="6349296">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349302">for</span>&nbsp;<span class="ident" id="6349306">j</span>&nbsp;<span class="op" id="6349308">:=</span>&nbsp;<span class="ident" id="6349311">j0</span><span class="op" id="6349313">;</span>&nbsp;<span class="ident" id="6349315">j</span>&nbsp;<span class="op" id="6349317">&lt;</span>&nbsp;<span class="ident" id="6349319">j1</span><span class="op" id="6349321">;</span>&nbsp;<span class="ident" id="6349323">j</span>&nbsp;<span class="op" id="6349325">+=</span>&nbsp;<span class="num" id="6349328">4</span>&nbsp;<span class="op" id="6349330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349337">cr0</span><span class="op" id="6349340">[</span><span class="ident" id="6349341">i</span><span class="op" id="6349342">+</span><span class="num" id="6349343">0</span><span class="op" id="6349344">]</span>&nbsp;<span class="op" id="6349346">=</span>&nbsp;<span class="ident" id="6349348">pix</span><span class="op" id="6349351">[</span><span class="ident" id="6349352">j</span><span class="op" id="6349353">+</span><span class="num" id="6349354">0</span><span class="op" id="6349355">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349362">cr0</span><span class="op" id="6349365">[</span><span class="ident" id="6349366">i</span><span class="op" id="6349367">+</span><span class="num" id="6349368">1</span><span class="op" id="6349369">]</span>&nbsp;<span class="op" id="6349371">=</span>&nbsp;<span class="ident" id="6349373">pix</span><span class="op" id="6349376">[</span><span class="ident" id="6349377">j</span><span class="op" id="6349378">+</span><span class="num" id="6349379">1</span><span class="op" id="6349380">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349387">cr0</span><span class="op" id="6349390">[</span><span class="ident" id="6349391">i</span><span class="op" id="6349392">+</span><span class="num" id="6349393">2</span><span class="op" id="6349394">]</span>&nbsp;<span class="op" id="6349396">=</span>&nbsp;<span class="ident" id="6349398">pix</span><span class="op" id="6349401">[</span><span class="ident" id="6349402">j</span><span class="op" id="6349403">+</span><span class="num" id="6349404">2</span><span class="op" id="6349405">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349412">i</span>&nbsp;<span class="op" id="6349414">+=</span>&nbsp;<span class="num" id="6349417">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349428">}</span>&nbsp;<span class="keyword" id="6349430">else</span>&nbsp;<span class="op" id="6349435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349441">for</span>&nbsp;<span class="ident" id="6349445">x</span>&nbsp;<span class="op" id="6349447">:=</span>&nbsp;<span class="ident" id="6349450">b</span><span class="op" id="6349451">.</span><span class="ident" id="6349452">Min</span><span class="op" id="6349455">.</span><span class="ident" id="6349456">X</span><span class="op" id="6349457">;</span>&nbsp;<span class="ident" id="6349459">x</span>&nbsp;<span class="op" id="6349461">&lt;</span>&nbsp;<span class="ident" id="6349463">b</span><span class="op" id="6349464">.</span><span class="ident" id="6349465">Max</span><span class="op" id="6349468">.</span><span class="ident" id="6349469">X</span><span class="op" id="6349470">;</span>&nbsp;<span class="ident" id="6349472">x</span><span class="op" id="6349473">++</span>&nbsp;<span class="op" id="6349476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349483">r</span><span class="op" id="6349484">,</span>&nbsp;<span class="ident" id="6349486">g</span><span class="op" id="6349487">,</span>&nbsp;<span class="ident" id="6349489">b</span><span class="op" id="6349490">,</span>&nbsp;<span class="ident" id="6349492">_</span>&nbsp;<span class="op" id="6349494">:=</span>&nbsp;<span class="ident" id="6349497">m</span><span class="op" id="6349498">.</span><span class="ident" id="6349499">At</span><span class="op" id="6349501">(</span><span class="ident" id="6349502">x</span><span class="op" id="6349503">,</span>&nbsp;<span class="ident" id="6349505">y</span><span class="op" id="6349506">)</span><span class="op" id="6349507">.</span><span class="ident" id="6349508">RGBA</span><span class="op" id="6349512">(</span><span class="op" id="6349513">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349520">cr0</span><span class="op" id="6349523">[</span><span class="ident" id="6349524">i</span><span class="op" id="6349525">+</span><span class="num" id="6349526">0</span><span class="op" id="6349527">]</span>&nbsp;<span class="op" id="6349529">=</span>&nbsp;<span class="builtintype" id="6349531">uint8</span><span class="op" id="6349536">(</span><span class="ident" id="6349537">r</span>&nbsp;<span class="op" id="6349539">&gt;&gt;</span>&nbsp;<span class="num" id="6349542">8</span><span class="op" id="6349543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349550">cr0</span><span class="op" id="6349553">[</span><span class="ident" id="6349554">i</span><span class="op" id="6349555">+</span><span class="num" id="6349556">1</span><span class="op" id="6349557">]</span>&nbsp;<span class="op" id="6349559">=</span>&nbsp;<span class="builtintype" id="6349561">uint8</span><span class="op" id="6349566">(</span><span class="ident" id="6349567">g</span>&nbsp;<span class="op" id="6349569">&gt;&gt;</span>&nbsp;<span class="num" id="6349572">8</span><span class="op" id="6349573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349580">cr0</span><span class="op" id="6349583">[</span><span class="ident" id="6349584">i</span><span class="op" id="6349585">+</span><span class="num" id="6349586">2</span><span class="op" id="6349587">]</span>&nbsp;<span class="op" id="6349589">=</span>&nbsp;<span class="builtintype" id="6349591">uint8</span><span class="op" id="6349596">(</span><span class="ident" id="6349597">b</span>&nbsp;<span class="op" id="6349599">&gt;&gt;</span>&nbsp;<span class="num" id="6349602">8</span><span class="op" id="6349603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349610">i</span>&nbsp;<span class="op" id="6349612">+=</span>&nbsp;<span class="num" id="6349615">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349621">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349630">case</span>&nbsp;<span class="ident" id="6349635">cbP8</span><span class="op" id="6349639">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349644">if</span>&nbsp;<span class="ident" id="6349647">paletted</span>&nbsp;<span class="op" id="6349656">!=</span>&nbsp;<span class="builtintype" id="6349659">nil</span>&nbsp;<span class="op" id="6349663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349669">offset</span>&nbsp;<span class="op" id="6349676">:=</span>&nbsp;<span class="op" id="6349679">(</span><span class="ident" id="6349680">y</span>&nbsp;<span class="op" id="6349682">-</span>&nbsp;<span class="ident" id="6349684">b</span><span class="op" id="6349685">.</span><span class="ident" id="6349686">Min</span><span class="op" id="6349689">.</span><span class="ident" id="6349690">Y</span><span class="op" id="6349691">)</span>&nbsp;<span class="op" id="6349693">*</span>&nbsp;<span class="ident" id="6349695">paletted</span><span class="op" id="6349703">.</span><span class="ident" id="6349704">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6349715">copy</span><span class="op" id="6349719">(</span><span class="ident" id="6349720">cr</span><span class="op" id="6349722">[</span><span class="num" id="6349723">0</span><span class="op" id="6349724">]</span><span class="op" id="6349725">[</span><span class="num" id="6349726">1</span><span class="op" id="6349727">:</span><span class="op" id="6349728">]</span><span class="op" id="6349729">,</span>&nbsp;<span class="ident" id="6349731">paletted</span><span class="op" id="6349739">.</span><span class="ident" id="6349740">Pix</span><span class="op" id="6349743">[</span><span class="ident" id="6349744">offset</span><span class="op" id="6349750">:</span><span class="ident" id="6349751">offset</span><span class="op" id="6349757">+</span><span class="ident" id="6349758">b</span><span class="op" id="6349759">.</span><span class="ident" id="6349760">Dx</span><span class="op" id="6349762">(</span><span class="op" id="6349763">)</span><span class="op" id="6349764">]</span><span class="op" id="6349765">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349770">}</span>&nbsp;<span class="keyword" id="6349772">else</span>&nbsp;<span class="op" id="6349777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349783">pi</span>&nbsp;<span class="op" id="6349786">:=</span>&nbsp;<span class="ident" id="6349789">m</span><span class="op" id="6349790">.</span><span class="op" id="6349791">(</span><span class="ident" id="6349792">image</span><span class="op" id="6349797">.</span><span class="ident" id="6349798">PalettedImage</span><span class="op" id="6349811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349817">for</span>&nbsp;<span class="ident" id="6349821">x</span>&nbsp;<span class="op" id="6349823">:=</span>&nbsp;<span class="ident" id="6349826">b</span><span class="op" id="6349827">.</span><span class="ident" id="6349828">Min</span><span class="op" id="6349831">.</span><span class="ident" id="6349832">X</span><span class="op" id="6349833">;</span>&nbsp;<span class="ident" id="6349835">x</span>&nbsp;<span class="op" id="6349837">&lt;</span>&nbsp;<span class="ident" id="6349839">b</span><span class="op" id="6349840">.</span><span class="ident" id="6349841">Max</span><span class="op" id="6349844">.</span><span class="ident" id="6349845">X</span><span class="op" id="6349846">;</span>&nbsp;<span class="ident" id="6349848">x</span><span class="op" id="6349849">++</span>&nbsp;<span class="op" id="6349852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349859">cr</span><span class="op" id="6349861">[</span><span class="num" id="6349862">0</span><span class="op" id="6349863">]</span><span class="op" id="6349864">[</span><span class="ident" id="6349865">i</span><span class="op" id="6349866">]</span>&nbsp;<span class="op" id="6349868">=</span>&nbsp;<span class="ident" id="6349870">pi</span><span class="op" id="6349872">.</span><span class="ident" id="6349873">ColorIndexAt</span><span class="op" id="6349885">(</span><span class="ident" id="6349886">x</span><span class="op" id="6349887">,</span>&nbsp;<span class="ident" id="6349889">y</span><span class="op" id="6349890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349897">i</span>&nbsp;<span class="op" id="6349899">+=</span>&nbsp;<span class="num" id="6349902">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6349913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349917">case</span>&nbsp;<span class="ident" id="6349922">cbTCA8</span><span class="op" id="6349928">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6349933">if</span>&nbsp;<span class="ident" id="6349936">nrgba</span>&nbsp;<span class="op" id="6349942">!=</span>&nbsp;<span class="builtintype" id="6349945">nil</span>&nbsp;<span class="op" id="6349949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6349955">offset</span>&nbsp;<span class="op" id="6349962">:=</span>&nbsp;<span class="op" id="6349965">(</span><span class="ident" id="6349966">y</span>&nbsp;<span class="op" id="6349968">-</span>&nbsp;<span class="ident" id="6349970">b</span><span class="op" id="6349971">.</span><span class="ident" id="6349972">Min</span><span class="op" id="6349975">.</span><span class="ident" id="6349976">Y</span><span class="op" id="6349977">)</span>&nbsp;<span class="op" id="6349979">*</span>&nbsp;<span class="ident" id="6349981">nrgba</span><span class="op" id="6349986">.</span><span class="ident" id="6349987">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6349998">copy</span><span class="op" id="6350002">(</span><span class="ident" id="6350003">cr</span><span class="op" id="6350005">[</span><span class="num" id="6350006">0</span><span class="op" id="6350007">]</span><span class="op" id="6350008">[</span><span class="num" id="6350009">1</span><span class="op" id="6350010">:</span><span class="op" id="6350011">]</span><span class="op" id="6350012">,</span>&nbsp;<span class="ident" id="6350014">nrgba</span><span class="op" id="6350019">.</span><span class="ident" id="6350020">Pix</span><span class="op" id="6350023">[</span><span class="ident" id="6350024">offset</span><span class="op" id="6350030">:</span><span class="ident" id="6350031">offset</span><span class="op" id="6350037">+</span><span class="ident" id="6350038">b</span><span class="op" id="6350039">.</span><span class="ident" id="6350040">Dx</span><span class="op" id="6350042">(</span><span class="op" id="6350043">)</span><span class="op" id="6350044">*</span><span class="num" id="6350045">4</span><span class="op" id="6350046">]</span><span class="op" id="6350047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350052">}</span>&nbsp;<span class="keyword" id="6350054">else</span>&nbsp;<span class="op" id="6350059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6350065">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350162">for</span>&nbsp;<span class="ident" id="6350166">x</span>&nbsp;<span class="op" id="6350168">:=</span>&nbsp;<span class="ident" id="6350171">b</span><span class="op" id="6350172">.</span><span class="ident" id="6350173">Min</span><span class="op" id="6350176">.</span><span class="ident" id="6350177">X</span><span class="op" id="6350178">;</span>&nbsp;<span class="ident" id="6350180">x</span>&nbsp;<span class="op" id="6350182">&lt;</span>&nbsp;<span class="ident" id="6350184">b</span><span class="op" id="6350185">.</span><span class="ident" id="6350186">Max</span><span class="op" id="6350189">.</span><span class="ident" id="6350190">X</span><span class="op" id="6350191">;</span>&nbsp;<span class="ident" id="6350193">x</span><span class="op" id="6350194">++</span>&nbsp;<span class="op" id="6350197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350204">c</span>&nbsp;<span class="op" id="6350206">:=</span>&nbsp;<span class="ident" id="6350209">color</span><span class="op" id="6350214">.</span><span class="ident" id="6350215">NRGBAModel</span><span class="op" id="6350225">.</span><span class="ident" id="6350226">Convert</span><span class="op" id="6350233">(</span><span class="ident" id="6350234">m</span><span class="op" id="6350235">.</span><span class="ident" id="6350236">At</span><span class="op" id="6350238">(</span><span class="ident" id="6350239">x</span><span class="op" id="6350240">,</span>&nbsp;<span class="ident" id="6350242">y</span><span class="op" id="6350243">)</span><span class="op" id="6350244">)</span><span class="op" id="6350245">.</span><span class="op" id="6350246">(</span><span class="ident" id="6350247">color</span><span class="op" id="6350252">.</span><span class="ident" id="6350253">NRGBA</span><span class="op" id="6350258">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350265">cr</span><span class="op" id="6350267">[</span><span class="num" id="6350268">0</span><span class="op" id="6350269">]</span><span class="op" id="6350270">[</span><span class="ident" id="6350271">i</span><span class="op" id="6350272">+</span><span class="num" id="6350273">0</span><span class="op" id="6350274">]</span>&nbsp;<span class="op" id="6350276">=</span>&nbsp;<span class="ident" id="6350278">c</span><span class="op" id="6350279">.</span><span class="ident" id="6350280">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350287">cr</span><span class="op" id="6350289">[</span><span class="num" id="6350290">0</span><span class="op" id="6350291">]</span><span class="op" id="6350292">[</span><span class="ident" id="6350293">i</span><span class="op" id="6350294">+</span><span class="num" id="6350295">1</span><span class="op" id="6350296">]</span>&nbsp;<span class="op" id="6350298">=</span>&nbsp;<span class="ident" id="6350300">c</span><span class="op" id="6350301">.</span><span class="ident" id="6350302">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350309">cr</span><span class="op" id="6350311">[</span><span class="num" id="6350312">0</span><span class="op" id="6350313">]</span><span class="op" id="6350314">[</span><span class="ident" id="6350315">i</span><span class="op" id="6350316">+</span><span class="num" id="6350317">2</span><span class="op" id="6350318">]</span>&nbsp;<span class="op" id="6350320">=</span>&nbsp;<span class="ident" id="6350322">c</span><span class="op" id="6350323">.</span><span class="ident" id="6350324">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350331">cr</span><span class="op" id="6350333">[</span><span class="num" id="6350334">0</span><span class="op" id="6350335">]</span><span class="op" id="6350336">[</span><span class="ident" id="6350337">i</span><span class="op" id="6350338">+</span><span class="num" id="6350339">3</span><span class="op" id="6350340">]</span>&nbsp;<span class="op" id="6350342">=</span>&nbsp;<span class="ident" id="6350344">c</span><span class="op" id="6350345">.</span><span class="ident" id="6350346">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350353">i</span>&nbsp;<span class="op" id="6350355">+=</span>&nbsp;<span class="num" id="6350358">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350373">case</span>&nbsp;<span class="ident" id="6350378">cbG16</span><span class="op" id="6350383">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350388">for</span>&nbsp;<span class="ident" id="6350392">x</span>&nbsp;<span class="op" id="6350394">:=</span>&nbsp;<span class="ident" id="6350397">b</span><span class="op" id="6350398">.</span><span class="ident" id="6350399">Min</span><span class="op" id="6350402">.</span><span class="ident" id="6350403">X</span><span class="op" id="6350404">;</span>&nbsp;<span class="ident" id="6350406">x</span>&nbsp;<span class="op" id="6350408">&lt;</span>&nbsp;<span class="ident" id="6350410">b</span><span class="op" id="6350411">.</span><span class="ident" id="6350412">Max</span><span class="op" id="6350415">.</span><span class="ident" id="6350416">X</span><span class="op" id="6350417">;</span>&nbsp;<span class="ident" id="6350419">x</span><span class="op" id="6350420">++</span>&nbsp;<span class="op" id="6350423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350429">c</span>&nbsp;<span class="op" id="6350431">:=</span>&nbsp;<span class="ident" id="6350434">color</span><span class="op" id="6350439">.</span><span class="ident" id="6350440">Gray16Model</span><span class="op" id="6350451">.</span><span class="ident" id="6350452">Convert</span><span class="op" id="6350459">(</span><span class="ident" id="6350460">m</span><span class="op" id="6350461">.</span><span class="ident" id="6350462">At</span><span class="op" id="6350464">(</span><span class="ident" id="6350465">x</span><span class="op" id="6350466">,</span>&nbsp;<span class="ident" id="6350468">y</span><span class="op" id="6350469">)</span><span class="op" id="6350470">)</span><span class="op" id="6350471">.</span><span class="op" id="6350472">(</span><span class="ident" id="6350473">color</span><span class="op" id="6350478">.</span><span class="ident" id="6350479">Gray16</span><span class="op" id="6350485">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350491">cr</span><span class="op" id="6350493">[</span><span class="num" id="6350494">0</span><span class="op" id="6350495">]</span><span class="op" id="6350496">[</span><span class="ident" id="6350497">i</span><span class="op" id="6350498">+</span><span class="num" id="6350499">0</span><span class="op" id="6350500">]</span>&nbsp;<span class="op" id="6350502">=</span>&nbsp;<span class="builtintype" id="6350504">uint8</span><span class="op" id="6350509">(</span><span class="ident" id="6350510">c</span><span class="op" id="6350511">.</span><span class="ident" id="6350512">Y</span>&nbsp;<span class="op" id="6350514">&gt;&gt;</span>&nbsp;<span class="num" id="6350517">8</span><span class="op" id="6350518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350524">cr</span><span class="op" id="6350526">[</span><span class="num" id="6350527">0</span><span class="op" id="6350528">]</span><span class="op" id="6350529">[</span><span class="ident" id="6350530">i</span><span class="op" id="6350531">+</span><span class="num" id="6350532">1</span><span class="op" id="6350533">]</span>&nbsp;<span class="op" id="6350535">=</span>&nbsp;<span class="builtintype" id="6350537">uint8</span><span class="op" id="6350542">(</span><span class="ident" id="6350543">c</span><span class="op" id="6350544">.</span><span class="ident" id="6350545">Y</span><span class="op" id="6350546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350552">i</span>&nbsp;<span class="op" id="6350554">+=</span>&nbsp;<span class="num" id="6350557">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350566">case</span>&nbsp;<span class="ident" id="6350571">cbTC16</span><span class="op" id="6350577">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6350582">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350654">for</span>&nbsp;<span class="ident" id="6350658">x</span>&nbsp;<span class="op" id="6350660">:=</span>&nbsp;<span class="ident" id="6350663">b</span><span class="op" id="6350664">.</span><span class="ident" id="6350665">Min</span><span class="op" id="6350668">.</span><span class="ident" id="6350669">X</span><span class="op" id="6350670">;</span>&nbsp;<span class="ident" id="6350672">x</span>&nbsp;<span class="op" id="6350674">&lt;</span>&nbsp;<span class="ident" id="6350676">b</span><span class="op" id="6350677">.</span><span class="ident" id="6350678">Max</span><span class="op" id="6350681">.</span><span class="ident" id="6350682">X</span><span class="op" id="6350683">;</span>&nbsp;<span class="ident" id="6350685">x</span><span class="op" id="6350686">++</span>&nbsp;<span class="op" id="6350689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350695">r</span><span class="op" id="6350696">,</span>&nbsp;<span class="ident" id="6350698">g</span><span class="op" id="6350699">,</span>&nbsp;<span class="ident" id="6350701">b</span><span class="op" id="6350702">,</span>&nbsp;<span class="ident" id="6350704">_</span>&nbsp;<span class="op" id="6350706">:=</span>&nbsp;<span class="ident" id="6350709">m</span><span class="op" id="6350710">.</span><span class="ident" id="6350711">At</span><span class="op" id="6350713">(</span><span class="ident" id="6350714">x</span><span class="op" id="6350715">,</span>&nbsp;<span class="ident" id="6350717">y</span><span class="op" id="6350718">)</span><span class="op" id="6350719">.</span><span class="ident" id="6350720">RGBA</span><span class="op" id="6350724">(</span><span class="op" id="6350725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350731">cr</span><span class="op" id="6350733">[</span><span class="num" id="6350734">0</span><span class="op" id="6350735">]</span><span class="op" id="6350736">[</span><span class="ident" id="6350737">i</span><span class="op" id="6350738">+</span><span class="num" id="6350739">0</span><span class="op" id="6350740">]</span>&nbsp;<span class="op" id="6350742">=</span>&nbsp;<span class="builtintype" id="6350744">uint8</span><span class="op" id="6350749">(</span><span class="ident" id="6350750">r</span>&nbsp;<span class="op" id="6350752">&gt;&gt;</span>&nbsp;<span class="num" id="6350755">8</span><span class="op" id="6350756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350762">cr</span><span class="op" id="6350764">[</span><span class="num" id="6350765">0</span><span class="op" id="6350766">]</span><span class="op" id="6350767">[</span><span class="ident" id="6350768">i</span><span class="op" id="6350769">+</span><span class="num" id="6350770">1</span><span class="op" id="6350771">]</span>&nbsp;<span class="op" id="6350773">=</span>&nbsp;<span class="builtintype" id="6350775">uint8</span><span class="op" id="6350780">(</span><span class="ident" id="6350781">r</span><span class="op" id="6350782">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350788">cr</span><span class="op" id="6350790">[</span><span class="num" id="6350791">0</span><span class="op" id="6350792">]</span><span class="op" id="6350793">[</span><span class="ident" id="6350794">i</span><span class="op" id="6350795">+</span><span class="num" id="6350796">2</span><span class="op" id="6350797">]</span>&nbsp;<span class="op" id="6350799">=</span>&nbsp;<span class="builtintype" id="6350801">uint8</span><span class="op" id="6350806">(</span><span class="ident" id="6350807">g</span>&nbsp;<span class="op" id="6350809">&gt;&gt;</span>&nbsp;<span class="num" id="6350812">8</span><span class="op" id="6350813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350819">cr</span><span class="op" id="6350821">[</span><span class="num" id="6350822">0</span><span class="op" id="6350823">]</span><span class="op" id="6350824">[</span><span class="ident" id="6350825">i</span><span class="op" id="6350826">+</span><span class="num" id="6350827">3</span><span class="op" id="6350828">]</span>&nbsp;<span class="op" id="6350830">=</span>&nbsp;<span class="builtintype" id="6350832">uint8</span><span class="op" id="6350837">(</span><span class="ident" id="6350838">g</span><span class="op" id="6350839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350845">cr</span><span class="op" id="6350847">[</span><span class="num" id="6350848">0</span><span class="op" id="6350849">]</span><span class="op" id="6350850">[</span><span class="ident" id="6350851">i</span><span class="op" id="6350852">+</span><span class="num" id="6350853">4</span><span class="op" id="6350854">]</span>&nbsp;<span class="op" id="6350856">=</span>&nbsp;<span class="builtintype" id="6350858">uint8</span><span class="op" id="6350863">(</span><span class="ident" id="6350864">b</span>&nbsp;<span class="op" id="6350866">&gt;&gt;</span>&nbsp;<span class="num" id="6350869">8</span><span class="op" id="6350870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350876">cr</span><span class="op" id="6350878">[</span><span class="num" id="6350879">0</span><span class="op" id="6350880">]</span><span class="op" id="6350881">[</span><span class="ident" id="6350882">i</span><span class="op" id="6350883">+</span><span class="num" id="6350884">5</span><span class="op" id="6350885">]</span>&nbsp;<span class="op" id="6350887">=</span>&nbsp;<span class="builtintype" id="6350889">uint8</span><span class="op" id="6350894">(</span><span class="ident" id="6350895">b</span><span class="op" id="6350896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6350902">i</span>&nbsp;<span class="op" id="6350904">+=</span>&nbsp;<span class="num" id="6350907">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6350912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6350916">case</span>&nbsp;<span class="ident" id="6350921">cbTCA16</span><span class="op" id="6350928">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6350933">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351029">for</span>&nbsp;<span class="ident" id="6351033">x</span>&nbsp;<span class="op" id="6351035">:=</span>&nbsp;<span class="ident" id="6351038">b</span><span class="op" id="6351039">.</span><span class="ident" id="6351040">Min</span><span class="op" id="6351043">.</span><span class="ident" id="6351044">X</span><span class="op" id="6351045">;</span>&nbsp;<span class="ident" id="6351047">x</span>&nbsp;<span class="op" id="6351049">&lt;</span>&nbsp;<span class="ident" id="6351051">b</span><span class="op" id="6351052">.</span><span class="ident" id="6351053">Max</span><span class="op" id="6351056">.</span><span class="ident" id="6351057">X</span><span class="op" id="6351058">;</span>&nbsp;<span class="ident" id="6351060">x</span><span class="op" id="6351061">++</span>&nbsp;<span class="op" id="6351064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351070">c</span>&nbsp;<span class="op" id="6351072">:=</span>&nbsp;<span class="ident" id="6351075">color</span><span class="op" id="6351080">.</span><span class="ident" id="6351081">NRGBA64Model</span><span class="op" id="6351093">.</span><span class="ident" id="6351094">Convert</span><span class="op" id="6351101">(</span><span class="ident" id="6351102">m</span><span class="op" id="6351103">.</span><span class="ident" id="6351104">At</span><span class="op" id="6351106">(</span><span class="ident" id="6351107">x</span><span class="op" id="6351108">,</span>&nbsp;<span class="ident" id="6351110">y</span><span class="op" id="6351111">)</span><span class="op" id="6351112">)</span><span class="op" id="6351113">.</span><span class="op" id="6351114">(</span><span class="ident" id="6351115">color</span><span class="op" id="6351120">.</span><span class="ident" id="6351121">NRGBA64</span><span class="op" id="6351128">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351134">cr</span><span class="op" id="6351136">[</span><span class="num" id="6351137">0</span><span class="op" id="6351138">]</span><span class="op" id="6351139">[</span><span class="ident" id="6351140">i</span><span class="op" id="6351141">+</span><span class="num" id="6351142">0</span><span class="op" id="6351143">]</span>&nbsp;<span class="op" id="6351145">=</span>&nbsp;<span class="builtintype" id="6351147">uint8</span><span class="op" id="6351152">(</span><span class="ident" id="6351153">c</span><span class="op" id="6351154">.</span><span class="ident" id="6351155">R</span>&nbsp;<span class="op" id="6351157">&gt;&gt;</span>&nbsp;<span class="num" id="6351160">8</span><span class="op" id="6351161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351167">cr</span><span class="op" id="6351169">[</span><span class="num" id="6351170">0</span><span class="op" id="6351171">]</span><span class="op" id="6351172">[</span><span class="ident" id="6351173">i</span><span class="op" id="6351174">+</span><span class="num" id="6351175">1</span><span class="op" id="6351176">]</span>&nbsp;<span class="op" id="6351178">=</span>&nbsp;<span class="builtintype" id="6351180">uint8</span><span class="op" id="6351185">(</span><span class="ident" id="6351186">c</span><span class="op" id="6351187">.</span><span class="ident" id="6351188">R</span><span class="op" id="6351189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351195">cr</span><span class="op" id="6351197">[</span><span class="num" id="6351198">0</span><span class="op" id="6351199">]</span><span class="op" id="6351200">[</span><span class="ident" id="6351201">i</span><span class="op" id="6351202">+</span><span class="num" id="6351203">2</span><span class="op" id="6351204">]</span>&nbsp;<span class="op" id="6351206">=</span>&nbsp;<span class="builtintype" id="6351208">uint8</span><span class="op" id="6351213">(</span><span class="ident" id="6351214">c</span><span class="op" id="6351215">.</span><span class="ident" id="6351216">G</span>&nbsp;<span class="op" id="6351218">&gt;&gt;</span>&nbsp;<span class="num" id="6351221">8</span><span class="op" id="6351222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351228">cr</span><span class="op" id="6351230">[</span><span class="num" id="6351231">0</span><span class="op" id="6351232">]</span><span class="op" id="6351233">[</span><span class="ident" id="6351234">i</span><span class="op" id="6351235">+</span><span class="num" id="6351236">3</span><span class="op" id="6351237">]</span>&nbsp;<span class="op" id="6351239">=</span>&nbsp;<span class="builtintype" id="6351241">uint8</span><span class="op" id="6351246">(</span><span class="ident" id="6351247">c</span><span class="op" id="6351248">.</span><span class="ident" id="6351249">G</span><span class="op" id="6351250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351256">cr</span><span class="op" id="6351258">[</span><span class="num" id="6351259">0</span><span class="op" id="6351260">]</span><span class="op" id="6351261">[</span><span class="ident" id="6351262">i</span><span class="op" id="6351263">+</span><span class="num" id="6351264">4</span><span class="op" id="6351265">]</span>&nbsp;<span class="op" id="6351267">=</span>&nbsp;<span class="builtintype" id="6351269">uint8</span><span class="op" id="6351274">(</span><span class="ident" id="6351275">c</span><span class="op" id="6351276">.</span><span class="ident" id="6351277">B</span>&nbsp;<span class="op" id="6351279">&gt;&gt;</span>&nbsp;<span class="num" id="6351282">8</span><span class="op" id="6351283">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351289">cr</span><span class="op" id="6351291">[</span><span class="num" id="6351292">0</span><span class="op" id="6351293">]</span><span class="op" id="6351294">[</span><span class="ident" id="6351295">i</span><span class="op" id="6351296">+</span><span class="num" id="6351297">5</span><span class="op" id="6351298">]</span>&nbsp;<span class="op" id="6351300">=</span>&nbsp;<span class="builtintype" id="6351302">uint8</span><span class="op" id="6351307">(</span><span class="ident" id="6351308">c</span><span class="op" id="6351309">.</span><span class="ident" id="6351310">B</span><span class="op" id="6351311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351317">cr</span><span class="op" id="6351319">[</span><span class="num" id="6351320">0</span><span class="op" id="6351321">]</span><span class="op" id="6351322">[</span><span class="ident" id="6351323">i</span><span class="op" id="6351324">+</span><span class="num" id="6351325">6</span><span class="op" id="6351326">]</span>&nbsp;<span class="op" id="6351328">=</span>&nbsp;<span class="builtintype" id="6351330">uint8</span><span class="op" id="6351335">(</span><span class="ident" id="6351336">c</span><span class="op" id="6351337">.</span><span class="ident" id="6351338">A</span>&nbsp;<span class="op" id="6351340">&gt;&gt;</span>&nbsp;<span class="num" id="6351343">8</span><span class="op" id="6351344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351350">cr</span><span class="op" id="6351352">[</span><span class="num" id="6351353">0</span><span class="op" id="6351354">]</span><span class="op" id="6351355">[</span><span class="ident" id="6351356">i</span><span class="op" id="6351357">+</span><span class="num" id="6351358">7</span><span class="op" id="6351359">]</span>&nbsp;<span class="op" id="6351361">=</span>&nbsp;<span class="builtintype" id="6351363">uint8</span><span class="op" id="6351368">(</span><span class="ident" id="6351369">c</span><span class="op" id="6351370">.</span><span class="ident" id="6351371">A</span><span class="op" id="6351372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351378">i</span>&nbsp;<span class="op" id="6351380">+=</span>&nbsp;<span class="num" id="6351383">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6351388">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6351392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351397">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351420">f</span>&nbsp;<span class="op" id="6351422">:=</span>&nbsp;<span class="ident" id="6351425">ftNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351434">if</span>&nbsp;<span class="ident" id="6351437">level</span>&nbsp;<span class="op" id="6351443">!=</span>&nbsp;<span class="ident" id="6351446">zlib</span><span class="op" id="6351450">.</span><span class="ident" id="6351451">NoCompression</span>&nbsp;<span class="op" id="6351465">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351470">f</span>&nbsp;<span class="op" id="6351472">=</span>&nbsp;<span class="ident" id="6351474">filter</span><span class="op" id="6351480">(</span><span class="op" id="6351481">&amp;</span><span class="ident" id="6351482">cr</span><span class="op" id="6351484">,</span>&nbsp;<span class="ident" id="6351486">pr</span><span class="op" id="6351488">,</span>&nbsp;<span class="ident" id="6351490">bpp</span><span class="op" id="6351493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6351497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351502">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351535">if</span>&nbsp;<span class="ident" id="6351538">_</span><span class="op" id="6351539">,</span>&nbsp;<span class="ident" id="6351541">err</span>&nbsp;<span class="op" id="6351545">:=</span>&nbsp;<span class="ident" id="6351548">zw</span><span class="op" id="6351550">.</span><span class="ident" id="6351551">Write</span><span class="op" id="6351556">(</span><span class="ident" id="6351557">cr</span><span class="op" id="6351559">[</span><span class="ident" id="6351560">f</span><span class="op" id="6351561">]</span><span class="op" id="6351562">)</span><span class="op" id="6351563">;</span>&nbsp;<span class="ident" id="6351565">err</span>&nbsp;<span class="op" id="6351569">!=</span>&nbsp;<span class="builtintype" id="6351572">nil</span>&nbsp;<span class="op" id="6351576">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351581">return</span>&nbsp;<span class="ident" id="6351588">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6351594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6351599">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351655">pr</span><span class="op" id="6351657">,</span>&nbsp;<span class="ident" id="6351659">cr</span><span class="op" id="6351661">[</span><span class="num" id="6351662">0</span><span class="op" id="6351663">]</span>&nbsp;<span class="op" id="6351665">=</span>&nbsp;<span class="ident" id="6351667">cr</span><span class="op" id="6351669">[</span><span class="num" id="6351670">0</span><span class="op" id="6351671">]</span><span class="op" id="6351672">,</span>&nbsp;<span class="ident" id="6351674">pr</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6351678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351681">return</span>&nbsp;<span class="builtintype" id="6351688">nil</span><br>
<span class="lineno"></span><span class="op" id="6351692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6351695">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="6351754">func</span>&nbsp;<span class="op" id="6351759">(</span><span class="ident" id="6351760">e</span>&nbsp;<span class="op" id="6351762">*</span><span class="ident" id="6351763">encoder</span><span class="op" id="6351770">)</span>&nbsp;<span class="ident" id="6351772">writeIDATs</span><span class="op" id="6351782">(</span><span class="op" id="6351783">)</span>&nbsp;<span class="op" id="6351785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351788">if</span>&nbsp;<span class="ident" id="6351791">e</span><span class="op" id="6351792">.</span><span class="ident" id="6351793">err</span>&nbsp;<span class="op" id="6351797">!=</span>&nbsp;<span class="builtintype" id="6351800">nil</span>&nbsp;<span class="op" id="6351804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351808">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6351816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351819">var</span>&nbsp;<span class="ident" id="6351823">bw</span>&nbsp;<span class="op" id="6351826">*</span><span class="ident" id="6351827">bufio</span><span class="op" id="6351832">.</span><span class="ident" id="6351833">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351841">bw</span>&nbsp;<span class="op" id="6351844">=</span>&nbsp;<span class="ident" id="6351846">bufio</span><span class="op" id="6351851">.</span><span class="ident" id="6351852">NewWriterSize</span><span class="op" id="6351865">(</span><span class="ident" id="6351866">e</span><span class="op" id="6351867">,</span>&nbsp;<span class="num" id="6351869">1</span><span class="op" id="6351870">&lt;&lt;</span><span class="num" id="6351872">15</span><span class="op" id="6351874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351877">e</span><span class="op" id="6351878">.</span><span class="ident" id="6351879">err</span>&nbsp;<span class="op" id="6351883">=</span>&nbsp;<span class="ident" id="6351885">writeImage</span><span class="op" id="6351895">(</span><span class="ident" id="6351896">bw</span><span class="op" id="6351898">,</span>&nbsp;<span class="ident" id="6351900">e</span><span class="op" id="6351901">.</span><span class="ident" id="6351902">m</span><span class="op" id="6351903">,</span>&nbsp;<span class="ident" id="6351905">e</span><span class="op" id="6351906">.</span><span class="ident" id="6351907">cb</span><span class="op" id="6351909">,</span>&nbsp;<span class="ident" id="6351911">levelToZlib</span><span class="op" id="6351922">(</span><span class="ident" id="6351923">e</span><span class="op" id="6351924">.</span><span class="ident" id="6351925">enc</span><span class="op" id="6351928">.</span><span class="ident" id="6351929">CompressionLevel</span><span class="op" id="6351945">)</span><span class="op" id="6351946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351949">if</span>&nbsp;<span class="ident" id="6351952">e</span><span class="op" id="6351953">.</span><span class="ident" id="6351954">err</span>&nbsp;<span class="op" id="6351958">!=</span>&nbsp;<span class="builtintype" id="6351961">nil</span>&nbsp;<span class="op" id="6351965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6351969">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6351977">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6351980">e</span><span class="op" id="6351981">.</span><span class="ident" id="6351982">err</span>&nbsp;<span class="op" id="6351986">=</span>&nbsp;<span class="ident" id="6351988">bw</span><span class="op" id="6351990">.</span><span class="ident" id="6351991">Flush</span><span class="op" id="6351996">(</span><span class="op" id="6351997">)</span><br>
<span class="lineno"></span><span class="op" id="6351999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6352002">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="6352065">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="6352128">func</span>&nbsp;<span class="ident" id="6352133">levelToZlib</span><span class="op" id="6352144">(</span><span class="ident" id="6352145">l</span>&nbsp;<span class="ident" id="6352147">CompressionLevel</span><span class="op" id="6352163">)</span>&nbsp;<span class="builtintype" id="6352165">int</span>&nbsp;<span class="op" id="6352169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352172">switch</span>&nbsp;<span class="ident" id="6352179">l</span>&nbsp;<span class="op" id="6352181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352184">case</span>&nbsp;<span class="ident" id="6352189">DefaultCompression</span><span class="op" id="6352207">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352211">return</span>&nbsp;<span class="ident" id="6352218">zlib</span><span class="op" id="6352222">.</span><span class="ident" id="6352223">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352243">case</span>&nbsp;<span class="ident" id="6352248">NoCompression</span><span class="op" id="6352261">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352265">return</span>&nbsp;<span class="ident" id="6352272">zlib</span><span class="op" id="6352276">.</span><span class="ident" id="6352277">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352292">case</span>&nbsp;<span class="ident" id="6352297">BestSpeed</span><span class="op" id="6352306">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352310">return</span>&nbsp;<span class="ident" id="6352317">zlib</span><span class="op" id="6352321">.</span><span class="ident" id="6352322">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352333">case</span>&nbsp;<span class="ident" id="6352338">BestCompression</span><span class="op" id="6352353">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352357">return</span>&nbsp;<span class="ident" id="6352364">zlib</span><span class="op" id="6352368">.</span><span class="ident" id="6352369">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352386">default</span><span class="op" id="6352393">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352397">return</span>&nbsp;<span class="ident" id="6352404">zlib</span><span class="op" id="6352408">.</span><span class="ident" id="6352409">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6352429">}</span><br>
<span class="lineno"></span><span class="op" id="6352431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="6352434">func</span>&nbsp;<span class="op" id="6352439">(</span><span class="ident" id="6352440">e</span>&nbsp;<span class="op" id="6352442">*</span><span class="ident" id="6352443">encoder</span><span class="op" id="6352450">)</span>&nbsp;<span class="ident" id="6352452">writeIEND</span><span class="op" id="6352461">(</span><span class="op" id="6352462">)</span>&nbsp;<span class="op" id="6352464">{</span>&nbsp;<span class="ident" id="6352466">e</span><span class="op" id="6352467">.</span><span class="ident" id="6352468">writeChunk</span><span class="op" id="6352478">(</span><span class="builtintype" id="6352479">nil</span><span class="op" id="6352482">,</span>&nbsp;<span class="string" id="6352484">&#34;IEND&#34;</span><span class="op" id="6352490">)</span>&nbsp;<span class="op" id="6352492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6352495">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6352561">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="6352635">func</span>&nbsp;<span class="ident" id="6352640">Encode</span><span class="op" id="6352646">(</span><span class="ident" id="6352647">w</span>&nbsp;<span class="ident" id="6352649">io</span><span class="op" id="6352651">.</span><span class="ident" id="6352652">Writer</span><span class="op" id="6352658">,</span>&nbsp;<span class="ident" id="6352660">m</span>&nbsp;<span class="ident" id="6352662">image</span><span class="op" id="6352667">.</span><span class="ident" id="6352668">Image</span><span class="op" id="6352673">)</span>&nbsp;<span class="builtintype" id="6352675">error</span>&nbsp;<span class="op" id="6352681">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352684">var</span>&nbsp;<span class="ident" id="6352688">e</span>&nbsp;<span class="ident" id="6352690">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6352699">return</span>&nbsp;<span class="ident" id="6352706">e</span><span class="op" id="6352707">.</span><span class="ident" id="6352708">Encode</span><span class="op" id="6352714">(</span><span class="ident" id="6352715">w</span><span class="op" id="6352716">,</span>&nbsp;<span class="ident" id="6352718">m</span><span class="op" id="6352719">)</span><br>
<span class="lineno"></span><span class="op" id="6352721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6352724">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="6352773">func</span>&nbsp;<span class="op" id="6352778">(</span><span class="ident" id="6352779">enc</span>&nbsp;<span class="op" id="6352783">*</span><span class="ident" id="6352784">Encoder</span><span class="op" id="6352791">)</span>&nbsp;<span class="ident" id="6352793">Encode</span><span class="op" id="6352799">(</span><span class="ident" id="6352800">w</span>&nbsp;<span class="ident" id="6352802">io</span><span class="op" id="6352804">.</span><span class="ident" id="6352805">Writer</span><span class="op" id="6352811">,</span>&nbsp;<span class="ident" id="6352813">m</span>&nbsp;<span class="ident" id="6352815">image</span><span class="op" id="6352820">.</span><span class="ident" id="6352821">Image</span><span class="op" id="6352826">)</span>&nbsp;<span class="builtintype" id="6352828">error</span>&nbsp;<span class="op" id="6352834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6352837">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6352914">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6352994">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353013">mw</span><span class="op" id="6353015">,</span>&nbsp;<span class="ident" id="6353017">mh</span>&nbsp;<span class="op" id="6353020">:=</span>&nbsp;<span class="ident" id="6353023">int64</span><span class="op" id="6353028">(</span><span class="ident" id="6353029">m</span><span class="op" id="6353030">.</span><span class="ident" id="6353031">Bounds</span><span class="op" id="6353037">(</span><span class="op" id="6353038">)</span><span class="op" id="6353039">.</span><span class="ident" id="6353040">Dx</span><span class="op" id="6353042">(</span><span class="op" id="6353043">)</span><span class="op" id="6353044">)</span><span class="op" id="6353045">,</span>&nbsp;<span class="ident" id="6353047">int64</span><span class="op" id="6353052">(</span><span class="ident" id="6353053">m</span><span class="op" id="6353054">.</span><span class="ident" id="6353055">Bounds</span><span class="op" id="6353061">(</span><span class="op" id="6353062">)</span><span class="op" id="6353063">.</span><span class="ident" id="6353064">Dy</span><span class="op" id="6353066">(</span><span class="op" id="6353067">)</span><span class="op" id="6353068">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353071">if</span>&nbsp;<span class="ident" id="6353074">mw</span>&nbsp;<span class="op" id="6353077">&lt;=</span>&nbsp;<span class="num" id="6353080">0</span>&nbsp;<span class="op" id="6353082">||</span>&nbsp;<span class="ident" id="6353085">mh</span>&nbsp;<span class="op" id="6353088">&lt;=</span>&nbsp;<span class="num" id="6353091">0</span>&nbsp;<span class="op" id="6353093">||</span>&nbsp;<span class="ident" id="6353096">mw</span>&nbsp;<span class="op" id="6353099">&gt;=</span>&nbsp;<span class="num" id="6353102">1</span><span class="op" id="6353103">&lt;&lt;</span><span class="num" id="6353105">32</span>&nbsp;<span class="op" id="6353108">||</span>&nbsp;<span class="ident" id="6353111">mh</span>&nbsp;<span class="op" id="6353114">&gt;=</span>&nbsp;<span class="num" id="6353117">1</span><span class="op" id="6353118">&lt;&lt;</span><span class="num" id="6353120">32</span>&nbsp;<span class="op" id="6353123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353127">return</span>&nbsp;<span class="ident" id="6353134">FormatError</span><span class="op" id="6353145">(</span><span class="string" id="6353146">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="6353169">+</span>&nbsp;<span class="ident" id="6353171">strconv</span><span class="op" id="6353178">.</span><span class="ident" id="6353179">FormatInt</span><span class="op" id="6353188">(</span><span class="ident" id="6353189">mw</span><span class="op" id="6353191">,</span>&nbsp;<span class="num" id="6353193">10</span><span class="op" id="6353195">)</span>&nbsp;<span class="op" id="6353197">+</span>&nbsp;<span class="string" id="6353199">&#34;x&#34;</span>&nbsp;<span class="op" id="6353203">+</span>&nbsp;<span class="ident" id="6353205">strconv</span><span class="op" id="6353212">.</span><span class="ident" id="6353213">FormatInt</span><span class="op" id="6353222">(</span><span class="ident" id="6353223">mh</span><span class="op" id="6353225">,</span>&nbsp;<span class="num" id="6353227">10</span><span class="op" id="6353229">)</span><span class="op" id="6353230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6353233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353237">var</span>&nbsp;<span class="ident" id="6353241">e</span>&nbsp;<span class="ident" id="6353243">encoder</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353252">e</span><span class="op" id="6353253">.</span><span class="ident" id="6353254">enc</span>&nbsp;<span class="op" id="6353258">=</span>&nbsp;<span class="ident" id="6353260">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353265">e</span><span class="op" id="6353266">.</span><span class="ident" id="6353267">w</span>&nbsp;<span class="op" id="6353269">=</span>&nbsp;<span class="ident" id="6353271">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353274">e</span><span class="op" id="6353275">.</span><span class="ident" id="6353276">m</span>&nbsp;<span class="op" id="6353278">=</span>&nbsp;<span class="ident" id="6353280">m</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353284">var</span>&nbsp;<span class="ident" id="6353288">pal</span>&nbsp;<span class="ident" id="6353292">color</span><span class="op" id="6353297">.</span><span class="ident" id="6353298">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6353307">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353368">if</span>&nbsp;<span class="ident" id="6353371">_</span><span class="op" id="6353372">,</span>&nbsp;<span class="ident" id="6353374">ok</span>&nbsp;<span class="op" id="6353377">:=</span>&nbsp;<span class="ident" id="6353380">m</span><span class="op" id="6353381">.</span><span class="op" id="6353382">(</span><span class="ident" id="6353383">image</span><span class="op" id="6353388">.</span><span class="ident" id="6353389">PalettedImage</span><span class="op" id="6353402">)</span><span class="op" id="6353403">;</span>&nbsp;<span class="ident" id="6353405">ok</span>&nbsp;<span class="op" id="6353408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353412">pal</span><span class="op" id="6353415">,</span>&nbsp;<span class="ident" id="6353417">_</span>&nbsp;<span class="op" id="6353419">=</span>&nbsp;<span class="ident" id="6353421">m</span><span class="op" id="6353422">.</span><span class="ident" id="6353423">ColorModel</span><span class="op" id="6353433">(</span><span class="op" id="6353434">)</span><span class="op" id="6353435">.</span><span class="op" id="6353436">(</span><span class="ident" id="6353437">color</span><span class="op" id="6353442">.</span><span class="ident" id="6353443">Palette</span><span class="op" id="6353450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6353453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353456">if</span>&nbsp;<span class="ident" id="6353459">pal</span>&nbsp;<span class="op" id="6353463">!=</span>&nbsp;<span class="builtintype" id="6353466">nil</span>&nbsp;<span class="op" id="6353470">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353474">e</span><span class="op" id="6353475">.</span><span class="ident" id="6353476">cb</span>&nbsp;<span class="op" id="6353479">=</span>&nbsp;<span class="ident" id="6353481">cbP8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6353487">}</span>&nbsp;<span class="keyword" id="6353489">else</span>&nbsp;<span class="op" id="6353494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353498">switch</span>&nbsp;<span class="ident" id="6353505">m</span><span class="op" id="6353506">.</span><span class="ident" id="6353507">ColorModel</span><span class="op" id="6353517">(</span><span class="op" id="6353518">)</span>&nbsp;<span class="op" id="6353520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353524">case</span>&nbsp;<span class="ident" id="6353529">color</span><span class="op" id="6353534">.</span><span class="ident" id="6353535">GrayModel</span><span class="op" id="6353544">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353549">e</span><span class="op" id="6353550">.</span><span class="ident" id="6353551">cb</span>&nbsp;<span class="op" id="6353554">=</span>&nbsp;<span class="ident" id="6353556">cbG8</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353563">case</span>&nbsp;<span class="ident" id="6353568">color</span><span class="op" id="6353573">.</span><span class="ident" id="6353574">Gray16Model</span><span class="op" id="6353585">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353590">e</span><span class="op" id="6353591">.</span><span class="ident" id="6353592">cb</span>&nbsp;<span class="op" id="6353595">=</span>&nbsp;<span class="ident" id="6353597">cbG16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353605">case</span>&nbsp;<span class="ident" id="6353610">color</span><span class="op" id="6353615">.</span><span class="ident" id="6353616">RGBAModel</span><span class="op" id="6353625">,</span>&nbsp;<span class="ident" id="6353627">color</span><span class="op" id="6353632">.</span><span class="ident" id="6353633">NRGBAModel</span><span class="op" id="6353643">,</span>&nbsp;<span class="ident" id="6353645">color</span><span class="op" id="6353650">.</span><span class="ident" id="6353651">AlphaModel</span><span class="op" id="6353661">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353666">if</span>&nbsp;<span class="ident" id="6353669">opaque</span><span class="op" id="6353675">(</span><span class="ident" id="6353676">m</span><span class="op" id="6353677">)</span>&nbsp;<span class="op" id="6353679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353685">e</span><span class="op" id="6353686">.</span><span class="ident" id="6353687">cb</span>&nbsp;<span class="op" id="6353690">=</span>&nbsp;<span class="ident" id="6353692">cbTC8</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6353701">}</span>&nbsp;<span class="keyword" id="6353703">else</span>&nbsp;<span class="op" id="6353708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353714">e</span><span class="op" id="6353715">.</span><span class="ident" id="6353716">cb</span>&nbsp;<span class="op" id="6353719">=</span>&nbsp;<span class="ident" id="6353721">cbTCA8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6353731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353735">default</span><span class="op" id="6353742">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353747">if</span>&nbsp;<span class="ident" id="6353750">opaque</span><span class="op" id="6353756">(</span><span class="ident" id="6353757">m</span><span class="op" id="6353758">)</span>&nbsp;<span class="op" id="6353760">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353766">e</span><span class="op" id="6353767">.</span><span class="ident" id="6353768">cb</span>&nbsp;<span class="op" id="6353771">=</span>&nbsp;<span class="ident" id="6353773">cbTC16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6353783">}</span>&nbsp;<span class="keyword" id="6353785">else</span>&nbsp;<span class="op" id="6353790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353796">e</span><span class="op" id="6353797">.</span><span class="ident" id="6353798">cb</span>&nbsp;<span class="op" id="6353801">=</span>&nbsp;<span class="ident" id="6353803">cbTCA16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6353814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6353818">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6353821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353825">_</span><span class="op" id="6353826">,</span>&nbsp;<span class="ident" id="6353828">e</span><span class="op" id="6353829">.</span><span class="ident" id="6353830">err</span>&nbsp;<span class="op" id="6353834">=</span>&nbsp;<span class="ident" id="6353836">io</span><span class="op" id="6353838">.</span><span class="ident" id="6353839">WriteString</span><span class="op" id="6353850">(</span><span class="ident" id="6353851">w</span><span class="op" id="6353852">,</span>&nbsp;<span class="ident" id="6353854">pngHeader</span><span class="op" id="6353863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353866">e</span><span class="op" id="6353867">.</span><span class="ident" id="6353868">writeIHDR</span><span class="op" id="6353877">(</span><span class="op" id="6353878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353881">if</span>&nbsp;<span class="ident" id="6353884">pal</span>&nbsp;<span class="op" id="6353888">!=</span>&nbsp;<span class="builtintype" id="6353891">nil</span>&nbsp;<span class="op" id="6353895">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353899">e</span><span class="op" id="6353900">.</span><span class="ident" id="6353901">writePLTEAndTRNS</span><span class="op" id="6353917">(</span><span class="ident" id="6353918">pal</span><span class="op" id="6353921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6353924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353927">e</span><span class="op" id="6353928">.</span><span class="ident" id="6353929">writeIDATs</span><span class="op" id="6353939">(</span><span class="op" id="6353940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6353943">e</span><span class="op" id="6353944">.</span><span class="ident" id="6353945">writeIEND</span><span class="op" id="6353954">(</span><span class="op" id="6353955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6353958">return</span>&nbsp;<span class="ident" id="6353965">e</span><span class="op" id="6353966">.</span><span class="ident" id="6353967">err</span><br>
<span class="lineno">530</span><span class="op" id="6353971">}</span>
</div>
</body>
</html>
