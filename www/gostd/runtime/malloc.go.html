<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1758570">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1758625">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1758679">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1758730">package</span>&nbsp;<span class="ident" id="1758738">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1758747">import</span>&nbsp;<span class="op" id="1758754">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1758757">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1758766">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1758769">const</span>&nbsp;<span class="op" id="1758775">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758778">debugMalloc</span>&nbsp;<span class="op" id="1758790">=</span>&nbsp;<span class="builtintype" id="1758792">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758800">flagNoScan</span>&nbsp;<span class="op" id="1758811">=</span>&nbsp;<span class="ident" id="1758813">_FlagNoScan</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758826">flagNoZero</span>&nbsp;<span class="op" id="1758837">=</span>&nbsp;<span class="ident" id="1758839">_FlagNoZero</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758853">maxTinySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1758867">=</span>&nbsp;<span class="ident" id="1758869">_TinySize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758880">tinySizeClass</span>&nbsp;<span class="op" id="1758894">=</span>&nbsp;<span class="ident" id="1758896">_TinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758912">maxSmallSize</span>&nbsp;&nbsp;<span class="op" id="1758926">=</span>&nbsp;<span class="ident" id="1758928">_MaxSmallSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758944">pageShift</span>&nbsp;<span class="op" id="1758954">=</span>&nbsp;<span class="ident" id="1758956">_PageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758968">pageSize</span>&nbsp;&nbsp;<span class="op" id="1758978">=</span>&nbsp;<span class="ident" id="1758980">_PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758991">pageMask</span>&nbsp;&nbsp;<span class="op" id="1759001">=</span>&nbsp;<span class="ident" id="1759003">_PageMask</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1759015">bitsPerPointer</span>&nbsp;&nbsp;<span class="op" id="1759031">=</span>&nbsp;<span class="ident" id="1759033">_BitsPerPointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1759050">bitsMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1759066">=</span>&nbsp;<span class="ident" id="1759068">_BitsMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1759079">pointersPerByte</span>&nbsp;<span class="op" id="1759095">=</span>&nbsp;<span class="ident" id="1759097">_PointersPerByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1759115">maxGCMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1759131">=</span>&nbsp;<span class="ident" id="1759133">_MaxGCMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1759145">bitsDead</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1759161">=</span>&nbsp;<span class="ident" id="1759163">_BitsDead</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1759174">bitsPointer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1759190">=</span>&nbsp;<span class="ident" id="1759192">_BitsPointer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1759207">mSpanInUse</span>&nbsp;<span class="op" id="1759218">=</span>&nbsp;<span class="ident" id="1759220">_MSpanInUse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1759234">concurrentSweep</span>&nbsp;<span class="op" id="1759250">=</span>&nbsp;<span class="ident" id="1759252">_ConcurrentSweep</span>&nbsp;<span class="op" id="1759269">!=</span>&nbsp;<span class="num" id="1759272">0</span><br>
<span class="lineno">35</span><span class="op" id="1759274">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1759277">//&nbsp;Page&nbsp;number&nbsp;(address&gt;&gt;pageShift)</span><br>
<span class="lineno"></span><span class="keyword" id="1759313">type</span>&nbsp;<span class="ident" id="1759318">pageID</span>&nbsp;<span class="builtintype" id="1759325">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1759334">//&nbsp;base&nbsp;address&nbsp;for&nbsp;all&nbsp;0-byte&nbsp;allocations</span><br>
<span class="lineno"></span><span class="keyword" id="1759377">var</span>&nbsp;<span class="ident" id="1759381">zerobase</span>&nbsp;<span class="builtintype" id="1759390">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1759399">//&nbsp;Allocate&nbsp;an&nbsp;object&nbsp;of&nbsp;size&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1759436">//&nbsp;Small&nbsp;objects&nbsp;are&nbsp;allocated&nbsp;from&nbsp;the&nbsp;per-P&nbsp;cache&#39;s&nbsp;free&nbsp;lists.</span><br>
<span class="lineno">45</span><span class="comment" id="1759502">//&nbsp;Large&nbsp;objects&nbsp;(&gt;&nbsp;32&nbsp;kB)&nbsp;are&nbsp;allocated&nbsp;straight&nbsp;from&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span><span class="keyword" id="1759567">func</span>&nbsp;<span class="ident" id="1759572">mallocgc</span><span class="op" id="1759580">(</span><span class="ident" id="1759581">size</span>&nbsp;<span class="builtintype" id="1759586">uintptr</span><span class="op" id="1759593">,</span>&nbsp;<span class="ident" id="1759595">typ</span>&nbsp;<span class="op" id="1759599">*</span><span class="ident" id="1759600">_type</span><span class="op" id="1759605">,</span>&nbsp;<span class="ident" id="1759607">flags</span>&nbsp;<span class="builtintype" id="1759613">uint32</span><span class="op" id="1759619">)</span>&nbsp;<span class="ident" id="1759621">unsafe</span><span class="op" id="1759627">.</span><span class="ident" id="1759628">Pointer</span>&nbsp;<span class="op" id="1759636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1759639">if</span>&nbsp;<span class="ident" id="1759642">size</span>&nbsp;<span class="op" id="1759647">==</span>&nbsp;<span class="num" id="1759650">0</span>&nbsp;<span class="op" id="1759652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1759656">return</span>&nbsp;<span class="ident" id="1759663">unsafe</span><span class="op" id="1759669">.</span><span class="ident" id="1759670">Pointer</span><span class="op" id="1759677">(</span><span class="op" id="1759678">&amp;</span><span class="ident" id="1759679">zerobase</span><span class="op" id="1759687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1759690">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1759693">size0</span>&nbsp;<span class="op" id="1759699">:=</span>&nbsp;<span class="ident" id="1759702">size</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1759709">if</span>&nbsp;<span class="ident" id="1759712">flags</span><span class="op" id="1759717">&amp;</span><span class="ident" id="1759718">flagNoScan</span>&nbsp;<span class="op" id="1759729">==</span>&nbsp;<span class="num" id="1759732">0</span>&nbsp;<span class="op" id="1759734">&amp;&amp;</span>&nbsp;<span class="ident" id="1759737">typ</span>&nbsp;<span class="op" id="1759741">==</span>&nbsp;<span class="ident" id="1759744">nil</span>&nbsp;<span class="op" id="1759748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1759752">gothrow</span><span class="op" id="1759759">(</span><span class="string" id="1759760">&#34;malloc&nbsp;missing&nbsp;type&#34;</span><span class="op" id="1759781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1759784">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1759788">//&nbsp;This&nbsp;function&nbsp;must&nbsp;be&nbsp;atomic&nbsp;wrt&nbsp;GC,&nbsp;but&nbsp;for&nbsp;performance&nbsp;reasons</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1759857">//&nbsp;we&nbsp;don&#39;t&nbsp;acquirem/releasem&nbsp;on&nbsp;fast&nbsp;path.&nbsp;The&nbsp;code&nbsp;below&nbsp;does&nbsp;not&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1759931">//&nbsp;split&nbsp;stack&nbsp;checks,&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;preempted&nbsp;by&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1759987">//&nbsp;Functions&nbsp;like&nbsp;roundup/add&nbsp;are&nbsp;inlined.&nbsp;And&nbsp;onM/racemalloc&nbsp;are&nbsp;nosplit.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1760063">//&nbsp;If&nbsp;debugMalloc&nbsp;=&nbsp;true,&nbsp;these&nbsp;assumptions&nbsp;are&nbsp;checked&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1760127">if</span>&nbsp;<span class="ident" id="1760130">debugMalloc</span>&nbsp;<span class="op" id="1760142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1760146">mp</span>&nbsp;<span class="op" id="1760149">:=</span>&nbsp;<span class="ident" id="1760152">acquirem</span><span class="op" id="1760160">(</span><span class="op" id="1760161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1760165">if</span>&nbsp;<span class="ident" id="1760168">mp</span><span class="op" id="1760170">.</span><span class="ident" id="1760171">mallocing</span>&nbsp;<span class="op" id="1760181">!=</span>&nbsp;<span class="num" id="1760184">0</span>&nbsp;<span class="op" id="1760186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1760191">gothrow</span><span class="op" id="1760198">(</span><span class="string" id="1760199">&#34;malloc&nbsp;deadlock&#34;</span><span class="op" id="1760216">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1760220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1760224">mp</span><span class="op" id="1760226">.</span><span class="ident" id="1760227">mallocing</span>&nbsp;<span class="op" id="1760237">=</span>&nbsp;<span class="num" id="1760239">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1760243">if</span>&nbsp;<span class="ident" id="1760246">mp</span><span class="op" id="1760248">.</span><span class="ident" id="1760249">curg</span>&nbsp;<span class="op" id="1760254">!=</span>&nbsp;<span class="ident" id="1760257">nil</span>&nbsp;<span class="op" id="1760261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1760266">mp</span><span class="op" id="1760268">.</span><span class="ident" id="1760269">curg</span><span class="op" id="1760273">.</span><span class="ident" id="1760274">stackguard0</span>&nbsp;<span class="op" id="1760286">=</span>&nbsp;<span class="op" id="1760288">^</span><span class="builtintype" id="1760289">uintptr</span><span class="op" id="1760296">(</span><span class="num" id="1760297">0xfff</span><span class="op" id="1760302">)</span>&nbsp;<span class="op" id="1760304">|</span>&nbsp;<span class="num" id="1760306">0xbad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1760314">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1760317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1760321">c</span>&nbsp;<span class="op" id="1760323">:=</span>&nbsp;<span class="ident" id="1760326">gomcache</span><span class="op" id="1760334">(</span><span class="op" id="1760335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1760338">var</span>&nbsp;<span class="ident" id="1760342">s</span>&nbsp;<span class="op" id="1760344">*</span><span class="ident" id="1760345">mspan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1760352">var</span>&nbsp;<span class="ident" id="1760356">x</span>&nbsp;<span class="ident" id="1760358">unsafe</span><span class="op" id="1760364">.</span><span class="ident" id="1760365">Pointer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1760374">if</span>&nbsp;<span class="ident" id="1760377">size</span>&nbsp;<span class="op" id="1760382">&lt;=</span>&nbsp;<span class="ident" id="1760385">maxSmallSize</span>&nbsp;<span class="op" id="1760398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1760402">if</span>&nbsp;<span class="ident" id="1760405">flags</span><span class="op" id="1760410">&amp;</span><span class="ident" id="1760411">flagNoScan</span>&nbsp;<span class="op" id="1760422">!=</span>&nbsp;<span class="num" id="1760425">0</span>&nbsp;<span class="op" id="1760427">&amp;&amp;</span>&nbsp;<span class="ident" id="1760430">size</span>&nbsp;<span class="op" id="1760435">&lt;</span>&nbsp;<span class="ident" id="1760437">maxTinySize</span>&nbsp;<span class="op" id="1760449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1760454">//&nbsp;Tiny&nbsp;allocator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1760476">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1760482">//&nbsp;Tiny&nbsp;allocator&nbsp;combines&nbsp;several&nbsp;tiny&nbsp;allocation&nbsp;requests</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1760545">//&nbsp;into&nbsp;a&nbsp;single&nbsp;memory&nbsp;block.&nbsp;The&nbsp;resulting&nbsp;memory&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1760606">//&nbsp;is&nbsp;freed&nbsp;when&nbsp;all&nbsp;subobjects&nbsp;are&nbsp;unreachable.&nbsp;The&nbsp;subobjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1760673">//&nbsp;must&nbsp;be&nbsp;FlagNoScan&nbsp;(don&#39;t&nbsp;have&nbsp;pointers),&nbsp;this&nbsp;ensures&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1760739">//&nbsp;the&nbsp;amount&nbsp;of&nbsp;potentially&nbsp;wasted&nbsp;memory&nbsp;is&nbsp;bounded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1760797">//</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1760803">//&nbsp;Size&nbsp;of&nbsp;the&nbsp;memory&nbsp;block&nbsp;used&nbsp;for&nbsp;combining&nbsp;(maxTinySize)&nbsp;is&nbsp;tunable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1760879">//&nbsp;Current&nbsp;setting&nbsp;is&nbsp;16&nbsp;bytes,&nbsp;which&nbsp;relates&nbsp;to&nbsp;2x&nbsp;worst&nbsp;case&nbsp;memory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1760952">//&nbsp;wastage&nbsp;(when&nbsp;all&nbsp;but&nbsp;one&nbsp;subobjects&nbsp;are&nbsp;unreachable).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761013">//&nbsp;8&nbsp;bytes&nbsp;would&nbsp;result&nbsp;in&nbsp;no&nbsp;wastage&nbsp;at&nbsp;all,&nbsp;but&nbsp;provides&nbsp;less</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761080">//&nbsp;opportunities&nbsp;for&nbsp;combining.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761115">//&nbsp;32&nbsp;bytes&nbsp;provides&nbsp;more&nbsp;opportunities&nbsp;for&nbsp;combining,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761173">//&nbsp;but&nbsp;can&nbsp;lead&nbsp;to&nbsp;4x&nbsp;worst&nbsp;case&nbsp;wastage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761218">//&nbsp;The&nbsp;best&nbsp;case&nbsp;winning&nbsp;is&nbsp;8x&nbsp;regardless&nbsp;of&nbsp;block&nbsp;size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761278">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761284">//&nbsp;Objects&nbsp;obtained&nbsp;from&nbsp;tiny&nbsp;allocator&nbsp;must&nbsp;not&nbsp;be&nbsp;freed&nbsp;explicitly.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761357">//&nbsp;So&nbsp;when&nbsp;an&nbsp;object&nbsp;will&nbsp;be&nbsp;freed&nbsp;explicitly,&nbsp;we&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761422">//&nbsp;its&nbsp;size&nbsp;&gt;=&nbsp;maxTinySize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761453">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761459">//&nbsp;SetFinalizer&nbsp;has&nbsp;a&nbsp;special&nbsp;case&nbsp;for&nbsp;objects&nbsp;potentially&nbsp;coming</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761528">//&nbsp;from&nbsp;tiny&nbsp;allocator,&nbsp;it&nbsp;such&nbsp;case&nbsp;it&nbsp;allows&nbsp;to&nbsp;set&nbsp;finalizers</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761596">//&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte&nbsp;of&nbsp;a&nbsp;memory&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761639">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761645">//&nbsp;The&nbsp;main&nbsp;targets&nbsp;of&nbsp;tiny&nbsp;allocator&nbsp;are&nbsp;small&nbsp;strings&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761708">//&nbsp;standalone&nbsp;escaping&nbsp;variables.&nbsp;On&nbsp;a&nbsp;json&nbsp;benchmark</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761765">//&nbsp;the&nbsp;allocator&nbsp;reduces&nbsp;number&nbsp;of&nbsp;allocations&nbsp;by&nbsp;~12%&nbsp;and</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761827">//&nbsp;reduces&nbsp;heap&nbsp;size&nbsp;by&nbsp;~20%.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1761860">tinysize</span>&nbsp;<span class="op" id="1761869">:=</span>&nbsp;<span class="builtintype" id="1761872">uintptr</span><span class="op" id="1761879">(</span><span class="ident" id="1761880">c</span><span class="op" id="1761881">.</span><span class="ident" id="1761882">tinysize</span><span class="op" id="1761890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1761895">if</span>&nbsp;<span class="ident" id="1761898">size</span>&nbsp;<span class="op" id="1761903">&lt;=</span>&nbsp;<span class="ident" id="1761906">tinysize</span>&nbsp;<span class="op" id="1761915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1761921">tiny</span>&nbsp;<span class="op" id="1761926">:=</span>&nbsp;<span class="ident" id="1761929">unsafe</span><span class="op" id="1761935">.</span><span class="ident" id="1761936">Pointer</span><span class="op" id="1761943">(</span><span class="ident" id="1761944">c</span><span class="op" id="1761945">.</span><span class="ident" id="1761946">tiny</span><span class="op" id="1761950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1761956">//&nbsp;Align&nbsp;tiny&nbsp;pointer&nbsp;for&nbsp;required&nbsp;(conservative)&nbsp;alignment.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1762021">if</span>&nbsp;<span class="ident" id="1762024">size</span><span class="op" id="1762028">&amp;</span><span class="num" id="1762029">7</span>&nbsp;<span class="op" id="1762031">==</span>&nbsp;<span class="num" id="1762034">0</span>&nbsp;<span class="op" id="1762036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762043">tiny</span>&nbsp;<span class="op" id="1762048">=</span>&nbsp;<span class="ident" id="1762050">roundup</span><span class="op" id="1762057">(</span><span class="ident" id="1762058">tiny</span><span class="op" id="1762062">,</span>&nbsp;<span class="num" id="1762064">8</span><span class="op" id="1762065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1762071">}</span>&nbsp;<span class="keyword" id="1762073">else</span>&nbsp;<span class="keyword" id="1762078">if</span>&nbsp;<span class="ident" id="1762081">size</span><span class="op" id="1762085">&amp;</span><span class="num" id="1762086">3</span>&nbsp;<span class="op" id="1762088">==</span>&nbsp;<span class="num" id="1762091">0</span>&nbsp;<span class="op" id="1762093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762100">tiny</span>&nbsp;<span class="op" id="1762105">=</span>&nbsp;<span class="ident" id="1762107">roundup</span><span class="op" id="1762114">(</span><span class="ident" id="1762115">tiny</span><span class="op" id="1762119">,</span>&nbsp;<span class="num" id="1762121">4</span><span class="op" id="1762122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1762128">}</span>&nbsp;<span class="keyword" id="1762130">else</span>&nbsp;<span class="keyword" id="1762135">if</span>&nbsp;<span class="ident" id="1762138">size</span><span class="op" id="1762142">&amp;</span><span class="num" id="1762143">1</span>&nbsp;<span class="op" id="1762145">==</span>&nbsp;<span class="num" id="1762148">0</span>&nbsp;<span class="op" id="1762150">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762157">tiny</span>&nbsp;<span class="op" id="1762162">=</span>&nbsp;<span class="ident" id="1762164">roundup</span><span class="op" id="1762171">(</span><span class="ident" id="1762172">tiny</span><span class="op" id="1762176">,</span>&nbsp;<span class="num" id="1762178">2</span><span class="op" id="1762179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1762185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762191">size1</span>&nbsp;<span class="op" id="1762197">:=</span>&nbsp;<span class="ident" id="1762200">size</span>&nbsp;<span class="op" id="1762205">+</span>&nbsp;<span class="op" id="1762207">(</span><span class="builtintype" id="1762208">uintptr</span><span class="op" id="1762215">(</span><span class="ident" id="1762216">tiny</span><span class="op" id="1762220">)</span>&nbsp;<span class="op" id="1762222">-</span>&nbsp;<span class="builtintype" id="1762224">uintptr</span><span class="op" id="1762231">(</span><span class="ident" id="1762232">unsafe</span><span class="op" id="1762238">.</span><span class="ident" id="1762239">Pointer</span><span class="op" id="1762246">(</span><span class="ident" id="1762247">c</span><span class="op" id="1762248">.</span><span class="ident" id="1762249">tiny</span><span class="op" id="1762253">)</span><span class="op" id="1762254">)</span><span class="op" id="1762255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1762261">if</span>&nbsp;<span class="ident" id="1762264">size1</span>&nbsp;<span class="op" id="1762270">&lt;=</span>&nbsp;<span class="ident" id="1762273">tinysize</span>&nbsp;<span class="op" id="1762282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1762289">//&nbsp;The&nbsp;object&nbsp;fits&nbsp;into&nbsp;existing&nbsp;tiny&nbsp;block.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762339">x</span>&nbsp;<span class="op" id="1762341">=</span>&nbsp;<span class="ident" id="1762343">tiny</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762353">c</span><span class="op" id="1762354">.</span><span class="ident" id="1762355">tiny</span>&nbsp;<span class="op" id="1762360">=</span>&nbsp;<span class="op" id="1762362">(</span><span class="op" id="1762363">*</span><span class="builtintype" id="1762364">byte</span><span class="op" id="1762368">)</span><span class="op" id="1762369">(</span><span class="ident" id="1762370">add</span><span class="op" id="1762373">(</span><span class="ident" id="1762374">x</span><span class="op" id="1762375">,</span>&nbsp;<span class="ident" id="1762377">size</span><span class="op" id="1762381">)</span><span class="op" id="1762382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762389">c</span><span class="op" id="1762390">.</span><span class="ident" id="1762391">tinysize</span>&nbsp;<span class="op" id="1762400">-=</span>&nbsp;<span class="builtintype" id="1762403">uintptr</span><span class="op" id="1762410">(</span><span class="ident" id="1762411">size1</span><span class="op" id="1762416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762423">c</span><span class="op" id="1762424">.</span><span class="ident" id="1762425">local_tinyallocs</span><span class="op" id="1762441">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1762449">if</span>&nbsp;<span class="ident" id="1762452">debugMalloc</span>&nbsp;<span class="op" id="1762464">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762472">mp</span>&nbsp;<span class="op" id="1762475">:=</span>&nbsp;<span class="ident" id="1762478">acquirem</span><span class="op" id="1762486">(</span><span class="op" id="1762487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1762495">if</span>&nbsp;<span class="ident" id="1762498">mp</span><span class="op" id="1762500">.</span><span class="ident" id="1762501">mallocing</span>&nbsp;<span class="op" id="1762511">==</span>&nbsp;<span class="num" id="1762514">0</span>&nbsp;<span class="op" id="1762516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762525">gothrow</span><span class="op" id="1762532">(</span><span class="string" id="1762533">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1762545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1762553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762561">mp</span><span class="op" id="1762563">.</span><span class="ident" id="1762564">mallocing</span>&nbsp;<span class="op" id="1762574">=</span>&nbsp;<span class="num" id="1762576">0</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1762584">if</span>&nbsp;<span class="ident" id="1762587">mp</span><span class="op" id="1762589">.</span><span class="ident" id="1762590">curg</span>&nbsp;<span class="op" id="1762595">!=</span>&nbsp;<span class="ident" id="1762598">nil</span>&nbsp;<span class="op" id="1762602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762611">mp</span><span class="op" id="1762613">.</span><span class="ident" id="1762614">curg</span><span class="op" id="1762618">.</span><span class="ident" id="1762619">stackguard0</span>&nbsp;<span class="op" id="1762631">=</span>&nbsp;<span class="ident" id="1762633">mp</span><span class="op" id="1762635">.</span><span class="ident" id="1762636">curg</span><span class="op" id="1762640">.</span><span class="ident" id="1762641">stack</span><span class="op" id="1762646">.</span><span class="ident" id="1762647">lo</span>&nbsp;<span class="op" id="1762650">+</span>&nbsp;<span class="ident" id="1762652">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1762670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1762678">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1762735">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762791">releasem</span><span class="op" id="1762799">(</span><span class="ident" id="1762800">mp</span><span class="op" id="1762802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762810">releasem</span><span class="op" id="1762818">(</span><span class="ident" id="1762819">mp</span><span class="op" id="1762821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1762828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1762835">return</span>&nbsp;<span class="ident" id="1762842">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1762848">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1762853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1762858">//&nbsp;Allocate&nbsp;a&nbsp;new&nbsp;maxTinySize&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762898">s</span>&nbsp;<span class="op" id="1762900">=</span>&nbsp;<span class="ident" id="1762902">c</span><span class="op" id="1762903">.</span><span class="ident" id="1762904">alloc</span><span class="op" id="1762909">[</span><span class="ident" id="1762910">tinySizeClass</span><span class="op" id="1762923">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762928">v</span>&nbsp;<span class="op" id="1762930">:=</span>&nbsp;<span class="ident" id="1762933">s</span><span class="op" id="1762934">.</span><span class="ident" id="1762935">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1762947">if</span>&nbsp;<span class="ident" id="1762950">v</span>&nbsp;<span class="op" id="1762952">==</span>&nbsp;<span class="ident" id="1762955">nil</span>&nbsp;<span class="op" id="1762959">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762965">mp</span>&nbsp;<span class="op" id="1762968">:=</span>&nbsp;<span class="ident" id="1762971">acquirem</span><span class="op" id="1762979">(</span><span class="op" id="1762980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1762986">mp</span><span class="op" id="1762988">.</span><span class="ident" id="1762989">scalararg</span><span class="op" id="1762998">[</span><span class="num" id="1762999">0</span><span class="op" id="1763000">]</span>&nbsp;<span class="op" id="1763002">=</span>&nbsp;<span class="ident" id="1763004">tinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763022">onM</span><span class="op" id="1763025">(</span><span class="ident" id="1763026">mcacheRefill_m</span><span class="op" id="1763040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763046">releasem</span><span class="op" id="1763054">(</span><span class="ident" id="1763055">mp</span><span class="op" id="1763057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763063">s</span>&nbsp;<span class="op" id="1763065">=</span>&nbsp;<span class="ident" id="1763067">c</span><span class="op" id="1763068">.</span><span class="ident" id="1763069">alloc</span><span class="op" id="1763074">[</span><span class="ident" id="1763075">tinySizeClass</span><span class="op" id="1763088">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763094">v</span>&nbsp;<span class="op" id="1763096">=</span>&nbsp;<span class="ident" id="1763098">s</span><span class="op" id="1763099">.</span><span class="ident" id="1763100">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1763112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763117">s</span><span class="op" id="1763118">.</span><span class="ident" id="1763119">freelist</span>&nbsp;<span class="op" id="1763128">=</span>&nbsp;<span class="ident" id="1763130">v</span><span class="op" id="1763131">.</span><span class="ident" id="1763132">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763140">s</span><span class="op" id="1763141">.</span><span class="ident" id="1763142">ref</span><span class="op" id="1763145">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1763151">//TODO:&nbsp;prefetch&nbsp;v.next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763178">x</span>&nbsp;<span class="op" id="1763180">=</span>&nbsp;<span class="ident" id="1763182">unsafe</span><span class="op" id="1763188">.</span><span class="ident" id="1763189">Pointer</span><span class="op" id="1763196">(</span><span class="ident" id="1763197">v</span><span class="op" id="1763198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1763203">(</span><span class="op" id="1763204">*</span><span class="op" id="1763205">[</span><span class="num" id="1763206">2</span><span class="op" id="1763207">]</span><span class="ident" id="1763208">uint64</span><span class="op" id="1763214">)</span><span class="op" id="1763215">(</span><span class="ident" id="1763216">x</span><span class="op" id="1763217">)</span><span class="op" id="1763218">[</span><span class="num" id="1763219">0</span><span class="op" id="1763220">]</span>&nbsp;<span class="op" id="1763222">=</span>&nbsp;<span class="num" id="1763224">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1763229">(</span><span class="op" id="1763230">*</span><span class="op" id="1763231">[</span><span class="num" id="1763232">2</span><span class="op" id="1763233">]</span><span class="ident" id="1763234">uint64</span><span class="op" id="1763240">)</span><span class="op" id="1763241">(</span><span class="ident" id="1763242">x</span><span class="op" id="1763243">)</span><span class="op" id="1763244">[</span><span class="num" id="1763245">1</span><span class="op" id="1763246">]</span>&nbsp;<span class="op" id="1763248">=</span>&nbsp;<span class="num" id="1763250">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1763255">//&nbsp;See&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;replace&nbsp;the&nbsp;existing&nbsp;tiny&nbsp;block&nbsp;with&nbsp;the&nbsp;new&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1763328">//&nbsp;based&nbsp;on&nbsp;amount&nbsp;of&nbsp;remaining&nbsp;free&nbsp;space.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1763375">if</span>&nbsp;<span class="ident" id="1763378">maxTinySize</span><span class="op" id="1763389">-</span><span class="ident" id="1763390">size</span>&nbsp;<span class="op" id="1763395">&gt;</span>&nbsp;<span class="ident" id="1763397">tinysize</span>&nbsp;<span class="op" id="1763406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763412">c</span><span class="op" id="1763413">.</span><span class="ident" id="1763414">tiny</span>&nbsp;<span class="op" id="1763419">=</span>&nbsp;<span class="op" id="1763421">(</span><span class="op" id="1763422">*</span><span class="builtintype" id="1763423">byte</span><span class="op" id="1763427">)</span><span class="op" id="1763428">(</span><span class="ident" id="1763429">add</span><span class="op" id="1763432">(</span><span class="ident" id="1763433">x</span><span class="op" id="1763434">,</span>&nbsp;<span class="ident" id="1763436">size</span><span class="op" id="1763440">)</span><span class="op" id="1763441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763447">c</span><span class="op" id="1763448">.</span><span class="ident" id="1763449">tinysize</span>&nbsp;<span class="op" id="1763458">=</span>&nbsp;<span class="builtintype" id="1763460">uintptr</span><span class="op" id="1763467">(</span><span class="ident" id="1763468">maxTinySize</span>&nbsp;<span class="op" id="1763480">-</span>&nbsp;<span class="ident" id="1763482">size</span><span class="op" id="1763486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1763491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763496">size</span>&nbsp;<span class="op" id="1763501">=</span>&nbsp;<span class="ident" id="1763503">maxTinySize</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1763517">}</span>&nbsp;<span class="keyword" id="1763519">else</span>&nbsp;<span class="op" id="1763524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1763529">var</span>&nbsp;<span class="ident" id="1763533">sizeclass</span>&nbsp;<span class="builtintype" id="1763543">int8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1763551">if</span>&nbsp;<span class="ident" id="1763554">size</span>&nbsp;<span class="op" id="1763559">&lt;=</span>&nbsp;<span class="num" id="1763562">1024</span><span class="op" id="1763566">-</span><span class="num" id="1763567">8</span>&nbsp;<span class="op" id="1763569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763575">sizeclass</span>&nbsp;<span class="op" id="1763585">=</span>&nbsp;<span class="ident" id="1763587">size_to_class8</span><span class="op" id="1763601">[</span><span class="op" id="1763602">(</span><span class="ident" id="1763603">size</span><span class="op" id="1763607">+</span><span class="num" id="1763608">7</span><span class="op" id="1763609">)</span><span class="op" id="1763610">&gt;&gt;</span><span class="num" id="1763612">3</span><span class="op" id="1763613">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1763618">}</span>&nbsp;<span class="keyword" id="1763620">else</span>&nbsp;<span class="op" id="1763625">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763631">sizeclass</span>&nbsp;<span class="op" id="1763641">=</span>&nbsp;<span class="ident" id="1763643">size_to_class128</span><span class="op" id="1763659">[</span><span class="op" id="1763660">(</span><span class="ident" id="1763661">size</span><span class="op" id="1763665">-</span><span class="num" id="1763666">1024</span><span class="op" id="1763670">+</span><span class="num" id="1763671">127</span><span class="op" id="1763674">)</span><span class="op" id="1763675">&gt;&gt;</span><span class="num" id="1763677">7</span><span class="op" id="1763678">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1763683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763688">size</span>&nbsp;<span class="op" id="1763693">=</span>&nbsp;<span class="builtintype" id="1763695">uintptr</span><span class="op" id="1763702">(</span><span class="ident" id="1763703">class_to_size</span><span class="op" id="1763716">[</span><span class="ident" id="1763717">sizeclass</span><span class="op" id="1763726">]</span><span class="op" id="1763727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763732">s</span>&nbsp;<span class="op" id="1763734">=</span>&nbsp;<span class="ident" id="1763736">c</span><span class="op" id="1763737">.</span><span class="ident" id="1763738">alloc</span><span class="op" id="1763743">[</span><span class="ident" id="1763744">sizeclass</span><span class="op" id="1763753">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763758">v</span>&nbsp;<span class="op" id="1763760">:=</span>&nbsp;<span class="ident" id="1763763">s</span><span class="op" id="1763764">.</span><span class="ident" id="1763765">freelist</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1763777">if</span>&nbsp;<span class="ident" id="1763780">v</span>&nbsp;<span class="op" id="1763782">==</span>&nbsp;<span class="ident" id="1763785">nil</span>&nbsp;<span class="op" id="1763789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763795">mp</span>&nbsp;<span class="op" id="1763798">:=</span>&nbsp;<span class="ident" id="1763801">acquirem</span><span class="op" id="1763809">(</span><span class="op" id="1763810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763816">mp</span><span class="op" id="1763818">.</span><span class="ident" id="1763819">scalararg</span><span class="op" id="1763828">[</span><span class="num" id="1763829">0</span><span class="op" id="1763830">]</span>&nbsp;<span class="op" id="1763832">=</span>&nbsp;<span class="builtintype" id="1763834">uintptr</span><span class="op" id="1763841">(</span><span class="ident" id="1763842">sizeclass</span><span class="op" id="1763851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763857">onM</span><span class="op" id="1763860">(</span><span class="ident" id="1763861">mcacheRefill_m</span><span class="op" id="1763875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763881">releasem</span><span class="op" id="1763889">(</span><span class="ident" id="1763890">mp</span><span class="op" id="1763892">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763898">s</span>&nbsp;<span class="op" id="1763900">=</span>&nbsp;<span class="ident" id="1763902">c</span><span class="op" id="1763903">.</span><span class="ident" id="1763904">alloc</span><span class="op" id="1763909">[</span><span class="ident" id="1763910">sizeclass</span><span class="op" id="1763919">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763925">v</span>&nbsp;<span class="op" id="1763927">=</span>&nbsp;<span class="ident" id="1763929">s</span><span class="op" id="1763930">.</span><span class="ident" id="1763931">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1763943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763948">s</span><span class="op" id="1763949">.</span><span class="ident" id="1763950">freelist</span>&nbsp;<span class="op" id="1763959">=</span>&nbsp;<span class="ident" id="1763961">v</span><span class="op" id="1763962">.</span><span class="ident" id="1763963">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1763971">s</span><span class="op" id="1763972">.</span><span class="ident" id="1763973">ref</span><span class="op" id="1763976">++</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1763982">//TODO:&nbsp;prefetch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764002">x</span>&nbsp;<span class="op" id="1764004">=</span>&nbsp;<span class="ident" id="1764006">unsafe</span><span class="op" id="1764012">.</span><span class="ident" id="1764013">Pointer</span><span class="op" id="1764020">(</span><span class="ident" id="1764021">v</span><span class="op" id="1764022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1764027">if</span>&nbsp;<span class="ident" id="1764030">flags</span><span class="op" id="1764035">&amp;</span><span class="ident" id="1764036">flagNoZero</span>&nbsp;<span class="op" id="1764047">==</span>&nbsp;<span class="num" id="1764050">0</span>&nbsp;<span class="op" id="1764052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764058">v</span><span class="op" id="1764059">.</span><span class="ident" id="1764060">next</span>&nbsp;<span class="op" id="1764065">=</span>&nbsp;<span class="ident" id="1764067">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1764075">if</span>&nbsp;<span class="ident" id="1764078">size</span>&nbsp;<span class="op" id="1764083">&gt;</span>&nbsp;<span class="num" id="1764085">2</span><span class="op" id="1764086">*</span><span class="ident" id="1764087">ptrSize</span>&nbsp;<span class="op" id="1764095">&amp;&amp;</span>&nbsp;<span class="op" id="1764098">(</span><span class="op" id="1764099">(</span><span class="op" id="1764100">*</span><span class="op" id="1764101">[</span><span class="num" id="1764102">2</span><span class="op" id="1764103">]</span><span class="builtintype" id="1764104">uintptr</span><span class="op" id="1764111">)</span><span class="op" id="1764112">(</span><span class="ident" id="1764113">x</span><span class="op" id="1764114">)</span><span class="op" id="1764115">)</span><span class="op" id="1764116">[</span><span class="num" id="1764117">1</span><span class="op" id="1764118">]</span>&nbsp;<span class="op" id="1764120">!=</span>&nbsp;<span class="num" id="1764123">0</span>&nbsp;<span class="op" id="1764125">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764132">memclr</span><span class="op" id="1764138">(</span><span class="ident" id="1764139">unsafe</span><span class="op" id="1764145">.</span><span class="ident" id="1764146">Pointer</span><span class="op" id="1764153">(</span><span class="ident" id="1764154">v</span><span class="op" id="1764155">)</span><span class="op" id="1764156">,</span>&nbsp;<span class="ident" id="1764158">size</span><span class="op" id="1764162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1764168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1764173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1764177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764181">c</span><span class="op" id="1764182">.</span><span class="ident" id="1764183">local_cachealloc</span>&nbsp;<span class="op" id="1764200">+=</span>&nbsp;<span class="ident" id="1764203">intptr</span><span class="op" id="1764209">(</span><span class="ident" id="1764210">size</span><span class="op" id="1764214">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1764217">}</span>&nbsp;<span class="keyword" id="1764219">else</span>&nbsp;<span class="op" id="1764224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764228">mp</span>&nbsp;<span class="op" id="1764231">:=</span>&nbsp;<span class="ident" id="1764234">acquirem</span><span class="op" id="1764242">(</span><span class="op" id="1764243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764247">mp</span><span class="op" id="1764249">.</span><span class="ident" id="1764250">scalararg</span><span class="op" id="1764259">[</span><span class="num" id="1764260">0</span><span class="op" id="1764261">]</span>&nbsp;<span class="op" id="1764263">=</span>&nbsp;<span class="builtintype" id="1764265">uintptr</span><span class="op" id="1764272">(</span><span class="ident" id="1764273">size</span><span class="op" id="1764277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764281">mp</span><span class="op" id="1764283">.</span><span class="ident" id="1764284">scalararg</span><span class="op" id="1764293">[</span><span class="num" id="1764294">1</span><span class="op" id="1764295">]</span>&nbsp;<span class="op" id="1764297">=</span>&nbsp;<span class="builtintype" id="1764299">uintptr</span><span class="op" id="1764306">(</span><span class="ident" id="1764307">flags</span><span class="op" id="1764312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764316">onM</span><span class="op" id="1764319">(</span><span class="ident" id="1764320">largeAlloc_m</span><span class="op" id="1764332">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764336">s</span>&nbsp;<span class="op" id="1764338">=</span>&nbsp;<span class="op" id="1764340">(</span><span class="op" id="1764341">*</span><span class="ident" id="1764342">mspan</span><span class="op" id="1764347">)</span><span class="op" id="1764348">(</span><span class="ident" id="1764349">mp</span><span class="op" id="1764351">.</span><span class="ident" id="1764352">ptrarg</span><span class="op" id="1764358">[</span><span class="num" id="1764359">0</span><span class="op" id="1764360">]</span><span class="op" id="1764361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764365">mp</span><span class="op" id="1764367">.</span><span class="ident" id="1764368">ptrarg</span><span class="op" id="1764374">[</span><span class="num" id="1764375">0</span><span class="op" id="1764376">]</span>&nbsp;<span class="op" id="1764378">=</span>&nbsp;<span class="ident" id="1764380">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764386">releasem</span><span class="op" id="1764394">(</span><span class="ident" id="1764395">mp</span><span class="op" id="1764397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764401">x</span>&nbsp;<span class="op" id="1764403">=</span>&nbsp;<span class="ident" id="1764405">unsafe</span><span class="op" id="1764411">.</span><span class="ident" id="1764412">Pointer</span><span class="op" id="1764419">(</span><span class="builtintype" id="1764420">uintptr</span><span class="op" id="1764427">(</span><span class="ident" id="1764428">s</span><span class="op" id="1764429">.</span><span class="ident" id="1764430">start</span>&nbsp;<span class="op" id="1764436">&lt;&lt;</span>&nbsp;<span class="ident" id="1764439">pageShift</span><span class="op" id="1764448">)</span><span class="op" id="1764449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764453">size</span>&nbsp;<span class="op" id="1764458">=</span>&nbsp;<span class="builtintype" id="1764460">uintptr</span><span class="op" id="1764467">(</span><span class="ident" id="1764468">s</span><span class="op" id="1764469">.</span><span class="ident" id="1764470">elemsize</span><span class="op" id="1764478">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1764481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1764485">if</span>&nbsp;<span class="ident" id="1764488">flags</span><span class="op" id="1764493">&amp;</span><span class="ident" id="1764494">flagNoScan</span>&nbsp;<span class="op" id="1764505">!=</span>&nbsp;<span class="num" id="1764508">0</span>&nbsp;<span class="op" id="1764510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1764514">//&nbsp;All&nbsp;objects&nbsp;are&nbsp;pre-marked&nbsp;as&nbsp;noscan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1764557">goto</span>&nbsp;<span class="ident" id="1764562">marked</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1764570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1764574">//&nbsp;If&nbsp;allocating&nbsp;a&nbsp;defer+arg&nbsp;block,&nbsp;now&nbsp;that&nbsp;we&#39;ve&nbsp;picked&nbsp;a&nbsp;malloc&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1764647">//&nbsp;large&nbsp;enough&nbsp;to&nbsp;hold&nbsp;everything,&nbsp;cut&nbsp;the&nbsp;&#34;asked&nbsp;for&#34;&nbsp;size&nbsp;down&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1764717">//&nbsp;just&nbsp;the&nbsp;defer&nbsp;header,&nbsp;so&nbsp;that&nbsp;the&nbsp;GC&nbsp;bitmap&nbsp;will&nbsp;record&nbsp;the&nbsp;arg&nbsp;block</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1764792">//&nbsp;as&nbsp;containing&nbsp;nothing&nbsp;at&nbsp;all&nbsp;(as&nbsp;if&nbsp;it&nbsp;were&nbsp;unused&nbsp;space&nbsp;at&nbsp;the&nbsp;end&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1764867">//&nbsp;a&nbsp;malloc&nbsp;block&nbsp;caused&nbsp;by&nbsp;size&nbsp;rounding).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1764912">//&nbsp;The&nbsp;defer&nbsp;arg&nbsp;areas&nbsp;are&nbsp;scanned&nbsp;as&nbsp;part&nbsp;of&nbsp;scanstack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1764970">if</span>&nbsp;<span class="ident" id="1764973">typ</span>&nbsp;<span class="op" id="1764977">==</span>&nbsp;<span class="ident" id="1764980">deferType</span>&nbsp;<span class="op" id="1764990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1764994">size0</span>&nbsp;<span class="op" id="1765000">=</span>&nbsp;<span class="ident" id="1765002">unsafe</span><span class="op" id="1765008">.</span><span class="ident" id="1765009">Sizeof</span><span class="op" id="1765015">(</span><span class="ident" id="1765016">_defer</span><span class="op" id="1765022">{</span><span class="op" id="1765023">}</span><span class="op" id="1765024">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1765027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1765031">//&nbsp;From&nbsp;here&nbsp;till&nbsp;marked&nbsp;label&nbsp;marking&nbsp;the&nbsp;object&nbsp;as&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1765095">//&nbsp;and&nbsp;storing&nbsp;type&nbsp;info&nbsp;in&nbsp;the&nbsp;GC&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1765139">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1765143">arena_start</span>&nbsp;<span class="op" id="1765155">:=</span>&nbsp;<span class="builtintype" id="1765158">uintptr</span><span class="op" id="1765165">(</span><span class="ident" id="1765166">unsafe</span><span class="op" id="1765172">.</span><span class="ident" id="1765173">Pointer</span><span class="op" id="1765180">(</span><span class="ident" id="1765181">mheap_</span><span class="op" id="1765187">.</span><span class="ident" id="1765188">arena_start</span><span class="op" id="1765199">)</span><span class="op" id="1765200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1765204">off</span>&nbsp;<span class="op" id="1765208">:=</span>&nbsp;<span class="op" id="1765211">(</span><span class="builtintype" id="1765212">uintptr</span><span class="op" id="1765219">(</span><span class="ident" id="1765220">x</span><span class="op" id="1765221">)</span>&nbsp;<span class="op" id="1765223">-</span>&nbsp;<span class="ident" id="1765225">arena_start</span><span class="op" id="1765236">)</span>&nbsp;<span class="op" id="1765238">/</span>&nbsp;<span class="ident" id="1765240">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1765250">xbits</span>&nbsp;<span class="op" id="1765256">:=</span>&nbsp;<span class="op" id="1765259">(</span><span class="op" id="1765260">*</span><span class="builtintype" id="1765261">uint8</span><span class="op" id="1765266">)</span><span class="op" id="1765267">(</span><span class="ident" id="1765268">unsafe</span><span class="op" id="1765274">.</span><span class="ident" id="1765275">Pointer</span><span class="op" id="1765282">(</span><span class="ident" id="1765283">arena_start</span>&nbsp;<span class="op" id="1765295">-</span>&nbsp;<span class="ident" id="1765297">off</span><span class="op" id="1765300">/</span><span class="ident" id="1765301">wordsPerBitmapByte</span>&nbsp;<span class="op" id="1765320">-</span>&nbsp;<span class="num" id="1765322">1</span><span class="op" id="1765323">)</span><span class="op" id="1765324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1765328">shift</span>&nbsp;<span class="op" id="1765334">:=</span>&nbsp;<span class="op" id="1765337">(</span><span class="ident" id="1765338">off</span>&nbsp;<span class="op" id="1765342">%</span>&nbsp;<span class="ident" id="1765344">wordsPerBitmapByte</span><span class="op" id="1765362">)</span>&nbsp;<span class="op" id="1765364">*</span>&nbsp;<span class="ident" id="1765366">gcBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1765375">if</span>&nbsp;<span class="ident" id="1765378">debugMalloc</span>&nbsp;<span class="op" id="1765390">&amp;&amp;</span>&nbsp;<span class="op" id="1765393">(</span><span class="op" id="1765394">(</span><span class="op" id="1765395">*</span><span class="ident" id="1765396">xbits</span><span class="op" id="1765401">&gt;&gt;</span><span class="ident" id="1765403">shift</span><span class="op" id="1765408">)</span><span class="op" id="1765409">&amp;</span><span class="op" id="1765410">(</span><span class="ident" id="1765411">bitMask</span><span class="op" id="1765418">|</span><span class="ident" id="1765419">bitPtrMask</span><span class="op" id="1765429">)</span><span class="op" id="1765430">)</span>&nbsp;<span class="op" id="1765432">!=</span>&nbsp;<span class="ident" id="1765435">bitBoundary</span>&nbsp;<span class="op" id="1765447">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1765452">println</span><span class="op" id="1765459">(</span><span class="string" id="1765460">&#34;runtime:&nbsp;bits&nbsp;=&#34;</span><span class="op" id="1765477">,</span>&nbsp;<span class="op" id="1765479">(</span><span class="op" id="1765480">*</span><span class="ident" id="1765481">xbits</span><span class="op" id="1765486">&gt;&gt;</span><span class="ident" id="1765488">shift</span><span class="op" id="1765493">)</span><span class="op" id="1765494">&amp;</span><span class="op" id="1765495">(</span><span class="ident" id="1765496">bitMask</span><span class="op" id="1765503">|</span><span class="ident" id="1765504">bitPtrMask</span><span class="op" id="1765514">)</span><span class="op" id="1765515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1765520">gothrow</span><span class="op" id="1765527">(</span><span class="string" id="1765528">&#34;bad&nbsp;bits&nbsp;in&nbsp;markallocated&#34;</span><span class="op" id="1765555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1765559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1765564">var</span>&nbsp;<span class="ident" id="1765568">ti</span><span class="op" id="1765570">,</span>&nbsp;<span class="ident" id="1765572">te</span>&nbsp;<span class="builtintype" id="1765575">uintptr</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1765585">var</span>&nbsp;<span class="ident" id="1765589">ptrmask</span>&nbsp;<span class="op" id="1765597">*</span><span class="builtintype" id="1765598">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1765606">if</span>&nbsp;<span class="ident" id="1765609">size</span>&nbsp;<span class="op" id="1765614">==</span>&nbsp;<span class="ident" id="1765617">ptrSize</span>&nbsp;<span class="op" id="1765625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1765630">//&nbsp;It&#39;s&nbsp;one&nbsp;word&nbsp;and&nbsp;it&nbsp;has&nbsp;pointers,&nbsp;it&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1765693">*</span><span class="ident" id="1765694">xbits</span>&nbsp;<span class="op" id="1765700">|=</span>&nbsp;<span class="op" id="1765703">(</span><span class="ident" id="1765704">bitsPointer</span>&nbsp;<span class="op" id="1765716">&lt;&lt;</span>&nbsp;<span class="num" id="1765719">2</span><span class="op" id="1765720">)</span>&nbsp;<span class="op" id="1765722">&lt;&lt;</span>&nbsp;<span class="ident" id="1765725">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1765734">goto</span>&nbsp;<span class="ident" id="1765739">marked</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1765748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1765752">if</span>&nbsp;<span class="ident" id="1765755">typ</span><span class="op" id="1765758">.</span><span class="ident" id="1765759">kind</span><span class="op" id="1765763">&amp;</span><span class="ident" id="1765764">kindGCProg</span>&nbsp;<span class="op" id="1765775">!=</span>&nbsp;<span class="num" id="1765778">0</span>&nbsp;<span class="op" id="1765780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1765785">nptr</span>&nbsp;<span class="op" id="1765790">:=</span>&nbsp;<span class="op" id="1765793">(</span><span class="builtintype" id="1765794">uintptr</span><span class="op" id="1765801">(</span><span class="ident" id="1765802">typ</span><span class="op" id="1765805">.</span><span class="ident" id="1765806">size</span><span class="op" id="1765810">)</span>&nbsp;<span class="op" id="1765812">+</span>&nbsp;<span class="ident" id="1765814">ptrSize</span>&nbsp;<span class="op" id="1765822">-</span>&nbsp;<span class="num" id="1765824">1</span><span class="op" id="1765825">)</span>&nbsp;<span class="op" id="1765827">/</span>&nbsp;<span class="ident" id="1765829">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1765840">masksize</span>&nbsp;<span class="op" id="1765849">:=</span>&nbsp;<span class="ident" id="1765852">nptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1765860">if</span>&nbsp;<span class="ident" id="1765863">masksize</span><span class="op" id="1765871">%</span><span class="num" id="1765872">2</span>&nbsp;<span class="op" id="1765874">!=</span>&nbsp;<span class="num" id="1765877">0</span>&nbsp;<span class="op" id="1765879">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1765885">masksize</span>&nbsp;<span class="op" id="1765894">*=</span>&nbsp;<span class="num" id="1765897">2</span>&nbsp;<span class="comment" id="1765899">//&nbsp;repeated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1765914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1765919">masksize</span>&nbsp;<span class="op" id="1765928">=</span>&nbsp;<span class="ident" id="1765930">masksize</span>&nbsp;<span class="op" id="1765939">*</span>&nbsp;<span class="ident" id="1765941">pointersPerByte</span>&nbsp;<span class="op" id="1765957">/</span>&nbsp;<span class="num" id="1765959">8</span>&nbsp;<span class="comment" id="1765961">//&nbsp;4&nbsp;bits&nbsp;per&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1765983">masksize</span><span class="op" id="1765991">++</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1766025">//&nbsp;unroll&nbsp;flag&nbsp;in&nbsp;the&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1766060">if</span>&nbsp;<span class="ident" id="1766063">masksize</span>&nbsp;<span class="op" id="1766072">&gt;</span>&nbsp;<span class="ident" id="1766074">maxGCMask</span>&nbsp;<span class="op" id="1766084">&amp;&amp;</span>&nbsp;<span class="ident" id="1766087">typ</span><span class="op" id="1766090">.</span><span class="ident" id="1766091">gc</span><span class="op" id="1766093">[</span><span class="num" id="1766094">1</span><span class="op" id="1766095">]</span>&nbsp;<span class="op" id="1766097">!=</span>&nbsp;<span class="num" id="1766100">0</span>&nbsp;<span class="op" id="1766102">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1766108">//&nbsp;If&nbsp;the&nbsp;mask&nbsp;is&nbsp;too&nbsp;large,&nbsp;unroll&nbsp;the&nbsp;program&nbsp;directly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1766169">//&nbsp;into&nbsp;the&nbsp;GC&nbsp;bitmap.&nbsp;It&#39;s&nbsp;7&nbsp;times&nbsp;slower&nbsp;than&nbsp;copying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1766229">//&nbsp;from&nbsp;the&nbsp;pre-unrolled&nbsp;mask,&nbsp;but&nbsp;saves&nbsp;1/16&nbsp;of&nbsp;type&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1766292">//&nbsp;memory&nbsp;for&nbsp;the&nbsp;mask.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766320">mp</span>&nbsp;<span class="op" id="1766323">:=</span>&nbsp;<span class="ident" id="1766326">acquirem</span><span class="op" id="1766334">(</span><span class="op" id="1766335">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766341">mp</span><span class="op" id="1766343">.</span><span class="ident" id="1766344">ptrarg</span><span class="op" id="1766350">[</span><span class="num" id="1766351">0</span><span class="op" id="1766352">]</span>&nbsp;<span class="op" id="1766354">=</span>&nbsp;<span class="ident" id="1766356">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766362">mp</span><span class="op" id="1766364">.</span><span class="ident" id="1766365">ptrarg</span><span class="op" id="1766371">[</span><span class="num" id="1766372">1</span><span class="op" id="1766373">]</span>&nbsp;<span class="op" id="1766375">=</span>&nbsp;<span class="ident" id="1766377">unsafe</span><span class="op" id="1766383">.</span><span class="ident" id="1766384">Pointer</span><span class="op" id="1766391">(</span><span class="ident" id="1766392">typ</span><span class="op" id="1766395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766401">mp</span><span class="op" id="1766403">.</span><span class="ident" id="1766404">scalararg</span><span class="op" id="1766413">[</span><span class="num" id="1766414">0</span><span class="op" id="1766415">]</span>&nbsp;<span class="op" id="1766417">=</span>&nbsp;<span class="builtintype" id="1766419">uintptr</span><span class="op" id="1766426">(</span><span class="ident" id="1766427">size</span><span class="op" id="1766431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766437">mp</span><span class="op" id="1766439">.</span><span class="ident" id="1766440">scalararg</span><span class="op" id="1766449">[</span><span class="num" id="1766450">1</span><span class="op" id="1766451">]</span>&nbsp;<span class="op" id="1766453">=</span>&nbsp;<span class="builtintype" id="1766455">uintptr</span><span class="op" id="1766462">(</span><span class="ident" id="1766463">size0</span><span class="op" id="1766468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766474">onM</span><span class="op" id="1766477">(</span><span class="ident" id="1766478">unrollgcproginplace_m</span><span class="op" id="1766499">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766505">releasem</span><span class="op" id="1766513">(</span><span class="ident" id="1766514">mp</span><span class="op" id="1766516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1766522">goto</span>&nbsp;<span class="ident" id="1766527">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1766537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766542">ptrmask</span>&nbsp;<span class="op" id="1766550">=</span>&nbsp;<span class="op" id="1766552">(</span><span class="op" id="1766553">*</span><span class="builtintype" id="1766554">uint8</span><span class="op" id="1766559">)</span><span class="op" id="1766560">(</span><span class="ident" id="1766561">unsafe</span><span class="op" id="1766567">.</span><span class="ident" id="1766568">Pointer</span><span class="op" id="1766575">(</span><span class="builtintype" id="1766576">uintptr</span><span class="op" id="1766583">(</span><span class="ident" id="1766584">typ</span><span class="op" id="1766587">.</span><span class="ident" id="1766588">gc</span><span class="op" id="1766590">[</span><span class="num" id="1766591">0</span><span class="op" id="1766592">]</span><span class="op" id="1766593">)</span><span class="op" id="1766594">)</span><span class="op" id="1766595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1766600">//&nbsp;Check&nbsp;whether&nbsp;the&nbsp;program&nbsp;is&nbsp;already&nbsp;unrolled.</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1766653">if</span>&nbsp;<span class="builtintype" id="1766656">uintptr</span><span class="op" id="1766663">(</span><span class="ident" id="1766664">atomicloadp</span><span class="op" id="1766675">(</span><span class="ident" id="1766676">unsafe</span><span class="op" id="1766682">.</span><span class="ident" id="1766683">Pointer</span><span class="op" id="1766690">(</span><span class="ident" id="1766691">ptrmask</span><span class="op" id="1766698">)</span><span class="op" id="1766699">)</span><span class="op" id="1766700">)</span><span class="op" id="1766701">&amp;</span><span class="num" id="1766702">0xff</span>&nbsp;<span class="op" id="1766707">==</span>&nbsp;<span class="num" id="1766710">0</span>&nbsp;<span class="op" id="1766712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766718">mp</span>&nbsp;<span class="op" id="1766721">:=</span>&nbsp;<span class="ident" id="1766724">acquirem</span><span class="op" id="1766732">(</span><span class="op" id="1766733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766739">mp</span><span class="op" id="1766741">.</span><span class="ident" id="1766742">ptrarg</span><span class="op" id="1766748">[</span><span class="num" id="1766749">0</span><span class="op" id="1766750">]</span>&nbsp;<span class="op" id="1766752">=</span>&nbsp;<span class="ident" id="1766754">unsafe</span><span class="op" id="1766760">.</span><span class="ident" id="1766761">Pointer</span><span class="op" id="1766768">(</span><span class="ident" id="1766769">typ</span><span class="op" id="1766772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766778">onM</span><span class="op" id="1766781">(</span><span class="ident" id="1766782">unrollgcprog_m</span><span class="op" id="1766796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766802">releasem</span><span class="op" id="1766810">(</span><span class="ident" id="1766811">mp</span><span class="op" id="1766813">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1766818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766823">ptrmask</span>&nbsp;<span class="op" id="1766831">=</span>&nbsp;<span class="op" id="1766833">(</span><span class="op" id="1766834">*</span><span class="builtintype" id="1766835">uint8</span><span class="op" id="1766840">)</span><span class="op" id="1766841">(</span><span class="ident" id="1766842">add</span><span class="op" id="1766845">(</span><span class="ident" id="1766846">unsafe</span><span class="op" id="1766852">.</span><span class="ident" id="1766853">Pointer</span><span class="op" id="1766860">(</span><span class="ident" id="1766861">ptrmask</span><span class="op" id="1766868">)</span><span class="op" id="1766869">,</span>&nbsp;<span class="num" id="1766871">1</span><span class="op" id="1766872">)</span><span class="op" id="1766873">)</span>&nbsp;<span class="comment" id="1766875">//&nbsp;skip&nbsp;the&nbsp;unroll&nbsp;flag&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1766906">}</span>&nbsp;<span class="keyword" id="1766908">else</span>&nbsp;<span class="op" id="1766913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1766918">ptrmask</span>&nbsp;<span class="op" id="1766926">=</span>&nbsp;<span class="op" id="1766928">(</span><span class="op" id="1766929">*</span><span class="builtintype" id="1766930">uint8</span><span class="op" id="1766935">)</span><span class="op" id="1766936">(</span><span class="ident" id="1766937">unsafe</span><span class="op" id="1766943">.</span><span class="ident" id="1766944">Pointer</span><span class="op" id="1766951">(</span><span class="ident" id="1766952">typ</span><span class="op" id="1766955">.</span><span class="ident" id="1766956">gc</span><span class="op" id="1766958">[</span><span class="num" id="1766959">0</span><span class="op" id="1766960">]</span><span class="op" id="1766961">)</span><span class="op" id="1766962">)</span>&nbsp;<span class="comment" id="1766964">//&nbsp;pointer&nbsp;to&nbsp;unrolled&nbsp;mask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1766994">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1766998">if</span>&nbsp;<span class="ident" id="1767001">size</span>&nbsp;<span class="op" id="1767006">==</span>&nbsp;<span class="num" id="1767009">2</span><span class="op" id="1767010">*</span><span class="ident" id="1767011">ptrSize</span>&nbsp;<span class="op" id="1767019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767024">*</span><span class="ident" id="1767025">xbits</span>&nbsp;<span class="op" id="1767031">=</span>&nbsp;<span class="op" id="1767033">*</span><span class="ident" id="1767034">ptrmask</span>&nbsp;<span class="op" id="1767042">|</span>&nbsp;<span class="ident" id="1767044">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1767059">goto</span>&nbsp;<span class="ident" id="1767064">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1767077">te</span>&nbsp;<span class="op" id="1767080">=</span>&nbsp;<span class="builtintype" id="1767082">uintptr</span><span class="op" id="1767089">(</span><span class="ident" id="1767090">typ</span><span class="op" id="1767093">.</span><span class="ident" id="1767094">size</span><span class="op" id="1767098">)</span>&nbsp;<span class="op" id="1767100">/</span>&nbsp;<span class="ident" id="1767102">ptrSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1767112">//&nbsp;If&nbsp;the&nbsp;type&nbsp;occupies&nbsp;odd&nbsp;number&nbsp;of&nbsp;words,&nbsp;its&nbsp;mask&nbsp;is&nbsp;repeated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1767181">if</span>&nbsp;<span class="ident" id="1767184">te</span><span class="op" id="1767186">%</span><span class="num" id="1767187">2</span>&nbsp;<span class="op" id="1767189">==</span>&nbsp;<span class="num" id="1767192">0</span>&nbsp;<span class="op" id="1767194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1767199">te</span>&nbsp;<span class="op" id="1767202">/=</span>&nbsp;<span class="num" id="1767205">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1767213">//&nbsp;Copy&nbsp;pointer&nbsp;bitmask&nbsp;into&nbsp;the&nbsp;bitmap.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1767256">for</span>&nbsp;<span class="ident" id="1767260">i</span>&nbsp;<span class="op" id="1767262">:=</span>&nbsp;<span class="builtintype" id="1767265">uintptr</span><span class="op" id="1767272">(</span><span class="num" id="1767273">0</span><span class="op" id="1767274">)</span><span class="op" id="1767275">;</span>&nbsp;<span class="ident" id="1767277">i</span>&nbsp;<span class="op" id="1767279">&lt;</span>&nbsp;<span class="ident" id="1767281">size0</span><span class="op" id="1767286">;</span>&nbsp;<span class="ident" id="1767288">i</span>&nbsp;<span class="op" id="1767290">+=</span>&nbsp;<span class="num" id="1767293">2</span>&nbsp;<span class="op" id="1767295">*</span>&nbsp;<span class="ident" id="1767297">ptrSize</span>&nbsp;<span class="op" id="1767305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1767310">v</span>&nbsp;<span class="op" id="1767312">:=</span>&nbsp;<span class="op" id="1767315">*</span><span class="op" id="1767316">(</span><span class="op" id="1767317">*</span><span class="builtintype" id="1767318">uint8</span><span class="op" id="1767323">)</span><span class="op" id="1767324">(</span><span class="ident" id="1767325">add</span><span class="op" id="1767328">(</span><span class="ident" id="1767329">unsafe</span><span class="op" id="1767335">.</span><span class="ident" id="1767336">Pointer</span><span class="op" id="1767343">(</span><span class="ident" id="1767344">ptrmask</span><span class="op" id="1767351">)</span><span class="op" id="1767352">,</span>&nbsp;<span class="ident" id="1767354">ti</span><span class="op" id="1767356">)</span><span class="op" id="1767357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1767362">ti</span><span class="op" id="1767364">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1767370">if</span>&nbsp;<span class="ident" id="1767373">ti</span>&nbsp;<span class="op" id="1767376">==</span>&nbsp;<span class="ident" id="1767379">te</span>&nbsp;<span class="op" id="1767382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1767388">ti</span>&nbsp;<span class="op" id="1767391">=</span>&nbsp;<span class="num" id="1767393">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1767403">if</span>&nbsp;<span class="ident" id="1767406">i</span>&nbsp;<span class="op" id="1767408">==</span>&nbsp;<span class="num" id="1767411">0</span>&nbsp;<span class="op" id="1767413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1767419">v</span>&nbsp;<span class="op" id="1767421">|=</span>&nbsp;<span class="ident" id="1767424">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1767444">if</span>&nbsp;<span class="ident" id="1767447">i</span><span class="op" id="1767448">+</span><span class="ident" id="1767449">ptrSize</span>&nbsp;<span class="op" id="1767457">==</span>&nbsp;<span class="ident" id="1767460">size0</span>&nbsp;<span class="op" id="1767466">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1767472">v</span>&nbsp;<span class="op" id="1767474">&amp;^=</span>&nbsp;<span class="builtintype" id="1767478">uint8</span><span class="op" id="1767483">(</span><span class="ident" id="1767484">bitPtrMask</span>&nbsp;<span class="op" id="1767495">&lt;&lt;</span>&nbsp;<span class="num" id="1767498">4</span><span class="op" id="1767499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767510">*</span><span class="ident" id="1767511">xbits</span>&nbsp;<span class="op" id="1767517">=</span>&nbsp;<span class="ident" id="1767519">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1767524">xbits</span>&nbsp;<span class="op" id="1767530">=</span>&nbsp;<span class="op" id="1767532">(</span><span class="op" id="1767533">*</span><span class="builtintype" id="1767534">byte</span><span class="op" id="1767538">)</span><span class="op" id="1767539">(</span><span class="ident" id="1767540">add</span><span class="op" id="1767543">(</span><span class="ident" id="1767544">unsafe</span><span class="op" id="1767550">.</span><span class="ident" id="1767551">Pointer</span><span class="op" id="1767558">(</span><span class="ident" id="1767559">xbits</span><span class="op" id="1767564">)</span><span class="op" id="1767565">,</span>&nbsp;<span class="op" id="1767567">^</span><span class="builtintype" id="1767568">uintptr</span><span class="op" id="1767575">(</span><span class="num" id="1767576">0</span><span class="op" id="1767577">)</span><span class="op" id="1767578">)</span><span class="op" id="1767579">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1767587">if</span>&nbsp;<span class="ident" id="1767590">size0</span><span class="op" id="1767595">%</span><span class="op" id="1767596">(</span><span class="num" id="1767597">2</span><span class="op" id="1767598">*</span><span class="ident" id="1767599">ptrSize</span><span class="op" id="1767606">)</span>&nbsp;<span class="op" id="1767608">==</span>&nbsp;<span class="num" id="1767611">0</span>&nbsp;<span class="op" id="1767613">&amp;&amp;</span>&nbsp;<span class="ident" id="1767616">size0</span>&nbsp;<span class="op" id="1767622">&lt;</span>&nbsp;<span class="ident" id="1767624">size</span>&nbsp;<span class="op" id="1767629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1767634">//&nbsp;Mark&nbsp;the&nbsp;word&nbsp;after&nbsp;last&nbsp;object&#39;s&nbsp;word&nbsp;as&nbsp;bitsDead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767692">*</span><span class="ident" id="1767693">xbits</span>&nbsp;<span class="op" id="1767699">=</span>&nbsp;<span class="ident" id="1767701">bitsDead</span>&nbsp;<span class="op" id="1767710">&lt;&lt;</span>&nbsp;<span class="num" id="1767713">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767717">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767720">}</span><br>
<span class="lineno"></span><span class="ident" id="1767722">marked</span><span class="op" id="1767728">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1767731">if</span>&nbsp;<span class="ident" id="1767734">raceenabled</span>&nbsp;<span class="op" id="1767746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1767750">racemalloc</span><span class="op" id="1767760">(</span><span class="ident" id="1767761">x</span><span class="op" id="1767762">,</span>&nbsp;<span class="ident" id="1767764">size</span><span class="op" id="1767768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767771">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1767775">if</span>&nbsp;<span class="ident" id="1767778">debugMalloc</span>&nbsp;<span class="op" id="1767790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1767794">mp</span>&nbsp;<span class="op" id="1767797">:=</span>&nbsp;<span class="ident" id="1767800">acquirem</span><span class="op" id="1767808">(</span><span class="op" id="1767809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1767813">if</span>&nbsp;<span class="ident" id="1767816">mp</span><span class="op" id="1767818">.</span><span class="ident" id="1767819">mallocing</span>&nbsp;<span class="op" id="1767829">==</span>&nbsp;<span class="num" id="1767832">0</span>&nbsp;<span class="op" id="1767834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1767839">gothrow</span><span class="op" id="1767846">(</span><span class="string" id="1767847">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1767859">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1767867">mp</span><span class="op" id="1767869">.</span><span class="ident" id="1767870">mallocing</span>&nbsp;<span class="op" id="1767880">=</span>&nbsp;<span class="num" id="1767882">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1767886">if</span>&nbsp;<span class="ident" id="1767889">mp</span><span class="op" id="1767891">.</span><span class="ident" id="1767892">curg</span>&nbsp;<span class="op" id="1767897">!=</span>&nbsp;<span class="ident" id="1767900">nil</span>&nbsp;<span class="op" id="1767904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1767909">mp</span><span class="op" id="1767911">.</span><span class="ident" id="1767912">curg</span><span class="op" id="1767916">.</span><span class="ident" id="1767917">stackguard0</span>&nbsp;<span class="op" id="1767929">=</span>&nbsp;<span class="ident" id="1767931">mp</span><span class="op" id="1767933">.</span><span class="ident" id="1767934">curg</span><span class="op" id="1767938">.</span><span class="ident" id="1767939">stack</span><span class="op" id="1767944">.</span><span class="ident" id="1767945">lo</span>&nbsp;<span class="op" id="1767948">+</span>&nbsp;<span class="ident" id="1767950">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1767964">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1767968">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1768021">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1768073">releasem</span><span class="op" id="1768081">(</span><span class="ident" id="1768082">mp</span><span class="op" id="1768084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1768088">releasem</span><span class="op" id="1768096">(</span><span class="ident" id="1768097">mp</span><span class="op" id="1768099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1768102">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1768106">if</span>&nbsp;<span class="ident" id="1768109">debug</span><span class="op" id="1768114">.</span><span class="ident" id="1768115">allocfreetrace</span>&nbsp;<span class="op" id="1768130">!=</span>&nbsp;<span class="num" id="1768133">0</span>&nbsp;<span class="op" id="1768135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1768139">tracealloc</span><span class="op" id="1768149">(</span><span class="ident" id="1768150">x</span><span class="op" id="1768151">,</span>&nbsp;<span class="ident" id="1768153">size</span><span class="op" id="1768157">,</span>&nbsp;<span class="ident" id="1768159">typ</span><span class="op" id="1768162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1768165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1768169">if</span>&nbsp;<span class="ident" id="1768172">rate</span>&nbsp;<span class="op" id="1768177">:=</span>&nbsp;<span class="ident" id="1768180">MemProfileRate</span><span class="op" id="1768194">;</span>&nbsp;<span class="ident" id="1768196">rate</span>&nbsp;<span class="op" id="1768201">&gt;</span>&nbsp;<span class="num" id="1768203">0</span>&nbsp;<span class="op" id="1768205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1768209">if</span>&nbsp;<span class="ident" id="1768212">size</span>&nbsp;<span class="op" id="1768217">&lt;</span>&nbsp;<span class="builtintype" id="1768219">uintptr</span><span class="op" id="1768226">(</span><span class="ident" id="1768227">rate</span><span class="op" id="1768231">)</span>&nbsp;<span class="op" id="1768233">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1768236">int32</span><span class="op" id="1768241">(</span><span class="ident" id="1768242">size</span><span class="op" id="1768246">)</span>&nbsp;<span class="op" id="1768248">&lt;</span>&nbsp;<span class="ident" id="1768250">c</span><span class="op" id="1768251">.</span><span class="ident" id="1768252">next_sample</span>&nbsp;<span class="op" id="1768264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1768269">c</span><span class="op" id="1768270">.</span><span class="ident" id="1768271">next_sample</span>&nbsp;<span class="op" id="1768283">-=</span>&nbsp;<span class="builtintype" id="1768286">int32</span><span class="op" id="1768291">(</span><span class="ident" id="1768292">size</span><span class="op" id="1768296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1768300">}</span>&nbsp;<span class="keyword" id="1768302">else</span>&nbsp;<span class="op" id="1768307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1768312">mp</span>&nbsp;<span class="op" id="1768315">:=</span>&nbsp;<span class="ident" id="1768318">acquirem</span><span class="op" id="1768326">(</span><span class="op" id="1768327">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1768332">profilealloc</span><span class="op" id="1768344">(</span><span class="ident" id="1768345">mp</span><span class="op" id="1768347">,</span>&nbsp;<span class="ident" id="1768349">x</span><span class="op" id="1768350">,</span>&nbsp;<span class="ident" id="1768352">size</span><span class="op" id="1768356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1768361">releasem</span><span class="op" id="1768369">(</span><span class="ident" id="1768370">mp</span><span class="op" id="1768372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1768376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1768379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1768383">if</span>&nbsp;<span class="ident" id="1768386">memstats</span><span class="op" id="1768394">.</span><span class="ident" id="1768395">heap_alloc</span>&nbsp;<span class="op" id="1768406">&gt;=</span>&nbsp;<span class="ident" id="1768409">memstats</span><span class="op" id="1768417">.</span><span class="ident" id="1768418">next_gc</span>&nbsp;<span class="op" id="1768426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1768430">gogc</span><span class="op" id="1768434">(</span><span class="num" id="1768435">0</span><span class="op" id="1768436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1768439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1768443">return</span>&nbsp;<span class="ident" id="1768450">x</span><br>
<span class="lineno">345</span><span class="op" id="1768452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1768455">//&nbsp;implementation&nbsp;of&nbsp;new&nbsp;builtin</span><br>
<span class="lineno"></span><span class="keyword" id="1768488">func</span>&nbsp;<span class="ident" id="1768493">newobject</span><span class="op" id="1768502">(</span><span class="ident" id="1768503">typ</span>&nbsp;<span class="op" id="1768507">*</span><span class="ident" id="1768508">_type</span><span class="op" id="1768513">)</span>&nbsp;<span class="ident" id="1768515">unsafe</span><span class="op" id="1768521">.</span><span class="ident" id="1768522">Pointer</span>&nbsp;<span class="op" id="1768530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1768533">flags</span>&nbsp;<span class="op" id="1768539">:=</span>&nbsp;<span class="builtintype" id="1768542">uint32</span><span class="op" id="1768548">(</span><span class="num" id="1768549">0</span><span class="op" id="1768550">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1768553">if</span>&nbsp;<span class="ident" id="1768556">typ</span><span class="op" id="1768559">.</span><span class="ident" id="1768560">kind</span><span class="op" id="1768564">&amp;</span><span class="ident" id="1768565">kindNoPointers</span>&nbsp;<span class="op" id="1768580">!=</span>&nbsp;<span class="num" id="1768583">0</span>&nbsp;<span class="op" id="1768585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1768589">flags</span>&nbsp;<span class="op" id="1768595">|=</span>&nbsp;<span class="ident" id="1768598">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1768610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1768613">return</span>&nbsp;<span class="ident" id="1768620">mallocgc</span><span class="op" id="1768628">(</span><span class="builtintype" id="1768629">uintptr</span><span class="op" id="1768636">(</span><span class="ident" id="1768637">typ</span><span class="op" id="1768640">.</span><span class="ident" id="1768641">size</span><span class="op" id="1768645">)</span><span class="op" id="1768646">,</span>&nbsp;<span class="ident" id="1768648">typ</span><span class="op" id="1768651">,</span>&nbsp;<span class="ident" id="1768653">flags</span><span class="op" id="1768658">)</span><br>
<span class="lineno"></span><span class="op" id="1768660">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="1768663">//&nbsp;implementation&nbsp;of&nbsp;make&nbsp;builtin&nbsp;for&nbsp;slices</span><br>
<span class="lineno"></span><span class="keyword" id="1768708">func</span>&nbsp;<span class="ident" id="1768713">newarray</span><span class="op" id="1768721">(</span><span class="ident" id="1768722">typ</span>&nbsp;<span class="op" id="1768726">*</span><span class="ident" id="1768727">_type</span><span class="op" id="1768732">,</span>&nbsp;<span class="ident" id="1768734">n</span>&nbsp;<span class="builtintype" id="1768736">uintptr</span><span class="op" id="1768743">)</span>&nbsp;<span class="ident" id="1768745">unsafe</span><span class="op" id="1768751">.</span><span class="ident" id="1768752">Pointer</span>&nbsp;<span class="op" id="1768760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1768763">flags</span>&nbsp;<span class="op" id="1768769">:=</span>&nbsp;<span class="builtintype" id="1768772">uint32</span><span class="op" id="1768778">(</span><span class="num" id="1768779">0</span><span class="op" id="1768780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1768783">if</span>&nbsp;<span class="ident" id="1768786">typ</span><span class="op" id="1768789">.</span><span class="ident" id="1768790">kind</span><span class="op" id="1768794">&amp;</span><span class="ident" id="1768795">kindNoPointers</span>&nbsp;<span class="op" id="1768810">!=</span>&nbsp;<span class="num" id="1768813">0</span>&nbsp;<span class="op" id="1768815">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1768819">flags</span>&nbsp;<span class="op" id="1768825">|=</span>&nbsp;<span class="ident" id="1768828">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1768840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1768843">if</span>&nbsp;<span class="builtintype" id="1768846">int</span><span class="op" id="1768849">(</span><span class="ident" id="1768850">n</span><span class="op" id="1768851">)</span>&nbsp;<span class="op" id="1768853">&lt;</span>&nbsp;<span class="num" id="1768855">0</span>&nbsp;<span class="op" id="1768857">||</span>&nbsp;<span class="op" id="1768860">(</span><span class="ident" id="1768861">typ</span><span class="op" id="1768864">.</span><span class="ident" id="1768865">size</span>&nbsp;<span class="op" id="1768870">&gt;</span>&nbsp;<span class="num" id="1768872">0</span>&nbsp;<span class="op" id="1768874">&amp;&amp;</span>&nbsp;<span class="ident" id="1768877">n</span>&nbsp;<span class="op" id="1768879">&gt;</span>&nbsp;<span class="ident" id="1768881">maxmem</span><span class="op" id="1768887">/</span><span class="builtintype" id="1768888">uintptr</span><span class="op" id="1768895">(</span><span class="ident" id="1768896">typ</span><span class="op" id="1768899">.</span><span class="ident" id="1768900">size</span><span class="op" id="1768904">)</span><span class="op" id="1768905">)</span>&nbsp;<span class="op" id="1768907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1768911">panic</span><span class="op" id="1768916">(</span><span class="string" id="1768917">&#34;runtime:&nbsp;allocation&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1768956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1768959">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1768962">return</span>&nbsp;<span class="ident" id="1768969">mallocgc</span><span class="op" id="1768977">(</span><span class="builtintype" id="1768978">uintptr</span><span class="op" id="1768985">(</span><span class="ident" id="1768986">typ</span><span class="op" id="1768989">.</span><span class="ident" id="1768990">size</span><span class="op" id="1768994">)</span><span class="op" id="1768995">*</span><span class="ident" id="1768996">n</span><span class="op" id="1768997">,</span>&nbsp;<span class="ident" id="1768999">typ</span><span class="op" id="1769002">,</span>&nbsp;<span class="ident" id="1769004">flags</span><span class="op" id="1769009">)</span><br>
<span class="lineno"></span><span class="op" id="1769011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1769014">//&nbsp;rawmem&nbsp;returns&nbsp;a&nbsp;chunk&nbsp;of&nbsp;pointerless&nbsp;memory.&nbsp;&nbsp;It&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1769070">//&nbsp;not&nbsp;zeroed.</span><br>
<span class="lineno">370</span><span class="keyword" id="1769085">func</span>&nbsp;<span class="ident" id="1769090">rawmem</span><span class="op" id="1769096">(</span><span class="ident" id="1769097">size</span>&nbsp;<span class="builtintype" id="1769102">uintptr</span><span class="op" id="1769109">)</span>&nbsp;<span class="ident" id="1769111">unsafe</span><span class="op" id="1769117">.</span><span class="ident" id="1769118">Pointer</span>&nbsp;<span class="op" id="1769126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1769129">return</span>&nbsp;<span class="ident" id="1769136">mallocgc</span><span class="op" id="1769144">(</span><span class="ident" id="1769145">size</span><span class="op" id="1769149">,</span>&nbsp;<span class="ident" id="1769151">nil</span><span class="op" id="1769154">,</span>&nbsp;<span class="ident" id="1769156">flagNoScan</span><span class="op" id="1769166">|</span><span class="ident" id="1769167">flagNoZero</span><span class="op" id="1769177">)</span><br>
<span class="lineno"></span><span class="op" id="1769179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1769182">//&nbsp;round&nbsp;size&nbsp;up&nbsp;to&nbsp;next&nbsp;size&nbsp;class</span><br>
<span class="lineno">375</span><span class="keyword" id="1769218">func</span>&nbsp;<span class="ident" id="1769223">goroundupsize</span><span class="op" id="1769236">(</span><span class="ident" id="1769237">size</span>&nbsp;<span class="builtintype" id="1769242">uintptr</span><span class="op" id="1769249">)</span>&nbsp;<span class="builtintype" id="1769251">uintptr</span>&nbsp;<span class="op" id="1769259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1769262">if</span>&nbsp;<span class="ident" id="1769265">size</span>&nbsp;<span class="op" id="1769270">&lt;</span>&nbsp;<span class="ident" id="1769272">maxSmallSize</span>&nbsp;<span class="op" id="1769285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1769289">if</span>&nbsp;<span class="ident" id="1769292">size</span>&nbsp;<span class="op" id="1769297">&lt;=</span>&nbsp;<span class="num" id="1769300">1024</span><span class="op" id="1769304">-</span><span class="num" id="1769305">8</span>&nbsp;<span class="op" id="1769307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1769312">return</span>&nbsp;<span class="builtintype" id="1769319">uintptr</span><span class="op" id="1769326">(</span><span class="ident" id="1769327">class_to_size</span><span class="op" id="1769340">[</span><span class="ident" id="1769341">size_to_class8</span><span class="op" id="1769355">[</span><span class="op" id="1769356">(</span><span class="ident" id="1769357">size</span><span class="op" id="1769361">+</span><span class="num" id="1769362">7</span><span class="op" id="1769363">)</span><span class="op" id="1769364">&gt;&gt;</span><span class="num" id="1769366">3</span><span class="op" id="1769367">]</span><span class="op" id="1769368">]</span><span class="op" id="1769369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1769373">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1769377">return</span>&nbsp;<span class="builtintype" id="1769384">uintptr</span><span class="op" id="1769391">(</span><span class="ident" id="1769392">class_to_size</span><span class="op" id="1769405">[</span><span class="ident" id="1769406">size_to_class128</span><span class="op" id="1769422">[</span><span class="op" id="1769423">(</span><span class="ident" id="1769424">size</span><span class="op" id="1769428">-</span><span class="num" id="1769429">1024</span><span class="op" id="1769433">+</span><span class="num" id="1769434">127</span><span class="op" id="1769437">)</span><span class="op" id="1769438">&gt;&gt;</span><span class="num" id="1769440">7</span><span class="op" id="1769441">]</span><span class="op" id="1769442">]</span><span class="op" id="1769443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1769446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1769449">if</span>&nbsp;<span class="ident" id="1769452">size</span><span class="op" id="1769456">+</span><span class="ident" id="1769457">pageSize</span>&nbsp;<span class="op" id="1769466">&lt;</span>&nbsp;<span class="ident" id="1769468">size</span>&nbsp;<span class="op" id="1769473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1769477">return</span>&nbsp;<span class="ident" id="1769484">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1769490">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1769493">return</span>&nbsp;<span class="op" id="1769500">(</span><span class="ident" id="1769501">size</span>&nbsp;<span class="op" id="1769506">+</span>&nbsp;<span class="ident" id="1769508">pageSize</span>&nbsp;<span class="op" id="1769517">-</span>&nbsp;<span class="num" id="1769519">1</span><span class="op" id="1769520">)</span>&nbsp;<span class="op" id="1769522">&amp;^</span>&nbsp;<span class="ident" id="1769525">pageMask</span><br>
<span class="lineno"></span><span class="op" id="1769534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1769537">func</span>&nbsp;<span class="ident" id="1769542">profilealloc</span><span class="op" id="1769554">(</span><span class="ident" id="1769555">mp</span>&nbsp;<span class="op" id="1769558">*</span><span class="ident" id="1769559">m</span><span class="op" id="1769560">,</span>&nbsp;<span class="ident" id="1769562">x</span>&nbsp;<span class="ident" id="1769564">unsafe</span><span class="op" id="1769570">.</span><span class="ident" id="1769571">Pointer</span><span class="op" id="1769578">,</span>&nbsp;<span class="ident" id="1769580">size</span>&nbsp;<span class="builtintype" id="1769585">uintptr</span><span class="op" id="1769592">)</span>&nbsp;<span class="op" id="1769594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1769597">c</span>&nbsp;<span class="op" id="1769599">:=</span>&nbsp;<span class="ident" id="1769602">mp</span><span class="op" id="1769604">.</span><span class="ident" id="1769605">mcache</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1769613">rate</span>&nbsp;<span class="op" id="1769618">:=</span>&nbsp;<span class="ident" id="1769621">MemProfileRate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1769637">if</span>&nbsp;<span class="ident" id="1769640">size</span>&nbsp;<span class="op" id="1769645">&lt;</span>&nbsp;<span class="builtintype" id="1769647">uintptr</span><span class="op" id="1769654">(</span><span class="ident" id="1769655">rate</span><span class="op" id="1769659">)</span>&nbsp;<span class="op" id="1769661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1769665">//&nbsp;pick&nbsp;next&nbsp;profile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1769693">//&nbsp;If&nbsp;you&nbsp;change&nbsp;this,&nbsp;also&nbsp;change&nbsp;allocmcache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1769743">if</span>&nbsp;<span class="ident" id="1769746">rate</span>&nbsp;<span class="op" id="1769751">&gt;</span>&nbsp;<span class="num" id="1769753">0x3fffffff</span>&nbsp;<span class="op" id="1769764">{</span>&nbsp;<span class="comment" id="1769766">//&nbsp;make&nbsp;2*rate&nbsp;not&nbsp;overflow</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1769797">rate</span>&nbsp;<span class="op" id="1769802">=</span>&nbsp;<span class="num" id="1769804">0x3fffffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1769817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1769821">next</span>&nbsp;<span class="op" id="1769826">:=</span>&nbsp;<span class="builtintype" id="1769829">int32</span><span class="op" id="1769834">(</span><span class="ident" id="1769835">fastrand1</span><span class="op" id="1769844">(</span><span class="op" id="1769845">)</span><span class="op" id="1769846">)</span>&nbsp;<span class="op" id="1769848">%</span>&nbsp;<span class="op" id="1769850">(</span><span class="num" id="1769851">2</span>&nbsp;<span class="op" id="1769853">*</span>&nbsp;<span class="builtintype" id="1769855">int32</span><span class="op" id="1769860">(</span><span class="ident" id="1769861">rate</span><span class="op" id="1769865">)</span><span class="op" id="1769866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1769870">//&nbsp;Subtract&nbsp;the&nbsp;&#34;remainder&#34;&nbsp;of&nbsp;the&nbsp;current&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1769927">//&nbsp;Otherwise&nbsp;objects&nbsp;that&nbsp;are&nbsp;close&nbsp;in&nbsp;size&nbsp;to&nbsp;sampling&nbsp;rate</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1769990">//&nbsp;will&nbsp;be&nbsp;under-sampled,&nbsp;because&nbsp;we&nbsp;consistently&nbsp;discard&nbsp;this&nbsp;remainder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1770066">next</span>&nbsp;<span class="op" id="1770071">-=</span>&nbsp;<span class="op" id="1770074">(</span><span class="builtintype" id="1770075">int32</span><span class="op" id="1770080">(</span><span class="ident" id="1770081">size</span><span class="op" id="1770085">)</span>&nbsp;<span class="op" id="1770087">-</span>&nbsp;<span class="ident" id="1770089">c</span><span class="op" id="1770090">.</span><span class="ident" id="1770091">next_sample</span><span class="op" id="1770102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1770106">if</span>&nbsp;<span class="ident" id="1770109">next</span>&nbsp;<span class="op" id="1770114">&lt;</span>&nbsp;<span class="num" id="1770116">0</span>&nbsp;<span class="op" id="1770118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1770123">next</span>&nbsp;<span class="op" id="1770128">=</span>&nbsp;<span class="num" id="1770130">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1770134">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1770138">c</span><span class="op" id="1770139">.</span><span class="ident" id="1770140">next_sample</span>&nbsp;<span class="op" id="1770152">=</span>&nbsp;<span class="ident" id="1770154">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1770160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1770164">mProf_Malloc</span><span class="op" id="1770176">(</span><span class="ident" id="1770177">x</span><span class="op" id="1770178">,</span>&nbsp;<span class="ident" id="1770180">size</span><span class="op" id="1770184">)</span><br>
<span class="lineno"></span><span class="op" id="1770186">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="1770189">//&nbsp;force&nbsp;=&nbsp;1&nbsp;-&nbsp;do&nbsp;GC&nbsp;regardless&nbsp;of&nbsp;current&nbsp;heap&nbsp;usage</span><br>
<span class="lineno"></span><span class="comment" id="1770243">//&nbsp;force&nbsp;=&nbsp;2&nbsp;-&nbsp;go&nbsp;GC&nbsp;and&nbsp;eager&nbsp;sweep</span><br>
<span class="lineno"></span><span class="keyword" id="1770280">func</span>&nbsp;<span class="ident" id="1770285">gogc</span><span class="op" id="1770289">(</span><span class="ident" id="1770290">force</span>&nbsp;<span class="builtintype" id="1770296">int32</span><span class="op" id="1770301">)</span>&nbsp;<span class="op" id="1770303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1770306">//&nbsp;The&nbsp;gc&nbsp;is&nbsp;turned&nbsp;off&nbsp;(via&nbsp;enablegc)&nbsp;until&nbsp;the&nbsp;bootstrap&nbsp;has&nbsp;completed.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1770381">//&nbsp;Also,&nbsp;malloc&nbsp;gets&nbsp;called&nbsp;in&nbsp;the&nbsp;guts&nbsp;of&nbsp;a&nbsp;number&nbsp;of&nbsp;libraries&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1770461">//&nbsp;holding&nbsp;locks.&nbsp;To&nbsp;avoid&nbsp;deadlocks&nbsp;during&nbsp;stoptheworld,&nbsp;don&#39;t&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1770533">//&nbsp;trying&nbsp;to&nbsp;run&nbsp;gc&nbsp;while&nbsp;holding&nbsp;a&nbsp;lock.&nbsp;The&nbsp;next&nbsp;mallocgc&nbsp;without&nbsp;a&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1770609">//&nbsp;will&nbsp;do&nbsp;the&nbsp;gc&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1770637">mp</span>&nbsp;<span class="op" id="1770640">:=</span>&nbsp;<span class="ident" id="1770643">acquirem</span><span class="op" id="1770651">(</span><span class="op" id="1770652">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1770655">if</span>&nbsp;<span class="ident" id="1770658">gp</span>&nbsp;<span class="op" id="1770661">:=</span>&nbsp;<span class="ident" id="1770664">getg</span><span class="op" id="1770668">(</span><span class="op" id="1770669">)</span><span class="op" id="1770670">;</span>&nbsp;<span class="ident" id="1770672">gp</span>&nbsp;<span class="op" id="1770675">==</span>&nbsp;<span class="ident" id="1770678">mp</span><span class="op" id="1770680">.</span><span class="ident" id="1770681">g0</span>&nbsp;<span class="op" id="1770684">||</span>&nbsp;<span class="ident" id="1770687">mp</span><span class="op" id="1770689">.</span><span class="ident" id="1770690">locks</span>&nbsp;<span class="op" id="1770696">&gt;</span>&nbsp;<span class="num" id="1770698">1</span>&nbsp;<span class="op" id="1770700">||</span>&nbsp;<span class="op" id="1770703">!</span><span class="ident" id="1770704">memstats</span><span class="op" id="1770712">.</span><span class="ident" id="1770713">enablegc</span>&nbsp;<span class="op" id="1770722">||</span>&nbsp;<span class="ident" id="1770725">panicking</span>&nbsp;<span class="op" id="1770735">!=</span>&nbsp;<span class="num" id="1770738">0</span>&nbsp;<span class="op" id="1770740">||</span>&nbsp;<span class="ident" id="1770743">gcpercent</span>&nbsp;<span class="op" id="1770753">&lt;</span>&nbsp;<span class="num" id="1770755">0</span>&nbsp;<span class="op" id="1770757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1770761">releasem</span><span class="op" id="1770769">(</span><span class="ident" id="1770770">mp</span><span class="op" id="1770772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1770776">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1770784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1770787">releasem</span><span class="op" id="1770795">(</span><span class="ident" id="1770796">mp</span><span class="op" id="1770798">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1770801">mp</span>&nbsp;<span class="op" id="1770804">=</span>&nbsp;<span class="ident" id="1770806">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1770812">semacquire</span><span class="op" id="1770822">(</span><span class="op" id="1770823">&amp;</span><span class="ident" id="1770824">worldsema</span><span class="op" id="1770833">,</span>&nbsp;<span class="builtintype" id="1770835">false</span><span class="op" id="1770840">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1770844">if</span>&nbsp;<span class="ident" id="1770847">force</span>&nbsp;<span class="op" id="1770853">==</span>&nbsp;<span class="num" id="1770856">0</span>&nbsp;<span class="op" id="1770858">&amp;&amp;</span>&nbsp;<span class="ident" id="1770861">memstats</span><span class="op" id="1770869">.</span><span class="ident" id="1770870">heap_alloc</span>&nbsp;<span class="op" id="1770881">&lt;</span>&nbsp;<span class="ident" id="1770883">memstats</span><span class="op" id="1770891">.</span><span class="ident" id="1770892">next_gc</span>&nbsp;<span class="op" id="1770900">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1770904">//&nbsp;typically&nbsp;threads&nbsp;which&nbsp;lost&nbsp;the&nbsp;race&nbsp;to&nbsp;grab</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1770955">//&nbsp;worldsema&nbsp;exit&nbsp;here&nbsp;when&nbsp;gc&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1770997">semrelease</span><span class="op" id="1771007">(</span><span class="op" id="1771008">&amp;</span><span class="ident" id="1771009">worldsema</span><span class="op" id="1771018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1771022">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1771030">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1771034">//&nbsp;Ok,&nbsp;we&#39;re&nbsp;doing&nbsp;it!&nbsp;&nbsp;Stop&nbsp;everybody&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771079">startTime</span>&nbsp;<span class="op" id="1771089">:=</span>&nbsp;<span class="ident" id="1771092">nanotime</span><span class="op" id="1771100">(</span><span class="op" id="1771101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771104">mp</span>&nbsp;<span class="op" id="1771107">=</span>&nbsp;<span class="ident" id="1771109">acquirem</span><span class="op" id="1771117">(</span><span class="op" id="1771118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771121">mp</span><span class="op" id="1771123">.</span><span class="ident" id="1771124">gcing</span>&nbsp;<span class="op" id="1771130">=</span>&nbsp;<span class="num" id="1771132">1</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771135">releasem</span><span class="op" id="1771143">(</span><span class="ident" id="1771144">mp</span><span class="op" id="1771146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771149">onM</span><span class="op" id="1771152">(</span><span class="ident" id="1771153">stoptheworld</span><span class="op" id="1771165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1771168">if</span>&nbsp;<span class="ident" id="1771171">mp</span>&nbsp;<span class="op" id="1771174">!=</span>&nbsp;<span class="ident" id="1771177">acquirem</span><span class="op" id="1771185">(</span><span class="op" id="1771186">)</span>&nbsp;<span class="op" id="1771188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771192">gothrow</span><span class="op" id="1771199">(</span><span class="string" id="1771200">&#34;gogc:&nbsp;rescheduled&#34;</span><span class="op" id="1771219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1771222">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771226">clearpools</span><span class="op" id="1771236">(</span><span class="op" id="1771237">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1771241">//&nbsp;Run&nbsp;gc&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;so&nbsp;that&nbsp;the&nbsp;g&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1771301">//&nbsp;we&#39;re&nbsp;currently&nbsp;running&nbsp;on&nbsp;will&nbsp;no&nbsp;longer&nbsp;change.&nbsp;&nbsp;Cuts</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1771361">//&nbsp;the&nbsp;root&nbsp;set&nbsp;down&nbsp;a&nbsp;bit&nbsp;(g0&nbsp;stacks&nbsp;are&nbsp;not&nbsp;scanned,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1771421">//&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;scan&nbsp;gc&#39;s&nbsp;internal&nbsp;state).&nbsp;&nbsp;We&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1771478">//&nbsp;need&nbsp;to&nbsp;switch&nbsp;to&nbsp;g0&nbsp;so&nbsp;we&nbsp;can&nbsp;shrink&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771531">n</span>&nbsp;<span class="op" id="1771533">:=</span>&nbsp;<span class="num" id="1771536">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1771539">if</span>&nbsp;<span class="ident" id="1771542">debug</span><span class="op" id="1771547">.</span><span class="ident" id="1771548">gctrace</span>&nbsp;<span class="op" id="1771556">&gt;</span>&nbsp;<span class="num" id="1771558">1</span>&nbsp;<span class="op" id="1771560">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771564">n</span>&nbsp;<span class="op" id="1771566">=</span>&nbsp;<span class="num" id="1771568">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1771571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1771574">for</span>&nbsp;<span class="ident" id="1771578">i</span>&nbsp;<span class="op" id="1771580">:=</span>&nbsp;<span class="num" id="1771583">0</span><span class="op" id="1771584">;</span>&nbsp;<span class="ident" id="1771586">i</span>&nbsp;<span class="op" id="1771588">&lt;</span>&nbsp;<span class="ident" id="1771590">n</span><span class="op" id="1771591">;</span>&nbsp;<span class="ident" id="1771593">i</span><span class="op" id="1771594">++</span>&nbsp;<span class="op" id="1771597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1771601">if</span>&nbsp;<span class="ident" id="1771604">i</span>&nbsp;<span class="op" id="1771606">&gt;</span>&nbsp;<span class="num" id="1771608">0</span>&nbsp;<span class="op" id="1771610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771615">startTime</span>&nbsp;<span class="op" id="1771625">=</span>&nbsp;<span class="ident" id="1771627">nanotime</span><span class="op" id="1771635">(</span><span class="op" id="1771636">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1771640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1771644">//&nbsp;switch&nbsp;to&nbsp;g0,&nbsp;call&nbsp;gc,&nbsp;then&nbsp;switch&nbsp;back</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771689">mp</span><span class="op" id="1771691">.</span><span class="ident" id="1771692">scalararg</span><span class="op" id="1771701">[</span><span class="num" id="1771702">0</span><span class="op" id="1771703">]</span>&nbsp;<span class="op" id="1771705">=</span>&nbsp;<span class="builtintype" id="1771707">uintptr</span><span class="op" id="1771714">(</span><span class="builtintype" id="1771715">uint32</span><span class="op" id="1771721">(</span><span class="ident" id="1771722">startTime</span><span class="op" id="1771731">)</span><span class="op" id="1771732">)</span>&nbsp;<span class="comment" id="1771734">//&nbsp;low&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771751">mp</span><span class="op" id="1771753">.</span><span class="ident" id="1771754">scalararg</span><span class="op" id="1771763">[</span><span class="num" id="1771764">1</span><span class="op" id="1771765">]</span>&nbsp;<span class="op" id="1771767">=</span>&nbsp;<span class="builtintype" id="1771769">uintptr</span><span class="op" id="1771776">(</span><span class="ident" id="1771777">startTime</span>&nbsp;<span class="op" id="1771787">&gt;&gt;</span>&nbsp;<span class="num" id="1771790">32</span><span class="op" id="1771792">)</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1771796">//&nbsp;high&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1771814">if</span>&nbsp;<span class="ident" id="1771817">force</span>&nbsp;<span class="op" id="1771823">&gt;=</span>&nbsp;<span class="num" id="1771826">2</span>&nbsp;<span class="op" id="1771828">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771833">mp</span><span class="op" id="1771835">.</span><span class="ident" id="1771836">scalararg</span><span class="op" id="1771845">[</span><span class="num" id="1771846">2</span><span class="op" id="1771847">]</span>&nbsp;<span class="op" id="1771849">=</span>&nbsp;<span class="num" id="1771851">1</span>&nbsp;<span class="comment" id="1771853">//&nbsp;eagersweep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1771869">}</span>&nbsp;<span class="keyword" id="1771871">else</span>&nbsp;<span class="op" id="1771876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771881">mp</span><span class="op" id="1771883">.</span><span class="ident" id="1771884">scalararg</span><span class="op" id="1771893">[</span><span class="num" id="1771894">2</span><span class="op" id="1771895">]</span>&nbsp;<span class="op" id="1771897">=</span>&nbsp;<span class="num" id="1771899">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1771903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771907">onM</span><span class="op" id="1771910">(</span><span class="ident" id="1771911">gc_m</span><span class="op" id="1771915">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1771918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1771922">//&nbsp;all&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771935">mp</span><span class="op" id="1771937">.</span><span class="ident" id="1771938">gcing</span>&nbsp;<span class="op" id="1771944">=</span>&nbsp;<span class="num" id="1771946">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771949">semrelease</span><span class="op" id="1771959">(</span><span class="op" id="1771960">&amp;</span><span class="ident" id="1771961">worldsema</span><span class="op" id="1771970">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771973">onM</span><span class="op" id="1771976">(</span><span class="ident" id="1771977">starttheworld</span><span class="op" id="1771990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1771993">releasem</span><span class="op" id="1772001">(</span><span class="ident" id="1772002">mp</span><span class="op" id="1772004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1772007">mp</span>&nbsp;<span class="op" id="1772010">=</span>&nbsp;<span class="ident" id="1772012">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1772018">//&nbsp;now&nbsp;that&nbsp;gc&nbsp;is&nbsp;done,&nbsp;kick&nbsp;off&nbsp;finalizer&nbsp;thread&nbsp;if&nbsp;needed</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1772079">if</span>&nbsp;<span class="op" id="1772082">!</span><span class="ident" id="1772083">concurrentSweep</span>&nbsp;<span class="op" id="1772099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1772103">//&nbsp;give&nbsp;the&nbsp;queued&nbsp;finalizers,&nbsp;if&nbsp;any,&nbsp;a&nbsp;chance&nbsp;to&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1772160">Gosched</span><span class="op" id="1772167">(</span><span class="op" id="1772168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1772171">}</span><br>
<span class="lineno"></span><span class="op" id="1772173">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="1772176">//&nbsp;GC&nbsp;runs&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span><span class="keyword" id="1772209">func</span>&nbsp;<span class="ident" id="1772214">GC</span><span class="op" id="1772216">(</span><span class="op" id="1772217">)</span>&nbsp;<span class="op" id="1772219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1772222">gogc</span><span class="op" id="1772226">(</span><span class="num" id="1772227">2</span><span class="op" id="1772228">)</span><br>
<span class="lineno"></span><span class="op" id="1772230">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="comment" id="1772233">//&nbsp;linker-provided</span><br>
<span class="lineno"></span><span class="keyword" id="1772252">var</span>&nbsp;<span class="ident" id="1772256">noptrdata</span>&nbsp;<span class="keyword" id="1772266">struct</span><span class="op" id="1772272">{</span><span class="op" id="1772273">}</span><br>
<span class="lineno"></span><span class="keyword" id="1772275">var</span>&nbsp;<span class="ident" id="1772279">enoptrdata</span>&nbsp;<span class="keyword" id="1772290">struct</span><span class="op" id="1772296">{</span><span class="op" id="1772297">}</span><br>
<span class="lineno"></span><span class="keyword" id="1772299">var</span>&nbsp;<span class="ident" id="1772303">noptrbss</span>&nbsp;<span class="keyword" id="1772312">struct</span><span class="op" id="1772318">{</span><span class="op" id="1772319">}</span><br>
<span class="lineno">495</span><span class="keyword" id="1772321">var</span>&nbsp;<span class="ident" id="1772325">enoptrbss</span>&nbsp;<span class="keyword" id="1772335">struct</span><span class="op" id="1772341">{</span><span class="op" id="1772342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1772345">//&nbsp;SetFinalizer&nbsp;sets&nbsp;the&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span><span class="comment" id="1772404">//&nbsp;When&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;finds&nbsp;an&nbsp;unreachable&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="1772461">//&nbsp;with&nbsp;an&nbsp;associated&nbsp;finalizer,&nbsp;it&nbsp;clears&nbsp;the&nbsp;association&nbsp;and&nbsp;runs</span><br>
<span class="lineno">500</span><span class="comment" id="1772529">//&nbsp;f(x)&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine.&nbsp;&nbsp;This&nbsp;makes&nbsp;x&nbsp;reachable&nbsp;again,&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="1772597">//&nbsp;now&nbsp;without&nbsp;an&nbsp;associated&nbsp;finalizer.&nbsp;&nbsp;Assuming&nbsp;that&nbsp;SetFinalizer</span><br>
<span class="lineno"></span><span class="comment" id="1772665">//&nbsp;is&nbsp;not&nbsp;called&nbsp;again,&nbsp;the&nbsp;next&nbsp;time&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;sees</span><br>
<span class="lineno"></span><span class="comment" id="1772730">//&nbsp;that&nbsp;x&nbsp;is&nbsp;unreachable,&nbsp;it&nbsp;will&nbsp;free&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1772772">//</span><br>
<span class="lineno">505</span><span class="comment" id="1772775">//&nbsp;SetFinalizer(x,&nbsp;nil)&nbsp;clears&nbsp;any&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1772839">//</span><br>
<span class="lineno"></span><span class="comment" id="1772842">//&nbsp;The&nbsp;argument&nbsp;x&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;object&nbsp;allocated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="1772904">//&nbsp;calling&nbsp;new&nbsp;or&nbsp;by&nbsp;taking&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;composite&nbsp;literal.</span><br>
<span class="lineno"></span><span class="comment" id="1772968">//&nbsp;The&nbsp;argument&nbsp;f&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;that&nbsp;takes&nbsp;a&nbsp;single&nbsp;argument</span><br>
<span class="lineno">510</span><span class="comment" id="1773034">//&nbsp;to&nbsp;which&nbsp;x&#39;s&nbsp;type&nbsp;can&nbsp;be&nbsp;assigned,&nbsp;and&nbsp;can&nbsp;have&nbsp;arbitrary&nbsp;ignored&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="1773110">//&nbsp;values.&nbsp;If&nbsp;either&nbsp;of&nbsp;these&nbsp;is&nbsp;not&nbsp;true,&nbsp;SetFinalizer&nbsp;aborts&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1773177">//&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1773189">//</span><br>
<span class="lineno"></span><span class="comment" id="1773192">//&nbsp;Finalizers&nbsp;are&nbsp;run&nbsp;in&nbsp;dependency&nbsp;order:&nbsp;if&nbsp;A&nbsp;points&nbsp;at&nbsp;B,&nbsp;both&nbsp;have</span><br>
<span class="lineno">515</span><span class="comment" id="1773263">//&nbsp;finalizers,&nbsp;and&nbsp;they&nbsp;are&nbsp;otherwise&nbsp;unreachable,&nbsp;only&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1773333">//&nbsp;for&nbsp;A&nbsp;runs;&nbsp;once&nbsp;A&nbsp;is&nbsp;freed,&nbsp;the&nbsp;finalizer&nbsp;for&nbsp;B&nbsp;can&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="1773394">//&nbsp;If&nbsp;a&nbsp;cyclic&nbsp;structure&nbsp;includes&nbsp;a&nbsp;block&nbsp;with&nbsp;a&nbsp;finalizer,&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1773459">//&nbsp;cycle&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;and&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1773528">//&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;run,&nbsp;because&nbsp;there&nbsp;is&nbsp;no&nbsp;ordering&nbsp;that</span><br>
<span class="lineno">520</span><span class="comment" id="1773591">//&nbsp;respects&nbsp;the&nbsp;dependencies.</span><br>
<span class="lineno"></span><span class="comment" id="1773621">//</span><br>
<span class="lineno"></span><span class="comment" id="1773624">//&nbsp;The&nbsp;finalizer&nbsp;for&nbsp;x&nbsp;is&nbsp;scheduled&nbsp;to&nbsp;run&nbsp;at&nbsp;some&nbsp;arbitrary&nbsp;time&nbsp;after</span><br>
<span class="lineno"></span><span class="comment" id="1773696">//&nbsp;x&nbsp;becomes&nbsp;unreachable.</span><br>
<span class="lineno"></span><span class="comment" id="1773722">//&nbsp;There&nbsp;is&nbsp;no&nbsp;guarantee&nbsp;that&nbsp;finalizers&nbsp;will&nbsp;run&nbsp;before&nbsp;a&nbsp;program&nbsp;exits,</span><br>
<span class="lineno">525</span><span class="comment" id="1773796">//&nbsp;so&nbsp;typically&nbsp;they&nbsp;are&nbsp;useful&nbsp;only&nbsp;for&nbsp;releasing&nbsp;non-memory&nbsp;resources</span><br>
<span class="lineno"></span><span class="comment" id="1773868">//&nbsp;associated&nbsp;with&nbsp;an&nbsp;object&nbsp;during&nbsp;a&nbsp;long-running&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1773928">//&nbsp;For&nbsp;example,&nbsp;an&nbsp;os.File&nbsp;object&nbsp;could&nbsp;use&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;close&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1773997">//&nbsp;associated&nbsp;operating&nbsp;system&nbsp;file&nbsp;descriptor&nbsp;when&nbsp;a&nbsp;program&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="1774068">//&nbsp;an&nbsp;os.File&nbsp;without&nbsp;calling&nbsp;Close,&nbsp;but&nbsp;it&nbsp;would&nbsp;be&nbsp;a&nbsp;mistake</span><br>
<span class="lineno">530</span><span class="comment" id="1774131">//&nbsp;to&nbsp;depend&nbsp;on&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;flush&nbsp;an&nbsp;in-memory&nbsp;I/O&nbsp;buffer&nbsp;such&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1774202">//&nbsp;bufio.Writer,&nbsp;because&nbsp;the&nbsp;buffer&nbsp;would&nbsp;not&nbsp;be&nbsp;flushed&nbsp;at&nbsp;program&nbsp;exit.</span><br>
<span class="lineno"></span><span class="comment" id="1774276">//</span><br>
<span class="lineno"></span><span class="comment" id="1774279">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;*x&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1774350">//&nbsp;zero&nbsp;bytes.</span><br>
<span class="lineno">535</span><span class="comment" id="1774365">//</span><br>
<span class="lineno"></span><span class="comment" id="1774368">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;for&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1774440">//&nbsp;in&nbsp;initializers&nbsp;for&nbsp;package-level&nbsp;variables.&nbsp;Such&nbsp;objects&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1774508">//&nbsp;linker-allocated,&nbsp;not&nbsp;heap-allocated.</span><br>
<span class="lineno"></span><span class="comment" id="1774549">//</span><br>
<span class="lineno">540</span><span class="comment" id="1774552">//&nbsp;A&nbsp;single&nbsp;goroutine&nbsp;runs&nbsp;all&nbsp;finalizers&nbsp;for&nbsp;a&nbsp;program,&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="comment" id="1774623">//&nbsp;If&nbsp;a&nbsp;finalizer&nbsp;must&nbsp;run&nbsp;for&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;should&nbsp;do&nbsp;so&nbsp;by&nbsp;starting</span><br>
<span class="lineno"></span><span class="comment" id="1774695">//&nbsp;a&nbsp;new&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1774715">func</span>&nbsp;<span class="ident" id="1774720">SetFinalizer</span><span class="op" id="1774732">(</span><span class="ident" id="1774733">obj</span>&nbsp;<span class="keyword" id="1774737">interface</span><span class="op" id="1774746">{</span><span class="op" id="1774747">}</span><span class="op" id="1774748">,</span>&nbsp;<span class="ident" id="1774750">finalizer</span>&nbsp;<span class="keyword" id="1774760">interface</span><span class="op" id="1774769">{</span><span class="op" id="1774770">}</span><span class="op" id="1774771">)</span>&nbsp;<span class="op" id="1774773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1774776">e</span>&nbsp;<span class="op" id="1774778">:=</span>&nbsp;<span class="op" id="1774781">(</span><span class="op" id="1774782">*</span><span class="ident" id="1774783">eface</span><span class="op" id="1774788">)</span><span class="op" id="1774789">(</span><span class="ident" id="1774790">unsafe</span><span class="op" id="1774796">.</span><span class="ident" id="1774797">Pointer</span><span class="op" id="1774804">(</span><span class="op" id="1774805">&amp;</span><span class="ident" id="1774806">obj</span><span class="op" id="1774809">)</span><span class="op" id="1774810">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1774813">etyp</span>&nbsp;<span class="op" id="1774818">:=</span>&nbsp;<span class="ident" id="1774821">e</span><span class="op" id="1774822">.</span><span class="ident" id="1774823">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1774830">if</span>&nbsp;<span class="ident" id="1774833">etyp</span>&nbsp;<span class="op" id="1774838">==</span>&nbsp;<span class="ident" id="1774841">nil</span>&nbsp;<span class="op" id="1774845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1774849">gothrow</span><span class="op" id="1774856">(</span><span class="string" id="1774857">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;nil&#34;</span><span class="op" id="1774902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1774905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1774908">if</span>&nbsp;<span class="ident" id="1774911">etyp</span><span class="op" id="1774915">.</span><span class="ident" id="1774916">kind</span><span class="op" id="1774920">&amp;</span><span class="ident" id="1774921">kindMask</span>&nbsp;<span class="op" id="1774930">!=</span>&nbsp;<span class="ident" id="1774933">kindPtr</span>&nbsp;<span class="op" id="1774941">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1774945">gothrow</span><span class="op" id="1774952">(</span><span class="string" id="1774953">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1774996">+</span>&nbsp;<span class="op" id="1774998">*</span><span class="ident" id="1774999">etyp</span><span class="op" id="1775003">.</span><span class="ident" id="1775004">_string</span>&nbsp;<span class="op" id="1775012">+</span>&nbsp;<span class="string" id="1775014">&#34;,&nbsp;not&nbsp;pointer&#34;</span><span class="op" id="1775029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1775032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1775035">ot</span>&nbsp;<span class="op" id="1775038">:=</span>&nbsp;<span class="op" id="1775041">(</span><span class="op" id="1775042">*</span><span class="ident" id="1775043">ptrtype</span><span class="op" id="1775050">)</span><span class="op" id="1775051">(</span><span class="ident" id="1775052">unsafe</span><span class="op" id="1775058">.</span><span class="ident" id="1775059">Pointer</span><span class="op" id="1775066">(</span><span class="ident" id="1775067">etyp</span><span class="op" id="1775071">)</span><span class="op" id="1775072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1775075">if</span>&nbsp;<span class="ident" id="1775078">ot</span><span class="op" id="1775080">.</span><span class="ident" id="1775081">elem</span>&nbsp;<span class="op" id="1775086">==</span>&nbsp;<span class="ident" id="1775089">nil</span>&nbsp;<span class="op" id="1775093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1775097">gothrow</span><span class="op" id="1775104">(</span><span class="string" id="1775105">&#34;nil&nbsp;elem&nbsp;type!&#34;</span><span class="op" id="1775121">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1775124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1775128">//&nbsp;find&nbsp;the&nbsp;containing&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1775159">_</span><span class="op" id="1775160">,</span>&nbsp;<span class="ident" id="1775162">base</span><span class="op" id="1775166">,</span>&nbsp;<span class="ident" id="1775168">_</span>&nbsp;<span class="op" id="1775170">:=</span>&nbsp;<span class="ident" id="1775173">findObject</span><span class="op" id="1775183">(</span><span class="ident" id="1775184">e</span><span class="op" id="1775185">.</span><span class="ident" id="1775186">data</span><span class="op" id="1775190">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1775194">if</span>&nbsp;<span class="ident" id="1775197">base</span>&nbsp;<span class="op" id="1775202">==</span>&nbsp;<span class="ident" id="1775205">nil</span>&nbsp;<span class="op" id="1775209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1775213">//&nbsp;0-length&nbsp;objects&nbsp;are&nbsp;okay.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1775245">if</span>&nbsp;<span class="ident" id="1775248">e</span><span class="op" id="1775249">.</span><span class="ident" id="1775250">data</span>&nbsp;<span class="op" id="1775255">==</span>&nbsp;<span class="ident" id="1775258">unsafe</span><span class="op" id="1775264">.</span><span class="ident" id="1775265">Pointer</span><span class="op" id="1775272">(</span><span class="op" id="1775273">&amp;</span><span class="ident" id="1775274">zerobase</span><span class="op" id="1775282">)</span>&nbsp;<span class="op" id="1775284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1775289">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1775298">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1775303">//&nbsp;Global&nbsp;initializers&nbsp;might&nbsp;be&nbsp;linker-allocated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1775355">//&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;Foo&nbsp;=&nbsp;&amp;Object{}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1775380">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1775399">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspruntime.SetFinalizer(Foo,&nbsp;nil)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1775436">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1775443">//&nbsp;The&nbsp;relevant&nbsp;segments&nbsp;are:&nbsp;noptrdata,&nbsp;data,&nbsp;bss,&nbsp;noptrbss.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1775507">//&nbsp;We&nbsp;cannot&nbsp;assume&nbsp;they&nbsp;are&nbsp;in&nbsp;any&nbsp;order&nbsp;or&nbsp;even&nbsp;contiguous,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1775571">//&nbsp;due&nbsp;to&nbsp;external&nbsp;linking.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1775601">if</span>&nbsp;<span class="builtintype" id="1775604">uintptr</span><span class="op" id="1775611">(</span><span class="ident" id="1775612">unsafe</span><span class="op" id="1775618">.</span><span class="ident" id="1775619">Pointer</span><span class="op" id="1775626">(</span><span class="op" id="1775627">&amp;</span><span class="ident" id="1775628">noptrdata</span><span class="op" id="1775637">)</span><span class="op" id="1775638">)</span>&nbsp;<span class="op" id="1775640">&lt;=</span>&nbsp;<span class="builtintype" id="1775643">uintptr</span><span class="op" id="1775650">(</span><span class="ident" id="1775651">e</span><span class="op" id="1775652">.</span><span class="ident" id="1775653">data</span><span class="op" id="1775657">)</span>&nbsp;<span class="op" id="1775659">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1775662">uintptr</span><span class="op" id="1775669">(</span><span class="ident" id="1775670">e</span><span class="op" id="1775671">.</span><span class="ident" id="1775672">data</span><span class="op" id="1775676">)</span>&nbsp;<span class="op" id="1775678">&lt;</span>&nbsp;<span class="builtintype" id="1775680">uintptr</span><span class="op" id="1775687">(</span><span class="ident" id="1775688">unsafe</span><span class="op" id="1775694">.</span><span class="ident" id="1775695">Pointer</span><span class="op" id="1775702">(</span><span class="op" id="1775703">&amp;</span><span class="ident" id="1775704">enoptrdata</span><span class="op" id="1775714">)</span><span class="op" id="1775715">)</span>&nbsp;<span class="op" id="1775717">||</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1775723">uintptr</span><span class="op" id="1775730">(</span><span class="ident" id="1775731">unsafe</span><span class="op" id="1775737">.</span><span class="ident" id="1775738">Pointer</span><span class="op" id="1775745">(</span><span class="op" id="1775746">&amp;</span><span class="ident" id="1775747">data</span><span class="op" id="1775751">)</span><span class="op" id="1775752">)</span>&nbsp;<span class="op" id="1775754">&lt;=</span>&nbsp;<span class="builtintype" id="1775757">uintptr</span><span class="op" id="1775764">(</span><span class="ident" id="1775765">e</span><span class="op" id="1775766">.</span><span class="ident" id="1775767">data</span><span class="op" id="1775771">)</span>&nbsp;<span class="op" id="1775773">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1775776">uintptr</span><span class="op" id="1775783">(</span><span class="ident" id="1775784">e</span><span class="op" id="1775785">.</span><span class="ident" id="1775786">data</span><span class="op" id="1775790">)</span>&nbsp;<span class="op" id="1775792">&lt;</span>&nbsp;<span class="builtintype" id="1775794">uintptr</span><span class="op" id="1775801">(</span><span class="ident" id="1775802">unsafe</span><span class="op" id="1775808">.</span><span class="ident" id="1775809">Pointer</span><span class="op" id="1775816">(</span><span class="op" id="1775817">&amp;</span><span class="ident" id="1775818">edata</span><span class="op" id="1775823">)</span><span class="op" id="1775824">)</span>&nbsp;<span class="op" id="1775826">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1775832">uintptr</span><span class="op" id="1775839">(</span><span class="ident" id="1775840">unsafe</span><span class="op" id="1775846">.</span><span class="ident" id="1775847">Pointer</span><span class="op" id="1775854">(</span><span class="op" id="1775855">&amp;</span><span class="ident" id="1775856">bss</span><span class="op" id="1775859">)</span><span class="op" id="1775860">)</span>&nbsp;<span class="op" id="1775862">&lt;=</span>&nbsp;<span class="builtintype" id="1775865">uintptr</span><span class="op" id="1775872">(</span><span class="ident" id="1775873">e</span><span class="op" id="1775874">.</span><span class="ident" id="1775875">data</span><span class="op" id="1775879">)</span>&nbsp;<span class="op" id="1775881">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1775884">uintptr</span><span class="op" id="1775891">(</span><span class="ident" id="1775892">e</span><span class="op" id="1775893">.</span><span class="ident" id="1775894">data</span><span class="op" id="1775898">)</span>&nbsp;<span class="op" id="1775900">&lt;</span>&nbsp;<span class="builtintype" id="1775902">uintptr</span><span class="op" id="1775909">(</span><span class="ident" id="1775910">unsafe</span><span class="op" id="1775916">.</span><span class="ident" id="1775917">Pointer</span><span class="op" id="1775924">(</span><span class="op" id="1775925">&amp;</span><span class="ident" id="1775926">ebss</span><span class="op" id="1775930">)</span><span class="op" id="1775931">)</span>&nbsp;<span class="op" id="1775933">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1775939">uintptr</span><span class="op" id="1775946">(</span><span class="ident" id="1775947">unsafe</span><span class="op" id="1775953">.</span><span class="ident" id="1775954">Pointer</span><span class="op" id="1775961">(</span><span class="op" id="1775962">&amp;</span><span class="ident" id="1775963">noptrbss</span><span class="op" id="1775971">)</span><span class="op" id="1775972">)</span>&nbsp;<span class="op" id="1775974">&lt;=</span>&nbsp;<span class="builtintype" id="1775977">uintptr</span><span class="op" id="1775984">(</span><span class="ident" id="1775985">e</span><span class="op" id="1775986">.</span><span class="ident" id="1775987">data</span><span class="op" id="1775991">)</span>&nbsp;<span class="op" id="1775993">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1775996">uintptr</span><span class="op" id="1776003">(</span><span class="ident" id="1776004">e</span><span class="op" id="1776005">.</span><span class="ident" id="1776006">data</span><span class="op" id="1776010">)</span>&nbsp;<span class="op" id="1776012">&lt;</span>&nbsp;<span class="builtintype" id="1776014">uintptr</span><span class="op" id="1776021">(</span><span class="ident" id="1776022">unsafe</span><span class="op" id="1776028">.</span><span class="ident" id="1776029">Pointer</span><span class="op" id="1776036">(</span><span class="op" id="1776037">&amp;</span><span class="ident" id="1776038">enoptrbss</span><span class="op" id="1776047">)</span><span class="op" id="1776048">)</span>&nbsp;<span class="op" id="1776050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1776055">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1776064">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776068">gothrow</span><span class="op" id="1776075">(</span><span class="string" id="1776076">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;in&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1776130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1776133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1776137">if</span>&nbsp;<span class="ident" id="1776140">e</span><span class="op" id="1776141">.</span><span class="ident" id="1776142">data</span>&nbsp;<span class="op" id="1776147">!=</span>&nbsp;<span class="ident" id="1776150">base</span>&nbsp;<span class="op" id="1776155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1776159">//&nbsp;As&nbsp;an&nbsp;implementation&nbsp;detail&nbsp;we&nbsp;allow&nbsp;to&nbsp;set&nbsp;finalizers&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1776237">//&nbsp;of&nbsp;an&nbsp;object&nbsp;if&nbsp;it&nbsp;could&nbsp;come&nbsp;from&nbsp;tiny&nbsp;alloc&nbsp;(see&nbsp;mallocgc&nbsp;for&nbsp;details).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1776316">if</span>&nbsp;<span class="ident" id="1776319">ot</span><span class="op" id="1776321">.</span><span class="ident" id="1776322">elem</span>&nbsp;<span class="op" id="1776327">==</span>&nbsp;<span class="ident" id="1776330">nil</span>&nbsp;<span class="op" id="1776334">||</span>&nbsp;<span class="ident" id="1776337">ot</span><span class="op" id="1776339">.</span><span class="ident" id="1776340">elem</span><span class="op" id="1776344">.</span><span class="ident" id="1776345">kind</span><span class="op" id="1776349">&amp;</span><span class="ident" id="1776350">kindNoPointers</span>&nbsp;<span class="op" id="1776365">==</span>&nbsp;<span class="num" id="1776368">0</span>&nbsp;<span class="op" id="1776370">||</span>&nbsp;<span class="ident" id="1776373">ot</span><span class="op" id="1776375">.</span><span class="ident" id="1776376">elem</span><span class="op" id="1776380">.</span><span class="ident" id="1776381">size</span>&nbsp;<span class="op" id="1776386">&gt;=</span>&nbsp;<span class="ident" id="1776389">maxTinySize</span>&nbsp;<span class="op" id="1776401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776406">gothrow</span><span class="op" id="1776413">(</span><span class="string" id="1776414">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;at&nbsp;beginning&nbsp;of&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1776481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1776485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1776488">}</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776492">f</span>&nbsp;<span class="op" id="1776494">:=</span>&nbsp;<span class="op" id="1776497">(</span><span class="op" id="1776498">*</span><span class="ident" id="1776499">eface</span><span class="op" id="1776504">)</span><span class="op" id="1776505">(</span><span class="ident" id="1776506">unsafe</span><span class="op" id="1776512">.</span><span class="ident" id="1776513">Pointer</span><span class="op" id="1776520">(</span><span class="op" id="1776521">&amp;</span><span class="ident" id="1776522">finalizer</span><span class="op" id="1776531">)</span><span class="op" id="1776532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776535">ftyp</span>&nbsp;<span class="op" id="1776540">:=</span>&nbsp;<span class="ident" id="1776543">f</span><span class="op" id="1776544">.</span><span class="ident" id="1776545">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1776552">if</span>&nbsp;<span class="ident" id="1776555">ftyp</span>&nbsp;<span class="op" id="1776560">==</span>&nbsp;<span class="ident" id="1776563">nil</span>&nbsp;<span class="op" id="1776567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1776571">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;and&nbsp;remove&nbsp;finalizer</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776615">mp</span>&nbsp;<span class="op" id="1776618">:=</span>&nbsp;<span class="ident" id="1776621">acquirem</span><span class="op" id="1776629">(</span><span class="op" id="1776630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776634">mp</span><span class="op" id="1776636">.</span><span class="ident" id="1776637">ptrarg</span><span class="op" id="1776643">[</span><span class="num" id="1776644">0</span><span class="op" id="1776645">]</span>&nbsp;<span class="op" id="1776647">=</span>&nbsp;<span class="ident" id="1776649">e</span><span class="op" id="1776650">.</span><span class="ident" id="1776651">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776658">onM</span><span class="op" id="1776661">(</span><span class="ident" id="1776662">removeFinalizer_m</span><span class="op" id="1776679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776683">releasem</span><span class="op" id="1776691">(</span><span class="ident" id="1776692">mp</span><span class="op" id="1776694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1776698">return</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1776706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1776710">if</span>&nbsp;<span class="ident" id="1776713">ftyp</span><span class="op" id="1776717">.</span><span class="ident" id="1776718">kind</span><span class="op" id="1776722">&amp;</span><span class="ident" id="1776723">kindMask</span>&nbsp;<span class="op" id="1776732">!=</span>&nbsp;<span class="ident" id="1776735">kindFunc</span>&nbsp;<span class="op" id="1776744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776748">gothrow</span><span class="op" id="1776755">(</span><span class="string" id="1776756">&#34;runtime.SetFinalizer:&nbsp;second&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1776800">+</span>&nbsp;<span class="op" id="1776802">*</span><span class="ident" id="1776803">ftyp</span><span class="op" id="1776807">.</span><span class="ident" id="1776808">_string</span>&nbsp;<span class="op" id="1776816">+</span>&nbsp;<span class="string" id="1776818">&#34;,&nbsp;not&nbsp;a&nbsp;function&#34;</span><span class="op" id="1776836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1776839">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776842">ft</span>&nbsp;<span class="op" id="1776845">:=</span>&nbsp;<span class="op" id="1776848">(</span><span class="op" id="1776849">*</span><span class="ident" id="1776850">functype</span><span class="op" id="1776858">)</span><span class="op" id="1776859">(</span><span class="ident" id="1776860">unsafe</span><span class="op" id="1776866">.</span><span class="ident" id="1776867">Pointer</span><span class="op" id="1776874">(</span><span class="ident" id="1776875">ftyp</span><span class="op" id="1776879">)</span><span class="op" id="1776880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776883">ins</span>&nbsp;<span class="op" id="1776887">:=</span>&nbsp;<span class="op" id="1776890">*</span><span class="op" id="1776891">(</span><span class="op" id="1776892">*</span><span class="op" id="1776893">[</span><span class="op" id="1776894">]</span><span class="op" id="1776895">*</span><span class="ident" id="1776896">_type</span><span class="op" id="1776901">)</span><span class="op" id="1776902">(</span><span class="ident" id="1776903">unsafe</span><span class="op" id="1776909">.</span><span class="ident" id="1776910">Pointer</span><span class="op" id="1776917">(</span><span class="op" id="1776918">&amp;</span><span class="ident" id="1776919">ft</span><span class="op" id="1776921">.</span><span class="ident" id="1776922">in</span><span class="op" id="1776924">)</span><span class="op" id="1776925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1776928">if</span>&nbsp;<span class="ident" id="1776931">ft</span><span class="op" id="1776933">.</span><span class="ident" id="1776934">dotdotdot</span>&nbsp;<span class="op" id="1776944">||</span>&nbsp;<span class="builtinfunc" id="1776947">len</span><span class="op" id="1776950">(</span><span class="ident" id="1776951">ins</span><span class="op" id="1776954">)</span>&nbsp;<span class="op" id="1776956">!=</span>&nbsp;<span class="num" id="1776959">1</span>&nbsp;<span class="op" id="1776961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1776965">gothrow</span><span class="op" id="1776972">(</span><span class="string" id="1776973">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1777010">+</span>&nbsp;<span class="op" id="1777012">*</span><span class="ident" id="1777013">etyp</span><span class="op" id="1777017">.</span><span class="ident" id="1777018">_string</span>&nbsp;<span class="op" id="1777026">+</span>&nbsp;<span class="string" id="1777028">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1777045">+</span>&nbsp;<span class="op" id="1777047">*</span><span class="ident" id="1777048">ftyp</span><span class="op" id="1777052">.</span><span class="ident" id="1777053">_string</span><span class="op" id="1777060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777063">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1777066">fint</span>&nbsp;<span class="op" id="1777071">:=</span>&nbsp;<span class="ident" id="1777074">ins</span><span class="op" id="1777077">[</span><span class="num" id="1777078">0</span><span class="op" id="1777079">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777082">switch</span>&nbsp;<span class="op" id="1777089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777092">case</span>&nbsp;<span class="ident" id="1777097">fint</span>&nbsp;<span class="op" id="1777102">==</span>&nbsp;<span class="ident" id="1777105">etyp</span><span class="op" id="1777109">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1777113">//&nbsp;ok&nbsp;-&nbsp;same&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777133">goto</span>&nbsp;<span class="ident" id="1777138">okarg</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777145">case</span>&nbsp;<span class="ident" id="1777150">fint</span><span class="op" id="1777154">.</span><span class="ident" id="1777155">kind</span><span class="op" id="1777159">&amp;</span><span class="ident" id="1777160">kindMask</span>&nbsp;<span class="op" id="1777169">==</span>&nbsp;<span class="ident" id="1777172">kindPtr</span><span class="op" id="1777179">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777183">if</span>&nbsp;<span class="op" id="1777186">(</span><span class="ident" id="1777187">fint</span><span class="op" id="1777191">.</span><span class="ident" id="1777192">x</span>&nbsp;<span class="op" id="1777194">==</span>&nbsp;<span class="ident" id="1777197">nil</span>&nbsp;<span class="op" id="1777201">||</span>&nbsp;<span class="ident" id="1777204">fint</span><span class="op" id="1777208">.</span><span class="ident" id="1777209">x</span><span class="op" id="1777210">.</span><span class="ident" id="1777211">name</span>&nbsp;<span class="op" id="1777216">==</span>&nbsp;<span class="ident" id="1777219">nil</span>&nbsp;<span class="op" id="1777223">||</span>&nbsp;<span class="ident" id="1777226">etyp</span><span class="op" id="1777230">.</span><span class="ident" id="1777231">x</span>&nbsp;<span class="op" id="1777233">==</span>&nbsp;<span class="ident" id="1777236">nil</span>&nbsp;<span class="op" id="1777240">||</span>&nbsp;<span class="ident" id="1777243">etyp</span><span class="op" id="1777247">.</span><span class="ident" id="1777248">x</span><span class="op" id="1777249">.</span><span class="ident" id="1777250">name</span>&nbsp;<span class="op" id="1777255">==</span>&nbsp;<span class="ident" id="1777258">nil</span><span class="op" id="1777261">)</span>&nbsp;<span class="op" id="1777263">&amp;&amp;</span>&nbsp;<span class="op" id="1777266">(</span><span class="op" id="1777267">*</span><span class="ident" id="1777268">ptrtype</span><span class="op" id="1777275">)</span><span class="op" id="1777276">(</span><span class="ident" id="1777277">unsafe</span><span class="op" id="1777283">.</span><span class="ident" id="1777284">Pointer</span><span class="op" id="1777291">(</span><span class="ident" id="1777292">fint</span><span class="op" id="1777296">)</span><span class="op" id="1777297">)</span><span class="op" id="1777298">.</span><span class="ident" id="1777299">elem</span>&nbsp;<span class="op" id="1777304">==</span>&nbsp;<span class="ident" id="1777307">ot</span><span class="op" id="1777309">.</span><span class="ident" id="1777310">elem</span>&nbsp;<span class="op" id="1777315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1777320">//&nbsp;ok&nbsp;-&nbsp;not&nbsp;same&nbsp;type,&nbsp;but&nbsp;both&nbsp;pointers,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1777365">//&nbsp;one&nbsp;or&nbsp;the&nbsp;other&nbsp;is&nbsp;unnamed,&nbsp;and&nbsp;same&nbsp;element&nbsp;type,&nbsp;so&nbsp;assignable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777438">goto</span>&nbsp;<span class="ident" id="1777443">okarg</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777454">case</span>&nbsp;<span class="ident" id="1777459">fint</span><span class="op" id="1777463">.</span><span class="ident" id="1777464">kind</span><span class="op" id="1777468">&amp;</span><span class="ident" id="1777469">kindMask</span>&nbsp;<span class="op" id="1777478">==</span>&nbsp;<span class="ident" id="1777481">kindInterface</span><span class="op" id="1777494">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1777498">ityp</span>&nbsp;<span class="op" id="1777503">:=</span>&nbsp;<span class="op" id="1777506">(</span><span class="op" id="1777507">*</span><span class="ident" id="1777508">interfacetype</span><span class="op" id="1777521">)</span><span class="op" id="1777522">(</span><span class="ident" id="1777523">unsafe</span><span class="op" id="1777529">.</span><span class="ident" id="1777530">Pointer</span><span class="op" id="1777537">(</span><span class="ident" id="1777538">fint</span><span class="op" id="1777542">)</span><span class="op" id="1777543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777547">if</span>&nbsp;<span class="builtinfunc" id="1777550">len</span><span class="op" id="1777553">(</span><span class="ident" id="1777554">ityp</span><span class="op" id="1777558">.</span><span class="ident" id="1777559">mhdr</span><span class="op" id="1777563">)</span>&nbsp;<span class="op" id="1777565">==</span>&nbsp;<span class="num" id="1777568">0</span>&nbsp;<span class="op" id="1777570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1777575">//&nbsp;ok&nbsp;-&nbsp;satisfies&nbsp;empty&nbsp;interface</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777612">goto</span>&nbsp;<span class="ident" id="1777617">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777629">if</span>&nbsp;<span class="ident" id="1777632">_</span><span class="op" id="1777633">,</span>&nbsp;<span class="ident" id="1777635">ok</span>&nbsp;<span class="op" id="1777638">:=</span>&nbsp;<span class="ident" id="1777641">assertE2I2</span><span class="op" id="1777651">(</span><span class="ident" id="1777652">ityp</span><span class="op" id="1777656">,</span>&nbsp;<span class="ident" id="1777658">obj</span><span class="op" id="1777661">)</span><span class="op" id="1777662">;</span>&nbsp;<span class="ident" id="1777664">ok</span>&nbsp;<span class="op" id="1777667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777672">goto</span>&nbsp;<span class="ident" id="1777677">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777685">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1777691">gothrow</span><span class="op" id="1777698">(</span><span class="string" id="1777699">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1777736">+</span>&nbsp;<span class="op" id="1777738">*</span><span class="ident" id="1777739">etyp</span><span class="op" id="1777743">.</span><span class="ident" id="1777744">_string</span>&nbsp;<span class="op" id="1777752">+</span>&nbsp;<span class="string" id="1777754">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1777771">+</span>&nbsp;<span class="op" id="1777773">*</span><span class="ident" id="1777774">ftyp</span><span class="op" id="1777778">.</span><span class="ident" id="1777779">_string</span><span class="op" id="1777786">)</span><br>
<span class="lineno"></span><span class="ident" id="1777788">okarg</span><span class="op" id="1777793">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1777796">//&nbsp;compute&nbsp;size&nbsp;needed&nbsp;for&nbsp;return&nbsp;parameters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1777842">nret</span>&nbsp;<span class="op" id="1777847">:=</span>&nbsp;<span class="builtintype" id="1777850">uintptr</span><span class="op" id="1777857">(</span><span class="num" id="1777858">0</span><span class="op" id="1777859">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1777862">for</span>&nbsp;<span class="ident" id="1777866">_</span><span class="op" id="1777867">,</span>&nbsp;<span class="ident" id="1777869">t</span>&nbsp;<span class="op" id="1777871">:=</span>&nbsp;<span class="keyword" id="1777874">range</span>&nbsp;<span class="op" id="1777880">*</span><span class="op" id="1777881">(</span><span class="op" id="1777882">*</span><span class="op" id="1777883">[</span><span class="op" id="1777884">]</span><span class="op" id="1777885">*</span><span class="ident" id="1777886">_type</span><span class="op" id="1777891">)</span><span class="op" id="1777892">(</span><span class="ident" id="1777893">unsafe</span><span class="op" id="1777899">.</span><span class="ident" id="1777900">Pointer</span><span class="op" id="1777907">(</span><span class="op" id="1777908">&amp;</span><span class="ident" id="1777909">ft</span><span class="op" id="1777911">.</span><span class="ident" id="1777912">out</span><span class="op" id="1777915">)</span><span class="op" id="1777916">)</span>&nbsp;<span class="op" id="1777918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1777922">nret</span>&nbsp;<span class="op" id="1777927">=</span>&nbsp;<span class="ident" id="1777929">round</span><span class="op" id="1777934">(</span><span class="ident" id="1777935">nret</span><span class="op" id="1777939">,</span>&nbsp;<span class="builtintype" id="1777941">uintptr</span><span class="op" id="1777948">(</span><span class="ident" id="1777949">t</span><span class="op" id="1777950">.</span><span class="ident" id="1777951">align</span><span class="op" id="1777956">)</span><span class="op" id="1777957">)</span>&nbsp;<span class="op" id="1777959">+</span>&nbsp;<span class="builtintype" id="1777961">uintptr</span><span class="op" id="1777968">(</span><span class="ident" id="1777969">t</span><span class="op" id="1777970">.</span><span class="ident" id="1777971">size</span><span class="op" id="1777975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1777978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1777981">nret</span>&nbsp;<span class="op" id="1777986">=</span>&nbsp;<span class="ident" id="1777988">round</span><span class="op" id="1777993">(</span><span class="ident" id="1777994">nret</span><span class="op" id="1777998">,</span>&nbsp;<span class="ident" id="1778000">ptrSize</span><span class="op" id="1778007">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1778011">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;have&nbsp;a&nbsp;finalizer&nbsp;goroutine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778055">createfing</span><span class="op" id="1778065">(</span><span class="op" id="1778066">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1778070">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;to&nbsp;add&nbsp;finalizer&nbsp;record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778116">mp</span>&nbsp;<span class="op" id="1778119">:=</span>&nbsp;<span class="ident" id="1778122">acquirem</span><span class="op" id="1778130">(</span><span class="op" id="1778131">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778134">mp</span><span class="op" id="1778136">.</span><span class="ident" id="1778137">ptrarg</span><span class="op" id="1778143">[</span><span class="num" id="1778144">0</span><span class="op" id="1778145">]</span>&nbsp;<span class="op" id="1778147">=</span>&nbsp;<span class="ident" id="1778149">f</span><span class="op" id="1778150">.</span><span class="ident" id="1778151">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778157">mp</span><span class="op" id="1778159">.</span><span class="ident" id="1778160">ptrarg</span><span class="op" id="1778166">[</span><span class="num" id="1778167">1</span><span class="op" id="1778168">]</span>&nbsp;<span class="op" id="1778170">=</span>&nbsp;<span class="ident" id="1778172">e</span><span class="op" id="1778173">.</span><span class="ident" id="1778174">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778180">mp</span><span class="op" id="1778182">.</span><span class="ident" id="1778183">scalararg</span><span class="op" id="1778192">[</span><span class="num" id="1778193">0</span><span class="op" id="1778194">]</span>&nbsp;<span class="op" id="1778196">=</span>&nbsp;<span class="ident" id="1778198">nret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778204">mp</span><span class="op" id="1778206">.</span><span class="ident" id="1778207">ptrarg</span><span class="op" id="1778213">[</span><span class="num" id="1778214">2</span><span class="op" id="1778215">]</span>&nbsp;<span class="op" id="1778217">=</span>&nbsp;<span class="ident" id="1778219">unsafe</span><span class="op" id="1778225">.</span><span class="ident" id="1778226">Pointer</span><span class="op" id="1778233">(</span><span class="ident" id="1778234">fint</span><span class="op" id="1778238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778241">mp</span><span class="op" id="1778243">.</span><span class="ident" id="1778244">ptrarg</span><span class="op" id="1778250">[</span><span class="num" id="1778251">3</span><span class="op" id="1778252">]</span>&nbsp;<span class="op" id="1778254">=</span>&nbsp;<span class="ident" id="1778256">unsafe</span><span class="op" id="1778262">.</span><span class="ident" id="1778263">Pointer</span><span class="op" id="1778270">(</span><span class="ident" id="1778271">ot</span><span class="op" id="1778273">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778276">onM</span><span class="op" id="1778279">(</span><span class="ident" id="1778280">setFinalizer_m</span><span class="op" id="1778294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1778297">if</span>&nbsp;<span class="ident" id="1778300">mp</span><span class="op" id="1778302">.</span><span class="ident" id="1778303">scalararg</span><span class="op" id="1778312">[</span><span class="num" id="1778313">0</span><span class="op" id="1778314">]</span>&nbsp;<span class="op" id="1778316">!=</span>&nbsp;<span class="num" id="1778319">1</span>&nbsp;<span class="op" id="1778321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778325">gothrow</span><span class="op" id="1778332">(</span><span class="string" id="1778333">&#34;runtime.SetFinalizer:&nbsp;finalizer&nbsp;already&nbsp;set&#34;</span><span class="op" id="1778378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1778381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778384">releasem</span><span class="op" id="1778392">(</span><span class="ident" id="1778393">mp</span><span class="op" id="1778395">)</span><br>
<span class="lineno">655</span><span class="op" id="1778397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1778400">//&nbsp;round&nbsp;n&nbsp;up&nbsp;to&nbsp;a&nbsp;multiple&nbsp;of&nbsp;a.&nbsp;&nbsp;a&nbsp;must&nbsp;be&nbsp;a&nbsp;power&nbsp;of&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="1778459">func</span>&nbsp;<span class="ident" id="1778464">round</span><span class="op" id="1778469">(</span><span class="ident" id="1778470">n</span><span class="op" id="1778471">,</span>&nbsp;<span class="ident" id="1778473">a</span>&nbsp;<span class="builtintype" id="1778475">uintptr</span><span class="op" id="1778482">)</span>&nbsp;<span class="builtintype" id="1778484">uintptr</span>&nbsp;<span class="op" id="1778492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1778495">return</span>&nbsp;<span class="op" id="1778502">(</span><span class="ident" id="1778503">n</span>&nbsp;<span class="op" id="1778505">+</span>&nbsp;<span class="ident" id="1778507">a</span>&nbsp;<span class="op" id="1778509">-</span>&nbsp;<span class="num" id="1778511">1</span><span class="op" id="1778512">)</span>&nbsp;<span class="op" id="1778514">&amp;^</span>&nbsp;<span class="op" id="1778517">(</span><span class="ident" id="1778518">a</span>&nbsp;<span class="op" id="1778520">-</span>&nbsp;<span class="num" id="1778522">1</span><span class="op" id="1778523">)</span><br>
<span class="lineno">660</span><span class="op" id="1778525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1778528">//&nbsp;Look&nbsp;up&nbsp;pointer&nbsp;v&nbsp;in&nbsp;heap.&nbsp;&nbsp;Return&nbsp;the&nbsp;span&nbsp;containing&nbsp;the&nbsp;object,</span><br>
<span class="lineno"></span><span class="comment" id="1778598">//&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;object,&nbsp;and&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;If&nbsp;the&nbsp;object</span><br>
<span class="lineno"></span><span class="comment" id="1778669">//&nbsp;does&nbsp;not&nbsp;exist,&nbsp;return&nbsp;nil,&nbsp;nil,&nbsp;0.</span><br>
<span class="lineno">665</span><span class="keyword" id="1778708">func</span>&nbsp;<span class="ident" id="1778713">findObject</span><span class="op" id="1778723">(</span><span class="ident" id="1778724">v</span>&nbsp;<span class="ident" id="1778726">unsafe</span><span class="op" id="1778732">.</span><span class="ident" id="1778733">Pointer</span><span class="op" id="1778740">)</span>&nbsp;<span class="op" id="1778742">(</span><span class="ident" id="1778743">s</span>&nbsp;<span class="op" id="1778745">*</span><span class="ident" id="1778746">mspan</span><span class="op" id="1778751">,</span>&nbsp;<span class="ident" id="1778753">x</span>&nbsp;<span class="ident" id="1778755">unsafe</span><span class="op" id="1778761">.</span><span class="ident" id="1778762">Pointer</span><span class="op" id="1778769">,</span>&nbsp;<span class="ident" id="1778771">n</span>&nbsp;<span class="builtintype" id="1778773">uintptr</span><span class="op" id="1778780">)</span>&nbsp;<span class="op" id="1778782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778785">c</span>&nbsp;<span class="op" id="1778787">:=</span>&nbsp;<span class="ident" id="1778790">gomcache</span><span class="op" id="1778798">(</span><span class="op" id="1778799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778802">c</span><span class="op" id="1778803">.</span><span class="ident" id="1778804">local_nlookup</span><span class="op" id="1778817">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1778821">if</span>&nbsp;<span class="ident" id="1778824">ptrSize</span>&nbsp;<span class="op" id="1778832">==</span>&nbsp;<span class="num" id="1778835">4</span>&nbsp;<span class="op" id="1778837">&amp;&amp;</span>&nbsp;<span class="ident" id="1778840">c</span><span class="op" id="1778841">.</span><span class="ident" id="1778842">local_nlookup</span>&nbsp;<span class="op" id="1778856">&gt;=</span>&nbsp;<span class="num" id="1778859">1</span><span class="op" id="1778860">&lt;&lt;</span><span class="num" id="1778862">30</span>&nbsp;<span class="op" id="1778865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1778869">//&nbsp;purge&nbsp;cache&nbsp;stats&nbsp;to&nbsp;prevent&nbsp;overflow</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778912">lock</span><span class="op" id="1778916">(</span><span class="op" id="1778917">&amp;</span><span class="ident" id="1778918">mheap_</span><span class="op" id="1778924">.</span><span class="ident" id="1778925">lock</span><span class="op" id="1778929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778933">purgecachedstats</span><span class="op" id="1778949">(</span><span class="ident" id="1778950">c</span><span class="op" id="1778951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778955">unlock</span><span class="op" id="1778961">(</span><span class="op" id="1778962">&amp;</span><span class="ident" id="1778963">mheap_</span><span class="op" id="1778969">.</span><span class="ident" id="1778970">lock</span><span class="op" id="1778974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1778977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1778981">//&nbsp;find&nbsp;span</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1778995">arena_start</span>&nbsp;<span class="op" id="1779007">:=</span>&nbsp;<span class="builtintype" id="1779010">uintptr</span><span class="op" id="1779017">(</span><span class="ident" id="1779018">unsafe</span><span class="op" id="1779024">.</span><span class="ident" id="1779025">Pointer</span><span class="op" id="1779032">(</span><span class="ident" id="1779033">mheap_</span><span class="op" id="1779039">.</span><span class="ident" id="1779040">arena_start</span><span class="op" id="1779051">)</span><span class="op" id="1779052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779055">arena_used</span>&nbsp;<span class="op" id="1779066">:=</span>&nbsp;<span class="builtintype" id="1779069">uintptr</span><span class="op" id="1779076">(</span><span class="ident" id="1779077">unsafe</span><span class="op" id="1779083">.</span><span class="ident" id="1779084">Pointer</span><span class="op" id="1779091">(</span><span class="ident" id="1779092">mheap_</span><span class="op" id="1779098">.</span><span class="ident" id="1779099">arena_used</span><span class="op" id="1779109">)</span><span class="op" id="1779110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1779113">if</span>&nbsp;<span class="builtintype" id="1779116">uintptr</span><span class="op" id="1779123">(</span><span class="ident" id="1779124">v</span><span class="op" id="1779125">)</span>&nbsp;<span class="op" id="1779127">&lt;</span>&nbsp;<span class="ident" id="1779129">arena_start</span>&nbsp;<span class="op" id="1779141">||</span>&nbsp;<span class="builtintype" id="1779144">uintptr</span><span class="op" id="1779151">(</span><span class="ident" id="1779152">v</span><span class="op" id="1779153">)</span>&nbsp;<span class="op" id="1779155">&gt;=</span>&nbsp;<span class="ident" id="1779158">arena_used</span>&nbsp;<span class="op" id="1779169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1779173">return</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1779181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779184">p</span>&nbsp;<span class="op" id="1779186">:=</span>&nbsp;<span class="builtintype" id="1779189">uintptr</span><span class="op" id="1779196">(</span><span class="ident" id="1779197">v</span><span class="op" id="1779198">)</span>&nbsp;<span class="op" id="1779200">&gt;&gt;</span>&nbsp;<span class="ident" id="1779203">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779214">q</span>&nbsp;<span class="op" id="1779216">:=</span>&nbsp;<span class="ident" id="1779219">p</span>&nbsp;<span class="op" id="1779221">-</span>&nbsp;<span class="ident" id="1779223">arena_start</span><span class="op" id="1779234">&gt;&gt;</span><span class="ident" id="1779236">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779247">s</span>&nbsp;<span class="op" id="1779249">=</span>&nbsp;<span class="op" id="1779251">*</span><span class="op" id="1779252">(</span><span class="op" id="1779253">*</span><span class="op" id="1779254">*</span><span class="ident" id="1779255">mspan</span><span class="op" id="1779260">)</span><span class="op" id="1779261">(</span><span class="ident" id="1779262">add</span><span class="op" id="1779265">(</span><span class="ident" id="1779266">unsafe</span><span class="op" id="1779272">.</span><span class="ident" id="1779273">Pointer</span><span class="op" id="1779280">(</span><span class="ident" id="1779281">mheap_</span><span class="op" id="1779287">.</span><span class="ident" id="1779288">spans</span><span class="op" id="1779293">)</span><span class="op" id="1779294">,</span>&nbsp;<span class="ident" id="1779296">q</span><span class="op" id="1779297">*</span><span class="ident" id="1779298">ptrSize</span><span class="op" id="1779305">)</span><span class="op" id="1779306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1779309">if</span>&nbsp;<span class="ident" id="1779312">s</span>&nbsp;<span class="op" id="1779314">==</span>&nbsp;<span class="ident" id="1779317">nil</span>&nbsp;<span class="op" id="1779321">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1779325">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1779333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779336">x</span>&nbsp;<span class="op" id="1779338">=</span>&nbsp;<span class="ident" id="1779340">unsafe</span><span class="op" id="1779346">.</span><span class="ident" id="1779347">Pointer</span><span class="op" id="1779354">(</span><span class="builtintype" id="1779355">uintptr</span><span class="op" id="1779362">(</span><span class="ident" id="1779363">s</span><span class="op" id="1779364">.</span><span class="ident" id="1779365">start</span><span class="op" id="1779370">)</span>&nbsp;<span class="op" id="1779372">&lt;&lt;</span>&nbsp;<span class="ident" id="1779375">pageShift</span><span class="op" id="1779384">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1779388">if</span>&nbsp;<span class="builtintype" id="1779391">uintptr</span><span class="op" id="1779398">(</span><span class="ident" id="1779399">v</span><span class="op" id="1779400">)</span>&nbsp;<span class="op" id="1779402">&lt;</span>&nbsp;<span class="builtintype" id="1779404">uintptr</span><span class="op" id="1779411">(</span><span class="ident" id="1779412">x</span><span class="op" id="1779413">)</span>&nbsp;<span class="op" id="1779415">||</span>&nbsp;<span class="builtintype" id="1779418">uintptr</span><span class="op" id="1779425">(</span><span class="ident" id="1779426">v</span><span class="op" id="1779427">)</span>&nbsp;<span class="op" id="1779429">&gt;=</span>&nbsp;<span class="builtintype" id="1779432">uintptr</span><span class="op" id="1779439">(</span><span class="ident" id="1779440">unsafe</span><span class="op" id="1779446">.</span><span class="ident" id="1779447">Pointer</span><span class="op" id="1779454">(</span><span class="ident" id="1779455">s</span><span class="op" id="1779456">.</span><span class="ident" id="1779457">limit</span><span class="op" id="1779462">)</span><span class="op" id="1779463">)</span>&nbsp;<span class="op" id="1779465">||</span>&nbsp;<span class="ident" id="1779468">s</span><span class="op" id="1779469">.</span><span class="ident" id="1779470">state</span>&nbsp;<span class="op" id="1779476">!=</span>&nbsp;<span class="ident" id="1779479">mSpanInUse</span>&nbsp;<span class="op" id="1779490">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779494">s</span>&nbsp;<span class="op" id="1779496">=</span>&nbsp;<span class="ident" id="1779498">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779504">x</span>&nbsp;<span class="op" id="1779506">=</span>&nbsp;<span class="ident" id="1779508">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1779514">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1779522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779526">n</span>&nbsp;<span class="op" id="1779528">=</span>&nbsp;<span class="builtintype" id="1779530">uintptr</span><span class="op" id="1779537">(</span><span class="ident" id="1779538">s</span><span class="op" id="1779539">.</span><span class="ident" id="1779540">elemsize</span><span class="op" id="1779548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1779551">if</span>&nbsp;<span class="ident" id="1779554">s</span><span class="op" id="1779555">.</span><span class="ident" id="1779556">sizeclass</span>&nbsp;<span class="op" id="1779566">!=</span>&nbsp;<span class="num" id="1779569">0</span>&nbsp;<span class="op" id="1779571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779575">x</span>&nbsp;<span class="op" id="1779577">=</span>&nbsp;<span class="ident" id="1779579">add</span><span class="op" id="1779582">(</span><span class="ident" id="1779583">x</span><span class="op" id="1779584">,</span>&nbsp;<span class="op" id="1779586">(</span><span class="builtintype" id="1779587">uintptr</span><span class="op" id="1779594">(</span><span class="ident" id="1779595">v</span><span class="op" id="1779596">)</span><span class="op" id="1779597">-</span><span class="builtintype" id="1779598">uintptr</span><span class="op" id="1779605">(</span><span class="ident" id="1779606">x</span><span class="op" id="1779607">)</span><span class="op" id="1779608">)</span><span class="op" id="1779609">/</span><span class="ident" id="1779610">n</span><span class="op" id="1779611">*</span><span class="ident" id="1779612">n</span><span class="op" id="1779613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1779616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1779619">return</span><br>
<span class="lineno">700</span><span class="op" id="1779626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1779629">var</span>&nbsp;<span class="ident" id="1779633">fingCreate</span>&nbsp;<span class="builtintype" id="1779644">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1779652">func</span>&nbsp;<span class="ident" id="1779657">createfing</span><span class="op" id="1779667">(</span><span class="op" id="1779668">)</span>&nbsp;<span class="op" id="1779670">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1779673">//&nbsp;start&nbsp;the&nbsp;finalizer&nbsp;goroutine&nbsp;exactly&nbsp;once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1779720">if</span>&nbsp;<span class="ident" id="1779723">fingCreate</span>&nbsp;<span class="op" id="1779734">==</span>&nbsp;<span class="num" id="1779737">0</span>&nbsp;<span class="op" id="1779739">&amp;&amp;</span>&nbsp;<span class="ident" id="1779742">cas</span><span class="op" id="1779745">(</span><span class="op" id="1779746">&amp;</span><span class="ident" id="1779747">fingCreate</span><span class="op" id="1779757">,</span>&nbsp;<span class="num" id="1779759">0</span><span class="op" id="1779760">,</span>&nbsp;<span class="num" id="1779762">1</span><span class="op" id="1779763">)</span>&nbsp;<span class="op" id="1779765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1779769">go</span>&nbsp;<span class="ident" id="1779772">runfinq</span><span class="op" id="1779779">(</span><span class="op" id="1779780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1779783">}</span><br>
<span class="lineno"></span><span class="op" id="1779785">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="1779788">//&nbsp;This&nbsp;is&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;runs&nbsp;all&nbsp;of&nbsp;the&nbsp;finalizers</span><br>
<span class="lineno"></span><span class="keyword" id="1779845">func</span>&nbsp;<span class="ident" id="1779850">runfinq</span><span class="op" id="1779857">(</span><span class="op" id="1779858">)</span>&nbsp;<span class="op" id="1779860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1779863">var</span>&nbsp;<span class="op" id="1779867">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779871">frame</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1779880">unsafe</span><span class="op" id="1779886">.</span><span class="ident" id="1779887">Pointer</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779897">framecap</span>&nbsp;<span class="builtintype" id="1779906">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1779915">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1779919">for</span>&nbsp;<span class="op" id="1779923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779927">lock</span><span class="op" id="1779931">(</span><span class="op" id="1779932">&amp;</span><span class="ident" id="1779933">finlock</span><span class="op" id="1779940">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779944">fb</span>&nbsp;<span class="op" id="1779947">:=</span>&nbsp;<span class="ident" id="1779950">finq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779957">finq</span>&nbsp;<span class="op" id="1779962">=</span>&nbsp;<span class="ident" id="1779964">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1779970">if</span>&nbsp;<span class="ident" id="1779973">fb</span>&nbsp;<span class="op" id="1779976">==</span>&nbsp;<span class="ident" id="1779979">nil</span>&nbsp;<span class="op" id="1779983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1779988">gp</span>&nbsp;<span class="op" id="1779991">:=</span>&nbsp;<span class="ident" id="1779994">getg</span><span class="op" id="1779998">(</span><span class="op" id="1779999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1780004">fing</span>&nbsp;<span class="op" id="1780009">=</span>&nbsp;<span class="ident" id="1780011">gp</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1780017">fingwait</span>&nbsp;<span class="op" id="1780026">=</span>&nbsp;<span class="builtintype" id="1780028">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1780036">gp</span><span class="op" id="1780038">.</span><span class="ident" id="1780039">issystem</span>&nbsp;<span class="op" id="1780048">=</span>&nbsp;<span class="builtintype" id="1780050">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1780058">goparkunlock</span><span class="op" id="1780070">(</span><span class="op" id="1780071">&amp;</span><span class="ident" id="1780072">finlock</span><span class="op" id="1780079">,</span>&nbsp;<span class="string" id="1780081">&#34;finalizer&nbsp;wait&#34;</span><span class="op" id="1780097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1780102">gp</span><span class="op" id="1780104">.</span><span class="ident" id="1780105">issystem</span>&nbsp;<span class="op" id="1780114">=</span>&nbsp;<span class="builtintype" id="1780116">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1780125">continue</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1780136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1780140">unlock</span><span class="op" id="1780146">(</span><span class="op" id="1780147">&amp;</span><span class="ident" id="1780148">finlock</span><span class="op" id="1780155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1780159">if</span>&nbsp;<span class="ident" id="1780162">raceenabled</span>&nbsp;<span class="op" id="1780174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1780179">racefingo</span><span class="op" id="1780188">(</span><span class="op" id="1780189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1780193">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1780197">for</span>&nbsp;<span class="ident" id="1780201">fb</span>&nbsp;<span class="op" id="1780204">!=</span>&nbsp;<span class="ident" id="1780207">nil</span>&nbsp;<span class="op" id="1780211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1780216">for</span>&nbsp;<span class="ident" id="1780220">i</span>&nbsp;<span class="op" id="1780222">:=</span>&nbsp;<span class="builtintype" id="1780225">int32</span><span class="op" id="1780230">(</span><span class="num" id="1780231">0</span><span class="op" id="1780232">)</span><span class="op" id="1780233">;</span>&nbsp;<span class="ident" id="1780235">i</span>&nbsp;<span class="op" id="1780237">&lt;</span>&nbsp;<span class="ident" id="1780239">fb</span><span class="op" id="1780241">.</span><span class="ident" id="1780242">cnt</span><span class="op" id="1780245">;</span>&nbsp;<span class="ident" id="1780247">i</span><span class="op" id="1780248">++</span>&nbsp;<span class="op" id="1780251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1780257">f</span>&nbsp;<span class="op" id="1780259">:=</span>&nbsp;<span class="op" id="1780262">(</span><span class="op" id="1780263">*</span><span class="ident" id="1780264">finalizer</span><span class="op" id="1780273">)</span><span class="op" id="1780274">(</span><span class="ident" id="1780275">add</span><span class="op" id="1780278">(</span><span class="ident" id="1780279">unsafe</span><span class="op" id="1780285">.</span><span class="ident" id="1780286">Pointer</span><span class="op" id="1780293">(</span><span class="op" id="1780294">&amp;</span><span class="ident" id="1780295">fb</span><span class="op" id="1780297">.</span><span class="ident" id="1780298">fin</span><span class="op" id="1780301">)</span><span class="op" id="1780302">,</span>&nbsp;<span class="builtintype" id="1780304">uintptr</span><span class="op" id="1780311">(</span><span class="ident" id="1780312">i</span><span class="op" id="1780313">)</span><span class="op" id="1780314">*</span><span class="ident" id="1780315">unsafe</span><span class="op" id="1780321">.</span><span class="ident" id="1780322">Sizeof</span><span class="op" id="1780328">(</span><span class="ident" id="1780329">finalizer</span><span class="op" id="1780338">{</span><span class="op" id="1780339">}</span><span class="op" id="1780340">)</span><span class="op" id="1780341">)</span><span class="op" id="1780342">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1780349">framesz</span>&nbsp;<span class="op" id="1780357">:=</span>&nbsp;<span class="ident" id="1780360">unsafe</span><span class="op" id="1780366">.</span><span class="ident" id="1780367">Sizeof</span><span class="op" id="1780373">(</span><span class="op" id="1780374">(</span><span class="keyword" id="1780375">interface</span><span class="op" id="1780384">{</span><span class="op" id="1780385">}</span><span class="op" id="1780386">)</span><span class="op" id="1780387">(</span><span class="ident" id="1780388">nil</span><span class="op" id="1780391">)</span><span class="op" id="1780392">)</span>&nbsp;<span class="op" id="1780394">+</span>&nbsp;<span class="builtintype" id="1780396">uintptr</span><span class="op" id="1780403">(</span><span class="ident" id="1780404">f</span><span class="op" id="1780405">.</span><span class="ident" id="1780406">nret</span><span class="op" id="1780410">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1780416">if</span>&nbsp;<span class="ident" id="1780419">framecap</span>&nbsp;<span class="op" id="1780428">&lt;</span>&nbsp;<span class="ident" id="1780430">framesz</span>&nbsp;<span class="op" id="1780438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1780445">//&nbsp;The&nbsp;frame&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1780509">//&nbsp;all&nbsp;not&nbsp;yet&nbsp;finalized&nbsp;objects&nbsp;are&nbsp;stored&nbsp;in&nbsp;finq.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1780567">//&nbsp;If&nbsp;we&nbsp;do&nbsp;not&nbsp;mark&nbsp;it&nbsp;as&nbsp;FlagNoScan,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1780611">//&nbsp;the&nbsp;last&nbsp;finalized&nbsp;object&nbsp;is&nbsp;not&nbsp;collected.</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1780663">frame</span>&nbsp;<span class="op" id="1780669">=</span>&nbsp;<span class="ident" id="1780671">mallocgc</span><span class="op" id="1780679">(</span><span class="ident" id="1780680">framesz</span><span class="op" id="1780687">,</span>&nbsp;<span class="ident" id="1780689">nil</span><span class="op" id="1780692">,</span>&nbsp;<span class="ident" id="1780694">flagNoScan</span><span class="op" id="1780704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1780711">framecap</span>&nbsp;<span class="op" id="1780720">=</span>&nbsp;<span class="ident" id="1780722">framesz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1780734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1780741">if</span>&nbsp;<span class="ident" id="1780744">f</span><span class="op" id="1780745">.</span><span class="ident" id="1780746">fint</span>&nbsp;<span class="op" id="1780751">==</span>&nbsp;<span class="ident" id="1780754">nil</span>&nbsp;<span class="op" id="1780758">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1780765">gothrow</span><span class="op" id="1780772">(</span><span class="string" id="1780773">&#34;missing&nbsp;type&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1780798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1780804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1780810">switch</span>&nbsp;<span class="ident" id="1780817">f</span><span class="op" id="1780818">.</span><span class="ident" id="1780819">fint</span><span class="op" id="1780823">.</span><span class="ident" id="1780824">kind</span>&nbsp;<span class="op" id="1780829">&amp;</span>&nbsp;<span class="ident" id="1780831">kindMask</span>&nbsp;<span class="op" id="1780840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1780846">case</span>&nbsp;<span class="ident" id="1780851">kindPtr</span><span class="op" id="1780858">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1780865">//&nbsp;direct&nbsp;use&nbsp;of&nbsp;pointer</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1780895">*</span><span class="op" id="1780896">(</span><span class="op" id="1780897">*</span><span class="ident" id="1780898">unsafe</span><span class="op" id="1780904">.</span><span class="ident" id="1780905">Pointer</span><span class="op" id="1780912">)</span><span class="op" id="1780913">(</span><span class="ident" id="1780914">frame</span><span class="op" id="1780919">)</span>&nbsp;<span class="op" id="1780921">=</span>&nbsp;<span class="ident" id="1780923">f</span><span class="op" id="1780924">.</span><span class="ident" id="1780925">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1780933">case</span>&nbsp;<span class="ident" id="1780938">kindInterface</span><span class="op" id="1780951">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1780958">ityp</span>&nbsp;<span class="op" id="1780963">:=</span>&nbsp;<span class="op" id="1780966">(</span><span class="op" id="1780967">*</span><span class="ident" id="1780968">interfacetype</span><span class="op" id="1780981">)</span><span class="op" id="1780982">(</span><span class="ident" id="1780983">unsafe</span><span class="op" id="1780989">.</span><span class="ident" id="1780990">Pointer</span><span class="op" id="1780997">(</span><span class="ident" id="1780998">f</span><span class="op" id="1780999">.</span><span class="ident" id="1781000">fint</span><span class="op" id="1781004">)</span><span class="op" id="1781005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1781012">//&nbsp;set&nbsp;up&nbsp;with&nbsp;empty&nbsp;interface</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1781048">(</span><span class="op" id="1781049">*</span><span class="ident" id="1781050">eface</span><span class="op" id="1781055">)</span><span class="op" id="1781056">(</span><span class="ident" id="1781057">frame</span><span class="op" id="1781062">)</span><span class="op" id="1781063">.</span><span class="ident" id="1781064">_type</span>&nbsp;<span class="op" id="1781070">=</span>&nbsp;<span class="op" id="1781072">&amp;</span><span class="ident" id="1781073">f</span><span class="op" id="1781074">.</span><span class="ident" id="1781075">ot</span><span class="op" id="1781077">.</span><span class="ident" id="1781078">typ</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1781087">(</span><span class="op" id="1781088">*</span><span class="ident" id="1781089">eface</span><span class="op" id="1781094">)</span><span class="op" id="1781095">(</span><span class="ident" id="1781096">frame</span><span class="op" id="1781101">)</span><span class="op" id="1781102">.</span><span class="ident" id="1781103">data</span>&nbsp;<span class="op" id="1781108">=</span>&nbsp;<span class="ident" id="1781110">f</span><span class="op" id="1781111">.</span><span class="ident" id="1781112">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1781121">if</span>&nbsp;<span class="builtinfunc" id="1781124">len</span><span class="op" id="1781127">(</span><span class="ident" id="1781128">ityp</span><span class="op" id="1781132">.</span><span class="ident" id="1781133">mhdr</span><span class="op" id="1781137">)</span>&nbsp;<span class="op" id="1781139">!=</span>&nbsp;<span class="num" id="1781142">0</span>&nbsp;<span class="op" id="1781144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1781152">//&nbsp;convert&nbsp;to&nbsp;interface&nbsp;with&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1781195">//&nbsp;this&nbsp;conversion&nbsp;is&nbsp;guaranteed&nbsp;to&nbsp;succeed&nbsp;-&nbsp;we&nbsp;checked&nbsp;in&nbsp;SetFinalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1781274">*</span><span class="op" id="1781275">(</span><span class="op" id="1781276">*</span><span class="ident" id="1781277">fInterface</span><span class="op" id="1781287">)</span><span class="op" id="1781288">(</span><span class="ident" id="1781289">frame</span><span class="op" id="1781294">)</span>&nbsp;<span class="op" id="1781296">=</span>&nbsp;<span class="ident" id="1781298">assertE2I</span><span class="op" id="1781307">(</span><span class="ident" id="1781308">ityp</span><span class="op" id="1781312">,</span>&nbsp;<span class="op" id="1781314">*</span><span class="op" id="1781315">(</span><span class="op" id="1781316">*</span><span class="keyword" id="1781317">interface</span><span class="op" id="1781326">{</span><span class="op" id="1781327">}</span><span class="op" id="1781328">)</span><span class="op" id="1781329">(</span><span class="ident" id="1781330">frame</span><span class="op" id="1781335">)</span><span class="op" id="1781336">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1781343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1781349">default</span><span class="op" id="1781356">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781363">gothrow</span><span class="op" id="1781370">(</span><span class="string" id="1781371">&#34;bad&nbsp;kind&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1781392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1781398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781404">reflectcall</span><span class="op" id="1781415">(</span><span class="ident" id="1781416">unsafe</span><span class="op" id="1781422">.</span><span class="ident" id="1781423">Pointer</span><span class="op" id="1781430">(</span><span class="ident" id="1781431">f</span><span class="op" id="1781432">.</span><span class="ident" id="1781433">fn</span><span class="op" id="1781435">)</span><span class="op" id="1781436">,</span>&nbsp;<span class="ident" id="1781438">frame</span><span class="op" id="1781443">,</span>&nbsp;<span class="builtintype" id="1781445">uint32</span><span class="op" id="1781451">(</span><span class="ident" id="1781452">framesz</span><span class="op" id="1781459">)</span><span class="op" id="1781460">,</span>&nbsp;<span class="builtintype" id="1781462">uint32</span><span class="op" id="1781468">(</span><span class="ident" id="1781469">framesz</span><span class="op" id="1781476">)</span><span class="op" id="1781477">)</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1781484">//&nbsp;drop&nbsp;finalizer&nbsp;queue&nbsp;references&nbsp;to&nbsp;finalized&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781543">f</span><span class="op" id="1781544">.</span><span class="ident" id="1781545">fn</span>&nbsp;<span class="op" id="1781548">=</span>&nbsp;<span class="ident" id="1781550">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781558">f</span><span class="op" id="1781559">.</span><span class="ident" id="1781560">arg</span>&nbsp;<span class="op" id="1781564">=</span>&nbsp;<span class="ident" id="1781566">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781574">f</span><span class="op" id="1781575">.</span><span class="ident" id="1781576">ot</span>&nbsp;<span class="op" id="1781579">=</span>&nbsp;<span class="ident" id="1781581">nil</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1781588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781593">fb</span><span class="op" id="1781595">.</span><span class="ident" id="1781596">cnt</span>&nbsp;<span class="op" id="1781600">=</span>&nbsp;<span class="num" id="1781602">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781607">next</span>&nbsp;<span class="op" id="1781612">:=</span>&nbsp;<span class="ident" id="1781615">fb</span><span class="op" id="1781617">.</span><span class="ident" id="1781618">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781626">lock</span><span class="op" id="1781630">(</span><span class="op" id="1781631">&amp;</span><span class="ident" id="1781632">finlock</span><span class="op" id="1781639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781644">fb</span><span class="op" id="1781646">.</span><span class="ident" id="1781647">next</span>&nbsp;<span class="op" id="1781652">=</span>&nbsp;<span class="ident" id="1781654">finc</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781662">finc</span>&nbsp;<span class="op" id="1781667">=</span>&nbsp;<span class="ident" id="1781669">fb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781675">unlock</span><span class="op" id="1781681">(</span><span class="op" id="1781682">&amp;</span><span class="ident" id="1781683">finlock</span><span class="op" id="1781690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781695">fb</span>&nbsp;<span class="op" id="1781698">=</span>&nbsp;<span class="ident" id="1781700">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1781707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1781710">}</span><br>
<span class="lineno">785</span><span class="op" id="1781712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1781715">var</span>&nbsp;<span class="ident" id="1781719">persistent</span>&nbsp;<span class="keyword" id="1781730">struct</span>&nbsp;<span class="op" id="1781737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781740">lock</span>&nbsp;<span class="ident" id="1781745">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781752">pos</span>&nbsp;&nbsp;<span class="ident" id="1781757">unsafe</span><span class="op" id="1781763">.</span><span class="ident" id="1781764">Pointer</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1781773">end</span>&nbsp;&nbsp;<span class="ident" id="1781778">unsafe</span><span class="op" id="1781784">.</span><span class="ident" id="1781785">Pointer</span><br>
<span class="lineno"></span><span class="op" id="1781793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1781796">//&nbsp;Wrapper&nbsp;around&nbsp;sysAlloc&nbsp;that&nbsp;can&nbsp;allocate&nbsp;small&nbsp;chunks.</span><br>
<span class="lineno"></span><span class="comment" id="1781855">//&nbsp;There&nbsp;is&nbsp;no&nbsp;associated&nbsp;free&nbsp;operation.</span><br>
<span class="lineno">795</span><span class="comment" id="1781897">//&nbsp;Intended&nbsp;for&nbsp;things&nbsp;like&nbsp;function/type/debug-related&nbsp;persistent&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1781970">//&nbsp;If&nbsp;align&nbsp;is&nbsp;0,&nbsp;uses&nbsp;default&nbsp;align&nbsp;(currently&nbsp;8).</span><br>
<span class="lineno"></span><span class="keyword" id="1782022">func</span>&nbsp;<span class="ident" id="1782027">persistentalloc</span><span class="op" id="1782042">(</span><span class="ident" id="1782043">size</span><span class="op" id="1782047">,</span>&nbsp;<span class="ident" id="1782049">align</span>&nbsp;<span class="builtintype" id="1782055">uintptr</span><span class="op" id="1782062">,</span>&nbsp;<span class="ident" id="1782064">stat</span>&nbsp;<span class="op" id="1782069">*</span><span class="ident" id="1782070">uint64</span><span class="op" id="1782076">)</span>&nbsp;<span class="ident" id="1782078">unsafe</span><span class="op" id="1782084">.</span><span class="ident" id="1782085">Pointer</span>&nbsp;<span class="op" id="1782093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782096">const</span>&nbsp;<span class="op" id="1782102">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782106">chunk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1782115">=</span>&nbsp;<span class="num" id="1782117">256</span>&nbsp;<span class="op" id="1782121">&lt;&lt;</span>&nbsp;<span class="num" id="1782124">10</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782129">maxBlock</span>&nbsp;<span class="op" id="1782138">=</span>&nbsp;<span class="num" id="1782140">64</span>&nbsp;<span class="op" id="1782143">&lt;&lt;</span>&nbsp;<span class="num" id="1782146">10</span>&nbsp;<span class="comment" id="1782149">//&nbsp;VM&nbsp;reservation&nbsp;granularity&nbsp;is&nbsp;64K&nbsp;on&nbsp;windows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1782198">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782202">if</span>&nbsp;<span class="ident" id="1782205">align</span>&nbsp;<span class="op" id="1782211">!=</span>&nbsp;<span class="num" id="1782214">0</span>&nbsp;<span class="op" id="1782216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782220">if</span>&nbsp;<span class="ident" id="1782223">align</span><span class="op" id="1782228">&amp;</span><span class="op" id="1782229">(</span><span class="ident" id="1782230">align</span><span class="op" id="1782235">-</span><span class="num" id="1782236">1</span><span class="op" id="1782237">)</span>&nbsp;<span class="op" id="1782239">!=</span>&nbsp;<span class="num" id="1782242">0</span>&nbsp;<span class="op" id="1782244">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782249">gothrow</span><span class="op" id="1782256">(</span><span class="string" id="1782257">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;not&nbsp;a&nbsp;power&nbsp;of&nbsp;2&#34;</span><span class="op" id="1782301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1782305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782309">if</span>&nbsp;<span class="ident" id="1782312">align</span>&nbsp;<span class="op" id="1782318">&gt;</span>&nbsp;<span class="ident" id="1782320">_PageSize</span>&nbsp;<span class="op" id="1782330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782335">gothrow</span><span class="op" id="1782342">(</span><span class="string" id="1782343">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;too&nbsp;large&#34;</span><span class="op" id="1782380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1782384">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1782387">}</span>&nbsp;<span class="keyword" id="1782389">else</span>&nbsp;<span class="op" id="1782394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782398">align</span>&nbsp;<span class="op" id="1782404">=</span>&nbsp;<span class="num" id="1782406">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1782409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782413">if</span>&nbsp;<span class="ident" id="1782416">size</span>&nbsp;<span class="op" id="1782421">&gt;=</span>&nbsp;<span class="ident" id="1782424">maxBlock</span>&nbsp;<span class="op" id="1782433">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782437">return</span>&nbsp;<span class="ident" id="1782444">sysAlloc</span><span class="op" id="1782452">(</span><span class="ident" id="1782453">size</span><span class="op" id="1782457">,</span>&nbsp;<span class="ident" id="1782459">stat</span><span class="op" id="1782463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1782466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782470">lock</span><span class="op" id="1782474">(</span><span class="op" id="1782475">&amp;</span><span class="ident" id="1782476">persistent</span><span class="op" id="1782486">.</span><span class="ident" id="1782487">lock</span><span class="op" id="1782491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782494">persistent</span><span class="op" id="1782504">.</span><span class="ident" id="1782505">pos</span>&nbsp;<span class="op" id="1782509">=</span>&nbsp;<span class="ident" id="1782511">roundup</span><span class="op" id="1782518">(</span><span class="ident" id="1782519">persistent</span><span class="op" id="1782529">.</span><span class="ident" id="1782530">pos</span><span class="op" id="1782533">,</span>&nbsp;<span class="ident" id="1782535">align</span><span class="op" id="1782540">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782543">if</span>&nbsp;<span class="builtintype" id="1782546">uintptr</span><span class="op" id="1782553">(</span><span class="ident" id="1782554">persistent</span><span class="op" id="1782564">.</span><span class="ident" id="1782565">pos</span><span class="op" id="1782568">)</span><span class="op" id="1782569">+</span><span class="ident" id="1782570">size</span>&nbsp;<span class="op" id="1782575">&gt;</span>&nbsp;<span class="builtintype" id="1782577">uintptr</span><span class="op" id="1782584">(</span><span class="ident" id="1782585">persistent</span><span class="op" id="1782595">.</span><span class="ident" id="1782596">end</span><span class="op" id="1782599">)</span>&nbsp;<span class="op" id="1782601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782605">persistent</span><span class="op" id="1782615">.</span><span class="ident" id="1782616">pos</span>&nbsp;<span class="op" id="1782620">=</span>&nbsp;<span class="ident" id="1782622">sysAlloc</span><span class="op" id="1782630">(</span><span class="ident" id="1782631">chunk</span><span class="op" id="1782636">,</span>&nbsp;<span class="op" id="1782638">&amp;</span><span class="ident" id="1782639">memstats</span><span class="op" id="1782647">.</span><span class="ident" id="1782648">other_sys</span><span class="op" id="1782657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782661">if</span>&nbsp;<span class="ident" id="1782664">persistent</span><span class="op" id="1782674">.</span><span class="ident" id="1782675">pos</span>&nbsp;<span class="op" id="1782679">==</span>&nbsp;<span class="ident" id="1782682">nil</span>&nbsp;<span class="op" id="1782686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782691">unlock</span><span class="op" id="1782697">(</span><span class="op" id="1782698">&amp;</span><span class="ident" id="1782699">persistent</span><span class="op" id="1782709">.</span><span class="ident" id="1782710">lock</span><span class="op" id="1782714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782719">gothrow</span><span class="op" id="1782726">(</span><span class="string" id="1782727">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1782760">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1782764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782768">persistent</span><span class="op" id="1782778">.</span><span class="ident" id="1782779">end</span>&nbsp;<span class="op" id="1782783">=</span>&nbsp;<span class="ident" id="1782785">add</span><span class="op" id="1782788">(</span><span class="ident" id="1782789">persistent</span><span class="op" id="1782799">.</span><span class="ident" id="1782800">pos</span><span class="op" id="1782803">,</span>&nbsp;<span class="ident" id="1782805">chunk</span><span class="op" id="1782810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1782813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782816">p</span>&nbsp;<span class="op" id="1782818">:=</span>&nbsp;<span class="ident" id="1782821">persistent</span><span class="op" id="1782831">.</span><span class="ident" id="1782832">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782837">persistent</span><span class="op" id="1782847">.</span><span class="ident" id="1782848">pos</span>&nbsp;<span class="op" id="1782852">=</span>&nbsp;<span class="ident" id="1782854">add</span><span class="op" id="1782857">(</span><span class="ident" id="1782858">persistent</span><span class="op" id="1782868">.</span><span class="ident" id="1782869">pos</span><span class="op" id="1782872">,</span>&nbsp;<span class="ident" id="1782874">size</span><span class="op" id="1782878">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782881">unlock</span><span class="op" id="1782887">(</span><span class="op" id="1782888">&amp;</span><span class="ident" id="1782889">persistent</span><span class="op" id="1782899">.</span><span class="ident" id="1782900">lock</span><span class="op" id="1782904">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1782908">if</span>&nbsp;<span class="ident" id="1782911">stat</span>&nbsp;<span class="op" id="1782916">!=</span>&nbsp;<span class="op" id="1782919">&amp;</span><span class="ident" id="1782920">memstats</span><span class="op" id="1782928">.</span><span class="ident" id="1782929">other_sys</span>&nbsp;<span class="op" id="1782939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782943">xadd64</span><span class="op" id="1782949">(</span><span class="ident" id="1782950">stat</span><span class="op" id="1782954">,</span>&nbsp;<span class="ident" id="1782956">int64</span><span class="op" id="1782961">(</span><span class="ident" id="1782962">size</span><span class="op" id="1782966">)</span><span class="op" id="1782967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1782971">xadd64</span><span class="op" id="1782977">(</span><span class="op" id="1782978">&amp;</span><span class="ident" id="1782979">memstats</span><span class="op" id="1782987">.</span><span class="ident" id="1782988">other_sys</span><span class="op" id="1782997">,</span>&nbsp;<span class="op" id="1782999">-</span><span class="ident" id="1783000">int64</span><span class="op" id="1783005">(</span><span class="ident" id="1783006">size</span><span class="op" id="1783010">)</span><span class="op" id="1783011">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1783014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1783017">return</span>&nbsp;<span class="ident" id="1783024">p</span><br>
<span class="lineno"></span><span class="op" id="1783026">}</span>
</div>
</body>
</html>
