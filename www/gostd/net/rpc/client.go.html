<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html" class="current">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5786803">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5786858">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5786912">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5786963">package</span>&nbsp;<span class="ident" id="5786971">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5786976">import</span>&nbsp;<span class="op" id="5786983">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5786986">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5786995">&#34;encoding/gob&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5787011">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5787021">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5787027">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5787034">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5787041">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5787053">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5787060">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5787063">//&nbsp;ServerError&nbsp;represents&nbsp;an&nbsp;error&nbsp;that&nbsp;has&nbsp;been&nbsp;returned&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="5787126">//&nbsp;the&nbsp;remote&nbsp;side&nbsp;of&nbsp;the&nbsp;RPC&nbsp;connection.</span><br>
<span class="lineno">20</span><span class="keyword" id="5787168">type</span>&nbsp;<span class="ident" id="5787173">ServerError</span>&nbsp;<span class="builtintype" id="5787185">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5787193">func</span>&nbsp;<span class="op" id="5787198">(</span><span class="ident" id="5787199">e</span>&nbsp;<span class="ident" id="5787201">ServerError</span><span class="op" id="5787212">)</span>&nbsp;<span class="ident" id="5787214">Error</span><span class="op" id="5787219">(</span><span class="op" id="5787220">)</span>&nbsp;<span class="builtintype" id="5787222">string</span>&nbsp;<span class="op" id="5787229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5787232">return</span>&nbsp;<span class="builtintype" id="5787239">string</span><span class="op" id="5787245">(</span><span class="ident" id="5787246">e</span><span class="op" id="5787247">)</span><br>
<span class="lineno"></span><span class="op" id="5787249">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="5787252">var</span>&nbsp;<span class="ident" id="5787256">ErrShutdown</span>&nbsp;<span class="op" id="5787268">=</span>&nbsp;<span class="ident" id="5787270">errors</span><span class="op" id="5787276">.</span><span class="ident" id="5787277">New</span><span class="op" id="5787280">(</span><span class="string" id="5787281">&#34;connection&nbsp;is&nbsp;shut&nbsp;down&#34;</span><span class="op" id="5787306">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5787309">//&nbsp;Call&nbsp;represents&nbsp;an&nbsp;active&nbsp;RPC.</span><br>
<span class="lineno"></span><span class="keyword" id="5787343">type</span>&nbsp;<span class="ident" id="5787348">Call</span>&nbsp;<span class="keyword" id="5787353">struct</span>&nbsp;<span class="op" id="5787360">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5787363">ServiceMethod</span>&nbsp;<span class="builtintype" id="5787377">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5787389">//&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5787437">Args</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5787451">interface</span><span class="op" id="5787460">{</span><span class="op" id="5787461">}</span>&nbsp;<span class="comment" id="5787463">//&nbsp;The&nbsp;argument&nbsp;to&nbsp;the&nbsp;function&nbsp;(*struct).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5787507">Reply</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5787521">interface</span><span class="op" id="5787530">{</span><span class="op" id="5787531">}</span>&nbsp;<span class="comment" id="5787533">//&nbsp;The&nbsp;reply&nbsp;from&nbsp;the&nbsp;function&nbsp;(*struct).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5787576">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5787590">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5787602">//&nbsp;After&nbsp;completion,&nbsp;the&nbsp;error&nbsp;status.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5787642">Done</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5787656">chan</span>&nbsp;<span class="op" id="5787661">*</span><span class="ident" id="5787662">Call</span>&nbsp;&nbsp;<span class="comment" id="5787668">//&nbsp;Strobes&nbsp;when&nbsp;call&nbsp;is&nbsp;complete.</span><br>
<span class="lineno">35</span><span class="op" id="5787702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5787705">//&nbsp;Client&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Client.</span><br>
<span class="lineno"></span><span class="comment" id="5787741">//&nbsp;There&nbsp;may&nbsp;be&nbsp;multiple&nbsp;outstanding&nbsp;Calls&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment" id="5787795">//&nbsp;with&nbsp;a&nbsp;single&nbsp;Client,&nbsp;and&nbsp;a&nbsp;Client&nbsp;may&nbsp;be&nbsp;used&nbsp;by</span><br>
<span class="lineno">40</span><span class="comment" id="5787848">//&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="keyword" id="5787887">type</span>&nbsp;<span class="ident" id="5787892">Client</span>&nbsp;<span class="keyword" id="5787899">struct</span>&nbsp;<span class="op" id="5787906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5787909">codec</span>&nbsp;<span class="ident" id="5787915">ClientCodec</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5787929">reqMutex</span>&nbsp;<span class="ident" id="5787938">sync</span><span class="op" id="5787942">.</span><span class="ident" id="5787943">Mutex</span>&nbsp;<span class="comment" id="5787949">//&nbsp;protects&nbsp;following</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5787972">request</span>&nbsp;&nbsp;<span class="ident" id="5787981">Request</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5787991">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5788000">sync</span><span class="op" id="5788004">.</span><span class="ident" id="5788005">Mutex</span>&nbsp;<span class="comment" id="5788011">//&nbsp;protects&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5788034">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5788043">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5788051">pending</span>&nbsp;&nbsp;<span class="keyword" id="5788060">map</span><span class="op" id="5788063">[</span><span class="ident" id="5788064">uint64</span><span class="op" id="5788070">]</span><span class="op" id="5788071">*</span><span class="ident" id="5788072">Call</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5788078">closing</span>&nbsp;&nbsp;<span class="builtintype" id="5788087">bool</span>&nbsp;<span class="comment" id="5788092">//&nbsp;user&nbsp;has&nbsp;called&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5788118">shutdown</span>&nbsp;<span class="builtintype" id="5788127">bool</span>&nbsp;<span class="comment" id="5788132">//&nbsp;server&nbsp;has&nbsp;told&nbsp;us&nbsp;to&nbsp;stop</span><br>
<span class="lineno"></span><span class="op" id="5788162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5788165">//&nbsp;A&nbsp;ClientCodec&nbsp;implements&nbsp;writing&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and</span><br>
<span class="lineno">55</span><span class="comment" id="5788221">//&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;client&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="5788288">//&nbsp;The&nbsp;client&nbsp;calls&nbsp;WriteRequest&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;to&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="5788358">//&nbsp;and&nbsp;calls&nbsp;ReadResponseHeader&nbsp;and&nbsp;ReadResponseBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="5788420">//&nbsp;to&nbsp;read&nbsp;responses.&nbsp;&nbsp;The&nbsp;client&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5788489">//&nbsp;connection.&nbsp;ReadResponseBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">60</span><span class="comment" id="5788546">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;response&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="5788612">//&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="5788626">type</span>&nbsp;<span class="ident" id="5788631">ClientCodec</span>&nbsp;<span class="keyword" id="5788643">interface</span>&nbsp;<span class="op" id="5788653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5788656">//&nbsp;WriteRequest&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5788729">WriteRequest</span><span class="op" id="5788741">(</span><span class="op" id="5788742">*</span><span class="ident" id="5788743">Request</span><span class="op" id="5788750">,</span>&nbsp;<span class="keyword" id="5788752">interface</span><span class="op" id="5788761">{</span><span class="op" id="5788762">}</span><span class="op" id="5788763">)</span>&nbsp;<span class="builtintype" id="5788765">error</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5788772">ReadResponseHeader</span><span class="op" id="5788790">(</span><span class="op" id="5788791">*</span><span class="ident" id="5788792">Response</span><span class="op" id="5788800">)</span>&nbsp;<span class="builtintype" id="5788802">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5788809">ReadResponseBody</span><span class="op" id="5788825">(</span><span class="keyword" id="5788826">interface</span><span class="op" id="5788835">{</span><span class="op" id="5788836">}</span><span class="op" id="5788837">)</span>&nbsp;<span class="builtintype" id="5788839">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5788847">Close</span><span class="op" id="5788852">(</span><span class="op" id="5788853">)</span>&nbsp;<span class="builtintype" id="5788855">error</span><br>
<span class="lineno"></span><span class="op" id="5788861">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="5788864">func</span>&nbsp;<span class="op" id="5788869">(</span><span class="ident" id="5788870">client</span>&nbsp;<span class="op" id="5788877">*</span><span class="ident" id="5788878">Client</span><span class="op" id="5788884">)</span>&nbsp;<span class="ident" id="5788886">send</span><span class="op" id="5788890">(</span><span class="ident" id="5788891">call</span>&nbsp;<span class="op" id="5788896">*</span><span class="ident" id="5788897">Call</span><span class="op" id="5788901">)</span>&nbsp;<span class="op" id="5788903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5788906">client</span><span class="op" id="5788912">.</span><span class="ident" id="5788913">reqMutex</span><span class="op" id="5788921">.</span><span class="ident" id="5788922">Lock</span><span class="op" id="5788926">(</span><span class="op" id="5788927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5788930">defer</span>&nbsp;<span class="ident" id="5788936">client</span><span class="op" id="5788942">.</span><span class="ident" id="5788943">reqMutex</span><span class="op" id="5788951">.</span><span class="ident" id="5788952">Unlock</span><span class="op" id="5788958">(</span><span class="op" id="5788959">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5788963">//&nbsp;Register&nbsp;this&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5788987">client</span><span class="op" id="5788993">.</span><span class="ident" id="5788994">mutex</span><span class="op" id="5788999">.</span><span class="ident" id="5789000">Lock</span><span class="op" id="5789004">(</span><span class="op" id="5789005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5789008">if</span>&nbsp;<span class="ident" id="5789011">client</span><span class="op" id="5789017">.</span><span class="ident" id="5789018">shutdown</span>&nbsp;<span class="op" id="5789027">||</span>&nbsp;<span class="ident" id="5789030">client</span><span class="op" id="5789036">.</span><span class="ident" id="5789037">closing</span>&nbsp;<span class="op" id="5789045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789049">call</span><span class="op" id="5789053">.</span><span class="ident" id="5789054">Error</span>&nbsp;<span class="op" id="5789060">=</span>&nbsp;<span class="ident" id="5789062">ErrShutdown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789076">client</span><span class="op" id="5789082">.</span><span class="ident" id="5789083">mutex</span><span class="op" id="5789088">.</span><span class="ident" id="5789089">Unlock</span><span class="op" id="5789095">(</span><span class="op" id="5789096">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789100">call</span><span class="op" id="5789104">.</span><span class="ident" id="5789105">done</span><span class="op" id="5789109">(</span><span class="op" id="5789110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5789114">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5789122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789125">seq</span>&nbsp;<span class="op" id="5789129">:=</span>&nbsp;<span class="ident" id="5789132">client</span><span class="op" id="5789138">.</span><span class="ident" id="5789139">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789144">client</span><span class="op" id="5789150">.</span><span class="ident" id="5789151">seq</span><span class="op" id="5789154">++</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789158">client</span><span class="op" id="5789164">.</span><span class="ident" id="5789165">pending</span><span class="op" id="5789172">[</span><span class="ident" id="5789173">seq</span><span class="op" id="5789176">]</span>&nbsp;<span class="op" id="5789178">=</span>&nbsp;<span class="ident" id="5789180">call</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789186">client</span><span class="op" id="5789192">.</span><span class="ident" id="5789193">mutex</span><span class="op" id="5789198">.</span><span class="ident" id="5789199">Unlock</span><span class="op" id="5789205">(</span><span class="op" id="5789206">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5789210">//&nbsp;Encode&nbsp;and&nbsp;send&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789243">client</span><span class="op" id="5789249">.</span><span class="ident" id="5789250">request</span><span class="op" id="5789257">.</span><span class="ident" id="5789258">Seq</span>&nbsp;<span class="op" id="5789262">=</span>&nbsp;<span class="ident" id="5789264">seq</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789269">client</span><span class="op" id="5789275">.</span><span class="ident" id="5789276">request</span><span class="op" id="5789283">.</span><span class="ident" id="5789284">ServiceMethod</span>&nbsp;<span class="op" id="5789298">=</span>&nbsp;<span class="ident" id="5789300">call</span><span class="op" id="5789304">.</span><span class="ident" id="5789305">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789320">err</span>&nbsp;<span class="op" id="5789324">:=</span>&nbsp;<span class="ident" id="5789327">client</span><span class="op" id="5789333">.</span><span class="ident" id="5789334">codec</span><span class="op" id="5789339">.</span><span class="ident" id="5789340">WriteRequest</span><span class="op" id="5789352">(</span><span class="op" id="5789353">&amp;</span><span class="ident" id="5789354">client</span><span class="op" id="5789360">.</span><span class="ident" id="5789361">request</span><span class="op" id="5789368">,</span>&nbsp;<span class="ident" id="5789370">call</span><span class="op" id="5789374">.</span><span class="ident" id="5789375">Args</span><span class="op" id="5789379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5789382">if</span>&nbsp;<span class="ident" id="5789385">err</span>&nbsp;<span class="op" id="5789389">!=</span>&nbsp;<span class="builtintype" id="5789392">nil</span>&nbsp;<span class="op" id="5789396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789400">client</span><span class="op" id="5789406">.</span><span class="ident" id="5789407">mutex</span><span class="op" id="5789412">.</span><span class="ident" id="5789413">Lock</span><span class="op" id="5789417">(</span><span class="op" id="5789418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789422">call</span>&nbsp;<span class="op" id="5789427">=</span>&nbsp;<span class="ident" id="5789429">client</span><span class="op" id="5789435">.</span><span class="ident" id="5789436">pending</span><span class="op" id="5789443">[</span><span class="ident" id="5789444">seq</span><span class="op" id="5789447">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5789451">delete</span><span class="op" id="5789457">(</span><span class="ident" id="5789458">client</span><span class="op" id="5789464">.</span><span class="ident" id="5789465">pending</span><span class="op" id="5789472">,</span>&nbsp;<span class="ident" id="5789474">seq</span><span class="op" id="5789477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789481">client</span><span class="op" id="5789487">.</span><span class="ident" id="5789488">mutex</span><span class="op" id="5789493">.</span><span class="ident" id="5789494">Unlock</span><span class="op" id="5789500">(</span><span class="op" id="5789501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5789505">if</span>&nbsp;<span class="ident" id="5789508">call</span>&nbsp;<span class="op" id="5789513">!=</span>&nbsp;<span class="builtintype" id="5789516">nil</span>&nbsp;<span class="op" id="5789520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789525">call</span><span class="op" id="5789529">.</span><span class="ident" id="5789530">Error</span>&nbsp;<span class="op" id="5789536">=</span>&nbsp;<span class="ident" id="5789538">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789545">call</span><span class="op" id="5789549">.</span><span class="ident" id="5789550">done</span><span class="op" id="5789554">(</span><span class="op" id="5789555">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5789559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5789562">}</span><br>
<span class="lineno"></span><span class="op" id="5789564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5789567">func</span>&nbsp;<span class="op" id="5789572">(</span><span class="ident" id="5789573">client</span>&nbsp;<span class="op" id="5789580">*</span><span class="ident" id="5789581">Client</span><span class="op" id="5789587">)</span>&nbsp;<span class="ident" id="5789589">input</span><span class="op" id="5789594">(</span><span class="op" id="5789595">)</span>&nbsp;<span class="op" id="5789597">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5789600">var</span>&nbsp;<span class="ident" id="5789604">err</span>&nbsp;<span class="builtintype" id="5789608">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5789615">var</span>&nbsp;<span class="ident" id="5789619">response</span>&nbsp;<span class="ident" id="5789628">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5789638">for</span>&nbsp;<span class="ident" id="5789642">err</span>&nbsp;<span class="op" id="5789646">==</span>&nbsp;<span class="builtintype" id="5789649">nil</span>&nbsp;<span class="op" id="5789653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789657">response</span>&nbsp;<span class="op" id="5789666">=</span>&nbsp;<span class="ident" id="5789668">Response</span><span class="op" id="5789676">{</span><span class="op" id="5789677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789681">err</span>&nbsp;<span class="op" id="5789685">=</span>&nbsp;<span class="ident" id="5789687">client</span><span class="op" id="5789693">.</span><span class="ident" id="5789694">codec</span><span class="op" id="5789699">.</span><span class="ident" id="5789700">ReadResponseHeader</span><span class="op" id="5789718">(</span><span class="op" id="5789719">&amp;</span><span class="ident" id="5789720">response</span><span class="op" id="5789728">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5789732">if</span>&nbsp;<span class="ident" id="5789735">err</span>&nbsp;<span class="op" id="5789739">!=</span>&nbsp;<span class="builtintype" id="5789742">nil</span>&nbsp;<span class="op" id="5789746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5789751">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5789759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789763">seq</span>&nbsp;<span class="op" id="5789767">:=</span>&nbsp;<span class="ident" id="5789770">response</span><span class="op" id="5789778">.</span><span class="ident" id="5789779">Seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789785">client</span><span class="op" id="5789791">.</span><span class="ident" id="5789792">mutex</span><span class="op" id="5789797">.</span><span class="ident" id="5789798">Lock</span><span class="op" id="5789802">(</span><span class="op" id="5789803">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789807">call</span>&nbsp;<span class="op" id="5789812">:=</span>&nbsp;<span class="ident" id="5789815">client</span><span class="op" id="5789821">.</span><span class="ident" id="5789822">pending</span><span class="op" id="5789829">[</span><span class="ident" id="5789830">seq</span><span class="op" id="5789833">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5789837">delete</span><span class="op" id="5789843">(</span><span class="ident" id="5789844">client</span><span class="op" id="5789850">.</span><span class="ident" id="5789851">pending</span><span class="op" id="5789858">,</span>&nbsp;<span class="ident" id="5789860">seq</span><span class="op" id="5789863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5789867">client</span><span class="op" id="5789873">.</span><span class="ident" id="5789874">mutex</span><span class="op" id="5789879">.</span><span class="ident" id="5789880">Unlock</span><span class="op" id="5789886">(</span><span class="op" id="5789887">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5789892">switch</span>&nbsp;<span class="op" id="5789899">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5789903">case</span>&nbsp;<span class="ident" id="5789908">call</span>&nbsp;<span class="op" id="5789913">==</span>&nbsp;<span class="builtintype" id="5789916">nil</span><span class="op" id="5789919">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5789924">//&nbsp;We&#39;ve&nbsp;got&nbsp;no&nbsp;pending&nbsp;call.&nbsp;That&nbsp;usually&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5789981">//&nbsp;WriteRequest&nbsp;partially&nbsp;failed,&nbsp;and&nbsp;call&nbsp;was&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5790039">//&nbsp;removed;&nbsp;response&nbsp;is&nbsp;a&nbsp;server&nbsp;telling&nbsp;us&nbsp;about&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5790095">//&nbsp;error&nbsp;reading&nbsp;request&nbsp;body.&nbsp;We&nbsp;should&nbsp;still&nbsp;attempt</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5790153">//&nbsp;to&nbsp;read&nbsp;error&nbsp;body,&nbsp;but&nbsp;there&#39;s&nbsp;no&nbsp;one&nbsp;to&nbsp;give&nbsp;it&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5790213">err</span>&nbsp;<span class="op" id="5790217">=</span>&nbsp;<span class="ident" id="5790219">client</span><span class="op" id="5790225">.</span><span class="ident" id="5790226">codec</span><span class="op" id="5790231">.</span><span class="ident" id="5790232">ReadResponseBody</span><span class="op" id="5790248">(</span><span class="builtintype" id="5790249">nil</span><span class="op" id="5790252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5790257">if</span>&nbsp;<span class="ident" id="5790260">err</span>&nbsp;<span class="op" id="5790264">!=</span>&nbsp;<span class="builtintype" id="5790267">nil</span>&nbsp;<span class="op" id="5790271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5790277">err</span>&nbsp;<span class="op" id="5790281">=</span>&nbsp;<span class="ident" id="5790283">errors</span><span class="op" id="5790289">.</span><span class="ident" id="5790290">New</span><span class="op" id="5790293">(</span><span class="string" id="5790294">&#34;reading&nbsp;error&nbsp;body:&nbsp;&#34;</span>&nbsp;<span class="op" id="5790317">+</span>&nbsp;<span class="ident" id="5790319">err</span><span class="op" id="5790322">.</span><span class="ident" id="5790323">Error</span><span class="op" id="5790328">(</span><span class="op" id="5790329">)</span><span class="op" id="5790330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5790335">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5790339">case</span>&nbsp;<span class="ident" id="5790344">response</span><span class="op" id="5790352">.</span><span class="ident" id="5790353">Error</span>&nbsp;<span class="op" id="5790359">!=</span>&nbsp;<span class="string" id="5790362">&#34;&#34;</span><span class="op" id="5790364">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5790369">//&nbsp;We&#39;ve&nbsp;got&nbsp;an&nbsp;error&nbsp;response.&nbsp;Give&nbsp;this&nbsp;to&nbsp;the&nbsp;request;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5790430">//&nbsp;any&nbsp;subsequent&nbsp;requests&nbsp;will&nbsp;get&nbsp;the&nbsp;ReadResponseBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5790490">//&nbsp;error&nbsp;if&nbsp;there&nbsp;is&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5790519">call</span><span class="op" id="5790523">.</span><span class="ident" id="5790524">Error</span>&nbsp;<span class="op" id="5790530">=</span>&nbsp;<span class="ident" id="5790532">ServerError</span><span class="op" id="5790543">(</span><span class="ident" id="5790544">response</span><span class="op" id="5790552">.</span><span class="ident" id="5790553">Error</span><span class="op" id="5790558">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5790563">err</span>&nbsp;<span class="op" id="5790567">=</span>&nbsp;<span class="ident" id="5790569">client</span><span class="op" id="5790575">.</span><span class="ident" id="5790576">codec</span><span class="op" id="5790581">.</span><span class="ident" id="5790582">ReadResponseBody</span><span class="op" id="5790598">(</span><span class="builtintype" id="5790599">nil</span><span class="op" id="5790602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5790607">if</span>&nbsp;<span class="ident" id="5790610">err</span>&nbsp;<span class="op" id="5790614">!=</span>&nbsp;<span class="builtintype" id="5790617">nil</span>&nbsp;<span class="op" id="5790621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5790627">err</span>&nbsp;<span class="op" id="5790631">=</span>&nbsp;<span class="ident" id="5790633">errors</span><span class="op" id="5790639">.</span><span class="ident" id="5790640">New</span><span class="op" id="5790643">(</span><span class="string" id="5790644">&#34;reading&nbsp;error&nbsp;body:&nbsp;&#34;</span>&nbsp;<span class="op" id="5790667">+</span>&nbsp;<span class="ident" id="5790669">err</span><span class="op" id="5790672">.</span><span class="ident" id="5790673">Error</span><span class="op" id="5790678">(</span><span class="op" id="5790679">)</span><span class="op" id="5790680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5790685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5790690">call</span><span class="op" id="5790694">.</span><span class="ident" id="5790695">done</span><span class="op" id="5790699">(</span><span class="op" id="5790700">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5790704">default</span><span class="op" id="5790711">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5790716">err</span>&nbsp;<span class="op" id="5790720">=</span>&nbsp;<span class="ident" id="5790722">client</span><span class="op" id="5790728">.</span><span class="ident" id="5790729">codec</span><span class="op" id="5790734">.</span><span class="ident" id="5790735">ReadResponseBody</span><span class="op" id="5790751">(</span><span class="ident" id="5790752">call</span><span class="op" id="5790756">.</span><span class="ident" id="5790757">Reply</span><span class="op" id="5790762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5790767">if</span>&nbsp;<span class="ident" id="5790770">err</span>&nbsp;<span class="op" id="5790774">!=</span>&nbsp;<span class="builtintype" id="5790777">nil</span>&nbsp;<span class="op" id="5790781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5790787">call</span><span class="op" id="5790791">.</span><span class="ident" id="5790792">Error</span>&nbsp;<span class="op" id="5790798">=</span>&nbsp;<span class="ident" id="5790800">errors</span><span class="op" id="5790806">.</span><span class="ident" id="5790807">New</span><span class="op" id="5790810">(</span><span class="string" id="5790811">&#34;reading&nbsp;body&nbsp;&#34;</span>&nbsp;<span class="op" id="5790827">+</span>&nbsp;<span class="ident" id="5790829">err</span><span class="op" id="5790832">.</span><span class="ident" id="5790833">Error</span><span class="op" id="5790838">(</span><span class="op" id="5790839">)</span><span class="op" id="5790840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5790845">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5790850">call</span><span class="op" id="5790854">.</span><span class="ident" id="5790855">done</span><span class="op" id="5790859">(</span><span class="op" id="5790860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5790864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5790867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5790870">//&nbsp;Terminate&nbsp;pending&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5790899">client</span><span class="op" id="5790905">.</span><span class="ident" id="5790906">reqMutex</span><span class="op" id="5790914">.</span><span class="ident" id="5790915">Lock</span><span class="op" id="5790919">(</span><span class="op" id="5790920">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5790923">client</span><span class="op" id="5790929">.</span><span class="ident" id="5790930">mutex</span><span class="op" id="5790935">.</span><span class="ident" id="5790936">Lock</span><span class="op" id="5790940">(</span><span class="op" id="5790941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5790944">client</span><span class="op" id="5790950">.</span><span class="ident" id="5790951">shutdown</span>&nbsp;<span class="op" id="5790960">=</span>&nbsp;<span class="builtintype" id="5790962">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5790968">closing</span>&nbsp;<span class="op" id="5790976">:=</span>&nbsp;<span class="ident" id="5790979">client</span><span class="op" id="5790985">.</span><span class="ident" id="5790986">closing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5790995">if</span>&nbsp;<span class="ident" id="5790998">err</span>&nbsp;<span class="op" id="5791002">==</span>&nbsp;<span class="ident" id="5791005">io</span><span class="op" id="5791007">.</span><span class="ident" id="5791008">EOF</span>&nbsp;<span class="op" id="5791012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5791016">if</span>&nbsp;<span class="ident" id="5791019">closing</span>&nbsp;<span class="op" id="5791027">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5791032">err</span>&nbsp;<span class="op" id="5791036">=</span>&nbsp;<span class="ident" id="5791038">ErrShutdown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5791052">}</span>&nbsp;<span class="keyword" id="5791054">else</span>&nbsp;<span class="op" id="5791059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5791064">err</span>&nbsp;<span class="op" id="5791068">=</span>&nbsp;<span class="ident" id="5791070">io</span><span class="op" id="5791072">.</span><span class="ident" id="5791073">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5791092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5791095">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5791098">for</span>&nbsp;<span class="ident" id="5791102">_</span><span class="op" id="5791103">,</span>&nbsp;<span class="ident" id="5791105">call</span>&nbsp;<span class="op" id="5791110">:=</span>&nbsp;<span class="keyword" id="5791113">range</span>&nbsp;<span class="ident" id="5791119">client</span><span class="op" id="5791125">.</span><span class="ident" id="5791126">pending</span>&nbsp;<span class="op" id="5791134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5791138">call</span><span class="op" id="5791142">.</span><span class="ident" id="5791143">Error</span>&nbsp;<span class="op" id="5791149">=</span>&nbsp;<span class="ident" id="5791151">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5791157">call</span><span class="op" id="5791161">.</span><span class="ident" id="5791162">done</span><span class="op" id="5791166">(</span><span class="op" id="5791167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5791170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5791173">client</span><span class="op" id="5791179">.</span><span class="ident" id="5791180">mutex</span><span class="op" id="5791185">.</span><span class="ident" id="5791186">Unlock</span><span class="op" id="5791192">(</span><span class="op" id="5791193">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5791196">client</span><span class="op" id="5791202">.</span><span class="ident" id="5791203">reqMutex</span><span class="op" id="5791211">.</span><span class="ident" id="5791212">Unlock</span><span class="op" id="5791218">(</span><span class="op" id="5791219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5791222">if</span>&nbsp;<span class="ident" id="5791225">debugLog</span>&nbsp;<span class="op" id="5791234">&amp;&amp;</span>&nbsp;<span class="ident" id="5791237">err</span>&nbsp;<span class="op" id="5791241">!=</span>&nbsp;<span class="ident" id="5791244">io</span><span class="op" id="5791246">.</span><span class="ident" id="5791247">EOF</span>&nbsp;<span class="op" id="5791251">&amp;&amp;</span>&nbsp;<span class="op" id="5791254">!</span><span class="ident" id="5791255">closing</span>&nbsp;<span class="op" id="5791263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5791267">log</span><span class="op" id="5791270">.</span><span class="ident" id="5791271">Println</span><span class="op" id="5791278">(</span><span class="string" id="5791279">&#34;rpc:&nbsp;client&nbsp;protocol&nbsp;error:&#34;</span><span class="op" id="5791308">,</span>&nbsp;<span class="ident" id="5791310">err</span><span class="op" id="5791313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5791316">}</span><br>
<span class="lineno"></span><span class="op" id="5791318">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="5791321">func</span>&nbsp;<span class="op" id="5791326">(</span><span class="ident" id="5791327">call</span>&nbsp;<span class="op" id="5791332">*</span><span class="ident" id="5791333">Call</span><span class="op" id="5791337">)</span>&nbsp;<span class="ident" id="5791339">done</span><span class="op" id="5791343">(</span><span class="op" id="5791344">)</span>&nbsp;<span class="op" id="5791346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5791349">select</span>&nbsp;<span class="op" id="5791356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5791359">case</span>&nbsp;<span class="ident" id="5791364">call</span><span class="op" id="5791368">.</span><span class="ident" id="5791369">Done</span>&nbsp;<span class="op" id="5791374">&lt;-</span>&nbsp;<span class="ident" id="5791377">call</span><span class="op" id="5791381">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5791385">//&nbsp;ok</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5791392">default</span><span class="op" id="5791399">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5791403">//&nbsp;We&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;block&nbsp;here.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5791480">//&nbsp;sure&nbsp;the&nbsp;channel&nbsp;has&nbsp;enough&nbsp;buffer&nbsp;space.&nbsp;See&nbsp;comment&nbsp;in&nbsp;Go().</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5791548">if</span>&nbsp;<span class="ident" id="5791551">debugLog</span>&nbsp;<span class="op" id="5791560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5791565">log</span><span class="op" id="5791568">.</span><span class="ident" id="5791569">Println</span><span class="op" id="5791576">(</span><span class="string" id="5791577">&#34;rpc:&nbsp;discarding&nbsp;Call&nbsp;reply&nbsp;due&nbsp;to&nbsp;insufficient&nbsp;Done&nbsp;chan&nbsp;capacity&#34;</span><span class="op" id="5791644">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5791648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5791651">}</span><br>
<span class="lineno"></span><span class="op" id="5791653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5791656">//&nbsp;NewClient&nbsp;returns&nbsp;a&nbsp;new&nbsp;Client&nbsp;to&nbsp;handle&nbsp;requests&nbsp;to&nbsp;the</span><br>
<span class="lineno">185</span><span class="comment" id="5791716">//&nbsp;set&nbsp;of&nbsp;services&nbsp;at&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5791771">//&nbsp;It&nbsp;adds&nbsp;a&nbsp;buffer&nbsp;to&nbsp;the&nbsp;write&nbsp;side&nbsp;of&nbsp;the&nbsp;connection&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="5791830">//&nbsp;the&nbsp;header&nbsp;and&nbsp;payload&nbsp;are&nbsp;sent&nbsp;as&nbsp;a&nbsp;unit.</span><br>
<span class="lineno"></span><span class="keyword" id="5791876">func</span>&nbsp;<span class="ident" id="5791881">NewClient</span><span class="op" id="5791890">(</span><span class="ident" id="5791891">conn</span>&nbsp;<span class="ident" id="5791896">io</span><span class="op" id="5791898">.</span><span class="ident" id="5791899">ReadWriteCloser</span><span class="op" id="5791914">)</span>&nbsp;<span class="op" id="5791916">*</span><span class="ident" id="5791917">Client</span>&nbsp;<span class="op" id="5791924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5791927">encBuf</span>&nbsp;<span class="op" id="5791934">:=</span>&nbsp;<span class="ident" id="5791937">bufio</span><span class="op" id="5791942">.</span><span class="ident" id="5791943">NewWriter</span><span class="op" id="5791952">(</span><span class="ident" id="5791953">conn</span><span class="op" id="5791957">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5791960">client</span>&nbsp;<span class="op" id="5791967">:=</span>&nbsp;<span class="op" id="5791970">&amp;</span><span class="ident" id="5791971">gobClientCodec</span><span class="op" id="5791985">{</span><span class="ident" id="5791986">conn</span><span class="op" id="5791990">,</span>&nbsp;<span class="ident" id="5791992">gob</span><span class="op" id="5791995">.</span><span class="ident" id="5791996">NewDecoder</span><span class="op" id="5792006">(</span><span class="ident" id="5792007">conn</span><span class="op" id="5792011">)</span><span class="op" id="5792012">,</span>&nbsp;<span class="ident" id="5792014">gob</span><span class="op" id="5792017">.</span><span class="ident" id="5792018">NewEncoder</span><span class="op" id="5792028">(</span><span class="ident" id="5792029">encBuf</span><span class="op" id="5792035">)</span><span class="op" id="5792036">,</span>&nbsp;<span class="ident" id="5792038">encBuf</span><span class="op" id="5792044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5792047">return</span>&nbsp;<span class="ident" id="5792054">NewClientWithCodec</span><span class="op" id="5792072">(</span><span class="ident" id="5792073">client</span><span class="op" id="5792079">)</span><br>
<span class="lineno"></span><span class="op" id="5792081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5792084">//&nbsp;NewClientWithCodec&nbsp;is&nbsp;like&nbsp;NewClient&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified</span><br>
<span class="lineno">195</span><span class="comment" id="5792147">//&nbsp;codec&nbsp;to&nbsp;encode&nbsp;requests&nbsp;and&nbsp;decode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5792197">func</span>&nbsp;<span class="ident" id="5792202">NewClientWithCodec</span><span class="op" id="5792220">(</span><span class="ident" id="5792221">codec</span>&nbsp;<span class="ident" id="5792227">ClientCodec</span><span class="op" id="5792238">)</span>&nbsp;<span class="op" id="5792240">*</span><span class="ident" id="5792241">Client</span>&nbsp;<span class="op" id="5792248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5792251">client</span>&nbsp;<span class="op" id="5792258">:=</span>&nbsp;<span class="op" id="5792261">&amp;</span><span class="ident" id="5792262">Client</span><span class="op" id="5792268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5792272">codec</span><span class="op" id="5792277">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5792281">codec</span><span class="op" id="5792286">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5792290">pending</span><span class="op" id="5792297">:</span>&nbsp;<span class="builtinfunc" id="5792299">make</span><span class="op" id="5792303">(</span><span class="keyword" id="5792304">map</span><span class="op" id="5792307">[</span><span class="ident" id="5792308">uint64</span><span class="op" id="5792314">]</span><span class="op" id="5792315">*</span><span class="ident" id="5792316">Call</span><span class="op" id="5792320">)</span><span class="op" id="5792321">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5792324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5792327">go</span>&nbsp;<span class="ident" id="5792330">client</span><span class="op" id="5792336">.</span><span class="ident" id="5792337">input</span><span class="op" id="5792342">(</span><span class="op" id="5792343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5792346">return</span>&nbsp;<span class="ident" id="5792353">client</span><br>
<span class="lineno"></span><span class="op" id="5792360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="keyword" id="5792363">type</span>&nbsp;<span class="ident" id="5792368">gobClientCodec</span>&nbsp;<span class="keyword" id="5792383">struct</span>&nbsp;<span class="op" id="5792390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5792393">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5792400">io</span><span class="op" id="5792402">.</span><span class="ident" id="5792403">ReadWriteCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5792420">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5792427">*</span><span class="ident" id="5792428">gob</span><span class="op" id="5792431">.</span><span class="ident" id="5792432">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5792441">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5792448">*</span><span class="ident" id="5792449">gob</span><span class="op" id="5792452">.</span><span class="ident" id="5792453">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5792462">encBuf</span>&nbsp;<span class="op" id="5792469">*</span><span class="ident" id="5792470">bufio</span><span class="op" id="5792475">.</span><span class="ident" id="5792476">Writer</span><br>
<span class="lineno">210</span><span class="op" id="5792483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5792486">func</span>&nbsp;<span class="op" id="5792491">(</span><span class="ident" id="5792492">c</span>&nbsp;<span class="op" id="5792494">*</span><span class="ident" id="5792495">gobClientCodec</span><span class="op" id="5792509">)</span>&nbsp;<span class="ident" id="5792511">WriteRequest</span><span class="op" id="5792523">(</span><span class="ident" id="5792524">r</span>&nbsp;<span class="op" id="5792526">*</span><span class="ident" id="5792527">Request</span><span class="op" id="5792534">,</span>&nbsp;<span class="ident" id="5792536">body</span>&nbsp;<span class="keyword" id="5792541">interface</span><span class="op" id="5792550">{</span><span class="op" id="5792551">}</span><span class="op" id="5792552">)</span>&nbsp;<span class="op" id="5792554">(</span><span class="ident" id="5792555">err</span>&nbsp;<span class="builtintype" id="5792559">error</span><span class="op" id="5792564">)</span>&nbsp;<span class="op" id="5792566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5792569">if</span>&nbsp;<span class="ident" id="5792572">err</span>&nbsp;<span class="op" id="5792576">=</span>&nbsp;<span class="ident" id="5792578">c</span><span class="op" id="5792579">.</span><span class="ident" id="5792580">enc</span><span class="op" id="5792583">.</span><span class="ident" id="5792584">Encode</span><span class="op" id="5792590">(</span><span class="ident" id="5792591">r</span><span class="op" id="5792592">)</span><span class="op" id="5792593">;</span>&nbsp;<span class="ident" id="5792595">err</span>&nbsp;<span class="op" id="5792599">!=</span>&nbsp;<span class="builtintype" id="5792602">nil</span>&nbsp;<span class="op" id="5792606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5792610">return</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5792618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5792621">if</span>&nbsp;<span class="ident" id="5792624">err</span>&nbsp;<span class="op" id="5792628">=</span>&nbsp;<span class="ident" id="5792630">c</span><span class="op" id="5792631">.</span><span class="ident" id="5792632">enc</span><span class="op" id="5792635">.</span><span class="ident" id="5792636">Encode</span><span class="op" id="5792642">(</span><span class="ident" id="5792643">body</span><span class="op" id="5792647">)</span><span class="op" id="5792648">;</span>&nbsp;<span class="ident" id="5792650">err</span>&nbsp;<span class="op" id="5792654">!=</span>&nbsp;<span class="builtintype" id="5792657">nil</span>&nbsp;<span class="op" id="5792661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5792665">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5792673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5792676">return</span>&nbsp;<span class="ident" id="5792683">c</span><span class="op" id="5792684">.</span><span class="ident" id="5792685">encBuf</span><span class="op" id="5792691">.</span><span class="ident" id="5792692">Flush</span><span class="op" id="5792697">(</span><span class="op" id="5792698">)</span><br>
<span class="lineno">220</span><span class="op" id="5792700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5792703">func</span>&nbsp;<span class="op" id="5792708">(</span><span class="ident" id="5792709">c</span>&nbsp;<span class="op" id="5792711">*</span><span class="ident" id="5792712">gobClientCodec</span><span class="op" id="5792726">)</span>&nbsp;<span class="ident" id="5792728">ReadResponseHeader</span><span class="op" id="5792746">(</span><span class="ident" id="5792747">r</span>&nbsp;<span class="op" id="5792749">*</span><span class="ident" id="5792750">Response</span><span class="op" id="5792758">)</span>&nbsp;<span class="builtintype" id="5792760">error</span>&nbsp;<span class="op" id="5792766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5792769">return</span>&nbsp;<span class="ident" id="5792776">c</span><span class="op" id="5792777">.</span><span class="ident" id="5792778">dec</span><span class="op" id="5792781">.</span><span class="ident" id="5792782">Decode</span><span class="op" id="5792788">(</span><span class="ident" id="5792789">r</span><span class="op" id="5792790">)</span><br>
<span class="lineno"></span><span class="op" id="5792792">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="5792795">func</span>&nbsp;<span class="op" id="5792800">(</span><span class="ident" id="5792801">c</span>&nbsp;<span class="op" id="5792803">*</span><span class="ident" id="5792804">gobClientCodec</span><span class="op" id="5792818">)</span>&nbsp;<span class="ident" id="5792820">ReadResponseBody</span><span class="op" id="5792836">(</span><span class="ident" id="5792837">body</span>&nbsp;<span class="keyword" id="5792842">interface</span><span class="op" id="5792851">{</span><span class="op" id="5792852">}</span><span class="op" id="5792853">)</span>&nbsp;<span class="builtintype" id="5792855">error</span>&nbsp;<span class="op" id="5792861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5792864">return</span>&nbsp;<span class="ident" id="5792871">c</span><span class="op" id="5792872">.</span><span class="ident" id="5792873">dec</span><span class="op" id="5792876">.</span><span class="ident" id="5792877">Decode</span><span class="op" id="5792883">(</span><span class="ident" id="5792884">body</span><span class="op" id="5792888">)</span><br>
<span class="lineno"></span><span class="op" id="5792890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="5792893">func</span>&nbsp;<span class="op" id="5792898">(</span><span class="ident" id="5792899">c</span>&nbsp;<span class="op" id="5792901">*</span><span class="ident" id="5792902">gobClientCodec</span><span class="op" id="5792916">)</span>&nbsp;<span class="ident" id="5792918">Close</span><span class="op" id="5792923">(</span><span class="op" id="5792924">)</span>&nbsp;<span class="builtintype" id="5792926">error</span>&nbsp;<span class="op" id="5792932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5792935">return</span>&nbsp;<span class="ident" id="5792942">c</span><span class="op" id="5792943">.</span><span class="ident" id="5792944">rwc</span><span class="op" id="5792947">.</span><span class="ident" id="5792948">Close</span><span class="op" id="5792953">(</span><span class="op" id="5792954">)</span><br>
<span class="lineno"></span><span class="op" id="5792956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5792959">//&nbsp;DialHTTP&nbsp;connects&nbsp;to&nbsp;an&nbsp;HTTP&nbsp;RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address</span><br>
<span class="lineno">235</span><span class="comment" id="5793035">//&nbsp;listening&nbsp;on&nbsp;the&nbsp;default&nbsp;HTTP&nbsp;RPC&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="5793078">func</span>&nbsp;<span class="ident" id="5793083">DialHTTP</span><span class="op" id="5793091">(</span><span class="ident" id="5793092">network</span><span class="op" id="5793099">,</span>&nbsp;<span class="ident" id="5793101">address</span>&nbsp;<span class="builtintype" id="5793109">string</span><span class="op" id="5793115">)</span>&nbsp;<span class="op" id="5793117">(</span><span class="op" id="5793118">*</span><span class="ident" id="5793119">Client</span><span class="op" id="5793125">,</span>&nbsp;<span class="builtintype" id="5793127">error</span><span class="op" id="5793132">)</span>&nbsp;<span class="op" id="5793134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5793137">return</span>&nbsp;<span class="ident" id="5793144">DialHTTPPath</span><span class="op" id="5793156">(</span><span class="ident" id="5793157">network</span><span class="op" id="5793164">,</span>&nbsp;<span class="ident" id="5793166">address</span><span class="op" id="5793173">,</span>&nbsp;<span class="ident" id="5793175">DefaultRPCPath</span><span class="op" id="5793189">)</span><br>
<span class="lineno"></span><span class="op" id="5793191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="comment" id="5793194">//&nbsp;DialHTTPPath&nbsp;connects&nbsp;to&nbsp;an&nbsp;HTTP&nbsp;RPC&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="5793241">//&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address&nbsp;and&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="5793287">func</span>&nbsp;<span class="ident" id="5793292">DialHTTPPath</span><span class="op" id="5793304">(</span><span class="ident" id="5793305">network</span><span class="op" id="5793312">,</span>&nbsp;<span class="ident" id="5793314">address</span><span class="op" id="5793321">,</span>&nbsp;<span class="ident" id="5793323">path</span>&nbsp;<span class="builtintype" id="5793328">string</span><span class="op" id="5793334">)</span>&nbsp;<span class="op" id="5793336">(</span><span class="op" id="5793337">*</span><span class="ident" id="5793338">Client</span><span class="op" id="5793344">,</span>&nbsp;<span class="builtintype" id="5793346">error</span><span class="op" id="5793351">)</span>&nbsp;<span class="op" id="5793353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5793356">var</span>&nbsp;<span class="ident" id="5793360">err</span>&nbsp;<span class="builtintype" id="5793364">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5793371">conn</span><span class="op" id="5793375">,</span>&nbsp;<span class="ident" id="5793377">err</span>&nbsp;<span class="op" id="5793381">:=</span>&nbsp;<span class="ident" id="5793384">net</span><span class="op" id="5793387">.</span><span class="ident" id="5793388">Dial</span><span class="op" id="5793392">(</span><span class="ident" id="5793393">network</span><span class="op" id="5793400">,</span>&nbsp;<span class="ident" id="5793402">address</span><span class="op" id="5793409">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5793412">if</span>&nbsp;<span class="ident" id="5793415">err</span>&nbsp;<span class="op" id="5793419">!=</span>&nbsp;<span class="builtintype" id="5793422">nil</span>&nbsp;<span class="op" id="5793426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5793430">return</span>&nbsp;<span class="builtintype" id="5793437">nil</span><span class="op" id="5793440">,</span>&nbsp;<span class="ident" id="5793442">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5793447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5793450">io</span><span class="op" id="5793452">.</span><span class="ident" id="5793453">WriteString</span><span class="op" id="5793464">(</span><span class="ident" id="5793465">conn</span><span class="op" id="5793469">,</span>&nbsp;<span class="string" id="5793471">&#34;CONNECT&nbsp;&#34;</span><span class="op" id="5793481">+</span><span class="ident" id="5793482">path</span><span class="op" id="5793486">+</span><span class="string" id="5793487">&#34;&nbsp;HTTP/1.0\n\n&#34;</span><span class="op" id="5793502">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5793506">//&nbsp;Require&nbsp;successful&nbsp;HTTP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5793543">//&nbsp;before&nbsp;switching&nbsp;to&nbsp;RPC&nbsp;protocol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5793581">resp</span><span class="op" id="5793585">,</span>&nbsp;<span class="ident" id="5793587">err</span>&nbsp;<span class="op" id="5793591">:=</span>&nbsp;<span class="ident" id="5793594">http</span><span class="op" id="5793598">.</span><span class="ident" id="5793599">ReadResponse</span><span class="op" id="5793611">(</span><span class="ident" id="5793612">bufio</span><span class="op" id="5793617">.</span><span class="ident" id="5793618">NewReader</span><span class="op" id="5793627">(</span><span class="ident" id="5793628">conn</span><span class="op" id="5793632">)</span><span class="op" id="5793633">,</span>&nbsp;<span class="op" id="5793635">&amp;</span><span class="ident" id="5793636">http</span><span class="op" id="5793640">.</span><span class="ident" id="5793641">Request</span><span class="op" id="5793648">{</span><span class="ident" id="5793649">Method</span><span class="op" id="5793655">:</span>&nbsp;<span class="string" id="5793657">&#34;CONNECT&#34;</span><span class="op" id="5793666">}</span><span class="op" id="5793667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5793670">if</span>&nbsp;<span class="ident" id="5793673">err</span>&nbsp;<span class="op" id="5793677">==</span>&nbsp;<span class="builtintype" id="5793680">nil</span>&nbsp;<span class="op" id="5793684">&amp;&amp;</span>&nbsp;<span class="ident" id="5793687">resp</span><span class="op" id="5793691">.</span><span class="ident" id="5793692">Status</span>&nbsp;<span class="op" id="5793699">==</span>&nbsp;<span class="ident" id="5793702">connected</span>&nbsp;<span class="op" id="5793712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5793716">return</span>&nbsp;<span class="ident" id="5793723">NewClient</span><span class="op" id="5793732">(</span><span class="ident" id="5793733">conn</span><span class="op" id="5793737">)</span><span class="op" id="5793738">,</span>&nbsp;<span class="builtintype" id="5793740">nil</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5793745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5793748">if</span>&nbsp;<span class="ident" id="5793751">err</span>&nbsp;<span class="op" id="5793755">==</span>&nbsp;<span class="builtintype" id="5793758">nil</span>&nbsp;<span class="op" id="5793762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5793766">err</span>&nbsp;<span class="op" id="5793770">=</span>&nbsp;<span class="ident" id="5793772">errors</span><span class="op" id="5793778">.</span><span class="ident" id="5793779">New</span><span class="op" id="5793782">(</span><span class="string" id="5793783">&#34;unexpected&nbsp;HTTP&nbsp;response:&nbsp;&#34;</span>&nbsp;<span class="op" id="5793812">+</span>&nbsp;<span class="ident" id="5793814">resp</span><span class="op" id="5793818">.</span><span class="ident" id="5793819">Status</span><span class="op" id="5793825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5793828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5793831">conn</span><span class="op" id="5793835">.</span><span class="ident" id="5793836">Close</span><span class="op" id="5793841">(</span><span class="op" id="5793842">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5793845">return</span>&nbsp;<span class="builtintype" id="5793852">nil</span><span class="op" id="5793855">,</span>&nbsp;<span class="op" id="5793857">&amp;</span><span class="ident" id="5793858">net</span><span class="op" id="5793861">.</span><span class="ident" id="5793862">OpError</span><span class="op" id="5793869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5793873">Op</span><span class="op" id="5793875">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="5793879">&#34;dial-http&#34;</span><span class="op" id="5793890">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5793894">Net</span><span class="op" id="5793897">:</span>&nbsp;&nbsp;<span class="ident" id="5793900">network</span>&nbsp;<span class="op" id="5793908">+</span>&nbsp;<span class="string" id="5793910">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="5793914">+</span>&nbsp;<span class="ident" id="5793916">address</span><span class="op" id="5793923">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5793927">Addr</span><span class="op" id="5793931">:</span>&nbsp;<span class="builtintype" id="5793933">nil</span><span class="op" id="5793936">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5793940">Err</span><span class="op" id="5793943">:</span>&nbsp;&nbsp;<span class="ident" id="5793946">err</span><span class="op" id="5793949">,</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5793952">}</span><br>
<span class="lineno"></span><span class="op" id="5793954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5793957">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;an&nbsp;RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="5794025">func</span>&nbsp;<span class="ident" id="5794030">Dial</span><span class="op" id="5794034">(</span><span class="ident" id="5794035">network</span><span class="op" id="5794042">,</span>&nbsp;<span class="ident" id="5794044">address</span>&nbsp;<span class="builtintype" id="5794052">string</span><span class="op" id="5794058">)</span>&nbsp;<span class="op" id="5794060">(</span><span class="op" id="5794061">*</span><span class="ident" id="5794062">Client</span><span class="op" id="5794068">,</span>&nbsp;<span class="builtintype" id="5794070">error</span><span class="op" id="5794075">)</span>&nbsp;<span class="op" id="5794077">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5794080">conn</span><span class="op" id="5794084">,</span>&nbsp;<span class="ident" id="5794086">err</span>&nbsp;<span class="op" id="5794090">:=</span>&nbsp;<span class="ident" id="5794093">net</span><span class="op" id="5794096">.</span><span class="ident" id="5794097">Dial</span><span class="op" id="5794101">(</span><span class="ident" id="5794102">network</span><span class="op" id="5794109">,</span>&nbsp;<span class="ident" id="5794111">address</span><span class="op" id="5794118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5794121">if</span>&nbsp;<span class="ident" id="5794124">err</span>&nbsp;<span class="op" id="5794128">!=</span>&nbsp;<span class="builtintype" id="5794131">nil</span>&nbsp;<span class="op" id="5794135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5794139">return</span>&nbsp;<span class="builtintype" id="5794146">nil</span><span class="op" id="5794149">,</span>&nbsp;<span class="ident" id="5794151">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5794156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5794159">return</span>&nbsp;<span class="ident" id="5794166">NewClient</span><span class="op" id="5794175">(</span><span class="ident" id="5794176">conn</span><span class="op" id="5794180">)</span><span class="op" id="5794181">,</span>&nbsp;<span class="builtintype" id="5794183">nil</span><br>
<span class="lineno">275</span><span class="op" id="5794187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5794190">func</span>&nbsp;<span class="op" id="5794195">(</span><span class="ident" id="5794196">client</span>&nbsp;<span class="op" id="5794203">*</span><span class="ident" id="5794204">Client</span><span class="op" id="5794210">)</span>&nbsp;<span class="ident" id="5794212">Close</span><span class="op" id="5794217">(</span><span class="op" id="5794218">)</span>&nbsp;<span class="builtintype" id="5794220">error</span>&nbsp;<span class="op" id="5794226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5794229">client</span><span class="op" id="5794235">.</span><span class="ident" id="5794236">mutex</span><span class="op" id="5794241">.</span><span class="ident" id="5794242">Lock</span><span class="op" id="5794246">(</span><span class="op" id="5794247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5794250">if</span>&nbsp;<span class="ident" id="5794253">client</span><span class="op" id="5794259">.</span><span class="ident" id="5794260">closing</span>&nbsp;<span class="op" id="5794268">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5794272">client</span><span class="op" id="5794278">.</span><span class="ident" id="5794279">mutex</span><span class="op" id="5794284">.</span><span class="ident" id="5794285">Unlock</span><span class="op" id="5794291">(</span><span class="op" id="5794292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5794296">return</span>&nbsp;<span class="ident" id="5794303">ErrShutdown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5794316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5794319">client</span><span class="op" id="5794325">.</span><span class="ident" id="5794326">closing</span>&nbsp;<span class="op" id="5794334">=</span>&nbsp;<span class="builtintype" id="5794336">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5794342">client</span><span class="op" id="5794348">.</span><span class="ident" id="5794349">mutex</span><span class="op" id="5794354">.</span><span class="ident" id="5794355">Unlock</span><span class="op" id="5794361">(</span><span class="op" id="5794362">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5794365">return</span>&nbsp;<span class="ident" id="5794372">client</span><span class="op" id="5794378">.</span><span class="ident" id="5794379">codec</span><span class="op" id="5794384">.</span><span class="ident" id="5794385">Close</span><span class="op" id="5794390">(</span><span class="op" id="5794391">)</span><br>
<span class="lineno"></span><span class="op" id="5794393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5794396">//&nbsp;Go&nbsp;invokes&nbsp;the&nbsp;function&nbsp;asynchronously.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;Call&nbsp;structure&nbsp;representing</span><br>
<span class="lineno"></span><span class="comment" id="5794483">//&nbsp;the&nbsp;invocation.&nbsp;&nbsp;The&nbsp;done&nbsp;channel&nbsp;will&nbsp;signal&nbsp;when&nbsp;the&nbsp;call&nbsp;is&nbsp;complete&nbsp;by&nbsp;returning</span><br>
<span class="lineno">290</span><span class="comment" id="5794571">//&nbsp;the&nbsp;same&nbsp;Call&nbsp;object.&nbsp;&nbsp;If&nbsp;done&nbsp;is&nbsp;nil,&nbsp;Go&nbsp;will&nbsp;allocate&nbsp;a&nbsp;new&nbsp;channel.</span><br>
<span class="lineno"></span><span class="comment" id="5794645">//&nbsp;If&nbsp;non-nil,&nbsp;done&nbsp;must&nbsp;be&nbsp;buffered&nbsp;or&nbsp;Go&nbsp;will&nbsp;deliberately&nbsp;crash.</span><br>
<span class="lineno"></span><span class="keyword" id="5794713">func</span>&nbsp;<span class="op" id="5794718">(</span><span class="ident" id="5794719">client</span>&nbsp;<span class="op" id="5794726">*</span><span class="ident" id="5794727">Client</span><span class="op" id="5794733">)</span>&nbsp;<span class="ident" id="5794735">Go</span><span class="op" id="5794737">(</span><span class="ident" id="5794738">serviceMethod</span>&nbsp;<span class="builtintype" id="5794752">string</span><span class="op" id="5794758">,</span>&nbsp;<span class="ident" id="5794760">args</span>&nbsp;<span class="keyword" id="5794765">interface</span><span class="op" id="5794774">{</span><span class="op" id="5794775">}</span><span class="op" id="5794776">,</span>&nbsp;<span class="ident" id="5794778">reply</span>&nbsp;<span class="keyword" id="5794784">interface</span><span class="op" id="5794793">{</span><span class="op" id="5794794">}</span><span class="op" id="5794795">,</span>&nbsp;<span class="ident" id="5794797">done</span>&nbsp;<span class="keyword" id="5794802">chan</span>&nbsp;<span class="op" id="5794807">*</span><span class="ident" id="5794808">Call</span><span class="op" id="5794812">)</span>&nbsp;<span class="op" id="5794814">*</span><span class="ident" id="5794815">Call</span>&nbsp;<span class="op" id="5794820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5794823">call</span>&nbsp;<span class="op" id="5794828">:=</span>&nbsp;<span class="builtinfunc" id="5794831">new</span><span class="op" id="5794834">(</span><span class="ident" id="5794835">Call</span><span class="op" id="5794839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5794842">call</span><span class="op" id="5794846">.</span><span class="ident" id="5794847">ServiceMethod</span>&nbsp;<span class="op" id="5794861">=</span>&nbsp;<span class="ident" id="5794863">serviceMethod</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5794878">call</span><span class="op" id="5794882">.</span><span class="ident" id="5794883">Args</span>&nbsp;<span class="op" id="5794888">=</span>&nbsp;<span class="ident" id="5794890">args</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5794896">call</span><span class="op" id="5794900">.</span><span class="ident" id="5794901">Reply</span>&nbsp;<span class="op" id="5794907">=</span>&nbsp;<span class="ident" id="5794909">reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5794916">if</span>&nbsp;<span class="ident" id="5794919">done</span>&nbsp;<span class="op" id="5794924">==</span>&nbsp;<span class="builtintype" id="5794927">nil</span>&nbsp;<span class="op" id="5794931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5794935">done</span>&nbsp;<span class="op" id="5794940">=</span>&nbsp;<span class="builtinfunc" id="5794942">make</span><span class="op" id="5794946">(</span><span class="keyword" id="5794947">chan</span>&nbsp;<span class="op" id="5794952">*</span><span class="ident" id="5794953">Call</span><span class="op" id="5794957">,</span>&nbsp;<span class="num" id="5794959">10</span><span class="op" id="5794961">)</span>&nbsp;<span class="comment" id="5794963">//&nbsp;buffered.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5794977">}</span>&nbsp;<span class="keyword" id="5794979">else</span>&nbsp;<span class="op" id="5794984">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5794988">//&nbsp;If&nbsp;caller&nbsp;passes&nbsp;done&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;must&nbsp;arrange&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5795044">//&nbsp;done&nbsp;has&nbsp;enough&nbsp;buffer&nbsp;for&nbsp;the&nbsp;number&nbsp;of&nbsp;simultaneous</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5795103">//&nbsp;RPCs&nbsp;that&nbsp;will&nbsp;be&nbsp;using&nbsp;that&nbsp;channel.&nbsp;&nbsp;If&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5795162">//&nbsp;is&nbsp;totally&nbsp;unbuffered,&nbsp;it&#39;s&nbsp;best&nbsp;not&nbsp;to&nbsp;run&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5795219">if</span>&nbsp;<span class="builtinfunc" id="5795222">cap</span><span class="op" id="5795225">(</span><span class="ident" id="5795226">done</span><span class="op" id="5795230">)</span>&nbsp;<span class="op" id="5795232">==</span>&nbsp;<span class="num" id="5795235">0</span>&nbsp;<span class="op" id="5795237">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5795242">log</span><span class="op" id="5795245">.</span><span class="ident" id="5795246">Panic</span><span class="op" id="5795251">(</span><span class="string" id="5795252">&#34;rpc:&nbsp;done&nbsp;channel&nbsp;is&nbsp;unbuffered&#34;</span><span class="op" id="5795285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5795289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5795292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5795295">call</span><span class="op" id="5795299">.</span><span class="ident" id="5795300">Done</span>&nbsp;<span class="op" id="5795305">=</span>&nbsp;<span class="ident" id="5795307">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5795313">client</span><span class="op" id="5795319">.</span><span class="ident" id="5795320">send</span><span class="op" id="5795324">(</span><span class="ident" id="5795325">call</span><span class="op" id="5795329">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5795332">return</span>&nbsp;<span class="ident" id="5795339">call</span><br>
<span class="lineno"></span><span class="op" id="5795344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5795347">//&nbsp;Call&nbsp;invokes&nbsp;the&nbsp;named&nbsp;function,&nbsp;waits&nbsp;for&nbsp;it&nbsp;to&nbsp;complete,&nbsp;and&nbsp;returns&nbsp;its&nbsp;error&nbsp;status.</span><br>
<span class="lineno"></span><span class="keyword" id="5795439">func</span>&nbsp;<span class="op" id="5795444">(</span><span class="ident" id="5795445">client</span>&nbsp;<span class="op" id="5795452">*</span><span class="ident" id="5795453">Client</span><span class="op" id="5795459">)</span>&nbsp;<span class="ident" id="5795461">Call</span><span class="op" id="5795465">(</span><span class="ident" id="5795466">serviceMethod</span>&nbsp;<span class="builtintype" id="5795480">string</span><span class="op" id="5795486">,</span>&nbsp;<span class="ident" id="5795488">args</span>&nbsp;<span class="keyword" id="5795493">interface</span><span class="op" id="5795502">{</span><span class="op" id="5795503">}</span><span class="op" id="5795504">,</span>&nbsp;<span class="ident" id="5795506">reply</span>&nbsp;<span class="keyword" id="5795512">interface</span><span class="op" id="5795521">{</span><span class="op" id="5795522">}</span><span class="op" id="5795523">)</span>&nbsp;<span class="builtintype" id="5795525">error</span>&nbsp;<span class="op" id="5795531">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5795534">call</span>&nbsp;<span class="op" id="5795539">:=</span>&nbsp;<span class="op" id="5795542">&lt;-</span><span class="ident" id="5795544">client</span><span class="op" id="5795550">.</span><span class="ident" id="5795551">Go</span><span class="op" id="5795553">(</span><span class="ident" id="5795554">serviceMethod</span><span class="op" id="5795567">,</span>&nbsp;<span class="ident" id="5795569">args</span><span class="op" id="5795573">,</span>&nbsp;<span class="ident" id="5795575">reply</span><span class="op" id="5795580">,</span>&nbsp;<span class="builtinfunc" id="5795582">make</span><span class="op" id="5795586">(</span><span class="keyword" id="5795587">chan</span>&nbsp;<span class="op" id="5795592">*</span><span class="ident" id="5795593">Call</span><span class="op" id="5795597">,</span>&nbsp;<span class="num" id="5795599">1</span><span class="op" id="5795600">)</span><span class="op" id="5795601">)</span><span class="op" id="5795602">.</span><span class="ident" id="5795603">Done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5795609">return</span>&nbsp;<span class="ident" id="5795616">call</span><span class="op" id="5795620">.</span><span class="ident" id="5795621">Error</span><br>
<span class="lineno"></span><span class="op" id="5795627">}</span>
</div>
</body>
</html>
