<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7893116">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7893171">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7893225">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7893276">package</span>&nbsp;<span class="ident" id="7893284">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7893290">import</span>&nbsp;<span class="op" id="7893297">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893300">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893309">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893316">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893325">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893340">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893346">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893359">&#34;math/rand&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893372">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893378">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893389">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7893399">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="7893402">//&nbsp;TestDecodeProgressive&nbsp;tests&nbsp;that&nbsp;decoding&nbsp;the&nbsp;baseline&nbsp;and&nbsp;progressive</span><br>
<span class="lineno"></span><span class="comment" id="7893476">//&nbsp;versions&nbsp;of&nbsp;the&nbsp;same&nbsp;image&nbsp;result&nbsp;in&nbsp;exactly&nbsp;the&nbsp;same&nbsp;pixel&nbsp;data,&nbsp;in&nbsp;YCbCr</span><br>
<span class="lineno"></span><span class="comment" id="7893554">//&nbsp;space&nbsp;for&nbsp;color&nbsp;images,&nbsp;and&nbsp;Y&nbsp;space&nbsp;for&nbsp;grayscale&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="7893615">func</span>&nbsp;<span class="ident" id="7893620">TestDecodeProgressive</span><span class="op" id="7893641">(</span><span class="ident" id="7893642">t</span>&nbsp;<span class="op" id="7893644">*</span><span class="ident" id="7893645">testing</span><span class="op" id="7893652">.</span><span class="ident" id="7893653">T</span><span class="op" id="7893654">)</span>&nbsp;<span class="op" id="7893656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893659">testCases</span>&nbsp;<span class="op" id="7893669">:=</span>&nbsp;<span class="op" id="7893672">[</span><span class="op" id="7893673">]</span><span class="builtintype" id="7893674">string</span><span class="op" id="7893680">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893684">&#34;../testdata/video-001&#34;</span><span class="op" id="7893707">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893711">&#34;../testdata/video-001.q50.420&#34;</span><span class="op" id="7893742">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893746">&#34;../testdata/video-001.q50.422&#34;</span><span class="op" id="7893777">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893781">&#34;../testdata/video-001.q50.440&#34;</span><span class="op" id="7893812">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893816">&#34;../testdata/video-001.q50.444&#34;</span><span class="op" id="7893847">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893851">&#34;../testdata/video-005.gray.q50&#34;</span><span class="op" id="7893883">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893887">&#34;../testdata/video-005.gray.q50.2x2&#34;</span><span class="op" id="7893923">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7893927">&#34;../testdata/video-001.separate.dc.progression&#34;</span><span class="op" id="7893974">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893980">for</span>&nbsp;<span class="ident" id="7893984">_</span><span class="op" id="7893985">,</span>&nbsp;<span class="ident" id="7893987">tc</span>&nbsp;<span class="op" id="7893990">:=</span>&nbsp;<span class="keyword" id="7893993">range</span>&nbsp;<span class="ident" id="7893999">testCases</span>&nbsp;<span class="op" id="7894009">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894013">m0</span><span class="op" id="7894015">,</span>&nbsp;<span class="ident" id="7894017">err</span>&nbsp;<span class="op" id="7894021">:=</span>&nbsp;<span class="ident" id="7894024">decodeFile</span><span class="op" id="7894034">(</span><span class="ident" id="7894035">tc</span>&nbsp;<span class="op" id="7894038">+</span>&nbsp;<span class="string" id="7894040">&#34;.jpeg&#34;</span><span class="op" id="7894047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894051">if</span>&nbsp;<span class="ident" id="7894054">err</span>&nbsp;<span class="op" id="7894058">!=</span>&nbsp;<span class="ident" id="7894061">nil</span>&nbsp;<span class="op" id="7894065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894070">t</span><span class="op" id="7894071">.</span><span class="ident" id="7894072">Errorf</span><span class="op" id="7894078">(</span><span class="string" id="7894079">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7894087">,</span>&nbsp;<span class="ident" id="7894089">tc</span><span class="op" id="7894091">+</span><span class="string" id="7894092">&#34;.jpeg&#34;</span><span class="op" id="7894099">,</span>&nbsp;<span class="ident" id="7894101">err</span><span class="op" id="7894104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894109">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894120">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894124">m1</span><span class="op" id="7894126">,</span>&nbsp;<span class="ident" id="7894128">err</span>&nbsp;<span class="op" id="7894132">:=</span>&nbsp;<span class="ident" id="7894135">decodeFile</span><span class="op" id="7894145">(</span><span class="ident" id="7894146">tc</span>&nbsp;<span class="op" id="7894149">+</span>&nbsp;<span class="string" id="7894151">&#34;.progressive.jpeg&#34;</span><span class="op" id="7894170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894174">if</span>&nbsp;<span class="ident" id="7894177">err</span>&nbsp;<span class="op" id="7894181">!=</span>&nbsp;<span class="ident" id="7894184">nil</span>&nbsp;<span class="op" id="7894188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894193">t</span><span class="op" id="7894194">.</span><span class="ident" id="7894195">Errorf</span><span class="op" id="7894201">(</span><span class="string" id="7894202">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7894210">,</span>&nbsp;<span class="ident" id="7894212">tc</span><span class="op" id="7894214">+</span><span class="string" id="7894215">&#34;.progressive.jpeg&#34;</span><span class="op" id="7894234">,</span>&nbsp;<span class="ident" id="7894236">err</span><span class="op" id="7894239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894244">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894255">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894259">if</span>&nbsp;<span class="ident" id="7894262">m0</span><span class="op" id="7894264">.</span><span class="ident" id="7894265">Bounds</span><span class="op" id="7894271">(</span><span class="op" id="7894272">)</span>&nbsp;<span class="op" id="7894274">!=</span>&nbsp;<span class="ident" id="7894277">m1</span><span class="op" id="7894279">.</span><span class="ident" id="7894280">Bounds</span><span class="op" id="7894286">(</span><span class="op" id="7894287">)</span>&nbsp;<span class="op" id="7894289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894294">t</span><span class="op" id="7894295">.</span><span class="ident" id="7894296">Errorf</span><span class="op" id="7894302">(</span><span class="string" id="7894303">&#34;%s:&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7894333">,</span>&nbsp;<span class="ident" id="7894335">tc</span><span class="op" id="7894337">,</span>&nbsp;<span class="ident" id="7894339">m0</span><span class="op" id="7894341">.</span><span class="ident" id="7894342">Bounds</span><span class="op" id="7894348">(</span><span class="op" id="7894349">)</span><span class="op" id="7894350">,</span>&nbsp;<span class="ident" id="7894352">m1</span><span class="op" id="7894354">.</span><span class="ident" id="7894355">Bounds</span><span class="op" id="7894361">(</span><span class="op" id="7894362">)</span><span class="op" id="7894363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894368">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7894383">//&nbsp;All&nbsp;of&nbsp;the&nbsp;video-*.jpeg&nbsp;files&nbsp;are&nbsp;150x103.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894431">if</span>&nbsp;<span class="ident" id="7894434">m0</span><span class="op" id="7894436">.</span><span class="ident" id="7894437">Bounds</span><span class="op" id="7894443">(</span><span class="op" id="7894444">)</span>&nbsp;<span class="op" id="7894446">!=</span>&nbsp;<span class="ident" id="7894449">image</span><span class="op" id="7894454">.</span><span class="ident" id="7894455">Rect</span><span class="op" id="7894459">(</span><span class="num" id="7894460">0</span><span class="op" id="7894461">,</span>&nbsp;<span class="num" id="7894463">0</span><span class="op" id="7894464">,</span>&nbsp;<span class="num" id="7894466">150</span><span class="op" id="7894469">,</span>&nbsp;<span class="num" id="7894471">103</span><span class="op" id="7894474">)</span>&nbsp;<span class="op" id="7894476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894481">t</span><span class="op" id="7894482">.</span><span class="ident" id="7894483">Errorf</span><span class="op" id="7894489">(</span><span class="string" id="7894490">&#34;%s:&nbsp;bad&nbsp;bounds:&nbsp;%v&#34;</span><span class="op" id="7894510">,</span>&nbsp;<span class="ident" id="7894512">tc</span><span class="op" id="7894514">,</span>&nbsp;<span class="ident" id="7894516">m0</span><span class="op" id="7894518">.</span><span class="ident" id="7894519">Bounds</span><span class="op" id="7894525">(</span><span class="op" id="7894526">)</span><span class="op" id="7894527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894532">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894548">switch</span>&nbsp;<span class="ident" id="7894555">m0</span>&nbsp;<span class="op" id="7894558">:=</span>&nbsp;<span class="ident" id="7894561">m0</span><span class="op" id="7894563">.</span><span class="op" id="7894564">(</span><span class="keyword" id="7894565">type</span><span class="op" id="7894569">)</span>&nbsp;<span class="op" id="7894571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894575">case</span>&nbsp;<span class="op" id="7894580">*</span><span class="ident" id="7894581">image</span><span class="op" id="7894586">.</span><span class="ident" id="7894587">YCbCr</span><span class="op" id="7894592">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894597">m1</span>&nbsp;<span class="op" id="7894600">:=</span>&nbsp;<span class="ident" id="7894603">m1</span><span class="op" id="7894605">.</span><span class="op" id="7894606">(</span><span class="op" id="7894607">*</span><span class="ident" id="7894608">image</span><span class="op" id="7894613">.</span><span class="ident" id="7894614">YCbCr</span><span class="op" id="7894619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894624">if</span>&nbsp;<span class="ident" id="7894627">err</span>&nbsp;<span class="op" id="7894631">:=</span>&nbsp;<span class="ident" id="7894634">check</span><span class="op" id="7894639">(</span><span class="ident" id="7894640">m0</span><span class="op" id="7894642">.</span><span class="ident" id="7894643">Bounds</span><span class="op" id="7894649">(</span><span class="op" id="7894650">)</span><span class="op" id="7894651">,</span>&nbsp;<span class="ident" id="7894653">m0</span><span class="op" id="7894655">.</span><span class="ident" id="7894656">Y</span><span class="op" id="7894657">,</span>&nbsp;<span class="ident" id="7894659">m1</span><span class="op" id="7894661">.</span><span class="ident" id="7894662">Y</span><span class="op" id="7894663">,</span>&nbsp;<span class="ident" id="7894665">m0</span><span class="op" id="7894667">.</span><span class="ident" id="7894668">YStride</span><span class="op" id="7894675">,</span>&nbsp;<span class="ident" id="7894677">m1</span><span class="op" id="7894679">.</span><span class="ident" id="7894680">YStride</span><span class="op" id="7894687">)</span><span class="op" id="7894688">;</span>&nbsp;<span class="ident" id="7894690">err</span>&nbsp;<span class="op" id="7894694">!=</span>&nbsp;<span class="ident" id="7894697">nil</span>&nbsp;<span class="op" id="7894701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894707">t</span><span class="op" id="7894708">.</span><span class="ident" id="7894709">Errorf</span><span class="op" id="7894715">(</span><span class="string" id="7894716">&#34;%s&nbsp;(Y):&nbsp;%v&#34;</span><span class="op" id="7894728">,</span>&nbsp;<span class="ident" id="7894730">tc</span><span class="op" id="7894732">,</span>&nbsp;<span class="ident" id="7894734">err</span><span class="op" id="7894737">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894743">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894760">if</span>&nbsp;<span class="ident" id="7894763">err</span>&nbsp;<span class="op" id="7894767">:=</span>&nbsp;<span class="ident" id="7894770">check</span><span class="op" id="7894775">(</span><span class="ident" id="7894776">m0</span><span class="op" id="7894778">.</span><span class="ident" id="7894779">Bounds</span><span class="op" id="7894785">(</span><span class="op" id="7894786">)</span><span class="op" id="7894787">,</span>&nbsp;<span class="ident" id="7894789">m0</span><span class="op" id="7894791">.</span><span class="ident" id="7894792">Cb</span><span class="op" id="7894794">,</span>&nbsp;<span class="ident" id="7894796">m1</span><span class="op" id="7894798">.</span><span class="ident" id="7894799">Cb</span><span class="op" id="7894801">,</span>&nbsp;<span class="ident" id="7894803">m0</span><span class="op" id="7894805">.</span><span class="ident" id="7894806">CStride</span><span class="op" id="7894813">,</span>&nbsp;<span class="ident" id="7894815">m1</span><span class="op" id="7894817">.</span><span class="ident" id="7894818">CStride</span><span class="op" id="7894825">)</span><span class="op" id="7894826">;</span>&nbsp;<span class="ident" id="7894828">err</span>&nbsp;<span class="op" id="7894832">!=</span>&nbsp;<span class="ident" id="7894835">nil</span>&nbsp;<span class="op" id="7894839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894845">t</span><span class="op" id="7894846">.</span><span class="ident" id="7894847">Errorf</span><span class="op" id="7894853">(</span><span class="string" id="7894854">&#34;%s&nbsp;(Cb):&nbsp;%v&#34;</span><span class="op" id="7894867">,</span>&nbsp;<span class="ident" id="7894869">tc</span><span class="op" id="7894871">,</span>&nbsp;<span class="ident" id="7894873">err</span><span class="op" id="7894876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894882">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894899">if</span>&nbsp;<span class="ident" id="7894902">err</span>&nbsp;<span class="op" id="7894906">:=</span>&nbsp;<span class="ident" id="7894909">check</span><span class="op" id="7894914">(</span><span class="ident" id="7894915">m0</span><span class="op" id="7894917">.</span><span class="ident" id="7894918">Bounds</span><span class="op" id="7894924">(</span><span class="op" id="7894925">)</span><span class="op" id="7894926">,</span>&nbsp;<span class="ident" id="7894928">m0</span><span class="op" id="7894930">.</span><span class="ident" id="7894931">Cr</span><span class="op" id="7894933">,</span>&nbsp;<span class="ident" id="7894935">m1</span><span class="op" id="7894937">.</span><span class="ident" id="7894938">Cr</span><span class="op" id="7894940">,</span>&nbsp;<span class="ident" id="7894942">m0</span><span class="op" id="7894944">.</span><span class="ident" id="7894945">CStride</span><span class="op" id="7894952">,</span>&nbsp;<span class="ident" id="7894954">m1</span><span class="op" id="7894956">.</span><span class="ident" id="7894957">CStride</span><span class="op" id="7894964">)</span><span class="op" id="7894965">;</span>&nbsp;<span class="ident" id="7894967">err</span>&nbsp;<span class="op" id="7894971">!=</span>&nbsp;<span class="ident" id="7894974">nil</span>&nbsp;<span class="op" id="7894978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894984">t</span><span class="op" id="7894985">.</span><span class="ident" id="7894986">Errorf</span><span class="op" id="7894992">(</span><span class="string" id="7894993">&#34;%s&nbsp;(Cr):&nbsp;%v&#34;</span><span class="op" id="7895006">,</span>&nbsp;<span class="ident" id="7895008">tc</span><span class="op" id="7895010">,</span>&nbsp;<span class="ident" id="7895012">err</span><span class="op" id="7895015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895021">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895033">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895037">case</span>&nbsp;<span class="op" id="7895042">*</span><span class="ident" id="7895043">image</span><span class="op" id="7895048">.</span><span class="ident" id="7895049">Gray</span><span class="op" id="7895053">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895058">m1</span>&nbsp;<span class="op" id="7895061">:=</span>&nbsp;<span class="ident" id="7895064">m1</span><span class="op" id="7895066">.</span><span class="op" id="7895067">(</span><span class="op" id="7895068">*</span><span class="ident" id="7895069">image</span><span class="op" id="7895074">.</span><span class="ident" id="7895075">Gray</span><span class="op" id="7895079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895084">if</span>&nbsp;<span class="ident" id="7895087">err</span>&nbsp;<span class="op" id="7895091">:=</span>&nbsp;<span class="ident" id="7895094">check</span><span class="op" id="7895099">(</span><span class="ident" id="7895100">m0</span><span class="op" id="7895102">.</span><span class="ident" id="7895103">Bounds</span><span class="op" id="7895109">(</span><span class="op" id="7895110">)</span><span class="op" id="7895111">,</span>&nbsp;<span class="ident" id="7895113">m0</span><span class="op" id="7895115">.</span><span class="ident" id="7895116">Pix</span><span class="op" id="7895119">,</span>&nbsp;<span class="ident" id="7895121">m1</span><span class="op" id="7895123">.</span><span class="ident" id="7895124">Pix</span><span class="op" id="7895127">,</span>&nbsp;<span class="ident" id="7895129">m0</span><span class="op" id="7895131">.</span><span class="ident" id="7895132">Stride</span><span class="op" id="7895138">,</span>&nbsp;<span class="ident" id="7895140">m1</span><span class="op" id="7895142">.</span><span class="ident" id="7895143">Stride</span><span class="op" id="7895149">)</span><span class="op" id="7895150">;</span>&nbsp;<span class="ident" id="7895152">err</span>&nbsp;<span class="op" id="7895156">!=</span>&nbsp;<span class="ident" id="7895159">nil</span>&nbsp;<span class="op" id="7895163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895169">t</span><span class="op" id="7895170">.</span><span class="ident" id="7895171">Errorf</span><span class="op" id="7895177">(</span><span class="string" id="7895178">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7895186">,</span>&nbsp;<span class="ident" id="7895188">tc</span><span class="op" id="7895190">,</span>&nbsp;<span class="ident" id="7895192">err</span><span class="op" id="7895195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895201">continue</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895217">default</span><span class="op" id="7895224">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895229">t</span><span class="op" id="7895230">.</span><span class="ident" id="7895231">Errorf</span><span class="op" id="7895237">(</span><span class="string" id="7895238">&#34;%s:&nbsp;unexpected&nbsp;image&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7895268">,</span>&nbsp;<span class="ident" id="7895270">tc</span><span class="op" id="7895272">,</span>&nbsp;<span class="ident" id="7895274">m0</span><span class="op" id="7895276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895281">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895292">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895295">}</span><br>
<span class="lineno"></span><span class="op" id="7895297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7895300">func</span>&nbsp;<span class="ident" id="7895305">decodeFile</span><span class="op" id="7895315">(</span><span class="ident" id="7895316">filename</span>&nbsp;<span class="builtintype" id="7895325">string</span><span class="op" id="7895331">)</span>&nbsp;<span class="op" id="7895333">(</span><span class="ident" id="7895334">image</span><span class="op" id="7895339">.</span><span class="ident" id="7895340">Image</span><span class="op" id="7895345">,</span>&nbsp;<span class="builtintype" id="7895347">error</span><span class="op" id="7895352">)</span>&nbsp;<span class="op" id="7895354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895357">f</span><span class="op" id="7895358">,</span>&nbsp;<span class="ident" id="7895360">err</span>&nbsp;<span class="op" id="7895364">:=</span>&nbsp;<span class="ident" id="7895367">os</span><span class="op" id="7895369">.</span><span class="ident" id="7895370">Open</span><span class="op" id="7895374">(</span><span class="ident" id="7895375">filename</span><span class="op" id="7895383">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895386">if</span>&nbsp;<span class="ident" id="7895389">err</span>&nbsp;<span class="op" id="7895393">!=</span>&nbsp;<span class="ident" id="7895396">nil</span>&nbsp;<span class="op" id="7895400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895404">return</span>&nbsp;<span class="ident" id="7895411">nil</span><span class="op" id="7895414">,</span>&nbsp;<span class="ident" id="7895416">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895424">defer</span>&nbsp;<span class="ident" id="7895430">f</span><span class="op" id="7895431">.</span><span class="ident" id="7895432">Close</span><span class="op" id="7895437">(</span><span class="op" id="7895438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895441">return</span>&nbsp;<span class="ident" id="7895448">Decode</span><span class="op" id="7895454">(</span><span class="ident" id="7895455">f</span><span class="op" id="7895456">)</span><br>
<span class="lineno">90</span><span class="op" id="7895458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7895461">type</span>&nbsp;<span class="ident" id="7895466">eofReader</span>&nbsp;<span class="keyword" id="7895476">struct</span>&nbsp;<span class="op" id="7895483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895486">data</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7895495">[</span><span class="op" id="7895496">]</span><span class="builtintype" id="7895497">byte</span>&nbsp;<span class="comment" id="7895502">//&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;without&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895536">dataEOF</span>&nbsp;&nbsp;<span class="op" id="7895545">[</span><span class="op" id="7895546">]</span><span class="builtintype" id="7895547">byte</span>&nbsp;<span class="comment" id="7895552">//&nbsp;then&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;with&nbsp;EOF&nbsp;on&nbsp;last&nbsp;chunk</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895602">lenAtEOF</span>&nbsp;<span class="builtintype" id="7895611">int</span><br>
<span class="lineno"></span><span class="op" id="7895615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7895618">func</span>&nbsp;<span class="op" id="7895623">(</span><span class="ident" id="7895624">r</span>&nbsp;<span class="op" id="7895626">*</span><span class="ident" id="7895627">eofReader</span><span class="op" id="7895636">)</span>&nbsp;<span class="ident" id="7895638">Read</span><span class="op" id="7895642">(</span><span class="ident" id="7895643">b</span>&nbsp;<span class="op" id="7895645">[</span><span class="op" id="7895646">]</span><span class="builtintype" id="7895647">byte</span><span class="op" id="7895651">)</span>&nbsp;<span class="op" id="7895653">(</span><span class="ident" id="7895654">n</span>&nbsp;<span class="builtintype" id="7895656">int</span><span class="op" id="7895659">,</span>&nbsp;<span class="ident" id="7895661">err</span>&nbsp;<span class="builtintype" id="7895665">error</span><span class="op" id="7895670">)</span>&nbsp;<span class="op" id="7895672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895675">if</span>&nbsp;<span class="builtinfunc" id="7895678">len</span><span class="op" id="7895681">(</span><span class="ident" id="7895682">r</span><span class="op" id="7895683">.</span><span class="ident" id="7895684">data</span><span class="op" id="7895688">)</span>&nbsp;<span class="op" id="7895690">&gt;</span>&nbsp;<span class="num" id="7895692">0</span>&nbsp;<span class="op" id="7895694">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895698">n</span>&nbsp;<span class="op" id="7895700">=</span>&nbsp;<span class="builtinfunc" id="7895702">copy</span><span class="op" id="7895706">(</span><span class="ident" id="7895707">b</span><span class="op" id="7895708">,</span>&nbsp;<span class="ident" id="7895710">r</span><span class="op" id="7895711">.</span><span class="ident" id="7895712">data</span><span class="op" id="7895716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895720">r</span><span class="op" id="7895721">.</span><span class="ident" id="7895722">data</span>&nbsp;<span class="op" id="7895727">=</span>&nbsp;<span class="ident" id="7895729">r</span><span class="op" id="7895730">.</span><span class="ident" id="7895731">data</span><span class="op" id="7895735">[</span><span class="ident" id="7895736">n</span><span class="op" id="7895737">:</span><span class="op" id="7895738">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895741">}</span>&nbsp;<span class="keyword" id="7895743">else</span>&nbsp;<span class="op" id="7895748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895752">n</span>&nbsp;<span class="op" id="7895754">=</span>&nbsp;<span class="builtinfunc" id="7895756">copy</span><span class="op" id="7895760">(</span><span class="ident" id="7895761">b</span><span class="op" id="7895762">,</span>&nbsp;<span class="ident" id="7895764">r</span><span class="op" id="7895765">.</span><span class="ident" id="7895766">dataEOF</span><span class="op" id="7895773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895777">r</span><span class="op" id="7895778">.</span><span class="ident" id="7895779">dataEOF</span>&nbsp;<span class="op" id="7895787">=</span>&nbsp;<span class="ident" id="7895789">r</span><span class="op" id="7895790">.</span><span class="ident" id="7895791">dataEOF</span><span class="op" id="7895798">[</span><span class="ident" id="7895799">n</span><span class="op" id="7895800">:</span><span class="op" id="7895801">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895805">if</span>&nbsp;<span class="builtinfunc" id="7895808">len</span><span class="op" id="7895811">(</span><span class="ident" id="7895812">r</span><span class="op" id="7895813">.</span><span class="ident" id="7895814">dataEOF</span><span class="op" id="7895821">)</span>&nbsp;<span class="op" id="7895823">==</span>&nbsp;<span class="num" id="7895826">0</span>&nbsp;<span class="op" id="7895828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895833">err</span>&nbsp;<span class="op" id="7895837">=</span>&nbsp;<span class="ident" id="7895839">io</span><span class="op" id="7895841">.</span><span class="ident" id="7895842">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895849">if</span>&nbsp;<span class="ident" id="7895852">r</span><span class="op" id="7895853">.</span><span class="ident" id="7895854">lenAtEOF</span>&nbsp;<span class="op" id="7895863">==</span>&nbsp;<span class="op" id="7895866">-</span><span class="num" id="7895867">1</span>&nbsp;<span class="op" id="7895869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895875">r</span><span class="op" id="7895876">.</span><span class="ident" id="7895877">lenAtEOF</span>&nbsp;<span class="op" id="7895886">=</span>&nbsp;<span class="ident" id="7895888">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895893">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895903">return</span><br>
<span class="lineno"></span><span class="op" id="7895910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="7895913">func</span>&nbsp;<span class="ident" id="7895918">TestDecodeEOF</span><span class="op" id="7895931">(</span><span class="ident" id="7895932">t</span>&nbsp;<span class="op" id="7895934">*</span><span class="ident" id="7895935">testing</span><span class="op" id="7895942">.</span><span class="ident" id="7895943">T</span><span class="op" id="7895944">)</span>&nbsp;<span class="op" id="7895946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7895949">//&nbsp;Check&nbsp;that&nbsp;if&nbsp;reader&nbsp;returns&nbsp;final&nbsp;data&nbsp;and&nbsp;EOF&nbsp;at&nbsp;same&nbsp;time,&nbsp;jpeg&nbsp;handles&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896032">data</span><span class="op" id="7896036">,</span>&nbsp;<span class="ident" id="7896038">err</span>&nbsp;<span class="op" id="7896042">:=</span>&nbsp;<span class="ident" id="7896045">ioutil</span><span class="op" id="7896051">.</span><span class="ident" id="7896052">ReadFile</span><span class="op" id="7896060">(</span><span class="string" id="7896061">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7896089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896092">if</span>&nbsp;<span class="ident" id="7896095">err</span>&nbsp;<span class="op" id="7896099">!=</span>&nbsp;<span class="ident" id="7896102">nil</span>&nbsp;<span class="op" id="7896106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896110">t</span><span class="op" id="7896111">.</span><span class="ident" id="7896112">Fatal</span><span class="op" id="7896117">(</span><span class="ident" id="7896118">err</span><span class="op" id="7896121">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896128">n</span>&nbsp;<span class="op" id="7896130">:=</span>&nbsp;<span class="builtinfunc" id="7896133">len</span><span class="op" id="7896136">(</span><span class="ident" id="7896137">data</span><span class="op" id="7896141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896144">for</span>&nbsp;<span class="ident" id="7896148">i</span>&nbsp;<span class="op" id="7896150">:=</span>&nbsp;<span class="num" id="7896153">0</span><span class="op" id="7896154">;</span>&nbsp;<span class="ident" id="7896156">i</span>&nbsp;<span class="op" id="7896158">&lt;</span>&nbsp;<span class="ident" id="7896160">n</span><span class="op" id="7896161">;</span>&nbsp;<span class="op" id="7896163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896167">r</span>&nbsp;<span class="op" id="7896169">:=</span>&nbsp;<span class="op" id="7896172">&amp;</span><span class="ident" id="7896173">eofReader</span><span class="op" id="7896182">{</span><span class="ident" id="7896183">data</span><span class="op" id="7896187">[</span><span class="op" id="7896188">:</span><span class="ident" id="7896189">n</span><span class="op" id="7896190">-</span><span class="ident" id="7896191">i</span><span class="op" id="7896192">]</span><span class="op" id="7896193">,</span>&nbsp;<span class="ident" id="7896195">data</span><span class="op" id="7896199">[</span><span class="ident" id="7896200">n</span><span class="op" id="7896201">-</span><span class="ident" id="7896202">i</span><span class="op" id="7896203">:</span><span class="op" id="7896204">]</span><span class="op" id="7896205">,</span>&nbsp;<span class="op" id="7896207">-</span><span class="num" id="7896208">1</span><span class="op" id="7896209">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896213">_</span><span class="op" id="7896214">,</span>&nbsp;<span class="ident" id="7896216">err</span>&nbsp;<span class="op" id="7896220">:=</span>&nbsp;<span class="ident" id="7896223">Decode</span><span class="op" id="7896229">(</span><span class="ident" id="7896230">r</span><span class="op" id="7896231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896235">if</span>&nbsp;<span class="ident" id="7896238">err</span>&nbsp;<span class="op" id="7896242">!=</span>&nbsp;<span class="ident" id="7896245">nil</span>&nbsp;<span class="op" id="7896249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896254">t</span><span class="op" id="7896255">.</span><span class="ident" id="7896256">Errorf</span><span class="op" id="7896262">(</span><span class="string" id="7896263">&#34;Decode&nbsp;with&nbsp;Read()&nbsp;=&nbsp;%d,&nbsp;EOF:&nbsp;%v&#34;</span><span class="op" id="7896297">,</span>&nbsp;<span class="ident" id="7896299">r</span><span class="op" id="7896300">.</span><span class="ident" id="7896301">lenAtEOF</span><span class="op" id="7896309">,</span>&nbsp;<span class="ident" id="7896311">err</span><span class="op" id="7896314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896322">if</span>&nbsp;<span class="ident" id="7896325">i</span>&nbsp;<span class="op" id="7896327">==</span>&nbsp;<span class="num" id="7896330">0</span>&nbsp;<span class="op" id="7896332">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896337">i</span>&nbsp;<span class="op" id="7896339">=</span>&nbsp;<span class="num" id="7896341">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896345">}</span>&nbsp;<span class="keyword" id="7896347">else</span>&nbsp;<span class="op" id="7896352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896357">i</span>&nbsp;<span class="op" id="7896359">*=</span>&nbsp;<span class="num" id="7896362">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896369">}</span><br>
<span class="lineno">135</span><span class="op" id="7896371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7896374">//&nbsp;check&nbsp;checks&nbsp;that&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;are&nbsp;equal,&nbsp;within&nbsp;the&nbsp;given&nbsp;bounds.</span><br>
<span class="lineno"></span><span class="keyword" id="7896448">func</span>&nbsp;<span class="ident" id="7896453">check</span><span class="op" id="7896458">(</span><span class="ident" id="7896459">bounds</span>&nbsp;<span class="ident" id="7896466">image</span><span class="op" id="7896471">.</span><span class="ident" id="7896472">Rectangle</span><span class="op" id="7896481">,</span>&nbsp;<span class="ident" id="7896483">pix0</span><span class="op" id="7896487">,</span>&nbsp;<span class="ident" id="7896489">pix1</span>&nbsp;<span class="op" id="7896494">[</span><span class="op" id="7896495">]</span><span class="builtintype" id="7896496">byte</span><span class="op" id="7896500">,</span>&nbsp;<span class="ident" id="7896502">stride0</span><span class="op" id="7896509">,</span>&nbsp;<span class="ident" id="7896511">stride1</span>&nbsp;<span class="builtintype" id="7896519">int</span><span class="op" id="7896522">)</span>&nbsp;<span class="builtintype" id="7896524">error</span>&nbsp;<span class="op" id="7896530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896533">if</span>&nbsp;<span class="ident" id="7896536">stride0</span>&nbsp;<span class="op" id="7896544">&lt;=</span>&nbsp;<span class="num" id="7896547">0</span>&nbsp;<span class="op" id="7896549">||</span>&nbsp;<span class="ident" id="7896552">stride0</span><span class="op" id="7896559">%</span><span class="num" id="7896560">8</span>&nbsp;<span class="op" id="7896562">!=</span>&nbsp;<span class="num" id="7896565">0</span>&nbsp;<span class="op" id="7896567">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896571">return</span>&nbsp;<span class="ident" id="7896578">fmt</span><span class="op" id="7896581">.</span><span class="ident" id="7896582">Errorf</span><span class="op" id="7896588">(</span><span class="string" id="7896589">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7896604">,</span>&nbsp;<span class="ident" id="7896606">stride0</span><span class="op" id="7896613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896619">if</span>&nbsp;<span class="ident" id="7896622">stride1</span>&nbsp;<span class="op" id="7896630">&lt;=</span>&nbsp;<span class="num" id="7896633">0</span>&nbsp;<span class="op" id="7896635">||</span>&nbsp;<span class="ident" id="7896638">stride1</span><span class="op" id="7896645">%</span><span class="num" id="7896646">8</span>&nbsp;<span class="op" id="7896648">!=</span>&nbsp;<span class="num" id="7896651">0</span>&nbsp;<span class="op" id="7896653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896657">return</span>&nbsp;<span class="ident" id="7896664">fmt</span><span class="op" id="7896667">.</span><span class="ident" id="7896668">Errorf</span><span class="op" id="7896674">(</span><span class="string" id="7896675">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7896690">,</span>&nbsp;<span class="ident" id="7896692">stride1</span><span class="op" id="7896699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896702">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7896705">//&nbsp;Compare&nbsp;the&nbsp;two&nbsp;pix&nbsp;data,&nbsp;one&nbsp;8x8&nbsp;block&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896760">for</span>&nbsp;<span class="ident" id="7896764">y</span>&nbsp;<span class="op" id="7896766">:=</span>&nbsp;<span class="num" id="7896769">0</span><span class="op" id="7896770">;</span>&nbsp;<span class="ident" id="7896772">y</span>&nbsp;<span class="op" id="7896774">&lt;</span>&nbsp;<span class="builtinfunc" id="7896776">len</span><span class="op" id="7896779">(</span><span class="ident" id="7896780">pix0</span><span class="op" id="7896784">)</span><span class="op" id="7896785">/</span><span class="ident" id="7896786">stride0</span>&nbsp;<span class="op" id="7896794">&amp;&amp;</span>&nbsp;<span class="ident" id="7896797">y</span>&nbsp;<span class="op" id="7896799">&lt;</span>&nbsp;<span class="builtinfunc" id="7896801">len</span><span class="op" id="7896804">(</span><span class="ident" id="7896805">pix1</span><span class="op" id="7896809">)</span><span class="op" id="7896810">/</span><span class="ident" id="7896811">stride1</span><span class="op" id="7896818">;</span>&nbsp;<span class="ident" id="7896820">y</span>&nbsp;<span class="op" id="7896822">+=</span>&nbsp;<span class="num" id="7896825">8</span>&nbsp;<span class="op" id="7896827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896831">for</span>&nbsp;<span class="ident" id="7896835">x</span>&nbsp;<span class="op" id="7896837">:=</span>&nbsp;<span class="num" id="7896840">0</span><span class="op" id="7896841">;</span>&nbsp;<span class="ident" id="7896843">x</span>&nbsp;<span class="op" id="7896845">&lt;</span>&nbsp;<span class="ident" id="7896847">stride0</span>&nbsp;<span class="op" id="7896855">&amp;&amp;</span>&nbsp;<span class="ident" id="7896858">x</span>&nbsp;<span class="op" id="7896860">&lt;</span>&nbsp;<span class="ident" id="7896862">stride1</span><span class="op" id="7896869">;</span>&nbsp;<span class="ident" id="7896871">x</span>&nbsp;<span class="op" id="7896873">+=</span>&nbsp;<span class="num" id="7896876">8</span>&nbsp;<span class="op" id="7896878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896883">if</span>&nbsp;<span class="ident" id="7896886">x</span>&nbsp;<span class="op" id="7896888">&gt;=</span>&nbsp;<span class="ident" id="7896891">bounds</span><span class="op" id="7896897">.</span><span class="ident" id="7896898">Max</span><span class="op" id="7896901">.</span><span class="ident" id="7896902">X</span>&nbsp;<span class="op" id="7896904">||</span>&nbsp;<span class="ident" id="7896907">y</span>&nbsp;<span class="op" id="7896909">&gt;=</span>&nbsp;<span class="ident" id="7896912">bounds</span><span class="op" id="7896918">.</span><span class="ident" id="7896919">Max</span><span class="op" id="7896922">.</span><span class="ident" id="7896923">Y</span>&nbsp;<span class="op" id="7896925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7896931">//&nbsp;We&nbsp;don&#39;t&nbsp;care&nbsp;if&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;differ&nbsp;if&nbsp;the&nbsp;8x8&nbsp;block&nbsp;is</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7896999">//&nbsp;entirely&nbsp;outside&nbsp;of&nbsp;the&nbsp;image&#39;s&nbsp;bounds.&nbsp;For&nbsp;example,&nbsp;this&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7897068">//&nbsp;occur&nbsp;with&nbsp;a&nbsp;4:2:0&nbsp;chroma&nbsp;subsampling&nbsp;and&nbsp;a&nbsp;1x1&nbsp;image.&nbsp;Baseline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7897139">//&nbsp;decoding&nbsp;works&nbsp;on&nbsp;the&nbsp;one&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole;&nbsp;progressive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7897206">//&nbsp;decoding&#39;s&nbsp;first&nbsp;pass&nbsp;works&nbsp;on&nbsp;that&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7897274">//&nbsp;refinement&nbsp;passes&nbsp;only&nbsp;process&nbsp;one&nbsp;8x8&nbsp;block&nbsp;within&nbsp;the&nbsp;MCU.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897342">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897360">for</span>&nbsp;<span class="ident" id="7897364">j</span>&nbsp;<span class="op" id="7897366">:=</span>&nbsp;<span class="num" id="7897369">0</span><span class="op" id="7897370">;</span>&nbsp;<span class="ident" id="7897372">j</span>&nbsp;<span class="op" id="7897374">&lt;</span>&nbsp;<span class="num" id="7897376">8</span><span class="op" id="7897377">;</span>&nbsp;<span class="ident" id="7897379">j</span><span class="op" id="7897380">++</span>&nbsp;<span class="op" id="7897383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897389">for</span>&nbsp;<span class="ident" id="7897393">i</span>&nbsp;<span class="op" id="7897395">:=</span>&nbsp;<span class="num" id="7897398">0</span><span class="op" id="7897399">;</span>&nbsp;<span class="ident" id="7897401">i</span>&nbsp;<span class="op" id="7897403">&lt;</span>&nbsp;<span class="num" id="7897405">8</span><span class="op" id="7897406">;</span>&nbsp;<span class="ident" id="7897408">i</span><span class="op" id="7897409">++</span>&nbsp;<span class="op" id="7897412">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897419">index0</span>&nbsp;<span class="op" id="7897426">:=</span>&nbsp;<span class="op" id="7897429">(</span><span class="ident" id="7897430">y</span><span class="op" id="7897431">+</span><span class="ident" id="7897432">j</span><span class="op" id="7897433">)</span><span class="op" id="7897434">*</span><span class="ident" id="7897435">stride0</span>&nbsp;<span class="op" id="7897443">+</span>&nbsp;<span class="op" id="7897445">(</span><span class="ident" id="7897446">x</span>&nbsp;<span class="op" id="7897448">+</span>&nbsp;<span class="ident" id="7897450">i</span><span class="op" id="7897451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897458">index1</span>&nbsp;<span class="op" id="7897465">:=</span>&nbsp;<span class="op" id="7897468">(</span><span class="ident" id="7897469">y</span><span class="op" id="7897470">+</span><span class="ident" id="7897471">j</span><span class="op" id="7897472">)</span><span class="op" id="7897473">*</span><span class="ident" id="7897474">stride1</span>&nbsp;<span class="op" id="7897482">+</span>&nbsp;<span class="op" id="7897484">(</span><span class="ident" id="7897485">x</span>&nbsp;<span class="op" id="7897487">+</span>&nbsp;<span class="ident" id="7897489">i</span><span class="op" id="7897490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897497">if</span>&nbsp;<span class="ident" id="7897500">pix0</span><span class="op" id="7897504">[</span><span class="ident" id="7897505">index0</span><span class="op" id="7897511">]</span>&nbsp;<span class="op" id="7897513">!=</span>&nbsp;<span class="ident" id="7897516">pix1</span><span class="op" id="7897520">[</span><span class="ident" id="7897521">index1</span><span class="op" id="7897527">]</span>&nbsp;<span class="op" id="7897529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897537">return</span>&nbsp;<span class="ident" id="7897544">fmt</span><span class="op" id="7897547">.</span><span class="ident" id="7897548">Errorf</span><span class="op" id="7897554">(</span><span class="string" id="7897555">&#34;blocks&nbsp;at&nbsp;(%d,&nbsp;%d)&nbsp;differ:\n%sand\n%s&#34;</span><span class="op" id="7897594">,</span>&nbsp;<span class="ident" id="7897596">x</span><span class="op" id="7897597">,</span>&nbsp;<span class="ident" id="7897599">y</span><span class="op" id="7897600">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897609">pixString</span><span class="op" id="7897618">(</span><span class="ident" id="7897619">pix0</span><span class="op" id="7897623">,</span>&nbsp;<span class="ident" id="7897625">stride0</span><span class="op" id="7897632">,</span>&nbsp;<span class="ident" id="7897634">x</span><span class="op" id="7897635">,</span>&nbsp;<span class="ident" id="7897637">y</span><span class="op" id="7897638">)</span><span class="op" id="7897639">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897648">pixString</span><span class="op" id="7897657">(</span><span class="ident" id="7897658">pix1</span><span class="op" id="7897662">,</span>&nbsp;<span class="ident" id="7897664">stride1</span><span class="op" id="7897671">,</span>&nbsp;<span class="ident" id="7897673">x</span><span class="op" id="7897674">,</span>&nbsp;<span class="ident" id="7897676">y</span><span class="op" id="7897677">)</span><span class="op" id="7897678">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897704">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897714">return</span>&nbsp;<span class="ident" id="7897721">nil</span><br>
<span class="lineno"></span><span class="op" id="7897725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="7897728">func</span>&nbsp;<span class="ident" id="7897733">pixString</span><span class="op" id="7897742">(</span><span class="ident" id="7897743">pix</span>&nbsp;<span class="op" id="7897747">[</span><span class="op" id="7897748">]</span><span class="builtintype" id="7897749">byte</span><span class="op" id="7897753">,</span>&nbsp;<span class="ident" id="7897755">stride</span><span class="op" id="7897761">,</span>&nbsp;<span class="ident" id="7897763">x</span><span class="op" id="7897764">,</span>&nbsp;<span class="ident" id="7897766">y</span>&nbsp;<span class="builtintype" id="7897768">int</span><span class="op" id="7897771">)</span>&nbsp;<span class="builtintype" id="7897773">string</span>&nbsp;<span class="op" id="7897780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897783">s</span>&nbsp;<span class="op" id="7897785">:=</span>&nbsp;<span class="ident" id="7897788">bytes</span><span class="op" id="7897793">.</span><span class="ident" id="7897794">NewBuffer</span><span class="op" id="7897803">(</span><span class="ident" id="7897804">nil</span><span class="op" id="7897807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897810">for</span>&nbsp;<span class="ident" id="7897814">j</span>&nbsp;<span class="op" id="7897816">:=</span>&nbsp;<span class="num" id="7897819">0</span><span class="op" id="7897820">;</span>&nbsp;<span class="ident" id="7897822">j</span>&nbsp;<span class="op" id="7897824">&lt;</span>&nbsp;<span class="num" id="7897826">8</span><span class="op" id="7897827">;</span>&nbsp;<span class="ident" id="7897829">j</span><span class="op" id="7897830">++</span>&nbsp;<span class="op" id="7897833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897837">fmt</span><span class="op" id="7897840">.</span><span class="ident" id="7897841">Fprintf</span><span class="op" id="7897848">(</span><span class="ident" id="7897849">s</span><span class="op" id="7897850">,</span>&nbsp;<span class="string" id="7897852">&#34;\t&#34;</span><span class="op" id="7897856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897860">for</span>&nbsp;<span class="ident" id="7897864">i</span>&nbsp;<span class="op" id="7897866">:=</span>&nbsp;<span class="num" id="7897869">0</span><span class="op" id="7897870">;</span>&nbsp;<span class="ident" id="7897872">i</span>&nbsp;<span class="op" id="7897874">&lt;</span>&nbsp;<span class="num" id="7897876">8</span><span class="op" id="7897877">;</span>&nbsp;<span class="ident" id="7897879">i</span><span class="op" id="7897880">++</span>&nbsp;<span class="op" id="7897883">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897888">fmt</span><span class="op" id="7897891">.</span><span class="ident" id="7897892">Fprintf</span><span class="op" id="7897899">(</span><span class="ident" id="7897900">s</span><span class="op" id="7897901">,</span>&nbsp;<span class="string" id="7897903">&#34;%02x&nbsp;&#34;</span><span class="op" id="7897910">,</span>&nbsp;<span class="ident" id="7897912">pix</span><span class="op" id="7897915">[</span><span class="op" id="7897916">(</span><span class="ident" id="7897917">y</span><span class="op" id="7897918">+</span><span class="ident" id="7897919">j</span><span class="op" id="7897920">)</span><span class="op" id="7897921">*</span><span class="ident" id="7897922">stride</span><span class="op" id="7897928">+</span><span class="op" id="7897929">(</span><span class="ident" id="7897930">x</span><span class="op" id="7897931">+</span><span class="ident" id="7897932">i</span><span class="op" id="7897933">)</span><span class="op" id="7897934">]</span><span class="op" id="7897935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897943">fmt</span><span class="op" id="7897946">.</span><span class="ident" id="7897947">Fprintf</span><span class="op" id="7897954">(</span><span class="ident" id="7897955">s</span><span class="op" id="7897956">,</span>&nbsp;<span class="string" id="7897958">&#34;\n&#34;</span><span class="op" id="7897962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897968">return</span>&nbsp;<span class="ident" id="7897975">s</span><span class="op" id="7897976">.</span><span class="ident" id="7897977">String</span><span class="op" id="7897983">(</span><span class="op" id="7897984">)</span><br>
<span class="lineno">185</span><span class="op" id="7897986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7897989">func</span>&nbsp;<span class="ident" id="7897994">TestExtraneousData</span><span class="op" id="7898012">(</span><span class="ident" id="7898013">t</span>&nbsp;<span class="op" id="7898015">*</span><span class="ident" id="7898016">testing</span><span class="op" id="7898023">.</span><span class="ident" id="7898024">T</span><span class="op" id="7898025">)</span>&nbsp;<span class="op" id="7898027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7898030">//&nbsp;Encode&nbsp;a&nbsp;1x1&nbsp;red&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898058">src</span>&nbsp;<span class="op" id="7898062">:=</span>&nbsp;<span class="ident" id="7898065">image</span><span class="op" id="7898070">.</span><span class="ident" id="7898071">NewRGBA</span><span class="op" id="7898078">(</span><span class="ident" id="7898079">image</span><span class="op" id="7898084">.</span><span class="ident" id="7898085">Rect</span><span class="op" id="7898089">(</span><span class="num" id="7898090">0</span><span class="op" id="7898091">,</span>&nbsp;<span class="num" id="7898093">0</span><span class="op" id="7898094">,</span>&nbsp;<span class="num" id="7898096">1</span><span class="op" id="7898097">,</span>&nbsp;<span class="num" id="7898099">1</span><span class="op" id="7898100">)</span><span class="op" id="7898101">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898104">src</span><span class="op" id="7898107">.</span><span class="ident" id="7898108">Set</span><span class="op" id="7898111">(</span><span class="num" id="7898112">0</span><span class="op" id="7898113">,</span>&nbsp;<span class="num" id="7898115">0</span><span class="op" id="7898116">,</span>&nbsp;<span class="ident" id="7898118">color</span><span class="op" id="7898123">.</span><span class="ident" id="7898124">RGBA</span><span class="op" id="7898128">{</span><span class="num" id="7898129">0xff</span><span class="op" id="7898133">,</span>&nbsp;<span class="num" id="7898135">0x00</span><span class="op" id="7898139">,</span>&nbsp;<span class="num" id="7898141">0x00</span><span class="op" id="7898145">,</span>&nbsp;<span class="num" id="7898147">0xff</span><span class="op" id="7898151">}</span><span class="op" id="7898152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898155">buf</span>&nbsp;<span class="op" id="7898159">:=</span>&nbsp;<span class="builtinfunc" id="7898162">new</span><span class="op" id="7898165">(</span><span class="ident" id="7898166">bytes</span><span class="op" id="7898171">.</span><span class="ident" id="7898172">Buffer</span><span class="op" id="7898178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898181">if</span>&nbsp;<span class="ident" id="7898184">err</span>&nbsp;<span class="op" id="7898188">:=</span>&nbsp;<span class="ident" id="7898191">Encode</span><span class="op" id="7898197">(</span><span class="ident" id="7898198">buf</span><span class="op" id="7898201">,</span>&nbsp;<span class="ident" id="7898203">src</span><span class="op" id="7898206">,</span>&nbsp;<span class="ident" id="7898208">nil</span><span class="op" id="7898211">)</span><span class="op" id="7898212">;</span>&nbsp;<span class="ident" id="7898214">err</span>&nbsp;<span class="op" id="7898218">!=</span>&nbsp;<span class="ident" id="7898221">nil</span>&nbsp;<span class="op" id="7898225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898229">t</span><span class="op" id="7898230">.</span><span class="ident" id="7898231">Fatalf</span><span class="op" id="7898237">(</span><span class="string" id="7898238">&#34;encode:&nbsp;%v&#34;</span><span class="op" id="7898250">,</span>&nbsp;<span class="ident" id="7898252">err</span><span class="op" id="7898255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898258">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898261">enc</span>&nbsp;<span class="op" id="7898265">:=</span>&nbsp;<span class="ident" id="7898268">buf</span><span class="op" id="7898271">.</span><span class="ident" id="7898272">String</span><span class="op" id="7898278">(</span><span class="op" id="7898279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7898282">//&nbsp;Sanity&nbsp;check&nbsp;that&nbsp;the&nbsp;encoded&nbsp;JPEG&nbsp;is&nbsp;long&nbsp;enough,&nbsp;that&nbsp;it&nbsp;ends&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7898355">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker,&nbsp;and&nbsp;that&nbsp;it&nbsp;contains&nbsp;a&nbsp;&#34;\xff\xda&#34;&nbsp;SOS&nbsp;marker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7898427">//&nbsp;somewhere&nbsp;in&nbsp;the&nbsp;final&nbsp;64&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898464">if</span>&nbsp;<span class="builtinfunc" id="7898467">len</span><span class="op" id="7898470">(</span><span class="ident" id="7898471">enc</span><span class="op" id="7898474">)</span>&nbsp;<span class="op" id="7898476">&lt;</span>&nbsp;<span class="num" id="7898478">64</span>&nbsp;<span class="op" id="7898481">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898485">t</span><span class="op" id="7898486">.</span><span class="ident" id="7898487">Fatalf</span><span class="op" id="7898493">(</span><span class="string" id="7898494">&#34;encoded&nbsp;JPEG&nbsp;is&nbsp;too&nbsp;short:&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="7898531">,</span>&nbsp;<span class="builtinfunc" id="7898533">len</span><span class="op" id="7898536">(</span><span class="ident" id="7898537">enc</span><span class="op" id="7898540">)</span><span class="op" id="7898541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898547">if</span>&nbsp;<span class="ident" id="7898550">got</span><span class="op" id="7898553">,</span>&nbsp;<span class="ident" id="7898555">want</span>&nbsp;<span class="op" id="7898560">:=</span>&nbsp;<span class="ident" id="7898563">enc</span><span class="op" id="7898566">[</span><span class="builtinfunc" id="7898567">len</span><span class="op" id="7898570">(</span><span class="ident" id="7898571">enc</span><span class="op" id="7898574">)</span><span class="op" id="7898575">-</span><span class="num" id="7898576">2</span><span class="op" id="7898577">:</span><span class="op" id="7898578">]</span><span class="op" id="7898579">,</span>&nbsp;<span class="string" id="7898581">&#34;\xff\xd9&#34;</span><span class="op" id="7898591">;</span>&nbsp;<span class="ident" id="7898593">got</span>&nbsp;<span class="op" id="7898597">!=</span>&nbsp;<span class="ident" id="7898600">want</span>&nbsp;<span class="op" id="7898605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898609">t</span><span class="op" id="7898610">.</span><span class="ident" id="7898611">Fatalf</span><span class="op" id="7898617">(</span><span class="string" id="7898618">&#34;encoded&nbsp;JPEG&nbsp;ends&nbsp;with&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7898654">,</span>&nbsp;<span class="ident" id="7898656">got</span><span class="op" id="7898659">,</span>&nbsp;<span class="ident" id="7898661">want</span><span class="op" id="7898665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898668">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898671">if</span>&nbsp;<span class="ident" id="7898674">s</span>&nbsp;<span class="op" id="7898676">:=</span>&nbsp;<span class="ident" id="7898679">enc</span><span class="op" id="7898682">[</span><span class="builtinfunc" id="7898683">len</span><span class="op" id="7898686">(</span><span class="ident" id="7898687">enc</span><span class="op" id="7898690">)</span><span class="op" id="7898691">-</span><span class="num" id="7898692">64</span><span class="op" id="7898694">:</span><span class="op" id="7898695">]</span><span class="op" id="7898696">;</span>&nbsp;<span class="op" id="7898698">!</span><span class="ident" id="7898699">strings</span><span class="op" id="7898706">.</span><span class="ident" id="7898707">Contains</span><span class="op" id="7898715">(</span><span class="ident" id="7898716">s</span><span class="op" id="7898717">,</span>&nbsp;<span class="string" id="7898719">&#34;\xff\xda&#34;</span><span class="op" id="7898729">)</span>&nbsp;<span class="op" id="7898731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898735">t</span><span class="op" id="7898736">.</span><span class="ident" id="7898737">Fatalf</span><span class="op" id="7898743">(</span><span class="string" id="7898744">&#34;encoded&nbsp;JPEG&nbsp;does&nbsp;not&nbsp;contain&nbsp;a&nbsp;SOS&nbsp;marker&nbsp;(ff&nbsp;da)&nbsp;near&nbsp;the&nbsp;end:&nbsp;%&nbsp;x&#34;</span><span class="op" id="7898814">,</span>&nbsp;<span class="ident" id="7898816">s</span><span class="op" id="7898817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7898823">//&nbsp;Test&nbsp;that&nbsp;adding&nbsp;some&nbsp;random&nbsp;junk&nbsp;between&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7898892">//&nbsp;EOI&nbsp;marker&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;decoding.</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898937">rnd</span>&nbsp;<span class="op" id="7898941">:=</span>&nbsp;<span class="ident" id="7898944">rand</span><span class="op" id="7898948">.</span><span class="ident" id="7898949">New</span><span class="op" id="7898952">(</span><span class="ident" id="7898953">rand</span><span class="op" id="7898957">.</span><span class="ident" id="7898958">NewSource</span><span class="op" id="7898967">(</span><span class="num" id="7898968">1</span><span class="op" id="7898969">)</span><span class="op" id="7898970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898973">for</span>&nbsp;<span class="ident" id="7898977">i</span><span class="op" id="7898978">,</span>&nbsp;<span class="ident" id="7898980">nerr</span>&nbsp;<span class="op" id="7898985">:=</span>&nbsp;<span class="num" id="7898988">0</span><span class="op" id="7898989">,</span>&nbsp;<span class="num" id="7898991">0</span><span class="op" id="7898992">;</span>&nbsp;<span class="ident" id="7898994">i</span>&nbsp;<span class="op" id="7898996">&lt;</span>&nbsp;<span class="num" id="7898998">1000</span>&nbsp;<span class="op" id="7899003">&amp;&amp;</span>&nbsp;<span class="ident" id="7899006">nerr</span>&nbsp;<span class="op" id="7899011">&lt;</span>&nbsp;<span class="num" id="7899013">10</span><span class="op" id="7899015">;</span>&nbsp;<span class="ident" id="7899017">i</span><span class="op" id="7899018">++</span>&nbsp;<span class="op" id="7899021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899025">buf</span><span class="op" id="7899028">.</span><span class="ident" id="7899029">Reset</span><span class="op" id="7899034">(</span><span class="op" id="7899035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7899039">//&nbsp;Write&nbsp;all&nbsp;but&nbsp;the&nbsp;trailing&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899094">buf</span><span class="op" id="7899097">.</span><span class="ident" id="7899098">WriteString</span><span class="op" id="7899109">(</span><span class="ident" id="7899110">enc</span><span class="op" id="7899113">[</span><span class="op" id="7899114">:</span><span class="builtinfunc" id="7899115">len</span><span class="op" id="7899118">(</span><span class="ident" id="7899119">enc</span><span class="op" id="7899122">)</span><span class="op" id="7899123">-</span><span class="num" id="7899124">2</span><span class="op" id="7899125">]</span><span class="op" id="7899126">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7899130">//&nbsp;Write&nbsp;some&nbsp;random&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899170">for</span>&nbsp;<span class="ident" id="7899174">n</span>&nbsp;<span class="op" id="7899176">:=</span>&nbsp;<span class="ident" id="7899179">rnd</span><span class="op" id="7899182">.</span><span class="ident" id="7899183">Intn</span><span class="op" id="7899187">(</span><span class="num" id="7899188">10</span><span class="op" id="7899190">)</span><span class="op" id="7899191">;</span>&nbsp;<span class="ident" id="7899193">n</span>&nbsp;<span class="op" id="7899195">&gt;</span>&nbsp;<span class="num" id="7899197">0</span><span class="op" id="7899198">;</span>&nbsp;<span class="ident" id="7899200">n</span><span class="op" id="7899201">--</span>&nbsp;<span class="op" id="7899204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899209">if</span>&nbsp;<span class="ident" id="7899212">x</span>&nbsp;<span class="op" id="7899214">:=</span>&nbsp;<span class="builtintype" id="7899217">byte</span><span class="op" id="7899221">(</span><span class="ident" id="7899222">rnd</span><span class="op" id="7899225">.</span><span class="ident" id="7899226">Intn</span><span class="op" id="7899230">(</span><span class="num" id="7899231">256</span><span class="op" id="7899234">)</span><span class="op" id="7899235">)</span><span class="op" id="7899236">;</span>&nbsp;<span class="ident" id="7899238">x</span>&nbsp;<span class="op" id="7899240">!=</span>&nbsp;<span class="num" id="7899243">0xff</span>&nbsp;<span class="op" id="7899248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899254">buf</span><span class="op" id="7899257">.</span><span class="ident" id="7899258">WriteByte</span><span class="op" id="7899267">(</span><span class="ident" id="7899268">x</span><span class="op" id="7899269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899274">}</span>&nbsp;<span class="keyword" id="7899276">else</span>&nbsp;<span class="op" id="7899281">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7899287">//&nbsp;The&nbsp;JPEG&nbsp;format&nbsp;escapes&nbsp;a&nbsp;SOS&nbsp;0xff&nbsp;data&nbsp;byte&nbsp;as&nbsp;&#34;\xff\x00&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899354">buf</span><span class="op" id="7899357">.</span><span class="ident" id="7899358">WriteString</span><span class="op" id="7899369">(</span><span class="string" id="7899370">&#34;\xff\x00&#34;</span><span class="op" id="7899380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7899393">//&nbsp;Write&nbsp;the&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899431">buf</span><span class="op" id="7899434">.</span><span class="ident" id="7899435">WriteString</span><span class="op" id="7899446">(</span><span class="string" id="7899447">&#34;\xff\xd9&#34;</span><span class="op" id="7899457">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7899462">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;can&nbsp;still&nbsp;decode&nbsp;the&nbsp;resultant&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899519">got</span><span class="op" id="7899522">,</span>&nbsp;<span class="ident" id="7899524">err</span>&nbsp;<span class="op" id="7899528">:=</span>&nbsp;<span class="ident" id="7899531">Decode</span><span class="op" id="7899537">(</span><span class="ident" id="7899538">buf</span><span class="op" id="7899541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899545">if</span>&nbsp;<span class="ident" id="7899548">err</span>&nbsp;<span class="op" id="7899552">!=</span>&nbsp;<span class="ident" id="7899555">nil</span>&nbsp;<span class="op" id="7899559">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899564">t</span><span class="op" id="7899565">.</span><span class="ident" id="7899566">Errorf</span><span class="op" id="7899572">(</span><span class="string" id="7899573">&#34;could&nbsp;not&nbsp;decode&nbsp;image&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="7899605">,</span>&nbsp;<span class="ident" id="7899607">i</span><span class="op" id="7899608">,</span>&nbsp;<span class="ident" id="7899610">err</span><span class="op" id="7899613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899618">nerr</span><span class="op" id="7899622">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899628">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899643">if</span>&nbsp;<span class="ident" id="7899646">got</span><span class="op" id="7899649">.</span><span class="ident" id="7899650">Bounds</span><span class="op" id="7899656">(</span><span class="op" id="7899657">)</span>&nbsp;<span class="op" id="7899659">!=</span>&nbsp;<span class="ident" id="7899662">src</span><span class="op" id="7899665">.</span><span class="ident" id="7899666">Bounds</span><span class="op" id="7899672">(</span><span class="op" id="7899673">)</span>&nbsp;<span class="op" id="7899675">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899680">t</span><span class="op" id="7899681">.</span><span class="ident" id="7899682">Errorf</span><span class="op" id="7899688">(</span><span class="string" id="7899689">&#34;image&nbsp;#%d,&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7899726">,</span>&nbsp;<span class="ident" id="7899728">i</span><span class="op" id="7899729">,</span>&nbsp;<span class="ident" id="7899731">got</span><span class="op" id="7899734">.</span><span class="ident" id="7899735">Bounds</span><span class="op" id="7899741">(</span><span class="op" id="7899742">)</span><span class="op" id="7899743">,</span>&nbsp;<span class="ident" id="7899745">src</span><span class="op" id="7899748">.</span><span class="ident" id="7899749">Bounds</span><span class="op" id="7899755">(</span><span class="op" id="7899756">)</span><span class="op" id="7899757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899762">nerr</span><span class="op" id="7899766">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899772">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899787">if</span>&nbsp;<span class="ident" id="7899790">averageDelta</span><span class="op" id="7899802">(</span><span class="ident" id="7899803">got</span><span class="op" id="7899806">,</span>&nbsp;<span class="ident" id="7899808">src</span><span class="op" id="7899811">)</span>&nbsp;<span class="op" id="7899813">&gt;</span>&nbsp;<span class="num" id="7899815">2</span><span class="op" id="7899816">&lt;&lt;</span><span class="num" id="7899818">8</span>&nbsp;<span class="op" id="7899820">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899825">t</span><span class="op" id="7899826">.</span><span class="ident" id="7899827">Errorf</span><span class="op" id="7899833">(</span><span class="string" id="7899834">&#34;image&nbsp;#%d&nbsp;changed&nbsp;too&nbsp;much&nbsp;after&nbsp;a&nbsp;round&nbsp;trip&#34;</span><span class="op" id="7899881">,</span>&nbsp;<span class="ident" id="7899883">i</span><span class="op" id="7899884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899889">nerr</span><span class="op" id="7899893">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899899">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899913">}</span><br>
<span class="lineno">245</span><span class="op" id="7899915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7899918">func</span>&nbsp;<span class="ident" id="7899923">benchmarkDecode</span><span class="op" id="7899938">(</span><span class="ident" id="7899939">b</span>&nbsp;<span class="op" id="7899941">*</span><span class="ident" id="7899942">testing</span><span class="op" id="7899949">.</span><span class="ident" id="7899950">B</span><span class="op" id="7899951">,</span>&nbsp;<span class="ident" id="7899953">filename</span>&nbsp;<span class="builtintype" id="7899962">string</span><span class="op" id="7899968">)</span>&nbsp;<span class="op" id="7899970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899973">b</span><span class="op" id="7899974">.</span><span class="ident" id="7899975">StopTimer</span><span class="op" id="7899984">(</span><span class="op" id="7899985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899988">data</span><span class="op" id="7899992">,</span>&nbsp;<span class="ident" id="7899994">err</span>&nbsp;<span class="op" id="7899998">:=</span>&nbsp;<span class="ident" id="7900001">ioutil</span><span class="op" id="7900007">.</span><span class="ident" id="7900008">ReadFile</span><span class="op" id="7900016">(</span><span class="ident" id="7900017">filename</span><span class="op" id="7900025">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900028">if</span>&nbsp;<span class="ident" id="7900031">err</span>&nbsp;<span class="op" id="7900035">!=</span>&nbsp;<span class="ident" id="7900038">nil</span>&nbsp;<span class="op" id="7900042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900046">b</span><span class="op" id="7900047">.</span><span class="ident" id="7900048">Fatal</span><span class="op" id="7900053">(</span><span class="ident" id="7900054">err</span><span class="op" id="7900057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900063">cfg</span><span class="op" id="7900066">,</span>&nbsp;<span class="ident" id="7900068">err</span>&nbsp;<span class="op" id="7900072">:=</span>&nbsp;<span class="ident" id="7900075">DecodeConfig</span><span class="op" id="7900087">(</span><span class="ident" id="7900088">bytes</span><span class="op" id="7900093">.</span><span class="ident" id="7900094">NewReader</span><span class="op" id="7900103">(</span><span class="ident" id="7900104">data</span><span class="op" id="7900108">)</span><span class="op" id="7900109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900112">if</span>&nbsp;<span class="ident" id="7900115">err</span>&nbsp;<span class="op" id="7900119">!=</span>&nbsp;<span class="ident" id="7900122">nil</span>&nbsp;<span class="op" id="7900126">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900130">b</span><span class="op" id="7900131">.</span><span class="ident" id="7900132">Fatal</span><span class="op" id="7900137">(</span><span class="ident" id="7900138">err</span><span class="op" id="7900141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900147">b</span><span class="op" id="7900148">.</span><span class="ident" id="7900149">SetBytes</span><span class="op" id="7900157">(</span><span class="ident" id="7900158">int64</span><span class="op" id="7900163">(</span><span class="ident" id="7900164">cfg</span><span class="op" id="7900167">.</span><span class="ident" id="7900168">Width</span>&nbsp;<span class="op" id="7900174">*</span>&nbsp;<span class="ident" id="7900176">cfg</span><span class="op" id="7900179">.</span><span class="ident" id="7900180">Height</span>&nbsp;<span class="op" id="7900187">*</span>&nbsp;<span class="num" id="7900189">4</span><span class="op" id="7900190">)</span><span class="op" id="7900191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900194">b</span><span class="op" id="7900195">.</span><span class="ident" id="7900196">StartTimer</span><span class="op" id="7900206">(</span><span class="op" id="7900207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7900210">for</span>&nbsp;<span class="ident" id="7900214">i</span>&nbsp;<span class="op" id="7900216">:=</span>&nbsp;<span class="num" id="7900219">0</span><span class="op" id="7900220">;</span>&nbsp;<span class="ident" id="7900222">i</span>&nbsp;<span class="op" id="7900224">&lt;</span>&nbsp;<span class="ident" id="7900226">b</span><span class="op" id="7900227">.</span><span class="ident" id="7900228">N</span><span class="op" id="7900229">;</span>&nbsp;<span class="ident" id="7900231">i</span><span class="op" id="7900232">++</span>&nbsp;<span class="op" id="7900235">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900239">Decode</span><span class="op" id="7900245">(</span><span class="ident" id="7900246">bytes</span><span class="op" id="7900251">.</span><span class="ident" id="7900252">NewReader</span><span class="op" id="7900261">(</span><span class="ident" id="7900262">data</span><span class="op" id="7900266">)</span><span class="op" id="7900267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7900270">}</span><br>
<span class="lineno"></span><span class="op" id="7900272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7900275">func</span>&nbsp;<span class="ident" id="7900280">BenchmarkDecodeBaseline</span><span class="op" id="7900303">(</span><span class="ident" id="7900304">b</span>&nbsp;<span class="op" id="7900306">*</span><span class="ident" id="7900307">testing</span><span class="op" id="7900314">.</span><span class="ident" id="7900315">B</span><span class="op" id="7900316">)</span>&nbsp;<span class="op" id="7900318">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900321">benchmarkDecode</span><span class="op" id="7900336">(</span><span class="ident" id="7900337">b</span><span class="op" id="7900338">,</span>&nbsp;<span class="string" id="7900340">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7900368">)</span><br>
<span class="lineno"></span><span class="op" id="7900370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7900373">func</span>&nbsp;<span class="ident" id="7900378">BenchmarkDecodeProgressive</span><span class="op" id="7900404">(</span><span class="ident" id="7900405">b</span>&nbsp;<span class="op" id="7900407">*</span><span class="ident" id="7900408">testing</span><span class="op" id="7900415">.</span><span class="ident" id="7900416">B</span><span class="op" id="7900417">)</span>&nbsp;<span class="op" id="7900419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7900422">benchmarkDecode</span><span class="op" id="7900437">(</span><span class="ident" id="7900438">b</span><span class="op" id="7900439">,</span>&nbsp;<span class="string" id="7900441">&#34;../testdata/video-001.progressive.jpeg&#34;</span><span class="op" id="7900481">)</span><br>
<span class="lineno">270</span><span class="op" id="7900483">}</span>
</div>
</body>
</html>
