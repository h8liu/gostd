<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6888411">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6888466">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6888520">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6888571">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="6888634">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="6888698">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6888755">package</span>&nbsp;<span class="ident" id="6888763">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="6888768">import</span>&nbsp;<span class="op" id="6888775">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888778">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888787">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888797">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888804">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888810">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888822">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888843">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888849">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888860">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888871">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6888878">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6888881">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="6888951">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="6889015">func</span>&nbsp;<span class="ident" id="6889020">TestHostingOurselves</span><span class="op" id="6889040">(</span><span class="ident" id="6889041">t</span>&nbsp;<span class="op" id="6889043">*</span><span class="ident" id="6889044">testing</span><span class="op" id="6889051">.</span><span class="ident" id="6889052">T</span><span class="op" id="6889053">)</span>&nbsp;<span class="op" id="6889055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889058">if</span>&nbsp;<span class="ident" id="6889061">runtime</span><span class="op" id="6889068">.</span><span class="ident" id="6889069">GOOS</span>&nbsp;<span class="op" id="6889074">==</span>&nbsp;<span class="string" id="6889077">&#34;nacl&#34;</span>&nbsp;<span class="op" id="6889084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889088">t</span><span class="op" id="6889089">.</span><span class="ident" id="6889090">Skip</span><span class="op" id="6889094">(</span><span class="string" id="6889095">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="6889113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889116">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889120">h</span>&nbsp;<span class="op" id="6889122">:=</span>&nbsp;<span class="op" id="6889125">&amp;</span><span class="ident" id="6889126">Handler</span><span class="op" id="6889133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889137">Path</span><span class="op" id="6889141">:</span>&nbsp;<span class="ident" id="6889143">os</span><span class="op" id="6889145">.</span><span class="ident" id="6889146">Args</span><span class="op" id="6889150">[</span><span class="num" id="6889151">0</span><span class="op" id="6889152">]</span><span class="op" id="6889153">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889157">Root</span><span class="op" id="6889161">:</span>&nbsp;<span class="string" id="6889163">&#34;/test.go&#34;</span><span class="op" id="6889173">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889177">Args</span><span class="op" id="6889181">:</span>&nbsp;<span class="op" id="6889183">[</span><span class="op" id="6889184">]</span><span class="builtintype" id="6889185">string</span><span class="op" id="6889191">{</span><span class="string" id="6889192">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6889225">}</span><span class="op" id="6889226">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889232">expectedMap</span>&nbsp;<span class="op" id="6889244">:=</span>&nbsp;<span class="keyword" id="6889247">map</span><span class="op" id="6889250">[</span><span class="builtintype" id="6889251">string</span><span class="op" id="6889257">]</span><span class="builtintype" id="6889258">string</span><span class="op" id="6889264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889268">&#34;test&#34;</span><span class="op" id="6889274">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6889293">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="6889311">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889315">&#34;param-a&#34;</span><span class="op" id="6889324">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6889340">&#34;b&#34;</span><span class="op" id="6889343">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889347">&#34;param-foo&#34;</span><span class="op" id="6889358">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6889372">&#34;bar&#34;</span><span class="op" id="6889377">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889381">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="6889404">:</span>&nbsp;<span class="string" id="6889406">&#34;CGI/1.1&#34;</span><span class="op" id="6889415">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889419">&#34;env-HTTP_HOST&#34;</span><span class="op" id="6889434">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6889444">&#34;example.com&#34;</span><span class="op" id="6889457">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889461">&#34;env-PATH_INFO&#34;</span><span class="op" id="6889476">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6889486">&#34;&#34;</span><span class="op" id="6889488">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889492">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6889510">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6889517">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="6889530">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889534">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="6889551">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6889559">&#34;1.2.3.4&#34;</span><span class="op" id="6889568">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889572">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="6889589">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6889597">&#34;1.2.3.4&#34;</span><span class="op" id="6889606">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889610">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="6889630">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6889635">&#34;GET&#34;</span><span class="op" id="6889640">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889644">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6889661">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6889669">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="6889691">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889695">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6889716">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6889720">os</span><span class="op" id="6889722">.</span><span class="ident" id="6889723">Args</span><span class="op" id="6889727">[</span><span class="num" id="6889728">0</span><span class="op" id="6889729">]</span><span class="op" id="6889730">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889734">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6889751">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6889759">&#34;/test.go&#34;</span><span class="op" id="6889769">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889773">&#34;env-SERVER_NAME&#34;</span><span class="op" id="6889790">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6889798">&#34;example.com&#34;</span><span class="op" id="6889811">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889815">&#34;env-SERVER_PORT&#34;</span><span class="op" id="6889832">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6889840">&#34;80&#34;</span><span class="op" id="6889844">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6889848">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="6889869">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6889873">&#34;go&#34;</span><span class="op" id="6889877">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6889880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6889883">replay</span>&nbsp;<span class="op" id="6889890">:=</span>&nbsp;<span class="ident" id="6889893">runCgiTest</span><span class="op" id="6889903">(</span><span class="ident" id="6889904">t</span><span class="op" id="6889905">,</span>&nbsp;<span class="ident" id="6889907">h</span><span class="op" id="6889908">,</span>&nbsp;<span class="string" id="6889910">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6889968">,</span>&nbsp;<span class="ident" id="6889970">expectedMap</span><span class="op" id="6889981">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6889985">if</span>&nbsp;<span class="ident" id="6889988">expected</span><span class="op" id="6889996">,</span>&nbsp;<span class="ident" id="6889998">got</span>&nbsp;<span class="op" id="6890002">:=</span>&nbsp;<span class="string" id="6890005">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6890031">,</span>&nbsp;<span class="ident" id="6890033">replay</span><span class="op" id="6890039">.</span><span class="ident" id="6890040">Header</span><span class="op" id="6890046">(</span><span class="op" id="6890047">)</span><span class="op" id="6890048">.</span><span class="ident" id="6890049">Get</span><span class="op" id="6890052">(</span><span class="string" id="6890053">&#34;Content-Type&#34;</span><span class="op" id="6890067">)</span><span class="op" id="6890068">;</span>&nbsp;<span class="ident" id="6890070">got</span>&nbsp;<span class="op" id="6890074">!=</span>&nbsp;<span class="ident" id="6890077">expected</span>&nbsp;<span class="op" id="6890086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890090">t</span><span class="op" id="6890091">.</span><span class="ident" id="6890092">Errorf</span><span class="op" id="6890098">(</span><span class="string" id="6890099">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6890138">,</span>&nbsp;<span class="ident" id="6890140">got</span><span class="op" id="6890143">,</span>&nbsp;<span class="ident" id="6890145">expected</span><span class="op" id="6890153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890159">if</span>&nbsp;<span class="ident" id="6890162">expected</span><span class="op" id="6890170">,</span>&nbsp;<span class="ident" id="6890172">got</span>&nbsp;<span class="op" id="6890176">:=</span>&nbsp;<span class="string" id="6890179">&#34;X-Test-Value&#34;</span><span class="op" id="6890193">,</span>&nbsp;<span class="ident" id="6890195">replay</span><span class="op" id="6890201">.</span><span class="ident" id="6890202">Header</span><span class="op" id="6890208">(</span><span class="op" id="6890209">)</span><span class="op" id="6890210">.</span><span class="ident" id="6890211">Get</span><span class="op" id="6890214">(</span><span class="string" id="6890215">&#34;X-Test-Header&#34;</span><span class="op" id="6890230">)</span><span class="op" id="6890231">;</span>&nbsp;<span class="ident" id="6890233">got</span>&nbsp;<span class="op" id="6890237">!=</span>&nbsp;<span class="ident" id="6890240">expected</span>&nbsp;<span class="op" id="6890249">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890253">t</span><span class="op" id="6890254">.</span><span class="ident" id="6890255">Errorf</span><span class="op" id="6890261">(</span><span class="string" id="6890262">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6890302">,</span>&nbsp;<span class="ident" id="6890304">got</span><span class="op" id="6890307">,</span>&nbsp;<span class="ident" id="6890309">expected</span><span class="op" id="6890317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890320">}</span><br>
<span class="lineno"></span><span class="op" id="6890322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6890325">type</span>&nbsp;<span class="ident" id="6890330">customWriterRecorder</span>&nbsp;<span class="keyword" id="6890351">struct</span>&nbsp;<span class="op" id="6890358">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890361">w</span>&nbsp;<span class="ident" id="6890363">io</span><span class="op" id="6890365">.</span><span class="ident" id="6890366">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890374">*</span><span class="ident" id="6890375">httptest</span><span class="op" id="6890383">.</span><span class="ident" id="6890384">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="6890401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6890404">func</span>&nbsp;<span class="op" id="6890409">(</span><span class="ident" id="6890410">r</span>&nbsp;<span class="op" id="6890412">*</span><span class="ident" id="6890413">customWriterRecorder</span><span class="op" id="6890433">)</span>&nbsp;<span class="ident" id="6890435">Write</span><span class="op" id="6890440">(</span><span class="ident" id="6890441">p</span>&nbsp;<span class="op" id="6890443">[</span><span class="op" id="6890444">]</span><span class="builtintype" id="6890445">byte</span><span class="op" id="6890449">)</span>&nbsp;<span class="op" id="6890451">(</span><span class="ident" id="6890452">n</span>&nbsp;<span class="builtintype" id="6890454">int</span><span class="op" id="6890457">,</span>&nbsp;<span class="ident" id="6890459">err</span>&nbsp;<span class="builtintype" id="6890463">error</span><span class="op" id="6890468">)</span>&nbsp;<span class="op" id="6890470">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890473">return</span>&nbsp;<span class="ident" id="6890480">r</span><span class="op" id="6890481">.</span><span class="ident" id="6890482">w</span><span class="op" id="6890483">.</span><span class="ident" id="6890484">Write</span><span class="op" id="6890489">(</span><span class="ident" id="6890490">p</span><span class="op" id="6890491">)</span><br>
<span class="lineno"></span><span class="op" id="6890493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6890496">type</span>&nbsp;<span class="ident" id="6890501">limitWriter</span>&nbsp;<span class="keyword" id="6890513">struct</span>&nbsp;<span class="op" id="6890520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890523">w</span>&nbsp;<span class="ident" id="6890525">io</span><span class="op" id="6890527">.</span><span class="ident" id="6890528">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890536">n</span>&nbsp;<span class="builtintype" id="6890538">int</span><br>
<span class="lineno"></span><span class="op" id="6890542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6890545">func</span>&nbsp;<span class="op" id="6890550">(</span><span class="ident" id="6890551">w</span>&nbsp;<span class="op" id="6890553">*</span><span class="ident" id="6890554">limitWriter</span><span class="op" id="6890565">)</span>&nbsp;<span class="ident" id="6890567">Write</span><span class="op" id="6890572">(</span><span class="ident" id="6890573">p</span>&nbsp;<span class="op" id="6890575">[</span><span class="op" id="6890576">]</span><span class="builtintype" id="6890577">byte</span><span class="op" id="6890581">)</span>&nbsp;<span class="op" id="6890583">(</span><span class="ident" id="6890584">n</span>&nbsp;<span class="builtintype" id="6890586">int</span><span class="op" id="6890589">,</span>&nbsp;<span class="ident" id="6890591">err</span>&nbsp;<span class="builtintype" id="6890595">error</span><span class="op" id="6890600">)</span>&nbsp;<span class="op" id="6890602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890605">if</span>&nbsp;<span class="builtinfunc" id="6890608">len</span><span class="op" id="6890611">(</span><span class="ident" id="6890612">p</span><span class="op" id="6890613">)</span>&nbsp;<span class="op" id="6890615">&gt;</span>&nbsp;<span class="ident" id="6890617">w</span><span class="op" id="6890618">.</span><span class="ident" id="6890619">n</span>&nbsp;<span class="op" id="6890621">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890625">p</span>&nbsp;<span class="op" id="6890627">=</span>&nbsp;<span class="ident" id="6890629">p</span><span class="op" id="6890630">[</span><span class="op" id="6890631">:</span><span class="ident" id="6890632">w</span><span class="op" id="6890633">.</span><span class="ident" id="6890634">n</span><span class="op" id="6890635">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890641">if</span>&nbsp;<span class="builtinfunc" id="6890644">len</span><span class="op" id="6890647">(</span><span class="ident" id="6890648">p</span><span class="op" id="6890649">)</span>&nbsp;<span class="op" id="6890651">&gt;</span>&nbsp;<span class="num" id="6890653">0</span>&nbsp;<span class="op" id="6890655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890659">n</span><span class="op" id="6890660">,</span>&nbsp;<span class="ident" id="6890662">err</span>&nbsp;<span class="op" id="6890666">=</span>&nbsp;<span class="ident" id="6890668">w</span><span class="op" id="6890669">.</span><span class="ident" id="6890670">w</span><span class="op" id="6890671">.</span><span class="ident" id="6890672">Write</span><span class="op" id="6890677">(</span><span class="ident" id="6890678">p</span><span class="op" id="6890679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890683">w</span><span class="op" id="6890684">.</span><span class="ident" id="6890685">n</span>&nbsp;<span class="op" id="6890687">-=</span>&nbsp;<span class="ident" id="6890690">n</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890696">if</span>&nbsp;<span class="ident" id="6890699">w</span><span class="op" id="6890700">.</span><span class="ident" id="6890701">n</span>&nbsp;<span class="op" id="6890703">==</span>&nbsp;<span class="num" id="6890706">0</span>&nbsp;<span class="op" id="6890708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890712">err</span>&nbsp;<span class="op" id="6890716">=</span>&nbsp;<span class="ident" id="6890718">errors</span><span class="op" id="6890724">.</span><span class="ident" id="6890725">New</span><span class="op" id="6890728">(</span><span class="string" id="6890729">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="6890747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890753">return</span><br>
<span class="lineno">90</span><span class="op" id="6890760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6890763">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="6890833">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="6890860">func</span>&nbsp;<span class="ident" id="6890865">TestKillChildAfterCopyError</span><span class="op" id="6890892">(</span><span class="ident" id="6890893">t</span>&nbsp;<span class="op" id="6890895">*</span><span class="ident" id="6890896">testing</span><span class="op" id="6890903">.</span><span class="ident" id="6890904">T</span><span class="op" id="6890905">)</span>&nbsp;<span class="op" id="6890907">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890910">if</span>&nbsp;<span class="ident" id="6890913">runtime</span><span class="op" id="6890920">.</span><span class="ident" id="6890921">GOOS</span>&nbsp;<span class="op" id="6890926">==</span>&nbsp;<span class="string" id="6890929">&#34;nacl&#34;</span>&nbsp;<span class="op" id="6890936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6890940">t</span><span class="op" id="6890941">.</span><span class="ident" id="6890942">Skip</span><span class="op" id="6890946">(</span><span class="string" id="6890947">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="6890965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6890968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6890972">defer</span>&nbsp;<span class="keyword" id="6890978">func</span><span class="op" id="6890982">(</span><span class="op" id="6890983">)</span>&nbsp;<span class="op" id="6890985">{</span>&nbsp;<span class="ident" id="6890987">testHookStartProcess</span>&nbsp;<span class="op" id="6891008">=</span>&nbsp;<span class="ident" id="6891010">nil</span>&nbsp;<span class="op" id="6891014">}</span><span class="op" id="6891015">(</span><span class="op" id="6891016">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891019">proc</span>&nbsp;<span class="op" id="6891024">:=</span>&nbsp;<span class="builtinfunc" id="6891027">make</span><span class="op" id="6891031">(</span><span class="keyword" id="6891032">chan</span>&nbsp;<span class="op" id="6891037">*</span><span class="ident" id="6891038">os</span><span class="op" id="6891040">.</span><span class="ident" id="6891041">Process</span><span class="op" id="6891048">,</span>&nbsp;<span class="num" id="6891050">1</span><span class="op" id="6891051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891054">testHookStartProcess</span>&nbsp;<span class="op" id="6891075">=</span>&nbsp;<span class="keyword" id="6891077">func</span><span class="op" id="6891081">(</span><span class="ident" id="6891082">p</span>&nbsp;<span class="op" id="6891084">*</span><span class="ident" id="6891085">os</span><span class="op" id="6891087">.</span><span class="ident" id="6891088">Process</span><span class="op" id="6891095">)</span>&nbsp;<span class="op" id="6891097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891101">proc</span>&nbsp;<span class="op" id="6891106">&lt;-</span>&nbsp;<span class="ident" id="6891109">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891116">h</span>&nbsp;<span class="op" id="6891118">:=</span>&nbsp;<span class="op" id="6891121">&amp;</span><span class="ident" id="6891122">Handler</span><span class="op" id="6891129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891133">Path</span><span class="op" id="6891137">:</span>&nbsp;<span class="ident" id="6891139">os</span><span class="op" id="6891141">.</span><span class="ident" id="6891142">Args</span><span class="op" id="6891146">[</span><span class="num" id="6891147">0</span><span class="op" id="6891148">]</span><span class="op" id="6891149">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891153">Root</span><span class="op" id="6891157">:</span>&nbsp;<span class="string" id="6891159">&#34;/test.go&#34;</span><span class="op" id="6891169">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891173">Args</span><span class="op" id="6891177">:</span>&nbsp;<span class="op" id="6891179">[</span><span class="op" id="6891180">]</span><span class="builtintype" id="6891181">string</span><span class="op" id="6891187">{</span><span class="string" id="6891188">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6891221">}</span><span class="op" id="6891222">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891225">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891228">req</span><span class="op" id="6891231">,</span>&nbsp;<span class="ident" id="6891233">_</span>&nbsp;<span class="op" id="6891235">:=</span>&nbsp;<span class="ident" id="6891238">http</span><span class="op" id="6891242">.</span><span class="ident" id="6891243">NewRequest</span><span class="op" id="6891253">(</span><span class="string" id="6891254">&#34;GET&#34;</span><span class="op" id="6891259">,</span>&nbsp;<span class="string" id="6891261">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="6891306">,</span>&nbsp;<span class="ident" id="6891308">nil</span><span class="op" id="6891311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891314">rec</span>&nbsp;<span class="op" id="6891318">:=</span>&nbsp;<span class="ident" id="6891321">httptest</span><span class="op" id="6891329">.</span><span class="ident" id="6891330">NewRecorder</span><span class="op" id="6891341">(</span><span class="op" id="6891342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891345">var</span>&nbsp;<span class="ident" id="6891349">out</span>&nbsp;<span class="ident" id="6891353">bytes</span><span class="op" id="6891358">.</span><span class="ident" id="6891359">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891367">const</span>&nbsp;<span class="ident" id="6891373">writeLen</span>&nbsp;<span class="op" id="6891382">=</span>&nbsp;<span class="num" id="6891384">50</span>&nbsp;<span class="op" id="6891387">&lt;&lt;</span>&nbsp;<span class="num" id="6891390">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891394">rw</span>&nbsp;<span class="op" id="6891397">:=</span>&nbsp;<span class="op" id="6891400">&amp;</span><span class="ident" id="6891401">customWriterRecorder</span><span class="op" id="6891421">{</span><span class="op" id="6891422">&amp;</span><span class="ident" id="6891423">limitWriter</span><span class="op" id="6891434">{</span><span class="op" id="6891435">&amp;</span><span class="ident" id="6891436">out</span><span class="op" id="6891439">,</span>&nbsp;<span class="ident" id="6891441">writeLen</span><span class="op" id="6891449">}</span><span class="op" id="6891450">,</span>&nbsp;<span class="ident" id="6891452">rec</span><span class="op" id="6891455">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891459">donec</span>&nbsp;<span class="op" id="6891465">:=</span>&nbsp;<span class="builtinfunc" id="6891468">make</span><span class="op" id="6891472">(</span><span class="keyword" id="6891473">chan</span>&nbsp;<span class="builtintype" id="6891478">bool</span><span class="op" id="6891482">,</span>&nbsp;<span class="num" id="6891484">1</span><span class="op" id="6891485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891488">go</span>&nbsp;<span class="keyword" id="6891491">func</span><span class="op" id="6891495">(</span><span class="op" id="6891496">)</span>&nbsp;<span class="op" id="6891498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891502">h</span><span class="op" id="6891503">.</span><span class="ident" id="6891504">ServeHTTP</span><span class="op" id="6891513">(</span><span class="ident" id="6891514">rw</span><span class="op" id="6891516">,</span>&nbsp;<span class="ident" id="6891518">req</span><span class="op" id="6891521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891525">donec</span>&nbsp;<span class="op" id="6891531">&lt;-</span>&nbsp;<span class="ident" id="6891534">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891540">}</span><span class="op" id="6891541">(</span><span class="op" id="6891542">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891546">select</span>&nbsp;<span class="op" id="6891553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891556">case</span>&nbsp;<span class="op" id="6891561">&lt;-</span><span class="ident" id="6891563">donec</span><span class="op" id="6891568">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891572">if</span>&nbsp;<span class="ident" id="6891575">out</span><span class="op" id="6891578">.</span><span class="ident" id="6891579">Len</span><span class="op" id="6891582">(</span><span class="op" id="6891583">)</span>&nbsp;<span class="op" id="6891585">!=</span>&nbsp;<span class="ident" id="6891588">writeLen</span>&nbsp;<span class="op" id="6891597">||</span>&nbsp;<span class="ident" id="6891600">out</span><span class="op" id="6891603">.</span><span class="ident" id="6891604">Bytes</span><span class="op" id="6891609">(</span><span class="op" id="6891610">)</span><span class="op" id="6891611">[</span><span class="num" id="6891612">0</span><span class="op" id="6891613">]</span>&nbsp;<span class="op" id="6891615">!=</span>&nbsp;<span class="string" id="6891618">&#39;a&#39;</span>&nbsp;<span class="op" id="6891622">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891627">t</span><span class="op" id="6891628">.</span><span class="ident" id="6891629">Errorf</span><span class="op" id="6891635">(</span><span class="string" id="6891636">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="6891659">,</span>&nbsp;<span class="ident" id="6891661">out</span><span class="op" id="6891664">.</span><span class="ident" id="6891665">Bytes</span><span class="op" id="6891670">(</span><span class="op" id="6891671">)</span><span class="op" id="6891672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891679">case</span>&nbsp;<span class="op" id="6891684">&lt;-</span><span class="ident" id="6891686">time</span><span class="op" id="6891690">.</span><span class="ident" id="6891691">After</span><span class="op" id="6891696">(</span><span class="num" id="6891697">5</span>&nbsp;<span class="op" id="6891699">*</span>&nbsp;<span class="ident" id="6891701">time</span><span class="op" id="6891705">.</span><span class="ident" id="6891706">Second</span><span class="op" id="6891712">)</span><span class="op" id="6891713">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891717">t</span><span class="op" id="6891718">.</span><span class="ident" id="6891719">Errorf</span><span class="op" id="6891725">(</span><span class="string" id="6891726">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="6891786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891790">select</span>&nbsp;<span class="op" id="6891797">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891801">case</span>&nbsp;<span class="ident" id="6891806">p</span>&nbsp;<span class="op" id="6891808">:=</span>&nbsp;<span class="op" id="6891811">&lt;-</span><span class="ident" id="6891813">proc</span><span class="op" id="6891817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891822">p</span><span class="op" id="6891823">.</span><span class="ident" id="6891824">Kill</span><span class="op" id="6891828">(</span><span class="op" id="6891829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891834">t</span><span class="op" id="6891835">.</span><span class="ident" id="6891836">Logf</span><span class="op" id="6891840">(</span><span class="string" id="6891841">&#34;killed&nbsp;process&#34;</span><span class="op" id="6891857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6891861">default</span><span class="op" id="6891868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6891873">t</span><span class="op" id="6891874">.</span><span class="ident" id="6891875">Logf</span><span class="op" id="6891879">(</span><span class="string" id="6891880">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="6891901">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6891908">}</span><br>
<span class="lineno"></span><span class="op" id="6891910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6891913">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="6891970">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="6891995">func</span>&nbsp;<span class="ident" id="6892000">TestChildOnlyHeaders</span><span class="op" id="6892020">(</span><span class="ident" id="6892021">t</span>&nbsp;<span class="op" id="6892023">*</span><span class="ident" id="6892024">testing</span><span class="op" id="6892031">.</span><span class="ident" id="6892032">T</span><span class="op" id="6892033">)</span>&nbsp;<span class="op" id="6892035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892038">if</span>&nbsp;<span class="ident" id="6892041">runtime</span><span class="op" id="6892048">.</span><span class="ident" id="6892049">GOOS</span>&nbsp;<span class="op" id="6892054">==</span>&nbsp;<span class="string" id="6892057">&#34;nacl&#34;</span>&nbsp;<span class="op" id="6892064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892068">t</span><span class="op" id="6892069">.</span><span class="ident" id="6892070">Skip</span><span class="op" id="6892074">(</span><span class="string" id="6892075">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="6892093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892096">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892100">h</span>&nbsp;<span class="op" id="6892102">:=</span>&nbsp;<span class="op" id="6892105">&amp;</span><span class="ident" id="6892106">Handler</span><span class="op" id="6892113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892117">Path</span><span class="op" id="6892121">:</span>&nbsp;<span class="ident" id="6892123">os</span><span class="op" id="6892125">.</span><span class="ident" id="6892126">Args</span><span class="op" id="6892130">[</span><span class="num" id="6892131">0</span><span class="op" id="6892132">]</span><span class="op" id="6892133">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892137">Root</span><span class="op" id="6892141">:</span>&nbsp;<span class="string" id="6892143">&#34;/test.go&#34;</span><span class="op" id="6892153">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892157">Args</span><span class="op" id="6892161">:</span>&nbsp;<span class="op" id="6892163">[</span><span class="op" id="6892164">]</span><span class="builtintype" id="6892165">string</span><span class="op" id="6892171">{</span><span class="string" id="6892172">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6892205">}</span><span class="op" id="6892206">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892212">expectedMap</span>&nbsp;<span class="op" id="6892224">:=</span>&nbsp;<span class="keyword" id="6892227">map</span><span class="op" id="6892230">[</span><span class="builtintype" id="6892231">string</span><span class="op" id="6892237">]</span><span class="builtintype" id="6892238">string</span><span class="op" id="6892244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6892248">&#34;_body&#34;</span><span class="op" id="6892255">:</span>&nbsp;<span class="string" id="6892257">&#34;&#34;</span><span class="op" id="6892259">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892265">replay</span>&nbsp;<span class="op" id="6892272">:=</span>&nbsp;<span class="ident" id="6892275">runCgiTest</span><span class="op" id="6892285">(</span><span class="ident" id="6892286">t</span><span class="op" id="6892287">,</span>&nbsp;<span class="ident" id="6892289">h</span><span class="op" id="6892290">,</span>&nbsp;<span class="string" id="6892292">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6892348">,</span>&nbsp;<span class="ident" id="6892350">expectedMap</span><span class="op" id="6892361">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6892364">if</span>&nbsp;<span class="ident" id="6892367">expected</span><span class="op" id="6892375">,</span>&nbsp;<span class="ident" id="6892377">got</span>&nbsp;<span class="op" id="6892381">:=</span>&nbsp;<span class="string" id="6892384">&#34;X-Test-Value&#34;</span><span class="op" id="6892398">,</span>&nbsp;<span class="ident" id="6892400">replay</span><span class="op" id="6892406">.</span><span class="ident" id="6892407">Header</span><span class="op" id="6892413">(</span><span class="op" id="6892414">)</span><span class="op" id="6892415">.</span><span class="ident" id="6892416">Get</span><span class="op" id="6892419">(</span><span class="string" id="6892420">&#34;X-Test-Header&#34;</span><span class="op" id="6892435">)</span><span class="op" id="6892436">;</span>&nbsp;<span class="ident" id="6892438">got</span>&nbsp;<span class="op" id="6892442">!=</span>&nbsp;<span class="ident" id="6892445">expected</span>&nbsp;<span class="op" id="6892454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892458">t</span><span class="op" id="6892459">.</span><span class="ident" id="6892460">Errorf</span><span class="op" id="6892466">(</span><span class="string" id="6892467">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6892507">,</span>&nbsp;<span class="ident" id="6892509">got</span><span class="op" id="6892512">,</span>&nbsp;<span class="ident" id="6892514">expected</span><span class="op" id="6892522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892525">}</span><br>
<span class="lineno"></span><span class="op" id="6892527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="6892530">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="6892555">func</span>&nbsp;<span class="ident" id="6892560">Test500WithNoHeaders</span><span class="op" id="6892580">(</span><span class="ident" id="6892581">t</span>&nbsp;<span class="op" id="6892583">*</span><span class="ident" id="6892584">testing</span><span class="op" id="6892591">.</span><span class="ident" id="6892592">T</span><span class="op" id="6892593">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6892599">{</span>&nbsp;<span class="ident" id="6892601">want500Test</span><span class="op" id="6892612">(</span><span class="ident" id="6892613">t</span><span class="op" id="6892614">,</span>&nbsp;<span class="string" id="6892616">&#34;/immediate-disconnect&#34;</span><span class="op" id="6892639">)</span>&nbsp;<span class="op" id="6892641">}</span><br>
<span class="lineno"></span><span class="keyword" id="6892643">func</span>&nbsp;<span class="ident" id="6892648">Test500WithNoContentType</span><span class="op" id="6892672">(</span><span class="ident" id="6892673">t</span>&nbsp;<span class="op" id="6892675">*</span><span class="ident" id="6892676">testing</span><span class="op" id="6892683">.</span><span class="ident" id="6892684">T</span><span class="op" id="6892685">)</span>&nbsp;<span class="op" id="6892687">{</span>&nbsp;<span class="ident" id="6892689">want500Test</span><span class="op" id="6892700">(</span><span class="ident" id="6892701">t</span><span class="op" id="6892702">,</span>&nbsp;<span class="string" id="6892704">&#34;/no-content-type&#34;</span><span class="op" id="6892722">)</span>&nbsp;<span class="op" id="6892724">}</span><br>
<span class="lineno"></span><span class="keyword" id="6892726">func</span>&nbsp;<span class="ident" id="6892731">Test500WithEmptyHeaders</span><span class="op" id="6892754">(</span><span class="ident" id="6892755">t</span>&nbsp;<span class="op" id="6892757">*</span><span class="ident" id="6892758">testing</span><span class="op" id="6892765">.</span><span class="ident" id="6892766">T</span><span class="op" id="6892767">)</span>&nbsp;&nbsp;<span class="op" id="6892770">{</span>&nbsp;<span class="ident" id="6892772">want500Test</span><span class="op" id="6892783">(</span><span class="ident" id="6892784">t</span><span class="op" id="6892785">,</span>&nbsp;<span class="string" id="6892787">&#34;/empty-headers&#34;</span><span class="op" id="6892803">)</span>&nbsp;<span class="op" id="6892805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="6892808">func</span>&nbsp;<span class="ident" id="6892813">want500Test</span><span class="op" id="6892824">(</span><span class="ident" id="6892825">t</span>&nbsp;<span class="op" id="6892827">*</span><span class="ident" id="6892828">testing</span><span class="op" id="6892835">.</span><span class="ident" id="6892836">T</span><span class="op" id="6892837">,</span>&nbsp;<span class="ident" id="6892839">path</span>&nbsp;<span class="builtintype" id="6892844">string</span><span class="op" id="6892850">)</span>&nbsp;<span class="op" id="6892852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892855">h</span>&nbsp;<span class="op" id="6892857">:=</span>&nbsp;<span class="op" id="6892860">&amp;</span><span class="ident" id="6892861">Handler</span><span class="op" id="6892868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892872">Path</span><span class="op" id="6892876">:</span>&nbsp;<span class="ident" id="6892878">os</span><span class="op" id="6892880">.</span><span class="ident" id="6892881">Args</span><span class="op" id="6892885">[</span><span class="num" id="6892886">0</span><span class="op" id="6892887">]</span><span class="op" id="6892888">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892892">Root</span><span class="op" id="6892896">:</span>&nbsp;<span class="string" id="6892898">&#34;/test.go&#34;</span><span class="op" id="6892908">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892912">Args</span><span class="op" id="6892916">:</span>&nbsp;<span class="op" id="6892918">[</span><span class="op" id="6892919">]</span><span class="builtintype" id="6892920">string</span><span class="op" id="6892926">{</span><span class="string" id="6892927">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6892960">}</span><span class="op" id="6892961">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6892964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6892967">expectedMap</span>&nbsp;<span class="op" id="6892979">:=</span>&nbsp;<span class="keyword" id="6892982">map</span><span class="op" id="6892985">[</span><span class="builtintype" id="6892986">string</span><span class="op" id="6892992">]</span><span class="builtintype" id="6892993">string</span><span class="op" id="6892999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6893003">&#34;_body&#34;</span><span class="op" id="6893010">:</span>&nbsp;<span class="string" id="6893012">&#34;&#34;</span><span class="op" id="6893014">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893020">replay</span>&nbsp;<span class="op" id="6893027">:=</span>&nbsp;<span class="ident" id="6893030">runCgiTest</span><span class="op" id="6893040">(</span><span class="ident" id="6893041">t</span><span class="op" id="6893042">,</span>&nbsp;<span class="ident" id="6893044">h</span><span class="op" id="6893045">,</span>&nbsp;<span class="string" id="6893047">&#34;GET&nbsp;&#34;</span><span class="op" id="6893053">+</span><span class="ident" id="6893054">path</span><span class="op" id="6893058">+</span><span class="string" id="6893059">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6893093">,</span>&nbsp;<span class="ident" id="6893095">expectedMap</span><span class="op" id="6893106">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893109">if</span>&nbsp;<span class="ident" id="6893112">replay</span><span class="op" id="6893118">.</span><span class="ident" id="6893119">Code</span>&nbsp;<span class="op" id="6893124">!=</span>&nbsp;<span class="num" id="6893127">500</span>&nbsp;<span class="op" id="6893131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893135">t</span><span class="op" id="6893136">.</span><span class="ident" id="6893137">Errorf</span><span class="op" id="6893143">(</span><span class="string" id="6893144">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="6893167">,</span>&nbsp;<span class="ident" id="6893169">replay</span><span class="op" id="6893175">.</span><span class="ident" id="6893176">Code</span><span class="op" id="6893180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893183">}</span><br>
<span class="lineno"></span><span class="op" id="6893185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6893188">type</span>&nbsp;<span class="ident" id="6893193">neverEnding</span>&nbsp;<span class="builtintype" id="6893205">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6893211">func</span>&nbsp;<span class="op" id="6893216">(</span><span class="ident" id="6893217">b</span>&nbsp;<span class="ident" id="6893219">neverEnding</span><span class="op" id="6893230">)</span>&nbsp;<span class="ident" id="6893232">Read</span><span class="op" id="6893236">(</span><span class="ident" id="6893237">p</span>&nbsp;<span class="op" id="6893239">[</span><span class="op" id="6893240">]</span><span class="builtintype" id="6893241">byte</span><span class="op" id="6893245">)</span>&nbsp;<span class="op" id="6893247">(</span><span class="ident" id="6893248">n</span>&nbsp;<span class="builtintype" id="6893250">int</span><span class="op" id="6893253">,</span>&nbsp;<span class="ident" id="6893255">err</span>&nbsp;<span class="builtintype" id="6893259">error</span><span class="op" id="6893264">)</span>&nbsp;<span class="op" id="6893266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893269">for</span>&nbsp;<span class="ident" id="6893273">i</span>&nbsp;<span class="op" id="6893275">:=</span>&nbsp;<span class="keyword" id="6893278">range</span>&nbsp;<span class="ident" id="6893284">p</span>&nbsp;<span class="op" id="6893286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893290">p</span><span class="op" id="6893291">[</span><span class="ident" id="6893292">i</span><span class="op" id="6893293">]</span>&nbsp;<span class="op" id="6893295">=</span>&nbsp;<span class="builtintype" id="6893297">byte</span><span class="op" id="6893301">(</span><span class="ident" id="6893302">b</span><span class="op" id="6893303">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893309">return</span>&nbsp;<span class="builtinfunc" id="6893316">len</span><span class="op" id="6893319">(</span><span class="ident" id="6893320">p</span><span class="op" id="6893321">)</span><span class="op" id="6893322">,</span>&nbsp;<span class="ident" id="6893324">nil</span><br>
<span class="lineno"></span><span class="op" id="6893328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6893331">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="6893361">func</span>&nbsp;<span class="ident" id="6893366">TestBeChildCGIProcess</span><span class="op" id="6893387">(</span><span class="ident" id="6893388">t</span>&nbsp;<span class="op" id="6893390">*</span><span class="ident" id="6893391">testing</span><span class="op" id="6893398">.</span><span class="ident" id="6893399">T</span><span class="op" id="6893400">)</span>&nbsp;<span class="op" id="6893402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893405">if</span>&nbsp;<span class="ident" id="6893408">os</span><span class="op" id="6893410">.</span><span class="ident" id="6893411">Getenv</span><span class="op" id="6893417">(</span><span class="string" id="6893418">&#34;REQUEST_METHOD&#34;</span><span class="op" id="6893434">)</span>&nbsp;<span class="op" id="6893436">==</span>&nbsp;<span class="string" id="6893439">&#34;&#34;</span>&nbsp;<span class="op" id="6893442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6893446">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893492">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893500">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893503">switch</span>&nbsp;<span class="ident" id="6893510">os</span><span class="op" id="6893512">.</span><span class="ident" id="6893513">Getenv</span><span class="op" id="6893519">(</span><span class="string" id="6893520">&#34;REQUEST_URI&#34;</span><span class="op" id="6893533">)</span>&nbsp;<span class="op" id="6893535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893538">case</span>&nbsp;<span class="string" id="6893543">&#34;/immediate-disconnect&#34;</span><span class="op" id="6893566">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893570">os</span><span class="op" id="6893572">.</span><span class="ident" id="6893573">Exit</span><span class="op" id="6893577">(</span><span class="num" id="6893578">0</span><span class="op" id="6893579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893582">case</span>&nbsp;<span class="string" id="6893587">&#34;/no-content-type&#34;</span><span class="op" id="6893605">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893609">fmt</span><span class="op" id="6893612">.</span><span class="ident" id="6893613">Printf</span><span class="op" id="6893619">(</span><span class="string" id="6893620">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="6893650">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893654">os</span><span class="op" id="6893656">.</span><span class="ident" id="6893657">Exit</span><span class="op" id="6893661">(</span><span class="num" id="6893662">0</span><span class="op" id="6893663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893666">case</span>&nbsp;<span class="string" id="6893671">&#34;/empty-headers&#34;</span><span class="op" id="6893687">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893691">fmt</span><span class="op" id="6893694">.</span><span class="ident" id="6893695">Printf</span><span class="op" id="6893701">(</span><span class="string" id="6893702">&#34;\nHello&#34;</span><span class="op" id="6893711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893715">os</span><span class="op" id="6893717">.</span><span class="ident" id="6893718">Exit</span><span class="op" id="6893722">(</span><span class="num" id="6893723">0</span><span class="op" id="6893724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893727">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893730">Serve</span><span class="op" id="6893735">(</span><span class="ident" id="6893736">http</span><span class="op" id="6893740">.</span><span class="ident" id="6893741">HandlerFunc</span><span class="op" id="6893752">(</span><span class="keyword" id="6893753">func</span><span class="op" id="6893757">(</span><span class="ident" id="6893758">rw</span>&nbsp;<span class="ident" id="6893761">http</span><span class="op" id="6893765">.</span><span class="ident" id="6893766">ResponseWriter</span><span class="op" id="6893780">,</span>&nbsp;<span class="ident" id="6893782">req</span>&nbsp;<span class="op" id="6893786">*</span><span class="ident" id="6893787">http</span><span class="op" id="6893791">.</span><span class="ident" id="6893792">Request</span><span class="op" id="6893799">)</span>&nbsp;<span class="op" id="6893801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893805">rw</span><span class="op" id="6893807">.</span><span class="ident" id="6893808">Header</span><span class="op" id="6893814">(</span><span class="op" id="6893815">)</span><span class="op" id="6893816">.</span><span class="ident" id="6893817">Set</span><span class="op" id="6893820">(</span><span class="string" id="6893821">&#34;X-Test-Header&#34;</span><span class="op" id="6893836">,</span>&nbsp;<span class="string" id="6893838">&#34;X-Test-Value&#34;</span><span class="op" id="6893852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893856">req</span><span class="op" id="6893859">.</span><span class="ident" id="6893860">ParseForm</span><span class="op" id="6893869">(</span><span class="op" id="6893870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893874">if</span>&nbsp;<span class="ident" id="6893877">req</span><span class="op" id="6893880">.</span><span class="ident" id="6893881">FormValue</span><span class="op" id="6893890">(</span><span class="string" id="6893891">&#34;no-body&#34;</span><span class="op" id="6893900">)</span>&nbsp;<span class="op" id="6893902">==</span>&nbsp;<span class="string" id="6893905">&#34;1&#34;</span>&nbsp;<span class="op" id="6893909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893914">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6893923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6893927">if</span>&nbsp;<span class="ident" id="6893930">req</span><span class="op" id="6893933">.</span><span class="ident" id="6893934">FormValue</span><span class="op" id="6893943">(</span><span class="string" id="6893944">&#34;write-forever&#34;</span><span class="op" id="6893959">)</span>&nbsp;<span class="op" id="6893961">==</span>&nbsp;<span class="string" id="6893964">&#34;1&#34;</span>&nbsp;<span class="op" id="6893968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6893973">io</span><span class="op" id="6893975">.</span><span class="ident" id="6893976">Copy</span><span class="op" id="6893980">(</span><span class="ident" id="6893981">rw</span><span class="op" id="6893983">,</span>&nbsp;<span class="ident" id="6893985">neverEnding</span><span class="op" id="6893996">(</span><span class="string" id="6893997">&#39;a&#39;</span><span class="op" id="6894000">)</span><span class="op" id="6894001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894006">for</span>&nbsp;<span class="op" id="6894010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894016">time</span><span class="op" id="6894020">.</span><span class="ident" id="6894021">Sleep</span><span class="op" id="6894026">(</span><span class="num" id="6894027">5</span>&nbsp;<span class="op" id="6894029">*</span>&nbsp;<span class="ident" id="6894031">time</span><span class="op" id="6894035">.</span><span class="ident" id="6894036">Second</span><span class="op" id="6894042">)</span>&nbsp;<span class="comment" id="6894044">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894085">fmt</span><span class="op" id="6894088">.</span><span class="ident" id="6894089">Fprintf</span><span class="op" id="6894096">(</span><span class="ident" id="6894097">rw</span><span class="op" id="6894099">,</span>&nbsp;<span class="string" id="6894101">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="6894126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894130">for</span>&nbsp;<span class="ident" id="6894134">k</span><span class="op" id="6894135">,</span>&nbsp;<span class="ident" id="6894137">vv</span>&nbsp;<span class="op" id="6894140">:=</span>&nbsp;<span class="keyword" id="6894143">range</span>&nbsp;<span class="ident" id="6894149">req</span><span class="op" id="6894152">.</span><span class="ident" id="6894153">Form</span>&nbsp;<span class="op" id="6894158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894163">for</span>&nbsp;<span class="ident" id="6894167">_</span><span class="op" id="6894168">,</span>&nbsp;<span class="ident" id="6894170">v</span>&nbsp;<span class="op" id="6894172">:=</span>&nbsp;<span class="keyword" id="6894175">range</span>&nbsp;<span class="ident" id="6894181">vv</span>&nbsp;<span class="op" id="6894184">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894190">fmt</span><span class="op" id="6894193">.</span><span class="ident" id="6894194">Fprintf</span><span class="op" id="6894201">(</span><span class="ident" id="6894202">rw</span><span class="op" id="6894204">,</span>&nbsp;<span class="string" id="6894206">&#34;param-%s=%s\n&#34;</span><span class="op" id="6894221">,</span>&nbsp;<span class="ident" id="6894223">k</span><span class="op" id="6894224">,</span>&nbsp;<span class="ident" id="6894226">v</span><span class="op" id="6894227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6894240">for</span>&nbsp;<span class="ident" id="6894244">_</span><span class="op" id="6894245">,</span>&nbsp;<span class="ident" id="6894247">kv</span>&nbsp;<span class="op" id="6894250">:=</span>&nbsp;<span class="keyword" id="6894253">range</span>&nbsp;<span class="ident" id="6894259">os</span><span class="op" id="6894261">.</span><span class="ident" id="6894262">Environ</span><span class="op" id="6894269">(</span><span class="op" id="6894270">)</span>&nbsp;<span class="op" id="6894272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894277">fmt</span><span class="op" id="6894280">.</span><span class="ident" id="6894281">Fprintf</span><span class="op" id="6894288">(</span><span class="ident" id="6894289">rw</span><span class="op" id="6894291">,</span>&nbsp;<span class="string" id="6894293">&#34;env-%s\n&#34;</span><span class="op" id="6894303">,</span>&nbsp;<span class="ident" id="6894305">kv</span><span class="op" id="6894307">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6894314">}</span><span class="op" id="6894315">)</span><span class="op" id="6894316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6894319">os</span><span class="op" id="6894321">.</span><span class="ident" id="6894322">Exit</span><span class="op" id="6894326">(</span><span class="num" id="6894327">0</span><span class="op" id="6894328">)</span><br>
<span class="lineno"></span><span class="op" id="6894330">}</span>
</div>
</body>
</html>
