<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1437116">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1437171">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1437225">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1437276">package</span>&nbsp;<span class="ident" id="1437284">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1437290">import</span>&nbsp;<span class="op" id="1437297">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1437300">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1437311">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1437326">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1437335">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1437338">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;temporary&nbsp;objects&nbsp;that&nbsp;may&nbsp;be&nbsp;individually&nbsp;saved&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1437413">//&nbsp;retrieved.</span><br>
<span class="lineno">15</span><span class="comment" id="1437427">//</span><br>
<span class="lineno"></span><span class="comment" id="1437430">//&nbsp;Any&nbsp;item&nbsp;stored&nbsp;in&nbsp;the&nbsp;Pool&nbsp;may&nbsp;be&nbsp;removed&nbsp;automatically&nbsp;at&nbsp;any&nbsp;time&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="1437510">//&nbsp;notification.&nbsp;If&nbsp;the&nbsp;Pool&nbsp;holds&nbsp;the&nbsp;only&nbsp;reference&nbsp;when&nbsp;this&nbsp;happens,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1437587">//&nbsp;item&nbsp;might&nbsp;be&nbsp;deallocated.</span><br>
<span class="lineno"></span><span class="comment" id="1437617">//</span><br>
<span class="lineno">20</span><span class="comment" id="1437620">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;safe&nbsp;for&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="1437685">//</span><br>
<span class="lineno"></span><span class="comment" id="1437688">//&nbsp;Pool&#39;s&nbsp;purpose&nbsp;is&nbsp;to&nbsp;cache&nbsp;allocated&nbsp;but&nbsp;unused&nbsp;items&nbsp;for&nbsp;later&nbsp;reuse,</span><br>
<span class="lineno"></span><span class="comment" id="1437762">//&nbsp;relieving&nbsp;pressure&nbsp;on&nbsp;the&nbsp;garbage&nbsp;collector.&nbsp;That&nbsp;is,&nbsp;it&nbsp;makes&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1437839">//&nbsp;build&nbsp;efficient,&nbsp;thread-safe&nbsp;free&nbsp;lists.&nbsp;However,&nbsp;it&nbsp;is&nbsp;not&nbsp;suitable&nbsp;for&nbsp;all</span><br>
<span class="lineno">25</span><span class="comment" id="1437919">//&nbsp;free&nbsp;lists.</span><br>
<span class="lineno"></span><span class="comment" id="1437934">//</span><br>
<span class="lineno"></span><span class="comment" id="1437937">//&nbsp;An&nbsp;appropriate&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;to&nbsp;manage&nbsp;a&nbsp;group&nbsp;of&nbsp;temporary&nbsp;items</span><br>
<span class="lineno"></span><span class="comment" id="1438009">//&nbsp;silently&nbsp;shared&nbsp;among&nbsp;and&nbsp;potentially&nbsp;reused&nbsp;by&nbsp;concurrent&nbsp;independent</span><br>
<span class="lineno"></span><span class="comment" id="1438083">//&nbsp;clients&nbsp;of&nbsp;a&nbsp;package.&nbsp;Pool&nbsp;provides&nbsp;a&nbsp;way&nbsp;to&nbsp;amortize&nbsp;allocation&nbsp;overhead</span><br>
<span class="lineno">30</span><span class="comment" id="1438160">//&nbsp;across&nbsp;many&nbsp;clients.</span><br>
<span class="lineno"></span><span class="comment" id="1438184">//</span><br>
<span class="lineno"></span><span class="comment" id="1438187">//&nbsp;An&nbsp;example&nbsp;of&nbsp;good&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;in&nbsp;the&nbsp;fmt&nbsp;package,&nbsp;which&nbsp;maintains&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1438264">//&nbsp;dynamically-sized&nbsp;store&nbsp;of&nbsp;temporary&nbsp;output&nbsp;buffers.&nbsp;The&nbsp;store&nbsp;scales&nbsp;under</span><br>
<span class="lineno"></span><span class="comment" id="1438343">//&nbsp;load&nbsp;(when&nbsp;many&nbsp;goroutines&nbsp;are&nbsp;actively&nbsp;printing)&nbsp;and&nbsp;shrinks&nbsp;when</span><br>
<span class="lineno">35</span><span class="comment" id="1438413">//&nbsp;quiescent.</span><br>
<span class="lineno"></span><span class="comment" id="1438427">//</span><br>
<span class="lineno"></span><span class="comment" id="1438430">//&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;a&nbsp;free&nbsp;list&nbsp;maintained&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;short-lived&nbsp;object&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1438510">//&nbsp;not&nbsp;a&nbsp;suitable&nbsp;use&nbsp;for&nbsp;a&nbsp;Pool,&nbsp;since&nbsp;the&nbsp;overhead&nbsp;does&nbsp;not&nbsp;amortize&nbsp;well&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1438589">//&nbsp;that&nbsp;scenario.&nbsp;It&nbsp;is&nbsp;more&nbsp;efficient&nbsp;to&nbsp;have&nbsp;such&nbsp;objects&nbsp;implement&nbsp;their&nbsp;own</span><br>
<span class="lineno">40</span><span class="comment" id="1438669">//&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="1438683">//</span><br>
<span class="lineno"></span><span class="keyword" id="1438686">type</span>&nbsp;<span class="ident" id="1438691">Pool</span>&nbsp;<span class="keyword" id="1438696">struct</span>&nbsp;<span class="op" id="1438703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438706">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1438716">unsafe</span><span class="op" id="1438722">.</span><span class="ident" id="1438723">Pointer</span>&nbsp;<span class="comment" id="1438731">//&nbsp;local&nbsp;fixed-size&nbsp;per-P&nbsp;pool,&nbsp;actual&nbsp;type&nbsp;is&nbsp;[P]poolLocal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438792">localSize</span>&nbsp;<span class="builtintype" id="1438802">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1438817">//&nbsp;size&nbsp;of&nbsp;the&nbsp;local&nbsp;array</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1438846">//&nbsp;New&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;generate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1438898">//&nbsp;a&nbsp;value&nbsp;when&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1438947">//&nbsp;It&nbsp;may&nbsp;not&nbsp;be&nbsp;changed&nbsp;concurrently&nbsp;with&nbsp;calls&nbsp;to&nbsp;Get.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439005">New</span>&nbsp;<span class="keyword" id="1439009">func</span><span class="op" id="1439013">(</span><span class="op" id="1439014">)</span>&nbsp;<span class="keyword" id="1439016">interface</span><span class="op" id="1439025">{</span><span class="op" id="1439026">}</span><br>
<span class="lineno">50</span><span class="op" id="1439028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1439031">//&nbsp;Local&nbsp;per-P&nbsp;Pool&nbsp;appendix.</span><br>
<span class="lineno"></span><span class="keyword" id="1439061">type</span>&nbsp;<span class="ident" id="1439066">poolLocal</span>&nbsp;<span class="keyword" id="1439076">struct</span>&nbsp;<span class="op" id="1439083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439086">private</span>&nbsp;<span class="keyword" id="1439094">interface</span><span class="op" id="1439103">{</span><span class="op" id="1439104">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1439108">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;only&nbsp;by&nbsp;the&nbsp;respective&nbsp;P.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439150">shared</span>&nbsp;&nbsp;<span class="op" id="1439158">[</span><span class="op" id="1439159">]</span><span class="keyword" id="1439160">interface</span><span class="op" id="1439169">{</span><span class="op" id="1439170">}</span>&nbsp;<span class="comment" id="1439172">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;by&nbsp;any&nbsp;P.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439198">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1439220">//&nbsp;Protects&nbsp;shared.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439241">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1439249">[</span><span class="num" id="1439250">128</span><span class="op" id="1439253">]</span><span class="builtintype" id="1439254">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1439263">//&nbsp;Prevents&nbsp;false&nbsp;sharing.</span><br>
<span class="lineno"></span><span class="op" id="1439290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1439293">//&nbsp;Put&nbsp;adds&nbsp;x&nbsp;to&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1439320">func</span>&nbsp;<span class="op" id="1439325">(</span><span class="ident" id="1439326">p</span>&nbsp;<span class="op" id="1439328">*</span><span class="ident" id="1439329">Pool</span><span class="op" id="1439333">)</span>&nbsp;<span class="ident" id="1439335">Put</span><span class="op" id="1439338">(</span><span class="ident" id="1439339">x</span>&nbsp;<span class="keyword" id="1439341">interface</span><span class="op" id="1439350">{</span><span class="op" id="1439351">}</span><span class="op" id="1439352">)</span>&nbsp;<span class="op" id="1439354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439357">if</span>&nbsp;<span class="ident" id="1439360">raceenabled</span>&nbsp;<span class="op" id="1439372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439376">//&nbsp;Under&nbsp;race&nbsp;detector&nbsp;the&nbsp;Pool&nbsp;degenerates&nbsp;into&nbsp;no-op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439434">//&nbsp;It&#39;s&nbsp;conforming,&nbsp;simple&nbsp;and&nbsp;does&nbsp;not&nbsp;introduce&nbsp;excessive</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1439496">//&nbsp;happens-before&nbsp;edges&nbsp;between&nbsp;unrelated&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439552">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439563">if</span>&nbsp;<span class="ident" id="1439566">x</span>&nbsp;<span class="op" id="1439568">==</span>&nbsp;<span class="ident" id="1439571">nil</span>&nbsp;<span class="op" id="1439575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439579">return</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439590">l</span>&nbsp;<span class="op" id="1439592">:=</span>&nbsp;<span class="ident" id="1439595">p</span><span class="op" id="1439596">.</span><span class="ident" id="1439597">pin</span><span class="op" id="1439600">(</span><span class="op" id="1439601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439604">if</span>&nbsp;<span class="ident" id="1439607">l</span><span class="op" id="1439608">.</span><span class="ident" id="1439609">private</span>&nbsp;<span class="op" id="1439617">==</span>&nbsp;<span class="ident" id="1439620">nil</span>&nbsp;<span class="op" id="1439624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439628">l</span><span class="op" id="1439629">.</span><span class="ident" id="1439630">private</span>&nbsp;<span class="op" id="1439638">=</span>&nbsp;<span class="ident" id="1439640">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439644">x</span>&nbsp;<span class="op" id="1439646">=</span>&nbsp;<span class="ident" id="1439648">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439656">runtime_procUnpin</span><span class="op" id="1439673">(</span><span class="op" id="1439674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439677">if</span>&nbsp;<span class="ident" id="1439680">x</span>&nbsp;<span class="op" id="1439682">==</span>&nbsp;<span class="ident" id="1439685">nil</span>&nbsp;<span class="op" id="1439689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439693">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439701">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439704">l</span><span class="op" id="1439705">.</span><span class="ident" id="1439706">Lock</span><span class="op" id="1439710">(</span><span class="op" id="1439711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439714">l</span><span class="op" id="1439715">.</span><span class="ident" id="1439716">shared</span>&nbsp;<span class="op" id="1439723">=</span>&nbsp;<span class="builtinfunc" id="1439725">append</span><span class="op" id="1439731">(</span><span class="ident" id="1439732">l</span><span class="op" id="1439733">.</span><span class="ident" id="1439734">shared</span><span class="op" id="1439740">,</span>&nbsp;<span class="ident" id="1439742">x</span><span class="op" id="1439743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439746">l</span><span class="op" id="1439747">.</span><span class="ident" id="1439748">Unlock</span><span class="op" id="1439754">(</span><span class="op" id="1439755">)</span><br>
<span class="lineno"></span><span class="op" id="1439757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1439760">//&nbsp;Get&nbsp;selects&nbsp;an&nbsp;arbitrary&nbsp;item&nbsp;from&nbsp;the&nbsp;Pool,&nbsp;removes&nbsp;it&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1439828">//&nbsp;Pool,&nbsp;and&nbsp;returns&nbsp;it&nbsp;to&nbsp;the&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1439867">//&nbsp;Get&nbsp;may&nbsp;choose&nbsp;to&nbsp;ignore&nbsp;the&nbsp;pool&nbsp;and&nbsp;treat&nbsp;it&nbsp;as&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="1439927">//&nbsp;Callers&nbsp;should&nbsp;not&nbsp;assume&nbsp;any&nbsp;relation&nbsp;between&nbsp;values&nbsp;passed&nbsp;to&nbsp;Put&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1440002">//&nbsp;the&nbsp;values&nbsp;returned&nbsp;by&nbsp;Get.</span><br>
<span class="lineno">90</span><span class="comment" id="1440033">//</span><br>
<span class="lineno"></span><span class="comment" id="1440036">//&nbsp;If&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil&nbsp;and&nbsp;p.New&nbsp;is&nbsp;non-nil,&nbsp;Get&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="1440107">//&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;p.New.</span><br>
<span class="lineno"></span><span class="keyword" id="1440139">func</span>&nbsp;<span class="op" id="1440144">(</span><span class="ident" id="1440145">p</span>&nbsp;<span class="op" id="1440147">*</span><span class="ident" id="1440148">Pool</span><span class="op" id="1440152">)</span>&nbsp;<span class="ident" id="1440154">Get</span><span class="op" id="1440157">(</span><span class="op" id="1440158">)</span>&nbsp;<span class="keyword" id="1440160">interface</span><span class="op" id="1440169">{</span><span class="op" id="1440170">}</span>&nbsp;<span class="op" id="1440172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440175">if</span>&nbsp;<span class="ident" id="1440178">raceenabled</span>&nbsp;<span class="op" id="1440190">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440194">if</span>&nbsp;<span class="ident" id="1440197">p</span><span class="op" id="1440198">.</span><span class="ident" id="1440199">New</span>&nbsp;<span class="op" id="1440203">!=</span>&nbsp;<span class="ident" id="1440206">nil</span>&nbsp;<span class="op" id="1440210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440215">return</span>&nbsp;<span class="ident" id="1440222">p</span><span class="op" id="1440223">.</span><span class="ident" id="1440224">New</span><span class="op" id="1440227">(</span><span class="op" id="1440228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440236">return</span>&nbsp;<span class="ident" id="1440243">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440248">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440251">l</span>&nbsp;<span class="op" id="1440253">:=</span>&nbsp;<span class="ident" id="1440256">p</span><span class="op" id="1440257">.</span><span class="ident" id="1440258">pin</span><span class="op" id="1440261">(</span><span class="op" id="1440262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440265">x</span>&nbsp;<span class="op" id="1440267">:=</span>&nbsp;<span class="ident" id="1440270">l</span><span class="op" id="1440271">.</span><span class="ident" id="1440272">private</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440281">l</span><span class="op" id="1440282">.</span><span class="ident" id="1440283">private</span>&nbsp;<span class="op" id="1440291">=</span>&nbsp;<span class="ident" id="1440293">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440298">runtime_procUnpin</span><span class="op" id="1440315">(</span><span class="op" id="1440316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440319">if</span>&nbsp;<span class="ident" id="1440322">x</span>&nbsp;<span class="op" id="1440324">!=</span>&nbsp;<span class="ident" id="1440327">nil</span>&nbsp;<span class="op" id="1440331">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440335">return</span>&nbsp;<span class="ident" id="1440342">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440348">l</span><span class="op" id="1440349">.</span><span class="ident" id="1440350">Lock</span><span class="op" id="1440354">(</span><span class="op" id="1440355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440358">last</span>&nbsp;<span class="op" id="1440363">:=</span>&nbsp;<span class="builtinfunc" id="1440366">len</span><span class="op" id="1440369">(</span><span class="ident" id="1440370">l</span><span class="op" id="1440371">.</span><span class="ident" id="1440372">shared</span><span class="op" id="1440378">)</span>&nbsp;<span class="op" id="1440380">-</span>&nbsp;<span class="num" id="1440382">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440385">if</span>&nbsp;<span class="ident" id="1440388">last</span>&nbsp;<span class="op" id="1440393">&gt;=</span>&nbsp;<span class="num" id="1440396">0</span>&nbsp;<span class="op" id="1440398">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440402">x</span>&nbsp;<span class="op" id="1440404">=</span>&nbsp;<span class="ident" id="1440406">l</span><span class="op" id="1440407">.</span><span class="ident" id="1440408">shared</span><span class="op" id="1440414">[</span><span class="ident" id="1440415">last</span><span class="op" id="1440419">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440423">l</span><span class="op" id="1440424">.</span><span class="ident" id="1440425">shared</span>&nbsp;<span class="op" id="1440432">=</span>&nbsp;<span class="ident" id="1440434">l</span><span class="op" id="1440435">.</span><span class="ident" id="1440436">shared</span><span class="op" id="1440442">[</span><span class="op" id="1440443">:</span><span class="ident" id="1440444">last</span><span class="op" id="1440448">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440454">l</span><span class="op" id="1440455">.</span><span class="ident" id="1440456">Unlock</span><span class="op" id="1440462">(</span><span class="op" id="1440463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440466">if</span>&nbsp;<span class="ident" id="1440469">x</span>&nbsp;<span class="op" id="1440471">!=</span>&nbsp;<span class="ident" id="1440474">nil</span>&nbsp;<span class="op" id="1440478">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440482">return</span>&nbsp;<span class="ident" id="1440489">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440495">return</span>&nbsp;<span class="ident" id="1440502">p</span><span class="op" id="1440503">.</span><span class="ident" id="1440504">getSlow</span><span class="op" id="1440511">(</span><span class="op" id="1440512">)</span><br>
<span class="lineno"></span><span class="op" id="1440514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="1440517">func</span>&nbsp;<span class="op" id="1440522">(</span><span class="ident" id="1440523">p</span>&nbsp;<span class="op" id="1440525">*</span><span class="ident" id="1440526">Pool</span><span class="op" id="1440530">)</span>&nbsp;<span class="ident" id="1440532">getSlow</span><span class="op" id="1440539">(</span><span class="op" id="1440540">)</span>&nbsp;<span class="op" id="1440542">(</span><span class="ident" id="1440543">x</span>&nbsp;<span class="keyword" id="1440545">interface</span><span class="op" id="1440554">{</span><span class="op" id="1440555">}</span><span class="op" id="1440556">)</span>&nbsp;<span class="op" id="1440558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440561">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;pin&nbsp;regarding&nbsp;ordering&nbsp;of&nbsp;the&nbsp;loads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440621">size</span>&nbsp;<span class="op" id="1440626">:=</span>&nbsp;<span class="ident" id="1440629">atomic</span><span class="op" id="1440635">.</span><span class="ident" id="1440636">LoadUintptr</span><span class="op" id="1440647">(</span><span class="op" id="1440648">&amp;</span><span class="ident" id="1440649">p</span><span class="op" id="1440650">.</span><span class="ident" id="1440651">localSize</span><span class="op" id="1440660">)</span>&nbsp;<span class="comment" id="1440662">//&nbsp;load-acquire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440679">local</span>&nbsp;<span class="op" id="1440685">:=</span>&nbsp;<span class="ident" id="1440688">p</span><span class="op" id="1440689">.</span><span class="ident" id="1440690">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1440720">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1440737">//&nbsp;Try&nbsp;to&nbsp;steal&nbsp;one&nbsp;element&nbsp;from&nbsp;other&nbsp;procs.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440784">pid</span>&nbsp;<span class="op" id="1440788">:=</span>&nbsp;<span class="ident" id="1440791">runtime_procPin</span><span class="op" id="1440806">(</span><span class="op" id="1440807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440810">runtime_procUnpin</span><span class="op" id="1440827">(</span><span class="op" id="1440828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440831">for</span>&nbsp;<span class="ident" id="1440835">i</span>&nbsp;<span class="op" id="1440837">:=</span>&nbsp;<span class="num" id="1440840">0</span><span class="op" id="1440841">;</span>&nbsp;<span class="ident" id="1440843">i</span>&nbsp;<span class="op" id="1440845">&lt;</span>&nbsp;<span class="builtintype" id="1440847">int</span><span class="op" id="1440850">(</span><span class="ident" id="1440851">size</span><span class="op" id="1440855">)</span><span class="op" id="1440856">;</span>&nbsp;<span class="ident" id="1440858">i</span><span class="op" id="1440859">++</span>&nbsp;<span class="op" id="1440862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440866">l</span>&nbsp;<span class="op" id="1440868">:=</span>&nbsp;<span class="ident" id="1440871">indexLocal</span><span class="op" id="1440881">(</span><span class="ident" id="1440882">local</span><span class="op" id="1440887">,</span>&nbsp;<span class="op" id="1440889">(</span><span class="ident" id="1440890">pid</span><span class="op" id="1440893">+</span><span class="ident" id="1440894">i</span><span class="op" id="1440895">+</span><span class="num" id="1440896">1</span><span class="op" id="1440897">)</span><span class="op" id="1440898">%</span><span class="builtintype" id="1440899">int</span><span class="op" id="1440902">(</span><span class="ident" id="1440903">size</span><span class="op" id="1440907">)</span><span class="op" id="1440908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440912">l</span><span class="op" id="1440913">.</span><span class="ident" id="1440914">Lock</span><span class="op" id="1440918">(</span><span class="op" id="1440919">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440923">last</span>&nbsp;<span class="op" id="1440928">:=</span>&nbsp;<span class="builtinfunc" id="1440931">len</span><span class="op" id="1440934">(</span><span class="ident" id="1440935">l</span><span class="op" id="1440936">.</span><span class="ident" id="1440937">shared</span><span class="op" id="1440943">)</span>&nbsp;<span class="op" id="1440945">-</span>&nbsp;<span class="num" id="1440947">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1440951">if</span>&nbsp;<span class="ident" id="1440954">last</span>&nbsp;<span class="op" id="1440959">&gt;=</span>&nbsp;<span class="num" id="1440962">0</span>&nbsp;<span class="op" id="1440964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440969">x</span>&nbsp;<span class="op" id="1440971">=</span>&nbsp;<span class="ident" id="1440973">l</span><span class="op" id="1440974">.</span><span class="ident" id="1440975">shared</span><span class="op" id="1440981">[</span><span class="ident" id="1440982">last</span><span class="op" id="1440986">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440991">l</span><span class="op" id="1440992">.</span><span class="ident" id="1440993">shared</span>&nbsp;<span class="op" id="1441000">=</span>&nbsp;<span class="ident" id="1441002">l</span><span class="op" id="1441003">.</span><span class="ident" id="1441004">shared</span><span class="op" id="1441010">[</span><span class="op" id="1441011">:</span><span class="ident" id="1441012">last</span><span class="op" id="1441016">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441021">l</span><span class="op" id="1441022">.</span><span class="ident" id="1441023">Unlock</span><span class="op" id="1441029">(</span><span class="op" id="1441030">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441035">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441047">l</span><span class="op" id="1441048">.</span><span class="ident" id="1441049">Unlock</span><span class="op" id="1441055">(</span><span class="op" id="1441056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441063">if</span>&nbsp;<span class="ident" id="1441066">x</span>&nbsp;<span class="op" id="1441068">==</span>&nbsp;<span class="ident" id="1441071">nil</span>&nbsp;<span class="op" id="1441075">&amp;&amp;</span>&nbsp;<span class="ident" id="1441078">p</span><span class="op" id="1441079">.</span><span class="ident" id="1441080">New</span>&nbsp;<span class="op" id="1441084">!=</span>&nbsp;<span class="ident" id="1441087">nil</span>&nbsp;<span class="op" id="1441091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441095">x</span>&nbsp;<span class="op" id="1441097">=</span>&nbsp;<span class="ident" id="1441099">p</span><span class="op" id="1441100">.</span><span class="ident" id="1441101">New</span><span class="op" id="1441104">(</span><span class="op" id="1441105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441111">return</span>&nbsp;<span class="ident" id="1441118">x</span><br>
<span class="lineno"></span><span class="op" id="1441120">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1441123">//&nbsp;pin&nbsp;pins&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;P,&nbsp;disables&nbsp;preemption&nbsp;and&nbsp;returns&nbsp;poolLocal&nbsp;pool&nbsp;for&nbsp;the&nbsp;P.</span><br>
<span class="lineno"></span><span class="comment" id="1441221">//&nbsp;Caller&nbsp;must&nbsp;call&nbsp;runtime_procUnpin()&nbsp;when&nbsp;done&nbsp;with&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1441286">func</span>&nbsp;<span class="op" id="1441291">(</span><span class="ident" id="1441292">p</span>&nbsp;<span class="op" id="1441294">*</span><span class="ident" id="1441295">Pool</span><span class="op" id="1441299">)</span>&nbsp;<span class="ident" id="1441301">pin</span><span class="op" id="1441304">(</span><span class="op" id="1441305">)</span>&nbsp;<span class="op" id="1441307">*</span><span class="ident" id="1441308">poolLocal</span>&nbsp;<span class="op" id="1441318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441321">pid</span>&nbsp;<span class="op" id="1441325">:=</span>&nbsp;<span class="ident" id="1441328">runtime_procPin</span><span class="op" id="1441343">(</span><span class="op" id="1441344">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441347">//&nbsp;In&nbsp;pinSlow&nbsp;we&nbsp;store&nbsp;to&nbsp;localSize&nbsp;and&nbsp;then&nbsp;to&nbsp;local,&nbsp;here&nbsp;we&nbsp;load&nbsp;in&nbsp;opposite&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441435">//&nbsp;Since&nbsp;we&#39;ve&nbsp;disabled&nbsp;preemption,&nbsp;GC&nbsp;can&nbsp;not&nbsp;happen&nbsp;in&nbsp;between.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441502">//&nbsp;Thus&nbsp;here&nbsp;we&nbsp;must&nbsp;observe&nbsp;local&nbsp;at&nbsp;least&nbsp;as&nbsp;large&nbsp;localSize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441567">//&nbsp;We&nbsp;can&nbsp;observe&nbsp;a&nbsp;newer/larger&nbsp;local,&nbsp;it&nbsp;is&nbsp;fine&nbsp;(we&nbsp;must&nbsp;observe&nbsp;its&nbsp;zero-initialized-ness).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441664">s</span>&nbsp;<span class="op" id="1441666">:=</span>&nbsp;<span class="ident" id="1441669">atomic</span><span class="op" id="1441675">.</span><span class="ident" id="1441676">LoadUintptr</span><span class="op" id="1441687">(</span><span class="op" id="1441688">&amp;</span><span class="ident" id="1441689">p</span><span class="op" id="1441690">.</span><span class="ident" id="1441691">localSize</span><span class="op" id="1441700">)</span>&nbsp;<span class="comment" id="1441702">//&nbsp;load-acquire</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441719">l</span>&nbsp;<span class="op" id="1441721">:=</span>&nbsp;<span class="ident" id="1441724">p</span><span class="op" id="1441725">.</span><span class="ident" id="1441726">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1441757">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441774">if</span>&nbsp;<span class="builtintype" id="1441777">uintptr</span><span class="op" id="1441784">(</span><span class="ident" id="1441785">pid</span><span class="op" id="1441788">)</span>&nbsp;<span class="op" id="1441790">&lt;</span>&nbsp;<span class="ident" id="1441792">s</span>&nbsp;<span class="op" id="1441794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441798">return</span>&nbsp;<span class="ident" id="1441805">indexLocal</span><span class="op" id="1441815">(</span><span class="ident" id="1441816">l</span><span class="op" id="1441817">,</span>&nbsp;<span class="ident" id="1441819">pid</span><span class="op" id="1441822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441828">return</span>&nbsp;<span class="ident" id="1441835">p</span><span class="op" id="1441836">.</span><span class="ident" id="1441837">pinSlow</span><span class="op" id="1441844">(</span><span class="op" id="1441845">)</span><br>
<span class="lineno">160</span><span class="op" id="1441847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1441850">func</span>&nbsp;<span class="op" id="1441855">(</span><span class="ident" id="1441856">p</span>&nbsp;<span class="op" id="1441858">*</span><span class="ident" id="1441859">Pool</span><span class="op" id="1441863">)</span>&nbsp;<span class="ident" id="1441865">pinSlow</span><span class="op" id="1441872">(</span><span class="op" id="1441873">)</span>&nbsp;<span class="op" id="1441875">*</span><span class="ident" id="1441876">poolLocal</span>&nbsp;<span class="op" id="1441886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441889">//&nbsp;Retry&nbsp;under&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441916">//&nbsp;Can&nbsp;not&nbsp;lock&nbsp;the&nbsp;mutex&nbsp;while&nbsp;pinned.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441957">runtime_procUnpin</span><span class="op" id="1441974">(</span><span class="op" id="1441975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441978">allPoolsMu</span><span class="op" id="1441988">.</span><span class="ident" id="1441989">Lock</span><span class="op" id="1441993">(</span><span class="op" id="1441994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441997">defer</span>&nbsp;<span class="ident" id="1442003">allPoolsMu</span><span class="op" id="1442013">.</span><span class="ident" id="1442014">Unlock</span><span class="op" id="1442020">(</span><span class="op" id="1442021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442024">pid</span>&nbsp;<span class="op" id="1442028">:=</span>&nbsp;<span class="ident" id="1442031">runtime_procPin</span><span class="op" id="1442046">(</span><span class="op" id="1442047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442050">//&nbsp;poolCleanup&nbsp;won&#39;t&nbsp;be&nbsp;called&nbsp;while&nbsp;we&nbsp;are&nbsp;pinned.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442103">s</span>&nbsp;<span class="op" id="1442105">:=</span>&nbsp;<span class="ident" id="1442108">p</span><span class="op" id="1442109">.</span><span class="ident" id="1442110">localSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442121">l</span>&nbsp;<span class="op" id="1442123">:=</span>&nbsp;<span class="ident" id="1442126">p</span><span class="op" id="1442127">.</span><span class="ident" id="1442128">local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442135">if</span>&nbsp;<span class="builtintype" id="1442138">uintptr</span><span class="op" id="1442145">(</span><span class="ident" id="1442146">pid</span><span class="op" id="1442149">)</span>&nbsp;<span class="op" id="1442151">&lt;</span>&nbsp;<span class="ident" id="1442153">s</span>&nbsp;<span class="op" id="1442155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442159">return</span>&nbsp;<span class="ident" id="1442166">indexLocal</span><span class="op" id="1442176">(</span><span class="ident" id="1442177">l</span><span class="op" id="1442178">,</span>&nbsp;<span class="ident" id="1442180">pid</span><span class="op" id="1442183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442186">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442189">if</span>&nbsp;<span class="ident" id="1442192">p</span><span class="op" id="1442193">.</span><span class="ident" id="1442194">local</span>&nbsp;<span class="op" id="1442200">==</span>&nbsp;<span class="ident" id="1442203">nil</span>&nbsp;<span class="op" id="1442207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442211">allPools</span>&nbsp;<span class="op" id="1442220">=</span>&nbsp;<span class="builtinfunc" id="1442222">append</span><span class="op" id="1442228">(</span><span class="ident" id="1442229">allPools</span><span class="op" id="1442237">,</span>&nbsp;<span class="ident" id="1442239">p</span><span class="op" id="1442240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442246">//&nbsp;If&nbsp;GOMAXPROCS&nbsp;changes&nbsp;between&nbsp;GCs,&nbsp;we&nbsp;re-allocate&nbsp;the&nbsp;array&nbsp;and&nbsp;lose&nbsp;the&nbsp;old&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442332">size</span>&nbsp;<span class="op" id="1442337">:=</span>&nbsp;<span class="ident" id="1442340">runtime</span><span class="op" id="1442347">.</span><span class="ident" id="1442348">GOMAXPROCS</span><span class="op" id="1442358">(</span><span class="num" id="1442359">0</span><span class="op" id="1442360">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442363">local</span>&nbsp;<span class="op" id="1442369">:=</span>&nbsp;<span class="builtinfunc" id="1442372">make</span><span class="op" id="1442376">(</span><span class="op" id="1442377">[</span><span class="op" id="1442378">]</span><span class="ident" id="1442379">poolLocal</span><span class="op" id="1442388">,</span>&nbsp;<span class="ident" id="1442390">size</span><span class="op" id="1442394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442397">atomic</span><span class="op" id="1442403">.</span><span class="ident" id="1442404">StorePointer</span><span class="op" id="1442416">(</span><span class="op" id="1442417">(</span><span class="op" id="1442418">*</span><span class="ident" id="1442419">unsafe</span><span class="op" id="1442425">.</span><span class="ident" id="1442426">Pointer</span><span class="op" id="1442433">)</span><span class="op" id="1442434">(</span><span class="op" id="1442435">&amp;</span><span class="ident" id="1442436">p</span><span class="op" id="1442437">.</span><span class="ident" id="1442438">local</span><span class="op" id="1442443">)</span><span class="op" id="1442444">,</span>&nbsp;<span class="ident" id="1442446">unsafe</span><span class="op" id="1442452">.</span><span class="ident" id="1442453">Pointer</span><span class="op" id="1442460">(</span><span class="op" id="1442461">&amp;</span><span class="ident" id="1442462">local</span><span class="op" id="1442467">[</span><span class="num" id="1442468">0</span><span class="op" id="1442469">]</span><span class="op" id="1442470">)</span><span class="op" id="1442471">)</span>&nbsp;<span class="comment" id="1442473">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442491">atomic</span><span class="op" id="1442497">.</span><span class="ident" id="1442498">StoreUintptr</span><span class="op" id="1442510">(</span><span class="op" id="1442511">&amp;</span><span class="ident" id="1442512">p</span><span class="op" id="1442513">.</span><span class="ident" id="1442514">localSize</span><span class="op" id="1442523">,</span>&nbsp;<span class="builtintype" id="1442525">uintptr</span><span class="op" id="1442532">(</span><span class="ident" id="1442533">size</span><span class="op" id="1442537">)</span><span class="op" id="1442538">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1442567">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442585">return</span>&nbsp;<span class="op" id="1442592">&amp;</span><span class="ident" id="1442593">local</span><span class="op" id="1442598">[</span><span class="ident" id="1442599">pid</span><span class="op" id="1442602">]</span><br>
<span class="lineno"></span><span class="op" id="1442604">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="1442607">func</span>&nbsp;<span class="ident" id="1442612">poolCleanup</span><span class="op" id="1442623">(</span><span class="op" id="1442624">)</span>&nbsp;<span class="op" id="1442626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442629">//&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;with&nbsp;the&nbsp;world&nbsp;stopped,&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442723">//&nbsp;It&nbsp;must&nbsp;not&nbsp;allocate&nbsp;and&nbsp;probably&nbsp;should&nbsp;not&nbsp;call&nbsp;any&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442800">//&nbsp;Defensively&nbsp;zero&nbsp;out&nbsp;everything,&nbsp;2&nbsp;reasons:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442848">//&nbsp;1.&nbsp;To&nbsp;prevent&nbsp;false&nbsp;retention&nbsp;of&nbsp;whole&nbsp;Pools.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442898">//&nbsp;2.&nbsp;If&nbsp;GC&nbsp;happens&nbsp;while&nbsp;a&nbsp;goroutine&nbsp;works&nbsp;with&nbsp;l.shared&nbsp;in&nbsp;Put/Get,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442969">//&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;will&nbsp;retain&nbsp;whole&nbsp;Pool.&nbsp;So&nbsp;next&nbsp;cycle&nbsp;memory&nbsp;consumption&nbsp;would&nbsp;be&nbsp;doubled.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443054">for</span>&nbsp;<span class="ident" id="1443058">i</span><span class="op" id="1443059">,</span>&nbsp;<span class="ident" id="1443061">p</span>&nbsp;<span class="op" id="1443063">:=</span>&nbsp;<span class="keyword" id="1443066">range</span>&nbsp;<span class="ident" id="1443072">allPools</span>&nbsp;<span class="op" id="1443081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443085">allPools</span><span class="op" id="1443093">[</span><span class="ident" id="1443094">i</span><span class="op" id="1443095">]</span>&nbsp;<span class="op" id="1443097">=</span>&nbsp;<span class="ident" id="1443099">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443105">for</span>&nbsp;<span class="ident" id="1443109">i</span>&nbsp;<span class="op" id="1443111">:=</span>&nbsp;<span class="num" id="1443114">0</span><span class="op" id="1443115">;</span>&nbsp;<span class="ident" id="1443117">i</span>&nbsp;<span class="op" id="1443119">&lt;</span>&nbsp;<span class="builtintype" id="1443121">int</span><span class="op" id="1443124">(</span><span class="ident" id="1443125">p</span><span class="op" id="1443126">.</span><span class="ident" id="1443127">localSize</span><span class="op" id="1443136">)</span><span class="op" id="1443137">;</span>&nbsp;<span class="ident" id="1443139">i</span><span class="op" id="1443140">++</span>&nbsp;<span class="op" id="1443143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443148">l</span>&nbsp;<span class="op" id="1443150">:=</span>&nbsp;<span class="ident" id="1443153">indexLocal</span><span class="op" id="1443163">(</span><span class="ident" id="1443164">p</span><span class="op" id="1443165">.</span><span class="ident" id="1443166">local</span><span class="op" id="1443171">,</span>&nbsp;<span class="ident" id="1443173">i</span><span class="op" id="1443174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443179">l</span><span class="op" id="1443180">.</span><span class="ident" id="1443181">private</span>&nbsp;<span class="op" id="1443189">=</span>&nbsp;<span class="ident" id="1443191">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443198">for</span>&nbsp;<span class="ident" id="1443202">j</span>&nbsp;<span class="op" id="1443204">:=</span>&nbsp;<span class="keyword" id="1443207">range</span>&nbsp;<span class="ident" id="1443213">l</span><span class="op" id="1443214">.</span><span class="ident" id="1443215">shared</span>&nbsp;<span class="op" id="1443222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443228">l</span><span class="op" id="1443229">.</span><span class="ident" id="1443230">shared</span><span class="op" id="1443236">[</span><span class="ident" id="1443237">j</span><span class="op" id="1443238">]</span>&nbsp;<span class="op" id="1443240">=</span>&nbsp;<span class="ident" id="1443242">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443254">l</span><span class="op" id="1443255">.</span><span class="ident" id="1443256">shared</span>&nbsp;<span class="op" id="1443263">=</span>&nbsp;<span class="ident" id="1443265">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443275">p</span><span class="op" id="1443276">.</span><span class="ident" id="1443277">local</span>&nbsp;<span class="op" id="1443283">=</span>&nbsp;<span class="ident" id="1443285">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443291">p</span><span class="op" id="1443292">.</span><span class="ident" id="1443293">localSize</span>&nbsp;<span class="op" id="1443303">=</span>&nbsp;<span class="num" id="1443305">0</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443311">allPools</span>&nbsp;<span class="op" id="1443320">=</span>&nbsp;<span class="op" id="1443322">[</span><span class="op" id="1443323">]</span><span class="op" id="1443324">*</span><span class="ident" id="1443325">Pool</span><span class="op" id="1443329">{</span><span class="op" id="1443330">}</span><br>
<span class="lineno"></span><span class="op" id="1443332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1443335">var</span>&nbsp;<span class="op" id="1443339">(</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443342">allPoolsMu</span>&nbsp;<span class="ident" id="1443353">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443360">allPools</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1443371">[</span><span class="op" id="1443372">]</span><span class="op" id="1443373">*</span><span class="ident" id="1443374">Pool</span><br>
<span class="lineno"></span><span class="op" id="1443379">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1443382">func</span>&nbsp;<span class="ident" id="1443387">init</span><span class="op" id="1443391">(</span><span class="op" id="1443392">)</span>&nbsp;<span class="op" id="1443394">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443397">runtime_registerPoolCleanup</span><span class="op" id="1443424">(</span><span class="ident" id="1443425">poolCleanup</span><span class="op" id="1443436">)</span><br>
<span class="lineno"></span><span class="op" id="1443438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1443441">func</span>&nbsp;<span class="ident" id="1443446">indexLocal</span><span class="op" id="1443456">(</span><span class="ident" id="1443457">l</span>&nbsp;<span class="ident" id="1443459">unsafe</span><span class="op" id="1443465">.</span><span class="ident" id="1443466">Pointer</span><span class="op" id="1443473">,</span>&nbsp;<span class="ident" id="1443475">i</span>&nbsp;<span class="builtintype" id="1443477">int</span><span class="op" id="1443480">)</span>&nbsp;<span class="op" id="1443482">*</span><span class="ident" id="1443483">poolLocal</span>&nbsp;<span class="op" id="1443493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443496">return</span>&nbsp;<span class="op" id="1443503">&amp;</span><span class="op" id="1443504">(</span><span class="op" id="1443505">*</span><span class="op" id="1443506">[</span><span class="num" id="1443507">1000000</span><span class="op" id="1443514">]</span><span class="ident" id="1443515">poolLocal</span><span class="op" id="1443524">)</span><span class="op" id="1443525">(</span><span class="ident" id="1443526">l</span><span class="op" id="1443527">)</span><span class="op" id="1443528">[</span><span class="ident" id="1443529">i</span><span class="op" id="1443530">]</span><br>
<span class="lineno">220</span><span class="op" id="1443532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1443535">//&nbsp;Implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1443562">func</span>&nbsp;<span class="ident" id="1443567">runtime_registerPoolCleanup</span><span class="op" id="1443594">(</span><span class="ident" id="1443595">cleanup</span>&nbsp;<span class="keyword" id="1443603">func</span><span class="op" id="1443607">(</span><span class="op" id="1443608">)</span><span class="op" id="1443609">)</span><br>
<span class="lineno"></span><span class="keyword" id="1443611">func</span>&nbsp;<span class="ident" id="1443616">runtime_procPin</span><span class="op" id="1443631">(</span><span class="op" id="1443632">)</span>&nbsp;<span class="builtintype" id="1443634">int</span><br>
<span class="lineno">225</span><span class="keyword" id="1443638">func</span>&nbsp;<span class="ident" id="1443643">runtime_procUnpin</span><span class="op" id="1443660">(</span><span class="op" id="1443661">)</span>
</div>
</body>
</html>
