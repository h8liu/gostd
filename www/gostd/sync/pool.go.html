<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html" class="current">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1359840">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1359895">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1359949">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1360000">package</span>&nbsp;<span class="ident" id="1360008">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1360014">import</span>&nbsp;<span class="op" id="1360021">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1360024">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1360035">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1360050">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1360059">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1360062">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;temporary&nbsp;objects&nbsp;that&nbsp;may&nbsp;be&nbsp;individually&nbsp;saved&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1360137">//&nbsp;retrieved.</span><br>
<span class="lineno">15</span><span class="comment" id="1360151">//</span><br>
<span class="lineno"></span><span class="comment" id="1360154">//&nbsp;Any&nbsp;item&nbsp;stored&nbsp;in&nbsp;the&nbsp;Pool&nbsp;may&nbsp;be&nbsp;removed&nbsp;automatically&nbsp;at&nbsp;any&nbsp;time&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="1360234">//&nbsp;notification.&nbsp;If&nbsp;the&nbsp;Pool&nbsp;holds&nbsp;the&nbsp;only&nbsp;reference&nbsp;when&nbsp;this&nbsp;happens,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1360311">//&nbsp;item&nbsp;might&nbsp;be&nbsp;deallocated.</span><br>
<span class="lineno"></span><span class="comment" id="1360341">//</span><br>
<span class="lineno">20</span><span class="comment" id="1360344">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;safe&nbsp;for&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="1360409">//</span><br>
<span class="lineno"></span><span class="comment" id="1360412">//&nbsp;Pool&#39;s&nbsp;purpose&nbsp;is&nbsp;to&nbsp;cache&nbsp;allocated&nbsp;but&nbsp;unused&nbsp;items&nbsp;for&nbsp;later&nbsp;reuse,</span><br>
<span class="lineno"></span><span class="comment" id="1360486">//&nbsp;relieving&nbsp;pressure&nbsp;on&nbsp;the&nbsp;garbage&nbsp;collector.&nbsp;That&nbsp;is,&nbsp;it&nbsp;makes&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1360563">//&nbsp;build&nbsp;efficient,&nbsp;thread-safe&nbsp;free&nbsp;lists.&nbsp;However,&nbsp;it&nbsp;is&nbsp;not&nbsp;suitable&nbsp;for&nbsp;all</span><br>
<span class="lineno">25</span><span class="comment" id="1360643">//&nbsp;free&nbsp;lists.</span><br>
<span class="lineno"></span><span class="comment" id="1360658">//</span><br>
<span class="lineno"></span><span class="comment" id="1360661">//&nbsp;An&nbsp;appropriate&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;to&nbsp;manage&nbsp;a&nbsp;group&nbsp;of&nbsp;temporary&nbsp;items</span><br>
<span class="lineno"></span><span class="comment" id="1360733">//&nbsp;silently&nbsp;shared&nbsp;among&nbsp;and&nbsp;potentially&nbsp;reused&nbsp;by&nbsp;concurrent&nbsp;independent</span><br>
<span class="lineno"></span><span class="comment" id="1360807">//&nbsp;clients&nbsp;of&nbsp;a&nbsp;package.&nbsp;Pool&nbsp;provides&nbsp;a&nbsp;way&nbsp;to&nbsp;amortize&nbsp;allocation&nbsp;overhead</span><br>
<span class="lineno">30</span><span class="comment" id="1360884">//&nbsp;across&nbsp;many&nbsp;clients.</span><br>
<span class="lineno"></span><span class="comment" id="1360908">//</span><br>
<span class="lineno"></span><span class="comment" id="1360911">//&nbsp;An&nbsp;example&nbsp;of&nbsp;good&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;in&nbsp;the&nbsp;fmt&nbsp;package,&nbsp;which&nbsp;maintains&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1360988">//&nbsp;dynamically-sized&nbsp;store&nbsp;of&nbsp;temporary&nbsp;output&nbsp;buffers.&nbsp;The&nbsp;store&nbsp;scales&nbsp;under</span><br>
<span class="lineno"></span><span class="comment" id="1361067">//&nbsp;load&nbsp;(when&nbsp;many&nbsp;goroutines&nbsp;are&nbsp;actively&nbsp;printing)&nbsp;and&nbsp;shrinks&nbsp;when</span><br>
<span class="lineno">35</span><span class="comment" id="1361137">//&nbsp;quiescent.</span><br>
<span class="lineno"></span><span class="comment" id="1361151">//</span><br>
<span class="lineno"></span><span class="comment" id="1361154">//&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;a&nbsp;free&nbsp;list&nbsp;maintained&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;short-lived&nbsp;object&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1361234">//&nbsp;not&nbsp;a&nbsp;suitable&nbsp;use&nbsp;for&nbsp;a&nbsp;Pool,&nbsp;since&nbsp;the&nbsp;overhead&nbsp;does&nbsp;not&nbsp;amortize&nbsp;well&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1361313">//&nbsp;that&nbsp;scenario.&nbsp;It&nbsp;is&nbsp;more&nbsp;efficient&nbsp;to&nbsp;have&nbsp;such&nbsp;objects&nbsp;implement&nbsp;their&nbsp;own</span><br>
<span class="lineno">40</span><span class="comment" id="1361393">//&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="1361407">//</span><br>
<span class="lineno"></span><span class="keyword" id="1361410">type</span>&nbsp;<span class="ident" id="1361415">Pool</span>&nbsp;<span class="keyword" id="1361420">struct</span>&nbsp;<span class="op" id="1361427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1361430">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1361440">unsafe</span><span class="op" id="1361446">.</span><span class="ident" id="1361447">Pointer</span>&nbsp;<span class="comment" id="1361455">//&nbsp;local&nbsp;fixed-size&nbsp;per-P&nbsp;pool,&nbsp;actual&nbsp;type&nbsp;is&nbsp;[P]poolLocal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1361516">localSize</span>&nbsp;<span class="builtintype" id="1361526">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1361541">//&nbsp;size&nbsp;of&nbsp;the&nbsp;local&nbsp;array</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1361570">//&nbsp;New&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;generate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1361622">//&nbsp;a&nbsp;value&nbsp;when&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1361671">//&nbsp;It&nbsp;may&nbsp;not&nbsp;be&nbsp;changed&nbsp;concurrently&nbsp;with&nbsp;calls&nbsp;to&nbsp;Get.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1361729">New</span>&nbsp;<span class="keyword" id="1361733">func</span><span class="op" id="1361737">(</span><span class="op" id="1361738">)</span>&nbsp;<span class="keyword" id="1361740">interface</span><span class="op" id="1361749">{</span><span class="op" id="1361750">}</span><br>
<span class="lineno">50</span><span class="op" id="1361752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1361755">//&nbsp;Local&nbsp;per-P&nbsp;Pool&nbsp;appendix.</span><br>
<span class="lineno"></span><span class="keyword" id="1361785">type</span>&nbsp;<span class="ident" id="1361790">poolLocal</span>&nbsp;<span class="keyword" id="1361800">struct</span>&nbsp;<span class="op" id="1361807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1361810">private</span>&nbsp;<span class="keyword" id="1361818">interface</span><span class="op" id="1361827">{</span><span class="op" id="1361828">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1361832">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;only&nbsp;by&nbsp;the&nbsp;respective&nbsp;P.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1361874">shared</span>&nbsp;&nbsp;<span class="op" id="1361882">[</span><span class="op" id="1361883">]</span><span class="keyword" id="1361884">interface</span><span class="op" id="1361893">{</span><span class="op" id="1361894">}</span>&nbsp;<span class="comment" id="1361896">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;by&nbsp;any&nbsp;P.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1361922">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1361944">//&nbsp;Protects&nbsp;shared.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1361965">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1361973">[</span><span class="num" id="1361974">128</span><span class="op" id="1361977">]</span><span class="builtintype" id="1361978">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1361987">//&nbsp;Prevents&nbsp;false&nbsp;sharing.</span><br>
<span class="lineno"></span><span class="op" id="1362014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1362017">//&nbsp;Put&nbsp;adds&nbsp;x&nbsp;to&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1362044">func</span>&nbsp;<span class="op" id="1362049">(</span><span class="ident" id="1362050">p</span>&nbsp;<span class="op" id="1362052">*</span><span class="ident" id="1362053">Pool</span><span class="op" id="1362057">)</span>&nbsp;<span class="ident" id="1362059">Put</span><span class="op" id="1362062">(</span><span class="ident" id="1362063">x</span>&nbsp;<span class="keyword" id="1362065">interface</span><span class="op" id="1362074">{</span><span class="op" id="1362075">}</span><span class="op" id="1362076">)</span>&nbsp;<span class="op" id="1362078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1362081">if</span>&nbsp;<span class="ident" id="1362084">raceenabled</span>&nbsp;<span class="op" id="1362096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1362100">//&nbsp;Under&nbsp;race&nbsp;detector&nbsp;the&nbsp;Pool&nbsp;degenerates&nbsp;into&nbsp;no-op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1362158">//&nbsp;It&#39;s&nbsp;conforming,&nbsp;simple&nbsp;and&nbsp;does&nbsp;not&nbsp;introduce&nbsp;excessive</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1362220">//&nbsp;happens-before&nbsp;edges&nbsp;between&nbsp;unrelated&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1362276">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1362284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1362287">if</span>&nbsp;<span class="ident" id="1362290">x</span>&nbsp;<span class="op" id="1362292">==</span>&nbsp;<span class="builtintype" id="1362295">nil</span>&nbsp;<span class="op" id="1362299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1362303">return</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1362311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1362314">l</span>&nbsp;<span class="op" id="1362316">:=</span>&nbsp;<span class="ident" id="1362319">p</span><span class="op" id="1362320">.</span><span class="ident" id="1362321">pin</span><span class="op" id="1362324">(</span><span class="op" id="1362325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1362328">if</span>&nbsp;<span class="ident" id="1362331">l</span><span class="op" id="1362332">.</span><span class="ident" id="1362333">private</span>&nbsp;<span class="op" id="1362341">==</span>&nbsp;<span class="builtintype" id="1362344">nil</span>&nbsp;<span class="op" id="1362348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1362352">l</span><span class="op" id="1362353">.</span><span class="ident" id="1362354">private</span>&nbsp;<span class="op" id="1362362">=</span>&nbsp;<span class="ident" id="1362364">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1362368">x</span>&nbsp;<span class="op" id="1362370">=</span>&nbsp;<span class="builtintype" id="1362372">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1362377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1362380">runtime_procUnpin</span><span class="op" id="1362397">(</span><span class="op" id="1362398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1362401">if</span>&nbsp;<span class="ident" id="1362404">x</span>&nbsp;<span class="op" id="1362406">==</span>&nbsp;<span class="builtintype" id="1362409">nil</span>&nbsp;<span class="op" id="1362413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1362417">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1362425">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1362428">l</span><span class="op" id="1362429">.</span><span class="ident" id="1362430">Lock</span><span class="op" id="1362434">(</span><span class="op" id="1362435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1362438">l</span><span class="op" id="1362439">.</span><span class="ident" id="1362440">shared</span>&nbsp;<span class="op" id="1362447">=</span>&nbsp;<span class="builtinfunc" id="1362449">append</span><span class="op" id="1362455">(</span><span class="ident" id="1362456">l</span><span class="op" id="1362457">.</span><span class="ident" id="1362458">shared</span><span class="op" id="1362464">,</span>&nbsp;<span class="ident" id="1362466">x</span><span class="op" id="1362467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1362470">l</span><span class="op" id="1362471">.</span><span class="ident" id="1362472">Unlock</span><span class="op" id="1362478">(</span><span class="op" id="1362479">)</span><br>
<span class="lineno"></span><span class="op" id="1362481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1362484">//&nbsp;Get&nbsp;selects&nbsp;an&nbsp;arbitrary&nbsp;item&nbsp;from&nbsp;the&nbsp;Pool,&nbsp;removes&nbsp;it&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1362552">//&nbsp;Pool,&nbsp;and&nbsp;returns&nbsp;it&nbsp;to&nbsp;the&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1362591">//&nbsp;Get&nbsp;may&nbsp;choose&nbsp;to&nbsp;ignore&nbsp;the&nbsp;pool&nbsp;and&nbsp;treat&nbsp;it&nbsp;as&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="1362651">//&nbsp;Callers&nbsp;should&nbsp;not&nbsp;assume&nbsp;any&nbsp;relation&nbsp;between&nbsp;values&nbsp;passed&nbsp;to&nbsp;Put&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1362726">//&nbsp;the&nbsp;values&nbsp;returned&nbsp;by&nbsp;Get.</span><br>
<span class="lineno">90</span><span class="comment" id="1362757">//</span><br>
<span class="lineno"></span><span class="comment" id="1362760">//&nbsp;If&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil&nbsp;and&nbsp;p.New&nbsp;is&nbsp;non-nil,&nbsp;Get&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="1362831">//&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;p.New.</span><br>
<span class="lineno"></span><span class="keyword" id="1362863">func</span>&nbsp;<span class="op" id="1362868">(</span><span class="ident" id="1362869">p</span>&nbsp;<span class="op" id="1362871">*</span><span class="ident" id="1362872">Pool</span><span class="op" id="1362876">)</span>&nbsp;<span class="ident" id="1362878">Get</span><span class="op" id="1362881">(</span><span class="op" id="1362882">)</span>&nbsp;<span class="keyword" id="1362884">interface</span><span class="op" id="1362893">{</span><span class="op" id="1362894">}</span>&nbsp;<span class="op" id="1362896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1362899">if</span>&nbsp;<span class="ident" id="1362902">raceenabled</span>&nbsp;<span class="op" id="1362914">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1362918">if</span>&nbsp;<span class="ident" id="1362921">p</span><span class="op" id="1362922">.</span><span class="ident" id="1362923">New</span>&nbsp;<span class="op" id="1362927">!=</span>&nbsp;<span class="builtintype" id="1362930">nil</span>&nbsp;<span class="op" id="1362934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1362939">return</span>&nbsp;<span class="ident" id="1362946">p</span><span class="op" id="1362947">.</span><span class="ident" id="1362948">New</span><span class="op" id="1362951">(</span><span class="op" id="1362952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1362956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1362960">return</span>&nbsp;<span class="builtintype" id="1362967">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1362972">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1362975">l</span>&nbsp;<span class="op" id="1362977">:=</span>&nbsp;<span class="ident" id="1362980">p</span><span class="op" id="1362981">.</span><span class="ident" id="1362982">pin</span><span class="op" id="1362985">(</span><span class="op" id="1362986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1362989">x</span>&nbsp;<span class="op" id="1362991">:=</span>&nbsp;<span class="ident" id="1362994">l</span><span class="op" id="1362995">.</span><span class="ident" id="1362996">private</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363005">l</span><span class="op" id="1363006">.</span><span class="ident" id="1363007">private</span>&nbsp;<span class="op" id="1363015">=</span>&nbsp;<span class="builtintype" id="1363017">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363022">runtime_procUnpin</span><span class="op" id="1363039">(</span><span class="op" id="1363040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1363043">if</span>&nbsp;<span class="ident" id="1363046">x</span>&nbsp;<span class="op" id="1363048">!=</span>&nbsp;<span class="builtintype" id="1363051">nil</span>&nbsp;<span class="op" id="1363055">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1363059">return</span>&nbsp;<span class="ident" id="1363066">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1363069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363072">l</span><span class="op" id="1363073">.</span><span class="ident" id="1363074">Lock</span><span class="op" id="1363078">(</span><span class="op" id="1363079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363082">last</span>&nbsp;<span class="op" id="1363087">:=</span>&nbsp;<span class="builtinfunc" id="1363090">len</span><span class="op" id="1363093">(</span><span class="ident" id="1363094">l</span><span class="op" id="1363095">.</span><span class="ident" id="1363096">shared</span><span class="op" id="1363102">)</span>&nbsp;<span class="op" id="1363104">-</span>&nbsp;<span class="num" id="1363106">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1363109">if</span>&nbsp;<span class="ident" id="1363112">last</span>&nbsp;<span class="op" id="1363117">&gt;=</span>&nbsp;<span class="num" id="1363120">0</span>&nbsp;<span class="op" id="1363122">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363126">x</span>&nbsp;<span class="op" id="1363128">=</span>&nbsp;<span class="ident" id="1363130">l</span><span class="op" id="1363131">.</span><span class="ident" id="1363132">shared</span><span class="op" id="1363138">[</span><span class="ident" id="1363139">last</span><span class="op" id="1363143">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363147">l</span><span class="op" id="1363148">.</span><span class="ident" id="1363149">shared</span>&nbsp;<span class="op" id="1363156">=</span>&nbsp;<span class="ident" id="1363158">l</span><span class="op" id="1363159">.</span><span class="ident" id="1363160">shared</span><span class="op" id="1363166">[</span><span class="op" id="1363167">:</span><span class="ident" id="1363168">last</span><span class="op" id="1363172">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1363175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363178">l</span><span class="op" id="1363179">.</span><span class="ident" id="1363180">Unlock</span><span class="op" id="1363186">(</span><span class="op" id="1363187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1363190">if</span>&nbsp;<span class="ident" id="1363193">x</span>&nbsp;<span class="op" id="1363195">!=</span>&nbsp;<span class="builtintype" id="1363198">nil</span>&nbsp;<span class="op" id="1363202">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1363206">return</span>&nbsp;<span class="ident" id="1363213">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1363216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1363219">return</span>&nbsp;<span class="ident" id="1363226">p</span><span class="op" id="1363227">.</span><span class="ident" id="1363228">getSlow</span><span class="op" id="1363235">(</span><span class="op" id="1363236">)</span><br>
<span class="lineno"></span><span class="op" id="1363238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="1363241">func</span>&nbsp;<span class="op" id="1363246">(</span><span class="ident" id="1363247">p</span>&nbsp;<span class="op" id="1363249">*</span><span class="ident" id="1363250">Pool</span><span class="op" id="1363254">)</span>&nbsp;<span class="ident" id="1363256">getSlow</span><span class="op" id="1363263">(</span><span class="op" id="1363264">)</span>&nbsp;<span class="op" id="1363266">(</span><span class="ident" id="1363267">x</span>&nbsp;<span class="keyword" id="1363269">interface</span><span class="op" id="1363278">{</span><span class="op" id="1363279">}</span><span class="op" id="1363280">)</span>&nbsp;<span class="op" id="1363282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1363285">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;pin&nbsp;regarding&nbsp;ordering&nbsp;of&nbsp;the&nbsp;loads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363345">size</span>&nbsp;<span class="op" id="1363350">:=</span>&nbsp;<span class="ident" id="1363353">atomic</span><span class="op" id="1363359">.</span><span class="ident" id="1363360">LoadUintptr</span><span class="op" id="1363371">(</span><span class="op" id="1363372">&amp;</span><span class="ident" id="1363373">p</span><span class="op" id="1363374">.</span><span class="ident" id="1363375">localSize</span><span class="op" id="1363384">)</span>&nbsp;<span class="comment" id="1363386">//&nbsp;load-acquire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363403">local</span>&nbsp;<span class="op" id="1363409">:=</span>&nbsp;<span class="ident" id="1363412">p</span><span class="op" id="1363413">.</span><span class="ident" id="1363414">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1363444">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1363461">//&nbsp;Try&nbsp;to&nbsp;steal&nbsp;one&nbsp;element&nbsp;from&nbsp;other&nbsp;procs.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363508">pid</span>&nbsp;<span class="op" id="1363512">:=</span>&nbsp;<span class="ident" id="1363515">runtime_procPin</span><span class="op" id="1363530">(</span><span class="op" id="1363531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363534">runtime_procUnpin</span><span class="op" id="1363551">(</span><span class="op" id="1363552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1363555">for</span>&nbsp;<span class="ident" id="1363559">i</span>&nbsp;<span class="op" id="1363561">:=</span>&nbsp;<span class="num" id="1363564">0</span><span class="op" id="1363565">;</span>&nbsp;<span class="ident" id="1363567">i</span>&nbsp;<span class="op" id="1363569">&lt;</span>&nbsp;<span class="builtintype" id="1363571">int</span><span class="op" id="1363574">(</span><span class="ident" id="1363575">size</span><span class="op" id="1363579">)</span><span class="op" id="1363580">;</span>&nbsp;<span class="ident" id="1363582">i</span><span class="op" id="1363583">++</span>&nbsp;<span class="op" id="1363586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363590">l</span>&nbsp;<span class="op" id="1363592">:=</span>&nbsp;<span class="ident" id="1363595">indexLocal</span><span class="op" id="1363605">(</span><span class="ident" id="1363606">local</span><span class="op" id="1363611">,</span>&nbsp;<span class="op" id="1363613">(</span><span class="ident" id="1363614">pid</span><span class="op" id="1363617">+</span><span class="ident" id="1363618">i</span><span class="op" id="1363619">+</span><span class="num" id="1363620">1</span><span class="op" id="1363621">)</span><span class="op" id="1363622">%</span><span class="builtintype" id="1363623">int</span><span class="op" id="1363626">(</span><span class="ident" id="1363627">size</span><span class="op" id="1363631">)</span><span class="op" id="1363632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363636">l</span><span class="op" id="1363637">.</span><span class="ident" id="1363638">Lock</span><span class="op" id="1363642">(</span><span class="op" id="1363643">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363647">last</span>&nbsp;<span class="op" id="1363652">:=</span>&nbsp;<span class="builtinfunc" id="1363655">len</span><span class="op" id="1363658">(</span><span class="ident" id="1363659">l</span><span class="op" id="1363660">.</span><span class="ident" id="1363661">shared</span><span class="op" id="1363667">)</span>&nbsp;<span class="op" id="1363669">-</span>&nbsp;<span class="num" id="1363671">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1363675">if</span>&nbsp;<span class="ident" id="1363678">last</span>&nbsp;<span class="op" id="1363683">&gt;=</span>&nbsp;<span class="num" id="1363686">0</span>&nbsp;<span class="op" id="1363688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363693">x</span>&nbsp;<span class="op" id="1363695">=</span>&nbsp;<span class="ident" id="1363697">l</span><span class="op" id="1363698">.</span><span class="ident" id="1363699">shared</span><span class="op" id="1363705">[</span><span class="ident" id="1363706">last</span><span class="op" id="1363710">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363715">l</span><span class="op" id="1363716">.</span><span class="ident" id="1363717">shared</span>&nbsp;<span class="op" id="1363724">=</span>&nbsp;<span class="ident" id="1363726">l</span><span class="op" id="1363727">.</span><span class="ident" id="1363728">shared</span><span class="op" id="1363734">[</span><span class="op" id="1363735">:</span><span class="ident" id="1363736">last</span><span class="op" id="1363740">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363745">l</span><span class="op" id="1363746">.</span><span class="ident" id="1363747">Unlock</span><span class="op" id="1363753">(</span><span class="op" id="1363754">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1363759">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1363767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363771">l</span><span class="op" id="1363772">.</span><span class="ident" id="1363773">Unlock</span><span class="op" id="1363779">(</span><span class="op" id="1363780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1363783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1363787">if</span>&nbsp;<span class="ident" id="1363790">x</span>&nbsp;<span class="op" id="1363792">==</span>&nbsp;<span class="builtintype" id="1363795">nil</span>&nbsp;<span class="op" id="1363799">&amp;&amp;</span>&nbsp;<span class="ident" id="1363802">p</span><span class="op" id="1363803">.</span><span class="ident" id="1363804">New</span>&nbsp;<span class="op" id="1363808">!=</span>&nbsp;<span class="builtintype" id="1363811">nil</span>&nbsp;<span class="op" id="1363815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1363819">x</span>&nbsp;<span class="op" id="1363821">=</span>&nbsp;<span class="ident" id="1363823">p</span><span class="op" id="1363824">.</span><span class="ident" id="1363825">New</span><span class="op" id="1363828">(</span><span class="op" id="1363829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1363832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1363835">return</span>&nbsp;<span class="ident" id="1363842">x</span><br>
<span class="lineno"></span><span class="op" id="1363844">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1363847">//&nbsp;pin&nbsp;pins&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;P,&nbsp;disables&nbsp;preemption&nbsp;and&nbsp;returns&nbsp;poolLocal&nbsp;pool&nbsp;for&nbsp;the&nbsp;P.</span><br>
<span class="lineno"></span><span class="comment" id="1363945">//&nbsp;Caller&nbsp;must&nbsp;call&nbsp;runtime_procUnpin()&nbsp;when&nbsp;done&nbsp;with&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1364010">func</span>&nbsp;<span class="op" id="1364015">(</span><span class="ident" id="1364016">p</span>&nbsp;<span class="op" id="1364018">*</span><span class="ident" id="1364019">Pool</span><span class="op" id="1364023">)</span>&nbsp;<span class="ident" id="1364025">pin</span><span class="op" id="1364028">(</span><span class="op" id="1364029">)</span>&nbsp;<span class="op" id="1364031">*</span><span class="ident" id="1364032">poolLocal</span>&nbsp;<span class="op" id="1364042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1364045">pid</span>&nbsp;<span class="op" id="1364049">:=</span>&nbsp;<span class="ident" id="1364052">runtime_procPin</span><span class="op" id="1364067">(</span><span class="op" id="1364068">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1364071">//&nbsp;In&nbsp;pinSlow&nbsp;we&nbsp;store&nbsp;to&nbsp;localSize&nbsp;and&nbsp;then&nbsp;to&nbsp;local,&nbsp;here&nbsp;we&nbsp;load&nbsp;in&nbsp;opposite&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1364159">//&nbsp;Since&nbsp;we&#39;ve&nbsp;disabled&nbsp;preemption,&nbsp;GC&nbsp;can&nbsp;not&nbsp;happen&nbsp;in&nbsp;between.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1364226">//&nbsp;Thus&nbsp;here&nbsp;we&nbsp;must&nbsp;observe&nbsp;local&nbsp;at&nbsp;least&nbsp;as&nbsp;large&nbsp;localSize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1364291">//&nbsp;We&nbsp;can&nbsp;observe&nbsp;a&nbsp;newer/larger&nbsp;local,&nbsp;it&nbsp;is&nbsp;fine&nbsp;(we&nbsp;must&nbsp;observe&nbsp;its&nbsp;zero-initialized-ness).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1364388">s</span>&nbsp;<span class="op" id="1364390">:=</span>&nbsp;<span class="ident" id="1364393">atomic</span><span class="op" id="1364399">.</span><span class="ident" id="1364400">LoadUintptr</span><span class="op" id="1364411">(</span><span class="op" id="1364412">&amp;</span><span class="ident" id="1364413">p</span><span class="op" id="1364414">.</span><span class="ident" id="1364415">localSize</span><span class="op" id="1364424">)</span>&nbsp;<span class="comment" id="1364426">//&nbsp;load-acquire</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1364443">l</span>&nbsp;<span class="op" id="1364445">:=</span>&nbsp;<span class="ident" id="1364448">p</span><span class="op" id="1364449">.</span><span class="ident" id="1364450">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1364481">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1364498">if</span>&nbsp;<span class="builtintype" id="1364501">uintptr</span><span class="op" id="1364508">(</span><span class="ident" id="1364509">pid</span><span class="op" id="1364512">)</span>&nbsp;<span class="op" id="1364514">&lt;</span>&nbsp;<span class="ident" id="1364516">s</span>&nbsp;<span class="op" id="1364518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1364522">return</span>&nbsp;<span class="ident" id="1364529">indexLocal</span><span class="op" id="1364539">(</span><span class="ident" id="1364540">l</span><span class="op" id="1364541">,</span>&nbsp;<span class="ident" id="1364543">pid</span><span class="op" id="1364546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1364549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1364552">return</span>&nbsp;<span class="ident" id="1364559">p</span><span class="op" id="1364560">.</span><span class="ident" id="1364561">pinSlow</span><span class="op" id="1364568">(</span><span class="op" id="1364569">)</span><br>
<span class="lineno">160</span><span class="op" id="1364571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1364574">func</span>&nbsp;<span class="op" id="1364579">(</span><span class="ident" id="1364580">p</span>&nbsp;<span class="op" id="1364582">*</span><span class="ident" id="1364583">Pool</span><span class="op" id="1364587">)</span>&nbsp;<span class="ident" id="1364589">pinSlow</span><span class="op" id="1364596">(</span><span class="op" id="1364597">)</span>&nbsp;<span class="op" id="1364599">*</span><span class="ident" id="1364600">poolLocal</span>&nbsp;<span class="op" id="1364610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1364613">//&nbsp;Retry&nbsp;under&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1364640">//&nbsp;Can&nbsp;not&nbsp;lock&nbsp;the&nbsp;mutex&nbsp;while&nbsp;pinned.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1364681">runtime_procUnpin</span><span class="op" id="1364698">(</span><span class="op" id="1364699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1364702">allPoolsMu</span><span class="op" id="1364712">.</span><span class="ident" id="1364713">Lock</span><span class="op" id="1364717">(</span><span class="op" id="1364718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1364721">defer</span>&nbsp;<span class="ident" id="1364727">allPoolsMu</span><span class="op" id="1364737">.</span><span class="ident" id="1364738">Unlock</span><span class="op" id="1364744">(</span><span class="op" id="1364745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1364748">pid</span>&nbsp;<span class="op" id="1364752">:=</span>&nbsp;<span class="ident" id="1364755">runtime_procPin</span><span class="op" id="1364770">(</span><span class="op" id="1364771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1364774">//&nbsp;poolCleanup&nbsp;won&#39;t&nbsp;be&nbsp;called&nbsp;while&nbsp;we&nbsp;are&nbsp;pinned.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1364827">s</span>&nbsp;<span class="op" id="1364829">:=</span>&nbsp;<span class="ident" id="1364832">p</span><span class="op" id="1364833">.</span><span class="ident" id="1364834">localSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1364845">l</span>&nbsp;<span class="op" id="1364847">:=</span>&nbsp;<span class="ident" id="1364850">p</span><span class="op" id="1364851">.</span><span class="ident" id="1364852">local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1364859">if</span>&nbsp;<span class="builtintype" id="1364862">uintptr</span><span class="op" id="1364869">(</span><span class="ident" id="1364870">pid</span><span class="op" id="1364873">)</span>&nbsp;<span class="op" id="1364875">&lt;</span>&nbsp;<span class="ident" id="1364877">s</span>&nbsp;<span class="op" id="1364879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1364883">return</span>&nbsp;<span class="ident" id="1364890">indexLocal</span><span class="op" id="1364900">(</span><span class="ident" id="1364901">l</span><span class="op" id="1364902">,</span>&nbsp;<span class="ident" id="1364904">pid</span><span class="op" id="1364907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1364910">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1364913">if</span>&nbsp;<span class="ident" id="1364916">p</span><span class="op" id="1364917">.</span><span class="ident" id="1364918">local</span>&nbsp;<span class="op" id="1364924">==</span>&nbsp;<span class="builtintype" id="1364927">nil</span>&nbsp;<span class="op" id="1364931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1364935">allPools</span>&nbsp;<span class="op" id="1364944">=</span>&nbsp;<span class="builtinfunc" id="1364946">append</span><span class="op" id="1364952">(</span><span class="ident" id="1364953">allPools</span><span class="op" id="1364961">,</span>&nbsp;<span class="ident" id="1364963">p</span><span class="op" id="1364964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1364967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1364970">//&nbsp;If&nbsp;GOMAXPROCS&nbsp;changes&nbsp;between&nbsp;GCs,&nbsp;we&nbsp;re-allocate&nbsp;the&nbsp;array&nbsp;and&nbsp;lose&nbsp;the&nbsp;old&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1365056">size</span>&nbsp;<span class="op" id="1365061">:=</span>&nbsp;<span class="ident" id="1365064">runtime</span><span class="op" id="1365071">.</span><span class="ident" id="1365072">GOMAXPROCS</span><span class="op" id="1365082">(</span><span class="num" id="1365083">0</span><span class="op" id="1365084">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1365087">local</span>&nbsp;<span class="op" id="1365093">:=</span>&nbsp;<span class="builtinfunc" id="1365096">make</span><span class="op" id="1365100">(</span><span class="op" id="1365101">[</span><span class="op" id="1365102">]</span><span class="ident" id="1365103">poolLocal</span><span class="op" id="1365112">,</span>&nbsp;<span class="ident" id="1365114">size</span><span class="op" id="1365118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1365121">atomic</span><span class="op" id="1365127">.</span><span class="ident" id="1365128">StorePointer</span><span class="op" id="1365140">(</span><span class="op" id="1365141">(</span><span class="op" id="1365142">*</span><span class="ident" id="1365143">unsafe</span><span class="op" id="1365149">.</span><span class="ident" id="1365150">Pointer</span><span class="op" id="1365157">)</span><span class="op" id="1365158">(</span><span class="op" id="1365159">&amp;</span><span class="ident" id="1365160">p</span><span class="op" id="1365161">.</span><span class="ident" id="1365162">local</span><span class="op" id="1365167">)</span><span class="op" id="1365168">,</span>&nbsp;<span class="ident" id="1365170">unsafe</span><span class="op" id="1365176">.</span><span class="ident" id="1365177">Pointer</span><span class="op" id="1365184">(</span><span class="op" id="1365185">&amp;</span><span class="ident" id="1365186">local</span><span class="op" id="1365191">[</span><span class="num" id="1365192">0</span><span class="op" id="1365193">]</span><span class="op" id="1365194">)</span><span class="op" id="1365195">)</span>&nbsp;<span class="comment" id="1365197">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1365215">atomic</span><span class="op" id="1365221">.</span><span class="ident" id="1365222">StoreUintptr</span><span class="op" id="1365234">(</span><span class="op" id="1365235">&amp;</span><span class="ident" id="1365236">p</span><span class="op" id="1365237">.</span><span class="ident" id="1365238">localSize</span><span class="op" id="1365247">,</span>&nbsp;<span class="builtintype" id="1365249">uintptr</span><span class="op" id="1365256">(</span><span class="ident" id="1365257">size</span><span class="op" id="1365261">)</span><span class="op" id="1365262">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1365291">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1365309">return</span>&nbsp;<span class="op" id="1365316">&amp;</span><span class="ident" id="1365317">local</span><span class="op" id="1365322">[</span><span class="ident" id="1365323">pid</span><span class="op" id="1365326">]</span><br>
<span class="lineno"></span><span class="op" id="1365328">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="1365331">func</span>&nbsp;<span class="ident" id="1365336">poolCleanup</span><span class="op" id="1365347">(</span><span class="op" id="1365348">)</span>&nbsp;<span class="op" id="1365350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1365353">//&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;with&nbsp;the&nbsp;world&nbsp;stopped,&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1365447">//&nbsp;It&nbsp;must&nbsp;not&nbsp;allocate&nbsp;and&nbsp;probably&nbsp;should&nbsp;not&nbsp;call&nbsp;any&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1365524">//&nbsp;Defensively&nbsp;zero&nbsp;out&nbsp;everything,&nbsp;2&nbsp;reasons:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1365572">//&nbsp;1.&nbsp;To&nbsp;prevent&nbsp;false&nbsp;retention&nbsp;of&nbsp;whole&nbsp;Pools.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1365622">//&nbsp;2.&nbsp;If&nbsp;GC&nbsp;happens&nbsp;while&nbsp;a&nbsp;goroutine&nbsp;works&nbsp;with&nbsp;l.shared&nbsp;in&nbsp;Put/Get,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1365693">//&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;will&nbsp;retain&nbsp;whole&nbsp;Pool.&nbsp;So&nbsp;next&nbsp;cycle&nbsp;memory&nbsp;consumption&nbsp;would&nbsp;be&nbsp;doubled.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1365778">for</span>&nbsp;<span class="ident" id="1365782">i</span><span class="op" id="1365783">,</span>&nbsp;<span class="ident" id="1365785">p</span>&nbsp;<span class="op" id="1365787">:=</span>&nbsp;<span class="keyword" id="1365790">range</span>&nbsp;<span class="ident" id="1365796">allPools</span>&nbsp;<span class="op" id="1365805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1365809">allPools</span><span class="op" id="1365817">[</span><span class="ident" id="1365818">i</span><span class="op" id="1365819">]</span>&nbsp;<span class="op" id="1365821">=</span>&nbsp;<span class="builtintype" id="1365823">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1365829">for</span>&nbsp;<span class="ident" id="1365833">i</span>&nbsp;<span class="op" id="1365835">:=</span>&nbsp;<span class="num" id="1365838">0</span><span class="op" id="1365839">;</span>&nbsp;<span class="ident" id="1365841">i</span>&nbsp;<span class="op" id="1365843">&lt;</span>&nbsp;<span class="builtintype" id="1365845">int</span><span class="op" id="1365848">(</span><span class="ident" id="1365849">p</span><span class="op" id="1365850">.</span><span class="ident" id="1365851">localSize</span><span class="op" id="1365860">)</span><span class="op" id="1365861">;</span>&nbsp;<span class="ident" id="1365863">i</span><span class="op" id="1365864">++</span>&nbsp;<span class="op" id="1365867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1365872">l</span>&nbsp;<span class="op" id="1365874">:=</span>&nbsp;<span class="ident" id="1365877">indexLocal</span><span class="op" id="1365887">(</span><span class="ident" id="1365888">p</span><span class="op" id="1365889">.</span><span class="ident" id="1365890">local</span><span class="op" id="1365895">,</span>&nbsp;<span class="ident" id="1365897">i</span><span class="op" id="1365898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1365903">l</span><span class="op" id="1365904">.</span><span class="ident" id="1365905">private</span>&nbsp;<span class="op" id="1365913">=</span>&nbsp;<span class="builtintype" id="1365915">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1365922">for</span>&nbsp;<span class="ident" id="1365926">j</span>&nbsp;<span class="op" id="1365928">:=</span>&nbsp;<span class="keyword" id="1365931">range</span>&nbsp;<span class="ident" id="1365937">l</span><span class="op" id="1365938">.</span><span class="ident" id="1365939">shared</span>&nbsp;<span class="op" id="1365946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1365952">l</span><span class="op" id="1365953">.</span><span class="ident" id="1365954">shared</span><span class="op" id="1365960">[</span><span class="ident" id="1365961">j</span><span class="op" id="1365962">]</span>&nbsp;<span class="op" id="1365964">=</span>&nbsp;<span class="builtintype" id="1365966">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1365973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1365978">l</span><span class="op" id="1365979">.</span><span class="ident" id="1365980">shared</span>&nbsp;<span class="op" id="1365987">=</span>&nbsp;<span class="builtintype" id="1365989">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1365995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1365999">p</span><span class="op" id="1366000">.</span><span class="ident" id="1366001">local</span>&nbsp;<span class="op" id="1366007">=</span>&nbsp;<span class="builtintype" id="1366009">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1366015">p</span><span class="op" id="1366016">.</span><span class="ident" id="1366017">localSize</span>&nbsp;<span class="op" id="1366027">=</span>&nbsp;<span class="num" id="1366029">0</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1366032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1366035">allPools</span>&nbsp;<span class="op" id="1366044">=</span>&nbsp;<span class="op" id="1366046">[</span><span class="op" id="1366047">]</span><span class="op" id="1366048">*</span><span class="ident" id="1366049">Pool</span><span class="op" id="1366053">{</span><span class="op" id="1366054">}</span><br>
<span class="lineno"></span><span class="op" id="1366056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1366059">var</span>&nbsp;<span class="op" id="1366063">(</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1366066">allPoolsMu</span>&nbsp;<span class="ident" id="1366077">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1366084">allPools</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1366095">[</span><span class="op" id="1366096">]</span><span class="op" id="1366097">*</span><span class="ident" id="1366098">Pool</span><br>
<span class="lineno"></span><span class="op" id="1366103">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1366106">func</span>&nbsp;<span class="ident" id="1366111">init</span><span class="op" id="1366115">(</span><span class="op" id="1366116">)</span>&nbsp;<span class="op" id="1366118">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1366121">runtime_registerPoolCleanup</span><span class="op" id="1366148">(</span><span class="ident" id="1366149">poolCleanup</span><span class="op" id="1366160">)</span><br>
<span class="lineno"></span><span class="op" id="1366162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1366165">func</span>&nbsp;<span class="ident" id="1366170">indexLocal</span><span class="op" id="1366180">(</span><span class="ident" id="1366181">l</span>&nbsp;<span class="ident" id="1366183">unsafe</span><span class="op" id="1366189">.</span><span class="ident" id="1366190">Pointer</span><span class="op" id="1366197">,</span>&nbsp;<span class="ident" id="1366199">i</span>&nbsp;<span class="builtintype" id="1366201">int</span><span class="op" id="1366204">)</span>&nbsp;<span class="op" id="1366206">*</span><span class="ident" id="1366207">poolLocal</span>&nbsp;<span class="op" id="1366217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1366220">return</span>&nbsp;<span class="op" id="1366227">&amp;</span><span class="op" id="1366228">(</span><span class="op" id="1366229">*</span><span class="op" id="1366230">[</span><span class="num" id="1366231">1000000</span><span class="op" id="1366238">]</span><span class="ident" id="1366239">poolLocal</span><span class="op" id="1366248">)</span><span class="op" id="1366249">(</span><span class="ident" id="1366250">l</span><span class="op" id="1366251">)</span><span class="op" id="1366252">[</span><span class="ident" id="1366253">i</span><span class="op" id="1366254">]</span><br>
<span class="lineno">220</span><span class="op" id="1366256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1366259">//&nbsp;Implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1366286">func</span>&nbsp;<span class="ident" id="1366291">runtime_registerPoolCleanup</span><span class="op" id="1366318">(</span><span class="ident" id="1366319">cleanup</span>&nbsp;<span class="keyword" id="1366327">func</span><span class="op" id="1366331">(</span><span class="op" id="1366332">)</span><span class="op" id="1366333">)</span><br>
<span class="lineno"></span><span class="keyword" id="1366335">func</span>&nbsp;<span class="ident" id="1366340">runtime_procPin</span><span class="op" id="1366355">(</span><span class="op" id="1366356">)</span>&nbsp;<span class="builtintype" id="1366358">int</span><br>
<span class="lineno">225</span><span class="keyword" id="1366362">func</span>&nbsp;<span class="ident" id="1366367">runtime_procUnpin</span><span class="op" id="1366384">(</span><span class="op" id="1366385">)</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
