<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/gif</h2>
<ul>
<li><a href="/gostd/image/gif/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/gif/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/gif/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/image/gif/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6194913">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6194968">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6195022">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6195073">package</span>&nbsp;<span class="ident" id="6195081">gif</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6195086">import</span>&nbsp;<span class="op" id="6195093">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6195096">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6195105">&#34;compress/lzw&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6195121">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6195131">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6195140">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6195155">&#34;image/color/palette&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6195178">&#34;image/draw&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6195192">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6195197">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6195200">//&nbsp;Graphic&nbsp;control&nbsp;extension&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="6195237">const</span>&nbsp;<span class="op" id="6195243">(</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6195246">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6195258">=</span>&nbsp;<span class="num" id="6195260">0xF9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6195266">gcBlockSize</span>&nbsp;<span class="op" id="6195278">=</span>&nbsp;<span class="num" id="6195280">0x04</span><br>
<span class="lineno"></span><span class="op" id="6195285">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6195288">var</span>&nbsp;<span class="ident" id="6195292">log2Lookup</span>&nbsp;<span class="op" id="6195303">=</span>&nbsp;<span class="op" id="6195305">[</span><span class="num" id="6195306">8</span><span class="op" id="6195307">]</span><span class="builtintype" id="6195308">int</span><span class="op" id="6195311">{</span><span class="num" id="6195312">2</span><span class="op" id="6195313">,</span>&nbsp;<span class="num" id="6195315">4</span><span class="op" id="6195316">,</span>&nbsp;<span class="num" id="6195318">8</span><span class="op" id="6195319">,</span>&nbsp;<span class="num" id="6195321">16</span><span class="op" id="6195323">,</span>&nbsp;<span class="num" id="6195325">32</span><span class="op" id="6195327">,</span>&nbsp;<span class="num" id="6195329">64</span><span class="op" id="6195331">,</span>&nbsp;<span class="num" id="6195333">128</span><span class="op" id="6195336">,</span>&nbsp;<span class="num" id="6195338">256</span><span class="op" id="6195341">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6195344">func</span>&nbsp;<span class="ident" id="6195349">log2</span><span class="op" id="6195353">(</span><span class="ident" id="6195354">x</span>&nbsp;<span class="builtintype" id="6195356">int</span><span class="op" id="6195359">)</span>&nbsp;<span class="builtintype" id="6195361">int</span>&nbsp;<span class="op" id="6195365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6195368">for</span>&nbsp;<span class="ident" id="6195372">i</span><span class="op" id="6195373">,</span>&nbsp;<span class="ident" id="6195375">v</span>&nbsp;<span class="op" id="6195377">:=</span>&nbsp;<span class="keyword" id="6195380">range</span>&nbsp;<span class="ident" id="6195386">log2Lookup</span>&nbsp;<span class="op" id="6195397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6195401">if</span>&nbsp;<span class="ident" id="6195404">x</span>&nbsp;<span class="op" id="6195406">&lt;=</span>&nbsp;<span class="ident" id="6195409">v</span>&nbsp;<span class="op" id="6195411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6195416">return</span>&nbsp;<span class="ident" id="6195423">i</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6195427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6195430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6195433">return</span>&nbsp;<span class="op" id="6195440">-</span><span class="num" id="6195441">1</span><br>
<span class="lineno"></span><span class="op" id="6195443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="6195446">//&nbsp;Little-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="6195464">func</span>&nbsp;<span class="ident" id="6195469">writeUint16</span><span class="op" id="6195480">(</span><span class="ident" id="6195481">b</span>&nbsp;<span class="op" id="6195483">[</span><span class="op" id="6195484">]</span><span class="builtintype" id="6195485">uint8</span><span class="op" id="6195490">,</span>&nbsp;<span class="ident" id="6195492">u</span>&nbsp;<span class="builtintype" id="6195494">uint16</span><span class="op" id="6195500">)</span>&nbsp;<span class="op" id="6195502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6195505">b</span><span class="op" id="6195506">[</span><span class="num" id="6195507">0</span><span class="op" id="6195508">]</span>&nbsp;<span class="op" id="6195510">=</span>&nbsp;<span class="builtintype" id="6195512">uint8</span><span class="op" id="6195517">(</span><span class="ident" id="6195518">u</span><span class="op" id="6195519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6195522">b</span><span class="op" id="6195523">[</span><span class="num" id="6195524">1</span><span class="op" id="6195525">]</span>&nbsp;<span class="op" id="6195527">=</span>&nbsp;<span class="builtintype" id="6195529">uint8</span><span class="op" id="6195534">(</span><span class="ident" id="6195535">u</span>&nbsp;<span class="op" id="6195537">&gt;&gt;</span>&nbsp;<span class="num" id="6195540">8</span><span class="op" id="6195541">)</span><br>
<span class="lineno"></span><span class="op" id="6195543">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="6195546">//&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6195578">type</span>&nbsp;<span class="ident" id="6195583">writer</span>&nbsp;<span class="keyword" id="6195590">interface</span>&nbsp;<span class="op" id="6195600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6195603">Flush</span><span class="op" id="6195608">(</span><span class="op" id="6195609">)</span>&nbsp;<span class="builtintype" id="6195611">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6195618">io</span><span class="op" id="6195620">.</span><span class="ident" id="6195621">Writer</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6195629">io</span><span class="op" id="6195631">.</span><span class="ident" id="6195632">ByteWriter</span><br>
<span class="lineno"></span><span class="op" id="6195643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6195646">//&nbsp;encoder&nbsp;encodes&nbsp;an&nbsp;image&nbsp;to&nbsp;the&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="6195693">type</span>&nbsp;<span class="ident" id="6195698">encoder</span>&nbsp;<span class="keyword" id="6195706">struct</span>&nbsp;<span class="op" id="6195713">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6195716">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;to&nbsp;write&nbsp;to.&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6195791">//&nbsp;writing.&nbsp;All&nbsp;attempted&nbsp;writes&nbsp;after&nbsp;the&nbsp;first&nbsp;error&nbsp;become&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6195862">w</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6195866">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6195874">err</span>&nbsp;<span class="builtintype" id="6195878">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6195885">//&nbsp;g&nbsp;is&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;data&nbsp;that&nbsp;is&nbsp;being&nbsp;encoded.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6195941">g</span>&nbsp;<span class="op" id="6195943">*</span><span class="ident" id="6195944">GIF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6195949">//&nbsp;buf&nbsp;is&nbsp;a&nbsp;scratch&nbsp;buffer.&nbsp;It&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;768&nbsp;so&nbsp;we&nbsp;can&nbsp;write&nbsp;the&nbsp;color&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6196033">buf</span>&nbsp;<span class="op" id="6196037">[</span><span class="num" id="6196038">1024</span><span class="op" id="6196042">]</span><span class="builtintype" id="6196043">byte</span><br>
<span class="lineno"></span><span class="op" id="6196048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6196051">//&nbsp;blockWriter&nbsp;writes&nbsp;the&nbsp;block&nbsp;structure&nbsp;of&nbsp;GIF&nbsp;image&nbsp;data,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="6196118">//&nbsp;comprises&nbsp;(n,&nbsp;(n&nbsp;bytes))&nbsp;blocks,&nbsp;with&nbsp;1&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;255.&nbsp;It&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6196184">//&nbsp;writer&nbsp;given&nbsp;to&nbsp;the&nbsp;LZW&nbsp;encoder,&nbsp;which&nbsp;is&nbsp;thus&nbsp;immune&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6196248">//&nbsp;blocking.</span><br>
<span class="lineno"></span><span class="keyword" id="6196261">type</span>&nbsp;<span class="ident" id="6196266">blockWriter</span>&nbsp;<span class="keyword" id="6196278">struct</span>&nbsp;<span class="op" id="6196285">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6196288">e</span>&nbsp;<span class="op" id="6196290">*</span><span class="ident" id="6196291">encoder</span><br>
<span class="lineno"></span><span class="op" id="6196299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6196302">func</span>&nbsp;<span class="op" id="6196307">(</span><span class="ident" id="6196308">b</span>&nbsp;<span class="ident" id="6196310">blockWriter</span><span class="op" id="6196321">)</span>&nbsp;<span class="ident" id="6196323">Write</span><span class="op" id="6196328">(</span><span class="ident" id="6196329">data</span>&nbsp;<span class="op" id="6196334">[</span><span class="op" id="6196335">]</span><span class="builtintype" id="6196336">byte</span><span class="op" id="6196340">)</span>&nbsp;<span class="op" id="6196342">(</span><span class="builtintype" id="6196343">int</span><span class="op" id="6196346">,</span>&nbsp;<span class="builtintype" id="6196348">error</span><span class="op" id="6196353">)</span>&nbsp;<span class="op" id="6196355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196358">if</span>&nbsp;<span class="ident" id="6196361">b</span><span class="op" id="6196362">.</span><span class="ident" id="6196363">e</span><span class="op" id="6196364">.</span><span class="ident" id="6196365">err</span>&nbsp;<span class="op" id="6196369">!=</span>&nbsp;<span class="ident" id="6196372">nil</span>&nbsp;<span class="op" id="6196376">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196380">return</span>&nbsp;<span class="num" id="6196387">0</span><span class="op" id="6196388">,</span>&nbsp;<span class="ident" id="6196390">b</span><span class="op" id="6196391">.</span><span class="ident" id="6196392">e</span><span class="op" id="6196393">.</span><span class="ident" id="6196394">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6196399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196402">if</span>&nbsp;<span class="builtinfunc" id="6196405">len</span><span class="op" id="6196408">(</span><span class="ident" id="6196409">data</span><span class="op" id="6196413">)</span>&nbsp;<span class="op" id="6196415">==</span>&nbsp;<span class="num" id="6196418">0</span>&nbsp;<span class="op" id="6196420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196424">return</span>&nbsp;<span class="num" id="6196431">0</span><span class="op" id="6196432">,</span>&nbsp;<span class="ident" id="6196434">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6196439">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6196442">total</span>&nbsp;<span class="op" id="6196448">:=</span>&nbsp;<span class="num" id="6196451">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196454">for</span>&nbsp;<span class="ident" id="6196458">total</span>&nbsp;<span class="op" id="6196464">&lt;</span>&nbsp;<span class="builtinfunc" id="6196466">len</span><span class="op" id="6196469">(</span><span class="ident" id="6196470">data</span><span class="op" id="6196474">)</span>&nbsp;<span class="op" id="6196476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6196480">n</span>&nbsp;<span class="op" id="6196482">:=</span>&nbsp;<span class="builtinfunc" id="6196485">copy</span><span class="op" id="6196489">(</span><span class="ident" id="6196490">b</span><span class="op" id="6196491">.</span><span class="ident" id="6196492">e</span><span class="op" id="6196493">.</span><span class="ident" id="6196494">buf</span><span class="op" id="6196497">[</span><span class="num" id="6196498">1</span><span class="op" id="6196499">:</span><span class="num" id="6196500">256</span><span class="op" id="6196503">]</span><span class="op" id="6196504">,</span>&nbsp;<span class="ident" id="6196506">data</span><span class="op" id="6196510">[</span><span class="ident" id="6196511">total</span><span class="op" id="6196516">:</span><span class="op" id="6196517">]</span><span class="op" id="6196518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6196522">total</span>&nbsp;<span class="op" id="6196528">+=</span>&nbsp;<span class="ident" id="6196531">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6196535">b</span><span class="op" id="6196536">.</span><span class="ident" id="6196537">e</span><span class="op" id="6196538">.</span><span class="ident" id="6196539">buf</span><span class="op" id="6196542">[</span><span class="num" id="6196543">0</span><span class="op" id="6196544">]</span>&nbsp;<span class="op" id="6196546">=</span>&nbsp;<span class="builtintype" id="6196548">uint8</span><span class="op" id="6196553">(</span><span class="ident" id="6196554">n</span><span class="op" id="6196555">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6196560">n</span><span class="op" id="6196561">,</span>&nbsp;<span class="ident" id="6196563">b</span><span class="op" id="6196564">.</span><span class="ident" id="6196565">e</span><span class="op" id="6196566">.</span><span class="ident" id="6196567">err</span>&nbsp;<span class="op" id="6196571">=</span>&nbsp;<span class="ident" id="6196573">b</span><span class="op" id="6196574">.</span><span class="ident" id="6196575">e</span><span class="op" id="6196576">.</span><span class="ident" id="6196577">w</span><span class="op" id="6196578">.</span><span class="ident" id="6196579">Write</span><span class="op" id="6196584">(</span><span class="ident" id="6196585">b</span><span class="op" id="6196586">.</span><span class="ident" id="6196587">e</span><span class="op" id="6196588">.</span><span class="ident" id="6196589">buf</span><span class="op" id="6196592">[</span><span class="op" id="6196593">:</span><span class="ident" id="6196594">n</span><span class="op" id="6196595">+</span><span class="num" id="6196596">1</span><span class="op" id="6196597">]</span><span class="op" id="6196598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196602">if</span>&nbsp;<span class="ident" id="6196605">b</span><span class="op" id="6196606">.</span><span class="ident" id="6196607">e</span><span class="op" id="6196608">.</span><span class="ident" id="6196609">err</span>&nbsp;<span class="op" id="6196613">!=</span>&nbsp;<span class="ident" id="6196616">nil</span>&nbsp;<span class="op" id="6196620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196625">return</span>&nbsp;<span class="num" id="6196632">0</span><span class="op" id="6196633">,</span>&nbsp;<span class="ident" id="6196635">b</span><span class="op" id="6196636">.</span><span class="ident" id="6196637">e</span><span class="op" id="6196638">.</span><span class="ident" id="6196639">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6196645">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6196648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196651">return</span>&nbsp;<span class="ident" id="6196658">total</span><span class="op" id="6196663">,</span>&nbsp;<span class="ident" id="6196665">b</span><span class="op" id="6196666">.</span><span class="ident" id="6196667">e</span><span class="op" id="6196668">.</span><span class="ident" id="6196669">err</span><br>
<span class="lineno"></span><span class="op" id="6196673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6196676">func</span>&nbsp;<span class="op" id="6196681">(</span><span class="ident" id="6196682">e</span>&nbsp;<span class="op" id="6196684">*</span><span class="ident" id="6196685">encoder</span><span class="op" id="6196692">)</span>&nbsp;<span class="ident" id="6196694">flush</span><span class="op" id="6196699">(</span><span class="op" id="6196700">)</span>&nbsp;<span class="op" id="6196702">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196705">if</span>&nbsp;<span class="ident" id="6196708">e</span><span class="op" id="6196709">.</span><span class="ident" id="6196710">err</span>&nbsp;<span class="op" id="6196714">!=</span>&nbsp;<span class="ident" id="6196717">nil</span>&nbsp;<span class="op" id="6196721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196725">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6196733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6196736">e</span><span class="op" id="6196737">.</span><span class="ident" id="6196738">err</span>&nbsp;<span class="op" id="6196742">=</span>&nbsp;<span class="ident" id="6196744">e</span><span class="op" id="6196745">.</span><span class="ident" id="6196746">w</span><span class="op" id="6196747">.</span><span class="ident" id="6196748">Flush</span><span class="op" id="6196753">(</span><span class="op" id="6196754">)</span><br>
<span class="lineno"></span><span class="op" id="6196756">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="6196759">func</span>&nbsp;<span class="op" id="6196764">(</span><span class="ident" id="6196765">e</span>&nbsp;<span class="op" id="6196767">*</span><span class="ident" id="6196768">encoder</span><span class="op" id="6196775">)</span>&nbsp;<span class="ident" id="6196777">write</span><span class="op" id="6196782">(</span><span class="ident" id="6196783">p</span>&nbsp;<span class="op" id="6196785">[</span><span class="op" id="6196786">]</span><span class="builtintype" id="6196787">byte</span><span class="op" id="6196791">)</span>&nbsp;<span class="op" id="6196793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196796">if</span>&nbsp;<span class="ident" id="6196799">e</span><span class="op" id="6196800">.</span><span class="ident" id="6196801">err</span>&nbsp;<span class="op" id="6196805">!=</span>&nbsp;<span class="ident" id="6196808">nil</span>&nbsp;<span class="op" id="6196812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196816">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6196824">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6196827">_</span><span class="op" id="6196828">,</span>&nbsp;<span class="ident" id="6196830">e</span><span class="op" id="6196831">.</span><span class="ident" id="6196832">err</span>&nbsp;<span class="op" id="6196836">=</span>&nbsp;<span class="ident" id="6196838">e</span><span class="op" id="6196839">.</span><span class="ident" id="6196840">w</span><span class="op" id="6196841">.</span><span class="ident" id="6196842">Write</span><span class="op" id="6196847">(</span><span class="ident" id="6196848">p</span><span class="op" id="6196849">)</span><br>
<span class="lineno"></span><span class="op" id="6196851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6196854">func</span>&nbsp;<span class="op" id="6196859">(</span><span class="ident" id="6196860">e</span>&nbsp;<span class="op" id="6196862">*</span><span class="ident" id="6196863">encoder</span><span class="op" id="6196870">)</span>&nbsp;<span class="ident" id="6196872">writeByte</span><span class="op" id="6196881">(</span><span class="ident" id="6196882">b</span>&nbsp;<span class="builtintype" id="6196884">byte</span><span class="op" id="6196888">)</span>&nbsp;<span class="op" id="6196890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196893">if</span>&nbsp;<span class="ident" id="6196896">e</span><span class="op" id="6196897">.</span><span class="ident" id="6196898">err</span>&nbsp;<span class="op" id="6196902">!=</span>&nbsp;<span class="ident" id="6196905">nil</span>&nbsp;<span class="op" id="6196909">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196913">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6196921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6196924">e</span><span class="op" id="6196925">.</span><span class="ident" id="6196926">err</span>&nbsp;<span class="op" id="6196930">=</span>&nbsp;<span class="ident" id="6196932">e</span><span class="op" id="6196933">.</span><span class="ident" id="6196934">w</span><span class="op" id="6196935">.</span><span class="ident" id="6196936">WriteByte</span><span class="op" id="6196945">(</span><span class="ident" id="6196946">b</span><span class="op" id="6196947">)</span><br>
<span class="lineno"></span><span class="op" id="6196949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="6196952">func</span>&nbsp;<span class="op" id="6196957">(</span><span class="ident" id="6196958">e</span>&nbsp;<span class="op" id="6196960">*</span><span class="ident" id="6196961">encoder</span><span class="op" id="6196968">)</span>&nbsp;<span class="ident" id="6196970">writeHeader</span><span class="op" id="6196981">(</span><span class="op" id="6196982">)</span>&nbsp;<span class="op" id="6196984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6196987">if</span>&nbsp;<span class="ident" id="6196990">e</span><span class="op" id="6196991">.</span><span class="ident" id="6196992">err</span>&nbsp;<span class="op" id="6196996">!=</span>&nbsp;<span class="ident" id="6196999">nil</span>&nbsp;<span class="op" id="6197003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6197007">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6197015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197018">_</span><span class="op" id="6197019">,</span>&nbsp;<span class="ident" id="6197021">e</span><span class="op" id="6197022">.</span><span class="ident" id="6197023">err</span>&nbsp;<span class="op" id="6197027">=</span>&nbsp;<span class="ident" id="6197029">io</span><span class="op" id="6197031">.</span><span class="ident" id="6197032">WriteString</span><span class="op" id="6197043">(</span><span class="ident" id="6197044">e</span><span class="op" id="6197045">.</span><span class="ident" id="6197046">w</span><span class="op" id="6197047">,</span>&nbsp;<span class="string" id="6197049">&#34;GIF89a&#34;</span><span class="op" id="6197057">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6197060">if</span>&nbsp;<span class="ident" id="6197063">e</span><span class="op" id="6197064">.</span><span class="ident" id="6197065">err</span>&nbsp;<span class="op" id="6197069">!=</span>&nbsp;<span class="ident" id="6197072">nil</span>&nbsp;<span class="op" id="6197076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6197080">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6197088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197092">pm</span>&nbsp;<span class="op" id="6197095">:=</span>&nbsp;<span class="ident" id="6197098">e</span><span class="op" id="6197099">.</span><span class="ident" id="6197100">g</span><span class="op" id="6197101">.</span><span class="ident" id="6197102">Image</span><span class="op" id="6197107">[</span><span class="num" id="6197108">0</span><span class="op" id="6197109">]</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6197112">//&nbsp;Logical&nbsp;screen&nbsp;width&nbsp;and&nbsp;height.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197149">writeUint16</span><span class="op" id="6197160">(</span><span class="ident" id="6197161">e</span><span class="op" id="6197162">.</span><span class="ident" id="6197163">buf</span><span class="op" id="6197166">[</span><span class="num" id="6197167">0</span><span class="op" id="6197168">:</span><span class="num" id="6197169">2</span><span class="op" id="6197170">]</span><span class="op" id="6197171">,</span>&nbsp;<span class="builtintype" id="6197173">uint16</span><span class="op" id="6197179">(</span><span class="ident" id="6197180">pm</span><span class="op" id="6197182">.</span><span class="ident" id="6197183">Bounds</span><span class="op" id="6197189">(</span><span class="op" id="6197190">)</span><span class="op" id="6197191">.</span><span class="ident" id="6197192">Dx</span><span class="op" id="6197194">(</span><span class="op" id="6197195">)</span><span class="op" id="6197196">)</span><span class="op" id="6197197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197200">writeUint16</span><span class="op" id="6197211">(</span><span class="ident" id="6197212">e</span><span class="op" id="6197213">.</span><span class="ident" id="6197214">buf</span><span class="op" id="6197217">[</span><span class="num" id="6197218">2</span><span class="op" id="6197219">:</span><span class="num" id="6197220">4</span><span class="op" id="6197221">]</span><span class="op" id="6197222">,</span>&nbsp;<span class="builtintype" id="6197224">uint16</span><span class="op" id="6197230">(</span><span class="ident" id="6197231">pm</span><span class="op" id="6197233">.</span><span class="ident" id="6197234">Bounds</span><span class="op" id="6197240">(</span><span class="op" id="6197241">)</span><span class="op" id="6197242">.</span><span class="ident" id="6197243">Dy</span><span class="op" id="6197245">(</span><span class="op" id="6197246">)</span><span class="op" id="6197247">)</span><span class="op" id="6197248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197251">e</span><span class="op" id="6197252">.</span><span class="ident" id="6197253">write</span><span class="op" id="6197258">(</span><span class="ident" id="6197259">e</span><span class="op" id="6197260">.</span><span class="ident" id="6197261">buf</span><span class="op" id="6197264">[</span><span class="op" id="6197265">:</span><span class="num" id="6197266">4</span><span class="op" id="6197267">]</span><span class="op" id="6197268">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6197272">//&nbsp;All&nbsp;frames&nbsp;have&nbsp;a&nbsp;local&nbsp;color&nbsp;table,&nbsp;so&nbsp;a&nbsp;global&nbsp;color&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6197337">//&nbsp;is&nbsp;not&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197356">e</span><span class="op" id="6197357">.</span><span class="ident" id="6197358">buf</span><span class="op" id="6197361">[</span><span class="num" id="6197362">0</span><span class="op" id="6197363">]</span>&nbsp;<span class="op" id="6197365">=</span>&nbsp;<span class="num" id="6197367">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197373">e</span><span class="op" id="6197374">.</span><span class="ident" id="6197375">buf</span><span class="op" id="6197378">[</span><span class="num" id="6197379">1</span><span class="op" id="6197380">]</span>&nbsp;<span class="op" id="6197382">=</span>&nbsp;<span class="num" id="6197384">0x00</span>&nbsp;<span class="comment" id="6197389">//&nbsp;Background&nbsp;Color&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197417">e</span><span class="op" id="6197418">.</span><span class="ident" id="6197419">buf</span><span class="op" id="6197422">[</span><span class="num" id="6197423">2</span><span class="op" id="6197424">]</span>&nbsp;<span class="op" id="6197426">=</span>&nbsp;<span class="num" id="6197428">0x00</span>&nbsp;<span class="comment" id="6197433">//&nbsp;Pixel&nbsp;Aspect&nbsp;Ratio.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197457">e</span><span class="op" id="6197458">.</span><span class="ident" id="6197459">write</span><span class="op" id="6197464">(</span><span class="ident" id="6197465">e</span><span class="op" id="6197466">.</span><span class="ident" id="6197467">buf</span><span class="op" id="6197470">[</span><span class="op" id="6197471">:</span><span class="num" id="6197472">3</span><span class="op" id="6197473">]</span><span class="op" id="6197474">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6197478">//&nbsp;Add&nbsp;animation&nbsp;info&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6197515">if</span>&nbsp;<span class="builtinfunc" id="6197518">len</span><span class="op" id="6197521">(</span><span class="ident" id="6197522">e</span><span class="op" id="6197523">.</span><span class="ident" id="6197524">g</span><span class="op" id="6197525">.</span><span class="ident" id="6197526">Image</span><span class="op" id="6197531">)</span>&nbsp;<span class="op" id="6197533">&gt;</span>&nbsp;<span class="num" id="6197535">1</span>&nbsp;<span class="op" id="6197537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197541">e</span><span class="op" id="6197542">.</span><span class="ident" id="6197543">buf</span><span class="op" id="6197546">[</span><span class="num" id="6197547">0</span><span class="op" id="6197548">]</span>&nbsp;<span class="op" id="6197550">=</span>&nbsp;<span class="num" id="6197552">0x21</span>&nbsp;<span class="comment" id="6197557">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197584">e</span><span class="op" id="6197585">.</span><span class="ident" id="6197586">buf</span><span class="op" id="6197589">[</span><span class="num" id="6197590">1</span><span class="op" id="6197591">]</span>&nbsp;<span class="op" id="6197593">=</span>&nbsp;<span class="num" id="6197595">0xff</span>&nbsp;<span class="comment" id="6197600">//&nbsp;Application&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197624">e</span><span class="op" id="6197625">.</span><span class="ident" id="6197626">buf</span><span class="op" id="6197629">[</span><span class="num" id="6197630">2</span><span class="op" id="6197631">]</span>&nbsp;<span class="op" id="6197633">=</span>&nbsp;<span class="num" id="6197635">0x0b</span>&nbsp;<span class="comment" id="6197640">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197657">e</span><span class="op" id="6197658">.</span><span class="ident" id="6197659">write</span><span class="op" id="6197664">(</span><span class="ident" id="6197665">e</span><span class="op" id="6197666">.</span><span class="ident" id="6197667">buf</span><span class="op" id="6197670">[</span><span class="op" id="6197671">:</span><span class="num" id="6197672">3</span><span class="op" id="6197673">]</span><span class="op" id="6197674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197678">_</span><span class="op" id="6197679">,</span>&nbsp;<span class="ident" id="6197681">e</span><span class="op" id="6197682">.</span><span class="ident" id="6197683">err</span>&nbsp;<span class="op" id="6197687">=</span>&nbsp;<span class="ident" id="6197689">io</span><span class="op" id="6197691">.</span><span class="ident" id="6197692">WriteString</span><span class="op" id="6197703">(</span><span class="ident" id="6197704">e</span><span class="op" id="6197705">.</span><span class="ident" id="6197706">w</span><span class="op" id="6197707">,</span>&nbsp;<span class="string" id="6197709">&#34;NETSCAPE2.0&#34;</span><span class="op" id="6197722">)</span>&nbsp;<span class="comment" id="6197724">//&nbsp;Application&nbsp;Identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6197753">if</span>&nbsp;<span class="ident" id="6197756">e</span><span class="op" id="6197757">.</span><span class="ident" id="6197758">err</span>&nbsp;<span class="op" id="6197762">!=</span>&nbsp;<span class="ident" id="6197765">nil</span>&nbsp;<span class="op" id="6197769">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6197774">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6197783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197787">e</span><span class="op" id="6197788">.</span><span class="ident" id="6197789">buf</span><span class="op" id="6197792">[</span><span class="num" id="6197793">0</span><span class="op" id="6197794">]</span>&nbsp;<span class="op" id="6197796">=</span>&nbsp;<span class="num" id="6197798">0x03</span>&nbsp;<span class="comment" id="6197803">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197820">e</span><span class="op" id="6197821">.</span><span class="ident" id="6197822">buf</span><span class="op" id="6197825">[</span><span class="num" id="6197826">1</span><span class="op" id="6197827">]</span>&nbsp;<span class="op" id="6197829">=</span>&nbsp;<span class="num" id="6197831">0x01</span>&nbsp;<span class="comment" id="6197836">//&nbsp;Sub-block&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197858">writeUint16</span><span class="op" id="6197869">(</span><span class="ident" id="6197870">e</span><span class="op" id="6197871">.</span><span class="ident" id="6197872">buf</span><span class="op" id="6197875">[</span><span class="num" id="6197876">2</span><span class="op" id="6197877">:</span><span class="num" id="6197878">4</span><span class="op" id="6197879">]</span><span class="op" id="6197880">,</span>&nbsp;<span class="builtintype" id="6197882">uint16</span><span class="op" id="6197888">(</span><span class="ident" id="6197889">e</span><span class="op" id="6197890">.</span><span class="ident" id="6197891">g</span><span class="op" id="6197892">.</span><span class="ident" id="6197893">LoopCount</span><span class="op" id="6197902">)</span><span class="op" id="6197903">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197907">e</span><span class="op" id="6197908">.</span><span class="ident" id="6197909">buf</span><span class="op" id="6197912">[</span><span class="num" id="6197913">4</span><span class="op" id="6197914">]</span>&nbsp;<span class="op" id="6197916">=</span>&nbsp;<span class="num" id="6197918">0x00</span>&nbsp;<span class="comment" id="6197923">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6197946">e</span><span class="op" id="6197947">.</span><span class="ident" id="6197948">write</span><span class="op" id="6197953">(</span><span class="ident" id="6197954">e</span><span class="op" id="6197955">.</span><span class="ident" id="6197956">buf</span><span class="op" id="6197959">[</span><span class="op" id="6197960">:</span><span class="num" id="6197961">5</span><span class="op" id="6197962">]</span><span class="op" id="6197963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6197966">}</span><br>
<span class="lineno"></span><span class="op" id="6197968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="keyword" id="6197971">func</span>&nbsp;<span class="op" id="6197976">(</span><span class="ident" id="6197977">e</span>&nbsp;<span class="op" id="6197979">*</span><span class="ident" id="6197980">encoder</span><span class="op" id="6197987">)</span>&nbsp;<span class="ident" id="6197989">writeColorTable</span><span class="op" id="6198004">(</span><span class="ident" id="6198005">p</span>&nbsp;<span class="ident" id="6198007">color</span><span class="op" id="6198012">.</span><span class="ident" id="6198013">Palette</span><span class="op" id="6198020">,</span>&nbsp;<span class="ident" id="6198022">size</span>&nbsp;<span class="builtintype" id="6198027">int</span><span class="op" id="6198030">)</span>&nbsp;<span class="op" id="6198032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198035">if</span>&nbsp;<span class="ident" id="6198038">e</span><span class="op" id="6198039">.</span><span class="ident" id="6198040">err</span>&nbsp;<span class="op" id="6198044">!=</span>&nbsp;<span class="ident" id="6198047">nil</span>&nbsp;<span class="op" id="6198051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198055">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6198063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198067">for</span>&nbsp;<span class="ident" id="6198071">i</span>&nbsp;<span class="op" id="6198073">:=</span>&nbsp;<span class="num" id="6198076">0</span><span class="op" id="6198077">;</span>&nbsp;<span class="ident" id="6198079">i</span>&nbsp;<span class="op" id="6198081">&lt;</span>&nbsp;<span class="ident" id="6198083">log2Lookup</span><span class="op" id="6198093">[</span><span class="ident" id="6198094">size</span><span class="op" id="6198098">]</span><span class="op" id="6198099">;</span>&nbsp;<span class="ident" id="6198101">i</span><span class="op" id="6198102">++</span>&nbsp;<span class="op" id="6198105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198109">if</span>&nbsp;<span class="ident" id="6198112">i</span>&nbsp;<span class="op" id="6198114">&lt;</span>&nbsp;<span class="builtinfunc" id="6198116">len</span><span class="op" id="6198119">(</span><span class="ident" id="6198120">p</span><span class="op" id="6198121">)</span>&nbsp;<span class="op" id="6198123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198128">r</span><span class="op" id="6198129">,</span>&nbsp;<span class="ident" id="6198131">g</span><span class="op" id="6198132">,</span>&nbsp;<span class="ident" id="6198134">b</span><span class="op" id="6198135">,</span>&nbsp;<span class="ident" id="6198137">_</span>&nbsp;<span class="op" id="6198139">:=</span>&nbsp;<span class="ident" id="6198142">p</span><span class="op" id="6198143">[</span><span class="ident" id="6198144">i</span><span class="op" id="6198145">]</span><span class="op" id="6198146">.</span><span class="ident" id="6198147">RGBA</span><span class="op" id="6198151">(</span><span class="op" id="6198152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198157">e</span><span class="op" id="6198158">.</span><span class="ident" id="6198159">buf</span><span class="op" id="6198162">[</span><span class="num" id="6198163">3</span><span class="op" id="6198164">*</span><span class="ident" id="6198165">i</span><span class="op" id="6198166">+</span><span class="num" id="6198167">0</span><span class="op" id="6198168">]</span>&nbsp;<span class="op" id="6198170">=</span>&nbsp;<span class="builtintype" id="6198172">uint8</span><span class="op" id="6198177">(</span><span class="ident" id="6198178">r</span>&nbsp;<span class="op" id="6198180">&gt;&gt;</span>&nbsp;<span class="num" id="6198183">8</span><span class="op" id="6198184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198189">e</span><span class="op" id="6198190">.</span><span class="ident" id="6198191">buf</span><span class="op" id="6198194">[</span><span class="num" id="6198195">3</span><span class="op" id="6198196">*</span><span class="ident" id="6198197">i</span><span class="op" id="6198198">+</span><span class="num" id="6198199">1</span><span class="op" id="6198200">]</span>&nbsp;<span class="op" id="6198202">=</span>&nbsp;<span class="builtintype" id="6198204">uint8</span><span class="op" id="6198209">(</span><span class="ident" id="6198210">g</span>&nbsp;<span class="op" id="6198212">&gt;&gt;</span>&nbsp;<span class="num" id="6198215">8</span><span class="op" id="6198216">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198221">e</span><span class="op" id="6198222">.</span><span class="ident" id="6198223">buf</span><span class="op" id="6198226">[</span><span class="num" id="6198227">3</span><span class="op" id="6198228">*</span><span class="ident" id="6198229">i</span><span class="op" id="6198230">+</span><span class="num" id="6198231">2</span><span class="op" id="6198232">]</span>&nbsp;<span class="op" id="6198234">=</span>&nbsp;<span class="builtintype" id="6198236">uint8</span><span class="op" id="6198241">(</span><span class="ident" id="6198242">b</span>&nbsp;<span class="op" id="6198244">&gt;&gt;</span>&nbsp;<span class="num" id="6198247">8</span><span class="op" id="6198248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6198252">}</span>&nbsp;<span class="keyword" id="6198254">else</span>&nbsp;<span class="op" id="6198259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6198264">//&nbsp;Pad&nbsp;with&nbsp;black.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198286">e</span><span class="op" id="6198287">.</span><span class="ident" id="6198288">buf</span><span class="op" id="6198291">[</span><span class="num" id="6198292">3</span><span class="op" id="6198293">*</span><span class="ident" id="6198294">i</span><span class="op" id="6198295">+</span><span class="num" id="6198296">0</span><span class="op" id="6198297">]</span>&nbsp;<span class="op" id="6198299">=</span>&nbsp;<span class="num" id="6198301">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198309">e</span><span class="op" id="6198310">.</span><span class="ident" id="6198311">buf</span><span class="op" id="6198314">[</span><span class="num" id="6198315">3</span><span class="op" id="6198316">*</span><span class="ident" id="6198317">i</span><span class="op" id="6198318">+</span><span class="num" id="6198319">1</span><span class="op" id="6198320">]</span>&nbsp;<span class="op" id="6198322">=</span>&nbsp;<span class="num" id="6198324">0x00</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198332">e</span><span class="op" id="6198333">.</span><span class="ident" id="6198334">buf</span><span class="op" id="6198337">[</span><span class="num" id="6198338">3</span><span class="op" id="6198339">*</span><span class="ident" id="6198340">i</span><span class="op" id="6198341">+</span><span class="num" id="6198342">2</span><span class="op" id="6198343">]</span>&nbsp;<span class="op" id="6198345">=</span>&nbsp;<span class="num" id="6198347">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6198354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6198357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198360">e</span><span class="op" id="6198361">.</span><span class="ident" id="6198362">write</span><span class="op" id="6198367">(</span><span class="ident" id="6198368">e</span><span class="op" id="6198369">.</span><span class="ident" id="6198370">buf</span><span class="op" id="6198373">[</span><span class="op" id="6198374">:</span><span class="num" id="6198375">3</span><span class="op" id="6198376">*</span><span class="ident" id="6198377">log2Lookup</span><span class="op" id="6198387">[</span><span class="ident" id="6198388">size</span><span class="op" id="6198392">]</span><span class="op" id="6198393">]</span><span class="op" id="6198394">)</span><br>
<span class="lineno"></span><span class="op" id="6198396">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="6198399">func</span>&nbsp;<span class="op" id="6198404">(</span><span class="ident" id="6198405">e</span>&nbsp;<span class="op" id="6198407">*</span><span class="ident" id="6198408">encoder</span><span class="op" id="6198415">)</span>&nbsp;<span class="ident" id="6198417">writeImageBlock</span><span class="op" id="6198432">(</span><span class="ident" id="6198433">pm</span>&nbsp;<span class="op" id="6198436">*</span><span class="ident" id="6198437">image</span><span class="op" id="6198442">.</span><span class="ident" id="6198443">Paletted</span><span class="op" id="6198451">,</span>&nbsp;<span class="ident" id="6198453">delay</span>&nbsp;<span class="builtintype" id="6198459">int</span><span class="op" id="6198462">)</span>&nbsp;<span class="op" id="6198464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198467">if</span>&nbsp;<span class="ident" id="6198470">e</span><span class="op" id="6198471">.</span><span class="ident" id="6198472">err</span>&nbsp;<span class="op" id="6198476">!=</span>&nbsp;<span class="ident" id="6198479">nil</span>&nbsp;<span class="op" id="6198483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198487">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6198495">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198499">if</span>&nbsp;<span class="builtinfunc" id="6198502">len</span><span class="op" id="6198505">(</span><span class="ident" id="6198506">pm</span><span class="op" id="6198508">.</span><span class="ident" id="6198509">Palette</span><span class="op" id="6198516">)</span>&nbsp;<span class="op" id="6198518">==</span>&nbsp;<span class="num" id="6198521">0</span>&nbsp;<span class="op" id="6198523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198527">e</span><span class="op" id="6198528">.</span><span class="ident" id="6198529">err</span>&nbsp;<span class="op" id="6198533">=</span>&nbsp;<span class="ident" id="6198535">errors</span><span class="op" id="6198541">.</span><span class="ident" id="6198542">New</span><span class="op" id="6198545">(</span><span class="string" id="6198546">&#34;gif:&nbsp;cannot&nbsp;encode&nbsp;image&nbsp;block&nbsp;with&nbsp;empty&nbsp;palette&#34;</span><span class="op" id="6198597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198601">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6198609">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198613">b</span>&nbsp;<span class="op" id="6198615">:=</span>&nbsp;<span class="ident" id="6198618">pm</span><span class="op" id="6198620">.</span><span class="ident" id="6198621">Bounds</span><span class="op" id="6198627">(</span><span class="op" id="6198628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198631">if</span>&nbsp;<span class="ident" id="6198634">b</span><span class="op" id="6198635">.</span><span class="ident" id="6198636">Dx</span><span class="op" id="6198638">(</span><span class="op" id="6198639">)</span>&nbsp;<span class="op" id="6198641">&gt;=</span>&nbsp;<span class="num" id="6198644">1</span><span class="op" id="6198645">&lt;&lt;</span><span class="num" id="6198647">16</span>&nbsp;<span class="op" id="6198650">||</span>&nbsp;<span class="ident" id="6198653">b</span><span class="op" id="6198654">.</span><span class="ident" id="6198655">Dy</span><span class="op" id="6198657">(</span><span class="op" id="6198658">)</span>&nbsp;<span class="op" id="6198660">&gt;=</span>&nbsp;<span class="num" id="6198663">1</span><span class="op" id="6198664">&lt;&lt;</span><span class="num" id="6198666">16</span>&nbsp;<span class="op" id="6198669">||</span>&nbsp;<span class="ident" id="6198672">b</span><span class="op" id="6198673">.</span><span class="ident" id="6198674">Min</span><span class="op" id="6198677">.</span><span class="ident" id="6198678">X</span>&nbsp;<span class="op" id="6198680">&lt;</span>&nbsp;<span class="num" id="6198682">0</span>&nbsp;<span class="op" id="6198684">||</span>&nbsp;<span class="ident" id="6198687">b</span><span class="op" id="6198688">.</span><span class="ident" id="6198689">Min</span><span class="op" id="6198692">.</span><span class="ident" id="6198693">X</span>&nbsp;<span class="op" id="6198695">&gt;=</span>&nbsp;<span class="num" id="6198698">1</span><span class="op" id="6198699">&lt;&lt;</span><span class="num" id="6198701">16</span>&nbsp;<span class="op" id="6198704">||</span>&nbsp;<span class="ident" id="6198707">b</span><span class="op" id="6198708">.</span><span class="ident" id="6198709">Min</span><span class="op" id="6198712">.</span><span class="ident" id="6198713">Y</span>&nbsp;<span class="op" id="6198715">&lt;</span>&nbsp;<span class="num" id="6198717">0</span>&nbsp;<span class="op" id="6198719">||</span>&nbsp;<span class="ident" id="6198722">b</span><span class="op" id="6198723">.</span><span class="ident" id="6198724">Min</span><span class="op" id="6198727">.</span><span class="ident" id="6198728">Y</span>&nbsp;<span class="op" id="6198730">&gt;=</span>&nbsp;<span class="num" id="6198733">1</span><span class="op" id="6198734">&lt;&lt;</span><span class="num" id="6198736">16</span>&nbsp;<span class="op" id="6198739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198743">e</span><span class="op" id="6198744">.</span><span class="ident" id="6198745">err</span>&nbsp;<span class="op" id="6198749">=</span>&nbsp;<span class="ident" id="6198751">errors</span><span class="op" id="6198757">.</span><span class="ident" id="6198758">New</span><span class="op" id="6198761">(</span><span class="string" id="6198762">&#34;gif:&nbsp;image&nbsp;block&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="6198803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198807">return</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6198815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198819">transparentIndex</span>&nbsp;<span class="op" id="6198836">:=</span>&nbsp;<span class="op" id="6198839">-</span><span class="num" id="6198840">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198843">for</span>&nbsp;<span class="ident" id="6198847">i</span><span class="op" id="6198848">,</span>&nbsp;<span class="ident" id="6198850">c</span>&nbsp;<span class="op" id="6198852">:=</span>&nbsp;<span class="keyword" id="6198855">range</span>&nbsp;<span class="ident" id="6198861">pm</span><span class="op" id="6198863">.</span><span class="ident" id="6198864">Palette</span>&nbsp;<span class="op" id="6198872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198876">if</span>&nbsp;<span class="ident" id="6198879">_</span><span class="op" id="6198880">,</span>&nbsp;<span class="ident" id="6198882">_</span><span class="op" id="6198883">,</span>&nbsp;<span class="ident" id="6198885">_</span><span class="op" id="6198886">,</span>&nbsp;<span class="ident" id="6198888">a</span>&nbsp;<span class="op" id="6198890">:=</span>&nbsp;<span class="ident" id="6198893">c</span><span class="op" id="6198894">.</span><span class="ident" id="6198895">RGBA</span><span class="op" id="6198899">(</span><span class="op" id="6198900">)</span><span class="op" id="6198901">;</span>&nbsp;<span class="ident" id="6198903">a</span>&nbsp;<span class="op" id="6198905">==</span>&nbsp;<span class="num" id="6198908">0</span>&nbsp;<span class="op" id="6198910">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198915">transparentIndex</span>&nbsp;<span class="op" id="6198932">=</span>&nbsp;<span class="ident" id="6198934">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198939">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6198947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6198950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6198954">if</span>&nbsp;<span class="ident" id="6198957">delay</span>&nbsp;<span class="op" id="6198963">&gt;</span>&nbsp;<span class="num" id="6198965">0</span>&nbsp;<span class="op" id="6198967">||</span>&nbsp;<span class="ident" id="6198970">transparentIndex</span>&nbsp;<span class="op" id="6198987">!=</span>&nbsp;<span class="op" id="6198990">-</span><span class="num" id="6198991">1</span>&nbsp;<span class="op" id="6198993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6198997">e</span><span class="op" id="6198998">.</span><span class="ident" id="6198999">buf</span><span class="op" id="6199002">[</span><span class="num" id="6199003">0</span><span class="op" id="6199004">]</span>&nbsp;<span class="op" id="6199006">=</span>&nbsp;<span class="ident" id="6199008">sExtension</span>&nbsp;&nbsp;<span class="comment" id="6199020">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199047">e</span><span class="op" id="6199048">.</span><span class="ident" id="6199049">buf</span><span class="op" id="6199052">[</span><span class="num" id="6199053">1</span><span class="op" id="6199054">]</span>&nbsp;<span class="op" id="6199056">=</span>&nbsp;<span class="ident" id="6199058">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6199070">//&nbsp;Graphic&nbsp;Control&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199098">e</span><span class="op" id="6199099">.</span><span class="ident" id="6199100">buf</span><span class="op" id="6199103">[</span><span class="num" id="6199104">2</span><span class="op" id="6199105">]</span>&nbsp;<span class="op" id="6199107">=</span>&nbsp;<span class="ident" id="6199109">gcBlockSize</span>&nbsp;<span class="comment" id="6199121">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6199138">if</span>&nbsp;<span class="ident" id="6199141">transparentIndex</span>&nbsp;<span class="op" id="6199158">!=</span>&nbsp;<span class="op" id="6199161">-</span><span class="num" id="6199162">1</span>&nbsp;<span class="op" id="6199164">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199169">e</span><span class="op" id="6199170">.</span><span class="ident" id="6199171">buf</span><span class="op" id="6199174">[</span><span class="num" id="6199175">3</span><span class="op" id="6199176">]</span>&nbsp;<span class="op" id="6199178">=</span>&nbsp;<span class="num" id="6199180">0x01</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6199187">}</span>&nbsp;<span class="keyword" id="6199189">else</span>&nbsp;<span class="op" id="6199194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199199">e</span><span class="op" id="6199200">.</span><span class="ident" id="6199201">buf</span><span class="op" id="6199204">[</span><span class="num" id="6199205">3</span><span class="op" id="6199206">]</span>&nbsp;<span class="op" id="6199208">=</span>&nbsp;<span class="num" id="6199210">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6199217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199221">writeUint16</span><span class="op" id="6199232">(</span><span class="ident" id="6199233">e</span><span class="op" id="6199234">.</span><span class="ident" id="6199235">buf</span><span class="op" id="6199238">[</span><span class="num" id="6199239">4</span><span class="op" id="6199240">:</span><span class="num" id="6199241">6</span><span class="op" id="6199242">]</span><span class="op" id="6199243">,</span>&nbsp;<span class="builtintype" id="6199245">uint16</span><span class="op" id="6199251">(</span><span class="ident" id="6199252">delay</span><span class="op" id="6199257">)</span><span class="op" id="6199258">)</span>&nbsp;<span class="comment" id="6199260">//&nbsp;Delay&nbsp;Time&nbsp;(1/100ths&nbsp;of&nbsp;a&nbsp;second)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6199300">//&nbsp;Transparent&nbsp;color&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6199330">if</span>&nbsp;<span class="ident" id="6199333">transparentIndex</span>&nbsp;<span class="op" id="6199350">!=</span>&nbsp;<span class="op" id="6199353">-</span><span class="num" id="6199354">1</span>&nbsp;<span class="op" id="6199356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199361">e</span><span class="op" id="6199362">.</span><span class="ident" id="6199363">buf</span><span class="op" id="6199366">[</span><span class="num" id="6199367">6</span><span class="op" id="6199368">]</span>&nbsp;<span class="op" id="6199370">=</span>&nbsp;<span class="builtintype" id="6199372">uint8</span><span class="op" id="6199377">(</span><span class="ident" id="6199378">transparentIndex</span><span class="op" id="6199394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6199398">}</span>&nbsp;<span class="keyword" id="6199400">else</span>&nbsp;<span class="op" id="6199405">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199410">e</span><span class="op" id="6199411">.</span><span class="ident" id="6199412">buf</span><span class="op" id="6199415">[</span><span class="num" id="6199416">6</span><span class="op" id="6199417">]</span>&nbsp;<span class="op" id="6199419">=</span>&nbsp;<span class="num" id="6199421">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6199428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199432">e</span><span class="op" id="6199433">.</span><span class="ident" id="6199434">buf</span><span class="op" id="6199437">[</span><span class="num" id="6199438">7</span><span class="op" id="6199439">]</span>&nbsp;<span class="op" id="6199441">=</span>&nbsp;<span class="num" id="6199443">0x00</span>&nbsp;<span class="comment" id="6199448">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199471">e</span><span class="op" id="6199472">.</span><span class="ident" id="6199473">write</span><span class="op" id="6199478">(</span><span class="ident" id="6199479">e</span><span class="op" id="6199480">.</span><span class="ident" id="6199481">buf</span><span class="op" id="6199484">[</span><span class="op" id="6199485">:</span><span class="num" id="6199486">8</span><span class="op" id="6199487">]</span><span class="op" id="6199488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6199491">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199494">e</span><span class="op" id="6199495">.</span><span class="ident" id="6199496">buf</span><span class="op" id="6199499">[</span><span class="num" id="6199500">0</span><span class="op" id="6199501">]</span>&nbsp;<span class="op" id="6199503">=</span>&nbsp;<span class="ident" id="6199505">sImageDescriptor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199523">writeUint16</span><span class="op" id="6199534">(</span><span class="ident" id="6199535">e</span><span class="op" id="6199536">.</span><span class="ident" id="6199537">buf</span><span class="op" id="6199540">[</span><span class="num" id="6199541">1</span><span class="op" id="6199542">:</span><span class="num" id="6199543">3</span><span class="op" id="6199544">]</span><span class="op" id="6199545">,</span>&nbsp;<span class="builtintype" id="6199547">uint16</span><span class="op" id="6199553">(</span><span class="ident" id="6199554">b</span><span class="op" id="6199555">.</span><span class="ident" id="6199556">Min</span><span class="op" id="6199559">.</span><span class="ident" id="6199560">X</span><span class="op" id="6199561">)</span><span class="op" id="6199562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199565">writeUint16</span><span class="op" id="6199576">(</span><span class="ident" id="6199577">e</span><span class="op" id="6199578">.</span><span class="ident" id="6199579">buf</span><span class="op" id="6199582">[</span><span class="num" id="6199583">3</span><span class="op" id="6199584">:</span><span class="num" id="6199585">5</span><span class="op" id="6199586">]</span><span class="op" id="6199587">,</span>&nbsp;<span class="builtintype" id="6199589">uint16</span><span class="op" id="6199595">(</span><span class="ident" id="6199596">b</span><span class="op" id="6199597">.</span><span class="ident" id="6199598">Min</span><span class="op" id="6199601">.</span><span class="ident" id="6199602">Y</span><span class="op" id="6199603">)</span><span class="op" id="6199604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199607">writeUint16</span><span class="op" id="6199618">(</span><span class="ident" id="6199619">e</span><span class="op" id="6199620">.</span><span class="ident" id="6199621">buf</span><span class="op" id="6199624">[</span><span class="num" id="6199625">5</span><span class="op" id="6199626">:</span><span class="num" id="6199627">7</span><span class="op" id="6199628">]</span><span class="op" id="6199629">,</span>&nbsp;<span class="builtintype" id="6199631">uint16</span><span class="op" id="6199637">(</span><span class="ident" id="6199638">b</span><span class="op" id="6199639">.</span><span class="ident" id="6199640">Dx</span><span class="op" id="6199642">(</span><span class="op" id="6199643">)</span><span class="op" id="6199644">)</span><span class="op" id="6199645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199648">writeUint16</span><span class="op" id="6199659">(</span><span class="ident" id="6199660">e</span><span class="op" id="6199661">.</span><span class="ident" id="6199662">buf</span><span class="op" id="6199665">[</span><span class="num" id="6199666">7</span><span class="op" id="6199667">:</span><span class="num" id="6199668">9</span><span class="op" id="6199669">]</span><span class="op" id="6199670">,</span>&nbsp;<span class="builtintype" id="6199672">uint16</span><span class="op" id="6199678">(</span><span class="ident" id="6199679">b</span><span class="op" id="6199680">.</span><span class="ident" id="6199681">Dy</span><span class="op" id="6199683">(</span><span class="op" id="6199684">)</span><span class="op" id="6199685">)</span><span class="op" id="6199686">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199689">e</span><span class="op" id="6199690">.</span><span class="ident" id="6199691">write</span><span class="op" id="6199696">(</span><span class="ident" id="6199697">e</span><span class="op" id="6199698">.</span><span class="ident" id="6199699">buf</span><span class="op" id="6199702">[</span><span class="op" id="6199703">:</span><span class="num" id="6199704">9</span><span class="op" id="6199705">]</span><span class="op" id="6199706">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199710">paddedSize</span>&nbsp;<span class="op" id="6199721">:=</span>&nbsp;<span class="ident" id="6199724">log2</span><span class="op" id="6199728">(</span><span class="builtinfunc" id="6199729">len</span><span class="op" id="6199732">(</span><span class="ident" id="6199733">pm</span><span class="op" id="6199735">.</span><span class="ident" id="6199736">Palette</span><span class="op" id="6199743">)</span><span class="op" id="6199744">)</span>&nbsp;<span class="comment" id="6199746">//&nbsp;Size&nbsp;of&nbsp;Local&nbsp;Color&nbsp;Table:&nbsp;2^(1+n).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6199786">//&nbsp;Interlacing&nbsp;is&nbsp;not&nbsp;supported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199820">e</span><span class="op" id="6199821">.</span><span class="ident" id="6199822">writeByte</span><span class="op" id="6199831">(</span><span class="num" id="6199832">0x80</span>&nbsp;<span class="op" id="6199837">|</span>&nbsp;<span class="builtintype" id="6199839">uint8</span><span class="op" id="6199844">(</span><span class="ident" id="6199845">paddedSize</span><span class="op" id="6199855">)</span><span class="op" id="6199856">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6199860">//&nbsp;Local&nbsp;Color&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199883">e</span><span class="op" id="6199884">.</span><span class="ident" id="6199885">writeColorTable</span><span class="op" id="6199900">(</span><span class="ident" id="6199901">pm</span><span class="op" id="6199903">.</span><span class="ident" id="6199904">Palette</span><span class="op" id="6199911">,</span>&nbsp;<span class="ident" id="6199913">paddedSize</span><span class="op" id="6199923">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199927">litWidth</span>&nbsp;<span class="op" id="6199936">:=</span>&nbsp;<span class="ident" id="6199939">paddedSize</span>&nbsp;<span class="op" id="6199950">+</span>&nbsp;<span class="num" id="6199952">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6199955">if</span>&nbsp;<span class="ident" id="6199958">litWidth</span>&nbsp;<span class="op" id="6199967">&lt;</span>&nbsp;<span class="num" id="6199969">2</span>&nbsp;<span class="op" id="6199971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199975">litWidth</span>&nbsp;<span class="op" id="6199984">=</span>&nbsp;<span class="num" id="6199986">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6199989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199992">e</span><span class="op" id="6199993">.</span><span class="ident" id="6199994">writeByte</span><span class="op" id="6200003">(</span><span class="builtintype" id="6200004">uint8</span><span class="op" id="6200009">(</span><span class="ident" id="6200010">litWidth</span><span class="op" id="6200018">)</span><span class="op" id="6200019">)</span>&nbsp;<span class="comment" id="6200021">//&nbsp;LZW&nbsp;Minimum&nbsp;Code&nbsp;Size.</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200049">lzww</span>&nbsp;<span class="op" id="6200054">:=</span>&nbsp;<span class="ident" id="6200057">lzw</span><span class="op" id="6200060">.</span><span class="ident" id="6200061">NewWriter</span><span class="op" id="6200070">(</span><span class="ident" id="6200071">blockWriter</span><span class="op" id="6200082">{</span><span class="ident" id="6200083">e</span><span class="op" id="6200084">:</span>&nbsp;<span class="ident" id="6200086">e</span><span class="op" id="6200087">}</span><span class="op" id="6200088">,</span>&nbsp;<span class="ident" id="6200090">lzw</span><span class="op" id="6200093">.</span><span class="ident" id="6200094">LSB</span><span class="op" id="6200097">,</span>&nbsp;<span class="ident" id="6200099">litWidth</span><span class="op" id="6200107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200110">if</span>&nbsp;<span class="ident" id="6200113">dx</span>&nbsp;<span class="op" id="6200116">:=</span>&nbsp;<span class="ident" id="6200119">b</span><span class="op" id="6200120">.</span><span class="ident" id="6200121">Dx</span><span class="op" id="6200123">(</span><span class="op" id="6200124">)</span><span class="op" id="6200125">;</span>&nbsp;<span class="ident" id="6200127">dx</span>&nbsp;<span class="op" id="6200130">==</span>&nbsp;<span class="ident" id="6200133">pm</span><span class="op" id="6200135">.</span><span class="ident" id="6200136">Stride</span>&nbsp;<span class="op" id="6200143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200147">_</span><span class="op" id="6200148">,</span>&nbsp;<span class="ident" id="6200150">e</span><span class="op" id="6200151">.</span><span class="ident" id="6200152">err</span>&nbsp;<span class="op" id="6200156">=</span>&nbsp;<span class="ident" id="6200158">lzww</span><span class="op" id="6200162">.</span><span class="ident" id="6200163">Write</span><span class="op" id="6200168">(</span><span class="ident" id="6200169">pm</span><span class="op" id="6200171">.</span><span class="ident" id="6200172">Pix</span><span class="op" id="6200175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200179">if</span>&nbsp;<span class="ident" id="6200182">e</span><span class="op" id="6200183">.</span><span class="ident" id="6200184">err</span>&nbsp;<span class="op" id="6200188">!=</span>&nbsp;<span class="ident" id="6200191">nil</span>&nbsp;<span class="op" id="6200195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200200">lzww</span><span class="op" id="6200204">.</span><span class="ident" id="6200205">Close</span><span class="op" id="6200210">(</span><span class="op" id="6200211">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200216">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200228">}</span>&nbsp;<span class="keyword" id="6200230">else</span>&nbsp;<span class="op" id="6200235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200239">for</span>&nbsp;<span class="ident" id="6200243">i</span><span class="op" id="6200244">,</span>&nbsp;<span class="ident" id="6200246">y</span>&nbsp;<span class="op" id="6200248">:=</span>&nbsp;<span class="num" id="6200251">0</span><span class="op" id="6200252">,</span>&nbsp;<span class="ident" id="6200254">b</span><span class="op" id="6200255">.</span><span class="ident" id="6200256">Min</span><span class="op" id="6200259">.</span><span class="ident" id="6200260">Y</span><span class="op" id="6200261">;</span>&nbsp;<span class="ident" id="6200263">y</span>&nbsp;<span class="op" id="6200265">&lt;</span>&nbsp;<span class="ident" id="6200267">b</span><span class="op" id="6200268">.</span><span class="ident" id="6200269">Max</span><span class="op" id="6200272">.</span><span class="ident" id="6200273">Y</span><span class="op" id="6200274">;</span>&nbsp;<span class="ident" id="6200276">i</span><span class="op" id="6200277">,</span>&nbsp;<span class="ident" id="6200279">y</span>&nbsp;<span class="op" id="6200281">=</span>&nbsp;<span class="ident" id="6200283">i</span><span class="op" id="6200284">+</span><span class="ident" id="6200285">pm</span><span class="op" id="6200287">.</span><span class="ident" id="6200288">Stride</span><span class="op" id="6200294">,</span>&nbsp;<span class="ident" id="6200296">y</span><span class="op" id="6200297">+</span><span class="num" id="6200298">1</span>&nbsp;<span class="op" id="6200300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200305">_</span><span class="op" id="6200306">,</span>&nbsp;<span class="ident" id="6200308">e</span><span class="op" id="6200309">.</span><span class="ident" id="6200310">err</span>&nbsp;<span class="op" id="6200314">=</span>&nbsp;<span class="ident" id="6200316">lzww</span><span class="op" id="6200320">.</span><span class="ident" id="6200321">Write</span><span class="op" id="6200326">(</span><span class="ident" id="6200327">pm</span><span class="op" id="6200329">.</span><span class="ident" id="6200330">Pix</span><span class="op" id="6200333">[</span><span class="ident" id="6200334">i</span>&nbsp;<span class="op" id="6200336">:</span>&nbsp;<span class="ident" id="6200338">i</span><span class="op" id="6200339">+</span><span class="ident" id="6200340">dx</span><span class="op" id="6200342">]</span><span class="op" id="6200343">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200348">if</span>&nbsp;<span class="ident" id="6200351">e</span><span class="op" id="6200352">.</span><span class="ident" id="6200353">err</span>&nbsp;<span class="op" id="6200357">!=</span>&nbsp;<span class="ident" id="6200360">nil</span>&nbsp;<span class="op" id="6200364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200370">lzww</span><span class="op" id="6200374">.</span><span class="ident" id="6200375">Close</span><span class="op" id="6200380">(</span><span class="op" id="6200381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200387">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200401">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200407">lzww</span><span class="op" id="6200411">.</span><span class="ident" id="6200412">Close</span><span class="op" id="6200417">(</span><span class="op" id="6200418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200421">e</span><span class="op" id="6200422">.</span><span class="ident" id="6200423">writeByte</span><span class="op" id="6200432">(</span><span class="num" id="6200433">0x00</span><span class="op" id="6200437">)</span>&nbsp;<span class="comment" id="6200439">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span><span class="op" id="6200460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="6200463">//&nbsp;Options&nbsp;are&nbsp;the&nbsp;encoding&nbsp;parameters.</span><br>
<span class="lineno"></span><span class="keyword" id="6200503">type</span>&nbsp;<span class="ident" id="6200508">Options</span>&nbsp;<span class="keyword" id="6200516">struct</span>&nbsp;<span class="op" id="6200523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6200526">//&nbsp;NumColors&nbsp;is&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;colors&nbsp;used&nbsp;in&nbsp;the&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6200591">//&nbsp;It&nbsp;ranges&nbsp;from&nbsp;1&nbsp;to&nbsp;256.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200620">NumColors</span>&nbsp;<span class="builtintype" id="6200630">int</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6200636">//&nbsp;Quantizer&nbsp;is&nbsp;used&nbsp;to&nbsp;produce&nbsp;a&nbsp;palette&nbsp;with&nbsp;size&nbsp;NumColors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6200700">//&nbsp;palette.Plan9&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Quantizer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200755">Quantizer</span>&nbsp;<span class="ident" id="6200765">draw</span><span class="op" id="6200769">.</span><span class="ident" id="6200770">Quantizer</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6200782">//&nbsp;Drawer&nbsp;is&nbsp;used&nbsp;to&nbsp;convert&nbsp;the&nbsp;source&nbsp;image&nbsp;to&nbsp;the&nbsp;desired&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6200853">//&nbsp;draw.FloydSteinberg&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Drawer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200911">Drawer</span>&nbsp;<span class="ident" id="6200918">draw</span><span class="op" id="6200922">.</span><span class="ident" id="6200923">Drawer</span><br>
<span class="lineno"></span><span class="op" id="6200930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="6200933">//&nbsp;EncodeAll&nbsp;writes&nbsp;the&nbsp;images&nbsp;in&nbsp;g&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6200997">//&nbsp;given&nbsp;loop&nbsp;count&nbsp;and&nbsp;delay&nbsp;between&nbsp;frames.</span><br>
<span class="lineno"></span><span class="keyword" id="6201043">func</span>&nbsp;<span class="ident" id="6201048">EncodeAll</span><span class="op" id="6201057">(</span><span class="ident" id="6201058">w</span>&nbsp;<span class="ident" id="6201060">io</span><span class="op" id="6201062">.</span><span class="ident" id="6201063">Writer</span><span class="op" id="6201069">,</span>&nbsp;<span class="ident" id="6201071">g</span>&nbsp;<span class="op" id="6201073">*</span><span class="ident" id="6201074">GIF</span><span class="op" id="6201077">)</span>&nbsp;<span class="builtintype" id="6201079">error</span>&nbsp;<span class="op" id="6201085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201088">if</span>&nbsp;<span class="builtinfunc" id="6201091">len</span><span class="op" id="6201094">(</span><span class="ident" id="6201095">g</span><span class="op" id="6201096">.</span><span class="ident" id="6201097">Image</span><span class="op" id="6201102">)</span>&nbsp;<span class="op" id="6201104">==</span>&nbsp;<span class="num" id="6201107">0</span>&nbsp;<span class="op" id="6201109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201113">return</span>&nbsp;<span class="ident" id="6201120">errors</span><span class="op" id="6201126">.</span><span class="ident" id="6201127">New</span><span class="op" id="6201130">(</span><span class="string" id="6201131">&#34;gif:&nbsp;must&nbsp;provide&nbsp;at&nbsp;least&nbsp;one&nbsp;image&#34;</span><span class="op" id="6201169">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6201172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201176">if</span>&nbsp;<span class="builtinfunc" id="6201179">len</span><span class="op" id="6201182">(</span><span class="ident" id="6201183">g</span><span class="op" id="6201184">.</span><span class="ident" id="6201185">Image</span><span class="op" id="6201190">)</span>&nbsp;<span class="op" id="6201192">!=</span>&nbsp;<span class="builtinfunc" id="6201195">len</span><span class="op" id="6201198">(</span><span class="ident" id="6201199">g</span><span class="op" id="6201200">.</span><span class="ident" id="6201201">Delay</span><span class="op" id="6201206">)</span>&nbsp;<span class="op" id="6201208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201212">return</span>&nbsp;<span class="ident" id="6201219">errors</span><span class="op" id="6201225">.</span><span class="ident" id="6201226">New</span><span class="op" id="6201229">(</span><span class="string" id="6201230">&#34;gif:&nbsp;mismatched&nbsp;image&nbsp;and&nbsp;delay&nbsp;lengths&#34;</span><span class="op" id="6201271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6201274">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201277">if</span>&nbsp;<span class="ident" id="6201280">g</span><span class="op" id="6201281">.</span><span class="ident" id="6201282">LoopCount</span>&nbsp;<span class="op" id="6201292">&lt;</span>&nbsp;<span class="num" id="6201294">0</span>&nbsp;<span class="op" id="6201296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201300">g</span><span class="op" id="6201301">.</span><span class="ident" id="6201302">LoopCount</span>&nbsp;<span class="op" id="6201312">=</span>&nbsp;<span class="num" id="6201314">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6201317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201321">e</span>&nbsp;<span class="op" id="6201323">:=</span>&nbsp;<span class="ident" id="6201326">encoder</span><span class="op" id="6201333">{</span><span class="ident" id="6201334">g</span><span class="op" id="6201335">:</span>&nbsp;<span class="ident" id="6201337">g</span><span class="op" id="6201338">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201341">if</span>&nbsp;<span class="ident" id="6201344">ww</span><span class="op" id="6201346">,</span>&nbsp;<span class="ident" id="6201348">ok</span>&nbsp;<span class="op" id="6201351">:=</span>&nbsp;<span class="ident" id="6201354">w</span><span class="op" id="6201355">.</span><span class="op" id="6201356">(</span><span class="ident" id="6201357">writer</span><span class="op" id="6201363">)</span><span class="op" id="6201364">;</span>&nbsp;<span class="ident" id="6201366">ok</span>&nbsp;<span class="op" id="6201369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201373">e</span><span class="op" id="6201374">.</span><span class="ident" id="6201375">w</span>&nbsp;<span class="op" id="6201377">=</span>&nbsp;<span class="ident" id="6201379">ww</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6201383">}</span>&nbsp;<span class="keyword" id="6201385">else</span>&nbsp;<span class="op" id="6201390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201394">e</span><span class="op" id="6201395">.</span><span class="ident" id="6201396">w</span>&nbsp;<span class="op" id="6201398">=</span>&nbsp;<span class="ident" id="6201400">bufio</span><span class="op" id="6201405">.</span><span class="ident" id="6201406">NewWriter</span><span class="op" id="6201415">(</span><span class="ident" id="6201416">w</span><span class="op" id="6201417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6201420">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201424">e</span><span class="op" id="6201425">.</span><span class="ident" id="6201426">writeHeader</span><span class="op" id="6201437">(</span><span class="op" id="6201438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201441">for</span>&nbsp;<span class="ident" id="6201445">i</span><span class="op" id="6201446">,</span>&nbsp;<span class="ident" id="6201448">pm</span>&nbsp;<span class="op" id="6201451">:=</span>&nbsp;<span class="keyword" id="6201454">range</span>&nbsp;<span class="ident" id="6201460">g</span><span class="op" id="6201461">.</span><span class="ident" id="6201462">Image</span>&nbsp;<span class="op" id="6201468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201472">e</span><span class="op" id="6201473">.</span><span class="ident" id="6201474">writeImageBlock</span><span class="op" id="6201489">(</span><span class="ident" id="6201490">pm</span><span class="op" id="6201492">,</span>&nbsp;<span class="ident" id="6201494">g</span><span class="op" id="6201495">.</span><span class="ident" id="6201496">Delay</span><span class="op" id="6201501">[</span><span class="ident" id="6201502">i</span><span class="op" id="6201503">]</span><span class="op" id="6201504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6201507">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201510">e</span><span class="op" id="6201511">.</span><span class="ident" id="6201512">writeByte</span><span class="op" id="6201521">(</span><span class="ident" id="6201522">sTrailer</span><span class="op" id="6201530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201533">e</span><span class="op" id="6201534">.</span><span class="ident" id="6201535">flush</span><span class="op" id="6201540">(</span><span class="op" id="6201541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201544">return</span>&nbsp;<span class="ident" id="6201551">e</span><span class="op" id="6201552">.</span><span class="ident" id="6201553">err</span><br>
<span class="lineno"></span><span class="op" id="6201557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="6201560">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="6201609">func</span>&nbsp;<span class="ident" id="6201614">Encode</span><span class="op" id="6201620">(</span><span class="ident" id="6201621">w</span>&nbsp;<span class="ident" id="6201623">io</span><span class="op" id="6201625">.</span><span class="ident" id="6201626">Writer</span><span class="op" id="6201632">,</span>&nbsp;<span class="ident" id="6201634">m</span>&nbsp;<span class="ident" id="6201636">image</span><span class="op" id="6201641">.</span><span class="ident" id="6201642">Image</span><span class="op" id="6201647">,</span>&nbsp;<span class="ident" id="6201649">o</span>&nbsp;<span class="op" id="6201651">*</span><span class="ident" id="6201652">Options</span><span class="op" id="6201659">)</span>&nbsp;<span class="builtintype" id="6201661">error</span>&nbsp;<span class="op" id="6201667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6201670">//&nbsp;Check&nbsp;for&nbsp;bounds&nbsp;and&nbsp;size&nbsp;restrictions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201714">b</span>&nbsp;<span class="op" id="6201716">:=</span>&nbsp;<span class="ident" id="6201719">m</span><span class="op" id="6201720">.</span><span class="ident" id="6201721">Bounds</span><span class="op" id="6201727">(</span><span class="op" id="6201728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201731">if</span>&nbsp;<span class="ident" id="6201734">b</span><span class="op" id="6201735">.</span><span class="ident" id="6201736">Dx</span><span class="op" id="6201738">(</span><span class="op" id="6201739">)</span>&nbsp;<span class="op" id="6201741">&gt;=</span>&nbsp;<span class="num" id="6201744">1</span><span class="op" id="6201745">&lt;&lt;</span><span class="num" id="6201747">16</span>&nbsp;<span class="op" id="6201750">||</span>&nbsp;<span class="ident" id="6201753">b</span><span class="op" id="6201754">.</span><span class="ident" id="6201755">Dy</span><span class="op" id="6201757">(</span><span class="op" id="6201758">)</span>&nbsp;<span class="op" id="6201760">&gt;=</span>&nbsp;<span class="num" id="6201763">1</span><span class="op" id="6201764">&lt;&lt;</span><span class="num" id="6201766">16</span>&nbsp;<span class="op" id="6201769">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201773">return</span>&nbsp;<span class="ident" id="6201780">errors</span><span class="op" id="6201786">.</span><span class="ident" id="6201787">New</span><span class="op" id="6201790">(</span><span class="string" id="6201791">&#34;gif:&nbsp;image&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="6201826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6201829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201833">opts</span>&nbsp;<span class="op" id="6201838">:=</span>&nbsp;<span class="ident" id="6201841">Options</span><span class="op" id="6201848">{</span><span class="op" id="6201849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201852">if</span>&nbsp;<span class="ident" id="6201855">o</span>&nbsp;<span class="op" id="6201857">!=</span>&nbsp;<span class="ident" id="6201860">nil</span>&nbsp;<span class="op" id="6201864">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201868">opts</span>&nbsp;<span class="op" id="6201873">=</span>&nbsp;<span class="op" id="6201875">*</span><span class="ident" id="6201876">o</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6201879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201882">if</span>&nbsp;<span class="ident" id="6201885">opts</span><span class="op" id="6201889">.</span><span class="ident" id="6201890">NumColors</span>&nbsp;<span class="op" id="6201900">&lt;</span>&nbsp;<span class="num" id="6201902">1</span>&nbsp;<span class="op" id="6201904">||</span>&nbsp;<span class="num" id="6201907">256</span>&nbsp;<span class="op" id="6201911">&lt;</span>&nbsp;<span class="ident" id="6201913">opts</span><span class="op" id="6201917">.</span><span class="ident" id="6201918">NumColors</span>&nbsp;<span class="op" id="6201928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201932">opts</span><span class="op" id="6201936">.</span><span class="ident" id="6201937">NumColors</span>&nbsp;<span class="op" id="6201947">=</span>&nbsp;<span class="num" id="6201949">256</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6201954">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201957">if</span>&nbsp;<span class="ident" id="6201960">opts</span><span class="op" id="6201964">.</span><span class="ident" id="6201965">Drawer</span>&nbsp;<span class="op" id="6201972">==</span>&nbsp;<span class="ident" id="6201975">nil</span>&nbsp;<span class="op" id="6201979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201983">opts</span><span class="op" id="6201987">.</span><span class="ident" id="6201988">Drawer</span>&nbsp;<span class="op" id="6201995">=</span>&nbsp;<span class="ident" id="6201997">draw</span><span class="op" id="6202001">.</span><span class="ident" id="6202002">FloydSteinberg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6202018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202022">pm</span><span class="op" id="6202024">,</span>&nbsp;<span class="ident" id="6202026">ok</span>&nbsp;<span class="op" id="6202029">:=</span>&nbsp;<span class="ident" id="6202032">m</span><span class="op" id="6202033">.</span><span class="op" id="6202034">(</span><span class="op" id="6202035">*</span><span class="ident" id="6202036">image</span><span class="op" id="6202041">.</span><span class="ident" id="6202042">Paletted</span><span class="op" id="6202050">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202053">if</span>&nbsp;<span class="op" id="6202056">!</span><span class="ident" id="6202057">ok</span>&nbsp;<span class="op" id="6202060">||</span>&nbsp;<span class="builtinfunc" id="6202063">len</span><span class="op" id="6202066">(</span><span class="ident" id="6202067">pm</span><span class="op" id="6202069">.</span><span class="ident" id="6202070">Palette</span><span class="op" id="6202077">)</span>&nbsp;<span class="op" id="6202079">&gt;</span>&nbsp;<span class="ident" id="6202081">opts</span><span class="op" id="6202085">.</span><span class="ident" id="6202086">NumColors</span>&nbsp;<span class="op" id="6202096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6202100">//&nbsp;TODO:&nbsp;Pick&nbsp;a&nbsp;better&nbsp;sub-sample&nbsp;of&nbsp;the&nbsp;Plan&nbsp;9&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202159">pm</span>&nbsp;<span class="op" id="6202162">=</span>&nbsp;<span class="ident" id="6202164">image</span><span class="op" id="6202169">.</span><span class="ident" id="6202170">NewPaletted</span><span class="op" id="6202181">(</span><span class="ident" id="6202182">b</span><span class="op" id="6202183">,</span>&nbsp;<span class="ident" id="6202185">palette</span><span class="op" id="6202192">.</span><span class="ident" id="6202193">Plan9</span><span class="op" id="6202198">[</span><span class="op" id="6202199">:</span><span class="ident" id="6202200">opts</span><span class="op" id="6202204">.</span><span class="ident" id="6202205">NumColors</span><span class="op" id="6202214">]</span><span class="op" id="6202215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202219">if</span>&nbsp;<span class="ident" id="6202222">opts</span><span class="op" id="6202226">.</span><span class="ident" id="6202227">Quantizer</span>&nbsp;<span class="op" id="6202237">!=</span>&nbsp;<span class="ident" id="6202240">nil</span>&nbsp;<span class="op" id="6202244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202249">pm</span><span class="op" id="6202251">.</span><span class="ident" id="6202252">Palette</span>&nbsp;<span class="op" id="6202260">=</span>&nbsp;<span class="ident" id="6202262">opts</span><span class="op" id="6202266">.</span><span class="ident" id="6202267">Quantizer</span><span class="op" id="6202276">.</span><span class="ident" id="6202277">Quantize</span><span class="op" id="6202285">(</span><span class="builtinfunc" id="6202286">make</span><span class="op" id="6202290">(</span><span class="ident" id="6202291">color</span><span class="op" id="6202296">.</span><span class="ident" id="6202297">Palette</span><span class="op" id="6202304">,</span>&nbsp;<span class="num" id="6202306">0</span><span class="op" id="6202307">,</span>&nbsp;<span class="ident" id="6202309">opts</span><span class="op" id="6202313">.</span><span class="ident" id="6202314">NumColors</span><span class="op" id="6202323">)</span><span class="op" id="6202324">,</span>&nbsp;<span class="ident" id="6202326">m</span><span class="op" id="6202327">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6202331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202335">opts</span><span class="op" id="6202339">.</span><span class="ident" id="6202340">Drawer</span><span class="op" id="6202346">.</span><span class="ident" id="6202347">Draw</span><span class="op" id="6202351">(</span><span class="ident" id="6202352">pm</span><span class="op" id="6202354">,</span>&nbsp;<span class="ident" id="6202356">b</span><span class="op" id="6202357">,</span>&nbsp;<span class="ident" id="6202359">m</span><span class="op" id="6202360">,</span>&nbsp;<span class="ident" id="6202362">image</span><span class="op" id="6202367">.</span><span class="ident" id="6202368">ZP</span><span class="op" id="6202370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6202373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202377">return</span>&nbsp;<span class="ident" id="6202384">EncodeAll</span><span class="op" id="6202393">(</span><span class="ident" id="6202394">w</span><span class="op" id="6202395">,</span>&nbsp;<span class="op" id="6202397">&amp;</span><span class="ident" id="6202398">GIF</span><span class="op" id="6202401">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202405">Image</span><span class="op" id="6202410">:</span>&nbsp;<span class="op" id="6202412">[</span><span class="op" id="6202413">]</span><span class="op" id="6202414">*</span><span class="ident" id="6202415">image</span><span class="op" id="6202420">.</span><span class="ident" id="6202421">Paletted</span><span class="op" id="6202429">{</span><span class="ident" id="6202430">pm</span><span class="op" id="6202432">}</span><span class="op" id="6202433">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202437">Delay</span><span class="op" id="6202442">:</span>&nbsp;<span class="op" id="6202444">[</span><span class="op" id="6202445">]</span><span class="builtintype" id="6202446">int</span><span class="op" id="6202449">{</span><span class="num" id="6202450">0</span><span class="op" id="6202451">}</span><span class="op" id="6202452">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6202455">}</span><span class="op" id="6202456">)</span><br>
<span class="lineno"></span><span class="op" id="6202458">}</span>
</div>
</body>
</html>
