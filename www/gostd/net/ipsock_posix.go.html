<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html" class="current">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4120507">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4120563">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4120617">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4120668">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4120746">//&nbsp;Internet&nbsp;protocol&nbsp;family&nbsp;sockets&nbsp;for&nbsp;POSIX</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4120793">package</span>&nbsp;<span class="ident" id="4120801">net</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4120806">import</span>&nbsp;<span class="op" id="4120813">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4120816">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4120827">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4120834">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="4120837">func</span>&nbsp;<span class="ident" id="4120842">probeIPv4Stack</span><span class="op" id="4120856">(</span><span class="op" id="4120857">)</span>&nbsp;<span class="builtintype" id="4120859">bool</span>&nbsp;<span class="op" id="4120864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120867">s</span><span class="op" id="4120868">,</span>&nbsp;<span class="ident" id="4120870">err</span>&nbsp;<span class="op" id="4120874">:=</span>&nbsp;<span class="ident" id="4120877">syscall</span><span class="op" id="4120884">.</span><span class="ident" id="4120885">Socket</span><span class="op" id="4120891">(</span><span class="ident" id="4120892">syscall</span><span class="op" id="4120899">.</span><span class="ident" id="4120900">AF_INET</span><span class="op" id="4120907">,</span>&nbsp;<span class="ident" id="4120909">syscall</span><span class="op" id="4120916">.</span><span class="ident" id="4120917">SOCK_STREAM</span><span class="op" id="4120928">,</span>&nbsp;<span class="ident" id="4120930">syscall</span><span class="op" id="4120937">.</span><span class="ident" id="4120938">IPPROTO_TCP</span><span class="op" id="4120949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120952">switch</span>&nbsp;<span class="ident" id="4120959">err</span>&nbsp;<span class="op" id="4120963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120966">case</span>&nbsp;<span class="ident" id="4120971">syscall</span><span class="op" id="4120978">.</span><span class="ident" id="4120979">EAFNOSUPPORT</span><span class="op" id="4120991">,</span>&nbsp;<span class="ident" id="4120993">syscall</span><span class="op" id="4121000">.</span><span class="ident" id="4121001">EPROTONOSUPPORT</span><span class="op" id="4121016">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121020">return</span>&nbsp;<span class="builtintype" id="4121027">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121034">case</span>&nbsp;<span class="ident" id="4121039">nil</span><span class="op" id="4121042">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121046">closesocket</span><span class="op" id="4121057">(</span><span class="ident" id="4121058">s</span><span class="op" id="4121059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4121062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121065">return</span>&nbsp;<span class="builtintype" id="4121072">true</span><br>
<span class="lineno">25</span><span class="op" id="4121077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4121080">//&nbsp;Should&nbsp;we&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;IPv4&nbsp;socket&nbsp;interface&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="4121139">//&nbsp;only&nbsp;dealing&nbsp;with&nbsp;IPv4&nbsp;sockets?&nbsp;&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;host&nbsp;system</span><br>
<span class="lineno"></span><span class="comment" id="4121202">//&nbsp;understands&nbsp;IPv6,&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;pass&nbsp;IPv4&nbsp;addresses&nbsp;to&nbsp;the&nbsp;IPv6</span><br>
<span class="lineno">30</span><span class="comment" id="4121268">//&nbsp;interface.&nbsp;&nbsp;That&nbsp;simplifies&nbsp;our&nbsp;code&nbsp;and&nbsp;is&nbsp;most&nbsp;general.</span><br>
<span class="lineno"></span><span class="comment" id="4121329">//&nbsp;Unfortunately,&nbsp;we&nbsp;need&nbsp;to&nbsp;run&nbsp;on&nbsp;kernels&nbsp;built&nbsp;without&nbsp;IPv6</span><br>
<span class="lineno"></span><span class="comment" id="4121392">//&nbsp;support&nbsp;too.&nbsp;&nbsp;So&nbsp;probe&nbsp;the&nbsp;kernel&nbsp;to&nbsp;figure&nbsp;it&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="4121447">//</span><br>
<span class="lineno"></span><span class="comment" id="4121450">//&nbsp;probeIPv6Stack&nbsp;probes&nbsp;both&nbsp;basic&nbsp;IPv6&nbsp;capability&nbsp;and&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno">35</span><span class="comment" id="4121517">//&nbsp;mapping&nbsp;capability&nbsp;which&nbsp;is&nbsp;controlled&nbsp;by&nbsp;IPV6_V6ONLY&nbsp;socket</span><br>
<span class="lineno"></span><span class="comment" id="4121581">//&nbsp;option&nbsp;and/or&nbsp;kernel&nbsp;state&nbsp;&#34;net.inet6.ip6.v6only&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="4121635">//&nbsp;It&nbsp;returns&nbsp;two&nbsp;boolean&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;first&nbsp;boolean&nbsp;value&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4121700">//&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;basic&nbsp;IPv6&nbsp;functionality.&nbsp;&nbsp;If&nbsp;the&nbsp;second</span><br>
<span class="lineno"></span><span class="comment" id="4121766">//&nbsp;boolean&nbsp;value&nbsp;is&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;IPv6&nbsp;IPv4-mapping.</span><br>
<span class="lineno">40</span><span class="keyword" id="4121827">func</span>&nbsp;<span class="ident" id="4121832">probeIPv6Stack</span><span class="op" id="4121846">(</span><span class="op" id="4121847">)</span>&nbsp;<span class="op" id="4121849">(</span><span class="ident" id="4121850">supportsIPv6</span><span class="op" id="4121862">,</span>&nbsp;<span class="ident" id="4121864">supportsIPv4map</span>&nbsp;<span class="builtintype" id="4121880">bool</span><span class="op" id="4121884">)</span>&nbsp;<span class="op" id="4121886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121889">var</span>&nbsp;<span class="ident" id="4121893">probes</span>&nbsp;<span class="op" id="4121900">=</span>&nbsp;<span class="op" id="4121902">[</span><span class="op" id="4121903">]</span><span class="keyword" id="4121904">struct</span>&nbsp;<span class="op" id="4121911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121915">laddr</span>&nbsp;<span class="ident" id="4121921">TCPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121931">value</span>&nbsp;<span class="builtintype" id="4121937">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121943">ok</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4121949">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4121955">}</span><span class="op" id="4121956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4121960">//&nbsp;IPv6&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4121995">{</span><span class="ident" id="4121996">laddr</span><span class="op" id="4122001">:</span>&nbsp;<span class="ident" id="4122003">TCPAddr</span><span class="op" id="4122010">{</span><span class="ident" id="4122011">IP</span><span class="op" id="4122013">:</span>&nbsp;<span class="ident" id="4122015">ParseIP</span><span class="op" id="4122022">(</span><span class="string" id="4122023">&#34;::1&#34;</span><span class="op" id="4122028">)</span><span class="op" id="4122029">}</span><span class="op" id="4122030">,</span>&nbsp;<span class="ident" id="4122032">value</span><span class="op" id="4122037">:</span>&nbsp;<span class="num" id="4122039">1</span><span class="op" id="4122040">}</span><span class="op" id="4122041">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4122045">//&nbsp;IPv6&nbsp;IPv4-mapped&nbsp;address&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122100">{</span><span class="ident" id="4122101">laddr</span><span class="op" id="4122106">:</span>&nbsp;<span class="ident" id="4122108">TCPAddr</span><span class="op" id="4122115">{</span><span class="ident" id="4122116">IP</span><span class="op" id="4122118">:</span>&nbsp;<span class="ident" id="4122120">IPv4</span><span class="op" id="4122124">(</span><span class="num" id="4122125">127</span><span class="op" id="4122128">,</span>&nbsp;<span class="num" id="4122130">0</span><span class="op" id="4122131">,</span>&nbsp;<span class="num" id="4122133">0</span><span class="op" id="4122134">,</span>&nbsp;<span class="num" id="4122136">1</span><span class="op" id="4122137">)</span><span class="op" id="4122138">}</span><span class="op" id="4122139">,</span>&nbsp;<span class="ident" id="4122141">value</span><span class="op" id="4122146">:</span>&nbsp;<span class="num" id="4122148">0</span><span class="op" id="4122149">}</span><span class="op" id="4122150">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122157">for</span>&nbsp;<span class="ident" id="4122161">i</span>&nbsp;<span class="op" id="4122163">:=</span>&nbsp;<span class="keyword" id="4122166">range</span>&nbsp;<span class="ident" id="4122172">probes</span>&nbsp;<span class="op" id="4122179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122183">s</span><span class="op" id="4122184">,</span>&nbsp;<span class="ident" id="4122186">err</span>&nbsp;<span class="op" id="4122190">:=</span>&nbsp;<span class="ident" id="4122193">syscall</span><span class="op" id="4122200">.</span><span class="ident" id="4122201">Socket</span><span class="op" id="4122207">(</span><span class="ident" id="4122208">syscall</span><span class="op" id="4122215">.</span><span class="ident" id="4122216">AF_INET6</span><span class="op" id="4122224">,</span>&nbsp;<span class="ident" id="4122226">syscall</span><span class="op" id="4122233">.</span><span class="ident" id="4122234">SOCK_STREAM</span><span class="op" id="4122245">,</span>&nbsp;<span class="ident" id="4122247">syscall</span><span class="op" id="4122254">.</span><span class="ident" id="4122255">IPPROTO_TCP</span><span class="op" id="4122266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122270">if</span>&nbsp;<span class="ident" id="4122273">err</span>&nbsp;<span class="op" id="4122277">!=</span>&nbsp;<span class="ident" id="4122280">nil</span>&nbsp;<span class="op" id="4122284">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122289">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122304">defer</span>&nbsp;<span class="ident" id="4122310">closesocket</span><span class="op" id="4122321">(</span><span class="ident" id="4122322">s</span><span class="op" id="4122323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122327">syscall</span><span class="op" id="4122334">.</span><span class="ident" id="4122335">SetsockoptInt</span><span class="op" id="4122348">(</span><span class="ident" id="4122349">s</span><span class="op" id="4122350">,</span>&nbsp;<span class="ident" id="4122352">syscall</span><span class="op" id="4122359">.</span><span class="ident" id="4122360">IPPROTO_IPV6</span><span class="op" id="4122372">,</span>&nbsp;<span class="ident" id="4122374">syscall</span><span class="op" id="4122381">.</span><span class="ident" id="4122382">IPV6_V6ONLY</span><span class="op" id="4122393">,</span>&nbsp;<span class="ident" id="4122395">probes</span><span class="op" id="4122401">[</span><span class="ident" id="4122402">i</span><span class="op" id="4122403">]</span><span class="op" id="4122404">.</span><span class="ident" id="4122405">value</span><span class="op" id="4122410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122414">sa</span><span class="op" id="4122416">,</span>&nbsp;<span class="ident" id="4122418">err</span>&nbsp;<span class="op" id="4122422">:=</span>&nbsp;<span class="ident" id="4122425">probes</span><span class="op" id="4122431">[</span><span class="ident" id="4122432">i</span><span class="op" id="4122433">]</span><span class="op" id="4122434">.</span><span class="ident" id="4122435">laddr</span><span class="op" id="4122440">.</span><span class="ident" id="4122441">sockaddr</span><span class="op" id="4122449">(</span><span class="ident" id="4122450">syscall</span><span class="op" id="4122457">.</span><span class="ident" id="4122458">AF_INET6</span><span class="op" id="4122466">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122470">if</span>&nbsp;<span class="ident" id="4122473">err</span>&nbsp;<span class="op" id="4122477">!=</span>&nbsp;<span class="ident" id="4122480">nil</span>&nbsp;<span class="op" id="4122484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122489">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122504">if</span>&nbsp;<span class="ident" id="4122507">err</span>&nbsp;<span class="op" id="4122511">:=</span>&nbsp;<span class="ident" id="4122514">syscall</span><span class="op" id="4122521">.</span><span class="ident" id="4122522">Bind</span><span class="op" id="4122526">(</span><span class="ident" id="4122527">s</span><span class="op" id="4122528">,</span>&nbsp;<span class="ident" id="4122530">sa</span><span class="op" id="4122532">)</span><span class="op" id="4122533">;</span>&nbsp;<span class="ident" id="4122535">err</span>&nbsp;<span class="op" id="4122539">!=</span>&nbsp;<span class="ident" id="4122542">nil</span>&nbsp;<span class="op" id="4122546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122551">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122566">probes</span><span class="op" id="4122572">[</span><span class="ident" id="4122573">i</span><span class="op" id="4122574">]</span><span class="op" id="4122575">.</span><span class="ident" id="4122576">ok</span>&nbsp;<span class="op" id="4122579">=</span>&nbsp;<span class="builtintype" id="4122581">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122591">return</span>&nbsp;<span class="ident" id="4122598">probes</span><span class="op" id="4122604">[</span><span class="num" id="4122605">0</span><span class="op" id="4122606">]</span><span class="op" id="4122607">.</span><span class="ident" id="4122608">ok</span><span class="op" id="4122610">,</span>&nbsp;<span class="ident" id="4122612">probes</span><span class="op" id="4122618">[</span><span class="num" id="4122619">1</span><span class="op" id="4122620">]</span><span class="op" id="4122621">.</span><span class="ident" id="4122622">ok</span><br>
<span class="lineno">70</span><span class="op" id="4122625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4122628">//&nbsp;favoriteAddrFamily&nbsp;returns&nbsp;the&nbsp;appropriate&nbsp;address&nbsp;family&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4122692">//&nbsp;the&nbsp;given&nbsp;net,&nbsp;laddr,&nbsp;raddr&nbsp;and&nbsp;mode.&nbsp;&nbsp;At&nbsp;first&nbsp;it&nbsp;figures</span><br>
<span class="lineno"></span><span class="comment" id="4122754">//&nbsp;address&nbsp;family&nbsp;out&nbsp;from&nbsp;the&nbsp;net.&nbsp;&nbsp;If&nbsp;mode&nbsp;indicates&nbsp;&#34;listen&#34;</span><br>
<span class="lineno">75</span><span class="comment" id="4122818">//&nbsp;and&nbsp;laddr&nbsp;is&nbsp;a&nbsp;wildcard,&nbsp;it&nbsp;assumes&nbsp;that&nbsp;the&nbsp;user&nbsp;wants&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4122880">//&nbsp;make&nbsp;a&nbsp;passive&nbsp;connection&nbsp;with&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;family,&nbsp;both</span><br>
<span class="lineno"></span><span class="comment" id="4122946">//&nbsp;AF_INET&nbsp;and&nbsp;AF_INET6,&nbsp;and&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;like&nbsp;following:</span><br>
<span class="lineno"></span><span class="comment" id="4123010">//</span><br>
<span class="lineno"></span><span class="comment" id="4123013">//&nbsp;&nbsp;&nbsp;&nbsp1.&nbsp;A&nbsp;wild-wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;&#34;</span><br>
<span class="lineno">80</span><span class="comment" id="4123050">//&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;the&nbsp;platform&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping</span><br>
<span class="lineno"></span><span class="comment" id="4123110">//&nbsp;&nbsp;&nbsp;&nbspcapabilities,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;user&nbsp;want&nbsp;to&nbsp;listen&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4123169">//&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;wildcard&nbsp;address&nbsp;over&nbsp;an&nbsp;AF_INET6</span><br>
<span class="lineno"></span><span class="comment" id="4123225">//&nbsp;&nbsp;&nbsp;&nbspsocket&nbsp;with&nbsp;IPV6_V6ONLY=0.&nbsp;&nbsp;Otherwise&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv4</span><br>
<span class="lineno"></span><span class="comment" id="4123284">//&nbsp;&nbsp;&nbsp;&nbspwildcard&nbsp;address&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET&nbsp;socket.</span><br>
<span class="lineno">85</span><span class="comment" id="4123335">//</span><br>
<span class="lineno"></span><span class="comment" id="4123338">//&nbsp;&nbsp;&nbsp;&nbsp2.&nbsp;A&nbsp;wild-ipv4wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4123386">//&nbsp;&nbsp;&nbsp;&nbspSame&nbsp;as&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="4123400">//</span><br>
<span class="lineno"></span><span class="comment" id="4123403">//&nbsp;&nbsp;&nbsp;&nbsp3.&nbsp;A&nbsp;wild-ipv6wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno">90</span><span class="comment" id="4123448">//&nbsp;&nbsp;&nbsp;&nbspAlmost&nbsp;same&nbsp;as&nbsp;1&nbsp;but&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv6&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="4123507">//&nbsp;&nbsp;&nbsp;&nbsplisten&nbsp;over&nbsp;an&nbsp;AF_INET6&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="4123565">//&nbsp;&nbsp;&nbsp;&nbspthe&nbsp;platform&nbsp;supports&nbsp;IPv6&nbsp;capability&nbsp;but&nbsp;not&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno"></span><span class="comment" id="4123625">//&nbsp;&nbsp;&nbsp;&nbspmapping&nbsp;capability.</span><br>
<span class="lineno"></span><span class="comment" id="4123648">//</span><br>
<span class="lineno">95</span><span class="comment" id="4123651">//&nbsp;&nbsp;&nbsp;&nbsp4.&nbsp;A&nbsp;ipv4-ipv4wild&nbsp;listen,&nbsp;&#34;tcp4&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4123706">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv4&nbsp;(AF_INET)&nbsp;wildcard&nbsp;address&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="4123759">//</span><br>
<span class="lineno"></span><span class="comment" id="4123762">//&nbsp;&nbsp;&nbsp;&nbsp5.&nbsp;A&nbsp;ipv6-ipv6wild&nbsp;listen,&nbsp;&#34;tcp6&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4123814">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv6&nbsp;(AF_INET6,&nbsp;IPV6_V6ONLY=1)&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">100</span><span class="comment" id="4123875">//&nbsp;&nbsp;&nbsp;&nbsplisten.</span><br>
<span class="lineno"></span><span class="comment" id="4123886">//</span><br>
<span class="lineno"></span><span class="comment" id="4123889">//&nbsp;Otherwise&nbsp;guess:&nbsp;if&nbsp;the&nbsp;addresses&nbsp;are&nbsp;IPv4&nbsp;then&nbsp;returns&nbsp;AF_INET,</span><br>
<span class="lineno"></span><span class="comment" id="4123957">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;AF_INET6.&nbsp;&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;boolean&nbsp;value&nbsp;what</span><br>
<span class="lineno"></span><span class="comment" id="4124024">//&nbsp;designates&nbsp;IPV6_V6ONLY&nbsp;option.</span><br>
<span class="lineno">105</span><span class="comment" id="4124058">//</span><br>
<span class="lineno"></span><span class="comment" id="4124061">//&nbsp;Note&nbsp;that&nbsp;OpenBSD&nbsp;allows&nbsp;neither&nbsp;&#34;net.inet6.ip6.v6only=1&#34;&nbsp;change</span><br>
<span class="lineno"></span><span class="comment" id="4124129">//&nbsp;nor&nbsp;IPPROTO_IPV6&nbsp;level&nbsp;IPV6_V6ONLY&nbsp;socket&nbsp;option&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword" id="4124190">func</span>&nbsp;<span class="ident" id="4124195">favoriteAddrFamily</span><span class="op" id="4124213">(</span><span class="ident" id="4124214">net</span>&nbsp;<span class="builtintype" id="4124218">string</span><span class="op" id="4124224">,</span>&nbsp;<span class="ident" id="4124226">laddr</span><span class="op" id="4124231">,</span>&nbsp;<span class="ident" id="4124233">raddr</span>&nbsp;<span class="ident" id="4124239">sockaddr</span><span class="op" id="4124247">,</span>&nbsp;<span class="ident" id="4124249">mode</span>&nbsp;<span class="builtintype" id="4124254">string</span><span class="op" id="4124260">)</span>&nbsp;<span class="op" id="4124262">(</span><span class="ident" id="4124263">family</span>&nbsp;<span class="builtintype" id="4124270">int</span><span class="op" id="4124273">,</span>&nbsp;<span class="ident" id="4124275">ipv6only</span>&nbsp;<span class="builtintype" id="4124284">bool</span><span class="op" id="4124288">)</span>&nbsp;<span class="op" id="4124290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124293">switch</span>&nbsp;<span class="ident" id="4124300">net</span><span class="op" id="4124303">[</span><span class="builtinfunc" id="4124304">len</span><span class="op" id="4124307">(</span><span class="ident" id="4124308">net</span><span class="op" id="4124311">)</span><span class="op" id="4124312">-</span><span class="num" id="4124313">1</span><span class="op" id="4124314">]</span>&nbsp;<span class="op" id="4124316">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124319">case</span>&nbsp;<span class="string" id="4124324">&#39;4&#39;</span><span class="op" id="4124327">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124331">return</span>&nbsp;<span class="ident" id="4124338">syscall</span><span class="op" id="4124345">.</span><span class="ident" id="4124346">AF_INET</span><span class="op" id="4124353">,</span>&nbsp;<span class="builtintype" id="4124355">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124362">case</span>&nbsp;<span class="string" id="4124367">&#39;6&#39;</span><span class="op" id="4124370">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124374">return</span>&nbsp;<span class="ident" id="4124381">syscall</span><span class="op" id="4124388">.</span><span class="ident" id="4124389">AF_INET6</span><span class="op" id="4124397">,</span>&nbsp;<span class="builtintype" id="4124399">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124405">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124409">if</span>&nbsp;<span class="ident" id="4124412">mode</span>&nbsp;<span class="op" id="4124417">==</span>&nbsp;<span class="string" id="4124420">&#34;listen&#34;</span>&nbsp;<span class="op" id="4124429">&amp;&amp;</span>&nbsp;<span class="op" id="4124432">(</span><span class="ident" id="4124433">laddr</span>&nbsp;<span class="op" id="4124439">==</span>&nbsp;<span class="ident" id="4124442">nil</span>&nbsp;<span class="op" id="4124446">||</span>&nbsp;<span class="ident" id="4124449">laddr</span><span class="op" id="4124454">.</span><span class="ident" id="4124455">isWildcard</span><span class="op" id="4124465">(</span><span class="op" id="4124466">)</span><span class="op" id="4124467">)</span>&nbsp;<span class="op" id="4124469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124473">if</span>&nbsp;<span class="ident" id="4124476">supportsIPv4map</span>&nbsp;<span class="op" id="4124492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124497">return</span>&nbsp;<span class="ident" id="4124504">syscall</span><span class="op" id="4124511">.</span><span class="ident" id="4124512">AF_INET6</span><span class="op" id="4124520">,</span>&nbsp;<span class="builtintype" id="4124522">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124530">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124534">if</span>&nbsp;<span class="ident" id="4124537">laddr</span>&nbsp;<span class="op" id="4124543">==</span>&nbsp;<span class="ident" id="4124546">nil</span>&nbsp;<span class="op" id="4124550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124555">return</span>&nbsp;<span class="ident" id="4124562">syscall</span><span class="op" id="4124569">.</span><span class="ident" id="4124570">AF_INET</span><span class="op" id="4124577">,</span>&nbsp;<span class="builtintype" id="4124579">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124591">return</span>&nbsp;<span class="ident" id="4124598">laddr</span><span class="op" id="4124603">.</span><span class="ident" id="4124604">family</span><span class="op" id="4124610">(</span><span class="op" id="4124611">)</span><span class="op" id="4124612">,</span>&nbsp;<span class="builtintype" id="4124614">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124621">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124625">if</span>&nbsp;<span class="op" id="4124628">(</span><span class="ident" id="4124629">laddr</span>&nbsp;<span class="op" id="4124635">==</span>&nbsp;<span class="ident" id="4124638">nil</span>&nbsp;<span class="op" id="4124642">||</span>&nbsp;<span class="ident" id="4124645">laddr</span><span class="op" id="4124650">.</span><span class="ident" id="4124651">family</span><span class="op" id="4124657">(</span><span class="op" id="4124658">)</span>&nbsp;<span class="op" id="4124660">==</span>&nbsp;<span class="ident" id="4124663">syscall</span><span class="op" id="4124670">.</span><span class="ident" id="4124671">AF_INET</span><span class="op" id="4124678">)</span>&nbsp;<span class="op" id="4124680">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124685">(</span><span class="ident" id="4124686">raddr</span>&nbsp;<span class="op" id="4124692">==</span>&nbsp;<span class="ident" id="4124695">nil</span>&nbsp;<span class="op" id="4124699">||</span>&nbsp;<span class="ident" id="4124702">raddr</span><span class="op" id="4124707">.</span><span class="ident" id="4124708">family</span><span class="op" id="4124714">(</span><span class="op" id="4124715">)</span>&nbsp;<span class="op" id="4124717">==</span>&nbsp;<span class="ident" id="4124720">syscall</span><span class="op" id="4124727">.</span><span class="ident" id="4124728">AF_INET</span><span class="op" id="4124735">)</span>&nbsp;<span class="op" id="4124737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124741">return</span>&nbsp;<span class="ident" id="4124748">syscall</span><span class="op" id="4124755">.</span><span class="ident" id="4124756">AF_INET</span><span class="op" id="4124763">,</span>&nbsp;<span class="builtintype" id="4124765">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124772">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124775">return</span>&nbsp;<span class="ident" id="4124782">syscall</span><span class="op" id="4124789">.</span><span class="ident" id="4124790">AF_INET6</span><span class="op" id="4124798">,</span>&nbsp;<span class="builtintype" id="4124800">false</span><br>
<span class="lineno"></span><span class="op" id="4124806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4124809">//&nbsp;Internet&nbsp;sockets&nbsp;(TCP,&nbsp;UDP,&nbsp;IP)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="4124845">func</span>&nbsp;<span class="ident" id="4124850">internetSocket</span><span class="op" id="4124864">(</span><span class="ident" id="4124865">net</span>&nbsp;<span class="builtintype" id="4124869">string</span><span class="op" id="4124875">,</span>&nbsp;<span class="ident" id="4124877">laddr</span><span class="op" id="4124882">,</span>&nbsp;<span class="ident" id="4124884">raddr</span>&nbsp;<span class="ident" id="4124890">sockaddr</span><span class="op" id="4124898">,</span>&nbsp;<span class="ident" id="4124900">deadline</span>&nbsp;<span class="ident" id="4124909">time</span><span class="op" id="4124913">.</span><span class="ident" id="4124914">Time</span><span class="op" id="4124918">,</span>&nbsp;<span class="ident" id="4124920">sotype</span><span class="op" id="4124926">,</span>&nbsp;<span class="ident" id="4124928">proto</span>&nbsp;<span class="builtintype" id="4124934">int</span><span class="op" id="4124937">,</span>&nbsp;<span class="ident" id="4124939">mode</span>&nbsp;<span class="builtintype" id="4124944">string</span><span class="op" id="4124950">)</span>&nbsp;<span class="op" id="4124952">(</span><span class="ident" id="4124953">fd</span>&nbsp;<span class="op" id="4124956">*</span><span class="ident" id="4124957">netFD</span><span class="op" id="4124962">,</span>&nbsp;<span class="ident" id="4124964">err</span>&nbsp;<span class="builtintype" id="4124968">error</span><span class="op" id="4124973">)</span>&nbsp;<span class="op" id="4124975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124978">family</span><span class="op" id="4124984">,</span>&nbsp;<span class="ident" id="4124986">ipv6only</span>&nbsp;<span class="op" id="4124995">:=</span>&nbsp;<span class="ident" id="4124998">favoriteAddrFamily</span><span class="op" id="4125016">(</span><span class="ident" id="4125017">net</span><span class="op" id="4125020">,</span>&nbsp;<span class="ident" id="4125022">laddr</span><span class="op" id="4125027">,</span>&nbsp;<span class="ident" id="4125029">raddr</span><span class="op" id="4125034">,</span>&nbsp;<span class="ident" id="4125036">mode</span><span class="op" id="4125040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125043">return</span>&nbsp;<span class="ident" id="4125050">socket</span><span class="op" id="4125056">(</span><span class="ident" id="4125057">net</span><span class="op" id="4125060">,</span>&nbsp;<span class="ident" id="4125062">family</span><span class="op" id="4125068">,</span>&nbsp;<span class="ident" id="4125070">sotype</span><span class="op" id="4125076">,</span>&nbsp;<span class="ident" id="4125078">proto</span><span class="op" id="4125083">,</span>&nbsp;<span class="ident" id="4125085">ipv6only</span><span class="op" id="4125093">,</span>&nbsp;<span class="ident" id="4125095">laddr</span><span class="op" id="4125100">,</span>&nbsp;<span class="ident" id="4125102">raddr</span><span class="op" id="4125107">,</span>&nbsp;<span class="ident" id="4125109">deadline</span><span class="op" id="4125117">)</span><br>
<span class="lineno"></span><span class="op" id="4125119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="4125122">func</span>&nbsp;<span class="ident" id="4125127">ipToSockaddr</span><span class="op" id="4125139">(</span><span class="ident" id="4125140">family</span>&nbsp;<span class="builtintype" id="4125147">int</span><span class="op" id="4125150">,</span>&nbsp;<span class="ident" id="4125152">ip</span>&nbsp;<span class="ident" id="4125155">IP</span><span class="op" id="4125157">,</span>&nbsp;<span class="ident" id="4125159">port</span>&nbsp;<span class="builtintype" id="4125164">int</span><span class="op" id="4125167">,</span>&nbsp;<span class="ident" id="4125169">zone</span>&nbsp;<span class="builtintype" id="4125174">string</span><span class="op" id="4125180">)</span>&nbsp;<span class="op" id="4125182">(</span><span class="ident" id="4125183">syscall</span><span class="op" id="4125190">.</span><span class="ident" id="4125191">Sockaddr</span><span class="op" id="4125199">,</span>&nbsp;<span class="builtintype" id="4125201">error</span><span class="op" id="4125206">)</span>&nbsp;<span class="op" id="4125208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125211">switch</span>&nbsp;<span class="ident" id="4125218">family</span>&nbsp;<span class="op" id="4125225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125228">case</span>&nbsp;<span class="ident" id="4125233">syscall</span><span class="op" id="4125240">.</span><span class="ident" id="4125241">AF_INET</span><span class="op" id="4125248">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125252">if</span>&nbsp;<span class="builtinfunc" id="4125255">len</span><span class="op" id="4125258">(</span><span class="ident" id="4125259">ip</span><span class="op" id="4125261">)</span>&nbsp;<span class="op" id="4125263">==</span>&nbsp;<span class="num" id="4125266">0</span>&nbsp;<span class="op" id="4125268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125273">ip</span>&nbsp;<span class="op" id="4125276">=</span>&nbsp;<span class="ident" id="4125278">IPv4zero</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125293">if</span>&nbsp;<span class="ident" id="4125296">ip</span>&nbsp;<span class="op" id="4125299">=</span>&nbsp;<span class="ident" id="4125301">ip</span><span class="op" id="4125303">.</span><span class="ident" id="4125304">To4</span><span class="op" id="4125307">(</span><span class="op" id="4125308">)</span><span class="op" id="4125309">;</span>&nbsp;<span class="ident" id="4125311">ip</span>&nbsp;<span class="op" id="4125314">==</span>&nbsp;<span class="ident" id="4125317">nil</span>&nbsp;<span class="op" id="4125321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125326">return</span>&nbsp;<span class="ident" id="4125333">nil</span><span class="op" id="4125336">,</span>&nbsp;<span class="ident" id="4125338">InvalidAddrError</span><span class="op" id="4125354">(</span><span class="string" id="4125355">&#34;non-IPv4&nbsp;address&#34;</span><span class="op" id="4125373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125381">sa</span>&nbsp;<span class="op" id="4125384">:=</span>&nbsp;<span class="builtinfunc" id="4125387">new</span><span class="op" id="4125390">(</span><span class="ident" id="4125391">syscall</span><span class="op" id="4125398">.</span><span class="ident" id="4125399">SockaddrInet4</span><span class="op" id="4125412">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125416">for</span>&nbsp;<span class="ident" id="4125420">i</span>&nbsp;<span class="op" id="4125422">:=</span>&nbsp;<span class="num" id="4125425">0</span><span class="op" id="4125426">;</span>&nbsp;<span class="ident" id="4125428">i</span>&nbsp;<span class="op" id="4125430">&lt;</span>&nbsp;<span class="ident" id="4125432">IPv4len</span><span class="op" id="4125439">;</span>&nbsp;<span class="ident" id="4125441">i</span><span class="op" id="4125442">++</span>&nbsp;<span class="op" id="4125445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125450">sa</span><span class="op" id="4125452">.</span><span class="ident" id="4125453">Addr</span><span class="op" id="4125457">[</span><span class="ident" id="4125458">i</span><span class="op" id="4125459">]</span>&nbsp;<span class="op" id="4125461">=</span>&nbsp;<span class="ident" id="4125463">ip</span><span class="op" id="4125465">[</span><span class="ident" id="4125466">i</span><span class="op" id="4125467">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125475">sa</span><span class="op" id="4125477">.</span><span class="ident" id="4125478">Port</span>&nbsp;<span class="op" id="4125483">=</span>&nbsp;<span class="ident" id="4125485">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125492">return</span>&nbsp;<span class="ident" id="4125499">sa</span><span class="op" id="4125501">,</span>&nbsp;<span class="ident" id="4125503">nil</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125508">case</span>&nbsp;<span class="ident" id="4125513">syscall</span><span class="op" id="4125520">.</span><span class="ident" id="4125521">AF_INET6</span><span class="op" id="4125529">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125533">if</span>&nbsp;<span class="builtinfunc" id="4125536">len</span><span class="op" id="4125539">(</span><span class="ident" id="4125540">ip</span><span class="op" id="4125542">)</span>&nbsp;<span class="op" id="4125544">==</span>&nbsp;<span class="num" id="4125547">0</span>&nbsp;<span class="op" id="4125549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125554">ip</span>&nbsp;<span class="op" id="4125557">=</span>&nbsp;<span class="ident" id="4125559">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4125574">//&nbsp;IPv4&nbsp;callers&nbsp;use&nbsp;0.0.0.0&nbsp;to&nbsp;mean&nbsp;&#34;announce&nbsp;on&nbsp;any&nbsp;available&nbsp;address&#34;.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4125649">//&nbsp;In&nbsp;IPv6&nbsp;mode,&nbsp;Linux&nbsp;treats&nbsp;that&nbsp;as&nbsp;meaning&nbsp;&#34;announce&nbsp;on&nbsp;0.0.0.0&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4125720">//&nbsp;which&nbsp;it&nbsp;refuses&nbsp;to&nbsp;do.&nbsp;&nbsp;Rewrite&nbsp;to&nbsp;the&nbsp;IPv6&nbsp;unspecified&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125791">if</span>&nbsp;<span class="ident" id="4125794">ip</span><span class="op" id="4125796">.</span><span class="ident" id="4125797">Equal</span><span class="op" id="4125802">(</span><span class="ident" id="4125803">IPv4zero</span><span class="op" id="4125811">)</span>&nbsp;<span class="op" id="4125813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125818">ip</span>&nbsp;<span class="op" id="4125821">=</span>&nbsp;<span class="ident" id="4125823">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125834">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125838">if</span>&nbsp;<span class="ident" id="4125841">ip</span>&nbsp;<span class="op" id="4125844">=</span>&nbsp;<span class="ident" id="4125846">ip</span><span class="op" id="4125848">.</span><span class="ident" id="4125849">To16</span><span class="op" id="4125853">(</span><span class="op" id="4125854">)</span><span class="op" id="4125855">;</span>&nbsp;<span class="ident" id="4125857">ip</span>&nbsp;<span class="op" id="4125860">==</span>&nbsp;<span class="ident" id="4125863">nil</span>&nbsp;<span class="op" id="4125867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125872">return</span>&nbsp;<span class="ident" id="4125879">nil</span><span class="op" id="4125882">,</span>&nbsp;<span class="ident" id="4125884">InvalidAddrError</span><span class="op" id="4125900">(</span><span class="string" id="4125901">&#34;non-IPv6&nbsp;address&#34;</span><span class="op" id="4125919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125927">sa</span>&nbsp;<span class="op" id="4125930">:=</span>&nbsp;<span class="builtinfunc" id="4125933">new</span><span class="op" id="4125936">(</span><span class="ident" id="4125937">syscall</span><span class="op" id="4125944">.</span><span class="ident" id="4125945">SockaddrInet6</span><span class="op" id="4125958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125962">for</span>&nbsp;<span class="ident" id="4125966">i</span>&nbsp;<span class="op" id="4125968">:=</span>&nbsp;<span class="num" id="4125971">0</span><span class="op" id="4125972">;</span>&nbsp;<span class="ident" id="4125974">i</span>&nbsp;<span class="op" id="4125976">&lt;</span>&nbsp;<span class="ident" id="4125978">IPv6len</span><span class="op" id="4125985">;</span>&nbsp;<span class="ident" id="4125987">i</span><span class="op" id="4125988">++</span>&nbsp;<span class="op" id="4125991">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125996">sa</span><span class="op" id="4125998">.</span><span class="ident" id="4125999">Addr</span><span class="op" id="4126003">[</span><span class="ident" id="4126004">i</span><span class="op" id="4126005">]</span>&nbsp;<span class="op" id="4126007">=</span>&nbsp;<span class="ident" id="4126009">ip</span><span class="op" id="4126011">[</span><span class="ident" id="4126012">i</span><span class="op" id="4126013">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4126017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4126021">sa</span><span class="op" id="4126023">.</span><span class="ident" id="4126024">Port</span>&nbsp;<span class="op" id="4126029">=</span>&nbsp;<span class="ident" id="4126031">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4126038">sa</span><span class="op" id="4126040">.</span><span class="ident" id="4126041">ZoneId</span>&nbsp;<span class="op" id="4126048">=</span>&nbsp;<span class="builtintype" id="4126050">uint32</span><span class="op" id="4126056">(</span><span class="ident" id="4126057">zoneToInt</span><span class="op" id="4126066">(</span><span class="ident" id="4126067">zone</span><span class="op" id="4126071">)</span><span class="op" id="4126072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4126076">return</span>&nbsp;<span class="ident" id="4126083">sa</span><span class="op" id="4126085">,</span>&nbsp;<span class="ident" id="4126087">nil</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4126092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4126095">return</span>&nbsp;<span class="ident" id="4126102">nil</span><span class="op" id="4126105">,</span>&nbsp;<span class="ident" id="4126107">InvalidAddrError</span><span class="op" id="4126123">(</span><span class="string" id="4126124">&#34;unexpected&nbsp;socket&nbsp;family&#34;</span><span class="op" id="4126150">)</span><br>
<span class="lineno"></span><span class="op" id="4126152">}</span>
</div>
</body>
</html>
