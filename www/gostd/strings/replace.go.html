<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>strings</h2>
<ul>
<li><a href="/gostd/strings/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/strings/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/strings/reader.go.html">reader.go</a></li>
<li><a href="/gostd/strings/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/strings/replace.go.html">replace.go</a></li>
<li><a href="/gostd/strings/replace_test.go.html">replace_test.go</a></li>
<li><a href="/gostd/strings/search.go.html">search.go</a></li>
<li><a href="/gostd/strings/search_test.go.html">search_test.go</a></li>
<li><a href="/gostd/strings/strings.go.html">strings.go</a></li>
<li><a href="/gostd/strings/strings_decl.go.html">strings_decl.go</a></li>
<li><a href="/gostd/strings/strings_test.go.html">strings_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2188055">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2188110">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2188164">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2188215">package</span>&nbsp;<span class="ident" id="2188223">strings</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2188232">import</span>&nbsp;<span class="string" id="2188239">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2188245">//&nbsp;Replacer&nbsp;replaces&nbsp;a&nbsp;list&nbsp;of&nbsp;strings&nbsp;with&nbsp;replacements.</span><br>
<span class="lineno">10</span><span class="comment" id="2188303">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="2188360">type</span>&nbsp;<span class="ident" id="2188365">Replacer</span>&nbsp;<span class="keyword" id="2188374">struct</span>&nbsp;<span class="op" id="2188381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2188384">r</span>&nbsp;<span class="ident" id="2188386">replacer</span><br>
<span class="lineno"></span><span class="op" id="2188395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="2188398">//&nbsp;replacer&nbsp;is&nbsp;the&nbsp;interface&nbsp;that&nbsp;a&nbsp;replacement&nbsp;algorithm&nbsp;needs&nbsp;to&nbsp;implement.</span><br>
<span class="lineno"></span><span class="keyword" id="2188476">type</span>&nbsp;<span class="ident" id="2188481">replacer</span>&nbsp;<span class="keyword" id="2188490">interface</span>&nbsp;<span class="op" id="2188500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2188503">Replace</span><span class="op" id="2188510">(</span><span class="ident" id="2188511">s</span>&nbsp;<span class="builtintype" id="2188513">string</span><span class="op" id="2188519">)</span>&nbsp;<span class="builtintype" id="2188521">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2188529">WriteString</span><span class="op" id="2188540">(</span><span class="ident" id="2188541">w</span>&nbsp;<span class="ident" id="2188543">io</span><span class="op" id="2188545">.</span><span class="ident" id="2188546">Writer</span><span class="op" id="2188552">,</span>&nbsp;<span class="ident" id="2188554">s</span>&nbsp;<span class="builtintype" id="2188556">string</span><span class="op" id="2188562">)</span>&nbsp;<span class="op" id="2188564">(</span><span class="ident" id="2188565">n</span>&nbsp;<span class="builtintype" id="2188567">int</span><span class="op" id="2188570">,</span>&nbsp;<span class="ident" id="2188572">err</span>&nbsp;<span class="builtintype" id="2188576">error</span><span class="op" id="2188581">)</span><br>
<span class="lineno"></span><span class="op" id="2188583">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="2188586">//&nbsp;NewReplacer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Replacer&nbsp;from&nbsp;a&nbsp;list&nbsp;of&nbsp;old,&nbsp;new&nbsp;string&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="comment" id="2188662">//&nbsp;Replacements&nbsp;are&nbsp;performed&nbsp;in&nbsp;order,&nbsp;without&nbsp;overlapping&nbsp;matches.</span><br>
<span class="lineno"></span><span class="keyword" id="2188731">func</span>&nbsp;<span class="ident" id="2188736">NewReplacer</span><span class="op" id="2188747">(</span><span class="ident" id="2188748">oldnew</span>&nbsp;<span class="op" id="2188755">...</span><span class="builtintype" id="2188758">string</span><span class="op" id="2188764">)</span>&nbsp;<span class="op" id="2188766">*</span><span class="ident" id="2188767">Replacer</span>&nbsp;<span class="op" id="2188776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2188779">if</span>&nbsp;<span class="builtinfunc" id="2188782">len</span><span class="op" id="2188785">(</span><span class="ident" id="2188786">oldnew</span><span class="op" id="2188792">)</span><span class="op" id="2188793">%</span><span class="num" id="2188794">2</span>&nbsp;<span class="op" id="2188796">==</span>&nbsp;<span class="num" id="2188799">1</span>&nbsp;<span class="op" id="2188801">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2188805">panic</span><span class="op" id="2188810">(</span><span class="string" id="2188811">&#34;strings.NewReplacer:&nbsp;odd&nbsp;argument&nbsp;count&#34;</span><span class="op" id="2188852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2188855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2188859">if</span>&nbsp;<span class="builtinfunc" id="2188862">len</span><span class="op" id="2188865">(</span><span class="ident" id="2188866">oldnew</span><span class="op" id="2188872">)</span>&nbsp;<span class="op" id="2188874">==</span>&nbsp;<span class="num" id="2188877">2</span>&nbsp;<span class="op" id="2188879">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2188882">len</span><span class="op" id="2188885">(</span><span class="ident" id="2188886">oldnew</span><span class="op" id="2188892">[</span><span class="num" id="2188893">0</span><span class="op" id="2188894">]</span><span class="op" id="2188895">)</span>&nbsp;<span class="op" id="2188897">&gt;</span>&nbsp;<span class="num" id="2188899">1</span>&nbsp;<span class="op" id="2188901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2188905">return</span>&nbsp;<span class="op" id="2188912">&amp;</span><span class="ident" id="2188913">Replacer</span><span class="op" id="2188921">{</span><span class="ident" id="2188922">r</span><span class="op" id="2188923">:</span>&nbsp;<span class="ident" id="2188925">makeSingleStringReplacer</span><span class="op" id="2188949">(</span><span class="ident" id="2188950">oldnew</span><span class="op" id="2188956">[</span><span class="num" id="2188957">0</span><span class="op" id="2188958">]</span><span class="op" id="2188959">,</span>&nbsp;<span class="ident" id="2188961">oldnew</span><span class="op" id="2188967">[</span><span class="num" id="2188968">1</span><span class="op" id="2188969">]</span><span class="op" id="2188970">)</span><span class="op" id="2188971">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2188974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2188978">allNewBytes</span>&nbsp;<span class="op" id="2188990">:=</span>&nbsp;<span class="builtintype" id="2188993">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2188999">for</span>&nbsp;<span class="ident" id="2189003">i</span>&nbsp;<span class="op" id="2189005">:=</span>&nbsp;<span class="num" id="2189008">0</span><span class="op" id="2189009">;</span>&nbsp;<span class="ident" id="2189011">i</span>&nbsp;<span class="op" id="2189013">&lt;</span>&nbsp;<span class="builtinfunc" id="2189015">len</span><span class="op" id="2189018">(</span><span class="ident" id="2189019">oldnew</span><span class="op" id="2189025">)</span><span class="op" id="2189026">;</span>&nbsp;<span class="ident" id="2189028">i</span>&nbsp;<span class="op" id="2189030">+=</span>&nbsp;<span class="num" id="2189033">2</span>&nbsp;<span class="op" id="2189035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2189039">if</span>&nbsp;<span class="builtinfunc" id="2189042">len</span><span class="op" id="2189045">(</span><span class="ident" id="2189046">oldnew</span><span class="op" id="2189052">[</span><span class="ident" id="2189053">i</span><span class="op" id="2189054">]</span><span class="op" id="2189055">)</span>&nbsp;<span class="op" id="2189057">!=</span>&nbsp;<span class="num" id="2189060">1</span>&nbsp;<span class="op" id="2189062">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2189067">return</span>&nbsp;<span class="op" id="2189074">&amp;</span><span class="ident" id="2189075">Replacer</span><span class="op" id="2189083">{</span><span class="ident" id="2189084">r</span><span class="op" id="2189085">:</span>&nbsp;<span class="ident" id="2189087">makeGenericReplacer</span><span class="op" id="2189106">(</span><span class="ident" id="2189107">oldnew</span><span class="op" id="2189113">)</span><span class="op" id="2189114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2189118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2189122">if</span>&nbsp;<span class="builtinfunc" id="2189125">len</span><span class="op" id="2189128">(</span><span class="ident" id="2189129">oldnew</span><span class="op" id="2189135">[</span><span class="ident" id="2189136">i</span><span class="op" id="2189137">+</span><span class="num" id="2189138">1</span><span class="op" id="2189139">]</span><span class="op" id="2189140">)</span>&nbsp;<span class="op" id="2189142">!=</span>&nbsp;<span class="num" id="2189145">1</span>&nbsp;<span class="op" id="2189147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2189152">allNewBytes</span>&nbsp;<span class="op" id="2189164">=</span>&nbsp;<span class="builtintype" id="2189166">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2189174">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2189177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2189181">if</span>&nbsp;<span class="ident" id="2189184">allNewBytes</span>&nbsp;<span class="op" id="2189196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2189200">r</span>&nbsp;<span class="op" id="2189202">:=</span>&nbsp;<span class="ident" id="2189205">byteReplacer</span><span class="op" id="2189217">{</span><span class="op" id="2189218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2189222">for</span>&nbsp;<span class="ident" id="2189226">i</span>&nbsp;<span class="op" id="2189228">:=</span>&nbsp;<span class="keyword" id="2189231">range</span>&nbsp;<span class="ident" id="2189237">r</span>&nbsp;<span class="op" id="2189239">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2189244">r</span><span class="op" id="2189245">[</span><span class="ident" id="2189246">i</span><span class="op" id="2189247">]</span>&nbsp;<span class="op" id="2189249">=</span>&nbsp;<span class="builtintype" id="2189251">byte</span><span class="op" id="2189255">(</span><span class="ident" id="2189256">i</span><span class="op" id="2189257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2189261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2189265">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2189324">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2189371">for</span>&nbsp;<span class="ident" id="2189375">i</span>&nbsp;<span class="op" id="2189377">:=</span>&nbsp;<span class="builtinfunc" id="2189380">len</span><span class="op" id="2189383">(</span><span class="ident" id="2189384">oldnew</span><span class="op" id="2189390">)</span>&nbsp;<span class="op" id="2189392">-</span>&nbsp;<span class="num" id="2189394">2</span><span class="op" id="2189395">;</span>&nbsp;<span class="ident" id="2189397">i</span>&nbsp;<span class="op" id="2189399">&gt;=</span>&nbsp;<span class="num" id="2189402">0</span><span class="op" id="2189403">;</span>&nbsp;<span class="ident" id="2189405">i</span>&nbsp;<span class="op" id="2189407">-=</span>&nbsp;<span class="num" id="2189410">2</span>&nbsp;<span class="op" id="2189412">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2189417">o</span>&nbsp;<span class="op" id="2189419">:=</span>&nbsp;<span class="ident" id="2189422">oldnew</span><span class="op" id="2189428">[</span><span class="ident" id="2189429">i</span><span class="op" id="2189430">]</span><span class="op" id="2189431">[</span><span class="num" id="2189432">0</span><span class="op" id="2189433">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2189438">n</span>&nbsp;<span class="op" id="2189440">:=</span>&nbsp;<span class="ident" id="2189443">oldnew</span><span class="op" id="2189449">[</span><span class="ident" id="2189450">i</span><span class="op" id="2189451">+</span><span class="num" id="2189452">1</span><span class="op" id="2189453">]</span><span class="op" id="2189454">[</span><span class="num" id="2189455">0</span><span class="op" id="2189456">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2189461">r</span><span class="op" id="2189462">[</span><span class="ident" id="2189463">o</span><span class="op" id="2189464">]</span>&nbsp;<span class="op" id="2189466">=</span>&nbsp;<span class="ident" id="2189468">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2189472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2189476">return</span>&nbsp;<span class="op" id="2189483">&amp;</span><span class="ident" id="2189484">Replacer</span><span class="op" id="2189492">{</span><span class="ident" id="2189493">r</span><span class="op" id="2189494">:</span>&nbsp;<span class="op" id="2189496">&amp;</span><span class="ident" id="2189497">r</span><span class="op" id="2189498">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2189501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2189505">r</span>&nbsp;<span class="op" id="2189507">:=</span>&nbsp;<span class="ident" id="2189510">byteStringReplacer</span><span class="op" id="2189528">{</span><span class="op" id="2189529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2189532">//&nbsp;The&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;old-&gt;new&nbsp;map&nbsp;takes&nbsp;precedence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2189590">//&nbsp;over&nbsp;the&nbsp;others&nbsp;with&nbsp;the&nbsp;same&nbsp;old&nbsp;string.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2189636">for</span>&nbsp;<span class="ident" id="2189640">i</span>&nbsp;<span class="op" id="2189642">:=</span>&nbsp;<span class="builtinfunc" id="2189645">len</span><span class="op" id="2189648">(</span><span class="ident" id="2189649">oldnew</span><span class="op" id="2189655">)</span>&nbsp;<span class="op" id="2189657">-</span>&nbsp;<span class="num" id="2189659">2</span><span class="op" id="2189660">;</span>&nbsp;<span class="ident" id="2189662">i</span>&nbsp;<span class="op" id="2189664">&gt;=</span>&nbsp;<span class="num" id="2189667">0</span><span class="op" id="2189668">;</span>&nbsp;<span class="ident" id="2189670">i</span>&nbsp;<span class="op" id="2189672">-=</span>&nbsp;<span class="num" id="2189675">2</span>&nbsp;<span class="op" id="2189677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2189681">o</span>&nbsp;<span class="op" id="2189683">:=</span>&nbsp;<span class="ident" id="2189686">oldnew</span><span class="op" id="2189692">[</span><span class="ident" id="2189693">i</span><span class="op" id="2189694">]</span><span class="op" id="2189695">[</span><span class="num" id="2189696">0</span><span class="op" id="2189697">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2189701">n</span>&nbsp;<span class="op" id="2189703">:=</span>&nbsp;<span class="ident" id="2189706">oldnew</span><span class="op" id="2189712">[</span><span class="ident" id="2189713">i</span><span class="op" id="2189714">+</span><span class="num" id="2189715">1</span><span class="op" id="2189716">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2189720">r</span><span class="op" id="2189721">[</span><span class="ident" id="2189722">o</span><span class="op" id="2189723">]</span>&nbsp;<span class="op" id="2189725">=</span>&nbsp;<span class="op" id="2189727">[</span><span class="op" id="2189728">]</span><span class="builtintype" id="2189729">byte</span><span class="op" id="2189733">(</span><span class="ident" id="2189734">n</span><span class="op" id="2189735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2189738">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2189741">return</span>&nbsp;<span class="op" id="2189748">&amp;</span><span class="ident" id="2189749">Replacer</span><span class="op" id="2189757">{</span><span class="ident" id="2189758">r</span><span class="op" id="2189759">:</span>&nbsp;<span class="op" id="2189761">&amp;</span><span class="ident" id="2189762">r</span><span class="op" id="2189763">}</span><br>
<span class="lineno"></span><span class="op" id="2189765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2189768">//&nbsp;Replace&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;s&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2189832">func</span>&nbsp;<span class="op" id="2189837">(</span><span class="ident" id="2189838">r</span>&nbsp;<span class="op" id="2189840">*</span><span class="ident" id="2189841">Replacer</span><span class="op" id="2189849">)</span>&nbsp;<span class="ident" id="2189851">Replace</span><span class="op" id="2189858">(</span><span class="ident" id="2189859">s</span>&nbsp;<span class="builtintype" id="2189861">string</span><span class="op" id="2189867">)</span>&nbsp;<span class="builtintype" id="2189869">string</span>&nbsp;<span class="op" id="2189876">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2189879">return</span>&nbsp;<span class="ident" id="2189886">r</span><span class="op" id="2189887">.</span><span class="ident" id="2189888">r</span><span class="op" id="2189889">.</span><span class="ident" id="2189890">Replace</span><span class="op" id="2189897">(</span><span class="ident" id="2189898">s</span><span class="op" id="2189899">)</span><br>
<span class="lineno"></span><span class="op" id="2189901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2189904">//&nbsp;WriteString&nbsp;writes&nbsp;s&nbsp;to&nbsp;w&nbsp;with&nbsp;all&nbsp;replacements&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="2189966">func</span>&nbsp;<span class="op" id="2189971">(</span><span class="ident" id="2189972">r</span>&nbsp;<span class="op" id="2189974">*</span><span class="ident" id="2189975">Replacer</span><span class="op" id="2189983">)</span>&nbsp;<span class="ident" id="2189985">WriteString</span><span class="op" id="2189996">(</span><span class="ident" id="2189997">w</span>&nbsp;<span class="ident" id="2189999">io</span><span class="op" id="2190001">.</span><span class="ident" id="2190002">Writer</span><span class="op" id="2190008">,</span>&nbsp;<span class="ident" id="2190010">s</span>&nbsp;<span class="builtintype" id="2190012">string</span><span class="op" id="2190018">)</span>&nbsp;<span class="op" id="2190020">(</span><span class="ident" id="2190021">n</span>&nbsp;<span class="builtintype" id="2190023">int</span><span class="op" id="2190026">,</span>&nbsp;<span class="ident" id="2190028">err</span>&nbsp;<span class="builtintype" id="2190032">error</span><span class="op" id="2190037">)</span>&nbsp;<span class="op" id="2190039">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2190042">return</span>&nbsp;<span class="ident" id="2190049">r</span><span class="op" id="2190050">.</span><span class="ident" id="2190051">r</span><span class="op" id="2190052">.</span><span class="ident" id="2190053">WriteString</span><span class="op" id="2190064">(</span><span class="ident" id="2190065">w</span><span class="op" id="2190066">,</span>&nbsp;<span class="ident" id="2190068">s</span><span class="op" id="2190069">)</span><br>
<span class="lineno"></span><span class="op" id="2190071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2190074">//&nbsp;trieNode&nbsp;is&nbsp;a&nbsp;node&nbsp;in&nbsp;a&nbsp;lookup&nbsp;trie&nbsp;for&nbsp;prioritized&nbsp;key/value&nbsp;pairs.&nbsp;Keys</span><br>
<span class="lineno"></span><span class="comment" id="2190151">//&nbsp;and&nbsp;values&nbsp;may&nbsp;be&nbsp;empty.&nbsp;For&nbsp;example,&nbsp;the&nbsp;trie&nbsp;containing&nbsp;keys&nbsp;&#34;ax&#34;,&nbsp;&#34;ay&#34;,</span><br>
<span class="lineno">80</span><span class="comment" id="2190229">//&nbsp;&#34;bcbc&#34;,&nbsp;&#34;x&#34;&nbsp;and&nbsp;&#34;xy&#34;&nbsp;could&nbsp;have&nbsp;eight&nbsp;nodes:</span><br>
<span class="lineno"></span><span class="comment" id="2190277">//</span><br>
<span class="lineno"></span><span class="comment" id="2190280">//&nbsp;&nbsp;n0&nbsp;&nbsp;-</span><br>
<span class="lineno"></span><span class="comment" id="2190290">//&nbsp;&nbsp;n1&nbsp;&nbsp;a-</span><br>
<span class="lineno"></span><span class="comment" id="2190301">//&nbsp;&nbsp;n2&nbsp;&nbsp;.x+</span><br>
<span class="lineno">85</span><span class="comment" id="2190313">//&nbsp;&nbsp;n3&nbsp;&nbsp;.y+</span><br>
<span class="lineno"></span><span class="comment" id="2190325">//&nbsp;&nbsp;n4&nbsp;&nbsp;b-</span><br>
<span class="lineno"></span><span class="comment" id="2190336">//&nbsp;&nbsp;n5&nbsp;&nbsp;.cbc+</span><br>
<span class="lineno"></span><span class="comment" id="2190350">//&nbsp;&nbsp;n6&nbsp;&nbsp;x+</span><br>
<span class="lineno"></span><span class="comment" id="2190361">//&nbsp;&nbsp;n7&nbsp;&nbsp;.y+</span><br>
<span class="lineno">90</span><span class="comment" id="2190373">//</span><br>
<span class="lineno"></span><span class="comment" id="2190376">//&nbsp;n0&nbsp;is&nbsp;the&nbsp;root&nbsp;node,&nbsp;and&nbsp;its&nbsp;children&nbsp;are&nbsp;n1,&nbsp;n4&nbsp;and&nbsp;n6;&nbsp;n1&#39;s&nbsp;children&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="2190454">//&nbsp;n2&nbsp;and&nbsp;n3;&nbsp;n4&#39;s&nbsp;child&nbsp;is&nbsp;n5;&nbsp;n6&#39;s&nbsp;child&nbsp;is&nbsp;n7.&nbsp;Nodes&nbsp;n0,&nbsp;n1&nbsp;and&nbsp;n4&nbsp;(marked</span><br>
<span class="lineno"></span><span class="comment" id="2190532">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;-&#34;)&nbsp;are&nbsp;partial&nbsp;keys,&nbsp;and&nbsp;nodes&nbsp;n2,&nbsp;n3,&nbsp;n5,&nbsp;n6&nbsp;and&nbsp;n7</span><br>
<span class="lineno"></span><span class="comment" id="2190606">//&nbsp;(marked&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;)&nbsp;are&nbsp;complete&nbsp;keys.</span><br>
<span class="lineno">95</span><span class="keyword" id="2190657">type</span>&nbsp;<span class="ident" id="2190662">trieNode</span>&nbsp;<span class="keyword" id="2190671">struct</span>&nbsp;<span class="op" id="2190678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2190681">//&nbsp;value&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s&nbsp;key/value&nbsp;pair.&nbsp;It&nbsp;is&nbsp;empty&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2190754">//&nbsp;this&nbsp;node&nbsp;is&nbsp;not&nbsp;a&nbsp;complete&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2190791">value</span>&nbsp;<span class="builtintype" id="2190797">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2190805">//&nbsp;priority&nbsp;is&nbsp;the&nbsp;priority&nbsp;(higher&nbsp;is&nbsp;more&nbsp;important)&nbsp;of&nbsp;the&nbsp;trie&nbsp;node&#39;s</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2190880">//&nbsp;key/value&nbsp;pair;&nbsp;keys&nbsp;are&nbsp;not&nbsp;necessarily&nbsp;matched&nbsp;shortest-&nbsp;or&nbsp;longest-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2190955">//&nbsp;first.&nbsp;Priority&nbsp;is&nbsp;positive&nbsp;if&nbsp;this&nbsp;node&nbsp;is&nbsp;a&nbsp;complete&nbsp;key,&nbsp;and&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191028">//&nbsp;otherwise.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;positive/zero&nbsp;priorities&nbsp;are&nbsp;marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191101">//&nbsp;with&nbsp;a&nbsp;trailing&nbsp;&#34;+&#34;&nbsp;or&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2191133">priority</span>&nbsp;<span class="builtintype" id="2191142">int</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191148">//&nbsp;A&nbsp;trie&nbsp;node&nbsp;may&nbsp;have&nbsp;zero,&nbsp;one&nbsp;or&nbsp;more&nbsp;child&nbsp;nodes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191204">//&nbsp;&nbsp;*&nbsp;if&nbsp;the&nbsp;remaining&nbsp;fields&nbsp;are&nbsp;zero,&nbsp;there&nbsp;are&nbsp;no&nbsp;children.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191268">//&nbsp;&nbsp;*&nbsp;if&nbsp;prefix&nbsp;and&nbsp;next&nbsp;are&nbsp;non-zero,&nbsp;there&nbsp;is&nbsp;one&nbsp;child&nbsp;in&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191336">//&nbsp;&nbsp;*&nbsp;if&nbsp;table&nbsp;is&nbsp;non-zero,&nbsp;it&nbsp;defines&nbsp;all&nbsp;the&nbsp;children.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191394">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191398">//&nbsp;Prefixes&nbsp;are&nbsp;preferred&nbsp;over&nbsp;tables&nbsp;when&nbsp;there&nbsp;is&nbsp;one&nbsp;child,&nbsp;but&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191470">//&nbsp;root&nbsp;node&nbsp;always&nbsp;uses&nbsp;a&nbsp;table&nbsp;for&nbsp;lookup&nbsp;efficiency.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191528">//&nbsp;prefix&nbsp;is&nbsp;the&nbsp;difference&nbsp;in&nbsp;keys&nbsp;between&nbsp;this&nbsp;trie&nbsp;node&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191602">//&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;node&nbsp;n4&nbsp;has&nbsp;prefix&nbsp;&#34;cbc&#34;&nbsp;and&nbsp;n4&#39;s&nbsp;next&nbsp;node&nbsp;is&nbsp;n5.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191679">//&nbsp;Node&nbsp;n5&nbsp;has&nbsp;no&nbsp;children&nbsp;and&nbsp;so&nbsp;has&nbsp;zero&nbsp;prefix,&nbsp;next&nbsp;and&nbsp;table&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2191754">prefix</span>&nbsp;<span class="builtintype" id="2191761">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2191769">next</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2191776">*</span><span class="ident" id="2191777">trieNode</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191788">//&nbsp;table&nbsp;is&nbsp;a&nbsp;lookup&nbsp;table&nbsp;indexed&nbsp;by&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;key,&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191859">//&nbsp;remapping&nbsp;that&nbsp;byte&nbsp;through&nbsp;genericReplacer.mapping&nbsp;to&nbsp;create&nbsp;a&nbsp;dense</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2191933">//&nbsp;index.&nbsp;In&nbsp;the&nbsp;example&nbsp;above,&nbsp;the&nbsp;keys&nbsp;only&nbsp;use&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;,&nbsp;&#39;c&#39;,&nbsp;&#39;x&#39;&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2192007">//&nbsp;&#39;y&#39;,&nbsp;which&nbsp;remap&nbsp;to&nbsp;0,&nbsp;1,&nbsp;2,&nbsp;3&nbsp;and&nbsp;4.&nbsp;All&nbsp;other&nbsp;bytes&nbsp;remap&nbsp;to&nbsp;5,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2192081">//&nbsp;genericReplacer.tableSize&nbsp;will&nbsp;be&nbsp;5.&nbsp;Node&nbsp;n0&#39;s&nbsp;table&nbsp;will&nbsp;be</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2192146">//&nbsp;[]*trieNode{&nbsp;0:n1,&nbsp;1:n4,&nbsp;3:n6&nbsp;},&nbsp;where&nbsp;the&nbsp;0,&nbsp;1&nbsp;and&nbsp;3&nbsp;are&nbsp;the&nbsp;remapped</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2192221">//&nbsp;&#39;a&#39;,&nbsp;&#39;b&#39;&nbsp;and&nbsp;&#39;x&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2192243">table</span>&nbsp;<span class="op" id="2192249">[</span><span class="op" id="2192250">]</span><span class="op" id="2192251">*</span><span class="ident" id="2192252">trieNode</span><br>
<span class="lineno"></span><span class="op" id="2192261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2192264">func</span>&nbsp;<span class="op" id="2192269">(</span><span class="ident" id="2192270">t</span>&nbsp;<span class="op" id="2192272">*</span><span class="ident" id="2192273">trieNode</span><span class="op" id="2192281">)</span>&nbsp;<span class="ident" id="2192283">add</span><span class="op" id="2192286">(</span><span class="ident" id="2192287">key</span><span class="op" id="2192290">,</span>&nbsp;<span class="ident" id="2192292">val</span>&nbsp;<span class="builtintype" id="2192296">string</span><span class="op" id="2192302">,</span>&nbsp;<span class="ident" id="2192304">priority</span>&nbsp;<span class="builtintype" id="2192313">int</span><span class="op" id="2192316">,</span>&nbsp;<span class="ident" id="2192318">r</span>&nbsp;<span class="op" id="2192320">*</span><span class="ident" id="2192321">genericReplacer</span><span class="op" id="2192336">)</span>&nbsp;<span class="op" id="2192338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2192341">if</span>&nbsp;<span class="ident" id="2192344">key</span>&nbsp;<span class="op" id="2192348">==</span>&nbsp;<span class="string" id="2192351">&#34;&#34;</span>&nbsp;<span class="op" id="2192354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2192358">if</span>&nbsp;<span class="ident" id="2192361">t</span><span class="op" id="2192362">.</span><span class="ident" id="2192363">priority</span>&nbsp;<span class="op" id="2192372">==</span>&nbsp;<span class="num" id="2192375">0</span>&nbsp;<span class="op" id="2192377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2192382">t</span><span class="op" id="2192383">.</span><span class="ident" id="2192384">value</span>&nbsp;<span class="op" id="2192390">=</span>&nbsp;<span class="ident" id="2192392">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2192399">t</span><span class="op" id="2192400">.</span><span class="ident" id="2192401">priority</span>&nbsp;<span class="op" id="2192410">=</span>&nbsp;<span class="ident" id="2192412">priority</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2192423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2192427">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2192435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2192439">if</span>&nbsp;<span class="ident" id="2192442">t</span><span class="op" id="2192443">.</span><span class="ident" id="2192444">prefix</span>&nbsp;<span class="op" id="2192451">!=</span>&nbsp;<span class="string" id="2192454">&#34;&#34;</span>&nbsp;<span class="op" id="2192457">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2192461">//&nbsp;Need&nbsp;to&nbsp;split&nbsp;the&nbsp;prefix&nbsp;among&nbsp;multiple&nbsp;nodes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2192513">var</span>&nbsp;<span class="ident" id="2192517">n</span>&nbsp;<span class="builtintype" id="2192519">int</span>&nbsp;<span class="comment" id="2192523">//&nbsp;length&nbsp;of&nbsp;the&nbsp;longest&nbsp;common&nbsp;prefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2192564">for</span>&nbsp;<span class="op" id="2192568">;</span>&nbsp;<span class="ident" id="2192570">n</span>&nbsp;<span class="op" id="2192572">&lt;</span>&nbsp;<span class="builtinfunc" id="2192574">len</span><span class="op" id="2192577">(</span><span class="ident" id="2192578">t</span><span class="op" id="2192579">.</span><span class="ident" id="2192580">prefix</span><span class="op" id="2192586">)</span>&nbsp;<span class="op" id="2192588">&amp;&amp;</span>&nbsp;<span class="ident" id="2192591">n</span>&nbsp;<span class="op" id="2192593">&lt;</span>&nbsp;<span class="builtinfunc" id="2192595">len</span><span class="op" id="2192598">(</span><span class="ident" id="2192599">key</span><span class="op" id="2192602">)</span><span class="op" id="2192603">;</span>&nbsp;<span class="ident" id="2192605">n</span><span class="op" id="2192606">++</span>&nbsp;<span class="op" id="2192609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2192614">if</span>&nbsp;<span class="ident" id="2192617">t</span><span class="op" id="2192618">.</span><span class="ident" id="2192619">prefix</span><span class="op" id="2192625">[</span><span class="ident" id="2192626">n</span><span class="op" id="2192627">]</span>&nbsp;<span class="op" id="2192629">!=</span>&nbsp;<span class="ident" id="2192632">key</span><span class="op" id="2192635">[</span><span class="ident" id="2192636">n</span><span class="op" id="2192637">]</span>&nbsp;<span class="op" id="2192639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2192645">break</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2192654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2192658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2192662">if</span>&nbsp;<span class="ident" id="2192665">n</span>&nbsp;<span class="op" id="2192667">==</span>&nbsp;<span class="builtinfunc" id="2192670">len</span><span class="op" id="2192673">(</span><span class="ident" id="2192674">t</span><span class="op" id="2192675">.</span><span class="ident" id="2192676">prefix</span><span class="op" id="2192682">)</span>&nbsp;<span class="op" id="2192684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2192689">t</span><span class="op" id="2192690">.</span><span class="ident" id="2192691">next</span><span class="op" id="2192695">.</span><span class="ident" id="2192696">add</span><span class="op" id="2192699">(</span><span class="ident" id="2192700">key</span><span class="op" id="2192703">[</span><span class="ident" id="2192704">n</span><span class="op" id="2192705">:</span><span class="op" id="2192706">]</span><span class="op" id="2192707">,</span>&nbsp;<span class="ident" id="2192709">val</span><span class="op" id="2192712">,</span>&nbsp;<span class="ident" id="2192714">priority</span><span class="op" id="2192722">,</span>&nbsp;<span class="ident" id="2192724">r</span><span class="op" id="2192725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2192729">}</span>&nbsp;<span class="keyword" id="2192731">else</span>&nbsp;<span class="keyword" id="2192736">if</span>&nbsp;<span class="ident" id="2192739">n</span>&nbsp;<span class="op" id="2192741">==</span>&nbsp;<span class="num" id="2192744">0</span>&nbsp;<span class="op" id="2192746">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2192751">//&nbsp;First&nbsp;byte&nbsp;differs,&nbsp;start&nbsp;a&nbsp;new&nbsp;lookup&nbsp;table&nbsp;here.&nbsp;Looking&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2192819">//&nbsp;what&nbsp;is&nbsp;currently&nbsp;t.prefix[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;prefixNode,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2192884">//&nbsp;looking&nbsp;up&nbsp;key[0]&nbsp;will&nbsp;lead&nbsp;to&nbsp;keyNode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2192930">var</span>&nbsp;<span class="ident" id="2192934">prefixNode</span>&nbsp;<span class="op" id="2192945">*</span><span class="ident" id="2192946">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2192958">if</span>&nbsp;<span class="builtinfunc" id="2192961">len</span><span class="op" id="2192964">(</span><span class="ident" id="2192965">t</span><span class="op" id="2192966">.</span><span class="ident" id="2192967">prefix</span><span class="op" id="2192973">)</span>&nbsp;<span class="op" id="2192975">==</span>&nbsp;<span class="num" id="2192978">1</span>&nbsp;<span class="op" id="2192980">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2192986">prefixNode</span>&nbsp;<span class="op" id="2192997">=</span>&nbsp;<span class="ident" id="2192999">t</span><span class="op" id="2193000">.</span><span class="ident" id="2193001">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2193009">}</span>&nbsp;<span class="keyword" id="2193011">else</span>&nbsp;<span class="op" id="2193016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193022">prefixNode</span>&nbsp;<span class="op" id="2193033">=</span>&nbsp;<span class="op" id="2193035">&amp;</span><span class="ident" id="2193036">trieNode</span><span class="op" id="2193044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193051">prefix</span><span class="op" id="2193057">:</span>&nbsp;<span class="ident" id="2193059">t</span><span class="op" id="2193060">.</span><span class="ident" id="2193061">prefix</span><span class="op" id="2193067">[</span><span class="num" id="2193068">1</span><span class="op" id="2193069">:</span><span class="op" id="2193070">]</span><span class="op" id="2193071">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193078">next</span><span class="op" id="2193082">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2193086">t</span><span class="op" id="2193087">.</span><span class="ident" id="2193088">next</span><span class="op" id="2193092">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2193098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2193103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193108">keyNode</span>&nbsp;<span class="op" id="2193116">:=</span>&nbsp;<span class="builtinfunc" id="2193119">new</span><span class="op" id="2193122">(</span><span class="ident" id="2193123">trieNode</span><span class="op" id="2193131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193136">t</span><span class="op" id="2193137">.</span><span class="ident" id="2193138">table</span>&nbsp;<span class="op" id="2193144">=</span>&nbsp;<span class="builtinfunc" id="2193146">make</span><span class="op" id="2193150">(</span><span class="op" id="2193151">[</span><span class="op" id="2193152">]</span><span class="op" id="2193153">*</span><span class="ident" id="2193154">trieNode</span><span class="op" id="2193162">,</span>&nbsp;<span class="ident" id="2193164">r</span><span class="op" id="2193165">.</span><span class="ident" id="2193166">tableSize</span><span class="op" id="2193175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193180">t</span><span class="op" id="2193181">.</span><span class="ident" id="2193182">table</span><span class="op" id="2193187">[</span><span class="ident" id="2193188">r</span><span class="op" id="2193189">.</span><span class="ident" id="2193190">mapping</span><span class="op" id="2193197">[</span><span class="ident" id="2193198">t</span><span class="op" id="2193199">.</span><span class="ident" id="2193200">prefix</span><span class="op" id="2193206">[</span><span class="num" id="2193207">0</span><span class="op" id="2193208">]</span><span class="op" id="2193209">]</span><span class="op" id="2193210">]</span>&nbsp;<span class="op" id="2193212">=</span>&nbsp;<span class="ident" id="2193214">prefixNode</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193228">t</span><span class="op" id="2193229">.</span><span class="ident" id="2193230">table</span><span class="op" id="2193235">[</span><span class="ident" id="2193236">r</span><span class="op" id="2193237">.</span><span class="ident" id="2193238">mapping</span><span class="op" id="2193245">[</span><span class="ident" id="2193246">key</span><span class="op" id="2193249">[</span><span class="num" id="2193250">0</span><span class="op" id="2193251">]</span><span class="op" id="2193252">]</span><span class="op" id="2193253">]</span>&nbsp;<span class="op" id="2193255">=</span>&nbsp;<span class="ident" id="2193257">keyNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193268">t</span><span class="op" id="2193269">.</span><span class="ident" id="2193270">prefix</span>&nbsp;<span class="op" id="2193277">=</span>&nbsp;<span class="string" id="2193279">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193285">t</span><span class="op" id="2193286">.</span><span class="ident" id="2193287">next</span>&nbsp;<span class="op" id="2193292">=</span>&nbsp;<span class="ident" id="2193294">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193301">keyNode</span><span class="op" id="2193308">.</span><span class="ident" id="2193309">add</span><span class="op" id="2193312">(</span><span class="ident" id="2193313">key</span><span class="op" id="2193316">[</span><span class="num" id="2193317">1</span><span class="op" id="2193318">:</span><span class="op" id="2193319">]</span><span class="op" id="2193320">,</span>&nbsp;<span class="ident" id="2193322">val</span><span class="op" id="2193325">,</span>&nbsp;<span class="ident" id="2193327">priority</span><span class="op" id="2193335">,</span>&nbsp;<span class="ident" id="2193337">r</span><span class="op" id="2193338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2193342">}</span>&nbsp;<span class="keyword" id="2193344">else</span>&nbsp;<span class="op" id="2193349">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2193354">//&nbsp;Insert&nbsp;new&nbsp;node&nbsp;after&nbsp;the&nbsp;common&nbsp;section&nbsp;of&nbsp;the&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193416">next</span>&nbsp;<span class="op" id="2193421">:=</span>&nbsp;<span class="op" id="2193424">&amp;</span><span class="ident" id="2193425">trieNode</span><span class="op" id="2193433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193439">prefix</span><span class="op" id="2193445">:</span>&nbsp;<span class="ident" id="2193447">t</span><span class="op" id="2193448">.</span><span class="ident" id="2193449">prefix</span><span class="op" id="2193455">[</span><span class="ident" id="2193456">n</span><span class="op" id="2193457">:</span><span class="op" id="2193458">]</span><span class="op" id="2193459">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193465">next</span><span class="op" id="2193469">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2193473">t</span><span class="op" id="2193474">.</span><span class="ident" id="2193475">next</span><span class="op" id="2193479">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2193484">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193489">t</span><span class="op" id="2193490">.</span><span class="ident" id="2193491">prefix</span>&nbsp;<span class="op" id="2193498">=</span>&nbsp;<span class="ident" id="2193500">t</span><span class="op" id="2193501">.</span><span class="ident" id="2193502">prefix</span><span class="op" id="2193508">[</span><span class="op" id="2193509">:</span><span class="ident" id="2193510">n</span><span class="op" id="2193511">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193516">t</span><span class="op" id="2193517">.</span><span class="ident" id="2193518">next</span>&nbsp;<span class="op" id="2193523">=</span>&nbsp;<span class="ident" id="2193525">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193533">next</span><span class="op" id="2193537">.</span><span class="ident" id="2193538">add</span><span class="op" id="2193541">(</span><span class="ident" id="2193542">key</span><span class="op" id="2193545">[</span><span class="ident" id="2193546">n</span><span class="op" id="2193547">:</span><span class="op" id="2193548">]</span><span class="op" id="2193549">,</span>&nbsp;<span class="ident" id="2193551">val</span><span class="op" id="2193554">,</span>&nbsp;<span class="ident" id="2193556">priority</span><span class="op" id="2193564">,</span>&nbsp;<span class="ident" id="2193566">r</span><span class="op" id="2193567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2193571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2193574">}</span>&nbsp;<span class="keyword" id="2193576">else</span>&nbsp;<span class="keyword" id="2193581">if</span>&nbsp;<span class="ident" id="2193584">t</span><span class="op" id="2193585">.</span><span class="ident" id="2193586">table</span>&nbsp;<span class="op" id="2193592">!=</span>&nbsp;<span class="ident" id="2193595">nil</span>&nbsp;<span class="op" id="2193599">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2193603">//&nbsp;Insert&nbsp;into&nbsp;existing&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193636">m</span>&nbsp;<span class="op" id="2193638">:=</span>&nbsp;<span class="ident" id="2193641">r</span><span class="op" id="2193642">.</span><span class="ident" id="2193643">mapping</span><span class="op" id="2193650">[</span><span class="ident" id="2193651">key</span><span class="op" id="2193654">[</span><span class="num" id="2193655">0</span><span class="op" id="2193656">]</span><span class="op" id="2193657">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2193661">if</span>&nbsp;<span class="ident" id="2193664">t</span><span class="op" id="2193665">.</span><span class="ident" id="2193666">table</span><span class="op" id="2193671">[</span><span class="ident" id="2193672">m</span><span class="op" id="2193673">]</span>&nbsp;<span class="op" id="2193675">==</span>&nbsp;<span class="ident" id="2193678">nil</span>&nbsp;<span class="op" id="2193682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193687">t</span><span class="op" id="2193688">.</span><span class="ident" id="2193689">table</span><span class="op" id="2193694">[</span><span class="ident" id="2193695">m</span><span class="op" id="2193696">]</span>&nbsp;<span class="op" id="2193698">=</span>&nbsp;<span class="builtinfunc" id="2193700">new</span><span class="op" id="2193703">(</span><span class="ident" id="2193704">trieNode</span><span class="op" id="2193712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2193716">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193720">t</span><span class="op" id="2193721">.</span><span class="ident" id="2193722">table</span><span class="op" id="2193727">[</span><span class="ident" id="2193728">m</span><span class="op" id="2193729">]</span><span class="op" id="2193730">.</span><span class="ident" id="2193731">add</span><span class="op" id="2193734">(</span><span class="ident" id="2193735">key</span><span class="op" id="2193738">[</span><span class="num" id="2193739">1</span><span class="op" id="2193740">:</span><span class="op" id="2193741">]</span><span class="op" id="2193742">,</span>&nbsp;<span class="ident" id="2193744">val</span><span class="op" id="2193747">,</span>&nbsp;<span class="ident" id="2193749">priority</span><span class="op" id="2193757">,</span>&nbsp;<span class="ident" id="2193759">r</span><span class="op" id="2193760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2193763">}</span>&nbsp;<span class="keyword" id="2193765">else</span>&nbsp;<span class="op" id="2193770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193774">t</span><span class="op" id="2193775">.</span><span class="ident" id="2193776">prefix</span>&nbsp;<span class="op" id="2193783">=</span>&nbsp;<span class="ident" id="2193785">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193791">t</span><span class="op" id="2193792">.</span><span class="ident" id="2193793">next</span>&nbsp;<span class="op" id="2193798">=</span>&nbsp;<span class="builtinfunc" id="2193800">new</span><span class="op" id="2193803">(</span><span class="ident" id="2193804">trieNode</span><span class="op" id="2193812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2193816">t</span><span class="op" id="2193817">.</span><span class="ident" id="2193818">next</span><span class="op" id="2193822">.</span><span class="ident" id="2193823">add</span><span class="op" id="2193826">(</span><span class="string" id="2193827">&#34;&#34;</span><span class="op" id="2193829">,</span>&nbsp;<span class="ident" id="2193831">val</span><span class="op" id="2193834">,</span>&nbsp;<span class="ident" id="2193836">priority</span><span class="op" id="2193844">,</span>&nbsp;<span class="ident" id="2193846">r</span><span class="op" id="2193847">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2193850">}</span><br>
<span class="lineno"></span><span class="op" id="2193852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2193855">func</span>&nbsp;<span class="op" id="2193860">(</span><span class="ident" id="2193861">r</span>&nbsp;<span class="op" id="2193863">*</span><span class="ident" id="2193864">genericReplacer</span><span class="op" id="2193879">)</span>&nbsp;<span class="ident" id="2193881">lookup</span><span class="op" id="2193887">(</span><span class="ident" id="2193888">s</span>&nbsp;<span class="builtintype" id="2193890">string</span><span class="op" id="2193896">,</span>&nbsp;<span class="ident" id="2193898">ignoreRoot</span>&nbsp;<span class="builtintype" id="2193909">bool</span><span class="op" id="2193913">)</span>&nbsp;<span class="op" id="2193915">(</span><span class="ident" id="2193916">val</span>&nbsp;<span class="builtintype" id="2193920">string</span><span class="op" id="2193926">,</span>&nbsp;<span class="ident" id="2193928">keylen</span>&nbsp;<span class="builtintype" id="2193935">int</span><span class="op" id="2193938">,</span>&nbsp;<span class="ident" id="2193940">found</span>&nbsp;<span class="builtintype" id="2193946">bool</span><span class="op" id="2193950">)</span>&nbsp;<span class="op" id="2193952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2193955">//&nbsp;Iterate&nbsp;down&nbsp;the&nbsp;trie&nbsp;to&nbsp;the&nbsp;end,&nbsp;and&nbsp;grab&nbsp;the&nbsp;value&nbsp;and&nbsp;keylen&nbsp;with</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2194028">//&nbsp;the&nbsp;highest&nbsp;priority.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194054">bestPriority</span>&nbsp;<span class="op" id="2194067">:=</span>&nbsp;<span class="num" id="2194070">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194073">node</span>&nbsp;<span class="op" id="2194078">:=</span>&nbsp;<span class="op" id="2194081">&amp;</span><span class="ident" id="2194082">r</span><span class="op" id="2194083">.</span><span class="ident" id="2194084">root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194090">n</span>&nbsp;<span class="op" id="2194092">:=</span>&nbsp;<span class="num" id="2194095">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2194098">for</span>&nbsp;<span class="ident" id="2194102">node</span>&nbsp;<span class="op" id="2194107">!=</span>&nbsp;<span class="ident" id="2194110">nil</span>&nbsp;<span class="op" id="2194114">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2194118">if</span>&nbsp;<span class="ident" id="2194121">node</span><span class="op" id="2194125">.</span><span class="ident" id="2194126">priority</span>&nbsp;<span class="op" id="2194135">&gt;</span>&nbsp;<span class="ident" id="2194137">bestPriority</span>&nbsp;<span class="op" id="2194150">&amp;&amp;</span>&nbsp;<span class="op" id="2194153">!</span><span class="op" id="2194154">(</span><span class="ident" id="2194155">ignoreRoot</span>&nbsp;<span class="op" id="2194166">&amp;&amp;</span>&nbsp;<span class="ident" id="2194169">node</span>&nbsp;<span class="op" id="2194174">==</span>&nbsp;<span class="op" id="2194177">&amp;</span><span class="ident" id="2194178">r</span><span class="op" id="2194179">.</span><span class="ident" id="2194180">root</span><span class="op" id="2194184">)</span>&nbsp;<span class="op" id="2194186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194191">bestPriority</span>&nbsp;<span class="op" id="2194204">=</span>&nbsp;<span class="ident" id="2194206">node</span><span class="op" id="2194210">.</span><span class="ident" id="2194211">priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194223">val</span>&nbsp;<span class="op" id="2194227">=</span>&nbsp;<span class="ident" id="2194229">node</span><span class="op" id="2194233">.</span><span class="ident" id="2194234">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194243">keylen</span>&nbsp;<span class="op" id="2194250">=</span>&nbsp;<span class="ident" id="2194252">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194257">found</span>&nbsp;<span class="op" id="2194263">=</span>&nbsp;<span class="builtintype" id="2194265">true</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2194272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2194277">if</span>&nbsp;<span class="ident" id="2194280">s</span>&nbsp;<span class="op" id="2194282">==</span>&nbsp;<span class="string" id="2194285">&#34;&#34;</span>&nbsp;<span class="op" id="2194288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2194293">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2194301">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2194305">if</span>&nbsp;<span class="ident" id="2194308">node</span><span class="op" id="2194312">.</span><span class="ident" id="2194313">table</span>&nbsp;<span class="op" id="2194319">!=</span>&nbsp;<span class="ident" id="2194322">nil</span>&nbsp;<span class="op" id="2194326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194331">index</span>&nbsp;<span class="op" id="2194337">:=</span>&nbsp;<span class="ident" id="2194340">r</span><span class="op" id="2194341">.</span><span class="ident" id="2194342">mapping</span><span class="op" id="2194349">[</span><span class="ident" id="2194350">s</span><span class="op" id="2194351">[</span><span class="num" id="2194352">0</span><span class="op" id="2194353">]</span><span class="op" id="2194354">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2194359">if</span>&nbsp;<span class="builtintype" id="2194362">int</span><span class="op" id="2194365">(</span><span class="ident" id="2194366">index</span><span class="op" id="2194371">)</span>&nbsp;<span class="op" id="2194373">==</span>&nbsp;<span class="ident" id="2194376">r</span><span class="op" id="2194377">.</span><span class="ident" id="2194378">tableSize</span>&nbsp;<span class="op" id="2194388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2194394">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2194403">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194408">node</span>&nbsp;<span class="op" id="2194413">=</span>&nbsp;<span class="ident" id="2194415">node</span><span class="op" id="2194419">.</span><span class="ident" id="2194420">table</span><span class="op" id="2194425">[</span><span class="ident" id="2194426">index</span><span class="op" id="2194431">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194436">s</span>&nbsp;<span class="op" id="2194438">=</span>&nbsp;<span class="ident" id="2194440">s</span><span class="op" id="2194441">[</span><span class="num" id="2194442">1</span><span class="op" id="2194443">:</span><span class="op" id="2194444">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194449">n</span><span class="op" id="2194450">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2194455">}</span>&nbsp;<span class="keyword" id="2194457">else</span>&nbsp;<span class="keyword" id="2194462">if</span>&nbsp;<span class="ident" id="2194465">node</span><span class="op" id="2194469">.</span><span class="ident" id="2194470">prefix</span>&nbsp;<span class="op" id="2194477">!=</span>&nbsp;<span class="string" id="2194480">&#34;&#34;</span>&nbsp;<span class="op" id="2194483">&amp;&amp;</span>&nbsp;<span class="ident" id="2194486">HasPrefix</span><span class="op" id="2194495">(</span><span class="ident" id="2194496">s</span><span class="op" id="2194497">,</span>&nbsp;<span class="ident" id="2194499">node</span><span class="op" id="2194503">.</span><span class="ident" id="2194504">prefix</span><span class="op" id="2194510">)</span>&nbsp;<span class="op" id="2194512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194517">n</span>&nbsp;<span class="op" id="2194519">+=</span>&nbsp;<span class="builtinfunc" id="2194522">len</span><span class="op" id="2194525">(</span><span class="ident" id="2194526">node</span><span class="op" id="2194530">.</span><span class="ident" id="2194531">prefix</span><span class="op" id="2194537">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194542">s</span>&nbsp;<span class="op" id="2194544">=</span>&nbsp;<span class="ident" id="2194546">s</span><span class="op" id="2194547">[</span><span class="builtinfunc" id="2194548">len</span><span class="op" id="2194551">(</span><span class="ident" id="2194552">node</span><span class="op" id="2194556">.</span><span class="ident" id="2194557">prefix</span><span class="op" id="2194563">)</span><span class="op" id="2194564">:</span><span class="op" id="2194565">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194570">node</span>&nbsp;<span class="op" id="2194575">=</span>&nbsp;<span class="ident" id="2194577">node</span><span class="op" id="2194581">.</span><span class="ident" id="2194582">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2194589">}</span>&nbsp;<span class="keyword" id="2194591">else</span>&nbsp;<span class="op" id="2194596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2194601">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2194609">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2194612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2194615">return</span><br>
<span class="lineno"></span><span class="op" id="2194622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2194625">//&nbsp;genericReplacer&nbsp;is&nbsp;the&nbsp;fully&nbsp;generic&nbsp;algorithm.</span><br>
<span class="lineno">230</span><span class="comment" id="2194676">//&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;fallback&nbsp;when&nbsp;nothing&nbsp;faster&nbsp;can&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="2194736">type</span>&nbsp;<span class="ident" id="2194741">genericReplacer</span>&nbsp;<span class="keyword" id="2194757">struct</span>&nbsp;<span class="op" id="2194764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194767">root</span>&nbsp;<span class="ident" id="2194772">trieNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2194782">//&nbsp;tableSize&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;a&nbsp;trie&nbsp;node&#39;s&nbsp;lookup&nbsp;table.&nbsp;It&nbsp;is&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2194856">//&nbsp;of&nbsp;unique&nbsp;key&nbsp;bytes.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194881">tableSize</span>&nbsp;<span class="builtintype" id="2194891">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2194896">//&nbsp;mapping&nbsp;maps&nbsp;from&nbsp;key&nbsp;bytes&nbsp;to&nbsp;a&nbsp;dense&nbsp;index&nbsp;for&nbsp;trieNode.table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2194965">mapping</span>&nbsp;<span class="op" id="2194973">[</span><span class="num" id="2194974">256</span><span class="op" id="2194977">]</span><span class="builtintype" id="2194978">byte</span><br>
<span class="lineno"></span><span class="op" id="2194983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="2194986">func</span>&nbsp;<span class="ident" id="2194991">makeGenericReplacer</span><span class="op" id="2195010">(</span><span class="ident" id="2195011">oldnew</span>&nbsp;<span class="op" id="2195018">[</span><span class="op" id="2195019">]</span><span class="builtintype" id="2195020">string</span><span class="op" id="2195026">)</span>&nbsp;<span class="op" id="2195028">*</span><span class="ident" id="2195029">genericReplacer</span>&nbsp;<span class="op" id="2195045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2195048">r</span>&nbsp;<span class="op" id="2195050">:=</span>&nbsp;<span class="builtinfunc" id="2195053">new</span><span class="op" id="2195056">(</span><span class="ident" id="2195057">genericReplacer</span><span class="op" id="2195072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2195075">//&nbsp;Find&nbsp;each&nbsp;byte&nbsp;used,&nbsp;then&nbsp;assign&nbsp;them&nbsp;each&nbsp;an&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2195132">for</span>&nbsp;<span class="ident" id="2195136">i</span>&nbsp;<span class="op" id="2195138">:=</span>&nbsp;<span class="num" id="2195141">0</span><span class="op" id="2195142">;</span>&nbsp;<span class="ident" id="2195144">i</span>&nbsp;<span class="op" id="2195146">&lt;</span>&nbsp;<span class="builtinfunc" id="2195148">len</span><span class="op" id="2195151">(</span><span class="ident" id="2195152">oldnew</span><span class="op" id="2195158">)</span><span class="op" id="2195159">;</span>&nbsp;<span class="ident" id="2195161">i</span>&nbsp;<span class="op" id="2195163">+=</span>&nbsp;<span class="num" id="2195166">2</span>&nbsp;<span class="op" id="2195168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2195172">key</span>&nbsp;<span class="op" id="2195176">:=</span>&nbsp;<span class="ident" id="2195179">oldnew</span><span class="op" id="2195185">[</span><span class="ident" id="2195186">i</span><span class="op" id="2195187">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2195191">for</span>&nbsp;<span class="ident" id="2195195">j</span>&nbsp;<span class="op" id="2195197">:=</span>&nbsp;<span class="num" id="2195200">0</span><span class="op" id="2195201">;</span>&nbsp;<span class="ident" id="2195203">j</span>&nbsp;<span class="op" id="2195205">&lt;</span>&nbsp;<span class="builtinfunc" id="2195207">len</span><span class="op" id="2195210">(</span><span class="ident" id="2195211">key</span><span class="op" id="2195214">)</span><span class="op" id="2195215">;</span>&nbsp;<span class="ident" id="2195217">j</span><span class="op" id="2195218">++</span>&nbsp;<span class="op" id="2195221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2195226">r</span><span class="op" id="2195227">.</span><span class="ident" id="2195228">mapping</span><span class="op" id="2195235">[</span><span class="ident" id="2195236">key</span><span class="op" id="2195239">[</span><span class="ident" id="2195240">j</span><span class="op" id="2195241">]</span><span class="op" id="2195242">]</span>&nbsp;<span class="op" id="2195244">=</span>&nbsp;<span class="num" id="2195246">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2195250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2195253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2195257">for</span>&nbsp;<span class="ident" id="2195261">_</span><span class="op" id="2195262">,</span>&nbsp;<span class="ident" id="2195264">b</span>&nbsp;<span class="op" id="2195266">:=</span>&nbsp;<span class="keyword" id="2195269">range</span>&nbsp;<span class="ident" id="2195275">r</span><span class="op" id="2195276">.</span><span class="ident" id="2195277">mapping</span>&nbsp;<span class="op" id="2195285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2195289">r</span><span class="op" id="2195290">.</span><span class="ident" id="2195291">tableSize</span>&nbsp;<span class="op" id="2195301">+=</span>&nbsp;<span class="builtintype" id="2195304">int</span><span class="op" id="2195307">(</span><span class="ident" id="2195308">b</span><span class="op" id="2195309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2195312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2195316">var</span>&nbsp;<span class="ident" id="2195320">index</span>&nbsp;<span class="builtintype" id="2195326">byte</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2195332">for</span>&nbsp;<span class="ident" id="2195336">i</span><span class="op" id="2195337">,</span>&nbsp;<span class="ident" id="2195339">b</span>&nbsp;<span class="op" id="2195341">:=</span>&nbsp;<span class="keyword" id="2195344">range</span>&nbsp;<span class="ident" id="2195350">r</span><span class="op" id="2195351">.</span><span class="ident" id="2195352">mapping</span>&nbsp;<span class="op" id="2195360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2195364">if</span>&nbsp;<span class="ident" id="2195367">b</span>&nbsp;<span class="op" id="2195369">==</span>&nbsp;<span class="num" id="2195372">0</span>&nbsp;<span class="op" id="2195374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2195379">r</span><span class="op" id="2195380">.</span><span class="ident" id="2195381">mapping</span><span class="op" id="2195388">[</span><span class="ident" id="2195389">i</span><span class="op" id="2195390">]</span>&nbsp;<span class="op" id="2195392">=</span>&nbsp;<span class="builtintype" id="2195394">byte</span><span class="op" id="2195398">(</span><span class="ident" id="2195399">r</span><span class="op" id="2195400">.</span><span class="ident" id="2195401">tableSize</span><span class="op" id="2195410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2195414">}</span>&nbsp;<span class="keyword" id="2195416">else</span>&nbsp;<span class="op" id="2195421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2195426">r</span><span class="op" id="2195427">.</span><span class="ident" id="2195428">mapping</span><span class="op" id="2195435">[</span><span class="ident" id="2195436">i</span><span class="op" id="2195437">]</span>&nbsp;<span class="op" id="2195439">=</span>&nbsp;<span class="ident" id="2195441">index</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2195450">index</span><span class="op" id="2195455">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2195460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2195463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2195466">//&nbsp;Ensure&nbsp;root&nbsp;node&nbsp;uses&nbsp;a&nbsp;lookup&nbsp;table&nbsp;(for&nbsp;performance).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2195526">r</span><span class="op" id="2195527">.</span><span class="ident" id="2195528">root</span><span class="op" id="2195532">.</span><span class="ident" id="2195533">table</span>&nbsp;<span class="op" id="2195539">=</span>&nbsp;<span class="builtinfunc" id="2195541">make</span><span class="op" id="2195545">(</span><span class="op" id="2195546">[</span><span class="op" id="2195547">]</span><span class="op" id="2195548">*</span><span class="ident" id="2195549">trieNode</span><span class="op" id="2195557">,</span>&nbsp;<span class="ident" id="2195559">r</span><span class="op" id="2195560">.</span><span class="ident" id="2195561">tableSize</span><span class="op" id="2195570">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2195574">for</span>&nbsp;<span class="ident" id="2195578">i</span>&nbsp;<span class="op" id="2195580">:=</span>&nbsp;<span class="num" id="2195583">0</span><span class="op" id="2195584">;</span>&nbsp;<span class="ident" id="2195586">i</span>&nbsp;<span class="op" id="2195588">&lt;</span>&nbsp;<span class="builtinfunc" id="2195590">len</span><span class="op" id="2195593">(</span><span class="ident" id="2195594">oldnew</span><span class="op" id="2195600">)</span><span class="op" id="2195601">;</span>&nbsp;<span class="ident" id="2195603">i</span>&nbsp;<span class="op" id="2195605">+=</span>&nbsp;<span class="num" id="2195608">2</span>&nbsp;<span class="op" id="2195610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2195614">r</span><span class="op" id="2195615">.</span><span class="ident" id="2195616">root</span><span class="op" id="2195620">.</span><span class="ident" id="2195621">add</span><span class="op" id="2195624">(</span><span class="ident" id="2195625">oldnew</span><span class="op" id="2195631">[</span><span class="ident" id="2195632">i</span><span class="op" id="2195633">]</span><span class="op" id="2195634">,</span>&nbsp;<span class="ident" id="2195636">oldnew</span><span class="op" id="2195642">[</span><span class="ident" id="2195643">i</span><span class="op" id="2195644">+</span><span class="num" id="2195645">1</span><span class="op" id="2195646">]</span><span class="op" id="2195647">,</span>&nbsp;<span class="builtinfunc" id="2195649">len</span><span class="op" id="2195652">(</span><span class="ident" id="2195653">oldnew</span><span class="op" id="2195659">)</span><span class="op" id="2195660">-</span><span class="ident" id="2195661">i</span><span class="op" id="2195662">,</span>&nbsp;<span class="ident" id="2195664">r</span><span class="op" id="2195665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2195668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2195671">return</span>&nbsp;<span class="ident" id="2195678">r</span><br>
<span class="lineno">270</span><span class="op" id="2195680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2195683">type</span>&nbsp;<span class="ident" id="2195688">appendSliceWriter</span>&nbsp;<span class="op" id="2195706">[</span><span class="op" id="2195707">]</span><span class="builtintype" id="2195708">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2195714">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;to&nbsp;satisfy&nbsp;io.Writer.</span><br>
<span class="lineno">275</span><span class="keyword" id="2195766">func</span>&nbsp;<span class="op" id="2195771">(</span><span class="ident" id="2195772">w</span>&nbsp;<span class="op" id="2195774">*</span><span class="ident" id="2195775">appendSliceWriter</span><span class="op" id="2195792">)</span>&nbsp;<span class="ident" id="2195794">Write</span><span class="op" id="2195799">(</span><span class="ident" id="2195800">p</span>&nbsp;<span class="op" id="2195802">[</span><span class="op" id="2195803">]</span><span class="builtintype" id="2195804">byte</span><span class="op" id="2195808">)</span>&nbsp;<span class="op" id="2195810">(</span><span class="builtintype" id="2195811">int</span><span class="op" id="2195814">,</span>&nbsp;<span class="builtintype" id="2195816">error</span><span class="op" id="2195821">)</span>&nbsp;<span class="op" id="2195823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2195826">*</span><span class="ident" id="2195827">w</span>&nbsp;<span class="op" id="2195829">=</span>&nbsp;<span class="builtinfunc" id="2195831">append</span><span class="op" id="2195837">(</span><span class="op" id="2195838">*</span><span class="ident" id="2195839">w</span><span class="op" id="2195840">,</span>&nbsp;<span class="ident" id="2195842">p</span><span class="op" id="2195843">...</span><span class="op" id="2195846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2195849">return</span>&nbsp;<span class="builtinfunc" id="2195856">len</span><span class="op" id="2195859">(</span><span class="ident" id="2195860">p</span><span class="op" id="2195861">)</span><span class="op" id="2195862">,</span>&nbsp;<span class="ident" id="2195864">nil</span><br>
<span class="lineno"></span><span class="op" id="2195868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="2195871">//&nbsp;WriteString&nbsp;writes&nbsp;to&nbsp;the&nbsp;buffer&nbsp;without&nbsp;string-&gt;[]byte-&gt;string&nbsp;allocations.</span><br>
<span class="lineno"></span><span class="keyword" id="2195951">func</span>&nbsp;<span class="op" id="2195956">(</span><span class="ident" id="2195957">w</span>&nbsp;<span class="op" id="2195959">*</span><span class="ident" id="2195960">appendSliceWriter</span><span class="op" id="2195977">)</span>&nbsp;<span class="ident" id="2195979">WriteString</span><span class="op" id="2195990">(</span><span class="ident" id="2195991">s</span>&nbsp;<span class="builtintype" id="2195993">string</span><span class="op" id="2195999">)</span>&nbsp;<span class="op" id="2196001">(</span><span class="builtintype" id="2196002">int</span><span class="op" id="2196005">,</span>&nbsp;<span class="builtintype" id="2196007">error</span><span class="op" id="2196012">)</span>&nbsp;<span class="op" id="2196014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2196017">*</span><span class="ident" id="2196018">w</span>&nbsp;<span class="op" id="2196020">=</span>&nbsp;<span class="builtinfunc" id="2196022">append</span><span class="op" id="2196028">(</span><span class="op" id="2196029">*</span><span class="ident" id="2196030">w</span><span class="op" id="2196031">,</span>&nbsp;<span class="ident" id="2196033">s</span><span class="op" id="2196034">...</span><span class="op" id="2196037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2196040">return</span>&nbsp;<span class="builtinfunc" id="2196047">len</span><span class="op" id="2196050">(</span><span class="ident" id="2196051">s</span><span class="op" id="2196052">)</span><span class="op" id="2196053">,</span>&nbsp;<span class="ident" id="2196055">nil</span><br>
<span class="lineno"></span><span class="op" id="2196059">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="2196062">type</span>&nbsp;<span class="ident" id="2196067">stringWriterIface</span>&nbsp;<span class="keyword" id="2196085">interface</span>&nbsp;<span class="op" id="2196095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196098">WriteString</span><span class="op" id="2196109">(</span><span class="builtintype" id="2196110">string</span><span class="op" id="2196116">)</span>&nbsp;<span class="op" id="2196118">(</span><span class="builtintype" id="2196119">int</span><span class="op" id="2196122">,</span>&nbsp;<span class="builtintype" id="2196124">error</span><span class="op" id="2196129">)</span><br>
<span class="lineno"></span><span class="op" id="2196131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="2196134">type</span>&nbsp;<span class="ident" id="2196139">stringWriter</span>&nbsp;<span class="keyword" id="2196152">struct</span>&nbsp;<span class="op" id="2196159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196162">w</span>&nbsp;<span class="ident" id="2196164">io</span><span class="op" id="2196166">.</span><span class="ident" id="2196167">Writer</span><br>
<span class="lineno"></span><span class="op" id="2196174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2196177">func</span>&nbsp;<span class="op" id="2196182">(</span><span class="ident" id="2196183">w</span>&nbsp;<span class="ident" id="2196185">stringWriter</span><span class="op" id="2196197">)</span>&nbsp;<span class="ident" id="2196199">WriteString</span><span class="op" id="2196210">(</span><span class="ident" id="2196211">s</span>&nbsp;<span class="builtintype" id="2196213">string</span><span class="op" id="2196219">)</span>&nbsp;<span class="op" id="2196221">(</span><span class="builtintype" id="2196222">int</span><span class="op" id="2196225">,</span>&nbsp;<span class="builtintype" id="2196227">error</span><span class="op" id="2196232">)</span>&nbsp;<span class="op" id="2196234">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2196237">return</span>&nbsp;<span class="ident" id="2196244">w</span><span class="op" id="2196245">.</span><span class="ident" id="2196246">w</span><span class="op" id="2196247">.</span><span class="ident" id="2196248">Write</span><span class="op" id="2196253">(</span><span class="op" id="2196254">[</span><span class="op" id="2196255">]</span><span class="builtintype" id="2196256">byte</span><span class="op" id="2196260">(</span><span class="ident" id="2196261">s</span><span class="op" id="2196262">)</span><span class="op" id="2196263">)</span><br>
<span class="lineno"></span><span class="op" id="2196265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2196268">func</span>&nbsp;<span class="ident" id="2196273">getStringWriter</span><span class="op" id="2196288">(</span><span class="ident" id="2196289">w</span>&nbsp;<span class="ident" id="2196291">io</span><span class="op" id="2196293">.</span><span class="ident" id="2196294">Writer</span><span class="op" id="2196300">)</span>&nbsp;<span class="ident" id="2196302">stringWriterIface</span>&nbsp;<span class="op" id="2196320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196323">sw</span><span class="op" id="2196325">,</span>&nbsp;<span class="ident" id="2196327">ok</span>&nbsp;<span class="op" id="2196330">:=</span>&nbsp;<span class="ident" id="2196333">w</span><span class="op" id="2196334">.</span><span class="op" id="2196335">(</span><span class="ident" id="2196336">stringWriterIface</span><span class="op" id="2196353">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2196356">if</span>&nbsp;<span class="op" id="2196359">!</span><span class="ident" id="2196360">ok</span>&nbsp;<span class="op" id="2196363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196367">sw</span>&nbsp;<span class="op" id="2196370">=</span>&nbsp;<span class="ident" id="2196372">stringWriter</span><span class="op" id="2196384">{</span><span class="ident" id="2196385">w</span><span class="op" id="2196386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2196389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2196392">return</span>&nbsp;<span class="ident" id="2196399">sw</span><br>
<span class="lineno"></span><span class="op" id="2196402">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="2196405">func</span>&nbsp;<span class="op" id="2196410">(</span><span class="ident" id="2196411">r</span>&nbsp;<span class="op" id="2196413">*</span><span class="ident" id="2196414">genericReplacer</span><span class="op" id="2196429">)</span>&nbsp;<span class="ident" id="2196431">Replace</span><span class="op" id="2196438">(</span><span class="ident" id="2196439">s</span>&nbsp;<span class="builtintype" id="2196441">string</span><span class="op" id="2196447">)</span>&nbsp;<span class="builtintype" id="2196449">string</span>&nbsp;<span class="op" id="2196456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196459">buf</span>&nbsp;<span class="op" id="2196463">:=</span>&nbsp;<span class="builtinfunc" id="2196466">make</span><span class="op" id="2196470">(</span><span class="ident" id="2196471">appendSliceWriter</span><span class="op" id="2196488">,</span>&nbsp;<span class="num" id="2196490">0</span><span class="op" id="2196491">,</span>&nbsp;<span class="builtinfunc" id="2196493">len</span><span class="op" id="2196496">(</span><span class="ident" id="2196497">s</span><span class="op" id="2196498">)</span><span class="op" id="2196499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196502">r</span><span class="op" id="2196503">.</span><span class="ident" id="2196504">WriteString</span><span class="op" id="2196515">(</span><span class="op" id="2196516">&amp;</span><span class="ident" id="2196517">buf</span><span class="op" id="2196520">,</span>&nbsp;<span class="ident" id="2196522">s</span><span class="op" id="2196523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2196526">return</span>&nbsp;<span class="builtintype" id="2196533">string</span><span class="op" id="2196539">(</span><span class="ident" id="2196540">buf</span><span class="op" id="2196543">)</span><br>
<span class="lineno">310</span><span class="op" id="2196545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2196548">func</span>&nbsp;<span class="op" id="2196553">(</span><span class="ident" id="2196554">r</span>&nbsp;<span class="op" id="2196556">*</span><span class="ident" id="2196557">genericReplacer</span><span class="op" id="2196572">)</span>&nbsp;<span class="ident" id="2196574">WriteString</span><span class="op" id="2196585">(</span><span class="ident" id="2196586">w</span>&nbsp;<span class="ident" id="2196588">io</span><span class="op" id="2196590">.</span><span class="ident" id="2196591">Writer</span><span class="op" id="2196597">,</span>&nbsp;<span class="ident" id="2196599">s</span>&nbsp;<span class="builtintype" id="2196601">string</span><span class="op" id="2196607">)</span>&nbsp;<span class="op" id="2196609">(</span><span class="ident" id="2196610">n</span>&nbsp;<span class="builtintype" id="2196612">int</span><span class="op" id="2196615">,</span>&nbsp;<span class="ident" id="2196617">err</span>&nbsp;<span class="builtintype" id="2196621">error</span><span class="op" id="2196626">)</span>&nbsp;<span class="op" id="2196628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196631">sw</span>&nbsp;<span class="op" id="2196634">:=</span>&nbsp;<span class="ident" id="2196637">getStringWriter</span><span class="op" id="2196652">(</span><span class="ident" id="2196653">w</span><span class="op" id="2196654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2196657">var</span>&nbsp;<span class="ident" id="2196661">last</span><span class="op" id="2196665">,</span>&nbsp;<span class="ident" id="2196667">wn</span>&nbsp;<span class="builtintype" id="2196670">int</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2196675">var</span>&nbsp;<span class="ident" id="2196679">prevMatchEmpty</span>&nbsp;<span class="builtintype" id="2196694">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2196700">for</span>&nbsp;<span class="ident" id="2196704">i</span>&nbsp;<span class="op" id="2196706">:=</span>&nbsp;<span class="num" id="2196709">0</span><span class="op" id="2196710">;</span>&nbsp;<span class="ident" id="2196712">i</span>&nbsp;<span class="op" id="2196714">&lt;=</span>&nbsp;<span class="builtinfunc" id="2196717">len</span><span class="op" id="2196720">(</span><span class="ident" id="2196721">s</span><span class="op" id="2196722">)</span><span class="op" id="2196723">;</span>&nbsp;<span class="op" id="2196725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2196729">//&nbsp;Fast&nbsp;path:&nbsp;s[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;prefix&nbsp;of&nbsp;any&nbsp;pattern.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2196782">if</span>&nbsp;<span class="ident" id="2196785">i</span>&nbsp;<span class="op" id="2196787">!=</span>&nbsp;<span class="builtinfunc" id="2196790">len</span><span class="op" id="2196793">(</span><span class="ident" id="2196794">s</span><span class="op" id="2196795">)</span>&nbsp;<span class="op" id="2196797">&amp;&amp;</span>&nbsp;<span class="ident" id="2196800">r</span><span class="op" id="2196801">.</span><span class="ident" id="2196802">root</span><span class="op" id="2196806">.</span><span class="ident" id="2196807">priority</span>&nbsp;<span class="op" id="2196816">==</span>&nbsp;<span class="num" id="2196819">0</span>&nbsp;<span class="op" id="2196821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196826">index</span>&nbsp;<span class="op" id="2196832">:=</span>&nbsp;<span class="builtintype" id="2196835">int</span><span class="op" id="2196838">(</span><span class="ident" id="2196839">r</span><span class="op" id="2196840">.</span><span class="ident" id="2196841">mapping</span><span class="op" id="2196848">[</span><span class="ident" id="2196849">s</span><span class="op" id="2196850">[</span><span class="ident" id="2196851">i</span><span class="op" id="2196852">]</span><span class="op" id="2196853">]</span><span class="op" id="2196854">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2196859">if</span>&nbsp;<span class="ident" id="2196862">index</span>&nbsp;<span class="op" id="2196868">==</span>&nbsp;<span class="ident" id="2196871">r</span><span class="op" id="2196872">.</span><span class="ident" id="2196873">tableSize</span>&nbsp;<span class="op" id="2196883">||</span>&nbsp;<span class="ident" id="2196886">r</span><span class="op" id="2196887">.</span><span class="ident" id="2196888">root</span><span class="op" id="2196892">.</span><span class="ident" id="2196893">table</span><span class="op" id="2196898">[</span><span class="ident" id="2196899">index</span><span class="op" id="2196904">]</span>&nbsp;<span class="op" id="2196906">==</span>&nbsp;<span class="ident" id="2196909">nil</span>&nbsp;<span class="op" id="2196913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2196919">i</span><span class="op" id="2196920">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2196927">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2196939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2196943">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2196948">//&nbsp;Ignore&nbsp;the&nbsp;empty&nbsp;match&nbsp;iff&nbsp;the&nbsp;previous&nbsp;loop&nbsp;found&nbsp;the&nbsp;empty&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197021">val</span><span class="op" id="2197024">,</span>&nbsp;<span class="ident" id="2197026">keylen</span><span class="op" id="2197032">,</span>&nbsp;<span class="ident" id="2197034">match</span>&nbsp;<span class="op" id="2197040">:=</span>&nbsp;<span class="ident" id="2197043">r</span><span class="op" id="2197044">.</span><span class="ident" id="2197045">lookup</span><span class="op" id="2197051">(</span><span class="ident" id="2197052">s</span><span class="op" id="2197053">[</span><span class="ident" id="2197054">i</span><span class="op" id="2197055">:</span><span class="op" id="2197056">]</span><span class="op" id="2197057">,</span>&nbsp;<span class="ident" id="2197059">prevMatchEmpty</span><span class="op" id="2197073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197077">prevMatchEmpty</span>&nbsp;<span class="op" id="2197092">=</span>&nbsp;<span class="ident" id="2197094">match</span>&nbsp;<span class="op" id="2197100">&amp;&amp;</span>&nbsp;<span class="ident" id="2197103">keylen</span>&nbsp;<span class="op" id="2197110">==</span>&nbsp;<span class="num" id="2197113">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2197117">if</span>&nbsp;<span class="ident" id="2197120">match</span>&nbsp;<span class="op" id="2197126">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197131">wn</span><span class="op" id="2197133">,</span>&nbsp;<span class="ident" id="2197135">err</span>&nbsp;<span class="op" id="2197139">=</span>&nbsp;<span class="ident" id="2197141">sw</span><span class="op" id="2197143">.</span><span class="ident" id="2197144">WriteString</span><span class="op" id="2197155">(</span><span class="ident" id="2197156">s</span><span class="op" id="2197157">[</span><span class="ident" id="2197158">last</span><span class="op" id="2197162">:</span><span class="ident" id="2197163">i</span><span class="op" id="2197164">]</span><span class="op" id="2197165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197170">n</span>&nbsp;<span class="op" id="2197172">+=</span>&nbsp;<span class="ident" id="2197175">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2197181">if</span>&nbsp;<span class="ident" id="2197184">err</span>&nbsp;<span class="op" id="2197188">!=</span>&nbsp;<span class="ident" id="2197191">nil</span>&nbsp;<span class="op" id="2197195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2197201">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2197211">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197216">wn</span><span class="op" id="2197218">,</span>&nbsp;<span class="ident" id="2197220">err</span>&nbsp;<span class="op" id="2197224">=</span>&nbsp;<span class="ident" id="2197226">sw</span><span class="op" id="2197228">.</span><span class="ident" id="2197229">WriteString</span><span class="op" id="2197240">(</span><span class="ident" id="2197241">val</span><span class="op" id="2197244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197249">n</span>&nbsp;<span class="op" id="2197251">+=</span>&nbsp;<span class="ident" id="2197254">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2197260">if</span>&nbsp;<span class="ident" id="2197263">err</span>&nbsp;<span class="op" id="2197267">!=</span>&nbsp;<span class="ident" id="2197270">nil</span>&nbsp;<span class="op" id="2197274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2197280">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2197290">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197295">i</span>&nbsp;<span class="op" id="2197297">+=</span>&nbsp;<span class="ident" id="2197300">keylen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197310">last</span>&nbsp;<span class="op" id="2197315">=</span>&nbsp;<span class="ident" id="2197317">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2197322">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2197333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197337">i</span><span class="op" id="2197338">++</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2197342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2197345">if</span>&nbsp;<span class="ident" id="2197348">last</span>&nbsp;<span class="op" id="2197353">!=</span>&nbsp;<span class="builtinfunc" id="2197356">len</span><span class="op" id="2197359">(</span><span class="ident" id="2197360">s</span><span class="op" id="2197361">)</span>&nbsp;<span class="op" id="2197363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197367">wn</span><span class="op" id="2197369">,</span>&nbsp;<span class="ident" id="2197371">err</span>&nbsp;<span class="op" id="2197375">=</span>&nbsp;<span class="ident" id="2197377">sw</span><span class="op" id="2197379">.</span><span class="ident" id="2197380">WriteString</span><span class="op" id="2197391">(</span><span class="ident" id="2197392">s</span><span class="op" id="2197393">[</span><span class="ident" id="2197394">last</span><span class="op" id="2197398">:</span><span class="op" id="2197399">]</span><span class="op" id="2197400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197404">n</span>&nbsp;<span class="op" id="2197406">+=</span>&nbsp;<span class="ident" id="2197409">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2197413">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2197416">return</span><br>
<span class="lineno"></span><span class="op" id="2197423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2197426">//&nbsp;singleStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;there&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="2197503">//&nbsp;one&nbsp;string&nbsp;to&nbsp;replace&nbsp;(and&nbsp;that&nbsp;string&nbsp;has&nbsp;more&nbsp;than&nbsp;one&nbsp;byte).</span><br>
<span class="lineno">355</span><span class="keyword" id="2197570">type</span>&nbsp;<span class="ident" id="2197575">singleStringReplacer</span>&nbsp;<span class="keyword" id="2197596">struct</span>&nbsp;<span class="op" id="2197603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197606">finder</span>&nbsp;<span class="op" id="2197613">*</span><span class="ident" id="2197614">stringFinder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2197628">//&nbsp;value&nbsp;is&nbsp;the&nbsp;new&nbsp;string&nbsp;that&nbsp;replaces&nbsp;that&nbsp;pattern&nbsp;when&nbsp;it&#39;s&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197700">value</span>&nbsp;<span class="builtintype" id="2197706">string</span><br>
<span class="lineno"></span><span class="op" id="2197713">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="2197716">func</span>&nbsp;<span class="ident" id="2197721">makeSingleStringReplacer</span><span class="op" id="2197745">(</span><span class="ident" id="2197746">pattern</span>&nbsp;<span class="builtintype" id="2197754">string</span><span class="op" id="2197760">,</span>&nbsp;<span class="ident" id="2197762">value</span>&nbsp;<span class="builtintype" id="2197768">string</span><span class="op" id="2197774">)</span>&nbsp;<span class="op" id="2197776">*</span><span class="ident" id="2197777">singleStringReplacer</span>&nbsp;<span class="op" id="2197798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2197801">return</span>&nbsp;<span class="op" id="2197808">&amp;</span><span class="ident" id="2197809">singleStringReplacer</span><span class="op" id="2197829">{</span><span class="ident" id="2197830">finder</span><span class="op" id="2197836">:</span>&nbsp;<span class="ident" id="2197838">makeStringFinder</span><span class="op" id="2197854">(</span><span class="ident" id="2197855">pattern</span><span class="op" id="2197862">)</span><span class="op" id="2197863">,</span>&nbsp;<span class="ident" id="2197865">value</span><span class="op" id="2197870">:</span>&nbsp;<span class="ident" id="2197872">value</span><span class="op" id="2197877">}</span><br>
<span class="lineno"></span><span class="op" id="2197879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="keyword" id="2197882">func</span>&nbsp;<span class="op" id="2197887">(</span><span class="ident" id="2197888">r</span>&nbsp;<span class="op" id="2197890">*</span><span class="ident" id="2197891">singleStringReplacer</span><span class="op" id="2197911">)</span>&nbsp;<span class="ident" id="2197913">Replace</span><span class="op" id="2197920">(</span><span class="ident" id="2197921">s</span>&nbsp;<span class="builtintype" id="2197923">string</span><span class="op" id="2197929">)</span>&nbsp;<span class="builtintype" id="2197931">string</span>&nbsp;<span class="op" id="2197938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2197941">var</span>&nbsp;<span class="ident" id="2197945">buf</span>&nbsp;<span class="op" id="2197949">[</span><span class="op" id="2197950">]</span><span class="builtintype" id="2197951">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197957">i</span><span class="op" id="2197958">,</span>&nbsp;<span class="ident" id="2197960">matched</span>&nbsp;<span class="op" id="2197968">:=</span>&nbsp;<span class="num" id="2197971">0</span><span class="op" id="2197972">,</span>&nbsp;<span class="builtintype" id="2197974">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2197981">for</span>&nbsp;<span class="op" id="2197985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2197989">match</span>&nbsp;<span class="op" id="2197995">:=</span>&nbsp;<span class="ident" id="2197998">r</span><span class="op" id="2197999">.</span><span class="ident" id="2198000">finder</span><span class="op" id="2198006">.</span><span class="ident" id="2198007">next</span><span class="op" id="2198011">(</span><span class="ident" id="2198012">s</span><span class="op" id="2198013">[</span><span class="ident" id="2198014">i</span><span class="op" id="2198015">:</span><span class="op" id="2198016">]</span><span class="op" id="2198017">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198021">if</span>&nbsp;<span class="ident" id="2198024">match</span>&nbsp;<span class="op" id="2198030">==</span>&nbsp;<span class="op" id="2198033">-</span><span class="num" id="2198034">1</span>&nbsp;<span class="op" id="2198036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198041">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2198049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198053">matched</span>&nbsp;<span class="op" id="2198061">=</span>&nbsp;<span class="builtintype" id="2198063">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198070">buf</span>&nbsp;<span class="op" id="2198074">=</span>&nbsp;<span class="builtinfunc" id="2198076">append</span><span class="op" id="2198082">(</span><span class="ident" id="2198083">buf</span><span class="op" id="2198086">,</span>&nbsp;<span class="ident" id="2198088">s</span><span class="op" id="2198089">[</span><span class="ident" id="2198090">i</span><span class="op" id="2198091">:</span><span class="ident" id="2198092">i</span><span class="op" id="2198093">+</span><span class="ident" id="2198094">match</span><span class="op" id="2198099">]</span><span class="op" id="2198100">...</span><span class="op" id="2198103">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198107">buf</span>&nbsp;<span class="op" id="2198111">=</span>&nbsp;<span class="builtinfunc" id="2198113">append</span><span class="op" id="2198119">(</span><span class="ident" id="2198120">buf</span><span class="op" id="2198123">,</span>&nbsp;<span class="ident" id="2198125">r</span><span class="op" id="2198126">.</span><span class="ident" id="2198127">value</span><span class="op" id="2198132">...</span><span class="op" id="2198135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198139">i</span>&nbsp;<span class="op" id="2198141">+=</span>&nbsp;<span class="ident" id="2198144">match</span>&nbsp;<span class="op" id="2198150">+</span>&nbsp;<span class="builtinfunc" id="2198152">len</span><span class="op" id="2198155">(</span><span class="ident" id="2198156">r</span><span class="op" id="2198157">.</span><span class="ident" id="2198158">finder</span><span class="op" id="2198164">.</span><span class="ident" id="2198165">pattern</span><span class="op" id="2198172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2198175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198178">if</span>&nbsp;<span class="op" id="2198181">!</span><span class="ident" id="2198182">matched</span>&nbsp;<span class="op" id="2198190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198194">return</span>&nbsp;<span class="ident" id="2198201">s</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2198204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198207">buf</span>&nbsp;<span class="op" id="2198211">=</span>&nbsp;<span class="builtinfunc" id="2198213">append</span><span class="op" id="2198219">(</span><span class="ident" id="2198220">buf</span><span class="op" id="2198223">,</span>&nbsp;<span class="ident" id="2198225">s</span><span class="op" id="2198226">[</span><span class="ident" id="2198227">i</span><span class="op" id="2198228">:</span><span class="op" id="2198229">]</span><span class="op" id="2198230">...</span><span class="op" id="2198233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198236">return</span>&nbsp;<span class="builtintype" id="2198243">string</span><span class="op" id="2198249">(</span><span class="ident" id="2198250">buf</span><span class="op" id="2198253">)</span><br>
<span class="lineno"></span><span class="op" id="2198255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="2198258">func</span>&nbsp;<span class="op" id="2198263">(</span><span class="ident" id="2198264">r</span>&nbsp;<span class="op" id="2198266">*</span><span class="ident" id="2198267">singleStringReplacer</span><span class="op" id="2198287">)</span>&nbsp;<span class="ident" id="2198289">WriteString</span><span class="op" id="2198300">(</span><span class="ident" id="2198301">w</span>&nbsp;<span class="ident" id="2198303">io</span><span class="op" id="2198305">.</span><span class="ident" id="2198306">Writer</span><span class="op" id="2198312">,</span>&nbsp;<span class="ident" id="2198314">s</span>&nbsp;<span class="builtintype" id="2198316">string</span><span class="op" id="2198322">)</span>&nbsp;<span class="op" id="2198324">(</span><span class="ident" id="2198325">n</span>&nbsp;<span class="builtintype" id="2198327">int</span><span class="op" id="2198330">,</span>&nbsp;<span class="ident" id="2198332">err</span>&nbsp;<span class="builtintype" id="2198336">error</span><span class="op" id="2198341">)</span>&nbsp;<span class="op" id="2198343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198346">sw</span>&nbsp;<span class="op" id="2198349">:=</span>&nbsp;<span class="ident" id="2198352">getStringWriter</span><span class="op" id="2198367">(</span><span class="ident" id="2198368">w</span><span class="op" id="2198369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198372">var</span>&nbsp;<span class="ident" id="2198376">i</span><span class="op" id="2198377">,</span>&nbsp;<span class="ident" id="2198379">wn</span>&nbsp;<span class="builtintype" id="2198382">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198387">for</span>&nbsp;<span class="op" id="2198391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198395">match</span>&nbsp;<span class="op" id="2198401">:=</span>&nbsp;<span class="ident" id="2198404">r</span><span class="op" id="2198405">.</span><span class="ident" id="2198406">finder</span><span class="op" id="2198412">.</span><span class="ident" id="2198413">next</span><span class="op" id="2198417">(</span><span class="ident" id="2198418">s</span><span class="op" id="2198419">[</span><span class="ident" id="2198420">i</span><span class="op" id="2198421">:</span><span class="op" id="2198422">]</span><span class="op" id="2198423">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198427">if</span>&nbsp;<span class="ident" id="2198430">match</span>&nbsp;<span class="op" id="2198436">==</span>&nbsp;<span class="op" id="2198439">-</span><span class="num" id="2198440">1</span>&nbsp;<span class="op" id="2198442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198447">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2198455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198459">wn</span><span class="op" id="2198461">,</span>&nbsp;<span class="ident" id="2198463">err</span>&nbsp;<span class="op" id="2198467">=</span>&nbsp;<span class="ident" id="2198469">sw</span><span class="op" id="2198471">.</span><span class="ident" id="2198472">WriteString</span><span class="op" id="2198483">(</span><span class="ident" id="2198484">s</span><span class="op" id="2198485">[</span><span class="ident" id="2198486">i</span>&nbsp;<span class="op" id="2198488">:</span>&nbsp;<span class="ident" id="2198490">i</span><span class="op" id="2198491">+</span><span class="ident" id="2198492">match</span><span class="op" id="2198497">]</span><span class="op" id="2198498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198502">n</span>&nbsp;<span class="op" id="2198504">+=</span>&nbsp;<span class="ident" id="2198507">wn</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198512">if</span>&nbsp;<span class="ident" id="2198515">err</span>&nbsp;<span class="op" id="2198519">!=</span>&nbsp;<span class="ident" id="2198522">nil</span>&nbsp;<span class="op" id="2198526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198531">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2198540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198544">wn</span><span class="op" id="2198546">,</span>&nbsp;<span class="ident" id="2198548">err</span>&nbsp;<span class="op" id="2198552">=</span>&nbsp;<span class="ident" id="2198554">sw</span><span class="op" id="2198556">.</span><span class="ident" id="2198557">WriteString</span><span class="op" id="2198568">(</span><span class="ident" id="2198569">r</span><span class="op" id="2198570">.</span><span class="ident" id="2198571">value</span><span class="op" id="2198576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198580">n</span>&nbsp;<span class="op" id="2198582">+=</span>&nbsp;<span class="ident" id="2198585">wn</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198590">if</span>&nbsp;<span class="ident" id="2198593">err</span>&nbsp;<span class="op" id="2198597">!=</span>&nbsp;<span class="ident" id="2198600">nil</span>&nbsp;<span class="op" id="2198604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198609">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2198618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198622">i</span>&nbsp;<span class="op" id="2198624">+=</span>&nbsp;<span class="ident" id="2198627">match</span>&nbsp;<span class="op" id="2198633">+</span>&nbsp;<span class="builtinfunc" id="2198635">len</span><span class="op" id="2198638">(</span><span class="ident" id="2198639">r</span><span class="op" id="2198640">.</span><span class="ident" id="2198641">finder</span><span class="op" id="2198647">.</span><span class="ident" id="2198648">pattern</span><span class="op" id="2198655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2198658">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198661">wn</span><span class="op" id="2198663">,</span>&nbsp;<span class="ident" id="2198665">err</span>&nbsp;<span class="op" id="2198669">=</span>&nbsp;<span class="ident" id="2198671">sw</span><span class="op" id="2198673">.</span><span class="ident" id="2198674">WriteString</span><span class="op" id="2198685">(</span><span class="ident" id="2198686">s</span><span class="op" id="2198687">[</span><span class="ident" id="2198688">i</span><span class="op" id="2198689">:</span><span class="op" id="2198690">]</span><span class="op" id="2198691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2198694">n</span>&nbsp;<span class="op" id="2198696">+=</span>&nbsp;<span class="ident" id="2198699">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198703">return</span><br>
<span class="lineno"></span><span class="op" id="2198710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="2198713">//&nbsp;byteReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the&nbsp;&#34;old&#34;</span><br>
<span class="lineno"></span><span class="comment" id="2198782">//&nbsp;and&nbsp;&#34;new&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2198826">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;bytes&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="2198887">type</span>&nbsp;<span class="ident" id="2198892">byteReplacer</span>&nbsp;<span class="op" id="2198905">[</span><span class="num" id="2198906">256</span><span class="op" id="2198909">]</span><span class="builtintype" id="2198910">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="keyword" id="2198916">func</span>&nbsp;<span class="op" id="2198921">(</span><span class="ident" id="2198922">r</span>&nbsp;<span class="op" id="2198924">*</span><span class="ident" id="2198925">byteReplacer</span><span class="op" id="2198937">)</span>&nbsp;<span class="ident" id="2198939">Replace</span><span class="op" id="2198946">(</span><span class="ident" id="2198947">s</span>&nbsp;<span class="builtintype" id="2198949">string</span><span class="op" id="2198955">)</span>&nbsp;<span class="builtintype" id="2198957">string</span>&nbsp;<span class="op" id="2198964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2198967">var</span>&nbsp;<span class="ident" id="2198971">buf</span>&nbsp;<span class="op" id="2198975">[</span><span class="op" id="2198976">]</span><span class="builtintype" id="2198977">byte</span>&nbsp;<span class="comment" id="2198982">//&nbsp;lazily&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199003">for</span>&nbsp;<span class="ident" id="2199007">i</span>&nbsp;<span class="op" id="2199009">:=</span>&nbsp;<span class="num" id="2199012">0</span><span class="op" id="2199013">;</span>&nbsp;<span class="ident" id="2199015">i</span>&nbsp;<span class="op" id="2199017">&lt;</span>&nbsp;<span class="builtinfunc" id="2199019">len</span><span class="op" id="2199022">(</span><span class="ident" id="2199023">s</span><span class="op" id="2199024">)</span><span class="op" id="2199025">;</span>&nbsp;<span class="ident" id="2199027">i</span><span class="op" id="2199028">++</span>&nbsp;<span class="op" id="2199031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199035">b</span>&nbsp;<span class="op" id="2199037">:=</span>&nbsp;<span class="ident" id="2199040">s</span><span class="op" id="2199041">[</span><span class="ident" id="2199042">i</span><span class="op" id="2199043">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199047">if</span>&nbsp;<span class="ident" id="2199050">r</span><span class="op" id="2199051">[</span><span class="ident" id="2199052">b</span><span class="op" id="2199053">]</span>&nbsp;<span class="op" id="2199055">!=</span>&nbsp;<span class="ident" id="2199058">b</span>&nbsp;<span class="op" id="2199060">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199065">if</span>&nbsp;<span class="ident" id="2199068">buf</span>&nbsp;<span class="op" id="2199072">==</span>&nbsp;<span class="ident" id="2199075">nil</span>&nbsp;<span class="op" id="2199079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199085">buf</span>&nbsp;<span class="op" id="2199089">=</span>&nbsp;<span class="op" id="2199091">[</span><span class="op" id="2199092">]</span><span class="builtintype" id="2199093">byte</span><span class="op" id="2199097">(</span><span class="ident" id="2199098">s</span><span class="op" id="2199099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199109">buf</span><span class="op" id="2199112">[</span><span class="ident" id="2199113">i</span><span class="op" id="2199114">]</span>&nbsp;<span class="op" id="2199116">=</span>&nbsp;<span class="ident" id="2199118">r</span><span class="op" id="2199119">[</span><span class="ident" id="2199120">b</span><span class="op" id="2199121">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199125">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199131">if</span>&nbsp;<span class="ident" id="2199134">buf</span>&nbsp;<span class="op" id="2199138">==</span>&nbsp;<span class="ident" id="2199141">nil</span>&nbsp;<span class="op" id="2199145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199149">return</span>&nbsp;<span class="ident" id="2199156">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199162">return</span>&nbsp;<span class="builtintype" id="2199169">string</span><span class="op" id="2199175">(</span><span class="ident" id="2199176">buf</span><span class="op" id="2199179">)</span><br>
<span class="lineno">430</span><span class="op" id="2199181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2199184">func</span>&nbsp;<span class="op" id="2199189">(</span><span class="ident" id="2199190">r</span>&nbsp;<span class="op" id="2199192">*</span><span class="ident" id="2199193">byteReplacer</span><span class="op" id="2199205">)</span>&nbsp;<span class="ident" id="2199207">WriteString</span><span class="op" id="2199218">(</span><span class="ident" id="2199219">w</span>&nbsp;<span class="ident" id="2199221">io</span><span class="op" id="2199223">.</span><span class="ident" id="2199224">Writer</span><span class="op" id="2199230">,</span>&nbsp;<span class="ident" id="2199232">s</span>&nbsp;<span class="builtintype" id="2199234">string</span><span class="op" id="2199240">)</span>&nbsp;<span class="op" id="2199242">(</span><span class="ident" id="2199243">n</span>&nbsp;<span class="builtintype" id="2199245">int</span><span class="op" id="2199248">,</span>&nbsp;<span class="ident" id="2199250">err</span>&nbsp;<span class="builtintype" id="2199254">error</span><span class="op" id="2199259">)</span>&nbsp;<span class="op" id="2199261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2199264">//&nbsp;TODO(bradfitz):&nbsp;use&nbsp;io.WriteString&nbsp;with&nbsp;slices&nbsp;of&nbsp;s,&nbsp;avoiding&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199342">bufsize</span>&nbsp;<span class="op" id="2199350">:=</span>&nbsp;<span class="num" id="2199353">32</span>&nbsp;<span class="op" id="2199356">&lt;&lt;</span>&nbsp;<span class="num" id="2199359">10</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199363">if</span>&nbsp;<span class="builtinfunc" id="2199366">len</span><span class="op" id="2199369">(</span><span class="ident" id="2199370">s</span><span class="op" id="2199371">)</span>&nbsp;<span class="op" id="2199373">&lt;</span>&nbsp;<span class="ident" id="2199375">bufsize</span>&nbsp;<span class="op" id="2199383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199387">bufsize</span>&nbsp;<span class="op" id="2199395">=</span>&nbsp;<span class="builtinfunc" id="2199397">len</span><span class="op" id="2199400">(</span><span class="ident" id="2199401">s</span><span class="op" id="2199402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199408">buf</span>&nbsp;<span class="op" id="2199412">:=</span>&nbsp;<span class="builtinfunc" id="2199415">make</span><span class="op" id="2199419">(</span><span class="op" id="2199420">[</span><span class="op" id="2199421">]</span><span class="builtintype" id="2199422">byte</span><span class="op" id="2199426">,</span>&nbsp;<span class="ident" id="2199428">bufsize</span><span class="op" id="2199435">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199439">for</span>&nbsp;<span class="builtinfunc" id="2199443">len</span><span class="op" id="2199446">(</span><span class="ident" id="2199447">s</span><span class="op" id="2199448">)</span>&nbsp;<span class="op" id="2199450">&gt;</span>&nbsp;<span class="num" id="2199452">0</span>&nbsp;<span class="op" id="2199454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199458">ncopy</span>&nbsp;<span class="op" id="2199464">:=</span>&nbsp;<span class="builtinfunc" id="2199467">copy</span><span class="op" id="2199471">(</span><span class="ident" id="2199472">buf</span><span class="op" id="2199475">,</span>&nbsp;<span class="ident" id="2199477">s</span><span class="op" id="2199478">[</span><span class="op" id="2199479">:</span><span class="op" id="2199480">]</span><span class="op" id="2199481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199485">s</span>&nbsp;<span class="op" id="2199487">=</span>&nbsp;<span class="ident" id="2199489">s</span><span class="op" id="2199490">[</span><span class="ident" id="2199491">ncopy</span><span class="op" id="2199496">:</span><span class="op" id="2199497">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199501">for</span>&nbsp;<span class="ident" id="2199505">i</span><span class="op" id="2199506">,</span>&nbsp;<span class="ident" id="2199508">b</span>&nbsp;<span class="op" id="2199510">:=</span>&nbsp;<span class="keyword" id="2199513">range</span>&nbsp;<span class="ident" id="2199519">buf</span><span class="op" id="2199522">[</span><span class="op" id="2199523">:</span><span class="ident" id="2199524">ncopy</span><span class="op" id="2199529">]</span>&nbsp;<span class="op" id="2199531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199536">buf</span><span class="op" id="2199539">[</span><span class="ident" id="2199540">i</span><span class="op" id="2199541">]</span>&nbsp;<span class="op" id="2199543">=</span>&nbsp;<span class="ident" id="2199545">r</span><span class="op" id="2199546">[</span><span class="ident" id="2199547">b</span><span class="op" id="2199548">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199556">wn</span><span class="op" id="2199558">,</span>&nbsp;<span class="ident" id="2199560">err</span>&nbsp;<span class="op" id="2199564">:=</span>&nbsp;<span class="ident" id="2199567">w</span><span class="op" id="2199568">.</span><span class="ident" id="2199569">Write</span><span class="op" id="2199574">(</span><span class="ident" id="2199575">buf</span><span class="op" id="2199578">[</span><span class="op" id="2199579">:</span><span class="ident" id="2199580">ncopy</span><span class="op" id="2199585">]</span><span class="op" id="2199586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2199590">n</span>&nbsp;<span class="op" id="2199592">+=</span>&nbsp;<span class="ident" id="2199595">wn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199600">if</span>&nbsp;<span class="ident" id="2199603">err</span>&nbsp;<span class="op" id="2199607">!=</span>&nbsp;<span class="ident" id="2199610">nil</span>&nbsp;<span class="op" id="2199614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199619">return</span>&nbsp;<span class="ident" id="2199626">n</span><span class="op" id="2199627">,</span>&nbsp;<span class="ident" id="2199629">err</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2199638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2199641">return</span>&nbsp;<span class="ident" id="2199648">n</span><span class="op" id="2199649">,</span>&nbsp;<span class="ident" id="2199651">nil</span><br>
<span class="lineno"></span><span class="op" id="2199655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="2199658">//&nbsp;byteStringReplacer&nbsp;is&nbsp;the&nbsp;implementation&nbsp;that&#39;s&nbsp;used&nbsp;when&nbsp;all&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2199727">//&nbsp;&#34;old&#34;&nbsp;values&nbsp;are&nbsp;single&nbsp;ASCII&nbsp;bytes&nbsp;but&nbsp;the&nbsp;&#34;new&#34;&nbsp;values&nbsp;vary&nbsp;in&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="2199801">//&nbsp;The&nbsp;array&nbsp;contains&nbsp;replacement&nbsp;byte&nbsp;slices&nbsp;indexed&nbsp;by&nbsp;old&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="2199868">//&nbsp;A&nbsp;nil&nbsp;[]byte&nbsp;means&nbsp;that&nbsp;the&nbsp;old&nbsp;byte&nbsp;should&nbsp;not&nbsp;be&nbsp;replaced.</span><br>
<span class="lineno"></span><span class="keyword" id="2199932">type</span>&nbsp;<span class="ident" id="2199937">byteStringReplacer</span>&nbsp;<span class="op" id="2199956">[</span><span class="num" id="2199957">256</span><span class="op" id="2199960">]</span><span class="op" id="2199961">[</span><span class="op" id="2199962">]</span><span class="builtintype" id="2199963">byte</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="2199969">func</span>&nbsp;<span class="op" id="2199974">(</span><span class="ident" id="2199975">r</span>&nbsp;<span class="op" id="2199977">*</span><span class="ident" id="2199978">byteStringReplacer</span><span class="op" id="2199996">)</span>&nbsp;<span class="ident" id="2199998">Replace</span><span class="op" id="2200005">(</span><span class="ident" id="2200006">s</span>&nbsp;<span class="builtintype" id="2200008">string</span><span class="op" id="2200014">)</span>&nbsp;<span class="builtintype" id="2200016">string</span>&nbsp;<span class="op" id="2200023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200026">newSize</span>&nbsp;<span class="op" id="2200034">:=</span>&nbsp;<span class="builtinfunc" id="2200037">len</span><span class="op" id="2200040">(</span><span class="ident" id="2200041">s</span><span class="op" id="2200042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200045">anyChanges</span>&nbsp;<span class="op" id="2200056">:=</span>&nbsp;<span class="builtintype" id="2200059">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200066">for</span>&nbsp;<span class="ident" id="2200070">i</span>&nbsp;<span class="op" id="2200072">:=</span>&nbsp;<span class="num" id="2200075">0</span><span class="op" id="2200076">;</span>&nbsp;<span class="ident" id="2200078">i</span>&nbsp;<span class="op" id="2200080">&lt;</span>&nbsp;<span class="builtinfunc" id="2200082">len</span><span class="op" id="2200085">(</span><span class="ident" id="2200086">s</span><span class="op" id="2200087">)</span><span class="op" id="2200088">;</span>&nbsp;<span class="ident" id="2200090">i</span><span class="op" id="2200091">++</span>&nbsp;<span class="op" id="2200094">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200098">b</span>&nbsp;<span class="op" id="2200100">:=</span>&nbsp;<span class="ident" id="2200103">s</span><span class="op" id="2200104">[</span><span class="ident" id="2200105">i</span><span class="op" id="2200106">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200110">if</span>&nbsp;<span class="ident" id="2200113">r</span><span class="op" id="2200114">[</span><span class="ident" id="2200115">b</span><span class="op" id="2200116">]</span>&nbsp;<span class="op" id="2200118">!=</span>&nbsp;<span class="ident" id="2200121">nil</span>&nbsp;<span class="op" id="2200125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200130">anyChanges</span>&nbsp;<span class="op" id="2200141">=</span>&nbsp;<span class="builtintype" id="2200143">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2200151">//&nbsp;The&nbsp;-1&nbsp;is&nbsp;because&nbsp;we&nbsp;are&nbsp;replacing&nbsp;1&nbsp;byte&nbsp;with&nbsp;len(r[b])&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200221">newSize</span>&nbsp;<span class="op" id="2200229">+=</span>&nbsp;<span class="builtinfunc" id="2200232">len</span><span class="op" id="2200235">(</span><span class="ident" id="2200236">r</span><span class="op" id="2200237">[</span><span class="ident" id="2200238">b</span><span class="op" id="2200239">]</span><span class="op" id="2200240">)</span>&nbsp;<span class="op" id="2200242">-</span>&nbsp;<span class="num" id="2200244">1</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200254">if</span>&nbsp;<span class="op" id="2200257">!</span><span class="ident" id="2200258">anyChanges</span>&nbsp;<span class="op" id="2200269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200273">return</span>&nbsp;<span class="ident" id="2200280">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200283">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200286">buf</span>&nbsp;<span class="op" id="2200290">:=</span>&nbsp;<span class="builtinfunc" id="2200293">make</span><span class="op" id="2200297">(</span><span class="op" id="2200298">[</span><span class="op" id="2200299">]</span><span class="builtintype" id="2200300">byte</span><span class="op" id="2200304">,</span>&nbsp;<span class="ident" id="2200306">newSize</span><span class="op" id="2200313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200316">bi</span>&nbsp;<span class="op" id="2200319">:=</span>&nbsp;<span class="ident" id="2200322">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200327">for</span>&nbsp;<span class="ident" id="2200331">i</span>&nbsp;<span class="op" id="2200333">:=</span>&nbsp;<span class="num" id="2200336">0</span><span class="op" id="2200337">;</span>&nbsp;<span class="ident" id="2200339">i</span>&nbsp;<span class="op" id="2200341">&lt;</span>&nbsp;<span class="builtinfunc" id="2200343">len</span><span class="op" id="2200346">(</span><span class="ident" id="2200347">s</span><span class="op" id="2200348">)</span><span class="op" id="2200349">;</span>&nbsp;<span class="ident" id="2200351">i</span><span class="op" id="2200352">++</span>&nbsp;<span class="op" id="2200355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200359">b</span>&nbsp;<span class="op" id="2200361">:=</span>&nbsp;<span class="ident" id="2200364">s</span><span class="op" id="2200365">[</span><span class="ident" id="2200366">i</span><span class="op" id="2200367">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200371">if</span>&nbsp;<span class="ident" id="2200374">r</span><span class="op" id="2200375">[</span><span class="ident" id="2200376">b</span><span class="op" id="2200377">]</span>&nbsp;<span class="op" id="2200379">!=</span>&nbsp;<span class="ident" id="2200382">nil</span>&nbsp;<span class="op" id="2200386">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200391">n</span>&nbsp;<span class="op" id="2200393">:=</span>&nbsp;<span class="builtinfunc" id="2200396">copy</span><span class="op" id="2200400">(</span><span class="ident" id="2200401">bi</span><span class="op" id="2200403">,</span>&nbsp;<span class="ident" id="2200405">r</span><span class="op" id="2200406">[</span><span class="ident" id="2200407">b</span><span class="op" id="2200408">]</span><span class="op" id="2200409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200414">bi</span>&nbsp;<span class="op" id="2200417">=</span>&nbsp;<span class="ident" id="2200419">bi</span><span class="op" id="2200421">[</span><span class="ident" id="2200422">n</span><span class="op" id="2200423">:</span><span class="op" id="2200424">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200428">}</span>&nbsp;<span class="keyword" id="2200430">else</span>&nbsp;<span class="op" id="2200435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200440">bi</span><span class="op" id="2200442">[</span><span class="num" id="2200443">0</span><span class="op" id="2200444">]</span>&nbsp;<span class="op" id="2200446">=</span>&nbsp;<span class="ident" id="2200448">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200453">bi</span>&nbsp;<span class="op" id="2200456">=</span>&nbsp;<span class="ident" id="2200458">bi</span><span class="op" id="2200460">[</span><span class="num" id="2200461">1</span><span class="op" id="2200462">:</span><span class="op" id="2200463">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200473">return</span>&nbsp;<span class="builtintype" id="2200480">string</span><span class="op" id="2200486">(</span><span class="ident" id="2200487">buf</span><span class="op" id="2200490">)</span><br>
<span class="lineno"></span><span class="op" id="2200492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="keyword" id="2200495">func</span>&nbsp;<span class="op" id="2200500">(</span><span class="ident" id="2200501">r</span>&nbsp;<span class="op" id="2200503">*</span><span class="ident" id="2200504">byteStringReplacer</span><span class="op" id="2200522">)</span>&nbsp;<span class="ident" id="2200524">WriteString</span><span class="op" id="2200535">(</span><span class="ident" id="2200536">w</span>&nbsp;<span class="ident" id="2200538">io</span><span class="op" id="2200540">.</span><span class="ident" id="2200541">Writer</span><span class="op" id="2200547">,</span>&nbsp;<span class="ident" id="2200549">s</span>&nbsp;<span class="builtintype" id="2200551">string</span><span class="op" id="2200557">)</span>&nbsp;<span class="op" id="2200559">(</span><span class="ident" id="2200560">n</span>&nbsp;<span class="builtintype" id="2200562">int</span><span class="op" id="2200565">,</span>&nbsp;<span class="ident" id="2200567">err</span>&nbsp;<span class="builtintype" id="2200571">error</span><span class="op" id="2200576">)</span>&nbsp;<span class="op" id="2200578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200581">sw</span>&nbsp;<span class="op" id="2200584">:=</span>&nbsp;<span class="ident" id="2200587">getStringWriter</span><span class="op" id="2200602">(</span><span class="ident" id="2200603">w</span><span class="op" id="2200604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200607">last</span>&nbsp;<span class="op" id="2200612">:=</span>&nbsp;<span class="num" id="2200615">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200618">for</span>&nbsp;<span class="ident" id="2200622">i</span>&nbsp;<span class="op" id="2200624">:=</span>&nbsp;<span class="num" id="2200627">0</span><span class="op" id="2200628">;</span>&nbsp;<span class="ident" id="2200630">i</span>&nbsp;<span class="op" id="2200632">&lt;</span>&nbsp;<span class="builtinfunc" id="2200634">len</span><span class="op" id="2200637">(</span><span class="ident" id="2200638">s</span><span class="op" id="2200639">)</span><span class="op" id="2200640">;</span>&nbsp;<span class="ident" id="2200642">i</span><span class="op" id="2200643">++</span>&nbsp;<span class="op" id="2200646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200650">b</span>&nbsp;<span class="op" id="2200652">:=</span>&nbsp;<span class="ident" id="2200655">s</span><span class="op" id="2200656">[</span><span class="ident" id="2200657">i</span><span class="op" id="2200658">]</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200662">if</span>&nbsp;<span class="ident" id="2200665">r</span><span class="op" id="2200666">[</span><span class="ident" id="2200667">b</span><span class="op" id="2200668">]</span>&nbsp;<span class="op" id="2200670">==</span>&nbsp;<span class="ident" id="2200673">nil</span>&nbsp;<span class="op" id="2200677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200682">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200697">if</span>&nbsp;<span class="ident" id="2200700">last</span>&nbsp;<span class="op" id="2200705">!=</span>&nbsp;<span class="ident" id="2200708">i</span>&nbsp;<span class="op" id="2200710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200715">nw</span><span class="op" id="2200717">,</span>&nbsp;<span class="ident" id="2200719">err</span>&nbsp;<span class="op" id="2200723">:=</span>&nbsp;<span class="ident" id="2200726">sw</span><span class="op" id="2200728">.</span><span class="ident" id="2200729">WriteString</span><span class="op" id="2200740">(</span><span class="ident" id="2200741">s</span><span class="op" id="2200742">[</span><span class="ident" id="2200743">last</span><span class="op" id="2200747">:</span><span class="ident" id="2200748">i</span><span class="op" id="2200749">]</span><span class="op" id="2200750">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200755">n</span>&nbsp;<span class="op" id="2200757">+=</span>&nbsp;<span class="ident" id="2200760">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200766">if</span>&nbsp;<span class="ident" id="2200769">err</span>&nbsp;<span class="op" id="2200773">!=</span>&nbsp;<span class="ident" id="2200776">nil</span>&nbsp;<span class="op" id="2200780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200786">return</span>&nbsp;<span class="ident" id="2200793">n</span><span class="op" id="2200794">,</span>&nbsp;<span class="ident" id="2200796">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200807">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200811">last</span>&nbsp;<span class="op" id="2200816">=</span>&nbsp;<span class="ident" id="2200818">i</span>&nbsp;<span class="op" id="2200820">+</span>&nbsp;<span class="num" id="2200822">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200826">nw</span><span class="op" id="2200828">,</span>&nbsp;<span class="ident" id="2200830">err</span>&nbsp;<span class="op" id="2200834">:=</span>&nbsp;<span class="ident" id="2200837">w</span><span class="op" id="2200838">.</span><span class="ident" id="2200839">Write</span><span class="op" id="2200844">(</span><span class="ident" id="2200845">r</span><span class="op" id="2200846">[</span><span class="ident" id="2200847">b</span><span class="op" id="2200848">]</span><span class="op" id="2200849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200853">n</span>&nbsp;<span class="op" id="2200855">+=</span>&nbsp;<span class="ident" id="2200858">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200863">if</span>&nbsp;<span class="ident" id="2200866">err</span>&nbsp;<span class="op" id="2200870">!=</span>&nbsp;<span class="ident" id="2200873">nil</span>&nbsp;<span class="op" id="2200877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200882">return</span>&nbsp;<span class="ident" id="2200889">n</span><span class="op" id="2200890">,</span>&nbsp;<span class="ident" id="2200892">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200904">if</span>&nbsp;<span class="ident" id="2200907">last</span>&nbsp;<span class="op" id="2200912">!=</span>&nbsp;<span class="builtinfunc" id="2200915">len</span><span class="op" id="2200918">(</span><span class="ident" id="2200919">s</span><span class="op" id="2200920">)</span>&nbsp;<span class="op" id="2200922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200926">var</span>&nbsp;<span class="ident" id="2200930">nw</span>&nbsp;<span class="builtintype" id="2200933">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200939">nw</span><span class="op" id="2200941">,</span>&nbsp;<span class="ident" id="2200943">err</span>&nbsp;<span class="op" id="2200947">=</span>&nbsp;<span class="ident" id="2200949">sw</span><span class="op" id="2200951">.</span><span class="ident" id="2200952">WriteString</span><span class="op" id="2200963">(</span><span class="ident" id="2200964">s</span><span class="op" id="2200965">[</span><span class="ident" id="2200966">last</span><span class="op" id="2200970">:</span><span class="op" id="2200971">]</span><span class="op" id="2200972">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2200976">n</span>&nbsp;<span class="op" id="2200978">+=</span>&nbsp;<span class="ident" id="2200981">nw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2200985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2200988">return</span><br>
<span class="lineno"></span><span class="op" id="2200995">}</span>
</div>
</body>
</html>
