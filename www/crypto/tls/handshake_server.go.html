<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3979062">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3979117">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3979171">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3979222">package</span>&nbsp;<span class="ident" id="3979230">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3979235">import</span>&nbsp;<span class="op" id="3979242">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3979245">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3979255">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3979271">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3979285">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3979302">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3979317">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3979334">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3979344">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3979351">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="3979356">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3979359">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="3979435">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="3979487">type</span>&nbsp;<span class="ident" id="3979492">serverHandshakeState</span>&nbsp;<span class="keyword" id="3979513">struct</span>&nbsp;<span class="op" id="3979520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979523">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979539">*</span><span class="ident" id="3979540">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979546">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979562">*</span><span class="ident" id="3979563">clientHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979579">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979595">*</span><span class="ident" id="3979596">serverHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979612">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979628">*</span><span class="ident" id="3979629">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979642">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3979658">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979664">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3979680">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979686">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979702">*</span><span class="ident" id="3979703">sessionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979717">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3979733">finishedHash</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979747">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979763">[</span><span class="op" id="3979764">]</span><span class="builtintype" id="3979765">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979771">certsFromClient</span>&nbsp;<span class="op" id="3979787">[</span><span class="op" id="3979788">]</span><span class="op" id="3979789">[</span><span class="op" id="3979790">]</span><span class="builtintype" id="3979791">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979797">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3979813">*</span><span class="ident" id="3979814">Certificate</span><br>
<span class="lineno"></span><span class="op" id="3979826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3979829">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="3979886">func</span>&nbsp;<span class="op" id="3979891">(</span><span class="ident" id="3979892">c</span>&nbsp;<span class="op" id="3979894">*</span><span class="ident" id="3979895">Conn</span><span class="op" id="3979899">)</span>&nbsp;<span class="ident" id="3979901">serverHandshake</span><span class="op" id="3979916">(</span><span class="op" id="3979917">)</span>&nbsp;<span class="builtintype" id="3979919">error</span>&nbsp;<span class="op" id="3979925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979928">config</span>&nbsp;<span class="op" id="3979935">:=</span>&nbsp;<span class="ident" id="3979938">c</span><span class="op" id="3979939">.</span><span class="ident" id="3979940">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3979949">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3980020">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980050">config</span><span class="op" id="3980056">.</span><span class="ident" id="3980057">serverInitOnce</span><span class="op" id="3980071">.</span><span class="ident" id="3980072">Do</span><span class="op" id="3980074">(</span><span class="ident" id="3980075">config</span><span class="op" id="3980081">.</span><span class="ident" id="3980082">serverInit</span><span class="op" id="3980092">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980096">hs</span>&nbsp;<span class="op" id="3980099">:=</span>&nbsp;<span class="ident" id="3980102">serverHandshakeState</span><span class="op" id="3980122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980126">c</span><span class="op" id="3980127">:</span>&nbsp;<span class="ident" id="3980129">c</span><span class="op" id="3980130">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980136">isResume</span><span class="op" id="3980144">,</span>&nbsp;<span class="ident" id="3980146">err</span>&nbsp;<span class="op" id="3980150">:=</span>&nbsp;<span class="ident" id="3980153">hs</span><span class="op" id="3980155">.</span><span class="ident" id="3980156">readClientHello</span><span class="op" id="3980171">(</span><span class="op" id="3980172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980175">if</span>&nbsp;<span class="ident" id="3980178">err</span>&nbsp;<span class="op" id="3980182">!=</span>&nbsp;<span class="ident" id="3980185">nil</span>&nbsp;<span class="op" id="3980189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980193">return</span>&nbsp;<span class="ident" id="3980200">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980205">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3980209">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980301">if</span>&nbsp;<span class="ident" id="3980304">isResume</span>&nbsp;<span class="op" id="3980313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3980317">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980402">if</span>&nbsp;<span class="ident" id="3980405">err</span>&nbsp;<span class="op" id="3980409">:=</span>&nbsp;<span class="ident" id="3980412">hs</span><span class="op" id="3980414">.</span><span class="ident" id="3980415">doResumeHandshake</span><span class="op" id="3980432">(</span><span class="op" id="3980433">)</span><span class="op" id="3980434">;</span>&nbsp;<span class="ident" id="3980436">err</span>&nbsp;<span class="op" id="3980440">!=</span>&nbsp;<span class="ident" id="3980443">nil</span>&nbsp;<span class="op" id="3980447">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980452">return</span>&nbsp;<span class="ident" id="3980459">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980469">if</span>&nbsp;<span class="ident" id="3980472">err</span>&nbsp;<span class="op" id="3980476">:=</span>&nbsp;<span class="ident" id="3980479">hs</span><span class="op" id="3980481">.</span><span class="ident" id="3980482">establishKeys</span><span class="op" id="3980495">(</span><span class="op" id="3980496">)</span><span class="op" id="3980497">;</span>&nbsp;<span class="ident" id="3980499">err</span>&nbsp;<span class="op" id="3980503">!=</span>&nbsp;<span class="ident" id="3980506">nil</span>&nbsp;<span class="op" id="3980510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980515">return</span>&nbsp;<span class="ident" id="3980522">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980528">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980532">if</span>&nbsp;<span class="ident" id="3980535">err</span>&nbsp;<span class="op" id="3980539">:=</span>&nbsp;<span class="ident" id="3980542">hs</span><span class="op" id="3980544">.</span><span class="ident" id="3980545">sendFinished</span><span class="op" id="3980557">(</span><span class="ident" id="3980558">c</span><span class="op" id="3980559">.</span><span class="ident" id="3980560">firstFinished</span><span class="op" id="3980573">[</span><span class="op" id="3980574">:</span><span class="op" id="3980575">]</span><span class="op" id="3980576">)</span><span class="op" id="3980577">;</span>&nbsp;<span class="ident" id="3980579">err</span>&nbsp;<span class="op" id="3980583">!=</span>&nbsp;<span class="ident" id="3980586">nil</span>&nbsp;<span class="op" id="3980590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980595">return</span>&nbsp;<span class="ident" id="3980602">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980612">if</span>&nbsp;<span class="ident" id="3980615">err</span>&nbsp;<span class="op" id="3980619">:=</span>&nbsp;<span class="ident" id="3980622">hs</span><span class="op" id="3980624">.</span><span class="ident" id="3980625">readFinished</span><span class="op" id="3980637">(</span><span class="ident" id="3980638">nil</span><span class="op" id="3980641">)</span><span class="op" id="3980642">;</span>&nbsp;<span class="ident" id="3980644">err</span>&nbsp;<span class="op" id="3980648">!=</span>&nbsp;<span class="ident" id="3980651">nil</span>&nbsp;<span class="op" id="3980655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980660">return</span>&nbsp;<span class="ident" id="3980667">err</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980677">c</span><span class="op" id="3980678">.</span><span class="ident" id="3980679">didResume</span>&nbsp;<span class="op" id="3980689">=</span>&nbsp;<span class="ident" id="3980691">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980697">}</span>&nbsp;<span class="keyword" id="3980699">else</span>&nbsp;<span class="op" id="3980704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3980708">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3980770">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980808">if</span>&nbsp;<span class="ident" id="3980811">err</span>&nbsp;<span class="op" id="3980815">:=</span>&nbsp;<span class="ident" id="3980818">hs</span><span class="op" id="3980820">.</span><span class="ident" id="3980821">doFullHandshake</span><span class="op" id="3980836">(</span><span class="op" id="3980837">)</span><span class="op" id="3980838">;</span>&nbsp;<span class="ident" id="3980840">err</span>&nbsp;<span class="op" id="3980844">!=</span>&nbsp;<span class="ident" id="3980847">nil</span>&nbsp;<span class="op" id="3980851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980856">return</span>&nbsp;<span class="ident" id="3980863">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980873">if</span>&nbsp;<span class="ident" id="3980876">err</span>&nbsp;<span class="op" id="3980880">:=</span>&nbsp;<span class="ident" id="3980883">hs</span><span class="op" id="3980885">.</span><span class="ident" id="3980886">establishKeys</span><span class="op" id="3980899">(</span><span class="op" id="3980900">)</span><span class="op" id="3980901">;</span>&nbsp;<span class="ident" id="3980903">err</span>&nbsp;<span class="op" id="3980907">!=</span>&nbsp;<span class="ident" id="3980910">nil</span>&nbsp;<span class="op" id="3980914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980919">return</span>&nbsp;<span class="ident" id="3980926">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980936">if</span>&nbsp;<span class="ident" id="3980939">err</span>&nbsp;<span class="op" id="3980943">:=</span>&nbsp;<span class="ident" id="3980946">hs</span><span class="op" id="3980948">.</span><span class="ident" id="3980949">readFinished</span><span class="op" id="3980961">(</span><span class="ident" id="3980962">c</span><span class="op" id="3980963">.</span><span class="ident" id="3980964">firstFinished</span><span class="op" id="3980977">[</span><span class="op" id="3980978">:</span><span class="op" id="3980979">]</span><span class="op" id="3980980">)</span><span class="op" id="3980981">;</span>&nbsp;<span class="ident" id="3980983">err</span>&nbsp;<span class="op" id="3980987">!=</span>&nbsp;<span class="ident" id="3980990">nil</span>&nbsp;<span class="op" id="3980994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980999">return</span>&nbsp;<span class="ident" id="3981006">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981016">if</span>&nbsp;<span class="ident" id="3981019">err</span>&nbsp;<span class="op" id="3981023">:=</span>&nbsp;<span class="ident" id="3981026">hs</span><span class="op" id="3981028">.</span><span class="ident" id="3981029">sendSessionTicket</span><span class="op" id="3981046">(</span><span class="op" id="3981047">)</span><span class="op" id="3981048">;</span>&nbsp;<span class="ident" id="3981050">err</span>&nbsp;<span class="op" id="3981054">!=</span>&nbsp;<span class="ident" id="3981057">nil</span>&nbsp;<span class="op" id="3981061">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981066">return</span>&nbsp;<span class="ident" id="3981073">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981083">if</span>&nbsp;<span class="ident" id="3981086">err</span>&nbsp;<span class="op" id="3981090">:=</span>&nbsp;<span class="ident" id="3981093">hs</span><span class="op" id="3981095">.</span><span class="ident" id="3981096">sendFinished</span><span class="op" id="3981108">(</span><span class="ident" id="3981109">nil</span><span class="op" id="3981112">)</span><span class="op" id="3981113">;</span>&nbsp;<span class="ident" id="3981115">err</span>&nbsp;<span class="op" id="3981119">!=</span>&nbsp;<span class="ident" id="3981122">nil</span>&nbsp;<span class="op" id="3981126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981131">return</span>&nbsp;<span class="ident" id="3981138">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981144">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981150">c</span><span class="op" id="3981151">.</span><span class="ident" id="3981152">handshakeComplete</span>&nbsp;<span class="op" id="3981170">=</span>&nbsp;<span class="ident" id="3981172">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981179">return</span>&nbsp;<span class="ident" id="3981186">nil</span><br>
<span class="lineno"></span><span class="op" id="3981190">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3981193">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="3981268">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="3981315">func</span>&nbsp;<span class="op" id="3981320">(</span><span class="ident" id="3981321">hs</span>&nbsp;<span class="op" id="3981324">*</span><span class="ident" id="3981325">serverHandshakeState</span><span class="op" id="3981345">)</span>&nbsp;<span class="ident" id="3981347">readClientHello</span><span class="op" id="3981362">(</span><span class="op" id="3981363">)</span>&nbsp;<span class="op" id="3981365">(</span><span class="ident" id="3981366">isResume</span>&nbsp;<span class="builtintype" id="3981375">bool</span><span class="op" id="3981379">,</span>&nbsp;<span class="ident" id="3981381">err</span>&nbsp;<span class="builtintype" id="3981385">error</span><span class="op" id="3981390">)</span>&nbsp;<span class="op" id="3981392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981395">config</span>&nbsp;<span class="op" id="3981402">:=</span>&nbsp;<span class="ident" id="3981405">hs</span><span class="op" id="3981407">.</span><span class="ident" id="3981408">c</span><span class="op" id="3981409">.</span><span class="ident" id="3981410">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981418">c</span>&nbsp;<span class="op" id="3981420">:=</span>&nbsp;<span class="ident" id="3981423">hs</span><span class="op" id="3981425">.</span><span class="ident" id="3981426">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981430">msg</span><span class="op" id="3981433">,</span>&nbsp;<span class="ident" id="3981435">err</span>&nbsp;<span class="op" id="3981439">:=</span>&nbsp;<span class="ident" id="3981442">c</span><span class="op" id="3981443">.</span><span class="ident" id="3981444">readHandshake</span><span class="op" id="3981457">(</span><span class="op" id="3981458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981461">if</span>&nbsp;<span class="ident" id="3981464">err</span>&nbsp;<span class="op" id="3981468">!=</span>&nbsp;<span class="ident" id="3981471">nil</span>&nbsp;<span class="op" id="3981475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981479">return</span>&nbsp;<span class="ident" id="3981486">false</span><span class="op" id="3981491">,</span>&nbsp;<span class="ident" id="3981493">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981501">var</span>&nbsp;<span class="ident" id="3981505">ok</span>&nbsp;<span class="builtintype" id="3981508">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981514">hs</span><span class="op" id="3981516">.</span><span class="ident" id="3981517">clientHello</span><span class="op" id="3981528">,</span>&nbsp;<span class="ident" id="3981530">ok</span>&nbsp;<span class="op" id="3981533">=</span>&nbsp;<span class="ident" id="3981535">msg</span><span class="op" id="3981538">.</span><span class="op" id="3981539">(</span><span class="op" id="3981540">*</span><span class="ident" id="3981541">clientHelloMsg</span><span class="op" id="3981555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981558">if</span>&nbsp;<span class="op" id="3981561">!</span><span class="ident" id="3981562">ok</span>&nbsp;<span class="op" id="3981565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981569">c</span><span class="op" id="3981570">.</span><span class="ident" id="3981571">sendAlert</span><span class="op" id="3981580">(</span><span class="ident" id="3981581">alertUnexpectedMessage</span><span class="op" id="3981603">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981607">return</span>&nbsp;<span class="ident" id="3981614">false</span><span class="op" id="3981619">,</span>&nbsp;<span class="ident" id="3981621">unexpectedMessageError</span><span class="op" id="3981643">(</span><span class="ident" id="3981644">hs</span><span class="op" id="3981646">.</span><span class="ident" id="3981647">clientHello</span><span class="op" id="3981658">,</span>&nbsp;<span class="ident" id="3981660">msg</span><span class="op" id="3981663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981669">c</span><span class="op" id="3981670">.</span><span class="ident" id="3981671">vers</span><span class="op" id="3981675">,</span>&nbsp;<span class="ident" id="3981677">ok</span>&nbsp;<span class="op" id="3981680">=</span>&nbsp;<span class="ident" id="3981682">config</span><span class="op" id="3981688">.</span><span class="ident" id="3981689">mutualVersion</span><span class="op" id="3981702">(</span><span class="ident" id="3981703">hs</span><span class="op" id="3981705">.</span><span class="ident" id="3981706">clientHello</span><span class="op" id="3981717">.</span><span class="ident" id="3981718">vers</span><span class="op" id="3981722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981725">if</span>&nbsp;<span class="op" id="3981728">!</span><span class="ident" id="3981729">ok</span>&nbsp;<span class="op" id="3981732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981736">c</span><span class="op" id="3981737">.</span><span class="ident" id="3981738">sendAlert</span><span class="op" id="3981747">(</span><span class="ident" id="3981748">alertProtocolVersion</span><span class="op" id="3981768">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981772">return</span>&nbsp;<span class="ident" id="3981779">false</span><span class="op" id="3981784">,</span>&nbsp;<span class="ident" id="3981786">fmt</span><span class="op" id="3981789">.</span><span class="ident" id="3981790">Errorf</span><span class="op" id="3981796">(</span><span class="string" id="3981797">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="3981865">,</span>&nbsp;<span class="ident" id="3981867">hs</span><span class="op" id="3981869">.</span><span class="ident" id="3981870">clientHello</span><span class="op" id="3981881">.</span><span class="ident" id="3981882">vers</span><span class="op" id="3981886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981892">c</span><span class="op" id="3981893">.</span><span class="ident" id="3981894">haveVers</span>&nbsp;<span class="op" id="3981903">=</span>&nbsp;<span class="ident" id="3981905">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981912">hs</span><span class="op" id="3981914">.</span><span class="ident" id="3981915">finishedHash</span>&nbsp;<span class="op" id="3981928">=</span>&nbsp;<span class="ident" id="3981930">newFinishedHash</span><span class="op" id="3981945">(</span><span class="ident" id="3981946">c</span><span class="op" id="3981947">.</span><span class="ident" id="3981948">vers</span><span class="op" id="3981952">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981955">hs</span><span class="op" id="3981957">.</span><span class="ident" id="3981958">finishedHash</span><span class="op" id="3981970">.</span><span class="ident" id="3981971">Write</span><span class="op" id="3981976">(</span><span class="ident" id="3981977">hs</span><span class="op" id="3981979">.</span><span class="ident" id="3981980">clientHello</span><span class="op" id="3981991">.</span><span class="ident" id="3981992">marshal</span><span class="op" id="3981999">(</span><span class="op" id="3982000">)</span><span class="op" id="3982001">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982005">hs</span><span class="op" id="3982007">.</span><span class="ident" id="3982008">hello</span>&nbsp;<span class="op" id="3982014">=</span>&nbsp;<span class="builtinfunc" id="3982016">new</span><span class="op" id="3982019">(</span><span class="ident" id="3982020">serverHelloMsg</span><span class="op" id="3982034">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982038">supportedCurve</span>&nbsp;<span class="op" id="3982053">:=</span>&nbsp;<span class="ident" id="3982056">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982063">preferredCurves</span>&nbsp;<span class="op" id="3982079">:=</span>&nbsp;<span class="ident" id="3982082">config</span><span class="op" id="3982088">.</span><span class="ident" id="3982089">curvePreferences</span><span class="op" id="3982105">(</span><span class="op" id="3982106">)</span><br>
<span class="lineno"></span><span class="ident" id="3982108">Curves</span><span class="op" id="3982114">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982117">for</span>&nbsp;<span class="ident" id="3982121">_</span><span class="op" id="3982122">,</span>&nbsp;<span class="ident" id="3982124">curve</span>&nbsp;<span class="op" id="3982130">:=</span>&nbsp;<span class="keyword" id="3982133">range</span>&nbsp;<span class="ident" id="3982139">hs</span><span class="op" id="3982141">.</span><span class="ident" id="3982142">clientHello</span><span class="op" id="3982153">.</span><span class="ident" id="3982154">supportedCurves</span>&nbsp;<span class="op" id="3982170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982174">for</span>&nbsp;<span class="ident" id="3982178">_</span><span class="op" id="3982179">,</span>&nbsp;<span class="ident" id="3982181">supported</span>&nbsp;<span class="op" id="3982191">:=</span>&nbsp;<span class="keyword" id="3982194">range</span>&nbsp;<span class="ident" id="3982200">preferredCurves</span>&nbsp;<span class="op" id="3982216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982221">if</span>&nbsp;<span class="ident" id="3982224">supported</span>&nbsp;<span class="op" id="3982234">==</span>&nbsp;<span class="ident" id="3982237">curve</span>&nbsp;<span class="op" id="3982243">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982249">supportedCurve</span>&nbsp;<span class="op" id="3982264">=</span>&nbsp;<span class="ident" id="3982266">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982275">break</span>&nbsp;<span class="ident" id="3982281">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982298">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982302">supportedPointFormat</span>&nbsp;<span class="op" id="3982323">:=</span>&nbsp;<span class="ident" id="3982326">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982333">for</span>&nbsp;<span class="ident" id="3982337">_</span><span class="op" id="3982338">,</span>&nbsp;<span class="ident" id="3982340">pointFormat</span>&nbsp;<span class="op" id="3982352">:=</span>&nbsp;<span class="keyword" id="3982355">range</span>&nbsp;<span class="ident" id="3982361">hs</span><span class="op" id="3982363">.</span><span class="ident" id="3982364">clientHello</span><span class="op" id="3982375">.</span><span class="ident" id="3982376">supportedPoints</span>&nbsp;<span class="op" id="3982392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982396">if</span>&nbsp;<span class="ident" id="3982399">pointFormat</span>&nbsp;<span class="op" id="3982411">==</span>&nbsp;<span class="ident" id="3982414">pointFormatUncompressed</span>&nbsp;<span class="op" id="3982438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982443">supportedPointFormat</span>&nbsp;<span class="op" id="3982464">=</span>&nbsp;<span class="ident" id="3982466">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982474">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982488">hs</span><span class="op" id="3982490">.</span><span class="ident" id="3982491">ellipticOk</span>&nbsp;<span class="op" id="3982502">=</span>&nbsp;<span class="ident" id="3982504">supportedCurve</span>&nbsp;<span class="op" id="3982519">&amp;&amp;</span>&nbsp;<span class="ident" id="3982522">supportedPointFormat</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982545">foundCompression</span>&nbsp;<span class="op" id="3982562">:=</span>&nbsp;<span class="ident" id="3982565">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3982572">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982647">for</span>&nbsp;<span class="ident" id="3982651">_</span><span class="op" id="3982652">,</span>&nbsp;<span class="ident" id="3982654">compression</span>&nbsp;<span class="op" id="3982666">:=</span>&nbsp;<span class="keyword" id="3982669">range</span>&nbsp;<span class="ident" id="3982675">hs</span><span class="op" id="3982677">.</span><span class="ident" id="3982678">clientHello</span><span class="op" id="3982689">.</span><span class="ident" id="3982690">compressionMethods</span>&nbsp;<span class="op" id="3982709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982713">if</span>&nbsp;<span class="ident" id="3982716">compression</span>&nbsp;<span class="op" id="3982728">==</span>&nbsp;<span class="ident" id="3982731">compressionNone</span>&nbsp;<span class="op" id="3982747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982752">foundCompression</span>&nbsp;<span class="op" id="3982769">=</span>&nbsp;<span class="ident" id="3982771">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982779">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982794">if</span>&nbsp;<span class="op" id="3982797">!</span><span class="ident" id="3982798">foundCompression</span>&nbsp;<span class="op" id="3982815">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982819">c</span><span class="op" id="3982820">.</span><span class="ident" id="3982821">sendAlert</span><span class="op" id="3982830">(</span><span class="ident" id="3982831">alertHandshakeFailure</span><span class="op" id="3982852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982856">return</span>&nbsp;<span class="ident" id="3982863">false</span><span class="op" id="3982868">,</span>&nbsp;<span class="ident" id="3982870">errors</span><span class="op" id="3982876">.</span><span class="ident" id="3982877">New</span><span class="op" id="3982880">(</span><span class="string" id="3982881">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="3982936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982943">hs</span><span class="op" id="3982945">.</span><span class="ident" id="3982946">hello</span><span class="op" id="3982951">.</span><span class="ident" id="3982952">vers</span>&nbsp;<span class="op" id="3982957">=</span>&nbsp;<span class="ident" id="3982959">c</span><span class="op" id="3982960">.</span><span class="ident" id="3982961">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982967">hs</span><span class="op" id="3982969">.</span><span class="ident" id="3982970">hello</span><span class="op" id="3982975">.</span><span class="ident" id="3982976">random</span>&nbsp;<span class="op" id="3982983">=</span>&nbsp;<span class="builtinfunc" id="3982985">make</span><span class="op" id="3982989">(</span><span class="op" id="3982990">[</span><span class="op" id="3982991">]</span><span class="builtintype" id="3982992">byte</span><span class="op" id="3982996">,</span>&nbsp;<span class="num" id="3982998">32</span><span class="op" id="3983000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983003">_</span><span class="op" id="3983004">,</span>&nbsp;<span class="ident" id="3983006">err</span>&nbsp;<span class="op" id="3983010">=</span>&nbsp;<span class="ident" id="3983012">io</span><span class="op" id="3983014">.</span><span class="ident" id="3983015">ReadFull</span><span class="op" id="3983023">(</span><span class="ident" id="3983024">config</span><span class="op" id="3983030">.</span><span class="ident" id="3983031">rand</span><span class="op" id="3983035">(</span><span class="op" id="3983036">)</span><span class="op" id="3983037">,</span>&nbsp;<span class="ident" id="3983039">hs</span><span class="op" id="3983041">.</span><span class="ident" id="3983042">hello</span><span class="op" id="3983047">.</span><span class="ident" id="3983048">random</span><span class="op" id="3983054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983057">if</span>&nbsp;<span class="ident" id="3983060">err</span>&nbsp;<span class="op" id="3983064">!=</span>&nbsp;<span class="ident" id="3983067">nil</span>&nbsp;<span class="op" id="3983071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983075">c</span><span class="op" id="3983076">.</span><span class="ident" id="3983077">sendAlert</span><span class="op" id="3983086">(</span><span class="ident" id="3983087">alertInternalError</span><span class="op" id="3983105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983109">return</span>&nbsp;<span class="ident" id="3983116">false</span><span class="op" id="3983121">,</span>&nbsp;<span class="ident" id="3983123">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983131">hs</span><span class="op" id="3983133">.</span><span class="ident" id="3983134">hello</span><span class="op" id="3983139">.</span><span class="ident" id="3983140">secureRenegotiation</span>&nbsp;<span class="op" id="3983160">=</span>&nbsp;<span class="ident" id="3983162">hs</span><span class="op" id="3983164">.</span><span class="ident" id="3983165">clientHello</span><span class="op" id="3983176">.</span><span class="ident" id="3983177">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983198">hs</span><span class="op" id="3983200">.</span><span class="ident" id="3983201">hello</span><span class="op" id="3983206">.</span><span class="ident" id="3983207">compressionMethod</span>&nbsp;<span class="op" id="3983225">=</span>&nbsp;<span class="ident" id="3983227">compressionNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983244">if</span>&nbsp;<span class="builtinfunc" id="3983247">len</span><span class="op" id="3983250">(</span><span class="ident" id="3983251">hs</span><span class="op" id="3983253">.</span><span class="ident" id="3983254">clientHello</span><span class="op" id="3983265">.</span><span class="ident" id="3983266">serverName</span><span class="op" id="3983276">)</span>&nbsp;<span class="op" id="3983278">&gt;</span>&nbsp;<span class="num" id="3983280">0</span>&nbsp;<span class="op" id="3983282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983286">c</span><span class="op" id="3983287">.</span><span class="ident" id="3983288">serverName</span>&nbsp;<span class="op" id="3983299">=</span>&nbsp;<span class="ident" id="3983301">hs</span><span class="op" id="3983303">.</span><span class="ident" id="3983304">clientHello</span><span class="op" id="3983315">.</span><span class="ident" id="3983316">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983332">if</span>&nbsp;<span class="builtinfunc" id="3983335">len</span><span class="op" id="3983338">(</span><span class="ident" id="3983339">hs</span><span class="op" id="3983341">.</span><span class="ident" id="3983342">clientHello</span><span class="op" id="3983353">.</span><span class="ident" id="3983354">alpnProtocols</span><span class="op" id="3983367">)</span>&nbsp;<span class="op" id="3983369">&gt;</span>&nbsp;<span class="num" id="3983371">0</span>&nbsp;<span class="op" id="3983373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983377">if</span>&nbsp;<span class="ident" id="3983380">selectedProto</span><span class="op" id="3983393">,</span>&nbsp;<span class="ident" id="3983395">fallback</span>&nbsp;<span class="op" id="3983404">:=</span>&nbsp;<span class="ident" id="3983407">mutualProtocol</span><span class="op" id="3983421">(</span><span class="ident" id="3983422">hs</span><span class="op" id="3983424">.</span><span class="ident" id="3983425">clientHello</span><span class="op" id="3983436">.</span><span class="ident" id="3983437">alpnProtocols</span><span class="op" id="3983450">,</span>&nbsp;<span class="ident" id="3983452">c</span><span class="op" id="3983453">.</span><span class="ident" id="3983454">config</span><span class="op" id="3983460">.</span><span class="ident" id="3983461">NextProtos</span><span class="op" id="3983471">)</span><span class="op" id="3983472">;</span>&nbsp;<span class="op" id="3983474">!</span><span class="ident" id="3983475">fallback</span>&nbsp;<span class="op" id="3983484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983489">hs</span><span class="op" id="3983491">.</span><span class="ident" id="3983492">hello</span><span class="op" id="3983497">.</span><span class="ident" id="3983498">alpnProtocol</span>&nbsp;<span class="op" id="3983511">=</span>&nbsp;<span class="ident" id="3983513">selectedProto</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983530">c</span><span class="op" id="3983531">.</span><span class="ident" id="3983532">clientProtocol</span>&nbsp;<span class="op" id="3983547">=</span>&nbsp;<span class="ident" id="3983549">selectedProto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983568">}</span>&nbsp;<span class="keyword" id="3983570">else</span>&nbsp;<span class="op" id="3983575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983579">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983651">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983710">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983747">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983804">if</span>&nbsp;<span class="ident" id="3983807">hs</span><span class="op" id="3983809">.</span><span class="ident" id="3983810">clientHello</span><span class="op" id="3983821">.</span><span class="ident" id="3983822">nextProtoNeg</span>&nbsp;<span class="op" id="3983835">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3983838">len</span><span class="op" id="3983841">(</span><span class="ident" id="3983842">config</span><span class="op" id="3983848">.</span><span class="ident" id="3983849">NextProtos</span><span class="op" id="3983859">)</span>&nbsp;<span class="op" id="3983861">&gt;</span>&nbsp;<span class="num" id="3983863">0</span>&nbsp;<span class="op" id="3983865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983870">hs</span><span class="op" id="3983872">.</span><span class="ident" id="3983873">hello</span><span class="op" id="3983878">.</span><span class="ident" id="3983879">nextProtoNeg</span>&nbsp;<span class="op" id="3983892">=</span>&nbsp;<span class="ident" id="3983894">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983902">hs</span><span class="op" id="3983904">.</span><span class="ident" id="3983905">hello</span><span class="op" id="3983910">.</span><span class="ident" id="3983911">nextProtos</span>&nbsp;<span class="op" id="3983922">=</span>&nbsp;<span class="ident" id="3983924">config</span><span class="op" id="3983930">.</span><span class="ident" id="3983931">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983951">if</span>&nbsp;<span class="builtinfunc" id="3983954">len</span><span class="op" id="3983957">(</span><span class="ident" id="3983958">config</span><span class="op" id="3983964">.</span><span class="ident" id="3983965">Certificates</span><span class="op" id="3983977">)</span>&nbsp;<span class="op" id="3983979">==</span>&nbsp;<span class="num" id="3983982">0</span>&nbsp;<span class="op" id="3983984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983988">c</span><span class="op" id="3983989">.</span><span class="ident" id="3983990">sendAlert</span><span class="op" id="3983999">(</span><span class="ident" id="3984000">alertInternalError</span><span class="op" id="3984018">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984022">return</span>&nbsp;<span class="ident" id="3984029">false</span><span class="op" id="3984034">,</span>&nbsp;<span class="ident" id="3984036">errors</span><span class="op" id="3984042">.</span><span class="ident" id="3984043">New</span><span class="op" id="3984046">(</span><span class="string" id="3984047">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="3984080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984086">hs</span><span class="op" id="3984088">.</span><span class="ident" id="3984089">cert</span>&nbsp;<span class="op" id="3984094">=</span>&nbsp;<span class="op" id="3984096">&amp;</span><span class="ident" id="3984097">config</span><span class="op" id="3984103">.</span><span class="ident" id="3984104">Certificates</span><span class="op" id="3984116">[</span><span class="num" id="3984117">0</span><span class="op" id="3984118">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984121">if</span>&nbsp;<span class="builtinfunc" id="3984124">len</span><span class="op" id="3984127">(</span><span class="ident" id="3984128">hs</span><span class="op" id="3984130">.</span><span class="ident" id="3984131">clientHello</span><span class="op" id="3984142">.</span><span class="ident" id="3984143">serverName</span><span class="op" id="3984153">)</span>&nbsp;<span class="op" id="3984155">&gt;</span>&nbsp;<span class="num" id="3984157">0</span>&nbsp;<span class="op" id="3984159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984163">chi</span>&nbsp;<span class="op" id="3984167">:=</span>&nbsp;<span class="op" id="3984170">&amp;</span><span class="ident" id="3984171">ClientHelloInfo</span><span class="op" id="3984186">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984191">CipherSuites</span><span class="op" id="3984203">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3984208">hs</span><span class="op" id="3984210">.</span><span class="ident" id="3984211">clientHello</span><span class="op" id="3984222">.</span><span class="ident" id="3984223">cipherSuites</span><span class="op" id="3984235">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984240">ServerName</span><span class="op" id="3984250">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3984257">hs</span><span class="op" id="3984259">.</span><span class="ident" id="3984260">clientHello</span><span class="op" id="3984271">.</span><span class="ident" id="3984272">serverName</span><span class="op" id="3984282">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984287">SupportedCurves</span><span class="op" id="3984302">:</span>&nbsp;<span class="ident" id="3984304">hs</span><span class="op" id="3984306">.</span><span class="ident" id="3984307">clientHello</span><span class="op" id="3984318">.</span><span class="ident" id="3984319">supportedCurves</span><span class="op" id="3984334">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984339">SupportedPoints</span><span class="op" id="3984354">:</span>&nbsp;<span class="ident" id="3984356">hs</span><span class="op" id="3984358">.</span><span class="ident" id="3984359">clientHello</span><span class="op" id="3984370">.</span><span class="ident" id="3984371">supportedPoints</span><span class="op" id="3984386">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984390">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984394">if</span>&nbsp;<span class="ident" id="3984397">hs</span><span class="op" id="3984399">.</span><span class="ident" id="3984400">cert</span><span class="op" id="3984404">,</span>&nbsp;<span class="ident" id="3984406">err</span>&nbsp;<span class="op" id="3984410">=</span>&nbsp;<span class="ident" id="3984412">config</span><span class="op" id="3984418">.</span><span class="ident" id="3984419">getCertificate</span><span class="op" id="3984433">(</span><span class="ident" id="3984434">chi</span><span class="op" id="3984437">)</span><span class="op" id="3984438">;</span>&nbsp;<span class="ident" id="3984440">err</span>&nbsp;<span class="op" id="3984444">!=</span>&nbsp;<span class="ident" id="3984447">nil</span>&nbsp;<span class="op" id="3984451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984456">c</span><span class="op" id="3984457">.</span><span class="ident" id="3984458">sendAlert</span><span class="op" id="3984467">(</span><span class="ident" id="3984468">alertInternalError</span><span class="op" id="3984486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984491">return</span>&nbsp;<span class="ident" id="3984498">false</span><span class="op" id="3984503">,</span>&nbsp;<span class="ident" id="3984505">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984514">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984518">_</span><span class="op" id="3984519">,</span>&nbsp;<span class="ident" id="3984521">hs</span><span class="op" id="3984523">.</span><span class="ident" id="3984524">ecdsaOk</span>&nbsp;<span class="op" id="3984532">=</span>&nbsp;<span class="ident" id="3984534">hs</span><span class="op" id="3984536">.</span><span class="ident" id="3984537">cert</span><span class="op" id="3984541">.</span><span class="ident" id="3984542">PrivateKey</span><span class="op" id="3984552">.</span><span class="op" id="3984553">(</span><span class="op" id="3984554">*</span><span class="ident" id="3984555">ecdsa</span><span class="op" id="3984560">.</span><span class="ident" id="3984561">PrivateKey</span><span class="op" id="3984571">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984575">if</span>&nbsp;<span class="ident" id="3984578">hs</span><span class="op" id="3984580">.</span><span class="ident" id="3984581">checkForResumption</span><span class="op" id="3984599">(</span><span class="op" id="3984600">)</span>&nbsp;<span class="op" id="3984602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984606">return</span>&nbsp;<span class="ident" id="3984613">true</span><span class="op" id="3984617">,</span>&nbsp;<span class="ident" id="3984619">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984628">var</span>&nbsp;<span class="ident" id="3984632">preferenceList</span><span class="op" id="3984646">,</span>&nbsp;<span class="ident" id="3984648">supportedList</span>&nbsp;<span class="op" id="3984662">[</span><span class="op" id="3984663">]</span><span class="builtintype" id="3984664">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984672">if</span>&nbsp;<span class="ident" id="3984675">c</span><span class="op" id="3984676">.</span><span class="ident" id="3984677">config</span><span class="op" id="3984683">.</span><span class="ident" id="3984684">PreferServerCipherSuites</span>&nbsp;<span class="op" id="3984709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984713">preferenceList</span>&nbsp;<span class="op" id="3984728">=</span>&nbsp;<span class="ident" id="3984730">c</span><span class="op" id="3984731">.</span><span class="ident" id="3984732">config</span><span class="op" id="3984738">.</span><span class="ident" id="3984739">cipherSuites</span><span class="op" id="3984751">(</span><span class="op" id="3984752">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984756">supportedList</span>&nbsp;<span class="op" id="3984770">=</span>&nbsp;<span class="ident" id="3984772">hs</span><span class="op" id="3984774">.</span><span class="ident" id="3984775">clientHello</span><span class="op" id="3984786">.</span><span class="ident" id="3984787">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984801">}</span>&nbsp;<span class="keyword" id="3984803">else</span>&nbsp;<span class="op" id="3984808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984812">preferenceList</span>&nbsp;<span class="op" id="3984827">=</span>&nbsp;<span class="ident" id="3984829">hs</span><span class="op" id="3984831">.</span><span class="ident" id="3984832">clientHello</span><span class="op" id="3984843">.</span><span class="ident" id="3984844">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984859">supportedList</span>&nbsp;<span class="op" id="3984873">=</span>&nbsp;<span class="ident" id="3984875">c</span><span class="op" id="3984876">.</span><span class="ident" id="3984877">config</span><span class="op" id="3984883">.</span><span class="ident" id="3984884">cipherSuites</span><span class="op" id="3984896">(</span><span class="op" id="3984897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984900">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984904">for</span>&nbsp;<span class="ident" id="3984908">_</span><span class="op" id="3984909">,</span>&nbsp;<span class="ident" id="3984911">id</span>&nbsp;<span class="op" id="3984914">:=</span>&nbsp;<span class="keyword" id="3984917">range</span>&nbsp;<span class="ident" id="3984923">preferenceList</span>&nbsp;<span class="op" id="3984938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984942">if</span>&nbsp;<span class="ident" id="3984945">hs</span><span class="op" id="3984947">.</span><span class="ident" id="3984948">suite</span>&nbsp;<span class="op" id="3984954">=</span>&nbsp;<span class="ident" id="3984956">c</span><span class="op" id="3984957">.</span><span class="ident" id="3984958">tryCipherSuite</span><span class="op" id="3984972">(</span><span class="ident" id="3984973">id</span><span class="op" id="3984975">,</span>&nbsp;<span class="ident" id="3984977">supportedList</span><span class="op" id="3984990">,</span>&nbsp;<span class="ident" id="3984992">c</span><span class="op" id="3984993">.</span><span class="ident" id="3984994">vers</span><span class="op" id="3984998">,</span>&nbsp;<span class="ident" id="3985000">hs</span><span class="op" id="3985002">.</span><span class="ident" id="3985003">ellipticOk</span><span class="op" id="3985013">,</span>&nbsp;<span class="ident" id="3985015">hs</span><span class="op" id="3985017">.</span><span class="ident" id="3985018">ecdsaOk</span><span class="op" id="3985025">)</span><span class="op" id="3985026">;</span>&nbsp;<span class="ident" id="3985028">hs</span><span class="op" id="3985030">.</span><span class="ident" id="3985031">suite</span>&nbsp;<span class="op" id="3985037">!=</span>&nbsp;<span class="ident" id="3985040">nil</span>&nbsp;<span class="op" id="3985044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985049">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985057">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985064">if</span>&nbsp;<span class="ident" id="3985067">hs</span><span class="op" id="3985069">.</span><span class="ident" id="3985070">suite</span>&nbsp;<span class="op" id="3985076">==</span>&nbsp;<span class="ident" id="3985079">nil</span>&nbsp;<span class="op" id="3985083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3985087">c</span><span class="op" id="3985088">.</span><span class="ident" id="3985089">sendAlert</span><span class="op" id="3985098">(</span><span class="ident" id="3985099">alertHandshakeFailure</span><span class="op" id="3985120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985124">return</span>&nbsp;<span class="ident" id="3985131">false</span><span class="op" id="3985136">,</span>&nbsp;<span class="ident" id="3985138">errors</span><span class="op" id="3985144">.</span><span class="ident" id="3985145">New</span><span class="op" id="3985148">(</span><span class="string" id="3985149">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="3985207">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3985214">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985284">for</span>&nbsp;<span class="ident" id="3985288">_</span><span class="op" id="3985289">,</span>&nbsp;<span class="ident" id="3985291">id</span>&nbsp;<span class="op" id="3985294">:=</span>&nbsp;<span class="keyword" id="3985297">range</span>&nbsp;<span class="ident" id="3985303">hs</span><span class="op" id="3985305">.</span><span class="ident" id="3985306">clientHello</span><span class="op" id="3985317">.</span><span class="ident" id="3985318">cipherSuites</span>&nbsp;<span class="op" id="3985331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985335">if</span>&nbsp;<span class="ident" id="3985338">id</span>&nbsp;<span class="op" id="3985341">==</span>&nbsp;<span class="ident" id="3985344">TLS_FALLBACK_SCSV</span>&nbsp;<span class="op" id="3985362">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3985367">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985416">if</span>&nbsp;<span class="ident" id="3985419">hs</span><span class="op" id="3985421">.</span><span class="ident" id="3985422">clientHello</span><span class="op" id="3985433">.</span><span class="ident" id="3985434">vers</span>&nbsp;<span class="op" id="3985439">&lt;</span>&nbsp;<span class="ident" id="3985441">c</span><span class="op" id="3985442">.</span><span class="ident" id="3985443">config</span><span class="op" id="3985449">.</span><span class="ident" id="3985450">MaxVersion</span>&nbsp;<span class="op" id="3985461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3985467">c</span><span class="op" id="3985468">.</span><span class="ident" id="3985469">sendAlert</span><span class="op" id="3985478">(</span><span class="ident" id="3985479">alertInappropriateFallback</span><span class="op" id="3985505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985511">return</span>&nbsp;<span class="ident" id="3985518">false</span><span class="op" id="3985523">,</span>&nbsp;<span class="ident" id="3985525">errors</span><span class="op" id="3985531">.</span><span class="ident" id="3985532">New</span><span class="op" id="3985535">(</span><span class="string" id="3985536">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="3985586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985591">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985596">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985611">return</span>&nbsp;<span class="ident" id="3985618">false</span><span class="op" id="3985623">,</span>&nbsp;<span class="ident" id="3985625">nil</span><br>
<span class="lineno">240</span><span class="op" id="3985629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3985632">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3985719">func</span>&nbsp;<span class="op" id="3985724">(</span><span class="ident" id="3985725">hs</span>&nbsp;<span class="op" id="3985728">*</span><span class="ident" id="3985729">serverHandshakeState</span><span class="op" id="3985749">)</span>&nbsp;<span class="ident" id="3985751">checkForResumption</span><span class="op" id="3985769">(</span><span class="op" id="3985770">)</span>&nbsp;<span class="builtintype" id="3985772">bool</span>&nbsp;<span class="op" id="3985777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3985780">c</span>&nbsp;<span class="op" id="3985782">:=</span>&nbsp;<span class="ident" id="3985785">hs</span><span class="op" id="3985787">.</span><span class="ident" id="3985788">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985792">if</span>&nbsp;<span class="ident" id="3985795">c</span><span class="op" id="3985796">.</span><span class="ident" id="3985797">config</span><span class="op" id="3985803">.</span><span class="ident" id="3985804">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3985827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985831">return</span>&nbsp;<span class="ident" id="3985838">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985849">var</span>&nbsp;<span class="ident" id="3985853">ok</span>&nbsp;<span class="builtintype" id="3985856">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985862">if</span>&nbsp;<span class="ident" id="3985865">hs</span><span class="op" id="3985867">.</span><span class="ident" id="3985868">sessionState</span><span class="op" id="3985880">,</span>&nbsp;<span class="ident" id="3985882">ok</span>&nbsp;<span class="op" id="3985885">=</span>&nbsp;<span class="ident" id="3985887">c</span><span class="op" id="3985888">.</span><span class="ident" id="3985889">decryptTicket</span><span class="op" id="3985902">(</span><span class="ident" id="3985903">hs</span><span class="op" id="3985905">.</span><span class="ident" id="3985906">clientHello</span><span class="op" id="3985917">.</span><span class="ident" id="3985918">sessionTicket</span><span class="op" id="3985931">)</span><span class="op" id="3985932">;</span>&nbsp;<span class="op" id="3985934">!</span><span class="ident" id="3985935">ok</span>&nbsp;<span class="op" id="3985938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985942">return</span>&nbsp;<span class="ident" id="3985949">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985960">if</span>&nbsp;<span class="ident" id="3985963">hs</span><span class="op" id="3985965">.</span><span class="ident" id="3985966">sessionState</span><span class="op" id="3985978">.</span><span class="ident" id="3985979">vers</span>&nbsp;<span class="op" id="3985984">&gt;</span>&nbsp;<span class="ident" id="3985986">hs</span><span class="op" id="3985988">.</span><span class="ident" id="3985989">clientHello</span><span class="op" id="3986000">.</span><span class="ident" id="3986001">vers</span>&nbsp;<span class="op" id="3986006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986010">return</span>&nbsp;<span class="ident" id="3986017">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986027">if</span>&nbsp;<span class="ident" id="3986030">vers</span><span class="op" id="3986034">,</span>&nbsp;<span class="ident" id="3986036">ok</span>&nbsp;<span class="op" id="3986039">:=</span>&nbsp;<span class="ident" id="3986042">c</span><span class="op" id="3986043">.</span><span class="ident" id="3986044">config</span><span class="op" id="3986050">.</span><span class="ident" id="3986051">mutualVersion</span><span class="op" id="3986064">(</span><span class="ident" id="3986065">hs</span><span class="op" id="3986067">.</span><span class="ident" id="3986068">sessionState</span><span class="op" id="3986080">.</span><span class="ident" id="3986081">vers</span><span class="op" id="3986085">)</span><span class="op" id="3986086">;</span>&nbsp;<span class="op" id="3986088">!</span><span class="ident" id="3986089">ok</span>&nbsp;<span class="op" id="3986092">||</span>&nbsp;<span class="ident" id="3986095">vers</span>&nbsp;<span class="op" id="3986100">!=</span>&nbsp;<span class="ident" id="3986103">hs</span><span class="op" id="3986105">.</span><span class="ident" id="3986106">sessionState</span><span class="op" id="3986118">.</span><span class="ident" id="3986119">vers</span>&nbsp;<span class="op" id="3986124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986128">return</span>&nbsp;<span class="ident" id="3986135">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986146">cipherSuiteOk</span>&nbsp;<span class="op" id="3986160">:=</span>&nbsp;<span class="ident" id="3986163">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3986170">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986246">for</span>&nbsp;<span class="ident" id="3986250">_</span><span class="op" id="3986251">,</span>&nbsp;<span class="ident" id="3986253">id</span>&nbsp;<span class="op" id="3986256">:=</span>&nbsp;<span class="keyword" id="3986259">range</span>&nbsp;<span class="ident" id="3986265">hs</span><span class="op" id="3986267">.</span><span class="ident" id="3986268">clientHello</span><span class="op" id="3986279">.</span><span class="ident" id="3986280">cipherSuites</span>&nbsp;<span class="op" id="3986293">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986297">if</span>&nbsp;<span class="ident" id="3986300">id</span>&nbsp;<span class="op" id="3986303">==</span>&nbsp;<span class="ident" id="3986306">hs</span><span class="op" id="3986308">.</span><span class="ident" id="3986309">sessionState</span><span class="op" id="3986321">.</span><span class="ident" id="3986322">cipherSuite</span>&nbsp;<span class="op" id="3986334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986339">cipherSuiteOk</span>&nbsp;<span class="op" id="3986353">=</span>&nbsp;<span class="ident" id="3986355">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986363">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986374">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986377">if</span>&nbsp;<span class="op" id="3986380">!</span><span class="ident" id="3986381">cipherSuiteOk</span>&nbsp;<span class="op" id="3986395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986399">return</span>&nbsp;<span class="ident" id="3986406">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3986417">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986482">hs</span><span class="op" id="3986484">.</span><span class="ident" id="3986485">suite</span>&nbsp;<span class="op" id="3986491">=</span>&nbsp;<span class="ident" id="3986493">c</span><span class="op" id="3986494">.</span><span class="ident" id="3986495">tryCipherSuite</span><span class="op" id="3986509">(</span><span class="ident" id="3986510">hs</span><span class="op" id="3986512">.</span><span class="ident" id="3986513">sessionState</span><span class="op" id="3986525">.</span><span class="ident" id="3986526">cipherSuite</span><span class="op" id="3986537">,</span>&nbsp;<span class="ident" id="3986539">c</span><span class="op" id="3986540">.</span><span class="ident" id="3986541">config</span><span class="op" id="3986547">.</span><span class="ident" id="3986548">cipherSuites</span><span class="op" id="3986560">(</span><span class="op" id="3986561">)</span><span class="op" id="3986562">,</span>&nbsp;<span class="ident" id="3986564">hs</span><span class="op" id="3986566">.</span><span class="ident" id="3986567">sessionState</span><span class="op" id="3986579">.</span><span class="ident" id="3986580">vers</span><span class="op" id="3986584">,</span>&nbsp;<span class="ident" id="3986586">hs</span><span class="op" id="3986588">.</span><span class="ident" id="3986589">ellipticOk</span><span class="op" id="3986599">,</span>&nbsp;<span class="ident" id="3986601">hs</span><span class="op" id="3986603">.</span><span class="ident" id="3986604">ecdsaOk</span><span class="op" id="3986611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986614">if</span>&nbsp;<span class="ident" id="3986617">hs</span><span class="op" id="3986619">.</span><span class="ident" id="3986620">suite</span>&nbsp;<span class="op" id="3986626">==</span>&nbsp;<span class="ident" id="3986629">nil</span>&nbsp;<span class="op" id="3986633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986637">return</span>&nbsp;<span class="ident" id="3986644">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986655">sessionHasClientCerts</span>&nbsp;<span class="op" id="3986677">:=</span>&nbsp;<span class="builtinfunc" id="3986680">len</span><span class="op" id="3986683">(</span><span class="ident" id="3986684">hs</span><span class="op" id="3986686">.</span><span class="ident" id="3986687">sessionState</span><span class="op" id="3986699">.</span><span class="ident" id="3986700">certificates</span><span class="op" id="3986712">)</span>&nbsp;<span class="op" id="3986714">!=</span>&nbsp;<span class="num" id="3986717">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3986720">needClientCerts</span>&nbsp;<span class="op" id="3986736">:=</span>&nbsp;<span class="ident" id="3986739">c</span><span class="op" id="3986740">.</span><span class="ident" id="3986741">config</span><span class="op" id="3986747">.</span><span class="ident" id="3986748">ClientAuth</span>&nbsp;<span class="op" id="3986759">==</span>&nbsp;<span class="ident" id="3986762">RequireAnyClientCert</span>&nbsp;<span class="op" id="3986783">||</span>&nbsp;<span class="ident" id="3986786">c</span><span class="op" id="3986787">.</span><span class="ident" id="3986788">config</span><span class="op" id="3986794">.</span><span class="ident" id="3986795">ClientAuth</span>&nbsp;<span class="op" id="3986806">==</span>&nbsp;<span class="ident" id="3986809">RequireAndVerifyClientCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986837">if</span>&nbsp;<span class="ident" id="3986840">needClientCerts</span>&nbsp;<span class="op" id="3986856">&amp;&amp;</span>&nbsp;<span class="op" id="3986859">!</span><span class="ident" id="3986860">sessionHasClientCerts</span>&nbsp;<span class="op" id="3986882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986886">return</span>&nbsp;<span class="ident" id="3986893">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986900">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986903">if</span>&nbsp;<span class="ident" id="3986906">sessionHasClientCerts</span>&nbsp;<span class="op" id="3986928">&amp;&amp;</span>&nbsp;<span class="ident" id="3986931">c</span><span class="op" id="3986932">.</span><span class="ident" id="3986933">config</span><span class="op" id="3986939">.</span><span class="ident" id="3986940">ClientAuth</span>&nbsp;<span class="op" id="3986951">==</span>&nbsp;<span class="ident" id="3986954">NoClientCert</span>&nbsp;<span class="op" id="3986967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986971">return</span>&nbsp;<span class="ident" id="3986978">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986989">return</span>&nbsp;<span class="ident" id="3986996">true</span><br>
<span class="lineno">290</span><span class="op" id="3987001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3987004">func</span>&nbsp;<span class="op" id="3987009">(</span><span class="ident" id="3987010">hs</span>&nbsp;<span class="op" id="3987013">*</span><span class="ident" id="3987014">serverHandshakeState</span><span class="op" id="3987034">)</span>&nbsp;<span class="ident" id="3987036">doResumeHandshake</span><span class="op" id="3987053">(</span><span class="op" id="3987054">)</span>&nbsp;<span class="builtintype" id="3987056">error</span>&nbsp;<span class="op" id="3987062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987065">c</span>&nbsp;<span class="op" id="3987067">:=</span>&nbsp;<span class="ident" id="3987070">hs</span><span class="op" id="3987072">.</span><span class="ident" id="3987073">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987077">hs</span><span class="op" id="3987079">.</span><span class="ident" id="3987080">hello</span><span class="op" id="3987085">.</span><span class="ident" id="3987086">cipherSuite</span>&nbsp;<span class="op" id="3987098">=</span>&nbsp;<span class="ident" id="3987100">hs</span><span class="op" id="3987102">.</span><span class="ident" id="3987103">suite</span><span class="op" id="3987108">.</span><span class="ident" id="3987109">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3987113">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3987183">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987218">hs</span><span class="op" id="3987220">.</span><span class="ident" id="3987221">hello</span><span class="op" id="3987226">.</span><span class="ident" id="3987227">sessionId</span>&nbsp;<span class="op" id="3987237">=</span>&nbsp;<span class="ident" id="3987239">hs</span><span class="op" id="3987241">.</span><span class="ident" id="3987242">clientHello</span><span class="op" id="3987253">.</span><span class="ident" id="3987254">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987265">hs</span><span class="op" id="3987267">.</span><span class="ident" id="3987268">finishedHash</span><span class="op" id="3987280">.</span><span class="ident" id="3987281">Write</span><span class="op" id="3987286">(</span><span class="ident" id="3987287">hs</span><span class="op" id="3987289">.</span><span class="ident" id="3987290">hello</span><span class="op" id="3987295">.</span><span class="ident" id="3987296">marshal</span><span class="op" id="3987303">(</span><span class="op" id="3987304">)</span><span class="op" id="3987305">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987308">c</span><span class="op" id="3987309">.</span><span class="ident" id="3987310">writeRecord</span><span class="op" id="3987321">(</span><span class="ident" id="3987322">recordTypeHandshake</span><span class="op" id="3987341">,</span>&nbsp;<span class="ident" id="3987343">hs</span><span class="op" id="3987345">.</span><span class="ident" id="3987346">hello</span><span class="op" id="3987351">.</span><span class="ident" id="3987352">marshal</span><span class="op" id="3987359">(</span><span class="op" id="3987360">)</span><span class="op" id="3987361">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987365">if</span>&nbsp;<span class="builtinfunc" id="3987368">len</span><span class="op" id="3987371">(</span><span class="ident" id="3987372">hs</span><span class="op" id="3987374">.</span><span class="ident" id="3987375">sessionState</span><span class="op" id="3987387">.</span><span class="ident" id="3987388">certificates</span><span class="op" id="3987400">)</span>&nbsp;<span class="op" id="3987402">&gt;</span>&nbsp;<span class="num" id="3987404">0</span>&nbsp;<span class="op" id="3987406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987410">if</span>&nbsp;<span class="ident" id="3987413">_</span><span class="op" id="3987414">,</span>&nbsp;<span class="ident" id="3987416">err</span>&nbsp;<span class="op" id="3987420">:=</span>&nbsp;<span class="ident" id="3987423">hs</span><span class="op" id="3987425">.</span><span class="ident" id="3987426">processCertsFromClient</span><span class="op" id="3987448">(</span><span class="ident" id="3987449">hs</span><span class="op" id="3987451">.</span><span class="ident" id="3987452">sessionState</span><span class="op" id="3987464">.</span><span class="ident" id="3987465">certificates</span><span class="op" id="3987477">)</span><span class="op" id="3987478">;</span>&nbsp;<span class="ident" id="3987480">err</span>&nbsp;<span class="op" id="3987484">!=</span>&nbsp;<span class="ident" id="3987487">nil</span>&nbsp;<span class="op" id="3987491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987496">return</span>&nbsp;<span class="ident" id="3987503">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987516">hs</span><span class="op" id="3987518">.</span><span class="ident" id="3987519">masterSecret</span>&nbsp;<span class="op" id="3987532">=</span>&nbsp;<span class="ident" id="3987534">hs</span><span class="op" id="3987536">.</span><span class="ident" id="3987537">sessionState</span><span class="op" id="3987549">.</span><span class="ident" id="3987550">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987565">return</span>&nbsp;<span class="ident" id="3987572">nil</span><br>
<span class="lineno"></span><span class="op" id="3987576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3987579">func</span>&nbsp;<span class="op" id="3987584">(</span><span class="ident" id="3987585">hs</span>&nbsp;<span class="op" id="3987588">*</span><span class="ident" id="3987589">serverHandshakeState</span><span class="op" id="3987609">)</span>&nbsp;<span class="ident" id="3987611">doFullHandshake</span><span class="op" id="3987626">(</span><span class="op" id="3987627">)</span>&nbsp;<span class="builtintype" id="3987629">error</span>&nbsp;<span class="op" id="3987635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987638">config</span>&nbsp;<span class="op" id="3987645">:=</span>&nbsp;<span class="ident" id="3987648">hs</span><span class="op" id="3987650">.</span><span class="ident" id="3987651">c</span><span class="op" id="3987652">.</span><span class="ident" id="3987653">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987661">c</span>&nbsp;<span class="op" id="3987663">:=</span>&nbsp;<span class="ident" id="3987666">hs</span><span class="op" id="3987668">.</span><span class="ident" id="3987669">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987673">if</span>&nbsp;<span class="ident" id="3987676">hs</span><span class="op" id="3987678">.</span><span class="ident" id="3987679">clientHello</span><span class="op" id="3987690">.</span><span class="ident" id="3987691">ocspStapling</span>&nbsp;<span class="op" id="3987704">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3987707">len</span><span class="op" id="3987710">(</span><span class="ident" id="3987711">hs</span><span class="op" id="3987713">.</span><span class="ident" id="3987714">cert</span><span class="op" id="3987718">.</span><span class="ident" id="3987719">OCSPStaple</span><span class="op" id="3987729">)</span>&nbsp;<span class="op" id="3987731">&gt;</span>&nbsp;<span class="num" id="3987733">0</span>&nbsp;<span class="op" id="3987735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987739">hs</span><span class="op" id="3987741">.</span><span class="ident" id="3987742">hello</span><span class="op" id="3987747">.</span><span class="ident" id="3987748">ocspStapling</span>&nbsp;<span class="op" id="3987761">=</span>&nbsp;<span class="ident" id="3987763">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987769">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987773">hs</span><span class="op" id="3987775">.</span><span class="ident" id="3987776">hello</span><span class="op" id="3987781">.</span><span class="ident" id="3987782">ticketSupported</span>&nbsp;<span class="op" id="3987798">=</span>&nbsp;<span class="ident" id="3987800">hs</span><span class="op" id="3987802">.</span><span class="ident" id="3987803">clientHello</span><span class="op" id="3987814">.</span><span class="ident" id="3987815">ticketSupported</span>&nbsp;<span class="op" id="3987831">&amp;&amp;</span>&nbsp;<span class="op" id="3987834">!</span><span class="ident" id="3987835">config</span><span class="op" id="3987841">.</span><span class="ident" id="3987842">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987866">hs</span><span class="op" id="3987868">.</span><span class="ident" id="3987869">hello</span><span class="op" id="3987874">.</span><span class="ident" id="3987875">cipherSuite</span>&nbsp;<span class="op" id="3987887">=</span>&nbsp;<span class="ident" id="3987889">hs</span><span class="op" id="3987891">.</span><span class="ident" id="3987892">suite</span><span class="op" id="3987897">.</span><span class="ident" id="3987898">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987902">hs</span><span class="op" id="3987904">.</span><span class="ident" id="3987905">finishedHash</span><span class="op" id="3987917">.</span><span class="ident" id="3987918">Write</span><span class="op" id="3987923">(</span><span class="ident" id="3987924">hs</span><span class="op" id="3987926">.</span><span class="ident" id="3987927">hello</span><span class="op" id="3987932">.</span><span class="ident" id="3987933">marshal</span><span class="op" id="3987940">(</span><span class="op" id="3987941">)</span><span class="op" id="3987942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987945">c</span><span class="op" id="3987946">.</span><span class="ident" id="3987947">writeRecord</span><span class="op" id="3987958">(</span><span class="ident" id="3987959">recordTypeHandshake</span><span class="op" id="3987978">,</span>&nbsp;<span class="ident" id="3987980">hs</span><span class="op" id="3987982">.</span><span class="ident" id="3987983">hello</span><span class="op" id="3987988">.</span><span class="ident" id="3987989">marshal</span><span class="op" id="3987996">(</span><span class="op" id="3987997">)</span><span class="op" id="3987998">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988002">certMsg</span>&nbsp;<span class="op" id="3988010">:=</span>&nbsp;<span class="builtinfunc" id="3988013">new</span><span class="op" id="3988016">(</span><span class="ident" id="3988017">certificateMsg</span><span class="op" id="3988031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988034">certMsg</span><span class="op" id="3988041">.</span><span class="ident" id="3988042">certificates</span>&nbsp;<span class="op" id="3988055">=</span>&nbsp;<span class="ident" id="3988057">hs</span><span class="op" id="3988059">.</span><span class="ident" id="3988060">cert</span><span class="op" id="3988064">.</span><span class="ident" id="3988065">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988078">hs</span><span class="op" id="3988080">.</span><span class="ident" id="3988081">finishedHash</span><span class="op" id="3988093">.</span><span class="ident" id="3988094">Write</span><span class="op" id="3988099">(</span><span class="ident" id="3988100">certMsg</span><span class="op" id="3988107">.</span><span class="ident" id="3988108">marshal</span><span class="op" id="3988115">(</span><span class="op" id="3988116">)</span><span class="op" id="3988117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988120">c</span><span class="op" id="3988121">.</span><span class="ident" id="3988122">writeRecord</span><span class="op" id="3988133">(</span><span class="ident" id="3988134">recordTypeHandshake</span><span class="op" id="3988153">,</span>&nbsp;<span class="ident" id="3988155">certMsg</span><span class="op" id="3988162">.</span><span class="ident" id="3988163">marshal</span><span class="op" id="3988170">(</span><span class="op" id="3988171">)</span><span class="op" id="3988172">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988176">if</span>&nbsp;<span class="ident" id="3988179">hs</span><span class="op" id="3988181">.</span><span class="ident" id="3988182">hello</span><span class="op" id="3988187">.</span><span class="ident" id="3988188">ocspStapling</span>&nbsp;<span class="op" id="3988201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988205">certStatus</span>&nbsp;<span class="op" id="3988216">:=</span>&nbsp;<span class="builtinfunc" id="3988219">new</span><span class="op" id="3988222">(</span><span class="ident" id="3988223">certificateStatusMsg</span><span class="op" id="3988243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988247">certStatus</span><span class="op" id="3988257">.</span><span class="ident" id="3988258">statusType</span>&nbsp;<span class="op" id="3988269">=</span>&nbsp;<span class="ident" id="3988271">statusTypeOCSP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988288">certStatus</span><span class="op" id="3988298">.</span><span class="ident" id="3988299">response</span>&nbsp;<span class="op" id="3988308">=</span>&nbsp;<span class="ident" id="3988310">hs</span><span class="op" id="3988312">.</span><span class="ident" id="3988313">cert</span><span class="op" id="3988317">.</span><span class="ident" id="3988318">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988331">hs</span><span class="op" id="3988333">.</span><span class="ident" id="3988334">finishedHash</span><span class="op" id="3988346">.</span><span class="ident" id="3988347">Write</span><span class="op" id="3988352">(</span><span class="ident" id="3988353">certStatus</span><span class="op" id="3988363">.</span><span class="ident" id="3988364">marshal</span><span class="op" id="3988371">(</span><span class="op" id="3988372">)</span><span class="op" id="3988373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988377">c</span><span class="op" id="3988378">.</span><span class="ident" id="3988379">writeRecord</span><span class="op" id="3988390">(</span><span class="ident" id="3988391">recordTypeHandshake</span><span class="op" id="3988410">,</span>&nbsp;<span class="ident" id="3988412">certStatus</span><span class="op" id="3988422">.</span><span class="ident" id="3988423">marshal</span><span class="op" id="3988430">(</span><span class="op" id="3988431">)</span><span class="op" id="3988432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988439">keyAgreement</span>&nbsp;<span class="op" id="3988452">:=</span>&nbsp;<span class="ident" id="3988455">hs</span><span class="op" id="3988457">.</span><span class="ident" id="3988458">suite</span><span class="op" id="3988463">.</span><span class="ident" id="3988464">ka</span><span class="op" id="3988466">(</span><span class="ident" id="3988467">c</span><span class="op" id="3988468">.</span><span class="ident" id="3988469">vers</span><span class="op" id="3988473">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988476">skx</span><span class="op" id="3988479">,</span>&nbsp;<span class="ident" id="3988481">err</span>&nbsp;<span class="op" id="3988485">:=</span>&nbsp;<span class="ident" id="3988488">keyAgreement</span><span class="op" id="3988500">.</span><span class="ident" id="3988501">generateServerKeyExchange</span><span class="op" id="3988526">(</span><span class="ident" id="3988527">config</span><span class="op" id="3988533">,</span>&nbsp;<span class="ident" id="3988535">hs</span><span class="op" id="3988537">.</span><span class="ident" id="3988538">cert</span><span class="op" id="3988542">,</span>&nbsp;<span class="ident" id="3988544">hs</span><span class="op" id="3988546">.</span><span class="ident" id="3988547">clientHello</span><span class="op" id="3988558">,</span>&nbsp;<span class="ident" id="3988560">hs</span><span class="op" id="3988562">.</span><span class="ident" id="3988563">hello</span><span class="op" id="3988568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988571">if</span>&nbsp;<span class="ident" id="3988574">err</span>&nbsp;<span class="op" id="3988578">!=</span>&nbsp;<span class="ident" id="3988581">nil</span>&nbsp;<span class="op" id="3988585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988589">c</span><span class="op" id="3988590">.</span><span class="ident" id="3988591">sendAlert</span><span class="op" id="3988600">(</span><span class="ident" id="3988601">alertHandshakeFailure</span><span class="op" id="3988622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988626">return</span>&nbsp;<span class="ident" id="3988633">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988638">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988641">if</span>&nbsp;<span class="ident" id="3988644">skx</span>&nbsp;<span class="op" id="3988648">!=</span>&nbsp;<span class="ident" id="3988651">nil</span>&nbsp;<span class="op" id="3988655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988659">hs</span><span class="op" id="3988661">.</span><span class="ident" id="3988662">finishedHash</span><span class="op" id="3988674">.</span><span class="ident" id="3988675">Write</span><span class="op" id="3988680">(</span><span class="ident" id="3988681">skx</span><span class="op" id="3988684">.</span><span class="ident" id="3988685">marshal</span><span class="op" id="3988692">(</span><span class="op" id="3988693">)</span><span class="op" id="3988694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988698">c</span><span class="op" id="3988699">.</span><span class="ident" id="3988700">writeRecord</span><span class="op" id="3988711">(</span><span class="ident" id="3988712">recordTypeHandshake</span><span class="op" id="3988731">,</span>&nbsp;<span class="ident" id="3988733">skx</span><span class="op" id="3988736">.</span><span class="ident" id="3988737">marshal</span><span class="op" id="3988744">(</span><span class="op" id="3988745">)</span><span class="op" id="3988746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988753">if</span>&nbsp;<span class="ident" id="3988756">config</span><span class="op" id="3988762">.</span><span class="ident" id="3988763">ClientAuth</span>&nbsp;<span class="op" id="3988774">&gt;=</span>&nbsp;<span class="ident" id="3988777">RequestClientCert</span>&nbsp;<span class="op" id="3988795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3988799">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988833">certReq</span>&nbsp;<span class="op" id="3988841">:=</span>&nbsp;<span class="builtinfunc" id="3988844">new</span><span class="op" id="3988847">(</span><span class="ident" id="3988848">certificateRequestMsg</span><span class="op" id="3988869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988873">certReq</span><span class="op" id="3988880">.</span><span class="ident" id="3988881">certificateTypes</span>&nbsp;<span class="op" id="3988898">=</span>&nbsp;<span class="op" id="3988900">[</span><span class="op" id="3988901">]</span><span class="builtintype" id="3988902">byte</span><span class="op" id="3988906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3988911">byte</span><span class="op" id="3988915">(</span><span class="ident" id="3988916">certTypeRSASign</span><span class="op" id="3988931">)</span><span class="op" id="3988932">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3988937">byte</span><span class="op" id="3988941">(</span><span class="ident" id="3988942">certTypeECDSASign</span><span class="op" id="3988959">)</span><span class="op" id="3988960">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3988964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988968">if</span>&nbsp;<span class="ident" id="3988971">c</span><span class="op" id="3988972">.</span><span class="ident" id="3988973">vers</span>&nbsp;<span class="op" id="3988978">&gt;=</span>&nbsp;<span class="ident" id="3988981">VersionTLS12</span>&nbsp;<span class="op" id="3988994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988999">certReq</span><span class="op" id="3989006">.</span><span class="ident" id="3989007">hasSignatureAndHash</span>&nbsp;<span class="op" id="3989027">=</span>&nbsp;<span class="ident" id="3989029">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989037">certReq</span><span class="op" id="3989044">.</span><span class="ident" id="3989045">signatureAndHashes</span>&nbsp;<span class="op" id="3989064">=</span>&nbsp;<span class="ident" id="3989066">supportedClientCertSignatureAlgorithms</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3989107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989112">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989168">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989229">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989286">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989344">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989391">if</span>&nbsp;<span class="ident" id="3989394">config</span><span class="op" id="3989400">.</span><span class="ident" id="3989401">ClientCAs</span>&nbsp;<span class="op" id="3989411">!=</span>&nbsp;<span class="ident" id="3989414">nil</span>&nbsp;<span class="op" id="3989418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989423">certReq</span><span class="op" id="3989430">.</span><span class="ident" id="3989431">certificateAuthorities</span>&nbsp;<span class="op" id="3989454">=</span>&nbsp;<span class="ident" id="3989456">config</span><span class="op" id="3989462">.</span><span class="ident" id="3989463">ClientCAs</span><span class="op" id="3989472">.</span><span class="ident" id="3989473">Subjects</span><span class="op" id="3989481">(</span><span class="op" id="3989482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3989486">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989490">hs</span><span class="op" id="3989492">.</span><span class="ident" id="3989493">finishedHash</span><span class="op" id="3989505">.</span><span class="ident" id="3989506">Write</span><span class="op" id="3989511">(</span><span class="ident" id="3989512">certReq</span><span class="op" id="3989519">.</span><span class="ident" id="3989520">marshal</span><span class="op" id="3989527">(</span><span class="op" id="3989528">)</span><span class="op" id="3989529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989533">c</span><span class="op" id="3989534">.</span><span class="ident" id="3989535">writeRecord</span><span class="op" id="3989546">(</span><span class="ident" id="3989547">recordTypeHandshake</span><span class="op" id="3989566">,</span>&nbsp;<span class="ident" id="3989568">certReq</span><span class="op" id="3989575">.</span><span class="ident" id="3989576">marshal</span><span class="op" id="3989583">(</span><span class="op" id="3989584">)</span><span class="op" id="3989585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3989588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989592">helloDone</span>&nbsp;<span class="op" id="3989602">:=</span>&nbsp;<span class="builtinfunc" id="3989605">new</span><span class="op" id="3989608">(</span><span class="ident" id="3989609">serverHelloDoneMsg</span><span class="op" id="3989627">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989630">hs</span><span class="op" id="3989632">.</span><span class="ident" id="3989633">finishedHash</span><span class="op" id="3989645">.</span><span class="ident" id="3989646">Write</span><span class="op" id="3989651">(</span><span class="ident" id="3989652">helloDone</span><span class="op" id="3989661">.</span><span class="ident" id="3989662">marshal</span><span class="op" id="3989669">(</span><span class="op" id="3989670">)</span><span class="op" id="3989671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989674">c</span><span class="op" id="3989675">.</span><span class="ident" id="3989676">writeRecord</span><span class="op" id="3989687">(</span><span class="ident" id="3989688">recordTypeHandshake</span><span class="op" id="3989707">,</span>&nbsp;<span class="ident" id="3989709">helloDone</span><span class="op" id="3989718">.</span><span class="ident" id="3989719">marshal</span><span class="op" id="3989726">(</span><span class="op" id="3989727">)</span><span class="op" id="3989728">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989732">var</span>&nbsp;<span class="ident" id="3989736">pub</span>&nbsp;<span class="ident" id="3989740">crypto</span><span class="op" id="3989746">.</span><span class="ident" id="3989747">PublicKey</span>&nbsp;<span class="comment" id="3989757">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989797">msg</span><span class="op" id="3989800">,</span>&nbsp;<span class="ident" id="3989802">err</span>&nbsp;<span class="op" id="3989806">:=</span>&nbsp;<span class="ident" id="3989809">c</span><span class="op" id="3989810">.</span><span class="ident" id="3989811">readHandshake</span><span class="op" id="3989824">(</span><span class="op" id="3989825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989828">if</span>&nbsp;<span class="ident" id="3989831">err</span>&nbsp;<span class="op" id="3989835">!=</span>&nbsp;<span class="ident" id="3989838">nil</span>&nbsp;<span class="op" id="3989842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989846">return</span>&nbsp;<span class="ident" id="3989853">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3989858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989862">var</span>&nbsp;<span class="ident" id="3989866">ok</span>&nbsp;<span class="builtintype" id="3989869">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989875">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989945">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989990">if</span>&nbsp;<span class="ident" id="3989993">config</span><span class="op" id="3989999">.</span><span class="ident" id="3990000">ClientAuth</span>&nbsp;<span class="op" id="3990011">&gt;=</span>&nbsp;<span class="ident" id="3990014">RequestClientCert</span>&nbsp;<span class="op" id="3990032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990036">if</span>&nbsp;<span class="ident" id="3990039">certMsg</span><span class="op" id="3990046">,</span>&nbsp;<span class="ident" id="3990048">ok</span>&nbsp;<span class="op" id="3990051">=</span>&nbsp;<span class="ident" id="3990053">msg</span><span class="op" id="3990056">.</span><span class="op" id="3990057">(</span><span class="op" id="3990058">*</span><span class="ident" id="3990059">certificateMsg</span><span class="op" id="3990073">)</span><span class="op" id="3990074">;</span>&nbsp;<span class="op" id="3990076">!</span><span class="ident" id="3990077">ok</span>&nbsp;<span class="op" id="3990080">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990085">c</span><span class="op" id="3990086">.</span><span class="ident" id="3990087">sendAlert</span><span class="op" id="3990096">(</span><span class="ident" id="3990097">alertUnexpectedMessage</span><span class="op" id="3990119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990124">return</span>&nbsp;<span class="ident" id="3990131">unexpectedMessageError</span><span class="op" id="3990153">(</span><span class="ident" id="3990154">certMsg</span><span class="op" id="3990161">,</span>&nbsp;<span class="ident" id="3990163">msg</span><span class="op" id="3990166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990174">hs</span><span class="op" id="3990176">.</span><span class="ident" id="3990177">finishedHash</span><span class="op" id="3990189">.</span><span class="ident" id="3990190">Write</span><span class="op" id="3990195">(</span><span class="ident" id="3990196">certMsg</span><span class="op" id="3990203">.</span><span class="ident" id="3990204">marshal</span><span class="op" id="3990211">(</span><span class="op" id="3990212">)</span><span class="op" id="3990213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990218">if</span>&nbsp;<span class="builtinfunc" id="3990221">len</span><span class="op" id="3990224">(</span><span class="ident" id="3990225">certMsg</span><span class="op" id="3990232">.</span><span class="ident" id="3990233">certificates</span><span class="op" id="3990245">)</span>&nbsp;<span class="op" id="3990247">==</span>&nbsp;<span class="num" id="3990250">0</span>&nbsp;<span class="op" id="3990252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3990257">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990309">switch</span>&nbsp;<span class="ident" id="3990316">config</span><span class="op" id="3990322">.</span><span class="ident" id="3990323">ClientAuth</span>&nbsp;<span class="op" id="3990334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990339">case</span>&nbsp;<span class="ident" id="3990344">RequireAnyClientCert</span><span class="op" id="3990364">,</span>&nbsp;<span class="ident" id="3990366">RequireAndVerifyClientCert</span><span class="op" id="3990392">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990398">c</span><span class="op" id="3990399">.</span><span class="ident" id="3990400">sendAlert</span><span class="op" id="3990409">(</span><span class="ident" id="3990410">alertBadCertificate</span><span class="op" id="3990429">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990435">return</span>&nbsp;<span class="ident" id="3990442">errors</span><span class="op" id="3990448">.</span><span class="ident" id="3990449">New</span><span class="op" id="3990452">(</span><span class="string" id="3990453">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="3990495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990509">pub</span><span class="op" id="3990512">,</span>&nbsp;<span class="ident" id="3990514">err</span>&nbsp;<span class="op" id="3990518">=</span>&nbsp;<span class="ident" id="3990520">hs</span><span class="op" id="3990522">.</span><span class="ident" id="3990523">processCertsFromClient</span><span class="op" id="3990545">(</span><span class="ident" id="3990546">certMsg</span><span class="op" id="3990553">.</span><span class="ident" id="3990554">certificates</span><span class="op" id="3990566">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990570">if</span>&nbsp;<span class="ident" id="3990573">err</span>&nbsp;<span class="op" id="3990577">!=</span>&nbsp;<span class="ident" id="3990580">nil</span>&nbsp;<span class="op" id="3990584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990589">return</span>&nbsp;<span class="ident" id="3990596">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990607">msg</span><span class="op" id="3990610">,</span>&nbsp;<span class="ident" id="3990612">err</span>&nbsp;<span class="op" id="3990616">=</span>&nbsp;<span class="ident" id="3990618">c</span><span class="op" id="3990619">.</span><span class="ident" id="3990620">readHandshake</span><span class="op" id="3990633">(</span><span class="op" id="3990634">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990638">if</span>&nbsp;<span class="ident" id="3990641">err</span>&nbsp;<span class="op" id="3990645">!=</span>&nbsp;<span class="ident" id="3990648">nil</span>&nbsp;<span class="op" id="3990652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990657">return</span>&nbsp;<span class="ident" id="3990664">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3990677">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990705">ckx</span><span class="op" id="3990708">,</span>&nbsp;<span class="ident" id="3990710">ok</span>&nbsp;<span class="op" id="3990713">:=</span>&nbsp;<span class="ident" id="3990716">msg</span><span class="op" id="3990719">.</span><span class="op" id="3990720">(</span><span class="op" id="3990721">*</span><span class="ident" id="3990722">clientKeyExchangeMsg</span><span class="op" id="3990742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990745">if</span>&nbsp;<span class="op" id="3990748">!</span><span class="ident" id="3990749">ok</span>&nbsp;<span class="op" id="3990752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990756">c</span><span class="op" id="3990757">.</span><span class="ident" id="3990758">sendAlert</span><span class="op" id="3990767">(</span><span class="ident" id="3990768">alertUnexpectedMessage</span><span class="op" id="3990790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990794">return</span>&nbsp;<span class="ident" id="3990801">unexpectedMessageError</span><span class="op" id="3990823">(</span><span class="ident" id="3990824">ckx</span><span class="op" id="3990827">,</span>&nbsp;<span class="ident" id="3990829">msg</span><span class="op" id="3990832">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990838">hs</span><span class="op" id="3990840">.</span><span class="ident" id="3990841">finishedHash</span><span class="op" id="3990853">.</span><span class="ident" id="3990854">Write</span><span class="op" id="3990859">(</span><span class="ident" id="3990860">ckx</span><span class="op" id="3990863">.</span><span class="ident" id="3990864">marshal</span><span class="op" id="3990871">(</span><span class="op" id="3990872">)</span><span class="op" id="3990873">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3990877">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3990958">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3991031">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3991100">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3991180">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3991260">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991314">if</span>&nbsp;<span class="builtinfunc" id="3991317">len</span><span class="op" id="3991320">(</span><span class="ident" id="3991321">c</span><span class="op" id="3991322">.</span><span class="ident" id="3991323">peerCertificates</span><span class="op" id="3991339">)</span>&nbsp;<span class="op" id="3991341">&gt;</span>&nbsp;<span class="num" id="3991343">0</span>&nbsp;<span class="op" id="3991345">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991349">msg</span><span class="op" id="3991352">,</span>&nbsp;<span class="ident" id="3991354">err</span>&nbsp;<span class="op" id="3991358">=</span>&nbsp;<span class="ident" id="3991360">c</span><span class="op" id="3991361">.</span><span class="ident" id="3991362">readHandshake</span><span class="op" id="3991375">(</span><span class="op" id="3991376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991380">if</span>&nbsp;<span class="ident" id="3991383">err</span>&nbsp;<span class="op" id="3991387">!=</span>&nbsp;<span class="ident" id="3991390">nil</span>&nbsp;<span class="op" id="3991394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991399">return</span>&nbsp;<span class="ident" id="3991406">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3991412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991416">certVerify</span><span class="op" id="3991426">,</span>&nbsp;<span class="ident" id="3991428">ok</span>&nbsp;<span class="op" id="3991431">:=</span>&nbsp;<span class="ident" id="3991434">msg</span><span class="op" id="3991437">.</span><span class="op" id="3991438">(</span><span class="op" id="3991439">*</span><span class="ident" id="3991440">certificateVerifyMsg</span><span class="op" id="3991460">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991464">if</span>&nbsp;<span class="op" id="3991467">!</span><span class="ident" id="3991468">ok</span>&nbsp;<span class="op" id="3991471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991476">c</span><span class="op" id="3991477">.</span><span class="ident" id="3991478">sendAlert</span><span class="op" id="3991487">(</span><span class="ident" id="3991488">alertUnexpectedMessage</span><span class="op" id="3991510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991515">return</span>&nbsp;<span class="ident" id="3991522">unexpectedMessageError</span><span class="op" id="3991544">(</span><span class="ident" id="3991545">certVerify</span><span class="op" id="3991555">,</span>&nbsp;<span class="ident" id="3991557">msg</span><span class="op" id="3991560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3991564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991569">switch</span>&nbsp;<span class="ident" id="3991576">key</span>&nbsp;<span class="op" id="3991580">:=</span>&nbsp;<span class="ident" id="3991583">pub</span><span class="op" id="3991586">.</span><span class="op" id="3991587">(</span><span class="keyword" id="3991588">type</span><span class="op" id="3991592">)</span>&nbsp;<span class="op" id="3991594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991598">case</span>&nbsp;<span class="op" id="3991603">*</span><span class="ident" id="3991604">ecdsa</span><span class="op" id="3991609">.</span><span class="ident" id="3991610">PublicKey</span><span class="op" id="3991619">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991624">ecdsaSig</span>&nbsp;<span class="op" id="3991633">:=</span>&nbsp;<span class="builtinfunc" id="3991636">new</span><span class="op" id="3991639">(</span><span class="ident" id="3991640">ecdsaSignature</span><span class="op" id="3991654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991659">if</span>&nbsp;<span class="ident" id="3991662">_</span><span class="op" id="3991663">,</span>&nbsp;<span class="ident" id="3991665">err</span>&nbsp;<span class="op" id="3991669">=</span>&nbsp;<span class="ident" id="3991671">asn1</span><span class="op" id="3991675">.</span><span class="ident" id="3991676">Unmarshal</span><span class="op" id="3991685">(</span><span class="ident" id="3991686">certVerify</span><span class="op" id="3991696">.</span><span class="ident" id="3991697">signature</span><span class="op" id="3991706">,</span>&nbsp;<span class="ident" id="3991708">ecdsaSig</span><span class="op" id="3991716">)</span><span class="op" id="3991717">;</span>&nbsp;<span class="ident" id="3991719">err</span>&nbsp;<span class="op" id="3991723">!=</span>&nbsp;<span class="ident" id="3991726">nil</span>&nbsp;<span class="op" id="3991730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991736">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3991745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991750">if</span>&nbsp;<span class="ident" id="3991753">ecdsaSig</span><span class="op" id="3991761">.</span><span class="ident" id="3991762">R</span><span class="op" id="3991763">.</span><span class="ident" id="3991764">Sign</span><span class="op" id="3991768">(</span><span class="op" id="3991769">)</span>&nbsp;<span class="op" id="3991771">&lt;=</span>&nbsp;<span class="num" id="3991774">0</span>&nbsp;<span class="op" id="3991776">||</span>&nbsp;<span class="ident" id="3991779">ecdsaSig</span><span class="op" id="3991787">.</span><span class="ident" id="3991788">S</span><span class="op" id="3991789">.</span><span class="ident" id="3991790">Sign</span><span class="op" id="3991794">(</span><span class="op" id="3991795">)</span>&nbsp;<span class="op" id="3991797">&lt;=</span>&nbsp;<span class="num" id="3991800">0</span>&nbsp;<span class="op" id="3991802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991808">err</span>&nbsp;<span class="op" id="3991812">=</span>&nbsp;<span class="ident" id="3991814">errors</span><span class="op" id="3991820">.</span><span class="ident" id="3991821">New</span><span class="op" id="3991824">(</span><span class="string" id="3991825">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="3991876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991882">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3991891">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991896">digest</span><span class="op" id="3991902">,</span>&nbsp;<span class="ident" id="3991904">_</span><span class="op" id="3991905">,</span>&nbsp;<span class="ident" id="3991907">_</span>&nbsp;<span class="op" id="3991909">:=</span>&nbsp;<span class="ident" id="3991912">hs</span><span class="op" id="3991914">.</span><span class="ident" id="3991915">finishedHash</span><span class="op" id="3991927">.</span><span class="ident" id="3991928">hashForClientCertificate</span><span class="op" id="3991952">(</span><span class="ident" id="3991953">signatureECDSA</span><span class="op" id="3991967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991972">if</span>&nbsp;<span class="op" id="3991975">!</span><span class="ident" id="3991976">ecdsa</span><span class="op" id="3991981">.</span><span class="ident" id="3991982">Verify</span><span class="op" id="3991988">(</span><span class="ident" id="3991989">key</span><span class="op" id="3991992">,</span>&nbsp;<span class="ident" id="3991994">digest</span><span class="op" id="3992000">,</span>&nbsp;<span class="ident" id="3992002">ecdsaSig</span><span class="op" id="3992010">.</span><span class="ident" id="3992011">R</span><span class="op" id="3992012">,</span>&nbsp;<span class="ident" id="3992014">ecdsaSig</span><span class="op" id="3992022">.</span><span class="ident" id="3992023">S</span><span class="op" id="3992024">)</span>&nbsp;<span class="op" id="3992026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992032">err</span>&nbsp;<span class="op" id="3992036">=</span>&nbsp;<span class="ident" id="3992038">errors</span><span class="op" id="3992044">.</span><span class="ident" id="3992045">New</span><span class="op" id="3992048">(</span><span class="string" id="3992049">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="3992077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992083">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992092">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992096">case</span>&nbsp;<span class="op" id="3992101">*</span><span class="ident" id="3992102">rsa</span><span class="op" id="3992105">.</span><span class="ident" id="3992106">PublicKey</span><span class="op" id="3992115">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992120">digest</span><span class="op" id="3992126">,</span>&nbsp;<span class="ident" id="3992128">hashFunc</span><span class="op" id="3992136">,</span>&nbsp;<span class="ident" id="3992138">_</span>&nbsp;<span class="op" id="3992140">:=</span>&nbsp;<span class="ident" id="3992143">hs</span><span class="op" id="3992145">.</span><span class="ident" id="3992146">finishedHash</span><span class="op" id="3992158">.</span><span class="ident" id="3992159">hashForClientCertificate</span><span class="op" id="3992183">(</span><span class="ident" id="3992184">signatureRSA</span><span class="op" id="3992196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992201">err</span>&nbsp;<span class="op" id="3992205">=</span>&nbsp;<span class="ident" id="3992207">rsa</span><span class="op" id="3992210">.</span><span class="ident" id="3992211">VerifyPKCS1v15</span><span class="op" id="3992225">(</span><span class="ident" id="3992226">key</span><span class="op" id="3992229">,</span>&nbsp;<span class="ident" id="3992231">hashFunc</span><span class="op" id="3992239">,</span>&nbsp;<span class="ident" id="3992241">digest</span><span class="op" id="3992247">,</span>&nbsp;<span class="ident" id="3992249">certVerify</span><span class="op" id="3992259">.</span><span class="ident" id="3992260">signature</span><span class="op" id="3992269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992277">if</span>&nbsp;<span class="ident" id="3992280">err</span>&nbsp;<span class="op" id="3992284">!=</span>&nbsp;<span class="ident" id="3992287">nil</span>&nbsp;<span class="op" id="3992291">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992296">c</span><span class="op" id="3992297">.</span><span class="ident" id="3992298">sendAlert</span><span class="op" id="3992307">(</span><span class="ident" id="3992308">alertBadCertificate</span><span class="op" id="3992327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992332">return</span>&nbsp;<span class="ident" id="3992339">errors</span><span class="op" id="3992345">.</span><span class="ident" id="3992346">New</span><span class="op" id="3992349">(</span><span class="string" id="3992350">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="3992404">+</span>&nbsp;<span class="ident" id="3992406">err</span><span class="op" id="3992409">.</span><span class="ident" id="3992410">Error</span><span class="op" id="3992415">(</span><span class="op" id="3992416">)</span><span class="op" id="3992417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992426">hs</span><span class="op" id="3992428">.</span><span class="ident" id="3992429">finishedHash</span><span class="op" id="3992441">.</span><span class="ident" id="3992442">Write</span><span class="op" id="3992447">(</span><span class="ident" id="3992448">certVerify</span><span class="op" id="3992458">.</span><span class="ident" id="3992459">marshal</span><span class="op" id="3992466">(</span><span class="op" id="3992467">)</span><span class="op" id="3992468">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992475">preMasterSecret</span><span class="op" id="3992490">,</span>&nbsp;<span class="ident" id="3992492">err</span>&nbsp;<span class="op" id="3992496">:=</span>&nbsp;<span class="ident" id="3992499">keyAgreement</span><span class="op" id="3992511">.</span><span class="ident" id="3992512">processClientKeyExchange</span><span class="op" id="3992536">(</span><span class="ident" id="3992537">config</span><span class="op" id="3992543">,</span>&nbsp;<span class="ident" id="3992545">hs</span><span class="op" id="3992547">.</span><span class="ident" id="3992548">cert</span><span class="op" id="3992552">,</span>&nbsp;<span class="ident" id="3992554">ckx</span><span class="op" id="3992557">,</span>&nbsp;<span class="ident" id="3992559">c</span><span class="op" id="3992560">.</span><span class="ident" id="3992561">vers</span><span class="op" id="3992565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992568">if</span>&nbsp;<span class="ident" id="3992571">err</span>&nbsp;<span class="op" id="3992575">!=</span>&nbsp;<span class="ident" id="3992578">nil</span>&nbsp;<span class="op" id="3992582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992586">c</span><span class="op" id="3992587">.</span><span class="ident" id="3992588">sendAlert</span><span class="op" id="3992597">(</span><span class="ident" id="3992598">alertHandshakeFailure</span><span class="op" id="3992619">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992623">return</span>&nbsp;<span class="ident" id="3992630">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992638">hs</span><span class="op" id="3992640">.</span><span class="ident" id="3992641">masterSecret</span>&nbsp;<span class="op" id="3992654">=</span>&nbsp;<span class="ident" id="3992656">masterFromPreMasterSecret</span><span class="op" id="3992681">(</span><span class="ident" id="3992682">c</span><span class="op" id="3992683">.</span><span class="ident" id="3992684">vers</span><span class="op" id="3992688">,</span>&nbsp;<span class="ident" id="3992690">preMasterSecret</span><span class="op" id="3992705">,</span>&nbsp;<span class="ident" id="3992707">hs</span><span class="op" id="3992709">.</span><span class="ident" id="3992710">clientHello</span><span class="op" id="3992721">.</span><span class="ident" id="3992722">random</span><span class="op" id="3992728">,</span>&nbsp;<span class="ident" id="3992730">hs</span><span class="op" id="3992732">.</span><span class="ident" id="3992733">hello</span><span class="op" id="3992738">.</span><span class="ident" id="3992739">random</span><span class="op" id="3992745">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992749">return</span>&nbsp;<span class="ident" id="3992756">nil</span><br>
<span class="lineno">475</span><span class="op" id="3992760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3992763">func</span>&nbsp;<span class="op" id="3992768">(</span><span class="ident" id="3992769">hs</span>&nbsp;<span class="op" id="3992772">*</span><span class="ident" id="3992773">serverHandshakeState</span><span class="op" id="3992793">)</span>&nbsp;<span class="ident" id="3992795">establishKeys</span><span class="op" id="3992808">(</span><span class="op" id="3992809">)</span>&nbsp;<span class="builtintype" id="3992811">error</span>&nbsp;<span class="op" id="3992817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992820">c</span>&nbsp;<span class="op" id="3992822">:=</span>&nbsp;<span class="ident" id="3992825">hs</span><span class="op" id="3992827">.</span><span class="ident" id="3992828">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992832">clientMAC</span><span class="op" id="3992841">,</span>&nbsp;<span class="ident" id="3992843">serverMAC</span><span class="op" id="3992852">,</span>&nbsp;<span class="ident" id="3992854">clientKey</span><span class="op" id="3992863">,</span>&nbsp;<span class="ident" id="3992865">serverKey</span><span class="op" id="3992874">,</span>&nbsp;<span class="ident" id="3992876">clientIV</span><span class="op" id="3992884">,</span>&nbsp;<span class="ident" id="3992886">serverIV</span>&nbsp;<span class="op" id="3992895">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992900">keysFromMasterSecret</span><span class="op" id="3992920">(</span><span class="ident" id="3992921">c</span><span class="op" id="3992922">.</span><span class="ident" id="3992923">vers</span><span class="op" id="3992927">,</span>&nbsp;<span class="ident" id="3992929">hs</span><span class="op" id="3992931">.</span><span class="ident" id="3992932">masterSecret</span><span class="op" id="3992944">,</span>&nbsp;<span class="ident" id="3992946">hs</span><span class="op" id="3992948">.</span><span class="ident" id="3992949">clientHello</span><span class="op" id="3992960">.</span><span class="ident" id="3992961">random</span><span class="op" id="3992967">,</span>&nbsp;<span class="ident" id="3992969">hs</span><span class="op" id="3992971">.</span><span class="ident" id="3992972">hello</span><span class="op" id="3992977">.</span><span class="ident" id="3992978">random</span><span class="op" id="3992984">,</span>&nbsp;<span class="ident" id="3992986">hs</span><span class="op" id="3992988">.</span><span class="ident" id="3992989">suite</span><span class="op" id="3992994">.</span><span class="ident" id="3992995">macLen</span><span class="op" id="3993001">,</span>&nbsp;<span class="ident" id="3993003">hs</span><span class="op" id="3993005">.</span><span class="ident" id="3993006">suite</span><span class="op" id="3993011">.</span><span class="ident" id="3993012">keyLen</span><span class="op" id="3993018">,</span>&nbsp;<span class="ident" id="3993020">hs</span><span class="op" id="3993022">.</span><span class="ident" id="3993023">suite</span><span class="op" id="3993028">.</span><span class="ident" id="3993029">ivLen</span><span class="op" id="3993034">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993038">var</span>&nbsp;<span class="ident" id="3993042">clientCipher</span><span class="op" id="3993054">,</span>&nbsp;<span class="ident" id="3993056">serverCipher</span>&nbsp;<span class="keyword" id="3993069">interface</span><span class="op" id="3993078">{</span><span class="op" id="3993079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993082">var</span>&nbsp;<span class="ident" id="3993086">clientHash</span><span class="op" id="3993096">,</span>&nbsp;<span class="ident" id="3993098">serverHash</span>&nbsp;<span class="ident" id="3993109">macFunction</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993123">if</span>&nbsp;<span class="ident" id="3993126">hs</span><span class="op" id="3993128">.</span><span class="ident" id="3993129">suite</span><span class="op" id="3993134">.</span><span class="ident" id="3993135">aead</span>&nbsp;<span class="op" id="3993140">==</span>&nbsp;<span class="ident" id="3993143">nil</span>&nbsp;<span class="op" id="3993147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993151">clientCipher</span>&nbsp;<span class="op" id="3993164">=</span>&nbsp;<span class="ident" id="3993166">hs</span><span class="op" id="3993168">.</span><span class="ident" id="3993169">suite</span><span class="op" id="3993174">.</span><span class="ident" id="3993175">cipher</span><span class="op" id="3993181">(</span><span class="ident" id="3993182">clientKey</span><span class="op" id="3993191">,</span>&nbsp;<span class="ident" id="3993193">clientIV</span><span class="op" id="3993201">,</span>&nbsp;<span class="ident" id="3993203">true</span>&nbsp;<span class="comment" id="3993208">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3993225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993229">clientHash</span>&nbsp;<span class="op" id="3993240">=</span>&nbsp;<span class="ident" id="3993242">hs</span><span class="op" id="3993244">.</span><span class="ident" id="3993245">suite</span><span class="op" id="3993250">.</span><span class="ident" id="3993251">mac</span><span class="op" id="3993254">(</span><span class="ident" id="3993255">c</span><span class="op" id="3993256">.</span><span class="ident" id="3993257">vers</span><span class="op" id="3993261">,</span>&nbsp;<span class="ident" id="3993263">clientMAC</span><span class="op" id="3993272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993276">serverCipher</span>&nbsp;<span class="op" id="3993289">=</span>&nbsp;<span class="ident" id="3993291">hs</span><span class="op" id="3993293">.</span><span class="ident" id="3993294">suite</span><span class="op" id="3993299">.</span><span class="ident" id="3993300">cipher</span><span class="op" id="3993306">(</span><span class="ident" id="3993307">serverKey</span><span class="op" id="3993316">,</span>&nbsp;<span class="ident" id="3993318">serverIV</span><span class="op" id="3993326">,</span>&nbsp;<span class="ident" id="3993328">false</span>&nbsp;<span class="comment" id="3993334">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3993355">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993359">serverHash</span>&nbsp;<span class="op" id="3993370">=</span>&nbsp;<span class="ident" id="3993372">hs</span><span class="op" id="3993374">.</span><span class="ident" id="3993375">suite</span><span class="op" id="3993380">.</span><span class="ident" id="3993381">mac</span><span class="op" id="3993384">(</span><span class="ident" id="3993385">c</span><span class="op" id="3993386">.</span><span class="ident" id="3993387">vers</span><span class="op" id="3993391">,</span>&nbsp;<span class="ident" id="3993393">serverMAC</span><span class="op" id="3993402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3993405">}</span>&nbsp;<span class="keyword" id="3993407">else</span>&nbsp;<span class="op" id="3993412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993416">clientCipher</span>&nbsp;<span class="op" id="3993429">=</span>&nbsp;<span class="ident" id="3993431">hs</span><span class="op" id="3993433">.</span><span class="ident" id="3993434">suite</span><span class="op" id="3993439">.</span><span class="ident" id="3993440">aead</span><span class="op" id="3993444">(</span><span class="ident" id="3993445">clientKey</span><span class="op" id="3993454">,</span>&nbsp;<span class="ident" id="3993456">clientIV</span><span class="op" id="3993464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993468">serverCipher</span>&nbsp;<span class="op" id="3993481">=</span>&nbsp;<span class="ident" id="3993483">hs</span><span class="op" id="3993485">.</span><span class="ident" id="3993486">suite</span><span class="op" id="3993491">.</span><span class="ident" id="3993492">aead</span><span class="op" id="3993496">(</span><span class="ident" id="3993497">serverKey</span><span class="op" id="3993506">,</span>&nbsp;<span class="ident" id="3993508">serverIV</span><span class="op" id="3993516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3993519">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993523">c</span><span class="op" id="3993524">.</span><span class="ident" id="3993525">in</span><span class="op" id="3993527">.</span><span class="ident" id="3993528">prepareCipherSpec</span><span class="op" id="3993545">(</span><span class="ident" id="3993546">c</span><span class="op" id="3993547">.</span><span class="ident" id="3993548">vers</span><span class="op" id="3993552">,</span>&nbsp;<span class="ident" id="3993554">clientCipher</span><span class="op" id="3993566">,</span>&nbsp;<span class="ident" id="3993568">clientHash</span><span class="op" id="3993578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993581">c</span><span class="op" id="3993582">.</span><span class="ident" id="3993583">out</span><span class="op" id="3993586">.</span><span class="ident" id="3993587">prepareCipherSpec</span><span class="op" id="3993604">(</span><span class="ident" id="3993605">c</span><span class="op" id="3993606">.</span><span class="ident" id="3993607">vers</span><span class="op" id="3993611">,</span>&nbsp;<span class="ident" id="3993613">serverCipher</span><span class="op" id="3993625">,</span>&nbsp;<span class="ident" id="3993627">serverHash</span><span class="op" id="3993637">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993641">return</span>&nbsp;<span class="ident" id="3993648">nil</span><br>
<span class="lineno">500</span><span class="op" id="3993652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3993655">func</span>&nbsp;<span class="op" id="3993660">(</span><span class="ident" id="3993661">hs</span>&nbsp;<span class="op" id="3993664">*</span><span class="ident" id="3993665">serverHandshakeState</span><span class="op" id="3993685">)</span>&nbsp;<span class="ident" id="3993687">readFinished</span><span class="op" id="3993699">(</span><span class="ident" id="3993700">out</span>&nbsp;<span class="op" id="3993704">[</span><span class="op" id="3993705">]</span><span class="builtintype" id="3993706">byte</span><span class="op" id="3993710">)</span>&nbsp;<span class="builtintype" id="3993712">error</span>&nbsp;<span class="op" id="3993718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993721">c</span>&nbsp;<span class="op" id="3993723">:=</span>&nbsp;<span class="ident" id="3993726">hs</span><span class="op" id="3993728">.</span><span class="ident" id="3993729">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993733">c</span><span class="op" id="3993734">.</span><span class="ident" id="3993735">readRecord</span><span class="op" id="3993745">(</span><span class="ident" id="3993746">recordTypeChangeCipherSpec</span><span class="op" id="3993772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993775">if</span>&nbsp;<span class="ident" id="3993778">err</span>&nbsp;<span class="op" id="3993782">:=</span>&nbsp;<span class="ident" id="3993785">c</span><span class="op" id="3993786">.</span><span class="ident" id="3993787">in</span><span class="op" id="3993789">.</span><span class="builtintype" id="3993790">error</span><span class="op" id="3993795">(</span><span class="op" id="3993796">)</span><span class="op" id="3993797">;</span>&nbsp;<span class="ident" id="3993799">err</span>&nbsp;<span class="op" id="3993803">!=</span>&nbsp;<span class="ident" id="3993806">nil</span>&nbsp;<span class="op" id="3993810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993814">return</span>&nbsp;<span class="ident" id="3993821">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3993826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993830">if</span>&nbsp;<span class="ident" id="3993833">hs</span><span class="op" id="3993835">.</span><span class="ident" id="3993836">hello</span><span class="op" id="3993841">.</span><span class="ident" id="3993842">nextProtoNeg</span>&nbsp;<span class="op" id="3993855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993859">msg</span><span class="op" id="3993862">,</span>&nbsp;<span class="ident" id="3993864">err</span>&nbsp;<span class="op" id="3993868">:=</span>&nbsp;<span class="ident" id="3993871">c</span><span class="op" id="3993872">.</span><span class="ident" id="3993873">readHandshake</span><span class="op" id="3993886">(</span><span class="op" id="3993887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993891">if</span>&nbsp;<span class="ident" id="3993894">err</span>&nbsp;<span class="op" id="3993898">!=</span>&nbsp;<span class="ident" id="3993901">nil</span>&nbsp;<span class="op" id="3993905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993910">return</span>&nbsp;<span class="ident" id="3993917">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3993923">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993927">nextProto</span><span class="op" id="3993936">,</span>&nbsp;<span class="ident" id="3993938">ok</span>&nbsp;<span class="op" id="3993941">:=</span>&nbsp;<span class="ident" id="3993944">msg</span><span class="op" id="3993947">.</span><span class="op" id="3993948">(</span><span class="op" id="3993949">*</span><span class="ident" id="3993950">nextProtoMsg</span><span class="op" id="3993962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993966">if</span>&nbsp;<span class="op" id="3993969">!</span><span class="ident" id="3993970">ok</span>&nbsp;<span class="op" id="3993973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993978">c</span><span class="op" id="3993979">.</span><span class="ident" id="3993980">sendAlert</span><span class="op" id="3993989">(</span><span class="ident" id="3993990">alertUnexpectedMessage</span><span class="op" id="3994012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994017">return</span>&nbsp;<span class="ident" id="3994024">unexpectedMessageError</span><span class="op" id="3994046">(</span><span class="ident" id="3994047">nextProto</span><span class="op" id="3994056">,</span>&nbsp;<span class="ident" id="3994058">msg</span><span class="op" id="3994061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994065">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994069">hs</span><span class="op" id="3994071">.</span><span class="ident" id="3994072">finishedHash</span><span class="op" id="3994084">.</span><span class="ident" id="3994085">Write</span><span class="op" id="3994090">(</span><span class="ident" id="3994091">nextProto</span><span class="op" id="3994100">.</span><span class="ident" id="3994101">marshal</span><span class="op" id="3994108">(</span><span class="op" id="3994109">)</span><span class="op" id="3994110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994114">c</span><span class="op" id="3994115">.</span><span class="ident" id="3994116">clientProtocol</span>&nbsp;<span class="op" id="3994131">=</span>&nbsp;<span class="ident" id="3994133">nextProto</span><span class="op" id="3994142">.</span><span class="ident" id="3994143">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994154">msg</span><span class="op" id="3994157">,</span>&nbsp;<span class="ident" id="3994159">err</span>&nbsp;<span class="op" id="3994163">:=</span>&nbsp;<span class="ident" id="3994166">c</span><span class="op" id="3994167">.</span><span class="ident" id="3994168">readHandshake</span><span class="op" id="3994181">(</span><span class="op" id="3994182">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994185">if</span>&nbsp;<span class="ident" id="3994188">err</span>&nbsp;<span class="op" id="3994192">!=</span>&nbsp;<span class="ident" id="3994195">nil</span>&nbsp;<span class="op" id="3994199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994203">return</span>&nbsp;<span class="ident" id="3994210">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994218">clientFinished</span><span class="op" id="3994232">,</span>&nbsp;<span class="ident" id="3994234">ok</span>&nbsp;<span class="op" id="3994237">:=</span>&nbsp;<span class="ident" id="3994240">msg</span><span class="op" id="3994243">.</span><span class="op" id="3994244">(</span><span class="op" id="3994245">*</span><span class="ident" id="3994246">finishedMsg</span><span class="op" id="3994257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994260">if</span>&nbsp;<span class="op" id="3994263">!</span><span class="ident" id="3994264">ok</span>&nbsp;<span class="op" id="3994267">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994271">c</span><span class="op" id="3994272">.</span><span class="ident" id="3994273">sendAlert</span><span class="op" id="3994282">(</span><span class="ident" id="3994283">alertUnexpectedMessage</span><span class="op" id="3994305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994309">return</span>&nbsp;<span class="ident" id="3994316">unexpectedMessageError</span><span class="op" id="3994338">(</span><span class="ident" id="3994339">clientFinished</span><span class="op" id="3994353">,</span>&nbsp;<span class="ident" id="3994355">msg</span><span class="op" id="3994358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994365">verify</span>&nbsp;<span class="op" id="3994372">:=</span>&nbsp;<span class="ident" id="3994375">hs</span><span class="op" id="3994377">.</span><span class="ident" id="3994378">finishedHash</span><span class="op" id="3994390">.</span><span class="ident" id="3994391">clientSum</span><span class="op" id="3994400">(</span><span class="ident" id="3994401">hs</span><span class="op" id="3994403">.</span><span class="ident" id="3994404">masterSecret</span><span class="op" id="3994416">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994419">if</span>&nbsp;<span class="builtinfunc" id="3994422">len</span><span class="op" id="3994425">(</span><span class="ident" id="3994426">verify</span><span class="op" id="3994432">)</span>&nbsp;<span class="op" id="3994434">!=</span>&nbsp;<span class="builtinfunc" id="3994437">len</span><span class="op" id="3994440">(</span><span class="ident" id="3994441">clientFinished</span><span class="op" id="3994455">.</span><span class="ident" id="3994456">verifyData</span><span class="op" id="3994466">)</span>&nbsp;<span class="op" id="3994468">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994473">subtle</span><span class="op" id="3994479">.</span><span class="ident" id="3994480">ConstantTimeCompare</span><span class="op" id="3994499">(</span><span class="ident" id="3994500">verify</span><span class="op" id="3994506">,</span>&nbsp;<span class="ident" id="3994508">clientFinished</span><span class="op" id="3994522">.</span><span class="ident" id="3994523">verifyData</span><span class="op" id="3994533">)</span>&nbsp;<span class="op" id="3994535">!=</span>&nbsp;<span class="num" id="3994538">1</span>&nbsp;<span class="op" id="3994540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994544">c</span><span class="op" id="3994545">.</span><span class="ident" id="3994546">sendAlert</span><span class="op" id="3994555">(</span><span class="ident" id="3994556">alertHandshakeFailure</span><span class="op" id="3994577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994581">return</span>&nbsp;<span class="ident" id="3994588">errors</span><span class="op" id="3994594">.</span><span class="ident" id="3994595">New</span><span class="op" id="3994598">(</span><span class="string" id="3994599">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="3994644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994647">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994651">hs</span><span class="op" id="3994653">.</span><span class="ident" id="3994654">finishedHash</span><span class="op" id="3994666">.</span><span class="ident" id="3994667">Write</span><span class="op" id="3994672">(</span><span class="ident" id="3994673">clientFinished</span><span class="op" id="3994687">.</span><span class="ident" id="3994688">marshal</span><span class="op" id="3994695">(</span><span class="op" id="3994696">)</span><span class="op" id="3994697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3994700">copy</span><span class="op" id="3994704">(</span><span class="ident" id="3994705">out</span><span class="op" id="3994708">,</span>&nbsp;<span class="ident" id="3994710">verify</span><span class="op" id="3994716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994719">return</span>&nbsp;<span class="ident" id="3994726">nil</span><br>
<span class="lineno"></span><span class="op" id="3994730">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="3994733">func</span>&nbsp;<span class="op" id="3994738">(</span><span class="ident" id="3994739">hs</span>&nbsp;<span class="op" id="3994742">*</span><span class="ident" id="3994743">serverHandshakeState</span><span class="op" id="3994763">)</span>&nbsp;<span class="ident" id="3994765">sendSessionTicket</span><span class="op" id="3994782">(</span><span class="op" id="3994783">)</span>&nbsp;<span class="builtintype" id="3994785">error</span>&nbsp;<span class="op" id="3994791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994794">if</span>&nbsp;<span class="op" id="3994797">!</span><span class="ident" id="3994798">hs</span><span class="op" id="3994800">.</span><span class="ident" id="3994801">hello</span><span class="op" id="3994806">.</span><span class="ident" id="3994807">ticketSupported</span>&nbsp;<span class="op" id="3994823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994827">return</span>&nbsp;<span class="ident" id="3994834">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994839">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994843">c</span>&nbsp;<span class="op" id="3994845">:=</span>&nbsp;<span class="ident" id="3994848">hs</span><span class="op" id="3994850">.</span><span class="ident" id="3994851">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994854">m</span>&nbsp;<span class="op" id="3994856">:=</span>&nbsp;<span class="builtinfunc" id="3994859">new</span><span class="op" id="3994862">(</span><span class="ident" id="3994863">newSessionTicketMsg</span><span class="op" id="3994882">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994886">var</span>&nbsp;<span class="ident" id="3994890">err</span>&nbsp;<span class="builtintype" id="3994894">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994901">state</span>&nbsp;<span class="op" id="3994907">:=</span>&nbsp;<span class="ident" id="3994910">sessionState</span><span class="op" id="3994922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994926">vers</span><span class="op" id="3994930">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3994940">c</span><span class="op" id="3994941">.</span><span class="ident" id="3994942">vers</span><span class="op" id="3994946">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994950">cipherSuite</span><span class="op" id="3994961">:</span>&nbsp;&nbsp;<span class="ident" id="3994964">hs</span><span class="op" id="3994966">.</span><span class="ident" id="3994967">suite</span><span class="op" id="3994972">.</span><span class="ident" id="3994973">id</span><span class="op" id="3994975">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994979">masterSecret</span><span class="op" id="3994991">:</span>&nbsp;<span class="ident" id="3994993">hs</span><span class="op" id="3994995">.</span><span class="ident" id="3994996">masterSecret</span><span class="op" id="3995008">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995012">certificates</span><span class="op" id="3995024">:</span>&nbsp;<span class="ident" id="3995026">hs</span><span class="op" id="3995028">.</span><span class="ident" id="3995029">certsFromClient</span><span class="op" id="3995044">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3995047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995050">m</span><span class="op" id="3995051">.</span><span class="ident" id="3995052">ticket</span><span class="op" id="3995058">,</span>&nbsp;<span class="ident" id="3995060">err</span>&nbsp;<span class="op" id="3995064">=</span>&nbsp;<span class="ident" id="3995066">c</span><span class="op" id="3995067">.</span><span class="ident" id="3995068">encryptTicket</span><span class="op" id="3995081">(</span><span class="op" id="3995082">&amp;</span><span class="ident" id="3995083">state</span><span class="op" id="3995088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995091">if</span>&nbsp;<span class="ident" id="3995094">err</span>&nbsp;<span class="op" id="3995098">!=</span>&nbsp;<span class="ident" id="3995101">nil</span>&nbsp;<span class="op" id="3995105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995109">return</span>&nbsp;<span class="ident" id="3995116">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3995121">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995125">hs</span><span class="op" id="3995127">.</span><span class="ident" id="3995128">finishedHash</span><span class="op" id="3995140">.</span><span class="ident" id="3995141">Write</span><span class="op" id="3995146">(</span><span class="ident" id="3995147">m</span><span class="op" id="3995148">.</span><span class="ident" id="3995149">marshal</span><span class="op" id="3995156">(</span><span class="op" id="3995157">)</span><span class="op" id="3995158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995161">c</span><span class="op" id="3995162">.</span><span class="ident" id="3995163">writeRecord</span><span class="op" id="3995174">(</span><span class="ident" id="3995175">recordTypeHandshake</span><span class="op" id="3995194">,</span>&nbsp;<span class="ident" id="3995196">m</span><span class="op" id="3995197">.</span><span class="ident" id="3995198">marshal</span><span class="op" id="3995205">(</span><span class="op" id="3995206">)</span><span class="op" id="3995207">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995211">return</span>&nbsp;<span class="ident" id="3995218">nil</span><br>
<span class="lineno">570</span><span class="op" id="3995222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3995225">func</span>&nbsp;<span class="op" id="3995230">(</span><span class="ident" id="3995231">hs</span>&nbsp;<span class="op" id="3995234">*</span><span class="ident" id="3995235">serverHandshakeState</span><span class="op" id="3995255">)</span>&nbsp;<span class="ident" id="3995257">sendFinished</span><span class="op" id="3995269">(</span><span class="ident" id="3995270">out</span>&nbsp;<span class="op" id="3995274">[</span><span class="op" id="3995275">]</span><span class="builtintype" id="3995276">byte</span><span class="op" id="3995280">)</span>&nbsp;<span class="builtintype" id="3995282">error</span>&nbsp;<span class="op" id="3995288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995291">c</span>&nbsp;<span class="op" id="3995293">:=</span>&nbsp;<span class="ident" id="3995296">hs</span><span class="op" id="3995298">.</span><span class="ident" id="3995299">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995303">c</span><span class="op" id="3995304">.</span><span class="ident" id="3995305">writeRecord</span><span class="op" id="3995316">(</span><span class="ident" id="3995317">recordTypeChangeCipherSpec</span><span class="op" id="3995343">,</span>&nbsp;<span class="op" id="3995345">[</span><span class="op" id="3995346">]</span><span class="builtintype" id="3995347">byte</span><span class="op" id="3995351">{</span><span class="num" id="3995352">1</span><span class="op" id="3995353">}</span><span class="op" id="3995354">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995358">finished</span>&nbsp;<span class="op" id="3995367">:=</span>&nbsp;<span class="builtinfunc" id="3995370">new</span><span class="op" id="3995373">(</span><span class="ident" id="3995374">finishedMsg</span><span class="op" id="3995385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995388">finished</span><span class="op" id="3995396">.</span><span class="ident" id="3995397">verifyData</span>&nbsp;<span class="op" id="3995408">=</span>&nbsp;<span class="ident" id="3995410">hs</span><span class="op" id="3995412">.</span><span class="ident" id="3995413">finishedHash</span><span class="op" id="3995425">.</span><span class="ident" id="3995426">serverSum</span><span class="op" id="3995435">(</span><span class="ident" id="3995436">hs</span><span class="op" id="3995438">.</span><span class="ident" id="3995439">masterSecret</span><span class="op" id="3995451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995454">hs</span><span class="op" id="3995456">.</span><span class="ident" id="3995457">finishedHash</span><span class="op" id="3995469">.</span><span class="ident" id="3995470">Write</span><span class="op" id="3995475">(</span><span class="ident" id="3995476">finished</span><span class="op" id="3995484">.</span><span class="ident" id="3995485">marshal</span><span class="op" id="3995492">(</span><span class="op" id="3995493">)</span><span class="op" id="3995494">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995497">c</span><span class="op" id="3995498">.</span><span class="ident" id="3995499">writeRecord</span><span class="op" id="3995510">(</span><span class="ident" id="3995511">recordTypeHandshake</span><span class="op" id="3995530">,</span>&nbsp;<span class="ident" id="3995532">finished</span><span class="op" id="3995540">.</span><span class="ident" id="3995541">marshal</span><span class="op" id="3995548">(</span><span class="op" id="3995549">)</span><span class="op" id="3995550">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995554">c</span><span class="op" id="3995555">.</span><span class="ident" id="3995556">cipherSuite</span>&nbsp;<span class="op" id="3995568">=</span>&nbsp;<span class="ident" id="3995570">hs</span><span class="op" id="3995572">.</span><span class="ident" id="3995573">suite</span><span class="op" id="3995578">.</span><span class="ident" id="3995579">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3995583">copy</span><span class="op" id="3995587">(</span><span class="ident" id="3995588">out</span><span class="op" id="3995591">,</span>&nbsp;<span class="ident" id="3995593">finished</span><span class="op" id="3995601">.</span><span class="ident" id="3995602">verifyData</span><span class="op" id="3995612">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995616">return</span>&nbsp;<span class="ident" id="3995623">nil</span><br>
<span class="lineno"></span><span class="op" id="3995627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3995630">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3995707">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="3995784">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3995827">func</span>&nbsp;<span class="op" id="3995832">(</span><span class="ident" id="3995833">hs</span>&nbsp;<span class="op" id="3995836">*</span><span class="ident" id="3995837">serverHandshakeState</span><span class="op" id="3995857">)</span>&nbsp;<span class="ident" id="3995859">processCertsFromClient</span><span class="op" id="3995881">(</span><span class="ident" id="3995882">certificates</span>&nbsp;<span class="op" id="3995895">[</span><span class="op" id="3995896">]</span><span class="op" id="3995897">[</span><span class="op" id="3995898">]</span><span class="builtintype" id="3995899">byte</span><span class="op" id="3995903">)</span>&nbsp;<span class="op" id="3995905">(</span><span class="ident" id="3995906">crypto</span><span class="op" id="3995912">.</span><span class="ident" id="3995913">PublicKey</span><span class="op" id="3995922">,</span>&nbsp;<span class="builtintype" id="3995924">error</span><span class="op" id="3995929">)</span>&nbsp;<span class="op" id="3995931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995934">c</span>&nbsp;<span class="op" id="3995936">:=</span>&nbsp;<span class="ident" id="3995939">hs</span><span class="op" id="3995941">.</span><span class="ident" id="3995942">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995946">hs</span><span class="op" id="3995948">.</span><span class="ident" id="3995949">certsFromClient</span>&nbsp;<span class="op" id="3995965">=</span>&nbsp;<span class="ident" id="3995967">certificates</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995981">certs</span>&nbsp;<span class="op" id="3995987">:=</span>&nbsp;<span class="builtinfunc" id="3995990">make</span><span class="op" id="3995994">(</span><span class="op" id="3995995">[</span><span class="op" id="3995996">]</span><span class="op" id="3995997">*</span><span class="ident" id="3995998">x509</span><span class="op" id="3996002">.</span><span class="ident" id="3996003">Certificate</span><span class="op" id="3996014">,</span>&nbsp;<span class="builtinfunc" id="3996016">len</span><span class="op" id="3996019">(</span><span class="ident" id="3996020">certificates</span><span class="op" id="3996032">)</span><span class="op" id="3996033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996036">var</span>&nbsp;<span class="ident" id="3996040">err</span>&nbsp;<span class="builtintype" id="3996044">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996051">for</span>&nbsp;<span class="ident" id="3996055">i</span><span class="op" id="3996056">,</span>&nbsp;<span class="ident" id="3996058">asn1Data</span>&nbsp;<span class="op" id="3996067">:=</span>&nbsp;<span class="keyword" id="3996070">range</span>&nbsp;<span class="ident" id="3996076">certificates</span>&nbsp;<span class="op" id="3996089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996093">if</span>&nbsp;<span class="ident" id="3996096">certs</span><span class="op" id="3996101">[</span><span class="ident" id="3996102">i</span><span class="op" id="3996103">]</span><span class="op" id="3996104">,</span>&nbsp;<span class="ident" id="3996106">err</span>&nbsp;<span class="op" id="3996110">=</span>&nbsp;<span class="ident" id="3996112">x509</span><span class="op" id="3996116">.</span><span class="ident" id="3996117">ParseCertificate</span><span class="op" id="3996133">(</span><span class="ident" id="3996134">asn1Data</span><span class="op" id="3996142">)</span><span class="op" id="3996143">;</span>&nbsp;<span class="ident" id="3996145">err</span>&nbsp;<span class="op" id="3996149">!=</span>&nbsp;<span class="ident" id="3996152">nil</span>&nbsp;<span class="op" id="3996156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996161">c</span><span class="op" id="3996162">.</span><span class="ident" id="3996163">sendAlert</span><span class="op" id="3996172">(</span><span class="ident" id="3996173">alertBadCertificate</span><span class="op" id="3996192">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996197">return</span>&nbsp;<span class="ident" id="3996204">nil</span><span class="op" id="3996207">,</span>&nbsp;<span class="ident" id="3996209">errors</span><span class="op" id="3996215">.</span><span class="ident" id="3996216">New</span><span class="op" id="3996219">(</span><span class="string" id="3996220">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3996264">+</span>&nbsp;<span class="ident" id="3996266">err</span><span class="op" id="3996269">.</span><span class="ident" id="3996270">Error</span><span class="op" id="3996275">(</span><span class="op" id="3996276">)</span><span class="op" id="3996277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3996281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3996284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996288">if</span>&nbsp;<span class="ident" id="3996291">c</span><span class="op" id="3996292">.</span><span class="ident" id="3996293">config</span><span class="op" id="3996299">.</span><span class="ident" id="3996300">ClientAuth</span>&nbsp;<span class="op" id="3996311">&gt;=</span>&nbsp;<span class="ident" id="3996314">VerifyClientCertIfGiven</span>&nbsp;<span class="op" id="3996338">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3996341">len</span><span class="op" id="3996344">(</span><span class="ident" id="3996345">certs</span><span class="op" id="3996350">)</span>&nbsp;<span class="op" id="3996352">&gt;</span>&nbsp;<span class="num" id="3996354">0</span>&nbsp;<span class="op" id="3996356">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996360">opts</span>&nbsp;<span class="op" id="3996365">:=</span>&nbsp;<span class="ident" id="3996368">x509</span><span class="op" id="3996372">.</span><span class="ident" id="3996373">VerifyOptions</span><span class="op" id="3996386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996391">Roots</span><span class="op" id="3996396">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3996406">c</span><span class="op" id="3996407">.</span><span class="ident" id="3996408">config</span><span class="op" id="3996414">.</span><span class="ident" id="3996415">ClientCAs</span><span class="op" id="3996424">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996429">CurrentTime</span><span class="op" id="3996440">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3996444">c</span><span class="op" id="3996445">.</span><span class="ident" id="3996446">config</span><span class="op" id="3996452">.</span><span class="ident" id="3996453">time</span><span class="op" id="3996457">(</span><span class="op" id="3996458">)</span><span class="op" id="3996459">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996464">Intermediates</span><span class="op" id="3996477">:</span>&nbsp;<span class="ident" id="3996479">x509</span><span class="op" id="3996483">.</span><span class="ident" id="3996484">NewCertPool</span><span class="op" id="3996495">(</span><span class="op" id="3996496">)</span><span class="op" id="3996497">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996502">KeyUsages</span><span class="op" id="3996511">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3996517">[</span><span class="op" id="3996518">]</span><span class="ident" id="3996519">x509</span><span class="op" id="3996523">.</span><span class="ident" id="3996524">ExtKeyUsage</span><span class="op" id="3996535">{</span><span class="ident" id="3996536">x509</span><span class="op" id="3996540">.</span><span class="ident" id="3996541">ExtKeyUsageClientAuth</span><span class="op" id="3996562">}</span><span class="op" id="3996563">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3996567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996572">for</span>&nbsp;<span class="ident" id="3996576">_</span><span class="op" id="3996577">,</span>&nbsp;<span class="ident" id="3996579">cert</span>&nbsp;<span class="op" id="3996584">:=</span>&nbsp;<span class="keyword" id="3996587">range</span>&nbsp;<span class="ident" id="3996593">certs</span><span class="op" id="3996598">[</span><span class="num" id="3996599">1</span><span class="op" id="3996600">:</span><span class="op" id="3996601">]</span>&nbsp;<span class="op" id="3996603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996608">opts</span><span class="op" id="3996612">.</span><span class="ident" id="3996613">Intermediates</span><span class="op" id="3996626">.</span><span class="ident" id="3996627">AddCert</span><span class="op" id="3996634">(</span><span class="ident" id="3996635">cert</span><span class="op" id="3996639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3996643">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996648">chains</span><span class="op" id="3996654">,</span>&nbsp;<span class="ident" id="3996656">err</span>&nbsp;<span class="op" id="3996660">:=</span>&nbsp;<span class="ident" id="3996663">certs</span><span class="op" id="3996668">[</span><span class="num" id="3996669">0</span><span class="op" id="3996670">]</span><span class="op" id="3996671">.</span><span class="ident" id="3996672">Verify</span><span class="op" id="3996678">(</span><span class="ident" id="3996679">opts</span><span class="op" id="3996683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996687">if</span>&nbsp;<span class="ident" id="3996690">err</span>&nbsp;<span class="op" id="3996694">!=</span>&nbsp;<span class="ident" id="3996697">nil</span>&nbsp;<span class="op" id="3996701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996706">c</span><span class="op" id="3996707">.</span><span class="ident" id="3996708">sendAlert</span><span class="op" id="3996717">(</span><span class="ident" id="3996718">alertBadCertificate</span><span class="op" id="3996737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996742">return</span>&nbsp;<span class="ident" id="3996749">nil</span><span class="op" id="3996752">,</span>&nbsp;<span class="ident" id="3996754">errors</span><span class="op" id="3996760">.</span><span class="ident" id="3996761">New</span><span class="op" id="3996764">(</span><span class="string" id="3996765">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3996812">+</span>&nbsp;<span class="ident" id="3996814">err</span><span class="op" id="3996817">.</span><span class="ident" id="3996818">Error</span><span class="op" id="3996823">(</span><span class="op" id="3996824">)</span><span class="op" id="3996825">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3996829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996834">ok</span>&nbsp;<span class="op" id="3996837">:=</span>&nbsp;<span class="ident" id="3996840">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996848">for</span>&nbsp;<span class="ident" id="3996852">_</span><span class="op" id="3996853">,</span>&nbsp;<span class="ident" id="3996855">ku</span>&nbsp;<span class="op" id="3996858">:=</span>&nbsp;<span class="keyword" id="3996861">range</span>&nbsp;<span class="ident" id="3996867">certs</span><span class="op" id="3996872">[</span><span class="num" id="3996873">0</span><span class="op" id="3996874">]</span><span class="op" id="3996875">.</span><span class="ident" id="3996876">ExtKeyUsage</span>&nbsp;<span class="op" id="3996888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996893">if</span>&nbsp;<span class="ident" id="3996896">ku</span>&nbsp;<span class="op" id="3996899">==</span>&nbsp;<span class="ident" id="3996902">x509</span><span class="op" id="3996906">.</span><span class="ident" id="3996907">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="3996929">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996935">ok</span>&nbsp;<span class="op" id="3996938">=</span>&nbsp;<span class="ident" id="3996940">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996949">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3996958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3996962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996966">if</span>&nbsp;<span class="op" id="3996969">!</span><span class="ident" id="3996970">ok</span>&nbsp;<span class="op" id="3996973">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996978">c</span><span class="op" id="3996979">.</span><span class="ident" id="3996980">sendAlert</span><span class="op" id="3996989">(</span><span class="ident" id="3996990">alertHandshakeFailure</span><span class="op" id="3997011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997016">return</span>&nbsp;<span class="ident" id="3997023">nil</span><span class="op" id="3997026">,</span>&nbsp;<span class="ident" id="3997028">errors</span><span class="op" id="3997034">.</span><span class="ident" id="3997035">New</span><span class="op" id="3997038">(</span><span class="string" id="3997039">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="3997142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3997146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997151">c</span><span class="op" id="3997152">.</span><span class="ident" id="3997153">verifiedChains</span>&nbsp;<span class="op" id="3997168">=</span>&nbsp;<span class="ident" id="3997170">chains</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3997178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997182">if</span>&nbsp;<span class="builtinfunc" id="3997185">len</span><span class="op" id="3997188">(</span><span class="ident" id="3997189">certs</span><span class="op" id="3997194">)</span>&nbsp;<span class="op" id="3997196">&gt;</span>&nbsp;<span class="num" id="3997198">0</span>&nbsp;<span class="op" id="3997200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997204">var</span>&nbsp;<span class="ident" id="3997208">pub</span>&nbsp;<span class="ident" id="3997212">crypto</span><span class="op" id="3997218">.</span><span class="ident" id="3997219">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997231">switch</span>&nbsp;<span class="ident" id="3997238">key</span>&nbsp;<span class="op" id="3997242">:=</span>&nbsp;<span class="ident" id="3997245">certs</span><span class="op" id="3997250">[</span><span class="num" id="3997251">0</span><span class="op" id="3997252">]</span><span class="op" id="3997253">.</span><span class="ident" id="3997254">PublicKey</span><span class="op" id="3997263">.</span><span class="op" id="3997264">(</span><span class="keyword" id="3997265">type</span><span class="op" id="3997269">)</span>&nbsp;<span class="op" id="3997271">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997275">case</span>&nbsp;<span class="op" id="3997280">*</span><span class="ident" id="3997281">ecdsa</span><span class="op" id="3997286">.</span><span class="ident" id="3997287">PublicKey</span><span class="op" id="3997296">,</span>&nbsp;<span class="op" id="3997298">*</span><span class="ident" id="3997299">rsa</span><span class="op" id="3997302">.</span><span class="ident" id="3997303">PublicKey</span><span class="op" id="3997312">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997317">pub</span>&nbsp;<span class="op" id="3997321">=</span>&nbsp;<span class="ident" id="3997323">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997329">default</span><span class="op" id="3997336">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997341">c</span><span class="op" id="3997342">.</span><span class="ident" id="3997343">sendAlert</span><span class="op" id="3997352">(</span><span class="ident" id="3997353">alertUnsupportedCertificate</span><span class="op" id="3997380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997385">return</span>&nbsp;<span class="ident" id="3997392">nil</span><span class="op" id="3997395">,</span>&nbsp;<span class="ident" id="3997397">fmt</span><span class="op" id="3997400">.</span><span class="ident" id="3997401">Errorf</span><span class="op" id="3997407">(</span><span class="string" id="3997408">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="3997481">,</span>&nbsp;<span class="ident" id="3997483">certs</span><span class="op" id="3997488">[</span><span class="num" id="3997489">0</span><span class="op" id="3997490">]</span><span class="op" id="3997491">.</span><span class="ident" id="3997492">PublicKey</span><span class="op" id="3997501">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3997505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997509">c</span><span class="op" id="3997510">.</span><span class="ident" id="3997511">peerCertificates</span>&nbsp;<span class="op" id="3997528">=</span>&nbsp;<span class="ident" id="3997530">certs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997538">return</span>&nbsp;<span class="ident" id="3997545">pub</span><span class="op" id="3997548">,</span>&nbsp;<span class="ident" id="3997550">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3997555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997559">return</span>&nbsp;<span class="ident" id="3997566">nil</span><span class="op" id="3997569">,</span>&nbsp;<span class="ident" id="3997571">nil</span><br>
<span class="lineno"></span><span class="op" id="3997575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3997578">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="3997657">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="3997682">func</span>&nbsp;<span class="op" id="3997687">(</span><span class="ident" id="3997688">c</span>&nbsp;<span class="op" id="3997690">*</span><span class="ident" id="3997691">Conn</span><span class="op" id="3997695">)</span>&nbsp;<span class="ident" id="3997697">tryCipherSuite</span><span class="op" id="3997711">(</span><span class="ident" id="3997712">id</span>&nbsp;<span class="builtintype" id="3997715">uint16</span><span class="op" id="3997721">,</span>&nbsp;<span class="ident" id="3997723">supportedCipherSuites</span>&nbsp;<span class="op" id="3997745">[</span><span class="op" id="3997746">]</span><span class="builtintype" id="3997747">uint16</span><span class="op" id="3997753">,</span>&nbsp;<span class="ident" id="3997755">version</span>&nbsp;<span class="builtintype" id="3997763">uint16</span><span class="op" id="3997769">,</span>&nbsp;<span class="ident" id="3997771">ellipticOk</span><span class="op" id="3997781">,</span>&nbsp;<span class="ident" id="3997783">ecdsaOk</span>&nbsp;<span class="builtintype" id="3997791">bool</span><span class="op" id="3997795">)</span>&nbsp;<span class="op" id="3997797">*</span><span class="ident" id="3997798">cipherSuite</span>&nbsp;<span class="op" id="3997810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997813">for</span>&nbsp;<span class="ident" id="3997817">_</span><span class="op" id="3997818">,</span>&nbsp;<span class="ident" id="3997820">supported</span>&nbsp;<span class="op" id="3997830">:=</span>&nbsp;<span class="keyword" id="3997833">range</span>&nbsp;<span class="ident" id="3997839">supportedCipherSuites</span>&nbsp;<span class="op" id="3997861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997865">if</span>&nbsp;<span class="ident" id="3997868">id</span>&nbsp;<span class="op" id="3997871">==</span>&nbsp;<span class="ident" id="3997874">supported</span>&nbsp;<span class="op" id="3997884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997889">var</span>&nbsp;<span class="ident" id="3997893">candidate</span>&nbsp;<span class="op" id="3997903">*</span><span class="ident" id="3997904">cipherSuite</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997920">for</span>&nbsp;<span class="ident" id="3997924">_</span><span class="op" id="3997925">,</span>&nbsp;<span class="ident" id="3997927">s</span>&nbsp;<span class="op" id="3997929">:=</span>&nbsp;<span class="keyword" id="3997932">range</span>&nbsp;<span class="ident" id="3997938">cipherSuites</span>&nbsp;<span class="op" id="3997951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997957">if</span>&nbsp;<span class="ident" id="3997960">s</span><span class="op" id="3997961">.</span><span class="ident" id="3997962">id</span>&nbsp;<span class="op" id="3997965">==</span>&nbsp;<span class="ident" id="3997968">id</span>&nbsp;<span class="op" id="3997971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997978">candidate</span>&nbsp;<span class="op" id="3997988">=</span>&nbsp;<span class="ident" id="3997990">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997997">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998007">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998017">if</span>&nbsp;<span class="ident" id="3998020">candidate</span>&nbsp;<span class="op" id="3998030">==</span>&nbsp;<span class="ident" id="3998033">nil</span>&nbsp;<span class="op" id="3998037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998043">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3998060">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3998108">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998139">if</span>&nbsp;<span class="op" id="3998142">(</span><span class="ident" id="3998143">candidate</span><span class="op" id="3998152">.</span><span class="ident" id="3998153">flags</span><span class="op" id="3998158">&amp;</span><span class="ident" id="3998159">suiteECDHE</span>&nbsp;<span class="op" id="3998170">!=</span>&nbsp;<span class="num" id="3998173">0</span><span class="op" id="3998174">)</span>&nbsp;<span class="op" id="3998176">&amp;&amp;</span>&nbsp;<span class="op" id="3998179">!</span><span class="ident" id="3998180">ellipticOk</span>&nbsp;<span class="op" id="3998191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998197">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998214">if</span>&nbsp;<span class="op" id="3998217">(</span><span class="ident" id="3998218">candidate</span><span class="op" id="3998227">.</span><span class="ident" id="3998228">flags</span><span class="op" id="3998233">&amp;</span><span class="ident" id="3998234">suiteECDSA</span>&nbsp;<span class="op" id="3998245">!=</span>&nbsp;<span class="num" id="3998248">0</span><span class="op" id="3998249">)</span>&nbsp;<span class="op" id="3998251">!=</span>&nbsp;<span class="ident" id="3998254">ecdsaOk</span>&nbsp;<span class="op" id="3998262">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998268">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998285">if</span>&nbsp;<span class="ident" id="3998288">version</span>&nbsp;<span class="op" id="3998296">&lt;</span>&nbsp;<span class="ident" id="3998298">VersionTLS12</span>&nbsp;<span class="op" id="3998311">&amp;&amp;</span>&nbsp;<span class="ident" id="3998314">candidate</span><span class="op" id="3998323">.</span><span class="ident" id="3998324">flags</span><span class="op" id="3998329">&amp;</span><span class="ident" id="3998330">suiteTLS12</span>&nbsp;<span class="op" id="3998341">!=</span>&nbsp;<span class="num" id="3998344">0</span>&nbsp;<span class="op" id="3998346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998352">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998364">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998369">return</span>&nbsp;<span class="ident" id="3998376">candidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998395">return</span>&nbsp;<span class="ident" id="3998402">nil</span><br>
<span class="lineno">685</span><span class="op" id="3998406">}</span>
</div>
</body>
</html>
