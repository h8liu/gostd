<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1575360">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1575415">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1575469">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1575520">//&nbsp;Malloc&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1575541">//&nbsp;Patterned&nbsp;after&nbsp;tcmalloc&#39;s&nbsp;algorithms;&nbsp;shorter&nbsp;code.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1575598">package</span>&nbsp;<span class="ident" id="1575606">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1575615">import</span>&nbsp;<span class="op" id="1575622">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1575625">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1575634">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1575637">//&nbsp;NOTE(rsc):&nbsp;Everything&nbsp;here&nbsp;could&nbsp;use&nbsp;cas&nbsp;if&nbsp;contention&nbsp;became&nbsp;an&nbsp;issue.</span><br>
<span class="lineno">15</span><span class="keyword" id="1575712">var</span>&nbsp;<span class="ident" id="1575716">proflock</span>&nbsp;<span class="ident" id="1575725">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1575732">//&nbsp;All&nbsp;memory&nbsp;allocations&nbsp;are&nbsp;local&nbsp;and&nbsp;do&nbsp;not&nbsp;escape&nbsp;outside&nbsp;of&nbsp;the&nbsp;profiler.</span><br>
<span class="lineno"></span><span class="comment" id="1575811">//&nbsp;The&nbsp;profiler&nbsp;is&nbsp;forbidden&nbsp;from&nbsp;referring&nbsp;to&nbsp;garbage-collected&nbsp;memory.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1575885">const</span>&nbsp;<span class="op" id="1575891">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575894">//&nbsp;profile&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575912">memProfile</span>&nbsp;<span class="ident" id="1575923">bucketType</span>&nbsp;<span class="op" id="1575934">=</span>&nbsp;<span class="num" id="1575936">1</span>&nbsp;<span class="op" id="1575938">+</span>&nbsp;<span class="ident" id="1575940">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575946">blockProfile</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575961">//&nbsp;size&nbsp;of&nbsp;bucket&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575991">buckHashSize</span>&nbsp;<span class="op" id="1576004">=</span>&nbsp;<span class="num" id="1576006">179999</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1576015">//&nbsp;max&nbsp;depth&nbsp;of&nbsp;stack&nbsp;to&nbsp;record&nbsp;in&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576058">maxStack</span>&nbsp;<span class="op" id="1576067">=</span>&nbsp;<span class="num" id="1576069">32</span><br>
<span class="lineno">30</span><span class="op" id="1576072">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1576075">type</span>&nbsp;<span class="ident" id="1576080">bucketType</span>&nbsp;<span class="builtintype" id="1576091">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1576096">//&nbsp;A&nbsp;bucket&nbsp;holds&nbsp;per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno">35</span><span class="comment" id="1576152">//&nbsp;The&nbsp;representation&nbsp;is&nbsp;a&nbsp;bit&nbsp;sleazy,&nbsp;inherited&nbsp;from&nbsp;C.</span><br>
<span class="lineno"></span><span class="comment" id="1576209">//&nbsp;This&nbsp;struct&nbsp;defines&nbsp;the&nbsp;bucket&nbsp;header.&nbsp;It&nbsp;is&nbsp;followed&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1576269">//&nbsp;memory&nbsp;by&nbsp;the&nbsp;stack&nbsp;words&nbsp;and&nbsp;then&nbsp;the&nbsp;actual&nbsp;record</span><br>
<span class="lineno"></span><span class="comment" id="1576325">//&nbsp;data,&nbsp;either&nbsp;a&nbsp;memRecord&nbsp;or&nbsp;a&nbsp;blockRecord.</span><br>
<span class="lineno"></span><span class="comment" id="1576371">//</span><br>
<span class="lineno">40</span><span class="comment" id="1576374">//&nbsp;Per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="1576415">//&nbsp;Lookup&nbsp;by&nbsp;hashing&nbsp;call&nbsp;stack&nbsp;into&nbsp;a&nbsp;linked-list&nbsp;hash&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="1576478">type</span>&nbsp;<span class="ident" id="1576483">bucket</span>&nbsp;<span class="keyword" id="1576490">struct</span>&nbsp;<span class="op" id="1576497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576500">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576508">*</span><span class="ident" id="1576509">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576517">allnext</span>&nbsp;<span class="op" id="1576525">*</span><span class="ident" id="1576526">bucket</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576534">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576542">bucketType</span>&nbsp;<span class="comment" id="1576553">//&nbsp;memBucket&nbsp;or&nbsp;blockBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576582">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1576590">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576599">size</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1576607">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576616">nstk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1576624">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1576632">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="1576635">//&nbsp;A&nbsp;memRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;memProfile,</span><br>
<span class="lineno"></span><span class="comment" id="1576702">//&nbsp;part&nbsp;of&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1576733">type</span>&nbsp;<span class="ident" id="1576738">memRecord</span>&nbsp;<span class="keyword" id="1576748">struct</span>&nbsp;<span class="op" id="1576755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1576758">//&nbsp;The&nbsp;following&nbsp;complex&nbsp;3-stage&nbsp;scheme&nbsp;of&nbsp;stats&nbsp;accumulation</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1576821">//&nbsp;is&nbsp;required&nbsp;to&nbsp;obtain&nbsp;a&nbsp;consistent&nbsp;picture&nbsp;of&nbsp;mallocs&nbsp;and&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1576889">//&nbsp;for&nbsp;some&nbsp;point&nbsp;in&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1576917">//&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;mallocs&nbsp;come&nbsp;in&nbsp;real&nbsp;time,&nbsp;while&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1576980">//&nbsp;come&nbsp;only&nbsp;after&nbsp;a&nbsp;GC&nbsp;during&nbsp;concurrent&nbsp;sweeping.&nbsp;So&nbsp;if&nbsp;we&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577048">//&nbsp;naively&nbsp;count&nbsp;them,&nbsp;we&nbsp;would&nbsp;get&nbsp;a&nbsp;skew&nbsp;toward&nbsp;mallocs.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577108">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577112">//&nbsp;Mallocs&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577155">//&nbsp;Explicit&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577205">//&nbsp;GC&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577247">//&nbsp;After&nbsp;GC&nbsp;prev&nbsp;stats&nbsp;are&nbsp;added&nbsp;to&nbsp;final&nbsp;stats&nbsp;and</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577300">//&nbsp;recent&nbsp;stats&nbsp;are&nbsp;moved&nbsp;into&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577344">allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1577356">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577365">frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1577377">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577386">alloc_bytes</span>&nbsp;<span class="builtintype" id="1577398">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577407">free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1577419">uintptr</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577429">//&nbsp;changes&nbsp;between&nbsp;next-to-last&nbsp;GC&nbsp;and&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577477">prev_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1577494">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577503">prev_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1577520">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577529">prev_alloc_bytes</span>&nbsp;<span class="builtintype" id="1577546">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577555">prev_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1577572">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1577582">//&nbsp;changes&nbsp;since&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577608">recent_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1577627">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577636">recent_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1577655">uintptr</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577664">recent_alloc_bytes</span>&nbsp;<span class="builtintype" id="1577683">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577692">recent_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1577711">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1577719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1577722">//&nbsp;A&nbsp;blockRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;blockProfile,</span><br>
<span class="lineno">85</span><span class="comment" id="1577793">//&nbsp;part&nbsp;of&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1577826">type</span>&nbsp;<span class="ident" id="1577831">blockRecord</span>&nbsp;<span class="keyword" id="1577843">struct</span>&nbsp;<span class="op" id="1577850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577853">count</span>&nbsp;&nbsp;<span class="ident" id="1577860">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577867">cycles</span>&nbsp;<span class="ident" id="1577874">int64</span><br>
<span class="lineno"></span><span class="op" id="1577880">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="1577883">var</span>&nbsp;<span class="op" id="1577887">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577890">mbuckets</span>&nbsp;&nbsp;<span class="op" id="1577900">*</span><span class="ident" id="1577901">bucket</span>&nbsp;<span class="comment" id="1577908">//&nbsp;memory&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577935">bbuckets</span>&nbsp;&nbsp;<span class="op" id="1577945">*</span><span class="ident" id="1577946">bucket</span>&nbsp;<span class="comment" id="1577953">//&nbsp;blocking&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577982">buckhash</span>&nbsp;&nbsp;<span class="op" id="1577992">*</span><span class="op" id="1577993">[</span><span class="num" id="1577994">179999</span><span class="op" id="1578000">]</span><span class="op" id="1578001">*</span><span class="ident" id="1578002">bucket</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578010">bucketmem</span>&nbsp;<span class="builtintype" id="1578020">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1578028">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1578031">//&nbsp;newBucket&nbsp;allocates&nbsp;a&nbsp;bucket&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;number&nbsp;of&nbsp;stack&nbsp;entries.</span><br>
<span class="lineno"></span><span class="keyword" id="1578112">func</span>&nbsp;<span class="ident" id="1578117">newBucket</span><span class="op" id="1578126">(</span><span class="ident" id="1578127">typ</span>&nbsp;<span class="ident" id="1578131">bucketType</span><span class="op" id="1578141">,</span>&nbsp;<span class="ident" id="1578143">nstk</span>&nbsp;<span class="builtintype" id="1578148">int</span><span class="op" id="1578151">)</span>&nbsp;<span class="op" id="1578153">*</span><span class="ident" id="1578154">bucket</span>&nbsp;<span class="op" id="1578161">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578164">size</span>&nbsp;<span class="op" id="1578169">:=</span>&nbsp;<span class="ident" id="1578172">unsafe</span><span class="op" id="1578178">.</span><span class="ident" id="1578179">Sizeof</span><span class="op" id="1578185">(</span><span class="ident" id="1578186">bucket</span><span class="op" id="1578192">{</span><span class="op" id="1578193">}</span><span class="op" id="1578194">)</span>&nbsp;<span class="op" id="1578196">+</span>&nbsp;<span class="builtintype" id="1578198">uintptr</span><span class="op" id="1578205">(</span><span class="ident" id="1578206">nstk</span><span class="op" id="1578210">)</span><span class="op" id="1578211">*</span><span class="ident" id="1578212">unsafe</span><span class="op" id="1578218">.</span><span class="ident" id="1578219">Sizeof</span><span class="op" id="1578225">(</span><span class="builtintype" id="1578226">uintptr</span><span class="op" id="1578233">(</span><span class="num" id="1578234">0</span><span class="op" id="1578235">)</span><span class="op" id="1578236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1578239">switch</span>&nbsp;<span class="ident" id="1578246">typ</span>&nbsp;<span class="op" id="1578250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1578253">default</span><span class="op" id="1578260">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578264">gothrow</span><span class="op" id="1578271">(</span><span class="string" id="1578272">&#34;invalid&nbsp;profile&nbsp;bucket&nbsp;type&#34;</span><span class="op" id="1578301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1578304">case</span>&nbsp;<span class="ident" id="1578309">memProfile</span><span class="op" id="1578319">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578323">size</span>&nbsp;<span class="op" id="1578328">+=</span>&nbsp;<span class="ident" id="1578331">unsafe</span><span class="op" id="1578337">.</span><span class="ident" id="1578338">Sizeof</span><span class="op" id="1578344">(</span><span class="ident" id="1578345">memRecord</span><span class="op" id="1578354">{</span><span class="op" id="1578355">}</span><span class="op" id="1578356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1578359">case</span>&nbsp;<span class="ident" id="1578364">blockProfile</span><span class="op" id="1578376">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578380">size</span>&nbsp;<span class="op" id="1578385">+=</span>&nbsp;<span class="ident" id="1578388">unsafe</span><span class="op" id="1578394">.</span><span class="ident" id="1578395">Sizeof</span><span class="op" id="1578401">(</span><span class="ident" id="1578402">blockRecord</span><span class="op" id="1578413">{</span><span class="op" id="1578414">}</span><span class="op" id="1578415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1578418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578422">b</span>&nbsp;<span class="op" id="1578424">:=</span>&nbsp;<span class="op" id="1578427">(</span><span class="op" id="1578428">*</span><span class="ident" id="1578429">bucket</span><span class="op" id="1578435">)</span><span class="op" id="1578436">(</span><span class="ident" id="1578437">persistentalloc</span><span class="op" id="1578452">(</span><span class="ident" id="1578453">size</span><span class="op" id="1578457">,</span>&nbsp;<span class="num" id="1578459">0</span><span class="op" id="1578460">,</span>&nbsp;<span class="op" id="1578462">&amp;</span><span class="ident" id="1578463">memstats</span><span class="op" id="1578471">.</span><span class="ident" id="1578472">buckhash_sys</span><span class="op" id="1578484">)</span><span class="op" id="1578485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578488">bucketmem</span>&nbsp;<span class="op" id="1578498">+=</span>&nbsp;<span class="ident" id="1578501">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578507">b</span><span class="op" id="1578508">.</span><span class="ident" id="1578509">typ</span>&nbsp;<span class="op" id="1578513">=</span>&nbsp;<span class="ident" id="1578515">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578520">b</span><span class="op" id="1578521">.</span><span class="ident" id="1578522">nstk</span>&nbsp;<span class="op" id="1578527">=</span>&nbsp;<span class="builtintype" id="1578529">uintptr</span><span class="op" id="1578536">(</span><span class="ident" id="1578537">nstk</span><span class="op" id="1578541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1578544">return</span>&nbsp;<span class="ident" id="1578551">b</span><br>
<span class="lineno">115</span><span class="op" id="1578553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1578556">//&nbsp;stk&nbsp;returns&nbsp;the&nbsp;slice&nbsp;in&nbsp;b&nbsp;holding&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1578605">func</span>&nbsp;<span class="op" id="1578610">(</span><span class="ident" id="1578611">b</span>&nbsp;<span class="op" id="1578613">*</span><span class="ident" id="1578614">bucket</span><span class="op" id="1578620">)</span>&nbsp;<span class="ident" id="1578622">stk</span><span class="op" id="1578625">(</span><span class="op" id="1578626">)</span>&nbsp;<span class="op" id="1578628">[</span><span class="op" id="1578629">]</span><span class="builtintype" id="1578630">uintptr</span>&nbsp;<span class="op" id="1578638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578641">stk</span>&nbsp;<span class="op" id="1578645">:=</span>&nbsp;<span class="op" id="1578648">(</span><span class="op" id="1578649">*</span><span class="op" id="1578650">[</span><span class="ident" id="1578651">maxStack</span><span class="op" id="1578659">]</span><span class="builtintype" id="1578660">uintptr</span><span class="op" id="1578667">)</span><span class="op" id="1578668">(</span><span class="ident" id="1578669">add</span><span class="op" id="1578672">(</span><span class="ident" id="1578673">unsafe</span><span class="op" id="1578679">.</span><span class="ident" id="1578680">Pointer</span><span class="op" id="1578687">(</span><span class="ident" id="1578688">b</span><span class="op" id="1578689">)</span><span class="op" id="1578690">,</span>&nbsp;<span class="ident" id="1578692">unsafe</span><span class="op" id="1578698">.</span><span class="ident" id="1578699">Sizeof</span><span class="op" id="1578705">(</span><span class="op" id="1578706">*</span><span class="ident" id="1578707">b</span><span class="op" id="1578708">)</span><span class="op" id="1578709">)</span><span class="op" id="1578710">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1578713">return</span>&nbsp;<span class="ident" id="1578720">stk</span><span class="op" id="1578723">[</span><span class="op" id="1578724">:</span><span class="ident" id="1578725">b</span><span class="op" id="1578726">.</span><span class="ident" id="1578727">nstk</span><span class="op" id="1578731">:</span><span class="ident" id="1578732">b</span><span class="op" id="1578733">.</span><span class="ident" id="1578734">nstk</span><span class="op" id="1578738">]</span><br>
<span class="lineno"></span><span class="op" id="1578740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1578743">//&nbsp;mp&nbsp;returns&nbsp;the&nbsp;memRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;memProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1578812">func</span>&nbsp;<span class="op" id="1578817">(</span><span class="ident" id="1578818">b</span>&nbsp;<span class="op" id="1578820">*</span><span class="ident" id="1578821">bucket</span><span class="op" id="1578827">)</span>&nbsp;<span class="ident" id="1578829">mp</span><span class="op" id="1578831">(</span><span class="op" id="1578832">)</span>&nbsp;<span class="op" id="1578834">*</span><span class="ident" id="1578835">memRecord</span>&nbsp;<span class="op" id="1578845">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1578848">if</span>&nbsp;<span class="ident" id="1578851">b</span><span class="op" id="1578852">.</span><span class="ident" id="1578853">typ</span>&nbsp;<span class="op" id="1578857">!=</span>&nbsp;<span class="ident" id="1578860">memProfile</span>&nbsp;<span class="op" id="1578871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578875">gothrow</span><span class="op" id="1578882">(</span><span class="string" id="1578883">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.mp&#34;</span><span class="op" id="1578905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1578908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578911">data</span>&nbsp;<span class="op" id="1578916">:=</span>&nbsp;<span class="ident" id="1578919">add</span><span class="op" id="1578922">(</span><span class="ident" id="1578923">unsafe</span><span class="op" id="1578929">.</span><span class="ident" id="1578930">Pointer</span><span class="op" id="1578937">(</span><span class="ident" id="1578938">b</span><span class="op" id="1578939">)</span><span class="op" id="1578940">,</span>&nbsp;<span class="ident" id="1578942">unsafe</span><span class="op" id="1578948">.</span><span class="ident" id="1578949">Sizeof</span><span class="op" id="1578955">(</span><span class="op" id="1578956">*</span><span class="ident" id="1578957">b</span><span class="op" id="1578958">)</span><span class="op" id="1578959">+</span><span class="ident" id="1578960">b</span><span class="op" id="1578961">.</span><span class="ident" id="1578962">nstk</span><span class="op" id="1578966">*</span><span class="ident" id="1578967">unsafe</span><span class="op" id="1578973">.</span><span class="ident" id="1578974">Sizeof</span><span class="op" id="1578980">(</span><span class="builtintype" id="1578981">uintptr</span><span class="op" id="1578988">(</span><span class="num" id="1578989">0</span><span class="op" id="1578990">)</span><span class="op" id="1578991">)</span><span class="op" id="1578992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1578995">return</span>&nbsp;<span class="op" id="1579002">(</span><span class="op" id="1579003">*</span><span class="ident" id="1579004">memRecord</span><span class="op" id="1579013">)</span><span class="op" id="1579014">(</span><span class="ident" id="1579015">data</span><span class="op" id="1579019">)</span><br>
<span class="lineno">130</span><span class="op" id="1579021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1579024">//&nbsp;bp&nbsp;returns&nbsp;the&nbsp;blockRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;blockProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1579097">func</span>&nbsp;<span class="op" id="1579102">(</span><span class="ident" id="1579103">b</span>&nbsp;<span class="op" id="1579105">*</span><span class="ident" id="1579106">bucket</span><span class="op" id="1579112">)</span>&nbsp;<span class="ident" id="1579114">bp</span><span class="op" id="1579116">(</span><span class="op" id="1579117">)</span>&nbsp;<span class="op" id="1579119">*</span><span class="ident" id="1579120">blockRecord</span>&nbsp;<span class="op" id="1579132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579135">if</span>&nbsp;<span class="ident" id="1579138">b</span><span class="op" id="1579139">.</span><span class="ident" id="1579140">typ</span>&nbsp;<span class="op" id="1579144">!=</span>&nbsp;<span class="ident" id="1579147">blockProfile</span>&nbsp;<span class="op" id="1579160">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579164">gothrow</span><span class="op" id="1579171">(</span><span class="string" id="1579172">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.bp&#34;</span><span class="op" id="1579194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1579197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579200">data</span>&nbsp;<span class="op" id="1579205">:=</span>&nbsp;<span class="ident" id="1579208">add</span><span class="op" id="1579211">(</span><span class="ident" id="1579212">unsafe</span><span class="op" id="1579218">.</span><span class="ident" id="1579219">Pointer</span><span class="op" id="1579226">(</span><span class="ident" id="1579227">b</span><span class="op" id="1579228">)</span><span class="op" id="1579229">,</span>&nbsp;<span class="ident" id="1579231">unsafe</span><span class="op" id="1579237">.</span><span class="ident" id="1579238">Sizeof</span><span class="op" id="1579244">(</span><span class="op" id="1579245">*</span><span class="ident" id="1579246">b</span><span class="op" id="1579247">)</span><span class="op" id="1579248">+</span><span class="ident" id="1579249">b</span><span class="op" id="1579250">.</span><span class="ident" id="1579251">nstk</span><span class="op" id="1579255">*</span><span class="ident" id="1579256">unsafe</span><span class="op" id="1579262">.</span><span class="ident" id="1579263">Sizeof</span><span class="op" id="1579269">(</span><span class="builtintype" id="1579270">uintptr</span><span class="op" id="1579277">(</span><span class="num" id="1579278">0</span><span class="op" id="1579279">)</span><span class="op" id="1579280">)</span><span class="op" id="1579281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579284">return</span>&nbsp;<span class="op" id="1579291">(</span><span class="op" id="1579292">*</span><span class="ident" id="1579293">blockRecord</span><span class="op" id="1579304">)</span><span class="op" id="1579305">(</span><span class="ident" id="1579306">data</span><span class="op" id="1579310">)</span><br>
<span class="lineno"></span><span class="op" id="1579312">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="1579315">//&nbsp;Return&nbsp;the&nbsp;bucket&nbsp;for&nbsp;stk[0:nstk],&nbsp;allocating&nbsp;new&nbsp;bucket&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="1579386">func</span>&nbsp;<span class="ident" id="1579391">stkbucket</span><span class="op" id="1579400">(</span><span class="ident" id="1579401">typ</span>&nbsp;<span class="ident" id="1579405">bucketType</span><span class="op" id="1579415">,</span>&nbsp;<span class="ident" id="1579417">size</span>&nbsp;<span class="builtintype" id="1579422">uintptr</span><span class="op" id="1579429">,</span>&nbsp;<span class="ident" id="1579431">stk</span>&nbsp;<span class="op" id="1579435">[</span><span class="op" id="1579436">]</span><span class="builtintype" id="1579437">uintptr</span><span class="op" id="1579444">,</span>&nbsp;<span class="ident" id="1579446">alloc</span>&nbsp;<span class="builtintype" id="1579452">bool</span><span class="op" id="1579456">)</span>&nbsp;<span class="op" id="1579458">*</span><span class="ident" id="1579459">bucket</span>&nbsp;<span class="op" id="1579466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579469">if</span>&nbsp;<span class="ident" id="1579472">buckhash</span>&nbsp;<span class="op" id="1579481">==</span>&nbsp;<span class="ident" id="1579484">nil</span>&nbsp;<span class="op" id="1579488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579492">buckhash</span>&nbsp;<span class="op" id="1579501">=</span>&nbsp;<span class="op" id="1579503">(</span><span class="op" id="1579504">*</span><span class="op" id="1579505">[</span><span class="ident" id="1579506">buckHashSize</span><span class="op" id="1579518">]</span><span class="op" id="1579519">*</span><span class="ident" id="1579520">bucket</span><span class="op" id="1579526">)</span><span class="op" id="1579527">(</span><span class="ident" id="1579528">sysAlloc</span><span class="op" id="1579536">(</span><span class="ident" id="1579537">unsafe</span><span class="op" id="1579543">.</span><span class="ident" id="1579544">Sizeof</span><span class="op" id="1579550">(</span><span class="op" id="1579551">*</span><span class="ident" id="1579552">buckhash</span><span class="op" id="1579560">)</span><span class="op" id="1579561">,</span>&nbsp;<span class="op" id="1579563">&amp;</span><span class="ident" id="1579564">memstats</span><span class="op" id="1579572">.</span><span class="ident" id="1579573">buckhash_sys</span><span class="op" id="1579585">)</span><span class="op" id="1579586">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579590">if</span>&nbsp;<span class="ident" id="1579593">buckhash</span>&nbsp;<span class="op" id="1579602">==</span>&nbsp;<span class="ident" id="1579605">nil</span>&nbsp;<span class="op" id="1579609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579614">gothrow</span><span class="op" id="1579621">(</span><span class="string" id="1579622">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1579655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1579659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1579662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579666">//&nbsp;Hash&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579682">var</span>&nbsp;<span class="ident" id="1579686">h</span>&nbsp;<span class="builtintype" id="1579688">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579697">for</span>&nbsp;<span class="ident" id="1579701">_</span><span class="op" id="1579702">,</span>&nbsp;<span class="ident" id="1579704">pc</span>&nbsp;<span class="op" id="1579707">:=</span>&nbsp;<span class="keyword" id="1579710">range</span>&nbsp;<span class="ident" id="1579716">stk</span>&nbsp;<span class="op" id="1579720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579724">h</span>&nbsp;<span class="op" id="1579726">+=</span>&nbsp;<span class="ident" id="1579729">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579734">h</span>&nbsp;<span class="op" id="1579736">+=</span>&nbsp;<span class="ident" id="1579739">h</span>&nbsp;<span class="op" id="1579741">&lt;&lt;</span>&nbsp;<span class="num" id="1579744">10</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579749">h</span>&nbsp;<span class="op" id="1579751">^=</span>&nbsp;<span class="ident" id="1579754">h</span>&nbsp;<span class="op" id="1579756">&gt;&gt;</span>&nbsp;<span class="num" id="1579759">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1579762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579765">//&nbsp;hash&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579782">h</span>&nbsp;<span class="op" id="1579784">+=</span>&nbsp;<span class="ident" id="1579787">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579793">h</span>&nbsp;<span class="op" id="1579795">+=</span>&nbsp;<span class="ident" id="1579798">h</span>&nbsp;<span class="op" id="1579800">&lt;&lt;</span>&nbsp;<span class="num" id="1579803">10</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579807">h</span>&nbsp;<span class="op" id="1579809">^=</span>&nbsp;<span class="ident" id="1579812">h</span>&nbsp;<span class="op" id="1579814">&gt;&gt;</span>&nbsp;<span class="num" id="1579817">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1579820">//&nbsp;finalize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579833">h</span>&nbsp;<span class="op" id="1579835">+=</span>&nbsp;<span class="ident" id="1579838">h</span>&nbsp;<span class="op" id="1579840">&lt;&lt;</span>&nbsp;<span class="num" id="1579843">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579846">h</span>&nbsp;<span class="op" id="1579848">^=</span>&nbsp;<span class="ident" id="1579851">h</span>&nbsp;<span class="op" id="1579853">&gt;&gt;</span>&nbsp;<span class="num" id="1579856">11</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1579861">i</span>&nbsp;<span class="op" id="1579863">:=</span>&nbsp;<span class="builtintype" id="1579866">int</span><span class="op" id="1579869">(</span><span class="ident" id="1579870">h</span>&nbsp;<span class="op" id="1579872">%</span>&nbsp;<span class="ident" id="1579874">buckHashSize</span><span class="op" id="1579886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579889">for</span>&nbsp;<span class="ident" id="1579893">b</span>&nbsp;<span class="op" id="1579895">:=</span>&nbsp;<span class="ident" id="1579898">buckhash</span><span class="op" id="1579906">[</span><span class="ident" id="1579907">i</span><span class="op" id="1579908">]</span><span class="op" id="1579909">;</span>&nbsp;<span class="ident" id="1579911">b</span>&nbsp;<span class="op" id="1579913">!=</span>&nbsp;<span class="ident" id="1579916">nil</span><span class="op" id="1579919">;</span>&nbsp;<span class="ident" id="1579921">b</span>&nbsp;<span class="op" id="1579923">=</span>&nbsp;<span class="ident" id="1579925">b</span><span class="op" id="1579926">.</span><span class="ident" id="1579927">next</span>&nbsp;<span class="op" id="1579932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1579936">if</span>&nbsp;<span class="ident" id="1579939">b</span><span class="op" id="1579940">.</span><span class="ident" id="1579941">typ</span>&nbsp;<span class="op" id="1579945">==</span>&nbsp;<span class="ident" id="1579948">typ</span>&nbsp;<span class="op" id="1579952">&amp;&amp;</span>&nbsp;<span class="ident" id="1579955">b</span><span class="op" id="1579956">.</span><span class="ident" id="1579957">hash</span>&nbsp;<span class="op" id="1579962">==</span>&nbsp;<span class="ident" id="1579965">h</span>&nbsp;<span class="op" id="1579967">&amp;&amp;</span>&nbsp;<span class="ident" id="1579970">b</span><span class="op" id="1579971">.</span><span class="ident" id="1579972">size</span>&nbsp;<span class="op" id="1579977">==</span>&nbsp;<span class="ident" id="1579980">size</span>&nbsp;<span class="op" id="1579985">&amp;&amp;</span>&nbsp;<span class="ident" id="1579988">eqslice</span><span class="op" id="1579995">(</span><span class="ident" id="1579996">b</span><span class="op" id="1579997">.</span><span class="ident" id="1579998">stk</span><span class="op" id="1580001">(</span><span class="op" id="1580002">)</span><span class="op" id="1580003">,</span>&nbsp;<span class="ident" id="1580005">stk</span><span class="op" id="1580008">)</span>&nbsp;<span class="op" id="1580010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580015">return</span>&nbsp;<span class="ident" id="1580022">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580026">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580033">if</span>&nbsp;<span class="op" id="1580036">!</span><span class="ident" id="1580037">alloc</span>&nbsp;<span class="op" id="1580043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580047">return</span>&nbsp;<span class="ident" id="1580054">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580059">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1580063">//&nbsp;Create&nbsp;new&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580086">b</span>&nbsp;<span class="op" id="1580088">:=</span>&nbsp;<span class="ident" id="1580091">newBucket</span><span class="op" id="1580100">(</span><span class="ident" id="1580101">typ</span><span class="op" id="1580104">,</span>&nbsp;<span class="builtinfunc" id="1580106">len</span><span class="op" id="1580109">(</span><span class="ident" id="1580110">stk</span><span class="op" id="1580113">)</span><span class="op" id="1580114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1580117">copy</span><span class="op" id="1580121">(</span><span class="ident" id="1580122">b</span><span class="op" id="1580123">.</span><span class="ident" id="1580124">stk</span><span class="op" id="1580127">(</span><span class="op" id="1580128">)</span><span class="op" id="1580129">,</span>&nbsp;<span class="ident" id="1580131">stk</span><span class="op" id="1580134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580137">b</span><span class="op" id="1580138">.</span><span class="ident" id="1580139">hash</span>&nbsp;<span class="op" id="1580144">=</span>&nbsp;<span class="ident" id="1580146">h</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580149">b</span><span class="op" id="1580150">.</span><span class="ident" id="1580151">size</span>&nbsp;<span class="op" id="1580156">=</span>&nbsp;<span class="ident" id="1580158">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580164">b</span><span class="op" id="1580165">.</span><span class="ident" id="1580166">next</span>&nbsp;<span class="op" id="1580171">=</span>&nbsp;<span class="ident" id="1580173">buckhash</span><span class="op" id="1580181">[</span><span class="ident" id="1580182">i</span><span class="op" id="1580183">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580186">buckhash</span><span class="op" id="1580194">[</span><span class="ident" id="1580195">i</span><span class="op" id="1580196">]</span>&nbsp;<span class="op" id="1580198">=</span>&nbsp;<span class="ident" id="1580200">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580203">if</span>&nbsp;<span class="ident" id="1580206">typ</span>&nbsp;<span class="op" id="1580210">==</span>&nbsp;<span class="ident" id="1580213">memProfile</span>&nbsp;<span class="op" id="1580224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580228">b</span><span class="op" id="1580229">.</span><span class="ident" id="1580230">allnext</span>&nbsp;<span class="op" id="1580238">=</span>&nbsp;<span class="ident" id="1580240">mbuckets</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580251">mbuckets</span>&nbsp;<span class="op" id="1580260">=</span>&nbsp;<span class="ident" id="1580262">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580265">}</span>&nbsp;<span class="keyword" id="1580267">else</span>&nbsp;<span class="op" id="1580272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580276">b</span><span class="op" id="1580277">.</span><span class="ident" id="1580278">allnext</span>&nbsp;<span class="op" id="1580286">=</span>&nbsp;<span class="ident" id="1580288">bbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580299">bbuckets</span>&nbsp;<span class="op" id="1580308">=</span>&nbsp;<span class="ident" id="1580310">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580313">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580316">return</span>&nbsp;<span class="ident" id="1580323">b</span><br>
<span class="lineno"></span><span class="op" id="1580325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1580328">func</span>&nbsp;<span class="ident" id="1580333">sysAlloc</span><span class="op" id="1580341">(</span><span class="ident" id="1580342">n</span>&nbsp;<span class="builtintype" id="1580344">uintptr</span><span class="op" id="1580351">,</span>&nbsp;<span class="ident" id="1580353">stat</span>&nbsp;<span class="op" id="1580358">*</span><span class="ident" id="1580359">uint64</span><span class="op" id="1580365">)</span>&nbsp;<span class="ident" id="1580367">unsafe</span><span class="op" id="1580373">.</span><span class="ident" id="1580374">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="1580383">func</span>&nbsp;<span class="ident" id="1580388">eqslice</span><span class="op" id="1580395">(</span><span class="ident" id="1580396">x</span><span class="op" id="1580397">,</span>&nbsp;<span class="ident" id="1580399">y</span>&nbsp;<span class="op" id="1580401">[</span><span class="op" id="1580402">]</span><span class="builtintype" id="1580403">uintptr</span><span class="op" id="1580410">)</span>&nbsp;<span class="builtintype" id="1580412">bool</span>&nbsp;<span class="op" id="1580417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580420">if</span>&nbsp;<span class="builtinfunc" id="1580423">len</span><span class="op" id="1580426">(</span><span class="ident" id="1580427">x</span><span class="op" id="1580428">)</span>&nbsp;<span class="op" id="1580430">!=</span>&nbsp;<span class="builtinfunc" id="1580433">len</span><span class="op" id="1580436">(</span><span class="ident" id="1580437">y</span><span class="op" id="1580438">)</span>&nbsp;<span class="op" id="1580440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580444">return</span>&nbsp;<span class="builtintype" id="1580451">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580461">for</span>&nbsp;<span class="ident" id="1580465">i</span><span class="op" id="1580466">,</span>&nbsp;<span class="ident" id="1580468">xi</span>&nbsp;<span class="op" id="1580471">:=</span>&nbsp;<span class="keyword" id="1580474">range</span>&nbsp;<span class="ident" id="1580480">x</span>&nbsp;<span class="op" id="1580482">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580486">if</span>&nbsp;<span class="ident" id="1580489">xi</span>&nbsp;<span class="op" id="1580492">!=</span>&nbsp;<span class="ident" id="1580495">y</span><span class="op" id="1580496">[</span><span class="ident" id="1580497">i</span><span class="op" id="1580498">]</span>&nbsp;<span class="op" id="1580500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580505">return</span>&nbsp;<span class="builtintype" id="1580512">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1580523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580526">return</span>&nbsp;<span class="builtintype" id="1580533">true</span><br>
<span class="lineno">205</span><span class="op" id="1580538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1580541">func</span>&nbsp;<span class="ident" id="1580546">mprof_GC</span><span class="op" id="1580554">(</span><span class="op" id="1580555">)</span>&nbsp;<span class="op" id="1580557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1580560">for</span>&nbsp;<span class="ident" id="1580564">b</span>&nbsp;<span class="op" id="1580566">:=</span>&nbsp;<span class="ident" id="1580569">mbuckets</span><span class="op" id="1580577">;</span>&nbsp;<span class="ident" id="1580579">b</span>&nbsp;<span class="op" id="1580581">!=</span>&nbsp;<span class="ident" id="1580584">nil</span><span class="op" id="1580587">;</span>&nbsp;<span class="ident" id="1580589">b</span>&nbsp;<span class="op" id="1580591">=</span>&nbsp;<span class="ident" id="1580593">b</span><span class="op" id="1580594">.</span><span class="ident" id="1580595">allnext</span>&nbsp;<span class="op" id="1580603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580607">mp</span>&nbsp;<span class="op" id="1580610">:=</span>&nbsp;<span class="ident" id="1580613">b</span><span class="op" id="1580614">.</span><span class="ident" id="1580615">mp</span><span class="op" id="1580617">(</span><span class="op" id="1580618">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580622">mp</span><span class="op" id="1580624">.</span><span class="ident" id="1580625">allocs</span>&nbsp;<span class="op" id="1580632">+=</span>&nbsp;<span class="ident" id="1580635">mp</span><span class="op" id="1580637">.</span><span class="ident" id="1580638">prev_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580652">mp</span><span class="op" id="1580654">.</span><span class="ident" id="1580655">frees</span>&nbsp;<span class="op" id="1580661">+=</span>&nbsp;<span class="ident" id="1580664">mp</span><span class="op" id="1580666">.</span><span class="ident" id="1580667">prev_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580680">mp</span><span class="op" id="1580682">.</span><span class="ident" id="1580683">alloc_bytes</span>&nbsp;<span class="op" id="1580695">+=</span>&nbsp;<span class="ident" id="1580698">mp</span><span class="op" id="1580700">.</span><span class="ident" id="1580701">prev_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580720">mp</span><span class="op" id="1580722">.</span><span class="ident" id="1580723">free_bytes</span>&nbsp;<span class="op" id="1580734">+=</span>&nbsp;<span class="ident" id="1580737">mp</span><span class="op" id="1580739">.</span><span class="ident" id="1580740">prev_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580759">mp</span><span class="op" id="1580761">.</span><span class="ident" id="1580762">prev_allocs</span>&nbsp;<span class="op" id="1580774">=</span>&nbsp;<span class="ident" id="1580776">mp</span><span class="op" id="1580778">.</span><span class="ident" id="1580779">recent_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580795">mp</span><span class="op" id="1580797">.</span><span class="ident" id="1580798">prev_frees</span>&nbsp;<span class="op" id="1580809">=</span>&nbsp;<span class="ident" id="1580811">mp</span><span class="op" id="1580813">.</span><span class="ident" id="1580814">recent_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580829">mp</span><span class="op" id="1580831">.</span><span class="ident" id="1580832">prev_alloc_bytes</span>&nbsp;<span class="op" id="1580849">=</span>&nbsp;<span class="ident" id="1580851">mp</span><span class="op" id="1580853">.</span><span class="ident" id="1580854">recent_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580875">mp</span><span class="op" id="1580877">.</span><span class="ident" id="1580878">prev_free_bytes</span>&nbsp;<span class="op" id="1580894">=</span>&nbsp;<span class="ident" id="1580896">mp</span><span class="op" id="1580898">.</span><span class="ident" id="1580899">recent_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580920">mp</span><span class="op" id="1580922">.</span><span class="ident" id="1580923">recent_allocs</span>&nbsp;<span class="op" id="1580937">=</span>&nbsp;<span class="num" id="1580939">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580943">mp</span><span class="op" id="1580945">.</span><span class="ident" id="1580946">recent_frees</span>&nbsp;<span class="op" id="1580959">=</span>&nbsp;<span class="num" id="1580961">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580965">mp</span><span class="op" id="1580967">.</span><span class="ident" id="1580968">recent_alloc_bytes</span>&nbsp;<span class="op" id="1580987">=</span>&nbsp;<span class="num" id="1580989">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1580993">mp</span><span class="op" id="1580995">.</span><span class="ident" id="1580996">recent_free_bytes</span>&nbsp;<span class="op" id="1581014">=</span>&nbsp;<span class="num" id="1581016">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1581019">}</span><br>
<span class="lineno">225</span><span class="op" id="1581021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1581024">//&nbsp;Record&nbsp;that&nbsp;a&nbsp;gc&nbsp;just&nbsp;happened:&nbsp;all&nbsp;the&nbsp;&#39;recent&#39;&nbsp;statistics&nbsp;are&nbsp;now&nbsp;real.</span><br>
<span class="lineno"></span><span class="keyword" id="1581101">func</span>&nbsp;<span class="ident" id="1581106">mProf_GC</span><span class="op" id="1581114">(</span><span class="op" id="1581115">)</span>&nbsp;<span class="op" id="1581117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581120">lock</span><span class="op" id="1581124">(</span><span class="op" id="1581125">&amp;</span><span class="ident" id="1581126">proflock</span><span class="op" id="1581134">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581137">mprof_GC</span><span class="op" id="1581145">(</span><span class="op" id="1581146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581149">unlock</span><span class="op" id="1581155">(</span><span class="op" id="1581156">&amp;</span><span class="ident" id="1581157">proflock</span><span class="op" id="1581165">)</span><br>
<span class="lineno"></span><span class="op" id="1581167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1581170">//&nbsp;Called&nbsp;by&nbsp;malloc&nbsp;to&nbsp;record&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno">235</span><span class="keyword" id="1581218">func</span>&nbsp;<span class="ident" id="1581223">mProf_Malloc</span><span class="op" id="1581235">(</span><span class="ident" id="1581236">p</span>&nbsp;<span class="ident" id="1581238">unsafe</span><span class="op" id="1581244">.</span><span class="ident" id="1581245">Pointer</span><span class="op" id="1581252">,</span>&nbsp;<span class="ident" id="1581254">size</span>&nbsp;<span class="builtintype" id="1581259">uintptr</span><span class="op" id="1581266">)</span>&nbsp;<span class="op" id="1581268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1581271">var</span>&nbsp;<span class="ident" id="1581275">stk</span>&nbsp;<span class="op" id="1581279">[</span><span class="ident" id="1581280">maxStack</span><span class="op" id="1581288">]</span><span class="builtintype" id="1581289">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581298">nstk</span>&nbsp;<span class="op" id="1581303">:=</span>&nbsp;<span class="ident" id="1581306">callers</span><span class="op" id="1581313">(</span><span class="num" id="1581314">4</span><span class="op" id="1581315">,</span>&nbsp;<span class="op" id="1581317">&amp;</span><span class="ident" id="1581318">stk</span><span class="op" id="1581321">[</span><span class="num" id="1581322">0</span><span class="op" id="1581323">]</span><span class="op" id="1581324">,</span>&nbsp;<span class="builtinfunc" id="1581326">len</span><span class="op" id="1581329">(</span><span class="ident" id="1581330">stk</span><span class="op" id="1581333">)</span><span class="op" id="1581334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581337">lock</span><span class="op" id="1581341">(</span><span class="op" id="1581342">&amp;</span><span class="ident" id="1581343">proflock</span><span class="op" id="1581351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581354">b</span>&nbsp;<span class="op" id="1581356">:=</span>&nbsp;<span class="ident" id="1581359">stkbucket</span><span class="op" id="1581368">(</span><span class="ident" id="1581369">memProfile</span><span class="op" id="1581379">,</span>&nbsp;<span class="ident" id="1581381">size</span><span class="op" id="1581385">,</span>&nbsp;<span class="ident" id="1581387">stk</span><span class="op" id="1581390">[</span><span class="op" id="1581391">:</span><span class="ident" id="1581392">nstk</span><span class="op" id="1581396">]</span><span class="op" id="1581397">,</span>&nbsp;<span class="builtintype" id="1581399">true</span><span class="op" id="1581403">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581406">mp</span>&nbsp;<span class="op" id="1581409">:=</span>&nbsp;<span class="ident" id="1581412">b</span><span class="op" id="1581413">.</span><span class="ident" id="1581414">mp</span><span class="op" id="1581416">(</span><span class="op" id="1581417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581420">mp</span><span class="op" id="1581422">.</span><span class="ident" id="1581423">recent_allocs</span><span class="op" id="1581436">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581440">mp</span><span class="op" id="1581442">.</span><span class="ident" id="1581443">recent_alloc_bytes</span>&nbsp;<span class="op" id="1581462">+=</span>&nbsp;<span class="ident" id="1581465">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581471">unlock</span><span class="op" id="1581477">(</span><span class="op" id="1581478">&amp;</span><span class="ident" id="1581479">proflock</span><span class="op" id="1581487">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581491">//&nbsp;Setprofilebucket&nbsp;locks&nbsp;a&nbsp;bunch&nbsp;of&nbsp;other&nbsp;mutexes,&nbsp;so&nbsp;we&nbsp;call&nbsp;it&nbsp;outside&nbsp;of&nbsp;proflock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581579">//&nbsp;This&nbsp;reduces&nbsp;potential&nbsp;contention&nbsp;and&nbsp;chances&nbsp;of&nbsp;deadlocks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581643">//&nbsp;Since&nbsp;the&nbsp;object&nbsp;must&nbsp;be&nbsp;alive&nbsp;during&nbsp;call&nbsp;to&nbsp;mProf_Malloc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1581707">//&nbsp;it&#39;s&nbsp;fine&nbsp;to&nbsp;do&nbsp;this&nbsp;non-atomically.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581748">setprofilebucket</span><span class="op" id="1581764">(</span><span class="ident" id="1581765">p</span><span class="op" id="1581766">,</span>&nbsp;<span class="ident" id="1581768">b</span><span class="op" id="1581769">)</span><br>
<span class="lineno">250</span><span class="op" id="1581771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1581774">func</span>&nbsp;<span class="ident" id="1581779">setprofilebucket_m</span><span class="op" id="1581797">(</span><span class="op" id="1581798">)</span>&nbsp;<span class="comment" id="1581800">//&nbsp;mheap.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1581812">func</span>&nbsp;<span class="ident" id="1581817">setprofilebucket</span><span class="op" id="1581833">(</span><span class="ident" id="1581834">p</span>&nbsp;<span class="ident" id="1581836">unsafe</span><span class="op" id="1581842">.</span><span class="ident" id="1581843">Pointer</span><span class="op" id="1581850">,</span>&nbsp;<span class="ident" id="1581852">b</span>&nbsp;<span class="op" id="1581854">*</span><span class="ident" id="1581855">bucket</span><span class="op" id="1581861">)</span>&nbsp;<span class="op" id="1581863">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581866">g</span>&nbsp;<span class="op" id="1581868">:=</span>&nbsp;<span class="ident" id="1581871">getg</span><span class="op" id="1581875">(</span><span class="op" id="1581876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581879">g</span><span class="op" id="1581880">.</span><span class="ident" id="1581881">m</span><span class="op" id="1581882">.</span><span class="ident" id="1581883">ptrarg</span><span class="op" id="1581889">[</span><span class="num" id="1581890">0</span><span class="op" id="1581891">]</span>&nbsp;<span class="op" id="1581893">=</span>&nbsp;<span class="ident" id="1581895">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581898">g</span><span class="op" id="1581899">.</span><span class="ident" id="1581900">m</span><span class="op" id="1581901">.</span><span class="ident" id="1581902">ptrarg</span><span class="op" id="1581908">[</span><span class="num" id="1581909">1</span><span class="op" id="1581910">]</span>&nbsp;<span class="op" id="1581912">=</span>&nbsp;<span class="ident" id="1581914">unsafe</span><span class="op" id="1581920">.</span><span class="ident" id="1581921">Pointer</span><span class="op" id="1581928">(</span><span class="ident" id="1581929">b</span><span class="op" id="1581930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1581933">onM</span><span class="op" id="1581936">(</span><span class="ident" id="1581937">setprofilebucket_m</span><span class="op" id="1581955">)</span><br>
<span class="lineno"></span><span class="op" id="1581957">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="1581960">//&nbsp;Called&nbsp;when&nbsp;freeing&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="1582001">func</span>&nbsp;<span class="ident" id="1582006">mProf_Free</span><span class="op" id="1582016">(</span><span class="ident" id="1582017">b</span>&nbsp;<span class="op" id="1582019">*</span><span class="ident" id="1582020">bucket</span><span class="op" id="1582026">,</span>&nbsp;<span class="ident" id="1582028">size</span>&nbsp;<span class="builtintype" id="1582033">uintptr</span><span class="op" id="1582040">,</span>&nbsp;<span class="ident" id="1582042">freed</span>&nbsp;<span class="builtintype" id="1582048">bool</span><span class="op" id="1582052">)</span>&nbsp;<span class="op" id="1582054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582057">lock</span><span class="op" id="1582061">(</span><span class="op" id="1582062">&amp;</span><span class="ident" id="1582063">proflock</span><span class="op" id="1582071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582074">mp</span>&nbsp;<span class="op" id="1582077">:=</span>&nbsp;<span class="ident" id="1582080">b</span><span class="op" id="1582081">.</span><span class="ident" id="1582082">mp</span><span class="op" id="1582084">(</span><span class="op" id="1582085">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582088">if</span>&nbsp;<span class="ident" id="1582091">freed</span>&nbsp;<span class="op" id="1582097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582101">mp</span><span class="op" id="1582103">.</span><span class="ident" id="1582104">recent_frees</span><span class="op" id="1582116">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582121">mp</span><span class="op" id="1582123">.</span><span class="ident" id="1582124">recent_free_bytes</span>&nbsp;<span class="op" id="1582142">+=</span>&nbsp;<span class="ident" id="1582145">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582151">}</span>&nbsp;<span class="keyword" id="1582153">else</span>&nbsp;<span class="op" id="1582158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582162">mp</span><span class="op" id="1582164">.</span><span class="ident" id="1582165">prev_frees</span><span class="op" id="1582175">++</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582180">mp</span><span class="op" id="1582182">.</span><span class="ident" id="1582183">prev_free_bytes</span>&nbsp;<span class="op" id="1582199">+=</span>&nbsp;<span class="ident" id="1582202">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582211">unlock</span><span class="op" id="1582217">(</span><span class="op" id="1582218">&amp;</span><span class="ident" id="1582219">proflock</span><span class="op" id="1582227">)</span><br>
<span class="lineno"></span><span class="op" id="1582229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="1582232">var</span>&nbsp;<span class="ident" id="1582236">blockprofilerate</span>&nbsp;<span class="ident" id="1582253">uint64</span>&nbsp;<span class="comment" id="1582260">//&nbsp;in&nbsp;CPU&nbsp;ticks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1582277">//&nbsp;SetBlockProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;goroutine&nbsp;blocking&nbsp;events</span><br>
<span class="lineno"></span><span class="comment" id="1582351">//&nbsp;that&nbsp;are&nbsp;reported&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.&nbsp;&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample</span><br>
<span class="lineno"></span><span class="comment" id="1582426">//&nbsp;an&nbsp;average&nbsp;of&nbsp;one&nbsp;blocking&nbsp;event&nbsp;per&nbsp;rate&nbsp;nanoseconds&nbsp;spent&nbsp;blocked.</span><br>
<span class="lineno">280</span><span class="comment" id="1582498">//</span><br>
<span class="lineno"></span><span class="comment" id="1582501">//&nbsp;To&nbsp;include&nbsp;every&nbsp;blocking&nbsp;event&nbsp;in&nbsp;the&nbsp;profile,&nbsp;pass&nbsp;rate&nbsp;=&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1582567">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;pass&nbsp;rate&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="1582618">func</span>&nbsp;<span class="ident" id="1582623">SetBlockProfileRate</span><span class="op" id="1582642">(</span><span class="ident" id="1582643">rate</span>&nbsp;<span class="builtintype" id="1582648">int</span><span class="op" id="1582651">)</span>&nbsp;<span class="op" id="1582653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582656">var</span>&nbsp;<span class="ident" id="1582660">r</span>&nbsp;<span class="ident" id="1582662">int64</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582669">if</span>&nbsp;<span class="ident" id="1582672">rate</span>&nbsp;<span class="op" id="1582677">&lt;=</span>&nbsp;<span class="num" id="1582680">0</span>&nbsp;<span class="op" id="1582682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582686">r</span>&nbsp;<span class="op" id="1582688">=</span>&nbsp;<span class="num" id="1582690">0</span>&nbsp;<span class="comment" id="1582692">//&nbsp;disable&nbsp;profiling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582714">}</span>&nbsp;<span class="keyword" id="1582716">else</span>&nbsp;<span class="keyword" id="1582721">if</span>&nbsp;<span class="ident" id="1582724">rate</span>&nbsp;<span class="op" id="1582729">==</span>&nbsp;<span class="num" id="1582732">1</span>&nbsp;<span class="op" id="1582734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582738">r</span>&nbsp;<span class="op" id="1582740">=</span>&nbsp;<span class="num" id="1582742">1</span>&nbsp;<span class="comment" id="1582744">//&nbsp;profile&nbsp;everything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582767">}</span>&nbsp;<span class="keyword" id="1582769">else</span>&nbsp;<span class="op" id="1582774">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1582778">//&nbsp;convert&nbsp;ns&nbsp;to&nbsp;cycles,&nbsp;use&nbsp;float64&nbsp;to&nbsp;prevent&nbsp;overflow&nbsp;during&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582859">r</span>&nbsp;<span class="op" id="1582861">=</span>&nbsp;<span class="ident" id="1582863">int64</span><span class="op" id="1582868">(</span><span class="builtintype" id="1582869">float64</span><span class="op" id="1582876">(</span><span class="ident" id="1582877">rate</span><span class="op" id="1582881">)</span>&nbsp;<span class="op" id="1582883">*</span>&nbsp;<span class="builtintype" id="1582885">float64</span><span class="op" id="1582892">(</span><span class="ident" id="1582893">tickspersecond</span><span class="op" id="1582907">(</span><span class="op" id="1582908">)</span><span class="op" id="1582909">)</span>&nbsp;<span class="op" id="1582911">/</span>&nbsp;<span class="op" id="1582913">(</span><span class="num" id="1582914">1000</span>&nbsp;<span class="op" id="1582919">*</span>&nbsp;<span class="num" id="1582921">1000</span>&nbsp;<span class="op" id="1582926">*</span>&nbsp;<span class="num" id="1582928">1000</span><span class="op" id="1582932">)</span><span class="op" id="1582933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1582937">if</span>&nbsp;<span class="ident" id="1582940">r</span>&nbsp;<span class="op" id="1582942">==</span>&nbsp;<span class="num" id="1582945">0</span>&nbsp;<span class="op" id="1582947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582952">r</span>&nbsp;<span class="op" id="1582954">=</span>&nbsp;<span class="num" id="1582956">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582960">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1582963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1582967">atomicstore64</span><span class="op" id="1582980">(</span><span class="op" id="1582981">&amp;</span><span class="ident" id="1582982">blockprofilerate</span><span class="op" id="1582998">,</span>&nbsp;<span class="ident" id="1583000">uint64</span><span class="op" id="1583006">(</span><span class="ident" id="1583007">r</span><span class="op" id="1583008">)</span><span class="op" id="1583009">)</span><br>
<span class="lineno"></span><span class="op" id="1583011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="keyword" id="1583014">func</span>&nbsp;<span class="ident" id="1583019">blockevent</span><span class="op" id="1583029">(</span><span class="ident" id="1583030">cycles</span>&nbsp;<span class="ident" id="1583037">int64</span><span class="op" id="1583042">,</span>&nbsp;<span class="ident" id="1583044">skip</span>&nbsp;<span class="builtintype" id="1583049">int</span><span class="op" id="1583052">)</span>&nbsp;<span class="op" id="1583054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583057">if</span>&nbsp;<span class="ident" id="1583060">cycles</span>&nbsp;<span class="op" id="1583067">&lt;=</span>&nbsp;<span class="num" id="1583070">0</span>&nbsp;<span class="op" id="1583072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583076">cycles</span>&nbsp;<span class="op" id="1583083">=</span>&nbsp;<span class="num" id="1583085">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583091">rate</span>&nbsp;<span class="op" id="1583096">:=</span>&nbsp;<span class="ident" id="1583099">int64</span><span class="op" id="1583104">(</span><span class="ident" id="1583105">atomicload64</span><span class="op" id="1583117">(</span><span class="op" id="1583118">&amp;</span><span class="ident" id="1583119">blockprofilerate</span><span class="op" id="1583135">)</span><span class="op" id="1583136">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583139">if</span>&nbsp;<span class="ident" id="1583142">rate</span>&nbsp;<span class="op" id="1583147">&lt;=</span>&nbsp;<span class="num" id="1583150">0</span>&nbsp;<span class="op" id="1583152">||</span>&nbsp;<span class="op" id="1583155">(</span><span class="ident" id="1583156">rate</span>&nbsp;<span class="op" id="1583161">&gt;</span>&nbsp;<span class="ident" id="1583163">cycles</span>&nbsp;<span class="op" id="1583170">&amp;&amp;</span>&nbsp;<span class="ident" id="1583173">int64</span><span class="op" id="1583178">(</span><span class="ident" id="1583179">fastrand1</span><span class="op" id="1583188">(</span><span class="op" id="1583189">)</span><span class="op" id="1583190">)</span><span class="op" id="1583191">%</span><span class="ident" id="1583192">rate</span>&nbsp;<span class="op" id="1583197">&gt;</span>&nbsp;<span class="ident" id="1583199">cycles</span><span class="op" id="1583205">)</span>&nbsp;<span class="op" id="1583207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583211">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583222">gp</span>&nbsp;<span class="op" id="1583225">:=</span>&nbsp;<span class="ident" id="1583228">getg</span><span class="op" id="1583232">(</span><span class="op" id="1583233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583236">var</span>&nbsp;<span class="ident" id="1583240">nstk</span>&nbsp;<span class="builtintype" id="1583245">int</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583250">var</span>&nbsp;<span class="ident" id="1583254">stk</span>&nbsp;<span class="op" id="1583258">[</span><span class="ident" id="1583259">maxStack</span><span class="op" id="1583267">]</span><span class="builtintype" id="1583268">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583277">if</span>&nbsp;<span class="ident" id="1583280">gp</span><span class="op" id="1583282">.</span><span class="ident" id="1583283">m</span><span class="op" id="1583284">.</span><span class="ident" id="1583285">curg</span>&nbsp;<span class="op" id="1583290">==</span>&nbsp;<span class="ident" id="1583293">nil</span>&nbsp;<span class="op" id="1583297">||</span>&nbsp;<span class="ident" id="1583300">gp</span><span class="op" id="1583302">.</span><span class="ident" id="1583303">m</span><span class="op" id="1583304">.</span><span class="ident" id="1583305">curg</span>&nbsp;<span class="op" id="1583310">==</span>&nbsp;<span class="ident" id="1583313">gp</span>&nbsp;<span class="op" id="1583316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583320">nstk</span>&nbsp;<span class="op" id="1583325">=</span>&nbsp;<span class="ident" id="1583327">callers</span><span class="op" id="1583334">(</span><span class="ident" id="1583335">skip</span><span class="op" id="1583339">,</span>&nbsp;<span class="op" id="1583341">&amp;</span><span class="ident" id="1583342">stk</span><span class="op" id="1583345">[</span><span class="num" id="1583346">0</span><span class="op" id="1583347">]</span><span class="op" id="1583348">,</span>&nbsp;<span class="builtinfunc" id="1583350">len</span><span class="op" id="1583353">(</span><span class="ident" id="1583354">stk</span><span class="op" id="1583357">)</span><span class="op" id="1583358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583361">}</span>&nbsp;<span class="keyword" id="1583363">else</span>&nbsp;<span class="op" id="1583368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583372">nstk</span>&nbsp;<span class="op" id="1583377">=</span>&nbsp;<span class="ident" id="1583379">gcallers</span><span class="op" id="1583387">(</span><span class="ident" id="1583388">gp</span><span class="op" id="1583390">.</span><span class="ident" id="1583391">m</span><span class="op" id="1583392">.</span><span class="ident" id="1583393">curg</span><span class="op" id="1583397">,</span>&nbsp;<span class="ident" id="1583399">skip</span><span class="op" id="1583403">,</span>&nbsp;<span class="op" id="1583405">&amp;</span><span class="ident" id="1583406">stk</span><span class="op" id="1583409">[</span><span class="num" id="1583410">0</span><span class="op" id="1583411">]</span><span class="op" id="1583412">,</span>&nbsp;<span class="builtinfunc" id="1583414">len</span><span class="op" id="1583417">(</span><span class="ident" id="1583418">stk</span><span class="op" id="1583421">)</span><span class="op" id="1583422">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583428">lock</span><span class="op" id="1583432">(</span><span class="op" id="1583433">&amp;</span><span class="ident" id="1583434">proflock</span><span class="op" id="1583442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583445">b</span>&nbsp;<span class="op" id="1583447">:=</span>&nbsp;<span class="ident" id="1583450">stkbucket</span><span class="op" id="1583459">(</span><span class="ident" id="1583460">blockProfile</span><span class="op" id="1583472">,</span>&nbsp;<span class="num" id="1583474">0</span><span class="op" id="1583475">,</span>&nbsp;<span class="ident" id="1583477">stk</span><span class="op" id="1583480">[</span><span class="op" id="1583481">:</span><span class="ident" id="1583482">nstk</span><span class="op" id="1583486">]</span><span class="op" id="1583487">,</span>&nbsp;<span class="builtintype" id="1583489">true</span><span class="op" id="1583493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583496">b</span><span class="op" id="1583497">.</span><span class="ident" id="1583498">bp</span><span class="op" id="1583500">(</span><span class="op" id="1583501">)</span><span class="op" id="1583502">.</span><span class="ident" id="1583503">count</span><span class="op" id="1583508">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583512">b</span><span class="op" id="1583513">.</span><span class="ident" id="1583514">bp</span><span class="op" id="1583516">(</span><span class="op" id="1583517">)</span><span class="op" id="1583518">.</span><span class="ident" id="1583519">cycles</span>&nbsp;<span class="op" id="1583526">+=</span>&nbsp;<span class="ident" id="1583529">cycles</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583537">unlock</span><span class="op" id="1583543">(</span><span class="op" id="1583544">&amp;</span><span class="ident" id="1583545">proflock</span><span class="op" id="1583553">)</span><br>
<span class="lineno"></span><span class="op" id="1583555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1583558">//&nbsp;Go&nbsp;interface&nbsp;to&nbsp;profile&nbsp;data.</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="1583592">//&nbsp;A&nbsp;StackRecord&nbsp;describes&nbsp;a&nbsp;single&nbsp;execution&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1583645">type</span>&nbsp;<span class="ident" id="1583650">StackRecord</span>&nbsp;<span class="keyword" id="1583662">struct</span>&nbsp;<span class="op" id="1583669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1583672">Stack0</span>&nbsp;<span class="op" id="1583679">[</span><span class="num" id="1583680">32</span><span class="op" id="1583682">]</span><span class="builtintype" id="1583683">uintptr</span>&nbsp;<span class="comment" id="1583691">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1583745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="1583748">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1583809">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno"></span><span class="keyword" id="1583834">func</span>&nbsp;<span class="op" id="1583839">(</span><span class="ident" id="1583840">r</span>&nbsp;<span class="op" id="1583842">*</span><span class="ident" id="1583843">StackRecord</span><span class="op" id="1583854">)</span>&nbsp;<span class="ident" id="1583856">Stack</span><span class="op" id="1583861">(</span><span class="op" id="1583862">)</span>&nbsp;<span class="op" id="1583864">[</span><span class="op" id="1583865">]</span><span class="builtintype" id="1583866">uintptr</span>&nbsp;<span class="op" id="1583874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583877">for</span>&nbsp;<span class="ident" id="1583881">i</span><span class="op" id="1583882">,</span>&nbsp;<span class="ident" id="1583884">v</span>&nbsp;<span class="op" id="1583886">:=</span>&nbsp;<span class="keyword" id="1583889">range</span>&nbsp;<span class="ident" id="1583895">r</span><span class="op" id="1583896">.</span><span class="ident" id="1583897">Stack0</span>&nbsp;<span class="op" id="1583904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583908">if</span>&nbsp;<span class="ident" id="1583911">v</span>&nbsp;<span class="op" id="1583913">==</span>&nbsp;<span class="num" id="1583916">0</span>&nbsp;<span class="op" id="1583918">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583923">return</span>&nbsp;<span class="ident" id="1583930">r</span><span class="op" id="1583931">.</span><span class="ident" id="1583932">Stack0</span><span class="op" id="1583938">[</span><span class="num" id="1583939">0</span><span class="op" id="1583940">:</span><span class="ident" id="1583941">i</span><span class="op" id="1583942">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1583949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1583952">return</span>&nbsp;<span class="ident" id="1583959">r</span><span class="op" id="1583960">.</span><span class="ident" id="1583961">Stack0</span><span class="op" id="1583967">[</span><span class="num" id="1583968">0</span><span class="op" id="1583969">:</span><span class="op" id="1583970">]</span><br>
<span class="lineno"></span><span class="op" id="1583972">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="comment" id="1583975">//&nbsp;MemProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;memory&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="1584037">//&nbsp;that&nbsp;are&nbsp;recorded&nbsp;and&nbsp;reported&nbsp;in&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1584094">//&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample&nbsp;an&nbsp;average&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1584139">//&nbsp;one&nbsp;allocation&nbsp;per&nbsp;MemProfileRate&nbsp;bytes&nbsp;allocated.</span><br>
<span class="lineno">345</span><span class="comment" id="1584193">//</span><br>
<span class="lineno"></span><span class="comment" id="1584196">//&nbsp;To&nbsp;include&nbsp;every&nbsp;allocated&nbsp;block&nbsp;in&nbsp;the&nbsp;profile,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1584273">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1584333">//</span><br>
<span class="lineno"></span><span class="comment" id="1584336">//&nbsp;The&nbsp;tools&nbsp;that&nbsp;process&nbsp;the&nbsp;memory&nbsp;profiles&nbsp;assume&nbsp;that&nbsp;the</span><br>
<span class="lineno">350</span><span class="comment" id="1584398">//&nbsp;profile&nbsp;rate&nbsp;is&nbsp;constant&nbsp;across&nbsp;the&nbsp;lifetime&nbsp;of&nbsp;the&nbsp;program</span><br>
<span class="lineno"></span><span class="comment" id="1584461">//&nbsp;and&nbsp;equal&nbsp;to&nbsp;the&nbsp;current&nbsp;value.&nbsp;&nbsp;Programs&nbsp;that&nbsp;change&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1584522">//&nbsp;memory&nbsp;profiling&nbsp;rate&nbsp;should&nbsp;do&nbsp;so&nbsp;just&nbsp;once,&nbsp;as&nbsp;early&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1584583">//&nbsp;possible&nbsp;in&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;program&nbsp;(for&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="1584641">//&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;main).</span><br>
<span class="lineno">355</span><span class="keyword" id="1584671">var</span>&nbsp;<span class="ident" id="1584675">MemProfileRate</span>&nbsp;<span class="builtintype" id="1584690">int</span>&nbsp;<span class="op" id="1584694">=</span>&nbsp;<span class="num" id="1584696">512</span>&nbsp;<span class="op" id="1584700">*</span>&nbsp;<span class="num" id="1584702">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1584708">//&nbsp;A&nbsp;MemProfileRecord&nbsp;describes&nbsp;the&nbsp;live&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1584767">//&nbsp;by&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1584815">type</span>&nbsp;<span class="ident" id="1584820">MemProfileRecord</span>&nbsp;<span class="keyword" id="1584837">struct</span>&nbsp;<span class="op" id="1584844">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584847">AllocBytes</span><span class="op" id="1584857">,</span>&nbsp;<span class="ident" id="1584859">FreeBytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1584873">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1584885">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584922">AllocObjects</span><span class="op" id="1584934">,</span>&nbsp;<span class="ident" id="1584936">FreeObjects</span>&nbsp;<span class="ident" id="1584948">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1584960">//&nbsp;number&nbsp;of&nbsp;objects&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1584999">Stack0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1585025">[</span><span class="num" id="1585026">32</span><span class="op" id="1585028">]</span><span class="builtintype" id="1585029">uintptr</span>&nbsp;<span class="comment" id="1585037">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1585091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="1585094">//&nbsp;InUseBytes&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;use&nbsp;(AllocBytes&nbsp;-&nbsp;FreeBytes).</span><br>
<span class="lineno"></span><span class="keyword" id="1585169">func</span>&nbsp;<span class="op" id="1585174">(</span><span class="ident" id="1585175">r</span>&nbsp;<span class="op" id="1585177">*</span><span class="ident" id="1585178">MemProfileRecord</span><span class="op" id="1585194">)</span>&nbsp;<span class="ident" id="1585196">InUseBytes</span><span class="op" id="1585206">(</span><span class="op" id="1585207">)</span>&nbsp;<span class="ident" id="1585209">int64</span>&nbsp;<span class="op" id="1585215">{</span>&nbsp;<span class="keyword" id="1585217">return</span>&nbsp;<span class="ident" id="1585224">r</span><span class="op" id="1585225">.</span><span class="ident" id="1585226">AllocBytes</span>&nbsp;<span class="op" id="1585237">-</span>&nbsp;<span class="ident" id="1585239">r</span><span class="op" id="1585240">.</span><span class="ident" id="1585241">FreeBytes</span>&nbsp;<span class="op" id="1585251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1585254">//&nbsp;InUseObjects&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;in&nbsp;use&nbsp;(AllocObjects&nbsp;-&nbsp;FreeObjects).</span><br>
<span class="lineno"></span><span class="keyword" id="1585337">func</span>&nbsp;<span class="op" id="1585342">(</span><span class="ident" id="1585343">r</span>&nbsp;<span class="op" id="1585345">*</span><span class="ident" id="1585346">MemProfileRecord</span><span class="op" id="1585362">)</span>&nbsp;<span class="ident" id="1585364">InUseObjects</span><span class="op" id="1585376">(</span><span class="op" id="1585377">)</span>&nbsp;<span class="ident" id="1585379">int64</span>&nbsp;<span class="op" id="1585385">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585388">return</span>&nbsp;<span class="ident" id="1585395">r</span><span class="op" id="1585396">.</span><span class="ident" id="1585397">AllocObjects</span>&nbsp;<span class="op" id="1585410">-</span>&nbsp;<span class="ident" id="1585412">r</span><span class="op" id="1585413">.</span><span class="ident" id="1585414">FreeObjects</span><br>
<span class="lineno"></span><span class="op" id="1585426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1585429">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1585490">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno">375</span><span class="keyword" id="1585515">func</span>&nbsp;<span class="op" id="1585520">(</span><span class="ident" id="1585521">r</span>&nbsp;<span class="op" id="1585523">*</span><span class="ident" id="1585524">MemProfileRecord</span><span class="op" id="1585540">)</span>&nbsp;<span class="ident" id="1585542">Stack</span><span class="op" id="1585547">(</span><span class="op" id="1585548">)</span>&nbsp;<span class="op" id="1585550">[</span><span class="op" id="1585551">]</span><span class="builtintype" id="1585552">uintptr</span>&nbsp;<span class="op" id="1585560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585563">for</span>&nbsp;<span class="ident" id="1585567">i</span><span class="op" id="1585568">,</span>&nbsp;<span class="ident" id="1585570">v</span>&nbsp;<span class="op" id="1585572">:=</span>&nbsp;<span class="keyword" id="1585575">range</span>&nbsp;<span class="ident" id="1585581">r</span><span class="op" id="1585582">.</span><span class="ident" id="1585583">Stack0</span>&nbsp;<span class="op" id="1585590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585594">if</span>&nbsp;<span class="ident" id="1585597">v</span>&nbsp;<span class="op" id="1585599">==</span>&nbsp;<span class="num" id="1585602">0</span>&nbsp;<span class="op" id="1585604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585609">return</span>&nbsp;<span class="ident" id="1585616">r</span><span class="op" id="1585617">.</span><span class="ident" id="1585618">Stack0</span><span class="op" id="1585624">[</span><span class="num" id="1585625">0</span><span class="op" id="1585626">:</span><span class="ident" id="1585627">i</span><span class="op" id="1585628">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585632">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1585635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1585638">return</span>&nbsp;<span class="ident" id="1585645">r</span><span class="op" id="1585646">.</span><span class="ident" id="1585647">Stack0</span><span class="op" id="1585653">[</span><span class="num" id="1585654">0</span><span class="op" id="1585655">:</span><span class="op" id="1585656">]</span><br>
<span class="lineno"></span><span class="op" id="1585658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1585661">//&nbsp;MemProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno">385</span><span class="comment" id="1585739">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;MemProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1585816">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;MemProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1585885">//</span><br>
<span class="lineno"></span><span class="comment" id="1585888">//&nbsp;If&nbsp;inuseZero&nbsp;is&nbsp;true,&nbsp;the&nbsp;profile&nbsp;includes&nbsp;allocation&nbsp;records</span><br>
<span class="lineno"></span><span class="comment" id="1585953">//&nbsp;where&nbsp;r.AllocBytes&nbsp;&gt;&nbsp;0&nbsp;but&nbsp;r.AllocBytes&nbsp;==&nbsp;r.FreeBytes.</span><br>
<span class="lineno">390</span><span class="comment" id="1586012">//&nbsp;These&nbsp;are&nbsp;sites&nbsp;where&nbsp;memory&nbsp;was&nbsp;allocated,&nbsp;but&nbsp;it&nbsp;has&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="1586074">//&nbsp;been&nbsp;released&nbsp;back&nbsp;to&nbsp;the&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="1586112">//</span><br>
<span class="lineno"></span><span class="comment" id="1586115">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1586171">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.memprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno">395</span><span class="comment" id="1586226">//&nbsp;of&nbsp;calling&nbsp;MemProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1586261">func</span>&nbsp;<span class="ident" id="1586266">MemProfile</span><span class="op" id="1586276">(</span><span class="ident" id="1586277">p</span>&nbsp;<span class="op" id="1586279">[</span><span class="op" id="1586280">]</span><span class="ident" id="1586281">MemProfileRecord</span><span class="op" id="1586297">,</span>&nbsp;<span class="ident" id="1586299">inuseZero</span>&nbsp;<span class="builtintype" id="1586309">bool</span><span class="op" id="1586313">)</span>&nbsp;<span class="op" id="1586315">(</span><span class="ident" id="1586316">n</span>&nbsp;<span class="builtintype" id="1586318">int</span><span class="op" id="1586321">,</span>&nbsp;<span class="ident" id="1586323">ok</span>&nbsp;<span class="builtintype" id="1586326">bool</span><span class="op" id="1586330">)</span>&nbsp;<span class="op" id="1586332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586335">lock</span><span class="op" id="1586339">(</span><span class="op" id="1586340">&amp;</span><span class="ident" id="1586341">proflock</span><span class="op" id="1586349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586352">clear</span>&nbsp;<span class="op" id="1586358">:=</span>&nbsp;<span class="builtintype" id="1586361">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586367">for</span>&nbsp;<span class="ident" id="1586371">b</span>&nbsp;<span class="op" id="1586373">:=</span>&nbsp;<span class="ident" id="1586376">mbuckets</span><span class="op" id="1586384">;</span>&nbsp;<span class="ident" id="1586386">b</span>&nbsp;<span class="op" id="1586388">!=</span>&nbsp;<span class="ident" id="1586391">nil</span><span class="op" id="1586394">;</span>&nbsp;<span class="ident" id="1586396">b</span>&nbsp;<span class="op" id="1586398">=</span>&nbsp;<span class="ident" id="1586400">b</span><span class="op" id="1586401">.</span><span class="ident" id="1586402">allnext</span>&nbsp;<span class="op" id="1586410">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586414">mp</span>&nbsp;<span class="op" id="1586417">:=</span>&nbsp;<span class="ident" id="1586420">b</span><span class="op" id="1586421">.</span><span class="ident" id="1586422">mp</span><span class="op" id="1586424">(</span><span class="op" id="1586425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586429">if</span>&nbsp;<span class="ident" id="1586432">inuseZero</span>&nbsp;<span class="op" id="1586442">||</span>&nbsp;<span class="ident" id="1586445">mp</span><span class="op" id="1586447">.</span><span class="ident" id="1586448">alloc_bytes</span>&nbsp;<span class="op" id="1586460">!=</span>&nbsp;<span class="ident" id="1586463">mp</span><span class="op" id="1586465">.</span><span class="ident" id="1586466">free_bytes</span>&nbsp;<span class="op" id="1586477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586482">n</span><span class="op" id="1586483">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586492">if</span>&nbsp;<span class="ident" id="1586495">mp</span><span class="op" id="1586497">.</span><span class="ident" id="1586498">allocs</span>&nbsp;<span class="op" id="1586505">!=</span>&nbsp;<span class="num" id="1586508">0</span>&nbsp;<span class="op" id="1586510">||</span>&nbsp;<span class="ident" id="1586513">mp</span><span class="op" id="1586515">.</span><span class="ident" id="1586516">frees</span>&nbsp;<span class="op" id="1586522">!=</span>&nbsp;<span class="num" id="1586525">0</span>&nbsp;<span class="op" id="1586527">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586532">clear</span>&nbsp;<span class="op" id="1586538">=</span>&nbsp;<span class="builtintype" id="1586540">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586554">if</span>&nbsp;<span class="ident" id="1586557">clear</span>&nbsp;<span class="op" id="1586563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586567">//&nbsp;Absolutely&nbsp;no&nbsp;data,&nbsp;suggesting&nbsp;that&nbsp;a&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586629">//&nbsp;has&nbsp;not&nbsp;yet&nbsp;happened.&nbsp;In&nbsp;order&nbsp;to&nbsp;allow&nbsp;profiling&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586689">//&nbsp;garbage&nbsp;collection&nbsp;is&nbsp;disabled&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;execution,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1586758">//&nbsp;accumulate&nbsp;stats&nbsp;as&nbsp;if&nbsp;a&nbsp;GC&nbsp;just&nbsp;happened,&nbsp;and&nbsp;recount&nbsp;buckets.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586827">mprof_GC</span><span class="op" id="1586835">(</span><span class="op" id="1586836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586840">mprof_GC</span><span class="op" id="1586848">(</span><span class="op" id="1586849">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586853">n</span>&nbsp;<span class="op" id="1586855">=</span>&nbsp;<span class="num" id="1586857">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586861">for</span>&nbsp;<span class="ident" id="1586865">b</span>&nbsp;<span class="op" id="1586867">:=</span>&nbsp;<span class="ident" id="1586870">mbuckets</span><span class="op" id="1586878">;</span>&nbsp;<span class="ident" id="1586880">b</span>&nbsp;<span class="op" id="1586882">!=</span>&nbsp;<span class="ident" id="1586885">nil</span><span class="op" id="1586888">;</span>&nbsp;<span class="ident" id="1586890">b</span>&nbsp;<span class="op" id="1586892">=</span>&nbsp;<span class="ident" id="1586894">b</span><span class="op" id="1586895">.</span><span class="ident" id="1586896">allnext</span>&nbsp;<span class="op" id="1586904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586909">mp</span>&nbsp;<span class="op" id="1586912">:=</span>&nbsp;<span class="ident" id="1586915">b</span><span class="op" id="1586916">.</span><span class="ident" id="1586917">mp</span><span class="op" id="1586919">(</span><span class="op" id="1586920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586925">if</span>&nbsp;<span class="ident" id="1586928">inuseZero</span>&nbsp;<span class="op" id="1586938">||</span>&nbsp;<span class="ident" id="1586941">mp</span><span class="op" id="1586943">.</span><span class="ident" id="1586944">alloc_bytes</span>&nbsp;<span class="op" id="1586956">!=</span>&nbsp;<span class="ident" id="1586959">mp</span><span class="op" id="1586961">.</span><span class="ident" id="1586962">free_bytes</span>&nbsp;<span class="op" id="1586973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1586979">n</span><span class="op" id="1586980">++</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1586993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1586996">if</span>&nbsp;<span class="ident" id="1586999">n</span>&nbsp;<span class="op" id="1587001">&lt;=</span>&nbsp;<span class="builtinfunc" id="1587004">len</span><span class="op" id="1587007">(</span><span class="ident" id="1587008">p</span><span class="op" id="1587009">)</span>&nbsp;<span class="op" id="1587011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587015">ok</span>&nbsp;<span class="op" id="1587018">=</span>&nbsp;<span class="builtintype" id="1587020">true</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587027">idx</span>&nbsp;<span class="op" id="1587031">:=</span>&nbsp;<span class="num" id="1587034">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587038">for</span>&nbsp;<span class="ident" id="1587042">b</span>&nbsp;<span class="op" id="1587044">:=</span>&nbsp;<span class="ident" id="1587047">mbuckets</span><span class="op" id="1587055">;</span>&nbsp;<span class="ident" id="1587057">b</span>&nbsp;<span class="op" id="1587059">!=</span>&nbsp;<span class="ident" id="1587062">nil</span><span class="op" id="1587065">;</span>&nbsp;<span class="ident" id="1587067">b</span>&nbsp;<span class="op" id="1587069">=</span>&nbsp;<span class="ident" id="1587071">b</span><span class="op" id="1587072">.</span><span class="ident" id="1587073">allnext</span>&nbsp;<span class="op" id="1587081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587086">mp</span>&nbsp;<span class="op" id="1587089">:=</span>&nbsp;<span class="ident" id="1587092">b</span><span class="op" id="1587093">.</span><span class="ident" id="1587094">mp</span><span class="op" id="1587096">(</span><span class="op" id="1587097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587102">if</span>&nbsp;<span class="ident" id="1587105">inuseZero</span>&nbsp;<span class="op" id="1587115">||</span>&nbsp;<span class="ident" id="1587118">mp</span><span class="op" id="1587120">.</span><span class="ident" id="1587121">alloc_bytes</span>&nbsp;<span class="op" id="1587133">!=</span>&nbsp;<span class="ident" id="1587136">mp</span><span class="op" id="1587138">.</span><span class="ident" id="1587139">free_bytes</span>&nbsp;<span class="op" id="1587150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587156">record</span><span class="op" id="1587162">(</span><span class="op" id="1587163">&amp;</span><span class="ident" id="1587164">p</span><span class="op" id="1587165">[</span><span class="ident" id="1587166">idx</span><span class="op" id="1587169">]</span><span class="op" id="1587170">,</span>&nbsp;<span class="ident" id="1587172">b</span><span class="op" id="1587173">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587179">idx</span><span class="op" id="1587182">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587198">unlock</span><span class="op" id="1587204">(</span><span class="op" id="1587205">&amp;</span><span class="ident" id="1587206">proflock</span><span class="op" id="1587214">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587217">return</span><br>
<span class="lineno"></span><span class="op" id="1587224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1587227">//&nbsp;Write&nbsp;b&#39;s&nbsp;data&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="1587251">func</span>&nbsp;<span class="ident" id="1587256">record</span><span class="op" id="1587262">(</span><span class="ident" id="1587263">r</span>&nbsp;<span class="op" id="1587265">*</span><span class="ident" id="1587266">MemProfileRecord</span><span class="op" id="1587282">,</span>&nbsp;<span class="ident" id="1587284">b</span>&nbsp;<span class="op" id="1587286">*</span><span class="ident" id="1587287">bucket</span><span class="op" id="1587293">)</span>&nbsp;<span class="op" id="1587295">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587298">mp</span>&nbsp;<span class="op" id="1587301">:=</span>&nbsp;<span class="ident" id="1587304">b</span><span class="op" id="1587305">.</span><span class="ident" id="1587306">mp</span><span class="op" id="1587308">(</span><span class="op" id="1587309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587312">r</span><span class="op" id="1587313">.</span><span class="ident" id="1587314">AllocBytes</span>&nbsp;<span class="op" id="1587325">=</span>&nbsp;<span class="ident" id="1587327">int64</span><span class="op" id="1587332">(</span><span class="ident" id="1587333">mp</span><span class="op" id="1587335">.</span><span class="ident" id="1587336">alloc_bytes</span><span class="op" id="1587347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587350">r</span><span class="op" id="1587351">.</span><span class="ident" id="1587352">FreeBytes</span>&nbsp;<span class="op" id="1587362">=</span>&nbsp;<span class="ident" id="1587364">int64</span><span class="op" id="1587369">(</span><span class="ident" id="1587370">mp</span><span class="op" id="1587372">.</span><span class="ident" id="1587373">free_bytes</span><span class="op" id="1587383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587386">r</span><span class="op" id="1587387">.</span><span class="ident" id="1587388">AllocObjects</span>&nbsp;<span class="op" id="1587401">=</span>&nbsp;<span class="ident" id="1587403">int64</span><span class="op" id="1587408">(</span><span class="ident" id="1587409">mp</span><span class="op" id="1587411">.</span><span class="ident" id="1587412">allocs</span><span class="op" id="1587418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587421">r</span><span class="op" id="1587422">.</span><span class="ident" id="1587423">FreeObjects</span>&nbsp;<span class="op" id="1587435">=</span>&nbsp;<span class="ident" id="1587437">int64</span><span class="op" id="1587442">(</span><span class="ident" id="1587443">mp</span><span class="op" id="1587445">.</span><span class="ident" id="1587446">frees</span><span class="op" id="1587451">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1587454">copy</span><span class="op" id="1587458">(</span><span class="ident" id="1587459">r</span><span class="op" id="1587460">.</span><span class="ident" id="1587461">Stack0</span><span class="op" id="1587467">[</span><span class="op" id="1587468">:</span><span class="op" id="1587469">]</span><span class="op" id="1587470">,</span>&nbsp;<span class="ident" id="1587472">b</span><span class="op" id="1587473">.</span><span class="ident" id="1587474">stk</span><span class="op" id="1587477">(</span><span class="op" id="1587478">)</span><span class="op" id="1587479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587482">for</span>&nbsp;<span class="ident" id="1587486">i</span>&nbsp;<span class="op" id="1587488">:=</span>&nbsp;<span class="builtintype" id="1587491">int</span><span class="op" id="1587494">(</span><span class="ident" id="1587495">b</span><span class="op" id="1587496">.</span><span class="ident" id="1587497">nstk</span><span class="op" id="1587501">)</span><span class="op" id="1587502">;</span>&nbsp;<span class="ident" id="1587504">i</span>&nbsp;<span class="op" id="1587506">&lt;</span>&nbsp;<span class="builtinfunc" id="1587508">len</span><span class="op" id="1587511">(</span><span class="ident" id="1587512">r</span><span class="op" id="1587513">.</span><span class="ident" id="1587514">Stack0</span><span class="op" id="1587520">)</span><span class="op" id="1587521">;</span>&nbsp;<span class="ident" id="1587523">i</span><span class="op" id="1587524">++</span>&nbsp;<span class="op" id="1587527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587531">r</span><span class="op" id="1587532">.</span><span class="ident" id="1587533">Stack0</span><span class="op" id="1587539">[</span><span class="ident" id="1587540">i</span><span class="op" id="1587541">]</span>&nbsp;<span class="op" id="1587543">=</span>&nbsp;<span class="num" id="1587545">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587548">}</span><br>
<span class="lineno"></span><span class="op" id="1587550">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1587553">func</span>&nbsp;<span class="ident" id="1587558">iterate_memprof</span><span class="op" id="1587573">(</span><span class="ident" id="1587574">fn</span>&nbsp;<span class="keyword" id="1587577">func</span><span class="op" id="1587581">(</span><span class="op" id="1587582">*</span><span class="ident" id="1587583">bucket</span><span class="op" id="1587589">,</span>&nbsp;<span class="builtintype" id="1587591">uintptr</span><span class="op" id="1587598">,</span>&nbsp;<span class="op" id="1587600">*</span><span class="builtintype" id="1587601">uintptr</span><span class="op" id="1587608">,</span>&nbsp;<span class="builtintype" id="1587610">uintptr</span><span class="op" id="1587617">,</span>&nbsp;<span class="builtintype" id="1587619">uintptr</span><span class="op" id="1587626">,</span>&nbsp;<span class="builtintype" id="1587628">uintptr</span><span class="op" id="1587635">)</span><span class="op" id="1587636">)</span>&nbsp;<span class="op" id="1587638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587641">lock</span><span class="op" id="1587645">(</span><span class="op" id="1587646">&amp;</span><span class="ident" id="1587647">proflock</span><span class="op" id="1587655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1587658">for</span>&nbsp;<span class="ident" id="1587662">b</span>&nbsp;<span class="op" id="1587664">:=</span>&nbsp;<span class="ident" id="1587667">mbuckets</span><span class="op" id="1587675">;</span>&nbsp;<span class="ident" id="1587677">b</span>&nbsp;<span class="op" id="1587679">!=</span>&nbsp;<span class="ident" id="1587682">nil</span><span class="op" id="1587685">;</span>&nbsp;<span class="ident" id="1587687">b</span>&nbsp;<span class="op" id="1587689">=</span>&nbsp;<span class="ident" id="1587691">b</span><span class="op" id="1587692">.</span><span class="ident" id="1587693">allnext</span>&nbsp;<span class="op" id="1587701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587705">mp</span>&nbsp;<span class="op" id="1587708">:=</span>&nbsp;<span class="ident" id="1587711">b</span><span class="op" id="1587712">.</span><span class="ident" id="1587713">mp</span><span class="op" id="1587715">(</span><span class="op" id="1587716">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587720">fn</span><span class="op" id="1587722">(</span><span class="ident" id="1587723">b</span><span class="op" id="1587724">,</span>&nbsp;<span class="builtintype" id="1587726">uintptr</span><span class="op" id="1587733">(</span><span class="ident" id="1587734">b</span><span class="op" id="1587735">.</span><span class="ident" id="1587736">nstk</span><span class="op" id="1587740">)</span><span class="op" id="1587741">,</span>&nbsp;<span class="op" id="1587743">&amp;</span><span class="ident" id="1587744">b</span><span class="op" id="1587745">.</span><span class="ident" id="1587746">stk</span><span class="op" id="1587749">(</span><span class="op" id="1587750">)</span><span class="op" id="1587751">[</span><span class="num" id="1587752">0</span><span class="op" id="1587753">]</span><span class="op" id="1587754">,</span>&nbsp;<span class="ident" id="1587756">b</span><span class="op" id="1587757">.</span><span class="ident" id="1587758">size</span><span class="op" id="1587762">,</span>&nbsp;<span class="ident" id="1587764">mp</span><span class="op" id="1587766">.</span><span class="ident" id="1587767">allocs</span><span class="op" id="1587773">,</span>&nbsp;<span class="ident" id="1587775">mp</span><span class="op" id="1587777">.</span><span class="ident" id="1587778">frees</span><span class="op" id="1587783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1587786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587789">unlock</span><span class="op" id="1587795">(</span><span class="op" id="1587796">&amp;</span><span class="ident" id="1587797">proflock</span><span class="op" id="1587805">)</span><br>
<span class="lineno"></span><span class="op" id="1587807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="1587810">//&nbsp;BlockProfileRecord&nbsp;describes&nbsp;blocking&nbsp;events&nbsp;originated</span><br>
<span class="lineno"></span><span class="comment" id="1587869">//&nbsp;at&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1587917">type</span>&nbsp;<span class="ident" id="1587922">BlockProfileRecord</span>&nbsp;<span class="keyword" id="1587941">struct</span>&nbsp;<span class="op" id="1587948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587951">Count</span>&nbsp;&nbsp;<span class="ident" id="1587958">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587965">Cycles</span>&nbsp;<span class="ident" id="1587972">int64</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1587979">StackRecord</span><br>
<span class="lineno"></span><span class="op" id="1587991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1587994">//&nbsp;BlockProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1588076">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;BlockProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">470</span><span class="comment" id="1588155">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;BlockProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1588226">//</span><br>
<span class="lineno"></span><span class="comment" id="1588229">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1588285">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.blockprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1588342">//&nbsp;of&nbsp;calling&nbsp;BlockProfile&nbsp;directly.</span><br>
<span class="lineno">475</span><span class="keyword" id="1588379">func</span>&nbsp;<span class="ident" id="1588384">BlockProfile</span><span class="op" id="1588396">(</span><span class="ident" id="1588397">p</span>&nbsp;<span class="op" id="1588399">[</span><span class="op" id="1588400">]</span><span class="ident" id="1588401">BlockProfileRecord</span><span class="op" id="1588419">)</span>&nbsp;<span class="op" id="1588421">(</span><span class="ident" id="1588422">n</span>&nbsp;<span class="builtintype" id="1588424">int</span><span class="op" id="1588427">,</span>&nbsp;<span class="ident" id="1588429">ok</span>&nbsp;<span class="builtintype" id="1588432">bool</span><span class="op" id="1588436">)</span>&nbsp;<span class="op" id="1588438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588441">lock</span><span class="op" id="1588445">(</span><span class="op" id="1588446">&amp;</span><span class="ident" id="1588447">proflock</span><span class="op" id="1588455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588458">for</span>&nbsp;<span class="ident" id="1588462">b</span>&nbsp;<span class="op" id="1588464">:=</span>&nbsp;<span class="ident" id="1588467">bbuckets</span><span class="op" id="1588475">;</span>&nbsp;<span class="ident" id="1588477">b</span>&nbsp;<span class="op" id="1588479">!=</span>&nbsp;<span class="ident" id="1588482">nil</span><span class="op" id="1588485">;</span>&nbsp;<span class="ident" id="1588487">b</span>&nbsp;<span class="op" id="1588489">=</span>&nbsp;<span class="ident" id="1588491">b</span><span class="op" id="1588492">.</span><span class="ident" id="1588493">allnext</span>&nbsp;<span class="op" id="1588501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588505">n</span><span class="op" id="1588506">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588510">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588513">if</span>&nbsp;<span class="ident" id="1588516">n</span>&nbsp;<span class="op" id="1588518">&lt;=</span>&nbsp;<span class="builtinfunc" id="1588521">len</span><span class="op" id="1588524">(</span><span class="ident" id="1588525">p</span><span class="op" id="1588526">)</span>&nbsp;<span class="op" id="1588528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588532">ok</span>&nbsp;<span class="op" id="1588535">=</span>&nbsp;<span class="builtintype" id="1588537">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588544">for</span>&nbsp;<span class="ident" id="1588548">b</span>&nbsp;<span class="op" id="1588550">:=</span>&nbsp;<span class="ident" id="1588553">bbuckets</span><span class="op" id="1588561">;</span>&nbsp;<span class="ident" id="1588563">b</span>&nbsp;<span class="op" id="1588565">!=</span>&nbsp;<span class="ident" id="1588568">nil</span><span class="op" id="1588571">;</span>&nbsp;<span class="ident" id="1588573">b</span>&nbsp;<span class="op" id="1588575">=</span>&nbsp;<span class="ident" id="1588577">b</span><span class="op" id="1588578">.</span><span class="ident" id="1588579">allnext</span>&nbsp;<span class="op" id="1588587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588592">bp</span>&nbsp;<span class="op" id="1588595">:=</span>&nbsp;<span class="ident" id="1588598">b</span><span class="op" id="1588599">.</span><span class="ident" id="1588600">bp</span><span class="op" id="1588602">(</span><span class="op" id="1588603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588608">r</span>&nbsp;<span class="op" id="1588610">:=</span>&nbsp;<span class="op" id="1588613">&amp;</span><span class="ident" id="1588614">p</span><span class="op" id="1588615">[</span><span class="num" id="1588616">0</span><span class="op" id="1588617">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588622">r</span><span class="op" id="1588623">.</span><span class="ident" id="1588624">Count</span>&nbsp;<span class="op" id="1588630">=</span>&nbsp;<span class="ident" id="1588632">int64</span><span class="op" id="1588637">(</span><span class="ident" id="1588638">bp</span><span class="op" id="1588640">.</span><span class="ident" id="1588641">count</span><span class="op" id="1588646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588651">r</span><span class="op" id="1588652">.</span><span class="ident" id="1588653">Cycles</span>&nbsp;<span class="op" id="1588660">=</span>&nbsp;<span class="ident" id="1588662">int64</span><span class="op" id="1588667">(</span><span class="ident" id="1588668">bp</span><span class="op" id="1588670">.</span><span class="ident" id="1588671">cycles</span><span class="op" id="1588677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588682">i</span>&nbsp;<span class="op" id="1588684">:=</span>&nbsp;<span class="builtinfunc" id="1588687">copy</span><span class="op" id="1588691">(</span><span class="ident" id="1588692">r</span><span class="op" id="1588693">.</span><span class="ident" id="1588694">Stack0</span><span class="op" id="1588700">[</span><span class="op" id="1588701">:</span><span class="op" id="1588702">]</span><span class="op" id="1588703">,</span>&nbsp;<span class="ident" id="1588705">b</span><span class="op" id="1588706">.</span><span class="ident" id="1588707">stk</span><span class="op" id="1588710">(</span><span class="op" id="1588711">)</span><span class="op" id="1588712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588717">for</span>&nbsp;<span class="op" id="1588721">;</span>&nbsp;<span class="ident" id="1588723">i</span>&nbsp;<span class="op" id="1588725">&lt;</span>&nbsp;<span class="builtinfunc" id="1588727">len</span><span class="op" id="1588730">(</span><span class="ident" id="1588731">r</span><span class="op" id="1588732">.</span><span class="ident" id="1588733">Stack0</span><span class="op" id="1588739">)</span><span class="op" id="1588740">;</span>&nbsp;<span class="ident" id="1588742">i</span><span class="op" id="1588743">++</span>&nbsp;<span class="op" id="1588746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588752">r</span><span class="op" id="1588753">.</span><span class="ident" id="1588754">Stack0</span><span class="op" id="1588760">[</span><span class="ident" id="1588761">i</span><span class="op" id="1588762">]</span>&nbsp;<span class="op" id="1588764">=</span>&nbsp;<span class="num" id="1588766">0</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588776">p</span>&nbsp;<span class="op" id="1588778">=</span>&nbsp;<span class="ident" id="1588780">p</span><span class="op" id="1588781">[</span><span class="num" id="1588782">1</span><span class="op" id="1588783">:</span><span class="op" id="1588784">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1588791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1588794">unlock</span><span class="op" id="1588800">(</span><span class="op" id="1588801">&amp;</span><span class="ident" id="1588802">proflock</span><span class="op" id="1588810">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1588813">return</span><br>
<span class="lineno"></span><span class="op" id="1588820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1588823">//&nbsp;ThreadCreateProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;thread&nbsp;creation&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1588911">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">500</span><span class="comment" id="1588997">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1589075">//</span><br>
<span class="lineno"></span><span class="comment" id="1589078">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1589139">//&nbsp;of&nbsp;calling&nbsp;ThreadCreateProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1589183">func</span>&nbsp;<span class="ident" id="1589188">ThreadCreateProfile</span><span class="op" id="1589207">(</span><span class="ident" id="1589208">p</span>&nbsp;<span class="op" id="1589210">[</span><span class="op" id="1589211">]</span><span class="ident" id="1589212">StackRecord</span><span class="op" id="1589223">)</span>&nbsp;<span class="op" id="1589225">(</span><span class="ident" id="1589226">n</span>&nbsp;<span class="builtintype" id="1589228">int</span><span class="op" id="1589231">,</span>&nbsp;<span class="ident" id="1589233">ok</span>&nbsp;<span class="builtintype" id="1589236">bool</span><span class="op" id="1589240">)</span>&nbsp;<span class="op" id="1589242">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589245">first</span>&nbsp;<span class="op" id="1589251">:=</span>&nbsp;<span class="op" id="1589254">(</span><span class="op" id="1589255">*</span><span class="ident" id="1589256">m</span><span class="op" id="1589257">)</span><span class="op" id="1589258">(</span><span class="ident" id="1589259">atomicloadp</span><span class="op" id="1589270">(</span><span class="ident" id="1589271">unsafe</span><span class="op" id="1589277">.</span><span class="ident" id="1589278">Pointer</span><span class="op" id="1589285">(</span><span class="op" id="1589286">&amp;</span><span class="ident" id="1589287">allm</span><span class="op" id="1589291">)</span><span class="op" id="1589292">)</span><span class="op" id="1589293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589296">for</span>&nbsp;<span class="ident" id="1589300">mp</span>&nbsp;<span class="op" id="1589303">:=</span>&nbsp;<span class="ident" id="1589306">first</span><span class="op" id="1589311">;</span>&nbsp;<span class="ident" id="1589313">mp</span>&nbsp;<span class="op" id="1589316">!=</span>&nbsp;<span class="ident" id="1589319">nil</span><span class="op" id="1589322">;</span>&nbsp;<span class="ident" id="1589324">mp</span>&nbsp;<span class="op" id="1589327">=</span>&nbsp;<span class="ident" id="1589329">mp</span><span class="op" id="1589331">.</span><span class="ident" id="1589332">alllink</span>&nbsp;<span class="op" id="1589340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589344">n</span><span class="op" id="1589345">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589352">if</span>&nbsp;<span class="ident" id="1589355">n</span>&nbsp;<span class="op" id="1589357">&lt;=</span>&nbsp;<span class="builtinfunc" id="1589360">len</span><span class="op" id="1589363">(</span><span class="ident" id="1589364">p</span><span class="op" id="1589365">)</span>&nbsp;<span class="op" id="1589367">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589371">ok</span>&nbsp;<span class="op" id="1589374">=</span>&nbsp;<span class="builtintype" id="1589376">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589383">i</span>&nbsp;<span class="op" id="1589385">:=</span>&nbsp;<span class="num" id="1589388">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589392">for</span>&nbsp;<span class="ident" id="1589396">mp</span>&nbsp;<span class="op" id="1589399">:=</span>&nbsp;<span class="ident" id="1589402">first</span><span class="op" id="1589407">;</span>&nbsp;<span class="ident" id="1589409">mp</span>&nbsp;<span class="op" id="1589412">!=</span>&nbsp;<span class="ident" id="1589415">nil</span><span class="op" id="1589418">;</span>&nbsp;<span class="ident" id="1589420">mp</span>&nbsp;<span class="op" id="1589423">=</span>&nbsp;<span class="ident" id="1589425">mp</span><span class="op" id="1589427">.</span><span class="ident" id="1589428">alllink</span>&nbsp;<span class="op" id="1589436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589441">for</span>&nbsp;<span class="ident" id="1589445">s</span>&nbsp;<span class="op" id="1589447">:=</span>&nbsp;<span class="keyword" id="1589450">range</span>&nbsp;<span class="ident" id="1589456">mp</span><span class="op" id="1589458">.</span><span class="ident" id="1589459">createstack</span>&nbsp;<span class="op" id="1589471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589477">p</span><span class="op" id="1589478">[</span><span class="ident" id="1589479">i</span><span class="op" id="1589480">]</span><span class="op" id="1589481">.</span><span class="ident" id="1589482">Stack0</span><span class="op" id="1589488">[</span><span class="ident" id="1589489">s</span><span class="op" id="1589490">]</span>&nbsp;<span class="op" id="1589492">=</span>&nbsp;<span class="builtintype" id="1589494">uintptr</span><span class="op" id="1589501">(</span><span class="ident" id="1589502">mp</span><span class="op" id="1589504">.</span><span class="ident" id="1589505">createstack</span><span class="op" id="1589516">[</span><span class="ident" id="1589517">s</span><span class="op" id="1589518">]</span><span class="op" id="1589519">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589529">i</span><span class="op" id="1589530">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1589538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1589541">return</span><br>
<span class="lineno">520</span><span class="op" id="1589548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1589551">var</span>&nbsp;<span class="ident" id="1589555">allgs</span>&nbsp;<span class="op" id="1589561">[</span><span class="op" id="1589562">]</span><span class="op" id="1589563">*</span><span class="ident" id="1589564">g</span>&nbsp;<span class="comment" id="1589566">//&nbsp;proc.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1589577">//&nbsp;GoroutineProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;active&nbsp;goroutine&nbsp;stack&nbsp;profile.</span><br>
<span class="lineno">525</span><span class="comment" id="1589669">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;GoroutineProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1589752">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;GoroutineProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1589827">//</span><br>
<span class="lineno"></span><span class="comment" id="1589830">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1589891">//&nbsp;of&nbsp;calling&nbsp;GoroutineProfile&nbsp;directly.</span><br>
<span class="lineno">530</span><span class="keyword" id="1589932">func</span>&nbsp;<span class="ident" id="1589937">GoroutineProfile</span><span class="op" id="1589953">(</span><span class="ident" id="1589954">p</span>&nbsp;<span class="op" id="1589956">[</span><span class="op" id="1589957">]</span><span class="ident" id="1589958">StackRecord</span><span class="op" id="1589969">)</span>&nbsp;<span class="op" id="1589971">(</span><span class="ident" id="1589972">n</span>&nbsp;<span class="builtintype" id="1589974">int</span><span class="op" id="1589977">,</span>&nbsp;<span class="ident" id="1589979">ok</span>&nbsp;<span class="builtintype" id="1589982">bool</span><span class="op" id="1589986">)</span>&nbsp;<span class="op" id="1589988">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1589992">n</span>&nbsp;<span class="op" id="1589994">=</span>&nbsp;<span class="ident" id="1589996">NumGoroutine</span><span class="op" id="1590008">(</span><span class="op" id="1590009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590012">if</span>&nbsp;<span class="ident" id="1590015">n</span>&nbsp;<span class="op" id="1590017">&lt;=</span>&nbsp;<span class="builtinfunc" id="1590020">len</span><span class="op" id="1590023">(</span><span class="ident" id="1590024">p</span><span class="op" id="1590025">)</span>&nbsp;<span class="op" id="1590027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590031">gp</span>&nbsp;<span class="op" id="1590034">:=</span>&nbsp;<span class="ident" id="1590037">getg</span><span class="op" id="1590041">(</span><span class="op" id="1590042">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590046">semacquire</span><span class="op" id="1590056">(</span><span class="op" id="1590057">&amp;</span><span class="ident" id="1590058">worldsema</span><span class="op" id="1590067">,</span>&nbsp;<span class="builtintype" id="1590069">false</span><span class="op" id="1590074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590078">gp</span><span class="op" id="1590080">.</span><span class="ident" id="1590081">m</span><span class="op" id="1590082">.</span><span class="ident" id="1590083">gcing</span>&nbsp;<span class="op" id="1590089">=</span>&nbsp;<span class="num" id="1590091">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590095">onM</span><span class="op" id="1590098">(</span><span class="ident" id="1590099">stoptheworld</span><span class="op" id="1590111">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590116">n</span>&nbsp;<span class="op" id="1590118">=</span>&nbsp;<span class="ident" id="1590120">NumGoroutine</span><span class="op" id="1590132">(</span><span class="op" id="1590133">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590137">if</span>&nbsp;<span class="ident" id="1590140">n</span>&nbsp;<span class="op" id="1590142">&lt;=</span>&nbsp;<span class="builtinfunc" id="1590145">len</span><span class="op" id="1590148">(</span><span class="ident" id="1590149">p</span><span class="op" id="1590150">)</span>&nbsp;<span class="op" id="1590152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590157">ok</span>&nbsp;<span class="op" id="1590160">=</span>&nbsp;<span class="builtintype" id="1590162">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590170">r</span>&nbsp;<span class="op" id="1590172">:=</span>&nbsp;<span class="ident" id="1590175">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590180">sp</span>&nbsp;<span class="op" id="1590183">:=</span>&nbsp;<span class="ident" id="1590186">getcallersp</span><span class="op" id="1590197">(</span><span class="ident" id="1590198">unsafe</span><span class="op" id="1590204">.</span><span class="ident" id="1590205">Pointer</span><span class="op" id="1590212">(</span><span class="op" id="1590213">&amp;</span><span class="ident" id="1590214">p</span><span class="op" id="1590215">)</span><span class="op" id="1590216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590221">pc</span>&nbsp;<span class="op" id="1590224">:=</span>&nbsp;<span class="ident" id="1590227">getcallerpc</span><span class="op" id="1590238">(</span><span class="ident" id="1590239">unsafe</span><span class="op" id="1590245">.</span><span class="ident" id="1590246">Pointer</span><span class="op" id="1590253">(</span><span class="op" id="1590254">&amp;</span><span class="ident" id="1590255">p</span><span class="op" id="1590256">)</span><span class="op" id="1590257">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590262">onM</span><span class="op" id="1590265">(</span><span class="keyword" id="1590266">func</span><span class="op" id="1590270">(</span><span class="op" id="1590271">)</span>&nbsp;<span class="op" id="1590273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590279">saveg</span><span class="op" id="1590284">(</span><span class="ident" id="1590285">pc</span><span class="op" id="1590287">,</span>&nbsp;<span class="ident" id="1590289">sp</span><span class="op" id="1590291">,</span>&nbsp;<span class="ident" id="1590293">gp</span><span class="op" id="1590295">,</span>&nbsp;<span class="op" id="1590297">&amp;</span><span class="ident" id="1590298">r</span><span class="op" id="1590299">[</span><span class="num" id="1590300">0</span><span class="op" id="1590301">]</span><span class="op" id="1590302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590307">}</span><span class="op" id="1590308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590313">r</span>&nbsp;<span class="op" id="1590315">=</span>&nbsp;<span class="ident" id="1590317">r</span><span class="op" id="1590318">[</span><span class="num" id="1590319">1</span><span class="op" id="1590320">:</span><span class="op" id="1590321">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590326">for</span>&nbsp;<span class="ident" id="1590330">_</span><span class="op" id="1590331">,</span>&nbsp;<span class="ident" id="1590333">gp1</span>&nbsp;<span class="op" id="1590337">:=</span>&nbsp;<span class="keyword" id="1590340">range</span>&nbsp;<span class="ident" id="1590346">allgs</span>&nbsp;<span class="op" id="1590352">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590358">if</span>&nbsp;<span class="ident" id="1590361">gp1</span>&nbsp;<span class="op" id="1590365">==</span>&nbsp;<span class="ident" id="1590368">gp</span>&nbsp;<span class="op" id="1590371">||</span>&nbsp;<span class="ident" id="1590374">readgstatus</span><span class="op" id="1590385">(</span><span class="ident" id="1590386">gp1</span><span class="op" id="1590389">)</span>&nbsp;<span class="op" id="1590391">==</span>&nbsp;<span class="ident" id="1590394">_Gdead</span>&nbsp;<span class="op" id="1590401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590408">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590427">saveg</span><span class="op" id="1590432">(</span><span class="op" id="1590433">^</span><span class="builtintype" id="1590434">uintptr</span><span class="op" id="1590441">(</span><span class="num" id="1590442">0</span><span class="op" id="1590443">)</span><span class="op" id="1590444">,</span>&nbsp;<span class="op" id="1590446">^</span><span class="builtintype" id="1590447">uintptr</span><span class="op" id="1590454">(</span><span class="num" id="1590455">0</span><span class="op" id="1590456">)</span><span class="op" id="1590457">,</span>&nbsp;<span class="ident" id="1590459">gp1</span><span class="op" id="1590462">,</span>&nbsp;<span class="op" id="1590464">&amp;</span><span class="ident" id="1590465">r</span><span class="op" id="1590466">[</span><span class="num" id="1590467">0</span><span class="op" id="1590468">]</span><span class="op" id="1590469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590475">r</span>&nbsp;<span class="op" id="1590477">=</span>&nbsp;<span class="ident" id="1590479">r</span><span class="op" id="1590480">[</span><span class="num" id="1590481">1</span><span class="op" id="1590482">:</span><span class="op" id="1590483">]</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590497">gp</span><span class="op" id="1590499">.</span><span class="ident" id="1590500">m</span><span class="op" id="1590501">.</span><span class="ident" id="1590502">gcing</span>&nbsp;<span class="op" id="1590508">=</span>&nbsp;<span class="num" id="1590510">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590514">semrelease</span><span class="op" id="1590524">(</span><span class="op" id="1590525">&amp;</span><span class="ident" id="1590526">worldsema</span><span class="op" id="1590535">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590539">onM</span><span class="op" id="1590542">(</span><span class="ident" id="1590543">starttheworld</span><span class="op" id="1590556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590563">return</span>&nbsp;<span class="ident" id="1590570">n</span><span class="op" id="1590571">,</span>&nbsp;<span class="ident" id="1590573">ok</span><br>
<span class="lineno"></span><span class="op" id="1590576">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1590579">func</span>&nbsp;<span class="ident" id="1590584">saveg</span><span class="op" id="1590589">(</span><span class="ident" id="1590590">pc</span><span class="op" id="1590592">,</span>&nbsp;<span class="ident" id="1590594">sp</span>&nbsp;<span class="builtintype" id="1590597">uintptr</span><span class="op" id="1590604">,</span>&nbsp;<span class="ident" id="1590606">gp</span>&nbsp;<span class="op" id="1590609">*</span><span class="ident" id="1590610">g</span><span class="op" id="1590611">,</span>&nbsp;<span class="ident" id="1590613">r</span>&nbsp;<span class="op" id="1590615">*</span><span class="ident" id="1590616">StackRecord</span><span class="op" id="1590627">)</span>&nbsp;<span class="op" id="1590629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590632">n</span>&nbsp;<span class="op" id="1590634">:=</span>&nbsp;<span class="ident" id="1590637">gentraceback</span><span class="op" id="1590649">(</span><span class="ident" id="1590650">pc</span><span class="op" id="1590652">,</span>&nbsp;<span class="ident" id="1590654">sp</span><span class="op" id="1590656">,</span>&nbsp;<span class="num" id="1590658">0</span><span class="op" id="1590659">,</span>&nbsp;<span class="ident" id="1590661">gp</span><span class="op" id="1590663">,</span>&nbsp;<span class="num" id="1590665">0</span><span class="op" id="1590666">,</span>&nbsp;<span class="op" id="1590668">&amp;</span><span class="ident" id="1590669">r</span><span class="op" id="1590670">.</span><span class="ident" id="1590671">Stack0</span><span class="op" id="1590677">[</span><span class="num" id="1590678">0</span><span class="op" id="1590679">]</span><span class="op" id="1590680">,</span>&nbsp;<span class="builtinfunc" id="1590682">len</span><span class="op" id="1590685">(</span><span class="ident" id="1590686">r</span><span class="op" id="1590687">.</span><span class="ident" id="1590688">Stack0</span><span class="op" id="1590694">)</span><span class="op" id="1590695">,</span>&nbsp;<span class="ident" id="1590697">nil</span><span class="op" id="1590700">,</span>&nbsp;<span class="ident" id="1590702">nil</span><span class="op" id="1590705">,</span>&nbsp;<span class="num" id="1590707">0</span><span class="op" id="1590708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1590711">if</span>&nbsp;<span class="ident" id="1590714">n</span>&nbsp;<span class="op" id="1590716">&lt;</span>&nbsp;<span class="builtinfunc" id="1590718">len</span><span class="op" id="1590721">(</span><span class="ident" id="1590722">r</span><span class="op" id="1590723">.</span><span class="ident" id="1590724">Stack0</span><span class="op" id="1590730">)</span>&nbsp;<span class="op" id="1590732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1590736">r</span><span class="op" id="1590737">.</span><span class="ident" id="1590738">Stack0</span><span class="op" id="1590744">[</span><span class="ident" id="1590745">n</span><span class="op" id="1590746">]</span>&nbsp;<span class="op" id="1590748">=</span>&nbsp;<span class="num" id="1590750">0</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1590753">}</span><br>
<span class="lineno"></span><span class="op" id="1590755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1590758">//&nbsp;Stack&nbsp;formats&nbsp;a&nbsp;stack&nbsp;trace&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine&nbsp;into&nbsp;buf</span><br>
<span class="lineno"></span><span class="comment" id="1590823">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;to&nbsp;buf.</span><br>
<span class="lineno">575</span><span class="comment" id="1590874">//&nbsp;If&nbsp;all&nbsp;is&nbsp;true,&nbsp;Stack&nbsp;formats&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;other&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="1590944">//&nbsp;into&nbsp;buf&nbsp;after&nbsp;the&nbsp;trace&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1590999">func</span>&nbsp;<span class="ident" id="1591004">Stack</span><span class="op" id="1591009">(</span><span class="ident" id="1591010">buf</span>&nbsp;<span class="op" id="1591014">[</span><span class="op" id="1591015">]</span><span class="builtintype" id="1591016">byte</span><span class="op" id="1591020">,</span>&nbsp;<span class="ident" id="1591022">all</span>&nbsp;<span class="builtintype" id="1591026">bool</span><span class="op" id="1591030">)</span>&nbsp;<span class="builtintype" id="1591032">int</span>&nbsp;<span class="op" id="1591036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591039">mp</span>&nbsp;<span class="op" id="1591042">:=</span>&nbsp;<span class="ident" id="1591045">acquirem</span><span class="op" id="1591053">(</span><span class="op" id="1591054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591057">gp</span>&nbsp;<span class="op" id="1591060">:=</span>&nbsp;<span class="ident" id="1591063">mp</span><span class="op" id="1591065">.</span><span class="ident" id="1591066">curg</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591072">if</span>&nbsp;<span class="ident" id="1591075">all</span>&nbsp;<span class="op" id="1591079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591083">semacquire</span><span class="op" id="1591093">(</span><span class="op" id="1591094">&amp;</span><span class="ident" id="1591095">worldsema</span><span class="op" id="1591104">,</span>&nbsp;<span class="builtintype" id="1591106">false</span><span class="op" id="1591111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591115">mp</span><span class="op" id="1591117">.</span><span class="ident" id="1591118">gcing</span>&nbsp;<span class="op" id="1591124">=</span>&nbsp;<span class="num" id="1591126">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591130">releasem</span><span class="op" id="1591138">(</span><span class="ident" id="1591139">mp</span><span class="op" id="1591141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591145">onM</span><span class="op" id="1591148">(</span><span class="ident" id="1591149">stoptheworld</span><span class="op" id="1591161">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591165">if</span>&nbsp;<span class="ident" id="1591168">mp</span>&nbsp;<span class="op" id="1591171">!=</span>&nbsp;<span class="ident" id="1591174">acquirem</span><span class="op" id="1591182">(</span><span class="op" id="1591183">)</span>&nbsp;<span class="op" id="1591185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591190">gothrow</span><span class="op" id="1591197">(</span><span class="string" id="1591198">&#34;Stack:&nbsp;rescheduled&#34;</span><span class="op" id="1591218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591229">n</span>&nbsp;<span class="op" id="1591231">:=</span>&nbsp;<span class="num" id="1591234">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591237">if</span>&nbsp;<span class="builtinfunc" id="1591240">len</span><span class="op" id="1591243">(</span><span class="ident" id="1591244">buf</span><span class="op" id="1591247">)</span>&nbsp;<span class="op" id="1591249">&gt;</span>&nbsp;<span class="num" id="1591251">0</span>&nbsp;<span class="op" id="1591253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591257">sp</span>&nbsp;<span class="op" id="1591260">:=</span>&nbsp;<span class="ident" id="1591263">getcallersp</span><span class="op" id="1591274">(</span><span class="ident" id="1591275">unsafe</span><span class="op" id="1591281">.</span><span class="ident" id="1591282">Pointer</span><span class="op" id="1591289">(</span><span class="op" id="1591290">&amp;</span><span class="ident" id="1591291">buf</span><span class="op" id="1591294">)</span><span class="op" id="1591295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591299">pc</span>&nbsp;<span class="op" id="1591302">:=</span>&nbsp;<span class="ident" id="1591305">getcallerpc</span><span class="op" id="1591316">(</span><span class="ident" id="1591317">unsafe</span><span class="op" id="1591323">.</span><span class="ident" id="1591324">Pointer</span><span class="op" id="1591331">(</span><span class="op" id="1591332">&amp;</span><span class="ident" id="1591333">buf</span><span class="op" id="1591336">)</span><span class="op" id="1591337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591341">onM</span><span class="op" id="1591344">(</span><span class="keyword" id="1591345">func</span><span class="op" id="1591349">(</span><span class="op" id="1591350">)</span>&nbsp;<span class="op" id="1591352">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591357">g0</span>&nbsp;<span class="op" id="1591360">:=</span>&nbsp;<span class="ident" id="1591363">getg</span><span class="op" id="1591367">(</span><span class="op" id="1591368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591373">g0</span><span class="op" id="1591375">.</span><span class="ident" id="1591376">writebuf</span>&nbsp;<span class="op" id="1591385">=</span>&nbsp;<span class="ident" id="1591387">buf</span><span class="op" id="1591390">[</span><span class="num" id="1591391">0</span><span class="op" id="1591392">:</span><span class="num" id="1591393">0</span><span class="op" id="1591394">:</span><span class="builtinfunc" id="1591395">len</span><span class="op" id="1591398">(</span><span class="ident" id="1591399">buf</span><span class="op" id="1591402">)</span><span class="op" id="1591403">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591408">goroutineheader</span><span class="op" id="1591423">(</span><span class="ident" id="1591424">gp</span><span class="op" id="1591426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591431">traceback</span><span class="op" id="1591440">(</span><span class="ident" id="1591441">pc</span><span class="op" id="1591443">,</span>&nbsp;<span class="ident" id="1591445">sp</span><span class="op" id="1591447">,</span>&nbsp;<span class="num" id="1591449">0</span><span class="op" id="1591450">,</span>&nbsp;<span class="ident" id="1591452">gp</span><span class="op" id="1591454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591459">if</span>&nbsp;<span class="ident" id="1591462">all</span>&nbsp;<span class="op" id="1591466">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591472">tracebackothers</span><span class="op" id="1591487">(</span><span class="ident" id="1591488">gp</span><span class="op" id="1591490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591500">n</span>&nbsp;<span class="op" id="1591502">=</span>&nbsp;<span class="builtinfunc" id="1591504">len</span><span class="op" id="1591507">(</span><span class="ident" id="1591508">g0</span><span class="op" id="1591510">.</span><span class="ident" id="1591511">writebuf</span><span class="op" id="1591519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591524">g0</span><span class="op" id="1591526">.</span><span class="ident" id="1591527">writebuf</span>&nbsp;<span class="op" id="1591536">=</span>&nbsp;<span class="ident" id="1591538">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591544">}</span><span class="op" id="1591545">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591552">if</span>&nbsp;<span class="ident" id="1591555">all</span>&nbsp;<span class="op" id="1591559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591563">mp</span><span class="op" id="1591565">.</span><span class="ident" id="1591566">gcing</span>&nbsp;<span class="op" id="1591572">=</span>&nbsp;<span class="num" id="1591574">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591578">semrelease</span><span class="op" id="1591588">(</span><span class="op" id="1591589">&amp;</span><span class="ident" id="1591590">worldsema</span><span class="op" id="1591599">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591603">onM</span><span class="op" id="1591606">(</span><span class="ident" id="1591607">starttheworld</span><span class="op" id="1591620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591626">releasem</span><span class="op" id="1591634">(</span><span class="ident" id="1591635">mp</span><span class="op" id="1591637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591640">return</span>&nbsp;<span class="ident" id="1591647">n</span><br>
<span class="lineno"></span><span class="op" id="1591649">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="comment" id="1591652">//&nbsp;Tracing&nbsp;of&nbsp;alloc/free/gc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1591682">var</span>&nbsp;<span class="ident" id="1591686">tracelock</span>&nbsp;<span class="ident" id="1591696">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="1591703">func</span>&nbsp;<span class="ident" id="1591708">tracealloc</span><span class="op" id="1591718">(</span><span class="ident" id="1591719">p</span>&nbsp;<span class="ident" id="1591721">unsafe</span><span class="op" id="1591727">.</span><span class="ident" id="1591728">Pointer</span><span class="op" id="1591735">,</span>&nbsp;<span class="ident" id="1591737">size</span>&nbsp;<span class="builtintype" id="1591742">uintptr</span><span class="op" id="1591749">,</span>&nbsp;<span class="ident" id="1591751">typ</span>&nbsp;<span class="op" id="1591755">*</span><span class="ident" id="1591756">_type</span><span class="op" id="1591761">)</span>&nbsp;<span class="op" id="1591763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591766">lock</span><span class="op" id="1591770">(</span><span class="op" id="1591771">&amp;</span><span class="ident" id="1591772">tracelock</span><span class="op" id="1591781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591784">gp</span>&nbsp;<span class="op" id="1591787">:=</span>&nbsp;<span class="ident" id="1591790">getg</span><span class="op" id="1591794">(</span><span class="op" id="1591795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1591798">gp</span><span class="op" id="1591800">.</span><span class="ident" id="1591801">m</span><span class="op" id="1591802">.</span><span class="ident" id="1591803">traceback</span>&nbsp;<span class="op" id="1591813">=</span>&nbsp;<span class="num" id="1591815">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591818">if</span>&nbsp;<span class="ident" id="1591821">typ</span>&nbsp;<span class="op" id="1591825">==</span>&nbsp;<span class="ident" id="1591828">nil</span>&nbsp;<span class="op" id="1591832">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1591836">print</span><span class="op" id="1591841">(</span><span class="string" id="1591842">&#34;tracealloc(&#34;</span><span class="op" id="1591855">,</span>&nbsp;<span class="ident" id="1591857">p</span><span class="op" id="1591858">,</span>&nbsp;<span class="string" id="1591860">&#34;,&nbsp;&#34;</span><span class="op" id="1591864">,</span>&nbsp;<span class="ident" id="1591866">hex</span><span class="op" id="1591869">(</span><span class="ident" id="1591870">size</span><span class="op" id="1591874">)</span><span class="op" id="1591875">,</span>&nbsp;<span class="string" id="1591877">&#34;)\n&#34;</span><span class="op" id="1591882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591885">}</span>&nbsp;<span class="keyword" id="1591887">else</span>&nbsp;<span class="op" id="1591892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1591896">print</span><span class="op" id="1591901">(</span><span class="string" id="1591902">&#34;tracealloc(&#34;</span><span class="op" id="1591915">,</span>&nbsp;<span class="ident" id="1591917">p</span><span class="op" id="1591918">,</span>&nbsp;<span class="string" id="1591920">&#34;,&nbsp;&#34;</span><span class="op" id="1591924">,</span>&nbsp;<span class="ident" id="1591926">hex</span><span class="op" id="1591929">(</span><span class="ident" id="1591930">size</span><span class="op" id="1591934">)</span><span class="op" id="1591935">,</span>&nbsp;<span class="string" id="1591937">&#34;,&nbsp;&#34;</span><span class="op" id="1591941">,</span>&nbsp;<span class="op" id="1591943">*</span><span class="ident" id="1591944">typ</span><span class="op" id="1591947">.</span><span class="ident" id="1591948">_string</span><span class="op" id="1591955">,</span>&nbsp;<span class="string" id="1591957">&#34;)\n&#34;</span><span class="op" id="1591962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1591965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1591968">if</span>&nbsp;<span class="ident" id="1591971">gp</span><span class="op" id="1591973">.</span><span class="ident" id="1591974">m</span><span class="op" id="1591975">.</span><span class="ident" id="1591976">curg</span>&nbsp;<span class="op" id="1591981">==</span>&nbsp;<span class="ident" id="1591984">nil</span>&nbsp;<span class="op" id="1591988">||</span>&nbsp;<span class="ident" id="1591991">gp</span>&nbsp;<span class="op" id="1591994">==</span>&nbsp;<span class="ident" id="1591997">gp</span><span class="op" id="1591999">.</span><span class="ident" id="1592000">m</span><span class="op" id="1592001">.</span><span class="ident" id="1592002">curg</span>&nbsp;<span class="op" id="1592007">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592011">goroutineheader</span><span class="op" id="1592026">(</span><span class="ident" id="1592027">gp</span><span class="op" id="1592029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592033">pc</span>&nbsp;<span class="op" id="1592036">:=</span>&nbsp;<span class="ident" id="1592039">getcallerpc</span><span class="op" id="1592050">(</span><span class="ident" id="1592051">unsafe</span><span class="op" id="1592057">.</span><span class="ident" id="1592058">Pointer</span><span class="op" id="1592065">(</span><span class="op" id="1592066">&amp;</span><span class="ident" id="1592067">p</span><span class="op" id="1592068">)</span><span class="op" id="1592069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592073">sp</span>&nbsp;<span class="op" id="1592076">:=</span>&nbsp;<span class="ident" id="1592079">getcallersp</span><span class="op" id="1592090">(</span><span class="ident" id="1592091">unsafe</span><span class="op" id="1592097">.</span><span class="ident" id="1592098">Pointer</span><span class="op" id="1592105">(</span><span class="op" id="1592106">&amp;</span><span class="ident" id="1592107">p</span><span class="op" id="1592108">)</span><span class="op" id="1592109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592113">onM</span><span class="op" id="1592116">(</span><span class="keyword" id="1592117">func</span><span class="op" id="1592121">(</span><span class="op" id="1592122">)</span>&nbsp;<span class="op" id="1592124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592129">traceback</span><span class="op" id="1592138">(</span><span class="ident" id="1592139">pc</span><span class="op" id="1592141">,</span>&nbsp;<span class="ident" id="1592143">sp</span><span class="op" id="1592145">,</span>&nbsp;<span class="num" id="1592147">0</span><span class="op" id="1592148">,</span>&nbsp;<span class="ident" id="1592150">gp</span><span class="op" id="1592152">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1592156">}</span><span class="op" id="1592157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1592160">}</span>&nbsp;<span class="keyword" id="1592162">else</span>&nbsp;<span class="op" id="1592167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592171">goroutineheader</span><span class="op" id="1592186">(</span><span class="ident" id="1592187">gp</span><span class="op" id="1592189">.</span><span class="ident" id="1592190">m</span><span class="op" id="1592191">.</span><span class="ident" id="1592192">curg</span><span class="op" id="1592196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592200">traceback</span><span class="op" id="1592209">(</span><span class="op" id="1592210">^</span><span class="builtintype" id="1592211">uintptr</span><span class="op" id="1592218">(</span><span class="num" id="1592219">0</span><span class="op" id="1592220">)</span><span class="op" id="1592221">,</span>&nbsp;<span class="op" id="1592223">^</span><span class="builtintype" id="1592224">uintptr</span><span class="op" id="1592231">(</span><span class="num" id="1592232">0</span><span class="op" id="1592233">)</span><span class="op" id="1592234">,</span>&nbsp;<span class="num" id="1592236">0</span><span class="op" id="1592237">,</span>&nbsp;<span class="ident" id="1592239">gp</span><span class="op" id="1592241">.</span><span class="ident" id="1592242">m</span><span class="op" id="1592243">.</span><span class="ident" id="1592244">curg</span><span class="op" id="1592248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1592251">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1592254">print</span><span class="op" id="1592259">(</span><span class="string" id="1592260">&#34;\n&#34;</span><span class="op" id="1592264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592267">gp</span><span class="op" id="1592269">.</span><span class="ident" id="1592270">m</span><span class="op" id="1592271">.</span><span class="ident" id="1592272">traceback</span>&nbsp;<span class="op" id="1592282">=</span>&nbsp;<span class="num" id="1592284">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592287">unlock</span><span class="op" id="1592293">(</span><span class="op" id="1592294">&amp;</span><span class="ident" id="1592295">tracelock</span><span class="op" id="1592304">)</span><br>
<span class="lineno"></span><span class="op" id="1592306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span><span class="keyword" id="1592309">func</span>&nbsp;<span class="ident" id="1592314">tracefree</span><span class="op" id="1592323">(</span><span class="ident" id="1592324">p</span>&nbsp;<span class="ident" id="1592326">unsafe</span><span class="op" id="1592332">.</span><span class="ident" id="1592333">Pointer</span><span class="op" id="1592340">,</span>&nbsp;<span class="ident" id="1592342">size</span>&nbsp;<span class="builtintype" id="1592347">uintptr</span><span class="op" id="1592354">)</span>&nbsp;<span class="op" id="1592356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592359">lock</span><span class="op" id="1592363">(</span><span class="op" id="1592364">&amp;</span><span class="ident" id="1592365">tracelock</span><span class="op" id="1592374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592377">gp</span>&nbsp;<span class="op" id="1592380">:=</span>&nbsp;<span class="ident" id="1592383">getg</span><span class="op" id="1592387">(</span><span class="op" id="1592388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592391">gp</span><span class="op" id="1592393">.</span><span class="ident" id="1592394">m</span><span class="op" id="1592395">.</span><span class="ident" id="1592396">traceback</span>&nbsp;<span class="op" id="1592406">=</span>&nbsp;<span class="num" id="1592408">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1592411">print</span><span class="op" id="1592416">(</span><span class="string" id="1592417">&#34;tracefree(&#34;</span><span class="op" id="1592429">,</span>&nbsp;<span class="ident" id="1592431">p</span><span class="op" id="1592432">,</span>&nbsp;<span class="string" id="1592434">&#34;,&nbsp;&#34;</span><span class="op" id="1592438">,</span>&nbsp;<span class="ident" id="1592440">hex</span><span class="op" id="1592443">(</span><span class="ident" id="1592444">size</span><span class="op" id="1592448">)</span><span class="op" id="1592449">,</span>&nbsp;<span class="string" id="1592451">&#34;)\n&#34;</span><span class="op" id="1592456">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592459">goroutineheader</span><span class="op" id="1592474">(</span><span class="ident" id="1592475">gp</span><span class="op" id="1592477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592480">pc</span>&nbsp;<span class="op" id="1592483">:=</span>&nbsp;<span class="ident" id="1592486">getcallerpc</span><span class="op" id="1592497">(</span><span class="ident" id="1592498">unsafe</span><span class="op" id="1592504">.</span><span class="ident" id="1592505">Pointer</span><span class="op" id="1592512">(</span><span class="op" id="1592513">&amp;</span><span class="ident" id="1592514">p</span><span class="op" id="1592515">)</span><span class="op" id="1592516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592519">sp</span>&nbsp;<span class="op" id="1592522">:=</span>&nbsp;<span class="ident" id="1592525">getcallersp</span><span class="op" id="1592536">(</span><span class="ident" id="1592537">unsafe</span><span class="op" id="1592543">.</span><span class="ident" id="1592544">Pointer</span><span class="op" id="1592551">(</span><span class="op" id="1592552">&amp;</span><span class="ident" id="1592553">p</span><span class="op" id="1592554">)</span><span class="op" id="1592555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592558">onM</span><span class="op" id="1592561">(</span><span class="keyword" id="1592562">func</span><span class="op" id="1592566">(</span><span class="op" id="1592567">)</span>&nbsp;<span class="op" id="1592569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592573">traceback</span><span class="op" id="1592582">(</span><span class="ident" id="1592583">pc</span><span class="op" id="1592585">,</span>&nbsp;<span class="ident" id="1592587">sp</span><span class="op" id="1592589">,</span>&nbsp;<span class="num" id="1592591">0</span><span class="op" id="1592592">,</span>&nbsp;<span class="ident" id="1592594">gp</span><span class="op" id="1592596">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1592599">}</span><span class="op" id="1592600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1592603">print</span><span class="op" id="1592608">(</span><span class="string" id="1592609">&#34;\n&#34;</span><span class="op" id="1592613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592616">gp</span><span class="op" id="1592618">.</span><span class="ident" id="1592619">m</span><span class="op" id="1592620">.</span><span class="ident" id="1592621">traceback</span>&nbsp;<span class="op" id="1592631">=</span>&nbsp;<span class="num" id="1592633">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592636">unlock</span><span class="op" id="1592642">(</span><span class="op" id="1592643">&amp;</span><span class="ident" id="1592644">tracelock</span><span class="op" id="1592653">)</span><br>
<span class="lineno"></span><span class="op" id="1592655">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="keyword" id="1592658">func</span>&nbsp;<span class="ident" id="1592663">tracegc</span><span class="op" id="1592670">(</span><span class="op" id="1592671">)</span>&nbsp;<span class="op" id="1592673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592676">lock</span><span class="op" id="1592680">(</span><span class="op" id="1592681">&amp;</span><span class="ident" id="1592682">tracelock</span><span class="op" id="1592691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592694">gp</span>&nbsp;<span class="op" id="1592697">:=</span>&nbsp;<span class="ident" id="1592700">getg</span><span class="op" id="1592704">(</span><span class="op" id="1592705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592708">gp</span><span class="op" id="1592710">.</span><span class="ident" id="1592711">m</span><span class="op" id="1592712">.</span><span class="ident" id="1592713">traceback</span>&nbsp;<span class="op" id="1592723">=</span>&nbsp;<span class="num" id="1592725">2</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1592728">print</span><span class="op" id="1592733">(</span><span class="string" id="1592734">&#34;tracegc()\n&#34;</span><span class="op" id="1592747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1592750">//&nbsp;running&nbsp;on&nbsp;m-&gt;g0&nbsp;stack;&nbsp;show&nbsp;all&nbsp;non-g0&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592805">tracebackothers</span><span class="op" id="1592820">(</span><span class="ident" id="1592821">gp</span><span class="op" id="1592823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1592826">print</span><span class="op" id="1592831">(</span><span class="string" id="1592832">&#34;end&nbsp;tracegc\n&#34;</span><span class="op" id="1592847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1592850">print</span><span class="op" id="1592855">(</span><span class="string" id="1592856">&#34;\n&#34;</span><span class="op" id="1592860">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592863">gp</span><span class="op" id="1592865">.</span><span class="ident" id="1592866">m</span><span class="op" id="1592867">.</span><span class="ident" id="1592868">traceback</span>&nbsp;<span class="op" id="1592878">=</span>&nbsp;<span class="num" id="1592880">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1592883">unlock</span><span class="op" id="1592889">(</span><span class="op" id="1592890">&amp;</span><span class="ident" id="1592891">tracelock</span><span class="op" id="1592900">)</span><br>
<span class="lineno"></span><span class="op" id="1592902">}</span>
</div>
</body>
</html>
