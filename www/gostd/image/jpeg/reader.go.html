<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6359762">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6359817">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6359871">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6359922">//&nbsp;Package&nbsp;jpeg&nbsp;implements&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;decoder&nbsp;and&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="comment" id="6359983">//</span><br>
<span class="lineno"></span><span class="comment" id="6359986">//&nbsp;JPEG&nbsp;is&nbsp;defined&nbsp;in&nbsp;ITU-T&nbsp;T.81:&nbsp;http://www.w3.org/Graphics/JPEG/itu-t81.pdf.</span><br>
<span class="lineno"></span><span class="keyword" id="6360065">package</span>&nbsp;<span class="ident" id="6360073">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="6360079">import</span>&nbsp;<span class="op" id="6360086">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6360089">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6360098">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6360113">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6360118">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="6360121">//&nbsp;TODO(nigeltao):&nbsp;fix&nbsp;up&nbsp;the&nbsp;doc&nbsp;comment&nbsp;style&nbsp;so&nbsp;that&nbsp;sentences&nbsp;start&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="6360198">//&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;or&nbsp;function&nbsp;that&nbsp;they&nbsp;annotate.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6360255">//&nbsp;A&nbsp;FormatError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;JPEG.</span><br>
<span class="lineno">20</span><span class="keyword" id="6360316">type</span>&nbsp;<span class="ident" id="6360321">FormatError</span>&nbsp;<span class="builtintype" id="6360333">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6360341">func</span>&nbsp;<span class="op" id="6360346">(</span><span class="ident" id="6360347">e</span>&nbsp;<span class="ident" id="6360349">FormatError</span><span class="op" id="6360360">)</span>&nbsp;<span class="ident" id="6360362">Error</span><span class="op" id="6360367">(</span><span class="op" id="6360368">)</span>&nbsp;<span class="builtintype" id="6360370">string</span>&nbsp;<span class="op" id="6360377">{</span>&nbsp;<span class="keyword" id="6360379">return</span>&nbsp;<span class="string" id="6360386">&#34;invalid&nbsp;JPEG&nbsp;format:&nbsp;&#34;</span>&nbsp;<span class="op" id="6360410">+</span>&nbsp;<span class="builtintype" id="6360412">string</span><span class="op" id="6360418">(</span><span class="ident" id="6360419">e</span><span class="op" id="6360420">)</span>&nbsp;<span class="op" id="6360422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6360425">//&nbsp;An&nbsp;UnsupportedError&nbsp;reports&nbsp;that&nbsp;the&nbsp;input&nbsp;uses&nbsp;a&nbsp;valid&nbsp;but&nbsp;unimplemented&nbsp;JPEG&nbsp;feature.</span><br>
<span class="lineno">25</span><span class="keyword" id="6360516">type</span>&nbsp;<span class="ident" id="6360521">UnsupportedError</span>&nbsp;<span class="builtintype" id="6360538">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6360546">func</span>&nbsp;<span class="op" id="6360551">(</span><span class="ident" id="6360552">e</span>&nbsp;<span class="ident" id="6360554">UnsupportedError</span><span class="op" id="6360570">)</span>&nbsp;<span class="ident" id="6360572">Error</span><span class="op" id="6360577">(</span><span class="op" id="6360578">)</span>&nbsp;<span class="builtintype" id="6360580">string</span>&nbsp;<span class="op" id="6360587">{</span>&nbsp;<span class="keyword" id="6360589">return</span>&nbsp;<span class="string" id="6360596">&#34;unsupported&nbsp;JPEG&nbsp;feature:&nbsp;&#34;</span>&nbsp;<span class="op" id="6360625">+</span>&nbsp;<span class="builtintype" id="6360627">string</span><span class="op" id="6360633">(</span><span class="ident" id="6360634">e</span><span class="op" id="6360635">)</span>&nbsp;<span class="op" id="6360637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6360640">//&nbsp;Component&nbsp;specification,&nbsp;specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno">30</span><span class="keyword" id="6360696">type</span>&nbsp;<span class="ident" id="6360701">component</span>&nbsp;<span class="keyword" id="6360711">struct</span>&nbsp;<span class="op" id="6360718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360721">h</span>&nbsp;&nbsp;<span class="builtintype" id="6360724">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="6360730">//&nbsp;Horizontal&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360762">v</span>&nbsp;&nbsp;<span class="builtintype" id="6360765">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="6360771">//&nbsp;Vertical&nbsp;sampling&nbsp;factor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360801">c</span>&nbsp;&nbsp;<span class="builtintype" id="6360804">uint8</span>&nbsp;<span class="comment" id="6360810">//&nbsp;Component&nbsp;identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360836">tq</span>&nbsp;<span class="builtintype" id="6360839">uint8</span>&nbsp;<span class="comment" id="6360845">//&nbsp;Quantization&nbsp;table&nbsp;destination&nbsp;selector.</span><br>
<span class="lineno">35</span><span class="op" id="6360889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6360892">const</span>&nbsp;<span class="op" id="6360898">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360901">dcTable</span>&nbsp;<span class="op" id="6360909">=</span>&nbsp;<span class="num" id="6360911">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360914">acTable</span>&nbsp;<span class="op" id="6360922">=</span>&nbsp;<span class="num" id="6360924">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360927">maxTc</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6360935">=</span>&nbsp;<span class="num" id="6360937">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360940">maxTh</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6360948">=</span>&nbsp;<span class="num" id="6360950">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360953">maxTq</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6360961">=</span>&nbsp;<span class="num" id="6360963">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6360967">//&nbsp;A&nbsp;grayscale&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;a&nbsp;Y&nbsp;component.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361018">nGrayComponent</span>&nbsp;<span class="op" id="6361033">=</span>&nbsp;<span class="num" id="6361035">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6361038">//&nbsp;A&nbsp;color&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;Y,&nbsp;Cb&nbsp;and&nbsp;Cr&nbsp;components.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361090">nColorComponent</span>&nbsp;<span class="op" id="6361106">=</span>&nbsp;<span class="num" id="6361108">3</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6361112">//&nbsp;We&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;and&nbsp;4:2:0&nbsp;downsampling,&nbsp;and&nbsp;therefore&nbsp;the</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6361194">//&nbsp;number&nbsp;of&nbsp;luma&nbsp;samples&nbsp;per&nbsp;chroma&nbsp;sample&nbsp;is&nbsp;at&nbsp;most&nbsp;2&nbsp;in&nbsp;the&nbsp;horizontal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6361270">//&nbsp;and&nbsp;2&nbsp;in&nbsp;the&nbsp;vertical&nbsp;direction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361307">maxH</span>&nbsp;<span class="op" id="6361312">=</span>&nbsp;<span class="num" id="6361314">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361317">maxV</span>&nbsp;<span class="op" id="6361322">=</span>&nbsp;<span class="num" id="6361324">2</span><br>
<span class="lineno"></span><span class="op" id="6361326">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="6361329">const</span>&nbsp;<span class="op" id="6361335">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361338">soiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6361350">=</span>&nbsp;<span class="num" id="6361352">0xd8</span>&nbsp;<span class="comment" id="6361357">//&nbsp;Start&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361377">eoiMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6361389">=</span>&nbsp;<span class="num" id="6361391">0xd9</span>&nbsp;<span class="comment" id="6361396">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361414">sof0Marker</span>&nbsp;&nbsp;<span class="op" id="6361426">=</span>&nbsp;<span class="num" id="6361428">0xc0</span>&nbsp;<span class="comment" id="6361433">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Baseline).</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361464">sof2Marker</span>&nbsp;&nbsp;<span class="op" id="6361476">=</span>&nbsp;<span class="num" id="6361478">0xc2</span>&nbsp;<span class="comment" id="6361483">//&nbsp;Start&nbsp;Of&nbsp;Frame&nbsp;(Progressive).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361517">dhtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6361529">=</span>&nbsp;<span class="num" id="6361531">0xc4</span>&nbsp;<span class="comment" id="6361536">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361562">dqtMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6361574">=</span>&nbsp;<span class="num" id="6361576">0xdb</span>&nbsp;<span class="comment" id="6361581">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361612">sosMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6361624">=</span>&nbsp;<span class="num" id="6361626">0xda</span>&nbsp;<span class="comment" id="6361631">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361650">driMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6361662">=</span>&nbsp;<span class="num" id="6361664">0xdd</span>&nbsp;<span class="comment" id="6361669">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361698">rst0Marker</span>&nbsp;&nbsp;<span class="op" id="6361710">=</span>&nbsp;<span class="num" id="6361712">0xd0</span>&nbsp;<span class="comment" id="6361717">//&nbsp;ReSTart&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361734">rst7Marker</span>&nbsp;&nbsp;<span class="op" id="6361746">=</span>&nbsp;<span class="num" id="6361748">0xd7</span>&nbsp;<span class="comment" id="6361753">//&nbsp;ReSTart&nbsp;(7).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361770">app0Marker</span>&nbsp;&nbsp;<span class="op" id="6361782">=</span>&nbsp;<span class="num" id="6361784">0xe0</span>&nbsp;<span class="comment" id="6361789">//&nbsp;APPlication&nbsp;specific&nbsp;(0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361819">app15Marker</span>&nbsp;<span class="op" id="6361831">=</span>&nbsp;<span class="num" id="6361833">0xef</span>&nbsp;<span class="comment" id="6361838">//&nbsp;APPlication&nbsp;specific&nbsp;(15).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361869">comMarker</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6361881">=</span>&nbsp;<span class="num" id="6361883">0xfe</span>&nbsp;<span class="comment" id="6361888">//&nbsp;COMment.</span><br>
<span class="lineno">70</span><span class="op" id="6361900">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6361903">//&nbsp;unzig&nbsp;maps&nbsp;from&nbsp;the&nbsp;zig-zag&nbsp;ordering&nbsp;to&nbsp;the&nbsp;natural&nbsp;ordering.&nbsp;For&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="6361981">//&nbsp;unzig[3]&nbsp;is&nbsp;the&nbsp;column&nbsp;and&nbsp;row&nbsp;of&nbsp;the&nbsp;fourth&nbsp;element&nbsp;in&nbsp;zig-zag&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="6362059">//&nbsp;value&nbsp;is&nbsp;16,&nbsp;which&nbsp;means&nbsp;first&nbsp;column&nbsp;(16%8&nbsp;==&nbsp;0)&nbsp;and&nbsp;third&nbsp;row&nbsp;(16/8&nbsp;==&nbsp;2).</span><br>
<span class="lineno">75</span><span class="keyword" id="6362139">var</span>&nbsp;<span class="ident" id="6362143">unzig</span>&nbsp;<span class="op" id="6362149">=</span>&nbsp;<span class="op" id="6362151">[</span><span class="ident" id="6362152">blockSize</span><span class="op" id="6362161">]</span><span class="builtintype" id="6362162">int</span><span class="op" id="6362165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6362168">0</span><span class="op" id="6362169">,</span>&nbsp;<span class="num" id="6362171">1</span><span class="op" id="6362172">,</span>&nbsp;<span class="num" id="6362174">8</span><span class="op" id="6362175">,</span>&nbsp;<span class="num" id="6362177">16</span><span class="op" id="6362179">,</span>&nbsp;<span class="num" id="6362181">9</span><span class="op" id="6362182">,</span>&nbsp;<span class="num" id="6362184">2</span><span class="op" id="6362185">,</span>&nbsp;<span class="num" id="6362187">3</span><span class="op" id="6362188">,</span>&nbsp;<span class="num" id="6362190">10</span><span class="op" id="6362192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6362195">17</span><span class="op" id="6362197">,</span>&nbsp;<span class="num" id="6362199">24</span><span class="op" id="6362201">,</span>&nbsp;<span class="num" id="6362203">32</span><span class="op" id="6362205">,</span>&nbsp;<span class="num" id="6362207">25</span><span class="op" id="6362209">,</span>&nbsp;<span class="num" id="6362211">18</span><span class="op" id="6362213">,</span>&nbsp;<span class="num" id="6362215">11</span><span class="op" id="6362217">,</span>&nbsp;<span class="num" id="6362219">4</span><span class="op" id="6362220">,</span>&nbsp;<span class="num" id="6362222">5</span><span class="op" id="6362223">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6362226">12</span><span class="op" id="6362228">,</span>&nbsp;<span class="num" id="6362230">19</span><span class="op" id="6362232">,</span>&nbsp;<span class="num" id="6362234">26</span><span class="op" id="6362236">,</span>&nbsp;<span class="num" id="6362238">33</span><span class="op" id="6362240">,</span>&nbsp;<span class="num" id="6362242">40</span><span class="op" id="6362244">,</span>&nbsp;<span class="num" id="6362246">48</span><span class="op" id="6362248">,</span>&nbsp;<span class="num" id="6362250">41</span><span class="op" id="6362252">,</span>&nbsp;<span class="num" id="6362254">34</span><span class="op" id="6362256">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6362259">27</span><span class="op" id="6362261">,</span>&nbsp;<span class="num" id="6362263">20</span><span class="op" id="6362265">,</span>&nbsp;<span class="num" id="6362267">13</span><span class="op" id="6362269">,</span>&nbsp;<span class="num" id="6362271">6</span><span class="op" id="6362272">,</span>&nbsp;<span class="num" id="6362274">7</span><span class="op" id="6362275">,</span>&nbsp;<span class="num" id="6362277">14</span><span class="op" id="6362279">,</span>&nbsp;<span class="num" id="6362281">21</span><span class="op" id="6362283">,</span>&nbsp;<span class="num" id="6362285">28</span><span class="op" id="6362287">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6362290">35</span><span class="op" id="6362292">,</span>&nbsp;<span class="num" id="6362294">42</span><span class="op" id="6362296">,</span>&nbsp;<span class="num" id="6362298">49</span><span class="op" id="6362300">,</span>&nbsp;<span class="num" id="6362302">56</span><span class="op" id="6362304">,</span>&nbsp;<span class="num" id="6362306">57</span><span class="op" id="6362308">,</span>&nbsp;<span class="num" id="6362310">50</span><span class="op" id="6362312">,</span>&nbsp;<span class="num" id="6362314">43</span><span class="op" id="6362316">,</span>&nbsp;<span class="num" id="6362318">36</span><span class="op" id="6362320">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6362323">29</span><span class="op" id="6362325">,</span>&nbsp;<span class="num" id="6362327">22</span><span class="op" id="6362329">,</span>&nbsp;<span class="num" id="6362331">15</span><span class="op" id="6362333">,</span>&nbsp;<span class="num" id="6362335">23</span><span class="op" id="6362337">,</span>&nbsp;<span class="num" id="6362339">30</span><span class="op" id="6362341">,</span>&nbsp;<span class="num" id="6362343">37</span><span class="op" id="6362345">,</span>&nbsp;<span class="num" id="6362347">44</span><span class="op" id="6362349">,</span>&nbsp;<span class="num" id="6362351">51</span><span class="op" id="6362353">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6362356">58</span><span class="op" id="6362358">,</span>&nbsp;<span class="num" id="6362360">59</span><span class="op" id="6362362">,</span>&nbsp;<span class="num" id="6362364">52</span><span class="op" id="6362366">,</span>&nbsp;<span class="num" id="6362368">45</span><span class="op" id="6362370">,</span>&nbsp;<span class="num" id="6362372">38</span><span class="op" id="6362374">,</span>&nbsp;<span class="num" id="6362376">31</span><span class="op" id="6362378">,</span>&nbsp;<span class="num" id="6362380">39</span><span class="op" id="6362382">,</span>&nbsp;<span class="num" id="6362384">46</span><span class="op" id="6362386">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6362389">53</span><span class="op" id="6362391">,</span>&nbsp;<span class="num" id="6362393">60</span><span class="op" id="6362395">,</span>&nbsp;<span class="num" id="6362397">61</span><span class="op" id="6362399">,</span>&nbsp;<span class="num" id="6362401">54</span><span class="op" id="6362403">,</span>&nbsp;<span class="num" id="6362405">47</span><span class="op" id="6362407">,</span>&nbsp;<span class="num" id="6362409">55</span><span class="op" id="6362411">,</span>&nbsp;<span class="num" id="6362413">62</span><span class="op" id="6362415">,</span>&nbsp;<span class="num" id="6362417">63</span><span class="op" id="6362419">,</span><br>
<span class="lineno"></span><span class="op" id="6362421">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="6362424">//&nbsp;Reader&nbsp;is&nbsp;deprecated.</span><br>
<span class="lineno"></span><span class="keyword" id="6362449">type</span>&nbsp;<span class="ident" id="6362454">Reader</span>&nbsp;<span class="keyword" id="6362461">interface</span>&nbsp;<span class="op" id="6362471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362474">io</span><span class="op" id="6362476">.</span><span class="ident" id="6362477">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362489">io</span><span class="op" id="6362491">.</span><span class="ident" id="6362492">Reader</span><br>
<span class="lineno">90</span><span class="op" id="6362499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6362502">//&nbsp;bits&nbsp;holds&nbsp;the&nbsp;unprocessed&nbsp;bits&nbsp;that&nbsp;have&nbsp;been&nbsp;taken&nbsp;from&nbsp;the&nbsp;byte-stream.</span><br>
<span class="lineno"></span><span class="comment" id="6362580">//&nbsp;The&nbsp;n&nbsp;least&nbsp;significant&nbsp;bits&nbsp;of&nbsp;a&nbsp;form&nbsp;the&nbsp;unread&nbsp;bits,&nbsp;to&nbsp;be&nbsp;read&nbsp;in&nbsp;MSB&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6362660">//&nbsp;LSB&nbsp;order.</span><br>
<span class="lineno">95</span><span class="keyword" id="6362674">type</span>&nbsp;<span class="ident" id="6362679">bits</span>&nbsp;<span class="keyword" id="6362684">struct</span>&nbsp;<span class="op" id="6362691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362694">a</span>&nbsp;<span class="builtintype" id="6362696">uint32</span>&nbsp;<span class="comment" id="6362703">//&nbsp;accumulator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362720">m</span>&nbsp;<span class="builtintype" id="6362722">uint32</span>&nbsp;<span class="comment" id="6362729">//&nbsp;mask.&nbsp;m==1&lt;&lt;(n-1)&nbsp;when&nbsp;n&gt;0,&nbsp;with&nbsp;m==0&nbsp;when&nbsp;n==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362782">n</span>&nbsp;<span class="builtintype" id="6362784">int32</span>&nbsp;&nbsp;<span class="comment" id="6362791">//&nbsp;the&nbsp;number&nbsp;of&nbsp;unread&nbsp;bits&nbsp;in&nbsp;a.</span><br>
<span class="lineno"></span><span class="op" id="6362826">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="6362829">type</span>&nbsp;<span class="ident" id="6362834">decoder</span>&nbsp;<span class="keyword" id="6362842">struct</span>&nbsp;<span class="op" id="6362849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362852">r</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6362857">io</span><span class="op" id="6362859">.</span><span class="ident" id="6362860">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362868">bits</span>&nbsp;<span class="ident" id="6362873">bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6362879">//&nbsp;bytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;buffer,&nbsp;similar&nbsp;to&nbsp;a&nbsp;bufio.Reader,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6362949">//&nbsp;has&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;unread&nbsp;more&nbsp;than&nbsp;1&nbsp;byte,&nbsp;due&nbsp;to&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6363018">//&nbsp;Byte&nbsp;stuffing&nbsp;is&nbsp;specified&nbsp;in&nbsp;section&nbsp;F.1.2.3.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363069">bytes</span>&nbsp;<span class="keyword" id="6363075">struct</span>&nbsp;<span class="op" id="6363082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6363086">//&nbsp;buf[i:j]&nbsp;are&nbsp;the&nbsp;buffered&nbsp;bytes&nbsp;read&nbsp;from&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6363148">//&nbsp;io.Reader&nbsp;that&nbsp;haven&#39;t&nbsp;yet&nbsp;been&nbsp;passed&nbsp;further&nbsp;on.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363204">buf</span>&nbsp;&nbsp;<span class="op" id="6363209">[</span><span class="num" id="6363210">4096</span><span class="op" id="6363214">]</span><span class="builtintype" id="6363215">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363222">i</span><span class="op" id="6363223">,</span>&nbsp;<span class="ident" id="6363225">j</span>&nbsp;<span class="builtintype" id="6363227">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6363233">//&nbsp;nUnreadable&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;back&nbsp;up&nbsp;i&nbsp;after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6363292">//&nbsp;overshooting.&nbsp;It&nbsp;can&nbsp;be&nbsp;0,&nbsp;1&nbsp;or&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363332">nUnreadable</span>&nbsp;<span class="builtintype" id="6363344">int</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6363349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363352">width</span><span class="op" id="6363357">,</span>&nbsp;<span class="ident" id="6363359">height</span>&nbsp;<span class="builtintype" id="6363366">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363371">img1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363385">*</span><span class="ident" id="6363386">image</span><span class="op" id="6363391">.</span><span class="ident" id="6363392">Gray</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363398">img3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363412">*</span><span class="ident" id="6363413">image</span><span class="op" id="6363418">.</span><span class="ident" id="6363419">YCbCr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363426">ri</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6363440">int</span>&nbsp;<span class="comment" id="6363444">//&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363466">nComp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6363480">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363485">progressive</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6363499">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363505">eobRun</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6363519">uint16</span>&nbsp;<span class="comment" id="6363526">//&nbsp;End-of-Band&nbsp;run,&nbsp;specified&nbsp;in&nbsp;section&nbsp;G.1.2.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363577">comp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363591">[</span><span class="ident" id="6363592">nColorComponent</span><span class="op" id="6363607">]</span><span class="ident" id="6363608">component</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363619">progCoeffs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363633">[</span><span class="ident" id="6363634">nColorComponent</span><span class="op" id="6363649">]</span><span class="op" id="6363650">[</span><span class="op" id="6363651">]</span><span class="ident" id="6363652">block</span>&nbsp;<span class="comment" id="6363658">//&nbsp;Saved&nbsp;state&nbsp;between&nbsp;progressive-mode&nbsp;scans.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363706">huff</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363720">[</span><span class="ident" id="6363721">maxTc</span>&nbsp;<span class="op" id="6363727">+</span>&nbsp;<span class="num" id="6363729">1</span><span class="op" id="6363730">]</span><span class="op" id="6363731">[</span><span class="ident" id="6363732">maxTh</span>&nbsp;<span class="op" id="6363738">+</span>&nbsp;<span class="num" id="6363740">1</span><span class="op" id="6363741">]</span><span class="ident" id="6363742">huffman</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363751">quant</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363765">[</span><span class="ident" id="6363766">maxTq</span>&nbsp;<span class="op" id="6363772">+</span>&nbsp;<span class="num" id="6363774">1</span><span class="op" id="6363775">]</span><span class="ident" id="6363776">block</span>&nbsp;<span class="comment" id="6363782">//&nbsp;Quantization&nbsp;tables,&nbsp;in&nbsp;zig-zag&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363825">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6363839">[</span><span class="ident" id="6363840">blockSize</span>&nbsp;<span class="op" id="6363850">+</span>&nbsp;<span class="num" id="6363852">1</span><span class="op" id="6363853">]</span><span class="builtintype" id="6363854">byte</span><br>
<span class="lineno"></span><span class="op" id="6363859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="6363862">//&nbsp;fill&nbsp;fills&nbsp;up&nbsp;the&nbsp;d.bytes.buf&nbsp;buffer&nbsp;from&nbsp;the&nbsp;underlying&nbsp;io.Reader.&nbsp;It</span><br>
<span class="lineno"></span><span class="comment" id="6363936">//&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;there&nbsp;are&nbsp;no&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;d.bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="6364004">func</span>&nbsp;<span class="op" id="6364009">(</span><span class="ident" id="6364010">d</span>&nbsp;<span class="op" id="6364012">*</span><span class="ident" id="6364013">decoder</span><span class="op" id="6364020">)</span>&nbsp;<span class="ident" id="6364022">fill</span><span class="op" id="6364026">(</span><span class="op" id="6364027">)</span>&nbsp;<span class="builtintype" id="6364029">error</span>&nbsp;<span class="op" id="6364035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6364038">if</span>&nbsp;<span class="ident" id="6364041">d</span><span class="op" id="6364042">.</span><span class="ident" id="6364043">bytes</span><span class="op" id="6364048">.</span><span class="ident" id="6364049">i</span>&nbsp;<span class="op" id="6364051">!=</span>&nbsp;<span class="ident" id="6364054">d</span><span class="op" id="6364055">.</span><span class="ident" id="6364056">bytes</span><span class="op" id="6364061">.</span><span class="ident" id="6364062">j</span>&nbsp;<span class="op" id="6364064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6364068">panic</span><span class="op" id="6364073">(</span><span class="string" id="6364074">&#34;jpeg:&nbsp;fill&nbsp;called&nbsp;when&nbsp;unread&nbsp;bytes&nbsp;exist&#34;</span><span class="op" id="6364117">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6364120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6364123">//&nbsp;Move&nbsp;the&nbsp;last&nbsp;2&nbsp;bytes&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer,&nbsp;in&nbsp;case&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6364193">//&nbsp;to&nbsp;call&nbsp;unreadByteStuffedByte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6364228">if</span>&nbsp;<span class="ident" id="6364231">d</span><span class="op" id="6364232">.</span><span class="ident" id="6364233">bytes</span><span class="op" id="6364238">.</span><span class="ident" id="6364239">j</span>&nbsp;<span class="op" id="6364241">&gt;</span>&nbsp;<span class="num" id="6364243">2</span>&nbsp;<span class="op" id="6364245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364249">d</span><span class="op" id="6364250">.</span><span class="ident" id="6364251">bytes</span><span class="op" id="6364256">.</span><span class="ident" id="6364257">buf</span><span class="op" id="6364260">[</span><span class="num" id="6364261">0</span><span class="op" id="6364262">]</span>&nbsp;<span class="op" id="6364264">=</span>&nbsp;<span class="ident" id="6364266">d</span><span class="op" id="6364267">.</span><span class="ident" id="6364268">bytes</span><span class="op" id="6364273">.</span><span class="ident" id="6364274">buf</span><span class="op" id="6364277">[</span><span class="ident" id="6364278">d</span><span class="op" id="6364279">.</span><span class="ident" id="6364280">bytes</span><span class="op" id="6364285">.</span><span class="ident" id="6364286">j</span><span class="op" id="6364287">-</span><span class="num" id="6364288">2</span><span class="op" id="6364289">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364293">d</span><span class="op" id="6364294">.</span><span class="ident" id="6364295">bytes</span><span class="op" id="6364300">.</span><span class="ident" id="6364301">buf</span><span class="op" id="6364304">[</span><span class="num" id="6364305">1</span><span class="op" id="6364306">]</span>&nbsp;<span class="op" id="6364308">=</span>&nbsp;<span class="ident" id="6364310">d</span><span class="op" id="6364311">.</span><span class="ident" id="6364312">bytes</span><span class="op" id="6364317">.</span><span class="ident" id="6364318">buf</span><span class="op" id="6364321">[</span><span class="ident" id="6364322">d</span><span class="op" id="6364323">.</span><span class="ident" id="6364324">bytes</span><span class="op" id="6364329">.</span><span class="ident" id="6364330">j</span><span class="op" id="6364331">-</span><span class="num" id="6364332">1</span><span class="op" id="6364333">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364337">d</span><span class="op" id="6364338">.</span><span class="ident" id="6364339">bytes</span><span class="op" id="6364344">.</span><span class="ident" id="6364345">i</span><span class="op" id="6364346">,</span>&nbsp;<span class="ident" id="6364348">d</span><span class="op" id="6364349">.</span><span class="ident" id="6364350">bytes</span><span class="op" id="6364355">.</span><span class="ident" id="6364356">j</span>&nbsp;<span class="op" id="6364358">=</span>&nbsp;<span class="num" id="6364360">2</span><span class="op" id="6364361">,</span>&nbsp;<span class="num" id="6364363">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6364366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6364369">//&nbsp;Fill&nbsp;in&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364405">n</span><span class="op" id="6364406">,</span>&nbsp;<span class="ident" id="6364408">err</span>&nbsp;<span class="op" id="6364412">:=</span>&nbsp;<span class="ident" id="6364415">d</span><span class="op" id="6364416">.</span><span class="ident" id="6364417">r</span><span class="op" id="6364418">.</span><span class="ident" id="6364419">Read</span><span class="op" id="6364423">(</span><span class="ident" id="6364424">d</span><span class="op" id="6364425">.</span><span class="ident" id="6364426">bytes</span><span class="op" id="6364431">.</span><span class="ident" id="6364432">buf</span><span class="op" id="6364435">[</span><span class="ident" id="6364436">d</span><span class="op" id="6364437">.</span><span class="ident" id="6364438">bytes</span><span class="op" id="6364443">.</span><span class="ident" id="6364444">j</span><span class="op" id="6364445">:</span><span class="op" id="6364446">]</span><span class="op" id="6364447">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364450">d</span><span class="op" id="6364451">.</span><span class="ident" id="6364452">bytes</span><span class="op" id="6364457">.</span><span class="ident" id="6364458">j</span>&nbsp;<span class="op" id="6364460">+=</span>&nbsp;<span class="ident" id="6364463">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6364466">if</span>&nbsp;<span class="ident" id="6364469">n</span>&nbsp;<span class="op" id="6364471">&gt;</span>&nbsp;<span class="num" id="6364473">0</span>&nbsp;<span class="op" id="6364475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364479">err</span>&nbsp;<span class="op" id="6364483">=</span>&nbsp;<span class="ident" id="6364485">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6364490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6364493">return</span>&nbsp;<span class="ident" id="6364500">err</span><br>
<span class="lineno">150</span><span class="op" id="6364504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6364507">//&nbsp;unreadByteStuffedByte&nbsp;undoes&nbsp;the&nbsp;most&nbsp;recent&nbsp;readByteStuffedByte&nbsp;call,</span><br>
<span class="lineno"></span><span class="comment" id="6364581">//&nbsp;giving&nbsp;a&nbsp;byte&nbsp;of&nbsp;data&nbsp;back&nbsp;from&nbsp;d.bits&nbsp;to&nbsp;d.bytes.&nbsp;The&nbsp;Huffman&nbsp;look-up&nbsp;table</span><br>
<span class="lineno"></span><span class="comment" id="6364661">//&nbsp;requires&nbsp;at&nbsp;least&nbsp;8&nbsp;bits&nbsp;for&nbsp;look-up,&nbsp;which&nbsp;means&nbsp;that&nbsp;Huffman&nbsp;decoding&nbsp;can</span><br>
<span class="lineno">155</span><span class="comment" id="6364740">//&nbsp;sometimes&nbsp;overshoot&nbsp;and&nbsp;read&nbsp;one&nbsp;or&nbsp;two&nbsp;too&nbsp;many&nbsp;bytes.&nbsp;Two-byte&nbsp;overshoot</span><br>
<span class="lineno"></span><span class="comment" id="6364818">//&nbsp;can&nbsp;happen&nbsp;when&nbsp;expecting&nbsp;to&nbsp;read&nbsp;a&nbsp;0xff&nbsp;0x00&nbsp;byte-stuffed&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="6364886">func</span>&nbsp;<span class="op" id="6364891">(</span><span class="ident" id="6364892">d</span>&nbsp;<span class="op" id="6364894">*</span><span class="ident" id="6364895">decoder</span><span class="op" id="6364902">)</span>&nbsp;<span class="ident" id="6364904">unreadByteStuffedByte</span><span class="op" id="6364925">(</span><span class="op" id="6364926">)</span>&nbsp;<span class="op" id="6364928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6364931">if</span>&nbsp;<span class="ident" id="6364934">d</span><span class="op" id="6364935">.</span><span class="ident" id="6364936">bytes</span><span class="op" id="6364941">.</span><span class="ident" id="6364942">nUnreadable</span>&nbsp;<span class="op" id="6364954">==</span>&nbsp;<span class="num" id="6364957">0</span>&nbsp;<span class="op" id="6364959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6364963">panic</span><span class="op" id="6364968">(</span><span class="string" id="6364969">&#34;jpeg:&nbsp;unreadByteStuffedByte&nbsp;call&nbsp;cannot&nbsp;be&nbsp;fulfilled&#34;</span><span class="op" id="6365023">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6365026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6365029">d</span><span class="op" id="6365030">.</span><span class="ident" id="6365031">bytes</span><span class="op" id="6365036">.</span><span class="ident" id="6365037">i</span>&nbsp;<span class="op" id="6365039">-=</span>&nbsp;<span class="ident" id="6365042">d</span><span class="op" id="6365043">.</span><span class="ident" id="6365044">bytes</span><span class="op" id="6365049">.</span><span class="ident" id="6365050">nUnreadable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6365063">d</span><span class="op" id="6365064">.</span><span class="ident" id="6365065">bytes</span><span class="op" id="6365070">.</span><span class="ident" id="6365071">nUnreadable</span>&nbsp;<span class="op" id="6365083">=</span>&nbsp;<span class="num" id="6365085">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6365088">if</span>&nbsp;<span class="ident" id="6365091">d</span><span class="op" id="6365092">.</span><span class="ident" id="6365093">bits</span><span class="op" id="6365097">.</span><span class="ident" id="6365098">n</span>&nbsp;<span class="op" id="6365100">&gt;=</span>&nbsp;<span class="num" id="6365103">8</span>&nbsp;<span class="op" id="6365105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6365109">d</span><span class="op" id="6365110">.</span><span class="ident" id="6365111">bits</span><span class="op" id="6365115">.</span><span class="ident" id="6365116">a</span>&nbsp;<span class="op" id="6365118">&gt;&gt;=</span>&nbsp;<span class="num" id="6365122">8</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6365126">d</span><span class="op" id="6365127">.</span><span class="ident" id="6365128">bits</span><span class="op" id="6365132">.</span><span class="ident" id="6365133">n</span>&nbsp;<span class="op" id="6365135">-=</span>&nbsp;<span class="num" id="6365138">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6365142">d</span><span class="op" id="6365143">.</span><span class="ident" id="6365144">bits</span><span class="op" id="6365148">.</span><span class="ident" id="6365149">m</span>&nbsp;<span class="op" id="6365151">&gt;&gt;=</span>&nbsp;<span class="num" id="6365155">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6365158">}</span><br>
<span class="lineno"></span><span class="op" id="6365160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="6365163">//&nbsp;readByte&nbsp;returns&nbsp;the&nbsp;next&nbsp;byte,&nbsp;whether&nbsp;buffered&nbsp;or&nbsp;not&nbsp;buffered.&nbsp;It&nbsp;does</span><br>
<span class="lineno"></span><span class="comment" id="6365240">//&nbsp;not&nbsp;care&nbsp;about&nbsp;byte&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="6365273">func</span>&nbsp;<span class="op" id="6365278">(</span><span class="ident" id="6365279">d</span>&nbsp;<span class="op" id="6365281">*</span><span class="ident" id="6365282">decoder</span><span class="op" id="6365289">)</span>&nbsp;<span class="ident" id="6365291">readByte</span><span class="op" id="6365299">(</span><span class="op" id="6365300">)</span>&nbsp;<span class="op" id="6365302">(</span><span class="ident" id="6365303">x</span>&nbsp;<span class="builtintype" id="6365305">byte</span><span class="op" id="6365309">,</span>&nbsp;<span class="ident" id="6365311">err</span>&nbsp;<span class="builtintype" id="6365315">error</span><span class="op" id="6365320">)</span>&nbsp;<span class="op" id="6365322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6365325">for</span>&nbsp;<span class="ident" id="6365329">d</span><span class="op" id="6365330">.</span><span class="ident" id="6365331">bytes</span><span class="op" id="6365336">.</span><span class="ident" id="6365337">i</span>&nbsp;<span class="op" id="6365339">==</span>&nbsp;<span class="ident" id="6365342">d</span><span class="op" id="6365343">.</span><span class="ident" id="6365344">bytes</span><span class="op" id="6365349">.</span><span class="ident" id="6365350">j</span>&nbsp;<span class="op" id="6365352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6365356">if</span>&nbsp;<span class="ident" id="6365359">err</span>&nbsp;<span class="op" id="6365363">=</span>&nbsp;<span class="ident" id="6365365">d</span><span class="op" id="6365366">.</span><span class="ident" id="6365367">fill</span><span class="op" id="6365371">(</span><span class="op" id="6365372">)</span><span class="op" id="6365373">;</span>&nbsp;<span class="ident" id="6365375">err</span>&nbsp;<span class="op" id="6365379">!=</span>&nbsp;<span class="ident" id="6365382">nil</span>&nbsp;<span class="op" id="6365386">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6365391">return</span>&nbsp;<span class="num" id="6365398">0</span><span class="op" id="6365399">,</span>&nbsp;<span class="ident" id="6365401">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6365407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6365410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6365413">x</span>&nbsp;<span class="op" id="6365415">=</span>&nbsp;<span class="ident" id="6365417">d</span><span class="op" id="6365418">.</span><span class="ident" id="6365419">bytes</span><span class="op" id="6365424">.</span><span class="ident" id="6365425">buf</span><span class="op" id="6365428">[</span><span class="ident" id="6365429">d</span><span class="op" id="6365430">.</span><span class="ident" id="6365431">bytes</span><span class="op" id="6365436">.</span><span class="ident" id="6365437">i</span><span class="op" id="6365438">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6365441">d</span><span class="op" id="6365442">.</span><span class="ident" id="6365443">bytes</span><span class="op" id="6365448">.</span><span class="ident" id="6365449">i</span><span class="op" id="6365450">++</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6365454">d</span><span class="op" id="6365455">.</span><span class="ident" id="6365456">bytes</span><span class="op" id="6365461">.</span><span class="ident" id="6365462">nUnreadable</span>&nbsp;<span class="op" id="6365474">=</span>&nbsp;<span class="num" id="6365476">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6365479">return</span>&nbsp;<span class="ident" id="6365486">x</span><span class="op" id="6365487">,</span>&nbsp;<span class="ident" id="6365489">nil</span><br>
<span class="lineno"></span><span class="op" id="6365493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6365496">//&nbsp;errMissingFF00&nbsp;means&nbsp;that&nbsp;readByteStuffedByte&nbsp;encountered&nbsp;an&nbsp;0xff&nbsp;byte&nbsp;(a</span><br>
<span class="lineno">185</span><span class="comment" id="6365573">//&nbsp;marker&nbsp;byte)&nbsp;that&nbsp;wasn&#39;t&nbsp;the&nbsp;expected&nbsp;byte-stuffed&nbsp;sequence&nbsp;0xff,&nbsp;0x00.</span><br>
<span class="lineno"></span><span class="keyword" id="6365648">var</span>&nbsp;<span class="ident" id="6365652">errMissingFF00</span>&nbsp;<span class="op" id="6365667">=</span>&nbsp;<span class="ident" id="6365669">FormatError</span><span class="op" id="6365680">(</span><span class="string" id="6365681">&#34;missing&nbsp;0xff00&nbsp;sequence&#34;</span><span class="op" id="6365706">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6365709">//&nbsp;readByteStuffedByte&nbsp;is&nbsp;like&nbsp;readByte&nbsp;but&nbsp;is&nbsp;for&nbsp;byte-stuffed&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6365787">func</span>&nbsp;<span class="op" id="6365792">(</span><span class="ident" id="6365793">d</span>&nbsp;<span class="op" id="6365795">*</span><span class="ident" id="6365796">decoder</span><span class="op" id="6365803">)</span>&nbsp;<span class="ident" id="6365805">readByteStuffedByte</span><span class="op" id="6365824">(</span><span class="op" id="6365825">)</span>&nbsp;<span class="op" id="6365827">(</span><span class="ident" id="6365828">x</span>&nbsp;<span class="builtintype" id="6365830">byte</span><span class="op" id="6365834">,</span>&nbsp;<span class="ident" id="6365836">err</span>&nbsp;<span class="builtintype" id="6365840">error</span><span class="op" id="6365845">)</span>&nbsp;<span class="op" id="6365847">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6365850">//&nbsp;Take&nbsp;the&nbsp;fast&nbsp;path&nbsp;if&nbsp;d.bytes.buf&nbsp;contains&nbsp;at&nbsp;least&nbsp;two&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6365917">if</span>&nbsp;<span class="ident" id="6365920">d</span><span class="op" id="6365921">.</span><span class="ident" id="6365922">bytes</span><span class="op" id="6365927">.</span><span class="ident" id="6365928">i</span><span class="op" id="6365929">+</span><span class="num" id="6365930">2</span>&nbsp;<span class="op" id="6365932">&lt;=</span>&nbsp;<span class="ident" id="6365935">d</span><span class="op" id="6365936">.</span><span class="ident" id="6365937">bytes</span><span class="op" id="6365942">.</span><span class="ident" id="6365943">j</span>&nbsp;<span class="op" id="6365945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6365949">x</span>&nbsp;<span class="op" id="6365951">=</span>&nbsp;<span class="ident" id="6365953">d</span><span class="op" id="6365954">.</span><span class="ident" id="6365955">bytes</span><span class="op" id="6365960">.</span><span class="ident" id="6365961">buf</span><span class="op" id="6365964">[</span><span class="ident" id="6365965">d</span><span class="op" id="6365966">.</span><span class="ident" id="6365967">bytes</span><span class="op" id="6365972">.</span><span class="ident" id="6365973">i</span><span class="op" id="6365974">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6365978">d</span><span class="op" id="6365979">.</span><span class="ident" id="6365980">bytes</span><span class="op" id="6365985">.</span><span class="ident" id="6365986">i</span><span class="op" id="6365987">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6365992">d</span><span class="op" id="6365993">.</span><span class="ident" id="6365994">bytes</span><span class="op" id="6365999">.</span><span class="ident" id="6366000">nUnreadable</span>&nbsp;<span class="op" id="6366012">=</span>&nbsp;<span class="num" id="6366014">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366018">if</span>&nbsp;<span class="ident" id="6366021">x</span>&nbsp;<span class="op" id="6366023">!=</span>&nbsp;<span class="num" id="6366026">0xff</span>&nbsp;<span class="op" id="6366031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366036">return</span>&nbsp;<span class="ident" id="6366043">x</span><span class="op" id="6366044">,</span>&nbsp;<span class="ident" id="6366046">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6366052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366056">if</span>&nbsp;<span class="ident" id="6366059">d</span><span class="op" id="6366060">.</span><span class="ident" id="6366061">bytes</span><span class="op" id="6366066">.</span><span class="ident" id="6366067">buf</span><span class="op" id="6366070">[</span><span class="ident" id="6366071">d</span><span class="op" id="6366072">.</span><span class="ident" id="6366073">bytes</span><span class="op" id="6366078">.</span><span class="ident" id="6366079">i</span><span class="op" id="6366080">]</span>&nbsp;<span class="op" id="6366082">!=</span>&nbsp;<span class="num" id="6366085">0x00</span>&nbsp;<span class="op" id="6366090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366095">return</span>&nbsp;<span class="num" id="6366102">0</span><span class="op" id="6366103">,</span>&nbsp;<span class="ident" id="6366105">errMissingFF00</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6366122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6366126">d</span><span class="op" id="6366127">.</span><span class="ident" id="6366128">bytes</span><span class="op" id="6366133">.</span><span class="ident" id="6366134">i</span><span class="op" id="6366135">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6366140">d</span><span class="op" id="6366141">.</span><span class="ident" id="6366142">bytes</span><span class="op" id="6366147">.</span><span class="ident" id="6366148">nUnreadable</span>&nbsp;<span class="op" id="6366160">=</span>&nbsp;<span class="num" id="6366162">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366166">return</span>&nbsp;<span class="num" id="6366173">0xff</span><span class="op" id="6366177">,</span>&nbsp;<span class="ident" id="6366179">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6366184">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6366188">x</span><span class="op" id="6366189">,</span>&nbsp;<span class="ident" id="6366191">err</span>&nbsp;<span class="op" id="6366195">=</span>&nbsp;<span class="ident" id="6366197">d</span><span class="op" id="6366198">.</span><span class="ident" id="6366199">readByte</span><span class="op" id="6366207">(</span><span class="op" id="6366208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366211">if</span>&nbsp;<span class="ident" id="6366214">err</span>&nbsp;<span class="op" id="6366218">!=</span>&nbsp;<span class="ident" id="6366221">nil</span>&nbsp;<span class="op" id="6366225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366229">return</span>&nbsp;<span class="num" id="6366236">0</span><span class="op" id="6366237">,</span>&nbsp;<span class="ident" id="6366239">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6366244">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366247">if</span>&nbsp;<span class="ident" id="6366250">x</span>&nbsp;<span class="op" id="6366252">!=</span>&nbsp;<span class="num" id="6366255">0xff</span>&nbsp;<span class="op" id="6366260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6366264">d</span><span class="op" id="6366265">.</span><span class="ident" id="6366266">bytes</span><span class="op" id="6366271">.</span><span class="ident" id="6366272">nUnreadable</span>&nbsp;<span class="op" id="6366284">=</span>&nbsp;<span class="num" id="6366286">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366290">return</span>&nbsp;<span class="ident" id="6366297">x</span><span class="op" id="6366298">,</span>&nbsp;<span class="ident" id="6366300">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6366305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6366309">x</span><span class="op" id="6366310">,</span>&nbsp;<span class="ident" id="6366312">err</span>&nbsp;<span class="op" id="6366316">=</span>&nbsp;<span class="ident" id="6366318">d</span><span class="op" id="6366319">.</span><span class="ident" id="6366320">readByte</span><span class="op" id="6366328">(</span><span class="op" id="6366329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366332">if</span>&nbsp;<span class="ident" id="6366335">err</span>&nbsp;<span class="op" id="6366339">!=</span>&nbsp;<span class="ident" id="6366342">nil</span>&nbsp;<span class="op" id="6366346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6366350">d</span><span class="op" id="6366351">.</span><span class="ident" id="6366352">bytes</span><span class="op" id="6366357">.</span><span class="ident" id="6366358">nUnreadable</span>&nbsp;<span class="op" id="6366370">=</span>&nbsp;<span class="num" id="6366372">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366376">return</span>&nbsp;<span class="num" id="6366383">0</span><span class="op" id="6366384">,</span>&nbsp;<span class="ident" id="6366386">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6366391">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6366394">d</span><span class="op" id="6366395">.</span><span class="ident" id="6366396">bytes</span><span class="op" id="6366401">.</span><span class="ident" id="6366402">nUnreadable</span>&nbsp;<span class="op" id="6366414">=</span>&nbsp;<span class="num" id="6366416">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366419">if</span>&nbsp;<span class="ident" id="6366422">x</span>&nbsp;<span class="op" id="6366424">!=</span>&nbsp;<span class="num" id="6366427">0x00</span>&nbsp;<span class="op" id="6366432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366436">return</span>&nbsp;<span class="num" id="6366443">0</span><span class="op" id="6366444">,</span>&nbsp;<span class="ident" id="6366446">errMissingFF00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6366462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366465">return</span>&nbsp;<span class="num" id="6366472">0xff</span><span class="op" id="6366476">,</span>&nbsp;<span class="ident" id="6366478">nil</span><br>
<span class="lineno">225</span><span class="op" id="6366482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6366485">//&nbsp;readFull&nbsp;reads&nbsp;exactly&nbsp;len(p)&nbsp;bytes&nbsp;into&nbsp;p.&nbsp;It&nbsp;does&nbsp;not&nbsp;care&nbsp;about&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="6366560">//&nbsp;stuffing.</span><br>
<span class="lineno"></span><span class="keyword" id="6366573">func</span>&nbsp;<span class="op" id="6366578">(</span><span class="ident" id="6366579">d</span>&nbsp;<span class="op" id="6366581">*</span><span class="ident" id="6366582">decoder</span><span class="op" id="6366589">)</span>&nbsp;<span class="ident" id="6366591">readFull</span><span class="op" id="6366599">(</span><span class="ident" id="6366600">p</span>&nbsp;<span class="op" id="6366602">[</span><span class="op" id="6366603">]</span><span class="builtintype" id="6366604">byte</span><span class="op" id="6366608">)</span>&nbsp;<span class="builtintype" id="6366610">error</span>&nbsp;<span class="op" id="6366616">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6366619">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366658">if</span>&nbsp;<span class="ident" id="6366661">d</span><span class="op" id="6366662">.</span><span class="ident" id="6366663">bytes</span><span class="op" id="6366668">.</span><span class="ident" id="6366669">nUnreadable</span>&nbsp;<span class="op" id="6366681">!=</span>&nbsp;<span class="num" id="6366684">0</span>&nbsp;<span class="op" id="6366686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366690">if</span>&nbsp;<span class="ident" id="6366693">d</span><span class="op" id="6366694">.</span><span class="ident" id="6366695">bits</span><span class="op" id="6366699">.</span><span class="ident" id="6366700">n</span>&nbsp;<span class="op" id="6366702">&gt;=</span>&nbsp;<span class="num" id="6366705">8</span>&nbsp;<span class="op" id="6366707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6366712">d</span><span class="op" id="6366713">.</span><span class="ident" id="6366714">unreadByteStuffedByte</span><span class="op" id="6366735">(</span><span class="op" id="6366736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6366740">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6366744">d</span><span class="op" id="6366745">.</span><span class="ident" id="6366746">bytes</span><span class="op" id="6366751">.</span><span class="ident" id="6366752">nUnreadable</span>&nbsp;<span class="op" id="6366764">=</span>&nbsp;<span class="num" id="6366766">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6366769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366773">for</span>&nbsp;<span class="op" id="6366777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6366781">n</span>&nbsp;<span class="op" id="6366783">:=</span>&nbsp;<span class="builtinfunc" id="6366786">copy</span><span class="op" id="6366790">(</span><span class="ident" id="6366791">p</span><span class="op" id="6366792">,</span>&nbsp;<span class="ident" id="6366794">d</span><span class="op" id="6366795">.</span><span class="ident" id="6366796">bytes</span><span class="op" id="6366801">.</span><span class="ident" id="6366802">buf</span><span class="op" id="6366805">[</span><span class="ident" id="6366806">d</span><span class="op" id="6366807">.</span><span class="ident" id="6366808">bytes</span><span class="op" id="6366813">.</span><span class="ident" id="6366814">i</span><span class="op" id="6366815">:</span><span class="ident" id="6366816">d</span><span class="op" id="6366817">.</span><span class="ident" id="6366818">bytes</span><span class="op" id="6366823">.</span><span class="ident" id="6366824">j</span><span class="op" id="6366825">]</span><span class="op" id="6366826">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6366830">p</span>&nbsp;<span class="op" id="6366832">=</span>&nbsp;<span class="ident" id="6366834">p</span><span class="op" id="6366835">[</span><span class="ident" id="6366836">n</span><span class="op" id="6366837">:</span><span class="op" id="6366838">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6366842">d</span><span class="op" id="6366843">.</span><span class="ident" id="6366844">bytes</span><span class="op" id="6366849">.</span><span class="ident" id="6366850">i</span>&nbsp;<span class="op" id="6366852">+=</span>&nbsp;<span class="ident" id="6366855">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366859">if</span>&nbsp;<span class="builtinfunc" id="6366862">len</span><span class="op" id="6366865">(</span><span class="ident" id="6366866">p</span><span class="op" id="6366867">)</span>&nbsp;<span class="op" id="6366869">==</span>&nbsp;<span class="num" id="6366872">0</span>&nbsp;<span class="op" id="6366874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366879">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6366887">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366891">if</span>&nbsp;<span class="ident" id="6366894">err</span>&nbsp;<span class="op" id="6366898">:=</span>&nbsp;<span class="ident" id="6366901">d</span><span class="op" id="6366902">.</span><span class="ident" id="6366903">fill</span><span class="op" id="6366907">(</span><span class="op" id="6366908">)</span><span class="op" id="6366909">;</span>&nbsp;<span class="ident" id="6366911">err</span>&nbsp;<span class="op" id="6366915">!=</span>&nbsp;<span class="ident" id="6366918">nil</span>&nbsp;<span class="op" id="6366922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366927">if</span>&nbsp;<span class="ident" id="6366930">err</span>&nbsp;<span class="op" id="6366934">==</span>&nbsp;<span class="ident" id="6366937">io</span><span class="op" id="6366939">.</span><span class="ident" id="6366940">EOF</span>&nbsp;<span class="op" id="6366944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6366950">err</span>&nbsp;<span class="op" id="6366954">=</span>&nbsp;<span class="ident" id="6366956">io</span><span class="op" id="6366958">.</span><span class="ident" id="6366959">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6366979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6366984">return</span>&nbsp;<span class="ident" id="6366991">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6366997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6367000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367003">return</span>&nbsp;<span class="ident" id="6367010">nil</span><br>
<span class="lineno"></span><span class="op" id="6367014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="6367017">//&nbsp;ignore&nbsp;ignores&nbsp;the&nbsp;next&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="6367053">func</span>&nbsp;<span class="op" id="6367058">(</span><span class="ident" id="6367059">d</span>&nbsp;<span class="op" id="6367061">*</span><span class="ident" id="6367062">decoder</span><span class="op" id="6367069">)</span>&nbsp;<span class="ident" id="6367071">ignore</span><span class="op" id="6367077">(</span><span class="ident" id="6367078">n</span>&nbsp;<span class="builtintype" id="6367080">int</span><span class="op" id="6367083">)</span>&nbsp;<span class="builtintype" id="6367085">error</span>&nbsp;<span class="op" id="6367091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6367094">//&nbsp;Unread&nbsp;the&nbsp;overshot&nbsp;bytes,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367133">if</span>&nbsp;<span class="ident" id="6367136">d</span><span class="op" id="6367137">.</span><span class="ident" id="6367138">bytes</span><span class="op" id="6367143">.</span><span class="ident" id="6367144">nUnreadable</span>&nbsp;<span class="op" id="6367156">!=</span>&nbsp;<span class="num" id="6367159">0</span>&nbsp;<span class="op" id="6367161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367165">if</span>&nbsp;<span class="ident" id="6367168">d</span><span class="op" id="6367169">.</span><span class="ident" id="6367170">bits</span><span class="op" id="6367174">.</span><span class="ident" id="6367175">n</span>&nbsp;<span class="op" id="6367177">&gt;=</span>&nbsp;<span class="num" id="6367180">8</span>&nbsp;<span class="op" id="6367182">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6367187">d</span><span class="op" id="6367188">.</span><span class="ident" id="6367189">unreadByteStuffedByte</span><span class="op" id="6367210">(</span><span class="op" id="6367211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6367215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6367219">d</span><span class="op" id="6367220">.</span><span class="ident" id="6367221">bytes</span><span class="op" id="6367226">.</span><span class="ident" id="6367227">nUnreadable</span>&nbsp;<span class="op" id="6367239">=</span>&nbsp;<span class="num" id="6367241">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6367244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367248">for</span>&nbsp;<span class="op" id="6367252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6367256">m</span>&nbsp;<span class="op" id="6367258">:=</span>&nbsp;<span class="ident" id="6367261">d</span><span class="op" id="6367262">.</span><span class="ident" id="6367263">bytes</span><span class="op" id="6367268">.</span><span class="ident" id="6367269">j</span>&nbsp;<span class="op" id="6367271">-</span>&nbsp;<span class="ident" id="6367273">d</span><span class="op" id="6367274">.</span><span class="ident" id="6367275">bytes</span><span class="op" id="6367280">.</span><span class="ident" id="6367281">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367285">if</span>&nbsp;<span class="ident" id="6367288">m</span>&nbsp;<span class="op" id="6367290">&gt;</span>&nbsp;<span class="ident" id="6367292">n</span>&nbsp;<span class="op" id="6367294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6367299">m</span>&nbsp;<span class="op" id="6367301">=</span>&nbsp;<span class="ident" id="6367303">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6367307">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6367311">d</span><span class="op" id="6367312">.</span><span class="ident" id="6367313">bytes</span><span class="op" id="6367318">.</span><span class="ident" id="6367319">i</span>&nbsp;<span class="op" id="6367321">+=</span>&nbsp;<span class="ident" id="6367324">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6367328">n</span>&nbsp;<span class="op" id="6367330">-=</span>&nbsp;<span class="ident" id="6367333">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367337">if</span>&nbsp;<span class="ident" id="6367340">n</span>&nbsp;<span class="op" id="6367342">==</span>&nbsp;<span class="num" id="6367345">0</span>&nbsp;<span class="op" id="6367347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367352">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6367360">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367364">if</span>&nbsp;<span class="ident" id="6367367">err</span>&nbsp;<span class="op" id="6367371">:=</span>&nbsp;<span class="ident" id="6367374">d</span><span class="op" id="6367375">.</span><span class="ident" id="6367376">fill</span><span class="op" id="6367380">(</span><span class="op" id="6367381">)</span><span class="op" id="6367382">;</span>&nbsp;<span class="ident" id="6367384">err</span>&nbsp;<span class="op" id="6367388">!=</span>&nbsp;<span class="ident" id="6367391">nil</span>&nbsp;<span class="op" id="6367395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367400">if</span>&nbsp;<span class="ident" id="6367403">err</span>&nbsp;<span class="op" id="6367407">==</span>&nbsp;<span class="ident" id="6367410">io</span><span class="op" id="6367412">.</span><span class="ident" id="6367413">EOF</span>&nbsp;<span class="op" id="6367417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6367423">err</span>&nbsp;<span class="op" id="6367427">=</span>&nbsp;<span class="ident" id="6367429">io</span><span class="op" id="6367431">.</span><span class="ident" id="6367432">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6367452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367457">return</span>&nbsp;<span class="ident" id="6367464">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6367470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6367473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367476">return</span>&nbsp;<span class="ident" id="6367483">nil</span><br>
<span class="lineno"></span><span class="op" id="6367487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="6367490">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.2.</span><br>
<span class="lineno"></span><span class="keyword" id="6367521">func</span>&nbsp;<span class="op" id="6367526">(</span><span class="ident" id="6367527">d</span>&nbsp;<span class="op" id="6367529">*</span><span class="ident" id="6367530">decoder</span><span class="op" id="6367537">)</span>&nbsp;<span class="ident" id="6367539">processSOF</span><span class="op" id="6367549">(</span><span class="ident" id="6367550">n</span>&nbsp;<span class="builtintype" id="6367552">int</span><span class="op" id="6367555">)</span>&nbsp;<span class="builtintype" id="6367557">error</span>&nbsp;<span class="op" id="6367563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367566">switch</span>&nbsp;<span class="ident" id="6367573">n</span>&nbsp;<span class="op" id="6367575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367578">case</span>&nbsp;<span class="num" id="6367583">6</span>&nbsp;<span class="op" id="6367585">+</span>&nbsp;<span class="num" id="6367587">3</span><span class="op" id="6367588">*</span><span class="ident" id="6367589">nGrayComponent</span><span class="op" id="6367603">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6367607">d</span><span class="op" id="6367608">.</span><span class="ident" id="6367609">nComp</span>&nbsp;<span class="op" id="6367615">=</span>&nbsp;<span class="ident" id="6367617">nGrayComponent</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367633">case</span>&nbsp;<span class="num" id="6367638">6</span>&nbsp;<span class="op" id="6367640">+</span>&nbsp;<span class="num" id="6367642">3</span><span class="op" id="6367643">*</span><span class="ident" id="6367644">nColorComponent</span><span class="op" id="6367659">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6367663">d</span><span class="op" id="6367664">.</span><span class="ident" id="6367665">nComp</span>&nbsp;<span class="op" id="6367671">=</span>&nbsp;<span class="ident" id="6367673">nColorComponent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367690">default</span><span class="op" id="6367697">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367701">return</span>&nbsp;<span class="ident" id="6367708">UnsupportedError</span><span class="op" id="6367724">(</span><span class="string" id="6367725">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6367747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6367750">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367753">if</span>&nbsp;<span class="ident" id="6367756">err</span>&nbsp;<span class="op" id="6367760">:=</span>&nbsp;<span class="ident" id="6367763">d</span><span class="op" id="6367764">.</span><span class="ident" id="6367765">readFull</span><span class="op" id="6367773">(</span><span class="ident" id="6367774">d</span><span class="op" id="6367775">.</span><span class="ident" id="6367776">tmp</span><span class="op" id="6367779">[</span><span class="op" id="6367780">:</span><span class="ident" id="6367781">n</span><span class="op" id="6367782">]</span><span class="op" id="6367783">)</span><span class="op" id="6367784">;</span>&nbsp;<span class="ident" id="6367786">err</span>&nbsp;<span class="op" id="6367790">!=</span>&nbsp;<span class="ident" id="6367793">nil</span>&nbsp;<span class="op" id="6367797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367801">return</span>&nbsp;<span class="ident" id="6367808">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6367813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6367816">//&nbsp;We&nbsp;only&nbsp;support&nbsp;8-bit&nbsp;precision.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367853">if</span>&nbsp;<span class="ident" id="6367856">d</span><span class="op" id="6367857">.</span><span class="ident" id="6367858">tmp</span><span class="op" id="6367861">[</span><span class="num" id="6367862">0</span><span class="op" id="6367863">]</span>&nbsp;<span class="op" id="6367865">!=</span>&nbsp;<span class="num" id="6367868">8</span>&nbsp;<span class="op" id="6367870">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6367874">return</span>&nbsp;<span class="ident" id="6367881">UnsupportedError</span><span class="op" id="6367897">(</span><span class="string" id="6367898">&#34;precision&#34;</span><span class="op" id="6367909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6367912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6367915">d</span><span class="op" id="6367916">.</span><span class="ident" id="6367917">height</span>&nbsp;<span class="op" id="6367924">=</span>&nbsp;<span class="builtintype" id="6367926">int</span><span class="op" id="6367929">(</span><span class="ident" id="6367930">d</span><span class="op" id="6367931">.</span><span class="ident" id="6367932">tmp</span><span class="op" id="6367935">[</span><span class="num" id="6367936">1</span><span class="op" id="6367937">]</span><span class="op" id="6367938">)</span><span class="op" id="6367939">&lt;&lt;</span><span class="num" id="6367941">8</span>&nbsp;<span class="op" id="6367943">+</span>&nbsp;<span class="builtintype" id="6367945">int</span><span class="op" id="6367948">(</span><span class="ident" id="6367949">d</span><span class="op" id="6367950">.</span><span class="ident" id="6367951">tmp</span><span class="op" id="6367954">[</span><span class="num" id="6367955">2</span><span class="op" id="6367956">]</span><span class="op" id="6367957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6367960">d</span><span class="op" id="6367961">.</span><span class="ident" id="6367962">width</span>&nbsp;<span class="op" id="6367968">=</span>&nbsp;<span class="builtintype" id="6367970">int</span><span class="op" id="6367973">(</span><span class="ident" id="6367974">d</span><span class="op" id="6367975">.</span><span class="ident" id="6367976">tmp</span><span class="op" id="6367979">[</span><span class="num" id="6367980">3</span><span class="op" id="6367981">]</span><span class="op" id="6367982">)</span><span class="op" id="6367983">&lt;&lt;</span><span class="num" id="6367985">8</span>&nbsp;<span class="op" id="6367987">+</span>&nbsp;<span class="builtintype" id="6367989">int</span><span class="op" id="6367992">(</span><span class="ident" id="6367993">d</span><span class="op" id="6367994">.</span><span class="ident" id="6367995">tmp</span><span class="op" id="6367998">[</span><span class="num" id="6367999">4</span><span class="op" id="6368000">]</span><span class="op" id="6368001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6368004">if</span>&nbsp;<span class="builtintype" id="6368007">int</span><span class="op" id="6368010">(</span><span class="ident" id="6368011">d</span><span class="op" id="6368012">.</span><span class="ident" id="6368013">tmp</span><span class="op" id="6368016">[</span><span class="num" id="6368017">5</span><span class="op" id="6368018">]</span><span class="op" id="6368019">)</span>&nbsp;<span class="op" id="6368021">!=</span>&nbsp;<span class="ident" id="6368024">d</span><span class="op" id="6368025">.</span><span class="ident" id="6368026">nComp</span>&nbsp;<span class="op" id="6368032">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6368036">return</span>&nbsp;<span class="ident" id="6368043">UnsupportedError</span><span class="op" id="6368059">(</span><span class="string" id="6368060">&#34;SOF&nbsp;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;image&nbsp;components&#34;</span><span class="op" id="6368102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6368105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6368108">for</span>&nbsp;<span class="ident" id="6368112">i</span>&nbsp;<span class="op" id="6368114">:=</span>&nbsp;<span class="num" id="6368117">0</span><span class="op" id="6368118">;</span>&nbsp;<span class="ident" id="6368120">i</span>&nbsp;<span class="op" id="6368122">&lt;</span>&nbsp;<span class="ident" id="6368124">d</span><span class="op" id="6368125">.</span><span class="ident" id="6368126">nComp</span><span class="op" id="6368131">;</span>&nbsp;<span class="ident" id="6368133">i</span><span class="op" id="6368134">++</span>&nbsp;<span class="op" id="6368137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6368141">d</span><span class="op" id="6368142">.</span><span class="ident" id="6368143">comp</span><span class="op" id="6368147">[</span><span class="ident" id="6368148">i</span><span class="op" id="6368149">]</span><span class="op" id="6368150">.</span><span class="ident" id="6368151">c</span>&nbsp;<span class="op" id="6368153">=</span>&nbsp;<span class="ident" id="6368155">d</span><span class="op" id="6368156">.</span><span class="ident" id="6368157">tmp</span><span class="op" id="6368160">[</span><span class="num" id="6368161">6</span><span class="op" id="6368162">+</span><span class="num" id="6368163">3</span><span class="op" id="6368164">*</span><span class="ident" id="6368165">i</span><span class="op" id="6368166">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6368170">d</span><span class="op" id="6368171">.</span><span class="ident" id="6368172">comp</span><span class="op" id="6368176">[</span><span class="ident" id="6368177">i</span><span class="op" id="6368178">]</span><span class="op" id="6368179">.</span><span class="ident" id="6368180">tq</span>&nbsp;<span class="op" id="6368183">=</span>&nbsp;<span class="ident" id="6368185">d</span><span class="op" id="6368186">.</span><span class="ident" id="6368187">tmp</span><span class="op" id="6368190">[</span><span class="num" id="6368191">8</span><span class="op" id="6368192">+</span><span class="num" id="6368193">3</span><span class="op" id="6368194">*</span><span class="ident" id="6368195">i</span><span class="op" id="6368196">]</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6368200">if</span>&nbsp;<span class="ident" id="6368203">d</span><span class="op" id="6368204">.</span><span class="ident" id="6368205">nComp</span>&nbsp;<span class="op" id="6368211">==</span>&nbsp;<span class="ident" id="6368214">nGrayComponent</span>&nbsp;<span class="op" id="6368229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6368234">//&nbsp;If&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;has&nbsp;only&nbsp;one&nbsp;component,&nbsp;section&nbsp;A.2&nbsp;says&nbsp;&#34;this&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6368308">//&nbsp;is&nbsp;non-interleaved&nbsp;by&nbsp;definition&#34;&nbsp;and&nbsp;section&nbsp;A.2.2&nbsp;says&nbsp;&#34;[in&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6368381">//&nbsp;case...]&nbsp;the&nbsp;order&nbsp;of&nbsp;data&nbsp;units&nbsp;within&nbsp;a&nbsp;scan&nbsp;shall&nbsp;be&nbsp;left-to-right</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6368457">//&nbsp;and&nbsp;top-to-bottom...&nbsp;regardless&nbsp;of&nbsp;the&nbsp;values&nbsp;of&nbsp;H_1&nbsp;and&nbsp;V_1&#34;.&nbsp;Section</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6368534">//&nbsp;4.8.2&nbsp;also&nbsp;says&nbsp;&#34;[for&nbsp;non-interleaved&nbsp;data],&nbsp;the&nbsp;MCU&nbsp;is&nbsp;defined&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6368610">//&nbsp;one&nbsp;data&nbsp;unit&#34;.&nbsp;Similarly,&nbsp;section&nbsp;A.1.1&nbsp;explains&nbsp;that&nbsp;it&nbsp;is&nbsp;the&nbsp;ratio</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6368687">//&nbsp;of&nbsp;H_i&nbsp;to&nbsp;max_j(H_j)&nbsp;that&nbsp;matters,&nbsp;and&nbsp;similarly&nbsp;for&nbsp;V.&nbsp;For&nbsp;grayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6368763">//&nbsp;images,&nbsp;H_1&nbsp;is&nbsp;the&nbsp;maximum&nbsp;H_j&nbsp;for&nbsp;all&nbsp;components&nbsp;j,&nbsp;so&nbsp;that&nbsp;ratio&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6368839">//&nbsp;always&nbsp;1.&nbsp;The&nbsp;component&#39;s&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;effectively&nbsp;always&nbsp;(1,&nbsp;1):&nbsp;even&nbsp;if</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6368916">//&nbsp;the&nbsp;nominal&nbsp;(h,&nbsp;v)&nbsp;is&nbsp;(2,&nbsp;1),&nbsp;a&nbsp;20x5&nbsp;image&nbsp;is&nbsp;encoded&nbsp;in&nbsp;three&nbsp;8x8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6368989">//&nbsp;MCUs,&nbsp;not&nbsp;two&nbsp;16x8&nbsp;MCUs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369020">d</span><span class="op" id="6369021">.</span><span class="ident" id="6369022">comp</span><span class="op" id="6369026">[</span><span class="ident" id="6369027">i</span><span class="op" id="6369028">]</span><span class="op" id="6369029">.</span><span class="ident" id="6369030">h</span>&nbsp;<span class="op" id="6369032">=</span>&nbsp;<span class="num" id="6369034">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369039">d</span><span class="op" id="6369040">.</span><span class="ident" id="6369041">comp</span><span class="op" id="6369045">[</span><span class="ident" id="6369046">i</span><span class="op" id="6369047">]</span><span class="op" id="6369048">.</span><span class="ident" id="6369049">v</span>&nbsp;<span class="op" id="6369051">=</span>&nbsp;<span class="num" id="6369053">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6369058">continue</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6369069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369073">hv</span>&nbsp;<span class="op" id="6369076">:=</span>&nbsp;<span class="ident" id="6369079">d</span><span class="op" id="6369080">.</span><span class="ident" id="6369081">tmp</span><span class="op" id="6369084">[</span><span class="num" id="6369085">7</span><span class="op" id="6369086">+</span><span class="num" id="6369087">3</span><span class="op" id="6369088">*</span><span class="ident" id="6369089">i</span><span class="op" id="6369090">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369094">d</span><span class="op" id="6369095">.</span><span class="ident" id="6369096">comp</span><span class="op" id="6369100">[</span><span class="ident" id="6369101">i</span><span class="op" id="6369102">]</span><span class="op" id="6369103">.</span><span class="ident" id="6369104">h</span>&nbsp;<span class="op" id="6369106">=</span>&nbsp;<span class="builtintype" id="6369108">int</span><span class="op" id="6369111">(</span><span class="ident" id="6369112">hv</span>&nbsp;<span class="op" id="6369115">&gt;&gt;</span>&nbsp;<span class="num" id="6369118">4</span><span class="op" id="6369119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369123">d</span><span class="op" id="6369124">.</span><span class="ident" id="6369125">comp</span><span class="op" id="6369129">[</span><span class="ident" id="6369130">i</span><span class="op" id="6369131">]</span><span class="op" id="6369132">.</span><span class="ident" id="6369133">v</span>&nbsp;<span class="op" id="6369135">=</span>&nbsp;<span class="builtintype" id="6369137">int</span><span class="op" id="6369140">(</span><span class="ident" id="6369141">hv</span>&nbsp;<span class="op" id="6369144">&amp;</span>&nbsp;<span class="num" id="6369146">0x0f</span><span class="op" id="6369150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6369154">//&nbsp;For&nbsp;color&nbsp;images,&nbsp;we&nbsp;only&nbsp;support&nbsp;4:4:4,&nbsp;4:4:0,&nbsp;4:2:2&nbsp;or&nbsp;4:2:0&nbsp;chroma</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6369229">//&nbsp;downsampling&nbsp;ratios.&nbsp;This&nbsp;implies&nbsp;that&nbsp;the&nbsp;(h,&nbsp;v)&nbsp;values&nbsp;for&nbsp;the&nbsp;Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6369301">//&nbsp;component&nbsp;are&nbsp;either&nbsp;(1,&nbsp;1),&nbsp;(1,&nbsp;2),&nbsp;(2,&nbsp;1)&nbsp;or&nbsp;(2,&nbsp;2),&nbsp;and&nbsp;the&nbsp;(h,&nbsp;v)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6369376">//&nbsp;values&nbsp;for&nbsp;the&nbsp;Cr&nbsp;and&nbsp;Cb&nbsp;components&nbsp;must&nbsp;be&nbsp;(1,&nbsp;1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6369433">if</span>&nbsp;<span class="ident" id="6369436">i</span>&nbsp;<span class="op" id="6369438">==</span>&nbsp;<span class="num" id="6369441">0</span>&nbsp;<span class="op" id="6369443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6369448">if</span>&nbsp;<span class="ident" id="6369451">hv</span>&nbsp;<span class="op" id="6369454">!=</span>&nbsp;<span class="num" id="6369457">0x11</span>&nbsp;<span class="op" id="6369462">&amp;&amp;</span>&nbsp;<span class="ident" id="6369465">hv</span>&nbsp;<span class="op" id="6369468">!=</span>&nbsp;<span class="num" id="6369471">0x21</span>&nbsp;<span class="op" id="6369476">&amp;&amp;</span>&nbsp;<span class="ident" id="6369479">hv</span>&nbsp;<span class="op" id="6369482">!=</span>&nbsp;<span class="num" id="6369485">0x22</span>&nbsp;<span class="op" id="6369490">&amp;&amp;</span>&nbsp;<span class="ident" id="6369493">hv</span>&nbsp;<span class="op" id="6369496">!=</span>&nbsp;<span class="num" id="6369499">0x12</span>&nbsp;<span class="op" id="6369504">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6369510">return</span>&nbsp;<span class="ident" id="6369517">UnsupportedError</span><span class="op" id="6369533">(</span><span class="string" id="6369534">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="6369564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6369569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6369573">}</span>&nbsp;<span class="keyword" id="6369575">else</span>&nbsp;<span class="keyword" id="6369580">if</span>&nbsp;<span class="ident" id="6369583">hv</span>&nbsp;<span class="op" id="6369586">!=</span>&nbsp;<span class="num" id="6369589">0x11</span>&nbsp;<span class="op" id="6369594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6369599">return</span>&nbsp;<span class="ident" id="6369606">UnsupportedError</span><span class="op" id="6369622">(</span><span class="string" id="6369623">&#34;luma/chroma&nbsp;downsample&nbsp;ratio&#34;</span><span class="op" id="6369653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6369657">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6369660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6369663">return</span>&nbsp;<span class="ident" id="6369670">nil</span><br>
<span class="lineno"></span><span class="op" id="6369674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6369677">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.1.</span><br>
<span class="lineno">345</span><span class="keyword" id="6369710">func</span>&nbsp;<span class="op" id="6369715">(</span><span class="ident" id="6369716">d</span>&nbsp;<span class="op" id="6369718">*</span><span class="ident" id="6369719">decoder</span><span class="op" id="6369726">)</span>&nbsp;<span class="ident" id="6369728">processDQT</span><span class="op" id="6369738">(</span><span class="ident" id="6369739">n</span>&nbsp;<span class="builtintype" id="6369741">int</span><span class="op" id="6369744">)</span>&nbsp;<span class="builtintype" id="6369746">error</span>&nbsp;<span class="op" id="6369752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6369755">const</span>&nbsp;<span class="ident" id="6369761">qtLength</span>&nbsp;<span class="op" id="6369770">=</span>&nbsp;<span class="num" id="6369772">1</span>&nbsp;<span class="op" id="6369774">+</span>&nbsp;<span class="ident" id="6369776">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6369787">for</span>&nbsp;<span class="op" id="6369791">;</span>&nbsp;<span class="ident" id="6369793">n</span>&nbsp;<span class="op" id="6369795">&gt;=</span>&nbsp;<span class="ident" id="6369798">qtLength</span><span class="op" id="6369806">;</span>&nbsp;<span class="ident" id="6369808">n</span>&nbsp;<span class="op" id="6369810">-=</span>&nbsp;<span class="ident" id="6369813">qtLength</span>&nbsp;<span class="op" id="6369822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6369826">if</span>&nbsp;<span class="ident" id="6369829">err</span>&nbsp;<span class="op" id="6369833">:=</span>&nbsp;<span class="ident" id="6369836">d</span><span class="op" id="6369837">.</span><span class="ident" id="6369838">readFull</span><span class="op" id="6369846">(</span><span class="ident" id="6369847">d</span><span class="op" id="6369848">.</span><span class="ident" id="6369849">tmp</span><span class="op" id="6369852">[</span><span class="op" id="6369853">:</span><span class="ident" id="6369854">qtLength</span><span class="op" id="6369862">]</span><span class="op" id="6369863">)</span><span class="op" id="6369864">;</span>&nbsp;<span class="ident" id="6369866">err</span>&nbsp;<span class="op" id="6369870">!=</span>&nbsp;<span class="ident" id="6369873">nil</span>&nbsp;<span class="op" id="6369877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6369882">return</span>&nbsp;<span class="ident" id="6369889">err</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6369895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369899">pq</span>&nbsp;<span class="op" id="6369902">:=</span>&nbsp;<span class="ident" id="6369905">d</span><span class="op" id="6369906">.</span><span class="ident" id="6369907">tmp</span><span class="op" id="6369910">[</span><span class="num" id="6369911">0</span><span class="op" id="6369912">]</span>&nbsp;<span class="op" id="6369914">&gt;&gt;</span>&nbsp;<span class="num" id="6369917">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6369921">if</span>&nbsp;<span class="ident" id="6369924">pq</span>&nbsp;<span class="op" id="6369927">!=</span>&nbsp;<span class="num" id="6369930">0</span>&nbsp;<span class="op" id="6369932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6369937">return</span>&nbsp;<span class="ident" id="6369944">UnsupportedError</span><span class="op" id="6369960">(</span><span class="string" id="6369961">&#34;bad&nbsp;Pq&nbsp;value&#34;</span><span class="op" id="6369975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6369979">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6369983">tq</span>&nbsp;<span class="op" id="6369986">:=</span>&nbsp;<span class="ident" id="6369989">d</span><span class="op" id="6369990">.</span><span class="ident" id="6369991">tmp</span><span class="op" id="6369994">[</span><span class="num" id="6369995">0</span><span class="op" id="6369996">]</span>&nbsp;<span class="op" id="6369998">&amp;</span>&nbsp;<span class="num" id="6370000">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370007">if</span>&nbsp;<span class="ident" id="6370010">tq</span>&nbsp;<span class="op" id="6370013">&gt;</span>&nbsp;<span class="ident" id="6370015">maxTq</span>&nbsp;<span class="op" id="6370021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370026">return</span>&nbsp;<span class="ident" id="6370033">FormatError</span><span class="op" id="6370044">(</span><span class="string" id="6370045">&#34;bad&nbsp;Tq&nbsp;value&#34;</span><span class="op" id="6370059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6370063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370067">for</span>&nbsp;<span class="ident" id="6370071">i</span>&nbsp;<span class="op" id="6370073">:=</span>&nbsp;<span class="keyword" id="6370076">range</span>&nbsp;<span class="ident" id="6370082">d</span><span class="op" id="6370083">.</span><span class="ident" id="6370084">quant</span><span class="op" id="6370089">[</span><span class="ident" id="6370090">tq</span><span class="op" id="6370092">]</span>&nbsp;<span class="op" id="6370094">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6370099">d</span><span class="op" id="6370100">.</span><span class="ident" id="6370101">quant</span><span class="op" id="6370106">[</span><span class="ident" id="6370107">tq</span><span class="op" id="6370109">]</span><span class="op" id="6370110">[</span><span class="ident" id="6370111">i</span><span class="op" id="6370112">]</span>&nbsp;<span class="op" id="6370114">=</span>&nbsp;<span class="builtintype" id="6370116">int32</span><span class="op" id="6370121">(</span><span class="ident" id="6370122">d</span><span class="op" id="6370123">.</span><span class="ident" id="6370124">tmp</span><span class="op" id="6370127">[</span><span class="ident" id="6370128">i</span><span class="op" id="6370129">+</span><span class="num" id="6370130">1</span><span class="op" id="6370131">]</span><span class="op" id="6370132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6370136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6370139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370142">if</span>&nbsp;<span class="ident" id="6370145">n</span>&nbsp;<span class="op" id="6370147">!=</span>&nbsp;<span class="num" id="6370150">0</span>&nbsp;<span class="op" id="6370152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370156">return</span>&nbsp;<span class="ident" id="6370163">FormatError</span><span class="op" id="6370174">(</span><span class="string" id="6370175">&#34;DQT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6370197">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6370200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370203">return</span>&nbsp;<span class="ident" id="6370210">nil</span><br>
<span class="lineno"></span><span class="op" id="6370214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6370217">//&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.4.</span><br>
<span class="lineno">370</span><span class="keyword" id="6370250">func</span>&nbsp;<span class="op" id="6370255">(</span><span class="ident" id="6370256">d</span>&nbsp;<span class="op" id="6370258">*</span><span class="ident" id="6370259">decoder</span><span class="op" id="6370266">)</span>&nbsp;<span class="ident" id="6370268">processDRI</span><span class="op" id="6370278">(</span><span class="ident" id="6370279">n</span>&nbsp;<span class="builtintype" id="6370281">int</span><span class="op" id="6370284">)</span>&nbsp;<span class="builtintype" id="6370286">error</span>&nbsp;<span class="op" id="6370292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370295">if</span>&nbsp;<span class="ident" id="6370298">n</span>&nbsp;<span class="op" id="6370300">!=</span>&nbsp;<span class="num" id="6370303">2</span>&nbsp;<span class="op" id="6370305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370309">return</span>&nbsp;<span class="ident" id="6370316">FormatError</span><span class="op" id="6370327">(</span><span class="string" id="6370328">&#34;DRI&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6370350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6370353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370356">if</span>&nbsp;<span class="ident" id="6370359">err</span>&nbsp;<span class="op" id="6370363">:=</span>&nbsp;<span class="ident" id="6370366">d</span><span class="op" id="6370367">.</span><span class="ident" id="6370368">readFull</span><span class="op" id="6370376">(</span><span class="ident" id="6370377">d</span><span class="op" id="6370378">.</span><span class="ident" id="6370379">tmp</span><span class="op" id="6370382">[</span><span class="op" id="6370383">:</span><span class="num" id="6370384">2</span><span class="op" id="6370385">]</span><span class="op" id="6370386">)</span><span class="op" id="6370387">;</span>&nbsp;<span class="ident" id="6370389">err</span>&nbsp;<span class="op" id="6370393">!=</span>&nbsp;<span class="ident" id="6370396">nil</span>&nbsp;<span class="op" id="6370400">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370404">return</span>&nbsp;<span class="ident" id="6370411">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6370416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6370419">d</span><span class="op" id="6370420">.</span><span class="ident" id="6370421">ri</span>&nbsp;<span class="op" id="6370424">=</span>&nbsp;<span class="builtintype" id="6370426">int</span><span class="op" id="6370429">(</span><span class="ident" id="6370430">d</span><span class="op" id="6370431">.</span><span class="ident" id="6370432">tmp</span><span class="op" id="6370435">[</span><span class="num" id="6370436">0</span><span class="op" id="6370437">]</span><span class="op" id="6370438">)</span><span class="op" id="6370439">&lt;&lt;</span><span class="num" id="6370441">8</span>&nbsp;<span class="op" id="6370443">+</span>&nbsp;<span class="builtintype" id="6370445">int</span><span class="op" id="6370448">(</span><span class="ident" id="6370449">d</span><span class="op" id="6370450">.</span><span class="ident" id="6370451">tmp</span><span class="op" id="6370454">[</span><span class="num" id="6370455">1</span><span class="op" id="6370456">]</span><span class="op" id="6370457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370460">return</span>&nbsp;<span class="ident" id="6370467">nil</span><br>
<span class="lineno"></span><span class="op" id="6370471">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="6370474">//&nbsp;decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="6370544">func</span>&nbsp;<span class="op" id="6370549">(</span><span class="ident" id="6370550">d</span>&nbsp;<span class="op" id="6370552">*</span><span class="ident" id="6370553">decoder</span><span class="op" id="6370560">)</span>&nbsp;<span class="ident" id="6370562">decode</span><span class="op" id="6370568">(</span><span class="ident" id="6370569">r</span>&nbsp;<span class="ident" id="6370571">io</span><span class="op" id="6370573">.</span><span class="ident" id="6370574">Reader</span><span class="op" id="6370580">,</span>&nbsp;<span class="ident" id="6370582">configOnly</span>&nbsp;<span class="builtintype" id="6370593">bool</span><span class="op" id="6370597">)</span>&nbsp;<span class="op" id="6370599">(</span><span class="ident" id="6370600">image</span><span class="op" id="6370605">.</span><span class="ident" id="6370606">Image</span><span class="op" id="6370611">,</span>&nbsp;<span class="builtintype" id="6370613">error</span><span class="op" id="6370618">)</span>&nbsp;<span class="op" id="6370620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6370623">d</span><span class="op" id="6370624">.</span><span class="ident" id="6370625">r</span>&nbsp;<span class="op" id="6370627">=</span>&nbsp;<span class="ident" id="6370629">r</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6370633">//&nbsp;Check&nbsp;for&nbsp;the&nbsp;Start&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370674">if</span>&nbsp;<span class="ident" id="6370677">err</span>&nbsp;<span class="op" id="6370681">:=</span>&nbsp;<span class="ident" id="6370684">d</span><span class="op" id="6370685">.</span><span class="ident" id="6370686">readFull</span><span class="op" id="6370694">(</span><span class="ident" id="6370695">d</span><span class="op" id="6370696">.</span><span class="ident" id="6370697">tmp</span><span class="op" id="6370700">[</span><span class="op" id="6370701">:</span><span class="num" id="6370702">2</span><span class="op" id="6370703">]</span><span class="op" id="6370704">)</span><span class="op" id="6370705">;</span>&nbsp;<span class="ident" id="6370707">err</span>&nbsp;<span class="op" id="6370711">!=</span>&nbsp;<span class="ident" id="6370714">nil</span>&nbsp;<span class="op" id="6370718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370722">return</span>&nbsp;<span class="ident" id="6370729">nil</span><span class="op" id="6370732">,</span>&nbsp;<span class="ident" id="6370734">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6370739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370742">if</span>&nbsp;<span class="ident" id="6370745">d</span><span class="op" id="6370746">.</span><span class="ident" id="6370747">tmp</span><span class="op" id="6370750">[</span><span class="num" id="6370751">0</span><span class="op" id="6370752">]</span>&nbsp;<span class="op" id="6370754">!=</span>&nbsp;<span class="num" id="6370757">0xff</span>&nbsp;<span class="op" id="6370762">||</span>&nbsp;<span class="ident" id="6370765">d</span><span class="op" id="6370766">.</span><span class="ident" id="6370767">tmp</span><span class="op" id="6370770">[</span><span class="num" id="6370771">1</span><span class="op" id="6370772">]</span>&nbsp;<span class="op" id="6370774">!=</span>&nbsp;<span class="ident" id="6370777">soiMarker</span>&nbsp;<span class="op" id="6370787">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370791">return</span>&nbsp;<span class="ident" id="6370798">nil</span><span class="op" id="6370801">,</span>&nbsp;<span class="ident" id="6370803">FormatError</span><span class="op" id="6370814">(</span><span class="string" id="6370815">&#34;missing&nbsp;SOI&nbsp;marker&#34;</span><span class="op" id="6370835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6370838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6370842">//&nbsp;Process&nbsp;the&nbsp;remaining&nbsp;segments&nbsp;until&nbsp;the&nbsp;End&nbsp;Of&nbsp;Image&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370908">for</span>&nbsp;<span class="op" id="6370912">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6370916">err</span>&nbsp;<span class="op" id="6370920">:=</span>&nbsp;<span class="ident" id="6370923">d</span><span class="op" id="6370924">.</span><span class="ident" id="6370925">readFull</span><span class="op" id="6370933">(</span><span class="ident" id="6370934">d</span><span class="op" id="6370935">.</span><span class="ident" id="6370936">tmp</span><span class="op" id="6370939">[</span><span class="op" id="6370940">:</span><span class="num" id="6370941">2</span><span class="op" id="6370942">]</span><span class="op" id="6370943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370947">if</span>&nbsp;<span class="ident" id="6370950">err</span>&nbsp;<span class="op" id="6370954">!=</span>&nbsp;<span class="ident" id="6370957">nil</span>&nbsp;<span class="op" id="6370961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370966">return</span>&nbsp;<span class="ident" id="6370973">nil</span><span class="op" id="6370976">,</span>&nbsp;<span class="ident" id="6370978">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6370984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6370988">for</span>&nbsp;<span class="ident" id="6370992">d</span><span class="op" id="6370993">.</span><span class="ident" id="6370994">tmp</span><span class="op" id="6370997">[</span><span class="num" id="6370998">0</span><span class="op" id="6370999">]</span>&nbsp;<span class="op" id="6371001">!=</span>&nbsp;<span class="num" id="6371004">0xff</span>&nbsp;<span class="op" id="6371009">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371014">//&nbsp;Strictly&nbsp;speaking,&nbsp;this&nbsp;is&nbsp;a&nbsp;format&nbsp;error.&nbsp;However,&nbsp;libjpeg&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371083">//&nbsp;liberal&nbsp;in&nbsp;what&nbsp;it&nbsp;accepts.&nbsp;As&nbsp;of&nbsp;version&nbsp;9,&nbsp;next_marker&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371149">//&nbsp;jdmarker.c&nbsp;treats&nbsp;this&nbsp;as&nbsp;a&nbsp;warning&nbsp;(JWRN_EXTRANEOUS_DATA)&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371218">//&nbsp;continues&nbsp;to&nbsp;decode&nbsp;the&nbsp;stream.&nbsp;Even&nbsp;before&nbsp;next_marker&nbsp;sees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371285">//&nbsp;extraneous&nbsp;data,&nbsp;jpeg_fill_bit_buffer&nbsp;in&nbsp;jdhuff.c&nbsp;reads&nbsp;as&nbsp;many</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371355">//&nbsp;bytes&nbsp;as&nbsp;it&nbsp;can,&nbsp;possibly&nbsp;past&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;scan&#39;s&nbsp;data.&nbsp;It</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371421">//&nbsp;effectively&nbsp;puts&nbsp;back&nbsp;any&nbsp;markers&nbsp;that&nbsp;it&nbsp;overscanned&nbsp;(e.g.&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371490">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker),&nbsp;but&nbsp;it&nbsp;does&nbsp;not&nbsp;put&nbsp;back&nbsp;non-marker&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371562">//&nbsp;and&nbsp;thus&nbsp;it&nbsp;can&nbsp;silently&nbsp;ignore&nbsp;a&nbsp;small&nbsp;number&nbsp;of&nbsp;extraneous</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371629">//&nbsp;non-marker&nbsp;bytes&nbsp;before&nbsp;next_marker&nbsp;has&nbsp;a&nbsp;chance&nbsp;to&nbsp;see&nbsp;them&nbsp;(and</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371701">//&nbsp;print&nbsp;a&nbsp;warning).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371725">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371731">//&nbsp;We&nbsp;are&nbsp;therefore&nbsp;also&nbsp;liberal&nbsp;in&nbsp;what&nbsp;we&nbsp;accept.&nbsp;Extraneous&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371802">//&nbsp;is&nbsp;silently&nbsp;ignored.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371829">//</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371835">//&nbsp;This&nbsp;is&nbsp;similar&nbsp;to,&nbsp;but&nbsp;not&nbsp;exactly&nbsp;the&nbsp;same&nbsp;as,&nbsp;the&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371902">//&nbsp;mechanism&nbsp;within&nbsp;a&nbsp;scan&nbsp;(the&nbsp;RST[0-7]&nbsp;markers).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371956">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6371962">//&nbsp;Note&nbsp;that&nbsp;extraneous&nbsp;0xff&nbsp;bytes&nbsp;in&nbsp;e.g.&nbsp;SOS&nbsp;data&nbsp;are&nbsp;escaped&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372032">//&nbsp;&#34;\xff\x00&#34;,&nbsp;and&nbsp;so&nbsp;are&nbsp;detected&nbsp;a&nbsp;little&nbsp;further&nbsp;down&nbsp;below.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372099">d</span><span class="op" id="6372100">.</span><span class="ident" id="6372101">tmp</span><span class="op" id="6372104">[</span><span class="num" id="6372105">0</span><span class="op" id="6372106">]</span>&nbsp;<span class="op" id="6372108">=</span>&nbsp;<span class="ident" id="6372110">d</span><span class="op" id="6372111">.</span><span class="ident" id="6372112">tmp</span><span class="op" id="6372115">[</span><span class="num" id="6372116">1</span><span class="op" id="6372117">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372122">d</span><span class="op" id="6372123">.</span><span class="ident" id="6372124">tmp</span><span class="op" id="6372127">[</span><span class="num" id="6372128">1</span><span class="op" id="6372129">]</span><span class="op" id="6372130">,</span>&nbsp;<span class="ident" id="6372132">err</span>&nbsp;<span class="op" id="6372136">=</span>&nbsp;<span class="ident" id="6372138">d</span><span class="op" id="6372139">.</span><span class="ident" id="6372140">readByte</span><span class="op" id="6372148">(</span><span class="op" id="6372149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372154">if</span>&nbsp;<span class="ident" id="6372157">err</span>&nbsp;<span class="op" id="6372161">!=</span>&nbsp;<span class="ident" id="6372164">nil</span>&nbsp;<span class="op" id="6372168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372174">return</span>&nbsp;<span class="ident" id="6372181">nil</span><span class="op" id="6372184">,</span>&nbsp;<span class="ident" id="6372186">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6372193">}</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6372197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372201">marker</span>&nbsp;<span class="op" id="6372208">:=</span>&nbsp;<span class="ident" id="6372211">d</span><span class="op" id="6372212">.</span><span class="ident" id="6372213">tmp</span><span class="op" id="6372216">[</span><span class="num" id="6372217">1</span><span class="op" id="6372218">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372222">if</span>&nbsp;<span class="ident" id="6372225">marker</span>&nbsp;<span class="op" id="6372232">==</span>&nbsp;<span class="num" id="6372235">0</span>&nbsp;<span class="op" id="6372237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372242">//&nbsp;Treat&nbsp;&#34;\xff\x00&#34;&nbsp;as&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372285">continue</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6372296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372300">for</span>&nbsp;<span class="ident" id="6372304">marker</span>&nbsp;<span class="op" id="6372311">==</span>&nbsp;<span class="num" id="6372314">0xff</span>&nbsp;<span class="op" id="6372319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372324">//&nbsp;Section&nbsp;B.1.1.2&nbsp;says,&nbsp;&#34;Any&nbsp;marker&nbsp;may&nbsp;optionally&nbsp;be&nbsp;preceded&nbsp;by&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372398">//&nbsp;number&nbsp;of&nbsp;fill&nbsp;bytes,&nbsp;which&nbsp;are&nbsp;bytes&nbsp;assigned&nbsp;code&nbsp;X&#39;FF&#39;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372464">marker</span><span class="op" id="6372470">,</span>&nbsp;<span class="ident" id="6372472">err</span>&nbsp;<span class="op" id="6372476">=</span>&nbsp;<span class="ident" id="6372478">d</span><span class="op" id="6372479">.</span><span class="ident" id="6372480">readByte</span><span class="op" id="6372488">(</span><span class="op" id="6372489">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372494">if</span>&nbsp;<span class="ident" id="6372497">err</span>&nbsp;<span class="op" id="6372501">!=</span>&nbsp;<span class="ident" id="6372504">nil</span>&nbsp;<span class="op" id="6372508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372514">return</span>&nbsp;<span class="ident" id="6372521">nil</span><span class="op" id="6372524">,</span>&nbsp;<span class="ident" id="6372526">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6372533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6372537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372541">if</span>&nbsp;<span class="ident" id="6372544">marker</span>&nbsp;<span class="op" id="6372551">==</span>&nbsp;<span class="ident" id="6372554">eoiMarker</span>&nbsp;<span class="op" id="6372564">{</span>&nbsp;<span class="comment" id="6372566">//&nbsp;End&nbsp;Of&nbsp;Image.</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372586">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6372594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372598">if</span>&nbsp;<span class="ident" id="6372601">rst0Marker</span>&nbsp;<span class="op" id="6372612">&lt;=</span>&nbsp;<span class="ident" id="6372615">marker</span>&nbsp;<span class="op" id="6372622">&amp;&amp;</span>&nbsp;<span class="ident" id="6372625">marker</span>&nbsp;<span class="op" id="6372632">&lt;=</span>&nbsp;<span class="ident" id="6372635">rst7Marker</span>&nbsp;<span class="op" id="6372646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372651">//&nbsp;Figures&nbsp;B.2&nbsp;and&nbsp;B.16&nbsp;of&nbsp;the&nbsp;specification&nbsp;suggest&nbsp;that&nbsp;restart&nbsp;markers&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372735">//&nbsp;only&nbsp;occur&nbsp;between&nbsp;Entropy&nbsp;Coded&nbsp;Segments&nbsp;and&nbsp;not&nbsp;after&nbsp;the&nbsp;final&nbsp;ECS.</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372812">//&nbsp;However,&nbsp;some&nbsp;encoders&nbsp;may&nbsp;generate&nbsp;incorrect&nbsp;JPEGs&nbsp;with&nbsp;a&nbsp;final&nbsp;restart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372891">//&nbsp;marker.&nbsp;That&nbsp;restart&nbsp;marker&nbsp;will&nbsp;be&nbsp;seen&nbsp;here&nbsp;instead&nbsp;of&nbsp;inside&nbsp;the&nbsp;processSOS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372976">//&nbsp;method,&nbsp;and&nbsp;is&nbsp;ignored&nbsp;as&nbsp;a&nbsp;harmless&nbsp;error.&nbsp;Restart&nbsp;markers&nbsp;have&nbsp;no&nbsp;extra&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6373062">//&nbsp;so&nbsp;we&nbsp;check&nbsp;for&nbsp;this&nbsp;before&nbsp;we&nbsp;read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373138">continue</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6373154">//&nbsp;Read&nbsp;the&nbsp;16-bit&nbsp;length&nbsp;of&nbsp;the&nbsp;segment.&nbsp;The&nbsp;value&nbsp;includes&nbsp;the&nbsp;2&nbsp;bytes&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6373237">//&nbsp;length&nbsp;itself,&nbsp;so&nbsp;we&nbsp;subtract&nbsp;2&nbsp;to&nbsp;get&nbsp;the&nbsp;number&nbsp;of&nbsp;remaining&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373312">if</span>&nbsp;<span class="ident" id="6373315">err</span>&nbsp;<span class="op" id="6373319">=</span>&nbsp;<span class="ident" id="6373321">d</span><span class="op" id="6373322">.</span><span class="ident" id="6373323">readFull</span><span class="op" id="6373331">(</span><span class="ident" id="6373332">d</span><span class="op" id="6373333">.</span><span class="ident" id="6373334">tmp</span><span class="op" id="6373337">[</span><span class="op" id="6373338">:</span><span class="num" id="6373339">2</span><span class="op" id="6373340">]</span><span class="op" id="6373341">)</span><span class="op" id="6373342">;</span>&nbsp;<span class="ident" id="6373344">err</span>&nbsp;<span class="op" id="6373348">!=</span>&nbsp;<span class="ident" id="6373351">nil</span>&nbsp;<span class="op" id="6373355">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373360">return</span>&nbsp;<span class="ident" id="6373367">nil</span><span class="op" id="6373370">,</span>&nbsp;<span class="ident" id="6373372">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373382">n</span>&nbsp;<span class="op" id="6373384">:=</span>&nbsp;<span class="builtintype" id="6373387">int</span><span class="op" id="6373390">(</span><span class="ident" id="6373391">d</span><span class="op" id="6373392">.</span><span class="ident" id="6373393">tmp</span><span class="op" id="6373396">[</span><span class="num" id="6373397">0</span><span class="op" id="6373398">]</span><span class="op" id="6373399">)</span><span class="op" id="6373400">&lt;&lt;</span><span class="num" id="6373402">8</span>&nbsp;<span class="op" id="6373404">+</span>&nbsp;<span class="builtintype" id="6373406">int</span><span class="op" id="6373409">(</span><span class="ident" id="6373410">d</span><span class="op" id="6373411">.</span><span class="ident" id="6373412">tmp</span><span class="op" id="6373415">[</span><span class="num" id="6373416">1</span><span class="op" id="6373417">]</span><span class="op" id="6373418">)</span>&nbsp;<span class="op" id="6373420">-</span>&nbsp;<span class="num" id="6373422">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373426">if</span>&nbsp;<span class="ident" id="6373429">n</span>&nbsp;<span class="op" id="6373431">&lt;</span>&nbsp;<span class="num" id="6373433">0</span>&nbsp;<span class="op" id="6373435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373440">return</span>&nbsp;<span class="ident" id="6373447">nil</span><span class="op" id="6373450">,</span>&nbsp;<span class="ident" id="6373452">FormatError</span><span class="op" id="6373463">(</span><span class="string" id="6373464">&#34;short&nbsp;segment&nbsp;length&#34;</span><span class="op" id="6373486">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373495">switch</span>&nbsp;<span class="op" id="6373502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373506">case</span>&nbsp;<span class="ident" id="6373511">marker</span>&nbsp;<span class="op" id="6373518">==</span>&nbsp;<span class="ident" id="6373521">sof0Marker</span>&nbsp;<span class="op" id="6373532">||</span>&nbsp;<span class="ident" id="6373535">marker</span>&nbsp;<span class="op" id="6373542">==</span>&nbsp;<span class="ident" id="6373545">sof2Marker</span><span class="op" id="6373555">:</span>&nbsp;<span class="comment" id="6373557">//&nbsp;Start&nbsp;Of&nbsp;Frame.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373579">d</span><span class="op" id="6373580">.</span><span class="ident" id="6373581">progressive</span>&nbsp;<span class="op" id="6373593">=</span>&nbsp;<span class="ident" id="6373595">marker</span>&nbsp;<span class="op" id="6373602">==</span>&nbsp;<span class="ident" id="6373605">sof2Marker</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373619">err</span>&nbsp;<span class="op" id="6373623">=</span>&nbsp;<span class="ident" id="6373625">d</span><span class="op" id="6373626">.</span><span class="ident" id="6373627">processSOF</span><span class="op" id="6373637">(</span><span class="ident" id="6373638">n</span><span class="op" id="6373639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373644">if</span>&nbsp;<span class="ident" id="6373647">configOnly</span>&nbsp;<span class="op" id="6373658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373664">return</span>&nbsp;<span class="ident" id="6373671">nil</span><span class="op" id="6373674">,</span>&nbsp;<span class="ident" id="6373676">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373687">case</span>&nbsp;<span class="ident" id="6373692">marker</span>&nbsp;<span class="op" id="6373699">==</span>&nbsp;<span class="ident" id="6373702">dhtMarker</span><span class="op" id="6373711">:</span>&nbsp;<span class="comment" id="6373713">//&nbsp;Define&nbsp;Huffman&nbsp;Table.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373741">err</span>&nbsp;<span class="op" id="6373745">=</span>&nbsp;<span class="ident" id="6373747">d</span><span class="op" id="6373748">.</span><span class="ident" id="6373749">processDHT</span><span class="op" id="6373759">(</span><span class="ident" id="6373760">n</span><span class="op" id="6373761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373765">case</span>&nbsp;<span class="ident" id="6373770">marker</span>&nbsp;<span class="op" id="6373777">==</span>&nbsp;<span class="ident" id="6373780">dqtMarker</span><span class="op" id="6373789">:</span>&nbsp;<span class="comment" id="6373791">//&nbsp;Define&nbsp;Quantization&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373824">err</span>&nbsp;<span class="op" id="6373828">=</span>&nbsp;<span class="ident" id="6373830">d</span><span class="op" id="6373831">.</span><span class="ident" id="6373832">processDQT</span><span class="op" id="6373842">(</span><span class="ident" id="6373843">n</span><span class="op" id="6373844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373848">case</span>&nbsp;<span class="ident" id="6373853">marker</span>&nbsp;<span class="op" id="6373860">==</span>&nbsp;<span class="ident" id="6373863">sosMarker</span><span class="op" id="6373872">:</span>&nbsp;<span class="comment" id="6373874">//&nbsp;Start&nbsp;Of&nbsp;Scan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373895">err</span>&nbsp;<span class="op" id="6373899">=</span>&nbsp;<span class="ident" id="6373901">d</span><span class="op" id="6373902">.</span><span class="ident" id="6373903">processSOS</span><span class="op" id="6373913">(</span><span class="ident" id="6373914">n</span><span class="op" id="6373915">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373919">case</span>&nbsp;<span class="ident" id="6373924">marker</span>&nbsp;<span class="op" id="6373931">==</span>&nbsp;<span class="ident" id="6373934">driMarker</span><span class="op" id="6373943">:</span>&nbsp;<span class="comment" id="6373945">//&nbsp;Define&nbsp;Restart&nbsp;Interval.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373976">err</span>&nbsp;<span class="op" id="6373980">=</span>&nbsp;<span class="ident" id="6373982">d</span><span class="op" id="6373983">.</span><span class="ident" id="6373984">processDRI</span><span class="op" id="6373994">(</span><span class="ident" id="6373995">n</span><span class="op" id="6373996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374000">case</span>&nbsp;<span class="ident" id="6374005">app0Marker</span>&nbsp;<span class="op" id="6374016">&lt;=</span>&nbsp;<span class="ident" id="6374019">marker</span>&nbsp;<span class="op" id="6374026">&amp;&amp;</span>&nbsp;<span class="ident" id="6374029">marker</span>&nbsp;<span class="op" id="6374036">&lt;=</span>&nbsp;<span class="ident" id="6374039">app15Marker</span>&nbsp;<span class="op" id="6374051">||</span>&nbsp;<span class="ident" id="6374054">marker</span>&nbsp;<span class="op" id="6374061">==</span>&nbsp;<span class="ident" id="6374064">comMarker</span><span class="op" id="6374073">:</span>&nbsp;<span class="comment" id="6374075">//&nbsp;APPlication&nbsp;specific,&nbsp;or&nbsp;COMment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374115">err</span>&nbsp;<span class="op" id="6374119">=</span>&nbsp;<span class="ident" id="6374121">d</span><span class="op" id="6374122">.</span><span class="ident" id="6374123">ignore</span><span class="op" id="6374129">(</span><span class="ident" id="6374130">n</span><span class="op" id="6374131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374135">default</span><span class="op" id="6374142">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374147">err</span>&nbsp;<span class="op" id="6374151">=</span>&nbsp;<span class="ident" id="6374153">UnsupportedError</span><span class="op" id="6374169">(</span><span class="string" id="6374170">&#34;unknown&nbsp;marker&#34;</span><span class="op" id="6374186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374194">if</span>&nbsp;<span class="ident" id="6374197">err</span>&nbsp;<span class="op" id="6374201">!=</span>&nbsp;<span class="ident" id="6374204">nil</span>&nbsp;<span class="op" id="6374208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374213">return</span>&nbsp;<span class="ident" id="6374220">nil</span><span class="op" id="6374223">,</span>&nbsp;<span class="ident" id="6374225">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374231">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374237">if</span>&nbsp;<span class="ident" id="6374240">d</span><span class="op" id="6374241">.</span><span class="ident" id="6374242">img1</span>&nbsp;<span class="op" id="6374247">!=</span>&nbsp;<span class="ident" id="6374250">nil</span>&nbsp;<span class="op" id="6374254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374258">return</span>&nbsp;<span class="ident" id="6374265">d</span><span class="op" id="6374266">.</span><span class="ident" id="6374267">img1</span><span class="op" id="6374271">,</span>&nbsp;<span class="ident" id="6374273">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374281">if</span>&nbsp;<span class="ident" id="6374284">d</span><span class="op" id="6374285">.</span><span class="ident" id="6374286">img3</span>&nbsp;<span class="op" id="6374291">!=</span>&nbsp;<span class="ident" id="6374294">nil</span>&nbsp;<span class="op" id="6374298">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374302">return</span>&nbsp;<span class="ident" id="6374309">d</span><span class="op" id="6374310">.</span><span class="ident" id="6374311">img3</span><span class="op" id="6374315">,</span>&nbsp;<span class="ident" id="6374317">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374325">return</span>&nbsp;<span class="ident" id="6374332">nil</span><span class="op" id="6374335">,</span>&nbsp;<span class="ident" id="6374337">FormatError</span><span class="op" id="6374348">(</span><span class="string" id="6374349">&#34;missing&nbsp;SOS&nbsp;marker&#34;</span><span class="op" id="6374369">)</span><br>
<span class="lineno"></span><span class="op" id="6374371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="6374374">//&nbsp;Decode&nbsp;reads&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;from&nbsp;r&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;an&nbsp;image.Image.</span><br>
<span class="lineno"></span><span class="keyword" id="6374444">func</span>&nbsp;<span class="ident" id="6374449">Decode</span><span class="op" id="6374455">(</span><span class="ident" id="6374456">r</span>&nbsp;<span class="ident" id="6374458">io</span><span class="op" id="6374460">.</span><span class="ident" id="6374461">Reader</span><span class="op" id="6374467">)</span>&nbsp;<span class="op" id="6374469">(</span><span class="ident" id="6374470">image</span><span class="op" id="6374475">.</span><span class="ident" id="6374476">Image</span><span class="op" id="6374481">,</span>&nbsp;<span class="builtintype" id="6374483">error</span><span class="op" id="6374488">)</span>&nbsp;<span class="op" id="6374490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374493">var</span>&nbsp;<span class="ident" id="6374497">d</span>&nbsp;<span class="ident" id="6374499">decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374508">return</span>&nbsp;<span class="ident" id="6374515">d</span><span class="op" id="6374516">.</span><span class="ident" id="6374517">decode</span><span class="op" id="6374523">(</span><span class="ident" id="6374524">r</span><span class="op" id="6374525">,</span>&nbsp;<span class="builtintype" id="6374527">false</span><span class="op" id="6374532">)</span><br>
<span class="lineno"></span><span class="op" id="6374534">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="comment" id="6374537">//&nbsp;DecodeConfig&nbsp;returns&nbsp;the&nbsp;color&nbsp;model&nbsp;and&nbsp;dimensions&nbsp;of&nbsp;a&nbsp;JPEG&nbsp;image&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="6374616">//&nbsp;decoding&nbsp;the&nbsp;entire&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="6374646">func</span>&nbsp;<span class="ident" id="6374651">DecodeConfig</span><span class="op" id="6374663">(</span><span class="ident" id="6374664">r</span>&nbsp;<span class="ident" id="6374666">io</span><span class="op" id="6374668">.</span><span class="ident" id="6374669">Reader</span><span class="op" id="6374675">)</span>&nbsp;<span class="op" id="6374677">(</span><span class="ident" id="6374678">image</span><span class="op" id="6374683">.</span><span class="ident" id="6374684">Config</span><span class="op" id="6374690">,</span>&nbsp;<span class="builtintype" id="6374692">error</span><span class="op" id="6374697">)</span>&nbsp;<span class="op" id="6374699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374702">var</span>&nbsp;<span class="ident" id="6374706">d</span>&nbsp;<span class="ident" id="6374708">decoder</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374717">if</span>&nbsp;<span class="ident" id="6374720">_</span><span class="op" id="6374721">,</span>&nbsp;<span class="ident" id="6374723">err</span>&nbsp;<span class="op" id="6374727">:=</span>&nbsp;<span class="ident" id="6374730">d</span><span class="op" id="6374731">.</span><span class="ident" id="6374732">decode</span><span class="op" id="6374738">(</span><span class="ident" id="6374739">r</span><span class="op" id="6374740">,</span>&nbsp;<span class="builtintype" id="6374742">true</span><span class="op" id="6374746">)</span><span class="op" id="6374747">;</span>&nbsp;<span class="ident" id="6374749">err</span>&nbsp;<span class="op" id="6374753">!=</span>&nbsp;<span class="ident" id="6374756">nil</span>&nbsp;<span class="op" id="6374760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374764">return</span>&nbsp;<span class="ident" id="6374771">image</span><span class="op" id="6374776">.</span><span class="ident" id="6374777">Config</span><span class="op" id="6374783">{</span><span class="op" id="6374784">}</span><span class="op" id="6374785">,</span>&nbsp;<span class="ident" id="6374787">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374795">switch</span>&nbsp;<span class="ident" id="6374802">d</span><span class="op" id="6374803">.</span><span class="ident" id="6374804">nComp</span>&nbsp;<span class="op" id="6374810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374813">case</span>&nbsp;<span class="ident" id="6374818">nGrayComponent</span><span class="op" id="6374832">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374836">return</span>&nbsp;<span class="ident" id="6374843">image</span><span class="op" id="6374848">.</span><span class="ident" id="6374849">Config</span><span class="op" id="6374855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374860">ColorModel</span><span class="op" id="6374870">:</span>&nbsp;<span class="ident" id="6374872">color</span><span class="op" id="6374877">.</span><span class="ident" id="6374878">GrayModel</span><span class="op" id="6374887">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374892">Width</span><span class="op" id="6374897">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374904">d</span><span class="op" id="6374905">.</span><span class="ident" id="6374906">width</span><span class="op" id="6374911">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374916">Height</span><span class="op" id="6374922">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6374928">d</span><span class="op" id="6374929">.</span><span class="ident" id="6374930">height</span><span class="op" id="6374936">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374940">}</span><span class="op" id="6374941">,</span>&nbsp;<span class="ident" id="6374943">nil</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374948">case</span>&nbsp;<span class="ident" id="6374953">nColorComponent</span><span class="op" id="6374968">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374972">return</span>&nbsp;<span class="ident" id="6374979">image</span><span class="op" id="6374984">.</span><span class="ident" id="6374985">Config</span><span class="op" id="6374991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374996">ColorModel</span><span class="op" id="6375006">:</span>&nbsp;<span class="ident" id="6375008">color</span><span class="op" id="6375013">.</span><span class="ident" id="6375014">YCbCrModel</span><span class="op" id="6375024">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375029">Width</span><span class="op" id="6375034">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375041">d</span><span class="op" id="6375042">.</span><span class="ident" id="6375043">width</span><span class="op" id="6375048">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375053">Height</span><span class="op" id="6375059">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6375065">d</span><span class="op" id="6375066">.</span><span class="ident" id="6375067">height</span><span class="op" id="6375073">,</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6375077">}</span><span class="op" id="6375078">,</span>&nbsp;<span class="ident" id="6375080">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6375085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375088">return</span>&nbsp;<span class="ident" id="6375095">image</span><span class="op" id="6375100">.</span><span class="ident" id="6375101">Config</span><span class="op" id="6375107">{</span><span class="op" id="6375108">}</span><span class="op" id="6375109">,</span>&nbsp;<span class="ident" id="6375111">FormatError</span><span class="op" id="6375122">(</span><span class="string" id="6375123">&#34;missing&nbsp;SOF&nbsp;marker&#34;</span><span class="op" id="6375143">)</span><br>
<span class="lineno"></span><span class="op" id="6375145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">525</span><span class="keyword" id="6375148">func</span>&nbsp;<span class="ident" id="6375153">init</span><span class="op" id="6375157">(</span><span class="op" id="6375158">)</span>&nbsp;<span class="op" id="6375160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375163">image</span><span class="op" id="6375168">.</span><span class="ident" id="6375169">RegisterFormat</span><span class="op" id="6375183">(</span><span class="string" id="6375184">&#34;jpeg&#34;</span><span class="op" id="6375190">,</span>&nbsp;<span class="string" id="6375192">&#34;\xff\xd8&#34;</span><span class="op" id="6375202">,</span>&nbsp;<span class="ident" id="6375204">Decode</span><span class="op" id="6375210">,</span>&nbsp;<span class="ident" id="6375212">DecodeConfig</span><span class="op" id="6375224">)</span><br>
<span class="lineno"></span><span class="op" id="6375226">}</span>
</div>
</body>
</html>
