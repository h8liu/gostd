<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2501377">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2501432">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2501486">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2501537">//&nbsp;+build&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2501554">package</span>&nbsp;<span class="ident" id="2501562">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2501571">import</span>&nbsp;<span class="op" id="2501578">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2501581">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2501590">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2501593">//&nbsp;SysProcIDMap&nbsp;holds&nbsp;Container&nbsp;ID&nbsp;to&nbsp;Host&nbsp;ID&nbsp;mappings&nbsp;used&nbsp;for&nbsp;User&nbsp;Namespaces&nbsp;in&nbsp;Linux.</span><br>
<span class="lineno"></span><span class="comment" id="2501683">//&nbsp;See&nbsp;user_namespaces(7).</span><br>
<span class="lineno">15</span><span class="keyword" id="2501710">type</span>&nbsp;<span class="ident" id="2501715">SysProcIDMap</span>&nbsp;<span class="keyword" id="2501728">struct</span>&nbsp;<span class="op" id="2501735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2501738">ContainerID</span>&nbsp;<span class="builtintype" id="2501750">int</span>&nbsp;<span class="comment" id="2501754">//&nbsp;Container&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2501772">HostID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2501784">int</span>&nbsp;<span class="comment" id="2501788">//&nbsp;Host&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2501801">Size</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2501813">int</span>&nbsp;<span class="comment" id="2501817">//&nbsp;Size.</span><br>
<span class="lineno"></span><span class="op" id="2501826">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2501829">type</span>&nbsp;<span class="ident" id="2501834">SysProcAttr</span>&nbsp;<span class="keyword" id="2501846">struct</span>&nbsp;<span class="op" id="2501853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2501856">Chroot</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2501868">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2501883">//&nbsp;Chroot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2501895">Credential</span>&nbsp;&nbsp;<span class="op" id="2501907">*</span><span class="ident" id="2501908">Credential</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2501922">//&nbsp;Credential.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2501938">Ptrace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2501950">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2501965">//&nbsp;Enable&nbsp;tracing.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2501985">Setsid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2501997">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2502012">//&nbsp;Create&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2502032">Setpgid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2502044">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2502059">//&nbsp;Set&nbsp;process&nbsp;group&nbsp;ID&nbsp;to&nbsp;new&nbsp;pid&nbsp;(SYSV&nbsp;setpgrp)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2502110">Setctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2502122">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2502137">//&nbsp;Set&nbsp;controlling&nbsp;terminal&nbsp;to&nbsp;fd&nbsp;Ctty&nbsp;(only&nbsp;meaningful&nbsp;if&nbsp;Setsid&nbsp;is&nbsp;set)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2502212">Noctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2502224">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2502239">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;controlling&nbsp;terminal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2502281">Ctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2502293">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2502308">//&nbsp;Controlling&nbsp;TTY&nbsp;fd&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2502344">Pdeathsig</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2502356">Signal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2502371">//&nbsp;Signal&nbsp;that&nbsp;the&nbsp;process&nbsp;will&nbsp;get&nbsp;when&nbsp;its&nbsp;parent&nbsp;dies&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2502442">Cloneflags</span>&nbsp;&nbsp;<span class="builtintype" id="2502454">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2502469">//&nbsp;Flags&nbsp;for&nbsp;clone&nbsp;calls&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2502508">UidMappings</span>&nbsp;<span class="op" id="2502520">[</span><span class="op" id="2502521">]</span><span class="ident" id="2502522">SysProcIDMap</span>&nbsp;<span class="comment" id="2502535">//&nbsp;User&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2502577">GidMappings</span>&nbsp;<span class="op" id="2502589">[</span><span class="op" id="2502590">]</span><span class="ident" id="2502591">SysProcIDMap</span>&nbsp;<span class="comment" id="2502604">//&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span><span class="op" id="2502646">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="2502649">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2502684">func</span>&nbsp;<span class="ident" id="2502689">runtime_BeforeFork</span><span class="op" id="2502707">(</span><span class="op" id="2502708">)</span><br>
<span class="lineno"></span><span class="keyword" id="2502710">func</span>&nbsp;<span class="ident" id="2502715">runtime_AfterFork</span><span class="op" id="2502732">(</span><span class="op" id="2502733">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="2502736">//&nbsp;Fork,&nbsp;dup&nbsp;fd&nbsp;onto&nbsp;0..len(fd),&nbsp;and&nbsp;exec(argv0,&nbsp;argvv,&nbsp;envv)&nbsp;in&nbsp;child.</span><br>
<span class="lineno"></span><span class="comment" id="2502808">//&nbsp;If&nbsp;a&nbsp;dup&nbsp;or&nbsp;exec&nbsp;fails,&nbsp;write&nbsp;the&nbsp;errno&nbsp;error&nbsp;to&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="2502866">//&nbsp;(Pipe&nbsp;is&nbsp;close-on-exec&nbsp;so&nbsp;if&nbsp;exec&nbsp;succeeds,&nbsp;it&nbsp;will&nbsp;be&nbsp;closed.)</span><br>
<span class="lineno"></span><span class="comment" id="2502933">//&nbsp;In&nbsp;the&nbsp;child,&nbsp;this&nbsp;function&nbsp;must&nbsp;not&nbsp;acquire&nbsp;any&nbsp;locks,&nbsp;because</span><br>
<span class="lineno"></span><span class="comment" id="2503000">//&nbsp;they&nbsp;might&nbsp;have&nbsp;been&nbsp;locked&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;fork.&nbsp;&nbsp;This&nbsp;means</span><br>
<span class="lineno">45</span><span class="comment" id="2503068">//&nbsp;no&nbsp;rescheduling,&nbsp;no&nbsp;malloc&nbsp;calls,&nbsp;and&nbsp;no&nbsp;new&nbsp;stack&nbsp;segments.</span><br>
<span class="lineno"></span><span class="comment" id="2503132">//&nbsp;For&nbsp;the&nbsp;same&nbsp;reason&nbsp;compiler&nbsp;does&nbsp;not&nbsp;race&nbsp;instrument&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="2503193">//&nbsp;The&nbsp;calls&nbsp;to&nbsp;RawSyscall&nbsp;are&nbsp;okay&nbsp;because&nbsp;they&nbsp;are&nbsp;assembly</span><br>
<span class="lineno"></span><span class="comment" id="2503255">//&nbsp;functions&nbsp;that&nbsp;do&nbsp;not&nbsp;grow&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="2503296">func</span>&nbsp;<span class="ident" id="2503301">forkAndExecInChild</span><span class="op" id="2503319">(</span><span class="ident" id="2503320">argv0</span>&nbsp;<span class="op" id="2503326">*</span><span class="builtintype" id="2503327">byte</span><span class="op" id="2503331">,</span>&nbsp;<span class="ident" id="2503333">argv</span><span class="op" id="2503337">,</span>&nbsp;<span class="ident" id="2503339">envv</span>&nbsp;<span class="op" id="2503344">[</span><span class="op" id="2503345">]</span><span class="op" id="2503346">*</span><span class="builtintype" id="2503347">byte</span><span class="op" id="2503351">,</span>&nbsp;<span class="ident" id="2503353">chroot</span><span class="op" id="2503359">,</span>&nbsp;<span class="ident" id="2503361">dir</span>&nbsp;<span class="op" id="2503365">*</span><span class="builtintype" id="2503366">byte</span><span class="op" id="2503370">,</span>&nbsp;<span class="ident" id="2503372">attr</span>&nbsp;<span class="op" id="2503377">*</span><span class="ident" id="2503378">ProcAttr</span><span class="op" id="2503386">,</span>&nbsp;<span class="ident" id="2503388">sys</span>&nbsp;<span class="op" id="2503392">*</span><span class="ident" id="2503393">SysProcAttr</span><span class="op" id="2503404">,</span>&nbsp;<span class="ident" id="2503406">pipe</span>&nbsp;<span class="builtintype" id="2503411">int</span><span class="op" id="2503414">)</span>&nbsp;<span class="op" id="2503416">(</span><span class="ident" id="2503417">pid</span>&nbsp;<span class="builtintype" id="2503421">int</span><span class="op" id="2503424">,</span>&nbsp;<span class="ident" id="2503426">err</span>&nbsp;<span class="ident" id="2503430">Errno</span><span class="op" id="2503435">)</span>&nbsp;<span class="op" id="2503437">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2503440">//&nbsp;Declare&nbsp;all&nbsp;variables&nbsp;at&nbsp;top&nbsp;in&nbsp;case&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2503485">//&nbsp;declarations&nbsp;require&nbsp;heap&nbsp;allocation&nbsp;(e.g.,&nbsp;err1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2503540">var</span>&nbsp;<span class="op" id="2503544">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2503548">r1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2503555">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2503565">err1</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2503572">Errno</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2503580">err2</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2503587">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2503595">nextfd</span>&nbsp;<span class="builtintype" id="2503602">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2503608">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2503615">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2503621">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2503628">[</span><span class="num" id="2503629">2</span><span class="op" id="2503630">]</span><span class="builtintype" id="2503631">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2503636">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2503640">//&nbsp;Guard&nbsp;against&nbsp;side&nbsp;effects&nbsp;of&nbsp;shuffling&nbsp;fds&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2503695">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;nextfd&nbsp;is&nbsp;beyond&nbsp;any&nbsp;currently&nbsp;open&nbsp;files&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2503759">//&nbsp;that&nbsp;we&nbsp;can&#39;t&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;overwriting&nbsp;any&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2503818">fd</span>&nbsp;<span class="op" id="2503821">:=</span>&nbsp;<span class="builtinfunc" id="2503824">make</span><span class="op" id="2503828">(</span><span class="op" id="2503829">[</span><span class="op" id="2503830">]</span><span class="builtintype" id="2503831">int</span><span class="op" id="2503834">,</span>&nbsp;<span class="builtinfunc" id="2503836">len</span><span class="op" id="2503839">(</span><span class="ident" id="2503840">attr</span><span class="op" id="2503844">.</span><span class="ident" id="2503845">Files</span><span class="op" id="2503850">)</span><span class="op" id="2503851">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2503854">nextfd</span>&nbsp;<span class="op" id="2503861">=</span>&nbsp;<span class="builtinfunc" id="2503863">len</span><span class="op" id="2503866">(</span><span class="ident" id="2503867">attr</span><span class="op" id="2503871">.</span><span class="ident" id="2503872">Files</span><span class="op" id="2503877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2503880">for</span>&nbsp;<span class="ident" id="2503884">i</span><span class="op" id="2503885">,</span>&nbsp;<span class="ident" id="2503887">ufd</span>&nbsp;<span class="op" id="2503891">:=</span>&nbsp;<span class="keyword" id="2503894">range</span>&nbsp;<span class="ident" id="2503900">attr</span><span class="op" id="2503904">.</span><span class="ident" id="2503905">Files</span>&nbsp;<span class="op" id="2503911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2503915">if</span>&nbsp;<span class="ident" id="2503918">nextfd</span>&nbsp;<span class="op" id="2503925">&lt;</span>&nbsp;<span class="builtintype" id="2503927">int</span><span class="op" id="2503930">(</span><span class="ident" id="2503931">ufd</span><span class="op" id="2503934">)</span>&nbsp;<span class="op" id="2503936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2503941">nextfd</span>&nbsp;<span class="op" id="2503948">=</span>&nbsp;<span class="builtintype" id="2503950">int</span><span class="op" id="2503953">(</span><span class="ident" id="2503954">ufd</span><span class="op" id="2503957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2503961">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2503965">fd</span><span class="op" id="2503967">[</span><span class="ident" id="2503968">i</span><span class="op" id="2503969">]</span>&nbsp;<span class="op" id="2503971">=</span>&nbsp;<span class="builtintype" id="2503973">int</span><span class="op" id="2503976">(</span><span class="ident" id="2503977">ufd</span><span class="op" id="2503980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2503983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2503986">nextfd</span><span class="op" id="2503992">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2503997">//&nbsp;Allocate&nbsp;another&nbsp;pipe&nbsp;for&nbsp;parent&nbsp;to&nbsp;child&nbsp;communication&nbsp;for</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2504061">//&nbsp;synchronizing&nbsp;writing&nbsp;of&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2504117">if</span>&nbsp;<span class="ident" id="2504120">sys</span><span class="op" id="2504123">.</span><span class="ident" id="2504124">UidMappings</span>&nbsp;<span class="op" id="2504136">!=</span>&nbsp;<span class="ident" id="2504139">nil</span>&nbsp;<span class="op" id="2504143">||</span>&nbsp;<span class="ident" id="2504146">sys</span><span class="op" id="2504149">.</span><span class="ident" id="2504150">GidMappings</span>&nbsp;<span class="op" id="2504162">!=</span>&nbsp;<span class="ident" id="2504165">nil</span>&nbsp;<span class="op" id="2504169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2504173">if</span>&nbsp;<span class="ident" id="2504176">err</span>&nbsp;<span class="op" id="2504180">:=</span>&nbsp;<span class="ident" id="2504183">forkExecPipe</span><span class="op" id="2504195">(</span><span class="ident" id="2504196">p</span><span class="op" id="2504197">[</span><span class="op" id="2504198">:</span><span class="op" id="2504199">]</span><span class="op" id="2504200">)</span><span class="op" id="2504201">;</span>&nbsp;<span class="ident" id="2504203">err</span>&nbsp;<span class="op" id="2504207">!=</span>&nbsp;<span class="ident" id="2504210">nil</span>&nbsp;<span class="op" id="2504214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2504219">return</span>&nbsp;<span class="num" id="2504226">0</span><span class="op" id="2504227">,</span>&nbsp;<span class="ident" id="2504229">err</span><span class="op" id="2504232">.</span><span class="op" id="2504233">(</span><span class="ident" id="2504234">Errno</span><span class="op" id="2504239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2504243">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2504246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2504250">//&nbsp;About&nbsp;to&nbsp;call&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2504274">//&nbsp;No&nbsp;more&nbsp;allocation&nbsp;or&nbsp;calls&nbsp;of&nbsp;non-assembly&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2504333">runtime_BeforeFork</span><span class="op" id="2504351">(</span><span class="op" id="2504352">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2504355">r1</span><span class="op" id="2504357">,</span>&nbsp;<span class="ident" id="2504359">_</span><span class="op" id="2504360">,</span>&nbsp;<span class="ident" id="2504362">err1</span>&nbsp;<span class="op" id="2504367">=</span>&nbsp;<span class="ident" id="2504369">RawSyscall6</span><span class="op" id="2504380">(</span><span class="ident" id="2504381">SYS_CLONE</span><span class="op" id="2504390">,</span>&nbsp;<span class="builtintype" id="2504392">uintptr</span><span class="op" id="2504399">(</span><span class="ident" id="2504400">SIGCHLD</span><span class="op" id="2504407">)</span><span class="op" id="2504408">|</span><span class="ident" id="2504409">sys</span><span class="op" id="2504412">.</span><span class="ident" id="2504413">Cloneflags</span><span class="op" id="2504423">,</span>&nbsp;<span class="num" id="2504425">0</span><span class="op" id="2504426">,</span>&nbsp;<span class="num" id="2504428">0</span><span class="op" id="2504429">,</span>&nbsp;<span class="num" id="2504431">0</span><span class="op" id="2504432">,</span>&nbsp;<span class="num" id="2504434">0</span><span class="op" id="2504435">,</span>&nbsp;<span class="num" id="2504437">0</span><span class="op" id="2504438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2504441">if</span>&nbsp;<span class="ident" id="2504444">err1</span>&nbsp;<span class="op" id="2504449">!=</span>&nbsp;<span class="num" id="2504452">0</span>&nbsp;<span class="op" id="2504454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2504458">runtime_AfterFork</span><span class="op" id="2504475">(</span><span class="op" id="2504476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2504480">return</span>&nbsp;<span class="num" id="2504487">0</span><span class="op" id="2504488">,</span>&nbsp;<span class="ident" id="2504490">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2504496">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2504500">if</span>&nbsp;<span class="ident" id="2504503">r1</span>&nbsp;<span class="op" id="2504506">!=</span>&nbsp;<span class="num" id="2504509">0</span>&nbsp;<span class="op" id="2504511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2504515">//&nbsp;parent;&nbsp;return&nbsp;PID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2504539">runtime_AfterFork</span><span class="op" id="2504556">(</span><span class="op" id="2504557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2504561">pid</span>&nbsp;<span class="op" id="2504565">=</span>&nbsp;<span class="builtintype" id="2504567">int</span><span class="op" id="2504570">(</span><span class="ident" id="2504571">r1</span><span class="op" id="2504573">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2504578">if</span>&nbsp;<span class="ident" id="2504581">sys</span><span class="op" id="2504584">.</span><span class="ident" id="2504585">UidMappings</span>&nbsp;<span class="op" id="2504597">!=</span>&nbsp;<span class="ident" id="2504600">nil</span>&nbsp;<span class="op" id="2504604">||</span>&nbsp;<span class="ident" id="2504607">sys</span><span class="op" id="2504610">.</span><span class="ident" id="2504611">GidMappings</span>&nbsp;<span class="op" id="2504623">!=</span>&nbsp;<span class="ident" id="2504626">nil</span>&nbsp;<span class="op" id="2504630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2504635">Close</span><span class="op" id="2504640">(</span><span class="ident" id="2504641">p</span><span class="op" id="2504642">[</span><span class="num" id="2504643">0</span><span class="op" id="2504644">]</span><span class="op" id="2504645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2504650">err</span>&nbsp;<span class="op" id="2504654">:=</span>&nbsp;<span class="ident" id="2504657">writeUidGidMappings</span><span class="op" id="2504676">(</span><span class="ident" id="2504677">pid</span><span class="op" id="2504680">,</span>&nbsp;<span class="ident" id="2504682">sys</span><span class="op" id="2504685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2504690">if</span>&nbsp;<span class="ident" id="2504693">err</span>&nbsp;<span class="op" id="2504697">!=</span>&nbsp;<span class="ident" id="2504700">nil</span>&nbsp;<span class="op" id="2504704">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2504710">err2</span>&nbsp;<span class="op" id="2504715">=</span>&nbsp;<span class="ident" id="2504717">err</span><span class="op" id="2504720">.</span><span class="op" id="2504721">(</span><span class="ident" id="2504722">Errno</span><span class="op" id="2504727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2504732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2504737">RawSyscall</span><span class="op" id="2504747">(</span><span class="ident" id="2504748">SYS_WRITE</span><span class="op" id="2504757">,</span>&nbsp;<span class="builtintype" id="2504759">uintptr</span><span class="op" id="2504766">(</span><span class="ident" id="2504767">p</span><span class="op" id="2504768">[</span><span class="num" id="2504769">1</span><span class="op" id="2504770">]</span><span class="op" id="2504771">)</span><span class="op" id="2504772">,</span>&nbsp;<span class="builtintype" id="2504774">uintptr</span><span class="op" id="2504781">(</span><span class="ident" id="2504782">unsafe</span><span class="op" id="2504788">.</span><span class="ident" id="2504789">Pointer</span><span class="op" id="2504796">(</span><span class="op" id="2504797">&amp;</span><span class="ident" id="2504798">err2</span><span class="op" id="2504802">)</span><span class="op" id="2504803">)</span><span class="op" id="2504804">,</span>&nbsp;<span class="ident" id="2504806">unsafe</span><span class="op" id="2504812">.</span><span class="ident" id="2504813">Sizeof</span><span class="op" id="2504819">(</span><span class="ident" id="2504820">err2</span><span class="op" id="2504824">)</span><span class="op" id="2504825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2504830">Close</span><span class="op" id="2504835">(</span><span class="ident" id="2504836">p</span><span class="op" id="2504837">[</span><span class="num" id="2504838">1</span><span class="op" id="2504839">]</span><span class="op" id="2504840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2504844">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2504849">return</span>&nbsp;<span class="ident" id="2504856">pid</span><span class="op" id="2504859">,</span>&nbsp;<span class="num" id="2504861">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2504864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2504868">//&nbsp;Fork&nbsp;succeeded,&nbsp;now&nbsp;in&nbsp;child.</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2504903">//&nbsp;Wait&nbsp;for&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;be&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2504957">if</span>&nbsp;<span class="ident" id="2504960">sys</span><span class="op" id="2504963">.</span><span class="ident" id="2504964">UidMappings</span>&nbsp;<span class="op" id="2504976">!=</span>&nbsp;<span class="ident" id="2504979">nil</span>&nbsp;<span class="op" id="2504983">||</span>&nbsp;<span class="ident" id="2504986">sys</span><span class="op" id="2504989">.</span><span class="ident" id="2504990">GidMappings</span>&nbsp;<span class="op" id="2505002">!=</span>&nbsp;<span class="ident" id="2505005">nil</span>&nbsp;<span class="op" id="2505009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505013">if</span>&nbsp;<span class="ident" id="2505016">_</span><span class="op" id="2505017">,</span>&nbsp;<span class="ident" id="2505019">_</span><span class="op" id="2505020">,</span>&nbsp;<span class="ident" id="2505022">err1</span>&nbsp;<span class="op" id="2505027">=</span>&nbsp;<span class="ident" id="2505029">RawSyscall</span><span class="op" id="2505039">(</span><span class="ident" id="2505040">SYS_CLOSE</span><span class="op" id="2505049">,</span>&nbsp;<span class="builtintype" id="2505051">uintptr</span><span class="op" id="2505058">(</span><span class="ident" id="2505059">p</span><span class="op" id="2505060">[</span><span class="num" id="2505061">1</span><span class="op" id="2505062">]</span><span class="op" id="2505063">)</span><span class="op" id="2505064">,</span>&nbsp;<span class="num" id="2505066">0</span><span class="op" id="2505067">,</span>&nbsp;<span class="num" id="2505069">0</span><span class="op" id="2505070">)</span><span class="op" id="2505071">;</span>&nbsp;<span class="ident" id="2505073">err1</span>&nbsp;<span class="op" id="2505078">!=</span>&nbsp;<span class="num" id="2505081">0</span>&nbsp;<span class="op" id="2505083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505088">goto</span>&nbsp;<span class="ident" id="2505093">childerror</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2505106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2505110">r1</span><span class="op" id="2505112">,</span>&nbsp;<span class="ident" id="2505114">_</span><span class="op" id="2505115">,</span>&nbsp;<span class="ident" id="2505117">err1</span>&nbsp;<span class="op" id="2505122">=</span>&nbsp;<span class="ident" id="2505124">RawSyscall</span><span class="op" id="2505134">(</span><span class="ident" id="2505135">SYS_READ</span><span class="op" id="2505143">,</span>&nbsp;<span class="builtintype" id="2505145">uintptr</span><span class="op" id="2505152">(</span><span class="ident" id="2505153">p</span><span class="op" id="2505154">[</span><span class="num" id="2505155">0</span><span class="op" id="2505156">]</span><span class="op" id="2505157">)</span><span class="op" id="2505158">,</span>&nbsp;<span class="builtintype" id="2505160">uintptr</span><span class="op" id="2505167">(</span><span class="ident" id="2505168">unsafe</span><span class="op" id="2505174">.</span><span class="ident" id="2505175">Pointer</span><span class="op" id="2505182">(</span><span class="op" id="2505183">&amp;</span><span class="ident" id="2505184">err2</span><span class="op" id="2505188">)</span><span class="op" id="2505189">)</span><span class="op" id="2505190">,</span>&nbsp;<span class="ident" id="2505192">unsafe</span><span class="op" id="2505198">.</span><span class="ident" id="2505199">Sizeof</span><span class="op" id="2505205">(</span><span class="ident" id="2505206">err2</span><span class="op" id="2505210">)</span><span class="op" id="2505211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505215">if</span>&nbsp;<span class="ident" id="2505218">err1</span>&nbsp;<span class="op" id="2505223">!=</span>&nbsp;<span class="num" id="2505226">0</span>&nbsp;<span class="op" id="2505228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505233">goto</span>&nbsp;<span class="ident" id="2505238">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2505251">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505255">if</span>&nbsp;<span class="ident" id="2505258">r1</span>&nbsp;<span class="op" id="2505261">!=</span>&nbsp;<span class="ident" id="2505264">unsafe</span><span class="op" id="2505270">.</span><span class="ident" id="2505271">Sizeof</span><span class="op" id="2505277">(</span><span class="ident" id="2505278">err2</span><span class="op" id="2505282">)</span>&nbsp;<span class="op" id="2505284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2505289">err1</span>&nbsp;<span class="op" id="2505294">=</span>&nbsp;<span class="ident" id="2505296">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505306">goto</span>&nbsp;<span class="ident" id="2505311">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2505324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505328">if</span>&nbsp;<span class="ident" id="2505331">err2</span>&nbsp;<span class="op" id="2505336">!=</span>&nbsp;<span class="num" id="2505339">0</span>&nbsp;<span class="op" id="2505341">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2505346">err1</span>&nbsp;<span class="op" id="2505351">=</span>&nbsp;<span class="ident" id="2505353">err2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505361">goto</span>&nbsp;<span class="ident" id="2505366">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2505379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2505382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2505386">//&nbsp;Parent&nbsp;death&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505410">if</span>&nbsp;<span class="ident" id="2505413">sys</span><span class="op" id="2505416">.</span><span class="ident" id="2505417">Pdeathsig</span>&nbsp;<span class="op" id="2505427">!=</span>&nbsp;<span class="num" id="2505430">0</span>&nbsp;<span class="op" id="2505432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2505436">_</span><span class="op" id="2505437">,</span>&nbsp;<span class="ident" id="2505439">_</span><span class="op" id="2505440">,</span>&nbsp;<span class="ident" id="2505442">err1</span>&nbsp;<span class="op" id="2505447">=</span>&nbsp;<span class="ident" id="2505449">RawSyscall6</span><span class="op" id="2505460">(</span><span class="ident" id="2505461">SYS_PRCTL</span><span class="op" id="2505470">,</span>&nbsp;<span class="ident" id="2505472">PR_SET_PDEATHSIG</span><span class="op" id="2505488">,</span>&nbsp;<span class="builtintype" id="2505490">uintptr</span><span class="op" id="2505497">(</span><span class="ident" id="2505498">sys</span><span class="op" id="2505501">.</span><span class="ident" id="2505502">Pdeathsig</span><span class="op" id="2505511">)</span><span class="op" id="2505512">,</span>&nbsp;<span class="num" id="2505514">0</span><span class="op" id="2505515">,</span>&nbsp;<span class="num" id="2505517">0</span><span class="op" id="2505518">,</span>&nbsp;<span class="num" id="2505520">0</span><span class="op" id="2505521">,</span>&nbsp;<span class="num" id="2505523">0</span><span class="op" id="2505524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505528">if</span>&nbsp;<span class="ident" id="2505531">err1</span>&nbsp;<span class="op" id="2505536">!=</span>&nbsp;<span class="num" id="2505539">0</span>&nbsp;<span class="op" id="2505541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505546">goto</span>&nbsp;<span class="ident" id="2505551">childerror</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2505564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2505569">//&nbsp;Signal&nbsp;self&nbsp;if&nbsp;parent&nbsp;is&nbsp;already&nbsp;dead.&nbsp;This&nbsp;might&nbsp;cause&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2505632">//&nbsp;duplicate&nbsp;signal&nbsp;in&nbsp;rare&nbsp;cases,&nbsp;but&nbsp;it&nbsp;won&#39;t&nbsp;matter&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2505694">//&nbsp;using&nbsp;SIGKILL.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2505714">r1</span><span class="op" id="2505716">,</span>&nbsp;<span class="ident" id="2505718">_</span><span class="op" id="2505719">,</span>&nbsp;<span class="ident" id="2505721">_</span>&nbsp;<span class="op" id="2505723">=</span>&nbsp;<span class="ident" id="2505725">RawSyscall</span><span class="op" id="2505735">(</span><span class="ident" id="2505736">SYS_GETPPID</span><span class="op" id="2505747">,</span>&nbsp;<span class="num" id="2505749">0</span><span class="op" id="2505750">,</span>&nbsp;<span class="num" id="2505752">0</span><span class="op" id="2505753">,</span>&nbsp;<span class="num" id="2505755">0</span><span class="op" id="2505756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505760">if</span>&nbsp;<span class="ident" id="2505763">r1</span>&nbsp;<span class="op" id="2505766">==</span>&nbsp;<span class="num" id="2505769">1</span>&nbsp;<span class="op" id="2505771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2505776">pid</span><span class="op" id="2505779">,</span>&nbsp;<span class="ident" id="2505781">_</span><span class="op" id="2505782">,</span>&nbsp;<span class="ident" id="2505784">_</span>&nbsp;<span class="op" id="2505786">:=</span>&nbsp;<span class="ident" id="2505789">RawSyscall</span><span class="op" id="2505799">(</span><span class="ident" id="2505800">SYS_GETPID</span><span class="op" id="2505810">,</span>&nbsp;<span class="num" id="2505812">0</span><span class="op" id="2505813">,</span>&nbsp;<span class="num" id="2505815">0</span><span class="op" id="2505816">,</span>&nbsp;<span class="num" id="2505818">0</span><span class="op" id="2505819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2505824">_</span><span class="op" id="2505825">,</span>&nbsp;<span class="ident" id="2505827">_</span><span class="op" id="2505828">,</span>&nbsp;<span class="ident" id="2505830">err1</span>&nbsp;<span class="op" id="2505835">:=</span>&nbsp;<span class="ident" id="2505838">RawSyscall</span><span class="op" id="2505848">(</span><span class="ident" id="2505849">SYS_KILL</span><span class="op" id="2505857">,</span>&nbsp;<span class="ident" id="2505859">pid</span><span class="op" id="2505862">,</span>&nbsp;<span class="builtintype" id="2505864">uintptr</span><span class="op" id="2505871">(</span><span class="ident" id="2505872">sys</span><span class="op" id="2505875">.</span><span class="ident" id="2505876">Pdeathsig</span><span class="op" id="2505885">)</span><span class="op" id="2505886">,</span>&nbsp;<span class="num" id="2505888">0</span><span class="op" id="2505889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505894">if</span>&nbsp;<span class="ident" id="2505897">err1</span>&nbsp;<span class="op" id="2505902">!=</span>&nbsp;<span class="num" id="2505905">0</span>&nbsp;<span class="op" id="2505907">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505913">goto</span>&nbsp;<span class="ident" id="2505918">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2505932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2505936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2505939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2505943">//&nbsp;Enable&nbsp;tracing&nbsp;if&nbsp;requested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2505976">if</span>&nbsp;<span class="ident" id="2505979">sys</span><span class="op" id="2505982">.</span><span class="ident" id="2505983">Ptrace</span>&nbsp;<span class="op" id="2505990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2505994">_</span><span class="op" id="2505995">,</span>&nbsp;<span class="ident" id="2505997">_</span><span class="op" id="2505998">,</span>&nbsp;<span class="ident" id="2506000">err1</span>&nbsp;<span class="op" id="2506005">=</span>&nbsp;<span class="ident" id="2506007">RawSyscall</span><span class="op" id="2506017">(</span><span class="ident" id="2506018">SYS_PTRACE</span><span class="op" id="2506028">,</span>&nbsp;<span class="builtintype" id="2506030">uintptr</span><span class="op" id="2506037">(</span><span class="ident" id="2506038">PTRACE_TRACEME</span><span class="op" id="2506052">)</span><span class="op" id="2506053">,</span>&nbsp;<span class="num" id="2506055">0</span><span class="op" id="2506056">,</span>&nbsp;<span class="num" id="2506058">0</span><span class="op" id="2506059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506063">if</span>&nbsp;<span class="ident" id="2506066">err1</span>&nbsp;<span class="op" id="2506071">!=</span>&nbsp;<span class="num" id="2506074">0</span>&nbsp;<span class="op" id="2506076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506081">goto</span>&nbsp;<span class="ident" id="2506086">childerror</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2506099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2506102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2506106">//&nbsp;Session&nbsp;ID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506121">if</span>&nbsp;<span class="ident" id="2506124">sys</span><span class="op" id="2506127">.</span><span class="ident" id="2506128">Setsid</span>&nbsp;<span class="op" id="2506135">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2506139">_</span><span class="op" id="2506140">,</span>&nbsp;<span class="ident" id="2506142">_</span><span class="op" id="2506143">,</span>&nbsp;<span class="ident" id="2506145">err1</span>&nbsp;<span class="op" id="2506150">=</span>&nbsp;<span class="ident" id="2506152">RawSyscall</span><span class="op" id="2506162">(</span><span class="ident" id="2506163">SYS_SETSID</span><span class="op" id="2506173">,</span>&nbsp;<span class="num" id="2506175">0</span><span class="op" id="2506176">,</span>&nbsp;<span class="num" id="2506178">0</span><span class="op" id="2506179">,</span>&nbsp;<span class="num" id="2506181">0</span><span class="op" id="2506182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506186">if</span>&nbsp;<span class="ident" id="2506189">err1</span>&nbsp;<span class="op" id="2506194">!=</span>&nbsp;<span class="num" id="2506197">0</span>&nbsp;<span class="op" id="2506199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506204">goto</span>&nbsp;<span class="ident" id="2506209">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2506222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2506225">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2506229">//&nbsp;Set&nbsp;process&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506251">if</span>&nbsp;<span class="ident" id="2506254">sys</span><span class="op" id="2506257">.</span><span class="ident" id="2506258">Setpgid</span>&nbsp;<span class="op" id="2506266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2506270">_</span><span class="op" id="2506271">,</span>&nbsp;<span class="ident" id="2506273">_</span><span class="op" id="2506274">,</span>&nbsp;<span class="ident" id="2506276">err1</span>&nbsp;<span class="op" id="2506281">=</span>&nbsp;<span class="ident" id="2506283">RawSyscall</span><span class="op" id="2506293">(</span><span class="ident" id="2506294">SYS_SETPGID</span><span class="op" id="2506305">,</span>&nbsp;<span class="num" id="2506307">0</span><span class="op" id="2506308">,</span>&nbsp;<span class="num" id="2506310">0</span><span class="op" id="2506311">,</span>&nbsp;<span class="num" id="2506313">0</span><span class="op" id="2506314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506318">if</span>&nbsp;<span class="ident" id="2506321">err1</span>&nbsp;<span class="op" id="2506326">!=</span>&nbsp;<span class="num" id="2506329">0</span>&nbsp;<span class="op" id="2506331">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506336">goto</span>&nbsp;<span class="ident" id="2506341">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2506354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2506357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2506361">//&nbsp;Chroot</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506372">if</span>&nbsp;<span class="ident" id="2506375">chroot</span>&nbsp;<span class="op" id="2506382">!=</span>&nbsp;<span class="ident" id="2506385">nil</span>&nbsp;<span class="op" id="2506389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2506393">_</span><span class="op" id="2506394">,</span>&nbsp;<span class="ident" id="2506396">_</span><span class="op" id="2506397">,</span>&nbsp;<span class="ident" id="2506399">err1</span>&nbsp;<span class="op" id="2506404">=</span>&nbsp;<span class="ident" id="2506406">RawSyscall</span><span class="op" id="2506416">(</span><span class="ident" id="2506417">SYS_CHROOT</span><span class="op" id="2506427">,</span>&nbsp;<span class="builtintype" id="2506429">uintptr</span><span class="op" id="2506436">(</span><span class="ident" id="2506437">unsafe</span><span class="op" id="2506443">.</span><span class="ident" id="2506444">Pointer</span><span class="op" id="2506451">(</span><span class="ident" id="2506452">chroot</span><span class="op" id="2506458">)</span><span class="op" id="2506459">)</span><span class="op" id="2506460">,</span>&nbsp;<span class="num" id="2506462">0</span><span class="op" id="2506463">,</span>&nbsp;<span class="num" id="2506465">0</span><span class="op" id="2506466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506470">if</span>&nbsp;<span class="ident" id="2506473">err1</span>&nbsp;<span class="op" id="2506478">!=</span>&nbsp;<span class="num" id="2506481">0</span>&nbsp;<span class="op" id="2506483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506488">goto</span>&nbsp;<span class="ident" id="2506493">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2506506">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2506509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2506513">//&nbsp;User&nbsp;and&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506533">if</span>&nbsp;<span class="ident" id="2506536">cred</span>&nbsp;<span class="op" id="2506541">:=</span>&nbsp;<span class="ident" id="2506544">sys</span><span class="op" id="2506547">.</span><span class="ident" id="2506548">Credential</span><span class="op" id="2506558">;</span>&nbsp;<span class="ident" id="2506560">cred</span>&nbsp;<span class="op" id="2506565">!=</span>&nbsp;<span class="ident" id="2506568">nil</span>&nbsp;<span class="op" id="2506572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2506576">ngroups</span>&nbsp;<span class="op" id="2506584">:=</span>&nbsp;<span class="builtintype" id="2506587">uintptr</span><span class="op" id="2506594">(</span><span class="builtinfunc" id="2506595">len</span><span class="op" id="2506598">(</span><span class="ident" id="2506599">cred</span><span class="op" id="2506603">.</span><span class="ident" id="2506604">Groups</span><span class="op" id="2506610">)</span><span class="op" id="2506611">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506615">var</span>&nbsp;<span class="ident" id="2506619">groups</span>&nbsp;<span class="ident" id="2506626">unsafe</span><span class="op" id="2506632">.</span><span class="ident" id="2506633">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506643">if</span>&nbsp;<span class="ident" id="2506646">ngroups</span>&nbsp;<span class="op" id="2506654">&gt;</span>&nbsp;<span class="num" id="2506656">0</span>&nbsp;<span class="op" id="2506658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2506663">groups</span>&nbsp;<span class="op" id="2506670">=</span>&nbsp;<span class="ident" id="2506672">unsafe</span><span class="op" id="2506678">.</span><span class="ident" id="2506679">Pointer</span><span class="op" id="2506686">(</span><span class="op" id="2506687">&amp;</span><span class="ident" id="2506688">cred</span><span class="op" id="2506692">.</span><span class="ident" id="2506693">Groups</span><span class="op" id="2506699">[</span><span class="num" id="2506700">0</span><span class="op" id="2506701">]</span><span class="op" id="2506702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2506706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2506710">_</span><span class="op" id="2506711">,</span>&nbsp;<span class="ident" id="2506713">_</span><span class="op" id="2506714">,</span>&nbsp;<span class="ident" id="2506716">err1</span>&nbsp;<span class="op" id="2506721">=</span>&nbsp;<span class="ident" id="2506723">RawSyscall</span><span class="op" id="2506733">(</span><span class="ident" id="2506734">SYS_SETGROUPS</span><span class="op" id="2506747">,</span>&nbsp;<span class="ident" id="2506749">ngroups</span><span class="op" id="2506756">,</span>&nbsp;<span class="builtintype" id="2506758">uintptr</span><span class="op" id="2506765">(</span><span class="ident" id="2506766">groups</span><span class="op" id="2506772">)</span><span class="op" id="2506773">,</span>&nbsp;<span class="num" id="2506775">0</span><span class="op" id="2506776">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506780">if</span>&nbsp;<span class="ident" id="2506783">err1</span>&nbsp;<span class="op" id="2506788">!=</span>&nbsp;<span class="num" id="2506791">0</span>&nbsp;<span class="op" id="2506793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506798">goto</span>&nbsp;<span class="ident" id="2506803">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2506816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2506820">_</span><span class="op" id="2506821">,</span>&nbsp;<span class="ident" id="2506823">_</span><span class="op" id="2506824">,</span>&nbsp;<span class="ident" id="2506826">err1</span>&nbsp;<span class="op" id="2506831">=</span>&nbsp;<span class="ident" id="2506833">RawSyscall</span><span class="op" id="2506843">(</span><span class="ident" id="2506844">SYS_SETGID</span><span class="op" id="2506854">,</span>&nbsp;<span class="builtintype" id="2506856">uintptr</span><span class="op" id="2506863">(</span><span class="ident" id="2506864">cred</span><span class="op" id="2506868">.</span><span class="ident" id="2506869">Gid</span><span class="op" id="2506872">)</span><span class="op" id="2506873">,</span>&nbsp;<span class="num" id="2506875">0</span><span class="op" id="2506876">,</span>&nbsp;<span class="num" id="2506878">0</span><span class="op" id="2506879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506883">if</span>&nbsp;<span class="ident" id="2506886">err1</span>&nbsp;<span class="op" id="2506891">!=</span>&nbsp;<span class="num" id="2506894">0</span>&nbsp;<span class="op" id="2506896">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506901">goto</span>&nbsp;<span class="ident" id="2506906">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2506919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2506923">_</span><span class="op" id="2506924">,</span>&nbsp;<span class="ident" id="2506926">_</span><span class="op" id="2506927">,</span>&nbsp;<span class="ident" id="2506929">err1</span>&nbsp;<span class="op" id="2506934">=</span>&nbsp;<span class="ident" id="2506936">RawSyscall</span><span class="op" id="2506946">(</span><span class="ident" id="2506947">SYS_SETUID</span><span class="op" id="2506957">,</span>&nbsp;<span class="builtintype" id="2506959">uintptr</span><span class="op" id="2506966">(</span><span class="ident" id="2506967">cred</span><span class="op" id="2506971">.</span><span class="ident" id="2506972">Uid</span><span class="op" id="2506975">)</span><span class="op" id="2506976">,</span>&nbsp;<span class="num" id="2506978">0</span><span class="op" id="2506979">,</span>&nbsp;<span class="num" id="2506981">0</span><span class="op" id="2506982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2506986">if</span>&nbsp;<span class="ident" id="2506989">err1</span>&nbsp;<span class="op" id="2506994">!=</span>&nbsp;<span class="num" id="2506997">0</span>&nbsp;<span class="op" id="2506999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507004">goto</span>&nbsp;<span class="ident" id="2507009">childerror</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2507022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2507025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2507029">//&nbsp;Chdir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507039">if</span>&nbsp;<span class="ident" id="2507042">dir</span>&nbsp;<span class="op" id="2507046">!=</span>&nbsp;<span class="ident" id="2507049">nil</span>&nbsp;<span class="op" id="2507053">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2507057">_</span><span class="op" id="2507058">,</span>&nbsp;<span class="ident" id="2507060">_</span><span class="op" id="2507061">,</span>&nbsp;<span class="ident" id="2507063">err1</span>&nbsp;<span class="op" id="2507068">=</span>&nbsp;<span class="ident" id="2507070">RawSyscall</span><span class="op" id="2507080">(</span><span class="ident" id="2507081">SYS_CHDIR</span><span class="op" id="2507090">,</span>&nbsp;<span class="builtintype" id="2507092">uintptr</span><span class="op" id="2507099">(</span><span class="ident" id="2507100">unsafe</span><span class="op" id="2507106">.</span><span class="ident" id="2507107">Pointer</span><span class="op" id="2507114">(</span><span class="ident" id="2507115">dir</span><span class="op" id="2507118">)</span><span class="op" id="2507119">)</span><span class="op" id="2507120">,</span>&nbsp;<span class="num" id="2507122">0</span><span class="op" id="2507123">,</span>&nbsp;<span class="num" id="2507125">0</span><span class="op" id="2507126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507130">if</span>&nbsp;<span class="ident" id="2507133">err1</span>&nbsp;<span class="op" id="2507138">!=</span>&nbsp;<span class="num" id="2507141">0</span>&nbsp;<span class="op" id="2507143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507148">goto</span>&nbsp;<span class="ident" id="2507153">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2507166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2507169">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2507173">//&nbsp;Pass&nbsp;1:&nbsp;look&nbsp;for&nbsp;fd[i]&nbsp;&lt;&nbsp;i&nbsp;and&nbsp;move&nbsp;those&nbsp;up&nbsp;above&nbsp;len(fd)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2507236">//&nbsp;so&nbsp;that&nbsp;pass&nbsp;2&nbsp;won&#39;t&nbsp;stomp&nbsp;on&nbsp;an&nbsp;fd&nbsp;it&nbsp;needs&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507292">if</span>&nbsp;<span class="ident" id="2507295">pipe</span>&nbsp;<span class="op" id="2507300">&lt;</span>&nbsp;<span class="ident" id="2507302">nextfd</span>&nbsp;<span class="op" id="2507309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2507313">_</span><span class="op" id="2507314">,</span>&nbsp;<span class="ident" id="2507316">_</span><span class="op" id="2507317">,</span>&nbsp;<span class="ident" id="2507319">err1</span>&nbsp;<span class="op" id="2507324">=</span>&nbsp;<span class="ident" id="2507326">RawSyscall</span><span class="op" id="2507336">(</span><span class="ident" id="2507337">SYS_DUP2</span><span class="op" id="2507345">,</span>&nbsp;<span class="builtintype" id="2507347">uintptr</span><span class="op" id="2507354">(</span><span class="ident" id="2507355">pipe</span><span class="op" id="2507359">)</span><span class="op" id="2507360">,</span>&nbsp;<span class="builtintype" id="2507362">uintptr</span><span class="op" id="2507369">(</span><span class="ident" id="2507370">nextfd</span><span class="op" id="2507376">)</span><span class="op" id="2507377">,</span>&nbsp;<span class="num" id="2507379">0</span><span class="op" id="2507380">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507384">if</span>&nbsp;<span class="ident" id="2507387">err1</span>&nbsp;<span class="op" id="2507392">!=</span>&nbsp;<span class="num" id="2507395">0</span>&nbsp;<span class="op" id="2507397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507402">goto</span>&nbsp;<span class="ident" id="2507407">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2507420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2507424">RawSyscall</span><span class="op" id="2507434">(</span><span class="ident" id="2507435">SYS_FCNTL</span><span class="op" id="2507444">,</span>&nbsp;<span class="builtintype" id="2507446">uintptr</span><span class="op" id="2507453">(</span><span class="ident" id="2507454">nextfd</span><span class="op" id="2507460">)</span><span class="op" id="2507461">,</span>&nbsp;<span class="ident" id="2507463">F_SETFD</span><span class="op" id="2507470">,</span>&nbsp;<span class="ident" id="2507472">FD_CLOEXEC</span><span class="op" id="2507482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2507486">pipe</span>&nbsp;<span class="op" id="2507491">=</span>&nbsp;<span class="ident" id="2507493">nextfd</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2507502">nextfd</span><span class="op" id="2507508">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2507512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507515">for</span>&nbsp;<span class="ident" id="2507519">i</span>&nbsp;<span class="op" id="2507521">=</span>&nbsp;<span class="num" id="2507523">0</span><span class="op" id="2507524">;</span>&nbsp;<span class="ident" id="2507526">i</span>&nbsp;<span class="op" id="2507528">&lt;</span>&nbsp;<span class="builtinfunc" id="2507530">len</span><span class="op" id="2507533">(</span><span class="ident" id="2507534">fd</span><span class="op" id="2507536">)</span><span class="op" id="2507537">;</span>&nbsp;<span class="ident" id="2507539">i</span><span class="op" id="2507540">++</span>&nbsp;<span class="op" id="2507543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507547">if</span>&nbsp;<span class="ident" id="2507550">fd</span><span class="op" id="2507552">[</span><span class="ident" id="2507553">i</span><span class="op" id="2507554">]</span>&nbsp;<span class="op" id="2507556">&gt;=</span>&nbsp;<span class="num" id="2507559">0</span>&nbsp;<span class="op" id="2507561">&amp;&amp;</span>&nbsp;<span class="ident" id="2507564">fd</span><span class="op" id="2507566">[</span><span class="ident" id="2507567">i</span><span class="op" id="2507568">]</span>&nbsp;<span class="op" id="2507570">&lt;</span>&nbsp;<span class="builtintype" id="2507572">int</span><span class="op" id="2507575">(</span><span class="ident" id="2507576">i</span><span class="op" id="2507577">)</span>&nbsp;<span class="op" id="2507579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2507584">_</span><span class="op" id="2507585">,</span>&nbsp;<span class="ident" id="2507587">_</span><span class="op" id="2507588">,</span>&nbsp;<span class="ident" id="2507590">err1</span>&nbsp;<span class="op" id="2507595">=</span>&nbsp;<span class="ident" id="2507597">RawSyscall</span><span class="op" id="2507607">(</span><span class="ident" id="2507608">SYS_DUP2</span><span class="op" id="2507616">,</span>&nbsp;<span class="builtintype" id="2507618">uintptr</span><span class="op" id="2507625">(</span><span class="ident" id="2507626">fd</span><span class="op" id="2507628">[</span><span class="ident" id="2507629">i</span><span class="op" id="2507630">]</span><span class="op" id="2507631">)</span><span class="op" id="2507632">,</span>&nbsp;<span class="builtintype" id="2507634">uintptr</span><span class="op" id="2507641">(</span><span class="ident" id="2507642">nextfd</span><span class="op" id="2507648">)</span><span class="op" id="2507649">,</span>&nbsp;<span class="num" id="2507651">0</span><span class="op" id="2507652">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507657">if</span>&nbsp;<span class="ident" id="2507660">err1</span>&nbsp;<span class="op" id="2507665">!=</span>&nbsp;<span class="num" id="2507668">0</span>&nbsp;<span class="op" id="2507670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507676">goto</span>&nbsp;<span class="ident" id="2507681">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2507695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2507700">RawSyscall</span><span class="op" id="2507710">(</span><span class="ident" id="2507711">SYS_FCNTL</span><span class="op" id="2507720">,</span>&nbsp;<span class="builtintype" id="2507722">uintptr</span><span class="op" id="2507729">(</span><span class="ident" id="2507730">nextfd</span><span class="op" id="2507736">)</span><span class="op" id="2507737">,</span>&nbsp;<span class="ident" id="2507739">F_SETFD</span><span class="op" id="2507746">,</span>&nbsp;<span class="ident" id="2507748">FD_CLOEXEC</span><span class="op" id="2507758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2507763">fd</span><span class="op" id="2507765">[</span><span class="ident" id="2507766">i</span><span class="op" id="2507767">]</span>&nbsp;<span class="op" id="2507769">=</span>&nbsp;<span class="ident" id="2507771">nextfd</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2507781">nextfd</span><span class="op" id="2507787">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507793">if</span>&nbsp;<span class="ident" id="2507796">nextfd</span>&nbsp;<span class="op" id="2507803">==</span>&nbsp;<span class="ident" id="2507806">pipe</span>&nbsp;<span class="op" id="2507811">{</span>&nbsp;<span class="comment" id="2507813">//&nbsp;don&#39;t&nbsp;stomp&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2507840">nextfd</span><span class="op" id="2507846">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2507852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2507856">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2507859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2507863">//&nbsp;Pass&nbsp;2:&nbsp;dup&nbsp;fd[i]&nbsp;down&nbsp;onto&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507898">for</span>&nbsp;<span class="ident" id="2507902">i</span>&nbsp;<span class="op" id="2507904">=</span>&nbsp;<span class="num" id="2507906">0</span><span class="op" id="2507907">;</span>&nbsp;<span class="ident" id="2507909">i</span>&nbsp;<span class="op" id="2507911">&lt;</span>&nbsp;<span class="builtinfunc" id="2507913">len</span><span class="op" id="2507916">(</span><span class="ident" id="2507917">fd</span><span class="op" id="2507919">)</span><span class="op" id="2507920">;</span>&nbsp;<span class="ident" id="2507922">i</span><span class="op" id="2507923">++</span>&nbsp;<span class="op" id="2507926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507930">if</span>&nbsp;<span class="ident" id="2507933">fd</span><span class="op" id="2507935">[</span><span class="ident" id="2507936">i</span><span class="op" id="2507937">]</span>&nbsp;<span class="op" id="2507939">==</span>&nbsp;<span class="op" id="2507942">-</span><span class="num" id="2507943">1</span>&nbsp;<span class="op" id="2507945">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2507950">RawSyscall</span><span class="op" id="2507960">(</span><span class="ident" id="2507961">SYS_CLOSE</span><span class="op" id="2507970">,</span>&nbsp;<span class="builtintype" id="2507972">uintptr</span><span class="op" id="2507979">(</span><span class="ident" id="2507980">i</span><span class="op" id="2507981">)</span><span class="op" id="2507982">,</span>&nbsp;<span class="num" id="2507984">0</span><span class="op" id="2507985">,</span>&nbsp;<span class="num" id="2507987">0</span><span class="op" id="2507988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2507993">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2508004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2508008">if</span>&nbsp;<span class="ident" id="2508011">fd</span><span class="op" id="2508013">[</span><span class="ident" id="2508014">i</span><span class="op" id="2508015">]</span>&nbsp;<span class="op" id="2508017">==</span>&nbsp;<span class="builtintype" id="2508020">int</span><span class="op" id="2508023">(</span><span class="ident" id="2508024">i</span><span class="op" id="2508025">)</span>&nbsp;<span class="op" id="2508027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2508032">//&nbsp;dup2(i,&nbsp;i)&nbsp;won&#39;t&nbsp;clear&nbsp;close-on-exec&nbsp;flag&nbsp;on&nbsp;Linux,</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2508090">//&nbsp;probably&nbsp;not&nbsp;elsewhere&nbsp;either.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2508127">_</span><span class="op" id="2508128">,</span>&nbsp;<span class="ident" id="2508130">_</span><span class="op" id="2508131">,</span>&nbsp;<span class="ident" id="2508133">err1</span>&nbsp;<span class="op" id="2508138">=</span>&nbsp;<span class="ident" id="2508140">RawSyscall</span><span class="op" id="2508150">(</span><span class="ident" id="2508151">SYS_FCNTL</span><span class="op" id="2508160">,</span>&nbsp;<span class="builtintype" id="2508162">uintptr</span><span class="op" id="2508169">(</span><span class="ident" id="2508170">fd</span><span class="op" id="2508172">[</span><span class="ident" id="2508173">i</span><span class="op" id="2508174">]</span><span class="op" id="2508175">)</span><span class="op" id="2508176">,</span>&nbsp;<span class="ident" id="2508178">F_SETFD</span><span class="op" id="2508185">,</span>&nbsp;<span class="num" id="2508187">0</span><span class="op" id="2508188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2508193">if</span>&nbsp;<span class="ident" id="2508196">err1</span>&nbsp;<span class="op" id="2508201">!=</span>&nbsp;<span class="num" id="2508204">0</span>&nbsp;<span class="op" id="2508206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2508212">goto</span>&nbsp;<span class="ident" id="2508217">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2508231">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2508236">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2508247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2508251">//&nbsp;The&nbsp;new&nbsp;fd&nbsp;is&nbsp;created&nbsp;NOT&nbsp;close-on-exec,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2508297">//&nbsp;which&nbsp;is&nbsp;exactly&nbsp;what&nbsp;we&nbsp;want.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2508333">_</span><span class="op" id="2508334">,</span>&nbsp;<span class="ident" id="2508336">_</span><span class="op" id="2508337">,</span>&nbsp;<span class="ident" id="2508339">err1</span>&nbsp;<span class="op" id="2508344">=</span>&nbsp;<span class="ident" id="2508346">RawSyscall</span><span class="op" id="2508356">(</span><span class="ident" id="2508357">SYS_DUP2</span><span class="op" id="2508365">,</span>&nbsp;<span class="builtintype" id="2508367">uintptr</span><span class="op" id="2508374">(</span><span class="ident" id="2508375">fd</span><span class="op" id="2508377">[</span><span class="ident" id="2508378">i</span><span class="op" id="2508379">]</span><span class="op" id="2508380">)</span><span class="op" id="2508381">,</span>&nbsp;<span class="builtintype" id="2508383">uintptr</span><span class="op" id="2508390">(</span><span class="ident" id="2508391">i</span><span class="op" id="2508392">)</span><span class="op" id="2508393">,</span>&nbsp;<span class="num" id="2508395">0</span><span class="op" id="2508396">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2508400">if</span>&nbsp;<span class="ident" id="2508403">err1</span>&nbsp;<span class="op" id="2508408">!=</span>&nbsp;<span class="num" id="2508411">0</span>&nbsp;<span class="op" id="2508413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2508418">goto</span>&nbsp;<span class="ident" id="2508423">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2508436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2508439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2508443">//&nbsp;By&nbsp;convention,&nbsp;we&nbsp;don&#39;t&nbsp;close-on-exec&nbsp;the&nbsp;fds&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2508500">//&nbsp;started&nbsp;with,&nbsp;so&nbsp;if&nbsp;len(fd)&nbsp;&lt;&nbsp;3,&nbsp;close&nbsp;0,&nbsp;1,&nbsp;2&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2508562">//&nbsp;Programs&nbsp;that&nbsp;know&nbsp;they&nbsp;inherit&nbsp;fds&nbsp;&gt;=&nbsp;3&nbsp;will&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2508617">//&nbsp;to&nbsp;set&nbsp;them&nbsp;close-on-exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2508648">for</span>&nbsp;<span class="ident" id="2508652">i</span>&nbsp;<span class="op" id="2508654">=</span>&nbsp;<span class="builtinfunc" id="2508656">len</span><span class="op" id="2508659">(</span><span class="ident" id="2508660">fd</span><span class="op" id="2508662">)</span><span class="op" id="2508663">;</span>&nbsp;<span class="ident" id="2508665">i</span>&nbsp;<span class="op" id="2508667">&lt;</span>&nbsp;<span class="num" id="2508669">3</span><span class="op" id="2508670">;</span>&nbsp;<span class="ident" id="2508672">i</span><span class="op" id="2508673">++</span>&nbsp;<span class="op" id="2508676">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2508680">RawSyscall</span><span class="op" id="2508690">(</span><span class="ident" id="2508691">SYS_CLOSE</span><span class="op" id="2508700">,</span>&nbsp;<span class="builtintype" id="2508702">uintptr</span><span class="op" id="2508709">(</span><span class="ident" id="2508710">i</span><span class="op" id="2508711">)</span><span class="op" id="2508712">,</span>&nbsp;<span class="num" id="2508714">0</span><span class="op" id="2508715">,</span>&nbsp;<span class="num" id="2508717">0</span><span class="op" id="2508718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2508721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2508725">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;tty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2508750">if</span>&nbsp;<span class="ident" id="2508753">sys</span><span class="op" id="2508756">.</span><span class="ident" id="2508757">Noctty</span>&nbsp;<span class="op" id="2508764">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2508768">_</span><span class="op" id="2508769">,</span>&nbsp;<span class="ident" id="2508771">_</span><span class="op" id="2508772">,</span>&nbsp;<span class="ident" id="2508774">err1</span>&nbsp;<span class="op" id="2508779">=</span>&nbsp;<span class="ident" id="2508781">RawSyscall</span><span class="op" id="2508791">(</span><span class="ident" id="2508792">SYS_IOCTL</span><span class="op" id="2508801">,</span>&nbsp;<span class="num" id="2508803">0</span><span class="op" id="2508804">,</span>&nbsp;<span class="builtintype" id="2508806">uintptr</span><span class="op" id="2508813">(</span><span class="ident" id="2508814">TIOCNOTTY</span><span class="op" id="2508823">)</span><span class="op" id="2508824">,</span>&nbsp;<span class="num" id="2508826">0</span><span class="op" id="2508827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2508831">if</span>&nbsp;<span class="ident" id="2508834">err1</span>&nbsp;<span class="op" id="2508839">!=</span>&nbsp;<span class="num" id="2508842">0</span>&nbsp;<span class="op" id="2508844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2508849">goto</span>&nbsp;<span class="ident" id="2508854">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2508867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2508870">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2508874">//&nbsp;Set&nbsp;the&nbsp;controlling&nbsp;TTY&nbsp;to&nbsp;Ctty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2508910">if</span>&nbsp;<span class="ident" id="2508913">sys</span><span class="op" id="2508916">.</span><span class="ident" id="2508917">Setctty</span>&nbsp;<span class="op" id="2508925">&amp;&amp;</span>&nbsp;<span class="ident" id="2508928">sys</span><span class="op" id="2508931">.</span><span class="ident" id="2508932">Ctty</span>&nbsp;<span class="op" id="2508937">&gt;=</span>&nbsp;<span class="num" id="2508940">0</span>&nbsp;<span class="op" id="2508942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2508946">_</span><span class="op" id="2508947">,</span>&nbsp;<span class="ident" id="2508949">_</span><span class="op" id="2508950">,</span>&nbsp;<span class="ident" id="2508952">err1</span>&nbsp;<span class="op" id="2508957">=</span>&nbsp;<span class="ident" id="2508959">RawSyscall</span><span class="op" id="2508969">(</span><span class="ident" id="2508970">SYS_IOCTL</span><span class="op" id="2508979">,</span>&nbsp;<span class="builtintype" id="2508981">uintptr</span><span class="op" id="2508988">(</span><span class="ident" id="2508989">sys</span><span class="op" id="2508992">.</span><span class="ident" id="2508993">Ctty</span><span class="op" id="2508997">)</span><span class="op" id="2508998">,</span>&nbsp;<span class="builtintype" id="2509000">uintptr</span><span class="op" id="2509007">(</span><span class="ident" id="2509008">TIOCSCTTY</span><span class="op" id="2509017">)</span><span class="op" id="2509018">,</span>&nbsp;<span class="num" id="2509020">0</span><span class="op" id="2509021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2509025">if</span>&nbsp;<span class="ident" id="2509028">err1</span>&nbsp;<span class="op" id="2509033">!=</span>&nbsp;<span class="num" id="2509036">0</span>&nbsp;<span class="op" id="2509038">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2509043">goto</span>&nbsp;<span class="ident" id="2509048">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2509061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2509064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2509068">//&nbsp;Time&nbsp;to&nbsp;exec.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2509086">_</span><span class="op" id="2509087">,</span>&nbsp;<span class="ident" id="2509089">_</span><span class="op" id="2509090">,</span>&nbsp;<span class="ident" id="2509092">err1</span>&nbsp;<span class="op" id="2509097">=</span>&nbsp;<span class="ident" id="2509099">RawSyscall</span><span class="op" id="2509109">(</span><span class="ident" id="2509110">SYS_EXECVE</span><span class="op" id="2509120">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2509124">uintptr</span><span class="op" id="2509131">(</span><span class="ident" id="2509132">unsafe</span><span class="op" id="2509138">.</span><span class="ident" id="2509139">Pointer</span><span class="op" id="2509146">(</span><span class="ident" id="2509147">argv0</span><span class="op" id="2509152">)</span><span class="op" id="2509153">)</span><span class="op" id="2509154">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2509158">uintptr</span><span class="op" id="2509165">(</span><span class="ident" id="2509166">unsafe</span><span class="op" id="2509172">.</span><span class="ident" id="2509173">Pointer</span><span class="op" id="2509180">(</span><span class="op" id="2509181">&amp;</span><span class="ident" id="2509182">argv</span><span class="op" id="2509186">[</span><span class="num" id="2509187">0</span><span class="op" id="2509188">]</span><span class="op" id="2509189">)</span><span class="op" id="2509190">)</span><span class="op" id="2509191">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2509195">uintptr</span><span class="op" id="2509202">(</span><span class="ident" id="2509203">unsafe</span><span class="op" id="2509209">.</span><span class="ident" id="2509210">Pointer</span><span class="op" id="2509217">(</span><span class="op" id="2509218">&amp;</span><span class="ident" id="2509219">envv</span><span class="op" id="2509223">[</span><span class="num" id="2509224">0</span><span class="op" id="2509225">]</span><span class="op" id="2509226">)</span><span class="op" id="2509227">)</span><span class="op" id="2509228">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="ident" id="2509231">childerror</span><span class="op" id="2509241">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2509244">//&nbsp;send&nbsp;error&nbsp;code&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2509272">RawSyscall</span><span class="op" id="2509282">(</span><span class="ident" id="2509283">SYS_WRITE</span><span class="op" id="2509292">,</span>&nbsp;<span class="builtintype" id="2509294">uintptr</span><span class="op" id="2509301">(</span><span class="ident" id="2509302">pipe</span><span class="op" id="2509306">)</span><span class="op" id="2509307">,</span>&nbsp;<span class="builtintype" id="2509309">uintptr</span><span class="op" id="2509316">(</span><span class="ident" id="2509317">unsafe</span><span class="op" id="2509323">.</span><span class="ident" id="2509324">Pointer</span><span class="op" id="2509331">(</span><span class="op" id="2509332">&amp;</span><span class="ident" id="2509333">err1</span><span class="op" id="2509337">)</span><span class="op" id="2509338">)</span><span class="op" id="2509339">,</span>&nbsp;<span class="ident" id="2509341">unsafe</span><span class="op" id="2509347">.</span><span class="ident" id="2509348">Sizeof</span><span class="op" id="2509354">(</span><span class="ident" id="2509355">err1</span><span class="op" id="2509359">)</span><span class="op" id="2509360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2509363">for</span>&nbsp;<span class="op" id="2509367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2509371">RawSyscall</span><span class="op" id="2509381">(</span><span class="ident" id="2509382">SYS_EXIT</span><span class="op" id="2509390">,</span>&nbsp;<span class="num" id="2509392">253</span><span class="op" id="2509395">,</span>&nbsp;<span class="num" id="2509397">0</span><span class="op" id="2509398">,</span>&nbsp;<span class="num" id="2509400">0</span><span class="op" id="2509401">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2509404">}</span><br>
<span class="lineno"></span><span class="op" id="2509406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2509409">//&nbsp;Try&nbsp;to&nbsp;open&nbsp;a&nbsp;pipe&nbsp;with&nbsp;O_CLOEXEC&nbsp;set&nbsp;on&nbsp;both&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword" id="2509476">func</span>&nbsp;<span class="ident" id="2509481">forkExecPipe</span><span class="op" id="2509493">(</span><span class="ident" id="2509494">p</span>&nbsp;<span class="op" id="2509496">[</span><span class="op" id="2509497">]</span><span class="builtintype" id="2509498">int</span><span class="op" id="2509501">)</span>&nbsp;<span class="op" id="2509503">(</span><span class="ident" id="2509504">err</span>&nbsp;<span class="builtintype" id="2509508">error</span><span class="op" id="2509513">)</span>&nbsp;<span class="op" id="2509515">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2509518">err</span>&nbsp;<span class="op" id="2509522">=</span>&nbsp;<span class="ident" id="2509524">Pipe2</span><span class="op" id="2509529">(</span><span class="ident" id="2509530">p</span><span class="op" id="2509531">,</span>&nbsp;<span class="ident" id="2509533">O_CLOEXEC</span><span class="op" id="2509542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2509545">//&nbsp;pipe2&nbsp;was&nbsp;added&nbsp;in&nbsp;2.6.27&nbsp;and&nbsp;our&nbsp;minimum&nbsp;requirement&nbsp;is&nbsp;2.6.23,&nbsp;so&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2509620">//&nbsp;might&nbsp;not&nbsp;be&nbsp;implemented.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2509650">if</span>&nbsp;<span class="ident" id="2509653">err</span>&nbsp;<span class="op" id="2509657">==</span>&nbsp;<span class="ident" id="2509660">ENOSYS</span>&nbsp;<span class="op" id="2509667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2509671">if</span>&nbsp;<span class="ident" id="2509674">err</span>&nbsp;<span class="op" id="2509678">=</span>&nbsp;<span class="ident" id="2509680">Pipe</span><span class="op" id="2509684">(</span><span class="ident" id="2509685">p</span><span class="op" id="2509686">)</span><span class="op" id="2509687">;</span>&nbsp;<span class="ident" id="2509689">err</span>&nbsp;<span class="op" id="2509693">!=</span>&nbsp;<span class="ident" id="2509696">nil</span>&nbsp;<span class="op" id="2509700">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2509705">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2509714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2509718">if</span>&nbsp;<span class="ident" id="2509721">_</span><span class="op" id="2509722">,</span>&nbsp;<span class="ident" id="2509724">err</span>&nbsp;<span class="op" id="2509728">=</span>&nbsp;<span class="ident" id="2509730">fcntl</span><span class="op" id="2509735">(</span><span class="ident" id="2509736">p</span><span class="op" id="2509737">[</span><span class="num" id="2509738">0</span><span class="op" id="2509739">]</span><span class="op" id="2509740">,</span>&nbsp;<span class="ident" id="2509742">F_SETFD</span><span class="op" id="2509749">,</span>&nbsp;<span class="ident" id="2509751">FD_CLOEXEC</span><span class="op" id="2509761">)</span><span class="op" id="2509762">;</span>&nbsp;<span class="ident" id="2509764">err</span>&nbsp;<span class="op" id="2509768">!=</span>&nbsp;<span class="ident" id="2509771">nil</span>&nbsp;<span class="op" id="2509775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2509780">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2509789">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2509793">_</span><span class="op" id="2509794">,</span>&nbsp;<span class="ident" id="2509796">err</span>&nbsp;<span class="op" id="2509800">=</span>&nbsp;<span class="ident" id="2509802">fcntl</span><span class="op" id="2509807">(</span><span class="ident" id="2509808">p</span><span class="op" id="2509809">[</span><span class="num" id="2509810">1</span><span class="op" id="2509811">]</span><span class="op" id="2509812">,</span>&nbsp;<span class="ident" id="2509814">F_SETFD</span><span class="op" id="2509821">,</span>&nbsp;<span class="ident" id="2509823">FD_CLOEXEC</span><span class="op" id="2509833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2509836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2509839">return</span><br>
<span class="lineno"></span><span class="op" id="2509846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="comment" id="2509849">//&nbsp;writeIDMappings&nbsp;writes&nbsp;the&nbsp;user&nbsp;namespace&nbsp;User&nbsp;ID&nbsp;or&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;the&nbsp;specified&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="2509946">func</span>&nbsp;<span class="ident" id="2509951">writeIDMappings</span><span class="op" id="2509966">(</span><span class="ident" id="2509967">path</span>&nbsp;<span class="builtintype" id="2509972">string</span><span class="op" id="2509978">,</span>&nbsp;<span class="ident" id="2509980">idMap</span>&nbsp;<span class="op" id="2509986">[</span><span class="op" id="2509987">]</span><span class="ident" id="2509988">SysProcIDMap</span><span class="op" id="2510000">)</span>&nbsp;<span class="builtintype" id="2510002">error</span>&nbsp;<span class="op" id="2510008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2510011">fd</span><span class="op" id="2510013">,</span>&nbsp;<span class="ident" id="2510015">err</span>&nbsp;<span class="op" id="2510019">:=</span>&nbsp;<span class="ident" id="2510022">Open</span><span class="op" id="2510026">(</span><span class="ident" id="2510027">path</span><span class="op" id="2510031">,</span>&nbsp;<span class="ident" id="2510033">O_RDWR</span><span class="op" id="2510039">,</span>&nbsp;<span class="num" id="2510041">0</span><span class="op" id="2510042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510045">if</span>&nbsp;<span class="ident" id="2510048">err</span>&nbsp;<span class="op" id="2510052">!=</span>&nbsp;<span class="ident" id="2510055">nil</span>&nbsp;<span class="op" id="2510059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510063">return</span>&nbsp;<span class="ident" id="2510070">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2510075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2510079">data</span>&nbsp;<span class="op" id="2510084">:=</span>&nbsp;<span class="string" id="2510087">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510091">for</span>&nbsp;<span class="ident" id="2510095">_</span><span class="op" id="2510096">,</span>&nbsp;<span class="ident" id="2510098">im</span>&nbsp;<span class="op" id="2510101">:=</span>&nbsp;<span class="keyword" id="2510104">range</span>&nbsp;<span class="ident" id="2510110">idMap</span>&nbsp;<span class="op" id="2510116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2510120">data</span>&nbsp;<span class="op" id="2510125">=</span>&nbsp;<span class="ident" id="2510127">data</span>&nbsp;<span class="op" id="2510132">+</span>&nbsp;<span class="ident" id="2510134">itoa</span><span class="op" id="2510138">(</span><span class="ident" id="2510139">im</span><span class="op" id="2510141">.</span><span class="ident" id="2510142">ContainerID</span><span class="op" id="2510153">)</span>&nbsp;<span class="op" id="2510155">+</span>&nbsp;<span class="string" id="2510157">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2510161">+</span>&nbsp;<span class="ident" id="2510163">itoa</span><span class="op" id="2510167">(</span><span class="ident" id="2510168">im</span><span class="op" id="2510170">.</span><span class="ident" id="2510171">HostID</span><span class="op" id="2510177">)</span>&nbsp;<span class="op" id="2510179">+</span>&nbsp;<span class="string" id="2510181">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2510185">+</span>&nbsp;<span class="ident" id="2510187">itoa</span><span class="op" id="2510191">(</span><span class="ident" id="2510192">im</span><span class="op" id="2510194">.</span><span class="ident" id="2510195">Size</span><span class="op" id="2510199">)</span>&nbsp;<span class="op" id="2510201">+</span>&nbsp;<span class="string" id="2510203">&#34;\n&#34;</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2510209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2510213">bytes</span><span class="op" id="2510218">,</span>&nbsp;<span class="ident" id="2510220">err</span>&nbsp;<span class="op" id="2510224">:=</span>&nbsp;<span class="ident" id="2510227">ByteSliceFromString</span><span class="op" id="2510246">(</span><span class="ident" id="2510247">data</span><span class="op" id="2510251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510254">if</span>&nbsp;<span class="ident" id="2510257">err</span>&nbsp;<span class="op" id="2510261">!=</span>&nbsp;<span class="ident" id="2510264">nil</span>&nbsp;<span class="op" id="2510268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2510272">Close</span><span class="op" id="2510277">(</span><span class="ident" id="2510278">fd</span><span class="op" id="2510280">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510284">return</span>&nbsp;<span class="ident" id="2510291">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2510296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510300">if</span>&nbsp;<span class="ident" id="2510303">_</span><span class="op" id="2510304">,</span>&nbsp;<span class="ident" id="2510306">err</span>&nbsp;<span class="op" id="2510310">:=</span>&nbsp;<span class="ident" id="2510313">Write</span><span class="op" id="2510318">(</span><span class="ident" id="2510319">fd</span><span class="op" id="2510321">,</span>&nbsp;<span class="ident" id="2510323">bytes</span><span class="op" id="2510328">)</span><span class="op" id="2510329">;</span>&nbsp;<span class="ident" id="2510331">err</span>&nbsp;<span class="op" id="2510335">!=</span>&nbsp;<span class="ident" id="2510338">nil</span>&nbsp;<span class="op" id="2510342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2510346">Close</span><span class="op" id="2510351">(</span><span class="ident" id="2510352">fd</span><span class="op" id="2510354">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510358">return</span>&nbsp;<span class="ident" id="2510365">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2510370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510374">if</span>&nbsp;<span class="ident" id="2510377">err</span>&nbsp;<span class="op" id="2510381">:=</span>&nbsp;<span class="ident" id="2510384">Close</span><span class="op" id="2510389">(</span><span class="ident" id="2510390">fd</span><span class="op" id="2510392">)</span><span class="op" id="2510393">;</span>&nbsp;<span class="ident" id="2510395">err</span>&nbsp;<span class="op" id="2510399">!=</span>&nbsp;<span class="ident" id="2510402">nil</span>&nbsp;<span class="op" id="2510406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510410">return</span>&nbsp;<span class="ident" id="2510417">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2510422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510426">return</span>&nbsp;<span class="ident" id="2510433">nil</span><br>
<span class="lineno"></span><span class="op" id="2510437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="comment" id="2510440">//&nbsp;writeUidGidMappings&nbsp;writes&nbsp;User&nbsp;ID&nbsp;and&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces</span><br>
<span class="lineno"></span><span class="comment" id="2510520">//&nbsp;for&nbsp;a&nbsp;process&nbsp;and&nbsp;it&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;parent&nbsp;process.</span><br>
<span class="lineno"></span><span class="keyword" id="2510579">func</span>&nbsp;<span class="ident" id="2510584">writeUidGidMappings</span><span class="op" id="2510603">(</span><span class="ident" id="2510604">pid</span>&nbsp;<span class="builtintype" id="2510608">int</span><span class="op" id="2510611">,</span>&nbsp;<span class="ident" id="2510613">sys</span>&nbsp;<span class="op" id="2510617">*</span><span class="ident" id="2510618">SysProcAttr</span><span class="op" id="2510629">)</span>&nbsp;<span class="builtintype" id="2510631">error</span>&nbsp;<span class="op" id="2510637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510640">if</span>&nbsp;<span class="ident" id="2510643">sys</span><span class="op" id="2510646">.</span><span class="ident" id="2510647">UidMappings</span>&nbsp;<span class="op" id="2510659">!=</span>&nbsp;<span class="ident" id="2510662">nil</span>&nbsp;<span class="op" id="2510666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2510670">uidf</span>&nbsp;<span class="op" id="2510675">:=</span>&nbsp;<span class="string" id="2510678">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2510687">+</span>&nbsp;<span class="ident" id="2510689">itoa</span><span class="op" id="2510693">(</span><span class="ident" id="2510694">pid</span><span class="op" id="2510697">)</span>&nbsp;<span class="op" id="2510699">+</span>&nbsp;<span class="string" id="2510701">&#34;/uid_map&#34;</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510714">if</span>&nbsp;<span class="ident" id="2510717">err</span>&nbsp;<span class="op" id="2510721">:=</span>&nbsp;<span class="ident" id="2510724">writeIDMappings</span><span class="op" id="2510739">(</span><span class="ident" id="2510740">uidf</span><span class="op" id="2510744">,</span>&nbsp;<span class="ident" id="2510746">sys</span><span class="op" id="2510749">.</span><span class="ident" id="2510750">UidMappings</span><span class="op" id="2510761">)</span><span class="op" id="2510762">;</span>&nbsp;<span class="ident" id="2510764">err</span>&nbsp;<span class="op" id="2510768">!=</span>&nbsp;<span class="ident" id="2510771">nil</span>&nbsp;<span class="op" id="2510775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510780">return</span>&nbsp;<span class="ident" id="2510787">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2510793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2510796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510800">if</span>&nbsp;<span class="ident" id="2510803">sys</span><span class="op" id="2510806">.</span><span class="ident" id="2510807">GidMappings</span>&nbsp;<span class="op" id="2510819">!=</span>&nbsp;<span class="ident" id="2510822">nil</span>&nbsp;<span class="op" id="2510826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2510830">gidf</span>&nbsp;<span class="op" id="2510835">:=</span>&nbsp;<span class="string" id="2510838">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2510847">+</span>&nbsp;<span class="ident" id="2510849">itoa</span><span class="op" id="2510853">(</span><span class="ident" id="2510854">pid</span><span class="op" id="2510857">)</span>&nbsp;<span class="op" id="2510859">+</span>&nbsp;<span class="string" id="2510861">&#34;/gid_map&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510874">if</span>&nbsp;<span class="ident" id="2510877">err</span>&nbsp;<span class="op" id="2510881">:=</span>&nbsp;<span class="ident" id="2510884">writeIDMappings</span><span class="op" id="2510899">(</span><span class="ident" id="2510900">gidf</span><span class="op" id="2510904">,</span>&nbsp;<span class="ident" id="2510906">sys</span><span class="op" id="2510909">.</span><span class="ident" id="2510910">GidMappings</span><span class="op" id="2510921">)</span><span class="op" id="2510922">;</span>&nbsp;<span class="ident" id="2510924">err</span>&nbsp;<span class="op" id="2510928">!=</span>&nbsp;<span class="ident" id="2510931">nil</span>&nbsp;<span class="op" id="2510935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510940">return</span>&nbsp;<span class="ident" id="2510947">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2510953">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2510956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2510960">return</span>&nbsp;<span class="ident" id="2510967">nil</span><br>
<span class="lineno"></span><span class="op" id="2510971">}</span>
</div>
</body>
</html>
