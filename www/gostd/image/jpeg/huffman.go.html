<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html" class="current">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5785203">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5785258">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5785312">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5785363">package</span>&nbsp;<span class="ident" id="5785371">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5785377">import</span>&nbsp;<span class="op" id="5785384">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5785387">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5785392">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="5785395">//&nbsp;maxCodeLength&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="5785473">const</span>&nbsp;<span class="ident" id="5785479">maxCodeLength</span>&nbsp;<span class="op" id="5785493">=</span>&nbsp;<span class="num" id="5785495">16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5785499">//&nbsp;maxNCodes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;tree.</span><br>
<span class="lineno">15</span><span class="keyword" id="5785574">const</span>&nbsp;<span class="ident" id="5785580">maxNCodes</span>&nbsp;<span class="op" id="5785590">=</span>&nbsp;<span class="num" id="5785592">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5785597">//&nbsp;lutSize&nbsp;is&nbsp;the&nbsp;log-2&nbsp;size&nbsp;of&nbsp;the&nbsp;Huffman&nbsp;decoder&#39;s&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="5785666">const</span>&nbsp;<span class="ident" id="5785672">lutSize</span>&nbsp;<span class="op" id="5785680">=</span>&nbsp;<span class="num" id="5785682">8</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5785685">//&nbsp;huffman&nbsp;is&nbsp;a&nbsp;Huffman&nbsp;decoder,&nbsp;specified&nbsp;in&nbsp;section&nbsp;C.</span><br>
<span class="lineno"></span><span class="keyword" id="5785742">type</span>&nbsp;<span class="ident" id="5785747">huffman</span>&nbsp;<span class="keyword" id="5785755">struct</span>&nbsp;<span class="op" id="5785762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5785765">//&nbsp;length&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5785812">nCodes</span>&nbsp;<span class="builtintype" id="5785819">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5785826">//&nbsp;lut&nbsp;is&nbsp;the&nbsp;look-up&nbsp;table&nbsp;for&nbsp;the&nbsp;next&nbsp;lutSize&nbsp;bits&nbsp;in&nbsp;the&nbsp;bit-stream.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5785900">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;the&nbsp;uint16&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.&nbsp;The&nbsp;low&nbsp;8&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5785972">//&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;code&nbsp;length,&nbsp;or&nbsp;0&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;fit&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786045">//&nbsp;lutSize&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786063">lut</span>&nbsp;<span class="op" id="5786067">[</span><span class="num" id="5786068">1</span>&nbsp;<span class="op" id="5786070">&lt;&lt;</span>&nbsp;<span class="ident" id="5786073">lutSize</span><span class="op" id="5786080">]</span><span class="builtintype" id="5786081">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786089">//&nbsp;vals&nbsp;are&nbsp;the&nbsp;decoded&nbsp;values,&nbsp;sorted&nbsp;by&nbsp;their&nbsp;encoding.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786148">vals</span>&nbsp;<span class="op" id="5786153">[</span><span class="ident" id="5786154">maxNCodes</span><span class="op" id="5786163">]</span><span class="builtintype" id="5786164">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786171">//&nbsp;minCodes[i]&nbsp;is&nbsp;the&nbsp;minimum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786242">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786268">minCodes</span>&nbsp;<span class="op" id="5786277">[</span><span class="ident" id="5786278">maxCodeLength</span><span class="op" id="5786291">]</span><span class="builtintype" id="5786292">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786299">//&nbsp;maxCodes[i]&nbsp;is&nbsp;the&nbsp;maximum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786370">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786396">maxCodes</span>&nbsp;<span class="op" id="5786405">[</span><span class="ident" id="5786406">maxCodeLength</span><span class="op" id="5786419">]</span><span class="builtintype" id="5786420">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5786427">//&nbsp;valsIndices[i]&nbsp;is&nbsp;the&nbsp;index&nbsp;into&nbsp;vals&nbsp;of&nbsp;minCodes[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786485">valsIndices</span>&nbsp;<span class="op" id="5786497">[</span><span class="ident" id="5786498">maxCodeLength</span><span class="op" id="5786511">]</span><span class="builtintype" id="5786512">int32</span><br>
<span class="lineno"></span><span class="op" id="5786518">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="5786521">//&nbsp;errShortHuffmanData&nbsp;means&nbsp;that&nbsp;an&nbsp;unexpected&nbsp;EOF&nbsp;occurred&nbsp;while&nbsp;decoding</span><br>
<span class="lineno"></span><span class="comment" id="5786597">//&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5786614">var</span>&nbsp;<span class="ident" id="5786618">errShortHuffmanData</span>&nbsp;<span class="op" id="5786638">=</span>&nbsp;<span class="ident" id="5786640">FormatError</span><span class="op" id="5786651">(</span><span class="string" id="5786652">&#34;short&nbsp;Huffman&nbsp;data&#34;</span><span class="op" id="5786672">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5786675">//&nbsp;ensureNBits&nbsp;reads&nbsp;bytes&nbsp;from&nbsp;the&nbsp;byte&nbsp;buffer&nbsp;to&nbsp;ensure&nbsp;that&nbsp;d.bits.n&nbsp;is&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5786753">//&nbsp;least&nbsp;n.&nbsp;For&nbsp;best&nbsp;performance&nbsp;(avoiding&nbsp;function&nbsp;calls&nbsp;inside&nbsp;hot&nbsp;loops),</span><br>
<span class="lineno"></span><span class="comment" id="5786830">//&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;responsible&nbsp;for&nbsp;first&nbsp;checking&nbsp;that&nbsp;d.bits.n&nbsp;&lt;&nbsp;n.</span><br>
<span class="lineno"></span><span class="keyword" id="5786905">func</span>&nbsp;<span class="op" id="5786910">(</span><span class="ident" id="5786911">d</span>&nbsp;<span class="op" id="5786913">*</span><span class="ident" id="5786914">decoder</span><span class="op" id="5786921">)</span>&nbsp;<span class="ident" id="5786923">ensureNBits</span><span class="op" id="5786934">(</span><span class="ident" id="5786935">n</span>&nbsp;<span class="builtintype" id="5786937">int32</span><span class="op" id="5786942">)</span>&nbsp;<span class="builtintype" id="5786944">error</span>&nbsp;<span class="op" id="5786950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5786953">for</span>&nbsp;<span class="op" id="5786957">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5786961">c</span><span class="op" id="5786962">,</span>&nbsp;<span class="ident" id="5786964">err</span>&nbsp;<span class="op" id="5786968">:=</span>&nbsp;<span class="ident" id="5786971">d</span><span class="op" id="5786972">.</span><span class="ident" id="5786973">readByteStuffedByte</span><span class="op" id="5786992">(</span><span class="op" id="5786993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5786997">if</span>&nbsp;<span class="ident" id="5787000">err</span>&nbsp;<span class="op" id="5787004">!=</span>&nbsp;<span class="ident" id="5787007">nil</span>&nbsp;<span class="op" id="5787011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787016">if</span>&nbsp;<span class="ident" id="5787019">err</span>&nbsp;<span class="op" id="5787023">==</span>&nbsp;<span class="ident" id="5787026">io</span><span class="op" id="5787028">.</span><span class="ident" id="5787029">EOF</span>&nbsp;<span class="op" id="5787033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787039">return</span>&nbsp;<span class="ident" id="5787046">errShortHuffmanData</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787069">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787074">return</span>&nbsp;<span class="ident" id="5787081">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787091">d</span><span class="op" id="5787092">.</span><span class="ident" id="5787093">bits</span><span class="op" id="5787097">.</span><span class="ident" id="5787098">a</span>&nbsp;<span class="op" id="5787100">=</span>&nbsp;<span class="ident" id="5787102">d</span><span class="op" id="5787103">.</span><span class="ident" id="5787104">bits</span><span class="op" id="5787108">.</span><span class="ident" id="5787109">a</span><span class="op" id="5787110">&lt;&lt;</span><span class="num" id="5787112">8</span>&nbsp;<span class="op" id="5787114">|</span>&nbsp;<span class="builtintype" id="5787116">uint32</span><span class="op" id="5787122">(</span><span class="ident" id="5787123">c</span><span class="op" id="5787124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787128">d</span><span class="op" id="5787129">.</span><span class="ident" id="5787130">bits</span><span class="op" id="5787134">.</span><span class="ident" id="5787135">n</span>&nbsp;<span class="op" id="5787137">+=</span>&nbsp;<span class="num" id="5787140">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787144">if</span>&nbsp;<span class="ident" id="5787147">d</span><span class="op" id="5787148">.</span><span class="ident" id="5787149">bits</span><span class="op" id="5787153">.</span><span class="ident" id="5787154">m</span>&nbsp;<span class="op" id="5787156">==</span>&nbsp;<span class="num" id="5787159">0</span>&nbsp;<span class="op" id="5787161">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787166">d</span><span class="op" id="5787167">.</span><span class="ident" id="5787168">bits</span><span class="op" id="5787172">.</span><span class="ident" id="5787173">m</span>&nbsp;<span class="op" id="5787175">=</span>&nbsp;<span class="num" id="5787177">1</span>&nbsp;<span class="op" id="5787179">&lt;&lt;</span>&nbsp;<span class="num" id="5787182">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787186">}</span>&nbsp;<span class="keyword" id="5787188">else</span>&nbsp;<span class="op" id="5787193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787198">d</span><span class="op" id="5787199">.</span><span class="ident" id="5787200">bits</span><span class="op" id="5787204">.</span><span class="ident" id="5787205">m</span>&nbsp;<span class="op" id="5787207">&lt;&lt;=</span>&nbsp;<span class="num" id="5787211">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787219">if</span>&nbsp;<span class="ident" id="5787222">d</span><span class="op" id="5787223">.</span><span class="ident" id="5787224">bits</span><span class="op" id="5787228">.</span><span class="ident" id="5787229">n</span>&nbsp;<span class="op" id="5787231">&gt;=</span>&nbsp;<span class="ident" id="5787234">n</span>&nbsp;<span class="op" id="5787236">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787241">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787255">return</span>&nbsp;<span class="ident" id="5787262">nil</span><br>
<span class="lineno"></span><span class="op" id="5787266">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="5787269">//&nbsp;receiveExtend&nbsp;is&nbsp;the&nbsp;composition&nbsp;of&nbsp;RECEIVE&nbsp;and&nbsp;EXTEND,&nbsp;specified&nbsp;in&nbsp;section</span><br>
<span class="lineno"></span><span class="comment" id="5787349">//&nbsp;F.2.2.1.</span><br>
<span class="lineno"></span><span class="keyword" id="5787361">func</span>&nbsp;<span class="op" id="5787366">(</span><span class="ident" id="5787367">d</span>&nbsp;<span class="op" id="5787369">*</span><span class="ident" id="5787370">decoder</span><span class="op" id="5787377">)</span>&nbsp;<span class="ident" id="5787379">receiveExtend</span><span class="op" id="5787392">(</span><span class="ident" id="5787393">t</span>&nbsp;<span class="builtintype" id="5787395">uint8</span><span class="op" id="5787400">)</span>&nbsp;<span class="op" id="5787402">(</span><span class="builtintype" id="5787403">int32</span><span class="op" id="5787408">,</span>&nbsp;<span class="builtintype" id="5787410">error</span><span class="op" id="5787415">)</span>&nbsp;<span class="op" id="5787417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787420">if</span>&nbsp;<span class="ident" id="5787423">d</span><span class="op" id="5787424">.</span><span class="ident" id="5787425">bits</span><span class="op" id="5787429">.</span><span class="ident" id="5787430">n</span>&nbsp;<span class="op" id="5787432">&lt;</span>&nbsp;<span class="builtintype" id="5787434">int32</span><span class="op" id="5787439">(</span><span class="ident" id="5787440">t</span><span class="op" id="5787441">)</span>&nbsp;<span class="op" id="5787443">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787447">if</span>&nbsp;<span class="ident" id="5787450">err</span>&nbsp;<span class="op" id="5787454">:=</span>&nbsp;<span class="ident" id="5787457">d</span><span class="op" id="5787458">.</span><span class="ident" id="5787459">ensureNBits</span><span class="op" id="5787470">(</span><span class="builtintype" id="5787471">int32</span><span class="op" id="5787476">(</span><span class="ident" id="5787477">t</span><span class="op" id="5787478">)</span><span class="op" id="5787479">)</span><span class="op" id="5787480">;</span>&nbsp;<span class="ident" id="5787482">err</span>&nbsp;<span class="op" id="5787486">!=</span>&nbsp;<span class="ident" id="5787489">nil</span>&nbsp;<span class="op" id="5787493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787498">return</span>&nbsp;<span class="num" id="5787505">0</span><span class="op" id="5787506">,</span>&nbsp;<span class="ident" id="5787508">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787520">d</span><span class="op" id="5787521">.</span><span class="ident" id="5787522">bits</span><span class="op" id="5787526">.</span><span class="ident" id="5787527">n</span>&nbsp;<span class="op" id="5787529">-=</span>&nbsp;<span class="builtintype" id="5787532">int32</span><span class="op" id="5787537">(</span><span class="ident" id="5787538">t</span><span class="op" id="5787539">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787542">d</span><span class="op" id="5787543">.</span><span class="ident" id="5787544">bits</span><span class="op" id="5787548">.</span><span class="ident" id="5787549">m</span>&nbsp;<span class="op" id="5787551">&gt;&gt;=</span>&nbsp;<span class="ident" id="5787555">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787558">s</span>&nbsp;<span class="op" id="5787560">:=</span>&nbsp;<span class="builtintype" id="5787563">int32</span><span class="op" id="5787568">(</span><span class="num" id="5787569">1</span><span class="op" id="5787570">)</span>&nbsp;<span class="op" id="5787572">&lt;&lt;</span>&nbsp;<span class="ident" id="5787575">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787578">x</span>&nbsp;<span class="op" id="5787580">:=</span>&nbsp;<span class="builtintype" id="5787583">int32</span><span class="op" id="5787588">(</span><span class="ident" id="5787589">d</span><span class="op" id="5787590">.</span><span class="ident" id="5787591">bits</span><span class="op" id="5787595">.</span><span class="ident" id="5787596">a</span><span class="op" id="5787597">&gt;&gt;</span><span class="builtintype" id="5787599">uint8</span><span class="op" id="5787604">(</span><span class="ident" id="5787605">d</span><span class="op" id="5787606">.</span><span class="ident" id="5787607">bits</span><span class="op" id="5787611">.</span><span class="ident" id="5787612">n</span><span class="op" id="5787613">)</span><span class="op" id="5787614">)</span>&nbsp;<span class="op" id="5787616">&amp;</span>&nbsp;<span class="op" id="5787618">(</span><span class="ident" id="5787619">s</span>&nbsp;<span class="op" id="5787621">-</span>&nbsp;<span class="num" id="5787623">1</span><span class="op" id="5787624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787627">if</span>&nbsp;<span class="ident" id="5787630">x</span>&nbsp;<span class="op" id="5787632">&lt;</span>&nbsp;<span class="ident" id="5787634">s</span><span class="op" id="5787635">&gt;&gt;</span><span class="num" id="5787637">1</span>&nbsp;<span class="op" id="5787639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5787643">x</span>&nbsp;<span class="op" id="5787645">+=</span>&nbsp;<span class="op" id="5787648">(</span><span class="op" id="5787649">(</span><span class="op" id="5787650">-</span><span class="num" id="5787651">1</span><span class="op" id="5787652">)</span>&nbsp;<span class="op" id="5787654">&lt;&lt;</span>&nbsp;<span class="ident" id="5787657">t</span><span class="op" id="5787658">)</span>&nbsp;<span class="op" id="5787660">+</span>&nbsp;<span class="num" id="5787662">1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787668">return</span>&nbsp;<span class="ident" id="5787675">x</span><span class="op" id="5787676">,</span>&nbsp;<span class="ident" id="5787678">nil</span><br>
<span class="lineno"></span><span class="op" id="5787682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5787685">//&nbsp;processDHT&nbsp;processes&nbsp;a&nbsp;Define&nbsp;Huffman&nbsp;Table&nbsp;marker,&nbsp;and&nbsp;initializes&nbsp;a&nbsp;huffman</span><br>
<span class="lineno">90</span><span class="comment" id="5787766">//&nbsp;struct&nbsp;from&nbsp;its&nbsp;contents.&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.2.</span><br>
<span class="lineno"></span><span class="keyword" id="5787825">func</span>&nbsp;<span class="op" id="5787830">(</span><span class="ident" id="5787831">d</span>&nbsp;<span class="op" id="5787833">*</span><span class="ident" id="5787834">decoder</span><span class="op" id="5787841">)</span>&nbsp;<span class="ident" id="5787843">processDHT</span><span class="op" id="5787853">(</span><span class="ident" id="5787854">n</span>&nbsp;<span class="builtintype" id="5787856">int</span><span class="op" id="5787859">)</span>&nbsp;<span class="builtintype" id="5787861">error</span>&nbsp;<span class="op" id="5787867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787870">for</span>&nbsp;<span class="ident" id="5787874">n</span>&nbsp;<span class="op" id="5787876">&gt;</span>&nbsp;<span class="num" id="5787878">0</span>&nbsp;<span class="op" id="5787880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787884">if</span>&nbsp;<span class="ident" id="5787887">n</span>&nbsp;<span class="op" id="5787889">&lt;</span>&nbsp;<span class="num" id="5787891">17</span>&nbsp;<span class="op" id="5787894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787899">return</span>&nbsp;<span class="ident" id="5787906">FormatError</span><span class="op" id="5787917">(</span><span class="string" id="5787918">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5787940">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5787944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787948">if</span>&nbsp;<span class="ident" id="5787951">err</span>&nbsp;<span class="op" id="5787955">:=</span>&nbsp;<span class="ident" id="5787958">d</span><span class="op" id="5787959">.</span><span class="ident" id="5787960">readFull</span><span class="op" id="5787968">(</span><span class="ident" id="5787969">d</span><span class="op" id="5787970">.</span><span class="ident" id="5787971">tmp</span><span class="op" id="5787974">[</span><span class="op" id="5787975">:</span><span class="num" id="5787976">17</span><span class="op" id="5787978">]</span><span class="op" id="5787979">)</span><span class="op" id="5787980">;</span>&nbsp;<span class="ident" id="5787982">err</span>&nbsp;<span class="op" id="5787986">!=</span>&nbsp;<span class="ident" id="5787989">nil</span>&nbsp;<span class="op" id="5787993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5787998">return</span>&nbsp;<span class="ident" id="5788005">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788015">tc</span>&nbsp;<span class="op" id="5788018">:=</span>&nbsp;<span class="ident" id="5788021">d</span><span class="op" id="5788022">.</span><span class="ident" id="5788023">tmp</span><span class="op" id="5788026">[</span><span class="num" id="5788027">0</span><span class="op" id="5788028">]</span>&nbsp;<span class="op" id="5788030">&gt;&gt;</span>&nbsp;<span class="num" id="5788033">4</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788037">if</span>&nbsp;<span class="ident" id="5788040">tc</span>&nbsp;<span class="op" id="5788043">&gt;</span>&nbsp;<span class="ident" id="5788045">maxTc</span>&nbsp;<span class="op" id="5788051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788056">return</span>&nbsp;<span class="ident" id="5788063">FormatError</span><span class="op" id="5788074">(</span><span class="string" id="5788075">&#34;bad&nbsp;Tc&nbsp;value&#34;</span><span class="op" id="5788089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788097">th</span>&nbsp;<span class="op" id="5788100">:=</span>&nbsp;<span class="ident" id="5788103">d</span><span class="op" id="5788104">.</span><span class="ident" id="5788105">tmp</span><span class="op" id="5788108">[</span><span class="num" id="5788109">0</span><span class="op" id="5788110">]</span>&nbsp;<span class="op" id="5788112">&amp;</span>&nbsp;<span class="num" id="5788114">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788121">if</span>&nbsp;<span class="ident" id="5788124">th</span>&nbsp;<span class="op" id="5788127">&gt;</span>&nbsp;<span class="ident" id="5788129">maxTh</span>&nbsp;<span class="op" id="5788135">||</span>&nbsp;<span class="op" id="5788138">!</span><span class="ident" id="5788139">d</span><span class="op" id="5788140">.</span><span class="ident" id="5788141">progressive</span>&nbsp;<span class="op" id="5788153">&amp;&amp;</span>&nbsp;<span class="ident" id="5788156">th</span>&nbsp;<span class="op" id="5788159">&gt;</span>&nbsp;<span class="num" id="5788161">1</span>&nbsp;<span class="op" id="5788163">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788168">return</span>&nbsp;<span class="ident" id="5788175">FormatError</span><span class="op" id="5788186">(</span><span class="string" id="5788187">&#34;bad&nbsp;Th&nbsp;value&#34;</span><span class="op" id="5788201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788209">h</span>&nbsp;<span class="op" id="5788211">:=</span>&nbsp;<span class="op" id="5788214">&amp;</span><span class="ident" id="5788215">d</span><span class="op" id="5788216">.</span><span class="ident" id="5788217">huff</span><span class="op" id="5788221">[</span><span class="ident" id="5788222">tc</span><span class="op" id="5788224">]</span><span class="op" id="5788225">[</span><span class="ident" id="5788226">th</span><span class="op" id="5788228">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5788233">//&nbsp;Read&nbsp;nCodes&nbsp;and&nbsp;h.vals&nbsp;(and&nbsp;derive&nbsp;h.nCodes).</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5788284">//&nbsp;nCodes[i]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;with&nbsp;code&nbsp;length&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5788342">//&nbsp;h.nCodes&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788386">h</span><span class="op" id="5788387">.</span><span class="ident" id="5788388">nCodes</span>&nbsp;<span class="op" id="5788395">=</span>&nbsp;<span class="num" id="5788397">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788401">var</span>&nbsp;<span class="ident" id="5788405">nCodes</span>&nbsp;<span class="op" id="5788412">[</span><span class="ident" id="5788413">maxCodeLength</span><span class="op" id="5788426">]</span><span class="builtintype" id="5788427">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788435">for</span>&nbsp;<span class="ident" id="5788439">i</span>&nbsp;<span class="op" id="5788441">:=</span>&nbsp;<span class="keyword" id="5788444">range</span>&nbsp;<span class="ident" id="5788450">nCodes</span>&nbsp;<span class="op" id="5788457">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788462">nCodes</span><span class="op" id="5788468">[</span><span class="ident" id="5788469">i</span><span class="op" id="5788470">]</span>&nbsp;<span class="op" id="5788472">=</span>&nbsp;<span class="builtintype" id="5788474">int32</span><span class="op" id="5788479">(</span><span class="ident" id="5788480">d</span><span class="op" id="5788481">.</span><span class="ident" id="5788482">tmp</span><span class="op" id="5788485">[</span><span class="ident" id="5788486">i</span><span class="op" id="5788487">+</span><span class="num" id="5788488">1</span><span class="op" id="5788489">]</span><span class="op" id="5788490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788495">h</span><span class="op" id="5788496">.</span><span class="ident" id="5788497">nCodes</span>&nbsp;<span class="op" id="5788504">+=</span>&nbsp;<span class="ident" id="5788507">nCodes</span><span class="op" id="5788513">[</span><span class="ident" id="5788514">i</span><span class="op" id="5788515">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788523">if</span>&nbsp;<span class="ident" id="5788526">h</span><span class="op" id="5788527">.</span><span class="ident" id="5788528">nCodes</span>&nbsp;<span class="op" id="5788535">==</span>&nbsp;<span class="num" id="5788538">0</span>&nbsp;<span class="op" id="5788540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788545">return</span>&nbsp;<span class="ident" id="5788552">FormatError</span><span class="op" id="5788563">(</span><span class="string" id="5788564">&#34;Huffman&nbsp;table&nbsp;has&nbsp;zero&nbsp;length&#34;</span><span class="op" id="5788595">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788603">if</span>&nbsp;<span class="ident" id="5788606">h</span><span class="op" id="5788607">.</span><span class="ident" id="5788608">nCodes</span>&nbsp;<span class="op" id="5788615">&gt;</span>&nbsp;<span class="ident" id="5788617">maxNCodes</span>&nbsp;<span class="op" id="5788627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788632">return</span>&nbsp;<span class="ident" id="5788639">FormatError</span><span class="op" id="5788650">(</span><span class="string" id="5788651">&#34;Huffman&nbsp;table&nbsp;has&nbsp;excessive&nbsp;length&#34;</span><span class="op" id="5788687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788695">n</span>&nbsp;<span class="op" id="5788697">-=</span>&nbsp;<span class="builtintype" id="5788700">int</span><span class="op" id="5788703">(</span><span class="ident" id="5788704">h</span><span class="op" id="5788705">.</span><span class="ident" id="5788706">nCodes</span><span class="op" id="5788712">)</span>&nbsp;<span class="op" id="5788714">+</span>&nbsp;<span class="num" id="5788716">17</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788721">if</span>&nbsp;<span class="ident" id="5788724">n</span>&nbsp;<span class="op" id="5788726">&lt;</span>&nbsp;<span class="num" id="5788728">0</span>&nbsp;<span class="op" id="5788730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788735">return</span>&nbsp;<span class="ident" id="5788742">FormatError</span><span class="op" id="5788753">(</span><span class="string" id="5788754">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5788776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788784">if</span>&nbsp;<span class="ident" id="5788787">err</span>&nbsp;<span class="op" id="5788791">:=</span>&nbsp;<span class="ident" id="5788794">d</span><span class="op" id="5788795">.</span><span class="ident" id="5788796">readFull</span><span class="op" id="5788804">(</span><span class="ident" id="5788805">h</span><span class="op" id="5788806">.</span><span class="ident" id="5788807">vals</span><span class="op" id="5788811">[</span><span class="op" id="5788812">:</span><span class="ident" id="5788813">h</span><span class="op" id="5788814">.</span><span class="ident" id="5788815">nCodes</span><span class="op" id="5788821">]</span><span class="op" id="5788822">)</span><span class="op" id="5788823">;</span>&nbsp;<span class="ident" id="5788825">err</span>&nbsp;<span class="op" id="5788829">!=</span>&nbsp;<span class="ident" id="5788832">nil</span>&nbsp;<span class="op" id="5788836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788841">return</span>&nbsp;<span class="ident" id="5788848">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5788859">//&nbsp;Derive&nbsp;the&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788890">for</span>&nbsp;<span class="ident" id="5788894">i</span>&nbsp;<span class="op" id="5788896">:=</span>&nbsp;<span class="keyword" id="5788899">range</span>&nbsp;<span class="ident" id="5788905">h</span><span class="op" id="5788906">.</span><span class="ident" id="5788907">lut</span>&nbsp;<span class="op" id="5788911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788916">h</span><span class="op" id="5788917">.</span><span class="ident" id="5788918">lut</span><span class="op" id="5788921">[</span><span class="ident" id="5788922">i</span><span class="op" id="5788923">]</span>&nbsp;<span class="op" id="5788925">=</span>&nbsp;<span class="num" id="5788927">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5788931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788935">var</span>&nbsp;<span class="ident" id="5788939">x</span><span class="op" id="5788940">,</span>&nbsp;<span class="ident" id="5788942">code</span>&nbsp;<span class="builtintype" id="5788947">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5788956">for</span>&nbsp;<span class="ident" id="5788960">i</span>&nbsp;<span class="op" id="5788962">:=</span>&nbsp;<span class="builtintype" id="5788965">uint32</span><span class="op" id="5788971">(</span><span class="num" id="5788972">0</span><span class="op" id="5788973">)</span><span class="op" id="5788974">;</span>&nbsp;<span class="ident" id="5788976">i</span>&nbsp;<span class="op" id="5788978">&lt;</span>&nbsp;<span class="ident" id="5788980">lutSize</span><span class="op" id="5788987">;</span>&nbsp;<span class="ident" id="5788989">i</span><span class="op" id="5788990">++</span>&nbsp;<span class="op" id="5788993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5788998">code</span>&nbsp;<span class="op" id="5789003">&lt;&lt;=</span>&nbsp;<span class="num" id="5789007">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789012">for</span>&nbsp;<span class="ident" id="5789016">j</span>&nbsp;<span class="op" id="5789018">:=</span>&nbsp;<span class="builtintype" id="5789021">int32</span><span class="op" id="5789026">(</span><span class="num" id="5789027">0</span><span class="op" id="5789028">)</span><span class="op" id="5789029">;</span>&nbsp;<span class="ident" id="5789031">j</span>&nbsp;<span class="op" id="5789033">&lt;</span>&nbsp;<span class="ident" id="5789035">nCodes</span><span class="op" id="5789041">[</span><span class="ident" id="5789042">i</span><span class="op" id="5789043">]</span><span class="op" id="5789044">;</span>&nbsp;<span class="ident" id="5789046">j</span><span class="op" id="5789047">++</span>&nbsp;<span class="op" id="5789050">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5789056">//&nbsp;The&nbsp;codeLength&nbsp;is&nbsp;1+i,&nbsp;so&nbsp;shift&nbsp;code&nbsp;by&nbsp;8-(1+i)&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5789114">//&nbsp;calculate&nbsp;the&nbsp;high&nbsp;bits&nbsp;for&nbsp;every&nbsp;8-bit&nbsp;sequence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5789170">//&nbsp;whose&nbsp;codeLength&#39;s&nbsp;high&nbsp;bits&nbsp;matches&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5789220">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;lutValue&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5789278">//&nbsp;The&nbsp;low&nbsp;8&nbsp;bits&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;codeLength.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789327">base</span>&nbsp;<span class="op" id="5789332">:=</span>&nbsp;<span class="builtintype" id="5789335">uint8</span><span class="op" id="5789340">(</span><span class="ident" id="5789341">code</span>&nbsp;<span class="op" id="5789346">&lt;&lt;</span>&nbsp;<span class="op" id="5789349">(</span><span class="num" id="5789350">7</span>&nbsp;<span class="op" id="5789352">-</span>&nbsp;<span class="ident" id="5789354">i</span><span class="op" id="5789355">)</span><span class="op" id="5789356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789362">lutValue</span>&nbsp;<span class="op" id="5789371">:=</span>&nbsp;<span class="builtintype" id="5789374">uint16</span><span class="op" id="5789380">(</span><span class="ident" id="5789381">h</span><span class="op" id="5789382">.</span><span class="ident" id="5789383">vals</span><span class="op" id="5789387">[</span><span class="ident" id="5789388">x</span><span class="op" id="5789389">]</span><span class="op" id="5789390">)</span><span class="op" id="5789391">&lt;&lt;</span><span class="num" id="5789393">8</span>&nbsp;<span class="op" id="5789395">|</span>&nbsp;<span class="builtintype" id="5789397">uint16</span><span class="op" id="5789403">(</span><span class="num" id="5789404">2</span><span class="op" id="5789405">+</span><span class="ident" id="5789406">i</span><span class="op" id="5789407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789413">for</span>&nbsp;<span class="ident" id="5789417">k</span>&nbsp;<span class="op" id="5789419">:=</span>&nbsp;<span class="builtintype" id="5789422">uint8</span><span class="op" id="5789427">(</span><span class="num" id="5789428">0</span><span class="op" id="5789429">)</span><span class="op" id="5789430">;</span>&nbsp;<span class="ident" id="5789432">k</span>&nbsp;<span class="op" id="5789434">&lt;</span>&nbsp;<span class="num" id="5789436">1</span><span class="op" id="5789437">&lt;&lt;</span><span class="op" id="5789439">(</span><span class="num" id="5789440">7</span><span class="op" id="5789441">-</span><span class="ident" id="5789442">i</span><span class="op" id="5789443">)</span><span class="op" id="5789444">;</span>&nbsp;<span class="ident" id="5789446">k</span><span class="op" id="5789447">++</span>&nbsp;<span class="op" id="5789450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789457">h</span><span class="op" id="5789458">.</span><span class="ident" id="5789459">lut</span><span class="op" id="5789462">[</span><span class="ident" id="5789463">base</span><span class="op" id="5789467">|</span><span class="ident" id="5789468">k</span><span class="op" id="5789469">]</span>&nbsp;<span class="op" id="5789471">=</span>&nbsp;<span class="ident" id="5789473">lutValue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5789486">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789492">code</span><span class="op" id="5789496">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789503">x</span><span class="op" id="5789504">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5789510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5789514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5789519">//&nbsp;Derive&nbsp;minCodes,&nbsp;maxCodes,&nbsp;and&nbsp;valsIndices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789568">var</span>&nbsp;<span class="ident" id="5789572">c</span><span class="op" id="5789573">,</span>&nbsp;<span class="ident" id="5789575">index</span>&nbsp;<span class="builtintype" id="5789581">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789589">for</span>&nbsp;<span class="ident" id="5789593">i</span><span class="op" id="5789594">,</span>&nbsp;<span class="ident" id="5789596">n</span>&nbsp;<span class="op" id="5789598">:=</span>&nbsp;<span class="keyword" id="5789601">range</span>&nbsp;<span class="ident" id="5789607">nCodes</span>&nbsp;<span class="op" id="5789614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789619">if</span>&nbsp;<span class="ident" id="5789622">n</span>&nbsp;<span class="op" id="5789624">==</span>&nbsp;<span class="num" id="5789627">0</span>&nbsp;<span class="op" id="5789629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789635">h</span><span class="op" id="5789636">.</span><span class="ident" id="5789637">minCodes</span><span class="op" id="5789645">[</span><span class="ident" id="5789646">i</span><span class="op" id="5789647">]</span>&nbsp;<span class="op" id="5789649">=</span>&nbsp;<span class="op" id="5789651">-</span><span class="num" id="5789652">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789658">h</span><span class="op" id="5789659">.</span><span class="ident" id="5789660">maxCodes</span><span class="op" id="5789668">[</span><span class="ident" id="5789669">i</span><span class="op" id="5789670">]</span>&nbsp;<span class="op" id="5789672">=</span>&nbsp;<span class="op" id="5789674">-</span><span class="num" id="5789675">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789681">h</span><span class="op" id="5789682">.</span><span class="ident" id="5789683">valsIndices</span><span class="op" id="5789694">[</span><span class="ident" id="5789695">i</span><span class="op" id="5789696">]</span>&nbsp;<span class="op" id="5789698">=</span>&nbsp;<span class="op" id="5789700">-</span><span class="num" id="5789701">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5789706">}</span>&nbsp;<span class="keyword" id="5789708">else</span>&nbsp;<span class="op" id="5789713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789719">h</span><span class="op" id="5789720">.</span><span class="ident" id="5789721">minCodes</span><span class="op" id="5789729">[</span><span class="ident" id="5789730">i</span><span class="op" id="5789731">]</span>&nbsp;<span class="op" id="5789733">=</span>&nbsp;<span class="ident" id="5789735">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789741">h</span><span class="op" id="5789742">.</span><span class="ident" id="5789743">maxCodes</span><span class="op" id="5789751">[</span><span class="ident" id="5789752">i</span><span class="op" id="5789753">]</span>&nbsp;<span class="op" id="5789755">=</span>&nbsp;<span class="ident" id="5789757">c</span>&nbsp;<span class="op" id="5789759">+</span>&nbsp;<span class="ident" id="5789761">n</span>&nbsp;<span class="op" id="5789763">-</span>&nbsp;<span class="num" id="5789765">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789771">h</span><span class="op" id="5789772">.</span><span class="ident" id="5789773">valsIndices</span><span class="op" id="5789784">[</span><span class="ident" id="5789785">i</span><span class="op" id="5789786">]</span>&nbsp;<span class="op" id="5789788">=</span>&nbsp;<span class="ident" id="5789790">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789800">c</span>&nbsp;<span class="op" id="5789802">+=</span>&nbsp;<span class="ident" id="5789805">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789811">index</span>&nbsp;<span class="op" id="5789817">+=</span>&nbsp;<span class="ident" id="5789820">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5789825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5789830">c</span>&nbsp;<span class="op" id="5789832">&lt;&lt;=</span>&nbsp;<span class="num" id="5789836">1</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5789840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5789843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5789846">return</span>&nbsp;<span class="ident" id="5789853">nil</span><br>
<span class="lineno"></span><span class="op" id="5789857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="5789860">//&nbsp;decodeHuffman&nbsp;returns&nbsp;the&nbsp;next&nbsp;Huffman-coded&nbsp;value&nbsp;from&nbsp;the&nbsp;bit-stream,</span><br>
<span class="lineno"></span><span class="comment" id="5789935">//&nbsp;decoded&nbsp;according&nbsp;to&nbsp;h.</span><br>
<span class="lineno"></span><span class="keyword" id="5789962">func</span>&nbsp;<span class="op" id="5789967">(</span><span class="ident" id="5789968">d</span>&nbsp;<span class="op" id="5789970">*</span><span class="ident" id="5789971">decoder</span><span class="op" id="5789978">)</span>&nbsp;<span class="ident" id="5789980">decodeHuffman</span><span class="op" id="5789993">(</span><span class="ident" id="5789994">h</span>&nbsp;<span class="op" id="5789996">*</span><span class="ident" id="5789997">huffman</span><span class="op" id="5790004">)</span>&nbsp;<span class="op" id="5790006">(</span><span class="builtintype" id="5790007">uint8</span><span class="op" id="5790012">,</span>&nbsp;<span class="builtintype" id="5790014">error</span><span class="op" id="5790019">)</span>&nbsp;<span class="op" id="5790021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790024">if</span>&nbsp;<span class="ident" id="5790027">h</span><span class="op" id="5790028">.</span><span class="ident" id="5790029">nCodes</span>&nbsp;<span class="op" id="5790036">==</span>&nbsp;<span class="num" id="5790039">0</span>&nbsp;<span class="op" id="5790041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790045">return</span>&nbsp;<span class="num" id="5790052">0</span><span class="op" id="5790053">,</span>&nbsp;<span class="ident" id="5790055">FormatError</span><span class="op" id="5790066">(</span><span class="string" id="5790067">&#34;uninitialized&nbsp;Huffman&nbsp;table&#34;</span><span class="op" id="5790096">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5790099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790103">if</span>&nbsp;<span class="ident" id="5790106">d</span><span class="op" id="5790107">.</span><span class="ident" id="5790108">bits</span><span class="op" id="5790112">.</span><span class="ident" id="5790113">n</span>&nbsp;<span class="op" id="5790115">&lt;</span>&nbsp;<span class="num" id="5790117">8</span>&nbsp;<span class="op" id="5790119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790123">if</span>&nbsp;<span class="ident" id="5790126">err</span>&nbsp;<span class="op" id="5790130">:=</span>&nbsp;<span class="ident" id="5790133">d</span><span class="op" id="5790134">.</span><span class="ident" id="5790135">ensureNBits</span><span class="op" id="5790146">(</span><span class="num" id="5790147">8</span><span class="op" id="5790148">)</span><span class="op" id="5790149">;</span>&nbsp;<span class="ident" id="5790151">err</span>&nbsp;<span class="op" id="5790155">!=</span>&nbsp;<span class="ident" id="5790158">nil</span>&nbsp;<span class="op" id="5790162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790167">if</span>&nbsp;<span class="ident" id="5790170">err</span>&nbsp;<span class="op" id="5790174">!=</span>&nbsp;<span class="ident" id="5790177">errMissingFF00</span>&nbsp;<span class="op" id="5790192">&amp;&amp;</span>&nbsp;<span class="ident" id="5790195">err</span>&nbsp;<span class="op" id="5790199">!=</span>&nbsp;<span class="ident" id="5790202">errShortHuffmanData</span>&nbsp;<span class="op" id="5790222">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790228">return</span>&nbsp;<span class="num" id="5790235">0</span><span class="op" id="5790236">,</span>&nbsp;<span class="ident" id="5790238">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5790245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5790250">//&nbsp;There&nbsp;are&nbsp;no&nbsp;more&nbsp;bytes&nbsp;of&nbsp;data&nbsp;in&nbsp;this&nbsp;segment,&nbsp;but&nbsp;we&nbsp;may&nbsp;still</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5790322">//&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;the&nbsp;next&nbsp;symbol&nbsp;out&nbsp;of&nbsp;the&nbsp;previously&nbsp;read&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5790393">//&nbsp;First,&nbsp;undo&nbsp;the&nbsp;readByte&nbsp;that&nbsp;the&nbsp;ensureNBits&nbsp;call&nbsp;made.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790456">d</span><span class="op" id="5790457">.</span><span class="ident" id="5790458">unreadByteStuffedByte</span><span class="op" id="5790479">(</span><span class="op" id="5790480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790485">goto</span>&nbsp;<span class="ident" id="5790490">slowPath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5790501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5790504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790507">if</span>&nbsp;<span class="ident" id="5790510">v</span>&nbsp;<span class="op" id="5790512">:=</span>&nbsp;<span class="ident" id="5790515">h</span><span class="op" id="5790516">.</span><span class="ident" id="5790517">lut</span><span class="op" id="5790520">[</span><span class="op" id="5790521">(</span><span class="ident" id="5790522">d</span><span class="op" id="5790523">.</span><span class="ident" id="5790524">bits</span><span class="op" id="5790528">.</span><span class="ident" id="5790529">a</span><span class="op" id="5790530">&gt;&gt;</span><span class="builtintype" id="5790532">uint32</span><span class="op" id="5790538">(</span><span class="ident" id="5790539">d</span><span class="op" id="5790540">.</span><span class="ident" id="5790541">bits</span><span class="op" id="5790545">.</span><span class="ident" id="5790546">n</span><span class="op" id="5790547">-</span><span class="ident" id="5790548">lutSize</span><span class="op" id="5790555">)</span><span class="op" id="5790556">)</span><span class="op" id="5790557">&amp;</span><span class="num" id="5790558">0xff</span><span class="op" id="5790562">]</span><span class="op" id="5790563">;</span>&nbsp;<span class="ident" id="5790565">v</span>&nbsp;<span class="op" id="5790567">!=</span>&nbsp;<span class="num" id="5790570">0</span>&nbsp;<span class="op" id="5790572">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790576">n</span>&nbsp;<span class="op" id="5790578">:=</span>&nbsp;<span class="op" id="5790581">(</span><span class="ident" id="5790582">v</span>&nbsp;<span class="op" id="5790584">&amp;</span>&nbsp;<span class="num" id="5790586">0xff</span><span class="op" id="5790590">)</span>&nbsp;<span class="op" id="5790592">-</span>&nbsp;<span class="num" id="5790594">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790598">d</span><span class="op" id="5790599">.</span><span class="ident" id="5790600">bits</span><span class="op" id="5790604">.</span><span class="ident" id="5790605">n</span>&nbsp;<span class="op" id="5790607">-=</span>&nbsp;<span class="builtintype" id="5790610">int32</span><span class="op" id="5790615">(</span><span class="ident" id="5790616">n</span><span class="op" id="5790617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790621">d</span><span class="op" id="5790622">.</span><span class="ident" id="5790623">bits</span><span class="op" id="5790627">.</span><span class="ident" id="5790628">m</span>&nbsp;<span class="op" id="5790630">&gt;&gt;=</span>&nbsp;<span class="ident" id="5790634">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790638">return</span>&nbsp;<span class="builtintype" id="5790645">uint8</span><span class="op" id="5790650">(</span><span class="ident" id="5790651">v</span>&nbsp;<span class="op" id="5790653">&gt;&gt;</span>&nbsp;<span class="num" id="5790656">8</span><span class="op" id="5790657">)</span><span class="op" id="5790658">,</span>&nbsp;<span class="ident" id="5790660">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5790665">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="ident" id="5790668">slowPath</span><span class="op" id="5790676">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790679">for</span>&nbsp;<span class="ident" id="5790683">i</span><span class="op" id="5790684">,</span>&nbsp;<span class="ident" id="5790686">code</span>&nbsp;<span class="op" id="5790691">:=</span>&nbsp;<span class="num" id="5790694">0</span><span class="op" id="5790695">,</span>&nbsp;<span class="builtintype" id="5790697">int32</span><span class="op" id="5790702">(</span><span class="num" id="5790703">0</span><span class="op" id="5790704">)</span><span class="op" id="5790705">;</span>&nbsp;<span class="ident" id="5790707">i</span>&nbsp;<span class="op" id="5790709">&lt;</span>&nbsp;<span class="ident" id="5790711">maxCodeLength</span><span class="op" id="5790724">;</span>&nbsp;<span class="ident" id="5790726">i</span><span class="op" id="5790727">++</span>&nbsp;<span class="op" id="5790730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790734">if</span>&nbsp;<span class="ident" id="5790737">d</span><span class="op" id="5790738">.</span><span class="ident" id="5790739">bits</span><span class="op" id="5790743">.</span><span class="ident" id="5790744">n</span>&nbsp;<span class="op" id="5790746">==</span>&nbsp;<span class="num" id="5790749">0</span>&nbsp;<span class="op" id="5790751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790756">if</span>&nbsp;<span class="ident" id="5790759">err</span>&nbsp;<span class="op" id="5790763">:=</span>&nbsp;<span class="ident" id="5790766">d</span><span class="op" id="5790767">.</span><span class="ident" id="5790768">ensureNBits</span><span class="op" id="5790779">(</span><span class="num" id="5790780">1</span><span class="op" id="5790781">)</span><span class="op" id="5790782">;</span>&nbsp;<span class="ident" id="5790784">err</span>&nbsp;<span class="op" id="5790788">!=</span>&nbsp;<span class="ident" id="5790791">nil</span>&nbsp;<span class="op" id="5790795">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790801">return</span>&nbsp;<span class="num" id="5790808">0</span><span class="op" id="5790809">,</span>&nbsp;<span class="ident" id="5790811">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5790818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5790822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790826">if</span>&nbsp;<span class="ident" id="5790829">d</span><span class="op" id="5790830">.</span><span class="ident" id="5790831">bits</span><span class="op" id="5790835">.</span><span class="ident" id="5790836">a</span><span class="op" id="5790837">&amp;</span><span class="ident" id="5790838">d</span><span class="op" id="5790839">.</span><span class="ident" id="5790840">bits</span><span class="op" id="5790844">.</span><span class="ident" id="5790845">m</span>&nbsp;<span class="op" id="5790847">!=</span>&nbsp;<span class="num" id="5790850">0</span>&nbsp;<span class="op" id="5790852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790857">code</span>&nbsp;<span class="op" id="5790862">|=</span>&nbsp;<span class="num" id="5790865">1</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5790869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790873">d</span><span class="op" id="5790874">.</span><span class="ident" id="5790875">bits</span><span class="op" id="5790879">.</span><span class="ident" id="5790880">n</span><span class="op" id="5790881">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790886">d</span><span class="op" id="5790887">.</span><span class="ident" id="5790888">bits</span><span class="op" id="5790892">.</span><span class="ident" id="5790893">m</span>&nbsp;<span class="op" id="5790895">&gt;&gt;=</span>&nbsp;<span class="num" id="5790899">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790903">if</span>&nbsp;<span class="ident" id="5790906">code</span>&nbsp;<span class="op" id="5790911">&lt;=</span>&nbsp;<span class="ident" id="5790914">h</span><span class="op" id="5790915">.</span><span class="ident" id="5790916">maxCodes</span><span class="op" id="5790924">[</span><span class="ident" id="5790925">i</span><span class="op" id="5790926">]</span>&nbsp;<span class="op" id="5790928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5790933">return</span>&nbsp;<span class="ident" id="5790940">h</span><span class="op" id="5790941">.</span><span class="ident" id="5790942">vals</span><span class="op" id="5790946">[</span><span class="ident" id="5790947">h</span><span class="op" id="5790948">.</span><span class="ident" id="5790949">valsIndices</span><span class="op" id="5790960">[</span><span class="ident" id="5790961">i</span><span class="op" id="5790962">]</span><span class="op" id="5790963">+</span><span class="ident" id="5790964">code</span><span class="op" id="5790968">-</span><span class="ident" id="5790969">h</span><span class="op" id="5790970">.</span><span class="ident" id="5790971">minCodes</span><span class="op" id="5790979">[</span><span class="ident" id="5790980">i</span><span class="op" id="5790981">]</span><span class="op" id="5790982">]</span><span class="op" id="5790983">,</span>&nbsp;<span class="ident" id="5790985">nil</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5790991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5790995">code</span>&nbsp;<span class="op" id="5791000">&lt;&lt;=</span>&nbsp;<span class="num" id="5791004">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5791007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791010">return</span>&nbsp;<span class="num" id="5791017">0</span><span class="op" id="5791018">,</span>&nbsp;<span class="ident" id="5791020">FormatError</span><span class="op" id="5791031">(</span><span class="string" id="5791032">&#34;bad&nbsp;Huffman&nbsp;code&#34;</span><span class="op" id="5791050">)</span><br>
<span class="lineno"></span><span class="op" id="5791052">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="5791055">func</span>&nbsp;<span class="op" id="5791060">(</span><span class="ident" id="5791061">d</span>&nbsp;<span class="op" id="5791063">*</span><span class="ident" id="5791064">decoder</span><span class="op" id="5791071">)</span>&nbsp;<span class="ident" id="5791073">decodeBit</span><span class="op" id="5791082">(</span><span class="op" id="5791083">)</span>&nbsp;<span class="op" id="5791085">(</span><span class="builtintype" id="5791086">bool</span><span class="op" id="5791090">,</span>&nbsp;<span class="builtintype" id="5791092">error</span><span class="op" id="5791097">)</span>&nbsp;<span class="op" id="5791099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791102">if</span>&nbsp;<span class="ident" id="5791105">d</span><span class="op" id="5791106">.</span><span class="ident" id="5791107">bits</span><span class="op" id="5791111">.</span><span class="ident" id="5791112">n</span>&nbsp;<span class="op" id="5791114">==</span>&nbsp;<span class="num" id="5791117">0</span>&nbsp;<span class="op" id="5791119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791123">if</span>&nbsp;<span class="ident" id="5791126">err</span>&nbsp;<span class="op" id="5791130">:=</span>&nbsp;<span class="ident" id="5791133">d</span><span class="op" id="5791134">.</span><span class="ident" id="5791135">ensureNBits</span><span class="op" id="5791146">(</span><span class="num" id="5791147">1</span><span class="op" id="5791148">)</span><span class="op" id="5791149">;</span>&nbsp;<span class="ident" id="5791151">err</span>&nbsp;<span class="op" id="5791155">!=</span>&nbsp;<span class="ident" id="5791158">nil</span>&nbsp;<span class="op" id="5791162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791167">return</span>&nbsp;<span class="builtintype" id="5791174">false</span><span class="op" id="5791179">,</span>&nbsp;<span class="ident" id="5791181">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5791187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5791190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791193">ret</span>&nbsp;<span class="op" id="5791197">:=</span>&nbsp;<span class="ident" id="5791200">d</span><span class="op" id="5791201">.</span><span class="ident" id="5791202">bits</span><span class="op" id="5791206">.</span><span class="ident" id="5791207">a</span><span class="op" id="5791208">&amp;</span><span class="ident" id="5791209">d</span><span class="op" id="5791210">.</span><span class="ident" id="5791211">bits</span><span class="op" id="5791215">.</span><span class="ident" id="5791216">m</span>&nbsp;<span class="op" id="5791218">!=</span>&nbsp;<span class="num" id="5791221">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791224">d</span><span class="op" id="5791225">.</span><span class="ident" id="5791226">bits</span><span class="op" id="5791230">.</span><span class="ident" id="5791231">n</span><span class="op" id="5791232">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791236">d</span><span class="op" id="5791237">.</span><span class="ident" id="5791238">bits</span><span class="op" id="5791242">.</span><span class="ident" id="5791243">m</span>&nbsp;<span class="op" id="5791245">&gt;&gt;=</span>&nbsp;<span class="num" id="5791249">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791252">return</span>&nbsp;<span class="ident" id="5791259">ret</span><span class="op" id="5791262">,</span>&nbsp;<span class="ident" id="5791264">nil</span><br>
<span class="lineno"></span><span class="op" id="5791268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5791271">func</span>&nbsp;<span class="op" id="5791276">(</span><span class="ident" id="5791277">d</span>&nbsp;<span class="op" id="5791279">*</span><span class="ident" id="5791280">decoder</span><span class="op" id="5791287">)</span>&nbsp;<span class="ident" id="5791289">decodeBits</span><span class="op" id="5791299">(</span><span class="ident" id="5791300">n</span>&nbsp;<span class="builtintype" id="5791302">int32</span><span class="op" id="5791307">)</span>&nbsp;<span class="op" id="5791309">(</span><span class="builtintype" id="5791310">uint32</span><span class="op" id="5791316">,</span>&nbsp;<span class="builtintype" id="5791318">error</span><span class="op" id="5791323">)</span>&nbsp;<span class="op" id="5791325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791328">if</span>&nbsp;<span class="ident" id="5791331">d</span><span class="op" id="5791332">.</span><span class="ident" id="5791333">bits</span><span class="op" id="5791337">.</span><span class="ident" id="5791338">n</span>&nbsp;<span class="op" id="5791340">&lt;</span>&nbsp;<span class="ident" id="5791342">n</span>&nbsp;<span class="op" id="5791344">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791348">if</span>&nbsp;<span class="ident" id="5791351">err</span>&nbsp;<span class="op" id="5791355">:=</span>&nbsp;<span class="ident" id="5791358">d</span><span class="op" id="5791359">.</span><span class="ident" id="5791360">ensureNBits</span><span class="op" id="5791371">(</span><span class="ident" id="5791372">n</span><span class="op" id="5791373">)</span><span class="op" id="5791374">;</span>&nbsp;<span class="ident" id="5791376">err</span>&nbsp;<span class="op" id="5791380">!=</span>&nbsp;<span class="ident" id="5791383">nil</span>&nbsp;<span class="op" id="5791387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791392">return</span>&nbsp;<span class="num" id="5791399">0</span><span class="op" id="5791400">,</span>&nbsp;<span class="ident" id="5791402">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5791408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5791411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791414">ret</span>&nbsp;<span class="op" id="5791418">:=</span>&nbsp;<span class="ident" id="5791421">d</span><span class="op" id="5791422">.</span><span class="ident" id="5791423">bits</span><span class="op" id="5791427">.</span><span class="ident" id="5791428">a</span>&nbsp;<span class="op" id="5791430">&gt;&gt;</span>&nbsp;<span class="builtintype" id="5791433">uint32</span><span class="op" id="5791439">(</span><span class="ident" id="5791440">d</span><span class="op" id="5791441">.</span><span class="ident" id="5791442">bits</span><span class="op" id="5791446">.</span><span class="ident" id="5791447">n</span><span class="op" id="5791448">-</span><span class="ident" id="5791449">n</span><span class="op" id="5791450">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791453">ret</span>&nbsp;<span class="op" id="5791457">&amp;=</span>&nbsp;<span class="op" id="5791460">(</span><span class="num" id="5791461">1</span>&nbsp;<span class="op" id="5791463">&lt;&lt;</span>&nbsp;<span class="builtintype" id="5791466">uint32</span><span class="op" id="5791472">(</span><span class="ident" id="5791473">n</span><span class="op" id="5791474">)</span><span class="op" id="5791475">)</span>&nbsp;<span class="op" id="5791477">-</span>&nbsp;<span class="num" id="5791479">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791482">d</span><span class="op" id="5791483">.</span><span class="ident" id="5791484">bits</span><span class="op" id="5791488">.</span><span class="ident" id="5791489">n</span>&nbsp;<span class="op" id="5791491">-=</span>&nbsp;<span class="ident" id="5791494">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5791497">d</span><span class="op" id="5791498">.</span><span class="ident" id="5791499">bits</span><span class="op" id="5791503">.</span><span class="ident" id="5791504">m</span>&nbsp;<span class="op" id="5791506">&gt;&gt;=</span>&nbsp;<span class="builtintype" id="5791510">uint32</span><span class="op" id="5791516">(</span><span class="ident" id="5791517">n</span><span class="op" id="5791518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5791521">return</span>&nbsp;<span class="ident" id="5791528">ret</span><span class="op" id="5791531">,</span>&nbsp;<span class="ident" id="5791533">nil</span><br>
<span class="lineno"></span><span class="op" id="5791537">}</span>
</div>
</body>
</html>
