<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4979542">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4979597">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4979651">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4979702">package</span>&nbsp;<span class="ident" id="4979710">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4979720">import</span>&nbsp;<span class="op" id="4979727">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4979730">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4979739">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4979748">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4979758">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4979765">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4979771">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4979784">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4979791">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4979803">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4979814">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4979825">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4979832">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4979835">//&nbsp;One&nbsp;of&nbsp;the&nbsp;copies,&nbsp;say&nbsp;from&nbsp;b&nbsp;to&nbsp;r2,&nbsp;could&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using&nbsp;a&nbsp;more</span><br>
<span class="lineno"></span><span class="comment" id="4979908">//&nbsp;elaborate&nbsp;trick&nbsp;where&nbsp;the&nbsp;other&nbsp;copy&nbsp;is&nbsp;made&nbsp;during&nbsp;Request/Response.Write.</span><br>
<span class="lineno"></span><span class="comment" id="4979987">//&nbsp;This&nbsp;would&nbsp;complicate&nbsp;things&nbsp;too&nbsp;much,&nbsp;given&nbsp;that&nbsp;these&nbsp;functions&nbsp;are&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4980064">//&nbsp;debugging&nbsp;only.</span><br>
<span class="lineno">25</span><span class="keyword" id="4980083">func</span>&nbsp;<span class="ident" id="4980088">drainBody</span><span class="op" id="4980097">(</span><span class="ident" id="4980098">b</span>&nbsp;<span class="ident" id="4980100">io</span><span class="op" id="4980102">.</span><span class="ident" id="4980103">ReadCloser</span><span class="op" id="4980113">)</span>&nbsp;<span class="op" id="4980115">(</span><span class="ident" id="4980116">r1</span><span class="op" id="4980118">,</span>&nbsp;<span class="ident" id="4980120">r2</span>&nbsp;<span class="ident" id="4980123">io</span><span class="op" id="4980125">.</span><span class="ident" id="4980126">ReadCloser</span><span class="op" id="4980136">,</span>&nbsp;<span class="ident" id="4980138">err</span>&nbsp;<span class="builtintype" id="4980142">error</span><span class="op" id="4980147">)</span>&nbsp;<span class="op" id="4980149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4980152">var</span>&nbsp;<span class="ident" id="4980156">buf</span>&nbsp;<span class="ident" id="4980160">bytes</span><span class="op" id="4980165">.</span><span class="ident" id="4980166">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4980174">if</span>&nbsp;<span class="ident" id="4980177">_</span><span class="op" id="4980178">,</span>&nbsp;<span class="ident" id="4980180">err</span>&nbsp;<span class="op" id="4980184">=</span>&nbsp;<span class="ident" id="4980186">buf</span><span class="op" id="4980189">.</span><span class="ident" id="4980190">ReadFrom</span><span class="op" id="4980198">(</span><span class="ident" id="4980199">b</span><span class="op" id="4980200">)</span><span class="op" id="4980201">;</span>&nbsp;<span class="ident" id="4980203">err</span>&nbsp;<span class="op" id="4980207">!=</span>&nbsp;<span class="ident" id="4980210">nil</span>&nbsp;<span class="op" id="4980214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4980218">return</span>&nbsp;<span class="ident" id="4980225">nil</span><span class="op" id="4980228">,</span>&nbsp;<span class="ident" id="4980230">nil</span><span class="op" id="4980233">,</span>&nbsp;<span class="ident" id="4980235">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4980240">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4980243">if</span>&nbsp;<span class="ident" id="4980246">err</span>&nbsp;<span class="op" id="4980250">=</span>&nbsp;<span class="ident" id="4980252">b</span><span class="op" id="4980253">.</span><span class="ident" id="4980254">Close</span><span class="op" id="4980259">(</span><span class="op" id="4980260">)</span><span class="op" id="4980261">;</span>&nbsp;<span class="ident" id="4980263">err</span>&nbsp;<span class="op" id="4980267">!=</span>&nbsp;<span class="ident" id="4980270">nil</span>&nbsp;<span class="op" id="4980274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4980278">return</span>&nbsp;<span class="ident" id="4980285">nil</span><span class="op" id="4980288">,</span>&nbsp;<span class="ident" id="4980290">nil</span><span class="op" id="4980293">,</span>&nbsp;<span class="ident" id="4980295">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4980300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4980303">return</span>&nbsp;<span class="ident" id="4980310">ioutil</span><span class="op" id="4980316">.</span><span class="ident" id="4980317">NopCloser</span><span class="op" id="4980326">(</span><span class="op" id="4980327">&amp;</span><span class="ident" id="4980328">buf</span><span class="op" id="4980331">)</span><span class="op" id="4980332">,</span>&nbsp;<span class="ident" id="4980334">ioutil</span><span class="op" id="4980340">.</span><span class="ident" id="4980341">NopCloser</span><span class="op" id="4980350">(</span><span class="ident" id="4980351">bytes</span><span class="op" id="4980356">.</span><span class="ident" id="4980357">NewReader</span><span class="op" id="4980366">(</span><span class="ident" id="4980367">buf</span><span class="op" id="4980370">.</span><span class="ident" id="4980371">Bytes</span><span class="op" id="4980376">(</span><span class="op" id="4980377">)</span><span class="op" id="4980378">)</span><span class="op" id="4980379">)</span><span class="op" id="4980380">,</span>&nbsp;<span class="ident" id="4980382">nil</span><br>
<span class="lineno"></span><span class="op" id="4980386">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="4980389">//&nbsp;dumpConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;which&nbsp;writes&nbsp;to&nbsp;Writer&nbsp;and&nbsp;reads&nbsp;from&nbsp;Reader</span><br>
<span class="lineno"></span><span class="keyword" id="4980460">type</span>&nbsp;<span class="ident" id="4980465">dumpConn</span>&nbsp;<span class="keyword" id="4980474">struct</span>&nbsp;<span class="op" id="4980481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4980484">io</span><span class="op" id="4980486">.</span><span class="ident" id="4980487">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4980495">io</span><span class="op" id="4980497">.</span><span class="ident" id="4980498">Reader</span><br>
<span class="lineno">40</span><span class="op" id="4980505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4980508">func</span>&nbsp;<span class="op" id="4980513">(</span><span class="ident" id="4980514">c</span>&nbsp;<span class="op" id="4980516">*</span><span class="ident" id="4980517">dumpConn</span><span class="op" id="4980525">)</span>&nbsp;<span class="ident" id="4980527">Close</span><span class="op" id="4980532">(</span><span class="op" id="4980533">)</span>&nbsp;<span class="builtintype" id="4980535">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4980563">{</span>&nbsp;<span class="keyword" id="4980565">return</span>&nbsp;<span class="ident" id="4980572">nil</span>&nbsp;<span class="op" id="4980576">}</span><br>
<span class="lineno"></span><span class="keyword" id="4980578">func</span>&nbsp;<span class="op" id="4980583">(</span><span class="ident" id="4980584">c</span>&nbsp;<span class="op" id="4980586">*</span><span class="ident" id="4980587">dumpConn</span><span class="op" id="4980595">)</span>&nbsp;<span class="ident" id="4980597">LocalAddr</span><span class="op" id="4980606">(</span><span class="op" id="4980607">)</span>&nbsp;<span class="ident" id="4980609">net</span><span class="op" id="4980612">.</span><span class="ident" id="4980613">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4980633">{</span>&nbsp;<span class="keyword" id="4980635">return</span>&nbsp;<span class="ident" id="4980642">nil</span>&nbsp;<span class="op" id="4980646">}</span><br>
<span class="lineno"></span><span class="keyword" id="4980648">func</span>&nbsp;<span class="op" id="4980653">(</span><span class="ident" id="4980654">c</span>&nbsp;<span class="op" id="4980656">*</span><span class="ident" id="4980657">dumpConn</span><span class="op" id="4980665">)</span>&nbsp;<span class="ident" id="4980667">RemoteAddr</span><span class="op" id="4980677">(</span><span class="op" id="4980678">)</span>&nbsp;<span class="ident" id="4980680">net</span><span class="op" id="4980683">.</span><span class="ident" id="4980684">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4980703">{</span>&nbsp;<span class="keyword" id="4980705">return</span>&nbsp;<span class="ident" id="4980712">nil</span>&nbsp;<span class="op" id="4980716">}</span><br>
<span class="lineno">45</span><span class="keyword" id="4980718">func</span>&nbsp;<span class="op" id="4980723">(</span><span class="ident" id="4980724">c</span>&nbsp;<span class="op" id="4980726">*</span><span class="ident" id="4980727">dumpConn</span><span class="op" id="4980735">)</span>&nbsp;<span class="ident" id="4980737">SetDeadline</span><span class="op" id="4980748">(</span><span class="ident" id="4980749">t</span>&nbsp;<span class="ident" id="4980751">time</span><span class="op" id="4980755">.</span><span class="ident" id="4980756">Time</span><span class="op" id="4980760">)</span>&nbsp;<span class="builtintype" id="4980762">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4980773">{</span>&nbsp;<span class="keyword" id="4980775">return</span>&nbsp;<span class="ident" id="4980782">nil</span>&nbsp;<span class="op" id="4980786">}</span><br>
<span class="lineno"></span><span class="keyword" id="4980788">func</span>&nbsp;<span class="op" id="4980793">(</span><span class="ident" id="4980794">c</span>&nbsp;<span class="op" id="4980796">*</span><span class="ident" id="4980797">dumpConn</span><span class="op" id="4980805">)</span>&nbsp;<span class="ident" id="4980807">SetReadDeadline</span><span class="op" id="4980822">(</span><span class="ident" id="4980823">t</span>&nbsp;<span class="ident" id="4980825">time</span><span class="op" id="4980829">.</span><span class="ident" id="4980830">Time</span><span class="op" id="4980834">)</span>&nbsp;<span class="builtintype" id="4980836">error</span>&nbsp;&nbsp;<span class="op" id="4980843">{</span>&nbsp;<span class="keyword" id="4980845">return</span>&nbsp;<span class="ident" id="4980852">nil</span>&nbsp;<span class="op" id="4980856">}</span><br>
<span class="lineno"></span><span class="keyword" id="4980858">func</span>&nbsp;<span class="op" id="4980863">(</span><span class="ident" id="4980864">c</span>&nbsp;<span class="op" id="4980866">*</span><span class="ident" id="4980867">dumpConn</span><span class="op" id="4980875">)</span>&nbsp;<span class="ident" id="4980877">SetWriteDeadline</span><span class="op" id="4980893">(</span><span class="ident" id="4980894">t</span>&nbsp;<span class="ident" id="4980896">time</span><span class="op" id="4980900">.</span><span class="ident" id="4980901">Time</span><span class="op" id="4980905">)</span>&nbsp;<span class="builtintype" id="4980907">error</span>&nbsp;<span class="op" id="4980913">{</span>&nbsp;<span class="keyword" id="4980915">return</span>&nbsp;<span class="ident" id="4980922">nil</span>&nbsp;<span class="op" id="4980926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4980929">type</span>&nbsp;<span class="ident" id="4980934">neverEnding</span>&nbsp;<span class="builtintype" id="4980946">byte</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="4980952">func</span>&nbsp;<span class="op" id="4980957">(</span><span class="ident" id="4980958">b</span>&nbsp;<span class="ident" id="4980960">neverEnding</span><span class="op" id="4980971">)</span>&nbsp;<span class="ident" id="4980973">Read</span><span class="op" id="4980977">(</span><span class="ident" id="4980978">p</span>&nbsp;<span class="op" id="4980980">[</span><span class="op" id="4980981">]</span><span class="builtintype" id="4980982">byte</span><span class="op" id="4980986">)</span>&nbsp;<span class="op" id="4980988">(</span><span class="ident" id="4980989">n</span>&nbsp;<span class="builtintype" id="4980991">int</span><span class="op" id="4980994">,</span>&nbsp;<span class="ident" id="4980996">err</span>&nbsp;<span class="builtintype" id="4981000">error</span><span class="op" id="4981005">)</span>&nbsp;<span class="op" id="4981007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4981010">for</span>&nbsp;<span class="ident" id="4981014">i</span>&nbsp;<span class="op" id="4981016">:=</span>&nbsp;<span class="keyword" id="4981019">range</span>&nbsp;<span class="ident" id="4981025">p</span>&nbsp;<span class="op" id="4981027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4981031">p</span><span class="op" id="4981032">[</span><span class="ident" id="4981033">i</span><span class="op" id="4981034">]</span>&nbsp;<span class="op" id="4981036">=</span>&nbsp;<span class="builtintype" id="4981038">byte</span><span class="op" id="4981042">(</span><span class="ident" id="4981043">b</span><span class="op" id="4981044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4981047">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4981050">return</span>&nbsp;<span class="builtinfunc" id="4981057">len</span><span class="op" id="4981060">(</span><span class="ident" id="4981061">p</span><span class="op" id="4981062">)</span><span class="op" id="4981063">,</span>&nbsp;<span class="ident" id="4981065">nil</span><br>
<span class="lineno"></span><span class="op" id="4981069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4981072">//&nbsp;DumpRequestOut&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;includes</span><br>
<span class="lineno"></span><span class="comment" id="4981123">//&nbsp;headers&nbsp;that&nbsp;the&nbsp;standard&nbsp;http.Transport&nbsp;adds,</span><br>
<span class="lineno">60</span><span class="comment" id="4981173">//&nbsp;such&nbsp;as&nbsp;User-Agent.</span><br>
<span class="lineno"></span><span class="keyword" id="4981196">func</span>&nbsp;<span class="ident" id="4981201">DumpRequestOut</span><span class="op" id="4981215">(</span><span class="ident" id="4981216">req</span>&nbsp;<span class="op" id="4981220">*</span><span class="ident" id="4981221">http</span><span class="op" id="4981225">.</span><span class="ident" id="4981226">Request</span><span class="op" id="4981233">,</span>&nbsp;<span class="ident" id="4981235">body</span>&nbsp;<span class="builtintype" id="4981240">bool</span><span class="op" id="4981244">)</span>&nbsp;<span class="op" id="4981246">(</span><span class="op" id="4981247">[</span><span class="op" id="4981248">]</span><span class="builtintype" id="4981249">byte</span><span class="op" id="4981253">,</span>&nbsp;<span class="builtintype" id="4981255">error</span><span class="op" id="4981260">)</span>&nbsp;<span class="op" id="4981262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4981265">save</span>&nbsp;<span class="op" id="4981270">:=</span>&nbsp;<span class="ident" id="4981273">req</span><span class="op" id="4981276">.</span><span class="ident" id="4981277">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4981283">dummyBody</span>&nbsp;<span class="op" id="4981293">:=</span>&nbsp;<span class="builtintype" id="4981296">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4981303">if</span>&nbsp;<span class="op" id="4981306">!</span><span class="ident" id="4981307">body</span>&nbsp;<span class="op" id="4981312">||</span>&nbsp;<span class="ident" id="4981315">req</span><span class="op" id="4981318">.</span><span class="ident" id="4981319">Body</span>&nbsp;<span class="op" id="4981324">==</span>&nbsp;<span class="ident" id="4981327">nil</span>&nbsp;<span class="op" id="4981331">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4981335">req</span><span class="op" id="4981338">.</span><span class="ident" id="4981339">Body</span>&nbsp;<span class="op" id="4981344">=</span>&nbsp;<span class="ident" id="4981346">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4981352">if</span>&nbsp;<span class="ident" id="4981355">req</span><span class="op" id="4981358">.</span><span class="ident" id="4981359">ContentLength</span>&nbsp;<span class="op" id="4981373">!=</span>&nbsp;<span class="num" id="4981376">0</span>&nbsp;<span class="op" id="4981378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4981383">req</span><span class="op" id="4981386">.</span><span class="ident" id="4981387">Body</span>&nbsp;<span class="op" id="4981392">=</span>&nbsp;<span class="ident" id="4981394">ioutil</span><span class="op" id="4981400">.</span><span class="ident" id="4981401">NopCloser</span><span class="op" id="4981410">(</span><span class="ident" id="4981411">io</span><span class="op" id="4981413">.</span><span class="ident" id="4981414">LimitReader</span><span class="op" id="4981425">(</span><span class="ident" id="4981426">neverEnding</span><span class="op" id="4981437">(</span><span class="string" id="4981438">&#39;x&#39;</span><span class="op" id="4981441">)</span><span class="op" id="4981442">,</span>&nbsp;<span class="ident" id="4981444">req</span><span class="op" id="4981447">.</span><span class="ident" id="4981448">ContentLength</span><span class="op" id="4981461">)</span><span class="op" id="4981462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4981467">dummyBody</span>&nbsp;<span class="op" id="4981477">=</span>&nbsp;<span class="builtintype" id="4981479">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4981486">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4981489">}</span>&nbsp;<span class="keyword" id="4981491">else</span>&nbsp;<span class="op" id="4981496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4981500">var</span>&nbsp;<span class="ident" id="4981504">err</span>&nbsp;<span class="builtintype" id="4981508">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4981516">save</span><span class="op" id="4981520">,</span>&nbsp;<span class="ident" id="4981522">req</span><span class="op" id="4981525">.</span><span class="ident" id="4981526">Body</span><span class="op" id="4981530">,</span>&nbsp;<span class="ident" id="4981532">err</span>&nbsp;<span class="op" id="4981536">=</span>&nbsp;<span class="ident" id="4981538">drainBody</span><span class="op" id="4981547">(</span><span class="ident" id="4981548">req</span><span class="op" id="4981551">.</span><span class="ident" id="4981552">Body</span><span class="op" id="4981556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4981560">if</span>&nbsp;<span class="ident" id="4981563">err</span>&nbsp;<span class="op" id="4981567">!=</span>&nbsp;<span class="ident" id="4981570">nil</span>&nbsp;<span class="op" id="4981574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4981579">return</span>&nbsp;<span class="ident" id="4981586">nil</span><span class="op" id="4981589">,</span>&nbsp;<span class="ident" id="4981591">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4981597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4981600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4981604">//&nbsp;Since&nbsp;we&#39;re&nbsp;using&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;write&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4981674">//&nbsp;switch&nbsp;to&nbsp;http&nbsp;so&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;try&nbsp;to&nbsp;do&nbsp;an&nbsp;SSL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4981735">//&nbsp;negotiation&nbsp;with&nbsp;our&nbsp;dumpConn&nbsp;and&nbsp;its&nbsp;bytes.Buffer&nbsp;&amp;&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4981798">//&nbsp;The&nbsp;wire&nbsp;format&nbsp;for&nbsp;https&nbsp;and&nbsp;http&nbsp;are&nbsp;the&nbsp;same,&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4981859">reqSend</span>&nbsp;<span class="op" id="4981867">:=</span>&nbsp;<span class="ident" id="4981870">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4981875">if</span>&nbsp;<span class="ident" id="4981878">req</span><span class="op" id="4981881">.</span><span class="ident" id="4981882">URL</span><span class="op" id="4981885">.</span><span class="ident" id="4981886">Scheme</span>&nbsp;<span class="op" id="4981893">==</span>&nbsp;<span class="string" id="4981896">&#34;https&#34;</span>&nbsp;<span class="op" id="4981904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4981908">reqSend</span>&nbsp;<span class="op" id="4981916">=</span>&nbsp;<span class="builtinfunc" id="4981918">new</span><span class="op" id="4981921">(</span><span class="ident" id="4981922">http</span><span class="op" id="4981926">.</span><span class="ident" id="4981927">Request</span><span class="op" id="4981934">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4981938">*</span><span class="ident" id="4981939">reqSend</span>&nbsp;<span class="op" id="4981947">=</span>&nbsp;<span class="op" id="4981949">*</span><span class="ident" id="4981950">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4981956">reqSend</span><span class="op" id="4981963">.</span><span class="ident" id="4981964">URL</span>&nbsp;<span class="op" id="4981968">=</span>&nbsp;<span class="builtinfunc" id="4981970">new</span><span class="op" id="4981973">(</span><span class="ident" id="4981974">url</span><span class="op" id="4981977">.</span><span class="ident" id="4981978">URL</span><span class="op" id="4981981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4981985">*</span><span class="ident" id="4981986">reqSend</span><span class="op" id="4981993">.</span><span class="ident" id="4981994">URL</span>&nbsp;<span class="op" id="4981998">=</span>&nbsp;<span class="op" id="4982000">*</span><span class="ident" id="4982001">req</span><span class="op" id="4982004">.</span><span class="ident" id="4982005">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4982011">reqSend</span><span class="op" id="4982018">.</span><span class="ident" id="4982019">URL</span><span class="op" id="4982022">.</span><span class="ident" id="4982023">Scheme</span>&nbsp;<span class="op" id="4982030">=</span>&nbsp;<span class="string" id="4982032">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4982040">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4982044">//&nbsp;Use&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;record&nbsp;what&nbsp;we&nbsp;would&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4982107">//&nbsp;on&nbsp;the&nbsp;wire,&nbsp;but&nbsp;not&nbsp;using&nbsp;TCP.&nbsp;&nbsp;Use&nbsp;a&nbsp;Transport&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4982167">//&nbsp;custom&nbsp;dialer&nbsp;that&nbsp;returns&nbsp;a&nbsp;fake&nbsp;net.Conn&nbsp;that&nbsp;waits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4982225">//&nbsp;for&nbsp;the&nbsp;full&nbsp;input&nbsp;(and&nbsp;recording&nbsp;it),&nbsp;and&nbsp;then&nbsp;responds</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4982286">//&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4982313">var</span>&nbsp;<span class="ident" id="4982317">buf</span>&nbsp;<span class="ident" id="4982321">bytes</span><span class="op" id="4982326">.</span><span class="ident" id="4982327">Buffer</span>&nbsp;<span class="comment" id="4982334">//&nbsp;records&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4982357">pr</span><span class="op" id="4982359">,</span>&nbsp;<span class="ident" id="4982361">pw</span>&nbsp;<span class="op" id="4982364">:=</span>&nbsp;<span class="ident" id="4982367">io</span><span class="op" id="4982369">.</span><span class="ident" id="4982370">Pipe</span><span class="op" id="4982374">(</span><span class="op" id="4982375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4982378">defer</span>&nbsp;<span class="ident" id="4982384">pr</span><span class="op" id="4982386">.</span><span class="ident" id="4982387">Close</span><span class="op" id="4982392">(</span><span class="op" id="4982393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4982396">defer</span>&nbsp;<span class="ident" id="4982402">pw</span><span class="op" id="4982404">.</span><span class="ident" id="4982405">Close</span><span class="op" id="4982410">(</span><span class="op" id="4982411">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4982414">dr</span>&nbsp;<span class="op" id="4982417">:=</span>&nbsp;<span class="op" id="4982420">&amp;</span><span class="ident" id="4982421">delegateReader</span><span class="op" id="4982435">{</span><span class="ident" id="4982436">c</span><span class="op" id="4982437">:</span>&nbsp;<span class="builtinfunc" id="4982439">make</span><span class="op" id="4982443">(</span><span class="keyword" id="4982444">chan</span>&nbsp;<span class="ident" id="4982449">io</span><span class="op" id="4982451">.</span><span class="ident" id="4982452">Reader</span><span class="op" id="4982458">)</span><span class="op" id="4982459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4982462">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;request&nbsp;before&nbsp;replying&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4982526">go</span>&nbsp;<span class="keyword" id="4982529">func</span><span class="op" id="4982533">(</span><span class="op" id="4982534">)</span>&nbsp;<span class="op" id="4982536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4982540">req</span><span class="op" id="4982543">,</span>&nbsp;<span class="ident" id="4982545">err</span>&nbsp;<span class="op" id="4982549">:=</span>&nbsp;<span class="ident" id="4982552">http</span><span class="op" id="4982556">.</span><span class="ident" id="4982557">ReadRequest</span><span class="op" id="4982568">(</span><span class="ident" id="4982569">bufio</span><span class="op" id="4982574">.</span><span class="ident" id="4982575">NewReader</span><span class="op" id="4982584">(</span><span class="ident" id="4982585">pr</span><span class="op" id="4982587">)</span><span class="op" id="4982588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4982592">if</span>&nbsp;<span class="ident" id="4982595">err</span>&nbsp;<span class="op" id="4982599">==</span>&nbsp;<span class="ident" id="4982602">nil</span>&nbsp;<span class="op" id="4982606">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4982611">//&nbsp;Ensure&nbsp;all&nbsp;the&nbsp;body&nbsp;is&nbsp;read;&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4982656">//&nbsp;we&#39;ll&nbsp;get&nbsp;a&nbsp;partial&nbsp;dump.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4982688">io</span><span class="op" id="4982690">.</span><span class="ident" id="4982691">Copy</span><span class="op" id="4982695">(</span><span class="ident" id="4982696">ioutil</span><span class="op" id="4982702">.</span><span class="ident" id="4982703">Discard</span><span class="op" id="4982710">,</span>&nbsp;<span class="ident" id="4982712">req</span><span class="op" id="4982715">.</span><span class="ident" id="4982716">Body</span><span class="op" id="4982720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4982725">req</span><span class="op" id="4982728">.</span><span class="ident" id="4982729">Body</span><span class="op" id="4982733">.</span><span class="ident" id="4982734">Close</span><span class="op" id="4982739">(</span><span class="op" id="4982740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4982744">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4982748">dr</span><span class="op" id="4982750">.</span><span class="ident" id="4982751">c</span>&nbsp;<span class="op" id="4982753">&lt;-</span>&nbsp;<span class="ident" id="4982756">strings</span><span class="op" id="4982763">.</span><span class="ident" id="4982764">NewReader</span><span class="op" id="4982773">(</span><span class="string" id="4982774">&#34;HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content\r\n\r\n&#34;</span><span class="op" id="4982807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4982810">}</span><span class="op" id="4982811">(</span><span class="op" id="4982812">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4982816">t</span>&nbsp;<span class="op" id="4982818">:=</span>&nbsp;<span class="op" id="4982821">&amp;</span><span class="ident" id="4982822">http</span><span class="op" id="4982826">.</span><span class="ident" id="4982827">Transport</span><span class="op" id="4982836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4982840">DisableKeepAlives</span><span class="op" id="4982857">:</span>&nbsp;<span class="builtintype" id="4982859">true</span><span class="op" id="4982863">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4982867">Dial</span><span class="op" id="4982871">:</span>&nbsp;<span class="keyword" id="4982873">func</span><span class="op" id="4982877">(</span><span class="ident" id="4982878">net</span><span class="op" id="4982881">,</span>&nbsp;<span class="ident" id="4982883">addr</span>&nbsp;<span class="builtintype" id="4982888">string</span><span class="op" id="4982894">)</span>&nbsp;<span class="op" id="4982896">(</span><span class="ident" id="4982897">net</span><span class="op" id="4982900">.</span><span class="ident" id="4982901">Conn</span><span class="op" id="4982905">,</span>&nbsp;<span class="builtintype" id="4982907">error</span><span class="op" id="4982912">)</span>&nbsp;<span class="op" id="4982914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4982919">return</span>&nbsp;<span class="op" id="4982926">&amp;</span><span class="ident" id="4982927">dumpConn</span><span class="op" id="4982935">{</span><span class="ident" id="4982936">io</span><span class="op" id="4982938">.</span><span class="ident" id="4982939">MultiWriter</span><span class="op" id="4982950">(</span><span class="op" id="4982951">&amp;</span><span class="ident" id="4982952">buf</span><span class="op" id="4982955">,</span>&nbsp;<span class="ident" id="4982957">pw</span><span class="op" id="4982959">)</span><span class="op" id="4982960">,</span>&nbsp;<span class="ident" id="4982962">dr</span><span class="op" id="4982964">}</span><span class="op" id="4982965">,</span>&nbsp;<span class="ident" id="4982967">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4982973">}</span><span class="op" id="4982974">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4982977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4982981">_</span><span class="op" id="4982982">,</span>&nbsp;<span class="ident" id="4982984">err</span>&nbsp;<span class="op" id="4982988">:=</span>&nbsp;<span class="ident" id="4982991">t</span><span class="op" id="4982992">.</span><span class="ident" id="4982993">RoundTrip</span><span class="op" id="4983002">(</span><span class="ident" id="4983003">reqSend</span><span class="op" id="4983010">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4983014">req</span><span class="op" id="4983017">.</span><span class="ident" id="4983018">Body</span>&nbsp;<span class="op" id="4983023">=</span>&nbsp;<span class="ident" id="4983025">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4983031">if</span>&nbsp;<span class="ident" id="4983034">err</span>&nbsp;<span class="op" id="4983038">!=</span>&nbsp;<span class="ident" id="4983041">nil</span>&nbsp;<span class="op" id="4983045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4983049">return</span>&nbsp;<span class="ident" id="4983056">nil</span><span class="op" id="4983059">,</span>&nbsp;<span class="ident" id="4983061">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4983066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4983069">dump</span>&nbsp;<span class="op" id="4983074">:=</span>&nbsp;<span class="ident" id="4983077">buf</span><span class="op" id="4983080">.</span><span class="ident" id="4983081">Bytes</span><span class="op" id="4983086">(</span><span class="op" id="4983087">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4983091">//&nbsp;If&nbsp;we&nbsp;used&nbsp;a&nbsp;dummy&nbsp;body&nbsp;above,&nbsp;remove&nbsp;it&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4983141">//&nbsp;TODO:&nbsp;if&nbsp;the&nbsp;req.ContentLength&nbsp;is&nbsp;large,&nbsp;we&nbsp;allocate&nbsp;memory</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4983205">//&nbsp;unnecessarily&nbsp;just&nbsp;to&nbsp;slice&nbsp;it&nbsp;off&nbsp;here.&nbsp;&nbsp;But&nbsp;this&nbsp;is&nbsp;just</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4983268">//&nbsp;a&nbsp;debug&nbsp;function,&nbsp;so&nbsp;this&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;now.&nbsp;We&nbsp;could</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4983330">//&nbsp;discard&nbsp;the&nbsp;body&nbsp;earlier&nbsp;if&nbsp;this&nbsp;matters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4983376">if</span>&nbsp;<span class="ident" id="4983379">dummyBody</span>&nbsp;<span class="op" id="4983389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4983393">if</span>&nbsp;<span class="ident" id="4983396">i</span>&nbsp;<span class="op" id="4983398">:=</span>&nbsp;<span class="ident" id="4983401">bytes</span><span class="op" id="4983406">.</span><span class="ident" id="4983407">Index</span><span class="op" id="4983412">(</span><span class="ident" id="4983413">dump</span><span class="op" id="4983417">,</span>&nbsp;<span class="op" id="4983419">[</span><span class="op" id="4983420">]</span><span class="builtintype" id="4983421">byte</span><span class="op" id="4983425">(</span><span class="string" id="4983426">&#34;\r\n\r\n&#34;</span><span class="op" id="4983436">)</span><span class="op" id="4983437">)</span><span class="op" id="4983438">;</span>&nbsp;<span class="ident" id="4983440">i</span>&nbsp;<span class="op" id="4983442">&gt;=</span>&nbsp;<span class="num" id="4983445">0</span>&nbsp;<span class="op" id="4983447">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4983452">dump</span>&nbsp;<span class="op" id="4983457">=</span>&nbsp;<span class="ident" id="4983459">dump</span><span class="op" id="4983463">[</span><span class="op" id="4983464">:</span><span class="ident" id="4983465">i</span><span class="op" id="4983466">+</span><span class="num" id="4983467">4</span><span class="op" id="4983468">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4983472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4983475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4983478">return</span>&nbsp;<span class="ident" id="4983485">dump</span><span class="op" id="4983489">,</span>&nbsp;<span class="ident" id="4983491">nil</span><br>
<span class="lineno"></span><span class="op" id="4983495">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="4983498">//&nbsp;delegateReader&nbsp;is&nbsp;a&nbsp;reader&nbsp;that&nbsp;delegates&nbsp;to&nbsp;another&nbsp;reader,</span><br>
<span class="lineno"></span><span class="comment" id="4983562">//&nbsp;once&nbsp;it&nbsp;arrives&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="4983595">type</span>&nbsp;<span class="ident" id="4983600">delegateReader</span>&nbsp;<span class="keyword" id="4983615">struct</span>&nbsp;<span class="op" id="4983622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4983625">c</span>&nbsp;<span class="keyword" id="4983627">chan</span>&nbsp;<span class="ident" id="4983632">io</span><span class="op" id="4983634">.</span><span class="ident" id="4983635">Reader</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4983643">r</span>&nbsp;<span class="ident" id="4983645">io</span><span class="op" id="4983647">.</span><span class="ident" id="4983648">Reader</span>&nbsp;<span class="comment" id="4983655">//&nbsp;nil&nbsp;until&nbsp;received&nbsp;from&nbsp;c</span><br>
<span class="lineno"></span><span class="op" id="4983684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4983687">func</span>&nbsp;<span class="op" id="4983692">(</span><span class="ident" id="4983693">r</span>&nbsp;<span class="op" id="4983695">*</span><span class="ident" id="4983696">delegateReader</span><span class="op" id="4983710">)</span>&nbsp;<span class="ident" id="4983712">Read</span><span class="op" id="4983716">(</span><span class="ident" id="4983717">p</span>&nbsp;<span class="op" id="4983719">[</span><span class="op" id="4983720">]</span><span class="builtintype" id="4983721">byte</span><span class="op" id="4983725">)</span>&nbsp;<span class="op" id="4983727">(</span><span class="builtintype" id="4983728">int</span><span class="op" id="4983731">,</span>&nbsp;<span class="builtintype" id="4983733">error</span><span class="op" id="4983738">)</span>&nbsp;<span class="op" id="4983740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4983743">if</span>&nbsp;<span class="ident" id="4983746">r</span><span class="op" id="4983747">.</span><span class="ident" id="4983748">r</span>&nbsp;<span class="op" id="4983750">==</span>&nbsp;<span class="ident" id="4983753">nil</span>&nbsp;<span class="op" id="4983757">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4983761">r</span><span class="op" id="4983762">.</span><span class="ident" id="4983763">r</span>&nbsp;<span class="op" id="4983765">=</span>&nbsp;<span class="op" id="4983767">&lt;-</span><span class="ident" id="4983769">r</span><span class="op" id="4983770">.</span><span class="ident" id="4983771">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4983774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4983777">return</span>&nbsp;<span class="ident" id="4983784">r</span><span class="op" id="4983785">.</span><span class="ident" id="4983786">r</span><span class="op" id="4983787">.</span><span class="ident" id="4983788">Read</span><span class="op" id="4983792">(</span><span class="ident" id="4983793">p</span><span class="op" id="4983794">)</span><br>
<span class="lineno"></span><span class="op" id="4983796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="4983799">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="4983843">func</span>&nbsp;<span class="ident" id="4983848">valueOrDefault</span><span class="op" id="4983862">(</span><span class="ident" id="4983863">value</span><span class="op" id="4983868">,</span>&nbsp;<span class="ident" id="4983870">def</span>&nbsp;<span class="builtintype" id="4983874">string</span><span class="op" id="4983880">)</span>&nbsp;<span class="builtintype" id="4983882">string</span>&nbsp;<span class="op" id="4983889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4983892">if</span>&nbsp;<span class="ident" id="4983895">value</span>&nbsp;<span class="op" id="4983901">!=</span>&nbsp;<span class="string" id="4983904">&#34;&#34;</span>&nbsp;<span class="op" id="4983907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4983911">return</span>&nbsp;<span class="ident" id="4983918">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4983925">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4983928">return</span>&nbsp;<span class="ident" id="4983935">def</span><br>
<span class="lineno"></span><span class="op" id="4983939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4983942">var</span>&nbsp;<span class="ident" id="4983946">reqWriteExcludeHeaderDump</span>&nbsp;<span class="op" id="4983972">=</span>&nbsp;<span class="keyword" id="4983974">map</span><span class="op" id="4983977">[</span><span class="builtintype" id="4983978">string</span><span class="op" id="4983984">]</span><span class="builtintype" id="4983985">bool</span><span class="op" id="4983989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4983992">&#34;Host&#34;</span><span class="op" id="4983998">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4984013">true</span><span class="op" id="4984017">,</span>&nbsp;<span class="comment" id="4984019">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984048">&#34;Content-Length&#34;</span><span class="op" id="4984064">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4984069">true</span><span class="op" id="4984073">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984076">&#34;Transfer-Encoding&#34;</span><span class="op" id="4984095">:</span>&nbsp;<span class="builtintype" id="4984097">true</span><span class="op" id="4984101">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984104">&#34;Trailer&#34;</span><span class="op" id="4984113">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4984125">true</span><span class="op" id="4984129">,</span><br>
<span class="lineno"></span><span class="op" id="4984131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="4984134">//&nbsp;dumpAsReceived&nbsp;writes&nbsp;req&nbsp;to&nbsp;w&nbsp;in&nbsp;the&nbsp;form&nbsp;as&nbsp;it&nbsp;was&nbsp;received,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4984203">//&nbsp;at&nbsp;least&nbsp;as&nbsp;accurately&nbsp;as&nbsp;possible&nbsp;from&nbsp;the&nbsp;information&nbsp;retained&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4984274">//&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword" id="4984290">func</span>&nbsp;<span class="ident" id="4984295">dumpAsReceived</span><span class="op" id="4984309">(</span><span class="ident" id="4984310">req</span>&nbsp;<span class="op" id="4984314">*</span><span class="ident" id="4984315">http</span><span class="op" id="4984319">.</span><span class="ident" id="4984320">Request</span><span class="op" id="4984327">,</span>&nbsp;<span class="ident" id="4984329">w</span>&nbsp;<span class="ident" id="4984331">io</span><span class="op" id="4984333">.</span><span class="ident" id="4984334">Writer</span><span class="op" id="4984340">)</span>&nbsp;<span class="builtintype" id="4984342">error</span>&nbsp;<span class="op" id="4984348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4984351">return</span>&nbsp;<span class="ident" id="4984358">nil</span><br>
<span class="lineno">175</span><span class="op" id="4984362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4984365">//&nbsp;DumpRequest&nbsp;returns&nbsp;the&nbsp;as-received&nbsp;wire&nbsp;representation&nbsp;of&nbsp;req,</span><br>
<span class="lineno"></span><span class="comment" id="4984432">//&nbsp;optionally&nbsp;including&nbsp;the&nbsp;request&nbsp;body,&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="comment" id="4984489">//&nbsp;DumpRequest&nbsp;is&nbsp;semantically&nbsp;a&nbsp;no-op,&nbsp;but&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno">180</span><span class="comment" id="4984545">//&nbsp;dump&nbsp;the&nbsp;body,&nbsp;it&nbsp;reads&nbsp;the&nbsp;body&nbsp;data&nbsp;into&nbsp;memory&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4984602">//&nbsp;changes&nbsp;req.Body&nbsp;to&nbsp;refer&nbsp;to&nbsp;the&nbsp;in-memory&nbsp;copy.</span><br>
<span class="lineno"></span><span class="comment" id="4984654">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;http.Request.Write&nbsp;details&nbsp;which&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="4984719">//&nbsp;of&nbsp;req&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4984739">func</span>&nbsp;<span class="ident" id="4984744">DumpRequest</span><span class="op" id="4984755">(</span><span class="ident" id="4984756">req</span>&nbsp;<span class="op" id="4984760">*</span><span class="ident" id="4984761">http</span><span class="op" id="4984765">.</span><span class="ident" id="4984766">Request</span><span class="op" id="4984773">,</span>&nbsp;<span class="ident" id="4984775">body</span>&nbsp;<span class="builtintype" id="4984780">bool</span><span class="op" id="4984784">)</span>&nbsp;<span class="op" id="4984786">(</span><span class="ident" id="4984787">dump</span>&nbsp;<span class="op" id="4984792">[</span><span class="op" id="4984793">]</span><span class="builtintype" id="4984794">byte</span><span class="op" id="4984798">,</span>&nbsp;<span class="ident" id="4984800">err</span>&nbsp;<span class="builtintype" id="4984804">error</span><span class="op" id="4984809">)</span>&nbsp;<span class="op" id="4984811">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4984814">save</span>&nbsp;<span class="op" id="4984819">:=</span>&nbsp;<span class="ident" id="4984822">req</span><span class="op" id="4984825">.</span><span class="ident" id="4984826">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4984832">if</span>&nbsp;<span class="op" id="4984835">!</span><span class="ident" id="4984836">body</span>&nbsp;<span class="op" id="4984841">||</span>&nbsp;<span class="ident" id="4984844">req</span><span class="op" id="4984847">.</span><span class="ident" id="4984848">Body</span>&nbsp;<span class="op" id="4984853">==</span>&nbsp;<span class="ident" id="4984856">nil</span>&nbsp;<span class="op" id="4984860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4984864">req</span><span class="op" id="4984867">.</span><span class="ident" id="4984868">Body</span>&nbsp;<span class="op" id="4984873">=</span>&nbsp;<span class="ident" id="4984875">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4984880">}</span>&nbsp;<span class="keyword" id="4984882">else</span>&nbsp;<span class="op" id="4984887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4984891">save</span><span class="op" id="4984895">,</span>&nbsp;<span class="ident" id="4984897">req</span><span class="op" id="4984900">.</span><span class="ident" id="4984901">Body</span><span class="op" id="4984905">,</span>&nbsp;<span class="ident" id="4984907">err</span>&nbsp;<span class="op" id="4984911">=</span>&nbsp;<span class="ident" id="4984913">drainBody</span><span class="op" id="4984922">(</span><span class="ident" id="4984923">req</span><span class="op" id="4984926">.</span><span class="ident" id="4984927">Body</span><span class="op" id="4984931">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4984935">if</span>&nbsp;<span class="ident" id="4984938">err</span>&nbsp;<span class="op" id="4984942">!=</span>&nbsp;<span class="ident" id="4984945">nil</span>&nbsp;<span class="op" id="4984949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4984954">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4984963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4984966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4984970">var</span>&nbsp;<span class="ident" id="4984974">b</span>&nbsp;<span class="ident" id="4984976">bytes</span><span class="op" id="4984981">.</span><span class="ident" id="4984982">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4984991">fmt</span><span class="op" id="4984994">.</span><span class="ident" id="4984995">Fprintf</span><span class="op" id="4985002">(</span><span class="op" id="4985003">&amp;</span><span class="ident" id="4985004">b</span><span class="op" id="4985005">,</span>&nbsp;<span class="string" id="4985007">&#34;%s&nbsp;%s&nbsp;HTTP/%d.%d\r\n&#34;</span><span class="op" id="4985029">,</span>&nbsp;<span class="ident" id="4985031">valueOrDefault</span><span class="op" id="4985045">(</span><span class="ident" id="4985046">req</span><span class="op" id="4985049">.</span><span class="ident" id="4985050">Method</span><span class="op" id="4985056">,</span>&nbsp;<span class="string" id="4985058">&#34;GET&#34;</span><span class="op" id="4985063">)</span><span class="op" id="4985064">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985068">req</span><span class="op" id="4985071">.</span><span class="ident" id="4985072">URL</span><span class="op" id="4985075">.</span><span class="ident" id="4985076">RequestURI</span><span class="op" id="4985086">(</span><span class="op" id="4985087">)</span><span class="op" id="4985088">,</span>&nbsp;<span class="ident" id="4985090">req</span><span class="op" id="4985093">.</span><span class="ident" id="4985094">ProtoMajor</span><span class="op" id="4985104">,</span>&nbsp;<span class="ident" id="4985106">req</span><span class="op" id="4985109">.</span><span class="ident" id="4985110">ProtoMinor</span><span class="op" id="4985120">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985124">host</span>&nbsp;<span class="op" id="4985129">:=</span>&nbsp;<span class="ident" id="4985132">req</span><span class="op" id="4985135">.</span><span class="ident" id="4985136">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985142">if</span>&nbsp;<span class="ident" id="4985145">host</span>&nbsp;<span class="op" id="4985150">==</span>&nbsp;<span class="string" id="4985153">&#34;&#34;</span>&nbsp;<span class="op" id="4985156">&amp;&amp;</span>&nbsp;<span class="ident" id="4985159">req</span><span class="op" id="4985162">.</span><span class="ident" id="4985163">URL</span>&nbsp;<span class="op" id="4985167">!=</span>&nbsp;<span class="ident" id="4985170">nil</span>&nbsp;<span class="op" id="4985174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985178">host</span>&nbsp;<span class="op" id="4985183">=</span>&nbsp;<span class="ident" id="4985185">req</span><span class="op" id="4985188">.</span><span class="ident" id="4985189">URL</span><span class="op" id="4985192">.</span><span class="ident" id="4985193">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4985199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985202">if</span>&nbsp;<span class="ident" id="4985205">host</span>&nbsp;<span class="op" id="4985210">!=</span>&nbsp;<span class="string" id="4985213">&#34;&#34;</span>&nbsp;<span class="op" id="4985216">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985220">fmt</span><span class="op" id="4985223">.</span><span class="ident" id="4985224">Fprintf</span><span class="op" id="4985231">(</span><span class="op" id="4985232">&amp;</span><span class="ident" id="4985233">b</span><span class="op" id="4985234">,</span>&nbsp;<span class="string" id="4985236">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op" id="4985250">,</span>&nbsp;<span class="ident" id="4985252">host</span><span class="op" id="4985256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4985259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985263">chunked</span>&nbsp;<span class="op" id="4985271">:=</span>&nbsp;<span class="builtinfunc" id="4985274">len</span><span class="op" id="4985277">(</span><span class="ident" id="4985278">req</span><span class="op" id="4985281">.</span><span class="ident" id="4985282">TransferEncoding</span><span class="op" id="4985298">)</span>&nbsp;<span class="op" id="4985300">&gt;</span>&nbsp;<span class="num" id="4985302">0</span>&nbsp;<span class="op" id="4985304">&amp;&amp;</span>&nbsp;<span class="ident" id="4985307">req</span><span class="op" id="4985310">.</span><span class="ident" id="4985311">TransferEncoding</span><span class="op" id="4985327">[</span><span class="num" id="4985328">0</span><span class="op" id="4985329">]</span>&nbsp;<span class="op" id="4985331">==</span>&nbsp;<span class="string" id="4985334">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985345">if</span>&nbsp;<span class="builtinfunc" id="4985348">len</span><span class="op" id="4985351">(</span><span class="ident" id="4985352">req</span><span class="op" id="4985355">.</span><span class="ident" id="4985356">TransferEncoding</span><span class="op" id="4985372">)</span>&nbsp;<span class="op" id="4985374">&gt;</span>&nbsp;<span class="num" id="4985376">0</span>&nbsp;<span class="op" id="4985378">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985382">fmt</span><span class="op" id="4985385">.</span><span class="ident" id="4985386">Fprintf</span><span class="op" id="4985393">(</span><span class="op" id="4985394">&amp;</span><span class="ident" id="4985395">b</span><span class="op" id="4985396">,</span>&nbsp;<span class="string" id="4985398">&#34;Transfer-Encoding:&nbsp;%s\r\n&#34;</span><span class="op" id="4985425">,</span>&nbsp;<span class="ident" id="4985427">strings</span><span class="op" id="4985434">.</span><span class="ident" id="4985435">Join</span><span class="op" id="4985439">(</span><span class="ident" id="4985440">req</span><span class="op" id="4985443">.</span><span class="ident" id="4985444">TransferEncoding</span><span class="op" id="4985460">,</span>&nbsp;<span class="string" id="4985462">&#34;,&#34;</span><span class="op" id="4985465">)</span><span class="op" id="4985466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4985469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985472">if</span>&nbsp;<span class="ident" id="4985475">req</span><span class="op" id="4985478">.</span><span class="ident" id="4985479">Close</span>&nbsp;<span class="op" id="4985485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985489">fmt</span><span class="op" id="4985492">.</span><span class="ident" id="4985493">Fprintf</span><span class="op" id="4985500">(</span><span class="op" id="4985501">&amp;</span><span class="ident" id="4985502">b</span><span class="op" id="4985503">,</span>&nbsp;<span class="string" id="4985505">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="4985528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4985531">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985535">err</span>&nbsp;<span class="op" id="4985539">=</span>&nbsp;<span class="ident" id="4985541">req</span><span class="op" id="4985544">.</span><span class="ident" id="4985545">Header</span><span class="op" id="4985551">.</span><span class="ident" id="4985552">WriteSubset</span><span class="op" id="4985563">(</span><span class="op" id="4985564">&amp;</span><span class="ident" id="4985565">b</span><span class="op" id="4985566">,</span>&nbsp;<span class="ident" id="4985568">reqWriteExcludeHeaderDump</span><span class="op" id="4985593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985596">if</span>&nbsp;<span class="ident" id="4985599">err</span>&nbsp;<span class="op" id="4985603">!=</span>&nbsp;<span class="ident" id="4985606">nil</span>&nbsp;<span class="op" id="4985610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985614">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4985622">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985626">io</span><span class="op" id="4985628">.</span><span class="ident" id="4985629">WriteString</span><span class="op" id="4985640">(</span><span class="op" id="4985641">&amp;</span><span class="ident" id="4985642">b</span><span class="op" id="4985643">,</span>&nbsp;<span class="string" id="4985645">&#34;\r\n&#34;</span><span class="op" id="4985651">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985655">if</span>&nbsp;<span class="ident" id="4985658">req</span><span class="op" id="4985661">.</span><span class="ident" id="4985662">Body</span>&nbsp;<span class="op" id="4985667">!=</span>&nbsp;<span class="ident" id="4985670">nil</span>&nbsp;<span class="op" id="4985674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985678">var</span>&nbsp;<span class="ident" id="4985682">dest</span>&nbsp;<span class="ident" id="4985687">io</span><span class="op" id="4985689">.</span><span class="ident" id="4985690">Writer</span>&nbsp;<span class="op" id="4985697">=</span>&nbsp;<span class="op" id="4985699">&amp;</span><span class="ident" id="4985700">b</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985704">if</span>&nbsp;<span class="ident" id="4985707">chunked</span>&nbsp;<span class="op" id="4985715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985720">dest</span>&nbsp;<span class="op" id="4985725">=</span>&nbsp;<span class="ident" id="4985727">NewChunkedWriter</span><span class="op" id="4985743">(</span><span class="ident" id="4985744">dest</span><span class="op" id="4985748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4985752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985756">_</span><span class="op" id="4985757">,</span>&nbsp;<span class="ident" id="4985759">err</span>&nbsp;<span class="op" id="4985763">=</span>&nbsp;<span class="ident" id="4985765">io</span><span class="op" id="4985767">.</span><span class="ident" id="4985768">Copy</span><span class="op" id="4985772">(</span><span class="ident" id="4985773">dest</span><span class="op" id="4985777">,</span>&nbsp;<span class="ident" id="4985779">req</span><span class="op" id="4985782">.</span><span class="ident" id="4985783">Body</span><span class="op" id="4985787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985791">if</span>&nbsp;<span class="ident" id="4985794">chunked</span>&nbsp;<span class="op" id="4985802">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985807">dest</span><span class="op" id="4985811">.</span><span class="op" id="4985812">(</span><span class="ident" id="4985813">io</span><span class="op" id="4985815">.</span><span class="ident" id="4985816">Closer</span><span class="op" id="4985822">)</span><span class="op" id="4985823">.</span><span class="ident" id="4985824">Close</span><span class="op" id="4985829">(</span><span class="op" id="4985830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985835">io</span><span class="op" id="4985837">.</span><span class="ident" id="4985838">WriteString</span><span class="op" id="4985849">(</span><span class="op" id="4985850">&amp;</span><span class="ident" id="4985851">b</span><span class="op" id="4985852">,</span>&nbsp;<span class="string" id="4985854">&#34;\r\n&#34;</span><span class="op" id="4985860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4985864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4985867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985871">req</span><span class="op" id="4985874">.</span><span class="ident" id="4985875">Body</span>&nbsp;<span class="op" id="4985880">=</span>&nbsp;<span class="ident" id="4985882">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985888">if</span>&nbsp;<span class="ident" id="4985891">err</span>&nbsp;<span class="op" id="4985895">!=</span>&nbsp;<span class="ident" id="4985898">nil</span>&nbsp;<span class="op" id="4985902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985906">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4985914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985917">dump</span>&nbsp;<span class="op" id="4985922">=</span>&nbsp;<span class="ident" id="4985924">b</span><span class="op" id="4985925">.</span><span class="ident" id="4985926">Bytes</span><span class="op" id="4985931">(</span><span class="op" id="4985932">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985935">return</span><br>
<span class="lineno"></span><span class="op" id="4985942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4985945">//&nbsp;errNoBody&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;error&nbsp;value&nbsp;used&nbsp;by&nbsp;failureToReadBody&nbsp;so&nbsp;we&nbsp;can&nbsp;detect</span><br>
<span class="lineno"></span><span class="comment" id="4986027">//&nbsp;that&nbsp;the&nbsp;lack&nbsp;of&nbsp;body&nbsp;was&nbsp;intentional.</span><br>
<span class="lineno">245</span><span class="keyword" id="4986069">var</span>&nbsp;<span class="ident" id="4986073">errNoBody</span>&nbsp;<span class="op" id="4986083">=</span>&nbsp;<span class="ident" id="4986085">errors</span><span class="op" id="4986091">.</span><span class="ident" id="4986092">New</span><span class="op" id="4986095">(</span><span class="string" id="4986096">&#34;sentinel&nbsp;error&nbsp;value&#34;</span><span class="op" id="4986118">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4986121">//&nbsp;failureToReadBody&nbsp;is&nbsp;a&nbsp;io.ReadCloser&nbsp;that&nbsp;just&nbsp;returns&nbsp;errNoBody&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4986192">//&nbsp;Read.&nbsp;&nbsp;It&#39;s&nbsp;swapped&nbsp;in&nbsp;when&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;want&nbsp;to&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4986261">//&nbsp;body,&nbsp;but&nbsp;need&nbsp;a&nbsp;non-nil&nbsp;one,&nbsp;and&nbsp;want&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;error</span><br>
<span class="lineno">250</span><span class="comment" id="4986328">//&nbsp;from&nbsp;reading&nbsp;the&nbsp;dummy&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="4986360">type</span>&nbsp;<span class="ident" id="4986365">failureToReadBody</span>&nbsp;<span class="keyword" id="4986383">struct</span><span class="op" id="4986389">{</span><span class="op" id="4986390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4986393">func</span>&nbsp;<span class="op" id="4986398">(</span><span class="ident" id="4986399">failureToReadBody</span><span class="op" id="4986416">)</span>&nbsp;<span class="ident" id="4986418">Read</span><span class="op" id="4986422">(</span><span class="op" id="4986423">[</span><span class="op" id="4986424">]</span><span class="builtintype" id="4986425">byte</span><span class="op" id="4986429">)</span>&nbsp;<span class="op" id="4986431">(</span><span class="builtintype" id="4986432">int</span><span class="op" id="4986435">,</span>&nbsp;<span class="builtintype" id="4986437">error</span><span class="op" id="4986442">)</span>&nbsp;<span class="op" id="4986444">{</span>&nbsp;<span class="keyword" id="4986446">return</span>&nbsp;<span class="num" id="4986453">0</span><span class="op" id="4986454">,</span>&nbsp;<span class="ident" id="4986456">errNoBody</span>&nbsp;<span class="op" id="4986466">}</span><br>
<span class="lineno"></span><span class="keyword" id="4986468">func</span>&nbsp;<span class="op" id="4986473">(</span><span class="ident" id="4986474">failureToReadBody</span><span class="op" id="4986491">)</span>&nbsp;<span class="ident" id="4986493">Close</span><span class="op" id="4986498">(</span><span class="op" id="4986499">)</span>&nbsp;<span class="builtintype" id="4986501">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4986519">{</span>&nbsp;<span class="keyword" id="4986521">return</span>&nbsp;<span class="ident" id="4986528">nil</span>&nbsp;<span class="op" id="4986532">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="4986535">var</span>&nbsp;<span class="ident" id="4986539">emptyBody</span>&nbsp;<span class="op" id="4986549">=</span>&nbsp;<span class="ident" id="4986551">ioutil</span><span class="op" id="4986557">.</span><span class="ident" id="4986558">NopCloser</span><span class="op" id="4986567">(</span><span class="ident" id="4986568">strings</span><span class="op" id="4986575">.</span><span class="ident" id="4986576">NewReader</span><span class="op" id="4986585">(</span><span class="string" id="4986586">&#34;&#34;</span><span class="op" id="4986588">)</span><span class="op" id="4986589">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4986592">//&nbsp;DumpResponse&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;dumps&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4986650">func</span>&nbsp;<span class="ident" id="4986655">DumpResponse</span><span class="op" id="4986667">(</span><span class="ident" id="4986668">resp</span>&nbsp;<span class="op" id="4986673">*</span><span class="ident" id="4986674">http</span><span class="op" id="4986678">.</span><span class="ident" id="4986679">Response</span><span class="op" id="4986687">,</span>&nbsp;<span class="ident" id="4986689">body</span>&nbsp;<span class="builtintype" id="4986694">bool</span><span class="op" id="4986698">)</span>&nbsp;<span class="op" id="4986700">(</span><span class="ident" id="4986701">dump</span>&nbsp;<span class="op" id="4986706">[</span><span class="op" id="4986707">]</span><span class="builtintype" id="4986708">byte</span><span class="op" id="4986712">,</span>&nbsp;<span class="ident" id="4986714">err</span>&nbsp;<span class="builtintype" id="4986718">error</span><span class="op" id="4986723">)</span>&nbsp;<span class="op" id="4986725">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4986728">var</span>&nbsp;<span class="ident" id="4986732">b</span>&nbsp;<span class="ident" id="4986734">bytes</span><span class="op" id="4986739">.</span><span class="ident" id="4986740">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986748">save</span>&nbsp;<span class="op" id="4986753">:=</span>&nbsp;<span class="ident" id="4986756">resp</span><span class="op" id="4986760">.</span><span class="ident" id="4986761">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986767">savecl</span>&nbsp;<span class="op" id="4986774">:=</span>&nbsp;<span class="ident" id="4986777">resp</span><span class="op" id="4986781">.</span><span class="ident" id="4986782">ContentLength</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4986798">if</span>&nbsp;<span class="op" id="4986801">!</span><span class="ident" id="4986802">body</span>&nbsp;<span class="op" id="4986807">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986811">resp</span><span class="op" id="4986815">.</span><span class="ident" id="4986816">Body</span>&nbsp;<span class="op" id="4986821">=</span>&nbsp;<span class="ident" id="4986823">failureToReadBody</span><span class="op" id="4986840">{</span><span class="op" id="4986841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4986844">}</span>&nbsp;<span class="keyword" id="4986846">else</span>&nbsp;<span class="keyword" id="4986851">if</span>&nbsp;<span class="ident" id="4986854">resp</span><span class="op" id="4986858">.</span><span class="ident" id="4986859">Body</span>&nbsp;<span class="op" id="4986864">==</span>&nbsp;<span class="ident" id="4986867">nil</span>&nbsp;<span class="op" id="4986871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986875">resp</span><span class="op" id="4986879">.</span><span class="ident" id="4986880">Body</span>&nbsp;<span class="op" id="4986885">=</span>&nbsp;<span class="ident" id="4986887">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4986898">}</span>&nbsp;<span class="keyword" id="4986900">else</span>&nbsp;<span class="op" id="4986905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986909">save</span><span class="op" id="4986913">,</span>&nbsp;<span class="ident" id="4986915">resp</span><span class="op" id="4986919">.</span><span class="ident" id="4986920">Body</span><span class="op" id="4986924">,</span>&nbsp;<span class="ident" id="4986926">err</span>&nbsp;<span class="op" id="4986930">=</span>&nbsp;<span class="ident" id="4986932">drainBody</span><span class="op" id="4986941">(</span><span class="ident" id="4986942">resp</span><span class="op" id="4986946">.</span><span class="ident" id="4986947">Body</span><span class="op" id="4986951">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4986955">if</span>&nbsp;<span class="ident" id="4986958">err</span>&nbsp;<span class="op" id="4986962">!=</span>&nbsp;<span class="ident" id="4986965">nil</span>&nbsp;<span class="op" id="4986969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4986974">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4986983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4986986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986989">err</span>&nbsp;<span class="op" id="4986993">=</span>&nbsp;<span class="ident" id="4986995">resp</span><span class="op" id="4986999">.</span><span class="ident" id="4987000">Write</span><span class="op" id="4987005">(</span><span class="op" id="4987006">&amp;</span><span class="ident" id="4987007">b</span><span class="op" id="4987008">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987011">if</span>&nbsp;<span class="ident" id="4987014">err</span>&nbsp;<span class="op" id="4987018">==</span>&nbsp;<span class="ident" id="4987021">errNoBody</span>&nbsp;<span class="op" id="4987031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4987035">err</span>&nbsp;<span class="op" id="4987039">=</span>&nbsp;<span class="ident" id="4987041">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4987046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4987049">resp</span><span class="op" id="4987053">.</span><span class="ident" id="4987054">Body</span>&nbsp;<span class="op" id="4987059">=</span>&nbsp;<span class="ident" id="4987061">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4987067">resp</span><span class="op" id="4987071">.</span><span class="ident" id="4987072">ContentLength</span>&nbsp;<span class="op" id="4987086">=</span>&nbsp;<span class="ident" id="4987088">savecl</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987096">if</span>&nbsp;<span class="ident" id="4987099">err</span>&nbsp;<span class="op" id="4987103">!=</span>&nbsp;<span class="ident" id="4987106">nil</span>&nbsp;<span class="op" id="4987110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987114">return</span>&nbsp;<span class="ident" id="4987121">nil</span><span class="op" id="4987124">,</span>&nbsp;<span class="ident" id="4987126">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4987131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987134">return</span>&nbsp;<span class="ident" id="4987141">b</span><span class="op" id="4987142">.</span><span class="ident" id="4987143">Bytes</span><span class="op" id="4987148">(</span><span class="op" id="4987149">)</span><span class="op" id="4987150">,</span>&nbsp;<span class="ident" id="4987152">nil</span><br>
<span class="lineno"></span><span class="op" id="4987156">}</span>
</div>
</body>
</html>
