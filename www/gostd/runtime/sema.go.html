<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html" class="current">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1648274">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1648329">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1648383">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1648434">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1648477">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1648523">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="1648575">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="1648615">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="1648666">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="1648704">//</span><br>
<span class="lineno"></span><span class="comment" id="1648707">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="1648755">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1648811">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="1648868">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="1648931">//</span><br>
<span class="lineno"></span><span class="comment" id="1648934">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="1648986">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1649021">package</span>&nbsp;<span class="ident" id="1649029">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1649038">import</span>&nbsp;<span class="string" id="1649045">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1649055">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1649098">type</span>&nbsp;<span class="ident" id="1649103">semaRoot</span>&nbsp;<span class="keyword" id="1649112">struct</span>&nbsp;<span class="op" id="1649119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649122">lock</span>&nbsp;&nbsp;<span class="ident" id="1649128">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649135">head</span>&nbsp;&nbsp;<span class="op" id="1649141">*</span><span class="ident" id="1649142">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649149">tail</span>&nbsp;&nbsp;<span class="op" id="1649155">*</span><span class="ident" id="1649156">sudog</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649163">nwait</span>&nbsp;<span class="builtintype" id="1649169">uint32</span>&nbsp;<span class="comment" id="1649176">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="1649217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1649220">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="1649270">const</span>&nbsp;<span class="ident" id="1649276">semTabSize</span>&nbsp;<span class="op" id="1649287">=</span>&nbsp;<span class="num" id="1649289">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1649294">var</span>&nbsp;<span class="ident" id="1649298">semtable</span>&nbsp;<span class="op" id="1649307">[</span><span class="ident" id="1649308">semTabSize</span><span class="op" id="1649318">]</span><span class="keyword" id="1649319">struct</span>&nbsp;<span class="op" id="1649326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649329">root</span>&nbsp;<span class="ident" id="1649334">semaRoot</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649344">pad</span>&nbsp;&nbsp;<span class="op" id="1649349">[</span><span class="ident" id="1649350">_CacheLineSize</span>&nbsp;<span class="op" id="1649365">-</span>&nbsp;<span class="ident" id="1649367">unsafe</span><span class="op" id="1649373">.</span><span class="ident" id="1649374">Sizeof</span><span class="op" id="1649380">(</span><span class="ident" id="1649381">semaRoot</span><span class="op" id="1649389">{</span><span class="op" id="1649390">}</span><span class="op" id="1649391">)</span><span class="op" id="1649392">]</span><span class="builtintype" id="1649393">byte</span><br>
<span class="lineno"></span><span class="op" id="1649398">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1649401">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="1649435">func</span>&nbsp;<span class="ident" id="1649440">asyncsemacquire</span><span class="op" id="1649455">(</span><span class="ident" id="1649456">addr</span>&nbsp;<span class="op" id="1649461">*</span><span class="builtintype" id="1649462">uint32</span><span class="op" id="1649468">)</span>&nbsp;<span class="op" id="1649470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649473">semacquire</span><span class="op" id="1649483">(</span><span class="ident" id="1649484">addr</span><span class="op" id="1649488">,</span>&nbsp;<span class="builtintype" id="1649490">true</span><span class="op" id="1649494">)</span><br>
<span class="lineno"></span><span class="op" id="1649496">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="1649499">func</span>&nbsp;<span class="ident" id="1649504">asyncsemrelease</span><span class="op" id="1649519">(</span><span class="ident" id="1649520">addr</span>&nbsp;<span class="op" id="1649525">*</span><span class="builtintype" id="1649526">uint32</span><span class="op" id="1649532">)</span>&nbsp;<span class="op" id="1649534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649537">semrelease</span><span class="op" id="1649547">(</span><span class="ident" id="1649548">addr</span><span class="op" id="1649552">)</span><br>
<span class="lineno"></span><span class="op" id="1649554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="1649557">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1649581">func</span>&nbsp;<span class="ident" id="1649586">semacquire</span><span class="op" id="1649596">(</span><span class="ident" id="1649597">addr</span>&nbsp;<span class="op" id="1649602">*</span><span class="builtintype" id="1649603">uint32</span><span class="op" id="1649609">,</span>&nbsp;<span class="ident" id="1649611">profile</span>&nbsp;<span class="builtintype" id="1649619">bool</span><span class="op" id="1649623">)</span>&nbsp;<span class="op" id="1649625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649628">gp</span>&nbsp;<span class="op" id="1649631">:=</span>&nbsp;<span class="ident" id="1649634">getg</span><span class="op" id="1649638">(</span><span class="op" id="1649639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1649642">if</span>&nbsp;<span class="ident" id="1649645">gp</span>&nbsp;<span class="op" id="1649648">!=</span>&nbsp;<span class="ident" id="1649651">gp</span><span class="op" id="1649653">.</span><span class="ident" id="1649654">m</span><span class="op" id="1649655">.</span><span class="ident" id="1649656">curg</span>&nbsp;<span class="op" id="1649661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649665">gothrow</span><span class="op" id="1649672">(</span><span class="string" id="1649673">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="1649704">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1649707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649711">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1649726">if</span>&nbsp;<span class="ident" id="1649729">cansemacquire</span><span class="op" id="1649742">(</span><span class="ident" id="1649743">addr</span><span class="op" id="1649747">)</span>&nbsp;<span class="op" id="1649749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1649753">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1649761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649765">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649782">//&nbsp;&nbsp;&nbsp;&nbsp;increment&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649809">//&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649866">//&nbsp;&nbsp;&nbsp;&nbsp;enqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649897">//&nbsp;&nbsp;&nbsp;&nbsp;sleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649907">//&nbsp;&nbsp;&nbsp;&nbsp;(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649955">s</span>&nbsp;<span class="op" id="1649957">:=</span>&nbsp;<span class="ident" id="1649960">acquireSudog</span><span class="op" id="1649972">(</span><span class="op" id="1649973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649976">root</span>&nbsp;<span class="op" id="1649981">:=</span>&nbsp;<span class="ident" id="1649984">semroot</span><span class="op" id="1649991">(</span><span class="ident" id="1649992">addr</span><span class="op" id="1649996">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649999">t0</span>&nbsp;<span class="op" id="1650002">:=</span>&nbsp;<span class="ident" id="1650005">int64</span><span class="op" id="1650010">(</span><span class="num" id="1650011">0</span><span class="op" id="1650012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650015">s</span><span class="op" id="1650016">.</span><span class="ident" id="1650017">releasetime</span>&nbsp;<span class="op" id="1650029">=</span>&nbsp;<span class="num" id="1650031">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650034">if</span>&nbsp;<span class="ident" id="1650037">profile</span>&nbsp;<span class="op" id="1650045">&amp;&amp;</span>&nbsp;<span class="ident" id="1650048">blockprofilerate</span>&nbsp;<span class="op" id="1650065">&gt;</span>&nbsp;<span class="num" id="1650067">0</span>&nbsp;<span class="op" id="1650069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650073">t0</span>&nbsp;<span class="op" id="1650076">=</span>&nbsp;<span class="ident" id="1650078">cputicks</span><span class="op" id="1650086">(</span><span class="op" id="1650087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650091">s</span><span class="op" id="1650092">.</span><span class="ident" id="1650093">releasetime</span>&nbsp;<span class="op" id="1650105">=</span>&nbsp;<span class="op" id="1650107">-</span><span class="num" id="1650108">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1650111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650114">for</span>&nbsp;<span class="op" id="1650118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650122">lock</span><span class="op" id="1650126">(</span><span class="op" id="1650127">&amp;</span><span class="ident" id="1650128">root</span><span class="op" id="1650132">.</span><span class="ident" id="1650133">lock</span><span class="op" id="1650137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1650141">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650207">xadd</span><span class="op" id="1650211">(</span><span class="op" id="1650212">&amp;</span><span class="ident" id="1650213">root</span><span class="op" id="1650217">.</span><span class="ident" id="1650218">nwait</span><span class="op" id="1650223">,</span>&nbsp;<span class="num" id="1650225">1</span><span class="op" id="1650226">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1650230">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650279">if</span>&nbsp;<span class="ident" id="1650282">cansemacquire</span><span class="op" id="1650295">(</span><span class="ident" id="1650296">addr</span><span class="op" id="1650300">)</span>&nbsp;<span class="op" id="1650302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650307">xadd</span><span class="op" id="1650311">(</span><span class="op" id="1650312">&amp;</span><span class="ident" id="1650313">root</span><span class="op" id="1650317">.</span><span class="ident" id="1650318">nwait</span><span class="op" id="1650323">,</span>&nbsp;<span class="op" id="1650325">-</span><span class="num" id="1650326">1</span><span class="op" id="1650327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650332">unlock</span><span class="op" id="1650338">(</span><span class="op" id="1650339">&amp;</span><span class="ident" id="1650340">root</span><span class="op" id="1650344">.</span><span class="ident" id="1650345">lock</span><span class="op" id="1650349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650354">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1650362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1650366">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1650430">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650473">root</span><span class="op" id="1650477">.</span><span class="ident" id="1650478">queue</span><span class="op" id="1650483">(</span><span class="ident" id="1650484">addr</span><span class="op" id="1650488">,</span>&nbsp;<span class="ident" id="1650490">s</span><span class="op" id="1650491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650495">goparkunlock</span><span class="op" id="1650507">(</span><span class="op" id="1650508">&amp;</span><span class="ident" id="1650509">root</span><span class="op" id="1650513">.</span><span class="ident" id="1650514">lock</span><span class="op" id="1650518">,</span>&nbsp;<span class="string" id="1650520">&#34;semacquire&#34;</span><span class="op" id="1650532">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650536">if</span>&nbsp;<span class="ident" id="1650539">cansemacquire</span><span class="op" id="1650552">(</span><span class="ident" id="1650553">addr</span><span class="op" id="1650557">)</span>&nbsp;<span class="op" id="1650559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650564">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1650572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1650575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650578">if</span>&nbsp;<span class="ident" id="1650581">s</span><span class="op" id="1650582">.</span><span class="ident" id="1650583">releasetime</span>&nbsp;<span class="op" id="1650595">&gt;</span>&nbsp;<span class="num" id="1650597">0</span>&nbsp;<span class="op" id="1650599">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650603">blockevent</span><span class="op" id="1650613">(</span><span class="ident" id="1650614">int64</span><span class="op" id="1650619">(</span><span class="ident" id="1650620">s</span><span class="op" id="1650621">.</span><span class="ident" id="1650622">releasetime</span><span class="op" id="1650633">)</span><span class="op" id="1650634">-</span><span class="ident" id="1650635">t0</span><span class="op" id="1650637">,</span>&nbsp;<span class="num" id="1650639">3</span><span class="op" id="1650640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1650643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650646">releaseSudog</span><span class="op" id="1650658">(</span><span class="ident" id="1650659">s</span><span class="op" id="1650660">)</span><br>
<span class="lineno"></span><span class="op" id="1650662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="1650665">func</span>&nbsp;<span class="ident" id="1650670">semrelease</span><span class="op" id="1650680">(</span><span class="ident" id="1650681">addr</span>&nbsp;<span class="op" id="1650686">*</span><span class="builtintype" id="1650687">uint32</span><span class="op" id="1650693">)</span>&nbsp;<span class="op" id="1650695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650698">root</span>&nbsp;<span class="op" id="1650703">:=</span>&nbsp;<span class="ident" id="1650706">semroot</span><span class="op" id="1650713">(</span><span class="ident" id="1650714">addr</span><span class="op" id="1650718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650721">xadd</span><span class="op" id="1650725">(</span><span class="ident" id="1650726">addr</span><span class="op" id="1650730">,</span>&nbsp;<span class="num" id="1650732">1</span><span class="op" id="1650733">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1650737">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1650764">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1650832">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650862">if</span>&nbsp;<span class="ident" id="1650865">atomicload</span><span class="op" id="1650875">(</span><span class="op" id="1650876">&amp;</span><span class="ident" id="1650877">root</span><span class="op" id="1650881">.</span><span class="ident" id="1650882">nwait</span><span class="op" id="1650887">)</span>&nbsp;<span class="op" id="1650889">==</span>&nbsp;<span class="num" id="1650892">0</span>&nbsp;<span class="op" id="1650894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650898">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1650906">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1650910">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650960">lock</span><span class="op" id="1650964">(</span><span class="op" id="1650965">&amp;</span><span class="ident" id="1650966">root</span><span class="op" id="1650970">.</span><span class="ident" id="1650971">lock</span><span class="op" id="1650975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650978">if</span>&nbsp;<span class="ident" id="1650981">atomicload</span><span class="op" id="1650991">(</span><span class="op" id="1650992">&amp;</span><span class="ident" id="1650993">root</span><span class="op" id="1650997">.</span><span class="ident" id="1650998">nwait</span><span class="op" id="1651003">)</span>&nbsp;<span class="op" id="1651005">==</span>&nbsp;<span class="num" id="1651008">0</span>&nbsp;<span class="op" id="1651010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1651014">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1651071">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651117">unlock</span><span class="op" id="1651123">(</span><span class="op" id="1651124">&amp;</span><span class="ident" id="1651125">root</span><span class="op" id="1651129">.</span><span class="ident" id="1651130">lock</span><span class="op" id="1651134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651138">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651149">s</span>&nbsp;<span class="op" id="1651151">:=</span>&nbsp;<span class="ident" id="1651154">root</span><span class="op" id="1651158">.</span><span class="ident" id="1651159">head</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651165">for</span>&nbsp;<span class="op" id="1651169">;</span>&nbsp;<span class="ident" id="1651171">s</span>&nbsp;<span class="op" id="1651173">!=</span>&nbsp;<span class="ident" id="1651176">nil</span><span class="op" id="1651179">;</span>&nbsp;<span class="ident" id="1651181">s</span>&nbsp;<span class="op" id="1651183">=</span>&nbsp;<span class="ident" id="1651185">s</span><span class="op" id="1651186">.</span><span class="ident" id="1651187">next</span>&nbsp;<span class="op" id="1651192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651196">if</span>&nbsp;<span class="ident" id="1651199">s</span><span class="op" id="1651200">.</span><span class="ident" id="1651201">elem</span>&nbsp;<span class="op" id="1651206">==</span>&nbsp;<span class="ident" id="1651209">unsafe</span><span class="op" id="1651215">.</span><span class="ident" id="1651216">Pointer</span><span class="op" id="1651223">(</span><span class="ident" id="1651224">addr</span><span class="op" id="1651228">)</span>&nbsp;<span class="op" id="1651230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651235">xadd</span><span class="op" id="1651239">(</span><span class="op" id="1651240">&amp;</span><span class="ident" id="1651241">root</span><span class="op" id="1651245">.</span><span class="ident" id="1651246">nwait</span><span class="op" id="1651251">,</span>&nbsp;<span class="op" id="1651253">-</span><span class="num" id="1651254">1</span><span class="op" id="1651255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651260">root</span><span class="op" id="1651264">.</span><span class="ident" id="1651265">dequeue</span><span class="op" id="1651272">(</span><span class="ident" id="1651273">s</span><span class="op" id="1651274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651279">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651293">unlock</span><span class="op" id="1651299">(</span><span class="op" id="1651300">&amp;</span><span class="ident" id="1651301">root</span><span class="op" id="1651305">.</span><span class="ident" id="1651306">lock</span><span class="op" id="1651310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651313">if</span>&nbsp;<span class="ident" id="1651316">s</span>&nbsp;<span class="op" id="1651318">!=</span>&nbsp;<span class="ident" id="1651321">nil</span>&nbsp;<span class="op" id="1651325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651329">if</span>&nbsp;<span class="ident" id="1651332">s</span><span class="op" id="1651333">.</span><span class="ident" id="1651334">releasetime</span>&nbsp;<span class="op" id="1651346">!=</span>&nbsp;<span class="num" id="1651349">0</span>&nbsp;<span class="op" id="1651351">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651356">s</span><span class="op" id="1651357">.</span><span class="ident" id="1651358">releasetime</span>&nbsp;<span class="op" id="1651370">=</span>&nbsp;<span class="ident" id="1651372">cputicks</span><span class="op" id="1651380">(</span><span class="op" id="1651381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651389">goready</span><span class="op" id="1651396">(</span><span class="ident" id="1651397">s</span><span class="op" id="1651398">.</span><span class="ident" id="1651399">g</span><span class="op" id="1651400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651403">}</span><br>
<span class="lineno"></span><span class="op" id="1651405">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="1651408">func</span>&nbsp;<span class="ident" id="1651413">semroot</span><span class="op" id="1651420">(</span><span class="ident" id="1651421">addr</span>&nbsp;<span class="op" id="1651426">*</span><span class="builtintype" id="1651427">uint32</span><span class="op" id="1651433">)</span>&nbsp;<span class="op" id="1651435">*</span><span class="ident" id="1651436">semaRoot</span>&nbsp;<span class="op" id="1651445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651448">return</span>&nbsp;<span class="op" id="1651455">&amp;</span><span class="ident" id="1651456">semtable</span><span class="op" id="1651464">[</span><span class="op" id="1651465">(</span><span class="builtintype" id="1651466">uintptr</span><span class="op" id="1651473">(</span><span class="ident" id="1651474">unsafe</span><span class="op" id="1651480">.</span><span class="ident" id="1651481">Pointer</span><span class="op" id="1651488">(</span><span class="ident" id="1651489">addr</span><span class="op" id="1651493">)</span><span class="op" id="1651494">)</span><span class="op" id="1651495">&gt;&gt;</span><span class="num" id="1651497">3</span><span class="op" id="1651498">)</span><span class="op" id="1651499">%</span><span class="ident" id="1651500">semTabSize</span><span class="op" id="1651510">]</span><span class="op" id="1651511">.</span><span class="ident" id="1651512">root</span><br>
<span class="lineno"></span><span class="op" id="1651517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="1651520">func</span>&nbsp;<span class="ident" id="1651525">cansemacquire</span><span class="op" id="1651538">(</span><span class="ident" id="1651539">addr</span>&nbsp;<span class="op" id="1651544">*</span><span class="builtintype" id="1651545">uint32</span><span class="op" id="1651551">)</span>&nbsp;<span class="builtintype" id="1651553">bool</span>&nbsp;<span class="op" id="1651558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651561">for</span>&nbsp;<span class="op" id="1651565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651569">v</span>&nbsp;<span class="op" id="1651571">:=</span>&nbsp;<span class="ident" id="1651574">atomicload</span><span class="op" id="1651584">(</span><span class="ident" id="1651585">addr</span><span class="op" id="1651589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651593">if</span>&nbsp;<span class="ident" id="1651596">v</span>&nbsp;<span class="op" id="1651598">==</span>&nbsp;<span class="num" id="1651601">0</span>&nbsp;<span class="op" id="1651603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651608">return</span>&nbsp;<span class="builtintype" id="1651615">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651627">if</span>&nbsp;<span class="ident" id="1651630">cas</span><span class="op" id="1651633">(</span><span class="ident" id="1651634">addr</span><span class="op" id="1651638">,</span>&nbsp;<span class="ident" id="1651640">v</span><span class="op" id="1651641">,</span>&nbsp;<span class="ident" id="1651643">v</span><span class="op" id="1651644">-</span><span class="num" id="1651645">1</span><span class="op" id="1651646">)</span>&nbsp;<span class="op" id="1651648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651653">return</span>&nbsp;<span class="builtintype" id="1651660">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651670">}</span><br>
<span class="lineno">150</span><span class="op" id="1651672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1651675">func</span>&nbsp;<span class="op" id="1651680">(</span><span class="ident" id="1651681">root</span>&nbsp;<span class="op" id="1651686">*</span><span class="ident" id="1651687">semaRoot</span><span class="op" id="1651695">)</span>&nbsp;<span class="ident" id="1651697">queue</span><span class="op" id="1651702">(</span><span class="ident" id="1651703">addr</span>&nbsp;<span class="op" id="1651708">*</span><span class="builtintype" id="1651709">uint32</span><span class="op" id="1651715">,</span>&nbsp;<span class="ident" id="1651717">s</span>&nbsp;<span class="op" id="1651719">*</span><span class="ident" id="1651720">sudog</span><span class="op" id="1651725">)</span>&nbsp;<span class="op" id="1651727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651730">s</span><span class="op" id="1651731">.</span><span class="ident" id="1651732">g</span>&nbsp;<span class="op" id="1651734">=</span>&nbsp;<span class="ident" id="1651736">getg</span><span class="op" id="1651740">(</span><span class="op" id="1651741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651744">s</span><span class="op" id="1651745">.</span><span class="ident" id="1651746">elem</span>&nbsp;<span class="op" id="1651751">=</span>&nbsp;<span class="ident" id="1651753">unsafe</span><span class="op" id="1651759">.</span><span class="ident" id="1651760">Pointer</span><span class="op" id="1651767">(</span><span class="ident" id="1651768">addr</span><span class="op" id="1651772">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651775">s</span><span class="op" id="1651776">.</span><span class="ident" id="1651777">next</span>&nbsp;<span class="op" id="1651782">=</span>&nbsp;<span class="ident" id="1651784">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651789">s</span><span class="op" id="1651790">.</span><span class="ident" id="1651791">prev</span>&nbsp;<span class="op" id="1651796">=</span>&nbsp;<span class="ident" id="1651798">root</span><span class="op" id="1651802">.</span><span class="ident" id="1651803">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651809">if</span>&nbsp;<span class="ident" id="1651812">root</span><span class="op" id="1651816">.</span><span class="ident" id="1651817">tail</span>&nbsp;<span class="op" id="1651822">!=</span>&nbsp;<span class="ident" id="1651825">nil</span>&nbsp;<span class="op" id="1651829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651833">root</span><span class="op" id="1651837">.</span><span class="ident" id="1651838">tail</span><span class="op" id="1651842">.</span><span class="ident" id="1651843">next</span>&nbsp;<span class="op" id="1651848">=</span>&nbsp;<span class="ident" id="1651850">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651853">}</span>&nbsp;<span class="keyword" id="1651855">else</span>&nbsp;<span class="op" id="1651860">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651864">root</span><span class="op" id="1651868">.</span><span class="ident" id="1651869">head</span>&nbsp;<span class="op" id="1651874">=</span>&nbsp;<span class="ident" id="1651876">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651882">root</span><span class="op" id="1651886">.</span><span class="ident" id="1651887">tail</span>&nbsp;<span class="op" id="1651892">=</span>&nbsp;<span class="ident" id="1651894">s</span><br>
<span class="lineno"></span><span class="op" id="1651896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="1651899">func</span>&nbsp;<span class="op" id="1651904">(</span><span class="ident" id="1651905">root</span>&nbsp;<span class="op" id="1651910">*</span><span class="ident" id="1651911">semaRoot</span><span class="op" id="1651919">)</span>&nbsp;<span class="ident" id="1651921">dequeue</span><span class="op" id="1651928">(</span><span class="ident" id="1651929">s</span>&nbsp;<span class="op" id="1651931">*</span><span class="ident" id="1651932">sudog</span><span class="op" id="1651937">)</span>&nbsp;<span class="op" id="1651939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651942">if</span>&nbsp;<span class="ident" id="1651945">s</span><span class="op" id="1651946">.</span><span class="ident" id="1651947">next</span>&nbsp;<span class="op" id="1651952">!=</span>&nbsp;<span class="ident" id="1651955">nil</span>&nbsp;<span class="op" id="1651959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651963">s</span><span class="op" id="1651964">.</span><span class="ident" id="1651965">next</span><span class="op" id="1651969">.</span><span class="ident" id="1651970">prev</span>&nbsp;<span class="op" id="1651975">=</span>&nbsp;<span class="ident" id="1651977">s</span><span class="op" id="1651978">.</span><span class="ident" id="1651979">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651985">}</span>&nbsp;<span class="keyword" id="1651987">else</span>&nbsp;<span class="op" id="1651992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651996">root</span><span class="op" id="1652000">.</span><span class="ident" id="1652001">tail</span>&nbsp;<span class="op" id="1652006">=</span>&nbsp;<span class="ident" id="1652008">s</span><span class="op" id="1652009">.</span><span class="ident" id="1652010">prev</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652019">if</span>&nbsp;<span class="ident" id="1652022">s</span><span class="op" id="1652023">.</span><span class="ident" id="1652024">prev</span>&nbsp;<span class="op" id="1652029">!=</span>&nbsp;<span class="ident" id="1652032">nil</span>&nbsp;<span class="op" id="1652036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652040">s</span><span class="op" id="1652041">.</span><span class="ident" id="1652042">prev</span><span class="op" id="1652046">.</span><span class="ident" id="1652047">next</span>&nbsp;<span class="op" id="1652052">=</span>&nbsp;<span class="ident" id="1652054">s</span><span class="op" id="1652055">.</span><span class="ident" id="1652056">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652062">}</span>&nbsp;<span class="keyword" id="1652064">else</span>&nbsp;<span class="op" id="1652069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652073">root</span><span class="op" id="1652077">.</span><span class="ident" id="1652078">head</span>&nbsp;<span class="op" id="1652083">=</span>&nbsp;<span class="ident" id="1652085">s</span><span class="op" id="1652086">.</span><span class="ident" id="1652087">next</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652096">s</span><span class="op" id="1652097">.</span><span class="ident" id="1652098">elem</span>&nbsp;<span class="op" id="1652103">=</span>&nbsp;<span class="ident" id="1652105">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652110">s</span><span class="op" id="1652111">.</span><span class="ident" id="1652112">next</span>&nbsp;<span class="op" id="1652117">=</span>&nbsp;<span class="ident" id="1652119">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652124">s</span><span class="op" id="1652125">.</span><span class="ident" id="1652126">prev</span>&nbsp;<span class="op" id="1652131">=</span>&nbsp;<span class="ident" id="1652133">nil</span><br>
<span class="lineno"></span><span class="op" id="1652137">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="1652140">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="1652180">type</span>&nbsp;<span class="ident" id="1652185">syncSema</span>&nbsp;<span class="keyword" id="1652194">struct</span>&nbsp;<span class="op" id="1652201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652204">lock</span>&nbsp;<span class="ident" id="1652209">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652216">head</span>&nbsp;<span class="op" id="1652221">*</span><span class="ident" id="1652222">sudog</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652229">tail</span>&nbsp;<span class="op" id="1652234">*</span><span class="ident" id="1652235">sudog</span><br>
<span class="lineno"></span><span class="op" id="1652241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1652244">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1652322">func</span>&nbsp;<span class="ident" id="1652327">syncsemacquire</span><span class="op" id="1652341">(</span><span class="ident" id="1652342">s</span>&nbsp;<span class="op" id="1652344">*</span><span class="ident" id="1652345">syncSema</span><span class="op" id="1652353">)</span>&nbsp;<span class="op" id="1652355">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652358">lock</span><span class="op" id="1652362">(</span><span class="op" id="1652363">&amp;</span><span class="ident" id="1652364">s</span><span class="op" id="1652365">.</span><span class="ident" id="1652366">lock</span><span class="op" id="1652370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652373">if</span>&nbsp;<span class="ident" id="1652376">s</span><span class="op" id="1652377">.</span><span class="ident" id="1652378">head</span>&nbsp;<span class="op" id="1652383">!=</span>&nbsp;<span class="ident" id="1652386">nil</span>&nbsp;<span class="op" id="1652390">&amp;&amp;</span>&nbsp;<span class="ident" id="1652393">s</span><span class="op" id="1652394">.</span><span class="ident" id="1652395">head</span><span class="op" id="1652399">.</span><span class="ident" id="1652400">nrelease</span>&nbsp;<span class="op" id="1652409">&gt;</span>&nbsp;<span class="num" id="1652411">0</span>&nbsp;<span class="op" id="1652413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1652417">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652456">var</span>&nbsp;<span class="ident" id="1652460">wake</span>&nbsp;<span class="op" id="1652465">*</span><span class="ident" id="1652466">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652474">s</span><span class="op" id="1652475">.</span><span class="ident" id="1652476">head</span><span class="op" id="1652480">.</span><span class="ident" id="1652481">nrelease</span><span class="op" id="1652489">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652494">if</span>&nbsp;<span class="ident" id="1652497">s</span><span class="op" id="1652498">.</span><span class="ident" id="1652499">head</span><span class="op" id="1652503">.</span><span class="ident" id="1652504">nrelease</span>&nbsp;<span class="op" id="1652513">==</span>&nbsp;<span class="num" id="1652516">0</span>&nbsp;<span class="op" id="1652518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652523">wake</span>&nbsp;<span class="op" id="1652528">=</span>&nbsp;<span class="ident" id="1652530">s</span><span class="op" id="1652531">.</span><span class="ident" id="1652532">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652540">s</span><span class="op" id="1652541">.</span><span class="ident" id="1652542">head</span>&nbsp;<span class="op" id="1652547">=</span>&nbsp;<span class="ident" id="1652549">wake</span><span class="op" id="1652553">.</span><span class="ident" id="1652554">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652562">if</span>&nbsp;<span class="ident" id="1652565">s</span><span class="op" id="1652566">.</span><span class="ident" id="1652567">head</span>&nbsp;<span class="op" id="1652572">==</span>&nbsp;<span class="ident" id="1652575">nil</span>&nbsp;<span class="op" id="1652579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652585">s</span><span class="op" id="1652586">.</span><span class="ident" id="1652587">tail</span>&nbsp;<span class="op" id="1652592">=</span>&nbsp;<span class="ident" id="1652594">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652609">unlock</span><span class="op" id="1652615">(</span><span class="op" id="1652616">&amp;</span><span class="ident" id="1652617">s</span><span class="op" id="1652618">.</span><span class="ident" id="1652619">lock</span><span class="op" id="1652623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652627">if</span>&nbsp;<span class="ident" id="1652630">wake</span>&nbsp;<span class="op" id="1652635">!=</span>&nbsp;<span class="ident" id="1652638">nil</span>&nbsp;<span class="op" id="1652642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652647">wake</span><span class="op" id="1652651">.</span><span class="ident" id="1652652">next</span>&nbsp;<span class="op" id="1652657">=</span>&nbsp;<span class="ident" id="1652659">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652666">goready</span><span class="op" id="1652673">(</span><span class="ident" id="1652674">wake</span><span class="op" id="1652678">.</span><span class="ident" id="1652679">g</span><span class="op" id="1652680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652687">}</span>&nbsp;<span class="keyword" id="1652689">else</span>&nbsp;<span class="op" id="1652694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1652698">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652719">w</span>&nbsp;<span class="op" id="1652721">:=</span>&nbsp;<span class="ident" id="1652724">acquireSudog</span><span class="op" id="1652736">(</span><span class="op" id="1652737">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652741">w</span><span class="op" id="1652742">.</span><span class="ident" id="1652743">g</span>&nbsp;<span class="op" id="1652745">=</span>&nbsp;<span class="ident" id="1652747">getg</span><span class="op" id="1652751">(</span><span class="op" id="1652752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652756">w</span><span class="op" id="1652757">.</span><span class="ident" id="1652758">nrelease</span>&nbsp;<span class="op" id="1652767">=</span>&nbsp;<span class="op" id="1652769">-</span><span class="num" id="1652770">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652774">w</span><span class="op" id="1652775">.</span><span class="ident" id="1652776">next</span>&nbsp;<span class="op" id="1652781">=</span>&nbsp;<span class="ident" id="1652783">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652789">w</span><span class="op" id="1652790">.</span><span class="ident" id="1652791">releasetime</span>&nbsp;<span class="op" id="1652803">=</span>&nbsp;<span class="num" id="1652805">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652809">t0</span>&nbsp;<span class="op" id="1652812">:=</span>&nbsp;<span class="ident" id="1652815">int64</span><span class="op" id="1652820">(</span><span class="num" id="1652821">0</span><span class="op" id="1652822">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652826">if</span>&nbsp;<span class="ident" id="1652829">blockprofilerate</span>&nbsp;<span class="op" id="1652846">&gt;</span>&nbsp;<span class="num" id="1652848">0</span>&nbsp;<span class="op" id="1652850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652855">t0</span>&nbsp;<span class="op" id="1652858">=</span>&nbsp;<span class="ident" id="1652860">cputicks</span><span class="op" id="1652868">(</span><span class="op" id="1652869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652874">w</span><span class="op" id="1652875">.</span><span class="ident" id="1652876">releasetime</span>&nbsp;<span class="op" id="1652888">=</span>&nbsp;<span class="op" id="1652890">-</span><span class="num" id="1652891">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652899">if</span>&nbsp;<span class="ident" id="1652902">s</span><span class="op" id="1652903">.</span><span class="ident" id="1652904">tail</span>&nbsp;<span class="op" id="1652909">==</span>&nbsp;<span class="ident" id="1652912">nil</span>&nbsp;<span class="op" id="1652916">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652921">s</span><span class="op" id="1652922">.</span><span class="ident" id="1652923">head</span>&nbsp;<span class="op" id="1652928">=</span>&nbsp;<span class="ident" id="1652930">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652934">}</span>&nbsp;<span class="keyword" id="1652936">else</span>&nbsp;<span class="op" id="1652941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652946">s</span><span class="op" id="1652947">.</span><span class="ident" id="1652948">tail</span><span class="op" id="1652952">.</span><span class="ident" id="1652953">next</span>&nbsp;<span class="op" id="1652958">=</span>&nbsp;<span class="ident" id="1652960">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652968">s</span><span class="op" id="1652969">.</span><span class="ident" id="1652970">tail</span>&nbsp;<span class="op" id="1652975">=</span>&nbsp;<span class="ident" id="1652977">w</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652981">goparkunlock</span><span class="op" id="1652993">(</span><span class="op" id="1652994">&amp;</span><span class="ident" id="1652995">s</span><span class="op" id="1652996">.</span><span class="ident" id="1652997">lock</span><span class="op" id="1653001">,</span>&nbsp;<span class="string" id="1653003">&#34;semacquire&#34;</span><span class="op" id="1653015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653019">if</span>&nbsp;<span class="ident" id="1653022">t0</span>&nbsp;<span class="op" id="1653025">!=</span>&nbsp;<span class="num" id="1653028">0</span>&nbsp;<span class="op" id="1653030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653035">blockevent</span><span class="op" id="1653045">(</span><span class="ident" id="1653046">int64</span><span class="op" id="1653051">(</span><span class="ident" id="1653052">w</span><span class="op" id="1653053">.</span><span class="ident" id="1653054">releasetime</span><span class="op" id="1653065">)</span><span class="op" id="1653066">-</span><span class="ident" id="1653067">t0</span><span class="op" id="1653069">,</span>&nbsp;<span class="num" id="1653071">2</span><span class="op" id="1653072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653080">releaseSudog</span><span class="op" id="1653092">(</span><span class="ident" id="1653093">w</span><span class="op" id="1653094">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653097">}</span><br>
<span class="lineno"></span><span class="op" id="1653099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1653102">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1653180">func</span>&nbsp;<span class="ident" id="1653185">syncsemrelease</span><span class="op" id="1653199">(</span><span class="ident" id="1653200">s</span>&nbsp;<span class="op" id="1653202">*</span><span class="ident" id="1653203">syncSema</span><span class="op" id="1653211">,</span>&nbsp;<span class="ident" id="1653213">n</span>&nbsp;<span class="builtintype" id="1653215">uint32</span><span class="op" id="1653221">)</span>&nbsp;<span class="op" id="1653223">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653226">lock</span><span class="op" id="1653230">(</span><span class="op" id="1653231">&amp;</span><span class="ident" id="1653232">s</span><span class="op" id="1653233">.</span><span class="ident" id="1653234">lock</span><span class="op" id="1653238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653241">for</span>&nbsp;<span class="ident" id="1653245">n</span>&nbsp;<span class="op" id="1653247">&gt;</span>&nbsp;<span class="num" id="1653249">0</span>&nbsp;<span class="op" id="1653251">&amp;&amp;</span>&nbsp;<span class="ident" id="1653254">s</span><span class="op" id="1653255">.</span><span class="ident" id="1653256">head</span>&nbsp;<span class="op" id="1653261">!=</span>&nbsp;<span class="ident" id="1653264">nil</span>&nbsp;<span class="op" id="1653268">&amp;&amp;</span>&nbsp;<span class="ident" id="1653271">s</span><span class="op" id="1653272">.</span><span class="ident" id="1653273">head</span><span class="op" id="1653277">.</span><span class="ident" id="1653278">nrelease</span>&nbsp;<span class="op" id="1653287">&lt;</span>&nbsp;<span class="num" id="1653289">0</span>&nbsp;<span class="op" id="1653291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1653295">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653334">wake</span>&nbsp;<span class="op" id="1653339">:=</span>&nbsp;<span class="ident" id="1653342">s</span><span class="op" id="1653343">.</span><span class="ident" id="1653344">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653351">s</span><span class="op" id="1653352">.</span><span class="ident" id="1653353">head</span>&nbsp;<span class="op" id="1653358">=</span>&nbsp;<span class="ident" id="1653360">wake</span><span class="op" id="1653364">.</span><span class="ident" id="1653365">next</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653372">if</span>&nbsp;<span class="ident" id="1653375">s</span><span class="op" id="1653376">.</span><span class="ident" id="1653377">head</span>&nbsp;<span class="op" id="1653382">==</span>&nbsp;<span class="ident" id="1653385">nil</span>&nbsp;<span class="op" id="1653389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653394">s</span><span class="op" id="1653395">.</span><span class="ident" id="1653396">tail</span>&nbsp;<span class="op" id="1653401">=</span>&nbsp;<span class="ident" id="1653403">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653413">if</span>&nbsp;<span class="ident" id="1653416">wake</span><span class="op" id="1653420">.</span><span class="ident" id="1653421">releasetime</span>&nbsp;<span class="op" id="1653433">!=</span>&nbsp;<span class="num" id="1653436">0</span>&nbsp;<span class="op" id="1653438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653443">wake</span><span class="op" id="1653447">.</span><span class="ident" id="1653448">releasetime</span>&nbsp;<span class="op" id="1653460">=</span>&nbsp;<span class="ident" id="1653462">cputicks</span><span class="op" id="1653470">(</span><span class="op" id="1653471">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653479">wake</span><span class="op" id="1653483">.</span><span class="ident" id="1653484">next</span>&nbsp;<span class="op" id="1653489">=</span>&nbsp;<span class="ident" id="1653491">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653497">goready</span><span class="op" id="1653504">(</span><span class="ident" id="1653505">wake</span><span class="op" id="1653509">.</span><span class="ident" id="1653510">g</span><span class="op" id="1653511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653515">n</span><span class="op" id="1653516">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653520">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653523">if</span>&nbsp;<span class="ident" id="1653526">n</span>&nbsp;<span class="op" id="1653528">&gt;</span>&nbsp;<span class="num" id="1653530">0</span>&nbsp;<span class="op" id="1653532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1653536">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653556">w</span>&nbsp;<span class="op" id="1653558">:=</span>&nbsp;<span class="ident" id="1653561">acquireSudog</span><span class="op" id="1653573">(</span><span class="op" id="1653574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653578">w</span><span class="op" id="1653579">.</span><span class="ident" id="1653580">g</span>&nbsp;<span class="op" id="1653582">=</span>&nbsp;<span class="ident" id="1653584">getg</span><span class="op" id="1653588">(</span><span class="op" id="1653589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653593">w</span><span class="op" id="1653594">.</span><span class="ident" id="1653595">nrelease</span>&nbsp;<span class="op" id="1653604">=</span>&nbsp;<span class="builtintype" id="1653606">int32</span><span class="op" id="1653611">(</span><span class="ident" id="1653612">n</span><span class="op" id="1653613">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653617">w</span><span class="op" id="1653618">.</span><span class="ident" id="1653619">next</span>&nbsp;<span class="op" id="1653624">=</span>&nbsp;<span class="ident" id="1653626">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653632">w</span><span class="op" id="1653633">.</span><span class="ident" id="1653634">releasetime</span>&nbsp;<span class="op" id="1653646">=</span>&nbsp;<span class="num" id="1653648">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653652">if</span>&nbsp;<span class="ident" id="1653655">s</span><span class="op" id="1653656">.</span><span class="ident" id="1653657">tail</span>&nbsp;<span class="op" id="1653662">==</span>&nbsp;<span class="ident" id="1653665">nil</span>&nbsp;<span class="op" id="1653669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653674">s</span><span class="op" id="1653675">.</span><span class="ident" id="1653676">head</span>&nbsp;<span class="op" id="1653681">=</span>&nbsp;<span class="ident" id="1653683">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653687">}</span>&nbsp;<span class="keyword" id="1653689">else</span>&nbsp;<span class="op" id="1653694">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653699">s</span><span class="op" id="1653700">.</span><span class="ident" id="1653701">tail</span><span class="op" id="1653705">.</span><span class="ident" id="1653706">next</span>&nbsp;<span class="op" id="1653711">=</span>&nbsp;<span class="ident" id="1653713">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653721">s</span><span class="op" id="1653722">.</span><span class="ident" id="1653723">tail</span>&nbsp;<span class="op" id="1653728">=</span>&nbsp;<span class="ident" id="1653730">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653734">goparkunlock</span><span class="op" id="1653746">(</span><span class="op" id="1653747">&amp;</span><span class="ident" id="1653748">s</span><span class="op" id="1653749">.</span><span class="ident" id="1653750">lock</span><span class="op" id="1653754">,</span>&nbsp;<span class="string" id="1653756">&#34;semarelease&#34;</span><span class="op" id="1653769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653773">releaseSudog</span><span class="op" id="1653785">(</span><span class="ident" id="1653786">w</span><span class="op" id="1653787">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653790">}</span>&nbsp;<span class="keyword" id="1653792">else</span>&nbsp;<span class="op" id="1653797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653801">unlock</span><span class="op" id="1653807">(</span><span class="op" id="1653808">&amp;</span><span class="ident" id="1653809">s</span><span class="op" id="1653810">.</span><span class="ident" id="1653811">lock</span><span class="op" id="1653815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653818">}</span><br>
<span class="lineno"></span><span class="op" id="1653820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1653823">func</span>&nbsp;<span class="ident" id="1653828">syncsemcheck</span><span class="op" id="1653840">(</span><span class="ident" id="1653841">sz</span>&nbsp;<span class="builtintype" id="1653844">uintptr</span><span class="op" id="1653851">)</span>&nbsp;<span class="op" id="1653853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653856">if</span>&nbsp;<span class="ident" id="1653859">sz</span>&nbsp;<span class="op" id="1653862">!=</span>&nbsp;<span class="ident" id="1653865">unsafe</span><span class="op" id="1653871">.</span><span class="ident" id="1653872">Sizeof</span><span class="op" id="1653878">(</span><span class="ident" id="1653879">syncSema</span><span class="op" id="1653887">{</span><span class="op" id="1653888">}</span><span class="op" id="1653889">)</span>&nbsp;<span class="op" id="1653891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1653895">print</span><span class="op" id="1653900">(</span><span class="string" id="1653901">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="1653937">,</span>&nbsp;<span class="ident" id="1653939">sz</span><span class="op" id="1653941">,</span>&nbsp;<span class="string" id="1653943">&#34;&nbsp;runtime=&#34;</span><span class="op" id="1653954">,</span>&nbsp;<span class="ident" id="1653956">unsafe</span><span class="op" id="1653962">.</span><span class="ident" id="1653963">Sizeof</span><span class="op" id="1653969">(</span><span class="ident" id="1653970">syncSema</span><span class="op" id="1653978">{</span><span class="op" id="1653979">}</span><span class="op" id="1653980">)</span><span class="op" id="1653981">,</span>&nbsp;<span class="string" id="1653983">&#34;\n&#34;</span><span class="op" id="1653987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653991">gothrow</span><span class="op" id="1653998">(</span><span class="string" id="1653999">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="1654018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1654021">}</span><br>
<span class="lineno">275</span><span class="op" id="1654023">}</span>
</div>
</body>
</html>
