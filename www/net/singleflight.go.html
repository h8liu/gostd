<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1485510">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1485566">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1485620">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1485671">package</span>&nbsp;<span class="ident" id="1485679">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1485684">import</span>&nbsp;<span class="string" id="1485691">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1485699">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="1485757">type</span>&nbsp;<span class="ident" id="1485762">call</span>&nbsp;<span class="keyword" id="1485767">struct</span>&nbsp;<span class="op" id="1485774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485777">wg</span>&nbsp;<span class="ident" id="1485780"><a href="/net/singleflight.go.html#1485691">sync</a></span><span class="op" id="1485784">.</span><span class="ident" id="1485785">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485797">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485860">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485911">val</span>&nbsp;<span class="keyword" id="1485915">interface</span><span class="op" id="1485924">{</span><span class="op" id="1485925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1485928">err</span>&nbsp;<span class="builtintype" id="1485932">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1485940">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1486000">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1486062">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486107">dups</span>&nbsp;&nbsp;<span class="builtintype" id="1486113">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486118">chans</span>&nbsp;<span class="op" id="1486124">[</span><span class="op" id="1486125">]</span><span class="keyword" id="1486126">chan</span><span class="op" id="1486130">&lt;-</span>&nbsp;<span class="ident" id="1486133"><a href="/net/singleflight.go.html#1486489">singleflightResult</a></span><br>
<span class="lineno"></span><span class="op" id="1486152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="1486155">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1486223">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="1486290">type</span>&nbsp;<span class="ident" id="1486295">singleflight</span>&nbsp;<span class="keyword" id="1486308">struct</span>&nbsp;<span class="op" id="1486315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486318">mu</span>&nbsp;<span class="ident" id="1486321"><a href="/net/singleflight.go.html#1485691">sync</a></span><span class="op" id="1486325">.</span><span class="ident" id="1486326">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1486338">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486353">m</span>&nbsp;&nbsp;<span class="keyword" id="1486356">map</span><span class="op" id="1486359">[</span><span class="builtintype" id="1486360">string</span><span class="op" id="1486366">]</span><span class="op" id="1486367">*</span><span class="ident" id="1486368"><a href="/net/singleflight.go.html#1485762">call</a></span>&nbsp;<span class="comment" id="1486373">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="1486395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1486398">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="1486467">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="1486484">type</span>&nbsp;<span class="ident" id="1486489">singleflightResult</span>&nbsp;<span class="keyword" id="1486508">struct</span>&nbsp;<span class="op" id="1486515">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486518">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1486525">interface</span><span class="op" id="1486534">{</span><span class="op" id="1486535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486538">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1486545">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1486552">shared</span>&nbsp;<span class="builtintype" id="1486559">bool</span><br>
<span class="lineno"></span><span class="op" id="1486564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1486567">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="1486636">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1486702">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1486771">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="1486826">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="1486904">func</span>&nbsp;<span class="op" id="1486909">(</span><span class="ident" id="1486910">g</span>&nbsp;<span class="op" id="1486912">*</span><span class="ident" id="1486913"><a href="/net/singleflight.go.html#1486295">singleflight</a></span><span class="op" id="1486925">)</span>&nbsp;<span class="ident" id="1486927">Do</span><span class="op" id="1486929">(</span><span class="ident" id="1486930">key</span>&nbsp;<span class="builtintype" id="1486934">string</span><span class="op" id="1486940">,</span>&nbsp;<span class="ident" id="1486942">fn</span>&nbsp;<span class="keyword" id="1486945">func</span><span class="op" id="1486949">(</span><span class="op" id="1486950">)</span>&nbsp;<span class="op" id="1486952">(</span><span class="keyword" id="1486953">interface</span><span class="op" id="1486962">{</span><span class="op" id="1486963">}</span><span class="op" id="1486964">,</span>&nbsp;<span class="builtintype" id="1486966">error</span><span class="op" id="1486971">)</span><span class="op" id="1486972">)</span>&nbsp;<span class="op" id="1486974">(</span><span class="ident" id="1486975">v</span>&nbsp;<span class="keyword" id="1486977">interface</span><span class="op" id="1486986">{</span><span class="op" id="1486987">}</span><span class="op" id="1486988">,</span>&nbsp;<span class="ident" id="1486990">err</span>&nbsp;<span class="builtintype" id="1486994">error</span><span class="op" id="1486999">,</span>&nbsp;<span class="ident" id="1487001">shared</span>&nbsp;<span class="builtintype" id="1487008">bool</span><span class="op" id="1487012">)</span>&nbsp;<span class="op" id="1487014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487017"><a href="/net/singleflight.go.html#1486910">g</a></span><span class="op" id="1487018">.</span><span class="ident" id="1487019">mu</span><span class="op" id="1487021">.</span><span class="ident" id="1487022">Lock</span><span class="op" id="1487026">(</span><span class="op" id="1487027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487030">if</span>&nbsp;<span class="ident" id="1487033"><a href="/net/singleflight.go.html#1486910">g</a></span><span class="op" id="1487034">.</span><span class="ident" id="1487035">m</span>&nbsp;<span class="op" id="1487037">==</span>&nbsp;<span class="ident" id="1487040">nil</span>&nbsp;<span class="op" id="1487044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487048"><a href="/net/singleflight.go.html#1486910">g</a></span><span class="op" id="1487049">.</span><span class="ident" id="1487050">m</span>&nbsp;<span class="op" id="1487052">=</span>&nbsp;<span class="builtinfunc" id="1487054">make</span><span class="op" id="1487058">(</span><span class="keyword" id="1487059">map</span><span class="op" id="1487062">[</span><span class="builtintype" id="1487063">string</span><span class="op" id="1487069">]</span><span class="op" id="1487070">*</span><span class="ident" id="1487071"><a href="/net/singleflight.go.html#1485762">call</a></span><span class="op" id="1487075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487078">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487081">if</span>&nbsp;<span class="ident" id="1487084">c</span><span class="op" id="1487085">,</span>&nbsp;<span class="ident" id="1487087">ok</span>&nbsp;<span class="op" id="1487090">:=</span>&nbsp;<span class="ident" id="1487093"><a href="/net/singleflight.go.html#1486910">g</a></span><span class="op" id="1487094">.</span><span class="ident" id="1487095">m</span><span class="op" id="1487096">[</span><span class="ident" id="1487097"><a href="/net/singleflight.go.html#1486930">key</a></span><span class="op" id="1487100">]</span><span class="op" id="1487101">;</span>&nbsp;<span class="ident" id="1487103"><a href="/net/singleflight.go.html#1487087">ok</a></span>&nbsp;<span class="op" id="1487106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487110"><a href="/net/singleflight.go.html#1487084">c</a></span><span class="op" id="1487111">.</span><span class="ident" id="1487112">dups</span><span class="op" id="1487116">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487121"><a href="/net/singleflight.go.html#1486910">g</a></span><span class="op" id="1487122">.</span><span class="ident" id="1487123">mu</span><span class="op" id="1487125">.</span><span class="ident" id="1487126">Unlock</span><span class="op" id="1487132">(</span><span class="op" id="1487133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487137"><a href="/net/singleflight.go.html#1487084">c</a></span><span class="op" id="1487138">.</span><span class="ident" id="1487139">wg</span><span class="op" id="1487141">.</span><span class="ident" id="1487142">Wait</span><span class="op" id="1487146">(</span><span class="op" id="1487147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487151">return</span>&nbsp;<span class="ident" id="1487158"><a href="/net/singleflight.go.html#1487084">c</a></span><span class="op" id="1487159">.</span><span class="ident" id="1487160">val</span><span class="op" id="1487163">,</span>&nbsp;<span class="ident" id="1487165"><a href="/net/singleflight.go.html#1487084">c</a></span><span class="op" id="1487166">.</span><span class="ident" id="1487167">err</span><span class="op" id="1487170">,</span>&nbsp;<span class="builtintype" id="1487172">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487181">c</span>&nbsp;<span class="op" id="1487183">:=</span>&nbsp;<span class="builtinfunc" id="1487186">new</span><span class="op" id="1487189">(</span><span class="ident" id="1487190"><a href="/net/singleflight.go.html#1485762">call</a></span><span class="op" id="1487194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487197"><a href="/net/singleflight.go.html#1487181">c</a></span><span class="op" id="1487198">.</span><span class="ident" id="1487199">wg</span><span class="op" id="1487201">.</span><span class="ident" id="1487202">Add</span><span class="op" id="1487205">(</span><span class="num" id="1487206">1</span><span class="op" id="1487207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487210"><a href="/net/singleflight.go.html#1486910">g</a></span><span class="op" id="1487211">.</span><span class="ident" id="1487212">m</span><span class="op" id="1487213">[</span><span class="ident" id="1487214"><a href="/net/singleflight.go.html#1486930">key</a></span><span class="op" id="1487217">]</span>&nbsp;<span class="op" id="1487219">=</span>&nbsp;<span class="ident" id="1487221"><a href="/net/singleflight.go.html#1487181">c</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487224"><a href="/net/singleflight.go.html#1486910">g</a></span><span class="op" id="1487225">.</span><span class="ident" id="1487226">mu</span><span class="op" id="1487228">.</span><span class="ident" id="1487229">Unlock</span><span class="op" id="1487235">(</span><span class="op" id="1487236">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487240"><a href="/net/singleflight.go.html#1486910">g</a></span><span class="op" id="1487241">.</span><span class="ident" id="1487242">doCall</span><span class="op" id="1487248">(</span><span class="ident" id="1487249"><a href="/net/singleflight.go.html#1487181">c</a></span><span class="op" id="1487250">,</span>&nbsp;<span class="ident" id="1487252"><a href="/net/singleflight.go.html#1486930">key</a></span><span class="op" id="1487255">,</span>&nbsp;<span class="ident" id="1487257"><a href="/net/singleflight.go.html#1486942">fn</a></span><span class="op" id="1487259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487262">return</span>&nbsp;<span class="ident" id="1487269"><a href="/net/singleflight.go.html#1487181">c</a></span><span class="op" id="1487270">.</span><span class="ident" id="1487271">val</span><span class="op" id="1487274">,</span>&nbsp;<span class="ident" id="1487276"><a href="/net/singleflight.go.html#1487181">c</a></span><span class="op" id="1487277">.</span><span class="ident" id="1487278">err</span><span class="op" id="1487281">,</span>&nbsp;<span class="ident" id="1487283"><a href="/net/singleflight.go.html#1487181">c</a></span><span class="op" id="1487284">.</span><span class="ident" id="1487285">dups</span>&nbsp;<span class="op" id="1487290">&gt;</span>&nbsp;<span class="num" id="1487292">0</span><br>
<span class="lineno"></span><span class="op" id="1487294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="1487297">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1487362">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="1487394">func</span>&nbsp;<span class="op" id="1487399">(</span><span class="ident" id="1487400">g</span>&nbsp;<span class="op" id="1487402">*</span><span class="ident" id="1487403"><a href="/net/singleflight.go.html#1486295">singleflight</a></span><span class="op" id="1487415">)</span>&nbsp;<span class="ident" id="1487417">DoChan</span><span class="op" id="1487423">(</span><span class="ident" id="1487424">key</span>&nbsp;<span class="builtintype" id="1487428">string</span><span class="op" id="1487434">,</span>&nbsp;<span class="ident" id="1487436">fn</span>&nbsp;<span class="keyword" id="1487439">func</span><span class="op" id="1487443">(</span><span class="op" id="1487444">)</span>&nbsp;<span class="op" id="1487446">(</span><span class="keyword" id="1487447">interface</span><span class="op" id="1487456">{</span><span class="op" id="1487457">}</span><span class="op" id="1487458">,</span>&nbsp;<span class="builtintype" id="1487460">error</span><span class="op" id="1487465">)</span><span class="op" id="1487466">)</span>&nbsp;<span class="op" id="1487468">&lt;-</span><span class="keyword" id="1487470">chan</span>&nbsp;<span class="ident" id="1487475"><a href="/net/singleflight.go.html#1486489">singleflightResult</a></span>&nbsp;<span class="op" id="1487494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487497">ch</span>&nbsp;<span class="op" id="1487500">:=</span>&nbsp;<span class="builtinfunc" id="1487503">make</span><span class="op" id="1487507">(</span><span class="keyword" id="1487508">chan</span>&nbsp;<span class="ident" id="1487513"><a href="/net/singleflight.go.html#1486489">singleflightResult</a></span><span class="op" id="1487531">,</span>&nbsp;<span class="num" id="1487533">1</span><span class="op" id="1487534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487537"><a href="/net/singleflight.go.html#1487400">g</a></span><span class="op" id="1487538">.</span><span class="ident" id="1487539">mu</span><span class="op" id="1487541">.</span><span class="ident" id="1487542">Lock</span><span class="op" id="1487546">(</span><span class="op" id="1487547">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487550">if</span>&nbsp;<span class="ident" id="1487553"><a href="/net/singleflight.go.html#1487400">g</a></span><span class="op" id="1487554">.</span><span class="ident" id="1487555">m</span>&nbsp;<span class="op" id="1487557">==</span>&nbsp;<span class="ident" id="1487560">nil</span>&nbsp;<span class="op" id="1487564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487568"><a href="/net/singleflight.go.html#1487400">g</a></span><span class="op" id="1487569">.</span><span class="ident" id="1487570">m</span>&nbsp;<span class="op" id="1487572">=</span>&nbsp;<span class="builtinfunc" id="1487574">make</span><span class="op" id="1487578">(</span><span class="keyword" id="1487579">map</span><span class="op" id="1487582">[</span><span class="builtintype" id="1487583">string</span><span class="op" id="1487589">]</span><span class="op" id="1487590">*</span><span class="ident" id="1487591"><a href="/net/singleflight.go.html#1485762">call</a></span><span class="op" id="1487595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487601">if</span>&nbsp;<span class="ident" id="1487604">c</span><span class="op" id="1487605">,</span>&nbsp;<span class="ident" id="1487607">ok</span>&nbsp;<span class="op" id="1487610">:=</span>&nbsp;<span class="ident" id="1487613"><a href="/net/singleflight.go.html#1487400">g</a></span><span class="op" id="1487614">.</span><span class="ident" id="1487615">m</span><span class="op" id="1487616">[</span><span class="ident" id="1487617"><a href="/net/singleflight.go.html#1487424">key</a></span><span class="op" id="1487620">]</span><span class="op" id="1487621">;</span>&nbsp;<span class="ident" id="1487623"><a href="/net/singleflight.go.html#1487607">ok</a></span>&nbsp;<span class="op" id="1487626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487630"><a href="/net/singleflight.go.html#1487604">c</a></span><span class="op" id="1487631">.</span><span class="ident" id="1487632">dups</span><span class="op" id="1487636">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487641"><a href="/net/singleflight.go.html#1487604">c</a></span><span class="op" id="1487642">.</span><span class="ident" id="1487643">chans</span>&nbsp;<span class="op" id="1487649">=</span>&nbsp;<span class="builtinfunc" id="1487651">append</span><span class="op" id="1487657">(</span><span class="ident" id="1487658"><a href="/net/singleflight.go.html#1487604">c</a></span><span class="op" id="1487659">.</span><span class="ident" id="1487660">chans</span><span class="op" id="1487665">,</span>&nbsp;<span class="ident" id="1487667"><a href="/net/singleflight.go.html#1487497">ch</a></span><span class="op" id="1487669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487673"><a href="/net/singleflight.go.html#1487400">g</a></span><span class="op" id="1487674">.</span><span class="ident" id="1487675">mu</span><span class="op" id="1487677">.</span><span class="ident" id="1487678">Unlock</span><span class="op" id="1487684">(</span><span class="op" id="1487685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487689">return</span>&nbsp;<span class="ident" id="1487696"><a href="/net/singleflight.go.html#1487497">ch</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1487700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487703">c</span>&nbsp;<span class="op" id="1487705">:=</span>&nbsp;<span class="op" id="1487708">&amp;</span><span class="ident" id="1487709"><a href="/net/singleflight.go.html#1485762">call</a></span><span class="op" id="1487713">{</span><span class="ident" id="1487714">chans</span><span class="op" id="1487719">:</span>&nbsp;<span class="op" id="1487721">[</span><span class="op" id="1487722">]</span><span class="keyword" id="1487723">chan</span><span class="op" id="1487727">&lt;-</span>&nbsp;<span class="ident" id="1487730"><a href="/net/singleflight.go.html#1486489">singleflightResult</a></span><span class="op" id="1487748">{</span><span class="ident" id="1487749"><a href="/net/singleflight.go.html#1487497">ch</a></span><span class="op" id="1487751">}</span><span class="op" id="1487752">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487755"><a href="/net/singleflight.go.html#1487703">c</a></span><span class="op" id="1487756">.</span><span class="ident" id="1487757">wg</span><span class="op" id="1487759">.</span><span class="ident" id="1487760">Add</span><span class="op" id="1487763">(</span><span class="num" id="1487764">1</span><span class="op" id="1487765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487768"><a href="/net/singleflight.go.html#1487400">g</a></span><span class="op" id="1487769">.</span><span class="ident" id="1487770">m</span><span class="op" id="1487771">[</span><span class="ident" id="1487772"><a href="/net/singleflight.go.html#1487424">key</a></span><span class="op" id="1487775">]</span>&nbsp;<span class="op" id="1487777">=</span>&nbsp;<span class="ident" id="1487779"><a href="/net/singleflight.go.html#1487703">c</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487782"><a href="/net/singleflight.go.html#1487400">g</a></span><span class="op" id="1487783">.</span><span class="ident" id="1487784">mu</span><span class="op" id="1487786">.</span><span class="ident" id="1487787">Unlock</span><span class="op" id="1487793">(</span><span class="op" id="1487794">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487798">go</span>&nbsp;<span class="ident" id="1487801"><a href="/net/singleflight.go.html#1487400">g</a></span><span class="op" id="1487802">.</span><span class="ident" id="1487803">doCall</span><span class="op" id="1487809">(</span><span class="ident" id="1487810"><a href="/net/singleflight.go.html#1487703">c</a></span><span class="op" id="1487811">,</span>&nbsp;<span class="ident" id="1487813"><a href="/net/singleflight.go.html#1487424">key</a></span><span class="op" id="1487816">,</span>&nbsp;<span class="ident" id="1487818"><a href="/net/singleflight.go.html#1487436">fn</a></span><span class="op" id="1487820">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1487824">return</span>&nbsp;<span class="ident" id="1487831"><a href="/net/singleflight.go.html#1487497">ch</a></span><br>
<span class="lineno"></span><span class="op" id="1487834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1487837">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="1487882">func</span>&nbsp;<span class="op" id="1487887">(</span><span class="ident" id="1487888">g</span>&nbsp;<span class="op" id="1487890">*</span><span class="ident" id="1487891"><a href="/net/singleflight.go.html#1486295">singleflight</a></span><span class="op" id="1487903">)</span>&nbsp;<span class="ident" id="1487905">doCall</span><span class="op" id="1487911">(</span><span class="ident" id="1487912">c</span>&nbsp;<span class="op" id="1487914">*</span><span class="ident" id="1487915"><a href="/net/singleflight.go.html#1485762">call</a></span><span class="op" id="1487919">,</span>&nbsp;<span class="ident" id="1487921">key</span>&nbsp;<span class="builtintype" id="1487925">string</span><span class="op" id="1487931">,</span>&nbsp;<span class="ident" id="1487933">fn</span>&nbsp;<span class="keyword" id="1487936">func</span><span class="op" id="1487940">(</span><span class="op" id="1487941">)</span>&nbsp;<span class="op" id="1487943">(</span><span class="keyword" id="1487944">interface</span><span class="op" id="1487953">{</span><span class="op" id="1487954">}</span><span class="op" id="1487955">,</span>&nbsp;<span class="builtintype" id="1487957">error</span><span class="op" id="1487962">)</span><span class="op" id="1487963">)</span>&nbsp;<span class="op" id="1487965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487968"><a href="/net/singleflight.go.html#1487912">c</a></span><span class="op" id="1487969">.</span><span class="ident" id="1487970">val</span><span class="op" id="1487973">,</span>&nbsp;<span class="ident" id="1487975"><a href="/net/singleflight.go.html#1487912">c</a></span><span class="op" id="1487976">.</span><span class="ident" id="1487977">err</span>&nbsp;<span class="op" id="1487981">=</span>&nbsp;<span class="ident" id="1487983"><a href="/net/singleflight.go.html#1487933">fn</a></span><span class="op" id="1487985">(</span><span class="op" id="1487986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1487989"><a href="/net/singleflight.go.html#1487912">c</a></span><span class="op" id="1487990">.</span><span class="ident" id="1487991">wg</span><span class="op" id="1487993">.</span><span class="ident" id="1487994">Done</span><span class="op" id="1487998">(</span><span class="op" id="1487999">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488003"><a href="/net/singleflight.go.html#1487888">g</a></span><span class="op" id="1488004">.</span><span class="ident" id="1488005">mu</span><span class="op" id="1488007">.</span><span class="ident" id="1488008">Lock</span><span class="op" id="1488012">(</span><span class="op" id="1488013">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1488016">delete</span><span class="op" id="1488022">(</span><span class="ident" id="1488023"><a href="/net/singleflight.go.html#1487888">g</a></span><span class="op" id="1488024">.</span><span class="ident" id="1488025">m</span><span class="op" id="1488026">,</span>&nbsp;<span class="ident" id="1488028"><a href="/net/singleflight.go.html#1487921">key</a></span><span class="op" id="1488031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1488034">for</span>&nbsp;<span class="ident" id="1488038">_</span><span class="op" id="1488039">,</span>&nbsp;<span class="ident" id="1488041">ch</span>&nbsp;<span class="op" id="1488044">:=</span>&nbsp;<span class="keyword" id="1488047">range</span>&nbsp;<span class="ident" id="1488053"><a href="/net/singleflight.go.html#1487912">c</a></span><span class="op" id="1488054">.</span><span class="ident" id="1488055">chans</span>&nbsp;<span class="op" id="1488061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488065"><a href="/net/singleflight.go.html#1488041">ch</a></span>&nbsp;<span class="op" id="1488068">&lt;-</span>&nbsp;<span class="ident" id="1488071"><a href="/net/singleflight.go.html#1486489">singleflightResult</a></span><span class="op" id="1488089">{</span><span class="ident" id="1488090"><a href="/net/singleflight.go.html#1487912">c</a></span><span class="op" id="1488091">.</span><span class="ident" id="1488092">val</span><span class="op" id="1488095">,</span>&nbsp;<span class="ident" id="1488097"><a href="/net/singleflight.go.html#1487912">c</a></span><span class="op" id="1488098">.</span><span class="ident" id="1488099">err</span><span class="op" id="1488102">,</span>&nbsp;<span class="ident" id="1488104"><a href="/net/singleflight.go.html#1487912">c</a></span><span class="op" id="1488105">.</span><span class="ident" id="1488106">dups</span>&nbsp;<span class="op" id="1488111">&gt;</span>&nbsp;<span class="num" id="1488113">0</span><span class="op" id="1488114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1488117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488120"><a href="/net/singleflight.go.html#1487888">g</a></span><span class="op" id="1488121">.</span><span class="ident" id="1488122">mu</span><span class="op" id="1488124">.</span><span class="ident" id="1488125">Unlock</span><span class="op" id="1488131">(</span><span class="op" id="1488132">)</span><br>
<span class="lineno">100</span><span class="op" id="1488134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1488137">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="1488207">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1488276">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="1488308">func</span>&nbsp;<span class="op" id="1488313">(</span><span class="ident" id="1488314">g</span>&nbsp;<span class="op" id="1488316">*</span><span class="ident" id="1488317"><a href="/net/singleflight.go.html#1486295">singleflight</a></span><span class="op" id="1488329">)</span>&nbsp;<span class="ident" id="1488331">Forget</span><span class="op" id="1488337">(</span><span class="ident" id="1488338">key</span>&nbsp;<span class="builtintype" id="1488342">string</span><span class="op" id="1488348">)</span>&nbsp;<span class="op" id="1488350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488353"><a href="/net/singleflight.go.html#1488314">g</a></span><span class="op" id="1488354">.</span><span class="ident" id="1488355">mu</span><span class="op" id="1488357">.</span><span class="ident" id="1488358">Lock</span><span class="op" id="1488362">(</span><span class="op" id="1488363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1488366">delete</span><span class="op" id="1488372">(</span><span class="ident" id="1488373"><a href="/net/singleflight.go.html#1488314">g</a></span><span class="op" id="1488374">.</span><span class="ident" id="1488375">m</span><span class="op" id="1488376">,</span>&nbsp;<span class="ident" id="1488378"><a href="/net/singleflight.go.html#1488338">key</a></span><span class="op" id="1488381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488384"><a href="/net/singleflight.go.html#1488314">g</a></span><span class="op" id="1488385">.</span><span class="ident" id="1488386">mu</span><span class="op" id="1488388">.</span><span class="ident" id="1488389">Unlock</span><span class="op" id="1488395">(</span><span class="op" id="1488396">)</span><br>
<span class="lineno"></span><span class="op" id="1488398">}</span>
</div>
</body>
</html>
