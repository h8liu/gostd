<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html" class="current">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7009515">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7009570">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7009624">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7009675">package</span>&nbsp;<span class="ident" id="7009683">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7009689">import</span>&nbsp;<span class="op" id="7009696">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009699">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009708">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009715">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009724">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009739">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009745">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009758">&#34;math/rand&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009771">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009777">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7009788">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7009798">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="7009801">//&nbsp;TestDecodeProgressive&nbsp;tests&nbsp;that&nbsp;decoding&nbsp;the&nbsp;baseline&nbsp;and&nbsp;progressive</span><br>
<span class="lineno"></span><span class="comment" id="7009875">//&nbsp;versions&nbsp;of&nbsp;the&nbsp;same&nbsp;image&nbsp;result&nbsp;in&nbsp;exactly&nbsp;the&nbsp;same&nbsp;pixel&nbsp;data,&nbsp;in&nbsp;YCbCr</span><br>
<span class="lineno"></span><span class="comment" id="7009953">//&nbsp;space&nbsp;for&nbsp;color&nbsp;images,&nbsp;and&nbsp;Y&nbsp;space&nbsp;for&nbsp;grayscale&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="7010014">func</span>&nbsp;<span class="ident" id="7010019">TestDecodeProgressive</span><span class="op" id="7010040">(</span><span class="ident" id="7010041">t</span>&nbsp;<span class="op" id="7010043">*</span><span class="ident" id="7010044">testing</span><span class="op" id="7010051">.</span><span class="ident" id="7010052">T</span><span class="op" id="7010053">)</span>&nbsp;<span class="op" id="7010055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010058">testCases</span>&nbsp;<span class="op" id="7010068">:=</span>&nbsp;<span class="op" id="7010071">[</span><span class="op" id="7010072">]</span><span class="builtintype" id="7010073">string</span><span class="op" id="7010079">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010083">&#34;../testdata/video-001&#34;</span><span class="op" id="7010106">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010110">&#34;../testdata/video-001.q50.420&#34;</span><span class="op" id="7010141">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010145">&#34;../testdata/video-001.q50.422&#34;</span><span class="op" id="7010176">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010180">&#34;../testdata/video-001.q50.440&#34;</span><span class="op" id="7010211">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010215">&#34;../testdata/video-001.q50.444&#34;</span><span class="op" id="7010246">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010250">&#34;../testdata/video-005.gray.q50&#34;</span><span class="op" id="7010282">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010286">&#34;../testdata/video-005.gray.q50.2x2&#34;</span><span class="op" id="7010322">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7010326">&#34;../testdata/video-001.separate.dc.progression&#34;</span><span class="op" id="7010373">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010379">for</span>&nbsp;<span class="ident" id="7010383">_</span><span class="op" id="7010384">,</span>&nbsp;<span class="ident" id="7010386">tc</span>&nbsp;<span class="op" id="7010389">:=</span>&nbsp;<span class="keyword" id="7010392">range</span>&nbsp;<span class="ident" id="7010398">testCases</span>&nbsp;<span class="op" id="7010408">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010412">m0</span><span class="op" id="7010414">,</span>&nbsp;<span class="ident" id="7010416">err</span>&nbsp;<span class="op" id="7010420">:=</span>&nbsp;<span class="ident" id="7010423">decodeFile</span><span class="op" id="7010433">(</span><span class="ident" id="7010434">tc</span>&nbsp;<span class="op" id="7010437">+</span>&nbsp;<span class="string" id="7010439">&#34;.jpeg&#34;</span><span class="op" id="7010446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010450">if</span>&nbsp;<span class="ident" id="7010453">err</span>&nbsp;<span class="op" id="7010457">!=</span>&nbsp;<span class="ident" id="7010460">nil</span>&nbsp;<span class="op" id="7010464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010469">t</span><span class="op" id="7010470">.</span><span class="ident" id="7010471">Errorf</span><span class="op" id="7010477">(</span><span class="string" id="7010478">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7010486">,</span>&nbsp;<span class="ident" id="7010488">tc</span><span class="op" id="7010490">+</span><span class="string" id="7010491">&#34;.jpeg&#34;</span><span class="op" id="7010498">,</span>&nbsp;<span class="ident" id="7010500">err</span><span class="op" id="7010503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010508">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010519">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010523">m1</span><span class="op" id="7010525">,</span>&nbsp;<span class="ident" id="7010527">err</span>&nbsp;<span class="op" id="7010531">:=</span>&nbsp;<span class="ident" id="7010534">decodeFile</span><span class="op" id="7010544">(</span><span class="ident" id="7010545">tc</span>&nbsp;<span class="op" id="7010548">+</span>&nbsp;<span class="string" id="7010550">&#34;.progressive.jpeg&#34;</span><span class="op" id="7010569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010573">if</span>&nbsp;<span class="ident" id="7010576">err</span>&nbsp;<span class="op" id="7010580">!=</span>&nbsp;<span class="ident" id="7010583">nil</span>&nbsp;<span class="op" id="7010587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010592">t</span><span class="op" id="7010593">.</span><span class="ident" id="7010594">Errorf</span><span class="op" id="7010600">(</span><span class="string" id="7010601">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7010609">,</span>&nbsp;<span class="ident" id="7010611">tc</span><span class="op" id="7010613">+</span><span class="string" id="7010614">&#34;.progressive.jpeg&#34;</span><span class="op" id="7010633">,</span>&nbsp;<span class="ident" id="7010635">err</span><span class="op" id="7010638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010643">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010654">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010658">if</span>&nbsp;<span class="ident" id="7010661">m0</span><span class="op" id="7010663">.</span><span class="ident" id="7010664">Bounds</span><span class="op" id="7010670">(</span><span class="op" id="7010671">)</span>&nbsp;<span class="op" id="7010673">!=</span>&nbsp;<span class="ident" id="7010676">m1</span><span class="op" id="7010678">.</span><span class="ident" id="7010679">Bounds</span><span class="op" id="7010685">(</span><span class="op" id="7010686">)</span>&nbsp;<span class="op" id="7010688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010693">t</span><span class="op" id="7010694">.</span><span class="ident" id="7010695">Errorf</span><span class="op" id="7010701">(</span><span class="string" id="7010702">&#34;%s:&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7010732">,</span>&nbsp;<span class="ident" id="7010734">tc</span><span class="op" id="7010736">,</span>&nbsp;<span class="ident" id="7010738">m0</span><span class="op" id="7010740">.</span><span class="ident" id="7010741">Bounds</span><span class="op" id="7010747">(</span><span class="op" id="7010748">)</span><span class="op" id="7010749">,</span>&nbsp;<span class="ident" id="7010751">m1</span><span class="op" id="7010753">.</span><span class="ident" id="7010754">Bounds</span><span class="op" id="7010760">(</span><span class="op" id="7010761">)</span><span class="op" id="7010762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010767">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7010782">//&nbsp;All&nbsp;of&nbsp;the&nbsp;video-*.jpeg&nbsp;files&nbsp;are&nbsp;150x103.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010830">if</span>&nbsp;<span class="ident" id="7010833">m0</span><span class="op" id="7010835">.</span><span class="ident" id="7010836">Bounds</span><span class="op" id="7010842">(</span><span class="op" id="7010843">)</span>&nbsp;<span class="op" id="7010845">!=</span>&nbsp;<span class="ident" id="7010848">image</span><span class="op" id="7010853">.</span><span class="ident" id="7010854">Rect</span><span class="op" id="7010858">(</span><span class="num" id="7010859">0</span><span class="op" id="7010860">,</span>&nbsp;<span class="num" id="7010862">0</span><span class="op" id="7010863">,</span>&nbsp;<span class="num" id="7010865">150</span><span class="op" id="7010868">,</span>&nbsp;<span class="num" id="7010870">103</span><span class="op" id="7010873">)</span>&nbsp;<span class="op" id="7010875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010880">t</span><span class="op" id="7010881">.</span><span class="ident" id="7010882">Errorf</span><span class="op" id="7010888">(</span><span class="string" id="7010889">&#34;%s:&nbsp;bad&nbsp;bounds:&nbsp;%v&#34;</span><span class="op" id="7010909">,</span>&nbsp;<span class="ident" id="7010911">tc</span><span class="op" id="7010913">,</span>&nbsp;<span class="ident" id="7010915">m0</span><span class="op" id="7010917">.</span><span class="ident" id="7010918">Bounds</span><span class="op" id="7010924">(</span><span class="op" id="7010925">)</span><span class="op" id="7010926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010931">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7010942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010947">switch</span>&nbsp;<span class="ident" id="7010954">m0</span>&nbsp;<span class="op" id="7010957">:=</span>&nbsp;<span class="ident" id="7010960">m0</span><span class="op" id="7010962">.</span><span class="op" id="7010963">(</span><span class="keyword" id="7010964">type</span><span class="op" id="7010968">)</span>&nbsp;<span class="op" id="7010970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7010974">case</span>&nbsp;<span class="op" id="7010979">*</span><span class="ident" id="7010980">image</span><span class="op" id="7010985">.</span><span class="ident" id="7010986">YCbCr</span><span class="op" id="7010991">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7010996">m1</span>&nbsp;<span class="op" id="7010999">:=</span>&nbsp;<span class="ident" id="7011002">m1</span><span class="op" id="7011004">.</span><span class="op" id="7011005">(</span><span class="op" id="7011006">*</span><span class="ident" id="7011007">image</span><span class="op" id="7011012">.</span><span class="ident" id="7011013">YCbCr</span><span class="op" id="7011018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011023">if</span>&nbsp;<span class="ident" id="7011026">err</span>&nbsp;<span class="op" id="7011030">:=</span>&nbsp;<span class="ident" id="7011033">check</span><span class="op" id="7011038">(</span><span class="ident" id="7011039">m0</span><span class="op" id="7011041">.</span><span class="ident" id="7011042">Bounds</span><span class="op" id="7011048">(</span><span class="op" id="7011049">)</span><span class="op" id="7011050">,</span>&nbsp;<span class="ident" id="7011052">m0</span><span class="op" id="7011054">.</span><span class="ident" id="7011055">Y</span><span class="op" id="7011056">,</span>&nbsp;<span class="ident" id="7011058">m1</span><span class="op" id="7011060">.</span><span class="ident" id="7011061">Y</span><span class="op" id="7011062">,</span>&nbsp;<span class="ident" id="7011064">m0</span><span class="op" id="7011066">.</span><span class="ident" id="7011067">YStride</span><span class="op" id="7011074">,</span>&nbsp;<span class="ident" id="7011076">m1</span><span class="op" id="7011078">.</span><span class="ident" id="7011079">YStride</span><span class="op" id="7011086">)</span><span class="op" id="7011087">;</span>&nbsp;<span class="ident" id="7011089">err</span>&nbsp;<span class="op" id="7011093">!=</span>&nbsp;<span class="ident" id="7011096">nil</span>&nbsp;<span class="op" id="7011100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011106">t</span><span class="op" id="7011107">.</span><span class="ident" id="7011108">Errorf</span><span class="op" id="7011114">(</span><span class="string" id="7011115">&#34;%s&nbsp;(Y):&nbsp;%v&#34;</span><span class="op" id="7011127">,</span>&nbsp;<span class="ident" id="7011129">tc</span><span class="op" id="7011131">,</span>&nbsp;<span class="ident" id="7011133">err</span><span class="op" id="7011136">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011142">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011159">if</span>&nbsp;<span class="ident" id="7011162">err</span>&nbsp;<span class="op" id="7011166">:=</span>&nbsp;<span class="ident" id="7011169">check</span><span class="op" id="7011174">(</span><span class="ident" id="7011175">m0</span><span class="op" id="7011177">.</span><span class="ident" id="7011178">Bounds</span><span class="op" id="7011184">(</span><span class="op" id="7011185">)</span><span class="op" id="7011186">,</span>&nbsp;<span class="ident" id="7011188">m0</span><span class="op" id="7011190">.</span><span class="ident" id="7011191">Cb</span><span class="op" id="7011193">,</span>&nbsp;<span class="ident" id="7011195">m1</span><span class="op" id="7011197">.</span><span class="ident" id="7011198">Cb</span><span class="op" id="7011200">,</span>&nbsp;<span class="ident" id="7011202">m0</span><span class="op" id="7011204">.</span><span class="ident" id="7011205">CStride</span><span class="op" id="7011212">,</span>&nbsp;<span class="ident" id="7011214">m1</span><span class="op" id="7011216">.</span><span class="ident" id="7011217">CStride</span><span class="op" id="7011224">)</span><span class="op" id="7011225">;</span>&nbsp;<span class="ident" id="7011227">err</span>&nbsp;<span class="op" id="7011231">!=</span>&nbsp;<span class="ident" id="7011234">nil</span>&nbsp;<span class="op" id="7011238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011244">t</span><span class="op" id="7011245">.</span><span class="ident" id="7011246">Errorf</span><span class="op" id="7011252">(</span><span class="string" id="7011253">&#34;%s&nbsp;(Cb):&nbsp;%v&#34;</span><span class="op" id="7011266">,</span>&nbsp;<span class="ident" id="7011268">tc</span><span class="op" id="7011270">,</span>&nbsp;<span class="ident" id="7011272">err</span><span class="op" id="7011275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011281">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011298">if</span>&nbsp;<span class="ident" id="7011301">err</span>&nbsp;<span class="op" id="7011305">:=</span>&nbsp;<span class="ident" id="7011308">check</span><span class="op" id="7011313">(</span><span class="ident" id="7011314">m0</span><span class="op" id="7011316">.</span><span class="ident" id="7011317">Bounds</span><span class="op" id="7011323">(</span><span class="op" id="7011324">)</span><span class="op" id="7011325">,</span>&nbsp;<span class="ident" id="7011327">m0</span><span class="op" id="7011329">.</span><span class="ident" id="7011330">Cr</span><span class="op" id="7011332">,</span>&nbsp;<span class="ident" id="7011334">m1</span><span class="op" id="7011336">.</span><span class="ident" id="7011337">Cr</span><span class="op" id="7011339">,</span>&nbsp;<span class="ident" id="7011341">m0</span><span class="op" id="7011343">.</span><span class="ident" id="7011344">CStride</span><span class="op" id="7011351">,</span>&nbsp;<span class="ident" id="7011353">m1</span><span class="op" id="7011355">.</span><span class="ident" id="7011356">CStride</span><span class="op" id="7011363">)</span><span class="op" id="7011364">;</span>&nbsp;<span class="ident" id="7011366">err</span>&nbsp;<span class="op" id="7011370">!=</span>&nbsp;<span class="ident" id="7011373">nil</span>&nbsp;<span class="op" id="7011377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011383">t</span><span class="op" id="7011384">.</span><span class="ident" id="7011385">Errorf</span><span class="op" id="7011391">(</span><span class="string" id="7011392">&#34;%s&nbsp;(Cr):&nbsp;%v&#34;</span><span class="op" id="7011405">,</span>&nbsp;<span class="ident" id="7011407">tc</span><span class="op" id="7011409">,</span>&nbsp;<span class="ident" id="7011411">err</span><span class="op" id="7011414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011420">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011432">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011436">case</span>&nbsp;<span class="op" id="7011441">*</span><span class="ident" id="7011442">image</span><span class="op" id="7011447">.</span><span class="ident" id="7011448">Gray</span><span class="op" id="7011452">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011457">m1</span>&nbsp;<span class="op" id="7011460">:=</span>&nbsp;<span class="ident" id="7011463">m1</span><span class="op" id="7011465">.</span><span class="op" id="7011466">(</span><span class="op" id="7011467">*</span><span class="ident" id="7011468">image</span><span class="op" id="7011473">.</span><span class="ident" id="7011474">Gray</span><span class="op" id="7011478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011483">if</span>&nbsp;<span class="ident" id="7011486">err</span>&nbsp;<span class="op" id="7011490">:=</span>&nbsp;<span class="ident" id="7011493">check</span><span class="op" id="7011498">(</span><span class="ident" id="7011499">m0</span><span class="op" id="7011501">.</span><span class="ident" id="7011502">Bounds</span><span class="op" id="7011508">(</span><span class="op" id="7011509">)</span><span class="op" id="7011510">,</span>&nbsp;<span class="ident" id="7011512">m0</span><span class="op" id="7011514">.</span><span class="ident" id="7011515">Pix</span><span class="op" id="7011518">,</span>&nbsp;<span class="ident" id="7011520">m1</span><span class="op" id="7011522">.</span><span class="ident" id="7011523">Pix</span><span class="op" id="7011526">,</span>&nbsp;<span class="ident" id="7011528">m0</span><span class="op" id="7011530">.</span><span class="ident" id="7011531">Stride</span><span class="op" id="7011537">,</span>&nbsp;<span class="ident" id="7011539">m1</span><span class="op" id="7011541">.</span><span class="ident" id="7011542">Stride</span><span class="op" id="7011548">)</span><span class="op" id="7011549">;</span>&nbsp;<span class="ident" id="7011551">err</span>&nbsp;<span class="op" id="7011555">!=</span>&nbsp;<span class="ident" id="7011558">nil</span>&nbsp;<span class="op" id="7011562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011568">t</span><span class="op" id="7011569">.</span><span class="ident" id="7011570">Errorf</span><span class="op" id="7011576">(</span><span class="string" id="7011577">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="7011585">,</span>&nbsp;<span class="ident" id="7011587">tc</span><span class="op" id="7011589">,</span>&nbsp;<span class="ident" id="7011591">err</span><span class="op" id="7011594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011600">continue</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011616">default</span><span class="op" id="7011623">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011628">t</span><span class="op" id="7011629">.</span><span class="ident" id="7011630">Errorf</span><span class="op" id="7011636">(</span><span class="string" id="7011637">&#34;%s:&nbsp;unexpected&nbsp;image&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7011667">,</span>&nbsp;<span class="ident" id="7011669">tc</span><span class="op" id="7011671">,</span>&nbsp;<span class="ident" id="7011673">m0</span><span class="op" id="7011675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011680">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011691">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011694">}</span><br>
<span class="lineno"></span><span class="op" id="7011696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7011699">func</span>&nbsp;<span class="ident" id="7011704">decodeFile</span><span class="op" id="7011714">(</span><span class="ident" id="7011715">filename</span>&nbsp;<span class="builtintype" id="7011724">string</span><span class="op" id="7011730">)</span>&nbsp;<span class="op" id="7011732">(</span><span class="ident" id="7011733">image</span><span class="op" id="7011738">.</span><span class="ident" id="7011739">Image</span><span class="op" id="7011744">,</span>&nbsp;<span class="builtintype" id="7011746">error</span><span class="op" id="7011751">)</span>&nbsp;<span class="op" id="7011753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011756">f</span><span class="op" id="7011757">,</span>&nbsp;<span class="ident" id="7011759">err</span>&nbsp;<span class="op" id="7011763">:=</span>&nbsp;<span class="ident" id="7011766">os</span><span class="op" id="7011768">.</span><span class="ident" id="7011769">Open</span><span class="op" id="7011773">(</span><span class="ident" id="7011774">filename</span><span class="op" id="7011782">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011785">if</span>&nbsp;<span class="ident" id="7011788">err</span>&nbsp;<span class="op" id="7011792">!=</span>&nbsp;<span class="ident" id="7011795">nil</span>&nbsp;<span class="op" id="7011799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011803">return</span>&nbsp;<span class="ident" id="7011810">nil</span><span class="op" id="7011813">,</span>&nbsp;<span class="ident" id="7011815">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7011820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011823">defer</span>&nbsp;<span class="ident" id="7011829">f</span><span class="op" id="7011830">.</span><span class="ident" id="7011831">Close</span><span class="op" id="7011836">(</span><span class="op" id="7011837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7011840">return</span>&nbsp;<span class="ident" id="7011847">Decode</span><span class="op" id="7011853">(</span><span class="ident" id="7011854">f</span><span class="op" id="7011855">)</span><br>
<span class="lineno">90</span><span class="op" id="7011857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7011860">type</span>&nbsp;<span class="ident" id="7011865">eofReader</span>&nbsp;<span class="keyword" id="7011875">struct</span>&nbsp;<span class="op" id="7011882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011885">data</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7011894">[</span><span class="op" id="7011895">]</span><span class="builtintype" id="7011896">byte</span>&nbsp;<span class="comment" id="7011901">//&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;without&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7011935">dataEOF</span>&nbsp;&nbsp;<span class="op" id="7011944">[</span><span class="op" id="7011945">]</span><span class="builtintype" id="7011946">byte</span>&nbsp;<span class="comment" id="7011951">//&nbsp;then&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;with&nbsp;EOF&nbsp;on&nbsp;last&nbsp;chunk</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012001">lenAtEOF</span>&nbsp;<span class="builtintype" id="7012010">int</span><br>
<span class="lineno"></span><span class="op" id="7012014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7012017">func</span>&nbsp;<span class="op" id="7012022">(</span><span class="ident" id="7012023">r</span>&nbsp;<span class="op" id="7012025">*</span><span class="ident" id="7012026">eofReader</span><span class="op" id="7012035">)</span>&nbsp;<span class="ident" id="7012037">Read</span><span class="op" id="7012041">(</span><span class="ident" id="7012042">b</span>&nbsp;<span class="op" id="7012044">[</span><span class="op" id="7012045">]</span><span class="builtintype" id="7012046">byte</span><span class="op" id="7012050">)</span>&nbsp;<span class="op" id="7012052">(</span><span class="ident" id="7012053">n</span>&nbsp;<span class="builtintype" id="7012055">int</span><span class="op" id="7012058">,</span>&nbsp;<span class="ident" id="7012060">err</span>&nbsp;<span class="builtintype" id="7012064">error</span><span class="op" id="7012069">)</span>&nbsp;<span class="op" id="7012071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012074">if</span>&nbsp;<span class="builtinfunc" id="7012077">len</span><span class="op" id="7012080">(</span><span class="ident" id="7012081">r</span><span class="op" id="7012082">.</span><span class="ident" id="7012083">data</span><span class="op" id="7012087">)</span>&nbsp;<span class="op" id="7012089">&gt;</span>&nbsp;<span class="num" id="7012091">0</span>&nbsp;<span class="op" id="7012093">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012097">n</span>&nbsp;<span class="op" id="7012099">=</span>&nbsp;<span class="builtinfunc" id="7012101">copy</span><span class="op" id="7012105">(</span><span class="ident" id="7012106">b</span><span class="op" id="7012107">,</span>&nbsp;<span class="ident" id="7012109">r</span><span class="op" id="7012110">.</span><span class="ident" id="7012111">data</span><span class="op" id="7012115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012119">r</span><span class="op" id="7012120">.</span><span class="ident" id="7012121">data</span>&nbsp;<span class="op" id="7012126">=</span>&nbsp;<span class="ident" id="7012128">r</span><span class="op" id="7012129">.</span><span class="ident" id="7012130">data</span><span class="op" id="7012134">[</span><span class="ident" id="7012135">n</span><span class="op" id="7012136">:</span><span class="op" id="7012137">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012140">}</span>&nbsp;<span class="keyword" id="7012142">else</span>&nbsp;<span class="op" id="7012147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012151">n</span>&nbsp;<span class="op" id="7012153">=</span>&nbsp;<span class="builtinfunc" id="7012155">copy</span><span class="op" id="7012159">(</span><span class="ident" id="7012160">b</span><span class="op" id="7012161">,</span>&nbsp;<span class="ident" id="7012163">r</span><span class="op" id="7012164">.</span><span class="ident" id="7012165">dataEOF</span><span class="op" id="7012172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012176">r</span><span class="op" id="7012177">.</span><span class="ident" id="7012178">dataEOF</span>&nbsp;<span class="op" id="7012186">=</span>&nbsp;<span class="ident" id="7012188">r</span><span class="op" id="7012189">.</span><span class="ident" id="7012190">dataEOF</span><span class="op" id="7012197">[</span><span class="ident" id="7012198">n</span><span class="op" id="7012199">:</span><span class="op" id="7012200">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012204">if</span>&nbsp;<span class="builtinfunc" id="7012207">len</span><span class="op" id="7012210">(</span><span class="ident" id="7012211">r</span><span class="op" id="7012212">.</span><span class="ident" id="7012213">dataEOF</span><span class="op" id="7012220">)</span>&nbsp;<span class="op" id="7012222">==</span>&nbsp;<span class="num" id="7012225">0</span>&nbsp;<span class="op" id="7012227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012232">err</span>&nbsp;<span class="op" id="7012236">=</span>&nbsp;<span class="ident" id="7012238">io</span><span class="op" id="7012240">.</span><span class="ident" id="7012241">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012248">if</span>&nbsp;<span class="ident" id="7012251">r</span><span class="op" id="7012252">.</span><span class="ident" id="7012253">lenAtEOF</span>&nbsp;<span class="op" id="7012262">==</span>&nbsp;<span class="op" id="7012265">-</span><span class="num" id="7012266">1</span>&nbsp;<span class="op" id="7012268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012274">r</span><span class="op" id="7012275">.</span><span class="ident" id="7012276">lenAtEOF</span>&nbsp;<span class="op" id="7012285">=</span>&nbsp;<span class="ident" id="7012287">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012292">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012302">return</span><br>
<span class="lineno"></span><span class="op" id="7012309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="7012312">func</span>&nbsp;<span class="ident" id="7012317">TestDecodeEOF</span><span class="op" id="7012330">(</span><span class="ident" id="7012331">t</span>&nbsp;<span class="op" id="7012333">*</span><span class="ident" id="7012334">testing</span><span class="op" id="7012341">.</span><span class="ident" id="7012342">T</span><span class="op" id="7012343">)</span>&nbsp;<span class="op" id="7012345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7012348">//&nbsp;Check&nbsp;that&nbsp;if&nbsp;reader&nbsp;returns&nbsp;final&nbsp;data&nbsp;and&nbsp;EOF&nbsp;at&nbsp;same&nbsp;time,&nbsp;jpeg&nbsp;handles&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012431">data</span><span class="op" id="7012435">,</span>&nbsp;<span class="ident" id="7012437">err</span>&nbsp;<span class="op" id="7012441">:=</span>&nbsp;<span class="ident" id="7012444">ioutil</span><span class="op" id="7012450">.</span><span class="ident" id="7012451">ReadFile</span><span class="op" id="7012459">(</span><span class="string" id="7012460">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7012488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012491">if</span>&nbsp;<span class="ident" id="7012494">err</span>&nbsp;<span class="op" id="7012498">!=</span>&nbsp;<span class="ident" id="7012501">nil</span>&nbsp;<span class="op" id="7012505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012509">t</span><span class="op" id="7012510">.</span><span class="ident" id="7012511">Fatal</span><span class="op" id="7012516">(</span><span class="ident" id="7012517">err</span><span class="op" id="7012520">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012527">n</span>&nbsp;<span class="op" id="7012529">:=</span>&nbsp;<span class="builtinfunc" id="7012532">len</span><span class="op" id="7012535">(</span><span class="ident" id="7012536">data</span><span class="op" id="7012540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012543">for</span>&nbsp;<span class="ident" id="7012547">i</span>&nbsp;<span class="op" id="7012549">:=</span>&nbsp;<span class="num" id="7012552">0</span><span class="op" id="7012553">;</span>&nbsp;<span class="ident" id="7012555">i</span>&nbsp;<span class="op" id="7012557">&lt;</span>&nbsp;<span class="ident" id="7012559">n</span><span class="op" id="7012560">;</span>&nbsp;<span class="op" id="7012562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012566">r</span>&nbsp;<span class="op" id="7012568">:=</span>&nbsp;<span class="op" id="7012571">&amp;</span><span class="ident" id="7012572">eofReader</span><span class="op" id="7012581">{</span><span class="ident" id="7012582">data</span><span class="op" id="7012586">[</span><span class="op" id="7012587">:</span><span class="ident" id="7012588">n</span><span class="op" id="7012589">-</span><span class="ident" id="7012590">i</span><span class="op" id="7012591">]</span><span class="op" id="7012592">,</span>&nbsp;<span class="ident" id="7012594">data</span><span class="op" id="7012598">[</span><span class="ident" id="7012599">n</span><span class="op" id="7012600">-</span><span class="ident" id="7012601">i</span><span class="op" id="7012602">:</span><span class="op" id="7012603">]</span><span class="op" id="7012604">,</span>&nbsp;<span class="op" id="7012606">-</span><span class="num" id="7012607">1</span><span class="op" id="7012608">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012612">_</span><span class="op" id="7012613">,</span>&nbsp;<span class="ident" id="7012615">err</span>&nbsp;<span class="op" id="7012619">:=</span>&nbsp;<span class="ident" id="7012622">Decode</span><span class="op" id="7012628">(</span><span class="ident" id="7012629">r</span><span class="op" id="7012630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012634">if</span>&nbsp;<span class="ident" id="7012637">err</span>&nbsp;<span class="op" id="7012641">!=</span>&nbsp;<span class="ident" id="7012644">nil</span>&nbsp;<span class="op" id="7012648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012653">t</span><span class="op" id="7012654">.</span><span class="ident" id="7012655">Errorf</span><span class="op" id="7012661">(</span><span class="string" id="7012662">&#34;Decode&nbsp;with&nbsp;Read()&nbsp;=&nbsp;%d,&nbsp;EOF:&nbsp;%v&#34;</span><span class="op" id="7012696">,</span>&nbsp;<span class="ident" id="7012698">r</span><span class="op" id="7012699">.</span><span class="ident" id="7012700">lenAtEOF</span><span class="op" id="7012708">,</span>&nbsp;<span class="ident" id="7012710">err</span><span class="op" id="7012713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012721">if</span>&nbsp;<span class="ident" id="7012724">i</span>&nbsp;<span class="op" id="7012726">==</span>&nbsp;<span class="num" id="7012729">0</span>&nbsp;<span class="op" id="7012731">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012736">i</span>&nbsp;<span class="op" id="7012738">=</span>&nbsp;<span class="num" id="7012740">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012744">}</span>&nbsp;<span class="keyword" id="7012746">else</span>&nbsp;<span class="op" id="7012751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7012756">i</span>&nbsp;<span class="op" id="7012758">*=</span>&nbsp;<span class="num" id="7012761">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7012768">}</span><br>
<span class="lineno">135</span><span class="op" id="7012770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7012773">//&nbsp;check&nbsp;checks&nbsp;that&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;are&nbsp;equal,&nbsp;within&nbsp;the&nbsp;given&nbsp;bounds.</span><br>
<span class="lineno"></span><span class="keyword" id="7012847">func</span>&nbsp;<span class="ident" id="7012852">check</span><span class="op" id="7012857">(</span><span class="ident" id="7012858">bounds</span>&nbsp;<span class="ident" id="7012865">image</span><span class="op" id="7012870">.</span><span class="ident" id="7012871">Rectangle</span><span class="op" id="7012880">,</span>&nbsp;<span class="ident" id="7012882">pix0</span><span class="op" id="7012886">,</span>&nbsp;<span class="ident" id="7012888">pix1</span>&nbsp;<span class="op" id="7012893">[</span><span class="op" id="7012894">]</span><span class="builtintype" id="7012895">byte</span><span class="op" id="7012899">,</span>&nbsp;<span class="ident" id="7012901">stride0</span><span class="op" id="7012908">,</span>&nbsp;<span class="ident" id="7012910">stride1</span>&nbsp;<span class="builtintype" id="7012918">int</span><span class="op" id="7012921">)</span>&nbsp;<span class="builtintype" id="7012923">error</span>&nbsp;<span class="op" id="7012929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012932">if</span>&nbsp;<span class="ident" id="7012935">stride0</span>&nbsp;<span class="op" id="7012943">&lt;=</span>&nbsp;<span class="num" id="7012946">0</span>&nbsp;<span class="op" id="7012948">||</span>&nbsp;<span class="ident" id="7012951">stride0</span><span class="op" id="7012958">%</span><span class="num" id="7012959">8</span>&nbsp;<span class="op" id="7012961">!=</span>&nbsp;<span class="num" id="7012964">0</span>&nbsp;<span class="op" id="7012966">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7012970">return</span>&nbsp;<span class="ident" id="7012977">fmt</span><span class="op" id="7012980">.</span><span class="ident" id="7012981">Errorf</span><span class="op" id="7012987">(</span><span class="string" id="7012988">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7013003">,</span>&nbsp;<span class="ident" id="7013005">stride0</span><span class="op" id="7013012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013018">if</span>&nbsp;<span class="ident" id="7013021">stride1</span>&nbsp;<span class="op" id="7013029">&lt;=</span>&nbsp;<span class="num" id="7013032">0</span>&nbsp;<span class="op" id="7013034">||</span>&nbsp;<span class="ident" id="7013037">stride1</span><span class="op" id="7013044">%</span><span class="num" id="7013045">8</span>&nbsp;<span class="op" id="7013047">!=</span>&nbsp;<span class="num" id="7013050">0</span>&nbsp;<span class="op" id="7013052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013056">return</span>&nbsp;<span class="ident" id="7013063">fmt</span><span class="op" id="7013066">.</span><span class="ident" id="7013067">Errorf</span><span class="op" id="7013073">(</span><span class="string" id="7013074">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="7013089">,</span>&nbsp;<span class="ident" id="7013091">stride1</span><span class="op" id="7013098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013101">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7013104">//&nbsp;Compare&nbsp;the&nbsp;two&nbsp;pix&nbsp;data,&nbsp;one&nbsp;8x8&nbsp;block&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013159">for</span>&nbsp;<span class="ident" id="7013163">y</span>&nbsp;<span class="op" id="7013165">:=</span>&nbsp;<span class="num" id="7013168">0</span><span class="op" id="7013169">;</span>&nbsp;<span class="ident" id="7013171">y</span>&nbsp;<span class="op" id="7013173">&lt;</span>&nbsp;<span class="builtinfunc" id="7013175">len</span><span class="op" id="7013178">(</span><span class="ident" id="7013179">pix0</span><span class="op" id="7013183">)</span><span class="op" id="7013184">/</span><span class="ident" id="7013185">stride0</span>&nbsp;<span class="op" id="7013193">&amp;&amp;</span>&nbsp;<span class="ident" id="7013196">y</span>&nbsp;<span class="op" id="7013198">&lt;</span>&nbsp;<span class="builtinfunc" id="7013200">len</span><span class="op" id="7013203">(</span><span class="ident" id="7013204">pix1</span><span class="op" id="7013208">)</span><span class="op" id="7013209">/</span><span class="ident" id="7013210">stride1</span><span class="op" id="7013217">;</span>&nbsp;<span class="ident" id="7013219">y</span>&nbsp;<span class="op" id="7013221">+=</span>&nbsp;<span class="num" id="7013224">8</span>&nbsp;<span class="op" id="7013226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013230">for</span>&nbsp;<span class="ident" id="7013234">x</span>&nbsp;<span class="op" id="7013236">:=</span>&nbsp;<span class="num" id="7013239">0</span><span class="op" id="7013240">;</span>&nbsp;<span class="ident" id="7013242">x</span>&nbsp;<span class="op" id="7013244">&lt;</span>&nbsp;<span class="ident" id="7013246">stride0</span>&nbsp;<span class="op" id="7013254">&amp;&amp;</span>&nbsp;<span class="ident" id="7013257">x</span>&nbsp;<span class="op" id="7013259">&lt;</span>&nbsp;<span class="ident" id="7013261">stride1</span><span class="op" id="7013268">;</span>&nbsp;<span class="ident" id="7013270">x</span>&nbsp;<span class="op" id="7013272">+=</span>&nbsp;<span class="num" id="7013275">8</span>&nbsp;<span class="op" id="7013277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013282">if</span>&nbsp;<span class="ident" id="7013285">x</span>&nbsp;<span class="op" id="7013287">&gt;=</span>&nbsp;<span class="ident" id="7013290">bounds</span><span class="op" id="7013296">.</span><span class="ident" id="7013297">Max</span><span class="op" id="7013300">.</span><span class="ident" id="7013301">X</span>&nbsp;<span class="op" id="7013303">||</span>&nbsp;<span class="ident" id="7013306">y</span>&nbsp;<span class="op" id="7013308">&gt;=</span>&nbsp;<span class="ident" id="7013311">bounds</span><span class="op" id="7013317">.</span><span class="ident" id="7013318">Max</span><span class="op" id="7013321">.</span><span class="ident" id="7013322">Y</span>&nbsp;<span class="op" id="7013324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7013330">//&nbsp;We&nbsp;don&#39;t&nbsp;care&nbsp;if&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;differ&nbsp;if&nbsp;the&nbsp;8x8&nbsp;block&nbsp;is</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7013398">//&nbsp;entirely&nbsp;outside&nbsp;of&nbsp;the&nbsp;image&#39;s&nbsp;bounds.&nbsp;For&nbsp;example,&nbsp;this&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7013467">//&nbsp;occur&nbsp;with&nbsp;a&nbsp;4:2:0&nbsp;chroma&nbsp;subsampling&nbsp;and&nbsp;a&nbsp;1x1&nbsp;image.&nbsp;Baseline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7013538">//&nbsp;decoding&nbsp;works&nbsp;on&nbsp;the&nbsp;one&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole;&nbsp;progressive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7013605">//&nbsp;decoding&#39;s&nbsp;first&nbsp;pass&nbsp;works&nbsp;on&nbsp;that&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7013673">//&nbsp;refinement&nbsp;passes&nbsp;only&nbsp;process&nbsp;one&nbsp;8x8&nbsp;block&nbsp;within&nbsp;the&nbsp;MCU.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013741">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7013753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013759">for</span>&nbsp;<span class="ident" id="7013763">j</span>&nbsp;<span class="op" id="7013765">:=</span>&nbsp;<span class="num" id="7013768">0</span><span class="op" id="7013769">;</span>&nbsp;<span class="ident" id="7013771">j</span>&nbsp;<span class="op" id="7013773">&lt;</span>&nbsp;<span class="num" id="7013775">8</span><span class="op" id="7013776">;</span>&nbsp;<span class="ident" id="7013778">j</span><span class="op" id="7013779">++</span>&nbsp;<span class="op" id="7013782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013788">for</span>&nbsp;<span class="ident" id="7013792">i</span>&nbsp;<span class="op" id="7013794">:=</span>&nbsp;<span class="num" id="7013797">0</span><span class="op" id="7013798">;</span>&nbsp;<span class="ident" id="7013800">i</span>&nbsp;<span class="op" id="7013802">&lt;</span>&nbsp;<span class="num" id="7013804">8</span><span class="op" id="7013805">;</span>&nbsp;<span class="ident" id="7013807">i</span><span class="op" id="7013808">++</span>&nbsp;<span class="op" id="7013811">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013818">index0</span>&nbsp;<span class="op" id="7013825">:=</span>&nbsp;<span class="op" id="7013828">(</span><span class="ident" id="7013829">y</span><span class="op" id="7013830">+</span><span class="ident" id="7013831">j</span><span class="op" id="7013832">)</span><span class="op" id="7013833">*</span><span class="ident" id="7013834">stride0</span>&nbsp;<span class="op" id="7013842">+</span>&nbsp;<span class="op" id="7013844">(</span><span class="ident" id="7013845">x</span>&nbsp;<span class="op" id="7013847">+</span>&nbsp;<span class="ident" id="7013849">i</span><span class="op" id="7013850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7013857">index1</span>&nbsp;<span class="op" id="7013864">:=</span>&nbsp;<span class="op" id="7013867">(</span><span class="ident" id="7013868">y</span><span class="op" id="7013869">+</span><span class="ident" id="7013870">j</span><span class="op" id="7013871">)</span><span class="op" id="7013872">*</span><span class="ident" id="7013873">stride1</span>&nbsp;<span class="op" id="7013881">+</span>&nbsp;<span class="op" id="7013883">(</span><span class="ident" id="7013884">x</span>&nbsp;<span class="op" id="7013886">+</span>&nbsp;<span class="ident" id="7013888">i</span><span class="op" id="7013889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013896">if</span>&nbsp;<span class="ident" id="7013899">pix0</span><span class="op" id="7013903">[</span><span class="ident" id="7013904">index0</span><span class="op" id="7013910">]</span>&nbsp;<span class="op" id="7013912">!=</span>&nbsp;<span class="ident" id="7013915">pix1</span><span class="op" id="7013919">[</span><span class="ident" id="7013920">index1</span><span class="op" id="7013926">]</span>&nbsp;<span class="op" id="7013928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7013936">return</span>&nbsp;<span class="ident" id="7013943">fmt</span><span class="op" id="7013946">.</span><span class="ident" id="7013947">Errorf</span><span class="op" id="7013953">(</span><span class="string" id="7013954">&#34;blocks&nbsp;at&nbsp;(%d,&nbsp;%d)&nbsp;differ:\n%sand\n%s&#34;</span><span class="op" id="7013993">,</span>&nbsp;<span class="ident" id="7013995">x</span><span class="op" id="7013996">,</span>&nbsp;<span class="ident" id="7013998">y</span><span class="op" id="7013999">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014008">pixString</span><span class="op" id="7014017">(</span><span class="ident" id="7014018">pix0</span><span class="op" id="7014022">,</span>&nbsp;<span class="ident" id="7014024">stride0</span><span class="op" id="7014031">,</span>&nbsp;<span class="ident" id="7014033">x</span><span class="op" id="7014034">,</span>&nbsp;<span class="ident" id="7014036">y</span><span class="op" id="7014037">)</span><span class="op" id="7014038">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014047">pixString</span><span class="op" id="7014056">(</span><span class="ident" id="7014057">pix1</span><span class="op" id="7014061">,</span>&nbsp;<span class="ident" id="7014063">stride1</span><span class="op" id="7014070">,</span>&nbsp;<span class="ident" id="7014072">x</span><span class="op" id="7014073">,</span>&nbsp;<span class="ident" id="7014075">y</span><span class="op" id="7014076">)</span><span class="op" id="7014077">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014103">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014113">return</span>&nbsp;<span class="ident" id="7014120">nil</span><br>
<span class="lineno"></span><span class="op" id="7014124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="7014127">func</span>&nbsp;<span class="ident" id="7014132">pixString</span><span class="op" id="7014141">(</span><span class="ident" id="7014142">pix</span>&nbsp;<span class="op" id="7014146">[</span><span class="op" id="7014147">]</span><span class="builtintype" id="7014148">byte</span><span class="op" id="7014152">,</span>&nbsp;<span class="ident" id="7014154">stride</span><span class="op" id="7014160">,</span>&nbsp;<span class="ident" id="7014162">x</span><span class="op" id="7014163">,</span>&nbsp;<span class="ident" id="7014165">y</span>&nbsp;<span class="builtintype" id="7014167">int</span><span class="op" id="7014170">)</span>&nbsp;<span class="builtintype" id="7014172">string</span>&nbsp;<span class="op" id="7014179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014182">s</span>&nbsp;<span class="op" id="7014184">:=</span>&nbsp;<span class="ident" id="7014187">bytes</span><span class="op" id="7014192">.</span><span class="ident" id="7014193">NewBuffer</span><span class="op" id="7014202">(</span><span class="ident" id="7014203">nil</span><span class="op" id="7014206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014209">for</span>&nbsp;<span class="ident" id="7014213">j</span>&nbsp;<span class="op" id="7014215">:=</span>&nbsp;<span class="num" id="7014218">0</span><span class="op" id="7014219">;</span>&nbsp;<span class="ident" id="7014221">j</span>&nbsp;<span class="op" id="7014223">&lt;</span>&nbsp;<span class="num" id="7014225">8</span><span class="op" id="7014226">;</span>&nbsp;<span class="ident" id="7014228">j</span><span class="op" id="7014229">++</span>&nbsp;<span class="op" id="7014232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014236">fmt</span><span class="op" id="7014239">.</span><span class="ident" id="7014240">Fprintf</span><span class="op" id="7014247">(</span><span class="ident" id="7014248">s</span><span class="op" id="7014249">,</span>&nbsp;<span class="string" id="7014251">&#34;\t&#34;</span><span class="op" id="7014255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014259">for</span>&nbsp;<span class="ident" id="7014263">i</span>&nbsp;<span class="op" id="7014265">:=</span>&nbsp;<span class="num" id="7014268">0</span><span class="op" id="7014269">;</span>&nbsp;<span class="ident" id="7014271">i</span>&nbsp;<span class="op" id="7014273">&lt;</span>&nbsp;<span class="num" id="7014275">8</span><span class="op" id="7014276">;</span>&nbsp;<span class="ident" id="7014278">i</span><span class="op" id="7014279">++</span>&nbsp;<span class="op" id="7014282">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014287">fmt</span><span class="op" id="7014290">.</span><span class="ident" id="7014291">Fprintf</span><span class="op" id="7014298">(</span><span class="ident" id="7014299">s</span><span class="op" id="7014300">,</span>&nbsp;<span class="string" id="7014302">&#34;%02x&nbsp;&#34;</span><span class="op" id="7014309">,</span>&nbsp;<span class="ident" id="7014311">pix</span><span class="op" id="7014314">[</span><span class="op" id="7014315">(</span><span class="ident" id="7014316">y</span><span class="op" id="7014317">+</span><span class="ident" id="7014318">j</span><span class="op" id="7014319">)</span><span class="op" id="7014320">*</span><span class="ident" id="7014321">stride</span><span class="op" id="7014327">+</span><span class="op" id="7014328">(</span><span class="ident" id="7014329">x</span><span class="op" id="7014330">+</span><span class="ident" id="7014331">i</span><span class="op" id="7014332">)</span><span class="op" id="7014333">]</span><span class="op" id="7014334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014342">fmt</span><span class="op" id="7014345">.</span><span class="ident" id="7014346">Fprintf</span><span class="op" id="7014353">(</span><span class="ident" id="7014354">s</span><span class="op" id="7014355">,</span>&nbsp;<span class="string" id="7014357">&#34;\n&#34;</span><span class="op" id="7014361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014367">return</span>&nbsp;<span class="ident" id="7014374">s</span><span class="op" id="7014375">.</span><span class="ident" id="7014376">String</span><span class="op" id="7014382">(</span><span class="op" id="7014383">)</span><br>
<span class="lineno">185</span><span class="op" id="7014385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7014388">func</span>&nbsp;<span class="ident" id="7014393">TestExtraneousData</span><span class="op" id="7014411">(</span><span class="ident" id="7014412">t</span>&nbsp;<span class="op" id="7014414">*</span><span class="ident" id="7014415">testing</span><span class="op" id="7014422">.</span><span class="ident" id="7014423">T</span><span class="op" id="7014424">)</span>&nbsp;<span class="op" id="7014426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7014429">//&nbsp;Encode&nbsp;a&nbsp;1x1&nbsp;red&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014457">src</span>&nbsp;<span class="op" id="7014461">:=</span>&nbsp;<span class="ident" id="7014464">image</span><span class="op" id="7014469">.</span><span class="ident" id="7014470">NewRGBA</span><span class="op" id="7014477">(</span><span class="ident" id="7014478">image</span><span class="op" id="7014483">.</span><span class="ident" id="7014484">Rect</span><span class="op" id="7014488">(</span><span class="num" id="7014489">0</span><span class="op" id="7014490">,</span>&nbsp;<span class="num" id="7014492">0</span><span class="op" id="7014493">,</span>&nbsp;<span class="num" id="7014495">1</span><span class="op" id="7014496">,</span>&nbsp;<span class="num" id="7014498">1</span><span class="op" id="7014499">)</span><span class="op" id="7014500">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014503">src</span><span class="op" id="7014506">.</span><span class="ident" id="7014507">Set</span><span class="op" id="7014510">(</span><span class="num" id="7014511">0</span><span class="op" id="7014512">,</span>&nbsp;<span class="num" id="7014514">0</span><span class="op" id="7014515">,</span>&nbsp;<span class="ident" id="7014517">color</span><span class="op" id="7014522">.</span><span class="ident" id="7014523">RGBA</span><span class="op" id="7014527">{</span><span class="num" id="7014528">0xff</span><span class="op" id="7014532">,</span>&nbsp;<span class="num" id="7014534">0x00</span><span class="op" id="7014538">,</span>&nbsp;<span class="num" id="7014540">0x00</span><span class="op" id="7014544">,</span>&nbsp;<span class="num" id="7014546">0xff</span><span class="op" id="7014550">}</span><span class="op" id="7014551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014554">buf</span>&nbsp;<span class="op" id="7014558">:=</span>&nbsp;<span class="builtinfunc" id="7014561">new</span><span class="op" id="7014564">(</span><span class="ident" id="7014565">bytes</span><span class="op" id="7014570">.</span><span class="ident" id="7014571">Buffer</span><span class="op" id="7014577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014580">if</span>&nbsp;<span class="ident" id="7014583">err</span>&nbsp;<span class="op" id="7014587">:=</span>&nbsp;<span class="ident" id="7014590">Encode</span><span class="op" id="7014596">(</span><span class="ident" id="7014597">buf</span><span class="op" id="7014600">,</span>&nbsp;<span class="ident" id="7014602">src</span><span class="op" id="7014605">,</span>&nbsp;<span class="ident" id="7014607">nil</span><span class="op" id="7014610">)</span><span class="op" id="7014611">;</span>&nbsp;<span class="ident" id="7014613">err</span>&nbsp;<span class="op" id="7014617">!=</span>&nbsp;<span class="ident" id="7014620">nil</span>&nbsp;<span class="op" id="7014624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014628">t</span><span class="op" id="7014629">.</span><span class="ident" id="7014630">Fatalf</span><span class="op" id="7014636">(</span><span class="string" id="7014637">&#34;encode:&nbsp;%v&#34;</span><span class="op" id="7014649">,</span>&nbsp;<span class="ident" id="7014651">err</span><span class="op" id="7014654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014657">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014660">enc</span>&nbsp;<span class="op" id="7014664">:=</span>&nbsp;<span class="ident" id="7014667">buf</span><span class="op" id="7014670">.</span><span class="ident" id="7014671">String</span><span class="op" id="7014677">(</span><span class="op" id="7014678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7014681">//&nbsp;Sanity&nbsp;check&nbsp;that&nbsp;the&nbsp;encoded&nbsp;JPEG&nbsp;is&nbsp;long&nbsp;enough,&nbsp;that&nbsp;it&nbsp;ends&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7014754">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker,&nbsp;and&nbsp;that&nbsp;it&nbsp;contains&nbsp;a&nbsp;&#34;\xff\xda&#34;&nbsp;SOS&nbsp;marker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7014826">//&nbsp;somewhere&nbsp;in&nbsp;the&nbsp;final&nbsp;64&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014863">if</span>&nbsp;<span class="builtinfunc" id="7014866">len</span><span class="op" id="7014869">(</span><span class="ident" id="7014870">enc</span><span class="op" id="7014873">)</span>&nbsp;<span class="op" id="7014875">&lt;</span>&nbsp;<span class="num" id="7014877">64</span>&nbsp;<span class="op" id="7014880">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7014884">t</span><span class="op" id="7014885">.</span><span class="ident" id="7014886">Fatalf</span><span class="op" id="7014892">(</span><span class="string" id="7014893">&#34;encoded&nbsp;JPEG&nbsp;is&nbsp;too&nbsp;short:&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="7014930">,</span>&nbsp;<span class="builtinfunc" id="7014932">len</span><span class="op" id="7014935">(</span><span class="ident" id="7014936">enc</span><span class="op" id="7014939">)</span><span class="op" id="7014940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7014943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7014946">if</span>&nbsp;<span class="ident" id="7014949">got</span><span class="op" id="7014952">,</span>&nbsp;<span class="ident" id="7014954">want</span>&nbsp;<span class="op" id="7014959">:=</span>&nbsp;<span class="ident" id="7014962">enc</span><span class="op" id="7014965">[</span><span class="builtinfunc" id="7014966">len</span><span class="op" id="7014969">(</span><span class="ident" id="7014970">enc</span><span class="op" id="7014973">)</span><span class="op" id="7014974">-</span><span class="num" id="7014975">2</span><span class="op" id="7014976">:</span><span class="op" id="7014977">]</span><span class="op" id="7014978">,</span>&nbsp;<span class="string" id="7014980">&#34;\xff\xd9&#34;</span><span class="op" id="7014990">;</span>&nbsp;<span class="ident" id="7014992">got</span>&nbsp;<span class="op" id="7014996">!=</span>&nbsp;<span class="ident" id="7014999">want</span>&nbsp;<span class="op" id="7015004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015008">t</span><span class="op" id="7015009">.</span><span class="ident" id="7015010">Fatalf</span><span class="op" id="7015016">(</span><span class="string" id="7015017">&#34;encoded&nbsp;JPEG&nbsp;ends&nbsp;with&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7015053">,</span>&nbsp;<span class="ident" id="7015055">got</span><span class="op" id="7015058">,</span>&nbsp;<span class="ident" id="7015060">want</span><span class="op" id="7015064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015067">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015070">if</span>&nbsp;<span class="ident" id="7015073">s</span>&nbsp;<span class="op" id="7015075">:=</span>&nbsp;<span class="ident" id="7015078">enc</span><span class="op" id="7015081">[</span><span class="builtinfunc" id="7015082">len</span><span class="op" id="7015085">(</span><span class="ident" id="7015086">enc</span><span class="op" id="7015089">)</span><span class="op" id="7015090">-</span><span class="num" id="7015091">64</span><span class="op" id="7015093">:</span><span class="op" id="7015094">]</span><span class="op" id="7015095">;</span>&nbsp;<span class="op" id="7015097">!</span><span class="ident" id="7015098">strings</span><span class="op" id="7015105">.</span><span class="ident" id="7015106">Contains</span><span class="op" id="7015114">(</span><span class="ident" id="7015115">s</span><span class="op" id="7015116">,</span>&nbsp;<span class="string" id="7015118">&#34;\xff\xda&#34;</span><span class="op" id="7015128">)</span>&nbsp;<span class="op" id="7015130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015134">t</span><span class="op" id="7015135">.</span><span class="ident" id="7015136">Fatalf</span><span class="op" id="7015142">(</span><span class="string" id="7015143">&#34;encoded&nbsp;JPEG&nbsp;does&nbsp;not&nbsp;contain&nbsp;a&nbsp;SOS&nbsp;marker&nbsp;(ff&nbsp;da)&nbsp;near&nbsp;the&nbsp;end:&nbsp;%&nbsp;x&#34;</span><span class="op" id="7015213">,</span>&nbsp;<span class="ident" id="7015215">s</span><span class="op" id="7015216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7015222">//&nbsp;Test&nbsp;that&nbsp;adding&nbsp;some&nbsp;random&nbsp;junk&nbsp;between&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7015291">//&nbsp;EOI&nbsp;marker&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;decoding.</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015336">rnd</span>&nbsp;<span class="op" id="7015340">:=</span>&nbsp;<span class="ident" id="7015343">rand</span><span class="op" id="7015347">.</span><span class="ident" id="7015348">New</span><span class="op" id="7015351">(</span><span class="ident" id="7015352">rand</span><span class="op" id="7015356">.</span><span class="ident" id="7015357">NewSource</span><span class="op" id="7015366">(</span><span class="num" id="7015367">1</span><span class="op" id="7015368">)</span><span class="op" id="7015369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015372">for</span>&nbsp;<span class="ident" id="7015376">i</span><span class="op" id="7015377">,</span>&nbsp;<span class="ident" id="7015379">nerr</span>&nbsp;<span class="op" id="7015384">:=</span>&nbsp;<span class="num" id="7015387">0</span><span class="op" id="7015388">,</span>&nbsp;<span class="num" id="7015390">0</span><span class="op" id="7015391">;</span>&nbsp;<span class="ident" id="7015393">i</span>&nbsp;<span class="op" id="7015395">&lt;</span>&nbsp;<span class="num" id="7015397">1000</span>&nbsp;<span class="op" id="7015402">&amp;&amp;</span>&nbsp;<span class="ident" id="7015405">nerr</span>&nbsp;<span class="op" id="7015410">&lt;</span>&nbsp;<span class="num" id="7015412">10</span><span class="op" id="7015414">;</span>&nbsp;<span class="ident" id="7015416">i</span><span class="op" id="7015417">++</span>&nbsp;<span class="op" id="7015420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015424">buf</span><span class="op" id="7015427">.</span><span class="ident" id="7015428">Reset</span><span class="op" id="7015433">(</span><span class="op" id="7015434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7015438">//&nbsp;Write&nbsp;all&nbsp;but&nbsp;the&nbsp;trailing&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015493">buf</span><span class="op" id="7015496">.</span><span class="ident" id="7015497">WriteString</span><span class="op" id="7015508">(</span><span class="ident" id="7015509">enc</span><span class="op" id="7015512">[</span><span class="op" id="7015513">:</span><span class="builtinfunc" id="7015514">len</span><span class="op" id="7015517">(</span><span class="ident" id="7015518">enc</span><span class="op" id="7015521">)</span><span class="op" id="7015522">-</span><span class="num" id="7015523">2</span><span class="op" id="7015524">]</span><span class="op" id="7015525">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7015529">//&nbsp;Write&nbsp;some&nbsp;random&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015569">for</span>&nbsp;<span class="ident" id="7015573">n</span>&nbsp;<span class="op" id="7015575">:=</span>&nbsp;<span class="ident" id="7015578">rnd</span><span class="op" id="7015581">.</span><span class="ident" id="7015582">Intn</span><span class="op" id="7015586">(</span><span class="num" id="7015587">10</span><span class="op" id="7015589">)</span><span class="op" id="7015590">;</span>&nbsp;<span class="ident" id="7015592">n</span>&nbsp;<span class="op" id="7015594">&gt;</span>&nbsp;<span class="num" id="7015596">0</span><span class="op" id="7015597">;</span>&nbsp;<span class="ident" id="7015599">n</span><span class="op" id="7015600">--</span>&nbsp;<span class="op" id="7015603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015608">if</span>&nbsp;<span class="ident" id="7015611">x</span>&nbsp;<span class="op" id="7015613">:=</span>&nbsp;<span class="builtintype" id="7015616">byte</span><span class="op" id="7015620">(</span><span class="ident" id="7015621">rnd</span><span class="op" id="7015624">.</span><span class="ident" id="7015625">Intn</span><span class="op" id="7015629">(</span><span class="num" id="7015630">256</span><span class="op" id="7015633">)</span><span class="op" id="7015634">)</span><span class="op" id="7015635">;</span>&nbsp;<span class="ident" id="7015637">x</span>&nbsp;<span class="op" id="7015639">!=</span>&nbsp;<span class="num" id="7015642">0xff</span>&nbsp;<span class="op" id="7015647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015653">buf</span><span class="op" id="7015656">.</span><span class="ident" id="7015657">WriteByte</span><span class="op" id="7015666">(</span><span class="ident" id="7015667">x</span><span class="op" id="7015668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015673">}</span>&nbsp;<span class="keyword" id="7015675">else</span>&nbsp;<span class="op" id="7015680">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7015686">//&nbsp;The&nbsp;JPEG&nbsp;format&nbsp;escapes&nbsp;a&nbsp;SOS&nbsp;0xff&nbsp;data&nbsp;byte&nbsp;as&nbsp;&#34;\xff\x00&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015753">buf</span><span class="op" id="7015756">.</span><span class="ident" id="7015757">WriteString</span><span class="op" id="7015768">(</span><span class="string" id="7015769">&#34;\xff\x00&#34;</span><span class="op" id="7015779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7015788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7015792">//&nbsp;Write&nbsp;the&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015830">buf</span><span class="op" id="7015833">.</span><span class="ident" id="7015834">WriteString</span><span class="op" id="7015845">(</span><span class="string" id="7015846">&#34;\xff\xd9&#34;</span><span class="op" id="7015856">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7015861">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;can&nbsp;still&nbsp;decode&nbsp;the&nbsp;resultant&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015918">got</span><span class="op" id="7015921">,</span>&nbsp;<span class="ident" id="7015923">err</span>&nbsp;<span class="op" id="7015927">:=</span>&nbsp;<span class="ident" id="7015930">Decode</span><span class="op" id="7015936">(</span><span class="ident" id="7015937">buf</span><span class="op" id="7015940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7015944">if</span>&nbsp;<span class="ident" id="7015947">err</span>&nbsp;<span class="op" id="7015951">!=</span>&nbsp;<span class="ident" id="7015954">nil</span>&nbsp;<span class="op" id="7015958">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7015963">t</span><span class="op" id="7015964">.</span><span class="ident" id="7015965">Errorf</span><span class="op" id="7015971">(</span><span class="string" id="7015972">&#34;could&nbsp;not&nbsp;decode&nbsp;image&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="7016004">,</span>&nbsp;<span class="ident" id="7016006">i</span><span class="op" id="7016007">,</span>&nbsp;<span class="ident" id="7016009">err</span><span class="op" id="7016012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016017">nerr</span><span class="op" id="7016021">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016027">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7016038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016042">if</span>&nbsp;<span class="ident" id="7016045">got</span><span class="op" id="7016048">.</span><span class="ident" id="7016049">Bounds</span><span class="op" id="7016055">(</span><span class="op" id="7016056">)</span>&nbsp;<span class="op" id="7016058">!=</span>&nbsp;<span class="ident" id="7016061">src</span><span class="op" id="7016064">.</span><span class="ident" id="7016065">Bounds</span><span class="op" id="7016071">(</span><span class="op" id="7016072">)</span>&nbsp;<span class="op" id="7016074">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016079">t</span><span class="op" id="7016080">.</span><span class="ident" id="7016081">Errorf</span><span class="op" id="7016087">(</span><span class="string" id="7016088">&#34;image&nbsp;#%d,&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="7016125">,</span>&nbsp;<span class="ident" id="7016127">i</span><span class="op" id="7016128">,</span>&nbsp;<span class="ident" id="7016130">got</span><span class="op" id="7016133">.</span><span class="ident" id="7016134">Bounds</span><span class="op" id="7016140">(</span><span class="op" id="7016141">)</span><span class="op" id="7016142">,</span>&nbsp;<span class="ident" id="7016144">src</span><span class="op" id="7016147">.</span><span class="ident" id="7016148">Bounds</span><span class="op" id="7016154">(</span><span class="op" id="7016155">)</span><span class="op" id="7016156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016161">nerr</span><span class="op" id="7016165">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016171">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7016182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016186">if</span>&nbsp;<span class="ident" id="7016189">averageDelta</span><span class="op" id="7016201">(</span><span class="ident" id="7016202">got</span><span class="op" id="7016205">,</span>&nbsp;<span class="ident" id="7016207">src</span><span class="op" id="7016210">)</span>&nbsp;<span class="op" id="7016212">&gt;</span>&nbsp;<span class="num" id="7016214">2</span><span class="op" id="7016215">&lt;&lt;</span><span class="num" id="7016217">8</span>&nbsp;<span class="op" id="7016219">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016224">t</span><span class="op" id="7016225">.</span><span class="ident" id="7016226">Errorf</span><span class="op" id="7016232">(</span><span class="string" id="7016233">&#34;image&nbsp;#%d&nbsp;changed&nbsp;too&nbsp;much&nbsp;after&nbsp;a&nbsp;round&nbsp;trip&#34;</span><span class="op" id="7016280">,</span>&nbsp;<span class="ident" id="7016282">i</span><span class="op" id="7016283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016288">nerr</span><span class="op" id="7016292">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016298">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7016309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7016312">}</span><br>
<span class="lineno">245</span><span class="op" id="7016314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7016317">func</span>&nbsp;<span class="ident" id="7016322">benchmarkDecode</span><span class="op" id="7016337">(</span><span class="ident" id="7016338">b</span>&nbsp;<span class="op" id="7016340">*</span><span class="ident" id="7016341">testing</span><span class="op" id="7016348">.</span><span class="ident" id="7016349">B</span><span class="op" id="7016350">,</span>&nbsp;<span class="ident" id="7016352">filename</span>&nbsp;<span class="builtintype" id="7016361">string</span><span class="op" id="7016367">)</span>&nbsp;<span class="op" id="7016369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016372">b</span><span class="op" id="7016373">.</span><span class="ident" id="7016374">StopTimer</span><span class="op" id="7016383">(</span><span class="op" id="7016384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016387">data</span><span class="op" id="7016391">,</span>&nbsp;<span class="ident" id="7016393">err</span>&nbsp;<span class="op" id="7016397">:=</span>&nbsp;<span class="ident" id="7016400">ioutil</span><span class="op" id="7016406">.</span><span class="ident" id="7016407">ReadFile</span><span class="op" id="7016415">(</span><span class="ident" id="7016416">filename</span><span class="op" id="7016424">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016427">if</span>&nbsp;<span class="ident" id="7016430">err</span>&nbsp;<span class="op" id="7016434">!=</span>&nbsp;<span class="ident" id="7016437">nil</span>&nbsp;<span class="op" id="7016441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016445">b</span><span class="op" id="7016446">.</span><span class="ident" id="7016447">Fatal</span><span class="op" id="7016452">(</span><span class="ident" id="7016453">err</span><span class="op" id="7016456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7016459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016462">cfg</span><span class="op" id="7016465">,</span>&nbsp;<span class="ident" id="7016467">err</span>&nbsp;<span class="op" id="7016471">:=</span>&nbsp;<span class="ident" id="7016474">DecodeConfig</span><span class="op" id="7016486">(</span><span class="ident" id="7016487">bytes</span><span class="op" id="7016492">.</span><span class="ident" id="7016493">NewReader</span><span class="op" id="7016502">(</span><span class="ident" id="7016503">data</span><span class="op" id="7016507">)</span><span class="op" id="7016508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016511">if</span>&nbsp;<span class="ident" id="7016514">err</span>&nbsp;<span class="op" id="7016518">!=</span>&nbsp;<span class="ident" id="7016521">nil</span>&nbsp;<span class="op" id="7016525">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016529">b</span><span class="op" id="7016530">.</span><span class="ident" id="7016531">Fatal</span><span class="op" id="7016536">(</span><span class="ident" id="7016537">err</span><span class="op" id="7016540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7016543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016546">b</span><span class="op" id="7016547">.</span><span class="ident" id="7016548">SetBytes</span><span class="op" id="7016556">(</span><span class="ident" id="7016557">int64</span><span class="op" id="7016562">(</span><span class="ident" id="7016563">cfg</span><span class="op" id="7016566">.</span><span class="ident" id="7016567">Width</span>&nbsp;<span class="op" id="7016573">*</span>&nbsp;<span class="ident" id="7016575">cfg</span><span class="op" id="7016578">.</span><span class="ident" id="7016579">Height</span>&nbsp;<span class="op" id="7016586">*</span>&nbsp;<span class="num" id="7016588">4</span><span class="op" id="7016589">)</span><span class="op" id="7016590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016593">b</span><span class="op" id="7016594">.</span><span class="ident" id="7016595">StartTimer</span><span class="op" id="7016605">(</span><span class="op" id="7016606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7016609">for</span>&nbsp;<span class="ident" id="7016613">i</span>&nbsp;<span class="op" id="7016615">:=</span>&nbsp;<span class="num" id="7016618">0</span><span class="op" id="7016619">;</span>&nbsp;<span class="ident" id="7016621">i</span>&nbsp;<span class="op" id="7016623">&lt;</span>&nbsp;<span class="ident" id="7016625">b</span><span class="op" id="7016626">.</span><span class="ident" id="7016627">N</span><span class="op" id="7016628">;</span>&nbsp;<span class="ident" id="7016630">i</span><span class="op" id="7016631">++</span>&nbsp;<span class="op" id="7016634">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016638">Decode</span><span class="op" id="7016644">(</span><span class="ident" id="7016645">bytes</span><span class="op" id="7016650">.</span><span class="ident" id="7016651">NewReader</span><span class="op" id="7016660">(</span><span class="ident" id="7016661">data</span><span class="op" id="7016665">)</span><span class="op" id="7016666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7016669">}</span><br>
<span class="lineno"></span><span class="op" id="7016671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7016674">func</span>&nbsp;<span class="ident" id="7016679">BenchmarkDecodeBaseline</span><span class="op" id="7016702">(</span><span class="ident" id="7016703">b</span>&nbsp;<span class="op" id="7016705">*</span><span class="ident" id="7016706">testing</span><span class="op" id="7016713">.</span><span class="ident" id="7016714">B</span><span class="op" id="7016715">)</span>&nbsp;<span class="op" id="7016717">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016720">benchmarkDecode</span><span class="op" id="7016735">(</span><span class="ident" id="7016736">b</span><span class="op" id="7016737">,</span>&nbsp;<span class="string" id="7016739">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="7016767">)</span><br>
<span class="lineno"></span><span class="op" id="7016769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7016772">func</span>&nbsp;<span class="ident" id="7016777">BenchmarkDecodeProgressive</span><span class="op" id="7016803">(</span><span class="ident" id="7016804">b</span>&nbsp;<span class="op" id="7016806">*</span><span class="ident" id="7016807">testing</span><span class="op" id="7016814">.</span><span class="ident" id="7016815">B</span><span class="op" id="7016816">)</span>&nbsp;<span class="op" id="7016818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7016821">benchmarkDecode</span><span class="op" id="7016836">(</span><span class="ident" id="7016837">b</span><span class="op" id="7016838">,</span>&nbsp;<span class="string" id="7016840">&#34;../testdata/video-001.progressive.jpeg&#34;</span><span class="op" id="7016880">)</span><br>
<span class="lineno">270</span><span class="op" id="7016882">}</span>
</div>
</body>
</html>
