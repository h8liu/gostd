<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5079688">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5079743">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5079797">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5079848">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspPackage&nbsp;rpc&nbsp;provides&nbsp;access&nbsp;to&nbsp;the&nbsp;exported&nbsp;methods&nbsp;of&nbsp;an&nbsp;object&nbsp;across&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspnetwork&nbsp;or&nbsp;other&nbsp;I/O&nbsp;connection.&nbsp;&nbsp;A&nbsp;server&nbsp;registers&nbsp;an&nbsp;object,&nbsp;making&nbsp;it&nbsp;visible<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspas&nbsp;a&nbsp;service&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;After&nbsp;registration,&nbsp;exported<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspmethods&nbsp;of&nbsp;the&nbsp;object&nbsp;will&nbsp;be&nbsp;accessible&nbsp;remotely.&nbsp;&nbsp;A&nbsp;server&nbsp;may&nbsp;register&nbsp;multiple<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;(services)&nbsp;of&nbsp;different&nbsp;types&nbsp;but&nbsp;it&nbsp;is&nbsp;an&nbsp;error&nbsp;to&nbsp;register&nbsp;multiple<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;of&nbsp;the&nbsp;same&nbsp;type.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspOnly&nbsp;methods&nbsp;that&nbsp;satisfy&nbsp;these&nbsp;criteria&nbsp;will&nbsp;be&nbsp;made&nbsp;available&nbsp;for&nbsp;remote&nbsp;access;<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspother&nbsp;methods&nbsp;will&nbsp;be&nbsp;ignored:<br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;is&nbsp;exported.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;exported&nbsp;(or&nbsp;builtin)&nbsp;types.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&#39;s&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;return&nbsp;type&nbsp;error.<br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspIn&nbsp;effect,&nbsp;the&nbsp;method&nbsp;must&nbsp;look&nbsp;schematically&nbsp;like<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*T)&nbsp;MethodName(argType&nbsp;T1,&nbsp;replyType&nbsp;*T2)&nbsp;error<br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbspwhere&nbsp;T,&nbsp;T1&nbsp;and&nbsp;T2&nbsp;can&nbsp;be&nbsp;marshaled&nbsp;by&nbsp;encoding/gob.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThese&nbsp;requirements&nbsp;apply&nbsp;even&nbsp;if&nbsp;a&nbsp;different&nbsp;codec&nbsp;is&nbsp;used.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp(In&nbsp;the&nbsp;future,&nbsp;these&nbsp;requirements&nbsp;may&nbsp;soften&nbsp;for&nbsp;custom&nbsp;codecs.)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;first&nbsp;argument&nbsp;represents&nbsp;the&nbsp;arguments&nbsp;provided&nbsp;by&nbsp;the&nbsp;caller;&nbsp;the<br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbspsecond&nbsp;argument&nbsp;represents&nbsp;the&nbsp;result&nbsp;parameters&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;caller.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;return&nbsp;value,&nbsp;if&nbsp;non-nil,&nbsp;is&nbsp;passed&nbsp;back&nbsp;as&nbsp;a&nbsp;string&nbsp;that&nbsp;the&nbsp;client<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspsees&nbsp;as&nbsp;if&nbsp;created&nbsp;by&nbsp;errors.New.&nbsp;&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;returned,&nbsp;the&nbsp;reply&nbsp;parameter<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspwill&nbsp;not&nbsp;be&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;may&nbsp;handle&nbsp;requests&nbsp;on&nbsp;a&nbsp;single&nbsp;connection&nbsp;by&nbsp;calling&nbsp;ServeConn.&nbsp;&nbsp;More<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptypically&nbsp;it&nbsp;will&nbsp;create&nbsp;a&nbsp;network&nbsp;listener&nbsp;and&nbsp;call&nbsp;Accept&nbsp;or,&nbsp;for&nbsp;an&nbsp;HTTP<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplistener,&nbsp;HandleHTTP&nbsp;and&nbsp;http.Serve.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;client&nbsp;wishing&nbsp;to&nbsp;use&nbsp;the&nbsp;service&nbsp;establishes&nbsp;a&nbsp;connection&nbsp;and&nbsp;then&nbsp;invokes<br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbspNewClient&nbsp;on&nbsp;the&nbsp;connection.&nbsp;&nbsp;The&nbsp;convenience&nbsp;function&nbsp;Dial&nbsp;(DialHTTP)&nbsp;performs<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;steps&nbsp;for&nbsp;a&nbsp;raw&nbsp;network&nbsp;connection&nbsp;(an&nbsp;HTTP&nbsp;connection).&nbsp;&nbsp;The&nbsp;resulting<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspClient&nbsp;object&nbsp;has&nbsp;two&nbsp;methods,&nbsp;Call&nbsp;and&nbsp;Go,&nbsp;that&nbsp;specify&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspcall,&nbsp;a&nbsp;pointer&nbsp;containing&nbsp;the&nbsp;arguments,&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;receive&nbsp;the&nbsp;result<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspparameters.<br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;Call&nbsp;method&nbsp;waits&nbsp;for&nbsp;the&nbsp;remote&nbsp;call&nbsp;to&nbsp;complete&nbsp;while&nbsp;the&nbsp;Go&nbsp;method<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplaunches&nbsp;the&nbsp;call&nbsp;asynchronously&nbsp;and&nbsp;signals&nbsp;completion&nbsp;using&nbsp;the&nbsp;Call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspstructure&#39;s&nbsp;Done&nbsp;channel.<br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbspUnless&nbsp;an&nbsp;explicit&nbsp;codec&nbsp;is&nbsp;set&nbsp;up,&nbsp;package&nbsp;encoding/gob&nbsp;is&nbsp;used&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptransport&nbsp;the&nbsp;data.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspHere&nbsp;is&nbsp;a&nbsp;simple&nbsp;example.&nbsp;&nbsp;A&nbsp;server&nbsp;wishes&nbsp;to&nbsp;export&nbsp;an&nbsp;object&nbsp;of&nbsp;type&nbsp;Arith:<br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;server<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Args&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspA,&nbsp;B&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Quotient&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspQuo,&nbsp;Rem&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Arith&nbsp;int<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Multiply(args&nbsp;*Args,&nbsp;reply&nbsp;*int)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp*reply&nbsp;=&nbsp;args.A&nbsp;*&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Divide(args&nbsp;*Args,&nbsp;quo&nbsp;*Quotient)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;args.B&nbsp;==&nbsp;0&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;errors.New(&#34;divide&nbsp;by&nbsp;zero&#34;)<br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Quo&nbsp;=&nbsp;args.A&nbsp;/&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Rem&nbsp;=&nbsp;args.A&nbsp;%&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;calls&nbsp;(for&nbsp;HTTP&nbsp;service):<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsparith&nbsp;:=&nbsp;new(Arith)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.Register(arith)<br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.HandleHTTP()<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspl,&nbsp;e&nbsp;:=&nbsp;net.Listen(&#34;tcp&#34;,&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;e&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;listen&nbsp;error:&#34;,&nbsp;e)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;http.Serve(l,&nbsp;nil)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspAt&nbsp;this&nbsp;point,&nbsp;clients&nbsp;can&nbsp;see&nbsp;a&nbsp;service&nbsp;&#34;Arith&#34;&nbsp;with&nbsp;methods&nbsp;&#34;Arith.Multiply&#34;&nbsp;and<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&#34;Arith.Divide&#34;.&nbsp;&nbsp;To&nbsp;invoke&nbsp;one,&nbsp;a&nbsp;client&nbsp;first&nbsp;dials&nbsp;the&nbsp;server:<br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspclient,&nbsp;err&nbsp;:=&nbsp;rpc.DialHTTP(&#34;tcp&#34;,&nbsp;serverAddress&nbsp;+&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;dialing:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbspThen&nbsp;it&nbsp;can&nbsp;make&nbsp;a&nbsp;remote&nbsp;call:<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Synchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspargs&nbsp;:=&nbsp;&amp;server.Args{7,8}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;reply&nbsp;int<br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;client.Call(&#34;Arith.Multiply&#34;,&nbsp;args,&nbsp;&amp;reply)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;arith&nbsp;error:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfmt.Printf(&#34;Arith:&nbsp;%d*%d=%d&#34;,&nbsp;args.A,&nbsp;args.B,&nbsp;reply)<br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspor<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Asynchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquotient&nbsp;:=&nbsp;new(Quotient)<br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspdivCall&nbsp;:=&nbsp;client.Go(&#34;Arith.Divide&#34;,&nbsp;args,&nbsp;quotient,&nbsp;nil)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreplyCall&nbsp;:=&nbsp;&lt;-divCall.Done&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;will&nbsp;be&nbsp;equal&nbsp;to&nbsp;divCall<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;check&nbsp;errors,&nbsp;print,&nbsp;etc.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;server&nbsp;implementation&nbsp;will&nbsp;often&nbsp;provide&nbsp;a&nbsp;simple,&nbsp;type-safe&nbsp;wrapper&nbsp;for&nbsp;the<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbspclient.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5083677">package</span>&nbsp;<span class="ident" id="5083685">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5083690">import</span>&nbsp;<span class="op" id="5083697">(</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5083700">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5083709">&#34;encoding/gob&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5083725">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5083735">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5083741">&#34;log&#34;</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5083748">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5083755">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5083767">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5083778">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5083789">&#34;sync&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5083797">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5083808">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5083823">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5083826">const</span>&nbsp;<span class="op" id="5083832">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5083835">//&nbsp;Defaults&nbsp;used&nbsp;by&nbsp;HandleHTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5083867">DefaultRPCPath</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5083884">=</span>&nbsp;<span class="string" id="5083886">&#34;/_goRPC_&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5083898">DefaultDebugPath</span>&nbsp;<span class="op" id="5083915">=</span>&nbsp;<span class="string" id="5083917">&#34;/debug/rpc&#34;</span><br>
<span class="lineno"></span><span class="op" id="5083930">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="5083933">//&nbsp;Precompute&nbsp;the&nbsp;reflect&nbsp;type&nbsp;for&nbsp;error.&nbsp;&nbsp;Can&#39;t&nbsp;use&nbsp;error&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="5084001">//&nbsp;because&nbsp;Typeof&nbsp;takes&nbsp;an&nbsp;empty&nbsp;interface&nbsp;value.&nbsp;&nbsp;This&nbsp;is&nbsp;annoying.</span><br>
<span class="lineno"></span><span class="keyword" id="5084070">var</span>&nbsp;<span class="ident" id="5084074">typeOfError</span>&nbsp;<span class="op" id="5084086">=</span>&nbsp;<span class="ident" id="5084088">reflect</span><span class="op" id="5084095">.</span><span class="ident" id="5084096">TypeOf</span><span class="op" id="5084102">(</span><span class="op" id="5084103">(</span><span class="op" id="5084104">*</span><span class="builtintype" id="5084105">error</span><span class="op" id="5084110">)</span><span class="op" id="5084111">(</span><span class="ident" id="5084112">nil</span><span class="op" id="5084115">)</span><span class="op" id="5084116">)</span><span class="op" id="5084117">.</span><span class="ident" id="5084118">Elem</span><span class="op" id="5084122">(</span><span class="op" id="5084123">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5084126">type</span>&nbsp;<span class="ident" id="5084131">methodType</span>&nbsp;<span class="keyword" id="5084142">struct</span>&nbsp;<span class="op" id="5084149">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084152">sync</span><span class="op" id="5084156">.</span><span class="ident" id="5084157">Mutex</span>&nbsp;<span class="comment" id="5084163">//&nbsp;protects&nbsp;counters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084185">method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5084196">reflect</span><span class="op" id="5084203">.</span><span class="ident" id="5084204">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084212">ArgType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5084223">reflect</span><span class="op" id="5084230">.</span><span class="ident" id="5084231">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084237">ReplyType</span>&nbsp;&nbsp;<span class="ident" id="5084248">reflect</span><span class="op" id="5084255">.</span><span class="ident" id="5084256">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084262">numCalls</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5084273">uint</span><br>
<span class="lineno">155</span><span class="op" id="5084278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5084281">type</span>&nbsp;<span class="ident" id="5084286">service</span>&nbsp;<span class="keyword" id="5084294">struct</span>&nbsp;<span class="op" id="5084301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084304">name</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5084311">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5084334">//&nbsp;name&nbsp;of&nbsp;service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084354">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5084361">reflect</span><span class="op" id="5084368">.</span><span class="ident" id="5084369">Value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5084384">//&nbsp;receiver&nbsp;of&nbsp;methods&nbsp;for&nbsp;the&nbsp;service</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084424">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5084431">reflect</span><span class="op" id="5084438">.</span><span class="ident" id="5084439">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5084454">//&nbsp;type&nbsp;of&nbsp;the&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084479">method</span>&nbsp;<span class="keyword" id="5084486">map</span><span class="op" id="5084489">[</span><span class="builtintype" id="5084490">string</span><span class="op" id="5084496">]</span><span class="op" id="5084497">*</span><span class="ident" id="5084498">methodType</span>&nbsp;<span class="comment" id="5084509">//&nbsp;registered&nbsp;methods</span><br>
<span class="lineno"></span><span class="op" id="5084531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5084534">//&nbsp;Request&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;call.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno">165</span><span class="comment" id="5084611">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno"></span><span class="comment" id="5084681">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5084701">type</span>&nbsp;<span class="ident" id="5084706">Request</span>&nbsp;<span class="keyword" id="5084714">struct</span>&nbsp;<span class="op" id="5084721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084724">ServiceMethod</span>&nbsp;<span class="builtintype" id="5084738">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5084747">//&nbsp;format:&nbsp;&#34;Service.Method&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084776">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5084790">uint64</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5084799">//&nbsp;sequence&nbsp;number&nbsp;chosen&nbsp;by&nbsp;client</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5084836">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5084850">*</span><span class="ident" id="5084851">Request</span>&nbsp;<span class="comment" id="5084859">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5084886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5084889">//&nbsp;Response&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;return.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno"></span><span class="comment" id="5084969">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno">175</span><span class="comment" id="5085039">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5085059">type</span>&nbsp;<span class="ident" id="5085064">Response</span>&nbsp;<span class="keyword" id="5085073">struct</span>&nbsp;<span class="op" id="5085080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085083">ServiceMethod</span>&nbsp;<span class="builtintype" id="5085097">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5085107">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085138">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5085152">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5085162">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085193">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5085207">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5085217">//&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085236">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5085250">*</span><span class="ident" id="5085251">Response</span>&nbsp;<span class="comment" id="5085260">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5085287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5085290">//&nbsp;Server&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5085326">type</span>&nbsp;<span class="ident" id="5085331">Server</span>&nbsp;<span class="keyword" id="5085338">struct</span>&nbsp;<span class="op" id="5085345">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085348">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5085359">sync</span><span class="op" id="5085363">.</span><span class="ident" id="5085364">RWMutex</span>&nbsp;<span class="comment" id="5085372">//&nbsp;protects&nbsp;the&nbsp;serviceMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085400">serviceMap</span>&nbsp;<span class="keyword" id="5085411">map</span><span class="op" id="5085414">[</span><span class="builtintype" id="5085415">string</span><span class="op" id="5085421">]</span><span class="op" id="5085422">*</span><span class="ident" id="5085423">service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085432">reqLock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5085443">sync</span><span class="op" id="5085447">.</span><span class="ident" id="5085448">Mutex</span>&nbsp;<span class="comment" id="5085454">//&nbsp;protects&nbsp;freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085475">freeReq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5085486">*</span><span class="ident" id="5085487">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085496">respLock</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5085507">sync</span><span class="op" id="5085511">.</span><span class="ident" id="5085512">Mutex</span>&nbsp;<span class="comment" id="5085518">//&nbsp;protects&nbsp;freeResp</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5085540">freeResp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5085551">*</span><span class="ident" id="5085552">Response</span><br>
<span class="lineno"></span><span class="op" id="5085561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5085564">//&nbsp;NewServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5085599">func</span>&nbsp;<span class="ident" id="5085604">NewServer</span><span class="op" id="5085613">(</span><span class="op" id="5085614">)</span>&nbsp;<span class="op" id="5085616">*</span><span class="ident" id="5085617">Server</span>&nbsp;<span class="op" id="5085624">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5085627">return</span>&nbsp;<span class="op" id="5085634">&amp;</span><span class="ident" id="5085635">Server</span><span class="op" id="5085641">{</span><span class="ident" id="5085642">serviceMap</span><span class="op" id="5085652">:</span>&nbsp;<span class="builtinfunc" id="5085654">make</span><span class="op" id="5085658">(</span><span class="keyword" id="5085659">map</span><span class="op" id="5085662">[</span><span class="builtintype" id="5085663">string</span><span class="op" id="5085669">]</span><span class="op" id="5085670">*</span><span class="ident" id="5085671">service</span><span class="op" id="5085678">)</span><span class="op" id="5085679">}</span><br>
<span class="lineno"></span><span class="op" id="5085681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5085684">//&nbsp;DefaultServer&nbsp;is&nbsp;the&nbsp;default&nbsp;instance&nbsp;of&nbsp;*Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5085737">var</span>&nbsp;<span class="ident" id="5085741">DefaultServer</span>&nbsp;<span class="op" id="5085755">=</span>&nbsp;<span class="ident" id="5085757">NewServer</span><span class="op" id="5085766">(</span><span class="op" id="5085767">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5085770">//&nbsp;Is&nbsp;this&nbsp;an&nbsp;exported&nbsp;-&nbsp;upper&nbsp;case&nbsp;-&nbsp;name?</span><br>
<span class="lineno"></span><span class="keyword" id="5085814">func</span>&nbsp;<span class="ident" id="5085819">isExported</span><span class="op" id="5085829">(</span><span class="ident" id="5085830">name</span>&nbsp;<span class="builtintype" id="5085835">string</span><span class="op" id="5085841">)</span>&nbsp;<span class="builtintype" id="5085843">bool</span>&nbsp;<span class="op" id="5085848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5085851">rune</span><span class="op" id="5085855">,</span>&nbsp;<span class="ident" id="5085857">_</span>&nbsp;<span class="op" id="5085859">:=</span>&nbsp;<span class="ident" id="5085862">utf8</span><span class="op" id="5085866">.</span><span class="ident" id="5085867">DecodeRuneInString</span><span class="op" id="5085885">(</span><span class="ident" id="5085886">name</span><span class="op" id="5085890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5085893">return</span>&nbsp;<span class="ident" id="5085900">unicode</span><span class="op" id="5085907">.</span><span class="ident" id="5085908">IsUpper</span><span class="op" id="5085915">(</span><span class="builtintype" id="5085916">rune</span><span class="op" id="5085920">)</span><br>
<span class="lineno">205</span><span class="op" id="5085922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5085925">//&nbsp;Is&nbsp;this&nbsp;type&nbsp;exported&nbsp;or&nbsp;a&nbsp;builtin?</span><br>
<span class="lineno"></span><span class="keyword" id="5085964">func</span>&nbsp;<span class="ident" id="5085969">isExportedOrBuiltinType</span><span class="op" id="5085992">(</span><span class="ident" id="5085993">t</span>&nbsp;<span class="ident" id="5085995">reflect</span><span class="op" id="5086002">.</span><span class="ident" id="5086003">Type</span><span class="op" id="5086007">)</span>&nbsp;<span class="builtintype" id="5086009">bool</span>&nbsp;<span class="op" id="5086014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5086017">for</span>&nbsp;<span class="ident" id="5086021">t</span><span class="op" id="5086022">.</span><span class="ident" id="5086023">Kind</span><span class="op" id="5086027">(</span><span class="op" id="5086028">)</span>&nbsp;<span class="op" id="5086030">==</span>&nbsp;<span class="ident" id="5086033">reflect</span><span class="op" id="5086040">.</span><span class="ident" id="5086041">Ptr</span>&nbsp;<span class="op" id="5086045">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5086049">t</span>&nbsp;<span class="op" id="5086051">=</span>&nbsp;<span class="ident" id="5086053">t</span><span class="op" id="5086054">.</span><span class="ident" id="5086055">Elem</span><span class="op" id="5086059">(</span><span class="op" id="5086060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5086063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5086066">//&nbsp;PkgPath&nbsp;will&nbsp;be&nbsp;non-empty&nbsp;even&nbsp;for&nbsp;an&nbsp;exported&nbsp;type,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5086123">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;the&nbsp;type&nbsp;name&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5086170">return</span>&nbsp;<span class="ident" id="5086177">isExported</span><span class="op" id="5086187">(</span><span class="ident" id="5086188">t</span><span class="op" id="5086189">.</span><span class="ident" id="5086190">Name</span><span class="op" id="5086194">(</span><span class="op" id="5086195">)</span><span class="op" id="5086196">)</span>&nbsp;<span class="op" id="5086198">||</span>&nbsp;<span class="ident" id="5086201">t</span><span class="op" id="5086202">.</span><span class="ident" id="5086203">PkgPath</span><span class="op" id="5086210">(</span><span class="op" id="5086211">)</span>&nbsp;<span class="op" id="5086213">==</span>&nbsp;<span class="string" id="5086216">&#34;&#34;</span><br>
<span class="lineno">215</span><span class="op" id="5086219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5086222">//&nbsp;Register&nbsp;publishes&nbsp;in&nbsp;the&nbsp;server&nbsp;the&nbsp;set&nbsp;of&nbsp;methods&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5086284">//&nbsp;receiver&nbsp;value&nbsp;that&nbsp;satisfy&nbsp;the&nbsp;following&nbsp;conditions:</span><br>
<span class="lineno"></span><span class="comment" id="5086341">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;exported&nbsp;method</span><br>
<span class="lineno">220</span><span class="comment" id="5086362">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;of&nbsp;exported&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5086404">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span><span class="comment" id="5086442">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;one&nbsp;return&nbsp;value,&nbsp;of&nbsp;type&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5086479">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;receiver&nbsp;is&nbsp;not&nbsp;an&nbsp;exported&nbsp;type&nbsp;or&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="5086549">//&nbsp;no&nbsp;suitable&nbsp;methods.&nbsp;It&nbsp;also&nbsp;logs&nbsp;the&nbsp;error&nbsp;using&nbsp;package&nbsp;log.</span><br>
<span class="lineno">225</span><span class="comment" id="5086615">//&nbsp;The&nbsp;client&nbsp;accesses&nbsp;each&nbsp;method&nbsp;using&nbsp;a&nbsp;string&nbsp;of&nbsp;the&nbsp;form&nbsp;&#34;Type.Method&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="5086692">//&nbsp;where&nbsp;Type&nbsp;is&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5086739">func</span>&nbsp;<span class="op" id="5086744">(</span><span class="ident" id="5086745">server</span>&nbsp;<span class="op" id="5086752">*</span><span class="ident" id="5086753">Server</span><span class="op" id="5086759">)</span>&nbsp;<span class="ident" id="5086761">Register</span><span class="op" id="5086769">(</span><span class="ident" id="5086770">rcvr</span>&nbsp;<span class="keyword" id="5086775">interface</span><span class="op" id="5086784">{</span><span class="op" id="5086785">}</span><span class="op" id="5086786">)</span>&nbsp;<span class="builtintype" id="5086788">error</span>&nbsp;<span class="op" id="5086794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5086797">return</span>&nbsp;<span class="ident" id="5086804">server</span><span class="op" id="5086810">.</span><span class="ident" id="5086811">register</span><span class="op" id="5086819">(</span><span class="ident" id="5086820">rcvr</span><span class="op" id="5086824">,</span>&nbsp;<span class="string" id="5086826">&#34;&#34;</span><span class="op" id="5086828">,</span>&nbsp;<span class="builtintype" id="5086830">false</span><span class="op" id="5086835">)</span><br>
<span class="lineno"></span><span class="op" id="5086837">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5086840">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5086913">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5086957">func</span>&nbsp;<span class="op" id="5086962">(</span><span class="ident" id="5086963">server</span>&nbsp;<span class="op" id="5086970">*</span><span class="ident" id="5086971">Server</span><span class="op" id="5086977">)</span>&nbsp;<span class="ident" id="5086979">RegisterName</span><span class="op" id="5086991">(</span><span class="ident" id="5086992">name</span>&nbsp;<span class="builtintype" id="5086997">string</span><span class="op" id="5087003">,</span>&nbsp;<span class="ident" id="5087005">rcvr</span>&nbsp;<span class="keyword" id="5087010">interface</span><span class="op" id="5087019">{</span><span class="op" id="5087020">}</span><span class="op" id="5087021">)</span>&nbsp;<span class="builtintype" id="5087023">error</span>&nbsp;<span class="op" id="5087029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087032">return</span>&nbsp;<span class="ident" id="5087039">server</span><span class="op" id="5087045">.</span><span class="ident" id="5087046">register</span><span class="op" id="5087054">(</span><span class="ident" id="5087055">rcvr</span><span class="op" id="5087059">,</span>&nbsp;<span class="ident" id="5087061">name</span><span class="op" id="5087065">,</span>&nbsp;<span class="builtintype" id="5087067">true</span><span class="op" id="5087071">)</span><br>
<span class="lineno">235</span><span class="op" id="5087073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5087076">func</span>&nbsp;<span class="op" id="5087081">(</span><span class="ident" id="5087082">server</span>&nbsp;<span class="op" id="5087089">*</span><span class="ident" id="5087090">Server</span><span class="op" id="5087096">)</span>&nbsp;<span class="ident" id="5087098">register</span><span class="op" id="5087106">(</span><span class="ident" id="5087107">rcvr</span>&nbsp;<span class="keyword" id="5087112">interface</span><span class="op" id="5087121">{</span><span class="op" id="5087122">}</span><span class="op" id="5087123">,</span>&nbsp;<span class="ident" id="5087125">name</span>&nbsp;<span class="builtintype" id="5087130">string</span><span class="op" id="5087136">,</span>&nbsp;<span class="ident" id="5087138">useName</span>&nbsp;<span class="builtintype" id="5087146">bool</span><span class="op" id="5087150">)</span>&nbsp;<span class="builtintype" id="5087152">error</span>&nbsp;<span class="op" id="5087158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087161">server</span><span class="op" id="5087167">.</span><span class="ident" id="5087168">mu</span><span class="op" id="5087170">.</span><span class="ident" id="5087171">Lock</span><span class="op" id="5087175">(</span><span class="op" id="5087176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087179">defer</span>&nbsp;<span class="ident" id="5087185">server</span><span class="op" id="5087191">.</span><span class="ident" id="5087192">mu</span><span class="op" id="5087194">.</span><span class="ident" id="5087195">Unlock</span><span class="op" id="5087201">(</span><span class="op" id="5087202">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087205">if</span>&nbsp;<span class="ident" id="5087208">server</span><span class="op" id="5087214">.</span><span class="ident" id="5087215">serviceMap</span>&nbsp;<span class="op" id="5087226">==</span>&nbsp;<span class="ident" id="5087229">nil</span>&nbsp;<span class="op" id="5087233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087237">server</span><span class="op" id="5087243">.</span><span class="ident" id="5087244">serviceMap</span>&nbsp;<span class="op" id="5087255">=</span>&nbsp;<span class="builtinfunc" id="5087257">make</span><span class="op" id="5087261">(</span><span class="keyword" id="5087262">map</span><span class="op" id="5087265">[</span><span class="builtintype" id="5087266">string</span><span class="op" id="5087272">]</span><span class="op" id="5087273">*</span><span class="ident" id="5087274">service</span><span class="op" id="5087281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5087284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087287">s</span>&nbsp;<span class="op" id="5087289">:=</span>&nbsp;<span class="builtinfunc" id="5087292">new</span><span class="op" id="5087295">(</span><span class="ident" id="5087296">service</span><span class="op" id="5087303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087306">s</span><span class="op" id="5087307">.</span><span class="ident" id="5087308">typ</span>&nbsp;<span class="op" id="5087312">=</span>&nbsp;<span class="ident" id="5087314">reflect</span><span class="op" id="5087321">.</span><span class="ident" id="5087322">TypeOf</span><span class="op" id="5087328">(</span><span class="ident" id="5087329">rcvr</span><span class="op" id="5087333">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087336">s</span><span class="op" id="5087337">.</span><span class="ident" id="5087338">rcvr</span>&nbsp;<span class="op" id="5087343">=</span>&nbsp;<span class="ident" id="5087345">reflect</span><span class="op" id="5087352">.</span><span class="ident" id="5087353">ValueOf</span><span class="op" id="5087360">(</span><span class="ident" id="5087361">rcvr</span><span class="op" id="5087365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087368">sname</span>&nbsp;<span class="op" id="5087374">:=</span>&nbsp;<span class="ident" id="5087377">reflect</span><span class="op" id="5087384">.</span><span class="ident" id="5087385">Indirect</span><span class="op" id="5087393">(</span><span class="ident" id="5087394">s</span><span class="op" id="5087395">.</span><span class="ident" id="5087396">rcvr</span><span class="op" id="5087400">)</span><span class="op" id="5087401">.</span><span class="ident" id="5087402">Type</span><span class="op" id="5087406">(</span><span class="op" id="5087407">)</span><span class="op" id="5087408">.</span><span class="ident" id="5087409">Name</span><span class="op" id="5087413">(</span><span class="op" id="5087414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087417">if</span>&nbsp;<span class="ident" id="5087420">useName</span>&nbsp;<span class="op" id="5087428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087432">sname</span>&nbsp;<span class="op" id="5087438">=</span>&nbsp;<span class="ident" id="5087440">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5087446">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087449">if</span>&nbsp;<span class="ident" id="5087452">sname</span>&nbsp;<span class="op" id="5087458">==</span>&nbsp;<span class="string" id="5087461">&#34;&#34;</span>&nbsp;<span class="op" id="5087464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087468">s</span>&nbsp;<span class="op" id="5087470">:=</span>&nbsp;<span class="string" id="5087473">&#34;rpc.Register:&nbsp;no&nbsp;service&nbsp;name&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5087515">+</span>&nbsp;<span class="ident" id="5087517">s</span><span class="op" id="5087518">.</span><span class="ident" id="5087519">typ</span><span class="op" id="5087522">.</span><span class="ident" id="5087523">String</span><span class="op" id="5087529">(</span><span class="op" id="5087530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087534">log</span><span class="op" id="5087537">.</span><span class="ident" id="5087538">Print</span><span class="op" id="5087543">(</span><span class="ident" id="5087544">s</span><span class="op" id="5087545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087549">return</span>&nbsp;<span class="ident" id="5087556">errors</span><span class="op" id="5087562">.</span><span class="ident" id="5087563">New</span><span class="op" id="5087566">(</span><span class="ident" id="5087567">s</span><span class="op" id="5087568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5087571">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087574">if</span>&nbsp;<span class="op" id="5087577">!</span><span class="ident" id="5087578">isExported</span><span class="op" id="5087588">(</span><span class="ident" id="5087589">sname</span><span class="op" id="5087594">)</span>&nbsp;<span class="op" id="5087596">&amp;&amp;</span>&nbsp;<span class="op" id="5087599">!</span><span class="ident" id="5087600">useName</span>&nbsp;<span class="op" id="5087608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087612">s</span>&nbsp;<span class="op" id="5087614">:=</span>&nbsp;<span class="string" id="5087617">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5087639">+</span>&nbsp;<span class="ident" id="5087641">sname</span>&nbsp;<span class="op" id="5087647">+</span>&nbsp;<span class="string" id="5087649">&#34;&nbsp;is&nbsp;not&nbsp;exported&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087670">log</span><span class="op" id="5087673">.</span><span class="ident" id="5087674">Print</span><span class="op" id="5087679">(</span><span class="ident" id="5087680">s</span><span class="op" id="5087681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087685">return</span>&nbsp;<span class="ident" id="5087692">errors</span><span class="op" id="5087698">.</span><span class="ident" id="5087699">New</span><span class="op" id="5087702">(</span><span class="ident" id="5087703">s</span><span class="op" id="5087704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5087707">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087710">if</span>&nbsp;<span class="ident" id="5087713">_</span><span class="op" id="5087714">,</span>&nbsp;<span class="ident" id="5087716">present</span>&nbsp;<span class="op" id="5087724">:=</span>&nbsp;<span class="ident" id="5087727">server</span><span class="op" id="5087733">.</span><span class="ident" id="5087734">serviceMap</span><span class="op" id="5087744">[</span><span class="ident" id="5087745">sname</span><span class="op" id="5087750">]</span><span class="op" id="5087751">;</span>&nbsp;<span class="ident" id="5087753">present</span>&nbsp;<span class="op" id="5087761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087765">return</span>&nbsp;<span class="ident" id="5087772">errors</span><span class="op" id="5087778">.</span><span class="ident" id="5087779">New</span><span class="op" id="5087782">(</span><span class="string" id="5087783">&#34;rpc:&nbsp;service&nbsp;already&nbsp;defined:&nbsp;&#34;</span>&nbsp;<span class="op" id="5087816">+</span>&nbsp;<span class="ident" id="5087818">sname</span><span class="op" id="5087823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5087826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087829">s</span><span class="op" id="5087830">.</span><span class="ident" id="5087831">name</span>&nbsp;<span class="op" id="5087836">=</span>&nbsp;<span class="ident" id="5087838">sname</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5087846">//&nbsp;Install&nbsp;the&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087870">s</span><span class="op" id="5087871">.</span><span class="ident" id="5087872">method</span>&nbsp;<span class="op" id="5087879">=</span>&nbsp;<span class="ident" id="5087881">suitableMethods</span><span class="op" id="5087896">(</span><span class="ident" id="5087897">s</span><span class="op" id="5087898">.</span><span class="ident" id="5087899">typ</span><span class="op" id="5087902">,</span>&nbsp;<span class="builtintype" id="5087904">true</span><span class="op" id="5087908">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5087912">if</span>&nbsp;<span class="builtinfunc" id="5087915">len</span><span class="op" id="5087918">(</span><span class="ident" id="5087919">s</span><span class="op" id="5087920">.</span><span class="ident" id="5087921">method</span><span class="op" id="5087927">)</span>&nbsp;<span class="op" id="5087929">==</span>&nbsp;<span class="num" id="5087932">0</span>&nbsp;<span class="op" id="5087934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5087938">str</span>&nbsp;<span class="op" id="5087942">:=</span>&nbsp;<span class="string" id="5087945">&#34;&#34;</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5087951">//&nbsp;To&nbsp;help&nbsp;the&nbsp;user,&nbsp;see&nbsp;if&nbsp;a&nbsp;pointer&nbsp;receiver&nbsp;would&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088012">method</span>&nbsp;<span class="op" id="5088019">:=</span>&nbsp;<span class="ident" id="5088022">suitableMethods</span><span class="op" id="5088037">(</span><span class="ident" id="5088038">reflect</span><span class="op" id="5088045">.</span><span class="ident" id="5088046">PtrTo</span><span class="op" id="5088051">(</span><span class="ident" id="5088052">s</span><span class="op" id="5088053">.</span><span class="ident" id="5088054">typ</span><span class="op" id="5088057">)</span><span class="op" id="5088058">,</span>&nbsp;<span class="builtintype" id="5088060">false</span><span class="op" id="5088065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088069">if</span>&nbsp;<span class="builtinfunc" id="5088072">len</span><span class="op" id="5088075">(</span><span class="ident" id="5088076">method</span><span class="op" id="5088082">)</span>&nbsp;<span class="op" id="5088084">!=</span>&nbsp;<span class="num" id="5088087">0</span>&nbsp;<span class="op" id="5088089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088094">str</span>&nbsp;<span class="op" id="5088098">=</span>&nbsp;<span class="string" id="5088100">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5088122">+</span>&nbsp;<span class="ident" id="5088124">sname</span>&nbsp;<span class="op" id="5088130">+</span>&nbsp;<span class="string" id="5088132">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&nbsp;(hint:&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;value&nbsp;of&nbsp;that&nbsp;type)&#34;</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5088223">}</span>&nbsp;<span class="keyword" id="5088225">else</span>&nbsp;<span class="op" id="5088230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088235">str</span>&nbsp;<span class="op" id="5088239">=</span>&nbsp;<span class="string" id="5088241">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5088263">+</span>&nbsp;<span class="ident" id="5088265">sname</span>&nbsp;<span class="op" id="5088271">+</span>&nbsp;<span class="string" id="5088273">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5088319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088323">log</span><span class="op" id="5088326">.</span><span class="ident" id="5088327">Print</span><span class="op" id="5088332">(</span><span class="ident" id="5088333">str</span><span class="op" id="5088336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088340">return</span>&nbsp;<span class="ident" id="5088347">errors</span><span class="op" id="5088353">.</span><span class="ident" id="5088354">New</span><span class="op" id="5088357">(</span><span class="ident" id="5088358">str</span><span class="op" id="5088361">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5088364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088367">server</span><span class="op" id="5088373">.</span><span class="ident" id="5088374">serviceMap</span><span class="op" id="5088384">[</span><span class="ident" id="5088385">s</span><span class="op" id="5088386">.</span><span class="ident" id="5088387">name</span><span class="op" id="5088391">]</span>&nbsp;<span class="op" id="5088393">=</span>&nbsp;<span class="ident" id="5088395">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088398">return</span>&nbsp;<span class="ident" id="5088405">nil</span><br>
<span class="lineno"></span><span class="op" id="5088409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="5088412">//&nbsp;suitableMethods&nbsp;returns&nbsp;suitable&nbsp;Rpc&nbsp;methods&nbsp;of&nbsp;typ,&nbsp;it&nbsp;will&nbsp;report</span><br>
<span class="lineno"></span><span class="comment" id="5088483">//&nbsp;error&nbsp;using&nbsp;log&nbsp;if&nbsp;reportErr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="5088524">func</span>&nbsp;<span class="ident" id="5088529">suitableMethods</span><span class="op" id="5088544">(</span><span class="ident" id="5088545">typ</span>&nbsp;<span class="ident" id="5088549">reflect</span><span class="op" id="5088556">.</span><span class="ident" id="5088557">Type</span><span class="op" id="5088561">,</span>&nbsp;<span class="ident" id="5088563">reportErr</span>&nbsp;<span class="builtintype" id="5088573">bool</span><span class="op" id="5088577">)</span>&nbsp;<span class="keyword" id="5088579">map</span><span class="op" id="5088582">[</span><span class="builtintype" id="5088583">string</span><span class="op" id="5088589">]</span><span class="op" id="5088590">*</span><span class="ident" id="5088591">methodType</span>&nbsp;<span class="op" id="5088602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088605">methods</span>&nbsp;<span class="op" id="5088613">:=</span>&nbsp;<span class="builtinfunc" id="5088616">make</span><span class="op" id="5088620">(</span><span class="keyword" id="5088621">map</span><span class="op" id="5088624">[</span><span class="builtintype" id="5088625">string</span><span class="op" id="5088631">]</span><span class="op" id="5088632">*</span><span class="ident" id="5088633">methodType</span><span class="op" id="5088643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088646">for</span>&nbsp;<span class="ident" id="5088650">m</span>&nbsp;<span class="op" id="5088652">:=</span>&nbsp;<span class="num" id="5088655">0</span><span class="op" id="5088656">;</span>&nbsp;<span class="ident" id="5088658">m</span>&nbsp;<span class="op" id="5088660">&lt;</span>&nbsp;<span class="ident" id="5088662">typ</span><span class="op" id="5088665">.</span><span class="ident" id="5088666">NumMethod</span><span class="op" id="5088675">(</span><span class="op" id="5088676">)</span><span class="op" id="5088677">;</span>&nbsp;<span class="ident" id="5088679">m</span><span class="op" id="5088680">++</span>&nbsp;<span class="op" id="5088683">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088687">method</span>&nbsp;<span class="op" id="5088694">:=</span>&nbsp;<span class="ident" id="5088697">typ</span><span class="op" id="5088700">.</span><span class="ident" id="5088701">Method</span><span class="op" id="5088707">(</span><span class="ident" id="5088708">m</span><span class="op" id="5088709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088713">mtype</span>&nbsp;<span class="op" id="5088719">:=</span>&nbsp;<span class="ident" id="5088722">method</span><span class="op" id="5088728">.</span><span class="ident" id="5088729">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088736">mname</span>&nbsp;<span class="op" id="5088742">:=</span>&nbsp;<span class="ident" id="5088745">method</span><span class="op" id="5088751">.</span><span class="ident" id="5088752">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5088759">//&nbsp;Method&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088789">if</span>&nbsp;<span class="ident" id="5088792">method</span><span class="op" id="5088798">.</span><span class="ident" id="5088799">PkgPath</span>&nbsp;<span class="op" id="5088807">!=</span>&nbsp;<span class="string" id="5088810">&#34;&#34;</span>&nbsp;<span class="op" id="5088813">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088818">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5088829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5088833">//&nbsp;Method&nbsp;needs&nbsp;three&nbsp;ins:&nbsp;receiver,&nbsp;*args,&nbsp;*reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088887">if</span>&nbsp;<span class="ident" id="5088890">mtype</span><span class="op" id="5088895">.</span><span class="ident" id="5088896">NumIn</span><span class="op" id="5088901">(</span><span class="op" id="5088902">)</span>&nbsp;<span class="op" id="5088904">!=</span>&nbsp;<span class="num" id="5088907">3</span>&nbsp;<span class="op" id="5088909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5088914">if</span>&nbsp;<span class="ident" id="5088917">reportErr</span>&nbsp;<span class="op" id="5088927">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5088933">log</span><span class="op" id="5088936">.</span><span class="ident" id="5088937">Println</span><span class="op" id="5088944">(</span><span class="string" id="5088945">&#34;method&#34;</span><span class="op" id="5088953">,</span>&nbsp;<span class="ident" id="5088955">mname</span><span class="op" id="5088960">,</span>&nbsp;<span class="string" id="5088962">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;ins:&#34;</span><span class="op" id="5088988">,</span>&nbsp;<span class="ident" id="5088990">mtype</span><span class="op" id="5088995">.</span><span class="ident" id="5088996">NumIn</span><span class="op" id="5089001">(</span><span class="op" id="5089002">)</span><span class="op" id="5089003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5089008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089013">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5089024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5089028">//&nbsp;First&nbsp;arg&nbsp;need&nbsp;not&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089066">argType</span>&nbsp;<span class="op" id="5089074">:=</span>&nbsp;<span class="ident" id="5089077">mtype</span><span class="op" id="5089082">.</span><span class="ident" id="5089083">In</span><span class="op" id="5089085">(</span><span class="num" id="5089086">1</span><span class="op" id="5089087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089091">if</span>&nbsp;<span class="op" id="5089094">!</span><span class="ident" id="5089095">isExportedOrBuiltinType</span><span class="op" id="5089118">(</span><span class="ident" id="5089119">argType</span><span class="op" id="5089126">)</span>&nbsp;<span class="op" id="5089128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089133">if</span>&nbsp;<span class="ident" id="5089136">reportErr</span>&nbsp;<span class="op" id="5089146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089152">log</span><span class="op" id="5089155">.</span><span class="ident" id="5089156">Println</span><span class="op" id="5089163">(</span><span class="ident" id="5089164">mname</span><span class="op" id="5089169">,</span>&nbsp;<span class="string" id="5089171">&#34;argument&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5089200">,</span>&nbsp;<span class="ident" id="5089202">argType</span><span class="op" id="5089209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5089214">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089219">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5089230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5089234">//&nbsp;Second&nbsp;arg&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089269">replyType</span>&nbsp;<span class="op" id="5089279">:=</span>&nbsp;<span class="ident" id="5089282">mtype</span><span class="op" id="5089287">.</span><span class="ident" id="5089288">In</span><span class="op" id="5089290">(</span><span class="num" id="5089291">2</span><span class="op" id="5089292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089296">if</span>&nbsp;<span class="ident" id="5089299">replyType</span><span class="op" id="5089308">.</span><span class="ident" id="5089309">Kind</span><span class="op" id="5089313">(</span><span class="op" id="5089314">)</span>&nbsp;<span class="op" id="5089316">!=</span>&nbsp;<span class="ident" id="5089319">reflect</span><span class="op" id="5089326">.</span><span class="ident" id="5089327">Ptr</span>&nbsp;<span class="op" id="5089331">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089336">if</span>&nbsp;<span class="ident" id="5089339">reportErr</span>&nbsp;<span class="op" id="5089349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089355">log</span><span class="op" id="5089358">.</span><span class="ident" id="5089359">Println</span><span class="op" id="5089366">(</span><span class="string" id="5089367">&#34;method&#34;</span><span class="op" id="5089375">,</span>&nbsp;<span class="ident" id="5089377">mname</span><span class="op" id="5089382">,</span>&nbsp;<span class="string" id="5089384">&#34;reply&nbsp;type&nbsp;not&nbsp;a&nbsp;pointer:&#34;</span><span class="op" id="5089411">,</span>&nbsp;<span class="ident" id="5089413">replyType</span><span class="op" id="5089422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5089427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089432">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5089443">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5089447">//&nbsp;Reply&nbsp;type&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089481">if</span>&nbsp;<span class="op" id="5089484">!</span><span class="ident" id="5089485">isExportedOrBuiltinType</span><span class="op" id="5089508">(</span><span class="ident" id="5089509">replyType</span><span class="op" id="5089518">)</span>&nbsp;<span class="op" id="5089520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089525">if</span>&nbsp;<span class="ident" id="5089528">reportErr</span>&nbsp;<span class="op" id="5089538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089544">log</span><span class="op" id="5089547">.</span><span class="ident" id="5089548">Println</span><span class="op" id="5089555">(</span><span class="string" id="5089556">&#34;method&#34;</span><span class="op" id="5089564">,</span>&nbsp;<span class="ident" id="5089566">mname</span><span class="op" id="5089571">,</span>&nbsp;<span class="string" id="5089573">&#34;reply&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5089599">,</span>&nbsp;<span class="ident" id="5089601">replyType</span><span class="op" id="5089610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5089615">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089620">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5089631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5089635">//&nbsp;Method&nbsp;needs&nbsp;one&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089662">if</span>&nbsp;<span class="ident" id="5089665">mtype</span><span class="op" id="5089670">.</span><span class="ident" id="5089671">NumOut</span><span class="op" id="5089677">(</span><span class="op" id="5089678">)</span>&nbsp;<span class="op" id="5089680">!=</span>&nbsp;<span class="num" id="5089683">1</span>&nbsp;<span class="op" id="5089685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089690">if</span>&nbsp;<span class="ident" id="5089693">reportErr</span>&nbsp;<span class="op" id="5089703">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089709">log</span><span class="op" id="5089712">.</span><span class="ident" id="5089713">Println</span><span class="op" id="5089720">(</span><span class="string" id="5089721">&#34;method&#34;</span><span class="op" id="5089729">,</span>&nbsp;<span class="ident" id="5089731">mname</span><span class="op" id="5089736">,</span>&nbsp;<span class="string" id="5089738">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;outs:&#34;</span><span class="op" id="5089765">,</span>&nbsp;<span class="ident" id="5089767">mtype</span><span class="op" id="5089772">.</span><span class="ident" id="5089773">NumOut</span><span class="op" id="5089779">(</span><span class="op" id="5089780">)</span><span class="op" id="5089781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5089786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089791">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5089802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5089806">//&nbsp;The&nbsp;return&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;must&nbsp;be&nbsp;error.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089856">if</span>&nbsp;<span class="ident" id="5089859">returnType</span>&nbsp;<span class="op" id="5089870">:=</span>&nbsp;<span class="ident" id="5089873">mtype</span><span class="op" id="5089878">.</span><span class="ident" id="5089879">Out</span><span class="op" id="5089882">(</span><span class="num" id="5089883">0</span><span class="op" id="5089884">)</span><span class="op" id="5089885">;</span>&nbsp;<span class="ident" id="5089887">returnType</span>&nbsp;<span class="op" id="5089898">!=</span>&nbsp;<span class="ident" id="5089901">typeOfError</span>&nbsp;<span class="op" id="5089913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5089918">if</span>&nbsp;<span class="ident" id="5089921">reportErr</span>&nbsp;<span class="op" id="5089931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5089937">log</span><span class="op" id="5089940">.</span><span class="ident" id="5089941">Println</span><span class="op" id="5089948">(</span><span class="string" id="5089949">&#34;method&#34;</span><span class="op" id="5089957">,</span>&nbsp;<span class="ident" id="5089959">mname</span><span class="op" id="5089964">,</span>&nbsp;<span class="string" id="5089966">&#34;returns&#34;</span><span class="op" id="5089975">,</span>&nbsp;<span class="ident" id="5089977">returnType</span><span class="op" id="5089987">.</span><span class="ident" id="5089988">String</span><span class="op" id="5089994">(</span><span class="op" id="5089995">)</span><span class="op" id="5089996">,</span>&nbsp;<span class="string" id="5089998">&#34;not&nbsp;error&#34;</span><span class="op" id="5090009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5090014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5090019">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5090030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090034">methods</span><span class="op" id="5090041">[</span><span class="ident" id="5090042">mname</span><span class="op" id="5090047">]</span>&nbsp;<span class="op" id="5090049">=</span>&nbsp;<span class="op" id="5090051">&amp;</span><span class="ident" id="5090052">methodType</span><span class="op" id="5090062">{</span><span class="ident" id="5090063">method</span><span class="op" id="5090069">:</span>&nbsp;<span class="ident" id="5090071">method</span><span class="op" id="5090077">,</span>&nbsp;<span class="ident" id="5090079">ArgType</span><span class="op" id="5090086">:</span>&nbsp;<span class="ident" id="5090088">argType</span><span class="op" id="5090095">,</span>&nbsp;<span class="ident" id="5090097">ReplyType</span><span class="op" id="5090106">:</span>&nbsp;<span class="ident" id="5090108">replyType</span><span class="op" id="5090117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5090120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5090123">return</span>&nbsp;<span class="ident" id="5090130">methods</span><br>
<span class="lineno"></span><span class="op" id="5090138">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span><span class="comment" id="5090141">//&nbsp;A&nbsp;value&nbsp;sent&nbsp;as&nbsp;a&nbsp;placeholder&nbsp;for&nbsp;the&nbsp;server&#39;s&nbsp;response&nbsp;value&nbsp;when&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="5090222">//&nbsp;receives&nbsp;an&nbsp;invalid&nbsp;request.&nbsp;It&nbsp;is&nbsp;never&nbsp;decoded&nbsp;by&nbsp;the&nbsp;client&nbsp;since&nbsp;the&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="5090307">//&nbsp;contains&nbsp;an&nbsp;error&nbsp;when&nbsp;it&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5090345">var</span>&nbsp;<span class="ident" id="5090349">invalidRequest</span>&nbsp;<span class="op" id="5090364">=</span>&nbsp;<span class="keyword" id="5090366">struct</span><span class="op" id="5090372">{</span><span class="op" id="5090373">}</span><span class="op" id="5090374">{</span><span class="op" id="5090375">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="5090378">func</span>&nbsp;<span class="op" id="5090383">(</span><span class="ident" id="5090384">server</span>&nbsp;<span class="op" id="5090391">*</span><span class="ident" id="5090392">Server</span><span class="op" id="5090398">)</span>&nbsp;<span class="ident" id="5090400">sendResponse</span><span class="op" id="5090412">(</span><span class="ident" id="5090413">sending</span>&nbsp;<span class="op" id="5090421">*</span><span class="ident" id="5090422">sync</span><span class="op" id="5090426">.</span><span class="ident" id="5090427">Mutex</span><span class="op" id="5090432">,</span>&nbsp;<span class="ident" id="5090434">req</span>&nbsp;<span class="op" id="5090438">*</span><span class="ident" id="5090439">Request</span><span class="op" id="5090446">,</span>&nbsp;<span class="ident" id="5090448">reply</span>&nbsp;<span class="keyword" id="5090454">interface</span><span class="op" id="5090463">{</span><span class="op" id="5090464">}</span><span class="op" id="5090465">,</span>&nbsp;<span class="ident" id="5090467">codec</span>&nbsp;<span class="ident" id="5090473">ServerCodec</span><span class="op" id="5090484">,</span>&nbsp;<span class="ident" id="5090486">errmsg</span>&nbsp;<span class="builtintype" id="5090493">string</span><span class="op" id="5090499">)</span>&nbsp;<span class="op" id="5090501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090504">resp</span>&nbsp;<span class="op" id="5090509">:=</span>&nbsp;<span class="ident" id="5090512">server</span><span class="op" id="5090518">.</span><span class="ident" id="5090519">getResponse</span><span class="op" id="5090530">(</span><span class="op" id="5090531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5090534">//&nbsp;Encode&nbsp;the&nbsp;response&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090565">resp</span><span class="op" id="5090569">.</span><span class="ident" id="5090570">ServiceMethod</span>&nbsp;<span class="op" id="5090584">=</span>&nbsp;<span class="ident" id="5090586">req</span><span class="op" id="5090589">.</span><span class="ident" id="5090590">ServiceMethod</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5090605">if</span>&nbsp;<span class="ident" id="5090608">errmsg</span>&nbsp;<span class="op" id="5090615">!=</span>&nbsp;<span class="string" id="5090618">&#34;&#34;</span>&nbsp;<span class="op" id="5090621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090625">resp</span><span class="op" id="5090629">.</span><span class="ident" id="5090630">Error</span>&nbsp;<span class="op" id="5090636">=</span>&nbsp;<span class="ident" id="5090638">errmsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090647">reply</span>&nbsp;<span class="op" id="5090653">=</span>&nbsp;<span class="ident" id="5090655">invalidRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5090671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090674">resp</span><span class="op" id="5090678">.</span><span class="ident" id="5090679">Seq</span>&nbsp;<span class="op" id="5090683">=</span>&nbsp;<span class="ident" id="5090685">req</span><span class="op" id="5090688">.</span><span class="ident" id="5090689">Seq</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090694">sending</span><span class="op" id="5090701">.</span><span class="ident" id="5090702">Lock</span><span class="op" id="5090706">(</span><span class="op" id="5090707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090710">err</span>&nbsp;<span class="op" id="5090714">:=</span>&nbsp;<span class="ident" id="5090717">codec</span><span class="op" id="5090722">.</span><span class="ident" id="5090723">WriteResponse</span><span class="op" id="5090736">(</span><span class="ident" id="5090737">resp</span><span class="op" id="5090741">,</span>&nbsp;<span class="ident" id="5090743">reply</span><span class="op" id="5090748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5090751">if</span>&nbsp;<span class="ident" id="5090754">debugLog</span>&nbsp;<span class="op" id="5090763">&amp;&amp;</span>&nbsp;<span class="ident" id="5090766">err</span>&nbsp;<span class="op" id="5090770">!=</span>&nbsp;<span class="ident" id="5090773">nil</span>&nbsp;<span class="op" id="5090777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090781">log</span><span class="op" id="5090784">.</span><span class="ident" id="5090785">Println</span><span class="op" id="5090792">(</span><span class="string" id="5090793">&#34;rpc:&nbsp;writing&nbsp;response:&#34;</span><span class="op" id="5090817">,</span>&nbsp;<span class="ident" id="5090819">err</span><span class="op" id="5090822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5090825">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090828">sending</span><span class="op" id="5090835">.</span><span class="ident" id="5090836">Unlock</span><span class="op" id="5090842">(</span><span class="op" id="5090843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090846">server</span><span class="op" id="5090852">.</span><span class="ident" id="5090853">freeResponse</span><span class="op" id="5090865">(</span><span class="ident" id="5090866">resp</span><span class="op" id="5090870">)</span><br>
<span class="lineno"></span><span class="op" id="5090872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5090875">func</span>&nbsp;<span class="op" id="5090880">(</span><span class="ident" id="5090881">m</span>&nbsp;<span class="op" id="5090883">*</span><span class="ident" id="5090884">methodType</span><span class="op" id="5090894">)</span>&nbsp;<span class="ident" id="5090896">NumCalls</span><span class="op" id="5090904">(</span><span class="op" id="5090905">)</span>&nbsp;<span class="op" id="5090907">(</span><span class="ident" id="5090908">n</span>&nbsp;<span class="builtintype" id="5090910">uint</span><span class="op" id="5090914">)</span>&nbsp;<span class="op" id="5090916">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090919">m</span><span class="op" id="5090920">.</span><span class="ident" id="5090921">Lock</span><span class="op" id="5090925">(</span><span class="op" id="5090926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090929">n</span>&nbsp;<span class="op" id="5090931">=</span>&nbsp;<span class="ident" id="5090933">m</span><span class="op" id="5090934">.</span><span class="ident" id="5090935">numCalls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5090945">m</span><span class="op" id="5090946">.</span><span class="ident" id="5090947">Unlock</span><span class="op" id="5090953">(</span><span class="op" id="5090954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5090957">return</span>&nbsp;<span class="ident" id="5090964">n</span><br>
<span class="lineno"></span><span class="op" id="5090966">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="5090969">func</span>&nbsp;<span class="op" id="5090974">(</span><span class="ident" id="5090975">s</span>&nbsp;<span class="op" id="5090977">*</span><span class="ident" id="5090978">service</span><span class="op" id="5090985">)</span>&nbsp;<span class="ident" id="5090987">call</span><span class="op" id="5090991">(</span><span class="ident" id="5090992">server</span>&nbsp;<span class="op" id="5090999">*</span><span class="ident" id="5091000">Server</span><span class="op" id="5091006">,</span>&nbsp;<span class="ident" id="5091008">sending</span>&nbsp;<span class="op" id="5091016">*</span><span class="ident" id="5091017">sync</span><span class="op" id="5091021">.</span><span class="ident" id="5091022">Mutex</span><span class="op" id="5091027">,</span>&nbsp;<span class="ident" id="5091029">mtype</span>&nbsp;<span class="op" id="5091035">*</span><span class="ident" id="5091036">methodType</span><span class="op" id="5091046">,</span>&nbsp;<span class="ident" id="5091048">req</span>&nbsp;<span class="op" id="5091052">*</span><span class="ident" id="5091053">Request</span><span class="op" id="5091060">,</span>&nbsp;<span class="ident" id="5091062">argv</span><span class="op" id="5091066">,</span>&nbsp;<span class="ident" id="5091068">replyv</span>&nbsp;<span class="ident" id="5091075">reflect</span><span class="op" id="5091082">.</span><span class="ident" id="5091083">Value</span><span class="op" id="5091088">,</span>&nbsp;<span class="ident" id="5091090">codec</span>&nbsp;<span class="ident" id="5091096">ServerCodec</span><span class="op" id="5091107">)</span>&nbsp;<span class="op" id="5091109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091112">mtype</span><span class="op" id="5091117">.</span><span class="ident" id="5091118">Lock</span><span class="op" id="5091122">(</span><span class="op" id="5091123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091126">mtype</span><span class="op" id="5091131">.</span><span class="ident" id="5091132">numCalls</span><span class="op" id="5091140">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091144">mtype</span><span class="op" id="5091149">.</span><span class="ident" id="5091150">Unlock</span><span class="op" id="5091156">(</span><span class="op" id="5091157">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091160">function</span>&nbsp;<span class="op" id="5091169">:=</span>&nbsp;<span class="ident" id="5091172">mtype</span><span class="op" id="5091177">.</span><span class="ident" id="5091178">method</span><span class="op" id="5091184">.</span><span class="ident" id="5091185">Func</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5091191">//&nbsp;Invoke&nbsp;the&nbsp;method,&nbsp;providing&nbsp;a&nbsp;new&nbsp;value&nbsp;for&nbsp;the&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091251">returnValues</span>&nbsp;<span class="op" id="5091264">:=</span>&nbsp;<span class="ident" id="5091267">function</span><span class="op" id="5091275">.</span><span class="ident" id="5091276">Call</span><span class="op" id="5091280">(</span><span class="op" id="5091281">[</span><span class="op" id="5091282">]</span><span class="ident" id="5091283">reflect</span><span class="op" id="5091290">.</span><span class="ident" id="5091291">Value</span><span class="op" id="5091296">{</span><span class="ident" id="5091297">s</span><span class="op" id="5091298">.</span><span class="ident" id="5091299">rcvr</span><span class="op" id="5091303">,</span>&nbsp;<span class="ident" id="5091305">argv</span><span class="op" id="5091309">,</span>&nbsp;<span class="ident" id="5091311">replyv</span><span class="op" id="5091317">}</span><span class="op" id="5091318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5091321">//&nbsp;The&nbsp;return&nbsp;value&nbsp;for&nbsp;the&nbsp;method&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091370">errInter</span>&nbsp;<span class="op" id="5091379">:=</span>&nbsp;<span class="ident" id="5091382">returnValues</span><span class="op" id="5091394">[</span><span class="num" id="5091395">0</span><span class="op" id="5091396">]</span><span class="op" id="5091397">.</span><span class="ident" id="5091398">Interface</span><span class="op" id="5091407">(</span><span class="op" id="5091408">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091411">errmsg</span>&nbsp;<span class="op" id="5091418">:=</span>&nbsp;<span class="string" id="5091421">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5091425">if</span>&nbsp;<span class="ident" id="5091428">errInter</span>&nbsp;<span class="op" id="5091437">!=</span>&nbsp;<span class="ident" id="5091440">nil</span>&nbsp;<span class="op" id="5091444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091448">errmsg</span>&nbsp;<span class="op" id="5091455">=</span>&nbsp;<span class="ident" id="5091457">errInter</span><span class="op" id="5091465">.</span><span class="op" id="5091466">(</span><span class="builtintype" id="5091467">error</span><span class="op" id="5091472">)</span><span class="op" id="5091473">.</span><span class="ident" id="5091474">Error</span><span class="op" id="5091479">(</span><span class="op" id="5091480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5091483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091486">server</span><span class="op" id="5091492">.</span><span class="ident" id="5091493">sendResponse</span><span class="op" id="5091505">(</span><span class="ident" id="5091506">sending</span><span class="op" id="5091513">,</span>&nbsp;<span class="ident" id="5091515">req</span><span class="op" id="5091518">,</span>&nbsp;<span class="ident" id="5091520">replyv</span><span class="op" id="5091526">.</span><span class="ident" id="5091527">Interface</span><span class="op" id="5091536">(</span><span class="op" id="5091537">)</span><span class="op" id="5091538">,</span>&nbsp;<span class="ident" id="5091540">codec</span><span class="op" id="5091545">,</span>&nbsp;<span class="ident" id="5091547">errmsg</span><span class="op" id="5091553">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091556">server</span><span class="op" id="5091562">.</span><span class="ident" id="5091563">freeRequest</span><span class="op" id="5091574">(</span><span class="ident" id="5091575">req</span><span class="op" id="5091578">)</span><br>
<span class="lineno"></span><span class="op" id="5091580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5091583">type</span>&nbsp;<span class="ident" id="5091588">gobServerCodec</span>&nbsp;<span class="keyword" id="5091603">struct</span>&nbsp;<span class="op" id="5091610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091613">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5091620">io</span><span class="op" id="5091622">.</span><span class="ident" id="5091623">ReadWriteCloser</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091640">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5091647">*</span><span class="ident" id="5091648">gob</span><span class="op" id="5091651">.</span><span class="ident" id="5091652">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091661">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5091668">*</span><span class="ident" id="5091669">gob</span><span class="op" id="5091672">.</span><span class="ident" id="5091673">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091682">encBuf</span>&nbsp;<span class="op" id="5091689">*</span><span class="ident" id="5091690">bufio</span><span class="op" id="5091695">.</span><span class="ident" id="5091696">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5091704">closed</span>&nbsp;<span class="builtintype" id="5091711">bool</span><br>
<span class="lineno"></span><span class="op" id="5091716">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="5091719">func</span>&nbsp;<span class="op" id="5091724">(</span><span class="ident" id="5091725">c</span>&nbsp;<span class="op" id="5091727">*</span><span class="ident" id="5091728">gobServerCodec</span><span class="op" id="5091742">)</span>&nbsp;<span class="ident" id="5091744">ReadRequestHeader</span><span class="op" id="5091761">(</span><span class="ident" id="5091762">r</span>&nbsp;<span class="op" id="5091764">*</span><span class="ident" id="5091765">Request</span><span class="op" id="5091772">)</span>&nbsp;<span class="builtintype" id="5091774">error</span>&nbsp;<span class="op" id="5091780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5091783">return</span>&nbsp;<span class="ident" id="5091790">c</span><span class="op" id="5091791">.</span><span class="ident" id="5091792">dec</span><span class="op" id="5091795">.</span><span class="ident" id="5091796">Decode</span><span class="op" id="5091802">(</span><span class="ident" id="5091803">r</span><span class="op" id="5091804">)</span><br>
<span class="lineno"></span><span class="op" id="5091806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="5091809">func</span>&nbsp;<span class="op" id="5091814">(</span><span class="ident" id="5091815">c</span>&nbsp;<span class="op" id="5091817">*</span><span class="ident" id="5091818">gobServerCodec</span><span class="op" id="5091832">)</span>&nbsp;<span class="ident" id="5091834">ReadRequestBody</span><span class="op" id="5091849">(</span><span class="ident" id="5091850">body</span>&nbsp;<span class="keyword" id="5091855">interface</span><span class="op" id="5091864">{</span><span class="op" id="5091865">}</span><span class="op" id="5091866">)</span>&nbsp;<span class="builtintype" id="5091868">error</span>&nbsp;<span class="op" id="5091874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5091877">return</span>&nbsp;<span class="ident" id="5091884">c</span><span class="op" id="5091885">.</span><span class="ident" id="5091886">dec</span><span class="op" id="5091889">.</span><span class="ident" id="5091890">Decode</span><span class="op" id="5091896">(</span><span class="ident" id="5091897">body</span><span class="op" id="5091901">)</span><br>
<span class="lineno"></span><span class="op" id="5091903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5091906">func</span>&nbsp;<span class="op" id="5091911">(</span><span class="ident" id="5091912">c</span>&nbsp;<span class="op" id="5091914">*</span><span class="ident" id="5091915">gobServerCodec</span><span class="op" id="5091929">)</span>&nbsp;<span class="ident" id="5091931">WriteResponse</span><span class="op" id="5091944">(</span><span class="ident" id="5091945">r</span>&nbsp;<span class="op" id="5091947">*</span><span class="ident" id="5091948">Response</span><span class="op" id="5091956">,</span>&nbsp;<span class="ident" id="5091958">body</span>&nbsp;<span class="keyword" id="5091963">interface</span><span class="op" id="5091972">{</span><span class="op" id="5091973">}</span><span class="op" id="5091974">)</span>&nbsp;<span class="op" id="5091976">(</span><span class="ident" id="5091977">err</span>&nbsp;<span class="builtintype" id="5091981">error</span><span class="op" id="5091986">)</span>&nbsp;<span class="op" id="5091988">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5091991">if</span>&nbsp;<span class="ident" id="5091994">err</span>&nbsp;<span class="op" id="5091998">=</span>&nbsp;<span class="ident" id="5092000">c</span><span class="op" id="5092001">.</span><span class="ident" id="5092002">enc</span><span class="op" id="5092005">.</span><span class="ident" id="5092006">Encode</span><span class="op" id="5092012">(</span><span class="ident" id="5092013">r</span><span class="op" id="5092014">)</span><span class="op" id="5092015">;</span>&nbsp;<span class="ident" id="5092017">err</span>&nbsp;<span class="op" id="5092021">!=</span>&nbsp;<span class="ident" id="5092024">nil</span>&nbsp;<span class="op" id="5092028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092032">if</span>&nbsp;<span class="ident" id="5092035">c</span><span class="op" id="5092036">.</span><span class="ident" id="5092037">encBuf</span><span class="op" id="5092043">.</span><span class="ident" id="5092044">Flush</span><span class="op" id="5092049">(</span><span class="op" id="5092050">)</span>&nbsp;<span class="op" id="5092052">==</span>&nbsp;<span class="ident" id="5092055">nil</span>&nbsp;<span class="op" id="5092059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5092064">//&nbsp;Gob&nbsp;couldn&#39;t&nbsp;encode&nbsp;the&nbsp;header.&nbsp;Should&nbsp;not&nbsp;happen,&nbsp;so&nbsp;if&nbsp;it&nbsp;does,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5092136">//&nbsp;shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092208">log</span><span class="op" id="5092211">.</span><span class="ident" id="5092212">Println</span><span class="op" id="5092219">(</span><span class="string" id="5092220">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;response:&#34;</span><span class="op" id="5092255">,</span>&nbsp;<span class="ident" id="5092257">err</span><span class="op" id="5092260">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092265">c</span><span class="op" id="5092266">.</span><span class="ident" id="5092267">Close</span><span class="op" id="5092272">(</span><span class="op" id="5092273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5092277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092281">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5092289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092292">if</span>&nbsp;<span class="ident" id="5092295">err</span>&nbsp;<span class="op" id="5092299">=</span>&nbsp;<span class="ident" id="5092301">c</span><span class="op" id="5092302">.</span><span class="ident" id="5092303">enc</span><span class="op" id="5092306">.</span><span class="ident" id="5092307">Encode</span><span class="op" id="5092313">(</span><span class="ident" id="5092314">body</span><span class="op" id="5092318">)</span><span class="op" id="5092319">;</span>&nbsp;<span class="ident" id="5092321">err</span>&nbsp;<span class="op" id="5092325">!=</span>&nbsp;<span class="ident" id="5092328">nil</span>&nbsp;<span class="op" id="5092332">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092336">if</span>&nbsp;<span class="ident" id="5092339">c</span><span class="op" id="5092340">.</span><span class="ident" id="5092341">encBuf</span><span class="op" id="5092347">.</span><span class="ident" id="5092348">Flush</span><span class="op" id="5092353">(</span><span class="op" id="5092354">)</span>&nbsp;<span class="op" id="5092356">==</span>&nbsp;<span class="ident" id="5092359">nil</span>&nbsp;<span class="op" id="5092363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5092368">//&nbsp;Was&nbsp;a&nbsp;gob&nbsp;problem&nbsp;encoding&nbsp;the&nbsp;body&nbsp;but&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5092443">//&nbsp;Shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092515">log</span><span class="op" id="5092518">.</span><span class="ident" id="5092519">Println</span><span class="op" id="5092526">(</span><span class="string" id="5092527">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;body:&#34;</span><span class="op" id="5092558">,</span>&nbsp;<span class="ident" id="5092560">err</span><span class="op" id="5092563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092568">c</span><span class="op" id="5092569">.</span><span class="ident" id="5092570">Close</span><span class="op" id="5092575">(</span><span class="op" id="5092576">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5092580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092584">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5092592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092595">return</span>&nbsp;<span class="ident" id="5092602">c</span><span class="op" id="5092603">.</span><span class="ident" id="5092604">encBuf</span><span class="op" id="5092610">.</span><span class="ident" id="5092611">Flush</span><span class="op" id="5092616">(</span><span class="op" id="5092617">)</span><br>
<span class="lineno"></span><span class="op" id="5092619">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5092622">func</span>&nbsp;<span class="op" id="5092627">(</span><span class="ident" id="5092628">c</span>&nbsp;<span class="op" id="5092630">*</span><span class="ident" id="5092631">gobServerCodec</span><span class="op" id="5092645">)</span>&nbsp;<span class="ident" id="5092647">Close</span><span class="op" id="5092652">(</span><span class="op" id="5092653">)</span>&nbsp;<span class="builtintype" id="5092655">error</span>&nbsp;<span class="op" id="5092661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092664">if</span>&nbsp;<span class="ident" id="5092667">c</span><span class="op" id="5092668">.</span><span class="ident" id="5092669">closed</span>&nbsp;<span class="op" id="5092676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5092680">//&nbsp;Only&nbsp;call&nbsp;c.rwc.Close&nbsp;once;&nbsp;otherwise&nbsp;the&nbsp;semantics&nbsp;are&nbsp;undefined.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092752">return</span>&nbsp;<span class="ident" id="5092759">nil</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5092764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5092767">c</span><span class="op" id="5092768">.</span><span class="ident" id="5092769">closed</span>&nbsp;<span class="op" id="5092776">=</span>&nbsp;<span class="builtintype" id="5092778">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5092784">return</span>&nbsp;<span class="ident" id="5092791">c</span><span class="op" id="5092792">.</span><span class="ident" id="5092793">rwc</span><span class="op" id="5092796">.</span><span class="ident" id="5092797">Close</span><span class="op" id="5092802">(</span><span class="op" id="5092803">)</span><br>
<span class="lineno"></span><span class="op" id="5092805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span><span class="comment" id="5092808">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5092861">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5092932">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5092993">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5093056">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">445</span><span class="keyword" id="5093115">func</span>&nbsp;<span class="op" id="5093120">(</span><span class="ident" id="5093121">server</span>&nbsp;<span class="op" id="5093128">*</span><span class="ident" id="5093129">Server</span><span class="op" id="5093135">)</span>&nbsp;<span class="ident" id="5093137">ServeConn</span><span class="op" id="5093146">(</span><span class="ident" id="5093147">conn</span>&nbsp;<span class="ident" id="5093152">io</span><span class="op" id="5093154">.</span><span class="ident" id="5093155">ReadWriteCloser</span><span class="op" id="5093170">)</span>&nbsp;<span class="op" id="5093172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5093175">buf</span>&nbsp;<span class="op" id="5093179">:=</span>&nbsp;<span class="ident" id="5093182">bufio</span><span class="op" id="5093187">.</span><span class="ident" id="5093188">NewWriter</span><span class="op" id="5093197">(</span><span class="ident" id="5093198">conn</span><span class="op" id="5093202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5093205">srv</span>&nbsp;<span class="op" id="5093209">:=</span>&nbsp;<span class="op" id="5093212">&amp;</span><span class="ident" id="5093213">gobServerCodec</span><span class="op" id="5093227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5093231">rwc</span><span class="op" id="5093234">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5093239">conn</span><span class="op" id="5093243">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5093247">dec</span><span class="op" id="5093250">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5093255">gob</span><span class="op" id="5093258">.</span><span class="ident" id="5093259">NewDecoder</span><span class="op" id="5093269">(</span><span class="ident" id="5093270">conn</span><span class="op" id="5093274">)</span><span class="op" id="5093275">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5093279">enc</span><span class="op" id="5093282">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5093287">gob</span><span class="op" id="5093290">.</span><span class="ident" id="5093291">NewEncoder</span><span class="op" id="5093301">(</span><span class="ident" id="5093302">buf</span><span class="op" id="5093305">)</span><span class="op" id="5093306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5093310">encBuf</span><span class="op" id="5093316">:</span>&nbsp;<span class="ident" id="5093318">buf</span><span class="op" id="5093321">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5093324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5093327">server</span><span class="op" id="5093333">.</span><span class="ident" id="5093334">ServeCodec</span><span class="op" id="5093344">(</span><span class="ident" id="5093345">srv</span><span class="op" id="5093348">)</span><br>
<span class="lineno"></span><span class="op" id="5093350">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5093353">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5093417">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5093458">func</span>&nbsp;<span class="op" id="5093463">(</span><span class="ident" id="5093464">server</span>&nbsp;<span class="op" id="5093471">*</span><span class="ident" id="5093472">Server</span><span class="op" id="5093478">)</span>&nbsp;<span class="ident" id="5093480">ServeCodec</span><span class="op" id="5093490">(</span><span class="ident" id="5093491">codec</span>&nbsp;<span class="ident" id="5093497">ServerCodec</span><span class="op" id="5093508">)</span>&nbsp;<span class="op" id="5093510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5093513">sending</span>&nbsp;<span class="op" id="5093521">:=</span>&nbsp;<span class="builtinfunc" id="5093524">new</span><span class="op" id="5093527">(</span><span class="ident" id="5093528">sync</span><span class="op" id="5093532">.</span><span class="ident" id="5093533">Mutex</span><span class="op" id="5093538">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093541">for</span>&nbsp;<span class="op" id="5093545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5093549">service</span><span class="op" id="5093556">,</span>&nbsp;<span class="ident" id="5093558">mtype</span><span class="op" id="5093563">,</span>&nbsp;<span class="ident" id="5093565">req</span><span class="op" id="5093568">,</span>&nbsp;<span class="ident" id="5093570">argv</span><span class="op" id="5093574">,</span>&nbsp;<span class="ident" id="5093576">replyv</span><span class="op" id="5093582">,</span>&nbsp;<span class="ident" id="5093584">keepReading</span><span class="op" id="5093595">,</span>&nbsp;<span class="ident" id="5093597">err</span>&nbsp;<span class="op" id="5093601">:=</span>&nbsp;<span class="ident" id="5093604">server</span><span class="op" id="5093610">.</span><span class="ident" id="5093611">readRequest</span><span class="op" id="5093622">(</span><span class="ident" id="5093623">codec</span><span class="op" id="5093628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093632">if</span>&nbsp;<span class="ident" id="5093635">err</span>&nbsp;<span class="op" id="5093639">!=</span>&nbsp;<span class="ident" id="5093642">nil</span>&nbsp;<span class="op" id="5093646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093651">if</span>&nbsp;<span class="ident" id="5093654">debugLog</span>&nbsp;<span class="op" id="5093663">&amp;&amp;</span>&nbsp;<span class="ident" id="5093666">err</span>&nbsp;<span class="op" id="5093670">!=</span>&nbsp;<span class="ident" id="5093673">io</span><span class="op" id="5093675">.</span><span class="ident" id="5093676">EOF</span>&nbsp;<span class="op" id="5093680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5093686">log</span><span class="op" id="5093689">.</span><span class="ident" id="5093690">Println</span><span class="op" id="5093697">(</span><span class="string" id="5093698">&#34;rpc:&#34;</span><span class="op" id="5093704">,</span>&nbsp;<span class="ident" id="5093706">err</span><span class="op" id="5093709">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5093714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093719">if</span>&nbsp;<span class="op" id="5093722">!</span><span class="ident" id="5093723">keepReading</span>&nbsp;<span class="op" id="5093735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093741">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5093750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5093755">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093818">if</span>&nbsp;<span class="ident" id="5093821">req</span>&nbsp;<span class="op" id="5093825">!=</span>&nbsp;<span class="ident" id="5093828">nil</span>&nbsp;<span class="op" id="5093832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5093838">server</span><span class="op" id="5093844">.</span><span class="ident" id="5093845">sendResponse</span><span class="op" id="5093857">(</span><span class="ident" id="5093858">sending</span><span class="op" id="5093865">,</span>&nbsp;<span class="ident" id="5093867">req</span><span class="op" id="5093870">,</span>&nbsp;<span class="ident" id="5093872">invalidRequest</span><span class="op" id="5093886">,</span>&nbsp;<span class="ident" id="5093888">codec</span><span class="op" id="5093893">,</span>&nbsp;<span class="ident" id="5093895">err</span><span class="op" id="5093898">.</span><span class="ident" id="5093899">Error</span><span class="op" id="5093904">(</span><span class="op" id="5093905">)</span><span class="op" id="5093906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5093912">server</span><span class="op" id="5093918">.</span><span class="ident" id="5093919">freeRequest</span><span class="op" id="5093930">(</span><span class="ident" id="5093931">req</span><span class="op" id="5093934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5093939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093944">continue</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5093955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5093959">go</span>&nbsp;<span class="ident" id="5093962">service</span><span class="op" id="5093969">.</span><span class="ident" id="5093970">call</span><span class="op" id="5093974">(</span><span class="ident" id="5093975">server</span><span class="op" id="5093981">,</span>&nbsp;<span class="ident" id="5093983">sending</span><span class="op" id="5093990">,</span>&nbsp;<span class="ident" id="5093992">mtype</span><span class="op" id="5093997">,</span>&nbsp;<span class="ident" id="5093999">req</span><span class="op" id="5094002">,</span>&nbsp;<span class="ident" id="5094004">argv</span><span class="op" id="5094008">,</span>&nbsp;<span class="ident" id="5094010">replyv</span><span class="op" id="5094016">,</span>&nbsp;<span class="ident" id="5094018">codec</span><span class="op" id="5094023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5094026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094029">codec</span><span class="op" id="5094034">.</span><span class="ident" id="5094035">Close</span><span class="op" id="5094040">(</span><span class="op" id="5094041">)</span><br>
<span class="lineno"></span><span class="op" id="5094043">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5094046">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5094124">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5094172">func</span>&nbsp;<span class="op" id="5094177">(</span><span class="ident" id="5094178">server</span>&nbsp;<span class="op" id="5094185">*</span><span class="ident" id="5094186">Server</span><span class="op" id="5094192">)</span>&nbsp;<span class="ident" id="5094194">ServeRequest</span><span class="op" id="5094206">(</span><span class="ident" id="5094207">codec</span>&nbsp;<span class="ident" id="5094213">ServerCodec</span><span class="op" id="5094224">)</span>&nbsp;<span class="builtintype" id="5094226">error</span>&nbsp;<span class="op" id="5094232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094235">sending</span>&nbsp;<span class="op" id="5094243">:=</span>&nbsp;<span class="builtinfunc" id="5094246">new</span><span class="op" id="5094249">(</span><span class="ident" id="5094250">sync</span><span class="op" id="5094254">.</span><span class="ident" id="5094255">Mutex</span><span class="op" id="5094260">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094263">service</span><span class="op" id="5094270">,</span>&nbsp;<span class="ident" id="5094272">mtype</span><span class="op" id="5094277">,</span>&nbsp;<span class="ident" id="5094279">req</span><span class="op" id="5094282">,</span>&nbsp;<span class="ident" id="5094284">argv</span><span class="op" id="5094288">,</span>&nbsp;<span class="ident" id="5094290">replyv</span><span class="op" id="5094296">,</span>&nbsp;<span class="ident" id="5094298">keepReading</span><span class="op" id="5094309">,</span>&nbsp;<span class="ident" id="5094311">err</span>&nbsp;<span class="op" id="5094315">:=</span>&nbsp;<span class="ident" id="5094318">server</span><span class="op" id="5094324">.</span><span class="ident" id="5094325">readRequest</span><span class="op" id="5094336">(</span><span class="ident" id="5094337">codec</span><span class="op" id="5094342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094345">if</span>&nbsp;<span class="ident" id="5094348">err</span>&nbsp;<span class="op" id="5094352">!=</span>&nbsp;<span class="ident" id="5094355">nil</span>&nbsp;<span class="op" id="5094359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094363">if</span>&nbsp;<span class="op" id="5094366">!</span><span class="ident" id="5094367">keepReading</span>&nbsp;<span class="op" id="5094379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094384">return</span>&nbsp;<span class="ident" id="5094391">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5094397">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5094401">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094463">if</span>&nbsp;<span class="ident" id="5094466">req</span>&nbsp;<span class="op" id="5094470">!=</span>&nbsp;<span class="ident" id="5094473">nil</span>&nbsp;<span class="op" id="5094477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094482">server</span><span class="op" id="5094488">.</span><span class="ident" id="5094489">sendResponse</span><span class="op" id="5094501">(</span><span class="ident" id="5094502">sending</span><span class="op" id="5094509">,</span>&nbsp;<span class="ident" id="5094511">req</span><span class="op" id="5094514">,</span>&nbsp;<span class="ident" id="5094516">invalidRequest</span><span class="op" id="5094530">,</span>&nbsp;<span class="ident" id="5094532">codec</span><span class="op" id="5094537">,</span>&nbsp;<span class="ident" id="5094539">err</span><span class="op" id="5094542">.</span><span class="ident" id="5094543">Error</span><span class="op" id="5094548">(</span><span class="op" id="5094549">)</span><span class="op" id="5094550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094555">server</span><span class="op" id="5094561">.</span><span class="ident" id="5094562">freeRequest</span><span class="op" id="5094573">(</span><span class="ident" id="5094574">req</span><span class="op" id="5094577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5094581">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094585">return</span>&nbsp;<span class="ident" id="5094592">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5094597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094600">service</span><span class="op" id="5094607">.</span><span class="ident" id="5094608">call</span><span class="op" id="5094612">(</span><span class="ident" id="5094613">server</span><span class="op" id="5094619">,</span>&nbsp;<span class="ident" id="5094621">sending</span><span class="op" id="5094628">,</span>&nbsp;<span class="ident" id="5094630">mtype</span><span class="op" id="5094635">,</span>&nbsp;<span class="ident" id="5094637">req</span><span class="op" id="5094640">,</span>&nbsp;<span class="ident" id="5094642">argv</span><span class="op" id="5094646">,</span>&nbsp;<span class="ident" id="5094648">replyv</span><span class="op" id="5094654">,</span>&nbsp;<span class="ident" id="5094656">codec</span><span class="op" id="5094661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094664">return</span>&nbsp;<span class="ident" id="5094671">nil</span><br>
<span class="lineno"></span><span class="op" id="5094675">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5094678">func</span>&nbsp;<span class="op" id="5094683">(</span><span class="ident" id="5094684">server</span>&nbsp;<span class="op" id="5094691">*</span><span class="ident" id="5094692">Server</span><span class="op" id="5094698">)</span>&nbsp;<span class="ident" id="5094700">getRequest</span><span class="op" id="5094710">(</span><span class="op" id="5094711">)</span>&nbsp;<span class="op" id="5094713">*</span><span class="ident" id="5094714">Request</span>&nbsp;<span class="op" id="5094722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094725">server</span><span class="op" id="5094731">.</span><span class="ident" id="5094732">reqLock</span><span class="op" id="5094739">.</span><span class="ident" id="5094740">Lock</span><span class="op" id="5094744">(</span><span class="op" id="5094745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094748">req</span>&nbsp;<span class="op" id="5094752">:=</span>&nbsp;<span class="ident" id="5094755">server</span><span class="op" id="5094761">.</span><span class="ident" id="5094762">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094771">if</span>&nbsp;<span class="ident" id="5094774">req</span>&nbsp;<span class="op" id="5094778">==</span>&nbsp;<span class="ident" id="5094781">nil</span>&nbsp;<span class="op" id="5094785">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094789">req</span>&nbsp;<span class="op" id="5094793">=</span>&nbsp;<span class="builtinfunc" id="5094795">new</span><span class="op" id="5094798">(</span><span class="ident" id="5094799">Request</span><span class="op" id="5094806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5094809">}</span>&nbsp;<span class="keyword" id="5094811">else</span>&nbsp;<span class="op" id="5094816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094820">server</span><span class="op" id="5094826">.</span><span class="ident" id="5094827">freeReq</span>&nbsp;<span class="op" id="5094835">=</span>&nbsp;<span class="ident" id="5094837">req</span><span class="op" id="5094840">.</span><span class="ident" id="5094841">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5094848">*</span><span class="ident" id="5094849">req</span>&nbsp;<span class="op" id="5094853">=</span>&nbsp;<span class="ident" id="5094855">Request</span><span class="op" id="5094862">{</span><span class="op" id="5094863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5094866">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094869">server</span><span class="op" id="5094875">.</span><span class="ident" id="5094876">reqLock</span><span class="op" id="5094883">.</span><span class="ident" id="5094884">Unlock</span><span class="op" id="5094890">(</span><span class="op" id="5094891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5094894">return</span>&nbsp;<span class="ident" id="5094901">req</span><br>
<span class="lineno"></span><span class="op" id="5094905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5094908">func</span>&nbsp;<span class="op" id="5094913">(</span><span class="ident" id="5094914">server</span>&nbsp;<span class="op" id="5094921">*</span><span class="ident" id="5094922">Server</span><span class="op" id="5094928">)</span>&nbsp;<span class="ident" id="5094930">freeRequest</span><span class="op" id="5094941">(</span><span class="ident" id="5094942">req</span>&nbsp;<span class="op" id="5094946">*</span><span class="ident" id="5094947">Request</span><span class="op" id="5094954">)</span>&nbsp;<span class="op" id="5094956">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094959">server</span><span class="op" id="5094965">.</span><span class="ident" id="5094966">reqLock</span><span class="op" id="5094973">.</span><span class="ident" id="5094974">Lock</span><span class="op" id="5094978">(</span><span class="op" id="5094979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5094982">req</span><span class="op" id="5094985">.</span><span class="ident" id="5094986">next</span>&nbsp;<span class="op" id="5094991">=</span>&nbsp;<span class="ident" id="5094993">server</span><span class="op" id="5094999">.</span><span class="ident" id="5095000">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095009">server</span><span class="op" id="5095015">.</span><span class="ident" id="5095016">freeReq</span>&nbsp;<span class="op" id="5095024">=</span>&nbsp;<span class="ident" id="5095026">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095031">server</span><span class="op" id="5095037">.</span><span class="ident" id="5095038">reqLock</span><span class="op" id="5095045">.</span><span class="ident" id="5095046">Unlock</span><span class="op" id="5095052">(</span><span class="op" id="5095053">)</span><br>
<span class="lineno"></span><span class="op" id="5095055">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span><span class="keyword" id="5095058">func</span>&nbsp;<span class="op" id="5095063">(</span><span class="ident" id="5095064">server</span>&nbsp;<span class="op" id="5095071">*</span><span class="ident" id="5095072">Server</span><span class="op" id="5095078">)</span>&nbsp;<span class="ident" id="5095080">getResponse</span><span class="op" id="5095091">(</span><span class="op" id="5095092">)</span>&nbsp;<span class="op" id="5095094">*</span><span class="ident" id="5095095">Response</span>&nbsp;<span class="op" id="5095104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095107">server</span><span class="op" id="5095113">.</span><span class="ident" id="5095114">respLock</span><span class="op" id="5095122">.</span><span class="ident" id="5095123">Lock</span><span class="op" id="5095127">(</span><span class="op" id="5095128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095131">resp</span>&nbsp;<span class="op" id="5095136">:=</span>&nbsp;<span class="ident" id="5095139">server</span><span class="op" id="5095145">.</span><span class="ident" id="5095146">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5095156">if</span>&nbsp;<span class="ident" id="5095159">resp</span>&nbsp;<span class="op" id="5095164">==</span>&nbsp;<span class="ident" id="5095167">nil</span>&nbsp;<span class="op" id="5095171">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095175">resp</span>&nbsp;<span class="op" id="5095180">=</span>&nbsp;<span class="builtinfunc" id="5095182">new</span><span class="op" id="5095185">(</span><span class="ident" id="5095186">Response</span><span class="op" id="5095194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5095197">}</span>&nbsp;<span class="keyword" id="5095199">else</span>&nbsp;<span class="op" id="5095204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095208">server</span><span class="op" id="5095214">.</span><span class="ident" id="5095215">freeResp</span>&nbsp;<span class="op" id="5095224">=</span>&nbsp;<span class="ident" id="5095226">resp</span><span class="op" id="5095230">.</span><span class="ident" id="5095231">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5095238">*</span><span class="ident" id="5095239">resp</span>&nbsp;<span class="op" id="5095244">=</span>&nbsp;<span class="ident" id="5095246">Response</span><span class="op" id="5095254">{</span><span class="op" id="5095255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5095258">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095261">server</span><span class="op" id="5095267">.</span><span class="ident" id="5095268">respLock</span><span class="op" id="5095276">.</span><span class="ident" id="5095277">Unlock</span><span class="op" id="5095283">(</span><span class="op" id="5095284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5095287">return</span>&nbsp;<span class="ident" id="5095294">resp</span><br>
<span class="lineno"></span><span class="op" id="5095299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5095302">func</span>&nbsp;<span class="op" id="5095307">(</span><span class="ident" id="5095308">server</span>&nbsp;<span class="op" id="5095315">*</span><span class="ident" id="5095316">Server</span><span class="op" id="5095322">)</span>&nbsp;<span class="ident" id="5095324">freeResponse</span><span class="op" id="5095336">(</span><span class="ident" id="5095337">resp</span>&nbsp;<span class="op" id="5095342">*</span><span class="ident" id="5095343">Response</span><span class="op" id="5095351">)</span>&nbsp;<span class="op" id="5095353">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095356">server</span><span class="op" id="5095362">.</span><span class="ident" id="5095363">respLock</span><span class="op" id="5095371">.</span><span class="ident" id="5095372">Lock</span><span class="op" id="5095376">(</span><span class="op" id="5095377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095380">resp</span><span class="op" id="5095384">.</span><span class="ident" id="5095385">next</span>&nbsp;<span class="op" id="5095390">=</span>&nbsp;<span class="ident" id="5095392">server</span><span class="op" id="5095398">.</span><span class="ident" id="5095399">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095409">server</span><span class="op" id="5095415">.</span><span class="ident" id="5095416">freeResp</span>&nbsp;<span class="op" id="5095425">=</span>&nbsp;<span class="ident" id="5095427">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095433">server</span><span class="op" id="5095439">.</span><span class="ident" id="5095440">respLock</span><span class="op" id="5095448">.</span><span class="ident" id="5095449">Unlock</span><span class="op" id="5095455">(</span><span class="op" id="5095456">)</span><br>
<span class="lineno"></span><span class="op" id="5095458">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="5095461">func</span>&nbsp;<span class="op" id="5095466">(</span><span class="ident" id="5095467">server</span>&nbsp;<span class="op" id="5095474">*</span><span class="ident" id="5095475">Server</span><span class="op" id="5095481">)</span>&nbsp;<span class="ident" id="5095483">readRequest</span><span class="op" id="5095494">(</span><span class="ident" id="5095495">codec</span>&nbsp;<span class="ident" id="5095501">ServerCodec</span><span class="op" id="5095512">)</span>&nbsp;<span class="op" id="5095514">(</span><span class="ident" id="5095515">service</span>&nbsp;<span class="op" id="5095523">*</span><span class="ident" id="5095524">service</span><span class="op" id="5095531">,</span>&nbsp;<span class="ident" id="5095533">mtype</span>&nbsp;<span class="op" id="5095539">*</span><span class="ident" id="5095540">methodType</span><span class="op" id="5095550">,</span>&nbsp;<span class="ident" id="5095552">req</span>&nbsp;<span class="op" id="5095556">*</span><span class="ident" id="5095557">Request</span><span class="op" id="5095564">,</span>&nbsp;<span class="ident" id="5095566">argv</span><span class="op" id="5095570">,</span>&nbsp;<span class="ident" id="5095572">replyv</span>&nbsp;<span class="ident" id="5095579">reflect</span><span class="op" id="5095586">.</span><span class="ident" id="5095587">Value</span><span class="op" id="5095592">,</span>&nbsp;<span class="ident" id="5095594">keepReading</span>&nbsp;<span class="builtintype" id="5095606">bool</span><span class="op" id="5095610">,</span>&nbsp;<span class="ident" id="5095612">err</span>&nbsp;<span class="builtintype" id="5095616">error</span><span class="op" id="5095621">)</span>&nbsp;<span class="op" id="5095623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095626">service</span><span class="op" id="5095633">,</span>&nbsp;<span class="ident" id="5095635">mtype</span><span class="op" id="5095640">,</span>&nbsp;<span class="ident" id="5095642">req</span><span class="op" id="5095645">,</span>&nbsp;<span class="ident" id="5095647">keepReading</span><span class="op" id="5095658">,</span>&nbsp;<span class="ident" id="5095660">err</span>&nbsp;<span class="op" id="5095664">=</span>&nbsp;<span class="ident" id="5095666">server</span><span class="op" id="5095672">.</span><span class="ident" id="5095673">readRequestHeader</span><span class="op" id="5095690">(</span><span class="ident" id="5095691">codec</span><span class="op" id="5095696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5095699">if</span>&nbsp;<span class="ident" id="5095702">err</span>&nbsp;<span class="op" id="5095706">!=</span>&nbsp;<span class="ident" id="5095709">nil</span>&nbsp;<span class="op" id="5095713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5095717">if</span>&nbsp;<span class="op" id="5095720">!</span><span class="ident" id="5095721">keepReading</span>&nbsp;<span class="op" id="5095733">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5095738">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5095747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5095751">//&nbsp;discard&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095769">codec</span><span class="op" id="5095774">.</span><span class="ident" id="5095775">ReadRequestBody</span><span class="op" id="5095790">(</span><span class="ident" id="5095791">nil</span><span class="op" id="5095794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5095798">return</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5095806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5095810">//&nbsp;Decode&nbsp;the&nbsp;argument&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095841">argIsValue</span>&nbsp;<span class="op" id="5095852">:=</span>&nbsp;<span class="builtintype" id="5095855">false</span>&nbsp;<span class="comment" id="5095861">//&nbsp;if&nbsp;true,&nbsp;need&nbsp;to&nbsp;indirect&nbsp;before&nbsp;calling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5095907">if</span>&nbsp;<span class="ident" id="5095910">mtype</span><span class="op" id="5095915">.</span><span class="ident" id="5095916">ArgType</span><span class="op" id="5095923">.</span><span class="ident" id="5095924">Kind</span><span class="op" id="5095928">(</span><span class="op" id="5095929">)</span>&nbsp;<span class="op" id="5095931">==</span>&nbsp;<span class="ident" id="5095934">reflect</span><span class="op" id="5095941">.</span><span class="ident" id="5095942">Ptr</span>&nbsp;<span class="op" id="5095946">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5095950">argv</span>&nbsp;<span class="op" id="5095955">=</span>&nbsp;<span class="ident" id="5095957">reflect</span><span class="op" id="5095964">.</span><span class="ident" id="5095965">New</span><span class="op" id="5095968">(</span><span class="ident" id="5095969">mtype</span><span class="op" id="5095974">.</span><span class="ident" id="5095975">ArgType</span><span class="op" id="5095982">.</span><span class="ident" id="5095983">Elem</span><span class="op" id="5095987">(</span><span class="op" id="5095988">)</span><span class="op" id="5095989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5095992">}</span>&nbsp;<span class="keyword" id="5095994">else</span>&nbsp;<span class="op" id="5095999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096003">argv</span>&nbsp;<span class="op" id="5096008">=</span>&nbsp;<span class="ident" id="5096010">reflect</span><span class="op" id="5096017">.</span><span class="ident" id="5096018">New</span><span class="op" id="5096021">(</span><span class="ident" id="5096022">mtype</span><span class="op" id="5096027">.</span><span class="ident" id="5096028">ArgType</span><span class="op" id="5096035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096039">argIsValue</span>&nbsp;<span class="op" id="5096050">=</span>&nbsp;<span class="builtintype" id="5096052">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5096058">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096061">//&nbsp;argv&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;a&nbsp;pointer&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096102">if</span>&nbsp;<span class="ident" id="5096105">err</span>&nbsp;<span class="op" id="5096109">=</span>&nbsp;<span class="ident" id="5096111">codec</span><span class="op" id="5096116">.</span><span class="ident" id="5096117">ReadRequestBody</span><span class="op" id="5096132">(</span><span class="ident" id="5096133">argv</span><span class="op" id="5096137">.</span><span class="ident" id="5096138">Interface</span><span class="op" id="5096147">(</span><span class="op" id="5096148">)</span><span class="op" id="5096149">)</span><span class="op" id="5096150">;</span>&nbsp;<span class="ident" id="5096152">err</span>&nbsp;<span class="op" id="5096156">!=</span>&nbsp;<span class="ident" id="5096159">nil</span>&nbsp;<span class="op" id="5096163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096167">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5096175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096178">if</span>&nbsp;<span class="ident" id="5096181">argIsValue</span>&nbsp;<span class="op" id="5096192">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096196">argv</span>&nbsp;<span class="op" id="5096201">=</span>&nbsp;<span class="ident" id="5096203">argv</span><span class="op" id="5096207">.</span><span class="ident" id="5096208">Elem</span><span class="op" id="5096212">(</span><span class="op" id="5096213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5096216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096220">replyv</span>&nbsp;<span class="op" id="5096227">=</span>&nbsp;<span class="ident" id="5096229">reflect</span><span class="op" id="5096236">.</span><span class="ident" id="5096237">New</span><span class="op" id="5096240">(</span><span class="ident" id="5096241">mtype</span><span class="op" id="5096246">.</span><span class="ident" id="5096247">ReplyType</span><span class="op" id="5096256">.</span><span class="ident" id="5096257">Elem</span><span class="op" id="5096261">(</span><span class="op" id="5096262">)</span><span class="op" id="5096263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096266">return</span><br>
<span class="lineno">570</span><span class="op" id="5096273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5096276">func</span>&nbsp;<span class="op" id="5096281">(</span><span class="ident" id="5096282">server</span>&nbsp;<span class="op" id="5096289">*</span><span class="ident" id="5096290">Server</span><span class="op" id="5096296">)</span>&nbsp;<span class="ident" id="5096298">readRequestHeader</span><span class="op" id="5096315">(</span><span class="ident" id="5096316">codec</span>&nbsp;<span class="ident" id="5096322">ServerCodec</span><span class="op" id="5096333">)</span>&nbsp;<span class="op" id="5096335">(</span><span class="ident" id="5096336">service</span>&nbsp;<span class="op" id="5096344">*</span><span class="ident" id="5096345">service</span><span class="op" id="5096352">,</span>&nbsp;<span class="ident" id="5096354">mtype</span>&nbsp;<span class="op" id="5096360">*</span><span class="ident" id="5096361">methodType</span><span class="op" id="5096371">,</span>&nbsp;<span class="ident" id="5096373">req</span>&nbsp;<span class="op" id="5096377">*</span><span class="ident" id="5096378">Request</span><span class="op" id="5096385">,</span>&nbsp;<span class="ident" id="5096387">keepReading</span>&nbsp;<span class="builtintype" id="5096399">bool</span><span class="op" id="5096403">,</span>&nbsp;<span class="ident" id="5096405">err</span>&nbsp;<span class="builtintype" id="5096409">error</span><span class="op" id="5096414">)</span>&nbsp;<span class="op" id="5096416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096419">//&nbsp;Grab&nbsp;the&nbsp;request&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096448">req</span>&nbsp;<span class="op" id="5096452">=</span>&nbsp;<span class="ident" id="5096454">server</span><span class="op" id="5096460">.</span><span class="ident" id="5096461">getRequest</span><span class="op" id="5096471">(</span><span class="op" id="5096472">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096475">err</span>&nbsp;<span class="op" id="5096479">=</span>&nbsp;<span class="ident" id="5096481">codec</span><span class="op" id="5096486">.</span><span class="ident" id="5096487">ReadRequestHeader</span><span class="op" id="5096504">(</span><span class="ident" id="5096505">req</span><span class="op" id="5096508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096511">if</span>&nbsp;<span class="ident" id="5096514">err</span>&nbsp;<span class="op" id="5096518">!=</span>&nbsp;<span class="ident" id="5096521">nil</span>&nbsp;<span class="op" id="5096525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096529">req</span>&nbsp;<span class="op" id="5096533">=</span>&nbsp;<span class="ident" id="5096535">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096541">if</span>&nbsp;<span class="ident" id="5096544">err</span>&nbsp;<span class="op" id="5096548">==</span>&nbsp;<span class="ident" id="5096551">io</span><span class="op" id="5096553">.</span><span class="ident" id="5096554">EOF</span>&nbsp;<span class="op" id="5096558">||</span>&nbsp;<span class="ident" id="5096561">err</span>&nbsp;<span class="op" id="5096565">==</span>&nbsp;<span class="ident" id="5096568">io</span><span class="op" id="5096570">.</span><span class="ident" id="5096571">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5096588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096593">return</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5096602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096606">err</span>&nbsp;<span class="op" id="5096610">=</span>&nbsp;<span class="ident" id="5096612">errors</span><span class="op" id="5096618">.</span><span class="ident" id="5096619">New</span><span class="op" id="5096622">(</span><span class="string" id="5096623">&#34;rpc:&nbsp;server&nbsp;cannot&nbsp;decode&nbsp;request:&nbsp;&#34;</span>&nbsp;<span class="op" id="5096661">+</span>&nbsp;<span class="ident" id="5096663">err</span><span class="op" id="5096666">.</span><span class="ident" id="5096667">Error</span><span class="op" id="5096672">(</span><span class="op" id="5096673">)</span><span class="op" id="5096674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096678">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5096686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096690">//&nbsp;We&nbsp;read&nbsp;the&nbsp;header&nbsp;successfully.&nbsp;&nbsp;If&nbsp;we&nbsp;see&nbsp;an&nbsp;error&nbsp;now,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5096752">//&nbsp;we&nbsp;can&nbsp;still&nbsp;recover&nbsp;and&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096810">keepReading</span>&nbsp;<span class="op" id="5096822">=</span>&nbsp;<span class="builtintype" id="5096824">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096831">dot</span>&nbsp;<span class="op" id="5096835">:=</span>&nbsp;<span class="ident" id="5096838">strings</span><span class="op" id="5096845">.</span><span class="ident" id="5096846">LastIndex</span><span class="op" id="5096855">(</span><span class="ident" id="5096856">req</span><span class="op" id="5096859">.</span><span class="ident" id="5096860">ServiceMethod</span><span class="op" id="5096873">,</span>&nbsp;<span class="string" id="5096875">&#34;.&#34;</span><span class="op" id="5096878">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096881">if</span>&nbsp;<span class="ident" id="5096884">dot</span>&nbsp;<span class="op" id="5096888">&lt;</span>&nbsp;<span class="num" id="5096890">0</span>&nbsp;<span class="op" id="5096892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096896">err</span>&nbsp;<span class="op" id="5096900">=</span>&nbsp;<span class="ident" id="5096902">errors</span><span class="op" id="5096908">.</span><span class="ident" id="5096909">New</span><span class="op" id="5096912">(</span><span class="string" id="5096913">&#34;rpc:&nbsp;service/method&nbsp;request&nbsp;ill-formed:&nbsp;&#34;</span>&nbsp;<span class="op" id="5096956">+</span>&nbsp;<span class="ident" id="5096958">req</span><span class="op" id="5096961">.</span><span class="ident" id="5096962">ServiceMethod</span><span class="op" id="5096975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5096979">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5096987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5096990">serviceName</span>&nbsp;<span class="op" id="5097002">:=</span>&nbsp;<span class="ident" id="5097005">req</span><span class="op" id="5097008">.</span><span class="ident" id="5097009">ServiceMethod</span><span class="op" id="5097022">[</span><span class="op" id="5097023">:</span><span class="ident" id="5097024">dot</span><span class="op" id="5097027">]</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5097030">methodName</span>&nbsp;<span class="op" id="5097041">:=</span>&nbsp;<span class="ident" id="5097044">req</span><span class="op" id="5097047">.</span><span class="ident" id="5097048">ServiceMethod</span><span class="op" id="5097061">[</span><span class="ident" id="5097062">dot</span><span class="op" id="5097065">+</span><span class="num" id="5097066">1</span><span class="op" id="5097067">:</span><span class="op" id="5097068">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5097072">//&nbsp;Look&nbsp;up&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5097097">server</span><span class="op" id="5097103">.</span><span class="ident" id="5097104">mu</span><span class="op" id="5097106">.</span><span class="ident" id="5097107">RLock</span><span class="op" id="5097112">(</span><span class="op" id="5097113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5097116">service</span>&nbsp;<span class="op" id="5097124">=</span>&nbsp;<span class="ident" id="5097126">server</span><span class="op" id="5097132">.</span><span class="ident" id="5097133">serviceMap</span><span class="op" id="5097143">[</span><span class="ident" id="5097144">serviceName</span><span class="op" id="5097155">]</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5097158">server</span><span class="op" id="5097164">.</span><span class="ident" id="5097165">mu</span><span class="op" id="5097167">.</span><span class="ident" id="5097168">RUnlock</span><span class="op" id="5097175">(</span><span class="op" id="5097176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5097179">if</span>&nbsp;<span class="ident" id="5097182">service</span>&nbsp;<span class="op" id="5097190">==</span>&nbsp;<span class="ident" id="5097193">nil</span>&nbsp;<span class="op" id="5097197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5097201">err</span>&nbsp;<span class="op" id="5097205">=</span>&nbsp;<span class="ident" id="5097207">errors</span><span class="op" id="5097213">.</span><span class="ident" id="5097214">New</span><span class="op" id="5097217">(</span><span class="string" id="5097218">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;service&nbsp;&#34;</span>&nbsp;<span class="op" id="5097245">+</span>&nbsp;<span class="ident" id="5097247">req</span><span class="op" id="5097250">.</span><span class="ident" id="5097251">ServiceMethod</span><span class="op" id="5097264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5097268">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5097276">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5097279">mtype</span>&nbsp;<span class="op" id="5097285">=</span>&nbsp;<span class="ident" id="5097287">service</span><span class="op" id="5097294">.</span><span class="ident" id="5097295">method</span><span class="op" id="5097301">[</span><span class="ident" id="5097302">methodName</span><span class="op" id="5097312">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5097315">if</span>&nbsp;<span class="ident" id="5097318">mtype</span>&nbsp;<span class="op" id="5097324">==</span>&nbsp;<span class="ident" id="5097327">nil</span>&nbsp;<span class="op" id="5097331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5097335">err</span>&nbsp;<span class="op" id="5097339">=</span>&nbsp;<span class="ident" id="5097341">errors</span><span class="op" id="5097347">.</span><span class="ident" id="5097348">New</span><span class="op" id="5097351">(</span><span class="string" id="5097352">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;method&nbsp;&#34;</span>&nbsp;<span class="op" id="5097378">+</span>&nbsp;<span class="ident" id="5097380">req</span><span class="op" id="5097383">.</span><span class="ident" id="5097384">ServiceMethod</span><span class="op" id="5097397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5097400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5097403">return</span><br>
<span class="lineno">610</span><span class="op" id="5097410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5097413">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5097479">//&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.&nbsp;&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="5097549">//&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno">615</span><span class="keyword" id="5097582">func</span>&nbsp;<span class="op" id="5097587">(</span><span class="ident" id="5097588">server</span>&nbsp;<span class="op" id="5097595">*</span><span class="ident" id="5097596">Server</span><span class="op" id="5097602">)</span>&nbsp;<span class="ident" id="5097604">Accept</span><span class="op" id="5097610">(</span><span class="ident" id="5097611">lis</span>&nbsp;<span class="ident" id="5097615">net</span><span class="op" id="5097618">.</span><span class="ident" id="5097619">Listener</span><span class="op" id="5097627">)</span>&nbsp;<span class="op" id="5097629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5097632">for</span>&nbsp;<span class="op" id="5097636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5097640">conn</span><span class="op" id="5097644">,</span>&nbsp;<span class="ident" id="5097646">err</span>&nbsp;<span class="op" id="5097650">:=</span>&nbsp;<span class="ident" id="5097653">lis</span><span class="op" id="5097656">.</span><span class="ident" id="5097657">Accept</span><span class="op" id="5097663">(</span><span class="op" id="5097664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5097668">if</span>&nbsp;<span class="ident" id="5097671">err</span>&nbsp;<span class="op" id="5097675">!=</span>&nbsp;<span class="ident" id="5097678">nil</span>&nbsp;<span class="op" id="5097682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5097687">log</span><span class="op" id="5097690">.</span><span class="ident" id="5097691">Fatal</span><span class="op" id="5097696">(</span><span class="string" id="5097697">&#34;rpc.Serve:&nbsp;accept:&#34;</span><span class="op" id="5097717">,</span>&nbsp;<span class="ident" id="5097719">err</span><span class="op" id="5097722">.</span><span class="ident" id="5097723">Error</span><span class="op" id="5097728">(</span><span class="op" id="5097729">)</span><span class="op" id="5097730">)</span>&nbsp;<span class="comment" id="5097732">//&nbsp;TODO(r):&nbsp;exit?</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5097752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5097756">go</span>&nbsp;<span class="ident" id="5097759">server</span><span class="op" id="5097765">.</span><span class="ident" id="5097766">ServeConn</span><span class="op" id="5097775">(</span><span class="ident" id="5097776">conn</span><span class="op" id="5097780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5097783">}</span><br>
<span class="lineno"></span><span class="op" id="5097785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span><span class="comment" id="5097788">//&nbsp;Register&nbsp;publishes&nbsp;the&nbsp;receiver&#39;s&nbsp;methods&nbsp;in&nbsp;the&nbsp;DefaultServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5097855">func</span>&nbsp;<span class="ident" id="5097860">Register</span><span class="op" id="5097868">(</span><span class="ident" id="5097869">rcvr</span>&nbsp;<span class="keyword" id="5097874">interface</span><span class="op" id="5097883">{</span><span class="op" id="5097884">}</span><span class="op" id="5097885">)</span>&nbsp;<span class="builtintype" id="5097887">error</span>&nbsp;<span class="op" id="5097893">{</span>&nbsp;<span class="keyword" id="5097895">return</span>&nbsp;<span class="ident" id="5097902">DefaultServer</span><span class="op" id="5097915">.</span><span class="ident" id="5097916">Register</span><span class="op" id="5097924">(</span><span class="ident" id="5097925">rcvr</span><span class="op" id="5097929">)</span>&nbsp;<span class="op" id="5097931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5097934">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5098007">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno">630</span><span class="keyword" id="5098051">func</span>&nbsp;<span class="ident" id="5098056">RegisterName</span><span class="op" id="5098068">(</span><span class="ident" id="5098069">name</span>&nbsp;<span class="builtintype" id="5098074">string</span><span class="op" id="5098080">,</span>&nbsp;<span class="ident" id="5098082">rcvr</span>&nbsp;<span class="keyword" id="5098087">interface</span><span class="op" id="5098096">{</span><span class="op" id="5098097">}</span><span class="op" id="5098098">)</span>&nbsp;<span class="builtintype" id="5098100">error</span>&nbsp;<span class="op" id="5098106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5098109">return</span>&nbsp;<span class="ident" id="5098116">DefaultServer</span><span class="op" id="5098129">.</span><span class="ident" id="5098130">RegisterName</span><span class="op" id="5098142">(</span><span class="ident" id="5098143">name</span><span class="op" id="5098147">,</span>&nbsp;<span class="ident" id="5098149">rcvr</span><span class="op" id="5098153">)</span><br>
<span class="lineno"></span><span class="op" id="5098155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5098158">//&nbsp;A&nbsp;ServerCodec&nbsp;implements&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and&nbsp;writing&nbsp;of</span><br>
<span class="lineno">635</span><span class="comment" id="5098225">//&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="5098281">//&nbsp;The&nbsp;server&nbsp;calls&nbsp;ReadRequestHeader&nbsp;and&nbsp;ReadRequestBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="5098348">//&nbsp;to&nbsp;read&nbsp;requests&nbsp;from&nbsp;the&nbsp;connection,&nbsp;and&nbsp;it&nbsp;calls&nbsp;WriteResponse&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5098419">//&nbsp;write&nbsp;a&nbsp;response&nbsp;back.&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5098492">//&nbsp;connection.&nbsp;ReadRequestBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">640</span><span class="comment" id="5098548">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;request&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="5098619">type</span>&nbsp;<span class="ident" id="5098624">ServerCodec</span>&nbsp;<span class="keyword" id="5098636">interface</span>&nbsp;<span class="op" id="5098646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5098649">ReadRequestHeader</span><span class="op" id="5098666">(</span><span class="op" id="5098667">*</span><span class="ident" id="5098668">Request</span><span class="op" id="5098675">)</span>&nbsp;<span class="builtintype" id="5098677">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5098684">ReadRequestBody</span><span class="op" id="5098699">(</span><span class="keyword" id="5098700">interface</span><span class="op" id="5098709">{</span><span class="op" id="5098710">}</span><span class="op" id="5098711">)</span>&nbsp;<span class="builtintype" id="5098713">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5098720">//&nbsp;WriteResponse&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5098794">WriteResponse</span><span class="op" id="5098807">(</span><span class="op" id="5098808">*</span><span class="ident" id="5098809">Response</span><span class="op" id="5098817">,</span>&nbsp;<span class="keyword" id="5098819">interface</span><span class="op" id="5098828">{</span><span class="op" id="5098829">}</span><span class="op" id="5098830">)</span>&nbsp;<span class="builtintype" id="5098832">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5098840">Close</span><span class="op" id="5098845">(</span><span class="op" id="5098846">)</span>&nbsp;<span class="builtintype" id="5098848">error</span><br>
<span class="lineno"></span><span class="op" id="5098854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="5098857">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;DefaultServer&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5098917">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5098988">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5099049">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5099112">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">655</span><span class="keyword" id="5099171">func</span>&nbsp;<span class="ident" id="5099176">ServeConn</span><span class="op" id="5099185">(</span><span class="ident" id="5099186">conn</span>&nbsp;<span class="ident" id="5099191">io</span><span class="op" id="5099193">.</span><span class="ident" id="5099194">ReadWriteCloser</span><span class="op" id="5099209">)</span>&nbsp;<span class="op" id="5099211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099214">DefaultServer</span><span class="op" id="5099227">.</span><span class="ident" id="5099228">ServeConn</span><span class="op" id="5099237">(</span><span class="ident" id="5099238">conn</span><span class="op" id="5099242">)</span><br>
<span class="lineno"></span><span class="op" id="5099244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5099247">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno">660</span><span class="comment" id="5099311">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5099352">func</span>&nbsp;<span class="ident" id="5099357">ServeCodec</span><span class="op" id="5099367">(</span><span class="ident" id="5099368">codec</span>&nbsp;<span class="ident" id="5099374">ServerCodec</span><span class="op" id="5099385">)</span>&nbsp;<span class="op" id="5099387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5099390">DefaultServer</span><span class="op" id="5099403">.</span><span class="ident" id="5099404">ServeCodec</span><span class="op" id="5099414">(</span><span class="ident" id="5099415">codec</span><span class="op" id="5099420">)</span><br>
<span class="lineno"></span><span class="op" id="5099422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="5099425">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5099503">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5099551">func</span>&nbsp;<span class="ident" id="5099556">ServeRequest</span><span class="op" id="5099568">(</span><span class="ident" id="5099569">codec</span>&nbsp;<span class="ident" id="5099575">ServerCodec</span><span class="op" id="5099586">)</span>&nbsp;<span class="builtintype" id="5099588">error</span>&nbsp;<span class="op" id="5099594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5099597">return</span>&nbsp;<span class="ident" id="5099604">DefaultServer</span><span class="op" id="5099617">.</span><span class="ident" id="5099618">ServeRequest</span><span class="op" id="5099630">(</span><span class="ident" id="5099631">codec</span><span class="op" id="5099636">)</span><br>
<span class="lineno"></span><span class="op" id="5099638">}</span><br>
<span class="lineno">670</span><br>
<span class="lineno"></span><span class="comment" id="5099641">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5099707">//&nbsp;to&nbsp;DefaultServer&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5099757">//&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5099826">func</span>&nbsp;<span class="ident" id="5099831">Accept</span><span class="op" id="5099837">(</span><span class="ident" id="5099838">lis</span>&nbsp;<span class="ident" id="5099842">net</span><span class="op" id="5099845">.</span><span class="ident" id="5099846">Listener</span><span class="op" id="5099854">)</span>&nbsp;<span class="op" id="5099856">{</span>&nbsp;<span class="ident" id="5099858">DefaultServer</span><span class="op" id="5099871">.</span><span class="ident" id="5099872">Accept</span><span class="op" id="5099878">(</span><span class="ident" id="5099879">lis</span><span class="op" id="5099882">)</span>&nbsp;<span class="op" id="5099884">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="comment" id="5099887">//&nbsp;Can&nbsp;connect&nbsp;to&nbsp;RPC&nbsp;service&nbsp;using&nbsp;HTTP&nbsp;CONNECT&nbsp;to&nbsp;rpcPath.</span><br>
<span class="lineno"></span><span class="keyword" id="5099948">var</span>&nbsp;<span class="ident" id="5099952">connected</span>&nbsp;<span class="op" id="5099962">=</span>&nbsp;<span class="string" id="5099964">&#34;200&nbsp;Connected&nbsp;to&nbsp;Go&nbsp;RPC&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5099991">//&nbsp;ServeHTTP&nbsp;implements&nbsp;an&nbsp;http.Handler&nbsp;that&nbsp;answers&nbsp;RPC&nbsp;requests.</span><br>
<span class="lineno">680</span><span class="keyword" id="5100058">func</span>&nbsp;<span class="op" id="5100063">(</span><span class="ident" id="5100064">server</span>&nbsp;<span class="op" id="5100071">*</span><span class="ident" id="5100072">Server</span><span class="op" id="5100078">)</span>&nbsp;<span class="ident" id="5100080">ServeHTTP</span><span class="op" id="5100089">(</span><span class="ident" id="5100090">w</span>&nbsp;<span class="ident" id="5100092">http</span><span class="op" id="5100096">.</span><span class="ident" id="5100097">ResponseWriter</span><span class="op" id="5100111">,</span>&nbsp;<span class="ident" id="5100113">req</span>&nbsp;<span class="op" id="5100117">*</span><span class="ident" id="5100118">http</span><span class="op" id="5100122">.</span><span class="ident" id="5100123">Request</span><span class="op" id="5100130">)</span>&nbsp;<span class="op" id="5100132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5100135">if</span>&nbsp;<span class="ident" id="5100138">req</span><span class="op" id="5100141">.</span><span class="ident" id="5100142">Method</span>&nbsp;<span class="op" id="5100149">!=</span>&nbsp;<span class="string" id="5100152">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="5100162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100166">w</span><span class="op" id="5100167">.</span><span class="ident" id="5100168">Header</span><span class="op" id="5100174">(</span><span class="op" id="5100175">)</span><span class="op" id="5100176">.</span><span class="ident" id="5100177">Set</span><span class="op" id="5100180">(</span><span class="string" id="5100181">&#34;Content-Type&#34;</span><span class="op" id="5100195">,</span>&nbsp;<span class="string" id="5100197">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="5100224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100228">w</span><span class="op" id="5100229">.</span><span class="ident" id="5100230">WriteHeader</span><span class="op" id="5100241">(</span><span class="ident" id="5100242">http</span><span class="op" id="5100246">.</span><span class="ident" id="5100247">StatusMethodNotAllowed</span><span class="op" id="5100269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100273">io</span><span class="op" id="5100275">.</span><span class="ident" id="5100276">WriteString</span><span class="op" id="5100287">(</span><span class="ident" id="5100288">w</span><span class="op" id="5100289">,</span>&nbsp;<span class="string" id="5100291">&#34;405&nbsp;must&nbsp;CONNECT\n&#34;</span><span class="op" id="5100311">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5100315">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5100323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100326">conn</span><span class="op" id="5100330">,</span>&nbsp;<span class="ident" id="5100332">_</span><span class="op" id="5100333">,</span>&nbsp;<span class="ident" id="5100335">err</span>&nbsp;<span class="op" id="5100339">:=</span>&nbsp;<span class="ident" id="5100342">w</span><span class="op" id="5100343">.</span><span class="op" id="5100344">(</span><span class="ident" id="5100345">http</span><span class="op" id="5100349">.</span><span class="ident" id="5100350">Hijacker</span><span class="op" id="5100358">)</span><span class="op" id="5100359">.</span><span class="ident" id="5100360">Hijack</span><span class="op" id="5100366">(</span><span class="op" id="5100367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5100370">if</span>&nbsp;<span class="ident" id="5100373">err</span>&nbsp;<span class="op" id="5100377">!=</span>&nbsp;<span class="ident" id="5100380">nil</span>&nbsp;<span class="op" id="5100384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100388">log</span><span class="op" id="5100391">.</span><span class="ident" id="5100392">Print</span><span class="op" id="5100397">(</span><span class="string" id="5100398">&#34;rpc&nbsp;hijacking&nbsp;&#34;</span><span class="op" id="5100414">,</span>&nbsp;<span class="ident" id="5100416">req</span><span class="op" id="5100419">.</span><span class="ident" id="5100420">RemoteAddr</span><span class="op" id="5100430">,</span>&nbsp;<span class="string" id="5100432">&#34;:&nbsp;&#34;</span><span class="op" id="5100436">,</span>&nbsp;<span class="ident" id="5100438">err</span><span class="op" id="5100441">.</span><span class="ident" id="5100442">Error</span><span class="op" id="5100447">(</span><span class="op" id="5100448">)</span><span class="op" id="5100449">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5100453">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5100461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100464">io</span><span class="op" id="5100466">.</span><span class="ident" id="5100467">WriteString</span><span class="op" id="5100478">(</span><span class="ident" id="5100479">conn</span><span class="op" id="5100483">,</span>&nbsp;<span class="string" id="5100485">&#34;HTTP/1.0&nbsp;&#34;</span><span class="op" id="5100496">+</span><span class="ident" id="5100497">connected</span><span class="op" id="5100506">+</span><span class="string" id="5100507">&#34;\n\n&#34;</span><span class="op" id="5100513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100516">server</span><span class="op" id="5100522">.</span><span class="ident" id="5100523">ServeConn</span><span class="op" id="5100532">(</span><span class="ident" id="5100533">conn</span><span class="op" id="5100537">)</span><br>
<span class="lineno"></span><span class="op" id="5100539">}</span><br>
<span class="lineno">695</span><br>
<span class="lineno"></span><span class="comment" id="5100542">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;on&nbsp;rpcPath,</span><br>
<span class="lineno"></span><span class="comment" id="5100611">//&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;debugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5100652">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5100730">func</span>&nbsp;<span class="op" id="5100735">(</span><span class="ident" id="5100736">server</span>&nbsp;<span class="op" id="5100743">*</span><span class="ident" id="5100744">Server</span><span class="op" id="5100750">)</span>&nbsp;<span class="ident" id="5100752">HandleHTTP</span><span class="op" id="5100762">(</span><span class="ident" id="5100763">rpcPath</span><span class="op" id="5100770">,</span>&nbsp;<span class="ident" id="5100772">debugPath</span>&nbsp;<span class="builtintype" id="5100782">string</span><span class="op" id="5100788">)</span>&nbsp;<span class="op" id="5100790">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100793">http</span><span class="op" id="5100797">.</span><span class="ident" id="5100798">Handle</span><span class="op" id="5100804">(</span><span class="ident" id="5100805">rpcPath</span><span class="op" id="5100812">,</span>&nbsp;<span class="ident" id="5100814">server</span><span class="op" id="5100820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5100823">http</span><span class="op" id="5100827">.</span><span class="ident" id="5100828">Handle</span><span class="op" id="5100834">(</span><span class="ident" id="5100835">debugPath</span><span class="op" id="5100844">,</span>&nbsp;<span class="ident" id="5100846">debugHTTP</span><span class="op" id="5100855">{</span><span class="ident" id="5100856">server</span><span class="op" id="5100862">}</span><span class="op" id="5100863">)</span><br>
<span class="lineno"></span><span class="op" id="5100865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5100868">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;to&nbsp;DefaultServer</span><br>
<span class="lineno">705</span><span class="comment" id="5100942">//&nbsp;on&nbsp;DefaultRPCPath&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;DefaultDebugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5101008">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5101086">func</span>&nbsp;<span class="ident" id="5101091">HandleHTTP</span><span class="op" id="5101101">(</span><span class="op" id="5101102">)</span>&nbsp;<span class="op" id="5101104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5101107">DefaultServer</span><span class="op" id="5101120">.</span><span class="ident" id="5101121">HandleHTTP</span><span class="op" id="5101131">(</span><span class="ident" id="5101132">DefaultRPCPath</span><span class="op" id="5101146">,</span>&nbsp;<span class="ident" id="5101148">DefaultDebugPath</span><span class="op" id="5101164">)</span><br>
<span class="lineno"></span><span class="op" id="5101166">}</span>
</div>
</body>
</html>
