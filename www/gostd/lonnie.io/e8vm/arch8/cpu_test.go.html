<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>lonnie.io/e8vm/arch8</h2>
<ul>
<li><a href="/gostd/lonnie.io/e8vm/arch8/console.go.html">console.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu.go.html">cpu.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu_test.go.html">cpu_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/device.go.html">device.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/exception.go.html">exception.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_all.go.html">inst_all.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br.go.html">inst_br.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br_test.go.html">inst_br_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm.go.html">inst_imm.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm_test.go.html">inst_imm_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_jmp.go.html">inst_jmp.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg.go.html">inst_reg.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg_test.go.html">inst_reg_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_sys.go.html">inst_sys.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/int_bus.go.html">int_bus.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt.go.html">interrupt.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt_test.go.html">interrupt_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/machine.go.html">machine.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/multi_core.go.html">multi_core.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page.go.html">page.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table.go.html">page_table.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table_test.go.html">page_table_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_test.go.html">page_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory.go.html">phy_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory_test.go.html">phy_memory_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs.go.html">regs.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs_test.go.html">regs_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/run_image.go.html">run_image.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/serial.go.html">serial.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/ticker.go.html">ticker.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory.go.html">virt_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory_test.go.html">virt_memory_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="keyword" id="6746256">package</span>&nbsp;<span class="ident" id="6746264">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6746271">import</span>&nbsp;<span class="op" id="6746278">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6746281">&#34;testing&#34;</span><br>
<span class="lineno">5</span><span class="op" id="6746291">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6746294">type</span>&nbsp;<span class="ident" id="6746299">ti1</span>&nbsp;<span class="builtintype" id="6746303">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6746308">func</span>&nbsp;<span class="op" id="6746313">(</span><span class="ident" id="6746314">i</span>&nbsp;<span class="ident" id="6746316">ti1</span><span class="op" id="6746319">)</span>&nbsp;<span class="ident" id="6746321">I</span><span class="op" id="6746322">(</span><span class="ident" id="6746323">cpu</span>&nbsp;<span class="op" id="6746327">*</span><span class="ident" id="6746328">cpu</span><span class="op" id="6746331">,</span>&nbsp;<span class="ident" id="6746333">in</span>&nbsp;<span class="builtintype" id="6746336">uint32</span><span class="op" id="6746342">)</span>&nbsp;<span class="op" id="6746344">*</span><span class="ident" id="6746345">Excep</span>&nbsp;<span class="op" id="6746351">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6746354">switch</span>&nbsp;<span class="ident" id="6746361">in</span>&nbsp;<span class="op" id="6746364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6746367">case</span>&nbsp;<span class="num" id="6746372">0</span><span class="op" id="6746373">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6746377">return</span>&nbsp;<span class="ident" id="6746384">errHalt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6746393">case</span>&nbsp;<span class="num" id="6746398">1</span><span class="op" id="6746399">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6746403">return</span>&nbsp;<span class="ident" id="6746410">errTimeInt</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6746422">case</span>&nbsp;<span class="num" id="6746427">2</span><span class="op" id="6746428">:</span>&nbsp;<span class="comment" id="6746430">//&nbsp;iret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6746440">if</span>&nbsp;<span class="ident" id="6746443">cpu</span><span class="op" id="6746446">.</span><span class="ident" id="6746447">UserMode</span><span class="op" id="6746455">(</span><span class="op" id="6746456">)</span>&nbsp;<span class="op" id="6746458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6746463">return</span>&nbsp;<span class="ident" id="6746470">errInvalidInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6746487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6746491">return</span>&nbsp;<span class="ident" id="6746498">cpu</span><span class="op" id="6746501">.</span><span class="ident" id="6746502">Iret</span><span class="op" id="6746506">(</span><span class="op" id="6746507">)</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6746510">default</span><span class="op" id="6746517">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6746521">return</span>&nbsp;<span class="ident" id="6746528">errInvalidInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6746544">}</span><br>
<span class="lineno"></span><span class="op" id="6746546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6746549">func</span>&nbsp;<span class="ident" id="6746554">TestCPU</span><span class="op" id="6746561">(</span><span class="ident" id="6746562">t</span>&nbsp;<span class="op" id="6746564">*</span><span class="ident" id="6746565">testing</span><span class="op" id="6746572">.</span><span class="ident" id="6746573">T</span><span class="op" id="6746574">)</span>&nbsp;<span class="op" id="6746576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746579">as</span>&nbsp;<span class="op" id="6746582">:=</span>&nbsp;<span class="keyword" id="6746585">func</span><span class="op" id="6746589">(</span><span class="ident" id="6746590">cond</span>&nbsp;<span class="builtintype" id="6746595">bool</span><span class="op" id="6746599">,</span>&nbsp;<span class="ident" id="6746601">s</span>&nbsp;<span class="builtintype" id="6746603">string</span><span class="op" id="6746609">,</span>&nbsp;<span class="ident" id="6746611">args</span>&nbsp;<span class="op" id="6746616">...</span><span class="keyword" id="6746619">interface</span><span class="op" id="6746628">{</span><span class="op" id="6746629">}</span><span class="op" id="6746630">)</span>&nbsp;<span class="op" id="6746632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6746636">if</span>&nbsp;<span class="op" id="6746639">!</span><span class="ident" id="6746640">cond</span>&nbsp;<span class="op" id="6746645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746650">t</span><span class="op" id="6746651">.</span><span class="ident" id="6746652">Fatalf</span><span class="op" id="6746658">(</span><span class="ident" id="6746659">s</span><span class="op" id="6746660">,</span>&nbsp;<span class="ident" id="6746662">args</span><span class="op" id="6746666">...</span><span class="op" id="6746669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6746673">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6746676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746680">m</span>&nbsp;<span class="op" id="6746682">:=</span>&nbsp;<span class="ident" id="6746685">newPhyMemory</span><span class="op" id="6746697">(</span><span class="ident" id="6746698">PageSize</span>&nbsp;<span class="op" id="6746707">*</span>&nbsp;<span class="num" id="6746709">32</span><span class="op" id="6746711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746714">cpu</span>&nbsp;<span class="op" id="6746718">:=</span>&nbsp;<span class="ident" id="6746721">newCPU</span><span class="op" id="6746727">(</span><span class="ident" id="6746728">m</span><span class="op" id="6746729">,</span>&nbsp;<span class="ident" id="6746731">ti1</span><span class="op" id="6746734">(</span><span class="num" id="6746735">0</span><span class="op" id="6746736">)</span><span class="op" id="6746737">,</span>&nbsp;<span class="num" id="6746739">0</span><span class="op" id="6746740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746743">e</span>&nbsp;<span class="op" id="6746745">:=</span>&nbsp;<span class="ident" id="6746748">cpu</span><span class="op" id="6746751">.</span><span class="ident" id="6746752">Tick</span><span class="op" id="6746756">(</span><span class="op" id="6746757">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746760">as</span><span class="op" id="6746762">(</span><span class="ident" id="6746763">e</span>&nbsp;<span class="op" id="6746765">==</span>&nbsp;<span class="ident" id="6746768">errHalt</span><span class="op" id="6746775">,</span>&nbsp;<span class="string" id="6746777">&#34;not&nbsp;halting&#34;</span><span class="op" id="6746790">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746794">cpu</span><span class="op" id="6746797">.</span><span class="ident" id="6746798">Reset</span><span class="op" id="6746803">(</span><span class="op" id="6746804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746807">m</span><span class="op" id="6746808">.</span><span class="ident" id="6746809">WriteWord</span><span class="op" id="6746818">(</span><span class="ident" id="6746819">InitPC</span><span class="op" id="6746825">,</span>&nbsp;<span class="num" id="6746827">1</span><span class="op" id="6746828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746831">e</span>&nbsp;<span class="op" id="6746833">=</span>&nbsp;<span class="ident" id="6746835">cpu</span><span class="op" id="6746838">.</span><span class="ident" id="6746839">Tick</span><span class="op" id="6746843">(</span><span class="op" id="6746844">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746847">as</span><span class="op" id="6746849">(</span><span class="ident" id="6746850">e</span>&nbsp;<span class="op" id="6746852">==</span>&nbsp;<span class="ident" id="6746855">errTimeInt</span><span class="op" id="6746865">,</span>&nbsp;<span class="string" id="6746867">&#34;not&nbsp;time&nbsp;interrupt&#34;</span><span class="op" id="6746887">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746891">cpu</span><span class="op" id="6746894">.</span><span class="ident" id="6746895">Reset</span><span class="op" id="6746900">(</span><span class="op" id="6746901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746904">cpu</span><span class="op" id="6746907">.</span><span class="ident" id="6746908">interrupt</span><span class="op" id="6746917">.</span><span class="ident" id="6746918">Enable</span><span class="op" id="6746924">(</span><span class="op" id="6746925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746928">cpu</span><span class="op" id="6746931">.</span><span class="ident" id="6746932">interrupt</span><span class="op" id="6746941">.</span><span class="ident" id="6746942">EnableInt</span><span class="op" id="6746951">(</span><span class="ident" id="6746952">errTimeInt</span><span class="op" id="6746962">.</span><span class="ident" id="6746963">Code</span><span class="op" id="6746967">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6746970">cpu</span><span class="op" id="6746973">.</span><span class="ident" id="6746974">interrupt</span><span class="op" id="6746983">.</span><span class="ident" id="6746984">writeWord</span><span class="op" id="6746993">(</span><span class="ident" id="6746994">intKernelSP</span><span class="op" id="6747005">,</span>&nbsp;<span class="num" id="6747007">0x10000</span><span class="op" id="6747014">)</span>&nbsp;&nbsp;<span class="comment" id="6747017">//&nbsp;page&nbsp;16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747029">cpu</span><span class="op" id="6747032">.</span><span class="ident" id="6747033">interrupt</span><span class="op" id="6747042">.</span><span class="ident" id="6747043">writeWord</span><span class="op" id="6747052">(</span><span class="ident" id="6747053">intHandlerPC</span><span class="op" id="6747065">,</span>&nbsp;<span class="num" id="6747067">0x10000</span><span class="op" id="6747074">)</span>&nbsp;<span class="comment" id="6747076">//&nbsp;page&nbsp;16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747088">cpu</span><span class="op" id="6747091">.</span><span class="ident" id="6747092">ring</span>&nbsp;<span class="op" id="6747097">=</span>&nbsp;<span class="num" id="6747099">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747103">e</span>&nbsp;<span class="op" id="6747105">=</span>&nbsp;<span class="ident" id="6747107">cpu</span><span class="op" id="6747110">.</span><span class="ident" id="6747111">Tick</span><span class="op" id="6747115">(</span><span class="op" id="6747116">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747119">as</span><span class="op" id="6747121">(</span><span class="ident" id="6747122">e</span>&nbsp;<span class="op" id="6747124">==</span>&nbsp;<span class="ident" id="6747127">nil</span><span class="op" id="6747130">,</span>&nbsp;<span class="string" id="6747132">&#34;should&nbsp;have&nbsp;no&nbsp;error&#34;</span><span class="op" id="6747154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747157">as</span><span class="op" id="6747159">(</span><span class="ident" id="6747160">cpu</span><span class="op" id="6747163">.</span><span class="ident" id="6747164">regs</span><span class="op" id="6747168">[</span><span class="ident" id="6747169">PC</span><span class="op" id="6747171">]</span>&nbsp;<span class="op" id="6747173">==</span>&nbsp;<span class="num" id="6747176">0x10000</span><span class="op" id="6747183">,</span>&nbsp;<span class="string" id="6747185">&#34;pc&nbsp;incorrect&#34;</span><span class="op" id="6747199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747202">as</span><span class="op" id="6747204">(</span><span class="ident" id="6747205">cpu</span><span class="op" id="6747208">.</span><span class="ident" id="6747209">regs</span><span class="op" id="6747213">[</span><span class="ident" id="6747214">SP</span><span class="op" id="6747216">]</span>&nbsp;<span class="op" id="6747218">==</span>&nbsp;<span class="num" id="6747221">0x10000</span><span class="op" id="6747228">,</span>&nbsp;<span class="string" id="6747230">&#34;sp&nbsp;incorrect&#34;</span><span class="op" id="6747244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747247">as</span><span class="op" id="6747249">(</span><span class="ident" id="6747250">cpu</span><span class="op" id="6747253">.</span><span class="ident" id="6747254">regs</span><span class="op" id="6747258">[</span><span class="ident" id="6747259">RET</span><span class="op" id="6747262">]</span>&nbsp;<span class="op" id="6747264">==</span>&nbsp;<span class="num" id="6747267">0x8000</span><span class="op" id="6747273">,</span>&nbsp;<span class="string" id="6747275">&#34;ret&nbsp;incorrect&#34;</span><span class="op" id="6747290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747293">as</span><span class="op" id="6747295">(</span><span class="op" id="6747296">!</span><span class="ident" id="6747297">cpu</span><span class="op" id="6747300">.</span><span class="ident" id="6747301">UserMode</span><span class="op" id="6747309">(</span><span class="op" id="6747310">)</span><span class="op" id="6747311">,</span>&nbsp;<span class="string" id="6747313">&#34;not&nbsp;in&nbsp;kernel&#34;</span><span class="op" id="6747328">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747331">b</span><span class="op" id="6747332">,</span>&nbsp;<span class="ident" id="6747334">e</span>&nbsp;<span class="op" id="6747336">:=</span>&nbsp;<span class="ident" id="6747339">m</span><span class="op" id="6747340">.</span><span class="ident" id="6747341">ReadByte</span><span class="op" id="6747349">(</span><span class="num" id="6747350">0x10000</span>&nbsp;<span class="op" id="6747358">-</span>&nbsp;<span class="ident" id="6747360">intFrameSize</span>&nbsp;<span class="op" id="6747373">+</span>&nbsp;<span class="ident" id="6747375">intFrameCode</span><span class="op" id="6747387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747390">as</span><span class="op" id="6747392">(</span><span class="ident" id="6747393">e</span>&nbsp;<span class="op" id="6747395">==</span>&nbsp;<span class="ident" id="6747398">nil</span><span class="op" id="6747401">,</span>&nbsp;<span class="string" id="6747403">&#34;read&nbsp;byte&nbsp;error&#34;</span><span class="op" id="6747420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747423">as</span><span class="op" id="6747425">(</span><span class="ident" id="6747426">b</span>&nbsp;<span class="op" id="6747428">==</span>&nbsp;<span class="ident" id="6747431">errTimeInt</span><span class="op" id="6747441">.</span><span class="ident" id="6747442">Code</span><span class="op" id="6747446">,</span>&nbsp;<span class="string" id="6747448">&#34;not&nbsp;time&nbsp;interrupt&#34;</span><span class="op" id="6747468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747471">b</span><span class="op" id="6747472">,</span>&nbsp;<span class="ident" id="6747474">e</span>&nbsp;<span class="op" id="6747476">=</span>&nbsp;<span class="ident" id="6747478">m</span><span class="op" id="6747479">.</span><span class="ident" id="6747480">ReadByte</span><span class="op" id="6747488">(</span><span class="num" id="6747489">0x10000</span>&nbsp;<span class="op" id="6747497">-</span>&nbsp;<span class="ident" id="6747499">intFrameSize</span>&nbsp;<span class="op" id="6747512">+</span>&nbsp;<span class="ident" id="6747514">intFrameRing</span><span class="op" id="6747526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747529">as</span><span class="op" id="6747531">(</span><span class="ident" id="6747532">b</span>&nbsp;<span class="op" id="6747534">==</span>&nbsp;<span class="num" id="6747537">1</span><span class="op" id="6747538">,</span>&nbsp;<span class="string" id="6747540">&#34;was&nbsp;not&nbsp;in&nbsp;user&#34;</span><span class="op" id="6747557">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747560">as</span><span class="op" id="6747562">(</span><span class="op" id="6747563">!</span><span class="ident" id="6747564">cpu</span><span class="op" id="6747567">.</span><span class="ident" id="6747568">interrupt</span><span class="op" id="6747577">.</span><span class="ident" id="6747578">Enabled</span><span class="op" id="6747585">(</span><span class="op" id="6747586">)</span><span class="op" id="6747587">,</span>&nbsp;<span class="string" id="6747589">&#34;interrupt&nbsp;not&nbsp;disabled&#34;</span><span class="op" id="6747613">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747617">e</span>&nbsp;<span class="op" id="6747619">=</span>&nbsp;<span class="ident" id="6747621">cpu</span><span class="op" id="6747624">.</span><span class="ident" id="6747625">Tick</span><span class="op" id="6747629">(</span><span class="op" id="6747630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747633">as</span><span class="op" id="6747635">(</span><span class="ident" id="6747636">e</span>&nbsp;<span class="op" id="6747638">==</span>&nbsp;<span class="ident" id="6747641">errHalt</span><span class="op" id="6747648">,</span>&nbsp;<span class="string" id="6747650">&#34;should&nbsp;halt&nbsp;now&#34;</span><span class="op" id="6747667">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747671">cpu</span><span class="op" id="6747674">.</span><span class="ident" id="6747675">Reset</span><span class="op" id="6747680">(</span><span class="op" id="6747681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747684">cpu</span><span class="op" id="6747687">.</span><span class="ident" id="6747688">interrupt</span><span class="op" id="6747697">.</span><span class="ident" id="6747698">Enable</span><span class="op" id="6747704">(</span><span class="op" id="6747705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747708">cpu</span><span class="op" id="6747711">.</span><span class="ident" id="6747712">ring</span>&nbsp;<span class="op" id="6747717">=</span>&nbsp;<span class="num" id="6747719">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747722">m</span><span class="op" id="6747723">.</span><span class="ident" id="6747724">WriteWord</span><span class="op" id="6747733">(</span><span class="num" id="6747734">0x10000</span><span class="op" id="6747741">,</span>&nbsp;<span class="num" id="6747743">2</span><span class="op" id="6747744">)</span>&nbsp;<span class="comment" id="6747746">//&nbsp;write&nbsp;an&nbsp;iret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747764">e</span>&nbsp;<span class="op" id="6747766">=</span>&nbsp;<span class="ident" id="6747768">cpu</span><span class="op" id="6747771">.</span><span class="ident" id="6747772">Tick</span><span class="op" id="6747776">(</span><span class="op" id="6747777">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747780">as</span><span class="op" id="6747782">(</span><span class="ident" id="6747783">e</span>&nbsp;<span class="op" id="6747785">==</span>&nbsp;<span class="ident" id="6747788">nil</span><span class="op" id="6747791">,</span>&nbsp;<span class="string" id="6747793">&#34;unexpected&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="6747815">,</span>&nbsp;<span class="ident" id="6747817">e</span><span class="op" id="6747818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747821">as</span><span class="op" id="6747823">(</span><span class="op" id="6747824">!</span><span class="ident" id="6747825">cpu</span><span class="op" id="6747828">.</span><span class="ident" id="6747829">interrupt</span><span class="op" id="6747838">.</span><span class="ident" id="6747839">Enabled</span><span class="op" id="6747846">(</span><span class="op" id="6747847">)</span><span class="op" id="6747848">,</span>&nbsp;<span class="string" id="6747850">&#34;interrupt&nbsp;not&nbsp;disabled&#34;</span><span class="op" id="6747874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747877">e</span>&nbsp;<span class="op" id="6747879">=</span>&nbsp;<span class="ident" id="6747881">cpu</span><span class="op" id="6747884">.</span><span class="ident" id="6747885">Tick</span><span class="op" id="6747889">(</span><span class="op" id="6747890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747893">as</span><span class="op" id="6747895">(</span><span class="ident" id="6747896">e</span>&nbsp;<span class="op" id="6747898">==</span>&nbsp;<span class="ident" id="6747901">nil</span><span class="op" id="6747904">,</span>&nbsp;<span class="string" id="6747906">&#34;unexpected&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="6747928">,</span>&nbsp;<span class="ident" id="6747930">e</span><span class="op" id="6747931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747934">as</span><span class="op" id="6747936">(</span><span class="ident" id="6747937">cpu</span><span class="op" id="6747940">.</span><span class="ident" id="6747941">regs</span><span class="op" id="6747945">[</span><span class="ident" id="6747946">PC</span><span class="op" id="6747948">]</span>&nbsp;<span class="op" id="6747950">==</span>&nbsp;<span class="num" id="6747953">0x8000</span><span class="op" id="6747959">,</span>&nbsp;<span class="string" id="6747961">&#34;pc&nbsp;not&nbsp;iret&#39;ed&#34;</span><span class="op" id="6747977">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6747980">as</span><span class="op" id="6747982">(</span><span class="ident" id="6747983">cpu</span><span class="op" id="6747986">.</span><span class="ident" id="6747987">regs</span><span class="op" id="6747991">[</span><span class="ident" id="6747992">SP</span><span class="op" id="6747994">]</span>&nbsp;<span class="op" id="6747996">==</span>&nbsp;<span class="num" id="6747999">0</span><span class="op" id="6748000">,</span>&nbsp;<span class="string" id="6748002">&#34;sp&nbsp;not&nbsp;restored&#34;</span><span class="op" id="6748019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6748022">as</span><span class="op" id="6748024">(</span><span class="ident" id="6748025">cpu</span><span class="op" id="6748028">.</span><span class="ident" id="6748029">ring</span>&nbsp;<span class="op" id="6748034">==</span>&nbsp;<span class="num" id="6748037">1</span><span class="op" id="6748038">,</span>&nbsp;<span class="string" id="6748040">&#34;ring&nbsp;not&nbsp;restored&#34;</span><span class="op" id="6748059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6748062">as</span><span class="op" id="6748064">(</span><span class="ident" id="6748065">cpu</span><span class="op" id="6748068">.</span><span class="ident" id="6748069">interrupt</span><span class="op" id="6748078">.</span><span class="ident" id="6748079">Enabled</span><span class="op" id="6748086">(</span><span class="op" id="6748087">)</span><span class="op" id="6748088">,</span>&nbsp;<span class="string" id="6748090">&#34;interrupt&nbsp;not&nbsp;enabled&nbsp;again&#34;</span><span class="op" id="6748119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6748122">has</span><span class="op" id="6748125">,</span>&nbsp;<span class="ident" id="6748127">code</span>&nbsp;<span class="op" id="6748132">:=</span>&nbsp;<span class="ident" id="6748135">cpu</span><span class="op" id="6748138">.</span><span class="ident" id="6748139">interrupt</span><span class="op" id="6748148">.</span><span class="ident" id="6748149">Poll</span><span class="op" id="6748153">(</span><span class="op" id="6748154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6748157">as</span><span class="op" id="6748159">(</span><span class="op" id="6748160">!</span><span class="ident" id="6748161">has</span>&nbsp;<span class="op" id="6748165">&amp;&amp;</span>&nbsp;<span class="ident" id="6748168">code</span>&nbsp;<span class="op" id="6748173">==</span>&nbsp;<span class="num" id="6748176">0</span><span class="op" id="6748177">,</span>&nbsp;<span class="string" id="6748179">&#34;interrupt&nbsp;was&nbsp;not&nbsp;cleared&#34;</span><span class="op" id="6748206">)</span><br>
<span class="lineno">80</span><span class="op" id="6748208">}</span>
</div>
</body>
</html>
