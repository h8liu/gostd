<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>expvar</h2>
<ul>
<li><a href="/gostd/expvar/expvar.go.html" class="current">expvar.go</a></li>
<li><a href="/gostd/expvar/expvar_test.go.html">expvar_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5441141">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5441196">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5441250">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5441301">//&nbsp;Package&nbsp;expvar&nbsp;provides&nbsp;a&nbsp;standardized&nbsp;interface&nbsp;to&nbsp;public&nbsp;variables,&nbsp;such</span><br>
<span class="lineno"></span><span class="comment" id="5441379">//&nbsp;as&nbsp;operation&nbsp;counters&nbsp;in&nbsp;servers.&nbsp;It&nbsp;exposes&nbsp;these&nbsp;variables&nbsp;via&nbsp;HTTP&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5441455">//&nbsp;/debug/vars&nbsp;in&nbsp;JSON&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="5441486">//</span><br>
<span class="lineno"></span><span class="comment" id="5441489">//&nbsp;Operations&nbsp;to&nbsp;set&nbsp;or&nbsp;modify&nbsp;these&nbsp;public&nbsp;variables&nbsp;are&nbsp;atomic.</span><br>
<span class="lineno">10</span><span class="comment" id="5441555">//</span><br>
<span class="lineno"></span><span class="comment" id="5441558">//&nbsp;In&nbsp;addition&nbsp;to&nbsp;adding&nbsp;the&nbsp;HTTP&nbsp;handler,&nbsp;this&nbsp;package&nbsp;registers&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5441628">//&nbsp;following&nbsp;variables:</span><br>
<span class="lineno"></span><span class="comment" id="5441652">//</span><br>
<span class="lineno"></span><span class="comment" id="5441655">//&nbsp;&nbsp;&nbsp;&nbsp;cmdline&nbsp;&nbsp;&nbsp;os.Args</span><br>
<span class="lineno">15</span><span class="comment" id="5441676">//&nbsp;&nbsp;&nbsp;&nbsp;memstats&nbsp;&nbsp;runtime.Memstats</span><br>
<span class="lineno"></span><span class="comment" id="5441706">//</span><br>
<span class="lineno"></span><span class="comment" id="5441709">//&nbsp;The&nbsp;package&nbsp;is&nbsp;sometimes&nbsp;only&nbsp;imported&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5441774">//&nbsp;registering&nbsp;its&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;the&nbsp;above&nbsp;variables.&nbsp;&nbsp;To&nbsp;use&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5441842">//&nbsp;this&nbsp;way,&nbsp;link&nbsp;this&nbsp;package&nbsp;into&nbsp;your&nbsp;program:</span><br>
<span class="lineno">20</span><span class="comment" id="5441892">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;_&nbsp;&#34;expvar&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5441913">//</span><br>
<span class="lineno"></span><span class="keyword" id="5441916">package</span>&nbsp;<span class="ident" id="5441924">expvar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5441932">import</span>&nbsp;<span class="op" id="5441939">(</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5441942">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5441951">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5441968">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5441975">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5441982">&#34;net/http&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5441994">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442000">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442011">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442019">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5442030">&#34;sync&#34;</span><br>
<span class="lineno">35</span><span class="op" id="5442037">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5442040">//&nbsp;Var&nbsp;is&nbsp;an&nbsp;abstract&nbsp;type&nbsp;for&nbsp;all&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5442095">type</span>&nbsp;<span class="ident" id="5442100">Var</span>&nbsp;<span class="keyword" id="5442104">interface</span>&nbsp;<span class="op" id="5442114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442117">String</span><span class="op" id="5442123">(</span><span class="op" id="5442124">)</span>&nbsp;<span class="builtintype" id="5442126">string</span><br>
<span class="lineno">40</span><span class="op" id="5442133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5442136">//&nbsp;Int&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;integer&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5442206">type</span>&nbsp;<span class="ident" id="5442211">Int</span>&nbsp;<span class="keyword" id="5442215">struct</span>&nbsp;<span class="op" id="5442222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442225">mu</span>&nbsp;<span class="ident" id="5442228">sync</span><span class="op" id="5442232">.</span><span class="ident" id="5442233">RWMutex</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442242">i</span>&nbsp;&nbsp;<span class="builtintype" id="5442245">int64</span><br>
<span class="lineno"></span><span class="op" id="5442251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5442254">func</span>&nbsp;<span class="op" id="5442259">(</span><span class="ident" id="5442260">v</span>&nbsp;<span class="op" id="5442262">*</span><span class="ident" id="5442263">Int</span><span class="op" id="5442266">)</span>&nbsp;<span class="ident" id="5442268">String</span><span class="op" id="5442274">(</span><span class="op" id="5442275">)</span>&nbsp;<span class="builtintype" id="5442277">string</span>&nbsp;<span class="op" id="5442284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442287">v</span><span class="op" id="5442288">.</span><span class="ident" id="5442289">mu</span><span class="op" id="5442291">.</span><span class="ident" id="5442292">RLock</span><span class="op" id="5442297">(</span><span class="op" id="5442298">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5442301">defer</span>&nbsp;<span class="ident" id="5442307">v</span><span class="op" id="5442308">.</span><span class="ident" id="5442309">mu</span><span class="op" id="5442311">.</span><span class="ident" id="5442312">RUnlock</span><span class="op" id="5442319">(</span><span class="op" id="5442320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5442323">return</span>&nbsp;<span class="ident" id="5442330">strconv</span><span class="op" id="5442337">.</span><span class="ident" id="5442338">FormatInt</span><span class="op" id="5442347">(</span><span class="ident" id="5442348">v</span><span class="op" id="5442349">.</span><span class="ident" id="5442350">i</span><span class="op" id="5442351">,</span>&nbsp;<span class="num" id="5442353">10</span><span class="op" id="5442355">)</span><br>
<span class="lineno"></span><span class="op" id="5442357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5442360">func</span>&nbsp;<span class="op" id="5442365">(</span><span class="ident" id="5442366">v</span>&nbsp;<span class="op" id="5442368">*</span><span class="ident" id="5442369">Int</span><span class="op" id="5442372">)</span>&nbsp;<span class="ident" id="5442374">Add</span><span class="op" id="5442377">(</span><span class="ident" id="5442378">delta</span>&nbsp;<span class="builtintype" id="5442384">int64</span><span class="op" id="5442389">)</span>&nbsp;<span class="op" id="5442391">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442394">v</span><span class="op" id="5442395">.</span><span class="ident" id="5442396">mu</span><span class="op" id="5442398">.</span><span class="ident" id="5442399">Lock</span><span class="op" id="5442403">(</span><span class="op" id="5442404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5442407">defer</span>&nbsp;<span class="ident" id="5442413">v</span><span class="op" id="5442414">.</span><span class="ident" id="5442415">mu</span><span class="op" id="5442417">.</span><span class="ident" id="5442418">Unlock</span><span class="op" id="5442424">(</span><span class="op" id="5442425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442428">v</span><span class="op" id="5442429">.</span><span class="ident" id="5442430">i</span>&nbsp;<span class="op" id="5442432">+=</span>&nbsp;<span class="ident" id="5442435">delta</span><br>
<span class="lineno"></span><span class="op" id="5442441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5442444">func</span>&nbsp;<span class="op" id="5442449">(</span><span class="ident" id="5442450">v</span>&nbsp;<span class="op" id="5442452">*</span><span class="ident" id="5442453">Int</span><span class="op" id="5442456">)</span>&nbsp;<span class="ident" id="5442458">Set</span><span class="op" id="5442461">(</span><span class="ident" id="5442462">value</span>&nbsp;<span class="builtintype" id="5442468">int64</span><span class="op" id="5442473">)</span>&nbsp;<span class="op" id="5442475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442478">v</span><span class="op" id="5442479">.</span><span class="ident" id="5442480">mu</span><span class="op" id="5442482">.</span><span class="ident" id="5442483">Lock</span><span class="op" id="5442487">(</span><span class="op" id="5442488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5442491">defer</span>&nbsp;<span class="ident" id="5442497">v</span><span class="op" id="5442498">.</span><span class="ident" id="5442499">mu</span><span class="op" id="5442501">.</span><span class="ident" id="5442502">Unlock</span><span class="op" id="5442508">(</span><span class="op" id="5442509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442512">v</span><span class="op" id="5442513">.</span><span class="ident" id="5442514">i</span>&nbsp;<span class="op" id="5442516">=</span>&nbsp;<span class="ident" id="5442518">value</span><br>
<span class="lineno"></span><span class="op" id="5442524">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="5442527">//&nbsp;Float&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;float&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5442597">type</span>&nbsp;<span class="ident" id="5442602">Float</span>&nbsp;<span class="keyword" id="5442608">struct</span>&nbsp;<span class="op" id="5442615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442618">mu</span>&nbsp;<span class="ident" id="5442621">sync</span><span class="op" id="5442625">.</span><span class="ident" id="5442626">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442635">f</span>&nbsp;&nbsp;<span class="builtintype" id="5442638">float64</span><br>
<span class="lineno">70</span><span class="op" id="5442646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5442649">func</span>&nbsp;<span class="op" id="5442654">(</span><span class="ident" id="5442655">v</span>&nbsp;<span class="op" id="5442657">*</span><span class="ident" id="5442658">Float</span><span class="op" id="5442663">)</span>&nbsp;<span class="ident" id="5442665">String</span><span class="op" id="5442671">(</span><span class="op" id="5442672">)</span>&nbsp;<span class="builtintype" id="5442674">string</span>&nbsp;<span class="op" id="5442681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442684">v</span><span class="op" id="5442685">.</span><span class="ident" id="5442686">mu</span><span class="op" id="5442688">.</span><span class="ident" id="5442689">RLock</span><span class="op" id="5442694">(</span><span class="op" id="5442695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5442698">defer</span>&nbsp;<span class="ident" id="5442704">v</span><span class="op" id="5442705">.</span><span class="ident" id="5442706">mu</span><span class="op" id="5442708">.</span><span class="ident" id="5442709">RUnlock</span><span class="op" id="5442716">(</span><span class="op" id="5442717">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5442720">return</span>&nbsp;<span class="ident" id="5442727">strconv</span><span class="op" id="5442734">.</span><span class="ident" id="5442735">FormatFloat</span><span class="op" id="5442746">(</span><span class="ident" id="5442747">v</span><span class="op" id="5442748">.</span><span class="ident" id="5442749">f</span><span class="op" id="5442750">,</span>&nbsp;<span class="string" id="5442752">&#39;g&#39;</span><span class="op" id="5442755">,</span>&nbsp;<span class="op" id="5442757">-</span><span class="num" id="5442758">1</span><span class="op" id="5442759">,</span>&nbsp;<span class="num" id="5442761">64</span><span class="op" id="5442763">)</span><br>
<span class="lineno"></span><span class="op" id="5442765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5442768">//&nbsp;Add&nbsp;adds&nbsp;delta&nbsp;to&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5442792">func</span>&nbsp;<span class="op" id="5442797">(</span><span class="ident" id="5442798">v</span>&nbsp;<span class="op" id="5442800">*</span><span class="ident" id="5442801">Float</span><span class="op" id="5442806">)</span>&nbsp;<span class="ident" id="5442808">Add</span><span class="op" id="5442811">(</span><span class="ident" id="5442812">delta</span>&nbsp;<span class="builtintype" id="5442818">float64</span><span class="op" id="5442825">)</span>&nbsp;<span class="op" id="5442827">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442830">v</span><span class="op" id="5442831">.</span><span class="ident" id="5442832">mu</span><span class="op" id="5442834">.</span><span class="ident" id="5442835">Lock</span><span class="op" id="5442839">(</span><span class="op" id="5442840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5442843">defer</span>&nbsp;<span class="ident" id="5442849">v</span><span class="op" id="5442850">.</span><span class="ident" id="5442851">mu</span><span class="op" id="5442853">.</span><span class="ident" id="5442854">Unlock</span><span class="op" id="5442860">(</span><span class="op" id="5442861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442864">v</span><span class="op" id="5442865">.</span><span class="ident" id="5442866">f</span>&nbsp;<span class="op" id="5442868">+=</span>&nbsp;<span class="ident" id="5442871">delta</span><br>
<span class="lineno"></span><span class="op" id="5442877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="5442880">//&nbsp;Set&nbsp;sets&nbsp;v&nbsp;to&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5442904">func</span>&nbsp;<span class="op" id="5442909">(</span><span class="ident" id="5442910">v</span>&nbsp;<span class="op" id="5442912">*</span><span class="ident" id="5442913">Float</span><span class="op" id="5442918">)</span>&nbsp;<span class="ident" id="5442920">Set</span><span class="op" id="5442923">(</span><span class="ident" id="5442924">value</span>&nbsp;<span class="builtintype" id="5442930">float64</span><span class="op" id="5442937">)</span>&nbsp;<span class="op" id="5442939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442942">v</span><span class="op" id="5442943">.</span><span class="ident" id="5442944">mu</span><span class="op" id="5442946">.</span><span class="ident" id="5442947">Lock</span><span class="op" id="5442951">(</span><span class="op" id="5442952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5442955">defer</span>&nbsp;<span class="ident" id="5442961">v</span><span class="op" id="5442962">.</span><span class="ident" id="5442963">mu</span><span class="op" id="5442965">.</span><span class="ident" id="5442966">Unlock</span><span class="op" id="5442972">(</span><span class="op" id="5442973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5442976">v</span><span class="op" id="5442977">.</span><span class="ident" id="5442978">f</span>&nbsp;<span class="op" id="5442980">=</span>&nbsp;<span class="ident" id="5442982">value</span><br>
<span class="lineno">90</span><span class="op" id="5442988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5442991">//&nbsp;Map&nbsp;is&nbsp;a&nbsp;string-to-Var&nbsp;map&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5443064">type</span>&nbsp;<span class="ident" id="5443069">Map</span>&nbsp;<span class="keyword" id="5443073">struct</span>&nbsp;<span class="op" id="5443080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443083">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5443088">sync</span><span class="op" id="5443092">.</span><span class="ident" id="5443093">RWMutex</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443102">m</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5443107">map</span><span class="op" id="5443110">[</span><span class="builtintype" id="5443111">string</span><span class="op" id="5443117">]</span><span class="ident" id="5443118">Var</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443123">keys</span>&nbsp;<span class="op" id="5443128">[</span><span class="op" id="5443129">]</span><span class="builtintype" id="5443130">string</span>&nbsp;<span class="comment" id="5443137">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5443147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5443150">//&nbsp;KeyValue&nbsp;represents&nbsp;a&nbsp;single&nbsp;entry&nbsp;in&nbsp;a&nbsp;Map.</span><br>
<span class="lineno">100</span><span class="keyword" id="5443198">type</span>&nbsp;<span class="ident" id="5443203">KeyValue</span>&nbsp;<span class="keyword" id="5443212">struct</span>&nbsp;<span class="op" id="5443219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443222">Key</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5443228">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443236">Value</span>&nbsp;<span class="ident" id="5443242">Var</span><br>
<span class="lineno"></span><span class="op" id="5443246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="5443249">func</span>&nbsp;<span class="op" id="5443254">(</span><span class="ident" id="5443255">v</span>&nbsp;<span class="op" id="5443257">*</span><span class="ident" id="5443258">Map</span><span class="op" id="5443261">)</span>&nbsp;<span class="ident" id="5443263">String</span><span class="op" id="5443269">(</span><span class="op" id="5443270">)</span>&nbsp;<span class="builtintype" id="5443272">string</span>&nbsp;<span class="op" id="5443279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443282">v</span><span class="op" id="5443283">.</span><span class="ident" id="5443284">mu</span><span class="op" id="5443286">.</span><span class="ident" id="5443287">RLock</span><span class="op" id="5443292">(</span><span class="op" id="5443293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5443296">defer</span>&nbsp;<span class="ident" id="5443302">v</span><span class="op" id="5443303">.</span><span class="ident" id="5443304">mu</span><span class="op" id="5443306">.</span><span class="ident" id="5443307">RUnlock</span><span class="op" id="5443314">(</span><span class="op" id="5443315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5443318">var</span>&nbsp;<span class="ident" id="5443322">b</span>&nbsp;<span class="ident" id="5443324">bytes</span><span class="op" id="5443329">.</span><span class="ident" id="5443330">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443338">fmt</span><span class="op" id="5443341">.</span><span class="ident" id="5443342">Fprintf</span><span class="op" id="5443349">(</span><span class="op" id="5443350">&amp;</span><span class="ident" id="5443351">b</span><span class="op" id="5443352">,</span>&nbsp;<span class="string" id="5443354">&#34;{&#34;</span><span class="op" id="5443357">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443360">first</span>&nbsp;<span class="op" id="5443366">:=</span>&nbsp;<span class="builtintype" id="5443369">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443375">v</span><span class="op" id="5443376">.</span><span class="ident" id="5443377">doLocked</span><span class="op" id="5443385">(</span><span class="keyword" id="5443386">func</span><span class="op" id="5443390">(</span><span class="ident" id="5443391">kv</span>&nbsp;<span class="ident" id="5443394">KeyValue</span><span class="op" id="5443402">)</span>&nbsp;<span class="op" id="5443404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5443408">if</span>&nbsp;<span class="op" id="5443411">!</span><span class="ident" id="5443412">first</span>&nbsp;<span class="op" id="5443418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443423">fmt</span><span class="op" id="5443426">.</span><span class="ident" id="5443427">Fprintf</span><span class="op" id="5443434">(</span><span class="op" id="5443435">&amp;</span><span class="ident" id="5443436">b</span><span class="op" id="5443437">,</span>&nbsp;<span class="string" id="5443439">&#34;,&nbsp;&#34;</span><span class="op" id="5443443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5443447">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443451">fmt</span><span class="op" id="5443454">.</span><span class="ident" id="5443455">Fprintf</span><span class="op" id="5443462">(</span><span class="op" id="5443463">&amp;</span><span class="ident" id="5443464">b</span><span class="op" id="5443465">,</span>&nbsp;<span class="string" id="5443467">&#34;%q:&nbsp;%v&#34;</span><span class="op" id="5443475">,</span>&nbsp;<span class="ident" id="5443477">kv</span><span class="op" id="5443479">.</span><span class="ident" id="5443480">Key</span><span class="op" id="5443483">,</span>&nbsp;<span class="ident" id="5443485">kv</span><span class="op" id="5443487">.</span><span class="ident" id="5443488">Value</span><span class="op" id="5443493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443497">first</span>&nbsp;<span class="op" id="5443503">=</span>&nbsp;<span class="builtintype" id="5443505">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5443512">}</span><span class="op" id="5443513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443516">fmt</span><span class="op" id="5443519">.</span><span class="ident" id="5443520">Fprintf</span><span class="op" id="5443527">(</span><span class="op" id="5443528">&amp;</span><span class="ident" id="5443529">b</span><span class="op" id="5443530">,</span>&nbsp;<span class="string" id="5443532">&#34;}&#34;</span><span class="op" id="5443535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5443538">return</span>&nbsp;<span class="ident" id="5443545">b</span><span class="op" id="5443546">.</span><span class="ident" id="5443547">String</span><span class="op" id="5443553">(</span><span class="op" id="5443554">)</span><br>
<span class="lineno">120</span><span class="op" id="5443556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5443559">func</span>&nbsp;<span class="op" id="5443564">(</span><span class="ident" id="5443565">v</span>&nbsp;<span class="op" id="5443567">*</span><span class="ident" id="5443568">Map</span><span class="op" id="5443571">)</span>&nbsp;<span class="ident" id="5443573">Init</span><span class="op" id="5443577">(</span><span class="op" id="5443578">)</span>&nbsp;<span class="op" id="5443580">*</span><span class="ident" id="5443581">Map</span>&nbsp;<span class="op" id="5443585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443588">v</span><span class="op" id="5443589">.</span><span class="ident" id="5443590">m</span>&nbsp;<span class="op" id="5443592">=</span>&nbsp;<span class="builtinfunc" id="5443594">make</span><span class="op" id="5443598">(</span><span class="keyword" id="5443599">map</span><span class="op" id="5443602">[</span><span class="builtintype" id="5443603">string</span><span class="op" id="5443609">]</span><span class="ident" id="5443610">Var</span><span class="op" id="5443613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5443616">return</span>&nbsp;<span class="ident" id="5443623">v</span><br>
<span class="lineno">125</span><span class="op" id="5443625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5443628">//&nbsp;updateKeys&nbsp;updates&nbsp;the&nbsp;sorted&nbsp;list&nbsp;of&nbsp;keys&nbsp;in&nbsp;v.keys.</span><br>
<span class="lineno"></span><span class="comment" id="5443685">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;v.mu&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5443719">func</span>&nbsp;<span class="op" id="5443724">(</span><span class="ident" id="5443725">v</span>&nbsp;<span class="op" id="5443727">*</span><span class="ident" id="5443728">Map</span><span class="op" id="5443731">)</span>&nbsp;<span class="ident" id="5443733">updateKeys</span><span class="op" id="5443743">(</span><span class="op" id="5443744">)</span>&nbsp;<span class="op" id="5443746">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5443749">if</span>&nbsp;<span class="builtinfunc" id="5443752">len</span><span class="op" id="5443755">(</span><span class="ident" id="5443756">v</span><span class="op" id="5443757">.</span><span class="ident" id="5443758">m</span><span class="op" id="5443759">)</span>&nbsp;<span class="op" id="5443761">==</span>&nbsp;<span class="builtinfunc" id="5443764">len</span><span class="op" id="5443767">(</span><span class="ident" id="5443768">v</span><span class="op" id="5443769">.</span><span class="ident" id="5443770">keys</span><span class="op" id="5443774">)</span>&nbsp;<span class="op" id="5443776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5443780">//&nbsp;No&nbsp;new&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5443797">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5443805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443808">v</span><span class="op" id="5443809">.</span><span class="ident" id="5443810">keys</span>&nbsp;<span class="op" id="5443815">=</span>&nbsp;<span class="ident" id="5443817">v</span><span class="op" id="5443818">.</span><span class="ident" id="5443819">keys</span><span class="op" id="5443823">[</span><span class="op" id="5443824">:</span><span class="num" id="5443825">0</span><span class="op" id="5443826">]</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5443829">for</span>&nbsp;<span class="ident" id="5443833">k</span>&nbsp;<span class="op" id="5443835">:=</span>&nbsp;<span class="keyword" id="5443838">range</span>&nbsp;<span class="ident" id="5443844">v</span><span class="op" id="5443845">.</span><span class="ident" id="5443846">m</span>&nbsp;<span class="op" id="5443848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443852">v</span><span class="op" id="5443853">.</span><span class="ident" id="5443854">keys</span>&nbsp;<span class="op" id="5443859">=</span>&nbsp;<span class="builtinfunc" id="5443861">append</span><span class="op" id="5443867">(</span><span class="ident" id="5443868">v</span><span class="op" id="5443869">.</span><span class="ident" id="5443870">keys</span><span class="op" id="5443874">,</span>&nbsp;<span class="ident" id="5443876">k</span><span class="op" id="5443877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5443880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443883">sort</span><span class="op" id="5443887">.</span><span class="ident" id="5443888">Strings</span><span class="op" id="5443895">(</span><span class="ident" id="5443896">v</span><span class="op" id="5443897">.</span><span class="ident" id="5443898">keys</span><span class="op" id="5443902">)</span><br>
<span class="lineno"></span><span class="op" id="5443904">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="5443907">func</span>&nbsp;<span class="op" id="5443912">(</span><span class="ident" id="5443913">v</span>&nbsp;<span class="op" id="5443915">*</span><span class="ident" id="5443916">Map</span><span class="op" id="5443919">)</span>&nbsp;<span class="ident" id="5443921">Get</span><span class="op" id="5443924">(</span><span class="ident" id="5443925">key</span>&nbsp;<span class="builtintype" id="5443929">string</span><span class="op" id="5443935">)</span>&nbsp;<span class="ident" id="5443937">Var</span>&nbsp;<span class="op" id="5443941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5443944">v</span><span class="op" id="5443945">.</span><span class="ident" id="5443946">mu</span><span class="op" id="5443948">.</span><span class="ident" id="5443949">RLock</span><span class="op" id="5443954">(</span><span class="op" id="5443955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5443958">defer</span>&nbsp;<span class="ident" id="5443964">v</span><span class="op" id="5443965">.</span><span class="ident" id="5443966">mu</span><span class="op" id="5443968">.</span><span class="ident" id="5443969">RUnlock</span><span class="op" id="5443976">(</span><span class="op" id="5443977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5443980">return</span>&nbsp;<span class="ident" id="5443987">v</span><span class="op" id="5443988">.</span><span class="ident" id="5443989">m</span><span class="op" id="5443990">[</span><span class="ident" id="5443991">key</span><span class="op" id="5443994">]</span><br>
<span class="lineno">145</span><span class="op" id="5443996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5443999">func</span>&nbsp;<span class="op" id="5444004">(</span><span class="ident" id="5444005">v</span>&nbsp;<span class="op" id="5444007">*</span><span class="ident" id="5444008">Map</span><span class="op" id="5444011">)</span>&nbsp;<span class="ident" id="5444013">Set</span><span class="op" id="5444016">(</span><span class="ident" id="5444017">key</span>&nbsp;<span class="builtintype" id="5444021">string</span><span class="op" id="5444027">,</span>&nbsp;<span class="ident" id="5444029">av</span>&nbsp;<span class="ident" id="5444032">Var</span><span class="op" id="5444035">)</span>&nbsp;<span class="op" id="5444037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444040">v</span><span class="op" id="5444041">.</span><span class="ident" id="5444042">mu</span><span class="op" id="5444044">.</span><span class="ident" id="5444045">Lock</span><span class="op" id="5444049">(</span><span class="op" id="5444050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5444053">defer</span>&nbsp;<span class="ident" id="5444059">v</span><span class="op" id="5444060">.</span><span class="ident" id="5444061">mu</span><span class="op" id="5444063">.</span><span class="ident" id="5444064">Unlock</span><span class="op" id="5444070">(</span><span class="op" id="5444071">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444074">v</span><span class="op" id="5444075">.</span><span class="ident" id="5444076">m</span><span class="op" id="5444077">[</span><span class="ident" id="5444078">key</span><span class="op" id="5444081">]</span>&nbsp;<span class="op" id="5444083">=</span>&nbsp;<span class="ident" id="5444085">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444089">v</span><span class="op" id="5444090">.</span><span class="ident" id="5444091">updateKeys</span><span class="op" id="5444101">(</span><span class="op" id="5444102">)</span><br>
<span class="lineno"></span><span class="op" id="5444104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5444107">func</span>&nbsp;<span class="op" id="5444112">(</span><span class="ident" id="5444113">v</span>&nbsp;<span class="op" id="5444115">*</span><span class="ident" id="5444116">Map</span><span class="op" id="5444119">)</span>&nbsp;<span class="ident" id="5444121">Add</span><span class="op" id="5444124">(</span><span class="ident" id="5444125">key</span>&nbsp;<span class="builtintype" id="5444129">string</span><span class="op" id="5444135">,</span>&nbsp;<span class="ident" id="5444137">delta</span>&nbsp;<span class="builtintype" id="5444143">int64</span><span class="op" id="5444148">)</span>&nbsp;<span class="op" id="5444150">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444153">v</span><span class="op" id="5444154">.</span><span class="ident" id="5444155">mu</span><span class="op" id="5444157">.</span><span class="ident" id="5444158">RLock</span><span class="op" id="5444163">(</span><span class="op" id="5444164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444167">av</span><span class="op" id="5444169">,</span>&nbsp;<span class="ident" id="5444171">ok</span>&nbsp;<span class="op" id="5444174">:=</span>&nbsp;<span class="ident" id="5444177">v</span><span class="op" id="5444178">.</span><span class="ident" id="5444179">m</span><span class="op" id="5444180">[</span><span class="ident" id="5444181">key</span><span class="op" id="5444184">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444187">v</span><span class="op" id="5444188">.</span><span class="ident" id="5444189">mu</span><span class="op" id="5444191">.</span><span class="ident" id="5444192">RUnlock</span><span class="op" id="5444199">(</span><span class="op" id="5444200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5444203">if</span>&nbsp;<span class="op" id="5444206">!</span><span class="ident" id="5444207">ok</span>&nbsp;<span class="op" id="5444210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5444214">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444252">v</span><span class="op" id="5444253">.</span><span class="ident" id="5444254">mu</span><span class="op" id="5444256">.</span><span class="ident" id="5444257">Lock</span><span class="op" id="5444261">(</span><span class="op" id="5444262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444266">av</span><span class="op" id="5444268">,</span>&nbsp;<span class="ident" id="5444270">ok</span>&nbsp;<span class="op" id="5444273">=</span>&nbsp;<span class="ident" id="5444275">v</span><span class="op" id="5444276">.</span><span class="ident" id="5444277">m</span><span class="op" id="5444278">[</span><span class="ident" id="5444279">key</span><span class="op" id="5444282">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5444286">if</span>&nbsp;<span class="op" id="5444289">!</span><span class="ident" id="5444290">ok</span>&nbsp;<span class="op" id="5444293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444298">av</span>&nbsp;<span class="op" id="5444301">=</span>&nbsp;<span class="builtinfunc" id="5444303">new</span><span class="op" id="5444306">(</span><span class="ident" id="5444307">Int</span><span class="op" id="5444310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444315">v</span><span class="op" id="5444316">.</span><span class="ident" id="5444317">m</span><span class="op" id="5444318">[</span><span class="ident" id="5444319">key</span><span class="op" id="5444322">]</span>&nbsp;<span class="op" id="5444324">=</span>&nbsp;<span class="ident" id="5444326">av</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444332">v</span><span class="op" id="5444333">.</span><span class="ident" id="5444334">updateKeys</span><span class="op" id="5444344">(</span><span class="op" id="5444345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5444349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444353">v</span><span class="op" id="5444354">.</span><span class="ident" id="5444355">mu</span><span class="op" id="5444357">.</span><span class="ident" id="5444358">Unlock</span><span class="op" id="5444364">(</span><span class="op" id="5444365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5444368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5444372">//&nbsp;Add&nbsp;to&nbsp;Int;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5444406">if</span>&nbsp;<span class="ident" id="5444409">iv</span><span class="op" id="5444411">,</span>&nbsp;<span class="ident" id="5444413">ok</span>&nbsp;<span class="op" id="5444416">:=</span>&nbsp;<span class="ident" id="5444419">av</span><span class="op" id="5444421">.</span><span class="op" id="5444422">(</span><span class="op" id="5444423">*</span><span class="ident" id="5444424">Int</span><span class="op" id="5444427">)</span><span class="op" id="5444428">;</span>&nbsp;<span class="ident" id="5444430">ok</span>&nbsp;<span class="op" id="5444433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444437">iv</span><span class="op" id="5444439">.</span><span class="ident" id="5444440">Add</span><span class="op" id="5444443">(</span><span class="ident" id="5444444">delta</span><span class="op" id="5444449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5444452">}</span><br>
<span class="lineno"></span><span class="op" id="5444454">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment" id="5444457">//&nbsp;AddFloat&nbsp;adds&nbsp;delta&nbsp;to&nbsp;the&nbsp;*Float&nbsp;value&nbsp;stored&nbsp;under&nbsp;the&nbsp;given&nbsp;map&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="5444532">func</span>&nbsp;<span class="op" id="5444537">(</span><span class="ident" id="5444538">v</span>&nbsp;<span class="op" id="5444540">*</span><span class="ident" id="5444541">Map</span><span class="op" id="5444544">)</span>&nbsp;<span class="ident" id="5444546">AddFloat</span><span class="op" id="5444554">(</span><span class="ident" id="5444555">key</span>&nbsp;<span class="builtintype" id="5444559">string</span><span class="op" id="5444565">,</span>&nbsp;<span class="ident" id="5444567">delta</span>&nbsp;<span class="builtintype" id="5444573">float64</span><span class="op" id="5444580">)</span>&nbsp;<span class="op" id="5444582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444585">v</span><span class="op" id="5444586">.</span><span class="ident" id="5444587">mu</span><span class="op" id="5444589">.</span><span class="ident" id="5444590">RLock</span><span class="op" id="5444595">(</span><span class="op" id="5444596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444599">av</span><span class="op" id="5444601">,</span>&nbsp;<span class="ident" id="5444603">ok</span>&nbsp;<span class="op" id="5444606">:=</span>&nbsp;<span class="ident" id="5444609">v</span><span class="op" id="5444610">.</span><span class="ident" id="5444611">m</span><span class="op" id="5444612">[</span><span class="ident" id="5444613">key</span><span class="op" id="5444616">]</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444619">v</span><span class="op" id="5444620">.</span><span class="ident" id="5444621">mu</span><span class="op" id="5444623">.</span><span class="ident" id="5444624">RUnlock</span><span class="op" id="5444631">(</span><span class="op" id="5444632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5444635">if</span>&nbsp;<span class="op" id="5444638">!</span><span class="ident" id="5444639">ok</span>&nbsp;<span class="op" id="5444642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5444646">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444684">v</span><span class="op" id="5444685">.</span><span class="ident" id="5444686">mu</span><span class="op" id="5444688">.</span><span class="ident" id="5444689">Lock</span><span class="op" id="5444693">(</span><span class="op" id="5444694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444698">av</span><span class="op" id="5444700">,</span>&nbsp;<span class="ident" id="5444702">ok</span>&nbsp;<span class="op" id="5444705">=</span>&nbsp;<span class="ident" id="5444707">v</span><span class="op" id="5444708">.</span><span class="ident" id="5444709">m</span><span class="op" id="5444710">[</span><span class="ident" id="5444711">key</span><span class="op" id="5444714">]</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5444718">if</span>&nbsp;<span class="op" id="5444721">!</span><span class="ident" id="5444722">ok</span>&nbsp;<span class="op" id="5444725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444730">av</span>&nbsp;<span class="op" id="5444733">=</span>&nbsp;<span class="builtinfunc" id="5444735">new</span><span class="op" id="5444738">(</span><span class="ident" id="5444739">Float</span><span class="op" id="5444744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444749">v</span><span class="op" id="5444750">.</span><span class="ident" id="5444751">m</span><span class="op" id="5444752">[</span><span class="ident" id="5444753">key</span><span class="op" id="5444756">]</span>&nbsp;<span class="op" id="5444758">=</span>&nbsp;<span class="ident" id="5444760">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444766">v</span><span class="op" id="5444767">.</span><span class="ident" id="5444768">updateKeys</span><span class="op" id="5444778">(</span><span class="op" id="5444779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5444783">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444787">v</span><span class="op" id="5444788">.</span><span class="ident" id="5444789">mu</span><span class="op" id="5444791">.</span><span class="ident" id="5444792">Unlock</span><span class="op" id="5444798">(</span><span class="op" id="5444799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5444802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5444806">//&nbsp;Add&nbsp;to&nbsp;Float;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5444842">if</span>&nbsp;<span class="ident" id="5444845">iv</span><span class="op" id="5444847">,</span>&nbsp;<span class="ident" id="5444849">ok</span>&nbsp;<span class="op" id="5444852">:=</span>&nbsp;<span class="ident" id="5444855">av</span><span class="op" id="5444857">.</span><span class="op" id="5444858">(</span><span class="op" id="5444859">*</span><span class="ident" id="5444860">Float</span><span class="op" id="5444865">)</span><span class="op" id="5444866">;</span>&nbsp;<span class="ident" id="5444868">ok</span>&nbsp;<span class="op" id="5444871">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5444875">iv</span><span class="op" id="5444877">.</span><span class="ident" id="5444878">Add</span><span class="op" id="5444881">(</span><span class="ident" id="5444882">delta</span><span class="op" id="5444887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5444890">}</span><br>
<span class="lineno"></span><span class="op" id="5444892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5444895">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">200</span><span class="comment" id="5444936">//&nbsp;The&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5444979">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5445032">func</span>&nbsp;<span class="op" id="5445037">(</span><span class="ident" id="5445038">v</span>&nbsp;<span class="op" id="5445040">*</span><span class="ident" id="5445041">Map</span><span class="op" id="5445044">)</span>&nbsp;<span class="ident" id="5445046">Do</span><span class="op" id="5445048">(</span><span class="ident" id="5445049">f</span>&nbsp;<span class="keyword" id="5445051">func</span><span class="op" id="5445055">(</span><span class="ident" id="5445056">KeyValue</span><span class="op" id="5445064">)</span><span class="op" id="5445065">)</span>&nbsp;<span class="op" id="5445067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5445070">v</span><span class="op" id="5445071">.</span><span class="ident" id="5445072">mu</span><span class="op" id="5445074">.</span><span class="ident" id="5445075">RLock</span><span class="op" id="5445080">(</span><span class="op" id="5445081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5445084">defer</span>&nbsp;<span class="ident" id="5445090">v</span><span class="op" id="5445091">.</span><span class="ident" id="5445092">mu</span><span class="op" id="5445094">.</span><span class="ident" id="5445095">RUnlock</span><span class="op" id="5445102">(</span><span class="op" id="5445103">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5445106">v</span><span class="op" id="5445107">.</span><span class="ident" id="5445108">doLocked</span><span class="op" id="5445116">(</span><span class="ident" id="5445117">f</span><span class="op" id="5445118">)</span><br>
<span class="lineno"></span><span class="op" id="5445120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5445123">//&nbsp;doLocked&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="5445170">//&nbsp;v.mu&nbsp;must&nbsp;be&nbsp;held&nbsp;for&nbsp;reads.</span><br>
<span class="lineno">210</span><span class="keyword" id="5445202">func</span>&nbsp;<span class="op" id="5445207">(</span><span class="ident" id="5445208">v</span>&nbsp;<span class="op" id="5445210">*</span><span class="ident" id="5445211">Map</span><span class="op" id="5445214">)</span>&nbsp;<span class="ident" id="5445216">doLocked</span><span class="op" id="5445224">(</span><span class="ident" id="5445225">f</span>&nbsp;<span class="keyword" id="5445227">func</span><span class="op" id="5445231">(</span><span class="ident" id="5445232">KeyValue</span><span class="op" id="5445240">)</span><span class="op" id="5445241">)</span>&nbsp;<span class="op" id="5445243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5445246">for</span>&nbsp;<span class="ident" id="5445250">_</span><span class="op" id="5445251">,</span>&nbsp;<span class="ident" id="5445253">k</span>&nbsp;<span class="op" id="5445255">:=</span>&nbsp;<span class="keyword" id="5445258">range</span>&nbsp;<span class="ident" id="5445264">v</span><span class="op" id="5445265">.</span><span class="ident" id="5445266">keys</span>&nbsp;<span class="op" id="5445271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5445275">f</span><span class="op" id="5445276">(</span><span class="ident" id="5445277">KeyValue</span><span class="op" id="5445285">{</span><span class="ident" id="5445286">k</span><span class="op" id="5445287">,</span>&nbsp;<span class="ident" id="5445289">v</span><span class="op" id="5445290">.</span><span class="ident" id="5445291">m</span><span class="op" id="5445292">[</span><span class="ident" id="5445293">k</span><span class="op" id="5445294">]</span><span class="op" id="5445295">}</span><span class="op" id="5445296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5445299">}</span><br>
<span class="lineno"></span><span class="op" id="5445301">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="5445304">//&nbsp;String&nbsp;is&nbsp;a&nbsp;string&nbsp;variable,&nbsp;and&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5445369">type</span>&nbsp;<span class="ident" id="5445374">String</span>&nbsp;<span class="keyword" id="5445381">struct</span>&nbsp;<span class="op" id="5445388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5445391">mu</span>&nbsp;<span class="ident" id="5445394">sync</span><span class="op" id="5445398">.</span><span class="ident" id="5445399">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5445408">s</span>&nbsp;&nbsp;<span class="builtintype" id="5445411">string</span><br>
<span class="lineno">220</span><span class="op" id="5445418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5445421">func</span>&nbsp;<span class="op" id="5445426">(</span><span class="ident" id="5445427">v</span>&nbsp;<span class="op" id="5445429">*</span><span class="ident" id="5445430">String</span><span class="op" id="5445436">)</span>&nbsp;<span class="ident" id="5445438">String</span><span class="op" id="5445444">(</span><span class="op" id="5445445">)</span>&nbsp;<span class="builtintype" id="5445447">string</span>&nbsp;<span class="op" id="5445454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5445457">v</span><span class="op" id="5445458">.</span><span class="ident" id="5445459">mu</span><span class="op" id="5445461">.</span><span class="ident" id="5445462">RLock</span><span class="op" id="5445467">(</span><span class="op" id="5445468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5445471">defer</span>&nbsp;<span class="ident" id="5445477">v</span><span class="op" id="5445478">.</span><span class="ident" id="5445479">mu</span><span class="op" id="5445481">.</span><span class="ident" id="5445482">RUnlock</span><span class="op" id="5445489">(</span><span class="op" id="5445490">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5445493">return</span>&nbsp;<span class="ident" id="5445500">strconv</span><span class="op" id="5445507">.</span><span class="ident" id="5445508">Quote</span><span class="op" id="5445513">(</span><span class="ident" id="5445514">v</span><span class="op" id="5445515">.</span><span class="ident" id="5445516">s</span><span class="op" id="5445517">)</span><br>
<span class="lineno"></span><span class="op" id="5445519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5445522">func</span>&nbsp;<span class="op" id="5445527">(</span><span class="ident" id="5445528">v</span>&nbsp;<span class="op" id="5445530">*</span><span class="ident" id="5445531">String</span><span class="op" id="5445537">)</span>&nbsp;<span class="ident" id="5445539">Set</span><span class="op" id="5445542">(</span><span class="ident" id="5445543">value</span>&nbsp;<span class="builtintype" id="5445549">string</span><span class="op" id="5445555">)</span>&nbsp;<span class="op" id="5445557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5445560">v</span><span class="op" id="5445561">.</span><span class="ident" id="5445562">mu</span><span class="op" id="5445564">.</span><span class="ident" id="5445565">Lock</span><span class="op" id="5445569">(</span><span class="op" id="5445570">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5445573">defer</span>&nbsp;<span class="ident" id="5445579">v</span><span class="op" id="5445580">.</span><span class="ident" id="5445581">mu</span><span class="op" id="5445583">.</span><span class="ident" id="5445584">Unlock</span><span class="op" id="5445590">(</span><span class="op" id="5445591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5445594">v</span><span class="op" id="5445595">.</span><span class="ident" id="5445596">s</span>&nbsp;<span class="op" id="5445598">=</span>&nbsp;<span class="ident" id="5445600">value</span><br>
<span class="lineno"></span><span class="op" id="5445606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5445609">//&nbsp;Func&nbsp;implements&nbsp;Var&nbsp;by&nbsp;calling&nbsp;the&nbsp;function</span><br>
<span class="lineno">235</span><span class="comment" id="5445656">//&nbsp;and&nbsp;formatting&nbsp;the&nbsp;returned&nbsp;value&nbsp;using&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="5445705">type</span>&nbsp;<span class="ident" id="5445710">Func</span>&nbsp;<span class="keyword" id="5445715">func</span><span class="op" id="5445719">(</span><span class="op" id="5445720">)</span>&nbsp;<span class="keyword" id="5445722">interface</span><span class="op" id="5445731">{</span><span class="op" id="5445732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5445735">func</span>&nbsp;<span class="op" id="5445740">(</span><span class="ident" id="5445741">f</span>&nbsp;<span class="ident" id="5445743">Func</span><span class="op" id="5445747">)</span>&nbsp;<span class="ident" id="5445749">String</span><span class="op" id="5445755">(</span><span class="op" id="5445756">)</span>&nbsp;<span class="builtintype" id="5445758">string</span>&nbsp;<span class="op" id="5445765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5445768">v</span><span class="op" id="5445769">,</span>&nbsp;<span class="ident" id="5445771">_</span>&nbsp;<span class="op" id="5445773">:=</span>&nbsp;<span class="ident" id="5445776">json</span><span class="op" id="5445780">.</span><span class="ident" id="5445781">Marshal</span><span class="op" id="5445788">(</span><span class="ident" id="5445789">f</span><span class="op" id="5445790">(</span><span class="op" id="5445791">)</span><span class="op" id="5445792">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5445795">return</span>&nbsp;<span class="builtintype" id="5445802">string</span><span class="op" id="5445808">(</span><span class="ident" id="5445809">v</span><span class="op" id="5445810">)</span><br>
<span class="lineno"></span><span class="op" id="5445812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5445815">//&nbsp;All&nbsp;published&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5445843">var</span>&nbsp;<span class="op" id="5445847">(</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5445850">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5445858">sync</span><span class="op" id="5445862">.</span><span class="ident" id="5445863">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5445872">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5445880">=</span>&nbsp;<span class="builtinfunc" id="5445882">make</span><span class="op" id="5445886">(</span><span class="keyword" id="5445887">map</span><span class="op" id="5445890">[</span><span class="builtintype" id="5445891">string</span><span class="op" id="5445897">]</span><span class="ident" id="5445898">Var</span><span class="op" id="5445901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5445904">varKeys</span>&nbsp;<span class="op" id="5445912">[</span><span class="op" id="5445913">]</span><span class="builtintype" id="5445914">string</span>&nbsp;<span class="comment" id="5445921">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5445931">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment" id="5445934">//&nbsp;Publish&nbsp;declares&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.&nbsp;This&nbsp;should&nbsp;be&nbsp;called&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5446010">//&nbsp;package&#39;s&nbsp;init&nbsp;function&nbsp;when&nbsp;it&nbsp;creates&nbsp;its&nbsp;Vars.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="5446086">//&nbsp;registered&nbsp;then&nbsp;this&nbsp;will&nbsp;log.Panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5446126">func</span>&nbsp;<span class="ident" id="5446131">Publish</span><span class="op" id="5446138">(</span><span class="ident" id="5446139">name</span>&nbsp;<span class="builtintype" id="5446144">string</span><span class="op" id="5446150">,</span>&nbsp;<span class="ident" id="5446152">v</span>&nbsp;<span class="ident" id="5446154">Var</span><span class="op" id="5446157">)</span>&nbsp;<span class="op" id="5446159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446162">mutex</span><span class="op" id="5446167">.</span><span class="ident" id="5446168">Lock</span><span class="op" id="5446172">(</span><span class="op" id="5446173">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446176">defer</span>&nbsp;<span class="ident" id="5446182">mutex</span><span class="op" id="5446187">.</span><span class="ident" id="5446188">Unlock</span><span class="op" id="5446194">(</span><span class="op" id="5446195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446198">if</span>&nbsp;<span class="ident" id="5446201">_</span><span class="op" id="5446202">,</span>&nbsp;<span class="ident" id="5446204">existing</span>&nbsp;<span class="op" id="5446213">:=</span>&nbsp;<span class="ident" id="5446216">vars</span><span class="op" id="5446220">[</span><span class="ident" id="5446221">name</span><span class="op" id="5446225">]</span><span class="op" id="5446226">;</span>&nbsp;<span class="ident" id="5446228">existing</span>&nbsp;<span class="op" id="5446237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446241">log</span><span class="op" id="5446244">.</span><span class="ident" id="5446245">Panicln</span><span class="op" id="5446252">(</span><span class="string" id="5446253">&#34;Reuse&nbsp;of&nbsp;exported&nbsp;var&nbsp;name:&#34;</span><span class="op" id="5446282">,</span>&nbsp;<span class="ident" id="5446284">name</span><span class="op" id="5446288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5446291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446294">vars</span><span class="op" id="5446298">[</span><span class="ident" id="5446299">name</span><span class="op" id="5446303">]</span>&nbsp;<span class="op" id="5446305">=</span>&nbsp;<span class="ident" id="5446307">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446310">varKeys</span>&nbsp;<span class="op" id="5446318">=</span>&nbsp;<span class="builtinfunc" id="5446320">append</span><span class="op" id="5446326">(</span><span class="ident" id="5446327">varKeys</span><span class="op" id="5446334">,</span>&nbsp;<span class="ident" id="5446336">name</span><span class="op" id="5446340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446343">sort</span><span class="op" id="5446347">.</span><span class="ident" id="5446348">Strings</span><span class="op" id="5446355">(</span><span class="ident" id="5446356">varKeys</span><span class="op" id="5446363">)</span><br>
<span class="lineno"></span><span class="op" id="5446365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5446368">//&nbsp;Get&nbsp;retrieves&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno">265</span><span class="keyword" id="5446412">func</span>&nbsp;<span class="ident" id="5446417">Get</span><span class="op" id="5446420">(</span><span class="ident" id="5446421">name</span>&nbsp;<span class="builtintype" id="5446426">string</span><span class="op" id="5446432">)</span>&nbsp;<span class="ident" id="5446434">Var</span>&nbsp;<span class="op" id="5446438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446441">mutex</span><span class="op" id="5446446">.</span><span class="ident" id="5446447">RLock</span><span class="op" id="5446452">(</span><span class="op" id="5446453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446456">defer</span>&nbsp;<span class="ident" id="5446462">mutex</span><span class="op" id="5446467">.</span><span class="ident" id="5446468">RUnlock</span><span class="op" id="5446475">(</span><span class="op" id="5446476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446479">return</span>&nbsp;<span class="ident" id="5446486">vars</span><span class="op" id="5446490">[</span><span class="ident" id="5446491">name</span><span class="op" id="5446495">]</span><br>
<span class="lineno"></span><span class="op" id="5446497">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="comment" id="5446500">//&nbsp;Convenience&nbsp;functions&nbsp;for&nbsp;creating&nbsp;new&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5446563">func</span>&nbsp;<span class="ident" id="5446568">NewInt</span><span class="op" id="5446574">(</span><span class="ident" id="5446575">name</span>&nbsp;<span class="builtintype" id="5446580">string</span><span class="op" id="5446586">)</span>&nbsp;<span class="op" id="5446588">*</span><span class="ident" id="5446589">Int</span>&nbsp;<span class="op" id="5446593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446596">v</span>&nbsp;<span class="op" id="5446598">:=</span>&nbsp;<span class="builtinfunc" id="5446601">new</span><span class="op" id="5446604">(</span><span class="ident" id="5446605">Int</span><span class="op" id="5446608">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446611">Publish</span><span class="op" id="5446618">(</span><span class="ident" id="5446619">name</span><span class="op" id="5446623">,</span>&nbsp;<span class="ident" id="5446625">v</span><span class="op" id="5446626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446629">return</span>&nbsp;<span class="ident" id="5446636">v</span><br>
<span class="lineno"></span><span class="op" id="5446638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5446641">func</span>&nbsp;<span class="ident" id="5446646">NewFloat</span><span class="op" id="5446654">(</span><span class="ident" id="5446655">name</span>&nbsp;<span class="builtintype" id="5446660">string</span><span class="op" id="5446666">)</span>&nbsp;<span class="op" id="5446668">*</span><span class="ident" id="5446669">Float</span>&nbsp;<span class="op" id="5446675">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446678">v</span>&nbsp;<span class="op" id="5446680">:=</span>&nbsp;<span class="builtinfunc" id="5446683">new</span><span class="op" id="5446686">(</span><span class="ident" id="5446687">Float</span><span class="op" id="5446692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446695">Publish</span><span class="op" id="5446702">(</span><span class="ident" id="5446703">name</span><span class="op" id="5446707">,</span>&nbsp;<span class="ident" id="5446709">v</span><span class="op" id="5446710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446713">return</span>&nbsp;<span class="ident" id="5446720">v</span><br>
<span class="lineno"></span><span class="op" id="5446722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5446725">func</span>&nbsp;<span class="ident" id="5446730">NewMap</span><span class="op" id="5446736">(</span><span class="ident" id="5446737">name</span>&nbsp;<span class="builtintype" id="5446742">string</span><span class="op" id="5446748">)</span>&nbsp;<span class="op" id="5446750">*</span><span class="ident" id="5446751">Map</span>&nbsp;<span class="op" id="5446755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446758">v</span>&nbsp;<span class="op" id="5446760">:=</span>&nbsp;<span class="builtinfunc" id="5446763">new</span><span class="op" id="5446766">(</span><span class="ident" id="5446767">Map</span><span class="op" id="5446770">)</span><span class="op" id="5446771">.</span><span class="ident" id="5446772">Init</span><span class="op" id="5446776">(</span><span class="op" id="5446777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446780">Publish</span><span class="op" id="5446787">(</span><span class="ident" id="5446788">name</span><span class="op" id="5446792">,</span>&nbsp;<span class="ident" id="5446794">v</span><span class="op" id="5446795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446798">return</span>&nbsp;<span class="ident" id="5446805">v</span><br>
<span class="lineno"></span><span class="op" id="5446807">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="keyword" id="5446810">func</span>&nbsp;<span class="ident" id="5446815">NewString</span><span class="op" id="5446824">(</span><span class="ident" id="5446825">name</span>&nbsp;<span class="builtintype" id="5446830">string</span><span class="op" id="5446836">)</span>&nbsp;<span class="op" id="5446838">*</span><span class="ident" id="5446839">String</span>&nbsp;<span class="op" id="5446846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446849">v</span>&nbsp;<span class="op" id="5446851">:=</span>&nbsp;<span class="builtinfunc" id="5446854">new</span><span class="op" id="5446857">(</span><span class="ident" id="5446858">String</span><span class="op" id="5446864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5446867">Publish</span><span class="op" id="5446874">(</span><span class="ident" id="5446875">name</span><span class="op" id="5446879">,</span>&nbsp;<span class="ident" id="5446881">v</span><span class="op" id="5446882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5446885">return</span>&nbsp;<span class="ident" id="5446892">v</span><br>
<span class="lineno">295</span><span class="op" id="5446894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5446897">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="5446939">//&nbsp;The&nbsp;global&nbsp;variable&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5446998">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno">300</span><span class="keyword" id="5447051">func</span>&nbsp;<span class="ident" id="5447056">Do</span><span class="op" id="5447058">(</span><span class="ident" id="5447059">f</span>&nbsp;<span class="keyword" id="5447061">func</span><span class="op" id="5447065">(</span><span class="ident" id="5447066">KeyValue</span><span class="op" id="5447074">)</span><span class="op" id="5447075">)</span>&nbsp;<span class="op" id="5447077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447080">mutex</span><span class="op" id="5447085">.</span><span class="ident" id="5447086">RLock</span><span class="op" id="5447091">(</span><span class="op" id="5447092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447095">defer</span>&nbsp;<span class="ident" id="5447101">mutex</span><span class="op" id="5447106">.</span><span class="ident" id="5447107">RUnlock</span><span class="op" id="5447114">(</span><span class="op" id="5447115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447118">for</span>&nbsp;<span class="ident" id="5447122">_</span><span class="op" id="5447123">,</span>&nbsp;<span class="ident" id="5447125">k</span>&nbsp;<span class="op" id="5447127">:=</span>&nbsp;<span class="keyword" id="5447130">range</span>&nbsp;<span class="ident" id="5447136">varKeys</span>&nbsp;<span class="op" id="5447144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447148">f</span><span class="op" id="5447149">(</span><span class="ident" id="5447150">KeyValue</span><span class="op" id="5447158">{</span><span class="ident" id="5447159">k</span><span class="op" id="5447160">,</span>&nbsp;<span class="ident" id="5447162">vars</span><span class="op" id="5447166">[</span><span class="ident" id="5447167">k</span><span class="op" id="5447168">]</span><span class="op" id="5447169">}</span><span class="op" id="5447170">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5447173">}</span><br>
<span class="lineno"></span><span class="op" id="5447175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5447178">func</span>&nbsp;<span class="ident" id="5447183">expvarHandler</span><span class="op" id="5447196">(</span><span class="ident" id="5447197">w</span>&nbsp;<span class="ident" id="5447199">http</span><span class="op" id="5447203">.</span><span class="ident" id="5447204">ResponseWriter</span><span class="op" id="5447218">,</span>&nbsp;<span class="ident" id="5447220">r</span>&nbsp;<span class="op" id="5447222">*</span><span class="ident" id="5447223">http</span><span class="op" id="5447227">.</span><span class="ident" id="5447228">Request</span><span class="op" id="5447235">)</span>&nbsp;<span class="op" id="5447237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447240">w</span><span class="op" id="5447241">.</span><span class="ident" id="5447242">Header</span><span class="op" id="5447248">(</span><span class="op" id="5447249">)</span><span class="op" id="5447250">.</span><span class="ident" id="5447251">Set</span><span class="op" id="5447254">(</span><span class="string" id="5447255">&#34;Content-Type&#34;</span><span class="op" id="5447269">,</span>&nbsp;<span class="string" id="5447271">&#34;application/json;&nbsp;charset=utf-8&#34;</span><span class="op" id="5447304">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447307">fmt</span><span class="op" id="5447310">.</span><span class="ident" id="5447311">Fprintf</span><span class="op" id="5447318">(</span><span class="ident" id="5447319">w</span><span class="op" id="5447320">,</span>&nbsp;<span class="string" id="5447322">&#34;{\n&#34;</span><span class="op" id="5447327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447330">first</span>&nbsp;<span class="op" id="5447336">:=</span>&nbsp;<span class="builtintype" id="5447339">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447345">Do</span><span class="op" id="5447347">(</span><span class="keyword" id="5447348">func</span><span class="op" id="5447352">(</span><span class="ident" id="5447353">kv</span>&nbsp;<span class="ident" id="5447356">KeyValue</span><span class="op" id="5447364">)</span>&nbsp;<span class="op" id="5447366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447370">if</span>&nbsp;<span class="op" id="5447373">!</span><span class="ident" id="5447374">first</span>&nbsp;<span class="op" id="5447380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447385">fmt</span><span class="op" id="5447388">.</span><span class="ident" id="5447389">Fprintf</span><span class="op" id="5447396">(</span><span class="ident" id="5447397">w</span><span class="op" id="5447398">,</span>&nbsp;<span class="string" id="5447400">&#34;,\n&#34;</span><span class="op" id="5447405">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5447409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447413">first</span>&nbsp;<span class="op" id="5447419">=</span>&nbsp;<span class="builtintype" id="5447421">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447429">fmt</span><span class="op" id="5447432">.</span><span class="ident" id="5447433">Fprintf</span><span class="op" id="5447440">(</span><span class="ident" id="5447441">w</span><span class="op" id="5447442">,</span>&nbsp;<span class="string" id="5447444">&#34;%q:&nbsp;%s&#34;</span><span class="op" id="5447452">,</span>&nbsp;<span class="ident" id="5447454">kv</span><span class="op" id="5447456">.</span><span class="ident" id="5447457">Key</span><span class="op" id="5447460">,</span>&nbsp;<span class="ident" id="5447462">kv</span><span class="op" id="5447464">.</span><span class="ident" id="5447465">Value</span><span class="op" id="5447470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5447473">}</span><span class="op" id="5447474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447477">fmt</span><span class="op" id="5447480">.</span><span class="ident" id="5447481">Fprintf</span><span class="op" id="5447488">(</span><span class="ident" id="5447489">w</span><span class="op" id="5447490">,</span>&nbsp;<span class="string" id="5447492">&#34;\n}\n&#34;</span><span class="op" id="5447499">)</span><br>
<span class="lineno">320</span><span class="op" id="5447501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5447504">func</span>&nbsp;<span class="ident" id="5447509">cmdline</span><span class="op" id="5447516">(</span><span class="op" id="5447517">)</span>&nbsp;<span class="keyword" id="5447519">interface</span><span class="op" id="5447528">{</span><span class="op" id="5447529">}</span>&nbsp;<span class="op" id="5447531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447534">return</span>&nbsp;<span class="ident" id="5447541">os</span><span class="op" id="5447543">.</span><span class="ident" id="5447544">Args</span><br>
<span class="lineno"></span><span class="op" id="5447549">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="5447552">func</span>&nbsp;<span class="ident" id="5447557">memstats</span><span class="op" id="5447565">(</span><span class="op" id="5447566">)</span>&nbsp;<span class="keyword" id="5447568">interface</span><span class="op" id="5447577">{</span><span class="op" id="5447578">}</span>&nbsp;<span class="op" id="5447580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447583">stats</span>&nbsp;<span class="op" id="5447589">:=</span>&nbsp;<span class="builtinfunc" id="5447592">new</span><span class="op" id="5447595">(</span><span class="ident" id="5447596">runtime</span><span class="op" id="5447603">.</span><span class="ident" id="5447604">MemStats</span><span class="op" id="5447612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447615">runtime</span><span class="op" id="5447622">.</span><span class="ident" id="5447623">ReadMemStats</span><span class="op" id="5447635">(</span><span class="ident" id="5447636">stats</span><span class="op" id="5447641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5447644">return</span>&nbsp;<span class="op" id="5447651">*</span><span class="ident" id="5447652">stats</span><br>
<span class="lineno">330</span><span class="op" id="5447658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5447661">func</span>&nbsp;<span class="ident" id="5447666">init</span><span class="op" id="5447670">(</span><span class="op" id="5447671">)</span>&nbsp;<span class="op" id="5447673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447676">http</span><span class="op" id="5447680">.</span><span class="ident" id="5447681">HandleFunc</span><span class="op" id="5447691">(</span><span class="string" id="5447692">&#34;/debug/vars&#34;</span><span class="op" id="5447705">,</span>&nbsp;<span class="ident" id="5447707">expvarHandler</span><span class="op" id="5447720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447723">Publish</span><span class="op" id="5447730">(</span><span class="string" id="5447731">&#34;cmdline&#34;</span><span class="op" id="5447740">,</span>&nbsp;<span class="ident" id="5447742">Func</span><span class="op" id="5447746">(</span><span class="ident" id="5447747">cmdline</span><span class="op" id="5447754">)</span><span class="op" id="5447755">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5447758">Publish</span><span class="op" id="5447765">(</span><span class="string" id="5447766">&#34;memstats&#34;</span><span class="op" id="5447776">,</span>&nbsp;<span class="ident" id="5447778">Func</span><span class="op" id="5447782">(</span><span class="ident" id="5447783">memstats</span><span class="op" id="5447791">)</span><span class="op" id="5447792">)</span><br>
<span class="lineno"></span><span class="op" id="5447794">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
