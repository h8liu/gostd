<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>os/signal</h2>
<ul>
<li><a href="/gostd/os/signal/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/os/signal/signal.go.html">signal.go</a></li>
<li><a href="/gostd/os/signal/signal_test.go.html" class="current">signal_test.go</a></li>
<li><a href="/gostd/os/signal/signal_unix.go.html">signal_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7445711">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7445766">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7445820">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7445871">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7445936">package</span>&nbsp;<span class="ident" id="7445944">signal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7445952">import</span>&nbsp;<span class="op" id="7445959">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7445962">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7445970">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7445983">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7445989">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7446000">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7446011">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7446022">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7446033">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7446044">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7446051">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7446054">func</span>&nbsp;<span class="ident" id="7446059">waitSig</span><span class="op" id="7446066">(</span><span class="ident" id="7446067">t</span>&nbsp;<span class="op" id="7446069">*</span><span class="ident" id="7446070">testing</span><span class="op" id="7446077">.</span><span class="ident" id="7446078">T</span><span class="op" id="7446079">,</span>&nbsp;<span class="ident" id="7446081">c</span>&nbsp;<span class="op" id="7446083">&lt;-</span><span class="keyword" id="7446085">chan</span>&nbsp;<span class="ident" id="7446090">os</span><span class="op" id="7446092">.</span><span class="ident" id="7446093">Signal</span><span class="op" id="7446099">,</span>&nbsp;<span class="ident" id="7446101">sig</span>&nbsp;<span class="ident" id="7446105">os</span><span class="op" id="7446107">.</span><span class="ident" id="7446108">Signal</span><span class="op" id="7446114">)</span>&nbsp;<span class="op" id="7446116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7446119">select</span>&nbsp;<span class="op" id="7446126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7446129">case</span>&nbsp;<span class="ident" id="7446134">s</span>&nbsp;<span class="op" id="7446136">:=</span>&nbsp;<span class="op" id="7446139">&lt;-</span><span class="ident" id="7446141">c</span><span class="op" id="7446142">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7446146">if</span>&nbsp;<span class="ident" id="7446149">s</span>&nbsp;<span class="op" id="7446151">!=</span>&nbsp;<span class="ident" id="7446154">sig</span>&nbsp;<span class="op" id="7446158">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446163">t</span><span class="op" id="7446164">.</span><span class="ident" id="7446165">Fatalf</span><span class="op" id="7446171">(</span><span class="string" id="7446172">&#34;signal&nbsp;was&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7446196">,</span>&nbsp;<span class="ident" id="7446198">s</span><span class="op" id="7446199">,</span>&nbsp;<span class="ident" id="7446201">sig</span><span class="op" id="7446204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7446208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7446211">case</span>&nbsp;<span class="op" id="7446216">&lt;-</span><span class="ident" id="7446218">time</span><span class="op" id="7446222">.</span><span class="ident" id="7446223">After</span><span class="op" id="7446228">(</span><span class="num" id="7446229">1</span>&nbsp;<span class="op" id="7446231">*</span>&nbsp;<span class="ident" id="7446233">time</span><span class="op" id="7446237">.</span><span class="ident" id="7446238">Second</span><span class="op" id="7446244">)</span><span class="op" id="7446245">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446249">t</span><span class="op" id="7446250">.</span><span class="ident" id="7446251">Fatalf</span><span class="op" id="7446257">(</span><span class="string" id="7446258">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;%v&#34;</span><span class="op" id="7446282">,</span>&nbsp;<span class="ident" id="7446284">sig</span><span class="op" id="7446287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7446290">}</span><br>
<span class="lineno">30</span><span class="op" id="7446292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7446295">//&nbsp;Test&nbsp;that&nbsp;basic&nbsp;signal&nbsp;handling&nbsp;works.</span><br>
<span class="lineno"></span><span class="keyword" id="7446337">func</span>&nbsp;<span class="ident" id="7446342">TestSignal</span><span class="op" id="7446352">(</span><span class="ident" id="7446353">t</span>&nbsp;<span class="op" id="7446355">*</span><span class="ident" id="7446356">testing</span><span class="op" id="7446363">.</span><span class="ident" id="7446364">T</span><span class="op" id="7446365">)</span>&nbsp;<span class="op" id="7446367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7446370">//&nbsp;Ask&nbsp;for&nbsp;SIGHUP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446389">c</span>&nbsp;<span class="op" id="7446391">:=</span>&nbsp;<span class="builtinfunc" id="7446394">make</span><span class="op" id="7446398">(</span><span class="keyword" id="7446399">chan</span>&nbsp;<span class="ident" id="7446404">os</span><span class="op" id="7446406">.</span><span class="ident" id="7446407">Signal</span><span class="op" id="7446413">,</span>&nbsp;<span class="num" id="7446415">1</span><span class="op" id="7446416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446419">Notify</span><span class="op" id="7446425">(</span><span class="ident" id="7446426">c</span><span class="op" id="7446427">,</span>&nbsp;<span class="ident" id="7446429">syscall</span><span class="op" id="7446436">.</span><span class="ident" id="7446437">SIGHUP</span><span class="op" id="7446443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7446446">defer</span>&nbsp;<span class="ident" id="7446452">Stop</span><span class="op" id="7446456">(</span><span class="ident" id="7446457">c</span><span class="op" id="7446458">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7446462">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGHUP</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446493">t</span><span class="op" id="7446494">.</span><span class="ident" id="7446495">Logf</span><span class="op" id="7446499">(</span><span class="string" id="7446500">&#34;sighup...&#34;</span><span class="op" id="7446511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446514">syscall</span><span class="op" id="7446521">.</span><span class="ident" id="7446522">Kill</span><span class="op" id="7446526">(</span><span class="ident" id="7446527">syscall</span><span class="op" id="7446534">.</span><span class="ident" id="7446535">Getpid</span><span class="op" id="7446541">(</span><span class="op" id="7446542">)</span><span class="op" id="7446543">,</span>&nbsp;<span class="ident" id="7446545">syscall</span><span class="op" id="7446552">.</span><span class="ident" id="7446553">SIGHUP</span><span class="op" id="7446559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446562">waitSig</span><span class="op" id="7446569">(</span><span class="ident" id="7446570">t</span><span class="op" id="7446571">,</span>&nbsp;<span class="ident" id="7446573">c</span><span class="op" id="7446574">,</span>&nbsp;<span class="ident" id="7446576">syscall</span><span class="op" id="7446583">.</span><span class="ident" id="7446584">SIGHUP</span><span class="op" id="7446590">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7446594">//&nbsp;Ask&nbsp;for&nbsp;everything&nbsp;we&nbsp;can&nbsp;get.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446629">c1</span>&nbsp;<span class="op" id="7446632">:=</span>&nbsp;<span class="builtinfunc" id="7446635">make</span><span class="op" id="7446639">(</span><span class="keyword" id="7446640">chan</span>&nbsp;<span class="ident" id="7446645">os</span><span class="op" id="7446647">.</span><span class="ident" id="7446648">Signal</span><span class="op" id="7446654">,</span>&nbsp;<span class="num" id="7446656">1</span><span class="op" id="7446657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446660">Notify</span><span class="op" id="7446666">(</span><span class="ident" id="7446667">c1</span><span class="op" id="7446669">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7446673">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGWINCH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446706">t</span><span class="op" id="7446707">.</span><span class="ident" id="7446708">Logf</span><span class="op" id="7446712">(</span><span class="string" id="7446713">&#34;sigwinch...&#34;</span><span class="op" id="7446726">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446729">syscall</span><span class="op" id="7446736">.</span><span class="ident" id="7446737">Kill</span><span class="op" id="7446741">(</span><span class="ident" id="7446742">syscall</span><span class="op" id="7446749">.</span><span class="ident" id="7446750">Getpid</span><span class="op" id="7446756">(</span><span class="op" id="7446757">)</span><span class="op" id="7446758">,</span>&nbsp;<span class="ident" id="7446760">syscall</span><span class="op" id="7446767">.</span><span class="ident" id="7446768">SIGWINCH</span><span class="op" id="7446776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446779">waitSig</span><span class="op" id="7446786">(</span><span class="ident" id="7446787">t</span><span class="op" id="7446788">,</span>&nbsp;<span class="ident" id="7446790">c1</span><span class="op" id="7446792">,</span>&nbsp;<span class="ident" id="7446794">syscall</span><span class="op" id="7446801">.</span><span class="ident" id="7446802">SIGWINCH</span><span class="op" id="7446810">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7446814">//&nbsp;Send&nbsp;two&nbsp;more&nbsp;SIGHUPs,&nbsp;to&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7446859">//&nbsp;they&nbsp;get&nbsp;delivered&nbsp;on&nbsp;c1&nbsp;and&nbsp;that&nbsp;not&nbsp;reading</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7446909">//&nbsp;from&nbsp;c&nbsp;does&nbsp;not&nbsp;block&nbsp;everything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446947">t</span><span class="op" id="7446948">.</span><span class="ident" id="7446949">Logf</span><span class="op" id="7446953">(</span><span class="string" id="7446954">&#34;sighup...&#34;</span><span class="op" id="7446965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7446968">syscall</span><span class="op" id="7446975">.</span><span class="ident" id="7446976">Kill</span><span class="op" id="7446980">(</span><span class="ident" id="7446981">syscall</span><span class="op" id="7446988">.</span><span class="ident" id="7446989">Getpid</span><span class="op" id="7446995">(</span><span class="op" id="7446996">)</span><span class="op" id="7446997">,</span>&nbsp;<span class="ident" id="7446999">syscall</span><span class="op" id="7447006">.</span><span class="ident" id="7447007">SIGHUP</span><span class="op" id="7447013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447016">waitSig</span><span class="op" id="7447023">(</span><span class="ident" id="7447024">t</span><span class="op" id="7447025">,</span>&nbsp;<span class="ident" id="7447027">c1</span><span class="op" id="7447029">,</span>&nbsp;<span class="ident" id="7447031">syscall</span><span class="op" id="7447038">.</span><span class="ident" id="7447039">SIGHUP</span><span class="op" id="7447045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447048">t</span><span class="op" id="7447049">.</span><span class="ident" id="7447050">Logf</span><span class="op" id="7447054">(</span><span class="string" id="7447055">&#34;sighup...&#34;</span><span class="op" id="7447066">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447069">syscall</span><span class="op" id="7447076">.</span><span class="ident" id="7447077">Kill</span><span class="op" id="7447081">(</span><span class="ident" id="7447082">syscall</span><span class="op" id="7447089">.</span><span class="ident" id="7447090">Getpid</span><span class="op" id="7447096">(</span><span class="op" id="7447097">)</span><span class="op" id="7447098">,</span>&nbsp;<span class="ident" id="7447100">syscall</span><span class="op" id="7447107">.</span><span class="ident" id="7447108">SIGHUP</span><span class="op" id="7447114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447117">waitSig</span><span class="op" id="7447124">(</span><span class="ident" id="7447125">t</span><span class="op" id="7447126">,</span>&nbsp;<span class="ident" id="7447128">c1</span><span class="op" id="7447130">,</span>&nbsp;<span class="ident" id="7447132">syscall</span><span class="op" id="7447139">.</span><span class="ident" id="7447140">SIGHUP</span><span class="op" id="7447146">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7447150">//&nbsp;The&nbsp;first&nbsp;SIGHUP&nbsp;should&nbsp;be&nbsp;waiting&nbsp;for&nbsp;us&nbsp;on&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447202">waitSig</span><span class="op" id="7447209">(</span><span class="ident" id="7447210">t</span><span class="op" id="7447211">,</span>&nbsp;<span class="ident" id="7447213">c</span><span class="op" id="7447214">,</span>&nbsp;<span class="ident" id="7447216">syscall</span><span class="op" id="7447223">.</span><span class="ident" id="7447224">SIGHUP</span><span class="op" id="7447230">)</span><br>
<span class="lineno">65</span><span class="op" id="7447232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7447235">func</span>&nbsp;<span class="ident" id="7447240">TestStress</span><span class="op" id="7447250">(</span><span class="ident" id="7447251">t</span>&nbsp;<span class="op" id="7447253">*</span><span class="ident" id="7447254">testing</span><span class="op" id="7447261">.</span><span class="ident" id="7447262">T</span><span class="op" id="7447263">)</span>&nbsp;<span class="op" id="7447265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447268">dur</span>&nbsp;<span class="op" id="7447272">:=</span>&nbsp;<span class="num" id="7447275">3</span>&nbsp;<span class="op" id="7447277">*</span>&nbsp;<span class="ident" id="7447279">time</span><span class="op" id="7447283">.</span><span class="ident" id="7447284">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447292">if</span>&nbsp;<span class="ident" id="7447295">testing</span><span class="op" id="7447302">.</span><span class="ident" id="7447303">Short</span><span class="op" id="7447308">(</span><span class="op" id="7447309">)</span>&nbsp;<span class="op" id="7447311">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447315">dur</span>&nbsp;<span class="op" id="7447319">=</span>&nbsp;<span class="num" id="7447321">100</span>&nbsp;<span class="op" id="7447325">*</span>&nbsp;<span class="ident" id="7447327">time</span><span class="op" id="7447331">.</span><span class="ident" id="7447332">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7447345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447348">defer</span>&nbsp;<span class="ident" id="7447354">runtime</span><span class="op" id="7447361">.</span><span class="ident" id="7447362">GOMAXPROCS</span><span class="op" id="7447372">(</span><span class="ident" id="7447373">runtime</span><span class="op" id="7447380">.</span><span class="ident" id="7447381">GOMAXPROCS</span><span class="op" id="7447391">(</span><span class="num" id="7447392">4</span><span class="op" id="7447393">)</span><span class="op" id="7447394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447397">done</span>&nbsp;<span class="op" id="7447402">:=</span>&nbsp;<span class="builtinfunc" id="7447405">make</span><span class="op" id="7447409">(</span><span class="keyword" id="7447410">chan</span>&nbsp;<span class="builtintype" id="7447415">bool</span><span class="op" id="7447419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447422">finished</span>&nbsp;<span class="op" id="7447431">:=</span>&nbsp;<span class="builtinfunc" id="7447434">make</span><span class="op" id="7447438">(</span><span class="keyword" id="7447439">chan</span>&nbsp;<span class="builtintype" id="7447444">bool</span><span class="op" id="7447448">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447451">go</span>&nbsp;<span class="keyword" id="7447454">func</span><span class="op" id="7447458">(</span><span class="op" id="7447459">)</span>&nbsp;<span class="op" id="7447461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447465">sig</span>&nbsp;<span class="op" id="7447469">:=</span>&nbsp;<span class="builtinfunc" id="7447472">make</span><span class="op" id="7447476">(</span><span class="keyword" id="7447477">chan</span>&nbsp;<span class="ident" id="7447482">os</span><span class="op" id="7447484">.</span><span class="ident" id="7447485">Signal</span><span class="op" id="7447491">,</span>&nbsp;<span class="num" id="7447493">1</span><span class="op" id="7447494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447498">Notify</span><span class="op" id="7447504">(</span><span class="ident" id="7447505">sig</span><span class="op" id="7447508">,</span>&nbsp;<span class="ident" id="7447510">syscall</span><span class="op" id="7447517">.</span><span class="ident" id="7447518">SIGUSR1</span><span class="op" id="7447525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447529">defer</span>&nbsp;<span class="ident" id="7447535">Stop</span><span class="op" id="7447539">(</span><span class="ident" id="7447540">sig</span><span class="op" id="7447543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447546">Loop</span><span class="op" id="7447550">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447554">for</span>&nbsp;<span class="op" id="7447558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447563">select</span>&nbsp;<span class="op" id="7447570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447575">case</span>&nbsp;<span class="op" id="7447580">&lt;-</span><span class="ident" id="7447582">sig</span><span class="op" id="7447585">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447590">case</span>&nbsp;<span class="op" id="7447595">&lt;-</span><span class="ident" id="7447597">done</span><span class="op" id="7447601">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447607">break</span>&nbsp;<span class="ident" id="7447613">Loop</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7447621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7447625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447629">finished</span>&nbsp;<span class="op" id="7447638">&lt;-</span>&nbsp;<span class="builtintype" id="7447641">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7447647">}</span><span class="op" id="7447648">(</span><span class="op" id="7447649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447652">go</span>&nbsp;<span class="keyword" id="7447655">func</span><span class="op" id="7447659">(</span><span class="op" id="7447660">)</span>&nbsp;<span class="op" id="7447662">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447665">Loop</span><span class="op" id="7447669">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447673">for</span>&nbsp;<span class="op" id="7447677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447682">select</span>&nbsp;<span class="op" id="7447689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447694">case</span>&nbsp;<span class="op" id="7447699">&lt;-</span><span class="ident" id="7447701">done</span><span class="op" id="7447705">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447711">break</span>&nbsp;<span class="ident" id="7447717">Loop</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7447725">default</span><span class="op" id="7447732">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447738">syscall</span><span class="op" id="7447745">.</span><span class="ident" id="7447746">Kill</span><span class="op" id="7447750">(</span><span class="ident" id="7447751">syscall</span><span class="op" id="7447758">.</span><span class="ident" id="7447759">Getpid</span><span class="op" id="7447765">(</span><span class="op" id="7447766">)</span><span class="op" id="7447767">,</span>&nbsp;<span class="ident" id="7447769">syscall</span><span class="op" id="7447776">.</span><span class="ident" id="7447777">SIGUSR1</span><span class="op" id="7447784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447790">runtime</span><span class="op" id="7447797">.</span><span class="ident" id="7447798">Gosched</span><span class="op" id="7447805">(</span><span class="op" id="7447806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7447811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7447815">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447819">finished</span>&nbsp;<span class="op" id="7447828">&lt;-</span>&nbsp;<span class="builtintype" id="7447831">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7447837">}</span><span class="op" id="7447838">(</span><span class="op" id="7447839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7447842">time</span><span class="op" id="7447846">.</span><span class="ident" id="7447847">Sleep</span><span class="op" id="7447852">(</span><span class="ident" id="7447853">dur</span><span class="op" id="7447856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7447859">close</span><span class="op" id="7447864">(</span><span class="ident" id="7447865">done</span><span class="op" id="7447869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7447872">&lt;-</span><span class="ident" id="7447874">finished</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7447884">&lt;-</span><span class="ident" id="7447886">finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7447896">//&nbsp;When&nbsp;run&nbsp;with&nbsp;&#39;go&nbsp;test&nbsp;-cpu=1,2,4&#39;&nbsp;SIGUSR1&nbsp;from&nbsp;this&nbsp;test&nbsp;can&nbsp;slip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7447967">//&nbsp;into&nbsp;subsequent&nbsp;TestSignal()&nbsp;causing&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7448017">//&nbsp;Sleep&nbsp;for&nbsp;a&nbsp;while&nbsp;to&nbsp;reduce&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7448081">time</span><span class="op" id="7448085">.</span><span class="ident" id="7448086">Sleep</span><span class="op" id="7448091">(</span><span class="num" id="7448092">10</span>&nbsp;<span class="op" id="7448095">*</span>&nbsp;<span class="ident" id="7448097">time</span><span class="op" id="7448101">.</span><span class="ident" id="7448102">Millisecond</span><span class="op" id="7448113">)</span><br>
<span class="lineno">110</span><span class="op" id="7448115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7448118">var</span>&nbsp;<span class="ident" id="7448122">sendUncaughtSighup</span>&nbsp;<span class="op" id="7448141">=</span>&nbsp;<span class="ident" id="7448143">flag</span><span class="op" id="7448147">.</span><span class="ident" id="7448148">Int</span><span class="op" id="7448151">(</span><span class="string" id="7448152">&#34;send_uncaught_sighup&#34;</span><span class="op" id="7448174">,</span>&nbsp;<span class="num" id="7448176">0</span><span class="op" id="7448177">,</span>&nbsp;<span class="string" id="7448179">&#34;send&nbsp;uncaught&nbsp;SIGHUP&nbsp;during&nbsp;TestStop&#34;</span><span class="op" id="7448217">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7448220">//&nbsp;Test&nbsp;that&nbsp;Stop&nbsp;cancels&nbsp;the&nbsp;channel&#39;s&nbsp;registrations.</span><br>
<span class="lineno">115</span><span class="keyword" id="7448275">func</span>&nbsp;<span class="ident" id="7448280">TestStop</span><span class="op" id="7448288">(</span><span class="ident" id="7448289">t</span>&nbsp;<span class="op" id="7448291">*</span><span class="ident" id="7448292">testing</span><span class="op" id="7448299">.</span><span class="ident" id="7448300">T</span><span class="op" id="7448301">)</span>&nbsp;<span class="op" id="7448303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7448306">sigs</span>&nbsp;<span class="op" id="7448311">:=</span>&nbsp;<span class="op" id="7448314">[</span><span class="op" id="7448315">]</span><span class="ident" id="7448316">syscall</span><span class="op" id="7448323">.</span><span class="ident" id="7448324">Signal</span><span class="op" id="7448330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7448334">syscall</span><span class="op" id="7448341">.</span><span class="ident" id="7448342">SIGWINCH</span><span class="op" id="7448350">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7448354">syscall</span><span class="op" id="7448361">.</span><span class="ident" id="7448362">SIGHUP</span><span class="op" id="7448368">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7448371">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7448375">for</span>&nbsp;<span class="ident" id="7448379">_</span><span class="op" id="7448380">,</span>&nbsp;<span class="ident" id="7448382">sig</span>&nbsp;<span class="op" id="7448386">:=</span>&nbsp;<span class="keyword" id="7448389">range</span>&nbsp;<span class="ident" id="7448395">sigs</span>&nbsp;<span class="op" id="7448400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7448404">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7448426">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7448471">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7448542">if</span>&nbsp;<span class="ident" id="7448545">sig</span>&nbsp;<span class="op" id="7448549">!=</span>&nbsp;<span class="ident" id="7448552">syscall</span><span class="op" id="7448559">.</span><span class="ident" id="7448560">SIGHUP</span>&nbsp;<span class="op" id="7448567">||</span>&nbsp;<span class="op" id="7448570">*</span><span class="ident" id="7448571">sendUncaughtSighup</span>&nbsp;<span class="op" id="7448590">==</span>&nbsp;<span class="num" id="7448593">1</span>&nbsp;<span class="op" id="7448595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7448600">syscall</span><span class="op" id="7448607">.</span><span class="ident" id="7448608">Kill</span><span class="op" id="7448612">(</span><span class="ident" id="7448613">syscall</span><span class="op" id="7448620">.</span><span class="ident" id="7448621">Getpid</span><span class="op" id="7448627">(</span><span class="op" id="7448628">)</span><span class="op" id="7448629">,</span>&nbsp;<span class="ident" id="7448631">sig</span><span class="op" id="7448634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7448638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7448642">time</span><span class="op" id="7448646">.</span><span class="ident" id="7448647">Sleep</span><span class="op" id="7448652">(</span><span class="num" id="7448653">100</span>&nbsp;<span class="op" id="7448657">*</span>&nbsp;<span class="ident" id="7448659">time</span><span class="op" id="7448663">.</span><span class="ident" id="7448664">Millisecond</span><span class="op" id="7448675">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7448680">//&nbsp;Ask&nbsp;for&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7448700">c</span>&nbsp;<span class="op" id="7448702">:=</span>&nbsp;<span class="builtinfunc" id="7448705">make</span><span class="op" id="7448709">(</span><span class="keyword" id="7448710">chan</span>&nbsp;<span class="ident" id="7448715">os</span><span class="op" id="7448717">.</span><span class="ident" id="7448718">Signal</span><span class="op" id="7448724">,</span>&nbsp;<span class="num" id="7448726">1</span><span class="op" id="7448727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7448731">Notify</span><span class="op" id="7448737">(</span><span class="ident" id="7448738">c</span><span class="op" id="7448739">,</span>&nbsp;<span class="ident" id="7448741">sig</span><span class="op" id="7448744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7448748">defer</span>&nbsp;<span class="ident" id="7448754">Stop</span><span class="op" id="7448758">(</span><span class="ident" id="7448759">c</span><span class="op" id="7448760">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7448765">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;that&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7448800">syscall</span><span class="op" id="7448807">.</span><span class="ident" id="7448808">Kill</span><span class="op" id="7448812">(</span><span class="ident" id="7448813">syscall</span><span class="op" id="7448820">.</span><span class="ident" id="7448821">Getpid</span><span class="op" id="7448827">(</span><span class="op" id="7448828">)</span><span class="op" id="7448829">,</span>&nbsp;<span class="ident" id="7448831">sig</span><span class="op" id="7448834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7448838">waitSig</span><span class="op" id="7448845">(</span><span class="ident" id="7448846">t</span><span class="op" id="7448847">,</span>&nbsp;<span class="ident" id="7448849">c</span><span class="op" id="7448850">,</span>&nbsp;<span class="ident" id="7448852">sig</span><span class="op" id="7448855">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7448860">Stop</span><span class="op" id="7448864">(</span><span class="ident" id="7448865">c</span><span class="op" id="7448866">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7448870">select</span>&nbsp;<span class="op" id="7448877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7448881">case</span>&nbsp;<span class="ident" id="7448886">s</span>&nbsp;<span class="op" id="7448888">:=</span>&nbsp;<span class="op" id="7448891">&lt;-</span><span class="ident" id="7448893">c</span><span class="op" id="7448894">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7448899">t</span><span class="op" id="7448900">.</span><span class="ident" id="7448901">Fatalf</span><span class="op" id="7448907">(</span><span class="string" id="7448908">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7448930">,</span>&nbsp;<span class="ident" id="7448932">s</span><span class="op" id="7448933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7448937">case</span>&nbsp;<span class="op" id="7448942">&lt;-</span><span class="ident" id="7448944">time</span><span class="op" id="7448948">.</span><span class="ident" id="7448949">After</span><span class="op" id="7448954">(</span><span class="num" id="7448955">100</span>&nbsp;<span class="op" id="7448959">*</span>&nbsp;<span class="ident" id="7448961">time</span><span class="op" id="7448965">.</span><span class="ident" id="7448966">Millisecond</span><span class="op" id="7448977">)</span><span class="op" id="7448978">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7448983">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7449011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7449016">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7449038">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7449083">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7449154">if</span>&nbsp;<span class="ident" id="7449157">sig</span>&nbsp;<span class="op" id="7449161">!=</span>&nbsp;<span class="ident" id="7449164">syscall</span><span class="op" id="7449171">.</span><span class="ident" id="7449172">SIGHUP</span>&nbsp;<span class="op" id="7449179">||</span>&nbsp;<span class="op" id="7449182">*</span><span class="ident" id="7449183">sendUncaughtSighup</span>&nbsp;<span class="op" id="7449202">==</span>&nbsp;<span class="num" id="7449205">2</span>&nbsp;<span class="op" id="7449207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7449212">syscall</span><span class="op" id="7449219">.</span><span class="ident" id="7449220">Kill</span><span class="op" id="7449224">(</span><span class="ident" id="7449225">syscall</span><span class="op" id="7449232">.</span><span class="ident" id="7449233">Getpid</span><span class="op" id="7449239">(</span><span class="op" id="7449240">)</span><span class="op" id="7449241">,</span>&nbsp;<span class="ident" id="7449243">sig</span><span class="op" id="7449246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7449250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7449255">select</span>&nbsp;<span class="op" id="7449262">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7449266">case</span>&nbsp;<span class="ident" id="7449271">s</span>&nbsp;<span class="op" id="7449273">:=</span>&nbsp;<span class="op" id="7449276">&lt;-</span><span class="ident" id="7449278">c</span><span class="op" id="7449279">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7449284">t</span><span class="op" id="7449285">.</span><span class="ident" id="7449286">Fatalf</span><span class="op" id="7449292">(</span><span class="string" id="7449293">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7449315">,</span>&nbsp;<span class="ident" id="7449317">s</span><span class="op" id="7449318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7449322">case</span>&nbsp;<span class="op" id="7449327">&lt;-</span><span class="ident" id="7449329">time</span><span class="op" id="7449333">.</span><span class="ident" id="7449334">After</span><span class="op" id="7449339">(</span><span class="num" id="7449340">100</span>&nbsp;<span class="op" id="7449344">*</span>&nbsp;<span class="ident" id="7449346">time</span><span class="op" id="7449350">.</span><span class="ident" id="7449351">Millisecond</span><span class="op" id="7449362">)</span><span class="op" id="7449363">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7449368">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7449396">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7449399">}</span><br>
<span class="lineno"></span><span class="op" id="7449401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7449404">//&nbsp;Test&nbsp;that&nbsp;when&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;an&nbsp;uncaught&nbsp;SIGHUP&nbsp;does&nbsp;not&nbsp;kill&nbsp;the&nbsp;program,</span><br>
<span class="lineno"></span><span class="comment" id="7449485">//&nbsp;but&nbsp;a</span><br>
<span class="lineno">165</span><span class="keyword" id="7449494">func</span>&nbsp;<span class="ident" id="7449499">TestNohup</span><span class="op" id="7449508">(</span><span class="ident" id="7449509">t</span>&nbsp;<span class="op" id="7449511">*</span><span class="ident" id="7449512">testing</span><span class="op" id="7449519">.</span><span class="ident" id="7449520">T</span><span class="op" id="7449521">)</span>&nbsp;<span class="op" id="7449523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7449526">//&nbsp;Ugly:&nbsp;ask&nbsp;for&nbsp;SIGHUP&nbsp;so&nbsp;that&nbsp;child&nbsp;will&nbsp;not&nbsp;have&nbsp;no-hup&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7449590">//&nbsp;even&nbsp;if&nbsp;test&nbsp;is&nbsp;running&nbsp;under&nbsp;nohup&nbsp;environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7449643">//&nbsp;We&nbsp;have&nbsp;no&nbsp;intention&nbsp;of&nbsp;reading&nbsp;from&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7449687">c</span>&nbsp;<span class="op" id="7449689">:=</span>&nbsp;<span class="builtinfunc" id="7449692">make</span><span class="op" id="7449696">(</span><span class="keyword" id="7449697">chan</span>&nbsp;<span class="ident" id="7449702">os</span><span class="op" id="7449704">.</span><span class="ident" id="7449705">Signal</span><span class="op" id="7449711">,</span>&nbsp;<span class="num" id="7449713">1</span><span class="op" id="7449714">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7449717">Notify</span><span class="op" id="7449723">(</span><span class="ident" id="7449724">c</span><span class="op" id="7449725">,</span>&nbsp;<span class="ident" id="7449727">syscall</span><span class="op" id="7449734">.</span><span class="ident" id="7449735">SIGHUP</span><span class="op" id="7449741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7449745">//&nbsp;When&nbsp;run&nbsp;without&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;crash&nbsp;on&nbsp;an&nbsp;uncaught&nbsp;SIGHUP.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7449818">//&nbsp;When&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;ignore&nbsp;uncaught&nbsp;SIGHUPs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7449885">//&nbsp;because&nbsp;the&nbsp;runtime&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;listening&nbsp;for&nbsp;them.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7449951">//&nbsp;Either&nbsp;way,&nbsp;TestStop&nbsp;should&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;catch&nbsp;them&nbsp;when&nbsp;it&nbsp;wants&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7450030">//&nbsp;and&nbsp;then&nbsp;when&nbsp;it&nbsp;stops&nbsp;wanting&nbsp;them,&nbsp;the&nbsp;original&nbsp;behavior&nbsp;should&nbsp;resume.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7450108">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7450112">//&nbsp;send_uncaught_sighup=1&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;before&nbsp;starting&nbsp;to&nbsp;listen&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7450195">//&nbsp;send_uncaught_sighup=2&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;after&nbsp;no&nbsp;longer&nbsp;listening&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7450278">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7450282">//&nbsp;Both&nbsp;should&nbsp;fail&nbsp;without&nbsp;nohup&nbsp;and&nbsp;succeed&nbsp;with&nbsp;nohup.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7450342">for</span>&nbsp;<span class="ident" id="7450346">i</span>&nbsp;<span class="op" id="7450348">:=</span>&nbsp;<span class="num" id="7450351">1</span><span class="op" id="7450352">;</span>&nbsp;<span class="ident" id="7450354">i</span>&nbsp;<span class="op" id="7450356">&lt;=</span>&nbsp;<span class="num" id="7450359">2</span><span class="op" id="7450360">;</span>&nbsp;<span class="ident" id="7450362">i</span><span class="op" id="7450363">++</span>&nbsp;<span class="op" id="7450366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7450370">out</span><span class="op" id="7450373">,</span>&nbsp;<span class="ident" id="7450375">err</span>&nbsp;<span class="op" id="7450379">:=</span>&nbsp;<span class="ident" id="7450382">exec</span><span class="op" id="7450386">.</span><span class="ident" id="7450387">Command</span><span class="op" id="7450394">(</span><span class="ident" id="7450395">os</span><span class="op" id="7450397">.</span><span class="ident" id="7450398">Args</span><span class="op" id="7450402">[</span><span class="num" id="7450403">0</span><span class="op" id="7450404">]</span><span class="op" id="7450405">,</span>&nbsp;<span class="string" id="7450407">&#34;-test.run=TestStop&#34;</span><span class="op" id="7450427">,</span>&nbsp;<span class="string" id="7450429">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7450453">+</span><span class="ident" id="7450454">strconv</span><span class="op" id="7450461">.</span><span class="ident" id="7450462">Itoa</span><span class="op" id="7450466">(</span><span class="ident" id="7450467">i</span><span class="op" id="7450468">)</span><span class="op" id="7450469">)</span><span class="op" id="7450470">.</span><span class="ident" id="7450471">CombinedOutput</span><span class="op" id="7450485">(</span><span class="op" id="7450486">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7450490">if</span>&nbsp;<span class="ident" id="7450493">err</span>&nbsp;<span class="op" id="7450497">==</span>&nbsp;<span class="builtintype" id="7450500">nil</span>&nbsp;<span class="op" id="7450504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7450509">t</span><span class="op" id="7450510">.</span><span class="ident" id="7450511">Fatalf</span><span class="op" id="7450517">(</span><span class="string" id="7450518">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;and&nbsp;it&nbsp;succeeded:&nbsp;expected&nbsp;failure.\nOutput:\n%s&#34;</span><span class="op" id="7450607">,</span>&nbsp;<span class="ident" id="7450609">i</span><span class="op" id="7450610">,</span>&nbsp;<span class="ident" id="7450612">out</span><span class="op" id="7450615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7450619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7450622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7450626">Stop</span><span class="op" id="7450630">(</span><span class="ident" id="7450631">c</span><span class="op" id="7450632">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7450636">//&nbsp;Again,&nbsp;this&nbsp;time&nbsp;with&nbsp;nohup,&nbsp;assuming&nbsp;we&nbsp;can&nbsp;find&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7450694">_</span><span class="op" id="7450695">,</span>&nbsp;<span class="ident" id="7450697">err</span>&nbsp;<span class="op" id="7450701">:=</span>&nbsp;<span class="ident" id="7450704">os</span><span class="op" id="7450706">.</span><span class="ident" id="7450707">Stat</span><span class="op" id="7450711">(</span><span class="string" id="7450712">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7450728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7450731">if</span>&nbsp;<span class="ident" id="7450734">err</span>&nbsp;<span class="op" id="7450738">!=</span>&nbsp;<span class="builtintype" id="7450741">nil</span>&nbsp;<span class="op" id="7450745">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7450749">t</span><span class="op" id="7450750">.</span><span class="ident" id="7450751">Skip</span><span class="op" id="7450755">(</span><span class="string" id="7450756">&#34;cannot&nbsp;find&nbsp;nohup;&nbsp;skipping&nbsp;second&nbsp;half&nbsp;of&nbsp;test&#34;</span><span class="op" id="7450805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7450808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7450812">for</span>&nbsp;<span class="ident" id="7450816">i</span>&nbsp;<span class="op" id="7450818">:=</span>&nbsp;<span class="num" id="7450821">1</span><span class="op" id="7450822">;</span>&nbsp;<span class="ident" id="7450824">i</span>&nbsp;<span class="op" id="7450826">&lt;=</span>&nbsp;<span class="num" id="7450829">2</span><span class="op" id="7450830">;</span>&nbsp;<span class="ident" id="7450832">i</span><span class="op" id="7450833">++</span>&nbsp;<span class="op" id="7450836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7450840">os</span><span class="op" id="7450842">.</span><span class="ident" id="7450843">Remove</span><span class="op" id="7450849">(</span><span class="string" id="7450850">&#34;nohup.out&#34;</span><span class="op" id="7450861">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7450865">out</span><span class="op" id="7450868">,</span>&nbsp;<span class="ident" id="7450870">err</span>&nbsp;<span class="op" id="7450874">:=</span>&nbsp;<span class="ident" id="7450877">exec</span><span class="op" id="7450881">.</span><span class="ident" id="7450882">Command</span><span class="op" id="7450889">(</span><span class="string" id="7450890">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7450906">,</span>&nbsp;<span class="ident" id="7450908">os</span><span class="op" id="7450910">.</span><span class="ident" id="7450911">Args</span><span class="op" id="7450915">[</span><span class="num" id="7450916">0</span><span class="op" id="7450917">]</span><span class="op" id="7450918">,</span>&nbsp;<span class="string" id="7450920">&#34;-test.run=TestStop&#34;</span><span class="op" id="7450940">,</span>&nbsp;<span class="string" id="7450942">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7450966">+</span><span class="ident" id="7450967">strconv</span><span class="op" id="7450974">.</span><span class="ident" id="7450975">Itoa</span><span class="op" id="7450979">(</span><span class="ident" id="7450980">i</span><span class="op" id="7450981">)</span><span class="op" id="7450982">)</span><span class="op" id="7450983">.</span><span class="ident" id="7450984">CombinedOutput</span><span class="op" id="7450998">(</span><span class="op" id="7450999">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7451004">data</span><span class="op" id="7451008">,</span>&nbsp;<span class="ident" id="7451010">_</span>&nbsp;<span class="op" id="7451012">:=</span>&nbsp;<span class="ident" id="7451015">ioutil</span><span class="op" id="7451021">.</span><span class="ident" id="7451022">ReadFile</span><span class="op" id="7451030">(</span><span class="string" id="7451031">&#34;nohup.out&#34;</span><span class="op" id="7451042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7451046">os</span><span class="op" id="7451048">.</span><span class="ident" id="7451049">Remove</span><span class="op" id="7451055">(</span><span class="string" id="7451056">&#34;nohup.out&#34;</span><span class="op" id="7451067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7451071">if</span>&nbsp;<span class="ident" id="7451074">err</span>&nbsp;<span class="op" id="7451078">!=</span>&nbsp;<span class="builtintype" id="7451081">nil</span>&nbsp;<span class="op" id="7451085">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7451090">t</span><span class="op" id="7451091">.</span><span class="ident" id="7451092">Fatalf</span><span class="op" id="7451098">(</span><span class="string" id="7451099">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;under&nbsp;nohup&nbsp;and&nbsp;it&nbsp;failed:&nbsp;expected&nbsp;success.\nError:&nbsp;%v\nOutput:\n%s%s&#34;</span><span class="op" id="7451210">,</span>&nbsp;<span class="ident" id="7451212">i</span><span class="op" id="7451213">,</span>&nbsp;<span class="ident" id="7451215">err</span><span class="op" id="7451218">,</span>&nbsp;<span class="ident" id="7451220">out</span><span class="op" id="7451223">,</span>&nbsp;<span class="ident" id="7451225">data</span><span class="op" id="7451229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7451233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7451236">}</span><br>
<span class="lineno"></span><span class="op" id="7451238">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
