<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1592905">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1592960">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1593014">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1593065">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1593143">package</span>&nbsp;<span class="ident" id="1593151">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1593160">import</span>&nbsp;<span class="string" id="1593167">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1593177">//&nbsp;Integrated&nbsp;network&nbsp;poller&nbsp;(platform-independent&nbsp;part).</span><br>
<span class="lineno"></span><span class="comment" id="1593235">//&nbsp;A&nbsp;particular&nbsp;implementation&nbsp;(epoll/kqueue)&nbsp;must&nbsp;define&nbsp;the&nbsp;following&nbsp;functions:</span><br>
<span class="lineno"></span><span class="comment" id="1593318">//&nbsp;func&nbsp;netpollinit()&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;initialize&nbsp;the&nbsp;poller</span><br>
<span class="lineno"></span><span class="comment" id="1593370">//&nbsp;func&nbsp;netpollopen(fd&nbsp;uintptr,&nbsp;pd&nbsp;*pollDesc)&nbsp;int32&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;arm&nbsp;edge-triggered&nbsp;notifications</span><br>
<span class="lineno">15</span><span class="comment" id="1593461">//&nbsp;and&nbsp;associate&nbsp;fd&nbsp;with&nbsp;pd.</span><br>
<span class="lineno"></span><span class="comment" id="1593490">//&nbsp;An&nbsp;implementation&nbsp;must&nbsp;call&nbsp;the&nbsp;following&nbsp;function&nbsp;to&nbsp;denote&nbsp;that&nbsp;the&nbsp;pd&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="comment" id="1593576">//&nbsp;func&nbsp;netpollready(gpp&nbsp;**g,&nbsp;pd&nbsp;*pollDesc,&nbsp;mode&nbsp;int32)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1593633">//&nbsp;pollDesc&nbsp;contains&nbsp;2&nbsp;binary&nbsp;semaphores,&nbsp;rg&nbsp;and&nbsp;wg,&nbsp;to&nbsp;park&nbsp;reader&nbsp;and&nbsp;writer</span><br>
<span class="lineno">20</span><span class="comment" id="1593712">//&nbsp;goroutines&nbsp;respectively.&nbsp;The&nbsp;semaphore&nbsp;can&nbsp;be&nbsp;in&nbsp;the&nbsp;following&nbsp;states:</span><br>
<span class="lineno"></span><span class="comment" id="1593786">//&nbsp;pdReady&nbsp;-&nbsp;io&nbsp;readiness&nbsp;notification&nbsp;is&nbsp;pending;</span><br>
<span class="lineno"></span><span class="comment" id="1593837">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;goroutine&nbsp;consumes&nbsp;the&nbsp;notification&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1593918">//&nbsp;pdWait&nbsp;-&nbsp;a&nbsp;goroutine&nbsp;prepares&nbsp;to&nbsp;park&nbsp;on&nbsp;the&nbsp;semaphore,&nbsp;but&nbsp;not&nbsp;yet&nbsp;parked;</span><br>
<span class="lineno"></span><span class="comment" id="1593997">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;goroutine&nbsp;commits&nbsp;to&nbsp;park&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;G&nbsp;pointer,</span><br>
<span class="lineno">25</span><span class="comment" id="1594075">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;io&nbsp;notification&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY,</span><br>
<span class="lineno"></span><span class="comment" id="1594161">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1594243">//&nbsp;G&nbsp;pointer&nbsp;-&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;blocked&nbsp;on&nbsp;the&nbsp;semaphore;</span><br>
<span class="lineno"></span><span class="comment" id="1594301">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io&nbsp;notification&nbsp;or&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY&nbsp;or&nbsp;nil&nbsp;respectively</span><br>
<span class="lineno"></span><span class="comment" id="1594396">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;unparks&nbsp;the&nbsp;goroutine.</span><br>
<span class="lineno">30</span><span class="comment" id="1594438">//&nbsp;nil&nbsp;-&nbsp;nothing&nbsp;of&nbsp;the&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="1594469">const</span>&nbsp;<span class="op" id="1594475">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594478">pdReady</span>&nbsp;<span class="builtintype" id="1594486">uintptr</span>&nbsp;<span class="op" id="1594494">=</span>&nbsp;<span class="num" id="1594496">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594499">pdWait</span>&nbsp;&nbsp;<span class="builtintype" id="1594507">uintptr</span>&nbsp;<span class="op" id="1594515">=</span>&nbsp;<span class="num" id="1594517">2</span><br>
<span class="lineno"></span><span class="op" id="1594519">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1594522">const</span>&nbsp;<span class="ident" id="1594528">pollBlockSize</span>&nbsp;<span class="op" id="1594542">=</span>&nbsp;<span class="num" id="1594544">4</span>&nbsp;<span class="op" id="1594546">*</span>&nbsp;<span class="num" id="1594548">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1594554">//&nbsp;Network&nbsp;poller&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="1594584">type</span>&nbsp;<span class="ident" id="1594589">pollDesc</span>&nbsp;<span class="keyword" id="1594598">struct</span>&nbsp;<span class="op" id="1594605">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1594608">link</span>&nbsp;<span class="op" id="1594613">*</span><span class="ident" id="1594614">pollDesc</span>&nbsp;<span class="comment" id="1594623">//&nbsp;in&nbsp;pollcache,&nbsp;protected&nbsp;by&nbsp;pollcache.lock</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1594670">//&nbsp;The&nbsp;lock&nbsp;protects&nbsp;pollOpen,&nbsp;pollSetDeadline,&nbsp;pollUnblock&nbsp;and&nbsp;deadlineimpl&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1594760">//&nbsp;This&nbsp;fully&nbsp;covers&nbsp;seq,&nbsp;rt&nbsp;and&nbsp;wt&nbsp;variables.&nbsp;fd&nbsp;is&nbsp;constant&nbsp;throughout&nbsp;the&nbsp;PollDesc&nbsp;lifetime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1594857">//&nbsp;pollReset,&nbsp;pollWait,&nbsp;pollWaitCanceled&nbsp;and&nbsp;runtimeÂ·netpollready&nbsp;(IO&nbsp;readiness&nbsp;notification)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1594953">//&nbsp;proceed&nbsp;w/o&nbsp;taking&nbsp;the&nbsp;lock.&nbsp;So&nbsp;closing,&nbsp;rg,&nbsp;rd,&nbsp;wg&nbsp;and&nbsp;wd&nbsp;are&nbsp;manipulated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595032">//&nbsp;in&nbsp;a&nbsp;lock-free&nbsp;way&nbsp;by&nbsp;all&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595074">//&nbsp;NOTE(dvyukov):&nbsp;the&nbsp;following&nbsp;code&nbsp;uses&nbsp;uintptr&nbsp;to&nbsp;store&nbsp;*g&nbsp;(rg/wg),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595146">//&nbsp;that&nbsp;will&nbsp;blow&nbsp;up&nbsp;when&nbsp;GC&nbsp;starts&nbsp;moving&nbsp;objects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595199">lock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595207">mutex</span>&nbsp;<span class="comment" id="1595213">//&nbsp;protectes&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595248">fd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1595256">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595265">closing</span>&nbsp;<span class="builtintype" id="1595273">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595279">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1595287">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1595302">//&nbsp;protects&nbsp;from&nbsp;stale&nbsp;timers&nbsp;and&nbsp;ready&nbsp;notifications</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595357">rg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1595365">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1595380">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;read&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595427">rt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595435">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1595450">//&nbsp;read&nbsp;deadline&nbsp;timer&nbsp;(set&nbsp;if&nbsp;rt.f&nbsp;!=&nbsp;nil)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595495">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595503">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1595518">//&nbsp;read&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595536">wg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1595544">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1595559">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;write&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595607">wt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595615">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1595630">//&nbsp;write&nbsp;deadline&nbsp;timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595655">wd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595663">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1595678">//&nbsp;write&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595697">user</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1595705">unsafe</span><span class="op" id="1595711">.</span><span class="ident" id="1595712">Pointer</span>&nbsp;<span class="comment" id="1595720">//&nbsp;user&nbsp;settable&nbsp;cookie</span><br>
<span class="lineno">60</span><span class="op" id="1595744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1595747">type</span>&nbsp;<span class="ident" id="1595752">pollCache</span>&nbsp;<span class="keyword" id="1595762">struct</span>&nbsp;<span class="op" id="1595769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595772">lock</span>&nbsp;&nbsp;<span class="ident" id="1595778">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1595785">first</span>&nbsp;<span class="op" id="1595791">*</span><span class="ident" id="1595792">pollDesc</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595802">//&nbsp;PollDesc&nbsp;objects&nbsp;must&nbsp;be&nbsp;type-stable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595844">//&nbsp;because&nbsp;we&nbsp;can&nbsp;get&nbsp;ready&nbsp;notification&nbsp;from&nbsp;epoll/kqueue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595904">//&nbsp;after&nbsp;the&nbsp;descriptor&nbsp;is&nbsp;closed/reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1595947">//&nbsp;Stale&nbsp;notifications&nbsp;are&nbsp;detected&nbsp;using&nbsp;seq&nbsp;variable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1596004">//&nbsp;seq&nbsp;is&nbsp;incremented&nbsp;when&nbsp;deadlines&nbsp;are&nbsp;changed&nbsp;or&nbsp;descriptor&nbsp;is&nbsp;reused.</span><br>
<span class="lineno">70</span><span class="op" id="1596078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1596081">var</span>&nbsp;<span class="ident" id="1596085">pollcache</span>&nbsp;<span class="ident" id="1596095">pollCache</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1596106">func</span>&nbsp;<span class="ident" id="1596111">netpollServerInit</span><span class="op" id="1596128">(</span><span class="op" id="1596129">)</span>&nbsp;<span class="op" id="1596131">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596134">onM</span><span class="op" id="1596137">(</span><span class="ident" id="1596138">netpollinit</span><span class="op" id="1596149">)</span><br>
<span class="lineno"></span><span class="op" id="1596151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1596154">func</span>&nbsp;<span class="ident" id="1596159">netpollOpen</span><span class="op" id="1596170">(</span><span class="ident" id="1596171">fd</span>&nbsp;<span class="builtintype" id="1596174">uintptr</span><span class="op" id="1596181">)</span>&nbsp;<span class="op" id="1596183">(</span><span class="op" id="1596184">*</span><span class="ident" id="1596185">pollDesc</span><span class="op" id="1596193">,</span>&nbsp;<span class="builtintype" id="1596195">int</span><span class="op" id="1596198">)</span>&nbsp;<span class="op" id="1596200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596203">pd</span>&nbsp;<span class="op" id="1596206">:=</span>&nbsp;<span class="ident" id="1596209">pollcache</span><span class="op" id="1596218">.</span><span class="ident" id="1596219">alloc</span><span class="op" id="1596224">(</span><span class="op" id="1596225">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596228">lock</span><span class="op" id="1596232">(</span><span class="op" id="1596233">&amp;</span><span class="ident" id="1596234">pd</span><span class="op" id="1596236">.</span><span class="ident" id="1596237">lock</span><span class="op" id="1596241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596244">if</span>&nbsp;<span class="ident" id="1596247">pd</span><span class="op" id="1596249">.</span><span class="ident" id="1596250">wg</span>&nbsp;<span class="op" id="1596253">!=</span>&nbsp;<span class="num" id="1596256">0</span>&nbsp;<span class="op" id="1596258">&amp;&amp;</span>&nbsp;<span class="ident" id="1596261">pd</span><span class="op" id="1596263">.</span><span class="ident" id="1596264">wg</span>&nbsp;<span class="op" id="1596267">!=</span>&nbsp;<span class="ident" id="1596270">pdReady</span>&nbsp;<span class="op" id="1596278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596282">gothrow</span><span class="op" id="1596289">(</span><span class="string" id="1596290">&#34;netpollOpen:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1596337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596343">if</span>&nbsp;<span class="ident" id="1596346">pd</span><span class="op" id="1596348">.</span><span class="ident" id="1596349">rg</span>&nbsp;<span class="op" id="1596352">!=</span>&nbsp;<span class="num" id="1596355">0</span>&nbsp;<span class="op" id="1596357">&amp;&amp;</span>&nbsp;<span class="ident" id="1596360">pd</span><span class="op" id="1596362">.</span><span class="ident" id="1596363">rg</span>&nbsp;<span class="op" id="1596366">!=</span>&nbsp;<span class="ident" id="1596369">pdReady</span>&nbsp;<span class="op" id="1596377">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596381">gothrow</span><span class="op" id="1596388">(</span><span class="string" id="1596389">&#34;netpollOpen:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1596435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596441">pd</span><span class="op" id="1596443">.</span><span class="ident" id="1596444">fd</span>&nbsp;<span class="op" id="1596447">=</span>&nbsp;<span class="ident" id="1596449">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596453">pd</span><span class="op" id="1596455">.</span><span class="ident" id="1596456">closing</span>&nbsp;<span class="op" id="1596464">=</span>&nbsp;<span class="builtintype" id="1596466">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596473">pd</span><span class="op" id="1596475">.</span><span class="ident" id="1596476">seq</span><span class="op" id="1596479">++</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596483">pd</span><span class="op" id="1596485">.</span><span class="ident" id="1596486">rg</span>&nbsp;<span class="op" id="1596489">=</span>&nbsp;<span class="num" id="1596491">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596494">pd</span><span class="op" id="1596496">.</span><span class="ident" id="1596497">rd</span>&nbsp;<span class="op" id="1596500">=</span>&nbsp;<span class="num" id="1596502">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596505">pd</span><span class="op" id="1596507">.</span><span class="ident" id="1596508">wg</span>&nbsp;<span class="op" id="1596511">=</span>&nbsp;<span class="num" id="1596513">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596516">pd</span><span class="op" id="1596518">.</span><span class="ident" id="1596519">wd</span>&nbsp;<span class="op" id="1596522">=</span>&nbsp;<span class="num" id="1596524">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596527">unlock</span><span class="op" id="1596533">(</span><span class="op" id="1596534">&amp;</span><span class="ident" id="1596535">pd</span><span class="op" id="1596537">.</span><span class="ident" id="1596538">lock</span><span class="op" id="1596542">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596546">var</span>&nbsp;<span class="ident" id="1596550">errno</span>&nbsp;<span class="builtintype" id="1596556">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596563">onM</span><span class="op" id="1596566">(</span><span class="keyword" id="1596567">func</span><span class="op" id="1596571">(</span><span class="op" id="1596572">)</span>&nbsp;<span class="op" id="1596574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596578">errno</span>&nbsp;<span class="op" id="1596584">=</span>&nbsp;<span class="ident" id="1596586">netpollopen</span><span class="op" id="1596597">(</span><span class="ident" id="1596598">fd</span><span class="op" id="1596600">,</span>&nbsp;<span class="ident" id="1596602">pd</span><span class="op" id="1596604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596607">}</span><span class="op" id="1596608">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596611">return</span>&nbsp;<span class="ident" id="1596618">pd</span><span class="op" id="1596620">,</span>&nbsp;<span class="builtintype" id="1596622">int</span><span class="op" id="1596625">(</span><span class="ident" id="1596626">errno</span><span class="op" id="1596631">)</span><br>
<span class="lineno"></span><span class="op" id="1596633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1596636">func</span>&nbsp;<span class="ident" id="1596641">netpollClose</span><span class="op" id="1596653">(</span><span class="ident" id="1596654">pd</span>&nbsp;<span class="op" id="1596657">*</span><span class="ident" id="1596658">pollDesc</span><span class="op" id="1596666">)</span>&nbsp;<span class="op" id="1596668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596671">if</span>&nbsp;<span class="op" id="1596674">!</span><span class="ident" id="1596675">pd</span><span class="op" id="1596677">.</span><span class="ident" id="1596678">closing</span>&nbsp;<span class="op" id="1596686">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596690">gothrow</span><span class="op" id="1596697">(</span><span class="string" id="1596698">&#34;netpollClose:&nbsp;close&nbsp;w/o&nbsp;unblock&#34;</span><span class="op" id="1596731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596737">if</span>&nbsp;<span class="ident" id="1596740">pd</span><span class="op" id="1596742">.</span><span class="ident" id="1596743">wg</span>&nbsp;<span class="op" id="1596746">!=</span>&nbsp;<span class="num" id="1596749">0</span>&nbsp;<span class="op" id="1596751">&amp;&amp;</span>&nbsp;<span class="ident" id="1596754">pd</span><span class="op" id="1596756">.</span><span class="ident" id="1596757">wg</span>&nbsp;<span class="op" id="1596760">!=</span>&nbsp;<span class="ident" id="1596763">pdReady</span>&nbsp;<span class="op" id="1596771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596775">gothrow</span><span class="op" id="1596782">(</span><span class="string" id="1596783">&#34;netpollClose:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1596834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596837">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1596840">if</span>&nbsp;<span class="ident" id="1596843">pd</span><span class="op" id="1596845">.</span><span class="ident" id="1596846">rg</span>&nbsp;<span class="op" id="1596849">!=</span>&nbsp;<span class="num" id="1596852">0</span>&nbsp;<span class="op" id="1596854">&amp;&amp;</span>&nbsp;<span class="ident" id="1596857">pd</span><span class="op" id="1596859">.</span><span class="ident" id="1596860">rg</span>&nbsp;<span class="op" id="1596863">!=</span>&nbsp;<span class="ident" id="1596866">pdReady</span>&nbsp;<span class="op" id="1596874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596878">gothrow</span><span class="op" id="1596885">(</span><span class="string" id="1596886">&#34;netpollClose:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1596936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596942">onM</span><span class="op" id="1596945">(</span><span class="keyword" id="1596946">func</span><span class="op" id="1596950">(</span><span class="op" id="1596951">)</span>&nbsp;<span class="op" id="1596953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596957">netpollclose</span><span class="op" id="1596969">(</span><span class="builtintype" id="1596970">uintptr</span><span class="op" id="1596977">(</span><span class="ident" id="1596978">pd</span><span class="op" id="1596980">.</span><span class="ident" id="1596981">fd</span><span class="op" id="1596983">)</span><span class="op" id="1596984">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1596987">}</span><span class="op" id="1596988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1596991">pollcache</span><span class="op" id="1597000">.</span><span class="ident" id="1597001">free</span><span class="op" id="1597005">(</span><span class="ident" id="1597006">pd</span><span class="op" id="1597008">)</span><br>
<span class="lineno"></span><span class="op" id="1597010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1597013">func</span>&nbsp;<span class="op" id="1597018">(</span><span class="ident" id="1597019">c</span>&nbsp;<span class="op" id="1597021">*</span><span class="ident" id="1597022">pollCache</span><span class="op" id="1597031">)</span>&nbsp;<span class="ident" id="1597033">free</span><span class="op" id="1597037">(</span><span class="ident" id="1597038">pd</span>&nbsp;<span class="op" id="1597041">*</span><span class="ident" id="1597042">pollDesc</span><span class="op" id="1597050">)</span>&nbsp;<span class="op" id="1597052">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597055">lock</span><span class="op" id="1597059">(</span><span class="op" id="1597060">&amp;</span><span class="ident" id="1597061">c</span><span class="op" id="1597062">.</span><span class="ident" id="1597063">lock</span><span class="op" id="1597067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597070">pd</span><span class="op" id="1597072">.</span><span class="ident" id="1597073">link</span>&nbsp;<span class="op" id="1597078">=</span>&nbsp;<span class="ident" id="1597080">c</span><span class="op" id="1597081">.</span><span class="ident" id="1597082">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597089">c</span><span class="op" id="1597090">.</span><span class="ident" id="1597091">first</span>&nbsp;<span class="op" id="1597097">=</span>&nbsp;<span class="ident" id="1597099">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597103">unlock</span><span class="op" id="1597109">(</span><span class="op" id="1597110">&amp;</span><span class="ident" id="1597111">c</span><span class="op" id="1597112">.</span><span class="ident" id="1597113">lock</span><span class="op" id="1597117">)</span><br>
<span class="lineno"></span><span class="op" id="1597119">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="1597122">func</span>&nbsp;<span class="ident" id="1597127">netpollReset</span><span class="op" id="1597139">(</span><span class="ident" id="1597140">pd</span>&nbsp;<span class="op" id="1597143">*</span><span class="ident" id="1597144">pollDesc</span><span class="op" id="1597152">,</span>&nbsp;<span class="ident" id="1597154">mode</span>&nbsp;<span class="builtintype" id="1597159">int</span><span class="op" id="1597162">)</span>&nbsp;<span class="builtintype" id="1597164">int</span>&nbsp;<span class="op" id="1597168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597171">err</span>&nbsp;<span class="op" id="1597175">:=</span>&nbsp;<span class="ident" id="1597178">netpollcheckerr</span><span class="op" id="1597193">(</span><span class="ident" id="1597194">pd</span><span class="op" id="1597196">,</span>&nbsp;<span class="builtintype" id="1597198">int32</span><span class="op" id="1597203">(</span><span class="ident" id="1597204">mode</span><span class="op" id="1597208">)</span><span class="op" id="1597209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597212">if</span>&nbsp;<span class="ident" id="1597215">err</span>&nbsp;<span class="op" id="1597219">!=</span>&nbsp;<span class="num" id="1597222">0</span>&nbsp;<span class="op" id="1597224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597228">return</span>&nbsp;<span class="ident" id="1597235">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597243">if</span>&nbsp;<span class="ident" id="1597246">mode</span>&nbsp;<span class="op" id="1597251">==</span>&nbsp;<span class="string" id="1597254">&#39;r&#39;</span>&nbsp;<span class="op" id="1597258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597262">pd</span><span class="op" id="1597264">.</span><span class="ident" id="1597265">rg</span>&nbsp;<span class="op" id="1597268">=</span>&nbsp;<span class="num" id="1597270">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597273">}</span>&nbsp;<span class="keyword" id="1597275">else</span>&nbsp;<span class="keyword" id="1597280">if</span>&nbsp;<span class="ident" id="1597283">mode</span>&nbsp;<span class="op" id="1597288">==</span>&nbsp;<span class="string" id="1597291">&#39;w&#39;</span>&nbsp;<span class="op" id="1597295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597299">pd</span><span class="op" id="1597301">.</span><span class="ident" id="1597302">wg</span>&nbsp;<span class="op" id="1597305">=</span>&nbsp;<span class="num" id="1597307">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597313">return</span>&nbsp;<span class="num" id="1597320">0</span><br>
<span class="lineno"></span><span class="op" id="1597322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1597325">func</span>&nbsp;<span class="ident" id="1597330">netpollWait</span><span class="op" id="1597341">(</span><span class="ident" id="1597342">pd</span>&nbsp;<span class="op" id="1597345">*</span><span class="ident" id="1597346">pollDesc</span><span class="op" id="1597354">,</span>&nbsp;<span class="ident" id="1597356">mode</span>&nbsp;<span class="builtintype" id="1597361">int</span><span class="op" id="1597364">)</span>&nbsp;<span class="builtintype" id="1597366">int</span>&nbsp;<span class="op" id="1597370">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597373">err</span>&nbsp;<span class="op" id="1597377">:=</span>&nbsp;<span class="ident" id="1597380">netpollcheckerr</span><span class="op" id="1597395">(</span><span class="ident" id="1597396">pd</span><span class="op" id="1597398">,</span>&nbsp;<span class="builtintype" id="1597400">int32</span><span class="op" id="1597405">(</span><span class="ident" id="1597406">mode</span><span class="op" id="1597410">)</span><span class="op" id="1597411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597414">if</span>&nbsp;<span class="ident" id="1597417">err</span>&nbsp;<span class="op" id="1597421">!=</span>&nbsp;<span class="num" id="1597424">0</span>&nbsp;<span class="op" id="1597426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597430">return</span>&nbsp;<span class="ident" id="1597437">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597445">//&nbsp;As&nbsp;for&nbsp;now&nbsp;only&nbsp;Solaris&nbsp;uses&nbsp;level-triggered&nbsp;IO.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597498">if</span>&nbsp;<span class="ident" id="1597501">GOOS</span>&nbsp;<span class="op" id="1597506">==</span>&nbsp;<span class="string" id="1597509">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1597519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597523">onM</span><span class="op" id="1597526">(</span><span class="keyword" id="1597527">func</span><span class="op" id="1597531">(</span><span class="op" id="1597532">)</span>&nbsp;<span class="op" id="1597534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597539">netpollarm</span><span class="op" id="1597549">(</span><span class="ident" id="1597550">pd</span><span class="op" id="1597552">,</span>&nbsp;<span class="ident" id="1597554">mode</span><span class="op" id="1597558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597562">}</span><span class="op" id="1597563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597566">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597569">for</span>&nbsp;<span class="op" id="1597573">!</span><span class="ident" id="1597574">netpollblock</span><span class="op" id="1597586">(</span><span class="ident" id="1597587">pd</span><span class="op" id="1597589">,</span>&nbsp;<span class="builtintype" id="1597591">int32</span><span class="op" id="1597596">(</span><span class="ident" id="1597597">mode</span><span class="op" id="1597601">)</span><span class="op" id="1597602">,</span>&nbsp;<span class="builtintype" id="1597604">false</span><span class="op" id="1597609">)</span>&nbsp;<span class="op" id="1597611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1597615">err</span>&nbsp;<span class="op" id="1597619">=</span>&nbsp;<span class="ident" id="1597621">netpollcheckerr</span><span class="op" id="1597636">(</span><span class="ident" id="1597637">pd</span><span class="op" id="1597639">,</span>&nbsp;<span class="builtintype" id="1597641">int32</span><span class="op" id="1597646">(</span><span class="ident" id="1597647">mode</span><span class="op" id="1597651">)</span><span class="op" id="1597652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597656">if</span>&nbsp;<span class="ident" id="1597659">err</span>&nbsp;<span class="op" id="1597663">!=</span>&nbsp;<span class="num" id="1597666">0</span>&nbsp;<span class="op" id="1597668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597673">return</span>&nbsp;<span class="ident" id="1597680">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597686">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597690">//&nbsp;Can&nbsp;happen&nbsp;if&nbsp;timeout&nbsp;has&nbsp;fired&nbsp;and&nbsp;unblocked&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597745">//&nbsp;but&nbsp;before&nbsp;we&nbsp;had&nbsp;a&nbsp;chance&nbsp;to&nbsp;run,&nbsp;timeout&nbsp;has&nbsp;been&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597809">//&nbsp;Pretend&nbsp;it&nbsp;has&nbsp;not&nbsp;happened&nbsp;and&nbsp;retry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1597852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1597855">return</span>&nbsp;<span class="num" id="1597862">0</span><br>
<span class="lineno">160</span><span class="op" id="1597864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1597867">func</span>&nbsp;<span class="ident" id="1597872">netpollWaitCanceled</span><span class="op" id="1597891">(</span><span class="ident" id="1597892">pd</span>&nbsp;<span class="op" id="1597895">*</span><span class="ident" id="1597896">pollDesc</span><span class="op" id="1597904">,</span>&nbsp;<span class="ident" id="1597906">mode</span>&nbsp;<span class="builtintype" id="1597911">int</span><span class="op" id="1597914">)</span>&nbsp;<span class="op" id="1597916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597919">//&nbsp;This&nbsp;function&nbsp;is&nbsp;used&nbsp;only&nbsp;on&nbsp;windows&nbsp;after&nbsp;a&nbsp;failed&nbsp;attempt&nbsp;to&nbsp;cancel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1597994">//&nbsp;a&nbsp;pending&nbsp;async&nbsp;IO&nbsp;operation.&nbsp;Wait&nbsp;for&nbsp;ioready,&nbsp;ignore&nbsp;closing&nbsp;or&nbsp;timeouts.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598074">for</span>&nbsp;<span class="op" id="1598078">!</span><span class="ident" id="1598079">netpollblock</span><span class="op" id="1598091">(</span><span class="ident" id="1598092">pd</span><span class="op" id="1598094">,</span>&nbsp;<span class="builtintype" id="1598096">int32</span><span class="op" id="1598101">(</span><span class="ident" id="1598102">mode</span><span class="op" id="1598106">)</span><span class="op" id="1598107">,</span>&nbsp;<span class="builtintype" id="1598109">true</span><span class="op" id="1598113">)</span>&nbsp;<span class="op" id="1598115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598118">}</span><br>
<span class="lineno"></span><span class="op" id="1598120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1598123">func</span>&nbsp;<span class="ident" id="1598128">netpollSetDeadline</span><span class="op" id="1598146">(</span><span class="ident" id="1598147">pd</span>&nbsp;<span class="op" id="1598150">*</span><span class="ident" id="1598151">pollDesc</span><span class="op" id="1598159">,</span>&nbsp;<span class="ident" id="1598161">d</span>&nbsp;<span class="ident" id="1598163">int64</span><span class="op" id="1598168">,</span>&nbsp;<span class="ident" id="1598170">mode</span>&nbsp;<span class="builtintype" id="1598175">int</span><span class="op" id="1598178">)</span>&nbsp;<span class="op" id="1598180">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598183">lock</span><span class="op" id="1598187">(</span><span class="op" id="1598188">&amp;</span><span class="ident" id="1598189">pd</span><span class="op" id="1598191">.</span><span class="ident" id="1598192">lock</span><span class="op" id="1598196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598199">if</span>&nbsp;<span class="ident" id="1598202">pd</span><span class="op" id="1598204">.</span><span class="ident" id="1598205">closing</span>&nbsp;<span class="op" id="1598213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598217">unlock</span><span class="op" id="1598223">(</span><span class="op" id="1598224">&amp;</span><span class="ident" id="1598225">pd</span><span class="op" id="1598227">.</span><span class="ident" id="1598228">lock</span><span class="op" id="1598232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598236">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598244">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598247">pd</span><span class="op" id="1598249">.</span><span class="ident" id="1598250">seq</span><span class="op" id="1598253">++</span>&nbsp;<span class="comment" id="1598256">//&nbsp;invalidate&nbsp;current&nbsp;timers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598286">//&nbsp;Reset&nbsp;current&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598312">if</span>&nbsp;<span class="ident" id="1598315">pd</span><span class="op" id="1598317">.</span><span class="ident" id="1598318">rt</span><span class="op" id="1598320">.</span><span class="ident" id="1598321">f</span>&nbsp;<span class="op" id="1598323">!=</span>&nbsp;<span class="ident" id="1598326">nil</span>&nbsp;<span class="op" id="1598330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598334">deltimer</span><span class="op" id="1598342">(</span><span class="op" id="1598343">&amp;</span><span class="ident" id="1598344">pd</span><span class="op" id="1598346">.</span><span class="ident" id="1598347">rt</span><span class="op" id="1598349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598353">pd</span><span class="op" id="1598355">.</span><span class="ident" id="1598356">rt</span><span class="op" id="1598358">.</span><span class="ident" id="1598359">f</span>&nbsp;<span class="op" id="1598361">=</span>&nbsp;<span class="ident" id="1598363">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598371">if</span>&nbsp;<span class="ident" id="1598374">pd</span><span class="op" id="1598376">.</span><span class="ident" id="1598377">wt</span><span class="op" id="1598379">.</span><span class="ident" id="1598380">f</span>&nbsp;<span class="op" id="1598382">!=</span>&nbsp;<span class="ident" id="1598385">nil</span>&nbsp;<span class="op" id="1598389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598393">deltimer</span><span class="op" id="1598401">(</span><span class="op" id="1598402">&amp;</span><span class="ident" id="1598403">pd</span><span class="op" id="1598405">.</span><span class="ident" id="1598406">wt</span><span class="op" id="1598408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598412">pd</span><span class="op" id="1598414">.</span><span class="ident" id="1598415">wt</span><span class="op" id="1598417">.</span><span class="ident" id="1598418">f</span>&nbsp;<span class="op" id="1598420">=</span>&nbsp;<span class="ident" id="1598422">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598427">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598430">//&nbsp;Setup&nbsp;new&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598452">if</span>&nbsp;<span class="ident" id="1598455">d</span>&nbsp;<span class="op" id="1598457">!=</span>&nbsp;<span class="num" id="1598460">0</span>&nbsp;<span class="op" id="1598462">&amp;&amp;</span>&nbsp;<span class="ident" id="1598465">d</span>&nbsp;<span class="op" id="1598467">&lt;=</span>&nbsp;<span class="ident" id="1598470">nanotime</span><span class="op" id="1598478">(</span><span class="op" id="1598479">)</span>&nbsp;<span class="op" id="1598481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598485">d</span>&nbsp;<span class="op" id="1598487">=</span>&nbsp;<span class="op" id="1598489">-</span><span class="num" id="1598490">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598496">if</span>&nbsp;<span class="ident" id="1598499">mode</span>&nbsp;<span class="op" id="1598504">==</span>&nbsp;<span class="string" id="1598507">&#39;r&#39;</span>&nbsp;<span class="op" id="1598511">||</span>&nbsp;<span class="ident" id="1598514">mode</span>&nbsp;<span class="op" id="1598519">==</span>&nbsp;<span class="string" id="1598522">&#39;r&#39;</span><span class="op" id="1598525">+</span><span class="string" id="1598526">&#39;w&#39;</span>&nbsp;<span class="op" id="1598530">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598534">pd</span><span class="op" id="1598536">.</span><span class="ident" id="1598537">rd</span>&nbsp;<span class="op" id="1598540">=</span>&nbsp;<span class="ident" id="1598542">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598548">if</span>&nbsp;<span class="ident" id="1598551">mode</span>&nbsp;<span class="op" id="1598556">==</span>&nbsp;<span class="string" id="1598559">&#39;w&#39;</span>&nbsp;<span class="op" id="1598563">||</span>&nbsp;<span class="ident" id="1598566">mode</span>&nbsp;<span class="op" id="1598571">==</span>&nbsp;<span class="string" id="1598574">&#39;r&#39;</span><span class="op" id="1598577">+</span><span class="string" id="1598578">&#39;w&#39;</span>&nbsp;<span class="op" id="1598582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598586">pd</span><span class="op" id="1598588">.</span><span class="ident" id="1598589">wd</span>&nbsp;<span class="op" id="1598592">=</span>&nbsp;<span class="ident" id="1598594">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598597">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598600">if</span>&nbsp;<span class="ident" id="1598603">pd</span><span class="op" id="1598605">.</span><span class="ident" id="1598606">rd</span>&nbsp;<span class="op" id="1598609">&gt;</span>&nbsp;<span class="num" id="1598611">0</span>&nbsp;<span class="op" id="1598613">&amp;&amp;</span>&nbsp;<span class="ident" id="1598616">pd</span><span class="op" id="1598618">.</span><span class="ident" id="1598619">rd</span>&nbsp;<span class="op" id="1598622">==</span>&nbsp;<span class="ident" id="1598625">pd</span><span class="op" id="1598627">.</span><span class="ident" id="1598628">wd</span>&nbsp;<span class="op" id="1598631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598635">pd</span><span class="op" id="1598637">.</span><span class="ident" id="1598638">rt</span><span class="op" id="1598640">.</span><span class="ident" id="1598641">f</span>&nbsp;<span class="op" id="1598643">=</span>&nbsp;<span class="ident" id="1598645">netpollDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598663">pd</span><span class="op" id="1598665">.</span><span class="ident" id="1598666">rt</span><span class="op" id="1598668">.</span><span class="ident" id="1598669">when</span>&nbsp;<span class="op" id="1598674">=</span>&nbsp;<span class="ident" id="1598676">pd</span><span class="op" id="1598678">.</span><span class="ident" id="1598679">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598684">//&nbsp;Copy&nbsp;current&nbsp;seq&nbsp;into&nbsp;the&nbsp;timer&nbsp;arg.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598726">//&nbsp;Timer&nbsp;func&nbsp;will&nbsp;check&nbsp;the&nbsp;seq&nbsp;against&nbsp;current&nbsp;descriptor&nbsp;seq,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1598793">//&nbsp;if&nbsp;they&nbsp;differ&nbsp;the&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598861">pd</span><span class="op" id="1598863">.</span><span class="ident" id="1598864">rt</span><span class="op" id="1598866">.</span><span class="ident" id="1598867">arg</span>&nbsp;<span class="op" id="1598871">=</span>&nbsp;<span class="ident" id="1598873">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598878">pd</span><span class="op" id="1598880">.</span><span class="ident" id="1598881">rt</span><span class="op" id="1598883">.</span><span class="ident" id="1598884">seq</span>&nbsp;<span class="op" id="1598888">=</span>&nbsp;<span class="ident" id="1598890">pd</span><span class="op" id="1598892">.</span><span class="ident" id="1598893">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598899">addtimer</span><span class="op" id="1598907">(</span><span class="op" id="1598908">&amp;</span><span class="ident" id="1598909">pd</span><span class="op" id="1598911">.</span><span class="ident" id="1598912">rt</span><span class="op" id="1598914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1598917">}</span>&nbsp;<span class="keyword" id="1598919">else</span>&nbsp;<span class="op" id="1598924">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1598928">if</span>&nbsp;<span class="ident" id="1598931">pd</span><span class="op" id="1598933">.</span><span class="ident" id="1598934">rd</span>&nbsp;<span class="op" id="1598937">&gt;</span>&nbsp;<span class="num" id="1598939">0</span>&nbsp;<span class="op" id="1598941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598946">pd</span><span class="op" id="1598948">.</span><span class="ident" id="1598949">rt</span><span class="op" id="1598951">.</span><span class="ident" id="1598952">f</span>&nbsp;<span class="op" id="1598954">=</span>&nbsp;<span class="ident" id="1598956">netpollReadDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1598979">pd</span><span class="op" id="1598981">.</span><span class="ident" id="1598982">rt</span><span class="op" id="1598984">.</span><span class="ident" id="1598985">when</span>&nbsp;<span class="op" id="1598990">=</span>&nbsp;<span class="ident" id="1598992">pd</span><span class="op" id="1598994">.</span><span class="ident" id="1598995">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599001">pd</span><span class="op" id="1599003">.</span><span class="ident" id="1599004">rt</span><span class="op" id="1599006">.</span><span class="ident" id="1599007">arg</span>&nbsp;<span class="op" id="1599011">=</span>&nbsp;<span class="ident" id="1599013">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599019">pd</span><span class="op" id="1599021">.</span><span class="ident" id="1599022">rt</span><span class="op" id="1599024">.</span><span class="ident" id="1599025">seq</span>&nbsp;<span class="op" id="1599029">=</span>&nbsp;<span class="ident" id="1599031">pd</span><span class="op" id="1599033">.</span><span class="ident" id="1599034">seq</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599041">addtimer</span><span class="op" id="1599049">(</span><span class="op" id="1599050">&amp;</span><span class="ident" id="1599051">pd</span><span class="op" id="1599053">.</span><span class="ident" id="1599054">rt</span><span class="op" id="1599056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599064">if</span>&nbsp;<span class="ident" id="1599067">pd</span><span class="op" id="1599069">.</span><span class="ident" id="1599070">wd</span>&nbsp;<span class="op" id="1599073">&gt;</span>&nbsp;<span class="num" id="1599075">0</span>&nbsp;<span class="op" id="1599077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599082">pd</span><span class="op" id="1599084">.</span><span class="ident" id="1599085">wt</span><span class="op" id="1599087">.</span><span class="ident" id="1599088">f</span>&nbsp;<span class="op" id="1599090">=</span>&nbsp;<span class="ident" id="1599092">netpollWriteDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599116">pd</span><span class="op" id="1599118">.</span><span class="ident" id="1599119">wt</span><span class="op" id="1599121">.</span><span class="ident" id="1599122">when</span>&nbsp;<span class="op" id="1599127">=</span>&nbsp;<span class="ident" id="1599129">pd</span><span class="op" id="1599131">.</span><span class="ident" id="1599132">wd</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599138">pd</span><span class="op" id="1599140">.</span><span class="ident" id="1599141">wt</span><span class="op" id="1599143">.</span><span class="ident" id="1599144">arg</span>&nbsp;<span class="op" id="1599148">=</span>&nbsp;<span class="ident" id="1599150">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599156">pd</span><span class="op" id="1599158">.</span><span class="ident" id="1599159">wt</span><span class="op" id="1599161">.</span><span class="ident" id="1599162">seq</span>&nbsp;<span class="op" id="1599166">=</span>&nbsp;<span class="ident" id="1599168">pd</span><span class="op" id="1599170">.</span><span class="ident" id="1599171">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599178">addtimer</span><span class="op" id="1599186">(</span><span class="op" id="1599187">&amp;</span><span class="ident" id="1599188">pd</span><span class="op" id="1599190">.</span><span class="ident" id="1599191">wt</span><span class="op" id="1599193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599200">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1599203">//&nbsp;If&nbsp;we&nbsp;set&nbsp;the&nbsp;new&nbsp;deadline&nbsp;in&nbsp;the&nbsp;past,&nbsp;unblock&nbsp;currently&nbsp;pending&nbsp;IO&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599284">var</span>&nbsp;<span class="ident" id="1599288">rg</span><span class="op" id="1599290">,</span>&nbsp;<span class="ident" id="1599292">wg</span>&nbsp;<span class="op" id="1599295">*</span><span class="ident" id="1599296">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599299">atomicstorep</span><span class="op" id="1599311">(</span><span class="ident" id="1599312">unsafe</span><span class="op" id="1599318">.</span><span class="ident" id="1599319">Pointer</span><span class="op" id="1599326">(</span><span class="op" id="1599327">&amp;</span><span class="ident" id="1599328">wg</span><span class="op" id="1599330">)</span><span class="op" id="1599331">,</span>&nbsp;<span class="ident" id="1599333">nil</span><span class="op" id="1599336">)</span>&nbsp;<span class="comment" id="1599338">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;stores&nbsp;to&nbsp;rd/wd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599422">if</span>&nbsp;<span class="ident" id="1599425">pd</span><span class="op" id="1599427">.</span><span class="ident" id="1599428">rd</span>&nbsp;<span class="op" id="1599431">&lt;</span>&nbsp;<span class="num" id="1599433">0</span>&nbsp;<span class="op" id="1599435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599439">rg</span>&nbsp;<span class="op" id="1599442">=</span>&nbsp;<span class="ident" id="1599444">netpollunblock</span><span class="op" id="1599458">(</span><span class="ident" id="1599459">pd</span><span class="op" id="1599461">,</span>&nbsp;<span class="string" id="1599463">&#39;r&#39;</span><span class="op" id="1599466">,</span>&nbsp;<span class="builtintype" id="1599468">false</span><span class="op" id="1599473">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599479">if</span>&nbsp;<span class="ident" id="1599482">pd</span><span class="op" id="1599484">.</span><span class="ident" id="1599485">wd</span>&nbsp;<span class="op" id="1599488">&lt;</span>&nbsp;<span class="num" id="1599490">0</span>&nbsp;<span class="op" id="1599492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599496">wg</span>&nbsp;<span class="op" id="1599499">=</span>&nbsp;<span class="ident" id="1599501">netpollunblock</span><span class="op" id="1599515">(</span><span class="ident" id="1599516">pd</span><span class="op" id="1599518">,</span>&nbsp;<span class="string" id="1599520">&#39;w&#39;</span><span class="op" id="1599523">,</span>&nbsp;<span class="builtintype" id="1599525">false</span><span class="op" id="1599530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599536">unlock</span><span class="op" id="1599542">(</span><span class="op" id="1599543">&amp;</span><span class="ident" id="1599544">pd</span><span class="op" id="1599546">.</span><span class="ident" id="1599547">lock</span><span class="op" id="1599551">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599554">if</span>&nbsp;<span class="ident" id="1599557">rg</span>&nbsp;<span class="op" id="1599560">!=</span>&nbsp;<span class="ident" id="1599563">nil</span>&nbsp;<span class="op" id="1599567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599571">goready</span><span class="op" id="1599578">(</span><span class="ident" id="1599579">rg</span><span class="op" id="1599581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599587">if</span>&nbsp;<span class="ident" id="1599590">wg</span>&nbsp;<span class="op" id="1599593">!=</span>&nbsp;<span class="ident" id="1599596">nil</span>&nbsp;<span class="op" id="1599600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599604">goready</span><span class="op" id="1599611">(</span><span class="ident" id="1599612">wg</span><span class="op" id="1599614">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599617">}</span><br>
<span class="lineno"></span><span class="op" id="1599619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1599622">func</span>&nbsp;<span class="ident" id="1599627">netpollUnblock</span><span class="op" id="1599641">(</span><span class="ident" id="1599642">pd</span>&nbsp;<span class="op" id="1599645">*</span><span class="ident" id="1599646">pollDesc</span><span class="op" id="1599654">)</span>&nbsp;<span class="op" id="1599656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599659">lock</span><span class="op" id="1599663">(</span><span class="op" id="1599664">&amp;</span><span class="ident" id="1599665">pd</span><span class="op" id="1599667">.</span><span class="ident" id="1599668">lock</span><span class="op" id="1599672">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599675">if</span>&nbsp;<span class="ident" id="1599678">pd</span><span class="op" id="1599680">.</span><span class="ident" id="1599681">closing</span>&nbsp;<span class="op" id="1599689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599693">gothrow</span><span class="op" id="1599700">(</span><span class="string" id="1599701">&#34;netpollUnblock:&nbsp;already&nbsp;closing&#34;</span><span class="op" id="1599734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1599737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599740">pd</span><span class="op" id="1599742">.</span><span class="ident" id="1599743">closing</span>&nbsp;<span class="op" id="1599751">=</span>&nbsp;<span class="builtintype" id="1599753">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599759">pd</span><span class="op" id="1599761">.</span><span class="ident" id="1599762">seq</span><span class="op" id="1599765">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599769">var</span>&nbsp;<span class="ident" id="1599773">rg</span><span class="op" id="1599775">,</span>&nbsp;<span class="ident" id="1599777">wg</span>&nbsp;<span class="op" id="1599780">*</span><span class="ident" id="1599781">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599784">atomicstorep</span><span class="op" id="1599796">(</span><span class="ident" id="1599797">unsafe</span><span class="op" id="1599803">.</span><span class="ident" id="1599804">Pointer</span><span class="op" id="1599811">(</span><span class="op" id="1599812">&amp;</span><span class="ident" id="1599813">rg</span><span class="op" id="1599815">)</span><span class="op" id="1599816">,</span>&nbsp;<span class="ident" id="1599818">nil</span><span class="op" id="1599821">)</span>&nbsp;<span class="comment" id="1599823">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;closing&nbsp;and&nbsp;read&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599908">rg</span>&nbsp;<span class="op" id="1599911">=</span>&nbsp;<span class="ident" id="1599913">netpollunblock</span><span class="op" id="1599927">(</span><span class="ident" id="1599928">pd</span><span class="op" id="1599930">,</span>&nbsp;<span class="string" id="1599932">&#39;r&#39;</span><span class="op" id="1599935">,</span>&nbsp;<span class="builtintype" id="1599937">false</span><span class="op" id="1599942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1599945">wg</span>&nbsp;<span class="op" id="1599948">=</span>&nbsp;<span class="ident" id="1599950">netpollunblock</span><span class="op" id="1599964">(</span><span class="ident" id="1599965">pd</span><span class="op" id="1599967">,</span>&nbsp;<span class="string" id="1599969">&#39;w&#39;</span><span class="op" id="1599972">,</span>&nbsp;<span class="builtintype" id="1599974">false</span><span class="op" id="1599979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1599982">if</span>&nbsp;<span class="ident" id="1599985">pd</span><span class="op" id="1599987">.</span><span class="ident" id="1599988">rt</span><span class="op" id="1599990">.</span><span class="ident" id="1599991">f</span>&nbsp;<span class="op" id="1599993">!=</span>&nbsp;<span class="ident" id="1599996">nil</span>&nbsp;<span class="op" id="1600000">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600004">deltimer</span><span class="op" id="1600012">(</span><span class="op" id="1600013">&amp;</span><span class="ident" id="1600014">pd</span><span class="op" id="1600016">.</span><span class="ident" id="1600017">rt</span><span class="op" id="1600019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600023">pd</span><span class="op" id="1600025">.</span><span class="ident" id="1600026">rt</span><span class="op" id="1600028">.</span><span class="ident" id="1600029">f</span>&nbsp;<span class="op" id="1600031">=</span>&nbsp;<span class="ident" id="1600033">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600041">if</span>&nbsp;<span class="ident" id="1600044">pd</span><span class="op" id="1600046">.</span><span class="ident" id="1600047">wt</span><span class="op" id="1600049">.</span><span class="ident" id="1600050">f</span>&nbsp;<span class="op" id="1600052">!=</span>&nbsp;<span class="ident" id="1600055">nil</span>&nbsp;<span class="op" id="1600059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600063">deltimer</span><span class="op" id="1600071">(</span><span class="op" id="1600072">&amp;</span><span class="ident" id="1600073">pd</span><span class="op" id="1600075">.</span><span class="ident" id="1600076">wt</span><span class="op" id="1600078">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600082">pd</span><span class="op" id="1600084">.</span><span class="ident" id="1600085">wt</span><span class="op" id="1600087">.</span><span class="ident" id="1600088">f</span>&nbsp;<span class="op" id="1600090">=</span>&nbsp;<span class="ident" id="1600092">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600100">unlock</span><span class="op" id="1600106">(</span><span class="op" id="1600107">&amp;</span><span class="ident" id="1600108">pd</span><span class="op" id="1600110">.</span><span class="ident" id="1600111">lock</span><span class="op" id="1600115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600118">if</span>&nbsp;<span class="ident" id="1600121">rg</span>&nbsp;<span class="op" id="1600124">!=</span>&nbsp;<span class="ident" id="1600127">nil</span>&nbsp;<span class="op" id="1600131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600135">goready</span><span class="op" id="1600142">(</span><span class="ident" id="1600143">rg</span><span class="op" id="1600145">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600151">if</span>&nbsp;<span class="ident" id="1600154">wg</span>&nbsp;<span class="op" id="1600157">!=</span>&nbsp;<span class="ident" id="1600160">nil</span>&nbsp;<span class="op" id="1600164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600168">goready</span><span class="op" id="1600175">(</span><span class="ident" id="1600176">wg</span><span class="op" id="1600178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600181">}</span><br>
<span class="lineno"></span><span class="op" id="1600183">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="1600186">func</span>&nbsp;<span class="ident" id="1600191">netpollfd</span><span class="op" id="1600200">(</span><span class="ident" id="1600201">pd</span>&nbsp;<span class="op" id="1600204">*</span><span class="ident" id="1600205">pollDesc</span><span class="op" id="1600213">)</span>&nbsp;<span class="builtintype" id="1600215">uintptr</span>&nbsp;<span class="op" id="1600223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600226">return</span>&nbsp;<span class="ident" id="1600233">pd</span><span class="op" id="1600235">.</span><span class="ident" id="1600236">fd</span><br>
<span class="lineno"></span><span class="op" id="1600239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1600242">func</span>&nbsp;<span class="ident" id="1600247">netpolluser</span><span class="op" id="1600258">(</span><span class="ident" id="1600259">pd</span>&nbsp;<span class="op" id="1600262">*</span><span class="ident" id="1600263">pollDesc</span><span class="op" id="1600271">)</span>&nbsp;<span class="op" id="1600273">*</span><span class="ident" id="1600274">unsafe</span><span class="op" id="1600280">.</span><span class="ident" id="1600281">Pointer</span>&nbsp;<span class="op" id="1600289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600292">return</span>&nbsp;<span class="op" id="1600299">&amp;</span><span class="ident" id="1600300">pd</span><span class="op" id="1600302">.</span><span class="ident" id="1600303">user</span><br>
<span class="lineno"></span><span class="op" id="1600308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1600311">func</span>&nbsp;<span class="ident" id="1600316">netpollclosing</span><span class="op" id="1600330">(</span><span class="ident" id="1600331">pd</span>&nbsp;<span class="op" id="1600334">*</span><span class="ident" id="1600335">pollDesc</span><span class="op" id="1600343">)</span>&nbsp;<span class="builtintype" id="1600345">bool</span>&nbsp;<span class="op" id="1600350">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600353">return</span>&nbsp;<span class="ident" id="1600360">pd</span><span class="op" id="1600362">.</span><span class="ident" id="1600363">closing</span><br>
<span class="lineno"></span><span class="op" id="1600371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1600374">func</span>&nbsp;<span class="ident" id="1600379">netpolllock</span><span class="op" id="1600390">(</span><span class="ident" id="1600391">pd</span>&nbsp;<span class="op" id="1600394">*</span><span class="ident" id="1600395">pollDesc</span><span class="op" id="1600403">)</span>&nbsp;<span class="op" id="1600405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600408">lock</span><span class="op" id="1600412">(</span><span class="op" id="1600413">&amp;</span><span class="ident" id="1600414">pd</span><span class="op" id="1600416">.</span><span class="ident" id="1600417">lock</span><span class="op" id="1600421">)</span><br>
<span class="lineno">280</span><span class="op" id="1600423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1600426">func</span>&nbsp;<span class="ident" id="1600431">netpollunlock</span><span class="op" id="1600444">(</span><span class="ident" id="1600445">pd</span>&nbsp;<span class="op" id="1600448">*</span><span class="ident" id="1600449">pollDesc</span><span class="op" id="1600457">)</span>&nbsp;<span class="op" id="1600459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600462">unlock</span><span class="op" id="1600468">(</span><span class="op" id="1600469">&amp;</span><span class="ident" id="1600470">pd</span><span class="op" id="1600472">.</span><span class="ident" id="1600473">lock</span><span class="op" id="1600477">)</span><br>
<span class="lineno"></span><span class="op" id="1600479">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="1600482">//&nbsp;make&nbsp;pd&nbsp;ready,&nbsp;newly&nbsp;runnable&nbsp;goroutines&nbsp;(if&nbsp;any)&nbsp;are&nbsp;returned&nbsp;in&nbsp;rg/wg</span><br>
<span class="lineno"></span><span class="keyword" id="1600557">func</span>&nbsp;<span class="ident" id="1600562">netpollready</span><span class="op" id="1600574">(</span><span class="ident" id="1600575">gpp</span>&nbsp;<span class="op" id="1600579">*</span><span class="op" id="1600580">*</span><span class="ident" id="1600581">g</span><span class="op" id="1600582">,</span>&nbsp;<span class="ident" id="1600584">pd</span>&nbsp;<span class="op" id="1600587">*</span><span class="ident" id="1600588">pollDesc</span><span class="op" id="1600596">,</span>&nbsp;<span class="ident" id="1600598">mode</span>&nbsp;<span class="builtintype" id="1600603">int32</span><span class="op" id="1600608">)</span>&nbsp;<span class="op" id="1600610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600613">var</span>&nbsp;<span class="ident" id="1600617">rg</span><span class="op" id="1600619">,</span>&nbsp;<span class="ident" id="1600621">wg</span>&nbsp;<span class="op" id="1600624">*</span><span class="ident" id="1600625">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600628">if</span>&nbsp;<span class="ident" id="1600631">mode</span>&nbsp;<span class="op" id="1600636">==</span>&nbsp;<span class="string" id="1600639">&#39;r&#39;</span>&nbsp;<span class="op" id="1600643">||</span>&nbsp;<span class="ident" id="1600646">mode</span>&nbsp;<span class="op" id="1600651">==</span>&nbsp;<span class="string" id="1600654">&#39;r&#39;</span><span class="op" id="1600657">+</span><span class="string" id="1600658">&#39;w&#39;</span>&nbsp;<span class="op" id="1600662">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600666">rg</span>&nbsp;<span class="op" id="1600669">=</span>&nbsp;<span class="ident" id="1600671">netpollunblock</span><span class="op" id="1600685">(</span><span class="ident" id="1600686">pd</span><span class="op" id="1600688">,</span>&nbsp;<span class="string" id="1600690">&#39;r&#39;</span><span class="op" id="1600693">,</span>&nbsp;<span class="builtintype" id="1600695">true</span><span class="op" id="1600699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600705">if</span>&nbsp;<span class="ident" id="1600708">mode</span>&nbsp;<span class="op" id="1600713">==</span>&nbsp;<span class="string" id="1600716">&#39;w&#39;</span>&nbsp;<span class="op" id="1600720">||</span>&nbsp;<span class="ident" id="1600723">mode</span>&nbsp;<span class="op" id="1600728">==</span>&nbsp;<span class="string" id="1600731">&#39;r&#39;</span><span class="op" id="1600734">+</span><span class="string" id="1600735">&#39;w&#39;</span>&nbsp;<span class="op" id="1600739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600743">wg</span>&nbsp;<span class="op" id="1600746">=</span>&nbsp;<span class="ident" id="1600748">netpollunblock</span><span class="op" id="1600762">(</span><span class="ident" id="1600763">pd</span><span class="op" id="1600765">,</span>&nbsp;<span class="string" id="1600767">&#39;w&#39;</span><span class="op" id="1600770">,</span>&nbsp;<span class="builtintype" id="1600772">true</span><span class="op" id="1600776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600779">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600782">if</span>&nbsp;<span class="ident" id="1600785">rg</span>&nbsp;<span class="op" id="1600788">!=</span>&nbsp;<span class="ident" id="1600791">nil</span>&nbsp;<span class="op" id="1600795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600799">rg</span><span class="op" id="1600801">.</span><span class="ident" id="1600802">schedlink</span>&nbsp;<span class="op" id="1600812">=</span>&nbsp;<span class="op" id="1600814">*</span><span class="ident" id="1600815">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600821">*</span><span class="ident" id="1600822">gpp</span>&nbsp;<span class="op" id="1600826">=</span>&nbsp;<span class="ident" id="1600828">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600835">if</span>&nbsp;<span class="ident" id="1600838">wg</span>&nbsp;<span class="op" id="1600841">!=</span>&nbsp;<span class="ident" id="1600844">nil</span>&nbsp;<span class="op" id="1600848">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1600852">wg</span><span class="op" id="1600854">.</span><span class="ident" id="1600855">schedlink</span>&nbsp;<span class="op" id="1600865">=</span>&nbsp;<span class="op" id="1600867">*</span><span class="ident" id="1600868">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600874">*</span><span class="ident" id="1600875">gpp</span>&nbsp;<span class="op" id="1600879">=</span>&nbsp;<span class="ident" id="1600881">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600885">}</span><br>
<span class="lineno"></span><span class="op" id="1600887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="keyword" id="1600890">func</span>&nbsp;<span class="ident" id="1600895">netpollcheckerr</span><span class="op" id="1600910">(</span><span class="ident" id="1600911">pd</span>&nbsp;<span class="op" id="1600914">*</span><span class="ident" id="1600915">pollDesc</span><span class="op" id="1600923">,</span>&nbsp;<span class="ident" id="1600925">mode</span>&nbsp;<span class="builtintype" id="1600930">int32</span><span class="op" id="1600935">)</span>&nbsp;<span class="builtintype" id="1600937">int</span>&nbsp;<span class="op" id="1600941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600944">if</span>&nbsp;<span class="ident" id="1600947">pd</span><span class="op" id="1600949">.</span><span class="ident" id="1600950">closing</span>&nbsp;<span class="op" id="1600958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600962">return</span>&nbsp;<span class="num" id="1600969">1</span>&nbsp;<span class="comment" id="1600971">//&nbsp;errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1600986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1600989">if</span>&nbsp;<span class="op" id="1600992">(</span><span class="ident" id="1600993">mode</span>&nbsp;<span class="op" id="1600998">==</span>&nbsp;<span class="string" id="1601001">&#39;r&#39;</span>&nbsp;<span class="op" id="1601005">&amp;&amp;</span>&nbsp;<span class="ident" id="1601008">pd</span><span class="op" id="1601010">.</span><span class="ident" id="1601011">rd</span>&nbsp;<span class="op" id="1601014">&lt;</span>&nbsp;<span class="num" id="1601016">0</span><span class="op" id="1601017">)</span>&nbsp;<span class="op" id="1601019">||</span>&nbsp;<span class="op" id="1601022">(</span><span class="ident" id="1601023">mode</span>&nbsp;<span class="op" id="1601028">==</span>&nbsp;<span class="string" id="1601031">&#39;w&#39;</span>&nbsp;<span class="op" id="1601035">&amp;&amp;</span>&nbsp;<span class="ident" id="1601038">pd</span><span class="op" id="1601040">.</span><span class="ident" id="1601041">wd</span>&nbsp;<span class="op" id="1601044">&lt;</span>&nbsp;<span class="num" id="1601046">0</span><span class="op" id="1601047">)</span>&nbsp;<span class="op" id="1601049">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601053">return</span>&nbsp;<span class="num" id="1601060">2</span>&nbsp;<span class="comment" id="1601062">//&nbsp;errTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601080">return</span>&nbsp;<span class="num" id="1601087">0</span><br>
<span class="lineno"></span><span class="op" id="1601089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="keyword" id="1601092">func</span>&nbsp;<span class="ident" id="1601097">netpollblockcommit</span><span class="op" id="1601115">(</span><span class="ident" id="1601116">gp</span>&nbsp;<span class="op" id="1601119">*</span><span class="ident" id="1601120">g</span><span class="op" id="1601121">,</span>&nbsp;<span class="ident" id="1601123">gpp</span>&nbsp;<span class="ident" id="1601127">unsafe</span><span class="op" id="1601133">.</span><span class="ident" id="1601134">Pointer</span><span class="op" id="1601141">)</span>&nbsp;<span class="builtintype" id="1601143">bool</span>&nbsp;<span class="op" id="1601148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601151">return</span>&nbsp;<span class="ident" id="1601158">casuintptr</span><span class="op" id="1601168">(</span><span class="op" id="1601169">(</span><span class="op" id="1601170">*</span><span class="builtintype" id="1601171">uintptr</span><span class="op" id="1601178">)</span><span class="op" id="1601179">(</span><span class="ident" id="1601180">gpp</span><span class="op" id="1601183">)</span><span class="op" id="1601184">,</span>&nbsp;<span class="ident" id="1601186">pdWait</span><span class="op" id="1601192">,</span>&nbsp;<span class="builtintype" id="1601194">uintptr</span><span class="op" id="1601201">(</span><span class="ident" id="1601202">unsafe</span><span class="op" id="1601208">.</span><span class="ident" id="1601209">Pointer</span><span class="op" id="1601216">(</span><span class="ident" id="1601217">gp</span><span class="op" id="1601219">)</span><span class="op" id="1601220">)</span><span class="op" id="1601221">)</span><br>
<span class="lineno"></span><span class="op" id="1601223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1601226">//&nbsp;returns&nbsp;true&nbsp;if&nbsp;IO&nbsp;is&nbsp;ready,&nbsp;or&nbsp;false&nbsp;if&nbsp;timedout&nbsp;or&nbsp;closed</span><br>
<span class="lineno">320</span><span class="comment" id="1601289">//&nbsp;waitio&nbsp;-&nbsp;wait&nbsp;only&nbsp;for&nbsp;completed&nbsp;IO,&nbsp;ignore&nbsp;errors</span><br>
<span class="lineno"></span><span class="keyword" id="1601343">func</span>&nbsp;<span class="ident" id="1601348">netpollblock</span><span class="op" id="1601360">(</span><span class="ident" id="1601361">pd</span>&nbsp;<span class="op" id="1601364">*</span><span class="ident" id="1601365">pollDesc</span><span class="op" id="1601373">,</span>&nbsp;<span class="ident" id="1601375">mode</span>&nbsp;<span class="builtintype" id="1601380">int32</span><span class="op" id="1601385">,</span>&nbsp;<span class="ident" id="1601387">waitio</span>&nbsp;<span class="builtintype" id="1601394">bool</span><span class="op" id="1601398">)</span>&nbsp;<span class="builtintype" id="1601400">bool</span>&nbsp;<span class="op" id="1601405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601408">gpp</span>&nbsp;<span class="op" id="1601412">:=</span>&nbsp;<span class="op" id="1601415">&amp;</span><span class="ident" id="1601416">pd</span><span class="op" id="1601418">.</span><span class="ident" id="1601419">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601423">if</span>&nbsp;<span class="ident" id="1601426">mode</span>&nbsp;<span class="op" id="1601431">==</span>&nbsp;<span class="string" id="1601434">&#39;w&#39;</span>&nbsp;<span class="op" id="1601438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601442">gpp</span>&nbsp;<span class="op" id="1601446">=</span>&nbsp;<span class="op" id="1601448">&amp;</span><span class="ident" id="1601449">pd</span><span class="op" id="1601451">.</span><span class="ident" id="1601452">wg</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1601460">//&nbsp;set&nbsp;the&nbsp;gpp&nbsp;semaphore&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601494">for</span>&nbsp;<span class="op" id="1601498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601502">old</span>&nbsp;<span class="op" id="1601506">:=</span>&nbsp;<span class="op" id="1601509">*</span><span class="ident" id="1601510">gpp</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601516">if</span>&nbsp;<span class="ident" id="1601519">old</span>&nbsp;<span class="op" id="1601523">==</span>&nbsp;<span class="ident" id="1601526">pdReady</span>&nbsp;<span class="op" id="1601534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601539">*</span><span class="ident" id="1601540">gpp</span>&nbsp;<span class="op" id="1601544">=</span>&nbsp;<span class="num" id="1601546">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601551">return</span>&nbsp;<span class="builtintype" id="1601558">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601569">if</span>&nbsp;<span class="ident" id="1601572">old</span>&nbsp;<span class="op" id="1601576">!=</span>&nbsp;<span class="num" id="1601579">0</span>&nbsp;<span class="op" id="1601581">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601586">gothrow</span><span class="op" id="1601593">(</span><span class="string" id="1601594">&#34;netpollblock:&nbsp;double&nbsp;wait&#34;</span><span class="op" id="1601621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601629">if</span>&nbsp;<span class="ident" id="1601632">casuintptr</span><span class="op" id="1601642">(</span><span class="ident" id="1601643">gpp</span><span class="op" id="1601646">,</span>&nbsp;<span class="num" id="1601648">0</span><span class="op" id="1601649">,</span>&nbsp;<span class="ident" id="1601651">pdWait</span><span class="op" id="1601657">)</span>&nbsp;<span class="op" id="1601659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601664">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601672">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1601675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1601679">//&nbsp;need&nbsp;to&nbsp;recheck&nbsp;error&nbsp;states&nbsp;after&nbsp;setting&nbsp;gpp&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1601738">//&nbsp;this&nbsp;is&nbsp;necessary&nbsp;because&nbsp;runtime_pollUnblock/runtime_pollSetDeadline/deadlineimpl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1601825">//&nbsp;do&nbsp;the&nbsp;opposite:&nbsp;store&nbsp;to&nbsp;closing/rd/wd,&nbsp;membarrier,&nbsp;load&nbsp;of&nbsp;rg/wg</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1601896">if</span>&nbsp;<span class="ident" id="1601899">waitio</span>&nbsp;<span class="op" id="1601906">||</span>&nbsp;<span class="ident" id="1601909">netpollcheckerr</span><span class="op" id="1601924">(</span><span class="ident" id="1601925">pd</span><span class="op" id="1601927">,</span>&nbsp;<span class="ident" id="1601929">mode</span><span class="op" id="1601933">)</span>&nbsp;<span class="op" id="1601935">==</span>&nbsp;<span class="num" id="1601938">0</span>&nbsp;<span class="op" id="1601940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601944">f</span>&nbsp;<span class="op" id="1601946">:=</span>&nbsp;<span class="ident" id="1601949">netpollblockcommit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1601970">gopark</span><span class="op" id="1601976">(</span><span class="op" id="1601977">*</span><span class="op" id="1601978">*</span><span class="op" id="1601979">(</span><span class="op" id="1601980">*</span><span class="op" id="1601981">*</span><span class="ident" id="1601982">unsafe</span><span class="op" id="1601988">.</span><span class="ident" id="1601989">Pointer</span><span class="op" id="1601996">)</span><span class="op" id="1601997">(</span><span class="ident" id="1601998">unsafe</span><span class="op" id="1602004">.</span><span class="ident" id="1602005">Pointer</span><span class="op" id="1602012">(</span><span class="op" id="1602013">&amp;</span><span class="ident" id="1602014">f</span><span class="op" id="1602015">)</span><span class="op" id="1602016">)</span><span class="op" id="1602017">,</span>&nbsp;<span class="ident" id="1602019">unsafe</span><span class="op" id="1602025">.</span><span class="ident" id="1602026">Pointer</span><span class="op" id="1602033">(</span><span class="ident" id="1602034">gpp</span><span class="op" id="1602037">)</span><span class="op" id="1602038">,</span>&nbsp;<span class="string" id="1602040">&#34;IO&nbsp;wait&#34;</span><span class="op" id="1602049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602055">//&nbsp;be&nbsp;careful&nbsp;to&nbsp;not&nbsp;lose&nbsp;concurrent&nbsp;READY&nbsp;notification</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602112">old</span>&nbsp;<span class="op" id="1602116">:=</span>&nbsp;<span class="ident" id="1602119">xchguintptr</span><span class="op" id="1602130">(</span><span class="ident" id="1602131">gpp</span><span class="op" id="1602134">,</span>&nbsp;<span class="num" id="1602136">0</span><span class="op" id="1602137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602140">if</span>&nbsp;<span class="ident" id="1602143">old</span>&nbsp;<span class="op" id="1602147">&gt;</span>&nbsp;<span class="ident" id="1602149">pdWait</span>&nbsp;<span class="op" id="1602156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602160">gothrow</span><span class="op" id="1602167">(</span><span class="string" id="1602168">&#34;netpollblock:&nbsp;corrupted&nbsp;state&#34;</span><span class="op" id="1602199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602205">return</span>&nbsp;<span class="ident" id="1602212">old</span>&nbsp;<span class="op" id="1602216">==</span>&nbsp;<span class="ident" id="1602219">pdReady</span><br>
<span class="lineno">355</span><span class="op" id="1602227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1602230">func</span>&nbsp;<span class="ident" id="1602235">netpollunblock</span><span class="op" id="1602249">(</span><span class="ident" id="1602250">pd</span>&nbsp;<span class="op" id="1602253">*</span><span class="ident" id="1602254">pollDesc</span><span class="op" id="1602262">,</span>&nbsp;<span class="ident" id="1602264">mode</span>&nbsp;<span class="builtintype" id="1602269">int32</span><span class="op" id="1602274">,</span>&nbsp;<span class="ident" id="1602276">ioready</span>&nbsp;<span class="builtintype" id="1602284">bool</span><span class="op" id="1602288">)</span>&nbsp;<span class="op" id="1602290">*</span><span class="ident" id="1602291">g</span>&nbsp;<span class="op" id="1602293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602296">gpp</span>&nbsp;<span class="op" id="1602300">:=</span>&nbsp;<span class="op" id="1602303">&amp;</span><span class="ident" id="1602304">pd</span><span class="op" id="1602306">.</span><span class="ident" id="1602307">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602311">if</span>&nbsp;<span class="ident" id="1602314">mode</span>&nbsp;<span class="op" id="1602319">==</span>&nbsp;<span class="string" id="1602322">&#39;w&#39;</span>&nbsp;<span class="op" id="1602326">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602330">gpp</span>&nbsp;<span class="op" id="1602334">=</span>&nbsp;<span class="op" id="1602336">&amp;</span><span class="ident" id="1602337">pd</span><span class="op" id="1602339">.</span><span class="ident" id="1602340">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602348">for</span>&nbsp;<span class="op" id="1602352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602356">old</span>&nbsp;<span class="op" id="1602360">:=</span>&nbsp;<span class="op" id="1602363">*</span><span class="ident" id="1602364">gpp</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602370">if</span>&nbsp;<span class="ident" id="1602373">old</span>&nbsp;<span class="op" id="1602377">==</span>&nbsp;<span class="ident" id="1602380">pdReady</span>&nbsp;<span class="op" id="1602388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602393">return</span>&nbsp;<span class="ident" id="1602400">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602410">if</span>&nbsp;<span class="ident" id="1602413">old</span>&nbsp;<span class="op" id="1602417">==</span>&nbsp;<span class="num" id="1602420">0</span>&nbsp;<span class="op" id="1602422">&amp;&amp;</span>&nbsp;<span class="op" id="1602425">!</span><span class="ident" id="1602426">ioready</span>&nbsp;<span class="op" id="1602434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602439">//&nbsp;Only&nbsp;set&nbsp;READY&nbsp;for&nbsp;ioready.&nbsp;runtime_pollWait</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602490">//&nbsp;will&nbsp;check&nbsp;for&nbsp;timeout/cancel&nbsp;before&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602542">return</span>&nbsp;<span class="ident" id="1602549">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602559">var</span>&nbsp;<span class="builtinfunc" id="1602563">new</span>&nbsp;<span class="builtintype" id="1602567">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602577">if</span>&nbsp;<span class="ident" id="1602580">ioready</span>&nbsp;<span class="op" id="1602588">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1602593">new</span>&nbsp;<span class="op" id="1602597">=</span>&nbsp;<span class="ident" id="1602599">pdReady</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602613">if</span>&nbsp;<span class="ident" id="1602616">casuintptr</span><span class="op" id="1602626">(</span><span class="ident" id="1602627">gpp</span><span class="op" id="1602630">,</span>&nbsp;<span class="ident" id="1602632">old</span><span class="op" id="1602635">,</span>&nbsp;<span class="builtinfunc" id="1602637">new</span><span class="op" id="1602640">)</span>&nbsp;<span class="op" id="1602642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602647">if</span>&nbsp;<span class="ident" id="1602650">old</span>&nbsp;<span class="op" id="1602654">==</span>&nbsp;<span class="ident" id="1602657">pdReady</span>&nbsp;<span class="op" id="1602665">||</span>&nbsp;<span class="ident" id="1602668">old</span>&nbsp;<span class="op" id="1602672">==</span>&nbsp;<span class="ident" id="1602675">pdWait</span>&nbsp;<span class="op" id="1602682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602688">old</span>&nbsp;<span class="op" id="1602692">=</span>&nbsp;<span class="num" id="1602694">0</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602704">return</span>&nbsp;<span class="op" id="1602711">(</span><span class="op" id="1602712">*</span><span class="ident" id="1602713">g</span><span class="op" id="1602714">)</span><span class="op" id="1602715">(</span><span class="ident" id="1602716">unsafe</span><span class="op" id="1602722">.</span><span class="ident" id="1602723">Pointer</span><span class="op" id="1602730">(</span><span class="ident" id="1602731">old</span><span class="op" id="1602734">)</span><span class="op" id="1602735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1602742">}</span><br>
<span class="lineno"></span><span class="op" id="1602744">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="keyword" id="1602747">func</span>&nbsp;<span class="ident" id="1602752">netpolldeadlineimpl</span><span class="op" id="1602771">(</span><span class="ident" id="1602772">pd</span>&nbsp;<span class="op" id="1602775">*</span><span class="ident" id="1602776">pollDesc</span><span class="op" id="1602784">,</span>&nbsp;<span class="ident" id="1602786">seq</span>&nbsp;<span class="builtintype" id="1602790">uintptr</span><span class="op" id="1602797">,</span>&nbsp;<span class="ident" id="1602799">read</span><span class="op" id="1602803">,</span>&nbsp;<span class="ident" id="1602805">write</span>&nbsp;<span class="builtintype" id="1602811">bool</span><span class="op" id="1602815">)</span>&nbsp;<span class="op" id="1602817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602820">lock</span><span class="op" id="1602824">(</span><span class="op" id="1602825">&amp;</span><span class="ident" id="1602826">pd</span><span class="op" id="1602828">.</span><span class="ident" id="1602829">lock</span><span class="op" id="1602833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602836">//&nbsp;Seq&nbsp;arg&nbsp;is&nbsp;seq&nbsp;when&nbsp;the&nbsp;timer&nbsp;was&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602879">//&nbsp;If&nbsp;it&#39;s&nbsp;stale,&nbsp;ignore&nbsp;the&nbsp;timer&nbsp;event.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1602922">if</span>&nbsp;<span class="ident" id="1602925">seq</span>&nbsp;<span class="op" id="1602929">!=</span>&nbsp;<span class="ident" id="1602932">pd</span><span class="op" id="1602934">.</span><span class="ident" id="1602935">seq</span>&nbsp;<span class="op" id="1602939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1602943">//&nbsp;The&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1602996">unlock</span><span class="op" id="1603002">(</span><span class="op" id="1603003">&amp;</span><span class="ident" id="1603004">pd</span><span class="op" id="1603006">.</span><span class="ident" id="1603007">lock</span><span class="op" id="1603011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603015">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603023">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603026">var</span>&nbsp;<span class="ident" id="1603030">rg</span>&nbsp;<span class="op" id="1603033">*</span><span class="ident" id="1603034">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603037">if</span>&nbsp;<span class="ident" id="1603040">read</span>&nbsp;<span class="op" id="1603045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603049">if</span>&nbsp;<span class="ident" id="1603052">pd</span><span class="op" id="1603054">.</span><span class="ident" id="1603055">rd</span>&nbsp;<span class="op" id="1603058">&lt;=</span>&nbsp;<span class="num" id="1603061">0</span>&nbsp;<span class="op" id="1603063">||</span>&nbsp;<span class="ident" id="1603066">pd</span><span class="op" id="1603068">.</span><span class="ident" id="1603069">rt</span><span class="op" id="1603071">.</span><span class="ident" id="1603072">f</span>&nbsp;<span class="op" id="1603074">==</span>&nbsp;<span class="ident" id="1603077">nil</span>&nbsp;<span class="op" id="1603081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603086">gothrow</span><span class="op" id="1603093">(</span><span class="string" id="1603094">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;read&nbsp;deadline&#34;</span><span class="op" id="1603143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603147">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603151">pd</span><span class="op" id="1603153">.</span><span class="ident" id="1603154">rd</span>&nbsp;<span class="op" id="1603157">=</span>&nbsp;<span class="op" id="1603159">-</span><span class="num" id="1603160">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603164">atomicstorep</span><span class="op" id="1603176">(</span><span class="ident" id="1603177">unsafe</span><span class="op" id="1603183">.</span><span class="ident" id="1603184">Pointer</span><span class="op" id="1603191">(</span><span class="op" id="1603192">&amp;</span><span class="ident" id="1603193">pd</span><span class="op" id="1603195">.</span><span class="ident" id="1603196">rt</span><span class="op" id="1603198">.</span><span class="ident" id="1603199">f</span><span class="op" id="1603200">)</span><span class="op" id="1603201">,</span>&nbsp;<span class="ident" id="1603203">nil</span><span class="op" id="1603206">)</span>&nbsp;<span class="comment" id="1603208">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;rd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603286">rg</span>&nbsp;<span class="op" id="1603289">=</span>&nbsp;<span class="ident" id="1603291">netpollunblock</span><span class="op" id="1603305">(</span><span class="ident" id="1603306">pd</span><span class="op" id="1603308">,</span>&nbsp;<span class="string" id="1603310">&#39;r&#39;</span><span class="op" id="1603313">,</span>&nbsp;<span class="builtintype" id="1603315">false</span><span class="op" id="1603320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603326">var</span>&nbsp;<span class="ident" id="1603330">wg</span>&nbsp;<span class="op" id="1603333">*</span><span class="ident" id="1603334">g</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603337">if</span>&nbsp;<span class="ident" id="1603340">write</span>&nbsp;<span class="op" id="1603346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603350">if</span>&nbsp;<span class="ident" id="1603353">pd</span><span class="op" id="1603355">.</span><span class="ident" id="1603356">wd</span>&nbsp;<span class="op" id="1603359">&lt;=</span>&nbsp;<span class="num" id="1603362">0</span>&nbsp;<span class="op" id="1603364">||</span>&nbsp;<span class="ident" id="1603367">pd</span><span class="op" id="1603369">.</span><span class="ident" id="1603370">wt</span><span class="op" id="1603372">.</span><span class="ident" id="1603373">f</span>&nbsp;<span class="op" id="1603375">==</span>&nbsp;<span class="ident" id="1603378">nil</span>&nbsp;<span class="op" id="1603382">&amp;&amp;</span>&nbsp;<span class="op" id="1603385">!</span><span class="ident" id="1603386">read</span>&nbsp;<span class="op" id="1603391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603396">gothrow</span><span class="op" id="1603403">(</span><span class="string" id="1603404">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;write&nbsp;deadline&#34;</span><span class="op" id="1603454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603462">pd</span><span class="op" id="1603464">.</span><span class="ident" id="1603465">wd</span>&nbsp;<span class="op" id="1603468">=</span>&nbsp;<span class="op" id="1603470">-</span><span class="num" id="1603471">1</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603475">atomicstorep</span><span class="op" id="1603487">(</span><span class="ident" id="1603488">unsafe</span><span class="op" id="1603494">.</span><span class="ident" id="1603495">Pointer</span><span class="op" id="1603502">(</span><span class="op" id="1603503">&amp;</span><span class="ident" id="1603504">pd</span><span class="op" id="1603506">.</span><span class="ident" id="1603507">wt</span><span class="op" id="1603509">.</span><span class="ident" id="1603510">f</span><span class="op" id="1603511">)</span><span class="op" id="1603512">,</span>&nbsp;<span class="ident" id="1603514">nil</span><span class="op" id="1603517">)</span>&nbsp;<span class="comment" id="1603519">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;wd&nbsp;and&nbsp;load&nbsp;of&nbsp;wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603597">wg</span>&nbsp;<span class="op" id="1603600">=</span>&nbsp;<span class="ident" id="1603602">netpollunblock</span><span class="op" id="1603616">(</span><span class="ident" id="1603617">pd</span><span class="op" id="1603619">,</span>&nbsp;<span class="string" id="1603621">&#39;w&#39;</span><span class="op" id="1603624">,</span>&nbsp;<span class="builtintype" id="1603626">false</span><span class="op" id="1603631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603637">unlock</span><span class="op" id="1603643">(</span><span class="op" id="1603644">&amp;</span><span class="ident" id="1603645">pd</span><span class="op" id="1603647">.</span><span class="ident" id="1603648">lock</span><span class="op" id="1603652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603655">if</span>&nbsp;<span class="ident" id="1603658">rg</span>&nbsp;<span class="op" id="1603661">!=</span>&nbsp;<span class="ident" id="1603664">nil</span>&nbsp;<span class="op" id="1603668">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603672">goready</span><span class="op" id="1603679">(</span><span class="ident" id="1603680">rg</span><span class="op" id="1603682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1603688">if</span>&nbsp;<span class="ident" id="1603691">wg</span>&nbsp;<span class="op" id="1603694">!=</span>&nbsp;<span class="ident" id="1603697">nil</span>&nbsp;<span class="op" id="1603701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603705">goready</span><span class="op" id="1603712">(</span><span class="ident" id="1603713">wg</span><span class="op" id="1603715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1603718">}</span><br>
<span class="lineno">420</span><span class="op" id="1603720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1603723">func</span>&nbsp;<span class="ident" id="1603728">netpollDeadline</span><span class="op" id="1603743">(</span><span class="ident" id="1603744">arg</span>&nbsp;<span class="keyword" id="1603748">interface</span><span class="op" id="1603757">{</span><span class="op" id="1603758">}</span><span class="op" id="1603759">,</span>&nbsp;<span class="ident" id="1603761">seq</span>&nbsp;<span class="builtintype" id="1603765">uintptr</span><span class="op" id="1603772">)</span>&nbsp;<span class="op" id="1603774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603777">netpolldeadlineimpl</span><span class="op" id="1603796">(</span><span class="ident" id="1603797">arg</span><span class="op" id="1603800">.</span><span class="op" id="1603801">(</span><span class="op" id="1603802">*</span><span class="ident" id="1603803">pollDesc</span><span class="op" id="1603811">)</span><span class="op" id="1603812">,</span>&nbsp;<span class="ident" id="1603814">seq</span><span class="op" id="1603817">,</span>&nbsp;<span class="builtintype" id="1603819">true</span><span class="op" id="1603823">,</span>&nbsp;<span class="builtintype" id="1603825">true</span><span class="op" id="1603829">)</span><br>
<span class="lineno"></span><span class="op" id="1603831">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="1603834">func</span>&nbsp;<span class="ident" id="1603839">netpollReadDeadline</span><span class="op" id="1603858">(</span><span class="ident" id="1603859">arg</span>&nbsp;<span class="keyword" id="1603863">interface</span><span class="op" id="1603872">{</span><span class="op" id="1603873">}</span><span class="op" id="1603874">,</span>&nbsp;<span class="ident" id="1603876">seq</span>&nbsp;<span class="builtintype" id="1603880">uintptr</span><span class="op" id="1603887">)</span>&nbsp;<span class="op" id="1603889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1603892">netpolldeadlineimpl</span><span class="op" id="1603911">(</span><span class="ident" id="1603912">arg</span><span class="op" id="1603915">.</span><span class="op" id="1603916">(</span><span class="op" id="1603917">*</span><span class="ident" id="1603918">pollDesc</span><span class="op" id="1603926">)</span><span class="op" id="1603927">,</span>&nbsp;<span class="ident" id="1603929">seq</span><span class="op" id="1603932">,</span>&nbsp;<span class="builtintype" id="1603934">true</span><span class="op" id="1603938">,</span>&nbsp;<span class="builtintype" id="1603940">false</span><span class="op" id="1603945">)</span><br>
<span class="lineno"></span><span class="op" id="1603947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="keyword" id="1603950">func</span>&nbsp;<span class="ident" id="1603955">netpollWriteDeadline</span><span class="op" id="1603975">(</span><span class="ident" id="1603976">arg</span>&nbsp;<span class="keyword" id="1603980">interface</span><span class="op" id="1603989">{</span><span class="op" id="1603990">}</span><span class="op" id="1603991">,</span>&nbsp;<span class="ident" id="1603993">seq</span>&nbsp;<span class="builtintype" id="1603997">uintptr</span><span class="op" id="1604004">)</span>&nbsp;<span class="op" id="1604006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604009">netpolldeadlineimpl</span><span class="op" id="1604028">(</span><span class="ident" id="1604029">arg</span><span class="op" id="1604032">.</span><span class="op" id="1604033">(</span><span class="op" id="1604034">*</span><span class="ident" id="1604035">pollDesc</span><span class="op" id="1604043">)</span><span class="op" id="1604044">,</span>&nbsp;<span class="ident" id="1604046">seq</span><span class="op" id="1604049">,</span>&nbsp;<span class="builtintype" id="1604051">false</span><span class="op" id="1604056">,</span>&nbsp;<span class="builtintype" id="1604058">true</span><span class="op" id="1604062">)</span><br>
<span class="lineno"></span><span class="op" id="1604064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1604067">func</span>&nbsp;<span class="op" id="1604072">(</span><span class="ident" id="1604073">c</span>&nbsp;<span class="op" id="1604075">*</span><span class="ident" id="1604076">pollCache</span><span class="op" id="1604085">)</span>&nbsp;<span class="ident" id="1604087">alloc</span><span class="op" id="1604092">(</span><span class="op" id="1604093">)</span>&nbsp;<span class="op" id="1604095">*</span><span class="ident" id="1604096">pollDesc</span>&nbsp;<span class="op" id="1604105">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604108">lock</span><span class="op" id="1604112">(</span><span class="op" id="1604113">&amp;</span><span class="ident" id="1604114">c</span><span class="op" id="1604115">.</span><span class="ident" id="1604116">lock</span><span class="op" id="1604120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604123">if</span>&nbsp;<span class="ident" id="1604126">c</span><span class="op" id="1604127">.</span><span class="ident" id="1604128">first</span>&nbsp;<span class="op" id="1604134">==</span>&nbsp;<span class="ident" id="1604137">nil</span>&nbsp;<span class="op" id="1604141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604145">const</span>&nbsp;<span class="ident" id="1604151">pdSize</span>&nbsp;<span class="op" id="1604158">=</span>&nbsp;<span class="ident" id="1604160">unsafe</span><span class="op" id="1604166">.</span><span class="ident" id="1604167">Sizeof</span><span class="op" id="1604173">(</span><span class="ident" id="1604174">pollDesc</span><span class="op" id="1604182">{</span><span class="op" id="1604183">}</span><span class="op" id="1604184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604188">n</span>&nbsp;<span class="op" id="1604190">:=</span>&nbsp;<span class="ident" id="1604193">pollBlockSize</span>&nbsp;<span class="op" id="1604207">/</span>&nbsp;<span class="ident" id="1604209">pdSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604218">if</span>&nbsp;<span class="ident" id="1604221">n</span>&nbsp;<span class="op" id="1604223">==</span>&nbsp;<span class="num" id="1604226">0</span>&nbsp;<span class="op" id="1604228">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604233">n</span>&nbsp;<span class="op" id="1604235">=</span>&nbsp;<span class="num" id="1604237">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1604241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604245">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;non-GC&nbsp;memory&nbsp;because&nbsp;can&nbsp;be&nbsp;referenced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1604301">//&nbsp;only&nbsp;from&nbsp;epoll/kqueue&nbsp;internals.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604340">mem</span>&nbsp;<span class="op" id="1604344">:=</span>&nbsp;<span class="ident" id="1604347">persistentalloc</span><span class="op" id="1604362">(</span><span class="ident" id="1604363">n</span><span class="op" id="1604364">*</span><span class="ident" id="1604365">pdSize</span><span class="op" id="1604371">,</span>&nbsp;<span class="num" id="1604373">0</span><span class="op" id="1604374">,</span>&nbsp;<span class="op" id="1604376">&amp;</span><span class="ident" id="1604377">memstats</span><span class="op" id="1604385">.</span><span class="ident" id="1604386">other_sys</span><span class="op" id="1604395">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604399">for</span>&nbsp;<span class="ident" id="1604403">i</span>&nbsp;<span class="op" id="1604405">:=</span>&nbsp;<span class="builtintype" id="1604408">uintptr</span><span class="op" id="1604415">(</span><span class="num" id="1604416">0</span><span class="op" id="1604417">)</span><span class="op" id="1604418">;</span>&nbsp;<span class="ident" id="1604420">i</span>&nbsp;<span class="op" id="1604422">&lt;</span>&nbsp;<span class="ident" id="1604424">n</span><span class="op" id="1604425">;</span>&nbsp;<span class="ident" id="1604427">i</span><span class="op" id="1604428">++</span>&nbsp;<span class="op" id="1604431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604436">pd</span>&nbsp;<span class="op" id="1604439">:=</span>&nbsp;<span class="op" id="1604442">(</span><span class="op" id="1604443">*</span><span class="ident" id="1604444">pollDesc</span><span class="op" id="1604452">)</span><span class="op" id="1604453">(</span><span class="ident" id="1604454">add</span><span class="op" id="1604457">(</span><span class="ident" id="1604458">mem</span><span class="op" id="1604461">,</span>&nbsp;<span class="ident" id="1604463">i</span><span class="op" id="1604464">*</span><span class="ident" id="1604465">pdSize</span><span class="op" id="1604471">)</span><span class="op" id="1604472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604477">pd</span><span class="op" id="1604479">.</span><span class="ident" id="1604480">link</span>&nbsp;<span class="op" id="1604485">=</span>&nbsp;<span class="ident" id="1604487">c</span><span class="op" id="1604488">.</span><span class="ident" id="1604489">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604498">c</span><span class="op" id="1604499">.</span><span class="ident" id="1604500">first</span>&nbsp;<span class="op" id="1604506">=</span>&nbsp;<span class="ident" id="1604508">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1604513">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1604516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604519">pd</span>&nbsp;<span class="op" id="1604522">:=</span>&nbsp;<span class="ident" id="1604525">c</span><span class="op" id="1604526">.</span><span class="ident" id="1604527">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604534">c</span><span class="op" id="1604535">.</span><span class="ident" id="1604536">first</span>&nbsp;<span class="op" id="1604542">=</span>&nbsp;<span class="ident" id="1604544">pd</span><span class="op" id="1604546">.</span><span class="ident" id="1604547">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1604553">unlock</span><span class="op" id="1604559">(</span><span class="op" id="1604560">&amp;</span><span class="ident" id="1604561">c</span><span class="op" id="1604562">.</span><span class="ident" id="1604563">lock</span><span class="op" id="1604567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1604570">return</span>&nbsp;<span class="ident" id="1604577">pd</span><br>
<span class="lineno">455</span><span class="op" id="1604580">}</span>
</div>
</body>
</html>
