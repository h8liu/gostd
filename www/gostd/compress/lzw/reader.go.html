<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4573245">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4573300">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4573354">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4573405">//&nbsp;Package&nbsp;lzw&nbsp;implements&nbsp;the&nbsp;Lempel-Ziv-Welch&nbsp;compressed&nbsp;data&nbsp;format,</span><br>
<span class="lineno"></span><span class="comment" id="4573476">//&nbsp;described&nbsp;in&nbsp;T.&nbsp;A.&nbsp;Welch,&nbsp;``A&nbsp;Technique&nbsp;for&nbsp;High-Performance&nbsp;Data</span><br>
<span class="lineno"></span><span class="comment" id="4573545">//&nbsp;Compression&#39;&#39;,&nbsp;Computer,&nbsp;17(6)&nbsp;(June&nbsp;1984),&nbsp;pp&nbsp;8-19.</span><br>
<span class="lineno"></span><span class="comment" id="4573601">//</span><br>
<span class="lineno"></span><span class="comment" id="4573604">//&nbsp;In&nbsp;particular,&nbsp;it&nbsp;implements&nbsp;LZW&nbsp;as&nbsp;used&nbsp;by&nbsp;the&nbsp;GIF&nbsp;and&nbsp;PDF&nbsp;file</span><br>
<span class="lineno">10</span><span class="comment" id="4573672">//&nbsp;formats,&nbsp;which&nbsp;means&nbsp;variable-width&nbsp;codes&nbsp;up&nbsp;to&nbsp;12&nbsp;bits&nbsp;and&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="4573745">//&nbsp;two&nbsp;non-literal&nbsp;codes&nbsp;are&nbsp;a&nbsp;clear&nbsp;code&nbsp;and&nbsp;an&nbsp;EOF&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="4573804">//</span><br>
<span class="lineno"></span><span class="comment" id="4573807">//&nbsp;The&nbsp;TIFF&nbsp;file&nbsp;format&nbsp;uses&nbsp;a&nbsp;similar&nbsp;but&nbsp;incompatible&nbsp;version&nbsp;of&nbsp;the&nbsp;LZW</span><br>
<span class="lineno"></span><span class="comment" id="4573882">//&nbsp;algorithm.&nbsp;See&nbsp;the&nbsp;golang.org/x/image/tiff/lzw&nbsp;package&nbsp;for&nbsp;an</span><br>
<span class="lineno">15</span><span class="comment" id="4573947">//&nbsp;implementation.</span><br>
<span class="lineno"></span><span class="keyword" id="4573966">package</span>&nbsp;<span class="ident" id="4573974">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4573979">//&nbsp;TODO(nigeltao):&nbsp;check&nbsp;that&nbsp;PDF&nbsp;uses&nbsp;LZW&nbsp;in&nbsp;the&nbsp;same&nbsp;way&nbsp;as&nbsp;GIF,</span><br>
<span class="lineno"></span><span class="comment" id="4574046">//&nbsp;modulo&nbsp;LSB/MSB&nbsp;packing&nbsp;order.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4574080">import</span>&nbsp;<span class="op" id="4574087">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4574090">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4574099">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4574109">&#34;fmt&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4574116">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4574121">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4574124">//&nbsp;Order&nbsp;specifies&nbsp;the&nbsp;bit&nbsp;ordering&nbsp;in&nbsp;an&nbsp;LZW&nbsp;data&nbsp;stream.</span><br>
<span class="lineno"></span><span class="keyword" id="4574183">type</span>&nbsp;<span class="ident" id="4574188">Order</span>&nbsp;<span class="builtintype" id="4574194">int</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="4574199">const</span>&nbsp;<span class="op" id="4574205">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574208">//&nbsp;LSB&nbsp;means&nbsp;Least&nbsp;Significant&nbsp;Bits&nbsp;first,&nbsp;as&nbsp;used&nbsp;in&nbsp;the&nbsp;GIF&nbsp;file&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574284">LSB</span>&nbsp;<span class="ident" id="4574288">Order</span>&nbsp;<span class="op" id="4574294">=</span>&nbsp;<span class="ident" id="4574296">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574302">//&nbsp;MSB&nbsp;means&nbsp;Most&nbsp;Significant&nbsp;Bits&nbsp;first,&nbsp;as&nbsp;used&nbsp;in&nbsp;the&nbsp;TIFF&nbsp;and&nbsp;PDF</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574373">//&nbsp;file&nbsp;formats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574391">MSB</span><br>
<span class="lineno"></span><span class="op" id="4574395">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4574398">const</span>&nbsp;<span class="op" id="4574404">(</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574407">maxWidth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4574426">=</span>&nbsp;<span class="num" id="4574428">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574432">decoderInvalidCode</span>&nbsp;<span class="op" id="4574451">=</span>&nbsp;<span class="num" id="4574453">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574461">flushBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4574480">=</span>&nbsp;<span class="num" id="4574482">1</span>&nbsp;<span class="op" id="4574484">&lt;&lt;</span>&nbsp;<span class="ident" id="4574487">maxWidth</span><br>
<span class="lineno"></span><span class="op" id="4574496">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="4574499">//&nbsp;decoder&nbsp;is&nbsp;the&nbsp;state&nbsp;from&nbsp;which&nbsp;the&nbsp;readXxx&nbsp;method&nbsp;converts&nbsp;a&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="4574569">//&nbsp;stream&nbsp;into&nbsp;a&nbsp;code&nbsp;stream.</span><br>
<span class="lineno"></span><span class="keyword" id="4574599">type</span>&nbsp;<span class="ident" id="4574604">decoder</span>&nbsp;<span class="keyword" id="4574612">struct</span>&nbsp;<span class="op" id="4574619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574622">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4574631">io</span><span class="op" id="4574633">.</span><span class="ident" id="4574634">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574646">bits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4574655">uint32</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574663">nBits</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4574672">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574678">width</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4574687">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574693">read</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4574702">func</span><span class="op" id="4574706">(</span><span class="op" id="4574707">*</span><span class="ident" id="4574708">decoder</span><span class="op" id="4574715">)</span>&nbsp;<span class="op" id="4574717">(</span><span class="builtintype" id="4574718">uint16</span><span class="op" id="4574724">,</span>&nbsp;<span class="builtintype" id="4574726">error</span><span class="op" id="4574731">)</span>&nbsp;<span class="comment" id="4574733">//&nbsp;readLSB&nbsp;or&nbsp;readMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574756">litWidth</span>&nbsp;<span class="builtintype" id="4574765">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4574796">//&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4574831">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4574840">error</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574848">//&nbsp;The&nbsp;first&nbsp;1&lt;&lt;litWidth&nbsp;codes&nbsp;are&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574899">//&nbsp;The&nbsp;next&nbsp;two&nbsp;codes&nbsp;mean&nbsp;clear&nbsp;and&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4574942">//&nbsp;Other&nbsp;valid&nbsp;codes&nbsp;are&nbsp;in&nbsp;the&nbsp;range&nbsp;[lo,&nbsp;hi]&nbsp;where&nbsp;lo&nbsp;:=&nbsp;clear&nbsp;+&nbsp;2,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575013">//&nbsp;with&nbsp;the&nbsp;upper&nbsp;bound&nbsp;incrementing&nbsp;on&nbsp;each&nbsp;code&nbsp;seen.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575070">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575133">//&nbsp;last&nbsp;is&nbsp;the&nbsp;most&nbsp;recently&nbsp;seen&nbsp;code,&nbsp;or&nbsp;decoderInvalidCode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4575197">clear</span><span class="op" id="4575202">,</span>&nbsp;<span class="ident" id="4575204">eof</span><span class="op" id="4575207">,</span>&nbsp;<span class="ident" id="4575209">hi</span><span class="op" id="4575211">,</span>&nbsp;<span class="ident" id="4575213">overflow</span><span class="op" id="4575221">,</span>&nbsp;<span class="ident" id="4575223">last</span>&nbsp;<span class="builtintype" id="4575228">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575237">//&nbsp;Each&nbsp;code&nbsp;c&nbsp;in&nbsp;[lo,&nbsp;hi]&nbsp;expands&nbsp;to&nbsp;two&nbsp;or&nbsp;more&nbsp;bytes.&nbsp;For&nbsp;c&nbsp;!=&nbsp;hi:</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575308">//&nbsp;&nbsp;&nbsp;suffix[c]&nbsp;is&nbsp;the&nbsp;last&nbsp;of&nbsp;these&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575352">//&nbsp;&nbsp;&nbsp;prefix[c]&nbsp;is&nbsp;the&nbsp;code&nbsp;for&nbsp;all&nbsp;but&nbsp;the&nbsp;last&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575407">//&nbsp;&nbsp;&nbsp;This&nbsp;code&nbsp;can&nbsp;either&nbsp;be&nbsp;a&nbsp;literal&nbsp;code&nbsp;or&nbsp;another&nbsp;code&nbsp;in&nbsp;[lo,&nbsp;c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575480">//&nbsp;The&nbsp;c&nbsp;==&nbsp;hi&nbsp;case&nbsp;is&nbsp;a&nbsp;special&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4575520">suffix</span>&nbsp;<span class="op" id="4575527">[</span><span class="num" id="4575528">1</span>&nbsp;<span class="op" id="4575530">&lt;&lt;</span>&nbsp;<span class="ident" id="4575533">maxWidth</span><span class="op" id="4575541">]</span><span class="builtintype" id="4575542">uint8</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4575549">prefix</span>&nbsp;<span class="op" id="4575556">[</span><span class="num" id="4575557">1</span>&nbsp;<span class="op" id="4575559">&lt;&lt;</span>&nbsp;<span class="ident" id="4575562">maxWidth</span><span class="op" id="4575570">]</span><span class="builtintype" id="4575571">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575580">//&nbsp;output&nbsp;is&nbsp;the&nbsp;temporary&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575623">//&nbsp;Literal&nbsp;codes&nbsp;are&nbsp;accumulated&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575687">//&nbsp;Non-literal&nbsp;codes&nbsp;decode&nbsp;to&nbsp;a&nbsp;sequence&nbsp;of&nbsp;suffixes&nbsp;that&nbsp;are&nbsp;first</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575757">//&nbsp;written&nbsp;right-to-left&nbsp;from&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;buffer&nbsp;before&nbsp;being&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575830">//&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575862">//&nbsp;It&nbsp;is&nbsp;flushed&nbsp;when&nbsp;it&nbsp;contains&nbsp;&gt;=&nbsp;1&lt;&lt;maxWidth&nbsp;bytes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4575919">//&nbsp;so&nbsp;that&nbsp;there&nbsp;is&nbsp;always&nbsp;room&nbsp;to&nbsp;decode&nbsp;an&nbsp;entire&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4575978">output</span>&nbsp;<span class="op" id="4575985">[</span><span class="num" id="4575986">2</span>&nbsp;<span class="op" id="4575988">*</span>&nbsp;<span class="num" id="4575990">1</span>&nbsp;<span class="op" id="4575992">&lt;&lt;</span>&nbsp;<span class="ident" id="4575995">maxWidth</span><span class="op" id="4576003">]</span><span class="builtintype" id="4576004">byte</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576010">o</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4576017">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4576024">//&nbsp;write&nbsp;index&nbsp;into&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576052">toRead</span>&nbsp;<span class="op" id="4576059">[</span><span class="op" id="4576060">]</span><span class="builtintype" id="4576061">byte</span>&nbsp;<span class="comment" id="4576066">//&nbsp;bytes&nbsp;to&nbsp;return&nbsp;from&nbsp;Read</span><br>
<span class="lineno"></span><span class="op" id="4576095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4576098">//&nbsp;readLSB&nbsp;returns&nbsp;the&nbsp;next&nbsp;code&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno">85</span><span class="keyword" id="4576172">func</span>&nbsp;<span class="op" id="4576177">(</span><span class="ident" id="4576178">d</span>&nbsp;<span class="op" id="4576180">*</span><span class="ident" id="4576181">decoder</span><span class="op" id="4576188">)</span>&nbsp;<span class="ident" id="4576190">readLSB</span><span class="op" id="4576197">(</span><span class="op" id="4576198">)</span>&nbsp;<span class="op" id="4576200">(</span><span class="builtintype" id="4576201">uint16</span><span class="op" id="4576207">,</span>&nbsp;<span class="builtintype" id="4576209">error</span><span class="op" id="4576214">)</span>&nbsp;<span class="op" id="4576216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576219">for</span>&nbsp;<span class="ident" id="4576223">d</span><span class="op" id="4576224">.</span><span class="ident" id="4576225">nBits</span>&nbsp;<span class="op" id="4576231">&lt;</span>&nbsp;<span class="ident" id="4576233">d</span><span class="op" id="4576234">.</span><span class="ident" id="4576235">width</span>&nbsp;<span class="op" id="4576241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576245">x</span><span class="op" id="4576246">,</span>&nbsp;<span class="ident" id="4576248">err</span>&nbsp;<span class="op" id="4576252">:=</span>&nbsp;<span class="ident" id="4576255">d</span><span class="op" id="4576256">.</span><span class="ident" id="4576257">r</span><span class="op" id="4576258">.</span><span class="ident" id="4576259">ReadByte</span><span class="op" id="4576267">(</span><span class="op" id="4576268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576272">if</span>&nbsp;<span class="ident" id="4576275">err</span>&nbsp;<span class="op" id="4576279">!=</span>&nbsp;<span class="ident" id="4576282">nil</span>&nbsp;<span class="op" id="4576286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576291">return</span>&nbsp;<span class="num" id="4576298">0</span><span class="op" id="4576299">,</span>&nbsp;<span class="ident" id="4576301">err</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576311">d</span><span class="op" id="4576312">.</span><span class="ident" id="4576313">bits</span>&nbsp;<span class="op" id="4576318">|=</span>&nbsp;<span class="builtintype" id="4576321">uint32</span><span class="op" id="4576327">(</span><span class="ident" id="4576328">x</span><span class="op" id="4576329">)</span>&nbsp;<span class="op" id="4576331">&lt;&lt;</span>&nbsp;<span class="ident" id="4576334">d</span><span class="op" id="4576335">.</span><span class="ident" id="4576336">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576344">d</span><span class="op" id="4576345">.</span><span class="ident" id="4576346">nBits</span>&nbsp;<span class="op" id="4576352">+=</span>&nbsp;<span class="num" id="4576355">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576361">code</span>&nbsp;<span class="op" id="4576366">:=</span>&nbsp;<span class="builtintype" id="4576369">uint16</span><span class="op" id="4576375">(</span><span class="ident" id="4576376">d</span><span class="op" id="4576377">.</span><span class="ident" id="4576378">bits</span>&nbsp;<span class="op" id="4576383">&amp;</span>&nbsp;<span class="op" id="4576385">(</span><span class="num" id="4576386">1</span><span class="op" id="4576387">&lt;&lt;</span><span class="ident" id="4576389">d</span><span class="op" id="4576390">.</span><span class="ident" id="4576391">width</span>&nbsp;<span class="op" id="4576397">-</span>&nbsp;<span class="num" id="4576399">1</span><span class="op" id="4576400">)</span><span class="op" id="4576401">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576404">d</span><span class="op" id="4576405">.</span><span class="ident" id="4576406">bits</span>&nbsp;<span class="op" id="4576411">&gt;&gt;=</span>&nbsp;<span class="ident" id="4576415">d</span><span class="op" id="4576416">.</span><span class="ident" id="4576417">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576424">d</span><span class="op" id="4576425">.</span><span class="ident" id="4576426">nBits</span>&nbsp;<span class="op" id="4576432">-=</span>&nbsp;<span class="ident" id="4576435">d</span><span class="op" id="4576436">.</span><span class="ident" id="4576437">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576444">return</span>&nbsp;<span class="ident" id="4576451">code</span><span class="op" id="4576455">,</span>&nbsp;<span class="ident" id="4576457">nil</span><br>
<span class="lineno"></span><span class="op" id="4576461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="4576464">//&nbsp;readMSB&nbsp;returns&nbsp;the&nbsp;next&nbsp;code&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4576537">func</span>&nbsp;<span class="op" id="4576542">(</span><span class="ident" id="4576543">d</span>&nbsp;<span class="op" id="4576545">*</span><span class="ident" id="4576546">decoder</span><span class="op" id="4576553">)</span>&nbsp;<span class="ident" id="4576555">readMSB</span><span class="op" id="4576562">(</span><span class="op" id="4576563">)</span>&nbsp;<span class="op" id="4576565">(</span><span class="builtintype" id="4576566">uint16</span><span class="op" id="4576572">,</span>&nbsp;<span class="builtintype" id="4576574">error</span><span class="op" id="4576579">)</span>&nbsp;<span class="op" id="4576581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576584">for</span>&nbsp;<span class="ident" id="4576588">d</span><span class="op" id="4576589">.</span><span class="ident" id="4576590">nBits</span>&nbsp;<span class="op" id="4576596">&lt;</span>&nbsp;<span class="ident" id="4576598">d</span><span class="op" id="4576599">.</span><span class="ident" id="4576600">width</span>&nbsp;<span class="op" id="4576606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576610">x</span><span class="op" id="4576611">,</span>&nbsp;<span class="ident" id="4576613">err</span>&nbsp;<span class="op" id="4576617">:=</span>&nbsp;<span class="ident" id="4576620">d</span><span class="op" id="4576621">.</span><span class="ident" id="4576622">r</span><span class="op" id="4576623">.</span><span class="ident" id="4576624">ReadByte</span><span class="op" id="4576632">(</span><span class="op" id="4576633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576637">if</span>&nbsp;<span class="ident" id="4576640">err</span>&nbsp;<span class="op" id="4576644">!=</span>&nbsp;<span class="ident" id="4576647">nil</span>&nbsp;<span class="op" id="4576651">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576656">return</span>&nbsp;<span class="num" id="4576663">0</span><span class="op" id="4576664">,</span>&nbsp;<span class="ident" id="4576666">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576676">d</span><span class="op" id="4576677">.</span><span class="ident" id="4576678">bits</span>&nbsp;<span class="op" id="4576683">|=</span>&nbsp;<span class="builtintype" id="4576686">uint32</span><span class="op" id="4576692">(</span><span class="ident" id="4576693">x</span><span class="op" id="4576694">)</span>&nbsp;<span class="op" id="4576696">&lt;&lt;</span>&nbsp;<span class="op" id="4576699">(</span><span class="num" id="4576700">24</span>&nbsp;<span class="op" id="4576703">-</span>&nbsp;<span class="ident" id="4576705">d</span><span class="op" id="4576706">.</span><span class="ident" id="4576707">nBits</span><span class="op" id="4576712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576716">d</span><span class="op" id="4576717">.</span><span class="ident" id="4576718">nBits</span>&nbsp;<span class="op" id="4576724">+=</span>&nbsp;<span class="num" id="4576727">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576730">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576733">code</span>&nbsp;<span class="op" id="4576738">:=</span>&nbsp;<span class="builtintype" id="4576741">uint16</span><span class="op" id="4576747">(</span><span class="ident" id="4576748">d</span><span class="op" id="4576749">.</span><span class="ident" id="4576750">bits</span>&nbsp;<span class="op" id="4576755">&gt;&gt;</span>&nbsp;<span class="op" id="4576758">(</span><span class="num" id="4576759">32</span>&nbsp;<span class="op" id="4576762">-</span>&nbsp;<span class="ident" id="4576764">d</span><span class="op" id="4576765">.</span><span class="ident" id="4576766">width</span><span class="op" id="4576771">)</span><span class="op" id="4576772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576775">d</span><span class="op" id="4576776">.</span><span class="ident" id="4576777">bits</span>&nbsp;<span class="op" id="4576782">&lt;&lt;=</span>&nbsp;<span class="ident" id="4576786">d</span><span class="op" id="4576787">.</span><span class="ident" id="4576788">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576795">d</span><span class="op" id="4576796">.</span><span class="ident" id="4576797">nBits</span>&nbsp;<span class="op" id="4576803">-=</span>&nbsp;<span class="ident" id="4576806">d</span><span class="op" id="4576807">.</span><span class="ident" id="4576808">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576815">return</span>&nbsp;<span class="ident" id="4576822">code</span><span class="op" id="4576826">,</span>&nbsp;<span class="ident" id="4576828">nil</span><br>
<span class="lineno"></span><span class="op" id="4576832">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="4576835">func</span>&nbsp;<span class="op" id="4576840">(</span><span class="ident" id="4576841">d</span>&nbsp;<span class="op" id="4576843">*</span><span class="ident" id="4576844">decoder</span><span class="op" id="4576851">)</span>&nbsp;<span class="ident" id="4576853">Read</span><span class="op" id="4576857">(</span><span class="ident" id="4576858">b</span>&nbsp;<span class="op" id="4576860">[</span><span class="op" id="4576861">]</span><span class="builtintype" id="4576862">byte</span><span class="op" id="4576866">)</span>&nbsp;<span class="op" id="4576868">(</span><span class="builtintype" id="4576869">int</span><span class="op" id="4576872">,</span>&nbsp;<span class="builtintype" id="4576874">error</span><span class="op" id="4576879">)</span>&nbsp;<span class="op" id="4576881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576884">for</span>&nbsp;<span class="op" id="4576888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576892">if</span>&nbsp;<span class="builtinfunc" id="4576895">len</span><span class="op" id="4576898">(</span><span class="ident" id="4576899">d</span><span class="op" id="4576900">.</span><span class="ident" id="4576901">toRead</span><span class="op" id="4576907">)</span>&nbsp;<span class="op" id="4576909">&gt;</span>&nbsp;<span class="num" id="4576911">0</span>&nbsp;<span class="op" id="4576913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576918">n</span>&nbsp;<span class="op" id="4576920">:=</span>&nbsp;<span class="builtinfunc" id="4576923">copy</span><span class="op" id="4576927">(</span><span class="ident" id="4576928">b</span><span class="op" id="4576929">,</span>&nbsp;<span class="ident" id="4576931">d</span><span class="op" id="4576932">.</span><span class="ident" id="4576933">toRead</span><span class="op" id="4576939">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4576944">d</span><span class="op" id="4576945">.</span><span class="ident" id="4576946">toRead</span>&nbsp;<span class="op" id="4576953">=</span>&nbsp;<span class="ident" id="4576955">d</span><span class="op" id="4576956">.</span><span class="ident" id="4576957">toRead</span><span class="op" id="4576963">[</span><span class="ident" id="4576964">n</span><span class="op" id="4576965">:</span><span class="op" id="4576966">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576971">return</span>&nbsp;<span class="ident" id="4576978">n</span><span class="op" id="4576979">,</span>&nbsp;<span class="ident" id="4576981">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4576987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4576991">if</span>&nbsp;<span class="ident" id="4576994">d</span><span class="op" id="4576995">.</span><span class="ident" id="4576996">err</span>&nbsp;<span class="op" id="4577000">!=</span>&nbsp;<span class="ident" id="4577003">nil</span>&nbsp;<span class="op" id="4577007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577012">return</span>&nbsp;<span class="num" id="4577019">0</span><span class="op" id="4577020">,</span>&nbsp;<span class="ident" id="4577022">d</span><span class="op" id="4577023">.</span><span class="ident" id="4577024">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4577030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577034">d</span><span class="op" id="4577035">.</span><span class="ident" id="4577036">decode</span><span class="op" id="4577042">(</span><span class="op" id="4577043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4577046">}</span><br>
<span class="lineno"></span><span class="op" id="4577048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="4577051">//&nbsp;decode&nbsp;decompresses&nbsp;bytes&nbsp;from&nbsp;r&nbsp;and&nbsp;leaves&nbsp;them&nbsp;in&nbsp;d.toRead.</span><br>
<span class="lineno"></span><span class="comment" id="4577116">//&nbsp;read&nbsp;specifies&nbsp;how&nbsp;to&nbsp;decode&nbsp;bytes&nbsp;into&nbsp;codes.</span><br>
<span class="lineno"></span><span class="comment" id="4577166">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span><span class="keyword" id="4577217">func</span>&nbsp;<span class="op" id="4577222">(</span><span class="ident" id="4577223">d</span>&nbsp;<span class="op" id="4577225">*</span><span class="ident" id="4577226">decoder</span><span class="op" id="4577233">)</span>&nbsp;<span class="ident" id="4577235">decode</span><span class="op" id="4577241">(</span><span class="op" id="4577242">)</span>&nbsp;<span class="op" id="4577244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4577247">//&nbsp;Loop&nbsp;over&nbsp;the&nbsp;code&nbsp;stream,&nbsp;converting&nbsp;codes&nbsp;into&nbsp;decompressed&nbsp;bytes.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577320">for</span>&nbsp;<span class="op" id="4577324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577328">code</span><span class="op" id="4577332">,</span>&nbsp;<span class="ident" id="4577334">err</span>&nbsp;<span class="op" id="4577338">:=</span>&nbsp;<span class="ident" id="4577341">d</span><span class="op" id="4577342">.</span><span class="ident" id="4577343">read</span><span class="op" id="4577347">(</span><span class="ident" id="4577348">d</span><span class="op" id="4577349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577353">if</span>&nbsp;<span class="ident" id="4577356">err</span>&nbsp;<span class="op" id="4577360">!=</span>&nbsp;<span class="ident" id="4577363">nil</span>&nbsp;<span class="op" id="4577367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577372">if</span>&nbsp;<span class="ident" id="4577375">err</span>&nbsp;<span class="op" id="4577379">==</span>&nbsp;<span class="ident" id="4577382">io</span><span class="op" id="4577384">.</span><span class="ident" id="4577385">EOF</span>&nbsp;<span class="op" id="4577389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577395">err</span>&nbsp;<span class="op" id="4577399">=</span>&nbsp;<span class="ident" id="4577401">io</span><span class="op" id="4577403">.</span><span class="ident" id="4577404">ErrUnexpectedEOF</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4577424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577429">d</span><span class="op" id="4577430">.</span><span class="ident" id="4577431">err</span>&nbsp;<span class="op" id="4577435">=</span>&nbsp;<span class="ident" id="4577437">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577444">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4577453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577457">switch</span>&nbsp;<span class="op" id="4577464">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577468">case</span>&nbsp;<span class="ident" id="4577473">code</span>&nbsp;<span class="op" id="4577478">&lt;</span>&nbsp;<span class="ident" id="4577480">d</span><span class="op" id="4577481">.</span><span class="ident" id="4577482">clear</span><span class="op" id="4577487">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4577492">//&nbsp;We&nbsp;have&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577522">d</span><span class="op" id="4577523">.</span><span class="ident" id="4577524">output</span><span class="op" id="4577530">[</span><span class="ident" id="4577531">d</span><span class="op" id="4577532">.</span><span class="ident" id="4577533">o</span><span class="op" id="4577534">]</span>&nbsp;<span class="op" id="4577536">=</span>&nbsp;<span class="builtintype" id="4577538">uint8</span><span class="op" id="4577543">(</span><span class="ident" id="4577544">code</span><span class="op" id="4577548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577553">d</span><span class="op" id="4577554">.</span><span class="ident" id="4577555">o</span><span class="op" id="4577556">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577562">if</span>&nbsp;<span class="ident" id="4577565">d</span><span class="op" id="4577566">.</span><span class="ident" id="4577567">last</span>&nbsp;<span class="op" id="4577572">!=</span>&nbsp;<span class="ident" id="4577575">decoderInvalidCode</span>&nbsp;<span class="op" id="4577594">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4577600">//&nbsp;Save&nbsp;what&nbsp;the&nbsp;hi&nbsp;code&nbsp;expands&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577641">d</span><span class="op" id="4577642">.</span><span class="ident" id="4577643">suffix</span><span class="op" id="4577649">[</span><span class="ident" id="4577650">d</span><span class="op" id="4577651">.</span><span class="ident" id="4577652">hi</span><span class="op" id="4577654">]</span>&nbsp;<span class="op" id="4577656">=</span>&nbsp;<span class="builtintype" id="4577658">uint8</span><span class="op" id="4577663">(</span><span class="ident" id="4577664">code</span><span class="op" id="4577668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577674">d</span><span class="op" id="4577675">.</span><span class="ident" id="4577676">prefix</span><span class="op" id="4577682">[</span><span class="ident" id="4577683">d</span><span class="op" id="4577684">.</span><span class="ident" id="4577685">hi</span><span class="op" id="4577687">]</span>&nbsp;<span class="op" id="4577689">=</span>&nbsp;<span class="ident" id="4577691">d</span><span class="op" id="4577692">.</span><span class="ident" id="4577693">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4577701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577705">case</span>&nbsp;<span class="ident" id="4577710">code</span>&nbsp;<span class="op" id="4577715">==</span>&nbsp;<span class="ident" id="4577718">d</span><span class="op" id="4577719">.</span><span class="ident" id="4577720">clear</span><span class="op" id="4577725">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577730">d</span><span class="op" id="4577731">.</span><span class="ident" id="4577732">width</span>&nbsp;<span class="op" id="4577738">=</span>&nbsp;<span class="num" id="4577740">1</span>&nbsp;<span class="op" id="4577742">+</span>&nbsp;<span class="builtintype" id="4577744">uint</span><span class="op" id="4577748">(</span><span class="ident" id="4577749">d</span><span class="op" id="4577750">.</span><span class="ident" id="4577751">litWidth</span><span class="op" id="4577759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577764">d</span><span class="op" id="4577765">.</span><span class="ident" id="4577766">hi</span>&nbsp;<span class="op" id="4577769">=</span>&nbsp;<span class="ident" id="4577771">d</span><span class="op" id="4577772">.</span><span class="ident" id="4577773">eof</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577780">d</span><span class="op" id="4577781">.</span><span class="ident" id="4577782">overflow</span>&nbsp;<span class="op" id="4577791">=</span>&nbsp;<span class="num" id="4577793">1</span>&nbsp;<span class="op" id="4577795">&lt;&lt;</span>&nbsp;<span class="ident" id="4577798">d</span><span class="op" id="4577799">.</span><span class="ident" id="4577800">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577809">d</span><span class="op" id="4577810">.</span><span class="ident" id="4577811">last</span>&nbsp;<span class="op" id="4577816">=</span>&nbsp;<span class="ident" id="4577818">decoderInvalidCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577840">continue</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577851">case</span>&nbsp;<span class="ident" id="4577856">code</span>&nbsp;<span class="op" id="4577861">==</span>&nbsp;<span class="ident" id="4577864">d</span><span class="op" id="4577865">.</span><span class="ident" id="4577866">eof</span><span class="op" id="4577869">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577874">d</span><span class="op" id="4577875">.</span><span class="ident" id="4577876">flush</span><span class="op" id="4577881">(</span><span class="op" id="4577882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577887">d</span><span class="op" id="4577888">.</span><span class="ident" id="4577889">err</span>&nbsp;<span class="op" id="4577893">=</span>&nbsp;<span class="ident" id="4577895">io</span><span class="op" id="4577897">.</span><span class="ident" id="4577898">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577905">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577914">case</span>&nbsp;<span class="ident" id="4577919">code</span>&nbsp;<span class="op" id="4577924">&lt;=</span>&nbsp;<span class="ident" id="4577927">d</span><span class="op" id="4577928">.</span><span class="ident" id="4577929">hi</span><span class="op" id="4577931">:</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4577936">c</span><span class="op" id="4577937">,</span>&nbsp;<span class="ident" id="4577939">i</span>&nbsp;<span class="op" id="4577941">:=</span>&nbsp;<span class="ident" id="4577944">code</span><span class="op" id="4577948">,</span>&nbsp;<span class="builtinfunc" id="4577950">len</span><span class="op" id="4577953">(</span><span class="ident" id="4577954">d</span><span class="op" id="4577955">.</span><span class="ident" id="4577956">output</span><span class="op" id="4577962">)</span><span class="op" id="4577963">-</span><span class="num" id="4577964">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4577969">if</span>&nbsp;<span class="ident" id="4577972">code</span>&nbsp;<span class="op" id="4577977">==</span>&nbsp;<span class="ident" id="4577980">d</span><span class="op" id="4577981">.</span><span class="ident" id="4577982">hi</span>&nbsp;<span class="op" id="4577985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4577991">//&nbsp;code&nbsp;==&nbsp;hi&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;which&nbsp;expands&nbsp;to&nbsp;the&nbsp;last&nbsp;expansion</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4578063">//&nbsp;followed&nbsp;by&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;last&nbsp;expansion.&nbsp;To&nbsp;find&nbsp;the&nbsp;head,&nbsp;we&nbsp;walk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4578140">//&nbsp;the&nbsp;prefix&nbsp;chain&nbsp;until&nbsp;we&nbsp;find&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578194">c</span>&nbsp;<span class="op" id="4578196">=</span>&nbsp;<span class="ident" id="4578198">d</span><span class="op" id="4578199">.</span><span class="ident" id="4578200">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578209">for</span>&nbsp;<span class="ident" id="4578213">c</span>&nbsp;<span class="op" id="4578215">&gt;=</span>&nbsp;<span class="ident" id="4578218">d</span><span class="op" id="4578219">.</span><span class="ident" id="4578220">clear</span>&nbsp;<span class="op" id="4578226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578233">c</span>&nbsp;<span class="op" id="4578235">=</span>&nbsp;<span class="ident" id="4578237">d</span><span class="op" id="4578238">.</span><span class="ident" id="4578239">prefix</span><span class="op" id="4578245">[</span><span class="ident" id="4578246">c</span><span class="op" id="4578247">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578259">d</span><span class="op" id="4578260">.</span><span class="ident" id="4578261">output</span><span class="op" id="4578267">[</span><span class="ident" id="4578268">i</span><span class="op" id="4578269">]</span>&nbsp;<span class="op" id="4578271">=</span>&nbsp;<span class="builtintype" id="4578273">uint8</span><span class="op" id="4578278">(</span><span class="ident" id="4578279">c</span><span class="op" id="4578280">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578286">i</span><span class="op" id="4578287">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578294">c</span>&nbsp;<span class="op" id="4578296">=</span>&nbsp;<span class="ident" id="4578298">d</span><span class="op" id="4578299">.</span><span class="ident" id="4578300">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4578313">//&nbsp;Copy&nbsp;the&nbsp;suffix&nbsp;chain&nbsp;into&nbsp;output&nbsp;and&nbsp;then&nbsp;write&nbsp;that&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578379">for</span>&nbsp;<span class="ident" id="4578383">c</span>&nbsp;<span class="op" id="4578385">&gt;=</span>&nbsp;<span class="ident" id="4578388">d</span><span class="op" id="4578389">.</span><span class="ident" id="4578390">clear</span>&nbsp;<span class="op" id="4578396">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578402">d</span><span class="op" id="4578403">.</span><span class="ident" id="4578404">output</span><span class="op" id="4578410">[</span><span class="ident" id="4578411">i</span><span class="op" id="4578412">]</span>&nbsp;<span class="op" id="4578414">=</span>&nbsp;<span class="ident" id="4578416">d</span><span class="op" id="4578417">.</span><span class="ident" id="4578418">suffix</span><span class="op" id="4578424">[</span><span class="ident" id="4578425">c</span><span class="op" id="4578426">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578432">i</span><span class="op" id="4578433">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578440">c</span>&nbsp;<span class="op" id="4578442">=</span>&nbsp;<span class="ident" id="4578444">d</span><span class="op" id="4578445">.</span><span class="ident" id="4578446">prefix</span><span class="op" id="4578452">[</span><span class="ident" id="4578453">c</span><span class="op" id="4578454">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578464">d</span><span class="op" id="4578465">.</span><span class="ident" id="4578466">output</span><span class="op" id="4578472">[</span><span class="ident" id="4578473">i</span><span class="op" id="4578474">]</span>&nbsp;<span class="op" id="4578476">=</span>&nbsp;<span class="builtintype" id="4578478">uint8</span><span class="op" id="4578483">(</span><span class="ident" id="4578484">c</span><span class="op" id="4578485">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578490">d</span><span class="op" id="4578491">.</span><span class="ident" id="4578492">o</span>&nbsp;<span class="op" id="4578494">+=</span>&nbsp;<span class="builtinfunc" id="4578497">copy</span><span class="op" id="4578501">(</span><span class="ident" id="4578502">d</span><span class="op" id="4578503">.</span><span class="ident" id="4578504">output</span><span class="op" id="4578510">[</span><span class="ident" id="4578511">d</span><span class="op" id="4578512">.</span><span class="ident" id="4578513">o</span><span class="op" id="4578514">:</span><span class="op" id="4578515">]</span><span class="op" id="4578516">,</span>&nbsp;<span class="ident" id="4578518">d</span><span class="op" id="4578519">.</span><span class="ident" id="4578520">output</span><span class="op" id="4578526">[</span><span class="ident" id="4578527">i</span><span class="op" id="4578528">:</span><span class="op" id="4578529">]</span><span class="op" id="4578530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578535">if</span>&nbsp;<span class="ident" id="4578538">d</span><span class="op" id="4578539">.</span><span class="ident" id="4578540">last</span>&nbsp;<span class="op" id="4578545">!=</span>&nbsp;<span class="ident" id="4578548">decoderInvalidCode</span>&nbsp;<span class="op" id="4578567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4578573">//&nbsp;Save&nbsp;what&nbsp;the&nbsp;hi&nbsp;code&nbsp;expands&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578614">d</span><span class="op" id="4578615">.</span><span class="ident" id="4578616">suffix</span><span class="op" id="4578622">[</span><span class="ident" id="4578623">d</span><span class="op" id="4578624">.</span><span class="ident" id="4578625">hi</span><span class="op" id="4578627">]</span>&nbsp;<span class="op" id="4578629">=</span>&nbsp;<span class="builtintype" id="4578631">uint8</span><span class="op" id="4578636">(</span><span class="ident" id="4578637">c</span><span class="op" id="4578638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578644">d</span><span class="op" id="4578645">.</span><span class="ident" id="4578646">prefix</span><span class="op" id="4578652">[</span><span class="ident" id="4578653">d</span><span class="op" id="4578654">.</span><span class="ident" id="4578655">hi</span><span class="op" id="4578657">]</span>&nbsp;<span class="op" id="4578659">=</span>&nbsp;<span class="ident" id="4578661">d</span><span class="op" id="4578662">.</span><span class="ident" id="4578663">last</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578675">default</span><span class="op" id="4578682">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578687">d</span><span class="op" id="4578688">.</span><span class="ident" id="4578689">err</span>&nbsp;<span class="op" id="4578693">=</span>&nbsp;<span class="ident" id="4578695">errors</span><span class="op" id="4578701">.</span><span class="ident" id="4578702">New</span><span class="op" id="4578705">(</span><span class="string" id="4578706">&#34;lzw:&nbsp;invalid&nbsp;code&#34;</span><span class="op" id="4578725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578730">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578739">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578743">d</span><span class="op" id="4578744">.</span><span class="ident" id="4578745">last</span><span class="op" id="4578749">,</span>&nbsp;<span class="ident" id="4578751">d</span><span class="op" id="4578752">.</span><span class="ident" id="4578753">hi</span>&nbsp;<span class="op" id="4578756">=</span>&nbsp;<span class="ident" id="4578758">code</span><span class="op" id="4578762">,</span>&nbsp;<span class="ident" id="4578764">d</span><span class="op" id="4578765">.</span><span class="ident" id="4578766">hi</span><span class="op" id="4578768">+</span><span class="num" id="4578769">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578773">if</span>&nbsp;<span class="ident" id="4578776">d</span><span class="op" id="4578777">.</span><span class="ident" id="4578778">hi</span>&nbsp;<span class="op" id="4578781">&gt;=</span>&nbsp;<span class="ident" id="4578784">d</span><span class="op" id="4578785">.</span><span class="ident" id="4578786">overflow</span>&nbsp;<span class="op" id="4578795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578800">if</span>&nbsp;<span class="ident" id="4578803">d</span><span class="op" id="4578804">.</span><span class="ident" id="4578805">width</span>&nbsp;<span class="op" id="4578811">==</span>&nbsp;<span class="ident" id="4578814">maxWidth</span>&nbsp;<span class="op" id="4578823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578829">d</span><span class="op" id="4578830">.</span><span class="ident" id="4578831">last</span>&nbsp;<span class="op" id="4578836">=</span>&nbsp;<span class="ident" id="4578838">decoderInvalidCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578860">}</span>&nbsp;<span class="keyword" id="4578862">else</span>&nbsp;<span class="op" id="4578867">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578873">d</span><span class="op" id="4578874">.</span><span class="ident" id="4578875">width</span><span class="op" id="4578880">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578887">d</span><span class="op" id="4578888">.</span><span class="ident" id="4578889">overflow</span>&nbsp;<span class="op" id="4578898">&lt;&lt;=</span>&nbsp;<span class="num" id="4578902">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578915">if</span>&nbsp;<span class="ident" id="4578918">d</span><span class="op" id="4578919">.</span><span class="ident" id="4578920">o</span>&nbsp;<span class="op" id="4578922">&gt;=</span>&nbsp;<span class="ident" id="4578925">flushBuffer</span>&nbsp;<span class="op" id="4578937">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4578942">d</span><span class="op" id="4578943">.</span><span class="ident" id="4578944">flush</span><span class="op" id="4578949">(</span><span class="op" id="4578950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4578955">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4578967">}</span><br>
<span class="lineno"></span><span class="op" id="4578969">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="keyword" id="4578972">func</span>&nbsp;<span class="op" id="4578977">(</span><span class="ident" id="4578978">d</span>&nbsp;<span class="op" id="4578980">*</span><span class="ident" id="4578981">decoder</span><span class="op" id="4578988">)</span>&nbsp;<span class="ident" id="4578990">flush</span><span class="op" id="4578995">(</span><span class="op" id="4578996">)</span>&nbsp;<span class="op" id="4578998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579001">d</span><span class="op" id="4579002">.</span><span class="ident" id="4579003">toRead</span>&nbsp;<span class="op" id="4579010">=</span>&nbsp;<span class="ident" id="4579012">d</span><span class="op" id="4579013">.</span><span class="ident" id="4579014">output</span><span class="op" id="4579020">[</span><span class="op" id="4579021">:</span><span class="ident" id="4579022">d</span><span class="op" id="4579023">.</span><span class="ident" id="4579024">o</span><span class="op" id="4579025">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579028">d</span><span class="op" id="4579029">.</span><span class="ident" id="4579030">o</span>&nbsp;<span class="op" id="4579032">=</span>&nbsp;<span class="num" id="4579034">0</span><br>
<span class="lineno"></span><span class="op" id="4579036">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="4579039">var</span>&nbsp;<span class="ident" id="4579043">errClosed</span>&nbsp;<span class="op" id="4579053">=</span>&nbsp;<span class="ident" id="4579055">errors</span><span class="op" id="4579061">.</span><span class="ident" id="4579062">New</span><span class="op" id="4579065">(</span><span class="string" id="4579066">&#34;compress/lzw:&nbsp;reader/writer&nbsp;is&nbsp;closed&#34;</span><span class="op" id="4579105">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4579108">func</span>&nbsp;<span class="op" id="4579113">(</span><span class="ident" id="4579114">d</span>&nbsp;<span class="op" id="4579116">*</span><span class="ident" id="4579117">decoder</span><span class="op" id="4579124">)</span>&nbsp;<span class="ident" id="4579126">Close</span><span class="op" id="4579131">(</span><span class="op" id="4579132">)</span>&nbsp;<span class="builtintype" id="4579134">error</span>&nbsp;<span class="op" id="4579140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579143">d</span><span class="op" id="4579144">.</span><span class="ident" id="4579145">err</span>&nbsp;<span class="op" id="4579149">=</span>&nbsp;<span class="ident" id="4579151">errClosed</span>&nbsp;<span class="comment" id="4579161">//&nbsp;in&nbsp;case&nbsp;any&nbsp;Reads&nbsp;come&nbsp;along</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579194">return</span>&nbsp;<span class="ident" id="4579201">nil</span><br>
<span class="lineno"></span><span class="op" id="4579205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4579208">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.ReadCloser.</span><br>
<span class="lineno"></span><span class="comment" id="4579250">//&nbsp;Reads&nbsp;from&nbsp;the&nbsp;returned&nbsp;io.ReadCloser&nbsp;read&nbsp;and&nbsp;decompress&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">225</span><span class="comment" id="4579324">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="4579371">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="4579433">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;ReadCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="4579507">//&nbsp;finished&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="4579528">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno">230</span><span class="comment" id="4579601">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="4579636">func</span>&nbsp;<span class="ident" id="4579641">NewReader</span><span class="op" id="4579650">(</span><span class="ident" id="4579651">r</span>&nbsp;<span class="ident" id="4579653">io</span><span class="op" id="4579655">.</span><span class="ident" id="4579656">Reader</span><span class="op" id="4579662">,</span>&nbsp;<span class="ident" id="4579664">order</span>&nbsp;<span class="ident" id="4579670">Order</span><span class="op" id="4579675">,</span>&nbsp;<span class="ident" id="4579677">litWidth</span>&nbsp;<span class="builtintype" id="4579686">int</span><span class="op" id="4579689">)</span>&nbsp;<span class="ident" id="4579691">io</span><span class="op" id="4579693">.</span><span class="ident" id="4579694">ReadCloser</span>&nbsp;<span class="op" id="4579705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579708">d</span>&nbsp;<span class="op" id="4579710">:=</span>&nbsp;<span class="builtinfunc" id="4579713">new</span><span class="op" id="4579716">(</span><span class="ident" id="4579717">decoder</span><span class="op" id="4579724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579727">switch</span>&nbsp;<span class="ident" id="4579734">order</span>&nbsp;<span class="op" id="4579740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579743">case</span>&nbsp;<span class="ident" id="4579748">LSB</span><span class="op" id="4579751">:</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579755">d</span><span class="op" id="4579756">.</span><span class="ident" id="4579757">read</span>&nbsp;<span class="op" id="4579762">=</span>&nbsp;<span class="op" id="4579764">(</span><span class="op" id="4579765">*</span><span class="ident" id="4579766">decoder</span><span class="op" id="4579773">)</span><span class="op" id="4579774">.</span><span class="ident" id="4579775">readLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579784">case</span>&nbsp;<span class="ident" id="4579789">MSB</span><span class="op" id="4579792">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579796">d</span><span class="op" id="4579797">.</span><span class="ident" id="4579798">read</span>&nbsp;<span class="op" id="4579803">=</span>&nbsp;<span class="op" id="4579805">(</span><span class="op" id="4579806">*</span><span class="ident" id="4579807">decoder</span><span class="op" id="4579814">)</span><span class="op" id="4579815">.</span><span class="ident" id="4579816">readMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579825">default</span><span class="op" id="4579832">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579836">d</span><span class="op" id="4579837">.</span><span class="ident" id="4579838">err</span>&nbsp;<span class="op" id="4579842">=</span>&nbsp;<span class="ident" id="4579844">errors</span><span class="op" id="4579850">.</span><span class="ident" id="4579851">New</span><span class="op" id="4579854">(</span><span class="string" id="4579855">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="4579875">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579879">return</span>&nbsp;<span class="ident" id="4579886">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4579889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579892">if</span>&nbsp;<span class="ident" id="4579895">litWidth</span>&nbsp;<span class="op" id="4579904">&lt;</span>&nbsp;<span class="num" id="4579906">2</span>&nbsp;<span class="op" id="4579908">||</span>&nbsp;<span class="num" id="4579911">8</span>&nbsp;<span class="op" id="4579913">&lt;</span>&nbsp;<span class="ident" id="4579915">litWidth</span>&nbsp;<span class="op" id="4579924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4579928">d</span><span class="op" id="4579929">.</span><span class="ident" id="4579930">err</span>&nbsp;<span class="op" id="4579934">=</span>&nbsp;<span class="ident" id="4579936">fmt</span><span class="op" id="4579939">.</span><span class="ident" id="4579940">Errorf</span><span class="op" id="4579946">(</span><span class="string" id="4579947">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="4579978">,</span>&nbsp;<span class="ident" id="4579980">litWidth</span><span class="op" id="4579988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4579992">return</span>&nbsp;<span class="ident" id="4579999">d</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4580002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4580005">if</span>&nbsp;<span class="ident" id="4580008">br</span><span class="op" id="4580010">,</span>&nbsp;<span class="ident" id="4580012">ok</span>&nbsp;<span class="op" id="4580015">:=</span>&nbsp;<span class="ident" id="4580018">r</span><span class="op" id="4580019">.</span><span class="op" id="4580020">(</span><span class="ident" id="4580021">io</span><span class="op" id="4580023">.</span><span class="ident" id="4580024">ByteReader</span><span class="op" id="4580034">)</span><span class="op" id="4580035">;</span>&nbsp;<span class="ident" id="4580037">ok</span>&nbsp;<span class="op" id="4580040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580044">d</span><span class="op" id="4580045">.</span><span class="ident" id="4580046">r</span>&nbsp;<span class="op" id="4580048">=</span>&nbsp;<span class="ident" id="4580050">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4580054">}</span>&nbsp;<span class="keyword" id="4580056">else</span>&nbsp;<span class="op" id="4580061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580065">d</span><span class="op" id="4580066">.</span><span class="ident" id="4580067">r</span>&nbsp;<span class="op" id="4580069">=</span>&nbsp;<span class="ident" id="4580071">bufio</span><span class="op" id="4580076">.</span><span class="ident" id="4580077">NewReader</span><span class="op" id="4580086">(</span><span class="ident" id="4580087">r</span><span class="op" id="4580088">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4580091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580094">d</span><span class="op" id="4580095">.</span><span class="ident" id="4580096">litWidth</span>&nbsp;<span class="op" id="4580105">=</span>&nbsp;<span class="ident" id="4580107">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580117">d</span><span class="op" id="4580118">.</span><span class="ident" id="4580119">width</span>&nbsp;<span class="op" id="4580125">=</span>&nbsp;<span class="num" id="4580127">1</span>&nbsp;<span class="op" id="4580129">+</span>&nbsp;<span class="builtintype" id="4580131">uint</span><span class="op" id="4580135">(</span><span class="ident" id="4580136">litWidth</span><span class="op" id="4580144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580147">d</span><span class="op" id="4580148">.</span><span class="ident" id="4580149">clear</span>&nbsp;<span class="op" id="4580155">=</span>&nbsp;<span class="builtintype" id="4580157">uint16</span><span class="op" id="4580163">(</span><span class="num" id="4580164">1</span><span class="op" id="4580165">)</span>&nbsp;<span class="op" id="4580167">&lt;&lt;</span>&nbsp;<span class="builtintype" id="4580170">uint</span><span class="op" id="4580174">(</span><span class="ident" id="4580175">litWidth</span><span class="op" id="4580183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580186">d</span><span class="op" id="4580187">.</span><span class="ident" id="4580188">eof</span><span class="op" id="4580191">,</span>&nbsp;<span class="ident" id="4580193">d</span><span class="op" id="4580194">.</span><span class="ident" id="4580195">hi</span>&nbsp;<span class="op" id="4580198">=</span>&nbsp;<span class="ident" id="4580200">d</span><span class="op" id="4580201">.</span><span class="ident" id="4580202">clear</span><span class="op" id="4580207">+</span><span class="num" id="4580208">1</span><span class="op" id="4580209">,</span>&nbsp;<span class="ident" id="4580211">d</span><span class="op" id="4580212">.</span><span class="ident" id="4580213">clear</span><span class="op" id="4580218">+</span><span class="num" id="4580219">1</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580222">d</span><span class="op" id="4580223">.</span><span class="ident" id="4580224">overflow</span>&nbsp;<span class="op" id="4580233">=</span>&nbsp;<span class="builtintype" id="4580235">uint16</span><span class="op" id="4580241">(</span><span class="num" id="4580242">1</span><span class="op" id="4580243">)</span>&nbsp;<span class="op" id="4580245">&lt;&lt;</span>&nbsp;<span class="ident" id="4580248">d</span><span class="op" id="4580249">.</span><span class="ident" id="4580250">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4580257">d</span><span class="op" id="4580258">.</span><span class="ident" id="4580259">last</span>&nbsp;<span class="op" id="4580264">=</span>&nbsp;<span class="ident" id="4580266">decoderInvalidCode</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4580287">return</span>&nbsp;<span class="ident" id="4580294">d</span><br>
<span class="lineno"></span><span class="op" id="4580296">}</span>
</div>
</body>
</html>
