<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rsa</h2>
<ul>
<li><a href="/gostd/crypto/rsa/pkcs1v15.go.html">pkcs1v15.go</a></li>
<li><a href="/gostd/crypto/rsa/pkcs1v15_test.go.html">pkcs1v15_test.go</a></li>
<li><a href="/gostd/crypto/rsa/pss.go.html">pss.go</a></li>
<li><a href="/gostd/crypto/rsa/pss_test.go.html">pss_test.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa.go.html">rsa.go</a></li>
<li><a href="/gostd/crypto/rsa/rsa_test.go.html">rsa_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3693751">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3693806">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3693860">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3693911">package</span>&nbsp;<span class="ident" id="3693919">rsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3693924">import</span>&nbsp;<span class="op" id="3693931">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3693934">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3693944">&#34;crypto/subtle&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3693961">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3693971">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3693977">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="3693988">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="3693991">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;encryption&nbsp;and&nbsp;decryption&nbsp;using&nbsp;PKCS#1&nbsp;v1.5&nbsp;padding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3694069">//&nbsp;EncryptPKCS1v15&nbsp;encrypts&nbsp;the&nbsp;given&nbsp;message&nbsp;with&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="3694165">//&nbsp;The&nbsp;message&nbsp;must&nbsp;be&nbsp;no&nbsp;longer&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;public&nbsp;modulus&nbsp;minus&nbsp;11&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="3694252">//&nbsp;WARNING:&nbsp;use&nbsp;of&nbsp;this&nbsp;function&nbsp;to&nbsp;encrypt&nbsp;plaintexts&nbsp;other&nbsp;than&nbsp;session&nbsp;keys</span><br>
<span class="lineno">20</span><span class="comment" id="3694331">//&nbsp;is&nbsp;dangerous.&nbsp;Use&nbsp;RSA&nbsp;OAEP&nbsp;in&nbsp;new&nbsp;protocols.</span><br>
<span class="lineno"></span><span class="keyword" id="3694379">func</span>&nbsp;<span class="ident" id="3694384">EncryptPKCS1v15</span><span class="op" id="3694399">(</span><span class="ident" id="3694400">rand</span>&nbsp;<span class="ident" id="3694405">io</span><span class="op" id="3694407">.</span><span class="ident" id="3694408">Reader</span><span class="op" id="3694414">,</span>&nbsp;<span class="ident" id="3694416">pub</span>&nbsp;<span class="op" id="3694420">*</span><span class="ident" id="3694421">PublicKey</span><span class="op" id="3694430">,</span>&nbsp;<span class="ident" id="3694432">msg</span>&nbsp;<span class="op" id="3694436">[</span><span class="op" id="3694437">]</span><span class="builtintype" id="3694438">byte</span><span class="op" id="3694442">)</span>&nbsp;<span class="op" id="3694444">(</span><span class="ident" id="3694445">out</span>&nbsp;<span class="op" id="3694449">[</span><span class="op" id="3694450">]</span><span class="builtintype" id="3694451">byte</span><span class="op" id="3694455">,</span>&nbsp;<span class="ident" id="3694457">err</span>&nbsp;<span class="builtintype" id="3694461">error</span><span class="op" id="3694466">)</span>&nbsp;<span class="op" id="3694468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694471">if</span>&nbsp;<span class="ident" id="3694474">err</span>&nbsp;<span class="op" id="3694478">:=</span>&nbsp;<span class="ident" id="3694481">checkPub</span><span class="op" id="3694489">(</span><span class="ident" id="3694490">pub</span><span class="op" id="3694493">)</span><span class="op" id="3694494">;</span>&nbsp;<span class="ident" id="3694496">err</span>&nbsp;<span class="op" id="3694500">!=</span>&nbsp;<span class="ident" id="3694503">nil</span>&nbsp;<span class="op" id="3694507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694511">return</span>&nbsp;<span class="ident" id="3694518">nil</span><span class="op" id="3694521">,</span>&nbsp;<span class="ident" id="3694523">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3694528">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694531">k</span>&nbsp;<span class="op" id="3694533">:=</span>&nbsp;<span class="op" id="3694536">(</span><span class="ident" id="3694537">pub</span><span class="op" id="3694540">.</span><span class="ident" id="3694541">N</span><span class="op" id="3694542">.</span><span class="ident" id="3694543">BitLen</span><span class="op" id="3694549">(</span><span class="op" id="3694550">)</span>&nbsp;<span class="op" id="3694552">+</span>&nbsp;<span class="num" id="3694554">7</span><span class="op" id="3694555">)</span>&nbsp;<span class="op" id="3694557">/</span>&nbsp;<span class="num" id="3694559">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694562">if</span>&nbsp;<span class="builtinfunc" id="3694565">len</span><span class="op" id="3694568">(</span><span class="ident" id="3694569">msg</span><span class="op" id="3694572">)</span>&nbsp;<span class="op" id="3694574">&gt;</span>&nbsp;<span class="ident" id="3694576">k</span><span class="op" id="3694577">-</span><span class="num" id="3694578">11</span>&nbsp;<span class="op" id="3694581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694585">err</span>&nbsp;<span class="op" id="3694589">=</span>&nbsp;<span class="ident" id="3694591">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694611">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3694619">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3694623">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x02&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;M</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694664">em</span>&nbsp;<span class="op" id="3694667">:=</span>&nbsp;<span class="builtinfunc" id="3694670">make</span><span class="op" id="3694674">(</span><span class="op" id="3694675">[</span><span class="op" id="3694676">]</span><span class="builtintype" id="3694677">byte</span><span class="op" id="3694681">,</span>&nbsp;<span class="ident" id="3694683">k</span><span class="op" id="3694684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694687">em</span><span class="op" id="3694689">[</span><span class="num" id="3694690">1</span><span class="op" id="3694691">]</span>&nbsp;<span class="op" id="3694693">=</span>&nbsp;<span class="num" id="3694695">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694698">ps</span><span class="op" id="3694700">,</span>&nbsp;<span class="ident" id="3694702">mm</span>&nbsp;<span class="op" id="3694705">:=</span>&nbsp;<span class="ident" id="3694708">em</span><span class="op" id="3694710">[</span><span class="num" id="3694711">2</span><span class="op" id="3694712">:</span><span class="builtinfunc" id="3694713">len</span><span class="op" id="3694716">(</span><span class="ident" id="3694717">em</span><span class="op" id="3694719">)</span><span class="op" id="3694720">-</span><span class="builtinfunc" id="3694721">len</span><span class="op" id="3694724">(</span><span class="ident" id="3694725">msg</span><span class="op" id="3694728">)</span><span class="op" id="3694729">-</span><span class="num" id="3694730">1</span><span class="op" id="3694731">]</span><span class="op" id="3694732">,</span>&nbsp;<span class="ident" id="3694734">em</span><span class="op" id="3694736">[</span><span class="builtinfunc" id="3694737">len</span><span class="op" id="3694740">(</span><span class="ident" id="3694741">em</span><span class="op" id="3694743">)</span><span class="op" id="3694744">-</span><span class="builtinfunc" id="3694745">len</span><span class="op" id="3694748">(</span><span class="ident" id="3694749">msg</span><span class="op" id="3694752">)</span><span class="op" id="3694753">:</span><span class="op" id="3694754">]</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694757">err</span>&nbsp;<span class="op" id="3694761">=</span>&nbsp;<span class="ident" id="3694763">nonZeroRandomBytes</span><span class="op" id="3694781">(</span><span class="ident" id="3694782">ps</span><span class="op" id="3694784">,</span>&nbsp;<span class="ident" id="3694786">rand</span><span class="op" id="3694790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694793">if</span>&nbsp;<span class="ident" id="3694796">err</span>&nbsp;<span class="op" id="3694800">!=</span>&nbsp;<span class="ident" id="3694803">nil</span>&nbsp;<span class="op" id="3694807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694811">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3694819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694822">em</span><span class="op" id="3694824">[</span><span class="builtinfunc" id="3694825">len</span><span class="op" id="3694828">(</span><span class="ident" id="3694829">em</span><span class="op" id="3694831">)</span><span class="op" id="3694832">-</span><span class="builtinfunc" id="3694833">len</span><span class="op" id="3694836">(</span><span class="ident" id="3694837">msg</span><span class="op" id="3694840">)</span><span class="op" id="3694841">-</span><span class="num" id="3694842">1</span><span class="op" id="3694843">]</span>&nbsp;<span class="op" id="3694845">=</span>&nbsp;<span class="num" id="3694847">0</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3694850">copy</span><span class="op" id="3694854">(</span><span class="ident" id="3694855">mm</span><span class="op" id="3694857">,</span>&nbsp;<span class="ident" id="3694859">msg</span><span class="op" id="3694862">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694866">m</span>&nbsp;<span class="op" id="3694868">:=</span>&nbsp;<span class="builtinfunc" id="3694871">new</span><span class="op" id="3694874">(</span><span class="ident" id="3694875">big</span><span class="op" id="3694878">.</span><span class="ident" id="3694879">Int</span><span class="op" id="3694882">)</span><span class="op" id="3694883">.</span><span class="ident" id="3694884">SetBytes</span><span class="op" id="3694892">(</span><span class="ident" id="3694893">em</span><span class="op" id="3694895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694898">c</span>&nbsp;<span class="op" id="3694900">:=</span>&nbsp;<span class="ident" id="3694903">encrypt</span><span class="op" id="3694910">(</span><span class="builtinfunc" id="3694911">new</span><span class="op" id="3694914">(</span><span class="ident" id="3694915">big</span><span class="op" id="3694918">.</span><span class="ident" id="3694919">Int</span><span class="op" id="3694922">)</span><span class="op" id="3694923">,</span>&nbsp;<span class="ident" id="3694925">pub</span><span class="op" id="3694928">,</span>&nbsp;<span class="ident" id="3694930">m</span><span class="op" id="3694931">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694935">copyWithLeftPad</span><span class="op" id="3694950">(</span><span class="ident" id="3694951">em</span><span class="op" id="3694953">,</span>&nbsp;<span class="ident" id="3694955">c</span><span class="op" id="3694956">.</span><span class="ident" id="3694957">Bytes</span><span class="op" id="3694962">(</span><span class="op" id="3694963">)</span><span class="op" id="3694964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694967">out</span>&nbsp;<span class="op" id="3694971">=</span>&nbsp;<span class="ident" id="3694973">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694977">return</span><br>
<span class="lineno"></span><span class="op" id="3694984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3694987">//&nbsp;DecryptPKCS1v15&nbsp;decrypts&nbsp;a&nbsp;plaintext&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="3695078">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword" id="3695156">func</span>&nbsp;<span class="ident" id="3695161">DecryptPKCS1v15</span><span class="op" id="3695176">(</span><span class="ident" id="3695177">rand</span>&nbsp;<span class="ident" id="3695182">io</span><span class="op" id="3695184">.</span><span class="ident" id="3695185">Reader</span><span class="op" id="3695191">,</span>&nbsp;<span class="ident" id="3695193">priv</span>&nbsp;<span class="op" id="3695198">*</span><span class="ident" id="3695199">PrivateKey</span><span class="op" id="3695209">,</span>&nbsp;<span class="ident" id="3695211">ciphertext</span>&nbsp;<span class="op" id="3695222">[</span><span class="op" id="3695223">]</span><span class="builtintype" id="3695224">byte</span><span class="op" id="3695228">)</span>&nbsp;<span class="op" id="3695230">(</span><span class="ident" id="3695231">out</span>&nbsp;<span class="op" id="3695235">[</span><span class="op" id="3695236">]</span><span class="builtintype" id="3695237">byte</span><span class="op" id="3695241">,</span>&nbsp;<span class="ident" id="3695243">err</span>&nbsp;<span class="builtintype" id="3695247">error</span><span class="op" id="3695252">)</span>&nbsp;<span class="op" id="3695254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695257">if</span>&nbsp;<span class="ident" id="3695260">err</span>&nbsp;<span class="op" id="3695264">:=</span>&nbsp;<span class="ident" id="3695267">checkPub</span><span class="op" id="3695275">(</span><span class="op" id="3695276">&amp;</span><span class="ident" id="3695277">priv</span><span class="op" id="3695281">.</span><span class="ident" id="3695282">PublicKey</span><span class="op" id="3695291">)</span><span class="op" id="3695292">;</span>&nbsp;<span class="ident" id="3695294">err</span>&nbsp;<span class="op" id="3695298">!=</span>&nbsp;<span class="ident" id="3695301">nil</span>&nbsp;<span class="op" id="3695305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695309">return</span>&nbsp;<span class="ident" id="3695316">nil</span><span class="op" id="3695319">,</span>&nbsp;<span class="ident" id="3695321">err</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3695326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695329">valid</span><span class="op" id="3695334">,</span>&nbsp;<span class="ident" id="3695336">out</span><span class="op" id="3695339">,</span>&nbsp;<span class="ident" id="3695341">index</span><span class="op" id="3695346">,</span>&nbsp;<span class="ident" id="3695348">err</span>&nbsp;<span class="op" id="3695352">:=</span>&nbsp;<span class="ident" id="3695355">decryptPKCS1v15</span><span class="op" id="3695370">(</span><span class="ident" id="3695371">rand</span><span class="op" id="3695375">,</span>&nbsp;<span class="ident" id="3695377">priv</span><span class="op" id="3695381">,</span>&nbsp;<span class="ident" id="3695383">ciphertext</span><span class="op" id="3695393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695396">if</span>&nbsp;<span class="ident" id="3695399">err</span>&nbsp;<span class="op" id="3695403">!=</span>&nbsp;<span class="ident" id="3695406">nil</span>&nbsp;<span class="op" id="3695410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695414">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3695422">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695425">if</span>&nbsp;<span class="ident" id="3695428">valid</span>&nbsp;<span class="op" id="3695434">==</span>&nbsp;<span class="num" id="3695437">0</span>&nbsp;<span class="op" id="3695439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695443">return</span>&nbsp;<span class="ident" id="3695450">nil</span><span class="op" id="3695453">,</span>&nbsp;<span class="ident" id="3695455">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3695470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695473">out</span>&nbsp;<span class="op" id="3695477">=</span>&nbsp;<span class="ident" id="3695479">out</span><span class="op" id="3695482">[</span><span class="ident" id="3695483">index</span><span class="op" id="3695488">:</span><span class="op" id="3695489">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695492">return</span><br>
<span class="lineno">65</span><span class="op" id="3695499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3695502">//&nbsp;DecryptPKCS1v15SessionKey&nbsp;decrypts&nbsp;a&nbsp;session&nbsp;key&nbsp;using&nbsp;RSA&nbsp;and&nbsp;the&nbsp;padding&nbsp;scheme&nbsp;from&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="3695605">//&nbsp;If&nbsp;rand&nbsp;!=&nbsp;nil,&nbsp;it&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="comment" id="3695683">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;ciphertext&nbsp;is&nbsp;the&nbsp;wrong&nbsp;length&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="3695754">//&nbsp;ciphertext&nbsp;is&nbsp;greater&nbsp;than&nbsp;the&nbsp;public&nbsp;modulus.&nbsp;Otherwise,&nbsp;no&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3695827">//&nbsp;returned.&nbsp;If&nbsp;the&nbsp;padding&nbsp;is&nbsp;valid,&nbsp;the&nbsp;resulting&nbsp;plaintext&nbsp;message&nbsp;is&nbsp;copied</span><br>
<span class="lineno"></span><span class="comment" id="3695907">//&nbsp;into&nbsp;key.&nbsp;Otherwise,&nbsp;key&nbsp;is&nbsp;unchanged.&nbsp;These&nbsp;alternatives&nbsp;occur&nbsp;in&nbsp;constant</span><br>
<span class="lineno"></span><span class="comment" id="3695986">//&nbsp;time.&nbsp;It&nbsp;is&nbsp;intended&nbsp;that&nbsp;the&nbsp;user&nbsp;of&nbsp;this&nbsp;function&nbsp;generate&nbsp;a&nbsp;random</span><br>
<span class="lineno"></span><span class="comment" id="3696059">//&nbsp;session&nbsp;key&nbsp;beforehand&nbsp;and&nbsp;continue&nbsp;the&nbsp;protocol&nbsp;with&nbsp;the&nbsp;resulting&nbsp;value.</span><br>
<span class="lineno">75</span><span class="comment" id="3696137">//&nbsp;This&nbsp;will&nbsp;remove&nbsp;any&nbsp;possibility&nbsp;that&nbsp;an&nbsp;attacker&nbsp;can&nbsp;learn&nbsp;any&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="3696216">//&nbsp;about&nbsp;the&nbsp;plaintext.</span><br>
<span class="lineno"></span><span class="comment" id="3696240">//&nbsp;See&nbsp;``Chosen&nbsp;Ciphertext&nbsp;Attacks&nbsp;Against&nbsp;Protocols&nbsp;Based&nbsp;on&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span><span class="comment" id="3696310">//&nbsp;Encryption&nbsp;Standard&nbsp;PKCS&nbsp;#1&#39;&#39;,&nbsp;Daniel&nbsp;Bleichenbacher,&nbsp;Advances&nbsp;in&nbsp;Cryptology</span><br>
<span class="lineno"></span><span class="comment" id="3696390">//&nbsp;(Crypto&nbsp;&#39;98).</span><br>
<span class="lineno">80</span><span class="keyword" id="3696407">func</span>&nbsp;<span class="ident" id="3696412">DecryptPKCS1v15SessionKey</span><span class="op" id="3696437">(</span><span class="ident" id="3696438">rand</span>&nbsp;<span class="ident" id="3696443">io</span><span class="op" id="3696445">.</span><span class="ident" id="3696446">Reader</span><span class="op" id="3696452">,</span>&nbsp;<span class="ident" id="3696454">priv</span>&nbsp;<span class="op" id="3696459">*</span><span class="ident" id="3696460">PrivateKey</span><span class="op" id="3696470">,</span>&nbsp;<span class="ident" id="3696472">ciphertext</span>&nbsp;<span class="op" id="3696483">[</span><span class="op" id="3696484">]</span><span class="builtintype" id="3696485">byte</span><span class="op" id="3696489">,</span>&nbsp;<span class="ident" id="3696491">key</span>&nbsp;<span class="op" id="3696495">[</span><span class="op" id="3696496">]</span><span class="builtintype" id="3696497">byte</span><span class="op" id="3696501">)</span>&nbsp;<span class="op" id="3696503">(</span><span class="ident" id="3696504">err</span>&nbsp;<span class="builtintype" id="3696508">error</span><span class="op" id="3696513">)</span>&nbsp;<span class="op" id="3696515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696518">if</span>&nbsp;<span class="ident" id="3696521">err</span>&nbsp;<span class="op" id="3696525">:=</span>&nbsp;<span class="ident" id="3696528">checkPub</span><span class="op" id="3696536">(</span><span class="op" id="3696537">&amp;</span><span class="ident" id="3696538">priv</span><span class="op" id="3696542">.</span><span class="ident" id="3696543">PublicKey</span><span class="op" id="3696552">)</span><span class="op" id="3696553">;</span>&nbsp;<span class="ident" id="3696555">err</span>&nbsp;<span class="op" id="3696559">!=</span>&nbsp;<span class="ident" id="3696562">nil</span>&nbsp;<span class="op" id="3696566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696570">return</span>&nbsp;<span class="ident" id="3696577">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3696582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696585">k</span>&nbsp;<span class="op" id="3696587">:=</span>&nbsp;<span class="op" id="3696590">(</span><span class="ident" id="3696591">priv</span><span class="op" id="3696595">.</span><span class="ident" id="3696596">N</span><span class="op" id="3696597">.</span><span class="ident" id="3696598">BitLen</span><span class="op" id="3696604">(</span><span class="op" id="3696605">)</span>&nbsp;<span class="op" id="3696607">+</span>&nbsp;<span class="num" id="3696609">7</span><span class="op" id="3696610">)</span>&nbsp;<span class="op" id="3696612">/</span>&nbsp;<span class="num" id="3696614">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696617">if</span>&nbsp;<span class="ident" id="3696620">k</span><span class="op" id="3696621">-</span><span class="op" id="3696622">(</span><span class="builtinfunc" id="3696623">len</span><span class="op" id="3696626">(</span><span class="ident" id="3696627">key</span><span class="op" id="3696630">)</span><span class="op" id="3696631">+</span><span class="num" id="3696632">3</span><span class="op" id="3696633">+</span><span class="num" id="3696634">8</span><span class="op" id="3696635">)</span>&nbsp;<span class="op" id="3696637">&lt;</span>&nbsp;<span class="num" id="3696639">0</span>&nbsp;<span class="op" id="3696641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696645">return</span>&nbsp;<span class="ident" id="3696652">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3696667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696671">valid</span><span class="op" id="3696676">,</span>&nbsp;<span class="ident" id="3696678">em</span><span class="op" id="3696680">,</span>&nbsp;<span class="ident" id="3696682">index</span><span class="op" id="3696687">,</span>&nbsp;<span class="ident" id="3696689">err</span>&nbsp;<span class="op" id="3696693">:=</span>&nbsp;<span class="ident" id="3696696">decryptPKCS1v15</span><span class="op" id="3696711">(</span><span class="ident" id="3696712">rand</span><span class="op" id="3696716">,</span>&nbsp;<span class="ident" id="3696718">priv</span><span class="op" id="3696722">,</span>&nbsp;<span class="ident" id="3696724">ciphertext</span><span class="op" id="3696734">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696737">if</span>&nbsp;<span class="ident" id="3696740">err</span>&nbsp;<span class="op" id="3696744">!=</span>&nbsp;<span class="ident" id="3696747">nil</span>&nbsp;<span class="op" id="3696751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696755">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3696763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696767">if</span>&nbsp;<span class="builtinfunc" id="3696770">len</span><span class="op" id="3696773">(</span><span class="ident" id="3696774">em</span><span class="op" id="3696776">)</span>&nbsp;<span class="op" id="3696778">!=</span>&nbsp;<span class="ident" id="3696781">k</span>&nbsp;<span class="op" id="3696783">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3696787">//&nbsp;This&nbsp;should&nbsp;be&nbsp;impossible&nbsp;because&nbsp;decryptPKCS1v15&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3696849">//&nbsp;returns&nbsp;the&nbsp;full&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696878">return</span>&nbsp;<span class="ident" id="3696885">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3696900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696904">valid</span>&nbsp;<span class="op" id="3696910">&amp;=</span>&nbsp;<span class="ident" id="3696913">subtle</span><span class="op" id="3696919">.</span><span class="ident" id="3696920">ConstantTimeEq</span><span class="op" id="3696934">(</span><span class="builtintype" id="3696935">int32</span><span class="op" id="3696940">(</span><span class="builtinfunc" id="3696941">len</span><span class="op" id="3696944">(</span><span class="ident" id="3696945">em</span><span class="op" id="3696947">)</span><span class="op" id="3696948">-</span><span class="ident" id="3696949">index</span><span class="op" id="3696954">)</span><span class="op" id="3696955">,</span>&nbsp;<span class="builtintype" id="3696957">int32</span><span class="op" id="3696962">(</span><span class="builtinfunc" id="3696963">len</span><span class="op" id="3696966">(</span><span class="ident" id="3696967">key</span><span class="op" id="3696970">)</span><span class="op" id="3696971">)</span><span class="op" id="3696972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696975">subtle</span><span class="op" id="3696981">.</span><span class="ident" id="3696982">ConstantTimeCopy</span><span class="op" id="3696998">(</span><span class="ident" id="3696999">valid</span><span class="op" id="3697004">,</span>&nbsp;<span class="ident" id="3697006">key</span><span class="op" id="3697009">,</span>&nbsp;<span class="ident" id="3697011">em</span><span class="op" id="3697013">[</span><span class="builtinfunc" id="3697014">len</span><span class="op" id="3697017">(</span><span class="ident" id="3697018">em</span><span class="op" id="3697020">)</span><span class="op" id="3697021">-</span><span class="builtinfunc" id="3697022">len</span><span class="op" id="3697025">(</span><span class="ident" id="3697026">key</span><span class="op" id="3697029">)</span><span class="op" id="3697030">:</span><span class="op" id="3697031">]</span><span class="op" id="3697032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3697035">return</span><br>
<span class="lineno"></span><span class="op" id="3697042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3697045">//&nbsp;decryptPKCS1v15&nbsp;decrypts&nbsp;ciphertext&nbsp;using&nbsp;priv&nbsp;and&nbsp;blinds&nbsp;the&nbsp;operation&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="3697123">//&nbsp;rand&nbsp;is&nbsp;not&nbsp;nil.&nbsp;It&nbsp;returns&nbsp;one&nbsp;or&nbsp;zero&nbsp;in&nbsp;valid&nbsp;that&nbsp;indicates&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3697202">//&nbsp;plaintext&nbsp;was&nbsp;correctly&nbsp;structured.&nbsp;In&nbsp;either&nbsp;case,&nbsp;the&nbsp;plaintext&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3697274">//&nbsp;returned&nbsp;in&nbsp;em&nbsp;so&nbsp;that&nbsp;it&nbsp;may&nbsp;be&nbsp;read&nbsp;independently&nbsp;of&nbsp;whether&nbsp;it&nbsp;was&nbsp;valid</span><br>
<span class="lineno"></span><span class="comment" id="3697353">//&nbsp;in&nbsp;order&nbsp;to&nbsp;maintain&nbsp;constant&nbsp;memory&nbsp;access&nbsp;patterns.&nbsp;If&nbsp;the&nbsp;plaintext&nbsp;was</span><br>
<span class="lineno">110</span><span class="comment" id="3697431">//&nbsp;valid&nbsp;then&nbsp;index&nbsp;contains&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;original&nbsp;message&nbsp;in&nbsp;em.</span><br>
<span class="lineno"></span><span class="keyword" id="3697501">func</span>&nbsp;<span class="ident" id="3697506">decryptPKCS1v15</span><span class="op" id="3697521">(</span><span class="ident" id="3697522">rand</span>&nbsp;<span class="ident" id="3697527">io</span><span class="op" id="3697529">.</span><span class="ident" id="3697530">Reader</span><span class="op" id="3697536">,</span>&nbsp;<span class="ident" id="3697538">priv</span>&nbsp;<span class="op" id="3697543">*</span><span class="ident" id="3697544">PrivateKey</span><span class="op" id="3697554">,</span>&nbsp;<span class="ident" id="3697556">ciphertext</span>&nbsp;<span class="op" id="3697567">[</span><span class="op" id="3697568">]</span><span class="builtintype" id="3697569">byte</span><span class="op" id="3697573">)</span>&nbsp;<span class="op" id="3697575">(</span><span class="ident" id="3697576">valid</span>&nbsp;<span class="builtintype" id="3697582">int</span><span class="op" id="3697585">,</span>&nbsp;<span class="ident" id="3697587">em</span>&nbsp;<span class="op" id="3697590">[</span><span class="op" id="3697591">]</span><span class="builtintype" id="3697592">byte</span><span class="op" id="3697596">,</span>&nbsp;<span class="ident" id="3697598">index</span>&nbsp;<span class="builtintype" id="3697604">int</span><span class="op" id="3697607">,</span>&nbsp;<span class="ident" id="3697609">err</span>&nbsp;<span class="builtintype" id="3697613">error</span><span class="op" id="3697618">)</span>&nbsp;<span class="op" id="3697620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3697623">k</span>&nbsp;<span class="op" id="3697625">:=</span>&nbsp;<span class="op" id="3697628">(</span><span class="ident" id="3697629">priv</span><span class="op" id="3697633">.</span><span class="ident" id="3697634">N</span><span class="op" id="3697635">.</span><span class="ident" id="3697636">BitLen</span><span class="op" id="3697642">(</span><span class="op" id="3697643">)</span>&nbsp;<span class="op" id="3697645">+</span>&nbsp;<span class="num" id="3697647">7</span><span class="op" id="3697648">)</span>&nbsp;<span class="op" id="3697650">/</span>&nbsp;<span class="num" id="3697652">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3697655">if</span>&nbsp;<span class="ident" id="3697658">k</span>&nbsp;<span class="op" id="3697660">&lt;</span>&nbsp;<span class="num" id="3697662">11</span>&nbsp;<span class="op" id="3697665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3697669">err</span>&nbsp;<span class="op" id="3697673">=</span>&nbsp;<span class="ident" id="3697675">ErrDecryption</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3697691">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3697699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3697703">c</span>&nbsp;<span class="op" id="3697705">:=</span>&nbsp;<span class="builtinfunc" id="3697708">new</span><span class="op" id="3697711">(</span><span class="ident" id="3697712">big</span><span class="op" id="3697715">.</span><span class="ident" id="3697716">Int</span><span class="op" id="3697719">)</span><span class="op" id="3697720">.</span><span class="ident" id="3697721">SetBytes</span><span class="op" id="3697729">(</span><span class="ident" id="3697730">ciphertext</span><span class="op" id="3697740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3697743">m</span><span class="op" id="3697744">,</span>&nbsp;<span class="ident" id="3697746">err</span>&nbsp;<span class="op" id="3697750">:=</span>&nbsp;<span class="ident" id="3697753">decrypt</span><span class="op" id="3697760">(</span><span class="ident" id="3697761">rand</span><span class="op" id="3697765">,</span>&nbsp;<span class="ident" id="3697767">priv</span><span class="op" id="3697771">,</span>&nbsp;<span class="ident" id="3697773">c</span><span class="op" id="3697774">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3697777">if</span>&nbsp;<span class="ident" id="3697780">err</span>&nbsp;<span class="op" id="3697784">!=</span>&nbsp;<span class="ident" id="3697787">nil</span>&nbsp;<span class="op" id="3697791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3697795">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3697803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3697807">em</span>&nbsp;<span class="op" id="3697810">=</span>&nbsp;<span class="ident" id="3697812">leftPad</span><span class="op" id="3697819">(</span><span class="ident" id="3697820">m</span><span class="op" id="3697821">.</span><span class="ident" id="3697822">Bytes</span><span class="op" id="3697827">(</span><span class="op" id="3697828">)</span><span class="op" id="3697829">,</span>&nbsp;<span class="ident" id="3697831">k</span><span class="op" id="3697832">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3697835">firstByteIsZero</span>&nbsp;<span class="op" id="3697851">:=</span>&nbsp;<span class="ident" id="3697854">subtle</span><span class="op" id="3697860">.</span><span class="ident" id="3697861">ConstantTimeByteEq</span><span class="op" id="3697879">(</span><span class="ident" id="3697880">em</span><span class="op" id="3697882">[</span><span class="num" id="3697883">0</span><span class="op" id="3697884">]</span><span class="op" id="3697885">,</span>&nbsp;<span class="num" id="3697887">0</span><span class="op" id="3697888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3697891">secondByteIsTwo</span>&nbsp;<span class="op" id="3697907">:=</span>&nbsp;<span class="ident" id="3697910">subtle</span><span class="op" id="3697916">.</span><span class="ident" id="3697917">ConstantTimeByteEq</span><span class="op" id="3697935">(</span><span class="ident" id="3697936">em</span><span class="op" id="3697938">[</span><span class="num" id="3697939">1</span><span class="op" id="3697940">]</span><span class="op" id="3697941">,</span>&nbsp;<span class="num" id="3697943">2</span><span class="op" id="3697944">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3697948">//&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;plaintext&nbsp;must&nbsp;be&nbsp;a&nbsp;string&nbsp;of&nbsp;non-zero&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3698019">//&nbsp;octets,&nbsp;followed&nbsp;by&nbsp;a&nbsp;0,&nbsp;followed&nbsp;by&nbsp;the&nbsp;message.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3698073">//&nbsp;&nbsp;&nbsp;lookingForIndex:&nbsp;1&nbsp;iff&nbsp;we&nbsp;are&nbsp;still&nbsp;looking&nbsp;for&nbsp;the&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3698137">//&nbsp;&nbsp;&nbsp;index:&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;first&nbsp;zero&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698185">lookingForIndex</span>&nbsp;<span class="op" id="3698201">:=</span>&nbsp;<span class="num" id="3698204">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3698208">for</span>&nbsp;<span class="ident" id="3698212">i</span>&nbsp;<span class="op" id="3698214">:=</span>&nbsp;<span class="num" id="3698217">2</span><span class="op" id="3698218">;</span>&nbsp;<span class="ident" id="3698220">i</span>&nbsp;<span class="op" id="3698222">&lt;</span>&nbsp;<span class="builtinfunc" id="3698224">len</span><span class="op" id="3698227">(</span><span class="ident" id="3698228">em</span><span class="op" id="3698230">)</span><span class="op" id="3698231">;</span>&nbsp;<span class="ident" id="3698233">i</span><span class="op" id="3698234">++</span>&nbsp;<span class="op" id="3698237">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698241">equals0</span>&nbsp;<span class="op" id="3698249">:=</span>&nbsp;<span class="ident" id="3698252">subtle</span><span class="op" id="3698258">.</span><span class="ident" id="3698259">ConstantTimeByteEq</span><span class="op" id="3698277">(</span><span class="ident" id="3698278">em</span><span class="op" id="3698280">[</span><span class="ident" id="3698281">i</span><span class="op" id="3698282">]</span><span class="op" id="3698283">,</span>&nbsp;<span class="num" id="3698285">0</span><span class="op" id="3698286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698290">index</span>&nbsp;<span class="op" id="3698296">=</span>&nbsp;<span class="ident" id="3698298">subtle</span><span class="op" id="3698304">.</span><span class="ident" id="3698305">ConstantTimeSelect</span><span class="op" id="3698323">(</span><span class="ident" id="3698324">lookingForIndex</span><span class="op" id="3698339">&amp;</span><span class="ident" id="3698340">equals0</span><span class="op" id="3698347">,</span>&nbsp;<span class="ident" id="3698349">i</span><span class="op" id="3698350">,</span>&nbsp;<span class="ident" id="3698352">index</span><span class="op" id="3698357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698361">lookingForIndex</span>&nbsp;<span class="op" id="3698377">=</span>&nbsp;<span class="ident" id="3698379">subtle</span><span class="op" id="3698385">.</span><span class="ident" id="3698386">ConstantTimeSelect</span><span class="op" id="3698404">(</span><span class="ident" id="3698405">equals0</span><span class="op" id="3698412">,</span>&nbsp;<span class="num" id="3698414">0</span><span class="op" id="3698415">,</span>&nbsp;<span class="ident" id="3698417">lookingForIndex</span><span class="op" id="3698432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3698435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3698439">//&nbsp;The&nbsp;PS&nbsp;padding&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;8&nbsp;bytes&nbsp;long,&nbsp;and&nbsp;it&nbsp;starts&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3698507">//&nbsp;bytes&nbsp;into&nbsp;em.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698526">validPS</span>&nbsp;<span class="op" id="3698534">:=</span>&nbsp;<span class="ident" id="3698537">subtle</span><span class="op" id="3698543">.</span><span class="ident" id="3698544">ConstantTimeLessOrEq</span><span class="op" id="3698564">(</span><span class="num" id="3698565">2</span><span class="op" id="3698566">+</span><span class="num" id="3698567">8</span><span class="op" id="3698568">,</span>&nbsp;<span class="ident" id="3698570">index</span><span class="op" id="3698575">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698579">valid</span>&nbsp;<span class="op" id="3698585">=</span>&nbsp;<span class="ident" id="3698587">firstByteIsZero</span>&nbsp;<span class="op" id="3698603">&amp;</span>&nbsp;<span class="ident" id="3698605">secondByteIsTwo</span>&nbsp;<span class="op" id="3698621">&amp;</span>&nbsp;<span class="op" id="3698623">(</span><span class="op" id="3698624">^</span><span class="ident" id="3698625">lookingForIndex</span>&nbsp;<span class="op" id="3698641">&amp;</span>&nbsp;<span class="num" id="3698643">1</span><span class="op" id="3698644">)</span>&nbsp;<span class="op" id="3698646">&amp;</span>&nbsp;<span class="ident" id="3698648">validPS</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698657">index</span>&nbsp;<span class="op" id="3698663">=</span>&nbsp;<span class="ident" id="3698665">subtle</span><span class="op" id="3698671">.</span><span class="ident" id="3698672">ConstantTimeSelect</span><span class="op" id="3698690">(</span><span class="ident" id="3698691">valid</span><span class="op" id="3698696">,</span>&nbsp;<span class="ident" id="3698698">index</span><span class="op" id="3698703">+</span><span class="num" id="3698704">1</span><span class="op" id="3698705">,</span>&nbsp;<span class="num" id="3698707">0</span><span class="op" id="3698708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3698711">return</span>&nbsp;<span class="ident" id="3698718">valid</span><span class="op" id="3698723">,</span>&nbsp;<span class="ident" id="3698725">em</span><span class="op" id="3698727">,</span>&nbsp;<span class="ident" id="3698729">index</span><span class="op" id="3698734">,</span>&nbsp;<span class="ident" id="3698736">nil</span><br>
<span class="lineno"></span><span class="op" id="3698740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3698743">//&nbsp;nonZeroRandomBytes&nbsp;fills&nbsp;the&nbsp;given&nbsp;slice&nbsp;with&nbsp;non-zero&nbsp;random&nbsp;octets.</span><br>
<span class="lineno">150</span><span class="keyword" id="3698816">func</span>&nbsp;<span class="ident" id="3698821">nonZeroRandomBytes</span><span class="op" id="3698839">(</span><span class="ident" id="3698840">s</span>&nbsp;<span class="op" id="3698842">[</span><span class="op" id="3698843">]</span><span class="builtintype" id="3698844">byte</span><span class="op" id="3698848">,</span>&nbsp;<span class="ident" id="3698850">rand</span>&nbsp;<span class="ident" id="3698855">io</span><span class="op" id="3698857">.</span><span class="ident" id="3698858">Reader</span><span class="op" id="3698864">)</span>&nbsp;<span class="op" id="3698866">(</span><span class="ident" id="3698867">err</span>&nbsp;<span class="builtintype" id="3698871">error</span><span class="op" id="3698876">)</span>&nbsp;<span class="op" id="3698878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698881">_</span><span class="op" id="3698882">,</span>&nbsp;<span class="ident" id="3698884">err</span>&nbsp;<span class="op" id="3698888">=</span>&nbsp;<span class="ident" id="3698890">io</span><span class="op" id="3698892">.</span><span class="ident" id="3698893">ReadFull</span><span class="op" id="3698901">(</span><span class="ident" id="3698902">rand</span><span class="op" id="3698906">,</span>&nbsp;<span class="ident" id="3698908">s</span><span class="op" id="3698909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3698912">if</span>&nbsp;<span class="ident" id="3698915">err</span>&nbsp;<span class="op" id="3698919">!=</span>&nbsp;<span class="ident" id="3698922">nil</span>&nbsp;<span class="op" id="3698926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3698930">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3698938">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3698942">for</span>&nbsp;<span class="ident" id="3698946">i</span>&nbsp;<span class="op" id="3698948">:=</span>&nbsp;<span class="num" id="3698951">0</span><span class="op" id="3698952">;</span>&nbsp;<span class="ident" id="3698954">i</span>&nbsp;<span class="op" id="3698956">&lt;</span>&nbsp;<span class="builtinfunc" id="3698958">len</span><span class="op" id="3698961">(</span><span class="ident" id="3698962">s</span><span class="op" id="3698963">)</span><span class="op" id="3698964">;</span>&nbsp;<span class="ident" id="3698966">i</span><span class="op" id="3698967">++</span>&nbsp;<span class="op" id="3698970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3698974">for</span>&nbsp;<span class="ident" id="3698978">s</span><span class="op" id="3698979">[</span><span class="ident" id="3698980">i</span><span class="op" id="3698981">]</span>&nbsp;<span class="op" id="3698983">==</span>&nbsp;<span class="num" id="3698986">0</span>&nbsp;<span class="op" id="3698988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3698993">_</span><span class="op" id="3698994">,</span>&nbsp;<span class="ident" id="3698996">err</span>&nbsp;<span class="op" id="3699000">=</span>&nbsp;<span class="ident" id="3699002">io</span><span class="op" id="3699004">.</span><span class="ident" id="3699005">ReadFull</span><span class="op" id="3699013">(</span><span class="ident" id="3699014">rand</span><span class="op" id="3699018">,</span>&nbsp;<span class="ident" id="3699020">s</span><span class="op" id="3699021">[</span><span class="ident" id="3699022">i</span><span class="op" id="3699023">:</span><span class="ident" id="3699024">i</span><span class="op" id="3699025">+</span><span class="num" id="3699026">1</span><span class="op" id="3699027">]</span><span class="op" id="3699028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3699033">if</span>&nbsp;<span class="ident" id="3699036">err</span>&nbsp;<span class="op" id="3699040">!=</span>&nbsp;<span class="ident" id="3699043">nil</span>&nbsp;<span class="op" id="3699047">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3699053">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3699063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3699068">//&nbsp;In&nbsp;tests,&nbsp;the&nbsp;PRNG&nbsp;may&nbsp;return&nbsp;all&nbsp;zeros&nbsp;so&nbsp;we&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3699123">//&nbsp;this&nbsp;to&nbsp;break&nbsp;the&nbsp;loop.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699153">s</span><span class="op" id="3699154">[</span><span class="ident" id="3699155">i</span><span class="op" id="3699156">]</span>&nbsp;<span class="op" id="3699158">^=</span>&nbsp;<span class="num" id="3699161">0x42</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3699168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3699171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3699175">return</span><br>
<span class="lineno"></span><span class="op" id="3699182">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="3699185">//&nbsp;These&nbsp;are&nbsp;ASN1&nbsp;DER&nbsp;structures:</span><br>
<span class="lineno"></span><span class="comment" id="3699219">//&nbsp;&nbsp;&nbsp;DigestInfo&nbsp;::=&nbsp;SEQUENCE&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3699250">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digestAlgorithm&nbsp;AlgorithmIdentifier,</span><br>
<span class="lineno"></span><span class="comment" id="3699294">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;digest&nbsp;OCTET&nbsp;STRING</span><br>
<span class="lineno">175</span><span class="comment" id="3699321">//&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3699328">//&nbsp;For&nbsp;performance,&nbsp;we&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;generic&nbsp;ASN1&nbsp;encoder.&nbsp;Rather,&nbsp;we</span><br>
<span class="lineno"></span><span class="comment" id="3699398">//&nbsp;precompute&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;digest&nbsp;value&nbsp;that&nbsp;makes&nbsp;a&nbsp;valid&nbsp;ASN1&nbsp;DER&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3699476">//&nbsp;with&nbsp;the&nbsp;correct&nbsp;contents.</span><br>
<span class="lineno"></span><span class="keyword" id="3699506">var</span>&nbsp;<span class="ident" id="3699510">hashPrefixes</span>&nbsp;<span class="op" id="3699523">=</span>&nbsp;<span class="keyword" id="3699525">map</span><span class="op" id="3699528">[</span><span class="ident" id="3699529">crypto</span><span class="op" id="3699535">.</span><span class="ident" id="3699536">Hash</span><span class="op" id="3699540">]</span><span class="op" id="3699541">[</span><span class="op" id="3699542">]</span><span class="builtintype" id="3699543">byte</span><span class="op" id="3699547">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699550">crypto</span><span class="op" id="3699556">.</span><span class="ident" id="3699557">MD5</span><span class="op" id="3699560">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3699568">{</span><span class="num" id="3699569">0x30</span><span class="op" id="3699573">,</span>&nbsp;<span class="num" id="3699575">0x20</span><span class="op" id="3699579">,</span>&nbsp;<span class="num" id="3699581">0x30</span><span class="op" id="3699585">,</span>&nbsp;<span class="num" id="3699587">0x0c</span><span class="op" id="3699591">,</span>&nbsp;<span class="num" id="3699593">0x06</span><span class="op" id="3699597">,</span>&nbsp;<span class="num" id="3699599">0x08</span><span class="op" id="3699603">,</span>&nbsp;<span class="num" id="3699605">0x2a</span><span class="op" id="3699609">,</span>&nbsp;<span class="num" id="3699611">0x86</span><span class="op" id="3699615">,</span>&nbsp;<span class="num" id="3699617">0x48</span><span class="op" id="3699621">,</span>&nbsp;<span class="num" id="3699623">0x86</span><span class="op" id="3699627">,</span>&nbsp;<span class="num" id="3699629">0xf7</span><span class="op" id="3699633">,</span>&nbsp;<span class="num" id="3699635">0x0d</span><span class="op" id="3699639">,</span>&nbsp;<span class="num" id="3699641">0x02</span><span class="op" id="3699645">,</span>&nbsp;<span class="num" id="3699647">0x05</span><span class="op" id="3699651">,</span>&nbsp;<span class="num" id="3699653">0x05</span><span class="op" id="3699657">,</span>&nbsp;<span class="num" id="3699659">0x00</span><span class="op" id="3699663">,</span>&nbsp;<span class="num" id="3699665">0x04</span><span class="op" id="3699669">,</span>&nbsp;<span class="num" id="3699671">0x10</span><span class="op" id="3699675">}</span><span class="op" id="3699676">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699679">crypto</span><span class="op" id="3699685">.</span><span class="ident" id="3699686">SHA1</span><span class="op" id="3699690">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3699697">{</span><span class="num" id="3699698">0x30</span><span class="op" id="3699702">,</span>&nbsp;<span class="num" id="3699704">0x21</span><span class="op" id="3699708">,</span>&nbsp;<span class="num" id="3699710">0x30</span><span class="op" id="3699714">,</span>&nbsp;<span class="num" id="3699716">0x09</span><span class="op" id="3699720">,</span>&nbsp;<span class="num" id="3699722">0x06</span><span class="op" id="3699726">,</span>&nbsp;<span class="num" id="3699728">0x05</span><span class="op" id="3699732">,</span>&nbsp;<span class="num" id="3699734">0x2b</span><span class="op" id="3699738">,</span>&nbsp;<span class="num" id="3699740">0x0e</span><span class="op" id="3699744">,</span>&nbsp;<span class="num" id="3699746">0x03</span><span class="op" id="3699750">,</span>&nbsp;<span class="num" id="3699752">0x02</span><span class="op" id="3699756">,</span>&nbsp;<span class="num" id="3699758">0x1a</span><span class="op" id="3699762">,</span>&nbsp;<span class="num" id="3699764">0x05</span><span class="op" id="3699768">,</span>&nbsp;<span class="num" id="3699770">0x00</span><span class="op" id="3699774">,</span>&nbsp;<span class="num" id="3699776">0x04</span><span class="op" id="3699780">,</span>&nbsp;<span class="num" id="3699782">0x14</span><span class="op" id="3699786">}</span><span class="op" id="3699787">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699790">crypto</span><span class="op" id="3699796">.</span><span class="ident" id="3699797">SHA224</span><span class="op" id="3699803">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3699808">{</span><span class="num" id="3699809">0x30</span><span class="op" id="3699813">,</span>&nbsp;<span class="num" id="3699815">0x2d</span><span class="op" id="3699819">,</span>&nbsp;<span class="num" id="3699821">0x30</span><span class="op" id="3699825">,</span>&nbsp;<span class="num" id="3699827">0x0d</span><span class="op" id="3699831">,</span>&nbsp;<span class="num" id="3699833">0x06</span><span class="op" id="3699837">,</span>&nbsp;<span class="num" id="3699839">0x09</span><span class="op" id="3699843">,</span>&nbsp;<span class="num" id="3699845">0x60</span><span class="op" id="3699849">,</span>&nbsp;<span class="num" id="3699851">0x86</span><span class="op" id="3699855">,</span>&nbsp;<span class="num" id="3699857">0x48</span><span class="op" id="3699861">,</span>&nbsp;<span class="num" id="3699863">0x01</span><span class="op" id="3699867">,</span>&nbsp;<span class="num" id="3699869">0x65</span><span class="op" id="3699873">,</span>&nbsp;<span class="num" id="3699875">0x03</span><span class="op" id="3699879">,</span>&nbsp;<span class="num" id="3699881">0x04</span><span class="op" id="3699885">,</span>&nbsp;<span class="num" id="3699887">0x02</span><span class="op" id="3699891">,</span>&nbsp;<span class="num" id="3699893">0x04</span><span class="op" id="3699897">,</span>&nbsp;<span class="num" id="3699899">0x05</span><span class="op" id="3699903">,</span>&nbsp;<span class="num" id="3699905">0x00</span><span class="op" id="3699909">,</span>&nbsp;<span class="num" id="3699911">0x04</span><span class="op" id="3699915">,</span>&nbsp;<span class="num" id="3699917">0x1c</span><span class="op" id="3699921">}</span><span class="op" id="3699922">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3699925">crypto</span><span class="op" id="3699931">.</span><span class="ident" id="3699932">SHA256</span><span class="op" id="3699938">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3699943">{</span><span class="num" id="3699944">0x30</span><span class="op" id="3699948">,</span>&nbsp;<span class="num" id="3699950">0x31</span><span class="op" id="3699954">,</span>&nbsp;<span class="num" id="3699956">0x30</span><span class="op" id="3699960">,</span>&nbsp;<span class="num" id="3699962">0x0d</span><span class="op" id="3699966">,</span>&nbsp;<span class="num" id="3699968">0x06</span><span class="op" id="3699972">,</span>&nbsp;<span class="num" id="3699974">0x09</span><span class="op" id="3699978">,</span>&nbsp;<span class="num" id="3699980">0x60</span><span class="op" id="3699984">,</span>&nbsp;<span class="num" id="3699986">0x86</span><span class="op" id="3699990">,</span>&nbsp;<span class="num" id="3699992">0x48</span><span class="op" id="3699996">,</span>&nbsp;<span class="num" id="3699998">0x01</span><span class="op" id="3700002">,</span>&nbsp;<span class="num" id="3700004">0x65</span><span class="op" id="3700008">,</span>&nbsp;<span class="num" id="3700010">0x03</span><span class="op" id="3700014">,</span>&nbsp;<span class="num" id="3700016">0x04</span><span class="op" id="3700020">,</span>&nbsp;<span class="num" id="3700022">0x02</span><span class="op" id="3700026">,</span>&nbsp;<span class="num" id="3700028">0x01</span><span class="op" id="3700032">,</span>&nbsp;<span class="num" id="3700034">0x05</span><span class="op" id="3700038">,</span>&nbsp;<span class="num" id="3700040">0x00</span><span class="op" id="3700044">,</span>&nbsp;<span class="num" id="3700046">0x04</span><span class="op" id="3700050">,</span>&nbsp;<span class="num" id="3700052">0x20</span><span class="op" id="3700056">}</span><span class="op" id="3700057">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3700060">crypto</span><span class="op" id="3700066">.</span><span class="ident" id="3700067">SHA384</span><span class="op" id="3700073">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3700078">{</span><span class="num" id="3700079">0x30</span><span class="op" id="3700083">,</span>&nbsp;<span class="num" id="3700085">0x41</span><span class="op" id="3700089">,</span>&nbsp;<span class="num" id="3700091">0x30</span><span class="op" id="3700095">,</span>&nbsp;<span class="num" id="3700097">0x0d</span><span class="op" id="3700101">,</span>&nbsp;<span class="num" id="3700103">0x06</span><span class="op" id="3700107">,</span>&nbsp;<span class="num" id="3700109">0x09</span><span class="op" id="3700113">,</span>&nbsp;<span class="num" id="3700115">0x60</span><span class="op" id="3700119">,</span>&nbsp;<span class="num" id="3700121">0x86</span><span class="op" id="3700125">,</span>&nbsp;<span class="num" id="3700127">0x48</span><span class="op" id="3700131">,</span>&nbsp;<span class="num" id="3700133">0x01</span><span class="op" id="3700137">,</span>&nbsp;<span class="num" id="3700139">0x65</span><span class="op" id="3700143">,</span>&nbsp;<span class="num" id="3700145">0x03</span><span class="op" id="3700149">,</span>&nbsp;<span class="num" id="3700151">0x04</span><span class="op" id="3700155">,</span>&nbsp;<span class="num" id="3700157">0x02</span><span class="op" id="3700161">,</span>&nbsp;<span class="num" id="3700163">0x02</span><span class="op" id="3700167">,</span>&nbsp;<span class="num" id="3700169">0x05</span><span class="op" id="3700173">,</span>&nbsp;<span class="num" id="3700175">0x00</span><span class="op" id="3700179">,</span>&nbsp;<span class="num" id="3700181">0x04</span><span class="op" id="3700185">,</span>&nbsp;<span class="num" id="3700187">0x30</span><span class="op" id="3700191">}</span><span class="op" id="3700192">,</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3700195">crypto</span><span class="op" id="3700201">.</span><span class="ident" id="3700202">SHA512</span><span class="op" id="3700208">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3700213">{</span><span class="num" id="3700214">0x30</span><span class="op" id="3700218">,</span>&nbsp;<span class="num" id="3700220">0x51</span><span class="op" id="3700224">,</span>&nbsp;<span class="num" id="3700226">0x30</span><span class="op" id="3700230">,</span>&nbsp;<span class="num" id="3700232">0x0d</span><span class="op" id="3700236">,</span>&nbsp;<span class="num" id="3700238">0x06</span><span class="op" id="3700242">,</span>&nbsp;<span class="num" id="3700244">0x09</span><span class="op" id="3700248">,</span>&nbsp;<span class="num" id="3700250">0x60</span><span class="op" id="3700254">,</span>&nbsp;<span class="num" id="3700256">0x86</span><span class="op" id="3700260">,</span>&nbsp;<span class="num" id="3700262">0x48</span><span class="op" id="3700266">,</span>&nbsp;<span class="num" id="3700268">0x01</span><span class="op" id="3700272">,</span>&nbsp;<span class="num" id="3700274">0x65</span><span class="op" id="3700278">,</span>&nbsp;<span class="num" id="3700280">0x03</span><span class="op" id="3700284">,</span>&nbsp;<span class="num" id="3700286">0x04</span><span class="op" id="3700290">,</span>&nbsp;<span class="num" id="3700292">0x02</span><span class="op" id="3700296">,</span>&nbsp;<span class="num" id="3700298">0x03</span><span class="op" id="3700302">,</span>&nbsp;<span class="num" id="3700304">0x05</span><span class="op" id="3700308">,</span>&nbsp;<span class="num" id="3700310">0x00</span><span class="op" id="3700314">,</span>&nbsp;<span class="num" id="3700316">0x04</span><span class="op" id="3700320">,</span>&nbsp;<span class="num" id="3700322">0x40</span><span class="op" id="3700326">}</span><span class="op" id="3700327">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3700330">crypto</span><span class="op" id="3700336">.</span><span class="ident" id="3700337">MD5SHA1</span><span class="op" id="3700344">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3700348">{</span><span class="op" id="3700349">}</span><span class="op" id="3700350">,</span>&nbsp;<span class="comment" id="3700352">//&nbsp;A&nbsp;special&nbsp;TLS&nbsp;case&nbsp;which&nbsp;doesn&#39;t&nbsp;use&nbsp;an&nbsp;ASN1&nbsp;prefix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3700409">crypto</span><span class="op" id="3700415">.</span><span class="ident" id="3700416">RIPEMD160</span><span class="op" id="3700425">:</span>&nbsp;<span class="op" id="3700427">{</span><span class="num" id="3700428">0x30</span><span class="op" id="3700432">,</span>&nbsp;<span class="num" id="3700434">0x20</span><span class="op" id="3700438">,</span>&nbsp;<span class="num" id="3700440">0x30</span><span class="op" id="3700444">,</span>&nbsp;<span class="num" id="3700446">0x08</span><span class="op" id="3700450">,</span>&nbsp;<span class="num" id="3700452">0x06</span><span class="op" id="3700456">,</span>&nbsp;<span class="num" id="3700458">0x06</span><span class="op" id="3700462">,</span>&nbsp;<span class="num" id="3700464">0x28</span><span class="op" id="3700468">,</span>&nbsp;<span class="num" id="3700470">0xcf</span><span class="op" id="3700474">,</span>&nbsp;<span class="num" id="3700476">0x06</span><span class="op" id="3700480">,</span>&nbsp;<span class="num" id="3700482">0x03</span><span class="op" id="3700486">,</span>&nbsp;<span class="num" id="3700488">0x00</span><span class="op" id="3700492">,</span>&nbsp;<span class="num" id="3700494">0x31</span><span class="op" id="3700498">,</span>&nbsp;<span class="num" id="3700500">0x04</span><span class="op" id="3700504">,</span>&nbsp;<span class="num" id="3700506">0x14</span><span class="op" id="3700510">}</span><span class="op" id="3700511">,</span><br>
<span class="lineno"></span><span class="op" id="3700513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="comment" id="3700516">//&nbsp;SignPKCS1v15&nbsp;calculates&nbsp;the&nbsp;signature&nbsp;of&nbsp;hashed&nbsp;using&nbsp;RSASSA-PKCS1-V1_5-SIGN&nbsp;from&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5.</span><br>
<span class="lineno"></span><span class="comment" id="3700618">//&nbsp;Note&nbsp;that&nbsp;hashed&nbsp;must&nbsp;be&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3700696">//&nbsp;given&nbsp;hash&nbsp;function.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero,&nbsp;hashed&nbsp;is&nbsp;signed&nbsp;directly.&nbsp;This&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3700775">//&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="3700817">func</span>&nbsp;<span class="ident" id="3700822">SignPKCS1v15</span><span class="op" id="3700834">(</span><span class="ident" id="3700835">rand</span>&nbsp;<span class="ident" id="3700840">io</span><span class="op" id="3700842">.</span><span class="ident" id="3700843">Reader</span><span class="op" id="3700849">,</span>&nbsp;<span class="ident" id="3700851">priv</span>&nbsp;<span class="op" id="3700856">*</span><span class="ident" id="3700857">PrivateKey</span><span class="op" id="3700867">,</span>&nbsp;<span class="ident" id="3700869">hash</span>&nbsp;<span class="ident" id="3700874">crypto</span><span class="op" id="3700880">.</span><span class="ident" id="3700881">Hash</span><span class="op" id="3700885">,</span>&nbsp;<span class="ident" id="3700887">hashed</span>&nbsp;<span class="op" id="3700894">[</span><span class="op" id="3700895">]</span><span class="builtintype" id="3700896">byte</span><span class="op" id="3700900">)</span>&nbsp;<span class="op" id="3700902">(</span><span class="ident" id="3700903">s</span>&nbsp;<span class="op" id="3700905">[</span><span class="op" id="3700906">]</span><span class="builtintype" id="3700907">byte</span><span class="op" id="3700911">,</span>&nbsp;<span class="ident" id="3700913">err</span>&nbsp;<span class="builtintype" id="3700917">error</span><span class="op" id="3700922">)</span>&nbsp;<span class="op" id="3700924">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3700927">hashLen</span><span class="op" id="3700934">,</span>&nbsp;<span class="ident" id="3700936">prefix</span><span class="op" id="3700942">,</span>&nbsp;<span class="ident" id="3700944">err</span>&nbsp;<span class="op" id="3700948">:=</span>&nbsp;<span class="ident" id="3700951">pkcs1v15HashInfo</span><span class="op" id="3700967">(</span><span class="ident" id="3700968">hash</span><span class="op" id="3700972">,</span>&nbsp;<span class="builtinfunc" id="3700974">len</span><span class="op" id="3700977">(</span><span class="ident" id="3700978">hashed</span><span class="op" id="3700984">)</span><span class="op" id="3700985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3700988">if</span>&nbsp;<span class="ident" id="3700991">err</span>&nbsp;<span class="op" id="3700995">!=</span>&nbsp;<span class="ident" id="3700998">nil</span>&nbsp;<span class="op" id="3701002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3701006">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3701014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3701018">tLen</span>&nbsp;<span class="op" id="3701023">:=</span>&nbsp;<span class="builtinfunc" id="3701026">len</span><span class="op" id="3701029">(</span><span class="ident" id="3701030">prefix</span><span class="op" id="3701036">)</span>&nbsp;<span class="op" id="3701038">+</span>&nbsp;<span class="ident" id="3701040">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3701049">k</span>&nbsp;<span class="op" id="3701051">:=</span>&nbsp;<span class="op" id="3701054">(</span><span class="ident" id="3701055">priv</span><span class="op" id="3701059">.</span><span class="ident" id="3701060">N</span><span class="op" id="3701061">.</span><span class="ident" id="3701062">BitLen</span><span class="op" id="3701068">(</span><span class="op" id="3701069">)</span>&nbsp;<span class="op" id="3701071">+</span>&nbsp;<span class="num" id="3701073">7</span><span class="op" id="3701074">)</span>&nbsp;<span class="op" id="3701076">/</span>&nbsp;<span class="num" id="3701078">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3701081">if</span>&nbsp;<span class="ident" id="3701084">k</span>&nbsp;<span class="op" id="3701086">&lt;</span>&nbsp;<span class="ident" id="3701088">tLen</span><span class="op" id="3701092">+</span><span class="num" id="3701093">11</span>&nbsp;<span class="op" id="3701096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3701100">return</span>&nbsp;<span class="ident" id="3701107">nil</span><span class="op" id="3701110">,</span>&nbsp;<span class="ident" id="3701112">ErrMessageTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3701131">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3701135">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3701176">em</span>&nbsp;<span class="op" id="3701179">:=</span>&nbsp;<span class="builtinfunc" id="3701182">make</span><span class="op" id="3701186">(</span><span class="op" id="3701187">[</span><span class="op" id="3701188">]</span><span class="builtintype" id="3701189">byte</span><span class="op" id="3701193">,</span>&nbsp;<span class="ident" id="3701195">k</span><span class="op" id="3701196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3701199">em</span><span class="op" id="3701201">[</span><span class="num" id="3701202">1</span><span class="op" id="3701203">]</span>&nbsp;<span class="op" id="3701205">=</span>&nbsp;<span class="num" id="3701207">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3701210">for</span>&nbsp;<span class="ident" id="3701214">i</span>&nbsp;<span class="op" id="3701216">:=</span>&nbsp;<span class="num" id="3701219">2</span><span class="op" id="3701220">;</span>&nbsp;<span class="ident" id="3701222">i</span>&nbsp;<span class="op" id="3701224">&lt;</span>&nbsp;<span class="ident" id="3701226">k</span><span class="op" id="3701227">-</span><span class="ident" id="3701228">tLen</span><span class="op" id="3701232">-</span><span class="num" id="3701233">1</span><span class="op" id="3701234">;</span>&nbsp;<span class="ident" id="3701236">i</span><span class="op" id="3701237">++</span>&nbsp;<span class="op" id="3701240">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3701244">em</span><span class="op" id="3701246">[</span><span class="ident" id="3701247">i</span><span class="op" id="3701248">]</span>&nbsp;<span class="op" id="3701250">=</span>&nbsp;<span class="num" id="3701252">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3701258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3701261">copy</span><span class="op" id="3701265">(</span><span class="ident" id="3701266">em</span><span class="op" id="3701268">[</span><span class="ident" id="3701269">k</span><span class="op" id="3701270">-</span><span class="ident" id="3701271">tLen</span><span class="op" id="3701275">:</span><span class="ident" id="3701276">k</span><span class="op" id="3701277">-</span><span class="ident" id="3701278">hashLen</span><span class="op" id="3701285">]</span><span class="op" id="3701286">,</span>&nbsp;<span class="ident" id="3701288">prefix</span><span class="op" id="3701294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3701297">copy</span><span class="op" id="3701301">(</span><span class="ident" id="3701302">em</span><span class="op" id="3701304">[</span><span class="ident" id="3701305">k</span><span class="op" id="3701306">-</span><span class="ident" id="3701307">hashLen</span><span class="op" id="3701314">:</span><span class="ident" id="3701315">k</span><span class="op" id="3701316">]</span><span class="op" id="3701317">,</span>&nbsp;<span class="ident" id="3701319">hashed</span><span class="op" id="3701325">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3701329">m</span>&nbsp;<span class="op" id="3701331">:=</span>&nbsp;<span class="builtinfunc" id="3701334">new</span><span class="op" id="3701337">(</span><span class="ident" id="3701338">big</span><span class="op" id="3701341">.</span><span class="ident" id="3701342">Int</span><span class="op" id="3701345">)</span><span class="op" id="3701346">.</span><span class="ident" id="3701347">SetBytes</span><span class="op" id="3701355">(</span><span class="ident" id="3701356">em</span><span class="op" id="3701358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3701361">c</span><span class="op" id="3701362">,</span>&nbsp;<span class="ident" id="3701364">err</span>&nbsp;<span class="op" id="3701368">:=</span>&nbsp;<span class="ident" id="3701371">decrypt</span><span class="op" id="3701378">(</span><span class="ident" id="3701379">rand</span><span class="op" id="3701383">,</span>&nbsp;<span class="ident" id="3701385">priv</span><span class="op" id="3701389">,</span>&nbsp;<span class="ident" id="3701391">m</span><span class="op" id="3701392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3701395">if</span>&nbsp;<span class="ident" id="3701398">err</span>&nbsp;<span class="op" id="3701402">!=</span>&nbsp;<span class="ident" id="3701405">nil</span>&nbsp;<span class="op" id="3701409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3701413">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3701421">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3701425">copyWithLeftPad</span><span class="op" id="3701440">(</span><span class="ident" id="3701441">em</span><span class="op" id="3701443">,</span>&nbsp;<span class="ident" id="3701445">c</span><span class="op" id="3701446">.</span><span class="ident" id="3701447">Bytes</span><span class="op" id="3701452">(</span><span class="op" id="3701453">)</span><span class="op" id="3701454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3701457">s</span>&nbsp;<span class="op" id="3701459">=</span>&nbsp;<span class="ident" id="3701461">em</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3701465">return</span><br>
<span class="lineno"></span><span class="op" id="3701472">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="comment" id="3701475">//&nbsp;VerifyPKCS1v15&nbsp;verifies&nbsp;an&nbsp;RSA&nbsp;PKCS#1&nbsp;v1.5&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment" id="3701532">//&nbsp;hashed&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;hashing&nbsp;the&nbsp;input&nbsp;message&nbsp;using&nbsp;the&nbsp;given&nbsp;hash</span><br>
<span class="lineno"></span><span class="comment" id="3701606">//&nbsp;function&nbsp;and&nbsp;sig&nbsp;is&nbsp;the&nbsp;signature.&nbsp;A&nbsp;valid&nbsp;signature&nbsp;is&nbsp;indicated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3701678">//&nbsp;returning&nbsp;a&nbsp;nil&nbsp;error.&nbsp;If&nbsp;hash&nbsp;is&nbsp;zero&nbsp;then&nbsp;hashed&nbsp;is&nbsp;used&nbsp;directly.&nbsp;This</span><br>
<span class="lineno">230</span><span class="comment" id="3701755">//&nbsp;isn&#39;t&nbsp;advisable&nbsp;except&nbsp;for&nbsp;interoperability.</span><br>
<span class="lineno"></span><span class="keyword" id="3701803">func</span>&nbsp;<span class="ident" id="3701808">VerifyPKCS1v15</span><span class="op" id="3701822">(</span><span class="ident" id="3701823">pub</span>&nbsp;<span class="op" id="3701827">*</span><span class="ident" id="3701828">PublicKey</span><span class="op" id="3701837">,</span>&nbsp;<span class="ident" id="3701839">hash</span>&nbsp;<span class="ident" id="3701844">crypto</span><span class="op" id="3701850">.</span><span class="ident" id="3701851">Hash</span><span class="op" id="3701855">,</span>&nbsp;<span class="ident" id="3701857">hashed</span>&nbsp;<span class="op" id="3701864">[</span><span class="op" id="3701865">]</span><span class="builtintype" id="3701866">byte</span><span class="op" id="3701870">,</span>&nbsp;<span class="ident" id="3701872">sig</span>&nbsp;<span class="op" id="3701876">[</span><span class="op" id="3701877">]</span><span class="builtintype" id="3701878">byte</span><span class="op" id="3701882">)</span>&nbsp;<span class="op" id="3701884">(</span><span class="ident" id="3701885">err</span>&nbsp;<span class="builtintype" id="3701889">error</span><span class="op" id="3701894">)</span>&nbsp;<span class="op" id="3701896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3701899">hashLen</span><span class="op" id="3701906">,</span>&nbsp;<span class="ident" id="3701908">prefix</span><span class="op" id="3701914">,</span>&nbsp;<span class="ident" id="3701916">err</span>&nbsp;<span class="op" id="3701920">:=</span>&nbsp;<span class="ident" id="3701923">pkcs1v15HashInfo</span><span class="op" id="3701939">(</span><span class="ident" id="3701940">hash</span><span class="op" id="3701944">,</span>&nbsp;<span class="builtinfunc" id="3701946">len</span><span class="op" id="3701949">(</span><span class="ident" id="3701950">hashed</span><span class="op" id="3701956">)</span><span class="op" id="3701957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3701960">if</span>&nbsp;<span class="ident" id="3701963">err</span>&nbsp;<span class="op" id="3701967">!=</span>&nbsp;<span class="ident" id="3701970">nil</span>&nbsp;<span class="op" id="3701974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3701978">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3701986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3701990">tLen</span>&nbsp;<span class="op" id="3701995">:=</span>&nbsp;<span class="builtinfunc" id="3701998">len</span><span class="op" id="3702001">(</span><span class="ident" id="3702002">prefix</span><span class="op" id="3702008">)</span>&nbsp;<span class="op" id="3702010">+</span>&nbsp;<span class="ident" id="3702012">hashLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3702021">k</span>&nbsp;<span class="op" id="3702023">:=</span>&nbsp;<span class="op" id="3702026">(</span><span class="ident" id="3702027">pub</span><span class="op" id="3702030">.</span><span class="ident" id="3702031">N</span><span class="op" id="3702032">.</span><span class="ident" id="3702033">BitLen</span><span class="op" id="3702039">(</span><span class="op" id="3702040">)</span>&nbsp;<span class="op" id="3702042">+</span>&nbsp;<span class="num" id="3702044">7</span><span class="op" id="3702045">)</span>&nbsp;<span class="op" id="3702047">/</span>&nbsp;<span class="num" id="3702049">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3702052">if</span>&nbsp;<span class="ident" id="3702055">k</span>&nbsp;<span class="op" id="3702057">&lt;</span>&nbsp;<span class="ident" id="3702059">tLen</span><span class="op" id="3702063">+</span><span class="num" id="3702064">11</span>&nbsp;<span class="op" id="3702067">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3702071">err</span>&nbsp;<span class="op" id="3702075">=</span>&nbsp;<span class="ident" id="3702077">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3702095">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3702103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3702107">c</span>&nbsp;<span class="op" id="3702109">:=</span>&nbsp;<span class="builtinfunc" id="3702112">new</span><span class="op" id="3702115">(</span><span class="ident" id="3702116">big</span><span class="op" id="3702119">.</span><span class="ident" id="3702120">Int</span><span class="op" id="3702123">)</span><span class="op" id="3702124">.</span><span class="ident" id="3702125">SetBytes</span><span class="op" id="3702133">(</span><span class="ident" id="3702134">sig</span><span class="op" id="3702137">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3702140">m</span>&nbsp;<span class="op" id="3702142">:=</span>&nbsp;<span class="ident" id="3702145">encrypt</span><span class="op" id="3702152">(</span><span class="builtinfunc" id="3702153">new</span><span class="op" id="3702156">(</span><span class="ident" id="3702157">big</span><span class="op" id="3702160">.</span><span class="ident" id="3702161">Int</span><span class="op" id="3702164">)</span><span class="op" id="3702165">,</span>&nbsp;<span class="ident" id="3702167">pub</span><span class="op" id="3702170">,</span>&nbsp;<span class="ident" id="3702172">c</span><span class="op" id="3702173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3702176">em</span>&nbsp;<span class="op" id="3702179">:=</span>&nbsp;<span class="ident" id="3702182">leftPad</span><span class="op" id="3702189">(</span><span class="ident" id="3702190">m</span><span class="op" id="3702191">.</span><span class="ident" id="3702192">Bytes</span><span class="op" id="3702197">(</span><span class="op" id="3702198">)</span><span class="op" id="3702199">,</span>&nbsp;<span class="ident" id="3702201">k</span><span class="op" id="3702202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3702205">//&nbsp;EM&nbsp;=&nbsp;0x00&nbsp;||&nbsp;0x01&nbsp;||&nbsp;PS&nbsp;||&nbsp;0x00&nbsp;||&nbsp;T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3702247">ok</span>&nbsp;<span class="op" id="3702250">:=</span>&nbsp;<span class="ident" id="3702253">subtle</span><span class="op" id="3702259">.</span><span class="ident" id="3702260">ConstantTimeByteEq</span><span class="op" id="3702278">(</span><span class="ident" id="3702279">em</span><span class="op" id="3702281">[</span><span class="num" id="3702282">0</span><span class="op" id="3702283">]</span><span class="op" id="3702284">,</span>&nbsp;<span class="num" id="3702286">0</span><span class="op" id="3702287">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3702290">ok</span>&nbsp;<span class="op" id="3702293">&amp;=</span>&nbsp;<span class="ident" id="3702296">subtle</span><span class="op" id="3702302">.</span><span class="ident" id="3702303">ConstantTimeByteEq</span><span class="op" id="3702321">(</span><span class="ident" id="3702322">em</span><span class="op" id="3702324">[</span><span class="num" id="3702325">1</span><span class="op" id="3702326">]</span><span class="op" id="3702327">,</span>&nbsp;<span class="num" id="3702329">1</span><span class="op" id="3702330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3702333">ok</span>&nbsp;<span class="op" id="3702336">&amp;=</span>&nbsp;<span class="ident" id="3702339">subtle</span><span class="op" id="3702345">.</span><span class="ident" id="3702346">ConstantTimeCompare</span><span class="op" id="3702365">(</span><span class="ident" id="3702366">em</span><span class="op" id="3702368">[</span><span class="ident" id="3702369">k</span><span class="op" id="3702370">-</span><span class="ident" id="3702371">hashLen</span><span class="op" id="3702378">:</span><span class="ident" id="3702379">k</span><span class="op" id="3702380">]</span><span class="op" id="3702381">,</span>&nbsp;<span class="ident" id="3702383">hashed</span><span class="op" id="3702389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3702392">ok</span>&nbsp;<span class="op" id="3702395">&amp;=</span>&nbsp;<span class="ident" id="3702398">subtle</span><span class="op" id="3702404">.</span><span class="ident" id="3702405">ConstantTimeCompare</span><span class="op" id="3702424">(</span><span class="ident" id="3702425">em</span><span class="op" id="3702427">[</span><span class="ident" id="3702428">k</span><span class="op" id="3702429">-</span><span class="ident" id="3702430">tLen</span><span class="op" id="3702434">:</span><span class="ident" id="3702435">k</span><span class="op" id="3702436">-</span><span class="ident" id="3702437">hashLen</span><span class="op" id="3702444">]</span><span class="op" id="3702445">,</span>&nbsp;<span class="ident" id="3702447">prefix</span><span class="op" id="3702453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3702456">ok</span>&nbsp;<span class="op" id="3702459">&amp;=</span>&nbsp;<span class="ident" id="3702462">subtle</span><span class="op" id="3702468">.</span><span class="ident" id="3702469">ConstantTimeByteEq</span><span class="op" id="3702487">(</span><span class="ident" id="3702488">em</span><span class="op" id="3702490">[</span><span class="ident" id="3702491">k</span><span class="op" id="3702492">-</span><span class="ident" id="3702493">tLen</span><span class="op" id="3702497">-</span><span class="num" id="3702498">1</span><span class="op" id="3702499">]</span><span class="op" id="3702500">,</span>&nbsp;<span class="num" id="3702502">0</span><span class="op" id="3702503">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3702507">for</span>&nbsp;<span class="ident" id="3702511">i</span>&nbsp;<span class="op" id="3702513">:=</span>&nbsp;<span class="num" id="3702516">2</span><span class="op" id="3702517">;</span>&nbsp;<span class="ident" id="3702519">i</span>&nbsp;<span class="op" id="3702521">&lt;</span>&nbsp;<span class="ident" id="3702523">k</span><span class="op" id="3702524">-</span><span class="ident" id="3702525">tLen</span><span class="op" id="3702529">-</span><span class="num" id="3702530">1</span><span class="op" id="3702531">;</span>&nbsp;<span class="ident" id="3702533">i</span><span class="op" id="3702534">++</span>&nbsp;<span class="op" id="3702537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3702541">ok</span>&nbsp;<span class="op" id="3702544">&amp;=</span>&nbsp;<span class="ident" id="3702547">subtle</span><span class="op" id="3702553">.</span><span class="ident" id="3702554">ConstantTimeByteEq</span><span class="op" id="3702572">(</span><span class="ident" id="3702573">em</span><span class="op" id="3702575">[</span><span class="ident" id="3702576">i</span><span class="op" id="3702577">]</span><span class="op" id="3702578">,</span>&nbsp;<span class="num" id="3702580">0xff</span><span class="op" id="3702584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3702587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3702591">if</span>&nbsp;<span class="ident" id="3702594">ok</span>&nbsp;<span class="op" id="3702597">!=</span>&nbsp;<span class="num" id="3702600">1</span>&nbsp;<span class="op" id="3702602">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3702606">return</span>&nbsp;<span class="ident" id="3702613">ErrVerification</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3702630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3702634">return</span>&nbsp;<span class="ident" id="3702641">nil</span><br>
<span class="lineno"></span><span class="op" id="3702645">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="3702648">func</span>&nbsp;<span class="ident" id="3702653">pkcs1v15HashInfo</span><span class="op" id="3702669">(</span><span class="ident" id="3702670">hash</span>&nbsp;<span class="ident" id="3702675">crypto</span><span class="op" id="3702681">.</span><span class="ident" id="3702682">Hash</span><span class="op" id="3702686">,</span>&nbsp;<span class="ident" id="3702688">inLen</span>&nbsp;<span class="builtintype" id="3702694">int</span><span class="op" id="3702697">)</span>&nbsp;<span class="op" id="3702699">(</span><span class="ident" id="3702700">hashLen</span>&nbsp;<span class="builtintype" id="3702708">int</span><span class="op" id="3702711">,</span>&nbsp;<span class="ident" id="3702713">prefix</span>&nbsp;<span class="op" id="3702720">[</span><span class="op" id="3702721">]</span><span class="builtintype" id="3702722">byte</span><span class="op" id="3702726">,</span>&nbsp;<span class="ident" id="3702728">err</span>&nbsp;<span class="builtintype" id="3702732">error</span><span class="op" id="3702737">)</span>&nbsp;<span class="op" id="3702739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3702742">//&nbsp;Special&nbsp;case:&nbsp;crypto.Hash(0)&nbsp;is&nbsp;used&nbsp;to&nbsp;indicate&nbsp;that&nbsp;the&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3702812">//&nbsp;signed&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3702833">if</span>&nbsp;<span class="ident" id="3702836">hash</span>&nbsp;<span class="op" id="3702841">==</span>&nbsp;<span class="num" id="3702844">0</span>&nbsp;<span class="op" id="3702846">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3702850">return</span>&nbsp;<span class="ident" id="3702857">inLen</span><span class="op" id="3702862">,</span>&nbsp;<span class="ident" id="3702864">nil</span><span class="op" id="3702867">,</span>&nbsp;<span class="ident" id="3702869">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3702874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3702878">hashLen</span>&nbsp;<span class="op" id="3702886">=</span>&nbsp;<span class="ident" id="3702888">hash</span><span class="op" id="3702892">.</span><span class="ident" id="3702893">Size</span><span class="op" id="3702897">(</span><span class="op" id="3702898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3702901">if</span>&nbsp;<span class="ident" id="3702904">inLen</span>&nbsp;<span class="op" id="3702910">!=</span>&nbsp;<span class="ident" id="3702913">hashLen</span>&nbsp;<span class="op" id="3702921">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3702925">return</span>&nbsp;<span class="num" id="3702932">0</span><span class="op" id="3702933">,</span>&nbsp;<span class="ident" id="3702935">nil</span><span class="op" id="3702938">,</span>&nbsp;<span class="ident" id="3702940">errors</span><span class="op" id="3702946">.</span><span class="ident" id="3702947">New</span><span class="op" id="3702950">(</span><span class="string" id="3702951">&#34;crypto/rsa:&nbsp;input&nbsp;must&nbsp;be&nbsp;hashed&nbsp;message&#34;</span><span class="op" id="3702993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3702996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3702999">prefix</span><span class="op" id="3703005">,</span>&nbsp;<span class="ident" id="3703007">ok</span>&nbsp;<span class="op" id="3703010">:=</span>&nbsp;<span class="ident" id="3703013">hashPrefixes</span><span class="op" id="3703025">[</span><span class="ident" id="3703026">hash</span><span class="op" id="3703030">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3703033">if</span>&nbsp;<span class="op" id="3703036">!</span><span class="ident" id="3703037">ok</span>&nbsp;<span class="op" id="3703040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3703044">return</span>&nbsp;<span class="num" id="3703051">0</span><span class="op" id="3703052">,</span>&nbsp;<span class="ident" id="3703054">nil</span><span class="op" id="3703057">,</span>&nbsp;<span class="ident" id="3703059">errors</span><span class="op" id="3703065">.</span><span class="ident" id="3703066">New</span><span class="op" id="3703069">(</span><span class="string" id="3703070">&#34;crypto/rsa:&nbsp;unsupported&nbsp;hash&nbsp;function&#34;</span><span class="op" id="3703109">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3703112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3703115">return</span><br>
<span class="lineno"></span><span class="op" id="3703122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3703125">//&nbsp;copyWithLeftPad&nbsp;copies&nbsp;src&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;dest,&nbsp;padding&nbsp;with&nbsp;zero&nbsp;bytes&nbsp;as</span><br>
<span class="lineno">285</span><span class="comment" id="3703202">//&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="3703213">func</span>&nbsp;<span class="ident" id="3703218">copyWithLeftPad</span><span class="op" id="3703233">(</span><span class="ident" id="3703234">dest</span><span class="op" id="3703238">,</span>&nbsp;<span class="ident" id="3703240">src</span>&nbsp;<span class="op" id="3703244">[</span><span class="op" id="3703245">]</span><span class="builtintype" id="3703246">byte</span><span class="op" id="3703250">)</span>&nbsp;<span class="op" id="3703252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3703255">numPaddingBytes</span>&nbsp;<span class="op" id="3703271">:=</span>&nbsp;<span class="builtinfunc" id="3703274">len</span><span class="op" id="3703277">(</span><span class="ident" id="3703278">dest</span><span class="op" id="3703282">)</span>&nbsp;<span class="op" id="3703284">-</span>&nbsp;<span class="builtinfunc" id="3703286">len</span><span class="op" id="3703289">(</span><span class="ident" id="3703290">src</span><span class="op" id="3703293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3703296">for</span>&nbsp;<span class="ident" id="3703300">i</span>&nbsp;<span class="op" id="3703302">:=</span>&nbsp;<span class="num" id="3703305">0</span><span class="op" id="3703306">;</span>&nbsp;<span class="ident" id="3703308">i</span>&nbsp;<span class="op" id="3703310">&lt;</span>&nbsp;<span class="ident" id="3703312">numPaddingBytes</span><span class="op" id="3703327">;</span>&nbsp;<span class="ident" id="3703329">i</span><span class="op" id="3703330">++</span>&nbsp;<span class="op" id="3703333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3703337">dest</span><span class="op" id="3703341">[</span><span class="ident" id="3703342">i</span><span class="op" id="3703343">]</span>&nbsp;<span class="op" id="3703345">=</span>&nbsp;<span class="num" id="3703347">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3703350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3703353">copy</span><span class="op" id="3703357">(</span><span class="ident" id="3703358">dest</span><span class="op" id="3703362">[</span><span class="ident" id="3703363">numPaddingBytes</span><span class="op" id="3703378">:</span><span class="op" id="3703379">]</span><span class="op" id="3703380">,</span>&nbsp;<span class="ident" id="3703382">src</span><span class="op" id="3703385">)</span><br>
<span class="lineno"></span><span class="op" id="3703387">}</span>
</div>
</body>
</html>
