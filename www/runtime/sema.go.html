<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1931553">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1931608">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1931662">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1931713">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1931756">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1931802">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="1931854">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="1931894">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="1931945">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="1931983">//</span><br>
<span class="lineno"></span><span class="comment" id="1931986">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="1932034">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1932090">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="1932147">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="1932210">//</span><br>
<span class="lineno"></span><span class="comment" id="1932213">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="1932265">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1932300">package</span>&nbsp;<span class="ident" id="1932308">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1932317">import</span>&nbsp;<span class="string" id="1932324">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1932334">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1932377">type</span>&nbsp;<span class="ident" id="1932382">semaRoot</span>&nbsp;<span class="keyword" id="1932391">struct</span>&nbsp;<span class="op" id="1932398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932401">lock</span>&nbsp;&nbsp;<span class="ident" id="1932407"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016175">mutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932414">head</span>&nbsp;&nbsp;<span class="op" id="1932420">*</span><span class="ident" id="1932421"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016716">sudog</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932428">tail</span>&nbsp;&nbsp;<span class="op" id="1932434">*</span><span class="ident" id="1932435"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016716">sudog</a></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932442">nwait</span>&nbsp;<span class="builtintype" id="1932448">uint32</span>&nbsp;<span class="comment" id="1932455">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="1932496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1932499">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="1932549">const</span>&nbsp;<span class="ident" id="1932555">semTabSize</span>&nbsp;<span class="op" id="1932566">=</span>&nbsp;<span class="num" id="1932568">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1932573">var</span>&nbsp;<span class="ident" id="1932577">semtable</span>&nbsp;<span class="op" id="1932586">[</span><span class="ident" id="1932587"><a href="/runtime/sema.go.html#1932555">semTabSize</a></span><span class="op" id="1932597">]</span><span class="keyword" id="1932598">struct</span>&nbsp;<span class="op" id="1932605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932608">root</span>&nbsp;<span class="ident" id="1932613"><a href="/runtime/sema.go.html#1932382">semaRoot</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932623">pad</span>&nbsp;&nbsp;<span class="op" id="1932628">[</span><span class="ident" id="1932629"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2021701">_CacheLineSize</a></span>&nbsp;<span class="op" id="1932644">-</span>&nbsp;<span class="ident" id="1932646"><a href="/runtime/sema.go.html#1932324">unsafe</a></span><span class="op" id="1932652">.</span><span class="ident" id="1932653">Sizeof</span><span class="op" id="1932659">(</span><span class="ident" id="1932660"><a href="/runtime/sema.go.html#1932382">semaRoot</a></span><span class="op" id="1932668">{</span><span class="op" id="1932669">}</span><span class="op" id="1932670">)</span><span class="op" id="1932671">]</span><span class="builtintype" id="1932672">byte</span><br>
<span class="lineno"></span><span class="op" id="1932677">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1932680">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="1932714">func</span>&nbsp;<span class="ident" id="1932719">asyncsemacquire</span><span class="op" id="1932734">(</span><span class="ident" id="1932735">addr</span>&nbsp;<span class="op" id="1932740">*</span><span class="builtintype" id="1932741">uint32</span><span class="op" id="1932747">)</span>&nbsp;<span class="op" id="1932749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932752"><a href="/runtime/sema.go.html#1932865">semacquire</a></span><span class="op" id="1932762">(</span><span class="ident" id="1932763"><a href="/runtime/sema.go.html#1932735">addr</a></span><span class="op" id="1932767">,</span>&nbsp;<span class="ident" id="1932769">true</span><span class="op" id="1932773">)</span><br>
<span class="lineno"></span><span class="op" id="1932775">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="1932778">func</span>&nbsp;<span class="ident" id="1932783">asyncsemrelease</span><span class="op" id="1932798">(</span><span class="ident" id="1932799">addr</span>&nbsp;<span class="op" id="1932804">*</span><span class="builtintype" id="1932805">uint32</span><span class="op" id="1932811">)</span>&nbsp;<span class="op" id="1932813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932816"><a href="/runtime/sema.go.html#1933949">semrelease</a></span><span class="op" id="1932826">(</span><span class="ident" id="1932827"><a href="/runtime/sema.go.html#1932799">addr</a></span><span class="op" id="1932831">)</span><br>
<span class="lineno"></span><span class="op" id="1932833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="1932836">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1932860">func</span>&nbsp;<span class="ident" id="1932865">semacquire</span><span class="op" id="1932875">(</span><span class="ident" id="1932876">addr</span>&nbsp;<span class="op" id="1932881">*</span><span class="builtintype" id="1932882">uint32</span><span class="op" id="1932888">,</span>&nbsp;<span class="ident" id="1932890">profile</span>&nbsp;<span class="builtintype" id="1932898">bool</span><span class="op" id="1932902">)</span>&nbsp;<span class="op" id="1932904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932907">gp</span>&nbsp;<span class="op" id="1932910">:=</span>&nbsp;<span class="ident" id="1932913"><a href="/runtime/stubs.go.html#1968886">getg</a></span><span class="op" id="1932917">(</span><span class="op" id="1932918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1932921">if</span>&nbsp;<span class="ident" id="1932924"><a href="/runtime/sema.go.html#1932907">gp</a></span>&nbsp;<span class="op" id="1932927">!=</span>&nbsp;<span class="ident" id="1932930"><a href="/runtime/sema.go.html#1932907">gp</a></span><span class="op" id="1932932">.</span><span class="ident" id="1932933">m</span><span class="op" id="1932934">.</span><span class="ident" id="1932935">curg</span>&nbsp;<span class="op" id="1932940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1932944"><a href="/runtime/panic.go.html#1894294">gothrow</a></span><span class="op" id="1932951">(</span><span class="string" id="1932952">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="1932983">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1932986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1932990">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1933005">if</span>&nbsp;<span class="ident" id="1933008"><a href="/runtime/sema.go.html#1934804">cansemacquire</a></span><span class="op" id="1933021">(</span><span class="ident" id="1933022"><a href="/runtime/sema.go.html#1932876">addr</a></span><span class="op" id="1933026">)</span>&nbsp;<span class="op" id="1933028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1933032">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1933040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933044">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933061">//&nbsp;&nbsp;&nbsp;&nbspincrement&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933088">//&nbsp;&nbsp;&nbsp;&nbsptry&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933145">//&nbsp;&nbsp;&nbsp;&nbspenqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933176">//&nbsp;&nbsp;&nbsp;&nbspsleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933186">//&nbsp;&nbsp;&nbsp;&nbsp(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933234">s</span>&nbsp;<span class="op" id="1933236">:=</span>&nbsp;<span class="ident" id="1933239"><a href="/runtime/proc.go.html#1904005">acquireSudog</a></span><span class="op" id="1933251">(</span><span class="op" id="1933252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933255">root</span>&nbsp;<span class="op" id="1933260">:=</span>&nbsp;<span class="ident" id="1933263"><a href="/runtime/sema.go.html#1934692">semroot</a></span><span class="op" id="1933270">(</span><span class="ident" id="1933271"><a href="/runtime/sema.go.html#1932876">addr</a></span><span class="op" id="1933275">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933278">t0</span>&nbsp;<span class="op" id="1933281">:=</span>&nbsp;<span class="ident" id="1933284">int64</span><span class="op" id="1933289">(</span><span class="num" id="1933290">0</span><span class="op" id="1933291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933294"><a href="/runtime/sema.go.html#1933234">s</a></span><span class="op" id="1933295">.</span><span class="ident" id="1933296">releasetime</span>&nbsp;<span class="op" id="1933308">=</span>&nbsp;<span class="num" id="1933310">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1933313">if</span>&nbsp;<span class="ident" id="1933316"><a href="/runtime/sema.go.html#1932890">profile</a></span>&nbsp;<span class="op" id="1933324">&amp;&amp;</span>&nbsp;<span class="ident" id="1933327"><a href="/runtime/mprof.go.html#1856178">blockprofilerate</a></span>&nbsp;<span class="op" id="1933344">&gt;</span>&nbsp;<span class="num" id="1933346">0</span>&nbsp;<span class="op" id="1933348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933352"><a href="/runtime/sema.go.html#1933278">t0</a></span>&nbsp;<span class="op" id="1933355">=</span>&nbsp;<span class="ident" id="1933357"><a href="/runtime/stubs.go.html#1974111">cputicks</a></span><span class="op" id="1933365">(</span><span class="op" id="1933366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933370"><a href="/runtime/sema.go.html#1933234">s</a></span><span class="op" id="1933371">.</span><span class="ident" id="1933372">releasetime</span>&nbsp;<span class="op" id="1933384">=</span>&nbsp;<span class="op" id="1933386">-</span><span class="num" id="1933387">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1933390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1933393">for</span>&nbsp;<span class="op" id="1933397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933401"><a href="/runtime/lock_futex.go.html#1815304">lock</a></span><span class="op" id="1933405">(</span><span class="op" id="1933406">&amp;</span><span class="ident" id="1933407"><a href="/runtime/sema.go.html#1933255">root</a></span><span class="op" id="1933411">.</span><span class="ident" id="1933412">lock</span><span class="op" id="1933416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933420">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933486"><a href="/runtime/atomic.go.html#1710915">xadd</a></span><span class="op" id="1933490">(</span><span class="op" id="1933491">&amp;</span><span class="ident" id="1933492"><a href="/runtime/sema.go.html#1933255">root</a></span><span class="op" id="1933496">.</span><span class="ident" id="1933497">nwait</span><span class="op" id="1933502">,</span>&nbsp;<span class="num" id="1933504">1</span><span class="op" id="1933505">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933509">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1933558">if</span>&nbsp;<span class="ident" id="1933561"><a href="/runtime/sema.go.html#1934804">cansemacquire</a></span><span class="op" id="1933574">(</span><span class="ident" id="1933575"><a href="/runtime/sema.go.html#1932876">addr</a></span><span class="op" id="1933579">)</span>&nbsp;<span class="op" id="1933581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933586"><a href="/runtime/atomic.go.html#1710915">xadd</a></span><span class="op" id="1933590">(</span><span class="op" id="1933591">&amp;</span><span class="ident" id="1933592"><a href="/runtime/sema.go.html#1933255">root</a></span><span class="op" id="1933596">.</span><span class="ident" id="1933597">nwait</span><span class="op" id="1933602">,</span>&nbsp;<span class="op" id="1933604">-</span><span class="num" id="1933605">1</span><span class="op" id="1933606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933611"><a href="/runtime/lock_futex.go.html#1816596">unlock</a></span><span class="op" id="1933617">(</span><span class="op" id="1933618">&amp;</span><span class="ident" id="1933619"><a href="/runtime/sema.go.html#1933255">root</a></span><span class="op" id="1933623">.</span><span class="ident" id="1933624">lock</span><span class="op" id="1933628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1933633">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1933641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933645">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1933709">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933752"><a href="/runtime/sema.go.html#1933255">root</a></span><span class="op" id="1933756">.</span><span class="ident" id="1933757">queue</span><span class="op" id="1933762">(</span><span class="ident" id="1933763"><a href="/runtime/sema.go.html#1932876">addr</a></span><span class="op" id="1933767">,</span>&nbsp;<span class="ident" id="1933769"><a href="/runtime/sema.go.html#1933234">s</a></span><span class="op" id="1933770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933774"><a href="/runtime/proc.go.html#1903766">goparkunlock</a></span><span class="op" id="1933786">(</span><span class="op" id="1933787">&amp;</span><span class="ident" id="1933788"><a href="/runtime/sema.go.html#1933255">root</a></span><span class="op" id="1933792">.</span><span class="ident" id="1933793">lock</span><span class="op" id="1933797">,</span>&nbsp;<span class="string" id="1933799">&#34;semacquire&#34;</span><span class="op" id="1933811">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1933815">if</span>&nbsp;<span class="ident" id="1933818"><a href="/runtime/sema.go.html#1934804">cansemacquire</a></span><span class="op" id="1933831">(</span><span class="ident" id="1933832"><a href="/runtime/sema.go.html#1932876">addr</a></span><span class="op" id="1933836">)</span>&nbsp;<span class="op" id="1933838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1933843">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1933851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1933854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1933857">if</span>&nbsp;<span class="ident" id="1933860"><a href="/runtime/sema.go.html#1933234">s</a></span><span class="op" id="1933861">.</span><span class="ident" id="1933862">releasetime</span>&nbsp;<span class="op" id="1933874">&gt;</span>&nbsp;<span class="num" id="1933876">0</span>&nbsp;<span class="op" id="1933878">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933882"><a href="/runtime/mprof.go.html#1856961">blockevent</a></span><span class="op" id="1933892">(</span><span class="ident" id="1933893">int64</span><span class="op" id="1933898">(</span><span class="ident" id="1933899"><a href="/runtime/sema.go.html#1933234">s</a></span><span class="op" id="1933900">.</span><span class="ident" id="1933901">releasetime</span><span class="op" id="1933912">)</span><span class="op" id="1933913">-</span><span class="ident" id="1933914"><a href="/runtime/sema.go.html#1933278">t0</a></span><span class="op" id="1933916">,</span>&nbsp;<span class="num" id="1933918">3</span><span class="op" id="1933919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1933922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933925"><a href="/runtime/proc.go.html#1904735">releaseSudog</a></span><span class="op" id="1933937">(</span><span class="ident" id="1933938"><a href="/runtime/sema.go.html#1933234">s</a></span><span class="op" id="1933939">)</span><br>
<span class="lineno"></span><span class="op" id="1933941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="1933944">func</span>&nbsp;<span class="ident" id="1933949">semrelease</span><span class="op" id="1933959">(</span><span class="ident" id="1933960">addr</span>&nbsp;<span class="op" id="1933965">*</span><span class="builtintype" id="1933966">uint32</span><span class="op" id="1933972">)</span>&nbsp;<span class="op" id="1933974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1933977">root</span>&nbsp;<span class="op" id="1933982">:=</span>&nbsp;<span class="ident" id="1933985"><a href="/runtime/sema.go.html#1934692">semroot</a></span><span class="op" id="1933992">(</span><span class="ident" id="1933993"><a href="/runtime/sema.go.html#1933960">addr</a></span><span class="op" id="1933997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934000"><a href="/runtime/atomic.go.html#1710915">xadd</a></span><span class="op" id="1934004">(</span><span class="ident" id="1934005"><a href="/runtime/sema.go.html#1933960">addr</a></span><span class="op" id="1934009">,</span>&nbsp;<span class="num" id="1934011">1</span><span class="op" id="1934012">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934016">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934043">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934111">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934141">if</span>&nbsp;<span class="ident" id="1934144"><a href="/runtime/atomic.go.html#1711297">atomicload</a></span><span class="op" id="1934154">(</span><span class="op" id="1934155">&amp;</span><span class="ident" id="1934156"><a href="/runtime/sema.go.html#1933977">root</a></span><span class="op" id="1934160">.</span><span class="ident" id="1934161">nwait</span><span class="op" id="1934166">)</span>&nbsp;<span class="op" id="1934168">==</span>&nbsp;<span class="num" id="1934171">0</span>&nbsp;<span class="op" id="1934173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934177">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934185">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934189">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934239"><a href="/runtime/lock_futex.go.html#1815304">lock</a></span><span class="op" id="1934243">(</span><span class="op" id="1934244">&amp;</span><span class="ident" id="1934245"><a href="/runtime/sema.go.html#1933977">root</a></span><span class="op" id="1934249">.</span><span class="ident" id="1934250">lock</span><span class="op" id="1934254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934257">if</span>&nbsp;<span class="ident" id="1934260"><a href="/runtime/atomic.go.html#1711297">atomicload</a></span><span class="op" id="1934270">(</span><span class="op" id="1934271">&amp;</span><span class="ident" id="1934272"><a href="/runtime/sema.go.html#1933977">root</a></span><span class="op" id="1934276">.</span><span class="ident" id="1934277">nwait</span><span class="op" id="1934282">)</span>&nbsp;<span class="op" id="1934284">==</span>&nbsp;<span class="num" id="1934287">0</span>&nbsp;<span class="op" id="1934289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934293">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1934350">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934396"><a href="/runtime/lock_futex.go.html#1816596">unlock</a></span><span class="op" id="1934402">(</span><span class="op" id="1934403">&amp;</span><span class="ident" id="1934404"><a href="/runtime/sema.go.html#1933977">root</a></span><span class="op" id="1934408">.</span><span class="ident" id="1934409">lock</span><span class="op" id="1934413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934417">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934428">s</span>&nbsp;<span class="op" id="1934430">:=</span>&nbsp;<span class="ident" id="1934433"><a href="/runtime/sema.go.html#1933977">root</a></span><span class="op" id="1934437">.</span><span class="ident" id="1934438">head</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934444">for</span>&nbsp;<span class="op" id="1934448">;</span>&nbsp;<span class="ident" id="1934450"><a href="/runtime/sema.go.html#1934428">s</a></span>&nbsp;<span class="op" id="1934452">!=</span>&nbsp;<span class="ident" id="1934455">nil</span><span class="op" id="1934458">;</span>&nbsp;<span class="ident" id="1934460"><a href="/runtime/sema.go.html#1934428">s</a></span>&nbsp;<span class="op" id="1934462">=</span>&nbsp;<span class="ident" id="1934464"><a href="/runtime/sema.go.html#1934428">s</a></span><span class="op" id="1934465">.</span><span class="ident" id="1934466">next</span>&nbsp;<span class="op" id="1934471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934475">if</span>&nbsp;<span class="ident" id="1934478"><a href="/runtime/sema.go.html#1934428">s</a></span><span class="op" id="1934479">.</span><span class="ident" id="1934480">elem</span>&nbsp;<span class="op" id="1934485">==</span>&nbsp;<span class="ident" id="1934488"><a href="/runtime/sema.go.html#1932324">unsafe</a></span><span class="op" id="1934494">.</span><span class="ident" id="1934495">Pointer</span><span class="op" id="1934502">(</span><span class="ident" id="1934503"><a href="/runtime/sema.go.html#1933960">addr</a></span><span class="op" id="1934507">)</span>&nbsp;<span class="op" id="1934509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934514"><a href="/runtime/atomic.go.html#1710915">xadd</a></span><span class="op" id="1934518">(</span><span class="op" id="1934519">&amp;</span><span class="ident" id="1934520"><a href="/runtime/sema.go.html#1933977">root</a></span><span class="op" id="1934524">.</span><span class="ident" id="1934525">nwait</span><span class="op" id="1934530">,</span>&nbsp;<span class="op" id="1934532">-</span><span class="num" id="1934533">1</span><span class="op" id="1934534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934539"><a href="/runtime/sema.go.html#1933977">root</a></span><span class="op" id="1934543">.</span><span class="ident" id="1934544">dequeue</span><span class="op" id="1934551">(</span><span class="ident" id="1934552"><a href="/runtime/sema.go.html#1934428">s</a></span><span class="op" id="1934553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934558">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934572"><a href="/runtime/lock_futex.go.html#1816596">unlock</a></span><span class="op" id="1934578">(</span><span class="op" id="1934579">&amp;</span><span class="ident" id="1934580"><a href="/runtime/sema.go.html#1933977">root</a></span><span class="op" id="1934584">.</span><span class="ident" id="1934585">lock</span><span class="op" id="1934589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934592">if</span>&nbsp;<span class="ident" id="1934595"><a href="/runtime/sema.go.html#1934428">s</a></span>&nbsp;<span class="op" id="1934597">!=</span>&nbsp;<span class="ident" id="1934600">nil</span>&nbsp;<span class="op" id="1934604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934608">if</span>&nbsp;<span class="ident" id="1934611"><a href="/runtime/sema.go.html#1934428">s</a></span><span class="op" id="1934612">.</span><span class="ident" id="1934613">releasetime</span>&nbsp;<span class="op" id="1934625">!=</span>&nbsp;<span class="num" id="1934628">0</span>&nbsp;<span class="op" id="1934630">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934635"><a href="/runtime/sema.go.html#1934428">s</a></span><span class="op" id="1934636">.</span><span class="ident" id="1934637">releasetime</span>&nbsp;<span class="op" id="1934649">=</span>&nbsp;<span class="ident" id="1934651"><a href="/runtime/stubs.go.html#1974111">cputicks</a></span><span class="op" id="1934659">(</span><span class="op" id="1934660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934668"><a href="/runtime/proc.go.html#1903886">goready</a></span><span class="op" id="1934675">(</span><span class="ident" id="1934676"><a href="/runtime/sema.go.html#1934428">s</a></span><span class="op" id="1934677">.</span><span class="ident" id="1934678">g</span><span class="op" id="1934679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934682">}</span><br>
<span class="lineno"></span><span class="op" id="1934684">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="1934687">func</span>&nbsp;<span class="ident" id="1934692">semroot</span><span class="op" id="1934699">(</span><span class="ident" id="1934700">addr</span>&nbsp;<span class="op" id="1934705">*</span><span class="builtintype" id="1934706">uint32</span><span class="op" id="1934712">)</span>&nbsp;<span class="op" id="1934714">*</span><span class="ident" id="1934715"><a href="/runtime/sema.go.html#1932382">semaRoot</a></span>&nbsp;<span class="op" id="1934724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934727">return</span>&nbsp;<span class="op" id="1934734">&amp;</span><span class="ident" id="1934735"><a href="/runtime/sema.go.html#1932577">semtable</a></span><span class="op" id="1934743">[</span><span class="op" id="1934744">(</span><span class="builtintype" id="1934745">uintptr</span><span class="op" id="1934752">(</span><span class="ident" id="1934753"><a href="/runtime/sema.go.html#1932324">unsafe</a></span><span class="op" id="1934759">.</span><span class="ident" id="1934760">Pointer</span><span class="op" id="1934767">(</span><span class="ident" id="1934768"><a href="/runtime/sema.go.html#1934700">addr</a></span><span class="op" id="1934772">)</span><span class="op" id="1934773">)</span><span class="op" id="1934774">&gt;&gt;</span><span class="num" id="1934776">3</span><span class="op" id="1934777">)</span><span class="op" id="1934778">%</span><span class="ident" id="1934779"><a href="/runtime/sema.go.html#1932555">semTabSize</a></span><span class="op" id="1934789">]</span><span class="op" id="1934790">.</span><span class="ident" id="1934791">root</span><br>
<span class="lineno"></span><span class="op" id="1934796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="1934799">func</span>&nbsp;<span class="ident" id="1934804">cansemacquire</span><span class="op" id="1934817">(</span><span class="ident" id="1934818">addr</span>&nbsp;<span class="op" id="1934823">*</span><span class="builtintype" id="1934824">uint32</span><span class="op" id="1934830">)</span>&nbsp;<span class="builtintype" id="1934832">bool</span>&nbsp;<span class="op" id="1934837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934840">for</span>&nbsp;<span class="op" id="1934844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1934848">v</span>&nbsp;<span class="op" id="1934850">:=</span>&nbsp;<span class="ident" id="1934853"><a href="/runtime/atomic.go.html#1711297">atomicload</a></span><span class="op" id="1934863">(</span><span class="ident" id="1934864"><a href="/runtime/sema.go.html#1934818">addr</a></span><span class="op" id="1934868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934872">if</span>&nbsp;<span class="ident" id="1934875"><a href="/runtime/sema.go.html#1934848">v</a></span>&nbsp;<span class="op" id="1934877">==</span>&nbsp;<span class="num" id="1934880">0</span>&nbsp;<span class="op" id="1934882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934887">return</span>&nbsp;<span class="ident" id="1934894">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934906">if</span>&nbsp;<span class="ident" id="1934909"><a href="/runtime/stubs.go.html#1974711">cas</a></span><span class="op" id="1934912">(</span><span class="ident" id="1934913"><a href="/runtime/sema.go.html#1934818">addr</a></span><span class="op" id="1934917">,</span>&nbsp;<span class="ident" id="1934919"><a href="/runtime/sema.go.html#1934848">v</a></span><span class="op" id="1934920">,</span>&nbsp;<span class="ident" id="1934922"><a href="/runtime/sema.go.html#1934848">v</a></span><span class="op" id="1934923">-</span><span class="num" id="1934924">1</span><span class="op" id="1934925">)</span>&nbsp;<span class="op" id="1934927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1934932">return</span>&nbsp;<span class="ident" id="1934939">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1934949">}</span><br>
<span class="lineno">150</span><span class="op" id="1934951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1934954">func</span>&nbsp;<span class="op" id="1934959">(</span><span class="ident" id="1934960">root</span>&nbsp;<span class="op" id="1934965">*</span><span class="ident" id="1934966"><a href="/runtime/sema.go.html#1932382">semaRoot</a></span><span class="op" id="1934974">)</span>&nbsp;<span class="ident" id="1934976">queue</span><span class="op" id="1934981">(</span><span class="ident" id="1934982">addr</span>&nbsp;<span class="op" id="1934987">*</span><span class="builtintype" id="1934988">uint32</span><span class="op" id="1934994">,</span>&nbsp;<span class="ident" id="1934996">s</span>&nbsp;<span class="op" id="1934998">*</span><span class="ident" id="1934999"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016716">sudog</a></span><span class="op" id="1935004">)</span>&nbsp;<span class="op" id="1935006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935009"><a href="/runtime/sema.go.html#1934996">s</a></span><span class="op" id="1935010">.</span><span class="ident" id="1935011">g</span>&nbsp;<span class="op" id="1935013">=</span>&nbsp;<span class="ident" id="1935015"><a href="/runtime/stubs.go.html#1968886">getg</a></span><span class="op" id="1935019">(</span><span class="op" id="1935020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935023"><a href="/runtime/sema.go.html#1934996">s</a></span><span class="op" id="1935024">.</span><span class="ident" id="1935025">elem</span>&nbsp;<span class="op" id="1935030">=</span>&nbsp;<span class="ident" id="1935032"><a href="/runtime/sema.go.html#1932324">unsafe</a></span><span class="op" id="1935038">.</span><span class="ident" id="1935039">Pointer</span><span class="op" id="1935046">(</span><span class="ident" id="1935047"><a href="/runtime/sema.go.html#1934982">addr</a></span><span class="op" id="1935051">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935054"><a href="/runtime/sema.go.html#1934996">s</a></span><span class="op" id="1935055">.</span><span class="ident" id="1935056">next</span>&nbsp;<span class="op" id="1935061">=</span>&nbsp;<span class="ident" id="1935063">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935068"><a href="/runtime/sema.go.html#1934996">s</a></span><span class="op" id="1935069">.</span><span class="ident" id="1935070">prev</span>&nbsp;<span class="op" id="1935075">=</span>&nbsp;<span class="ident" id="1935077"><a href="/runtime/sema.go.html#1934960">root</a></span><span class="op" id="1935081">.</span><span class="ident" id="1935082">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1935088">if</span>&nbsp;<span class="ident" id="1935091"><a href="/runtime/sema.go.html#1934960">root</a></span><span class="op" id="1935095">.</span><span class="ident" id="1935096">tail</span>&nbsp;<span class="op" id="1935101">!=</span>&nbsp;<span class="ident" id="1935104">nil</span>&nbsp;<span class="op" id="1935108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935112"><a href="/runtime/sema.go.html#1934960">root</a></span><span class="op" id="1935116">.</span><span class="ident" id="1935117">tail</span><span class="op" id="1935121">.</span><span class="ident" id="1935122">next</span>&nbsp;<span class="op" id="1935127">=</span>&nbsp;<span class="ident" id="1935129"><a href="/runtime/sema.go.html#1934996">s</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1935132">}</span>&nbsp;<span class="keyword" id="1935134">else</span>&nbsp;<span class="op" id="1935139">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935143"><a href="/runtime/sema.go.html#1934960">root</a></span><span class="op" id="1935147">.</span><span class="ident" id="1935148">head</span>&nbsp;<span class="op" id="1935153">=</span>&nbsp;<span class="ident" id="1935155"><a href="/runtime/sema.go.html#1934996">s</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1935158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935161"><a href="/runtime/sema.go.html#1934960">root</a></span><span class="op" id="1935165">.</span><span class="ident" id="1935166">tail</span>&nbsp;<span class="op" id="1935171">=</span>&nbsp;<span class="ident" id="1935173"><a href="/runtime/sema.go.html#1934996">s</a></span><br>
<span class="lineno"></span><span class="op" id="1935175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="1935178">func</span>&nbsp;<span class="op" id="1935183">(</span><span class="ident" id="1935184">root</span>&nbsp;<span class="op" id="1935189">*</span><span class="ident" id="1935190"><a href="/runtime/sema.go.html#1932382">semaRoot</a></span><span class="op" id="1935198">)</span>&nbsp;<span class="ident" id="1935200">dequeue</span><span class="op" id="1935207">(</span><span class="ident" id="1935208">s</span>&nbsp;<span class="op" id="1935210">*</span><span class="ident" id="1935211"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016716">sudog</a></span><span class="op" id="1935216">)</span>&nbsp;<span class="op" id="1935218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1935221">if</span>&nbsp;<span class="ident" id="1935224"><a href="/runtime/sema.go.html#1935208">s</a></span><span class="op" id="1935225">.</span><span class="ident" id="1935226">next</span>&nbsp;<span class="op" id="1935231">!=</span>&nbsp;<span class="ident" id="1935234">nil</span>&nbsp;<span class="op" id="1935238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935242"><a href="/runtime/sema.go.html#1935208">s</a></span><span class="op" id="1935243">.</span><span class="ident" id="1935244">next</span><span class="op" id="1935248">.</span><span class="ident" id="1935249">prev</span>&nbsp;<span class="op" id="1935254">=</span>&nbsp;<span class="ident" id="1935256"><a href="/runtime/sema.go.html#1935208">s</a></span><span class="op" id="1935257">.</span><span class="ident" id="1935258">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1935264">}</span>&nbsp;<span class="keyword" id="1935266">else</span>&nbsp;<span class="op" id="1935271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935275"><a href="/runtime/sema.go.html#1935184">root</a></span><span class="op" id="1935279">.</span><span class="ident" id="1935280">tail</span>&nbsp;<span class="op" id="1935285">=</span>&nbsp;<span class="ident" id="1935287"><a href="/runtime/sema.go.html#1935208">s</a></span><span class="op" id="1935288">.</span><span class="ident" id="1935289">prev</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1935295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1935298">if</span>&nbsp;<span class="ident" id="1935301"><a href="/runtime/sema.go.html#1935208">s</a></span><span class="op" id="1935302">.</span><span class="ident" id="1935303">prev</span>&nbsp;<span class="op" id="1935308">!=</span>&nbsp;<span class="ident" id="1935311">nil</span>&nbsp;<span class="op" id="1935315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935319"><a href="/runtime/sema.go.html#1935208">s</a></span><span class="op" id="1935320">.</span><span class="ident" id="1935321">prev</span><span class="op" id="1935325">.</span><span class="ident" id="1935326">next</span>&nbsp;<span class="op" id="1935331">=</span>&nbsp;<span class="ident" id="1935333"><a href="/runtime/sema.go.html#1935208">s</a></span><span class="op" id="1935334">.</span><span class="ident" id="1935335">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1935341">}</span>&nbsp;<span class="keyword" id="1935343">else</span>&nbsp;<span class="op" id="1935348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935352"><a href="/runtime/sema.go.html#1935184">root</a></span><span class="op" id="1935356">.</span><span class="ident" id="1935357">head</span>&nbsp;<span class="op" id="1935362">=</span>&nbsp;<span class="ident" id="1935364"><a href="/runtime/sema.go.html#1935208">s</a></span><span class="op" id="1935365">.</span><span class="ident" id="1935366">next</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1935372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935375"><a href="/runtime/sema.go.html#1935208">s</a></span><span class="op" id="1935376">.</span><span class="ident" id="1935377">elem</span>&nbsp;<span class="op" id="1935382">=</span>&nbsp;<span class="ident" id="1935384">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935389"><a href="/runtime/sema.go.html#1935208">s</a></span><span class="op" id="1935390">.</span><span class="ident" id="1935391">next</span>&nbsp;<span class="op" id="1935396">=</span>&nbsp;<span class="ident" id="1935398">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935403"><a href="/runtime/sema.go.html#1935208">s</a></span><span class="op" id="1935404">.</span><span class="ident" id="1935405">prev</span>&nbsp;<span class="op" id="1935410">=</span>&nbsp;<span class="ident" id="1935412">nil</span><br>
<span class="lineno"></span><span class="op" id="1935416">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="1935419">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="1935459">type</span>&nbsp;<span class="ident" id="1935464">syncSema</span>&nbsp;<span class="keyword" id="1935473">struct</span>&nbsp;<span class="op" id="1935480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935483">lock</span>&nbsp;<span class="ident" id="1935488"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016175">mutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935495">head</span>&nbsp;<span class="op" id="1935500">*</span><span class="ident" id="1935501"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016716">sudog</a></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935508">tail</span>&nbsp;<span class="op" id="1935513">*</span><span class="ident" id="1935514"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016716">sudog</a></span><br>
<span class="lineno"></span><span class="op" id="1935520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1935523">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1935601">func</span>&nbsp;<span class="ident" id="1935606">syncsemacquire</span><span class="op" id="1935620">(</span><span class="ident" id="1935621">s</span>&nbsp;<span class="op" id="1935623">*</span><span class="ident" id="1935624"><a href="/runtime/sema.go.html#1935464">syncSema</a></span><span class="op" id="1935632">)</span>&nbsp;<span class="op" id="1935634">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935637"><a href="/runtime/lock_futex.go.html#1815304">lock</a></span><span class="op" id="1935641">(</span><span class="op" id="1935642">&amp;</span><span class="ident" id="1935643"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1935644">.</span><span class="ident" id="1935645">lock</span><span class="op" id="1935649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1935652">if</span>&nbsp;<span class="ident" id="1935655"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1935656">.</span><span class="ident" id="1935657">head</span>&nbsp;<span class="op" id="1935662">!=</span>&nbsp;<span class="ident" id="1935665">nil</span>&nbsp;<span class="op" id="1935669">&amp;&amp;</span>&nbsp;<span class="ident" id="1935672"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1935673">.</span><span class="ident" id="1935674">head</span><span class="op" id="1935678">.</span><span class="ident" id="1935679">nrelease</span>&nbsp;<span class="op" id="1935688">&gt;</span>&nbsp;<span class="num" id="1935690">0</span>&nbsp;<span class="op" id="1935692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1935696">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1935735">var</span>&nbsp;<span class="ident" id="1935739">wake</span>&nbsp;<span class="op" id="1935744">*</span><span class="ident" id="1935745"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016716">sudog</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935753"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1935754">.</span><span class="ident" id="1935755">head</span><span class="op" id="1935759">.</span><span class="ident" id="1935760">nrelease</span><span class="op" id="1935768">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1935773">if</span>&nbsp;<span class="ident" id="1935776"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1935777">.</span><span class="ident" id="1935778">head</span><span class="op" id="1935782">.</span><span class="ident" id="1935783">nrelease</span>&nbsp;<span class="op" id="1935792">==</span>&nbsp;<span class="num" id="1935795">0</span>&nbsp;<span class="op" id="1935797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935802"><a href="/runtime/sema.go.html#1935739">wake</a></span>&nbsp;<span class="op" id="1935807">=</span>&nbsp;<span class="ident" id="1935809"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1935810">.</span><span class="ident" id="1935811">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935819"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1935820">.</span><span class="ident" id="1935821">head</span>&nbsp;<span class="op" id="1935826">=</span>&nbsp;<span class="ident" id="1935828"><a href="/runtime/sema.go.html#1935739">wake</a></span><span class="op" id="1935832">.</span><span class="ident" id="1935833">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1935841">if</span>&nbsp;<span class="ident" id="1935844"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1935845">.</span><span class="ident" id="1935846">head</span>&nbsp;<span class="op" id="1935851">==</span>&nbsp;<span class="ident" id="1935854">nil</span>&nbsp;<span class="op" id="1935858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935864"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1935865">.</span><span class="ident" id="1935866">tail</span>&nbsp;<span class="op" id="1935871">=</span>&nbsp;<span class="ident" id="1935873">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1935880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1935884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935888"><a href="/runtime/lock_futex.go.html#1816596">unlock</a></span><span class="op" id="1935894">(</span><span class="op" id="1935895">&amp;</span><span class="ident" id="1935896"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1935897">.</span><span class="ident" id="1935898">lock</span><span class="op" id="1935902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1935906">if</span>&nbsp;<span class="ident" id="1935909"><a href="/runtime/sema.go.html#1935739">wake</a></span>&nbsp;<span class="op" id="1935914">!=</span>&nbsp;<span class="ident" id="1935917">nil</span>&nbsp;<span class="op" id="1935921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935926"><a href="/runtime/sema.go.html#1935739">wake</a></span><span class="op" id="1935930">.</span><span class="ident" id="1935931">next</span>&nbsp;<span class="op" id="1935936">=</span>&nbsp;<span class="ident" id="1935938">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935945"><a href="/runtime/proc.go.html#1903886">goready</a></span><span class="op" id="1935952">(</span><span class="ident" id="1935953"><a href="/runtime/sema.go.html#1935739">wake</a></span><span class="op" id="1935957">.</span><span class="ident" id="1935958">g</span><span class="op" id="1935959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1935963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1935966">}</span>&nbsp;<span class="keyword" id="1935968">else</span>&nbsp;<span class="op" id="1935973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1935977">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1935998">w</span>&nbsp;<span class="op" id="1936000">:=</span>&nbsp;<span class="ident" id="1936003"><a href="/runtime/proc.go.html#1904005">acquireSudog</a></span><span class="op" id="1936015">(</span><span class="op" id="1936016">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936020"><a href="/runtime/sema.go.html#1935998">w</a></span><span class="op" id="1936021">.</span><span class="ident" id="1936022">g</span>&nbsp;<span class="op" id="1936024">=</span>&nbsp;<span class="ident" id="1936026"><a href="/runtime/stubs.go.html#1968886">getg</a></span><span class="op" id="1936030">(</span><span class="op" id="1936031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936035"><a href="/runtime/sema.go.html#1935998">w</a></span><span class="op" id="1936036">.</span><span class="ident" id="1936037">nrelease</span>&nbsp;<span class="op" id="1936046">=</span>&nbsp;<span class="op" id="1936048">-</span><span class="num" id="1936049">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936053"><a href="/runtime/sema.go.html#1935998">w</a></span><span class="op" id="1936054">.</span><span class="ident" id="1936055">next</span>&nbsp;<span class="op" id="1936060">=</span>&nbsp;<span class="ident" id="1936062">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936068"><a href="/runtime/sema.go.html#1935998">w</a></span><span class="op" id="1936069">.</span><span class="ident" id="1936070">releasetime</span>&nbsp;<span class="op" id="1936082">=</span>&nbsp;<span class="num" id="1936084">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936088">t0</span>&nbsp;<span class="op" id="1936091">:=</span>&nbsp;<span class="ident" id="1936094">int64</span><span class="op" id="1936099">(</span><span class="num" id="1936100">0</span><span class="op" id="1936101">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1936105">if</span>&nbsp;<span class="ident" id="1936108"><a href="/runtime/mprof.go.html#1856178">blockprofilerate</a></span>&nbsp;<span class="op" id="1936125">&gt;</span>&nbsp;<span class="num" id="1936127">0</span>&nbsp;<span class="op" id="1936129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936134"><a href="/runtime/sema.go.html#1936088">t0</a></span>&nbsp;<span class="op" id="1936137">=</span>&nbsp;<span class="ident" id="1936139"><a href="/runtime/stubs.go.html#1974111">cputicks</a></span><span class="op" id="1936147">(</span><span class="op" id="1936148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936153"><a href="/runtime/sema.go.html#1935998">w</a></span><span class="op" id="1936154">.</span><span class="ident" id="1936155">releasetime</span>&nbsp;<span class="op" id="1936167">=</span>&nbsp;<span class="op" id="1936169">-</span><span class="num" id="1936170">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1936174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1936178">if</span>&nbsp;<span class="ident" id="1936181"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1936182">.</span><span class="ident" id="1936183">tail</span>&nbsp;<span class="op" id="1936188">==</span>&nbsp;<span class="ident" id="1936191">nil</span>&nbsp;<span class="op" id="1936195">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936200"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1936201">.</span><span class="ident" id="1936202">head</span>&nbsp;<span class="op" id="1936207">=</span>&nbsp;<span class="ident" id="1936209"><a href="/runtime/sema.go.html#1935998">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1936213">}</span>&nbsp;<span class="keyword" id="1936215">else</span>&nbsp;<span class="op" id="1936220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936225"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1936226">.</span><span class="ident" id="1936227">tail</span><span class="op" id="1936231">.</span><span class="ident" id="1936232">next</span>&nbsp;<span class="op" id="1936237">=</span>&nbsp;<span class="ident" id="1936239"><a href="/runtime/sema.go.html#1935998">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1936243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936247"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1936248">.</span><span class="ident" id="1936249">tail</span>&nbsp;<span class="op" id="1936254">=</span>&nbsp;<span class="ident" id="1936256"><a href="/runtime/sema.go.html#1935998">w</a></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936260"><a href="/runtime/proc.go.html#1903766">goparkunlock</a></span><span class="op" id="1936272">(</span><span class="op" id="1936273">&amp;</span><span class="ident" id="1936274"><a href="/runtime/sema.go.html#1935621">s</a></span><span class="op" id="1936275">.</span><span class="ident" id="1936276">lock</span><span class="op" id="1936280">,</span>&nbsp;<span class="string" id="1936282">&#34;semacquire&#34;</span><span class="op" id="1936294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1936298">if</span>&nbsp;<span class="ident" id="1936301"><a href="/runtime/sema.go.html#1936088">t0</a></span>&nbsp;<span class="op" id="1936304">!=</span>&nbsp;<span class="num" id="1936307">0</span>&nbsp;<span class="op" id="1936309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936314"><a href="/runtime/mprof.go.html#1856961">blockevent</a></span><span class="op" id="1936324">(</span><span class="ident" id="1936325">int64</span><span class="op" id="1936330">(</span><span class="ident" id="1936331"><a href="/runtime/sema.go.html#1935998">w</a></span><span class="op" id="1936332">.</span><span class="ident" id="1936333">releasetime</span><span class="op" id="1936344">)</span><span class="op" id="1936345">-</span><span class="ident" id="1936346"><a href="/runtime/sema.go.html#1936088">t0</a></span><span class="op" id="1936348">,</span>&nbsp;<span class="num" id="1936350">2</span><span class="op" id="1936351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1936355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936359"><a href="/runtime/proc.go.html#1904735">releaseSudog</a></span><span class="op" id="1936371">(</span><span class="ident" id="1936372"><a href="/runtime/sema.go.html#1935998">w</a></span><span class="op" id="1936373">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1936376">}</span><br>
<span class="lineno"></span><span class="op" id="1936378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1936381">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1936459">func</span>&nbsp;<span class="ident" id="1936464">syncsemrelease</span><span class="op" id="1936478">(</span><span class="ident" id="1936479">s</span>&nbsp;<span class="op" id="1936481">*</span><span class="ident" id="1936482"><a href="/runtime/sema.go.html#1935464">syncSema</a></span><span class="op" id="1936490">,</span>&nbsp;<span class="ident" id="1936492">n</span>&nbsp;<span class="builtintype" id="1936494">uint32</span><span class="op" id="1936500">)</span>&nbsp;<span class="op" id="1936502">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936505"><a href="/runtime/lock_futex.go.html#1815304">lock</a></span><span class="op" id="1936509">(</span><span class="op" id="1936510">&amp;</span><span class="ident" id="1936511"><a href="/runtime/sema.go.html#1936479">s</a></span><span class="op" id="1936512">.</span><span class="ident" id="1936513">lock</span><span class="op" id="1936517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1936520">for</span>&nbsp;<span class="ident" id="1936524"><a href="/runtime/sema.go.html#1936492">n</a></span>&nbsp;<span class="op" id="1936526">&gt;</span>&nbsp;<span class="num" id="1936528">0</span>&nbsp;<span class="op" id="1936530">&amp;&amp;</span>&nbsp;<span class="ident" id="1936533"><a href="/runtime/sema.go.html#1936479">s</a></span><span class="op" id="1936534">.</span><span class="ident" id="1936535">head</span>&nbsp;<span class="op" id="1936540">!=</span>&nbsp;<span class="ident" id="1936543">nil</span>&nbsp;<span class="op" id="1936547">&amp;&amp;</span>&nbsp;<span class="ident" id="1936550"><a href="/runtime/sema.go.html#1936479">s</a></span><span class="op" id="1936551">.</span><span class="ident" id="1936552">head</span><span class="op" id="1936556">.</span><span class="ident" id="1936557">nrelease</span>&nbsp;<span class="op" id="1936566">&lt;</span>&nbsp;<span class="num" id="1936568">0</span>&nbsp;<span class="op" id="1936570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1936574">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936613">wake</span>&nbsp;<span class="op" id="1936618">:=</span>&nbsp;<span class="ident" id="1936621"><a href="/runtime/sema.go.html#1936479">s</a></span><span class="op" id="1936622">.</span><span class="ident" id="1936623">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936630"><a href="/runtime/sema.go.html#1936479">s</a></span><span class="op" id="1936631">.</span><span class="ident" id="1936632">head</span>&nbsp;<span class="op" id="1936637">=</span>&nbsp;<span class="ident" id="1936639"><a href="/runtime/sema.go.html#1936613">wake</a></span><span class="op" id="1936643">.</span><span class="ident" id="1936644">next</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1936651">if</span>&nbsp;<span class="ident" id="1936654"><a href="/runtime/sema.go.html#1936479">s</a></span><span class="op" id="1936655">.</span><span class="ident" id="1936656">head</span>&nbsp;<span class="op" id="1936661">==</span>&nbsp;<span class="ident" id="1936664">nil</span>&nbsp;<span class="op" id="1936668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936673"><a href="/runtime/sema.go.html#1936479">s</a></span><span class="op" id="1936674">.</span><span class="ident" id="1936675">tail</span>&nbsp;<span class="op" id="1936680">=</span>&nbsp;<span class="ident" id="1936682">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1936688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1936692">if</span>&nbsp;<span class="ident" id="1936695"><a href="/runtime/sema.go.html#1936613">wake</a></span><span class="op" id="1936699">.</span><span class="ident" id="1936700">releasetime</span>&nbsp;<span class="op" id="1936712">!=</span>&nbsp;<span class="num" id="1936715">0</span>&nbsp;<span class="op" id="1936717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936722"><a href="/runtime/sema.go.html#1936613">wake</a></span><span class="op" id="1936726">.</span><span class="ident" id="1936727">releasetime</span>&nbsp;<span class="op" id="1936739">=</span>&nbsp;<span class="ident" id="1936741"><a href="/runtime/stubs.go.html#1974111">cputicks</a></span><span class="op" id="1936749">(</span><span class="op" id="1936750">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1936754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936758"><a href="/runtime/sema.go.html#1936613">wake</a></span><span class="op" id="1936762">.</span><span class="ident" id="1936763">next</span>&nbsp;<span class="op" id="1936768">=</span>&nbsp;<span class="ident" id="1936770">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936776"><a href="/runtime/proc.go.html#1903886">goready</a></span><span class="op" id="1936783">(</span><span class="ident" id="1936784"><a href="/runtime/sema.go.html#1936613">wake</a></span><span class="op" id="1936788">.</span><span class="ident" id="1936789">g</span><span class="op" id="1936790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936794"><a href="/runtime/sema.go.html#1936492">n</a></span><span class="op" id="1936795">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1936799">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1936802">if</span>&nbsp;<span class="ident" id="1936805"><a href="/runtime/sema.go.html#1936492">n</a></span>&nbsp;<span class="op" id="1936807">&gt;</span>&nbsp;<span class="num" id="1936809">0</span>&nbsp;<span class="op" id="1936811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1936815">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936835">w</span>&nbsp;<span class="op" id="1936837">:=</span>&nbsp;<span class="ident" id="1936840"><a href="/runtime/proc.go.html#1904005">acquireSudog</a></span><span class="op" id="1936852">(</span><span class="op" id="1936853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936857"><a href="/runtime/sema.go.html#1936835">w</a></span><span class="op" id="1936858">.</span><span class="ident" id="1936859">g</span>&nbsp;<span class="op" id="1936861">=</span>&nbsp;<span class="ident" id="1936863"><a href="/runtime/stubs.go.html#1968886">getg</a></span><span class="op" id="1936867">(</span><span class="op" id="1936868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936872"><a href="/runtime/sema.go.html#1936835">w</a></span><span class="op" id="1936873">.</span><span class="ident" id="1936874">nrelease</span>&nbsp;<span class="op" id="1936883">=</span>&nbsp;<span class="builtintype" id="1936885">int32</span><span class="op" id="1936890">(</span><span class="ident" id="1936891"><a href="/runtime/sema.go.html#1936492">n</a></span><span class="op" id="1936892">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936896"><a href="/runtime/sema.go.html#1936835">w</a></span><span class="op" id="1936897">.</span><span class="ident" id="1936898">next</span>&nbsp;<span class="op" id="1936903">=</span>&nbsp;<span class="ident" id="1936905">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936911"><a href="/runtime/sema.go.html#1936835">w</a></span><span class="op" id="1936912">.</span><span class="ident" id="1936913">releasetime</span>&nbsp;<span class="op" id="1936925">=</span>&nbsp;<span class="num" id="1936927">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1936931">if</span>&nbsp;<span class="ident" id="1936934"><a href="/runtime/sema.go.html#1936479">s</a></span><span class="op" id="1936935">.</span><span class="ident" id="1936936">tail</span>&nbsp;<span class="op" id="1936941">==</span>&nbsp;<span class="ident" id="1936944">nil</span>&nbsp;<span class="op" id="1936948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936953"><a href="/runtime/sema.go.html#1936479">s</a></span><span class="op" id="1936954">.</span><span class="ident" id="1936955">head</span>&nbsp;<span class="op" id="1936960">=</span>&nbsp;<span class="ident" id="1936962"><a href="/runtime/sema.go.html#1936835">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1936966">}</span>&nbsp;<span class="keyword" id="1936968">else</span>&nbsp;<span class="op" id="1936973">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1936978"><a href="/runtime/sema.go.html#1936479">s</a></span><span class="op" id="1936979">.</span><span class="ident" id="1936980">tail</span><span class="op" id="1936984">.</span><span class="ident" id="1936985">next</span>&nbsp;<span class="op" id="1936990">=</span>&nbsp;<span class="ident" id="1936992"><a href="/runtime/sema.go.html#1936835">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1936996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1937000"><a href="/runtime/sema.go.html#1936479">s</a></span><span class="op" id="1937001">.</span><span class="ident" id="1937002">tail</span>&nbsp;<span class="op" id="1937007">=</span>&nbsp;<span class="ident" id="1937009"><a href="/runtime/sema.go.html#1936835">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1937013"><a href="/runtime/proc.go.html#1903766">goparkunlock</a></span><span class="op" id="1937025">(</span><span class="op" id="1937026">&amp;</span><span class="ident" id="1937027"><a href="/runtime/sema.go.html#1936479">s</a></span><span class="op" id="1937028">.</span><span class="ident" id="1937029">lock</span><span class="op" id="1937033">,</span>&nbsp;<span class="string" id="1937035">&#34;semarelease&#34;</span><span class="op" id="1937048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1937052"><a href="/runtime/proc.go.html#1904735">releaseSudog</a></span><span class="op" id="1937064">(</span><span class="ident" id="1937065"><a href="/runtime/sema.go.html#1936835">w</a></span><span class="op" id="1937066">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1937069">}</span>&nbsp;<span class="keyword" id="1937071">else</span>&nbsp;<span class="op" id="1937076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1937080"><a href="/runtime/lock_futex.go.html#1816596">unlock</a></span><span class="op" id="1937086">(</span><span class="op" id="1937087">&amp;</span><span class="ident" id="1937088"><a href="/runtime/sema.go.html#1936479">s</a></span><span class="op" id="1937089">.</span><span class="ident" id="1937090">lock</span><span class="op" id="1937094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1937097">}</span><br>
<span class="lineno"></span><span class="op" id="1937099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1937102">func</span>&nbsp;<span class="ident" id="1937107">syncsemcheck</span><span class="op" id="1937119">(</span><span class="ident" id="1937120">sz</span>&nbsp;<span class="builtintype" id="1937123">uintptr</span><span class="op" id="1937130">)</span>&nbsp;<span class="op" id="1937132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1937135">if</span>&nbsp;<span class="ident" id="1937138"><a href="/runtime/sema.go.html#1937120">sz</a></span>&nbsp;<span class="op" id="1937141">!=</span>&nbsp;<span class="ident" id="1937144"><a href="/runtime/sema.go.html#1932324">unsafe</a></span><span class="op" id="1937150">.</span><span class="ident" id="1937151">Sizeof</span><span class="op" id="1937157">(</span><span class="ident" id="1937158"><a href="/runtime/sema.go.html#1935464">syncSema</a></span><span class="op" id="1937166">{</span><span class="op" id="1937167">}</span><span class="op" id="1937168">)</span>&nbsp;<span class="op" id="1937170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1937174">print</span><span class="op" id="1937179">(</span><span class="string" id="1937180">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="1937216">,</span>&nbsp;<span class="ident" id="1937218"><a href="/runtime/sema.go.html#1937120">sz</a></span><span class="op" id="1937220">,</span>&nbsp;<span class="string" id="1937222">&#34;&nbsp;runtime=&#34;</span><span class="op" id="1937233">,</span>&nbsp;<span class="ident" id="1937235"><a href="/runtime/sema.go.html#1932324">unsafe</a></span><span class="op" id="1937241">.</span><span class="ident" id="1937242">Sizeof</span><span class="op" id="1937248">(</span><span class="ident" id="1937249"><a href="/runtime/sema.go.html#1935464">syncSema</a></span><span class="op" id="1937257">{</span><span class="op" id="1937258">}</span><span class="op" id="1937259">)</span><span class="op" id="1937260">,</span>&nbsp;<span class="string" id="1937262">&#34;\n&#34;</span><span class="op" id="1937266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1937270"><a href="/runtime/panic.go.html#1894294">gothrow</a></span><span class="op" id="1937277">(</span><span class="string" id="1937278">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="1937297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1937300">}</span><br>
<span class="lineno">275</span><span class="op" id="1937302">}</span>
</div>
</body>
</html>
