<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>text/template/parse</h2>
<ul>
<li><a href="/gostd/text/template/parse/lex.go.html">lex.go</a></li>
<li><a href="/gostd/text/template/parse/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/text/template/parse/node.go.html">node.go</a></li>
<li><a href="/gostd/text/template/parse/parse.go.html" class="current">parse.go</a></li>
<li><a href="/gostd/text/template/parse/parse_test.go.html">parse_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3296593">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3296648">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3296702">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3296753">//&nbsp;Package&nbsp;parse&nbsp;builds&nbsp;parse&nbsp;trees&nbsp;for&nbsp;templates&nbsp;as&nbsp;defined&nbsp;by&nbsp;text/template</span><br>
<span class="lineno"></span><span class="comment" id="3296831">//&nbsp;and&nbsp;html/template.&nbsp;Clients&nbsp;should&nbsp;use&nbsp;those&nbsp;packages&nbsp;to&nbsp;construct&nbsp;templates</span><br>
<span class="lineno"></span><span class="comment" id="3296910">//&nbsp;rather&nbsp;than&nbsp;this&nbsp;one,&nbsp;which&nbsp;provides&nbsp;shared&nbsp;internal&nbsp;data&nbsp;structures&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="3296986">//&nbsp;intended&nbsp;for&nbsp;general&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3297015">package</span>&nbsp;<span class="ident" id="3297023">parse</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3297030">import</span>&nbsp;<span class="op" id="3297037">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3297040">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3297049">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3297056">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3297067">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3297078">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="3297088">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3297091">//&nbsp;Tree&nbsp;is&nbsp;the&nbsp;representation&nbsp;of&nbsp;a&nbsp;single&nbsp;parsed&nbsp;template.</span><br>
<span class="lineno">20</span><span class="keyword" id="3297150">type</span>&nbsp;<span class="ident" id="3297155">Tree</span>&nbsp;<span class="keyword" id="3297160">struct</span>&nbsp;<span class="op" id="3297167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297170">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3297180">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3297190">//&nbsp;name&nbsp;of&nbsp;the&nbsp;template&nbsp;represented&nbsp;by&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297240">ParseName</span>&nbsp;<span class="builtintype" id="3297250">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3297260">//&nbsp;name&nbsp;of&nbsp;the&nbsp;top-level&nbsp;template&nbsp;during&nbsp;parsing,&nbsp;for&nbsp;error&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297331">Root</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3297341">*</span><span class="ident" id="3297342">ListNode</span>&nbsp;<span class="comment" id="3297351">//&nbsp;top-level&nbsp;root&nbsp;of&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297383">text</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3297393">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3297403">//&nbsp;text&nbsp;parsed&nbsp;to&nbsp;create&nbsp;the&nbsp;template&nbsp;(or&nbsp;its&nbsp;parent)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297458">//&nbsp;Parsing&nbsp;only;&nbsp;cleared&nbsp;after&nbsp;parse.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297497">funcs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3297507">[</span><span class="op" id="3297508">]</span><span class="keyword" id="3297509">map</span><span class="op" id="3297512">[</span><span class="builtintype" id="3297513">string</span><span class="op" id="3297519">]</span><span class="keyword" id="3297520">interface</span><span class="op" id="3297529">{</span><span class="op" id="3297530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297533">lex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3297543">*</span><span class="ident" id="3297544">lexer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297551">token</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3297561">[</span><span class="num" id="3297562">3</span><span class="op" id="3297563">]</span><span class="ident" id="3297564">item</span>&nbsp;<span class="comment" id="3297569">//&nbsp;three-token&nbsp;lookahead&nbsp;for&nbsp;parser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297607">peekCount</span>&nbsp;<span class="builtintype" id="3297617">int</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297622">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3297632">[</span><span class="op" id="3297633">]</span><span class="builtintype" id="3297634">string</span>&nbsp;<span class="comment" id="3297641">//&nbsp;variables&nbsp;defined&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span><span class="op" id="3297677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3297680">//&nbsp;Copy&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;Tree.&nbsp;Any&nbsp;parsing&nbsp;state&nbsp;is&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="3297748">func</span>&nbsp;<span class="op" id="3297753">(</span><span class="ident" id="3297754">t</span>&nbsp;<span class="op" id="3297756">*</span><span class="ident" id="3297757">Tree</span><span class="op" id="3297761">)</span>&nbsp;<span class="ident" id="3297763">Copy</span><span class="op" id="3297767">(</span><span class="op" id="3297768">)</span>&nbsp;<span class="op" id="3297770">*</span><span class="ident" id="3297771">Tree</span>&nbsp;<span class="op" id="3297776">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297779">if</span>&nbsp;<span class="ident" id="3297782">t</span>&nbsp;<span class="op" id="3297784">==</span>&nbsp;<span class="ident" id="3297787">nil</span>&nbsp;<span class="op" id="3297791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297795">return</span>&nbsp;<span class="ident" id="3297802">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297810">return</span>&nbsp;<span class="op" id="3297817">&amp;</span><span class="ident" id="3297818">Tree</span><span class="op" id="3297822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297826">Name</span><span class="op" id="3297830">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3297837">t</span><span class="op" id="3297838">.</span><span class="ident" id="3297839">Name</span><span class="op" id="3297843">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297847">ParseName</span><span class="op" id="3297856">:</span>&nbsp;<span class="ident" id="3297858">t</span><span class="op" id="3297859">.</span><span class="ident" id="3297860">ParseName</span><span class="op" id="3297869">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297873">Root</span><span class="op" id="3297877">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3297884">t</span><span class="op" id="3297885">.</span><span class="ident" id="3297886">Root</span><span class="op" id="3297890">.</span><span class="ident" id="3297891">CopyList</span><span class="op" id="3297899">(</span><span class="op" id="3297900">)</span><span class="op" id="3297901">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297905">text</span><span class="op" id="3297909">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3297916">t</span><span class="op" id="3297917">.</span><span class="ident" id="3297918">text</span><span class="op" id="3297922">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297925">}</span><br>
<span class="lineno"></span><span class="op" id="3297927">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="3297930">//&nbsp;Parse&nbsp;returns&nbsp;a&nbsp;map&nbsp;from&nbsp;template&nbsp;name&nbsp;to&nbsp;parse.Tree,&nbsp;created&nbsp;by&nbsp;parsing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3298010">//&nbsp;templates&nbsp;described&nbsp;in&nbsp;the&nbsp;argument&nbsp;string.&nbsp;The&nbsp;top-level&nbsp;template&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3298088">//&nbsp;given&nbsp;the&nbsp;specified&nbsp;name.&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;encountered,&nbsp;parsing&nbsp;stops&nbsp;and&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3298166">//&nbsp;empty&nbsp;map&nbsp;is&nbsp;returned&nbsp;with&nbsp;the&nbsp;error.</span><br>
<span class="lineno">50</span><span class="keyword" id="3298207">func</span>&nbsp;<span class="ident" id="3298212">Parse</span><span class="op" id="3298217">(</span><span class="ident" id="3298218">name</span><span class="op" id="3298222">,</span>&nbsp;<span class="ident" id="3298224">text</span><span class="op" id="3298228">,</span>&nbsp;<span class="ident" id="3298230">leftDelim</span><span class="op" id="3298239">,</span>&nbsp;<span class="ident" id="3298241">rightDelim</span>&nbsp;<span class="builtintype" id="3298252">string</span><span class="op" id="3298258">,</span>&nbsp;<span class="ident" id="3298260">funcs</span>&nbsp;<span class="op" id="3298266">...</span><span class="keyword" id="3298269">map</span><span class="op" id="3298272">[</span><span class="builtintype" id="3298273">string</span><span class="op" id="3298279">]</span><span class="keyword" id="3298280">interface</span><span class="op" id="3298289">{</span><span class="op" id="3298290">}</span><span class="op" id="3298291">)</span>&nbsp;<span class="op" id="3298293">(</span><span class="ident" id="3298294">treeSet</span>&nbsp;<span class="keyword" id="3298302">map</span><span class="op" id="3298305">[</span><span class="builtintype" id="3298306">string</span><span class="op" id="3298312">]</span><span class="op" id="3298313">*</span><span class="ident" id="3298314">Tree</span><span class="op" id="3298318">,</span>&nbsp;<span class="ident" id="3298320">err</span>&nbsp;<span class="builtintype" id="3298324">error</span><span class="op" id="3298329">)</span>&nbsp;<span class="op" id="3298331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298334">treeSet</span>&nbsp;<span class="op" id="3298342">=</span>&nbsp;<span class="builtinfunc" id="3298344">make</span><span class="op" id="3298348">(</span><span class="keyword" id="3298349">map</span><span class="op" id="3298352">[</span><span class="builtintype" id="3298353">string</span><span class="op" id="3298359">]</span><span class="op" id="3298360">*</span><span class="ident" id="3298361">Tree</span><span class="op" id="3298365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298368">t</span>&nbsp;<span class="op" id="3298370">:=</span>&nbsp;<span class="ident" id="3298373">New</span><span class="op" id="3298376">(</span><span class="ident" id="3298377">name</span><span class="op" id="3298381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298384">t</span><span class="op" id="3298385">.</span><span class="ident" id="3298386">text</span>&nbsp;<span class="op" id="3298391">=</span>&nbsp;<span class="ident" id="3298393">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298399">_</span><span class="op" id="3298400">,</span>&nbsp;<span class="ident" id="3298402">err</span>&nbsp;<span class="op" id="3298406">=</span>&nbsp;<span class="ident" id="3298408">t</span><span class="op" id="3298409">.</span><span class="ident" id="3298410">Parse</span><span class="op" id="3298415">(</span><span class="ident" id="3298416">text</span><span class="op" id="3298420">,</span>&nbsp;<span class="ident" id="3298422">leftDelim</span><span class="op" id="3298431">,</span>&nbsp;<span class="ident" id="3298433">rightDelim</span><span class="op" id="3298443">,</span>&nbsp;<span class="ident" id="3298445">treeSet</span><span class="op" id="3298452">,</span>&nbsp;<span class="ident" id="3298454">funcs</span><span class="op" id="3298459">...</span><span class="op" id="3298462">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298465">return</span><br>
<span class="lineno"></span><span class="op" id="3298472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3298475">//&nbsp;next&nbsp;returns&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3298507">func</span>&nbsp;<span class="op" id="3298512">(</span><span class="ident" id="3298513">t</span>&nbsp;<span class="op" id="3298515">*</span><span class="ident" id="3298516">Tree</span><span class="op" id="3298520">)</span>&nbsp;<span class="ident" id="3298522">next</span><span class="op" id="3298526">(</span><span class="op" id="3298527">)</span>&nbsp;<span class="ident" id="3298529">item</span>&nbsp;<span class="op" id="3298534">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298537">if</span>&nbsp;<span class="ident" id="3298540">t</span><span class="op" id="3298541">.</span><span class="ident" id="3298542">peekCount</span>&nbsp;<span class="op" id="3298552">&gt;</span>&nbsp;<span class="num" id="3298554">0</span>&nbsp;<span class="op" id="3298556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298560">t</span><span class="op" id="3298561">.</span><span class="ident" id="3298562">peekCount</span><span class="op" id="3298571">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3298575">}</span>&nbsp;<span class="keyword" id="3298577">else</span>&nbsp;<span class="op" id="3298582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298586">t</span><span class="op" id="3298587">.</span><span class="ident" id="3298588">token</span><span class="op" id="3298593">[</span><span class="num" id="3298594">0</span><span class="op" id="3298595">]</span>&nbsp;<span class="op" id="3298597">=</span>&nbsp;<span class="ident" id="3298599">t</span><span class="op" id="3298600">.</span><span class="ident" id="3298601">lex</span><span class="op" id="3298604">.</span><span class="ident" id="3298605">nextItem</span><span class="op" id="3298613">(</span><span class="op" id="3298614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3298617">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298620">return</span>&nbsp;<span class="ident" id="3298627">t</span><span class="op" id="3298628">.</span><span class="ident" id="3298629">token</span><span class="op" id="3298634">[</span><span class="ident" id="3298635">t</span><span class="op" id="3298636">.</span><span class="ident" id="3298637">peekCount</span><span class="op" id="3298646">]</span><br>
<span class="lineno"></span><span class="op" id="3298648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3298651">//&nbsp;backup&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;one&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3298698">func</span>&nbsp;<span class="op" id="3298703">(</span><span class="ident" id="3298704">t</span>&nbsp;<span class="op" id="3298706">*</span><span class="ident" id="3298707">Tree</span><span class="op" id="3298711">)</span>&nbsp;<span class="ident" id="3298713">backup</span><span class="op" id="3298719">(</span><span class="op" id="3298720">)</span>&nbsp;<span class="op" id="3298722">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298725">t</span><span class="op" id="3298726">.</span><span class="ident" id="3298727">peekCount</span><span class="op" id="3298736">++</span><br>
<span class="lineno"></span><span class="op" id="3298739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3298742">//&nbsp;backup2&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;two&nbsp;tokens.</span><br>
<span class="lineno"></span><span class="comment" id="3298791">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno">75</span><span class="keyword" id="3298829">func</span>&nbsp;<span class="op" id="3298834">(</span><span class="ident" id="3298835">t</span>&nbsp;<span class="op" id="3298837">*</span><span class="ident" id="3298838">Tree</span><span class="op" id="3298842">)</span>&nbsp;<span class="ident" id="3298844">backup2</span><span class="op" id="3298851">(</span><span class="ident" id="3298852">t1</span>&nbsp;<span class="ident" id="3298855">item</span><span class="op" id="3298859">)</span>&nbsp;<span class="op" id="3298861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298864">t</span><span class="op" id="3298865">.</span><span class="ident" id="3298866">token</span><span class="op" id="3298871">[</span><span class="num" id="3298872">1</span><span class="op" id="3298873">]</span>&nbsp;<span class="op" id="3298875">=</span>&nbsp;<span class="ident" id="3298877">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298881">t</span><span class="op" id="3298882">.</span><span class="ident" id="3298883">peekCount</span>&nbsp;<span class="op" id="3298893">=</span>&nbsp;<span class="num" id="3298895">2</span><br>
<span class="lineno"></span><span class="op" id="3298897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="3298900">//&nbsp;backup3&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;three&nbsp;tokens</span><br>
<span class="lineno"></span><span class="comment" id="3298950">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="3298988">func</span>&nbsp;<span class="op" id="3298993">(</span><span class="ident" id="3298994">t</span>&nbsp;<span class="op" id="3298996">*</span><span class="ident" id="3298997">Tree</span><span class="op" id="3299001">)</span>&nbsp;<span class="ident" id="3299003">backup3</span><span class="op" id="3299010">(</span><span class="ident" id="3299011">t2</span><span class="op" id="3299013">,</span>&nbsp;<span class="ident" id="3299015">t1</span>&nbsp;<span class="ident" id="3299018">item</span><span class="op" id="3299022">)</span>&nbsp;<span class="op" id="3299024">{</span>&nbsp;<span class="comment" id="3299026">//&nbsp;Reverse&nbsp;order:&nbsp;we&#39;re&nbsp;pushing&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299065">t</span><span class="op" id="3299066">.</span><span class="ident" id="3299067">token</span><span class="op" id="3299072">[</span><span class="num" id="3299073">1</span><span class="op" id="3299074">]</span>&nbsp;<span class="op" id="3299076">=</span>&nbsp;<span class="ident" id="3299078">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299082">t</span><span class="op" id="3299083">.</span><span class="ident" id="3299084">token</span><span class="op" id="3299089">[</span><span class="num" id="3299090">2</span><span class="op" id="3299091">]</span>&nbsp;<span class="op" id="3299093">=</span>&nbsp;<span class="ident" id="3299095">t2</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299099">t</span><span class="op" id="3299100">.</span><span class="ident" id="3299101">peekCount</span>&nbsp;<span class="op" id="3299111">=</span>&nbsp;<span class="num" id="3299113">3</span><br>
<span class="lineno"></span><span class="op" id="3299115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3299118">//&nbsp;peek&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3299171">func</span>&nbsp;<span class="op" id="3299176">(</span><span class="ident" id="3299177">t</span>&nbsp;<span class="op" id="3299179">*</span><span class="ident" id="3299180">Tree</span><span class="op" id="3299184">)</span>&nbsp;<span class="ident" id="3299186">peek</span><span class="op" id="3299190">(</span><span class="op" id="3299191">)</span>&nbsp;<span class="ident" id="3299193">item</span>&nbsp;<span class="op" id="3299198">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299201">if</span>&nbsp;<span class="ident" id="3299204">t</span><span class="op" id="3299205">.</span><span class="ident" id="3299206">peekCount</span>&nbsp;<span class="op" id="3299216">&gt;</span>&nbsp;<span class="num" id="3299218">0</span>&nbsp;<span class="op" id="3299220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299224">return</span>&nbsp;<span class="ident" id="3299231">t</span><span class="op" id="3299232">.</span><span class="ident" id="3299233">token</span><span class="op" id="3299238">[</span><span class="ident" id="3299239">t</span><span class="op" id="3299240">.</span><span class="ident" id="3299241">peekCount</span><span class="op" id="3299250">-</span><span class="num" id="3299251">1</span><span class="op" id="3299252">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299258">t</span><span class="op" id="3299259">.</span><span class="ident" id="3299260">peekCount</span>&nbsp;<span class="op" id="3299270">=</span>&nbsp;<span class="num" id="3299272">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299275">t</span><span class="op" id="3299276">.</span><span class="ident" id="3299277">token</span><span class="op" id="3299282">[</span><span class="num" id="3299283">0</span><span class="op" id="3299284">]</span>&nbsp;<span class="op" id="3299286">=</span>&nbsp;<span class="ident" id="3299288">t</span><span class="op" id="3299289">.</span><span class="ident" id="3299290">lex</span><span class="op" id="3299293">.</span><span class="ident" id="3299294">nextItem</span><span class="op" id="3299302">(</span><span class="op" id="3299303">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299306">return</span>&nbsp;<span class="ident" id="3299313">t</span><span class="op" id="3299314">.</span><span class="ident" id="3299315">token</span><span class="op" id="3299320">[</span><span class="num" id="3299321">0</span><span class="op" id="3299322">]</span><br>
<span class="lineno"></span><span class="op" id="3299324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3299327">//&nbsp;nextNonSpace&nbsp;returns&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3299377">func</span>&nbsp;<span class="op" id="3299382">(</span><span class="ident" id="3299383">t</span>&nbsp;<span class="op" id="3299385">*</span><span class="ident" id="3299386">Tree</span><span class="op" id="3299390">)</span>&nbsp;<span class="ident" id="3299392">nextNonSpace</span><span class="op" id="3299404">(</span><span class="op" id="3299405">)</span>&nbsp;<span class="op" id="3299407">(</span><span class="ident" id="3299408">token</span>&nbsp;<span class="ident" id="3299414">item</span><span class="op" id="3299418">)</span>&nbsp;<span class="op" id="3299420">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299423">for</span>&nbsp;<span class="op" id="3299427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299431">token</span>&nbsp;<span class="op" id="3299437">=</span>&nbsp;<span class="ident" id="3299439">t</span><span class="op" id="3299440">.</span><span class="ident" id="3299441">next</span><span class="op" id="3299445">(</span><span class="op" id="3299446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299450">if</span>&nbsp;<span class="ident" id="3299453">token</span><span class="op" id="3299458">.</span><span class="ident" id="3299459">typ</span>&nbsp;<span class="op" id="3299463">!=</span>&nbsp;<span class="ident" id="3299466">itemSpace</span>&nbsp;<span class="op" id="3299476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299481">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299489">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299495">return</span>&nbsp;<span class="ident" id="3299502">token</span><br>
<span class="lineno"></span><span class="op" id="3299508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3299511">//&nbsp;peekNonSpace&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno">110</span><span class="keyword" id="3299582">func</span>&nbsp;<span class="op" id="3299587">(</span><span class="ident" id="3299588">t</span>&nbsp;<span class="op" id="3299590">*</span><span class="ident" id="3299591">Tree</span><span class="op" id="3299595">)</span>&nbsp;<span class="ident" id="3299597">peekNonSpace</span><span class="op" id="3299609">(</span><span class="op" id="3299610">)</span>&nbsp;<span class="op" id="3299612">(</span><span class="ident" id="3299613">token</span>&nbsp;<span class="ident" id="3299619">item</span><span class="op" id="3299623">)</span>&nbsp;<span class="op" id="3299625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299628">for</span>&nbsp;<span class="op" id="3299632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299636">token</span>&nbsp;<span class="op" id="3299642">=</span>&nbsp;<span class="ident" id="3299644">t</span><span class="op" id="3299645">.</span><span class="ident" id="3299646">next</span><span class="op" id="3299650">(</span><span class="op" id="3299651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299655">if</span>&nbsp;<span class="ident" id="3299658">token</span><span class="op" id="3299663">.</span><span class="ident" id="3299664">typ</span>&nbsp;<span class="op" id="3299668">!=</span>&nbsp;<span class="ident" id="3299671">itemSpace</span>&nbsp;<span class="op" id="3299681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299686">break</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299700">t</span><span class="op" id="3299701">.</span><span class="ident" id="3299702">backup</span><span class="op" id="3299708">(</span><span class="op" id="3299709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299712">return</span>&nbsp;<span class="ident" id="3299719">token</span><br>
<span class="lineno"></span><span class="op" id="3299725">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3299728">//&nbsp;Parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3299741">//&nbsp;New&nbsp;allocates&nbsp;a&nbsp;new&nbsp;parse&nbsp;tree&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3299796">func</span>&nbsp;<span class="ident" id="3299801">New</span><span class="op" id="3299804">(</span><span class="ident" id="3299805">name</span>&nbsp;<span class="builtintype" id="3299810">string</span><span class="op" id="3299816">,</span>&nbsp;<span class="ident" id="3299818">funcs</span>&nbsp;<span class="op" id="3299824">...</span><span class="keyword" id="3299827">map</span><span class="op" id="3299830">[</span><span class="builtintype" id="3299831">string</span><span class="op" id="3299837">]</span><span class="keyword" id="3299838">interface</span><span class="op" id="3299847">{</span><span class="op" id="3299848">}</span><span class="op" id="3299849">)</span>&nbsp;<span class="op" id="3299851">*</span><span class="ident" id="3299852">Tree</span>&nbsp;<span class="op" id="3299857">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299860">return</span>&nbsp;<span class="op" id="3299867">&amp;</span><span class="ident" id="3299868">Tree</span><span class="op" id="3299872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299876">Name</span><span class="op" id="3299880">:</span>&nbsp;&nbsp;<span class="ident" id="3299883">name</span><span class="op" id="3299887">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299891">funcs</span><span class="op" id="3299896">:</span>&nbsp;<span class="ident" id="3299898">funcs</span><span class="op" id="3299903">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299906">}</span><br>
<span class="lineno"></span><span class="op" id="3299908">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="3299911">//&nbsp;ErrorContext&nbsp;returns&nbsp;a&nbsp;textual&nbsp;representation&nbsp;of&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;node&nbsp;in&nbsp;the&nbsp;input&nbsp;text.</span><br>
<span class="lineno"></span><span class="comment" id="3300007">//&nbsp;The&nbsp;receiver&nbsp;is&nbsp;only&nbsp;used&nbsp;when&nbsp;the&nbsp;node&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;tree&nbsp;inside,</span><br>
<span class="lineno"></span><span class="comment" id="3300094">//&nbsp;which&nbsp;can&nbsp;occur&nbsp;in&nbsp;old&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="3300126">func</span>&nbsp;<span class="op" id="3300131">(</span><span class="ident" id="3300132">t</span>&nbsp;<span class="op" id="3300134">*</span><span class="ident" id="3300135">Tree</span><span class="op" id="3300139">)</span>&nbsp;<span class="ident" id="3300141">ErrorContext</span><span class="op" id="3300153">(</span><span class="ident" id="3300154">n</span>&nbsp;<span class="ident" id="3300156">Node</span><span class="op" id="3300160">)</span>&nbsp;<span class="op" id="3300162">(</span><span class="ident" id="3300163">location</span><span class="op" id="3300171">,</span>&nbsp;<span class="ident" id="3300173">context</span>&nbsp;<span class="builtintype" id="3300181">string</span><span class="op" id="3300187">)</span>&nbsp;<span class="op" id="3300189">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300192">pos</span>&nbsp;<span class="op" id="3300196">:=</span>&nbsp;<span class="builtintype" id="3300199">int</span><span class="op" id="3300202">(</span><span class="ident" id="3300203">n</span><span class="op" id="3300204">.</span><span class="ident" id="3300205">Position</span><span class="op" id="3300213">(</span><span class="op" id="3300214">)</span><span class="op" id="3300215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300218">tree</span>&nbsp;<span class="op" id="3300223">:=</span>&nbsp;<span class="ident" id="3300226">n</span><span class="op" id="3300227">.</span><span class="ident" id="3300228">tree</span><span class="op" id="3300232">(</span><span class="op" id="3300233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300236">if</span>&nbsp;<span class="ident" id="3300239">tree</span>&nbsp;<span class="op" id="3300244">==</span>&nbsp;<span class="ident" id="3300247">nil</span>&nbsp;<span class="op" id="3300251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300255">tree</span>&nbsp;<span class="op" id="3300260">=</span>&nbsp;<span class="ident" id="3300262">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300265">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300268">text</span>&nbsp;<span class="op" id="3300273">:=</span>&nbsp;<span class="ident" id="3300276">tree</span><span class="op" id="3300280">.</span><span class="ident" id="3300281">text</span><span class="op" id="3300285">[</span><span class="op" id="3300286">:</span><span class="ident" id="3300287">pos</span><span class="op" id="3300290">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300293">byteNum</span>&nbsp;<span class="op" id="3300301">:=</span>&nbsp;<span class="ident" id="3300304">strings</span><span class="op" id="3300311">.</span><span class="ident" id="3300312">LastIndex</span><span class="op" id="3300321">(</span><span class="ident" id="3300322">text</span><span class="op" id="3300326">,</span>&nbsp;<span class="string" id="3300328">&#34;\n&#34;</span><span class="op" id="3300332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300335">if</span>&nbsp;<span class="ident" id="3300338">byteNum</span>&nbsp;<span class="op" id="3300346">==</span>&nbsp;<span class="op" id="3300349">-</span><span class="num" id="3300350">1</span>&nbsp;<span class="op" id="3300352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300356">byteNum</span>&nbsp;<span class="op" id="3300364">=</span>&nbsp;<span class="ident" id="3300366">pos</span>&nbsp;<span class="comment" id="3300370">//&nbsp;On&nbsp;first&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300389">}</span>&nbsp;<span class="keyword" id="3300391">else</span>&nbsp;<span class="op" id="3300396">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300400">byteNum</span><span class="op" id="3300407">++</span>&nbsp;<span class="comment" id="3300410">//&nbsp;After&nbsp;the&nbsp;newline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300434">byteNum</span>&nbsp;<span class="op" id="3300442">=</span>&nbsp;<span class="ident" id="3300444">pos</span>&nbsp;<span class="op" id="3300448">-</span>&nbsp;<span class="ident" id="3300450">byteNum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300462">lineNum</span>&nbsp;<span class="op" id="3300470">:=</span>&nbsp;<span class="num" id="3300473">1</span>&nbsp;<span class="op" id="3300475">+</span>&nbsp;<span class="ident" id="3300477">strings</span><span class="op" id="3300484">.</span><span class="ident" id="3300485">Count</span><span class="op" id="3300490">(</span><span class="ident" id="3300491">text</span><span class="op" id="3300495">,</span>&nbsp;<span class="string" id="3300497">&#34;\n&#34;</span><span class="op" id="3300501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300504">context</span>&nbsp;<span class="op" id="3300512">=</span>&nbsp;<span class="ident" id="3300514">n</span><span class="op" id="3300515">.</span><span class="ident" id="3300516">String</span><span class="op" id="3300522">(</span><span class="op" id="3300523">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300526">if</span>&nbsp;<span class="builtinfunc" id="3300529">len</span><span class="op" id="3300532">(</span><span class="ident" id="3300533">context</span><span class="op" id="3300540">)</span>&nbsp;<span class="op" id="3300542">&gt;</span>&nbsp;<span class="num" id="3300544">20</span>&nbsp;<span class="op" id="3300547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300551">context</span>&nbsp;<span class="op" id="3300559">=</span>&nbsp;<span class="ident" id="3300561">fmt</span><span class="op" id="3300564">.</span><span class="ident" id="3300565">Sprintf</span><span class="op" id="3300572">(</span><span class="string" id="3300573">&#34;%.20s...&#34;</span><span class="op" id="3300583">,</span>&nbsp;<span class="ident" id="3300585">context</span><span class="op" id="3300592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300598">return</span>&nbsp;<span class="ident" id="3300605">fmt</span><span class="op" id="3300608">.</span><span class="ident" id="3300609">Sprintf</span><span class="op" id="3300616">(</span><span class="string" id="3300617">&#34;%s:%d:%d&#34;</span><span class="op" id="3300627">,</span>&nbsp;<span class="ident" id="3300629">tree</span><span class="op" id="3300633">.</span><span class="ident" id="3300634">ParseName</span><span class="op" id="3300643">,</span>&nbsp;<span class="ident" id="3300645">lineNum</span><span class="op" id="3300652">,</span>&nbsp;<span class="ident" id="3300654">byteNum</span><span class="op" id="3300661">)</span><span class="op" id="3300662">,</span>&nbsp;<span class="ident" id="3300664">context</span><br>
<span class="lineno"></span><span class="op" id="3300672">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="3300675">//&nbsp;errorf&nbsp;formats&nbsp;the&nbsp;error&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3300730">func</span>&nbsp;<span class="op" id="3300735">(</span><span class="ident" id="3300736">t</span>&nbsp;<span class="op" id="3300738">*</span><span class="ident" id="3300739">Tree</span><span class="op" id="3300743">)</span>&nbsp;<span class="ident" id="3300745">errorf</span><span class="op" id="3300751">(</span><span class="ident" id="3300752">format</span>&nbsp;<span class="builtintype" id="3300759">string</span><span class="op" id="3300765">,</span>&nbsp;<span class="ident" id="3300767">args</span>&nbsp;<span class="op" id="3300772">...</span><span class="keyword" id="3300775">interface</span><span class="op" id="3300784">{</span><span class="op" id="3300785">}</span><span class="op" id="3300786">)</span>&nbsp;<span class="op" id="3300788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300791">t</span><span class="op" id="3300792">.</span><span class="ident" id="3300793">Root</span>&nbsp;<span class="op" id="3300798">=</span>&nbsp;<span class="ident" id="3300800">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300805">format</span>&nbsp;<span class="op" id="3300812">=</span>&nbsp;<span class="ident" id="3300814">fmt</span><span class="op" id="3300817">.</span><span class="ident" id="3300818">Sprintf</span><span class="op" id="3300825">(</span><span class="string" id="3300826">&#34;template:&nbsp;%s:%d:&nbsp;%s&#34;</span><span class="op" id="3300847">,</span>&nbsp;<span class="ident" id="3300849">t</span><span class="op" id="3300850">.</span><span class="ident" id="3300851">ParseName</span><span class="op" id="3300860">,</span>&nbsp;<span class="ident" id="3300862">t</span><span class="op" id="3300863">.</span><span class="ident" id="3300864">lex</span><span class="op" id="3300867">.</span><span class="ident" id="3300868">lineNumber</span><span class="op" id="3300878">(</span><span class="op" id="3300879">)</span><span class="op" id="3300880">,</span>&nbsp;<span class="ident" id="3300882">format</span><span class="op" id="3300888">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3300891">panic</span><span class="op" id="3300896">(</span><span class="ident" id="3300897">fmt</span><span class="op" id="3300900">.</span><span class="ident" id="3300901">Errorf</span><span class="op" id="3300907">(</span><span class="ident" id="3300908">format</span><span class="op" id="3300914">,</span>&nbsp;<span class="ident" id="3300916">args</span><span class="op" id="3300920">...</span><span class="op" id="3300923">)</span><span class="op" id="3300924">)</span><br>
<span class="lineno"></span><span class="op" id="3300926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3300929">//&nbsp;error&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3300961">func</span>&nbsp;<span class="op" id="3300966">(</span><span class="ident" id="3300967">t</span>&nbsp;<span class="op" id="3300969">*</span><span class="ident" id="3300970">Tree</span><span class="op" id="3300974">)</span>&nbsp;<span class="builtintype" id="3300976">error</span><span class="op" id="3300981">(</span><span class="ident" id="3300982">err</span>&nbsp;<span class="builtintype" id="3300986">error</span><span class="op" id="3300991">)</span>&nbsp;<span class="op" id="3300993">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300996">t</span><span class="op" id="3300997">.</span><span class="ident" id="3300998">errorf</span><span class="op" id="3301004">(</span><span class="string" id="3301005">&#34;%s&#34;</span><span class="op" id="3301009">,</span>&nbsp;<span class="ident" id="3301011">err</span><span class="op" id="3301014">)</span><br>
<span class="lineno"></span><span class="op" id="3301016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3301019">//&nbsp;expect&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;the&nbsp;required&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3301094">func</span>&nbsp;<span class="op" id="3301099">(</span><span class="ident" id="3301100">t</span>&nbsp;<span class="op" id="3301102">*</span><span class="ident" id="3301103">Tree</span><span class="op" id="3301107">)</span>&nbsp;<span class="ident" id="3301109">expect</span><span class="op" id="3301115">(</span><span class="ident" id="3301116">expected</span>&nbsp;<span class="ident" id="3301125">itemType</span><span class="op" id="3301133">,</span>&nbsp;<span class="ident" id="3301135">context</span>&nbsp;<span class="builtintype" id="3301143">string</span><span class="op" id="3301149">)</span>&nbsp;<span class="ident" id="3301151">item</span>&nbsp;<span class="op" id="3301156">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301159">token</span>&nbsp;<span class="op" id="3301165">:=</span>&nbsp;<span class="ident" id="3301168">t</span><span class="op" id="3301169">.</span><span class="ident" id="3301170">nextNonSpace</span><span class="op" id="3301182">(</span><span class="op" id="3301183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301186">if</span>&nbsp;<span class="ident" id="3301189">token</span><span class="op" id="3301194">.</span><span class="ident" id="3301195">typ</span>&nbsp;<span class="op" id="3301199">!=</span>&nbsp;<span class="ident" id="3301202">expected</span>&nbsp;<span class="op" id="3301211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301215">t</span><span class="op" id="3301216">.</span><span class="ident" id="3301217">unexpected</span><span class="op" id="3301227">(</span><span class="ident" id="3301228">token</span><span class="op" id="3301233">,</span>&nbsp;<span class="ident" id="3301235">context</span><span class="op" id="3301242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3301245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301248">return</span>&nbsp;<span class="ident" id="3301255">token</span><br>
<span class="lineno">175</span><span class="op" id="3301261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3301264">//&nbsp;expectOneOf&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;one&nbsp;of&nbsp;the&nbsp;required&nbsp;types.</span><br>
<span class="lineno"></span><span class="keyword" id="3301352">func</span>&nbsp;<span class="op" id="3301357">(</span><span class="ident" id="3301358">t</span>&nbsp;<span class="op" id="3301360">*</span><span class="ident" id="3301361">Tree</span><span class="op" id="3301365">)</span>&nbsp;<span class="ident" id="3301367">expectOneOf</span><span class="op" id="3301378">(</span><span class="ident" id="3301379">expected1</span><span class="op" id="3301388">,</span>&nbsp;<span class="ident" id="3301390">expected2</span>&nbsp;<span class="ident" id="3301400">itemType</span><span class="op" id="3301408">,</span>&nbsp;<span class="ident" id="3301410">context</span>&nbsp;<span class="builtintype" id="3301418">string</span><span class="op" id="3301424">)</span>&nbsp;<span class="ident" id="3301426">item</span>&nbsp;<span class="op" id="3301431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301434">token</span>&nbsp;<span class="op" id="3301440">:=</span>&nbsp;<span class="ident" id="3301443">t</span><span class="op" id="3301444">.</span><span class="ident" id="3301445">nextNonSpace</span><span class="op" id="3301457">(</span><span class="op" id="3301458">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301461">if</span>&nbsp;<span class="ident" id="3301464">token</span><span class="op" id="3301469">.</span><span class="ident" id="3301470">typ</span>&nbsp;<span class="op" id="3301474">!=</span>&nbsp;<span class="ident" id="3301477">expected1</span>&nbsp;<span class="op" id="3301487">&amp;&amp;</span>&nbsp;<span class="ident" id="3301490">token</span><span class="op" id="3301495">.</span><span class="ident" id="3301496">typ</span>&nbsp;<span class="op" id="3301500">!=</span>&nbsp;<span class="ident" id="3301503">expected2</span>&nbsp;<span class="op" id="3301513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301517">t</span><span class="op" id="3301518">.</span><span class="ident" id="3301519">unexpected</span><span class="op" id="3301529">(</span><span class="ident" id="3301530">token</span><span class="op" id="3301535">,</span>&nbsp;<span class="ident" id="3301537">context</span><span class="op" id="3301544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3301547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301550">return</span>&nbsp;<span class="ident" id="3301557">token</span><br>
<span class="lineno"></span><span class="op" id="3301563">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="comment" id="3301566">//&nbsp;unexpected&nbsp;complains&nbsp;about&nbsp;the&nbsp;token&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3301633">func</span>&nbsp;<span class="op" id="3301638">(</span><span class="ident" id="3301639">t</span>&nbsp;<span class="op" id="3301641">*</span><span class="ident" id="3301642">Tree</span><span class="op" id="3301646">)</span>&nbsp;<span class="ident" id="3301648">unexpected</span><span class="op" id="3301658">(</span><span class="ident" id="3301659">token</span>&nbsp;<span class="ident" id="3301665">item</span><span class="op" id="3301669">,</span>&nbsp;<span class="ident" id="3301671">context</span>&nbsp;<span class="builtintype" id="3301679">string</span><span class="op" id="3301685">)</span>&nbsp;<span class="op" id="3301687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301690">t</span><span class="op" id="3301691">.</span><span class="ident" id="3301692">errorf</span><span class="op" id="3301698">(</span><span class="string" id="3301699">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3301720">,</span>&nbsp;<span class="ident" id="3301722">token</span><span class="op" id="3301727">,</span>&nbsp;<span class="ident" id="3301729">context</span><span class="op" id="3301736">)</span><br>
<span class="lineno"></span><span class="op" id="3301738">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3301741">//&nbsp;recover&nbsp;is&nbsp;the&nbsp;handler&nbsp;that&nbsp;turns&nbsp;panics&nbsp;into&nbsp;returns&nbsp;from&nbsp;the&nbsp;top&nbsp;level&nbsp;of&nbsp;Parse.</span><br>
<span class="lineno"></span><span class="keyword" id="3301827">func</span>&nbsp;<span class="op" id="3301832">(</span><span class="ident" id="3301833">t</span>&nbsp;<span class="op" id="3301835">*</span><span class="ident" id="3301836">Tree</span><span class="op" id="3301840">)</span>&nbsp;<span class="builtinfunc" id="3301842">recover</span><span class="op" id="3301849">(</span><span class="ident" id="3301850">errp</span>&nbsp;<span class="op" id="3301855">*</span><span class="builtintype" id="3301856">error</span><span class="op" id="3301861">)</span>&nbsp;<span class="op" id="3301863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301866">e</span>&nbsp;<span class="op" id="3301868">:=</span>&nbsp;<span class="builtinfunc" id="3301871">recover</span><span class="op" id="3301878">(</span><span class="op" id="3301879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301882">if</span>&nbsp;<span class="ident" id="3301885">e</span>&nbsp;<span class="op" id="3301887">!=</span>&nbsp;<span class="ident" id="3301890">nil</span>&nbsp;<span class="op" id="3301894">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301898">if</span>&nbsp;<span class="ident" id="3301901">_</span><span class="op" id="3301902">,</span>&nbsp;<span class="ident" id="3301904">ok</span>&nbsp;<span class="op" id="3301907">:=</span>&nbsp;<span class="ident" id="3301910">e</span><span class="op" id="3301911">.</span><span class="op" id="3301912">(</span><span class="ident" id="3301913">runtime</span><span class="op" id="3301920">.</span><span class="ident" id="3301921">Error</span><span class="op" id="3301926">)</span><span class="op" id="3301927">;</span>&nbsp;<span class="ident" id="3301929">ok</span>&nbsp;<span class="op" id="3301932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3301937">panic</span><span class="op" id="3301942">(</span><span class="ident" id="3301943">e</span><span class="op" id="3301944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3301948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301952">if</span>&nbsp;<span class="ident" id="3301955">t</span>&nbsp;<span class="op" id="3301957">!=</span>&nbsp;<span class="ident" id="3301960">nil</span>&nbsp;<span class="op" id="3301964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301969">t</span><span class="op" id="3301970">.</span><span class="ident" id="3301971">stopParse</span><span class="op" id="3301980">(</span><span class="op" id="3301981">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3301985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3301989">*</span><span class="ident" id="3301990">errp</span>&nbsp;<span class="op" id="3301995">=</span>&nbsp;<span class="ident" id="3301997">e</span><span class="op" id="3301998">.</span><span class="op" id="3301999">(</span><span class="builtintype" id="3302000">error</span><span class="op" id="3302005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3302008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302011">return</span><br>
<span class="lineno"></span><span class="op" id="3302018">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="3302021">//&nbsp;startParse&nbsp;initializes&nbsp;the&nbsp;parser,&nbsp;using&nbsp;the&nbsp;lexer.</span><br>
<span class="lineno"></span><span class="keyword" id="3302076">func</span>&nbsp;<span class="op" id="3302081">(</span><span class="ident" id="3302082">t</span>&nbsp;<span class="op" id="3302084">*</span><span class="ident" id="3302085">Tree</span><span class="op" id="3302089">)</span>&nbsp;<span class="ident" id="3302091">startParse</span><span class="op" id="3302101">(</span><span class="ident" id="3302102">funcs</span>&nbsp;<span class="op" id="3302108">[</span><span class="op" id="3302109">]</span><span class="keyword" id="3302110">map</span><span class="op" id="3302113">[</span><span class="builtintype" id="3302114">string</span><span class="op" id="3302120">]</span><span class="keyword" id="3302121">interface</span><span class="op" id="3302130">{</span><span class="op" id="3302131">}</span><span class="op" id="3302132">,</span>&nbsp;<span class="ident" id="3302134">lex</span>&nbsp;<span class="op" id="3302138">*</span><span class="ident" id="3302139">lexer</span><span class="op" id="3302144">)</span>&nbsp;<span class="op" id="3302146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302149">t</span><span class="op" id="3302150">.</span><span class="ident" id="3302151">Root</span>&nbsp;<span class="op" id="3302156">=</span>&nbsp;<span class="ident" id="3302158">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302163">t</span><span class="op" id="3302164">.</span><span class="ident" id="3302165">lex</span>&nbsp;<span class="op" id="3302169">=</span>&nbsp;<span class="ident" id="3302171">lex</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302176">t</span><span class="op" id="3302177">.</span><span class="ident" id="3302178">vars</span>&nbsp;<span class="op" id="3302183">=</span>&nbsp;<span class="op" id="3302185">[</span><span class="op" id="3302186">]</span><span class="builtintype" id="3302187">string</span><span class="op" id="3302193">{</span><span class="string" id="3302194">&#34;$&#34;</span><span class="op" id="3302197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302200">t</span><span class="op" id="3302201">.</span><span class="ident" id="3302202">funcs</span>&nbsp;<span class="op" id="3302208">=</span>&nbsp;<span class="ident" id="3302210">funcs</span><br>
<span class="lineno"></span><span class="op" id="3302216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3302219">//&nbsp;stopParse&nbsp;terminates&nbsp;parsing.</span><br>
<span class="lineno">215</span><span class="keyword" id="3302252">func</span>&nbsp;<span class="op" id="3302257">(</span><span class="ident" id="3302258">t</span>&nbsp;<span class="op" id="3302260">*</span><span class="ident" id="3302261">Tree</span><span class="op" id="3302265">)</span>&nbsp;<span class="ident" id="3302267">stopParse</span><span class="op" id="3302276">(</span><span class="op" id="3302277">)</span>&nbsp;<span class="op" id="3302279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302282">t</span><span class="op" id="3302283">.</span><span class="ident" id="3302284">lex</span>&nbsp;<span class="op" id="3302288">=</span>&nbsp;<span class="ident" id="3302290">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302295">t</span><span class="op" id="3302296">.</span><span class="ident" id="3302297">vars</span>&nbsp;<span class="op" id="3302302">=</span>&nbsp;<span class="ident" id="3302304">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302309">t</span><span class="op" id="3302310">.</span><span class="ident" id="3302311">funcs</span>&nbsp;<span class="op" id="3302317">=</span>&nbsp;<span class="ident" id="3302319">nil</span><br>
<span class="lineno"></span><span class="op" id="3302323">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3302326">//&nbsp;Parse&nbsp;parses&nbsp;the&nbsp;template&nbsp;definition&nbsp;string&nbsp;to&nbsp;construct&nbsp;a&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3302406">//&nbsp;the&nbsp;template&nbsp;for&nbsp;execution.&nbsp;If&nbsp;either&nbsp;action&nbsp;delimiter&nbsp;string&nbsp;is&nbsp;empty,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3302485">//&nbsp;default&nbsp;(&#34;{{&#34;&nbsp;or&nbsp;&#34;}}&#34;)&nbsp;is&nbsp;used.&nbsp;Embedded&nbsp;template&nbsp;definitions&nbsp;are&nbsp;added&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3302563">//&nbsp;the&nbsp;treeSet&nbsp;map.</span><br>
<span class="lineno">225</span><span class="keyword" id="3302583">func</span>&nbsp;<span class="op" id="3302588">(</span><span class="ident" id="3302589">t</span>&nbsp;<span class="op" id="3302591">*</span><span class="ident" id="3302592">Tree</span><span class="op" id="3302596">)</span>&nbsp;<span class="ident" id="3302598">Parse</span><span class="op" id="3302603">(</span><span class="ident" id="3302604">text</span><span class="op" id="3302608">,</span>&nbsp;<span class="ident" id="3302610">leftDelim</span><span class="op" id="3302619">,</span>&nbsp;<span class="ident" id="3302621">rightDelim</span>&nbsp;<span class="builtintype" id="3302632">string</span><span class="op" id="3302638">,</span>&nbsp;<span class="ident" id="3302640">treeSet</span>&nbsp;<span class="keyword" id="3302648">map</span><span class="op" id="3302651">[</span><span class="builtintype" id="3302652">string</span><span class="op" id="3302658">]</span><span class="op" id="3302659">*</span><span class="ident" id="3302660">Tree</span><span class="op" id="3302664">,</span>&nbsp;<span class="ident" id="3302666">funcs</span>&nbsp;<span class="op" id="3302672">...</span><span class="keyword" id="3302675">map</span><span class="op" id="3302678">[</span><span class="builtintype" id="3302679">string</span><span class="op" id="3302685">]</span><span class="keyword" id="3302686">interface</span><span class="op" id="3302695">{</span><span class="op" id="3302696">}</span><span class="op" id="3302697">)</span>&nbsp;<span class="op" id="3302699">(</span><span class="ident" id="3302700">tree</span>&nbsp;<span class="op" id="3302705">*</span><span class="ident" id="3302706">Tree</span><span class="op" id="3302710">,</span>&nbsp;<span class="ident" id="3302712">err</span>&nbsp;<span class="builtintype" id="3302716">error</span><span class="op" id="3302721">)</span>&nbsp;<span class="op" id="3302723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302726">defer</span>&nbsp;<span class="ident" id="3302732">t</span><span class="op" id="3302733">.</span><span class="builtinfunc" id="3302734">recover</span><span class="op" id="3302741">(</span><span class="op" id="3302742">&amp;</span><span class="ident" id="3302743">err</span><span class="op" id="3302746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302749">t</span><span class="op" id="3302750">.</span><span class="ident" id="3302751">ParseName</span>&nbsp;<span class="op" id="3302761">=</span>&nbsp;<span class="ident" id="3302763">t</span><span class="op" id="3302764">.</span><span class="ident" id="3302765">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302771">t</span><span class="op" id="3302772">.</span><span class="ident" id="3302773">startParse</span><span class="op" id="3302783">(</span><span class="ident" id="3302784">funcs</span><span class="op" id="3302789">,</span>&nbsp;<span class="ident" id="3302791">lex</span><span class="op" id="3302794">(</span><span class="ident" id="3302795">t</span><span class="op" id="3302796">.</span><span class="ident" id="3302797">Name</span><span class="op" id="3302801">,</span>&nbsp;<span class="ident" id="3302803">text</span><span class="op" id="3302807">,</span>&nbsp;<span class="ident" id="3302809">leftDelim</span><span class="op" id="3302818">,</span>&nbsp;<span class="ident" id="3302820">rightDelim</span><span class="op" id="3302830">)</span><span class="op" id="3302831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302834">t</span><span class="op" id="3302835">.</span><span class="ident" id="3302836">text</span>&nbsp;<span class="op" id="3302841">=</span>&nbsp;<span class="ident" id="3302843">text</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302849">t</span><span class="op" id="3302850">.</span><span class="ident" id="3302851">parse</span><span class="op" id="3302856">(</span><span class="ident" id="3302857">treeSet</span><span class="op" id="3302864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302867">t</span><span class="op" id="3302868">.</span><span class="ident" id="3302869">add</span><span class="op" id="3302872">(</span><span class="ident" id="3302873">treeSet</span><span class="op" id="3302880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302883">t</span><span class="op" id="3302884">.</span><span class="ident" id="3302885">stopParse</span><span class="op" id="3302894">(</span><span class="op" id="3302895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3302898">return</span>&nbsp;<span class="ident" id="3302905">t</span><span class="op" id="3302906">,</span>&nbsp;<span class="ident" id="3302908">nil</span><br>
<span class="lineno"></span><span class="op" id="3302912">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="3302915">//&nbsp;add&nbsp;adds&nbsp;tree&nbsp;to&nbsp;the&nbsp;treeSet.</span><br>
<span class="lineno"></span><span class="keyword" id="3302948">func</span>&nbsp;<span class="op" id="3302953">(</span><span class="ident" id="3302954">t</span>&nbsp;<span class="op" id="3302956">*</span><span class="ident" id="3302957">Tree</span><span class="op" id="3302961">)</span>&nbsp;<span class="ident" id="3302963">add</span><span class="op" id="3302966">(</span><span class="ident" id="3302967">treeSet</span>&nbsp;<span class="keyword" id="3302975">map</span><span class="op" id="3302978">[</span><span class="builtintype" id="3302979">string</span><span class="op" id="3302985">]</span><span class="op" id="3302986">*</span><span class="ident" id="3302987">Tree</span><span class="op" id="3302991">)</span>&nbsp;<span class="op" id="3302993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3302996">tree</span>&nbsp;<span class="op" id="3303001">:=</span>&nbsp;<span class="ident" id="3303004">treeSet</span><span class="op" id="3303011">[</span><span class="ident" id="3303012">t</span><span class="op" id="3303013">.</span><span class="ident" id="3303014">Name</span><span class="op" id="3303018">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303021">if</span>&nbsp;<span class="ident" id="3303024">tree</span>&nbsp;<span class="op" id="3303029">==</span>&nbsp;<span class="ident" id="3303032">nil</span>&nbsp;<span class="op" id="3303036">||</span>&nbsp;<span class="ident" id="3303039">IsEmptyTree</span><span class="op" id="3303050">(</span><span class="ident" id="3303051">tree</span><span class="op" id="3303055">.</span><span class="ident" id="3303056">Root</span><span class="op" id="3303060">)</span>&nbsp;<span class="op" id="3303062">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3303066">treeSet</span><span class="op" id="3303073">[</span><span class="ident" id="3303074">t</span><span class="op" id="3303075">.</span><span class="ident" id="3303076">Name</span><span class="op" id="3303080">]</span>&nbsp;<span class="op" id="3303082">=</span>&nbsp;<span class="ident" id="3303084">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303088">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3303096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303099">if</span>&nbsp;<span class="op" id="3303102">!</span><span class="ident" id="3303103">IsEmptyTree</span><span class="op" id="3303114">(</span><span class="ident" id="3303115">t</span><span class="op" id="3303116">.</span><span class="ident" id="3303117">Root</span><span class="op" id="3303121">)</span>&nbsp;<span class="op" id="3303123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3303127">t</span><span class="op" id="3303128">.</span><span class="ident" id="3303129">errorf</span><span class="op" id="3303135">(</span><span class="string" id="3303136">&#34;template:&nbsp;multiple&nbsp;definition&nbsp;of&nbsp;template&nbsp;%q&#34;</span><span class="op" id="3303182">,</span>&nbsp;<span class="ident" id="3303184">t</span><span class="op" id="3303185">.</span><span class="ident" id="3303186">Name</span><span class="op" id="3303190">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3303193">}</span><br>
<span class="lineno"></span><span class="op" id="3303195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3303198">//&nbsp;IsEmptyTree&nbsp;reports&nbsp;whether&nbsp;this&nbsp;tree&nbsp;(node)&nbsp;is&nbsp;empty&nbsp;of&nbsp;everything&nbsp;but&nbsp;space.</span><br>
<span class="lineno"></span><span class="keyword" id="3303280">func</span>&nbsp;<span class="ident" id="3303285">IsEmptyTree</span><span class="op" id="3303296">(</span><span class="ident" id="3303297">n</span>&nbsp;<span class="ident" id="3303299">Node</span><span class="op" id="3303303">)</span>&nbsp;<span class="builtintype" id="3303305">bool</span>&nbsp;<span class="op" id="3303310">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303313">switch</span>&nbsp;<span class="ident" id="3303320">n</span>&nbsp;<span class="op" id="3303322">:=</span>&nbsp;<span class="ident" id="3303325">n</span><span class="op" id="3303326">.</span><span class="op" id="3303327">(</span><span class="keyword" id="3303328">type</span><span class="op" id="3303332">)</span>&nbsp;<span class="op" id="3303334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303337">case</span>&nbsp;<span class="ident" id="3303342">nil</span><span class="op" id="3303345">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303349">return</span>&nbsp;<span class="builtintype" id="3303356">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303362">case</span>&nbsp;<span class="op" id="3303367">*</span><span class="ident" id="3303368">ActionNode</span><span class="op" id="3303378">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303381">case</span>&nbsp;<span class="op" id="3303386">*</span><span class="ident" id="3303387">IfNode</span><span class="op" id="3303393">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303396">case</span>&nbsp;<span class="op" id="3303401">*</span><span class="ident" id="3303402">ListNode</span><span class="op" id="3303410">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303414">for</span>&nbsp;<span class="ident" id="3303418">_</span><span class="op" id="3303419">,</span>&nbsp;<span class="ident" id="3303421">node</span>&nbsp;<span class="op" id="3303426">:=</span>&nbsp;<span class="keyword" id="3303429">range</span>&nbsp;<span class="ident" id="3303435">n</span><span class="op" id="3303436">.</span><span class="ident" id="3303437">Nodes</span>&nbsp;<span class="op" id="3303443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303448">if</span>&nbsp;<span class="op" id="3303451">!</span><span class="ident" id="3303452">IsEmptyTree</span><span class="op" id="3303463">(</span><span class="ident" id="3303464">node</span><span class="op" id="3303468">)</span>&nbsp;<span class="op" id="3303470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303476">return</span>&nbsp;<span class="builtintype" id="3303483">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3303492">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3303496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303500">return</span>&nbsp;<span class="builtintype" id="3303507">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303513">case</span>&nbsp;<span class="op" id="3303518">*</span><span class="ident" id="3303519">RangeNode</span><span class="op" id="3303528">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303531">case</span>&nbsp;<span class="op" id="3303536">*</span><span class="ident" id="3303537">TemplateNode</span><span class="op" id="3303549">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303552">case</span>&nbsp;<span class="op" id="3303557">*</span><span class="ident" id="3303558">TextNode</span><span class="op" id="3303566">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303570">return</span>&nbsp;<span class="builtinfunc" id="3303577">len</span><span class="op" id="3303580">(</span><span class="ident" id="3303581">bytes</span><span class="op" id="3303586">.</span><span class="ident" id="3303587">TrimSpace</span><span class="op" id="3303596">(</span><span class="ident" id="3303597">n</span><span class="op" id="3303598">.</span><span class="ident" id="3303599">Text</span><span class="op" id="3303603">)</span><span class="op" id="3303604">)</span>&nbsp;<span class="op" id="3303606">==</span>&nbsp;<span class="num" id="3303609">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303612">case</span>&nbsp;<span class="op" id="3303617">*</span><span class="ident" id="3303618">WithNode</span><span class="op" id="3303626">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303629">default</span><span class="op" id="3303636">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3303640">panic</span><span class="op" id="3303645">(</span><span class="string" id="3303646">&#34;unknown&nbsp;node:&nbsp;&#34;</span>&nbsp;<span class="op" id="3303663">+</span>&nbsp;<span class="ident" id="3303665">n</span><span class="op" id="3303666">.</span><span class="ident" id="3303667">String</span><span class="op" id="3303673">(</span><span class="op" id="3303674">)</span><span class="op" id="3303675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3303678">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303681">return</span>&nbsp;<span class="builtintype" id="3303688">false</span><br>
<span class="lineno"></span><span class="op" id="3303694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3303697">//&nbsp;parse&nbsp;is&nbsp;the&nbsp;top-level&nbsp;parser&nbsp;for&nbsp;a&nbsp;template,&nbsp;essentially&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3303767">//&nbsp;as&nbsp;itemList&nbsp;except&nbsp;it&nbsp;also&nbsp;parses&nbsp;{{define}}&nbsp;actions.</span><br>
<span class="lineno">275</span><span class="comment" id="3303824">//&nbsp;It&nbsp;runs&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="3303843">func</span>&nbsp;<span class="op" id="3303848">(</span><span class="ident" id="3303849">t</span>&nbsp;<span class="op" id="3303851">*</span><span class="ident" id="3303852">Tree</span><span class="op" id="3303856">)</span>&nbsp;<span class="ident" id="3303858">parse</span><span class="op" id="3303863">(</span><span class="ident" id="3303864">treeSet</span>&nbsp;<span class="keyword" id="3303872">map</span><span class="op" id="3303875">[</span><span class="builtintype" id="3303876">string</span><span class="op" id="3303882">]</span><span class="op" id="3303883">*</span><span class="ident" id="3303884">Tree</span><span class="op" id="3303888">)</span>&nbsp;<span class="op" id="3303890">(</span><span class="ident" id="3303891">next</span>&nbsp;<span class="ident" id="3303896">Node</span><span class="op" id="3303900">)</span>&nbsp;<span class="op" id="3303902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3303905">t</span><span class="op" id="3303906">.</span><span class="ident" id="3303907">Root</span>&nbsp;<span class="op" id="3303912">=</span>&nbsp;<span class="ident" id="3303914">t</span><span class="op" id="3303915">.</span><span class="ident" id="3303916">newList</span><span class="op" id="3303923">(</span><span class="ident" id="3303924">t</span><span class="op" id="3303925">.</span><span class="ident" id="3303926">peek</span><span class="op" id="3303930">(</span><span class="op" id="3303931">)</span><span class="op" id="3303932">.</span><span class="ident" id="3303933">pos</span><span class="op" id="3303936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303939">for</span>&nbsp;<span class="ident" id="3303943">t</span><span class="op" id="3303944">.</span><span class="ident" id="3303945">peek</span><span class="op" id="3303949">(</span><span class="op" id="3303950">)</span><span class="op" id="3303951">.</span><span class="ident" id="3303952">typ</span>&nbsp;<span class="op" id="3303956">!=</span>&nbsp;<span class="ident" id="3303959">itemEOF</span>&nbsp;<span class="op" id="3303967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3303971">if</span>&nbsp;<span class="ident" id="3303974">t</span><span class="op" id="3303975">.</span><span class="ident" id="3303976">peek</span><span class="op" id="3303980">(</span><span class="op" id="3303981">)</span><span class="op" id="3303982">.</span><span class="ident" id="3303983">typ</span>&nbsp;<span class="op" id="3303987">==</span>&nbsp;<span class="ident" id="3303990">itemLeftDelim</span>&nbsp;<span class="op" id="3304004">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304009">delim</span>&nbsp;<span class="op" id="3304015">:=</span>&nbsp;<span class="ident" id="3304018">t</span><span class="op" id="3304019">.</span><span class="ident" id="3304020">next</span><span class="op" id="3304024">(</span><span class="op" id="3304025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3304030">if</span>&nbsp;<span class="ident" id="3304033">t</span><span class="op" id="3304034">.</span><span class="ident" id="3304035">nextNonSpace</span><span class="op" id="3304047">(</span><span class="op" id="3304048">)</span><span class="op" id="3304049">.</span><span class="ident" id="3304050">typ</span>&nbsp;<span class="op" id="3304054">==</span>&nbsp;<span class="ident" id="3304057">itemDefine</span>&nbsp;<span class="op" id="3304068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304074">newT</span>&nbsp;<span class="op" id="3304079">:=</span>&nbsp;<span class="ident" id="3304082">New</span><span class="op" id="3304085">(</span><span class="string" id="3304086">&#34;definition&#34;</span><span class="op" id="3304098">)</span>&nbsp;<span class="comment" id="3304100">//&nbsp;name&nbsp;will&nbsp;be&nbsp;updated&nbsp;once&nbsp;we&nbsp;know&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304145">newT</span><span class="op" id="3304149">.</span><span class="ident" id="3304150">text</span>&nbsp;<span class="op" id="3304155">=</span>&nbsp;<span class="ident" id="3304157">t</span><span class="op" id="3304158">.</span><span class="ident" id="3304159">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304168">newT</span><span class="op" id="3304172">.</span><span class="ident" id="3304173">ParseName</span>&nbsp;<span class="op" id="3304183">=</span>&nbsp;<span class="ident" id="3304185">t</span><span class="op" id="3304186">.</span><span class="ident" id="3304187">ParseName</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304201">newT</span><span class="op" id="3304205">.</span><span class="ident" id="3304206">startParse</span><span class="op" id="3304216">(</span><span class="ident" id="3304217">t</span><span class="op" id="3304218">.</span><span class="ident" id="3304219">funcs</span><span class="op" id="3304224">,</span>&nbsp;<span class="ident" id="3304226">t</span><span class="op" id="3304227">.</span><span class="ident" id="3304228">lex</span><span class="op" id="3304231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304237">newT</span><span class="op" id="3304241">.</span><span class="ident" id="3304242">parseDefinition</span><span class="op" id="3304257">(</span><span class="ident" id="3304258">treeSet</span><span class="op" id="3304265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3304271">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3304283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304288">t</span><span class="op" id="3304289">.</span><span class="ident" id="3304290">backup2</span><span class="op" id="3304297">(</span><span class="ident" id="3304298">delim</span><span class="op" id="3304303">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3304307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304311">n</span>&nbsp;<span class="op" id="3304313">:=</span>&nbsp;<span class="ident" id="3304316">t</span><span class="op" id="3304317">.</span><span class="ident" id="3304318">textOrAction</span><span class="op" id="3304330">(</span><span class="op" id="3304331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3304335">if</span>&nbsp;<span class="ident" id="3304338">n</span><span class="op" id="3304339">.</span><span class="ident" id="3304340">Type</span><span class="op" id="3304344">(</span><span class="op" id="3304345">)</span>&nbsp;<span class="op" id="3304347">==</span>&nbsp;<span class="ident" id="3304350">nodeEnd</span>&nbsp;<span class="op" id="3304358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304363">t</span><span class="op" id="3304364">.</span><span class="ident" id="3304365">errorf</span><span class="op" id="3304371">(</span><span class="string" id="3304372">&#34;unexpected&nbsp;%s&#34;</span><span class="op" id="3304387">,</span>&nbsp;<span class="ident" id="3304389">n</span><span class="op" id="3304390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3304394">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304398">t</span><span class="op" id="3304399">.</span><span class="ident" id="3304400">Root</span><span class="op" id="3304404">.</span><span class="builtinfunc" id="3304405">append</span><span class="op" id="3304411">(</span><span class="ident" id="3304412">n</span><span class="op" id="3304413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3304416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3304419">return</span>&nbsp;<span class="ident" id="3304426">nil</span><br>
<span class="lineno"></span><span class="op" id="3304430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="3304433">//&nbsp;parseDefinition&nbsp;parses&nbsp;a&nbsp;{{define}}&nbsp;...&nbsp;&nbsp;{{end}}&nbsp;template&nbsp;definition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3304509">//&nbsp;installs&nbsp;the&nbsp;definition&nbsp;in&nbsp;the&nbsp;treeSet&nbsp;map.&nbsp;&nbsp;The&nbsp;&#34;define&#34;&nbsp;keyword&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="3304590">//&nbsp;been&nbsp;scanned.</span><br>
<span class="lineno"></span><span class="keyword" id="3304607">func</span>&nbsp;<span class="op" id="3304612">(</span><span class="ident" id="3304613">t</span>&nbsp;<span class="op" id="3304615">*</span><span class="ident" id="3304616">Tree</span><span class="op" id="3304620">)</span>&nbsp;<span class="ident" id="3304622">parseDefinition</span><span class="op" id="3304637">(</span><span class="ident" id="3304638">treeSet</span>&nbsp;<span class="keyword" id="3304646">map</span><span class="op" id="3304649">[</span><span class="builtintype" id="3304650">string</span><span class="op" id="3304656">]</span><span class="op" id="3304657">*</span><span class="ident" id="3304658">Tree</span><span class="op" id="3304662">)</span>&nbsp;<span class="op" id="3304664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3304667">const</span>&nbsp;<span class="ident" id="3304673">context</span>&nbsp;<span class="op" id="3304681">=</span>&nbsp;<span class="string" id="3304683">&#34;define&nbsp;clause&#34;</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304700">name</span>&nbsp;<span class="op" id="3304705">:=</span>&nbsp;<span class="ident" id="3304708">t</span><span class="op" id="3304709">.</span><span class="ident" id="3304710">expectOneOf</span><span class="op" id="3304721">(</span><span class="ident" id="3304722">itemString</span><span class="op" id="3304732">,</span>&nbsp;<span class="ident" id="3304734">itemRawString</span><span class="op" id="3304747">,</span>&nbsp;<span class="ident" id="3304749">context</span><span class="op" id="3304756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3304759">var</span>&nbsp;<span class="ident" id="3304763">err</span>&nbsp;<span class="builtintype" id="3304767">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304774">t</span><span class="op" id="3304775">.</span><span class="ident" id="3304776">Name</span><span class="op" id="3304780">,</span>&nbsp;<span class="ident" id="3304782">err</span>&nbsp;<span class="op" id="3304786">=</span>&nbsp;<span class="ident" id="3304788">strconv</span><span class="op" id="3304795">.</span><span class="ident" id="3304796">Unquote</span><span class="op" id="3304803">(</span><span class="ident" id="3304804">name</span><span class="op" id="3304808">.</span><span class="ident" id="3304809">val</span><span class="op" id="3304812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3304815">if</span>&nbsp;<span class="ident" id="3304818">err</span>&nbsp;<span class="op" id="3304822">!=</span>&nbsp;<span class="ident" id="3304825">nil</span>&nbsp;<span class="op" id="3304829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304833">t</span><span class="op" id="3304834">.</span><span class="builtintype" id="3304835">error</span><span class="op" id="3304840">(</span><span class="ident" id="3304841">err</span><span class="op" id="3304844">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3304847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304850">t</span><span class="op" id="3304851">.</span><span class="ident" id="3304852">expect</span><span class="op" id="3304858">(</span><span class="ident" id="3304859">itemRightDelim</span><span class="op" id="3304873">,</span>&nbsp;<span class="ident" id="3304875">context</span><span class="op" id="3304882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3304885">var</span>&nbsp;<span class="ident" id="3304889">end</span>&nbsp;<span class="ident" id="3304893">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304899">t</span><span class="op" id="3304900">.</span><span class="ident" id="3304901">Root</span><span class="op" id="3304905">,</span>&nbsp;<span class="ident" id="3304907">end</span>&nbsp;<span class="op" id="3304911">=</span>&nbsp;<span class="ident" id="3304913">t</span><span class="op" id="3304914">.</span><span class="ident" id="3304915">itemList</span><span class="op" id="3304923">(</span><span class="op" id="3304924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3304927">if</span>&nbsp;<span class="ident" id="3304930">end</span><span class="op" id="3304933">.</span><span class="ident" id="3304934">Type</span><span class="op" id="3304938">(</span><span class="op" id="3304939">)</span>&nbsp;<span class="op" id="3304941">!=</span>&nbsp;<span class="ident" id="3304944">nodeEnd</span>&nbsp;<span class="op" id="3304952">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3304956">t</span><span class="op" id="3304957">.</span><span class="ident" id="3304958">errorf</span><span class="op" id="3304964">(</span><span class="string" id="3304965">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3304986">,</span>&nbsp;<span class="ident" id="3304988">end</span><span class="op" id="3304991">,</span>&nbsp;<span class="ident" id="3304993">context</span><span class="op" id="3305000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3305003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3305006">t</span><span class="op" id="3305007">.</span><span class="ident" id="3305008">add</span><span class="op" id="3305011">(</span><span class="ident" id="3305012">treeSet</span><span class="op" id="3305019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3305022">t</span><span class="op" id="3305023">.</span><span class="ident" id="3305024">stopParse</span><span class="op" id="3305033">(</span><span class="op" id="3305034">)</span><br>
<span class="lineno"></span><span class="op" id="3305036">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span><span class="comment" id="3305039">//&nbsp;itemList:</span><br>
<span class="lineno"></span><span class="comment" id="3305052">//&nbsp;&nbsp;&nbsp;&nbsptextOrAction*</span><br>
<span class="lineno"></span><span class="comment" id="3305069">//&nbsp;Terminates&nbsp;at&nbsp;{{end}}&nbsp;or&nbsp;{{else}},&nbsp;returned&nbsp;separately.</span><br>
<span class="lineno"></span><span class="keyword" id="3305128">func</span>&nbsp;<span class="op" id="3305133">(</span><span class="ident" id="3305134">t</span>&nbsp;<span class="op" id="3305136">*</span><span class="ident" id="3305137">Tree</span><span class="op" id="3305141">)</span>&nbsp;<span class="ident" id="3305143">itemList</span><span class="op" id="3305151">(</span><span class="op" id="3305152">)</span>&nbsp;<span class="op" id="3305154">(</span><span class="ident" id="3305155">list</span>&nbsp;<span class="op" id="3305160">*</span><span class="ident" id="3305161">ListNode</span><span class="op" id="3305169">,</span>&nbsp;<span class="ident" id="3305171">next</span>&nbsp;<span class="ident" id="3305176">Node</span><span class="op" id="3305180">)</span>&nbsp;<span class="op" id="3305182">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3305185">list</span>&nbsp;<span class="op" id="3305190">=</span>&nbsp;<span class="ident" id="3305192">t</span><span class="op" id="3305193">.</span><span class="ident" id="3305194">newList</span><span class="op" id="3305201">(</span><span class="ident" id="3305202">t</span><span class="op" id="3305203">.</span><span class="ident" id="3305204">peekNonSpace</span><span class="op" id="3305216">(</span><span class="op" id="3305217">)</span><span class="op" id="3305218">.</span><span class="ident" id="3305219">pos</span><span class="op" id="3305222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305225">for</span>&nbsp;<span class="ident" id="3305229">t</span><span class="op" id="3305230">.</span><span class="ident" id="3305231">peekNonSpace</span><span class="op" id="3305243">(</span><span class="op" id="3305244">)</span><span class="op" id="3305245">.</span><span class="ident" id="3305246">typ</span>&nbsp;<span class="op" id="3305250">!=</span>&nbsp;<span class="ident" id="3305253">itemEOF</span>&nbsp;<span class="op" id="3305261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3305265">n</span>&nbsp;<span class="op" id="3305267">:=</span>&nbsp;<span class="ident" id="3305270">t</span><span class="op" id="3305271">.</span><span class="ident" id="3305272">textOrAction</span><span class="op" id="3305284">(</span><span class="op" id="3305285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305289">switch</span>&nbsp;<span class="ident" id="3305296">n</span><span class="op" id="3305297">.</span><span class="ident" id="3305298">Type</span><span class="op" id="3305302">(</span><span class="op" id="3305303">)</span>&nbsp;<span class="op" id="3305305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305309">case</span>&nbsp;<span class="ident" id="3305314">nodeEnd</span><span class="op" id="3305321">,</span>&nbsp;<span class="ident" id="3305323">nodeElse</span><span class="op" id="3305331">:</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305336">return</span>&nbsp;<span class="ident" id="3305343">list</span><span class="op" id="3305347">,</span>&nbsp;<span class="ident" id="3305349">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3305353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3305357">list</span><span class="op" id="3305361">.</span><span class="builtinfunc" id="3305362">append</span><span class="op" id="3305368">(</span><span class="ident" id="3305369">n</span><span class="op" id="3305370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3305373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3305376">t</span><span class="op" id="3305377">.</span><span class="ident" id="3305378">errorf</span><span class="op" id="3305384">(</span><span class="string" id="3305385">&#34;unexpected&nbsp;EOF&#34;</span><span class="op" id="3305401">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305404">return</span><br>
<span class="lineno"></span><span class="op" id="3305411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3305414">//&nbsp;textOrAction:</span><br>
<span class="lineno"></span><span class="comment" id="3305431">//&nbsp;&nbsp;&nbsp;&nbsptext&nbsp;|&nbsp;action</span><br>
<span class="lineno">340</span><span class="keyword" id="3305448">func</span>&nbsp;<span class="op" id="3305453">(</span><span class="ident" id="3305454">t</span>&nbsp;<span class="op" id="3305456">*</span><span class="ident" id="3305457">Tree</span><span class="op" id="3305461">)</span>&nbsp;<span class="ident" id="3305463">textOrAction</span><span class="op" id="3305475">(</span><span class="op" id="3305476">)</span>&nbsp;<span class="ident" id="3305478">Node</span>&nbsp;<span class="op" id="3305483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305486">switch</span>&nbsp;<span class="ident" id="3305493">token</span>&nbsp;<span class="op" id="3305499">:=</span>&nbsp;<span class="ident" id="3305502">t</span><span class="op" id="3305503">.</span><span class="ident" id="3305504">nextNonSpace</span><span class="op" id="3305516">(</span><span class="op" id="3305517">)</span><span class="op" id="3305518">;</span>&nbsp;<span class="ident" id="3305520">token</span><span class="op" id="3305525">.</span><span class="ident" id="3305526">typ</span>&nbsp;<span class="op" id="3305530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305533">case</span>&nbsp;<span class="ident" id="3305538">itemText</span><span class="op" id="3305546">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305550">return</span>&nbsp;<span class="ident" id="3305557">t</span><span class="op" id="3305558">.</span><span class="ident" id="3305559">newText</span><span class="op" id="3305566">(</span><span class="ident" id="3305567">token</span><span class="op" id="3305572">.</span><span class="ident" id="3305573">pos</span><span class="op" id="3305576">,</span>&nbsp;<span class="ident" id="3305578">token</span><span class="op" id="3305583">.</span><span class="ident" id="3305584">val</span><span class="op" id="3305587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305590">case</span>&nbsp;<span class="ident" id="3305595">itemLeftDelim</span><span class="op" id="3305608">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305612">return</span>&nbsp;<span class="ident" id="3305619">t</span><span class="op" id="3305620">.</span><span class="ident" id="3305621">action</span><span class="op" id="3305627">(</span><span class="op" id="3305628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305631">default</span><span class="op" id="3305638">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3305642">t</span><span class="op" id="3305643">.</span><span class="ident" id="3305644">unexpected</span><span class="op" id="3305654">(</span><span class="ident" id="3305655">token</span><span class="op" id="3305660">,</span>&nbsp;<span class="string" id="3305662">&#34;input&#34;</span><span class="op" id="3305669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3305672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305675">return</span>&nbsp;<span class="ident" id="3305682">nil</span><br>
<span class="lineno">350</span><span class="op" id="3305686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3305689">//&nbsp;Action:</span><br>
<span class="lineno"></span><span class="comment" id="3305700">//&nbsp;&nbsp;&nbsp;&nbspcontrol</span><br>
<span class="lineno"></span><span class="comment" id="3305711">//&nbsp;&nbsp;&nbsp;&nbspcommand&nbsp;(&#34;|&#34;&nbsp;command)*</span><br>
<span class="lineno">355</span><span class="comment" id="3305737">//&nbsp;Left&nbsp;delim&nbsp;is&nbsp;past.&nbsp;Now&nbsp;get&nbsp;actions.</span><br>
<span class="lineno"></span><span class="comment" id="3305777">//&nbsp;First&nbsp;word&nbsp;could&nbsp;be&nbsp;a&nbsp;keyword&nbsp;such&nbsp;as&nbsp;range.</span><br>
<span class="lineno"></span><span class="keyword" id="3305825">func</span>&nbsp;<span class="op" id="3305830">(</span><span class="ident" id="3305831">t</span>&nbsp;<span class="op" id="3305833">*</span><span class="ident" id="3305834">Tree</span><span class="op" id="3305838">)</span>&nbsp;<span class="ident" id="3305840">action</span><span class="op" id="3305846">(</span><span class="op" id="3305847">)</span>&nbsp;<span class="op" id="3305849">(</span><span class="ident" id="3305850">n</span>&nbsp;<span class="ident" id="3305852">Node</span><span class="op" id="3305856">)</span>&nbsp;<span class="op" id="3305858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305861">switch</span>&nbsp;<span class="ident" id="3305868">token</span>&nbsp;<span class="op" id="3305874">:=</span>&nbsp;<span class="ident" id="3305877">t</span><span class="op" id="3305878">.</span><span class="ident" id="3305879">nextNonSpace</span><span class="op" id="3305891">(</span><span class="op" id="3305892">)</span><span class="op" id="3305893">;</span>&nbsp;<span class="ident" id="3305895">token</span><span class="op" id="3305900">.</span><span class="ident" id="3305901">typ</span>&nbsp;<span class="op" id="3305905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305908">case</span>&nbsp;<span class="ident" id="3305913">itemElse</span><span class="op" id="3305921">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305925">return</span>&nbsp;<span class="ident" id="3305932">t</span><span class="op" id="3305933">.</span><span class="ident" id="3305934">elseControl</span><span class="op" id="3305945">(</span><span class="op" id="3305946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305949">case</span>&nbsp;<span class="ident" id="3305954">itemEnd</span><span class="op" id="3305961">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305965">return</span>&nbsp;<span class="ident" id="3305972">t</span><span class="op" id="3305973">.</span><span class="ident" id="3305974">endControl</span><span class="op" id="3305984">(</span><span class="op" id="3305985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3305988">case</span>&nbsp;<span class="ident" id="3305993">itemIf</span><span class="op" id="3305999">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3306003">return</span>&nbsp;<span class="ident" id="3306010">t</span><span class="op" id="3306011">.</span><span class="ident" id="3306012">ifControl</span><span class="op" id="3306021">(</span><span class="op" id="3306022">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3306025">case</span>&nbsp;<span class="ident" id="3306030">itemRange</span><span class="op" id="3306039">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3306043">return</span>&nbsp;<span class="ident" id="3306050">t</span><span class="op" id="3306051">.</span><span class="ident" id="3306052">rangeControl</span><span class="op" id="3306064">(</span><span class="op" id="3306065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3306068">case</span>&nbsp;<span class="ident" id="3306073">itemTemplate</span><span class="op" id="3306085">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3306089">return</span>&nbsp;<span class="ident" id="3306096">t</span><span class="op" id="3306097">.</span><span class="ident" id="3306098">templateControl</span><span class="op" id="3306113">(</span><span class="op" id="3306114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3306117">case</span>&nbsp;<span class="ident" id="3306122">itemWith</span><span class="op" id="3306130">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3306134">return</span>&nbsp;<span class="ident" id="3306141">t</span><span class="op" id="3306142">.</span><span class="ident" id="3306143">withControl</span><span class="op" id="3306154">(</span><span class="op" id="3306155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3306158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3306161">t</span><span class="op" id="3306162">.</span><span class="ident" id="3306163">backup</span><span class="op" id="3306169">(</span><span class="op" id="3306170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3306173">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3306225">return</span>&nbsp;<span class="ident" id="3306232">t</span><span class="op" id="3306233">.</span><span class="ident" id="3306234">newAction</span><span class="op" id="3306243">(</span><span class="ident" id="3306244">t</span><span class="op" id="3306245">.</span><span class="ident" id="3306246">peek</span><span class="op" id="3306250">(</span><span class="op" id="3306251">)</span><span class="op" id="3306252">.</span><span class="ident" id="3306253">pos</span><span class="op" id="3306256">,</span>&nbsp;<span class="ident" id="3306258">t</span><span class="op" id="3306259">.</span><span class="ident" id="3306260">lex</span><span class="op" id="3306263">.</span><span class="ident" id="3306264">lineNumber</span><span class="op" id="3306274">(</span><span class="op" id="3306275">)</span><span class="op" id="3306276">,</span>&nbsp;<span class="ident" id="3306278">t</span><span class="op" id="3306279">.</span><span class="ident" id="3306280">pipeline</span><span class="op" id="3306288">(</span><span class="string" id="3306289">&#34;command&#34;</span><span class="op" id="3306298">)</span><span class="op" id="3306299">)</span><br>
<span class="lineno">375</span><span class="op" id="3306301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3306304">//&nbsp;Pipeline:</span><br>
<span class="lineno"></span><span class="comment" id="3306317">//&nbsp;&nbsp;&nbsp;&nbspdeclarations?&nbsp;command&nbsp;(&#39;|&#39;&nbsp;command)*</span><br>
<span class="lineno"></span><span class="keyword" id="3306357">func</span>&nbsp;<span class="op" id="3306362">(</span><span class="ident" id="3306363">t</span>&nbsp;<span class="op" id="3306365">*</span><span class="ident" id="3306366">Tree</span><span class="op" id="3306370">)</span>&nbsp;<span class="ident" id="3306372">pipeline</span><span class="op" id="3306380">(</span><span class="ident" id="3306381">context</span>&nbsp;<span class="builtintype" id="3306389">string</span><span class="op" id="3306395">)</span>&nbsp;<span class="op" id="3306397">(</span><span class="ident" id="3306398">pipe</span>&nbsp;<span class="op" id="3306403">*</span><span class="ident" id="3306404">PipeNode</span><span class="op" id="3306412">)</span>&nbsp;<span class="op" id="3306414">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3306417">var</span>&nbsp;<span class="ident" id="3306421">decl</span>&nbsp;<span class="op" id="3306426">[</span><span class="op" id="3306427">]</span><span class="op" id="3306428">*</span><span class="ident" id="3306429">VariableNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3306443">pos</span>&nbsp;<span class="op" id="3306447">:=</span>&nbsp;<span class="ident" id="3306450">t</span><span class="op" id="3306451">.</span><span class="ident" id="3306452">peekNonSpace</span><span class="op" id="3306464">(</span><span class="op" id="3306465">)</span><span class="op" id="3306466">.</span><span class="ident" id="3306467">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3306472">//&nbsp;Are&nbsp;there&nbsp;declarations?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3306500">for</span>&nbsp;<span class="op" id="3306504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3306508">if</span>&nbsp;<span class="ident" id="3306511">v</span>&nbsp;<span class="op" id="3306513">:=</span>&nbsp;<span class="ident" id="3306516">t</span><span class="op" id="3306517">.</span><span class="ident" id="3306518">peekNonSpace</span><span class="op" id="3306530">(</span><span class="op" id="3306531">)</span><span class="op" id="3306532">;</span>&nbsp;<span class="ident" id="3306534">v</span><span class="op" id="3306535">.</span><span class="ident" id="3306536">typ</span>&nbsp;<span class="op" id="3306540">==</span>&nbsp;<span class="ident" id="3306543">itemVariable</span>&nbsp;<span class="op" id="3306556">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3306561">t</span><span class="op" id="3306562">.</span><span class="ident" id="3306563">next</span><span class="op" id="3306567">(</span><span class="op" id="3306568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3306573">//&nbsp;Since&nbsp;space&nbsp;is&nbsp;a&nbsp;token,&nbsp;we&nbsp;need&nbsp;3-token&nbsp;look-ahead&nbsp;here&nbsp;in&nbsp;the&nbsp;worst&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3306654">//&nbsp;in&nbsp;&#34;$x&nbsp;foo&#34;&nbsp;we&nbsp;need&nbsp;to&nbsp;read&nbsp;&#34;foo&#34;&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;&#34;:=&#34;)&nbsp;to&nbsp;know&nbsp;that&nbsp;$x&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3306737">//&nbsp;argument&nbsp;variable&nbsp;rather&nbsp;than&nbsp;a&nbsp;declaration.&nbsp;So&nbsp;remember&nbsp;the&nbsp;token</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3306810">//&nbsp;adjacent&nbsp;to&nbsp;the&nbsp;variable&nbsp;so&nbsp;we&nbsp;can&nbsp;push&nbsp;it&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3306878">tokenAfterVariable</span>&nbsp;<span class="op" id="3306897">:=</span>&nbsp;<span class="ident" id="3306900">t</span><span class="op" id="3306901">.</span><span class="ident" id="3306902">peek</span><span class="op" id="3306906">(</span><span class="op" id="3306907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3306912">if</span>&nbsp;<span class="ident" id="3306915">next</span>&nbsp;<span class="op" id="3306920">:=</span>&nbsp;<span class="ident" id="3306923">t</span><span class="op" id="3306924">.</span><span class="ident" id="3306925">peekNonSpace</span><span class="op" id="3306937">(</span><span class="op" id="3306938">)</span><span class="op" id="3306939">;</span>&nbsp;<span class="ident" id="3306941">next</span><span class="op" id="3306945">.</span><span class="ident" id="3306946">typ</span>&nbsp;<span class="op" id="3306950">==</span>&nbsp;<span class="ident" id="3306953">itemColonEquals</span>&nbsp;<span class="op" id="3306969">||</span>&nbsp;<span class="op" id="3306972">(</span><span class="ident" id="3306973">next</span><span class="op" id="3306977">.</span><span class="ident" id="3306978">typ</span>&nbsp;<span class="op" id="3306982">==</span>&nbsp;<span class="ident" id="3306985">itemChar</span>&nbsp;<span class="op" id="3306994">&amp;&amp;</span>&nbsp;<span class="ident" id="3306997">next</span><span class="op" id="3307001">.</span><span class="ident" id="3307002">val</span>&nbsp;<span class="op" id="3307006">==</span>&nbsp;<span class="string" id="3307009">&#34;,&#34;</span><span class="op" id="3307012">)</span>&nbsp;<span class="op" id="3307014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307020">t</span><span class="op" id="3307021">.</span><span class="ident" id="3307022">nextNonSpace</span><span class="op" id="3307034">(</span><span class="op" id="3307035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307041">variable</span>&nbsp;<span class="op" id="3307050">:=</span>&nbsp;<span class="ident" id="3307053">t</span><span class="op" id="3307054">.</span><span class="ident" id="3307055">newVariable</span><span class="op" id="3307066">(</span><span class="ident" id="3307067">v</span><span class="op" id="3307068">.</span><span class="ident" id="3307069">pos</span><span class="op" id="3307072">,</span>&nbsp;<span class="ident" id="3307074">v</span><span class="op" id="3307075">.</span><span class="ident" id="3307076">val</span><span class="op" id="3307079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307085">decl</span>&nbsp;<span class="op" id="3307090">=</span>&nbsp;<span class="builtinfunc" id="3307092">append</span><span class="op" id="3307098">(</span><span class="ident" id="3307099">decl</span><span class="op" id="3307103">,</span>&nbsp;<span class="ident" id="3307105">variable</span><span class="op" id="3307113">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307119">t</span><span class="op" id="3307120">.</span><span class="ident" id="3307121">vars</span>&nbsp;<span class="op" id="3307126">=</span>&nbsp;<span class="builtinfunc" id="3307128">append</span><span class="op" id="3307134">(</span><span class="ident" id="3307135">t</span><span class="op" id="3307136">.</span><span class="ident" id="3307137">vars</span><span class="op" id="3307141">,</span>&nbsp;<span class="ident" id="3307143">v</span><span class="op" id="3307144">.</span><span class="ident" id="3307145">val</span><span class="op" id="3307148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3307154">if</span>&nbsp;<span class="ident" id="3307157">next</span><span class="op" id="3307161">.</span><span class="ident" id="3307162">typ</span>&nbsp;<span class="op" id="3307166">==</span>&nbsp;<span class="ident" id="3307169">itemChar</span>&nbsp;<span class="op" id="3307178">&amp;&amp;</span>&nbsp;<span class="ident" id="3307181">next</span><span class="op" id="3307185">.</span><span class="ident" id="3307186">val</span>&nbsp;<span class="op" id="3307190">==</span>&nbsp;<span class="string" id="3307193">&#34;,&#34;</span>&nbsp;<span class="op" id="3307197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3307204">if</span>&nbsp;<span class="ident" id="3307207">context</span>&nbsp;<span class="op" id="3307215">==</span>&nbsp;<span class="string" id="3307218">&#34;range&#34;</span>&nbsp;<span class="op" id="3307226">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3307229">len</span><span class="op" id="3307232">(</span><span class="ident" id="3307233">decl</span><span class="op" id="3307237">)</span>&nbsp;<span class="op" id="3307239">&lt;</span>&nbsp;<span class="num" id="3307241">2</span>&nbsp;<span class="op" id="3307243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3307251">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3307265">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307272">t</span><span class="op" id="3307273">.</span><span class="ident" id="3307274">errorf</span><span class="op" id="3307280">(</span><span class="string" id="3307281">&#34;too&nbsp;many&nbsp;declarations&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3307310">,</span>&nbsp;<span class="ident" id="3307312">context</span><span class="op" id="3307319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3307325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3307330">}</span>&nbsp;<span class="keyword" id="3307332">else</span>&nbsp;<span class="keyword" id="3307337">if</span>&nbsp;<span class="ident" id="3307340">tokenAfterVariable</span><span class="op" id="3307358">.</span><span class="ident" id="3307359">typ</span>&nbsp;<span class="op" id="3307363">==</span>&nbsp;<span class="ident" id="3307366">itemSpace</span>&nbsp;<span class="op" id="3307376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307382">t</span><span class="op" id="3307383">.</span><span class="ident" id="3307384">backup3</span><span class="op" id="3307391">(</span><span class="ident" id="3307392">v</span><span class="op" id="3307393">,</span>&nbsp;<span class="ident" id="3307395">tokenAfterVariable</span><span class="op" id="3307413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3307418">}</span>&nbsp;<span class="keyword" id="3307420">else</span>&nbsp;<span class="op" id="3307425">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307431">t</span><span class="op" id="3307432">.</span><span class="ident" id="3307433">backup2</span><span class="op" id="3307440">(</span><span class="ident" id="3307441">v</span><span class="op" id="3307442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3307447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3307451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3307455">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3307462">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307465">pipe</span>&nbsp;<span class="op" id="3307470">=</span>&nbsp;<span class="ident" id="3307472">t</span><span class="op" id="3307473">.</span><span class="ident" id="3307474">newPipeline</span><span class="op" id="3307485">(</span><span class="ident" id="3307486">pos</span><span class="op" id="3307489">,</span>&nbsp;<span class="ident" id="3307491">t</span><span class="op" id="3307492">.</span><span class="ident" id="3307493">lex</span><span class="op" id="3307496">.</span><span class="ident" id="3307497">lineNumber</span><span class="op" id="3307507">(</span><span class="op" id="3307508">)</span><span class="op" id="3307509">,</span>&nbsp;<span class="ident" id="3307511">decl</span><span class="op" id="3307515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3307518">for</span>&nbsp;<span class="op" id="3307522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3307526">switch</span>&nbsp;<span class="ident" id="3307533">token</span>&nbsp;<span class="op" id="3307539">:=</span>&nbsp;<span class="ident" id="3307542">t</span><span class="op" id="3307543">.</span><span class="ident" id="3307544">nextNonSpace</span><span class="op" id="3307556">(</span><span class="op" id="3307557">)</span><span class="op" id="3307558">;</span>&nbsp;<span class="ident" id="3307560">token</span><span class="op" id="3307565">.</span><span class="ident" id="3307566">typ</span>&nbsp;<span class="op" id="3307570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3307574">case</span>&nbsp;<span class="ident" id="3307579">itemRightDelim</span><span class="op" id="3307593">,</span>&nbsp;<span class="ident" id="3307595">itemRightParen</span><span class="op" id="3307609">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3307614">if</span>&nbsp;<span class="builtinfunc" id="3307617">len</span><span class="op" id="3307620">(</span><span class="ident" id="3307621">pipe</span><span class="op" id="3307625">.</span><span class="ident" id="3307626">Cmds</span><span class="op" id="3307630">)</span>&nbsp;<span class="op" id="3307632">==</span>&nbsp;<span class="num" id="3307635">0</span>&nbsp;<span class="op" id="3307637">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307643">t</span><span class="op" id="3307644">.</span><span class="ident" id="3307645">errorf</span><span class="op" id="3307651">(</span><span class="string" id="3307652">&#34;missing&nbsp;value&nbsp;for&nbsp;%s&#34;</span><span class="op" id="3307674">,</span>&nbsp;<span class="ident" id="3307676">context</span><span class="op" id="3307683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3307688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3307693">if</span>&nbsp;<span class="ident" id="3307696">token</span><span class="op" id="3307701">.</span><span class="ident" id="3307702">typ</span>&nbsp;<span class="op" id="3307706">==</span>&nbsp;<span class="ident" id="3307709">itemRightParen</span>&nbsp;<span class="op" id="3307724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307730">t</span><span class="op" id="3307731">.</span><span class="ident" id="3307732">backup</span><span class="op" id="3307738">(</span><span class="op" id="3307739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3307744">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3307749">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3307758">case</span>&nbsp;<span class="ident" id="3307763">itemBool</span><span class="op" id="3307771">,</span>&nbsp;<span class="ident" id="3307773">itemCharConstant</span><span class="op" id="3307789">,</span>&nbsp;<span class="ident" id="3307791">itemComplex</span><span class="op" id="3307802">,</span>&nbsp;<span class="ident" id="3307804">itemDot</span><span class="op" id="3307811">,</span>&nbsp;<span class="ident" id="3307813">itemField</span><span class="op" id="3307822">,</span>&nbsp;<span class="ident" id="3307824">itemIdentifier</span><span class="op" id="3307838">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307843">itemNumber</span><span class="op" id="3307853">,</span>&nbsp;<span class="ident" id="3307855">itemNil</span><span class="op" id="3307862">,</span>&nbsp;<span class="ident" id="3307864">itemRawString</span><span class="op" id="3307877">,</span>&nbsp;<span class="ident" id="3307879">itemString</span><span class="op" id="3307889">,</span>&nbsp;<span class="ident" id="3307891">itemVariable</span><span class="op" id="3307903">,</span>&nbsp;<span class="ident" id="3307905">itemLeftParen</span><span class="op" id="3307918">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307923">t</span><span class="op" id="3307924">.</span><span class="ident" id="3307925">backup</span><span class="op" id="3307931">(</span><span class="op" id="3307932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307937">pipe</span><span class="op" id="3307941">.</span><span class="builtinfunc" id="3307942">append</span><span class="op" id="3307948">(</span><span class="ident" id="3307949">t</span><span class="op" id="3307950">.</span><span class="ident" id="3307951">command</span><span class="op" id="3307958">(</span><span class="op" id="3307959">)</span><span class="op" id="3307960">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3307964">default</span><span class="op" id="3307971">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3307976">t</span><span class="op" id="3307977">.</span><span class="ident" id="3307978">unexpected</span><span class="op" id="3307988">(</span><span class="ident" id="3307989">token</span><span class="op" id="3307994">,</span>&nbsp;<span class="ident" id="3307996">context</span><span class="op" id="3308003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3308007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3308010">}</span><br>
<span class="lineno"></span><span class="op" id="3308012">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="3308015">func</span>&nbsp;<span class="op" id="3308020">(</span><span class="ident" id="3308021">t</span>&nbsp;<span class="op" id="3308023">*</span><span class="ident" id="3308024">Tree</span><span class="op" id="3308028">)</span>&nbsp;<span class="ident" id="3308030">parseControl</span><span class="op" id="3308042">(</span><span class="ident" id="3308043">allowElseIf</span>&nbsp;<span class="builtintype" id="3308055">bool</span><span class="op" id="3308059">,</span>&nbsp;<span class="ident" id="3308061">context</span>&nbsp;<span class="builtintype" id="3308069">string</span><span class="op" id="3308075">)</span>&nbsp;<span class="op" id="3308077">(</span><span class="ident" id="3308078">pos</span>&nbsp;<span class="ident" id="3308082">Pos</span><span class="op" id="3308085">,</span>&nbsp;<span class="ident" id="3308087">line</span>&nbsp;<span class="builtintype" id="3308092">int</span><span class="op" id="3308095">,</span>&nbsp;<span class="ident" id="3308097">pipe</span>&nbsp;<span class="op" id="3308102">*</span><span class="ident" id="3308103">PipeNode</span><span class="op" id="3308111">,</span>&nbsp;<span class="ident" id="3308113">list</span><span class="op" id="3308117">,</span>&nbsp;<span class="ident" id="3308119">elseList</span>&nbsp;<span class="op" id="3308128">*</span><span class="ident" id="3308129">ListNode</span><span class="op" id="3308137">)</span>&nbsp;<span class="op" id="3308139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3308142">defer</span>&nbsp;<span class="ident" id="3308148">t</span><span class="op" id="3308149">.</span><span class="ident" id="3308150">popVars</span><span class="op" id="3308157">(</span><span class="builtinfunc" id="3308158">len</span><span class="op" id="3308161">(</span><span class="ident" id="3308162">t</span><span class="op" id="3308163">.</span><span class="ident" id="3308164">vars</span><span class="op" id="3308168">)</span><span class="op" id="3308169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3308172">line</span>&nbsp;<span class="op" id="3308177">=</span>&nbsp;<span class="ident" id="3308179">t</span><span class="op" id="3308180">.</span><span class="ident" id="3308181">lex</span><span class="op" id="3308184">.</span><span class="ident" id="3308185">lineNumber</span><span class="op" id="3308195">(</span><span class="op" id="3308196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3308199">pipe</span>&nbsp;<span class="op" id="3308204">=</span>&nbsp;<span class="ident" id="3308206">t</span><span class="op" id="3308207">.</span><span class="ident" id="3308208">pipeline</span><span class="op" id="3308216">(</span><span class="ident" id="3308217">context</span><span class="op" id="3308224">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3308227">var</span>&nbsp;<span class="ident" id="3308231">next</span>&nbsp;<span class="ident" id="3308236">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3308242">list</span><span class="op" id="3308246">,</span>&nbsp;<span class="ident" id="3308248">next</span>&nbsp;<span class="op" id="3308253">=</span>&nbsp;<span class="ident" id="3308255">t</span><span class="op" id="3308256">.</span><span class="ident" id="3308257">itemList</span><span class="op" id="3308265">(</span><span class="op" id="3308266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3308269">switch</span>&nbsp;<span class="ident" id="3308276">next</span><span class="op" id="3308280">.</span><span class="ident" id="3308281">Type</span><span class="op" id="3308285">(</span><span class="op" id="3308286">)</span>&nbsp;<span class="op" id="3308288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3308291">case</span>&nbsp;<span class="ident" id="3308296">nodeEnd</span><span class="op" id="3308303">:</span>&nbsp;<span class="comment" id="3308305">//done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3308313">case</span>&nbsp;<span class="ident" id="3308318">nodeElse</span><span class="op" id="3308326">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3308330">if</span>&nbsp;<span class="ident" id="3308333">allowElseIf</span>&nbsp;<span class="op" id="3308345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3308350">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.&nbsp;If&nbsp;the&nbsp;&#34;else&#34;&nbsp;is&nbsp;followed&nbsp;immediately&nbsp;by&nbsp;an&nbsp;&#34;if&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3308434">//&nbsp;the&nbsp;elseControl&nbsp;will&nbsp;have&nbsp;left&nbsp;the&nbsp;&#34;if&#34;&nbsp;token&nbsp;pending.&nbsp;Treat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3308501">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else&nbsp;if&nbsp;b}}_{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3308538">//&nbsp;as</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3308547">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else}}{{if&nbsp;b}}_{{end}}{{end}}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3308595">//&nbsp;To&nbsp;do&nbsp;this,&nbsp;parse&nbsp;the&nbsp;if&nbsp;as&nbsp;usual&nbsp;and&nbsp;stop&nbsp;at&nbsp;it&nbsp;{{end}};&nbsp;the&nbsp;subsequent{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3308681">//&nbsp;is&nbsp;assumed.&nbsp;This&nbsp;technique&nbsp;works&nbsp;even&nbsp;for&nbsp;long&nbsp;if-else-if&nbsp;chains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3308753">//&nbsp;TODO:&nbsp;Should&nbsp;we&nbsp;allow&nbsp;else-if&nbsp;in&nbsp;with&nbsp;and&nbsp;range?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3308808">if</span>&nbsp;<span class="ident" id="3308811">t</span><span class="op" id="3308812">.</span><span class="ident" id="3308813">peek</span><span class="op" id="3308817">(</span><span class="op" id="3308818">)</span><span class="op" id="3308819">.</span><span class="ident" id="3308820">typ</span>&nbsp;<span class="op" id="3308824">==</span>&nbsp;<span class="ident" id="3308827">itemIf</span>&nbsp;<span class="op" id="3308834">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3308840">t</span><span class="op" id="3308841">.</span><span class="ident" id="3308842">next</span><span class="op" id="3308846">(</span><span class="op" id="3308847">)</span>&nbsp;<span class="comment" id="3308849">//&nbsp;Consume&nbsp;the&nbsp;&#34;if&#34;&nbsp;token.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3308880">elseList</span>&nbsp;<span class="op" id="3308889">=</span>&nbsp;<span class="ident" id="3308891">t</span><span class="op" id="3308892">.</span><span class="ident" id="3308893">newList</span><span class="op" id="3308900">(</span><span class="ident" id="3308901">next</span><span class="op" id="3308905">.</span><span class="ident" id="3308906">Position</span><span class="op" id="3308914">(</span><span class="op" id="3308915">)</span><span class="op" id="3308916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3308922">elseList</span><span class="op" id="3308930">.</span><span class="builtinfunc" id="3308931">append</span><span class="op" id="3308937">(</span><span class="ident" id="3308938">t</span><span class="op" id="3308939">.</span><span class="ident" id="3308940">ifControl</span><span class="op" id="3308949">(</span><span class="op" id="3308950">)</span><span class="op" id="3308951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3308957">//&nbsp;Do&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;item&nbsp;-&nbsp;only&nbsp;one&nbsp;{{end}}&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3309022">break</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3309031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3309035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3309039">elseList</span><span class="op" id="3309047">,</span>&nbsp;<span class="ident" id="3309049">next</span>&nbsp;<span class="op" id="3309054">=</span>&nbsp;<span class="ident" id="3309056">t</span><span class="op" id="3309057">.</span><span class="ident" id="3309058">itemList</span><span class="op" id="3309066">(</span><span class="op" id="3309067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3309071">if</span>&nbsp;<span class="ident" id="3309074">next</span><span class="op" id="3309078">.</span><span class="ident" id="3309079">Type</span><span class="op" id="3309083">(</span><span class="op" id="3309084">)</span>&nbsp;<span class="op" id="3309086">!=</span>&nbsp;<span class="ident" id="3309089">nodeEnd</span>&nbsp;<span class="op" id="3309097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3309102">t</span><span class="op" id="3309103">.</span><span class="ident" id="3309104">errorf</span><span class="op" id="3309110">(</span><span class="string" id="3309111">&#34;expected&nbsp;end;&nbsp;found&nbsp;%s&#34;</span><span class="op" id="3309135">,</span>&nbsp;<span class="ident" id="3309137">next</span><span class="op" id="3309141">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3309145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3309148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3309151">return</span>&nbsp;<span class="ident" id="3309158">pipe</span><span class="op" id="3309162">.</span><span class="ident" id="3309163">Position</span><span class="op" id="3309171">(</span><span class="op" id="3309172">)</span><span class="op" id="3309173">,</span>&nbsp;<span class="ident" id="3309175">line</span><span class="op" id="3309179">,</span>&nbsp;<span class="ident" id="3309181">pipe</span><span class="op" id="3309185">,</span>&nbsp;<span class="ident" id="3309187">list</span><span class="op" id="3309191">,</span>&nbsp;<span class="ident" id="3309193">elseList</span><br>
<span class="lineno"></span><span class="op" id="3309202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="comment" id="3309205">//&nbsp;If:</span><br>
<span class="lineno"></span><span class="comment" id="3309212">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3309248">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3309302">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3309325">func</span>&nbsp;<span class="op" id="3309330">(</span><span class="ident" id="3309331">t</span>&nbsp;<span class="op" id="3309333">*</span><span class="ident" id="3309334">Tree</span><span class="op" id="3309338">)</span>&nbsp;<span class="ident" id="3309340">ifControl</span><span class="op" id="3309349">(</span><span class="op" id="3309350">)</span>&nbsp;<span class="ident" id="3309352">Node</span>&nbsp;<span class="op" id="3309357">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3309360">return</span>&nbsp;<span class="ident" id="3309367">t</span><span class="op" id="3309368">.</span><span class="ident" id="3309369">newIf</span><span class="op" id="3309374">(</span><span class="ident" id="3309375">t</span><span class="op" id="3309376">.</span><span class="ident" id="3309377">parseControl</span><span class="op" id="3309389">(</span><span class="builtintype" id="3309390">true</span><span class="op" id="3309394">,</span>&nbsp;<span class="string" id="3309396">&#34;if&#34;</span><span class="op" id="3309400">)</span><span class="op" id="3309401">)</span><br>
<span class="lineno"></span><span class="op" id="3309403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3309406">//&nbsp;Range:</span><br>
<span class="lineno"></span><span class="comment" id="3309416">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno">475</span><span class="comment" id="3309455">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3309512">//&nbsp;Range&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3309538">func</span>&nbsp;<span class="op" id="3309543">(</span><span class="ident" id="3309544">t</span>&nbsp;<span class="op" id="3309546">*</span><span class="ident" id="3309547">Tree</span><span class="op" id="3309551">)</span>&nbsp;<span class="ident" id="3309553">rangeControl</span><span class="op" id="3309565">(</span><span class="op" id="3309566">)</span>&nbsp;<span class="ident" id="3309568">Node</span>&nbsp;<span class="op" id="3309573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3309576">return</span>&nbsp;<span class="ident" id="3309583">t</span><span class="op" id="3309584">.</span><span class="ident" id="3309585">newRange</span><span class="op" id="3309593">(</span><span class="ident" id="3309594">t</span><span class="op" id="3309595">.</span><span class="ident" id="3309596">parseControl</span><span class="op" id="3309608">(</span><span class="builtintype" id="3309609">false</span><span class="op" id="3309614">,</span>&nbsp;<span class="string" id="3309616">&#34;range&#34;</span><span class="op" id="3309623">)</span><span class="op" id="3309624">)</span><br>
<span class="lineno"></span><span class="op" id="3309626">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="3309629">//&nbsp;With:</span><br>
<span class="lineno"></span><span class="comment" id="3309638">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3309676">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3309732">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno">485</span><span class="keyword" id="3309755">func</span>&nbsp;<span class="op" id="3309760">(</span><span class="ident" id="3309761">t</span>&nbsp;<span class="op" id="3309763">*</span><span class="ident" id="3309764">Tree</span><span class="op" id="3309768">)</span>&nbsp;<span class="ident" id="3309770">withControl</span><span class="op" id="3309781">(</span><span class="op" id="3309782">)</span>&nbsp;<span class="ident" id="3309784">Node</span>&nbsp;<span class="op" id="3309789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3309792">return</span>&nbsp;<span class="ident" id="3309799">t</span><span class="op" id="3309800">.</span><span class="ident" id="3309801">newWith</span><span class="op" id="3309808">(</span><span class="ident" id="3309809">t</span><span class="op" id="3309810">.</span><span class="ident" id="3309811">parseControl</span><span class="op" id="3309823">(</span><span class="builtintype" id="3309824">false</span><span class="op" id="3309829">,</span>&nbsp;<span class="string" id="3309831">&#34;with&#34;</span><span class="op" id="3309837">)</span><span class="op" id="3309838">)</span><br>
<span class="lineno"></span><span class="op" id="3309840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3309843">//&nbsp;End:</span><br>
<span class="lineno">490</span><span class="comment" id="3309851">//&nbsp;&nbsp;&nbsp;&nbsp{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3309862">//&nbsp;End&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3309886">func</span>&nbsp;<span class="op" id="3309891">(</span><span class="ident" id="3309892">t</span>&nbsp;<span class="op" id="3309894">*</span><span class="ident" id="3309895">Tree</span><span class="op" id="3309899">)</span>&nbsp;<span class="ident" id="3309901">endControl</span><span class="op" id="3309911">(</span><span class="op" id="3309912">)</span>&nbsp;<span class="ident" id="3309914">Node</span>&nbsp;<span class="op" id="3309919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3309922">return</span>&nbsp;<span class="ident" id="3309929">t</span><span class="op" id="3309930">.</span><span class="ident" id="3309931">newEnd</span><span class="op" id="3309937">(</span><span class="ident" id="3309938">t</span><span class="op" id="3309939">.</span><span class="ident" id="3309940">expect</span><span class="op" id="3309946">(</span><span class="ident" id="3309947">itemRightDelim</span><span class="op" id="3309961">,</span>&nbsp;<span class="string" id="3309963">&#34;end&#34;</span><span class="op" id="3309968">)</span><span class="op" id="3309969">.</span><span class="ident" id="3309970">pos</span><span class="op" id="3309973">)</span><br>
<span class="lineno"></span><span class="op" id="3309975">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="comment" id="3309978">//&nbsp;Else:</span><br>
<span class="lineno"></span><span class="comment" id="3309987">//&nbsp;&nbsp;&nbsp;&nbsp{{else}}</span><br>
<span class="lineno"></span><span class="comment" id="3309999">//&nbsp;Else&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3310024">func</span>&nbsp;<span class="op" id="3310029">(</span><span class="ident" id="3310030">t</span>&nbsp;<span class="op" id="3310032">*</span><span class="ident" id="3310033">Tree</span><span class="op" id="3310037">)</span>&nbsp;<span class="ident" id="3310039">elseControl</span><span class="op" id="3310050">(</span><span class="op" id="3310051">)</span>&nbsp;<span class="ident" id="3310053">Node</span>&nbsp;<span class="op" id="3310058">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3310061">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3310093">peek</span>&nbsp;<span class="op" id="3310098">:=</span>&nbsp;<span class="ident" id="3310101">t</span><span class="op" id="3310102">.</span><span class="ident" id="3310103">peekNonSpace</span><span class="op" id="3310115">(</span><span class="op" id="3310116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3310119">if</span>&nbsp;<span class="ident" id="3310122">peek</span><span class="op" id="3310126">.</span><span class="ident" id="3310127">typ</span>&nbsp;<span class="op" id="3310131">==</span>&nbsp;<span class="ident" id="3310134">itemIf</span>&nbsp;<span class="op" id="3310141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3310145">//&nbsp;We&nbsp;see&nbsp;&#34;{{else&nbsp;if&nbsp;...&nbsp;&#34;&nbsp;but&nbsp;in&nbsp;effect&nbsp;rewrite&nbsp;it&nbsp;to&nbsp;{{else}}{{if&nbsp;...&nbsp;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3310222">return</span>&nbsp;<span class="ident" id="3310229">t</span><span class="op" id="3310230">.</span><span class="ident" id="3310231">newElse</span><span class="op" id="3310238">(</span><span class="ident" id="3310239">peek</span><span class="op" id="3310243">.</span><span class="ident" id="3310244">pos</span><span class="op" id="3310247">,</span>&nbsp;<span class="ident" id="3310249">t</span><span class="op" id="3310250">.</span><span class="ident" id="3310251">lex</span><span class="op" id="3310254">.</span><span class="ident" id="3310255">lineNumber</span><span class="op" id="3310265">(</span><span class="op" id="3310266">)</span><span class="op" id="3310267">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3310270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3310273">return</span>&nbsp;<span class="ident" id="3310280">t</span><span class="op" id="3310281">.</span><span class="ident" id="3310282">newElse</span><span class="op" id="3310289">(</span><span class="ident" id="3310290">t</span><span class="op" id="3310291">.</span><span class="ident" id="3310292">expect</span><span class="op" id="3310298">(</span><span class="ident" id="3310299">itemRightDelim</span><span class="op" id="3310313">,</span>&nbsp;<span class="string" id="3310315">&#34;else&#34;</span><span class="op" id="3310321">)</span><span class="op" id="3310322">.</span><span class="ident" id="3310323">pos</span><span class="op" id="3310326">,</span>&nbsp;<span class="ident" id="3310328">t</span><span class="op" id="3310329">.</span><span class="ident" id="3310330">lex</span><span class="op" id="3310333">.</span><span class="ident" id="3310334">lineNumber</span><span class="op" id="3310344">(</span><span class="op" id="3310345">)</span><span class="op" id="3310346">)</span><br>
<span class="lineno"></span><span class="op" id="3310348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3310351">//&nbsp;Template:</span><br>
<span class="lineno">510</span><span class="comment" id="3310364">//&nbsp;&nbsp;&nbsp;&nbsp{{template&nbsp;stringValue&nbsp;pipeline}}</span><br>
<span class="lineno"></span><span class="comment" id="3310401">//&nbsp;Template&nbsp;keyword&nbsp;is&nbsp;past.&nbsp;&nbsp;The&nbsp;name&nbsp;must&nbsp;be&nbsp;something&nbsp;that&nbsp;can&nbsp;evaluate</span><br>
<span class="lineno"></span><span class="comment" id="3310476">//&nbsp;to&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3310492">func</span>&nbsp;<span class="op" id="3310497">(</span><span class="ident" id="3310498">t</span>&nbsp;<span class="op" id="3310500">*</span><span class="ident" id="3310501">Tree</span><span class="op" id="3310505">)</span>&nbsp;<span class="ident" id="3310507">templateControl</span><span class="op" id="3310522">(</span><span class="op" id="3310523">)</span>&nbsp;<span class="ident" id="3310525">Node</span>&nbsp;<span class="op" id="3310530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3310533">var</span>&nbsp;<span class="ident" id="3310537">name</span>&nbsp;<span class="builtintype" id="3310542">string</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3310550">token</span>&nbsp;<span class="op" id="3310556">:=</span>&nbsp;<span class="ident" id="3310559">t</span><span class="op" id="3310560">.</span><span class="ident" id="3310561">nextNonSpace</span><span class="op" id="3310573">(</span><span class="op" id="3310574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3310577">switch</span>&nbsp;<span class="ident" id="3310584">token</span><span class="op" id="3310589">.</span><span class="ident" id="3310590">typ</span>&nbsp;<span class="op" id="3310594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3310597">case</span>&nbsp;<span class="ident" id="3310602">itemString</span><span class="op" id="3310612">,</span>&nbsp;<span class="ident" id="3310614">itemRawString</span><span class="op" id="3310627">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3310631">s</span><span class="op" id="3310632">,</span>&nbsp;<span class="ident" id="3310634">err</span>&nbsp;<span class="op" id="3310638">:=</span>&nbsp;<span class="ident" id="3310641">strconv</span><span class="op" id="3310648">.</span><span class="ident" id="3310649">Unquote</span><span class="op" id="3310656">(</span><span class="ident" id="3310657">token</span><span class="op" id="3310662">.</span><span class="ident" id="3310663">val</span><span class="op" id="3310666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3310670">if</span>&nbsp;<span class="ident" id="3310673">err</span>&nbsp;<span class="op" id="3310677">!=</span>&nbsp;<span class="ident" id="3310680">nil</span>&nbsp;<span class="op" id="3310684">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3310689">t</span><span class="op" id="3310690">.</span><span class="builtintype" id="3310691">error</span><span class="op" id="3310696">(</span><span class="ident" id="3310697">err</span><span class="op" id="3310700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3310704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3310708">name</span>&nbsp;<span class="op" id="3310713">=</span>&nbsp;<span class="ident" id="3310715">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3310718">default</span><span class="op" id="3310725">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3310729">t</span><span class="op" id="3310730">.</span><span class="ident" id="3310731">unexpected</span><span class="op" id="3310741">(</span><span class="ident" id="3310742">token</span><span class="op" id="3310747">,</span>&nbsp;<span class="string" id="3310749">&#34;template&nbsp;invocation&#34;</span><span class="op" id="3310770">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3310773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3310776">var</span>&nbsp;<span class="ident" id="3310780">pipe</span>&nbsp;<span class="op" id="3310785">*</span><span class="ident" id="3310786">PipeNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3310796">if</span>&nbsp;<span class="ident" id="3310799">t</span><span class="op" id="3310800">.</span><span class="ident" id="3310801">nextNonSpace</span><span class="op" id="3310813">(</span><span class="op" id="3310814">)</span><span class="op" id="3310815">.</span><span class="ident" id="3310816">typ</span>&nbsp;<span class="op" id="3310820">!=</span>&nbsp;<span class="ident" id="3310823">itemRightDelim</span>&nbsp;<span class="op" id="3310838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3310842">t</span><span class="op" id="3310843">.</span><span class="ident" id="3310844">backup</span><span class="op" id="3310850">(</span><span class="op" id="3310851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3310855">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3310908">pipe</span>&nbsp;<span class="op" id="3310913">=</span>&nbsp;<span class="ident" id="3310915">t</span><span class="op" id="3310916">.</span><span class="ident" id="3310917">pipeline</span><span class="op" id="3310925">(</span><span class="string" id="3310926">&#34;template&#34;</span><span class="op" id="3310936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3310939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3310942">return</span>&nbsp;<span class="ident" id="3310949">t</span><span class="op" id="3310950">.</span><span class="ident" id="3310951">newTemplate</span><span class="op" id="3310962">(</span><span class="ident" id="3310963">token</span><span class="op" id="3310968">.</span><span class="ident" id="3310969">pos</span><span class="op" id="3310972">,</span>&nbsp;<span class="ident" id="3310974">t</span><span class="op" id="3310975">.</span><span class="ident" id="3310976">lex</span><span class="op" id="3310979">.</span><span class="ident" id="3310980">lineNumber</span><span class="op" id="3310990">(</span><span class="op" id="3310991">)</span><span class="op" id="3310992">,</span>&nbsp;<span class="ident" id="3310994">name</span><span class="op" id="3310998">,</span>&nbsp;<span class="ident" id="3311000">pipe</span><span class="op" id="3311004">)</span><br>
<span class="lineno"></span><span class="op" id="3311006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="comment" id="3311009">//&nbsp;command:</span><br>
<span class="lineno"></span><span class="comment" id="3311021">//&nbsp;&nbsp;&nbsp;&nbspoperand&nbsp;(space&nbsp;operand)*</span><br>
<span class="lineno"></span><span class="comment" id="3311049">//&nbsp;space-separated&nbsp;arguments&nbsp;up&nbsp;to&nbsp;a&nbsp;pipeline&nbsp;character&nbsp;or&nbsp;right&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="3311125">//&nbsp;we&nbsp;consume&nbsp;the&nbsp;pipe&nbsp;character&nbsp;but&nbsp;leave&nbsp;the&nbsp;right&nbsp;delim&nbsp;to&nbsp;terminate&nbsp;the&nbsp;action.</span><br>
<span class="lineno"></span><span class="keyword" id="3311209">func</span>&nbsp;<span class="op" id="3311214">(</span><span class="ident" id="3311215">t</span>&nbsp;<span class="op" id="3311217">*</span><span class="ident" id="3311218">Tree</span><span class="op" id="3311222">)</span>&nbsp;<span class="ident" id="3311224">command</span><span class="op" id="3311231">(</span><span class="op" id="3311232">)</span>&nbsp;<span class="op" id="3311234">*</span><span class="ident" id="3311235">CommandNode</span>&nbsp;<span class="op" id="3311247">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3311250">cmd</span>&nbsp;<span class="op" id="3311254">:=</span>&nbsp;<span class="ident" id="3311257">t</span><span class="op" id="3311258">.</span><span class="ident" id="3311259">newCommand</span><span class="op" id="3311269">(</span><span class="ident" id="3311270">t</span><span class="op" id="3311271">.</span><span class="ident" id="3311272">peekNonSpace</span><span class="op" id="3311284">(</span><span class="op" id="3311285">)</span><span class="op" id="3311286">.</span><span class="ident" id="3311287">pos</span><span class="op" id="3311290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3311293">for</span>&nbsp;<span class="op" id="3311297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3311301">t</span><span class="op" id="3311302">.</span><span class="ident" id="3311303">peekNonSpace</span><span class="op" id="3311315">(</span><span class="op" id="3311316">)</span>&nbsp;<span class="comment" id="3311318">//&nbsp;skip&nbsp;leading&nbsp;spaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3311344">operand</span>&nbsp;<span class="op" id="3311352">:=</span>&nbsp;<span class="ident" id="3311355">t</span><span class="op" id="3311356">.</span><span class="ident" id="3311357">operand</span><span class="op" id="3311364">(</span><span class="op" id="3311365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3311369">if</span>&nbsp;<span class="ident" id="3311372">operand</span>&nbsp;<span class="op" id="3311380">!=</span>&nbsp;<span class="ident" id="3311383">nil</span>&nbsp;<span class="op" id="3311387">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3311392">cmd</span><span class="op" id="3311395">.</span><span class="builtinfunc" id="3311396">append</span><span class="op" id="3311402">(</span><span class="ident" id="3311403">operand</span><span class="op" id="3311410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3311414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3311418">switch</span>&nbsp;<span class="ident" id="3311425">token</span>&nbsp;<span class="op" id="3311431">:=</span>&nbsp;<span class="ident" id="3311434">t</span><span class="op" id="3311435">.</span><span class="ident" id="3311436">next</span><span class="op" id="3311440">(</span><span class="op" id="3311441">)</span><span class="op" id="3311442">;</span>&nbsp;<span class="ident" id="3311444">token</span><span class="op" id="3311449">.</span><span class="ident" id="3311450">typ</span>&nbsp;<span class="op" id="3311454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3311458">case</span>&nbsp;<span class="ident" id="3311463">itemSpace</span><span class="op" id="3311472">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3311477">continue</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3311488">case</span>&nbsp;<span class="ident" id="3311493">itemError</span><span class="op" id="3311502">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3311507">t</span><span class="op" id="3311508">.</span><span class="ident" id="3311509">errorf</span><span class="op" id="3311515">(</span><span class="string" id="3311516">&#34;%s&#34;</span><span class="op" id="3311520">,</span>&nbsp;<span class="ident" id="3311522">token</span><span class="op" id="3311527">.</span><span class="ident" id="3311528">val</span><span class="op" id="3311531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3311535">case</span>&nbsp;<span class="ident" id="3311540">itemRightDelim</span><span class="op" id="3311554">,</span>&nbsp;<span class="ident" id="3311556">itemRightParen</span><span class="op" id="3311570">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3311575">t</span><span class="op" id="3311576">.</span><span class="ident" id="3311577">backup</span><span class="op" id="3311583">(</span><span class="op" id="3311584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3311588">case</span>&nbsp;<span class="ident" id="3311593">itemPipe</span><span class="op" id="3311601">:</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3311605">default</span><span class="op" id="3311612">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3311617">t</span><span class="op" id="3311618">.</span><span class="ident" id="3311619">errorf</span><span class="op" id="3311625">(</span><span class="string" id="3311626">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;operand;&nbsp;missing&nbsp;space?&#34;</span><span class="op" id="3311668">,</span>&nbsp;<span class="ident" id="3311670">token</span><span class="op" id="3311675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3311679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3311683">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3311690">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3311693">if</span>&nbsp;<span class="builtinfunc" id="3311696">len</span><span class="op" id="3311699">(</span><span class="ident" id="3311700">cmd</span><span class="op" id="3311703">.</span><span class="ident" id="3311704">Args</span><span class="op" id="3311708">)</span>&nbsp;<span class="op" id="3311710">==</span>&nbsp;<span class="num" id="3311713">0</span>&nbsp;<span class="op" id="3311715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3311719">t</span><span class="op" id="3311720">.</span><span class="ident" id="3311721">errorf</span><span class="op" id="3311727">(</span><span class="string" id="3311728">&#34;empty&nbsp;command&#34;</span><span class="op" id="3311743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3311746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3311749">return</span>&nbsp;<span class="ident" id="3311756">cmd</span><br>
<span class="lineno"></span><span class="op" id="3311760">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="comment" id="3311763">//&nbsp;operand:</span><br>
<span class="lineno"></span><span class="comment" id="3311775">//&nbsp;&nbsp;&nbsp;&nbspterm&nbsp;.Field*</span><br>
<span class="lineno"></span><span class="comment" id="3311791">//&nbsp;An&nbsp;operand&nbsp;is&nbsp;a&nbsp;space-separated&nbsp;component&nbsp;of&nbsp;a&nbsp;command,</span><br>
<span class="lineno"></span><span class="comment" id="3311850">//&nbsp;a&nbsp;term&nbsp;possibly&nbsp;followed&nbsp;by&nbsp;field&nbsp;accesses.</span><br>
<span class="lineno">570</span><span class="comment" id="3311897">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;an&nbsp;operand.</span><br>
<span class="lineno"></span><span class="keyword" id="3311952">func</span>&nbsp;<span class="op" id="3311957">(</span><span class="ident" id="3311958">t</span>&nbsp;<span class="op" id="3311960">*</span><span class="ident" id="3311961">Tree</span><span class="op" id="3311965">)</span>&nbsp;<span class="ident" id="3311967">operand</span><span class="op" id="3311974">(</span><span class="op" id="3311975">)</span>&nbsp;<span class="ident" id="3311977">Node</span>&nbsp;<span class="op" id="3311982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3311985">node</span>&nbsp;<span class="op" id="3311990">:=</span>&nbsp;<span class="ident" id="3311993">t</span><span class="op" id="3311994">.</span><span class="ident" id="3311995">term</span><span class="op" id="3311999">(</span><span class="op" id="3312000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3312003">if</span>&nbsp;<span class="ident" id="3312006">node</span>&nbsp;<span class="op" id="3312011">==</span>&nbsp;<span class="ident" id="3312014">nil</span>&nbsp;<span class="op" id="3312018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3312022">return</span>&nbsp;<span class="ident" id="3312029">nil</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3312034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3312037">if</span>&nbsp;<span class="ident" id="3312040">t</span><span class="op" id="3312041">.</span><span class="ident" id="3312042">peek</span><span class="op" id="3312046">(</span><span class="op" id="3312047">)</span><span class="op" id="3312048">.</span><span class="ident" id="3312049">typ</span>&nbsp;<span class="op" id="3312053">==</span>&nbsp;<span class="ident" id="3312056">itemField</span>&nbsp;<span class="op" id="3312066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3312070">chain</span>&nbsp;<span class="op" id="3312076">:=</span>&nbsp;<span class="ident" id="3312079">t</span><span class="op" id="3312080">.</span><span class="ident" id="3312081">newChain</span><span class="op" id="3312089">(</span><span class="ident" id="3312090">t</span><span class="op" id="3312091">.</span><span class="ident" id="3312092">peek</span><span class="op" id="3312096">(</span><span class="op" id="3312097">)</span><span class="op" id="3312098">.</span><span class="ident" id="3312099">pos</span><span class="op" id="3312102">,</span>&nbsp;<span class="ident" id="3312104">node</span><span class="op" id="3312108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3312112">for</span>&nbsp;<span class="ident" id="3312116">t</span><span class="op" id="3312117">.</span><span class="ident" id="3312118">peek</span><span class="op" id="3312122">(</span><span class="op" id="3312123">)</span><span class="op" id="3312124">.</span><span class="ident" id="3312125">typ</span>&nbsp;<span class="op" id="3312129">==</span>&nbsp;<span class="ident" id="3312132">itemField</span>&nbsp;<span class="op" id="3312142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3312147">chain</span><span class="op" id="3312152">.</span><span class="ident" id="3312153">Add</span><span class="op" id="3312156">(</span><span class="ident" id="3312157">t</span><span class="op" id="3312158">.</span><span class="ident" id="3312159">next</span><span class="op" id="3312163">(</span><span class="op" id="3312164">)</span><span class="op" id="3312165">.</span><span class="ident" id="3312166">val</span><span class="op" id="3312169">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3312173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3312177">//&nbsp;Compatibility&nbsp;with&nbsp;original&nbsp;API:&nbsp;If&nbsp;the&nbsp;term&nbsp;is&nbsp;of&nbsp;type&nbsp;NodeField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3312248">//&nbsp;or&nbsp;NodeVariable,&nbsp;just&nbsp;put&nbsp;more&nbsp;fields&nbsp;on&nbsp;the&nbsp;original.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3312308">//&nbsp;Otherwise,&nbsp;keep&nbsp;the&nbsp;Chain&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3312345">//&nbsp;TODO:&nbsp;Switch&nbsp;to&nbsp;Chains&nbsp;always&nbsp;when&nbsp;we&nbsp;can.</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3312393">switch</span>&nbsp;<span class="ident" id="3312400">node</span><span class="op" id="3312404">.</span><span class="ident" id="3312405">Type</span><span class="op" id="3312409">(</span><span class="op" id="3312410">)</span>&nbsp;<span class="op" id="3312412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3312416">case</span>&nbsp;<span class="ident" id="3312421">NodeField</span><span class="op" id="3312430">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3312435">node</span>&nbsp;<span class="op" id="3312440">=</span>&nbsp;<span class="ident" id="3312442">t</span><span class="op" id="3312443">.</span><span class="ident" id="3312444">newField</span><span class="op" id="3312452">(</span><span class="ident" id="3312453">chain</span><span class="op" id="3312458">.</span><span class="ident" id="3312459">Position</span><span class="op" id="3312467">(</span><span class="op" id="3312468">)</span><span class="op" id="3312469">,</span>&nbsp;<span class="ident" id="3312471">chain</span><span class="op" id="3312476">.</span><span class="ident" id="3312477">String</span><span class="op" id="3312483">(</span><span class="op" id="3312484">)</span><span class="op" id="3312485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3312489">case</span>&nbsp;<span class="ident" id="3312494">NodeVariable</span><span class="op" id="3312506">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3312511">node</span>&nbsp;<span class="op" id="3312516">=</span>&nbsp;<span class="ident" id="3312518">t</span><span class="op" id="3312519">.</span><span class="ident" id="3312520">newVariable</span><span class="op" id="3312531">(</span><span class="ident" id="3312532">chain</span><span class="op" id="3312537">.</span><span class="ident" id="3312538">Position</span><span class="op" id="3312546">(</span><span class="op" id="3312547">)</span><span class="op" id="3312548">,</span>&nbsp;<span class="ident" id="3312550">chain</span><span class="op" id="3312555">.</span><span class="ident" id="3312556">String</span><span class="op" id="3312562">(</span><span class="op" id="3312563">)</span><span class="op" id="3312564">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3312568">default</span><span class="op" id="3312575">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3312580">node</span>&nbsp;<span class="op" id="3312585">=</span>&nbsp;<span class="ident" id="3312587">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3312595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3312598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3312601">return</span>&nbsp;<span class="ident" id="3312608">node</span><br>
<span class="lineno">595</span><span class="op" id="3312613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3312616">//&nbsp;term:</span><br>
<span class="lineno"></span><span class="comment" id="3312625">//&nbsp;&nbsp;&nbsp;&nbspliteral&nbsp;(number,&nbsp;string,&nbsp;nil,&nbsp;boolean)</span><br>
<span class="lineno"></span><span class="comment" id="3312667">//&nbsp;&nbsp;&nbsp;&nbspfunction&nbsp;(identifier)</span><br>
<span class="lineno">600</span><span class="comment" id="3312692">//&nbsp;&nbsp;&nbsp;&nbsp.</span><br>
<span class="lineno"></span><span class="comment" id="3312697">//&nbsp;&nbsp;&nbsp;&nbsp.Field</span><br>
<span class="lineno"></span><span class="comment" id="3312707">//&nbsp;&nbsp;&nbsp;&nbsp$</span><br>
<span class="lineno"></span><span class="comment" id="3312712">//&nbsp;&nbsp;&nbsp;&nbsp&#39;(&#39;&nbsp;pipeline&nbsp;&#39;)&#39;</span><br>
<span class="lineno"></span><span class="comment" id="3312732">//&nbsp;A&nbsp;term&nbsp;is&nbsp;a&nbsp;simple&nbsp;&#34;expression&#34;.</span><br>
<span class="lineno">605</span><span class="comment" id="3312768">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;a&nbsp;term.</span><br>
<span class="lineno"></span><span class="keyword" id="3312819">func</span>&nbsp;<span class="op" id="3312824">(</span><span class="ident" id="3312825">t</span>&nbsp;<span class="op" id="3312827">*</span><span class="ident" id="3312828">Tree</span><span class="op" id="3312832">)</span>&nbsp;<span class="ident" id="3312834">term</span><span class="op" id="3312838">(</span><span class="op" id="3312839">)</span>&nbsp;<span class="ident" id="3312841">Node</span>&nbsp;<span class="op" id="3312846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3312849">switch</span>&nbsp;<span class="ident" id="3312856">token</span>&nbsp;<span class="op" id="3312862">:=</span>&nbsp;<span class="ident" id="3312865">t</span><span class="op" id="3312866">.</span><span class="ident" id="3312867">nextNonSpace</span><span class="op" id="3312879">(</span><span class="op" id="3312880">)</span><span class="op" id="3312881">;</span>&nbsp;<span class="ident" id="3312883">token</span><span class="op" id="3312888">.</span><span class="ident" id="3312889">typ</span>&nbsp;<span class="op" id="3312893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3312896">case</span>&nbsp;<span class="ident" id="3312901">itemError</span><span class="op" id="3312910">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3312914">t</span><span class="op" id="3312915">.</span><span class="ident" id="3312916">errorf</span><span class="op" id="3312922">(</span><span class="string" id="3312923">&#34;%s&#34;</span><span class="op" id="3312927">,</span>&nbsp;<span class="ident" id="3312929">token</span><span class="op" id="3312934">.</span><span class="ident" id="3312935">val</span><span class="op" id="3312938">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3312941">case</span>&nbsp;<span class="ident" id="3312946">itemIdentifier</span><span class="op" id="3312960">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3312964">if</span>&nbsp;<span class="op" id="3312967">!</span><span class="ident" id="3312968">t</span><span class="op" id="3312969">.</span><span class="ident" id="3312970">hasFunction</span><span class="op" id="3312981">(</span><span class="ident" id="3312982">token</span><span class="op" id="3312987">.</span><span class="ident" id="3312988">val</span><span class="op" id="3312991">)</span>&nbsp;<span class="op" id="3312993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3312998">t</span><span class="op" id="3312999">.</span><span class="ident" id="3313000">errorf</span><span class="op" id="3313006">(</span><span class="string" id="3313007">&#34;function&nbsp;%q&nbsp;not&nbsp;defined&#34;</span><span class="op" id="3313032">,</span>&nbsp;<span class="ident" id="3313034">token</span><span class="op" id="3313039">.</span><span class="ident" id="3313040">val</span><span class="op" id="3313043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3313047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313051">return</span>&nbsp;<span class="ident" id="3313058">NewIdentifier</span><span class="op" id="3313071">(</span><span class="ident" id="3313072">token</span><span class="op" id="3313077">.</span><span class="ident" id="3313078">val</span><span class="op" id="3313081">)</span><span class="op" id="3313082">.</span><span class="ident" id="3313083">SetTree</span><span class="op" id="3313090">(</span><span class="ident" id="3313091">t</span><span class="op" id="3313092">)</span><span class="op" id="3313093">.</span><span class="ident" id="3313094">SetPos</span><span class="op" id="3313100">(</span><span class="ident" id="3313101">token</span><span class="op" id="3313106">.</span><span class="ident" id="3313107">pos</span><span class="op" id="3313110">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313113">case</span>&nbsp;<span class="ident" id="3313118">itemDot</span><span class="op" id="3313125">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313129">return</span>&nbsp;<span class="ident" id="3313136">t</span><span class="op" id="3313137">.</span><span class="ident" id="3313138">newDot</span><span class="op" id="3313144">(</span><span class="ident" id="3313145">token</span><span class="op" id="3313150">.</span><span class="ident" id="3313151">pos</span><span class="op" id="3313154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313157">case</span>&nbsp;<span class="ident" id="3313162">itemNil</span><span class="op" id="3313169">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313173">return</span>&nbsp;<span class="ident" id="3313180">t</span><span class="op" id="3313181">.</span><span class="ident" id="3313182">newNil</span><span class="op" id="3313188">(</span><span class="ident" id="3313189">token</span><span class="op" id="3313194">.</span><span class="ident" id="3313195">pos</span><span class="op" id="3313198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313201">case</span>&nbsp;<span class="ident" id="3313206">itemVariable</span><span class="op" id="3313218">:</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313222">return</span>&nbsp;<span class="ident" id="3313229">t</span><span class="op" id="3313230">.</span><span class="ident" id="3313231">useVar</span><span class="op" id="3313237">(</span><span class="ident" id="3313238">token</span><span class="op" id="3313243">.</span><span class="ident" id="3313244">pos</span><span class="op" id="3313247">,</span>&nbsp;<span class="ident" id="3313249">token</span><span class="op" id="3313254">.</span><span class="ident" id="3313255">val</span><span class="op" id="3313258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313261">case</span>&nbsp;<span class="ident" id="3313266">itemField</span><span class="op" id="3313275">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313279">return</span>&nbsp;<span class="ident" id="3313286">t</span><span class="op" id="3313287">.</span><span class="ident" id="3313288">newField</span><span class="op" id="3313296">(</span><span class="ident" id="3313297">token</span><span class="op" id="3313302">.</span><span class="ident" id="3313303">pos</span><span class="op" id="3313306">,</span>&nbsp;<span class="ident" id="3313308">token</span><span class="op" id="3313313">.</span><span class="ident" id="3313314">val</span><span class="op" id="3313317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313320">case</span>&nbsp;<span class="ident" id="3313325">itemBool</span><span class="op" id="3313333">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313337">return</span>&nbsp;<span class="ident" id="3313344">t</span><span class="op" id="3313345">.</span><span class="ident" id="3313346">newBool</span><span class="op" id="3313353">(</span><span class="ident" id="3313354">token</span><span class="op" id="3313359">.</span><span class="ident" id="3313360">pos</span><span class="op" id="3313363">,</span>&nbsp;<span class="ident" id="3313365">token</span><span class="op" id="3313370">.</span><span class="ident" id="3313371">val</span>&nbsp;<span class="op" id="3313375">==</span>&nbsp;<span class="string" id="3313378">&#34;true&#34;</span><span class="op" id="3313384">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313387">case</span>&nbsp;<span class="ident" id="3313392">itemCharConstant</span><span class="op" id="3313408">,</span>&nbsp;<span class="ident" id="3313410">itemComplex</span><span class="op" id="3313421">,</span>&nbsp;<span class="ident" id="3313423">itemNumber</span><span class="op" id="3313433">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3313437">number</span><span class="op" id="3313443">,</span>&nbsp;<span class="ident" id="3313445">err</span>&nbsp;<span class="op" id="3313449">:=</span>&nbsp;<span class="ident" id="3313452">t</span><span class="op" id="3313453">.</span><span class="ident" id="3313454">newNumber</span><span class="op" id="3313463">(</span><span class="ident" id="3313464">token</span><span class="op" id="3313469">.</span><span class="ident" id="3313470">pos</span><span class="op" id="3313473">,</span>&nbsp;<span class="ident" id="3313475">token</span><span class="op" id="3313480">.</span><span class="ident" id="3313481">val</span><span class="op" id="3313484">,</span>&nbsp;<span class="ident" id="3313486">token</span><span class="op" id="3313491">.</span><span class="ident" id="3313492">typ</span><span class="op" id="3313495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313499">if</span>&nbsp;<span class="ident" id="3313502">err</span>&nbsp;<span class="op" id="3313506">!=</span>&nbsp;<span class="ident" id="3313509">nil</span>&nbsp;<span class="op" id="3313513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3313518">t</span><span class="op" id="3313519">.</span><span class="builtintype" id="3313520">error</span><span class="op" id="3313525">(</span><span class="ident" id="3313526">err</span><span class="op" id="3313529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3313533">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313537">return</span>&nbsp;<span class="ident" id="3313544">number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313552">case</span>&nbsp;<span class="ident" id="3313557">itemLeftParen</span><span class="op" id="3313570">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3313574">pipe</span>&nbsp;<span class="op" id="3313579">:=</span>&nbsp;<span class="ident" id="3313582">t</span><span class="op" id="3313583">.</span><span class="ident" id="3313584">pipeline</span><span class="op" id="3313592">(</span><span class="string" id="3313593">&#34;parenthesized&nbsp;pipeline&#34;</span><span class="op" id="3313617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313621">if</span>&nbsp;<span class="ident" id="3313624">token</span>&nbsp;<span class="op" id="3313630">:=</span>&nbsp;<span class="ident" id="3313633">t</span><span class="op" id="3313634">.</span><span class="ident" id="3313635">next</span><span class="op" id="3313639">(</span><span class="op" id="3313640">)</span><span class="op" id="3313641">;</span>&nbsp;<span class="ident" id="3313643">token</span><span class="op" id="3313648">.</span><span class="ident" id="3313649">typ</span>&nbsp;<span class="op" id="3313653">!=</span>&nbsp;<span class="ident" id="3313656">itemRightParen</span>&nbsp;<span class="op" id="3313671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3313676">t</span><span class="op" id="3313677">.</span><span class="ident" id="3313678">errorf</span><span class="op" id="3313684">(</span><span class="string" id="3313685">&#34;unclosed&nbsp;right&nbsp;paren:&nbsp;unexpected&nbsp;%s&#34;</span><span class="op" id="3313722">,</span>&nbsp;<span class="ident" id="3313724">token</span><span class="op" id="3313729">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3313733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313737">return</span>&nbsp;<span class="ident" id="3313744">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313750">case</span>&nbsp;<span class="ident" id="3313755">itemString</span><span class="op" id="3313765">,</span>&nbsp;<span class="ident" id="3313767">itemRawString</span><span class="op" id="3313780">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3313784">s</span><span class="op" id="3313785">,</span>&nbsp;<span class="ident" id="3313787">err</span>&nbsp;<span class="op" id="3313791">:=</span>&nbsp;<span class="ident" id="3313794">strconv</span><span class="op" id="3313801">.</span><span class="ident" id="3313802">Unquote</span><span class="op" id="3313809">(</span><span class="ident" id="3313810">token</span><span class="op" id="3313815">.</span><span class="ident" id="3313816">val</span><span class="op" id="3313819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313823">if</span>&nbsp;<span class="ident" id="3313826">err</span>&nbsp;<span class="op" id="3313830">!=</span>&nbsp;<span class="ident" id="3313833">nil</span>&nbsp;<span class="op" id="3313837">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3313842">t</span><span class="op" id="3313843">.</span><span class="builtintype" id="3313844">error</span><span class="op" id="3313849">(</span><span class="ident" id="3313850">err</span><span class="op" id="3313853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3313857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313861">return</span>&nbsp;<span class="ident" id="3313868">t</span><span class="op" id="3313869">.</span><span class="ident" id="3313870">newString</span><span class="op" id="3313879">(</span><span class="ident" id="3313880">token</span><span class="op" id="3313885">.</span><span class="ident" id="3313886">pos</span><span class="op" id="3313889">,</span>&nbsp;<span class="ident" id="3313891">token</span><span class="op" id="3313896">.</span><span class="ident" id="3313897">val</span><span class="op" id="3313900">,</span>&nbsp;<span class="ident" id="3313902">s</span><span class="op" id="3313903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3313906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3313909">t</span><span class="op" id="3313910">.</span><span class="ident" id="3313911">backup</span><span class="op" id="3313917">(</span><span class="op" id="3313918">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3313921">return</span>&nbsp;<span class="ident" id="3313928">nil</span><br>
<span class="lineno"></span><span class="op" id="3313932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3313935">//&nbsp;hasFunction&nbsp;reports&nbsp;if&nbsp;a&nbsp;function&nbsp;name&nbsp;exists&nbsp;in&nbsp;the&nbsp;Tree&#39;s&nbsp;maps.</span><br>
<span class="lineno"></span><span class="keyword" id="3314004">func</span>&nbsp;<span class="op" id="3314009">(</span><span class="ident" id="3314010">t</span>&nbsp;<span class="op" id="3314012">*</span><span class="ident" id="3314013">Tree</span><span class="op" id="3314017">)</span>&nbsp;<span class="ident" id="3314019">hasFunction</span><span class="op" id="3314030">(</span><span class="ident" id="3314031">name</span>&nbsp;<span class="builtintype" id="3314036">string</span><span class="op" id="3314042">)</span>&nbsp;<span class="builtintype" id="3314044">bool</span>&nbsp;<span class="op" id="3314049">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3314052">for</span>&nbsp;<span class="ident" id="3314056">_</span><span class="op" id="3314057">,</span>&nbsp;<span class="ident" id="3314059">funcMap</span>&nbsp;<span class="op" id="3314067">:=</span>&nbsp;<span class="keyword" id="3314070">range</span>&nbsp;<span class="ident" id="3314076">t</span><span class="op" id="3314077">.</span><span class="ident" id="3314078">funcs</span>&nbsp;<span class="op" id="3314084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3314088">if</span>&nbsp;<span class="ident" id="3314091">funcMap</span>&nbsp;<span class="op" id="3314099">==</span>&nbsp;<span class="ident" id="3314102">nil</span>&nbsp;<span class="op" id="3314106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3314111">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3314122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3314126">if</span>&nbsp;<span class="ident" id="3314129">funcMap</span><span class="op" id="3314136">[</span><span class="ident" id="3314137">name</span><span class="op" id="3314141">]</span>&nbsp;<span class="op" id="3314143">!=</span>&nbsp;<span class="ident" id="3314146">nil</span>&nbsp;<span class="op" id="3314150">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3314155">return</span>&nbsp;<span class="builtintype" id="3314162">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3314169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3314172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3314175">return</span>&nbsp;<span class="builtintype" id="3314182">false</span><br>
<span class="lineno"></span><span class="op" id="3314188">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="comment" id="3314191">//&nbsp;popVars&nbsp;trims&nbsp;the&nbsp;variable&nbsp;list&nbsp;to&nbsp;the&nbsp;specified&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="3314250">func</span>&nbsp;<span class="op" id="3314255">(</span><span class="ident" id="3314256">t</span>&nbsp;<span class="op" id="3314258">*</span><span class="ident" id="3314259">Tree</span><span class="op" id="3314263">)</span>&nbsp;<span class="ident" id="3314265">popVars</span><span class="op" id="3314272">(</span><span class="ident" id="3314273">n</span>&nbsp;<span class="builtintype" id="3314275">int</span><span class="op" id="3314278">)</span>&nbsp;<span class="op" id="3314280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3314283">t</span><span class="op" id="3314284">.</span><span class="ident" id="3314285">vars</span>&nbsp;<span class="op" id="3314290">=</span>&nbsp;<span class="ident" id="3314292">t</span><span class="op" id="3314293">.</span><span class="ident" id="3314294">vars</span><span class="op" id="3314298">[</span><span class="op" id="3314299">:</span><span class="ident" id="3314300">n</span><span class="op" id="3314301">]</span><br>
<span class="lineno"></span><span class="op" id="3314303">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="3314306">//&nbsp;useVar&nbsp;returns&nbsp;a&nbsp;node&nbsp;for&nbsp;a&nbsp;variable&nbsp;reference.&nbsp;It&nbsp;errors&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3314374">//&nbsp;variable&nbsp;is&nbsp;not&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="3314402">func</span>&nbsp;<span class="op" id="3314407">(</span><span class="ident" id="3314408">t</span>&nbsp;<span class="op" id="3314410">*</span><span class="ident" id="3314411">Tree</span><span class="op" id="3314415">)</span>&nbsp;<span class="ident" id="3314417">useVar</span><span class="op" id="3314423">(</span><span class="ident" id="3314424">pos</span>&nbsp;<span class="ident" id="3314428">Pos</span><span class="op" id="3314431">,</span>&nbsp;<span class="ident" id="3314433">name</span>&nbsp;<span class="builtintype" id="3314438">string</span><span class="op" id="3314444">)</span>&nbsp;<span class="ident" id="3314446">Node</span>&nbsp;<span class="op" id="3314451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3314454">v</span>&nbsp;<span class="op" id="3314456">:=</span>&nbsp;<span class="ident" id="3314459">t</span><span class="op" id="3314460">.</span><span class="ident" id="3314461">newVariable</span><span class="op" id="3314472">(</span><span class="ident" id="3314473">pos</span><span class="op" id="3314476">,</span>&nbsp;<span class="ident" id="3314478">name</span><span class="op" id="3314482">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3314485">for</span>&nbsp;<span class="ident" id="3314489">_</span><span class="op" id="3314490">,</span>&nbsp;<span class="ident" id="3314492">varName</span>&nbsp;<span class="op" id="3314500">:=</span>&nbsp;<span class="keyword" id="3314503">range</span>&nbsp;<span class="ident" id="3314509">t</span><span class="op" id="3314510">.</span><span class="ident" id="3314511">vars</span>&nbsp;<span class="op" id="3314516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3314520">if</span>&nbsp;<span class="ident" id="3314523">varName</span>&nbsp;<span class="op" id="3314531">==</span>&nbsp;<span class="ident" id="3314534">v</span><span class="op" id="3314535">.</span><span class="ident" id="3314536">Ident</span><span class="op" id="3314541">[</span><span class="num" id="3314542">0</span><span class="op" id="3314543">]</span>&nbsp;<span class="op" id="3314545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3314550">return</span>&nbsp;<span class="ident" id="3314557">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3314561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3314564">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3314567">t</span><span class="op" id="3314568">.</span><span class="ident" id="3314569">errorf</span><span class="op" id="3314575">(</span><span class="string" id="3314576">&#34;undefined&nbsp;variable&nbsp;%q&#34;</span><span class="op" id="3314599">,</span>&nbsp;<span class="ident" id="3314601">v</span><span class="op" id="3314602">.</span><span class="ident" id="3314603">Ident</span><span class="op" id="3314608">[</span><span class="num" id="3314609">0</span><span class="op" id="3314610">]</span><span class="op" id="3314611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3314614">return</span>&nbsp;<span class="ident" id="3314621">nil</span><br>
<span class="lineno"></span><span class="op" id="3314625">}</span>
</div>
</body>
</html>
