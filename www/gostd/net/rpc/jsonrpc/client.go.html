<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html" class="current">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6317833">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6317889">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6317943">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6317994">//&nbsp;Package&nbsp;jsonrpc&nbsp;implements&nbsp;a&nbsp;JSON-RPC&nbsp;ClientCodec&nbsp;and&nbsp;ServerCodec</span><br>
<span class="lineno"></span><span class="comment" id="6318063">//&nbsp;for&nbsp;the&nbsp;rpc&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6318087">package</span>&nbsp;<span class="ident" id="6318095">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6318104">import</span>&nbsp;<span class="op" id="6318111">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6318114">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6318131">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6318138">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6318144">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6318151">&#34;net/rpc&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6318162">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="6318169">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6318172">type</span>&nbsp;<span class="ident" id="6318177">clientCodec</span>&nbsp;<span class="keyword" id="6318189">struct</span>&nbsp;<span class="op" id="6318196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318199">dec</span>&nbsp;<span class="op" id="6318203">*</span><span class="ident" id="6318204">json</span><span class="op" id="6318208">.</span><span class="ident" id="6318209">Decoder</span>&nbsp;<span class="comment" id="6318217">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318245">enc</span>&nbsp;<span class="op" id="6318249">*</span><span class="ident" id="6318250">json</span><span class="op" id="6318254">.</span><span class="ident" id="6318255">Encoder</span>&nbsp;<span class="comment" id="6318263">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318291">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6318295">io</span><span class="op" id="6318297">.</span><span class="ident" id="6318298">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6318307">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318332">req</span>&nbsp;&nbsp;<span class="ident" id="6318337">clientRequest</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318352">resp</span>&nbsp;<span class="ident" id="6318357">clientResponse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6318374">//&nbsp;JSON-RPC&nbsp;responses&nbsp;include&nbsp;the&nbsp;request&nbsp;id&nbsp;but&nbsp;not&nbsp;the&nbsp;request&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6318448">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;both.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6318478">//&nbsp;We&nbsp;save&nbsp;the&nbsp;request&nbsp;method&nbsp;in&nbsp;pending&nbsp;when&nbsp;sending&nbsp;a&nbsp;request</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6318543">//&nbsp;and&nbsp;then&nbsp;look&nbsp;it&nbsp;up&nbsp;by&nbsp;request&nbsp;ID&nbsp;when&nbsp;filling&nbsp;out&nbsp;the&nbsp;rpc&nbsp;Response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318616">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6318624">sync</span><span class="op" id="6318628">.</span><span class="ident" id="6318629">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6318642">//&nbsp;protects&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318663">pending</span>&nbsp;<span class="keyword" id="6318671">map</span><span class="op" id="6318674">[</span><span class="ident" id="6318675">uint64</span><span class="op" id="6318681">]</span><span class="builtintype" id="6318682">string</span>&nbsp;<span class="comment" id="6318689">//&nbsp;map&nbsp;request&nbsp;id&nbsp;to&nbsp;method&nbsp;name</span><br>
<span class="lineno"></span><span class="op" id="6318722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="6318725">//&nbsp;NewClientCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ClientCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="6318797">func</span>&nbsp;<span class="ident" id="6318802">NewClientCodec</span><span class="op" id="6318816">(</span><span class="ident" id="6318817">conn</span>&nbsp;<span class="ident" id="6318822">io</span><span class="op" id="6318824">.</span><span class="ident" id="6318825">ReadWriteCloser</span><span class="op" id="6318840">)</span>&nbsp;<span class="ident" id="6318842">rpc</span><span class="op" id="6318845">.</span><span class="ident" id="6318846">ClientCodec</span>&nbsp;<span class="op" id="6318858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6318861">return</span>&nbsp;<span class="op" id="6318868">&amp;</span><span class="ident" id="6318869">clientCodec</span><span class="op" id="6318880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318884">dec</span><span class="op" id="6318887">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318893">json</span><span class="op" id="6318897">.</span><span class="ident" id="6318898">NewDecoder</span><span class="op" id="6318908">(</span><span class="ident" id="6318909">conn</span><span class="op" id="6318913">)</span><span class="op" id="6318914">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318918">enc</span><span class="op" id="6318921">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318927">json</span><span class="op" id="6318931">.</span><span class="ident" id="6318932">NewEncoder</span><span class="op" id="6318942">(</span><span class="ident" id="6318943">conn</span><span class="op" id="6318947">)</span><span class="op" id="6318948">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318952">c</span><span class="op" id="6318953">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6318961">conn</span><span class="op" id="6318965">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318969">pending</span><span class="op" id="6318976">:</span>&nbsp;<span class="builtinfunc" id="6318978">make</span><span class="op" id="6318982">(</span><span class="keyword" id="6318983">map</span><span class="op" id="6318986">[</span><span class="ident" id="6318987">uint64</span><span class="op" id="6318993">]</span><span class="builtintype" id="6318994">string</span><span class="op" id="6319000">)</span><span class="op" id="6319001">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6319004">}</span><br>
<span class="lineno"></span><span class="op" id="6319006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="6319009">type</span>&nbsp;<span class="ident" id="6319014">clientRequest</span>&nbsp;<span class="keyword" id="6319028">struct</span>&nbsp;<span class="op" id="6319035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319038">Method</span>&nbsp;<span class="builtintype" id="6319045">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6319060">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319077">Params</span>&nbsp;<span class="op" id="6319084">[</span><span class="num" id="6319085">1</span><span class="op" id="6319086">]</span><span class="keyword" id="6319087">interface</span><span class="op" id="6319096">{</span><span class="op" id="6319097">}</span>&nbsp;<span class="string" id="6319099">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319116">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6319123">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6319138">`json:&#34;id&#34;`</span><br>
<span class="lineno"></span><span class="op" id="6319150">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6319153">func</span>&nbsp;<span class="op" id="6319158">(</span><span class="ident" id="6319159">c</span>&nbsp;<span class="op" id="6319161">*</span><span class="ident" id="6319162">clientCodec</span><span class="op" id="6319173">)</span>&nbsp;<span class="ident" id="6319175">WriteRequest</span><span class="op" id="6319187">(</span><span class="ident" id="6319188">r</span>&nbsp;<span class="op" id="6319190">*</span><span class="ident" id="6319191">rpc</span><span class="op" id="6319194">.</span><span class="ident" id="6319195">Request</span><span class="op" id="6319202">,</span>&nbsp;<span class="ident" id="6319204">param</span>&nbsp;<span class="keyword" id="6319210">interface</span><span class="op" id="6319219">{</span><span class="op" id="6319220">}</span><span class="op" id="6319221">)</span>&nbsp;<span class="builtintype" id="6319223">error</span>&nbsp;<span class="op" id="6319229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319232">c</span><span class="op" id="6319233">.</span><span class="ident" id="6319234">mutex</span><span class="op" id="6319239">.</span><span class="ident" id="6319240">Lock</span><span class="op" id="6319244">(</span><span class="op" id="6319245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319248">c</span><span class="op" id="6319249">.</span><span class="ident" id="6319250">pending</span><span class="op" id="6319257">[</span><span class="ident" id="6319258">r</span><span class="op" id="6319259">.</span><span class="ident" id="6319260">Seq</span><span class="op" id="6319263">]</span>&nbsp;<span class="op" id="6319265">=</span>&nbsp;<span class="ident" id="6319267">r</span><span class="op" id="6319268">.</span><span class="ident" id="6319269">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319284">c</span><span class="op" id="6319285">.</span><span class="ident" id="6319286">mutex</span><span class="op" id="6319291">.</span><span class="ident" id="6319292">Unlock</span><span class="op" id="6319298">(</span><span class="op" id="6319299">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319302">c</span><span class="op" id="6319303">.</span><span class="ident" id="6319304">req</span><span class="op" id="6319307">.</span><span class="ident" id="6319308">Method</span>&nbsp;<span class="op" id="6319315">=</span>&nbsp;<span class="ident" id="6319317">r</span><span class="op" id="6319318">.</span><span class="ident" id="6319319">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319334">c</span><span class="op" id="6319335">.</span><span class="ident" id="6319336">req</span><span class="op" id="6319339">.</span><span class="ident" id="6319340">Params</span><span class="op" id="6319346">[</span><span class="num" id="6319347">0</span><span class="op" id="6319348">]</span>&nbsp;<span class="op" id="6319350">=</span>&nbsp;<span class="ident" id="6319352">param</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319359">c</span><span class="op" id="6319360">.</span><span class="ident" id="6319361">req</span><span class="op" id="6319364">.</span><span class="ident" id="6319365">Id</span>&nbsp;<span class="op" id="6319368">=</span>&nbsp;<span class="ident" id="6319370">r</span><span class="op" id="6319371">.</span><span class="ident" id="6319372">Seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319377">return</span>&nbsp;<span class="ident" id="6319384">c</span><span class="op" id="6319385">.</span><span class="ident" id="6319386">enc</span><span class="op" id="6319389">.</span><span class="ident" id="6319390">Encode</span><span class="op" id="6319396">(</span><span class="op" id="6319397">&amp;</span><span class="ident" id="6319398">c</span><span class="op" id="6319399">.</span><span class="ident" id="6319400">req</span><span class="op" id="6319403">)</span><br>
<span class="lineno"></span><span class="op" id="6319405">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6319408">type</span>&nbsp;<span class="ident" id="6319413">clientResponse</span>&nbsp;<span class="keyword" id="6319428">struct</span>&nbsp;<span class="op" id="6319435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319438">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6319445">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6319462">`json:&#34;id&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319475">Result</span>&nbsp;<span class="op" id="6319482">*</span><span class="ident" id="6319483">json</span><span class="op" id="6319487">.</span><span class="ident" id="6319488">RawMessage</span>&nbsp;<span class="string" id="6319499">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319516">Error</span>&nbsp;&nbsp;<span class="keyword" id="6319523">interface</span><span class="op" id="6319532">{</span><span class="op" id="6319533">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6319540">`json:&#34;error&#34;`</span><br>
<span class="lineno">65</span><span class="op" id="6319555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6319558">func</span>&nbsp;<span class="op" id="6319563">(</span><span class="ident" id="6319564">r</span>&nbsp;<span class="op" id="6319566">*</span><span class="ident" id="6319567">clientResponse</span><span class="op" id="6319581">)</span>&nbsp;<span class="ident" id="6319583">reset</span><span class="op" id="6319588">(</span><span class="op" id="6319589">)</span>&nbsp;<span class="op" id="6319591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319594">r</span><span class="op" id="6319595">.</span><span class="ident" id="6319596">Id</span>&nbsp;<span class="op" id="6319599">=</span>&nbsp;<span class="num" id="6319601">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319604">r</span><span class="op" id="6319605">.</span><span class="ident" id="6319606">Result</span>&nbsp;<span class="op" id="6319613">=</span>&nbsp;<span class="ident" id="6319615">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319620">r</span><span class="op" id="6319621">.</span><span class="ident" id="6319622">Error</span>&nbsp;<span class="op" id="6319628">=</span>&nbsp;<span class="ident" id="6319630">nil</span><br>
<span class="lineno"></span><span class="op" id="6319634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6319637">func</span>&nbsp;<span class="op" id="6319642">(</span><span class="ident" id="6319643">c</span>&nbsp;<span class="op" id="6319645">*</span><span class="ident" id="6319646">clientCodec</span><span class="op" id="6319657">)</span>&nbsp;<span class="ident" id="6319659">ReadResponseHeader</span><span class="op" id="6319677">(</span><span class="ident" id="6319678">r</span>&nbsp;<span class="op" id="6319680">*</span><span class="ident" id="6319681">rpc</span><span class="op" id="6319684">.</span><span class="ident" id="6319685">Response</span><span class="op" id="6319693">)</span>&nbsp;<span class="builtintype" id="6319695">error</span>&nbsp;<span class="op" id="6319701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319704">c</span><span class="op" id="6319705">.</span><span class="ident" id="6319706">resp</span><span class="op" id="6319710">.</span><span class="ident" id="6319711">reset</span><span class="op" id="6319716">(</span><span class="op" id="6319717">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319720">if</span>&nbsp;<span class="ident" id="6319723">err</span>&nbsp;<span class="op" id="6319727">:=</span>&nbsp;<span class="ident" id="6319730">c</span><span class="op" id="6319731">.</span><span class="ident" id="6319732">dec</span><span class="op" id="6319735">.</span><span class="ident" id="6319736">Decode</span><span class="op" id="6319742">(</span><span class="op" id="6319743">&amp;</span><span class="ident" id="6319744">c</span><span class="op" id="6319745">.</span><span class="ident" id="6319746">resp</span><span class="op" id="6319750">)</span><span class="op" id="6319751">;</span>&nbsp;<span class="ident" id="6319753">err</span>&nbsp;<span class="op" id="6319757">!=</span>&nbsp;<span class="ident" id="6319760">nil</span>&nbsp;<span class="op" id="6319764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319768">return</span>&nbsp;<span class="ident" id="6319775">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6319780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319784">c</span><span class="op" id="6319785">.</span><span class="ident" id="6319786">mutex</span><span class="op" id="6319791">.</span><span class="ident" id="6319792">Lock</span><span class="op" id="6319796">(</span><span class="op" id="6319797">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319800">r</span><span class="op" id="6319801">.</span><span class="ident" id="6319802">ServiceMethod</span>&nbsp;<span class="op" id="6319816">=</span>&nbsp;<span class="ident" id="6319818">c</span><span class="op" id="6319819">.</span><span class="ident" id="6319820">pending</span><span class="op" id="6319827">[</span><span class="ident" id="6319828">c</span><span class="op" id="6319829">.</span><span class="ident" id="6319830">resp</span><span class="op" id="6319834">.</span><span class="ident" id="6319835">Id</span><span class="op" id="6319837">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6319840">delete</span><span class="op" id="6319846">(</span><span class="ident" id="6319847">c</span><span class="op" id="6319848">.</span><span class="ident" id="6319849">pending</span><span class="op" id="6319856">,</span>&nbsp;<span class="ident" id="6319858">c</span><span class="op" id="6319859">.</span><span class="ident" id="6319860">resp</span><span class="op" id="6319864">.</span><span class="ident" id="6319865">Id</span><span class="op" id="6319867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319870">c</span><span class="op" id="6319871">.</span><span class="ident" id="6319872">mutex</span><span class="op" id="6319877">.</span><span class="ident" id="6319878">Unlock</span><span class="op" id="6319884">(</span><span class="op" id="6319885">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319889">r</span><span class="op" id="6319890">.</span><span class="ident" id="6319891">Error</span>&nbsp;<span class="op" id="6319897">=</span>&nbsp;<span class="string" id="6319899">&#34;&#34;</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319903">r</span><span class="op" id="6319904">.</span><span class="ident" id="6319905">Seq</span>&nbsp;<span class="op" id="6319909">=</span>&nbsp;<span class="ident" id="6319911">c</span><span class="op" id="6319912">.</span><span class="ident" id="6319913">resp</span><span class="op" id="6319917">.</span><span class="ident" id="6319918">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319922">if</span>&nbsp;<span class="ident" id="6319925">c</span><span class="op" id="6319926">.</span><span class="ident" id="6319927">resp</span><span class="op" id="6319931">.</span><span class="ident" id="6319932">Error</span>&nbsp;<span class="op" id="6319938">!=</span>&nbsp;<span class="ident" id="6319941">nil</span>&nbsp;<span class="op" id="6319945">||</span>&nbsp;<span class="ident" id="6319948">c</span><span class="op" id="6319949">.</span><span class="ident" id="6319950">resp</span><span class="op" id="6319954">.</span><span class="ident" id="6319955">Result</span>&nbsp;<span class="op" id="6319962">==</span>&nbsp;<span class="ident" id="6319965">nil</span>&nbsp;<span class="op" id="6319969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319973">x</span><span class="op" id="6319974">,</span>&nbsp;<span class="ident" id="6319976">ok</span>&nbsp;<span class="op" id="6319979">:=</span>&nbsp;<span class="ident" id="6319982">c</span><span class="op" id="6319983">.</span><span class="ident" id="6319984">resp</span><span class="op" id="6319988">.</span><span class="ident" id="6319989">Error</span><span class="op" id="6319994">.</span><span class="op" id="6319995">(</span><span class="builtintype" id="6319996">string</span><span class="op" id="6320002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6320006">if</span>&nbsp;<span class="op" id="6320009">!</span><span class="ident" id="6320010">ok</span>&nbsp;<span class="op" id="6320013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6320018">return</span>&nbsp;<span class="ident" id="6320025">fmt</span><span class="op" id="6320028">.</span><span class="ident" id="6320029">Errorf</span><span class="op" id="6320035">(</span><span class="string" id="6320036">&#34;invalid&nbsp;error&nbsp;%v&#34;</span><span class="op" id="6320054">,</span>&nbsp;<span class="ident" id="6320056">c</span><span class="op" id="6320057">.</span><span class="ident" id="6320058">resp</span><span class="op" id="6320062">.</span><span class="ident" id="6320063">Error</span><span class="op" id="6320068">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6320072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6320076">if</span>&nbsp;<span class="ident" id="6320079">x</span>&nbsp;<span class="op" id="6320081">==</span>&nbsp;<span class="string" id="6320084">&#34;&#34;</span>&nbsp;<span class="op" id="6320087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6320092">x</span>&nbsp;<span class="op" id="6320094">=</span>&nbsp;<span class="string" id="6320096">&#34;unspecified&nbsp;error&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6320118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6320122">r</span><span class="op" id="6320123">.</span><span class="ident" id="6320124">Error</span>&nbsp;<span class="op" id="6320130">=</span>&nbsp;<span class="ident" id="6320132">x</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6320135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6320138">return</span>&nbsp;<span class="ident" id="6320145">nil</span><br>
<span class="lineno"></span><span class="op" id="6320149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6320152">func</span>&nbsp;<span class="op" id="6320157">(</span><span class="ident" id="6320158">c</span>&nbsp;<span class="op" id="6320160">*</span><span class="ident" id="6320161">clientCodec</span><span class="op" id="6320172">)</span>&nbsp;<span class="ident" id="6320174">ReadResponseBody</span><span class="op" id="6320190">(</span><span class="ident" id="6320191">x</span>&nbsp;<span class="keyword" id="6320193">interface</span><span class="op" id="6320202">{</span><span class="op" id="6320203">}</span><span class="op" id="6320204">)</span>&nbsp;<span class="builtintype" id="6320206">error</span>&nbsp;<span class="op" id="6320212">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6320215">if</span>&nbsp;<span class="ident" id="6320218">x</span>&nbsp;<span class="op" id="6320220">==</span>&nbsp;<span class="ident" id="6320223">nil</span>&nbsp;<span class="op" id="6320227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6320231">return</span>&nbsp;<span class="ident" id="6320238">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6320243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6320246">return</span>&nbsp;<span class="ident" id="6320253">json</span><span class="op" id="6320257">.</span><span class="ident" id="6320258">Unmarshal</span><span class="op" id="6320267">(</span><span class="op" id="6320268">*</span><span class="ident" id="6320269">c</span><span class="op" id="6320270">.</span><span class="ident" id="6320271">resp</span><span class="op" id="6320275">.</span><span class="ident" id="6320276">Result</span><span class="op" id="6320282">,</span>&nbsp;<span class="ident" id="6320284">x</span><span class="op" id="6320285">)</span><br>
<span class="lineno"></span><span class="op" id="6320287">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="6320290">func</span>&nbsp;<span class="op" id="6320295">(</span><span class="ident" id="6320296">c</span>&nbsp;<span class="op" id="6320298">*</span><span class="ident" id="6320299">clientCodec</span><span class="op" id="6320310">)</span>&nbsp;<span class="ident" id="6320312">Close</span><span class="op" id="6320317">(</span><span class="op" id="6320318">)</span>&nbsp;<span class="builtintype" id="6320320">error</span>&nbsp;<span class="op" id="6320326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6320329">return</span>&nbsp;<span class="ident" id="6320336">c</span><span class="op" id="6320337">.</span><span class="ident" id="6320338">c</span><span class="op" id="6320339">.</span><span class="ident" id="6320340">Close</span><span class="op" id="6320345">(</span><span class="op" id="6320346">)</span><br>
<span class="lineno"></span><span class="op" id="6320348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="6320351">//&nbsp;NewClient&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.Client&nbsp;to&nbsp;handle&nbsp;requests&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6320415">//&nbsp;set&nbsp;of&nbsp;services&nbsp;at&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6320470">func</span>&nbsp;<span class="ident" id="6320475">NewClient</span><span class="op" id="6320484">(</span><span class="ident" id="6320485">conn</span>&nbsp;<span class="ident" id="6320490">io</span><span class="op" id="6320492">.</span><span class="ident" id="6320493">ReadWriteCloser</span><span class="op" id="6320508">)</span>&nbsp;<span class="op" id="6320510">*</span><span class="ident" id="6320511">rpc</span><span class="op" id="6320514">.</span><span class="ident" id="6320515">Client</span>&nbsp;<span class="op" id="6320522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6320525">return</span>&nbsp;<span class="ident" id="6320532">rpc</span><span class="op" id="6320535">.</span><span class="ident" id="6320536">NewClientWithCodec</span><span class="op" id="6320554">(</span><span class="ident" id="6320555">NewClientCodec</span><span class="op" id="6320569">(</span><span class="ident" id="6320570">conn</span><span class="op" id="6320574">)</span><span class="op" id="6320575">)</span><br>
<span class="lineno"></span><span class="op" id="6320577">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="6320580">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;a&nbsp;JSON-RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="6320652">func</span>&nbsp;<span class="ident" id="6320657">Dial</span><span class="op" id="6320661">(</span><span class="ident" id="6320662">network</span><span class="op" id="6320669">,</span>&nbsp;<span class="ident" id="6320671">address</span>&nbsp;<span class="builtintype" id="6320679">string</span><span class="op" id="6320685">)</span>&nbsp;<span class="op" id="6320687">(</span><span class="op" id="6320688">*</span><span class="ident" id="6320689">rpc</span><span class="op" id="6320692">.</span><span class="ident" id="6320693">Client</span><span class="op" id="6320699">,</span>&nbsp;<span class="builtintype" id="6320701">error</span><span class="op" id="6320706">)</span>&nbsp;<span class="op" id="6320708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6320711">conn</span><span class="op" id="6320715">,</span>&nbsp;<span class="ident" id="6320717">err</span>&nbsp;<span class="op" id="6320721">:=</span>&nbsp;<span class="ident" id="6320724">net</span><span class="op" id="6320727">.</span><span class="ident" id="6320728">Dial</span><span class="op" id="6320732">(</span><span class="ident" id="6320733">network</span><span class="op" id="6320740">,</span>&nbsp;<span class="ident" id="6320742">address</span><span class="op" id="6320749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6320752">if</span>&nbsp;<span class="ident" id="6320755">err</span>&nbsp;<span class="op" id="6320759">!=</span>&nbsp;<span class="ident" id="6320762">nil</span>&nbsp;<span class="op" id="6320766">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6320770">return</span>&nbsp;<span class="ident" id="6320777">nil</span><span class="op" id="6320780">,</span>&nbsp;<span class="ident" id="6320782">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6320787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6320790">return</span>&nbsp;<span class="ident" id="6320797">NewClient</span><span class="op" id="6320806">(</span><span class="ident" id="6320807">conn</span><span class="op" id="6320811">)</span><span class="op" id="6320812">,</span>&nbsp;<span class="ident" id="6320814">err</span><br>
<span class="lineno"></span><span class="op" id="6320818">}</span>
</div>
</body>
</html>
