<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3291158">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3291214">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3291268">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3291319">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3291397">package</span>&nbsp;<span class="ident" id="3291405">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3291410">import</span>&nbsp;<span class="op" id="3291417">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3291420">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3291426">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3291432">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3291443">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3291450">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3291453">//&nbsp;BUG(rsc):&nbsp;On&nbsp;OpenBSD,&nbsp;listening&nbsp;on&nbsp;the&nbsp;&#34;tcp&#34;&nbsp;network&nbsp;does&nbsp;not&nbsp;listen&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3291529">//&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;connections.&nbsp;This&nbsp;is&nbsp;due&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;IPv4&nbsp;traffic</span><br>
<span class="lineno"></span><span class="comment" id="3291606">//&nbsp;will&nbsp;not&nbsp;be&nbsp;routed&nbsp;to&nbsp;an&nbsp;IPv6&nbsp;socket&nbsp;-&nbsp;two&nbsp;separate&nbsp;sockets&nbsp;are&nbsp;required</span><br>
<span class="lineno"></span><span class="comment" id="3291682">//&nbsp;if&nbsp;both&nbsp;AFs&nbsp;are&nbsp;to&nbsp;be&nbsp;supported.&nbsp;See&nbsp;inet6(4)&nbsp;on&nbsp;OpenBSD&nbsp;for&nbsp;details.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3291756">func</span>&nbsp;<span class="ident" id="3291761">sockaddrToTCP</span><span class="op" id="3291774">(</span><span class="ident" id="3291775">sa</span>&nbsp;<span class="ident" id="3291778">syscall</span><span class="op" id="3291785">.</span><span class="ident" id="3291786">Sockaddr</span><span class="op" id="3291794">)</span>&nbsp;<span class="ident" id="3291796">Addr</span>&nbsp;<span class="op" id="3291801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291804">switch</span>&nbsp;<span class="ident" id="3291811">sa</span>&nbsp;<span class="op" id="3291814">:=</span>&nbsp;<span class="ident" id="3291817">sa</span><span class="op" id="3291819">.</span><span class="op" id="3291820">(</span><span class="keyword" id="3291821">type</span><span class="op" id="3291825">)</span>&nbsp;<span class="op" id="3291827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291830">case</span>&nbsp;<span class="op" id="3291835">*</span><span class="ident" id="3291836">syscall</span><span class="op" id="3291843">.</span><span class="ident" id="3291844">SockaddrInet4</span><span class="op" id="3291857">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291861">return</span>&nbsp;<span class="op" id="3291868">&amp;</span><span class="ident" id="3291869">TCPAddr</span><span class="op" id="3291876">{</span><span class="ident" id="3291877">IP</span><span class="op" id="3291879">:</span>&nbsp;<span class="ident" id="3291881">sa</span><span class="op" id="3291883">.</span><span class="ident" id="3291884">Addr</span><span class="op" id="3291888">[</span><span class="num" id="3291889">0</span><span class="op" id="3291890">:</span><span class="op" id="3291891">]</span><span class="op" id="3291892">,</span>&nbsp;<span class="ident" id="3291894">Port</span><span class="op" id="3291898">:</span>&nbsp;<span class="ident" id="3291900">sa</span><span class="op" id="3291902">.</span><span class="ident" id="3291903">Port</span><span class="op" id="3291907">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291910">case</span>&nbsp;<span class="op" id="3291915">*</span><span class="ident" id="3291916">syscall</span><span class="op" id="3291923">.</span><span class="ident" id="3291924">SockaddrInet6</span><span class="op" id="3291937">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291941">return</span>&nbsp;<span class="op" id="3291948">&amp;</span><span class="ident" id="3291949">TCPAddr</span><span class="op" id="3291956">{</span><span class="ident" id="3291957">IP</span><span class="op" id="3291959">:</span>&nbsp;<span class="ident" id="3291961">sa</span><span class="op" id="3291963">.</span><span class="ident" id="3291964">Addr</span><span class="op" id="3291968">[</span><span class="num" id="3291969">0</span><span class="op" id="3291970">:</span><span class="op" id="3291971">]</span><span class="op" id="3291972">,</span>&nbsp;<span class="ident" id="3291974">Port</span><span class="op" id="3291978">:</span>&nbsp;<span class="ident" id="3291980">sa</span><span class="op" id="3291982">.</span><span class="ident" id="3291983">Port</span><span class="op" id="3291987">,</span>&nbsp;<span class="ident" id="3291989">Zone</span><span class="op" id="3291993">:</span>&nbsp;<span class="ident" id="3291995">zoneToString</span><span class="op" id="3292007">(</span><span class="builtintype" id="3292008">int</span><span class="op" id="3292011">(</span><span class="ident" id="3292012">sa</span><span class="op" id="3292014">.</span><span class="ident" id="3292015">ZoneId</span><span class="op" id="3292021">)</span><span class="op" id="3292022">)</span><span class="op" id="3292023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292029">return</span>&nbsp;<span class="ident" id="3292036">nil</span><br>
<span class="lineno"></span><span class="op" id="3292040">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3292043">func</span>&nbsp;<span class="op" id="3292048">(</span><span class="ident" id="3292049">a</span>&nbsp;<span class="op" id="3292051">*</span><span class="ident" id="3292052">TCPAddr</span><span class="op" id="3292059">)</span>&nbsp;<span class="ident" id="3292061">family</span><span class="op" id="3292067">(</span><span class="op" id="3292068">)</span>&nbsp;<span class="builtintype" id="3292070">int</span>&nbsp;<span class="op" id="3292074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292077">if</span>&nbsp;<span class="ident" id="3292080">a</span>&nbsp;<span class="op" id="3292082">==</span>&nbsp;<span class="ident" id="3292085">nil</span>&nbsp;<span class="op" id="3292089">||</span>&nbsp;<span class="builtinfunc" id="3292092">len</span><span class="op" id="3292095">(</span><span class="ident" id="3292096">a</span><span class="op" id="3292097">.</span><span class="ident" id="3292098">IP</span><span class="op" id="3292100">)</span>&nbsp;<span class="op" id="3292102">&lt;=</span>&nbsp;<span class="ident" id="3292105">IPv4len</span>&nbsp;<span class="op" id="3292113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292117">return</span>&nbsp;<span class="ident" id="3292124">syscall</span><span class="op" id="3292131">.</span><span class="ident" id="3292132">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292141">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292144">if</span>&nbsp;<span class="ident" id="3292147">a</span><span class="op" id="3292148">.</span><span class="ident" id="3292149">IP</span><span class="op" id="3292151">.</span><span class="ident" id="3292152">To4</span><span class="op" id="3292155">(</span><span class="op" id="3292156">)</span>&nbsp;<span class="op" id="3292158">!=</span>&nbsp;<span class="ident" id="3292161">nil</span>&nbsp;<span class="op" id="3292165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292169">return</span>&nbsp;<span class="ident" id="3292176">syscall</span><span class="op" id="3292183">.</span><span class="ident" id="3292184">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292196">return</span>&nbsp;<span class="ident" id="3292203">syscall</span><span class="op" id="3292210">.</span><span class="ident" id="3292211">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="3292220">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3292223">func</span>&nbsp;<span class="op" id="3292228">(</span><span class="ident" id="3292229">a</span>&nbsp;<span class="op" id="3292231">*</span><span class="ident" id="3292232">TCPAddr</span><span class="op" id="3292239">)</span>&nbsp;<span class="ident" id="3292241">isWildcard</span><span class="op" id="3292251">(</span><span class="op" id="3292252">)</span>&nbsp;<span class="builtintype" id="3292254">bool</span>&nbsp;<span class="op" id="3292259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292262">if</span>&nbsp;<span class="ident" id="3292265">a</span>&nbsp;<span class="op" id="3292267">==</span>&nbsp;<span class="ident" id="3292270">nil</span>&nbsp;<span class="op" id="3292274">||</span>&nbsp;<span class="ident" id="3292277">a</span><span class="op" id="3292278">.</span><span class="ident" id="3292279">IP</span>&nbsp;<span class="op" id="3292282">==</span>&nbsp;<span class="ident" id="3292285">nil</span>&nbsp;<span class="op" id="3292289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292293">return</span>&nbsp;<span class="builtintype" id="3292300">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292306">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292309">return</span>&nbsp;<span class="ident" id="3292316">a</span><span class="op" id="3292317">.</span><span class="ident" id="3292318">IP</span><span class="op" id="3292320">.</span><span class="ident" id="3292321">IsUnspecified</span><span class="op" id="3292334">(</span><span class="op" id="3292335">)</span><br>
<span class="lineno"></span><span class="op" id="3292337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3292340">func</span>&nbsp;<span class="op" id="3292345">(</span><span class="ident" id="3292346">a</span>&nbsp;<span class="op" id="3292348">*</span><span class="ident" id="3292349">TCPAddr</span><span class="op" id="3292356">)</span>&nbsp;<span class="ident" id="3292358">sockaddr</span><span class="op" id="3292366">(</span><span class="ident" id="3292367">family</span>&nbsp;<span class="builtintype" id="3292374">int</span><span class="op" id="3292377">)</span>&nbsp;<span class="op" id="3292379">(</span><span class="ident" id="3292380">syscall</span><span class="op" id="3292387">.</span><span class="ident" id="3292388">Sockaddr</span><span class="op" id="3292396">,</span>&nbsp;<span class="builtintype" id="3292398">error</span><span class="op" id="3292403">)</span>&nbsp;<span class="op" id="3292405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292408">if</span>&nbsp;<span class="ident" id="3292411">a</span>&nbsp;<span class="op" id="3292413">==</span>&nbsp;<span class="ident" id="3292416">nil</span>&nbsp;<span class="op" id="3292420">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292424">return</span>&nbsp;<span class="ident" id="3292431">nil</span><span class="op" id="3292434">,</span>&nbsp;<span class="ident" id="3292436">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292444">return</span>&nbsp;<span class="ident" id="3292451">ipToSockaddr</span><span class="op" id="3292463">(</span><span class="ident" id="3292464">family</span><span class="op" id="3292470">,</span>&nbsp;<span class="ident" id="3292472">a</span><span class="op" id="3292473">.</span><span class="ident" id="3292474">IP</span><span class="op" id="3292476">,</span>&nbsp;<span class="ident" id="3292478">a</span><span class="op" id="3292479">.</span><span class="ident" id="3292480">Port</span><span class="op" id="3292484">,</span>&nbsp;<span class="ident" id="3292486">a</span><span class="op" id="3292487">.</span><span class="ident" id="3292488">Zone</span><span class="op" id="3292492">)</span><br>
<span class="lineno"></span><span class="op" id="3292494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3292497">//&nbsp;TCPConn&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;interface&nbsp;for&nbsp;TCP&nbsp;network</span><br>
<span class="lineno"></span><span class="comment" id="3292567">//&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3292583">type</span>&nbsp;<span class="ident" id="3292588">TCPConn</span>&nbsp;<span class="keyword" id="3292596">struct</span>&nbsp;<span class="op" id="3292603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292606">conn</span><br>
<span class="lineno"></span><span class="op" id="3292611">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="3292614">func</span>&nbsp;<span class="ident" id="3292619">newTCPConn</span><span class="op" id="3292629">(</span><span class="ident" id="3292630">fd</span>&nbsp;<span class="op" id="3292633">*</span><span class="ident" id="3292634">netFD</span><span class="op" id="3292639">)</span>&nbsp;<span class="op" id="3292641">*</span><span class="ident" id="3292642">TCPConn</span>&nbsp;<span class="op" id="3292650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292653">c</span>&nbsp;<span class="op" id="3292655">:=</span>&nbsp;<span class="op" id="3292658">&amp;</span><span class="ident" id="3292659">TCPConn</span><span class="op" id="3292666">{</span><span class="ident" id="3292667">conn</span><span class="op" id="3292671">{</span><span class="ident" id="3292672">fd</span><span class="op" id="3292674">}</span><span class="op" id="3292675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292678">c</span><span class="op" id="3292679">.</span><span class="ident" id="3292680">SetNoDelay</span><span class="op" id="3292690">(</span><span class="builtintype" id="3292691">true</span><span class="op" id="3292695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292698">return</span>&nbsp;<span class="ident" id="3292705">c</span><br>
<span class="lineno">65</span><span class="op" id="3292707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3292710">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;io.ReaderFrom&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="3292768">func</span>&nbsp;<span class="op" id="3292773">(</span><span class="ident" id="3292774">c</span>&nbsp;<span class="op" id="3292776">*</span><span class="ident" id="3292777">TCPConn</span><span class="op" id="3292784">)</span>&nbsp;<span class="ident" id="3292786">ReadFrom</span><span class="op" id="3292794">(</span><span class="ident" id="3292795">r</span>&nbsp;<span class="ident" id="3292797">io</span><span class="op" id="3292799">.</span><span class="ident" id="3292800">Reader</span><span class="op" id="3292806">)</span>&nbsp;<span class="op" id="3292808">(</span><span class="ident" id="3292809">int64</span><span class="op" id="3292814">,</span>&nbsp;<span class="builtintype" id="3292816">error</span><span class="op" id="3292821">)</span>&nbsp;<span class="op" id="3292823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292826">if</span>&nbsp;<span class="ident" id="3292829">n</span><span class="op" id="3292830">,</span>&nbsp;<span class="ident" id="3292832">err</span><span class="op" id="3292835">,</span>&nbsp;<span class="ident" id="3292837">handled</span>&nbsp;<span class="op" id="3292845">:=</span>&nbsp;<span class="ident" id="3292848">sendFile</span><span class="op" id="3292856">(</span><span class="ident" id="3292857">c</span><span class="op" id="3292858">.</span><span class="ident" id="3292859">fd</span><span class="op" id="3292861">,</span>&nbsp;<span class="ident" id="3292863">r</span><span class="op" id="3292864">)</span><span class="op" id="3292865">;</span>&nbsp;<span class="ident" id="3292867">handled</span>&nbsp;<span class="op" id="3292875">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292879">return</span>&nbsp;<span class="ident" id="3292886">n</span><span class="op" id="3292887">,</span>&nbsp;<span class="ident" id="3292889">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292897">return</span>&nbsp;<span class="ident" id="3292904">genericReadFrom</span><span class="op" id="3292919">(</span><span class="ident" id="3292920">c</span><span class="op" id="3292921">,</span>&nbsp;<span class="ident" id="3292923">r</span><span class="op" id="3292924">)</span><br>
<span class="lineno"></span><span class="op" id="3292926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3292929">//&nbsp;CloseRead&nbsp;shuts&nbsp;down&nbsp;the&nbsp;reading&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3292993">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3293032">func</span>&nbsp;<span class="op" id="3293037">(</span><span class="ident" id="3293038">c</span>&nbsp;<span class="op" id="3293040">*</span><span class="ident" id="3293041">TCPConn</span><span class="op" id="3293048">)</span>&nbsp;<span class="ident" id="3293050">CloseRead</span><span class="op" id="3293059">(</span><span class="op" id="3293060">)</span>&nbsp;<span class="builtintype" id="3293062">error</span>&nbsp;<span class="op" id="3293068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293071">if</span>&nbsp;<span class="op" id="3293074">!</span><span class="ident" id="3293075">c</span><span class="op" id="3293076">.</span><span class="ident" id="3293077">ok</span><span class="op" id="3293079">(</span><span class="op" id="3293080">)</span>&nbsp;<span class="op" id="3293082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293086">return</span>&nbsp;<span class="ident" id="3293093">syscall</span><span class="op" id="3293100">.</span><span class="ident" id="3293101">EINVAL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293112">return</span>&nbsp;<span class="ident" id="3293119">c</span><span class="op" id="3293120">.</span><span class="ident" id="3293121">fd</span><span class="op" id="3293123">.</span><span class="ident" id="3293124">closeRead</span><span class="op" id="3293133">(</span><span class="op" id="3293134">)</span><br>
<span class="lineno"></span><span class="op" id="3293136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3293139">//&nbsp;CloseWrite&nbsp;shuts&nbsp;down&nbsp;the&nbsp;writing&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno">85</span><span class="comment" id="3293204">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3293243">func</span>&nbsp;<span class="op" id="3293248">(</span><span class="ident" id="3293249">c</span>&nbsp;<span class="op" id="3293251">*</span><span class="ident" id="3293252">TCPConn</span><span class="op" id="3293259">)</span>&nbsp;<span class="ident" id="3293261">CloseWrite</span><span class="op" id="3293271">(</span><span class="op" id="3293272">)</span>&nbsp;<span class="builtintype" id="3293274">error</span>&nbsp;<span class="op" id="3293280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293283">if</span>&nbsp;<span class="op" id="3293286">!</span><span class="ident" id="3293287">c</span><span class="op" id="3293288">.</span><span class="ident" id="3293289">ok</span><span class="op" id="3293291">(</span><span class="op" id="3293292">)</span>&nbsp;<span class="op" id="3293294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293298">return</span>&nbsp;<span class="ident" id="3293305">syscall</span><span class="op" id="3293312">.</span><span class="ident" id="3293313">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293321">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293324">return</span>&nbsp;<span class="ident" id="3293331">c</span><span class="op" id="3293332">.</span><span class="ident" id="3293333">fd</span><span class="op" id="3293335">.</span><span class="ident" id="3293336">closeWrite</span><span class="op" id="3293346">(</span><span class="op" id="3293347">)</span><br>
<span class="lineno"></span><span class="op" id="3293349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3293352">//&nbsp;SetLinger&nbsp;sets&nbsp;the&nbsp;behavior&nbsp;of&nbsp;Close&nbsp;on&nbsp;a&nbsp;connection&nbsp;which&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="3293420">//&nbsp;has&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;sent&nbsp;or&nbsp;to&nbsp;be&nbsp;acknowledged.</span><br>
<span class="lineno">95</span><span class="comment" id="3293474">//</span><br>
<span class="lineno"></span><span class="comment" id="3293477">//&nbsp;If&nbsp;sec&nbsp;&lt;&nbsp;0&nbsp;(the&nbsp;default),&nbsp;the&nbsp;operating&nbsp;system&nbsp;finishes&nbsp;sending&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3293548">//&nbsp;data&nbsp;in&nbsp;the&nbsp;background.</span><br>
<span class="lineno"></span><span class="comment" id="3293575">//</span><br>
<span class="lineno"></span><span class="comment" id="3293578">//&nbsp;If&nbsp;sec&nbsp;==&nbsp;0,&nbsp;the&nbsp;operating&nbsp;system&nbsp;discards&nbsp;any&nbsp;unsent&nbsp;or</span><br>
<span class="lineno">100</span><span class="comment" id="3293638">//&nbsp;unacknowledged&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3293662">//</span><br>
<span class="lineno"></span><span class="comment" id="3293665">//&nbsp;If&nbsp;sec&nbsp;&gt;&nbsp;0,&nbsp;the&nbsp;data&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;background&nbsp;as&nbsp;with&nbsp;sec&nbsp;&lt;&nbsp;0.&nbsp;On</span><br>
<span class="lineno"></span><span class="comment" id="3293735">//&nbsp;some&nbsp;operating&nbsp;systems&nbsp;after&nbsp;sec&nbsp;seconds&nbsp;have&nbsp;elapsed&nbsp;any&nbsp;remaining</span><br>
<span class="lineno"></span><span class="comment" id="3293806">//&nbsp;unsent&nbsp;data&nbsp;may&nbsp;be&nbsp;discarded.</span><br>
<span class="lineno">105</span><span class="keyword" id="3293839">func</span>&nbsp;<span class="op" id="3293844">(</span><span class="ident" id="3293845">c</span>&nbsp;<span class="op" id="3293847">*</span><span class="ident" id="3293848">TCPConn</span><span class="op" id="3293855">)</span>&nbsp;<span class="ident" id="3293857">SetLinger</span><span class="op" id="3293866">(</span><span class="ident" id="3293867">sec</span>&nbsp;<span class="builtintype" id="3293871">int</span><span class="op" id="3293874">)</span>&nbsp;<span class="builtintype" id="3293876">error</span>&nbsp;<span class="op" id="3293882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293885">if</span>&nbsp;<span class="op" id="3293888">!</span><span class="ident" id="3293889">c</span><span class="op" id="3293890">.</span><span class="ident" id="3293891">ok</span><span class="op" id="3293893">(</span><span class="op" id="3293894">)</span>&nbsp;<span class="op" id="3293896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293900">return</span>&nbsp;<span class="ident" id="3293907">syscall</span><span class="op" id="3293914">.</span><span class="ident" id="3293915">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293926">return</span>&nbsp;<span class="ident" id="3293933">setLinger</span><span class="op" id="3293942">(</span><span class="ident" id="3293943">c</span><span class="op" id="3293944">.</span><span class="ident" id="3293945">fd</span><span class="op" id="3293947">,</span>&nbsp;<span class="ident" id="3293949">sec</span><span class="op" id="3293952">)</span><br>
<span class="lineno">110</span><span class="op" id="3293954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3293957">//&nbsp;SetKeepAlive&nbsp;sets&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;send</span><br>
<span class="lineno"></span><span class="comment" id="3294019">//&nbsp;keepalive&nbsp;messages&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3294060">func</span>&nbsp;<span class="op" id="3294065">(</span><span class="ident" id="3294066">c</span>&nbsp;<span class="op" id="3294068">*</span><span class="ident" id="3294069">TCPConn</span><span class="op" id="3294076">)</span>&nbsp;<span class="ident" id="3294078">SetKeepAlive</span><span class="op" id="3294090">(</span><span class="ident" id="3294091">keepalive</span>&nbsp;<span class="builtintype" id="3294101">bool</span><span class="op" id="3294105">)</span>&nbsp;<span class="builtintype" id="3294107">error</span>&nbsp;<span class="op" id="3294113">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294116">if</span>&nbsp;<span class="op" id="3294119">!</span><span class="ident" id="3294120">c</span><span class="op" id="3294121">.</span><span class="ident" id="3294122">ok</span><span class="op" id="3294124">(</span><span class="op" id="3294125">)</span>&nbsp;<span class="op" id="3294127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294131">return</span>&nbsp;<span class="ident" id="3294138">syscall</span><span class="op" id="3294145">.</span><span class="ident" id="3294146">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3294154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294157">return</span>&nbsp;<span class="ident" id="3294164">setKeepAlive</span><span class="op" id="3294176">(</span><span class="ident" id="3294177">c</span><span class="op" id="3294178">.</span><span class="ident" id="3294179">fd</span><span class="op" id="3294181">,</span>&nbsp;<span class="ident" id="3294183">keepalive</span><span class="op" id="3294192">)</span><br>
<span class="lineno"></span><span class="op" id="3294194">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3294197">//&nbsp;SetKeepAlivePeriod&nbsp;sets&nbsp;period&nbsp;between&nbsp;keep&nbsp;alives.</span><br>
<span class="lineno"></span><span class="keyword" id="3294252">func</span>&nbsp;<span class="op" id="3294257">(</span><span class="ident" id="3294258">c</span>&nbsp;<span class="op" id="3294260">*</span><span class="ident" id="3294261">TCPConn</span><span class="op" id="3294268">)</span>&nbsp;<span class="ident" id="3294270">SetKeepAlivePeriod</span><span class="op" id="3294288">(</span><span class="ident" id="3294289">d</span>&nbsp;<span class="ident" id="3294291">time</span><span class="op" id="3294295">.</span><span class="ident" id="3294296">Duration</span><span class="op" id="3294304">)</span>&nbsp;<span class="builtintype" id="3294306">error</span>&nbsp;<span class="op" id="3294312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294315">if</span>&nbsp;<span class="op" id="3294318">!</span><span class="ident" id="3294319">c</span><span class="op" id="3294320">.</span><span class="ident" id="3294321">ok</span><span class="op" id="3294323">(</span><span class="op" id="3294324">)</span>&nbsp;<span class="op" id="3294326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294330">return</span>&nbsp;<span class="ident" id="3294337">syscall</span><span class="op" id="3294344">.</span><span class="ident" id="3294345">EINVAL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3294353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294356">return</span>&nbsp;<span class="ident" id="3294363">setKeepAlivePeriod</span><span class="op" id="3294381">(</span><span class="ident" id="3294382">c</span><span class="op" id="3294383">.</span><span class="ident" id="3294384">fd</span><span class="op" id="3294386">,</span>&nbsp;<span class="ident" id="3294388">d</span><span class="op" id="3294389">)</span><br>
<span class="lineno"></span><span class="op" id="3294391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3294394">//&nbsp;SetNoDelay&nbsp;controls&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;delay</span><br>
<span class="lineno">130</span><span class="comment" id="3294459">//&nbsp;packet&nbsp;transmission&nbsp;in&nbsp;hopes&nbsp;of&nbsp;sending&nbsp;fewer&nbsp;packets&nbsp;(Nagle&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3294525">//&nbsp;algorithm).&nbsp;&nbsp;The&nbsp;default&nbsp;is&nbsp;true&nbsp;(no&nbsp;delay),&nbsp;meaning&nbsp;that&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3294594">//&nbsp;sent&nbsp;as&nbsp;soon&nbsp;as&nbsp;possible&nbsp;after&nbsp;a&nbsp;Write.</span><br>
<span class="lineno"></span><span class="keyword" id="3294637">func</span>&nbsp;<span class="op" id="3294642">(</span><span class="ident" id="3294643">c</span>&nbsp;<span class="op" id="3294645">*</span><span class="ident" id="3294646">TCPConn</span><span class="op" id="3294653">)</span>&nbsp;<span class="ident" id="3294655">SetNoDelay</span><span class="op" id="3294665">(</span><span class="ident" id="3294666">noDelay</span>&nbsp;<span class="builtintype" id="3294674">bool</span><span class="op" id="3294678">)</span>&nbsp;<span class="builtintype" id="3294680">error</span>&nbsp;<span class="op" id="3294686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294689">if</span>&nbsp;<span class="op" id="3294692">!</span><span class="ident" id="3294693">c</span><span class="op" id="3294694">.</span><span class="ident" id="3294695">ok</span><span class="op" id="3294697">(</span><span class="op" id="3294698">)</span>&nbsp;<span class="op" id="3294700">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294704">return</span>&nbsp;<span class="ident" id="3294711">syscall</span><span class="op" id="3294718">.</span><span class="ident" id="3294719">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3294727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294730">return</span>&nbsp;<span class="ident" id="3294737">setNoDelay</span><span class="op" id="3294747">(</span><span class="ident" id="3294748">c</span><span class="op" id="3294749">.</span><span class="ident" id="3294750">fd</span><span class="op" id="3294752">,</span>&nbsp;<span class="ident" id="3294754">noDelay</span><span class="op" id="3294761">)</span><br>
<span class="lineno"></span><span class="op" id="3294763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3294766">//&nbsp;DialTCP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;net,</span><br>
<span class="lineno"></span><span class="comment" id="3294834">//&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;is&nbsp;not&nbsp;nil,&nbsp;it&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3294905">//&nbsp;used&nbsp;as&nbsp;the&nbsp;local&nbsp;address&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3294954">func</span>&nbsp;<span class="ident" id="3294959">DialTCP</span><span class="op" id="3294966">(</span><span class="ident" id="3294967">net</span>&nbsp;<span class="builtintype" id="3294971">string</span><span class="op" id="3294977">,</span>&nbsp;<span class="ident" id="3294979">laddr</span><span class="op" id="3294984">,</span>&nbsp;<span class="ident" id="3294986">raddr</span>&nbsp;<span class="op" id="3294992">*</span><span class="ident" id="3294993">TCPAddr</span><span class="op" id="3295000">)</span>&nbsp;<span class="op" id="3295002">(</span><span class="op" id="3295003">*</span><span class="ident" id="3295004">TCPConn</span><span class="op" id="3295011">,</span>&nbsp;<span class="builtintype" id="3295013">error</span><span class="op" id="3295018">)</span>&nbsp;<span class="op" id="3295020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295023">switch</span>&nbsp;<span class="ident" id="3295030">net</span>&nbsp;<span class="op" id="3295034">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295037">case</span>&nbsp;<span class="string" id="3295042">&#34;tcp&#34;</span><span class="op" id="3295047">,</span>&nbsp;<span class="string" id="3295049">&#34;tcp4&#34;</span><span class="op" id="3295055">,</span>&nbsp;<span class="string" id="3295057">&#34;tcp6&#34;</span><span class="op" id="3295063">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295066">default</span><span class="op" id="3295073">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295077">return</span>&nbsp;<span class="ident" id="3295084">nil</span><span class="op" id="3295087">,</span>&nbsp;<span class="op" id="3295089">&amp;</span><span class="ident" id="3295090">OpError</span><span class="op" id="3295097">{</span><span class="ident" id="3295098">Op</span><span class="op" id="3295100">:</span>&nbsp;<span class="string" id="3295102">&#34;dial&#34;</span><span class="op" id="3295108">,</span>&nbsp;<span class="ident" id="3295110">Net</span><span class="op" id="3295113">:</span>&nbsp;<span class="ident" id="3295115">net</span><span class="op" id="3295118">,</span>&nbsp;<span class="ident" id="3295120">Addr</span><span class="op" id="3295124">:</span>&nbsp;<span class="ident" id="3295126">raddr</span><span class="op" id="3295131">,</span>&nbsp;<span class="ident" id="3295133">Err</span><span class="op" id="3295136">:</span>&nbsp;<span class="ident" id="3295138">UnknownNetworkError</span><span class="op" id="3295157">(</span><span class="ident" id="3295158">net</span><span class="op" id="3295161">)</span><span class="op" id="3295162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295168">if</span>&nbsp;<span class="ident" id="3295171">raddr</span>&nbsp;<span class="op" id="3295177">==</span>&nbsp;<span class="ident" id="3295180">nil</span>&nbsp;<span class="op" id="3295184">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295188">return</span>&nbsp;<span class="ident" id="3295195">nil</span><span class="op" id="3295198">,</span>&nbsp;<span class="op" id="3295200">&amp;</span><span class="ident" id="3295201">OpError</span><span class="op" id="3295208">{</span><span class="ident" id="3295209">Op</span><span class="op" id="3295211">:</span>&nbsp;<span class="string" id="3295213">&#34;dial&#34;</span><span class="op" id="3295219">,</span>&nbsp;<span class="ident" id="3295221">Net</span><span class="op" id="3295224">:</span>&nbsp;<span class="ident" id="3295226">net</span><span class="op" id="3295229">,</span>&nbsp;<span class="ident" id="3295231">Addr</span><span class="op" id="3295235">:</span>&nbsp;<span class="ident" id="3295237">nil</span><span class="op" id="3295240">,</span>&nbsp;<span class="ident" id="3295242">Err</span><span class="op" id="3295245">:</span>&nbsp;<span class="ident" id="3295247">errMissingAddress</span><span class="op" id="3295264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295270">return</span>&nbsp;<span class="ident" id="3295277">dialTCP</span><span class="op" id="3295284">(</span><span class="ident" id="3295285">net</span><span class="op" id="3295288">,</span>&nbsp;<span class="ident" id="3295290">laddr</span><span class="op" id="3295295">,</span>&nbsp;<span class="ident" id="3295297">raddr</span><span class="op" id="3295302">,</span>&nbsp;<span class="ident" id="3295304">noDeadline</span><span class="op" id="3295314">)</span><br>
<span class="lineno"></span><span class="op" id="3295316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="3295319">func</span>&nbsp;<span class="ident" id="3295324">dialTCP</span><span class="op" id="3295331">(</span><span class="ident" id="3295332">net</span>&nbsp;<span class="builtintype" id="3295336">string</span><span class="op" id="3295342">,</span>&nbsp;<span class="ident" id="3295344">laddr</span><span class="op" id="3295349">,</span>&nbsp;<span class="ident" id="3295351">raddr</span>&nbsp;<span class="op" id="3295357">*</span><span class="ident" id="3295358">TCPAddr</span><span class="op" id="3295365">,</span>&nbsp;<span class="ident" id="3295367">deadline</span>&nbsp;<span class="ident" id="3295376">time</span><span class="op" id="3295380">.</span><span class="ident" id="3295381">Time</span><span class="op" id="3295385">)</span>&nbsp;<span class="op" id="3295387">(</span><span class="op" id="3295388">*</span><span class="ident" id="3295389">TCPConn</span><span class="op" id="3295396">,</span>&nbsp;<span class="builtintype" id="3295398">error</span><span class="op" id="3295403">)</span>&nbsp;<span class="op" id="3295405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295408">fd</span><span class="op" id="3295410">,</span>&nbsp;<span class="ident" id="3295412">err</span>&nbsp;<span class="op" id="3295416">:=</span>&nbsp;<span class="ident" id="3295419">internetSocket</span><span class="op" id="3295433">(</span><span class="ident" id="3295434">net</span><span class="op" id="3295437">,</span>&nbsp;<span class="ident" id="3295439">laddr</span><span class="op" id="3295444">,</span>&nbsp;<span class="ident" id="3295446">raddr</span><span class="op" id="3295451">,</span>&nbsp;<span class="ident" id="3295453">deadline</span><span class="op" id="3295461">,</span>&nbsp;<span class="ident" id="3295463">syscall</span><span class="op" id="3295470">.</span><span class="ident" id="3295471">SOCK_STREAM</span><span class="op" id="3295482">,</span>&nbsp;<span class="num" id="3295484">0</span><span class="op" id="3295485">,</span>&nbsp;<span class="string" id="3295487">&#34;dial&#34;</span><span class="op" id="3295493">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3295497">//&nbsp;TCP&nbsp;has&nbsp;a&nbsp;rarely&nbsp;used&nbsp;mechanism&nbsp;called&nbsp;a&nbsp;&#39;simultaneous&nbsp;connection&#39;&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3295571">//&nbsp;which&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr1,&nbsp;addr2)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine&nbsp;at&nbsp;addr1&nbsp;can</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3295639">//&nbsp;connect&nbsp;to&nbsp;a&nbsp;simultaneous&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr2,&nbsp;addr1)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3295714">//&nbsp;at&nbsp;addr2,&nbsp;without&nbsp;either&nbsp;machine&nbsp;executing&nbsp;Listen.&nbsp;&nbsp;If&nbsp;laddr&nbsp;==&nbsp;nil,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3295787">//&nbsp;it&nbsp;means&nbsp;we&nbsp;want&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate&nbsp;originating&nbsp;local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3295860">//&nbsp;address.&nbsp;&nbsp;Some&nbsp;Linux&nbsp;kernels&nbsp;cycle&nbsp;blindly&nbsp;through&nbsp;a&nbsp;fixed&nbsp;range&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3295932">//&nbsp;local&nbsp;ports,&nbsp;regardless&nbsp;of&nbsp;destination&nbsp;port.&nbsp;&nbsp;If&nbsp;a&nbsp;kernel&nbsp;happens&nbsp;to</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296005">//&nbsp;pick&nbsp;local&nbsp;port&nbsp;50001&nbsp;as&nbsp;the&nbsp;source&nbsp;for&nbsp;a&nbsp;Dial(&#34;tcp&#34;,&nbsp;&#34;&#34;,&nbsp;&#34;localhost:50001&#34;),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296087">//&nbsp;then&nbsp;the&nbsp;Dial&nbsp;will&nbsp;succeed,&nbsp;having&nbsp;simultaneously&nbsp;connected&nbsp;to&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296162">//&nbsp;This&nbsp;can&nbsp;only&nbsp;happen&nbsp;when&nbsp;we&nbsp;are&nbsp;letting&nbsp;the&nbsp;kernel&nbsp;pick&nbsp;a&nbsp;port&nbsp;(laddr&nbsp;==&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296245">//&nbsp;and&nbsp;when&nbsp;there&nbsp;is&nbsp;no&nbsp;listener&nbsp;for&nbsp;the&nbsp;destination&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296308">//&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;argue&nbsp;this&nbsp;is&nbsp;anything&nbsp;other&nbsp;than&nbsp;a&nbsp;kernel&nbsp;bug.&nbsp;&nbsp;If&nbsp;we</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296380">//&nbsp;see&nbsp;this&nbsp;happen,&nbsp;rather&nbsp;than&nbsp;expose&nbsp;the&nbsp;buggy&nbsp;effect&nbsp;to&nbsp;users,&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296450">//&nbsp;close&nbsp;the&nbsp;fd&nbsp;and&nbsp;try&nbsp;again.&nbsp;&nbsp;If&nbsp;it&nbsp;happens&nbsp;twice&nbsp;more,&nbsp;we&nbsp;relent&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296523">//&nbsp;use&nbsp;the&nbsp;result.&nbsp;&nbsp;See&nbsp;also:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296554">//&nbsp;&nbsp;&nbsp;&nbsphttp://golang.org/issue/2690</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296587">//&nbsp;&nbsp;&nbsp;&nbsphttp://stackoverflow.com/questions/4949858/</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296635">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296639">//&nbsp;The&nbsp;opposite&nbsp;can&nbsp;also&nbsp;happen:&nbsp;if&nbsp;we&nbsp;ask&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296717">//&nbsp;originating&nbsp;local&nbsp;address,&nbsp;sometimes&nbsp;it&nbsp;picks&nbsp;one&nbsp;that&nbsp;is&nbsp;already&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296795">//&nbsp;So&nbsp;if&nbsp;the&nbsp;error&nbsp;is&nbsp;EADDRNOTAVAIL,&nbsp;we&nbsp;have&nbsp;to&nbsp;try&nbsp;again&nbsp;too,&nbsp;just&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296868">//&nbsp;a&nbsp;different&nbsp;reason.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296892">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296896">//&nbsp;The&nbsp;kernel&nbsp;socket&nbsp;code&nbsp;is&nbsp;no&nbsp;doubt&nbsp;enjoying&nbsp;watching&nbsp;us&nbsp;squirm.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296964">for</span>&nbsp;<span class="ident" id="3296968">i</span>&nbsp;<span class="op" id="3296970">:=</span>&nbsp;<span class="num" id="3296973">0</span><span class="op" id="3296974">;</span>&nbsp;<span class="ident" id="3296976">i</span>&nbsp;<span class="op" id="3296978">&lt;</span>&nbsp;<span class="num" id="3296980">2</span>&nbsp;<span class="op" id="3296982">&amp;&amp;</span>&nbsp;<span class="op" id="3296985">(</span><span class="ident" id="3296986">laddr</span>&nbsp;<span class="op" id="3296992">==</span>&nbsp;<span class="ident" id="3296995">nil</span>&nbsp;<span class="op" id="3296999">||</span>&nbsp;<span class="ident" id="3297002">laddr</span><span class="op" id="3297007">.</span><span class="ident" id="3297008">Port</span>&nbsp;<span class="op" id="3297013">==</span>&nbsp;<span class="num" id="3297016">0</span><span class="op" id="3297017">)</span>&nbsp;<span class="op" id="3297019">&amp;&amp;</span>&nbsp;<span class="op" id="3297022">(</span><span class="ident" id="3297023">selfConnect</span><span class="op" id="3297034">(</span><span class="ident" id="3297035">fd</span><span class="op" id="3297037">,</span>&nbsp;<span class="ident" id="3297039">err</span><span class="op" id="3297042">)</span>&nbsp;<span class="op" id="3297044">||</span>&nbsp;<span class="ident" id="3297047">spuriousENOTAVAIL</span><span class="op" id="3297064">(</span><span class="ident" id="3297065">err</span><span class="op" id="3297068">)</span><span class="op" id="3297069">)</span><span class="op" id="3297070">;</span>&nbsp;<span class="ident" id="3297072">i</span><span class="op" id="3297073">++</span>&nbsp;<span class="op" id="3297076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297080">if</span>&nbsp;<span class="ident" id="3297083">err</span>&nbsp;<span class="op" id="3297087">==</span>&nbsp;<span class="ident" id="3297090">nil</span>&nbsp;<span class="op" id="3297094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297099">fd</span><span class="op" id="3297101">.</span><span class="ident" id="3297102">Close</span><span class="op" id="3297107">(</span><span class="op" id="3297108">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297116">fd</span><span class="op" id="3297118">,</span>&nbsp;<span class="ident" id="3297120">err</span>&nbsp;<span class="op" id="3297124">=</span>&nbsp;<span class="ident" id="3297126">internetSocket</span><span class="op" id="3297140">(</span><span class="ident" id="3297141">net</span><span class="op" id="3297144">,</span>&nbsp;<span class="ident" id="3297146">laddr</span><span class="op" id="3297151">,</span>&nbsp;<span class="ident" id="3297153">raddr</span><span class="op" id="3297158">,</span>&nbsp;<span class="ident" id="3297160">deadline</span><span class="op" id="3297168">,</span>&nbsp;<span class="ident" id="3297170">syscall</span><span class="op" id="3297177">.</span><span class="ident" id="3297178">SOCK_STREAM</span><span class="op" id="3297189">,</span>&nbsp;<span class="num" id="3297191">0</span><span class="op" id="3297192">,</span>&nbsp;<span class="string" id="3297194">&#34;dial&#34;</span><span class="op" id="3297200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297207">if</span>&nbsp;<span class="ident" id="3297210">err</span>&nbsp;<span class="op" id="3297214">!=</span>&nbsp;<span class="ident" id="3297217">nil</span>&nbsp;<span class="op" id="3297221">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297225">return</span>&nbsp;<span class="ident" id="3297232">nil</span><span class="op" id="3297235">,</span>&nbsp;<span class="op" id="3297237">&amp;</span><span class="ident" id="3297238">OpError</span><span class="op" id="3297245">{</span><span class="ident" id="3297246">Op</span><span class="op" id="3297248">:</span>&nbsp;<span class="string" id="3297250">&#34;dial&#34;</span><span class="op" id="3297256">,</span>&nbsp;<span class="ident" id="3297258">Net</span><span class="op" id="3297261">:</span>&nbsp;<span class="ident" id="3297263">net</span><span class="op" id="3297266">,</span>&nbsp;<span class="ident" id="3297268">Addr</span><span class="op" id="3297272">:</span>&nbsp;<span class="ident" id="3297274">raddr</span><span class="op" id="3297279">,</span>&nbsp;<span class="ident" id="3297281">Err</span><span class="op" id="3297284">:</span>&nbsp;<span class="ident" id="3297286">err</span><span class="op" id="3297289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297295">return</span>&nbsp;<span class="ident" id="3297302">newTCPConn</span><span class="op" id="3297312">(</span><span class="ident" id="3297313">fd</span><span class="op" id="3297315">)</span><span class="op" id="3297316">,</span>&nbsp;<span class="ident" id="3297318">nil</span><br>
<span class="lineno"></span><span class="op" id="3297322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="3297325">func</span>&nbsp;<span class="ident" id="3297330">selfConnect</span><span class="op" id="3297341">(</span><span class="ident" id="3297342">fd</span>&nbsp;<span class="op" id="3297345">*</span><span class="ident" id="3297346">netFD</span><span class="op" id="3297351">,</span>&nbsp;<span class="ident" id="3297353">err</span>&nbsp;<span class="builtintype" id="3297357">error</span><span class="op" id="3297362">)</span>&nbsp;<span class="builtintype" id="3297364">bool</span>&nbsp;<span class="op" id="3297369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297372">//&nbsp;If&nbsp;the&nbsp;connect&nbsp;failed,&nbsp;we&nbsp;clearly&nbsp;didn&#39;t&nbsp;connect&nbsp;to&nbsp;ourselves.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297439">if</span>&nbsp;<span class="ident" id="3297442">err</span>&nbsp;<span class="op" id="3297446">!=</span>&nbsp;<span class="ident" id="3297449">nil</span>&nbsp;<span class="op" id="3297453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297457">return</span>&nbsp;<span class="builtintype" id="3297464">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297471">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297475">//&nbsp;The&nbsp;socket&nbsp;constructor&nbsp;can&nbsp;return&nbsp;an&nbsp;fd&nbsp;with&nbsp;raddr&nbsp;nil&nbsp;under&nbsp;certain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297548">//&nbsp;unknown&nbsp;conditions.&nbsp;The&nbsp;errors&nbsp;in&nbsp;the&nbsp;calls&nbsp;there&nbsp;to&nbsp;Getpeername</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297617">//&nbsp;are&nbsp;discarded,&nbsp;but&nbsp;we&nbsp;can&#39;t&nbsp;catch&nbsp;the&nbsp;problem&nbsp;there&nbsp;because&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297687">//&nbsp;calls&nbsp;are&nbsp;sometimes&nbsp;legally&nbsp;erroneous&nbsp;with&nbsp;a&nbsp;&#34;socket&nbsp;not&nbsp;connected&#34;.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297760">//&nbsp;Since&nbsp;this&nbsp;code&nbsp;(selfConnect)&nbsp;is&nbsp;already&nbsp;trying&nbsp;to&nbsp;work&nbsp;around</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297827">//&nbsp;a&nbsp;problem,&nbsp;we&nbsp;make&nbsp;sure&nbsp;if&nbsp;this&nbsp;happens&nbsp;we&nbsp;recognize&nbsp;trouble&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297896">//&nbsp;ask&nbsp;the&nbsp;DialTCP&nbsp;routine&nbsp;to&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297938">//&nbsp;TODO:&nbsp;try&nbsp;to&nbsp;understand&nbsp;what&#39;s&nbsp;really&nbsp;going&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297990">if</span>&nbsp;<span class="ident" id="3297993">fd</span><span class="op" id="3297995">.</span><span class="ident" id="3297996">laddr</span>&nbsp;<span class="op" id="3298002">==</span>&nbsp;<span class="ident" id="3298005">nil</span>&nbsp;<span class="op" id="3298009">||</span>&nbsp;<span class="ident" id="3298012">fd</span><span class="op" id="3298014">.</span><span class="ident" id="3298015">raddr</span>&nbsp;<span class="op" id="3298021">==</span>&nbsp;<span class="ident" id="3298024">nil</span>&nbsp;<span class="op" id="3298028">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298032">return</span>&nbsp;<span class="builtintype" id="3298039">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3298045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298048">l</span>&nbsp;<span class="op" id="3298050">:=</span>&nbsp;<span class="ident" id="3298053">fd</span><span class="op" id="3298055">.</span><span class="ident" id="3298056">laddr</span><span class="op" id="3298061">.</span><span class="op" id="3298062">(</span><span class="op" id="3298063">*</span><span class="ident" id="3298064">TCPAddr</span><span class="op" id="3298071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298074">r</span>&nbsp;<span class="op" id="3298076">:=</span>&nbsp;<span class="ident" id="3298079">fd</span><span class="op" id="3298081">.</span><span class="ident" id="3298082">raddr</span><span class="op" id="3298087">.</span><span class="op" id="3298088">(</span><span class="op" id="3298089">*</span><span class="ident" id="3298090">TCPAddr</span><span class="op" id="3298097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298100">return</span>&nbsp;<span class="ident" id="3298107">l</span><span class="op" id="3298108">.</span><span class="ident" id="3298109">Port</span>&nbsp;<span class="op" id="3298114">==</span>&nbsp;<span class="ident" id="3298117">r</span><span class="op" id="3298118">.</span><span class="ident" id="3298119">Port</span>&nbsp;<span class="op" id="3298124">&amp;&amp;</span>&nbsp;<span class="ident" id="3298127">l</span><span class="op" id="3298128">.</span><span class="ident" id="3298129">IP</span><span class="op" id="3298131">.</span><span class="ident" id="3298132">Equal</span><span class="op" id="3298137">(</span><span class="ident" id="3298138">r</span><span class="op" id="3298139">.</span><span class="ident" id="3298140">IP</span><span class="op" id="3298142">)</span><br>
<span class="lineno">215</span><span class="op" id="3298144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3298147">func</span>&nbsp;<span class="ident" id="3298152">spuriousENOTAVAIL</span><span class="op" id="3298169">(</span><span class="ident" id="3298170">err</span>&nbsp;<span class="builtintype" id="3298174">error</span><span class="op" id="3298179">)</span>&nbsp;<span class="builtintype" id="3298181">bool</span>&nbsp;<span class="op" id="3298186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298189">e</span><span class="op" id="3298190">,</span>&nbsp;<span class="ident" id="3298192">ok</span>&nbsp;<span class="op" id="3298195">:=</span>&nbsp;<span class="ident" id="3298198">err</span><span class="op" id="3298201">.</span><span class="op" id="3298202">(</span><span class="op" id="3298203">*</span><span class="ident" id="3298204">OpError</span><span class="op" id="3298211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298214">return</span>&nbsp;<span class="ident" id="3298221">ok</span>&nbsp;<span class="op" id="3298224">&amp;&amp;</span>&nbsp;<span class="ident" id="3298227">e</span><span class="op" id="3298228">.</span><span class="ident" id="3298229">Err</span>&nbsp;<span class="op" id="3298233">==</span>&nbsp;<span class="ident" id="3298236">syscall</span><span class="op" id="3298243">.</span><span class="ident" id="3298244">EADDRNOTAVAIL</span><br>
<span class="lineno">220</span><span class="op" id="3298258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3298261">//&nbsp;TCPListener&nbsp;is&nbsp;a&nbsp;TCP&nbsp;network&nbsp;listener.&nbsp;&nbsp;Clients&nbsp;should&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="3298329">//&nbsp;use&nbsp;variables&nbsp;of&nbsp;type&nbsp;Listener&nbsp;instead&nbsp;of&nbsp;assuming&nbsp;TCP.</span><br>
<span class="lineno"></span><span class="keyword" id="3298388">type</span>&nbsp;<span class="ident" id="3298393">TCPListener</span>&nbsp;<span class="keyword" id="3298405">struct</span>&nbsp;<span class="op" id="3298412">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298415">fd</span>&nbsp;<span class="op" id="3298418">*</span><span class="ident" id="3298419">netFD</span><br>
<span class="lineno"></span><span class="op" id="3298425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3298428">//&nbsp;AcceptTCP&nbsp;accepts&nbsp;the&nbsp;next&nbsp;incoming&nbsp;call&nbsp;and&nbsp;returns&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="3298492">//&nbsp;connection.</span><br>
<span class="lineno">230</span><span class="keyword" id="3298507">func</span>&nbsp;<span class="op" id="3298512">(</span><span class="ident" id="3298513">l</span>&nbsp;<span class="op" id="3298515">*</span><span class="ident" id="3298516">TCPListener</span><span class="op" id="3298527">)</span>&nbsp;<span class="ident" id="3298529">AcceptTCP</span><span class="op" id="3298538">(</span><span class="op" id="3298539">)</span>&nbsp;<span class="op" id="3298541">(</span><span class="op" id="3298542">*</span><span class="ident" id="3298543">TCPConn</span><span class="op" id="3298550">,</span>&nbsp;<span class="builtintype" id="3298552">error</span><span class="op" id="3298557">)</span>&nbsp;<span class="op" id="3298559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298562">if</span>&nbsp;<span class="ident" id="3298565">l</span>&nbsp;<span class="op" id="3298567">==</span>&nbsp;<span class="ident" id="3298570">nil</span>&nbsp;<span class="op" id="3298574">||</span>&nbsp;<span class="ident" id="3298577">l</span><span class="op" id="3298578">.</span><span class="ident" id="3298579">fd</span>&nbsp;<span class="op" id="3298582">==</span>&nbsp;<span class="ident" id="3298585">nil</span>&nbsp;<span class="op" id="3298589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298593">return</span>&nbsp;<span class="ident" id="3298600">nil</span><span class="op" id="3298603">,</span>&nbsp;<span class="ident" id="3298605">syscall</span><span class="op" id="3298612">.</span><span class="ident" id="3298613">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3298621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298624">fd</span><span class="op" id="3298626">,</span>&nbsp;<span class="ident" id="3298628">err</span>&nbsp;<span class="op" id="3298632">:=</span>&nbsp;<span class="ident" id="3298635">l</span><span class="op" id="3298636">.</span><span class="ident" id="3298637">fd</span><span class="op" id="3298639">.</span><span class="ident" id="3298640">accept</span><span class="op" id="3298646">(</span><span class="op" id="3298647">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298650">if</span>&nbsp;<span class="ident" id="3298653">err</span>&nbsp;<span class="op" id="3298657">!=</span>&nbsp;<span class="ident" id="3298660">nil</span>&nbsp;<span class="op" id="3298664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298668">return</span>&nbsp;<span class="ident" id="3298675">nil</span><span class="op" id="3298678">,</span>&nbsp;<span class="ident" id="3298680">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3298685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298688">return</span>&nbsp;<span class="ident" id="3298695">newTCPConn</span><span class="op" id="3298705">(</span><span class="ident" id="3298706">fd</span><span class="op" id="3298708">)</span><span class="op" id="3298709">,</span>&nbsp;<span class="ident" id="3298711">nil</span><br>
<span class="lineno"></span><span class="op" id="3298715">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="3298718">//&nbsp;Accept&nbsp;implements&nbsp;the&nbsp;Accept&nbsp;method&nbsp;in&nbsp;the&nbsp;Listener&nbsp;interface;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3298787">//&nbsp;waits&nbsp;for&nbsp;the&nbsp;next&nbsp;call&nbsp;and&nbsp;returns&nbsp;a&nbsp;generic&nbsp;Conn.</span><br>
<span class="lineno"></span><span class="keyword" id="3298842">func</span>&nbsp;<span class="op" id="3298847">(</span><span class="ident" id="3298848">l</span>&nbsp;<span class="op" id="3298850">*</span><span class="ident" id="3298851">TCPListener</span><span class="op" id="3298862">)</span>&nbsp;<span class="ident" id="3298864">Accept</span><span class="op" id="3298870">(</span><span class="op" id="3298871">)</span>&nbsp;<span class="op" id="3298873">(</span><span class="ident" id="3298874">Conn</span><span class="op" id="3298878">,</span>&nbsp;<span class="builtintype" id="3298880">error</span><span class="op" id="3298885">)</span>&nbsp;<span class="op" id="3298887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298890">c</span><span class="op" id="3298891">,</span>&nbsp;<span class="ident" id="3298893">err</span>&nbsp;<span class="op" id="3298897">:=</span>&nbsp;<span class="ident" id="3298900">l</span><span class="op" id="3298901">.</span><span class="ident" id="3298902">AcceptTCP</span><span class="op" id="3298911">(</span><span class="op" id="3298912">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298915">if</span>&nbsp;<span class="ident" id="3298918">err</span>&nbsp;<span class="op" id="3298922">!=</span>&nbsp;<span class="ident" id="3298925">nil</span>&nbsp;<span class="op" id="3298929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298933">return</span>&nbsp;<span class="ident" id="3298940">nil</span><span class="op" id="3298943">,</span>&nbsp;<span class="ident" id="3298945">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3298950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298953">return</span>&nbsp;<span class="ident" id="3298960">c</span><span class="op" id="3298961">,</span>&nbsp;<span class="ident" id="3298963">nil</span><br>
<span class="lineno"></span><span class="op" id="3298967">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="3298970">//&nbsp;Close&nbsp;stops&nbsp;listening&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="3299015">//&nbsp;Already&nbsp;Accepted&nbsp;connections&nbsp;are&nbsp;not&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="3299063">func</span>&nbsp;<span class="op" id="3299068">(</span><span class="ident" id="3299069">l</span>&nbsp;<span class="op" id="3299071">*</span><span class="ident" id="3299072">TCPListener</span><span class="op" id="3299083">)</span>&nbsp;<span class="ident" id="3299085">Close</span><span class="op" id="3299090">(</span><span class="op" id="3299091">)</span>&nbsp;<span class="builtintype" id="3299093">error</span>&nbsp;<span class="op" id="3299099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299102">if</span>&nbsp;<span class="ident" id="3299105">l</span>&nbsp;<span class="op" id="3299107">==</span>&nbsp;<span class="ident" id="3299110">nil</span>&nbsp;<span class="op" id="3299114">||</span>&nbsp;<span class="ident" id="3299117">l</span><span class="op" id="3299118">.</span><span class="ident" id="3299119">fd</span>&nbsp;<span class="op" id="3299122">==</span>&nbsp;<span class="ident" id="3299125">nil</span>&nbsp;<span class="op" id="3299129">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299133">return</span>&nbsp;<span class="ident" id="3299140">syscall</span><span class="op" id="3299147">.</span><span class="ident" id="3299148">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299159">return</span>&nbsp;<span class="ident" id="3299166">l</span><span class="op" id="3299167">.</span><span class="ident" id="3299168">fd</span><span class="op" id="3299170">.</span><span class="ident" id="3299171">Close</span><span class="op" id="3299176">(</span><span class="op" id="3299177">)</span><br>
<span class="lineno"></span><span class="op" id="3299179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="3299182">//&nbsp;Addr&nbsp;returns&nbsp;the&nbsp;listener&#39;s&nbsp;network&nbsp;address,&nbsp;a&nbsp;*TCPAddr.</span><br>
<span class="lineno"></span><span class="keyword" id="3299242">func</span>&nbsp;<span class="op" id="3299247">(</span><span class="ident" id="3299248">l</span>&nbsp;<span class="op" id="3299250">*</span><span class="ident" id="3299251">TCPListener</span><span class="op" id="3299262">)</span>&nbsp;<span class="ident" id="3299264">Addr</span><span class="op" id="3299268">(</span><span class="op" id="3299269">)</span>&nbsp;<span class="ident" id="3299271">Addr</span>&nbsp;<span class="op" id="3299276">{</span>&nbsp;<span class="keyword" id="3299278">return</span>&nbsp;<span class="ident" id="3299285">l</span><span class="op" id="3299286">.</span><span class="ident" id="3299287">fd</span><span class="op" id="3299289">.</span><span class="ident" id="3299290">laddr</span>&nbsp;<span class="op" id="3299296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3299299">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;deadline&nbsp;associated&nbsp;with&nbsp;the&nbsp;listener.</span><br>
<span class="lineno"></span><span class="comment" id="3299362">//&nbsp;A&nbsp;zero&nbsp;time&nbsp;value&nbsp;disables&nbsp;the&nbsp;deadline.</span><br>
<span class="lineno">265</span><span class="keyword" id="3299406">func</span>&nbsp;<span class="op" id="3299411">(</span><span class="ident" id="3299412">l</span>&nbsp;<span class="op" id="3299414">*</span><span class="ident" id="3299415">TCPListener</span><span class="op" id="3299426">)</span>&nbsp;<span class="ident" id="3299428">SetDeadline</span><span class="op" id="3299439">(</span><span class="ident" id="3299440">t</span>&nbsp;<span class="ident" id="3299442">time</span><span class="op" id="3299446">.</span><span class="ident" id="3299447">Time</span><span class="op" id="3299451">)</span>&nbsp;<span class="builtintype" id="3299453">error</span>&nbsp;<span class="op" id="3299459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299462">if</span>&nbsp;<span class="ident" id="3299465">l</span>&nbsp;<span class="op" id="3299467">==</span>&nbsp;<span class="ident" id="3299470">nil</span>&nbsp;<span class="op" id="3299474">||</span>&nbsp;<span class="ident" id="3299477">l</span><span class="op" id="3299478">.</span><span class="ident" id="3299479">fd</span>&nbsp;<span class="op" id="3299482">==</span>&nbsp;<span class="ident" id="3299485">nil</span>&nbsp;<span class="op" id="3299489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299493">return</span>&nbsp;<span class="ident" id="3299500">syscall</span><span class="op" id="3299507">.</span><span class="ident" id="3299508">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299519">return</span>&nbsp;<span class="ident" id="3299526">l</span><span class="op" id="3299527">.</span><span class="ident" id="3299528">fd</span><span class="op" id="3299530">.</span><span class="ident" id="3299531">setDeadline</span><span class="op" id="3299542">(</span><span class="ident" id="3299543">t</span><span class="op" id="3299544">)</span><br>
<span class="lineno">270</span><span class="op" id="3299546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3299549">//&nbsp;File&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;underlying&nbsp;os.File,&nbsp;set&nbsp;to&nbsp;blocking</span><br>
<span class="lineno"></span><span class="comment" id="3299615">//&nbsp;mode.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;close&nbsp;f&nbsp;when&nbsp;finished.</span><br>
<span class="lineno"></span><span class="comment" id="3299685">//&nbsp;Closing&nbsp;l&nbsp;does&nbsp;not&nbsp;affect&nbsp;f,&nbsp;and&nbsp;closing&nbsp;f&nbsp;does&nbsp;not&nbsp;affect&nbsp;l.</span><br>
<span class="lineno">275</span><span class="comment" id="3299750">//</span><br>
<span class="lineno"></span><span class="comment" id="3299753">//&nbsp;The&nbsp;returned&nbsp;os.File&#39;s&nbsp;file&nbsp;descriptor&nbsp;is&nbsp;different&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3299817">//&nbsp;connection&#39;s.&nbsp;&nbsp;Attempting&nbsp;to&nbsp;change&nbsp;properties&nbsp;of&nbsp;the&nbsp;original</span><br>
<span class="lineno"></span><span class="comment" id="3299883">//&nbsp;using&nbsp;this&nbsp;duplicate&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;have&nbsp;the&nbsp;desired&nbsp;effect.</span><br>
<span class="lineno"></span><span class="keyword" id="3299947">func</span>&nbsp;<span class="op" id="3299952">(</span><span class="ident" id="3299953">l</span>&nbsp;<span class="op" id="3299955">*</span><span class="ident" id="3299956">TCPListener</span><span class="op" id="3299967">)</span>&nbsp;<span class="ident" id="3299969">File</span><span class="op" id="3299973">(</span><span class="op" id="3299974">)</span>&nbsp;<span class="op" id="3299976">(</span><span class="ident" id="3299977">f</span>&nbsp;<span class="op" id="3299979">*</span><span class="ident" id="3299980">os</span><span class="op" id="3299982">.</span><span class="ident" id="3299983">File</span><span class="op" id="3299987">,</span>&nbsp;<span class="ident" id="3299989">err</span>&nbsp;<span class="builtintype" id="3299993">error</span><span class="op" id="3299998">)</span>&nbsp;<span class="op" id="3300000">{</span>&nbsp;<span class="keyword" id="3300002">return</span>&nbsp;<span class="ident" id="3300009">l</span><span class="op" id="3300010">.</span><span class="ident" id="3300011">fd</span><span class="op" id="3300013">.</span><span class="ident" id="3300014">dup</span><span class="op" id="3300017">(</span><span class="op" id="3300018">)</span>&nbsp;<span class="op" id="3300020">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3300023">//&nbsp;ListenTCP&nbsp;announces&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address&nbsp;laddr&nbsp;and&nbsp;returns&nbsp;a&nbsp;TCP</span><br>
<span class="lineno"></span><span class="comment" id="3300089">//&nbsp;listener.&nbsp;&nbsp;Net&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;has&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3300157">//&nbsp;port&nbsp;of&nbsp;0,&nbsp;ListenTCP&nbsp;will&nbsp;choose&nbsp;an&nbsp;available&nbsp;port.&nbsp;&nbsp;The&nbsp;caller&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="3300228">//&nbsp;use&nbsp;the&nbsp;Addr&nbsp;method&nbsp;of&nbsp;TCPListener&nbsp;to&nbsp;retrieve&nbsp;the&nbsp;chosen&nbsp;address.</span><br>
<span class="lineno">285</span><span class="keyword" id="3300298">func</span>&nbsp;<span class="ident" id="3300303">ListenTCP</span><span class="op" id="3300312">(</span><span class="ident" id="3300313">net</span>&nbsp;<span class="builtintype" id="3300317">string</span><span class="op" id="3300323">,</span>&nbsp;<span class="ident" id="3300325">laddr</span>&nbsp;<span class="op" id="3300331">*</span><span class="ident" id="3300332">TCPAddr</span><span class="op" id="3300339">)</span>&nbsp;<span class="op" id="3300341">(</span><span class="op" id="3300342">*</span><span class="ident" id="3300343">TCPListener</span><span class="op" id="3300354">,</span>&nbsp;<span class="builtintype" id="3300356">error</span><span class="op" id="3300361">)</span>&nbsp;<span class="op" id="3300363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300366">switch</span>&nbsp;<span class="ident" id="3300373">net</span>&nbsp;<span class="op" id="3300377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300380">case</span>&nbsp;<span class="string" id="3300385">&#34;tcp&#34;</span><span class="op" id="3300390">,</span>&nbsp;<span class="string" id="3300392">&#34;tcp4&#34;</span><span class="op" id="3300398">,</span>&nbsp;<span class="string" id="3300400">&#34;tcp6&#34;</span><span class="op" id="3300406">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300409">default</span><span class="op" id="3300416">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300420">return</span>&nbsp;<span class="ident" id="3300427">nil</span><span class="op" id="3300430">,</span>&nbsp;<span class="op" id="3300432">&amp;</span><span class="ident" id="3300433">OpError</span><span class="op" id="3300440">{</span><span class="ident" id="3300441">Op</span><span class="op" id="3300443">:</span>&nbsp;<span class="string" id="3300445">&#34;listen&#34;</span><span class="op" id="3300453">,</span>&nbsp;<span class="ident" id="3300455">Net</span><span class="op" id="3300458">:</span>&nbsp;<span class="ident" id="3300460">net</span><span class="op" id="3300463">,</span>&nbsp;<span class="ident" id="3300465">Addr</span><span class="op" id="3300469">:</span>&nbsp;<span class="ident" id="3300471">laddr</span><span class="op" id="3300476">,</span>&nbsp;<span class="ident" id="3300478">Err</span><span class="op" id="3300481">:</span>&nbsp;<span class="ident" id="3300483">UnknownNetworkError</span><span class="op" id="3300502">(</span><span class="ident" id="3300503">net</span><span class="op" id="3300506">)</span><span class="op" id="3300507">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300513">if</span>&nbsp;<span class="ident" id="3300516">laddr</span>&nbsp;<span class="op" id="3300522">==</span>&nbsp;<span class="ident" id="3300525">nil</span>&nbsp;<span class="op" id="3300529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300533">laddr</span>&nbsp;<span class="op" id="3300539">=</span>&nbsp;<span class="op" id="3300541">&amp;</span><span class="ident" id="3300542">TCPAddr</span><span class="op" id="3300549">{</span><span class="op" id="3300550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300556">fd</span><span class="op" id="3300558">,</span>&nbsp;<span class="ident" id="3300560">err</span>&nbsp;<span class="op" id="3300564">:=</span>&nbsp;<span class="ident" id="3300567">internetSocket</span><span class="op" id="3300581">(</span><span class="ident" id="3300582">net</span><span class="op" id="3300585">,</span>&nbsp;<span class="ident" id="3300587">laddr</span><span class="op" id="3300592">,</span>&nbsp;<span class="ident" id="3300594">nil</span><span class="op" id="3300597">,</span>&nbsp;<span class="ident" id="3300599">noDeadline</span><span class="op" id="3300609">,</span>&nbsp;<span class="ident" id="3300611">syscall</span><span class="op" id="3300618">.</span><span class="ident" id="3300619">SOCK_STREAM</span><span class="op" id="3300630">,</span>&nbsp;<span class="num" id="3300632">0</span><span class="op" id="3300633">,</span>&nbsp;<span class="string" id="3300635">&#34;listen&#34;</span><span class="op" id="3300643">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300646">if</span>&nbsp;<span class="ident" id="3300649">err</span>&nbsp;<span class="op" id="3300653">!=</span>&nbsp;<span class="ident" id="3300656">nil</span>&nbsp;<span class="op" id="3300660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300664">return</span>&nbsp;<span class="ident" id="3300671">nil</span><span class="op" id="3300674">,</span>&nbsp;<span class="op" id="3300676">&amp;</span><span class="ident" id="3300677">OpError</span><span class="op" id="3300684">{</span><span class="ident" id="3300685">Op</span><span class="op" id="3300687">:</span>&nbsp;<span class="string" id="3300689">&#34;listen&#34;</span><span class="op" id="3300697">,</span>&nbsp;<span class="ident" id="3300699">Net</span><span class="op" id="3300702">:</span>&nbsp;<span class="ident" id="3300704">net</span><span class="op" id="3300707">,</span>&nbsp;<span class="ident" id="3300709">Addr</span><span class="op" id="3300713">:</span>&nbsp;<span class="ident" id="3300715">laddr</span><span class="op" id="3300720">,</span>&nbsp;<span class="ident" id="3300722">Err</span><span class="op" id="3300725">:</span>&nbsp;<span class="ident" id="3300727">err</span><span class="op" id="3300730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300736">return</span>&nbsp;<span class="op" id="3300743">&amp;</span><span class="ident" id="3300744">TCPListener</span><span class="op" id="3300755">{</span><span class="ident" id="3300756">fd</span><span class="op" id="3300758">}</span><span class="op" id="3300759">,</span>&nbsp;<span class="ident" id="3300761">nil</span><br>
<span class="lineno"></span><span class="op" id="3300765">}</span>
</div>
</body>
</html>
