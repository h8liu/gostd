<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/flate</h2>
<ul>
<li><a href="/gostd/compress/flate/copy.go.html">copy.go</a></li>
<li><a href="/gostd/compress/flate/copy_test.go.html">copy_test.go</a></li>
<li><a href="/gostd/compress/flate/deflate.go.html" class="current">deflate.go</a></li>
<li><a href="/gostd/compress/flate/deflate_test.go.html">deflate_test.go</a></li>
<li><a href="/gostd/compress/flate/fixedhuff.go.html">fixedhuff.go</a></li>
<li><a href="/gostd/compress/flate/flate_test.go.html">flate_test.go</a></li>
<li><a href="/gostd/compress/flate/huffman_bit_writer.go.html">huffman_bit_writer.go</a></li>
<li><a href="/gostd/compress/flate/huffman_code.go.html">huffman_code.go</a></li>
<li><a href="/gostd/compress/flate/inflate.go.html">inflate.go</a></li>
<li><a href="/gostd/compress/flate/inflate_test.go.html">inflate_test.go</a></li>
<li><a href="/gostd/compress/flate/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/flate/reverse_bits.go.html">reverse_bits.go</a></li>
<li><a href="/gostd/compress/flate/token.go.html">token.go</a></li>
<li><a href="/gostd/compress/flate/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4350972">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4351027">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4351081">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4351132">package</span>&nbsp;<span class="ident" id="4351140">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4351147">import</span>&nbsp;<span class="op" id="4351154">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4351157">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4351164">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4351170">&#34;math&#34;</span><br>
<span class="lineno"></span><span class="op" id="4351177">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4351180">const</span>&nbsp;<span class="op" id="4351186">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351189">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351208">=</span>&nbsp;<span class="num" id="4351210">0</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351213">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351232">=</span>&nbsp;<span class="num" id="4351234">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351237">fastCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351256">=</span>&nbsp;<span class="num" id="4351258">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351261">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351280">=</span>&nbsp;<span class="num" id="4351282">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351285">DefaultCompression</span>&nbsp;<span class="op" id="4351304">=</span>&nbsp;<span class="op" id="4351306">-</span><span class="num" id="4351307">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351310">logWindowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351329">=</span>&nbsp;<span class="num" id="4351331">15</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351335">windowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351354">=</span>&nbsp;<span class="num" id="4351356">1</span>&nbsp;<span class="op" id="4351358">&lt;&lt;</span>&nbsp;<span class="ident" id="4351361">logWindowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351376">windowMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351395">=</span>&nbsp;<span class="ident" id="4351397">windowSize</span>&nbsp;<span class="op" id="4351408">-</span>&nbsp;<span class="num" id="4351410">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351413">logMaxOffsetSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4351432">=</span>&nbsp;<span class="num" id="4351434">15</span>&nbsp;&nbsp;<span class="comment" id="4351438">//&nbsp;Standard&nbsp;DEFLATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351459">minMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351478">=</span>&nbsp;<span class="num" id="4351480">3</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4351484">//&nbsp;The&nbsp;smallest&nbsp;match&nbsp;that&nbsp;the&nbsp;compressor&nbsp;looks&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351537">maxMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351556">=</span>&nbsp;<span class="num" id="4351558">258</span>&nbsp;<span class="comment" id="4351562">//&nbsp;The&nbsp;longest&nbsp;match&nbsp;for&nbsp;the&nbsp;compressor</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351603">minOffsetSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351622">=</span>&nbsp;<span class="num" id="4351624">1</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4351628">//&nbsp;The&nbsp;shortest&nbsp;offset&nbsp;that&nbsp;makes&nbsp;any&nbsp;sense</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4351674">//&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;tokens&nbsp;we&nbsp;put&nbsp;into&nbsp;a&nbsp;single&nbsp;flat&nbsp;block,&nbsp;just&nbsp;too</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4351749">//&nbsp;stop&nbsp;things&nbsp;from&nbsp;getting&nbsp;too&nbsp;large.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351789">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4351809">=</span>&nbsp;<span class="num" id="4351811">1</span>&nbsp;<span class="op" id="4351813">&lt;&lt;</span>&nbsp;<span class="num" id="4351816">14</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351820">maxStoreBlockSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4351840">=</span>&nbsp;<span class="num" id="4351842">65535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351849">hashBits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351869">=</span>&nbsp;<span class="num" id="4351871">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351875">hashSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351895">=</span>&nbsp;<span class="num" id="4351897">1</span>&nbsp;<span class="op" id="4351899">&lt;&lt;</span>&nbsp;<span class="ident" id="4351902">hashBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351912">hashMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351932">=</span>&nbsp;<span class="op" id="4351934">(</span><span class="num" id="4351935">1</span>&nbsp;<span class="op" id="4351937">&lt;&lt;</span>&nbsp;<span class="ident" id="4351940">hashBits</span><span class="op" id="4351948">)</span>&nbsp;<span class="op" id="4351950">-</span>&nbsp;<span class="num" id="4351952">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4351955">hashShift</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4351975">=</span>&nbsp;<span class="op" id="4351977">(</span><span class="ident" id="4351978">hashBits</span>&nbsp;<span class="op" id="4351987">+</span>&nbsp;<span class="ident" id="4351989">minMatchLength</span>&nbsp;<span class="op" id="4352004">-</span>&nbsp;<span class="num" id="4352006">1</span><span class="op" id="4352007">)</span>&nbsp;<span class="op" id="4352009">/</span>&nbsp;<span class="ident" id="4352011">minMatchLength</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352027">maxHashOffset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352047">=</span>&nbsp;<span class="num" id="4352049">1</span>&nbsp;<span class="op" id="4352051">&lt;&lt;</span>&nbsp;<span class="num" id="4352054">24</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352059">skipNever</span>&nbsp;<span class="op" id="4352069">=</span>&nbsp;<span class="ident" id="4352071">math</span><span class="op" id="4352075">.</span><span class="ident" id="4352076">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="4352085">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="4352088">type</span>&nbsp;<span class="ident" id="4352093">compressionLevel</span>&nbsp;<span class="keyword" id="4352110">struct</span>&nbsp;<span class="op" id="4352117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352120">good</span><span class="op" id="4352124">,</span>&nbsp;<span class="ident" id="4352126">lazy</span><span class="op" id="4352130">,</span>&nbsp;<span class="ident" id="4352132">nice</span><span class="op" id="4352136">,</span>&nbsp;<span class="ident" id="4352138">chain</span><span class="op" id="4352143">,</span>&nbsp;<span class="ident" id="4352145">fastSkipHashing</span>&nbsp;<span class="builtintype" id="4352161">int</span><br>
<span class="lineno"></span><span class="op" id="4352165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4352168">var</span>&nbsp;<span class="ident" id="4352172">levels</span>&nbsp;<span class="op" id="4352179">=</span>&nbsp;<span class="op" id="4352181">[</span><span class="op" id="4352182">]</span><span class="ident" id="4352183">compressionLevel</span><span class="op" id="4352199">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352202">{</span><span class="op" id="4352203">}</span><span class="op" id="4352204">,</span>&nbsp;<span class="comment" id="4352206">//&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4352212">//&nbsp;For&nbsp;levels&nbsp;1-3&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;trying&nbsp;with&nbsp;lazy&nbsp;matches</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352272">{</span><span class="num" id="4352273">3</span><span class="op" id="4352274">,</span>&nbsp;<span class="num" id="4352276">0</span><span class="op" id="4352277">,</span>&nbsp;<span class="num" id="4352279">8</span><span class="op" id="4352280">,</span>&nbsp;<span class="num" id="4352282">4</span><span class="op" id="4352283">,</span>&nbsp;<span class="num" id="4352285">4</span><span class="op" id="4352286">}</span><span class="op" id="4352287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352290">{</span><span class="num" id="4352291">3</span><span class="op" id="4352292">,</span>&nbsp;<span class="num" id="4352294">0</span><span class="op" id="4352295">,</span>&nbsp;<span class="num" id="4352297">16</span><span class="op" id="4352299">,</span>&nbsp;<span class="num" id="4352301">8</span><span class="op" id="4352302">,</span>&nbsp;<span class="num" id="4352304">5</span><span class="op" id="4352305">}</span><span class="op" id="4352306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352309">{</span><span class="num" id="4352310">3</span><span class="op" id="4352311">,</span>&nbsp;<span class="num" id="4352313">0</span><span class="op" id="4352314">,</span>&nbsp;<span class="num" id="4352316">32</span><span class="op" id="4352318">,</span>&nbsp;<span class="num" id="4352320">32</span><span class="op" id="4352322">,</span>&nbsp;<span class="num" id="4352324">6</span><span class="op" id="4352325">}</span><span class="op" id="4352326">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4352329">//&nbsp;Levels&nbsp;4-9&nbsp;use&nbsp;increasingly&nbsp;more&nbsp;lazy&nbsp;matching</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4352380">//&nbsp;and&nbsp;increasingly&nbsp;stringent&nbsp;conditions&nbsp;for&nbsp;&#34;good&nbsp;enough&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352441">{</span><span class="num" id="4352442">4</span><span class="op" id="4352443">,</span>&nbsp;<span class="num" id="4352445">4</span><span class="op" id="4352446">,</span>&nbsp;<span class="num" id="4352448">16</span><span class="op" id="4352450">,</span>&nbsp;<span class="num" id="4352452">16</span><span class="op" id="4352454">,</span>&nbsp;<span class="ident" id="4352456">skipNever</span><span class="op" id="4352465">}</span><span class="op" id="4352466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352469">{</span><span class="num" id="4352470">8</span><span class="op" id="4352471">,</span>&nbsp;<span class="num" id="4352473">16</span><span class="op" id="4352475">,</span>&nbsp;<span class="num" id="4352477">32</span><span class="op" id="4352479">,</span>&nbsp;<span class="num" id="4352481">32</span><span class="op" id="4352483">,</span>&nbsp;<span class="ident" id="4352485">skipNever</span><span class="op" id="4352494">}</span><span class="op" id="4352495">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352498">{</span><span class="num" id="4352499">8</span><span class="op" id="4352500">,</span>&nbsp;<span class="num" id="4352502">16</span><span class="op" id="4352504">,</span>&nbsp;<span class="num" id="4352506">128</span><span class="op" id="4352509">,</span>&nbsp;<span class="num" id="4352511">128</span><span class="op" id="4352514">,</span>&nbsp;<span class="ident" id="4352516">skipNever</span><span class="op" id="4352525">}</span><span class="op" id="4352526">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352529">{</span><span class="num" id="4352530">8</span><span class="op" id="4352531">,</span>&nbsp;<span class="num" id="4352533">32</span><span class="op" id="4352535">,</span>&nbsp;<span class="num" id="4352537">128</span><span class="op" id="4352540">,</span>&nbsp;<span class="num" id="4352542">256</span><span class="op" id="4352545">,</span>&nbsp;<span class="ident" id="4352547">skipNever</span><span class="op" id="4352556">}</span><span class="op" id="4352557">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352560">{</span><span class="num" id="4352561">32</span><span class="op" id="4352563">,</span>&nbsp;<span class="num" id="4352565">128</span><span class="op" id="4352568">,</span>&nbsp;<span class="num" id="4352570">258</span><span class="op" id="4352573">,</span>&nbsp;<span class="num" id="4352575">1024</span><span class="op" id="4352579">,</span>&nbsp;<span class="ident" id="4352581">skipNever</span><span class="op" id="4352590">}</span><span class="op" id="4352591">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4352594">{</span><span class="num" id="4352595">32</span><span class="op" id="4352597">,</span>&nbsp;<span class="num" id="4352599">258</span><span class="op" id="4352602">,</span>&nbsp;<span class="num" id="4352604">258</span><span class="op" id="4352607">,</span>&nbsp;<span class="num" id="4352609">4096</span><span class="op" id="4352613">,</span>&nbsp;<span class="ident" id="4352615">skipNever</span><span class="op" id="4352624">}</span><span class="op" id="4352625">,</span><br>
<span class="lineno"></span><span class="op" id="4352627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4352630">type</span>&nbsp;<span class="ident" id="4352635">compressor</span>&nbsp;<span class="keyword" id="4352646">struct</span>&nbsp;<span class="op" id="4352653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352656">compressionLevel</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352675">w</span>&nbsp;<span class="op" id="4352677">*</span><span class="ident" id="4352678">huffmanBitWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4352697">//&nbsp;compression&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352723">fill</span>&nbsp;<span class="keyword" id="4352728">func</span><span class="op" id="4352732">(</span><span class="op" id="4352733">*</span><span class="ident" id="4352734">compressor</span><span class="op" id="4352744">,</span>&nbsp;<span class="op" id="4352746">[</span><span class="op" id="4352747">]</span><span class="builtintype" id="4352748">byte</span><span class="op" id="4352752">)</span>&nbsp;<span class="builtintype" id="4352754">int</span>&nbsp;<span class="comment" id="4352758">//&nbsp;copy&nbsp;data&nbsp;to&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352782">step</span>&nbsp;<span class="keyword" id="4352787">func</span><span class="op" id="4352791">(</span><span class="op" id="4352792">*</span><span class="ident" id="4352793">compressor</span><span class="op" id="4352803">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4352817">//&nbsp;process&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4352836">sync</span>&nbsp;<span class="builtintype" id="4352841">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4352871">//&nbsp;requesting&nbsp;flush</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4352893">//&nbsp;Input&nbsp;hash&nbsp;chains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4352915">//&nbsp;hashHead[hashValue]&nbsp;contains&nbsp;the&nbsp;largest&nbsp;inputIndex&nbsp;with&nbsp;the&nbsp;specified&nbsp;hash&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353001">//&nbsp;If&nbsp;hashHead[hashValue]&nbsp;is&nbsp;within&nbsp;the&nbsp;current&nbsp;window,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353063">//&nbsp;hashPrev[hashHead[hashValue]&nbsp;&amp;&nbsp;windowMask]&nbsp;contains&nbsp;the&nbsp;previous&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353138">//&nbsp;with&nbsp;the&nbsp;same&nbsp;hash&nbsp;value.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353168">chainHead</span>&nbsp;&nbsp;<span class="builtintype" id="4353179">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353184">hashHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4353195">[</span><span class="op" id="4353196">]</span><span class="builtintype" id="4353197">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353202">hashPrev</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4353213">[</span><span class="op" id="4353214">]</span><span class="builtintype" id="4353215">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353220">hashOffset</span>&nbsp;<span class="builtintype" id="4353231">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353237">//&nbsp;input&nbsp;window:&nbsp;unprocessed&nbsp;data&nbsp;is&nbsp;window[index:windowEnd]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353299">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4353313">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353318">window</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4353332">[</span><span class="op" id="4353333">]</span><span class="builtintype" id="4353334">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353340">windowEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4353354">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353359">blockStart</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4353373">int</span>&nbsp;&nbsp;<span class="comment" id="4353378">//&nbsp;window&nbsp;index&nbsp;where&nbsp;current&nbsp;tokens&nbsp;start</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353422">byteAvailable</span>&nbsp;<span class="builtintype" id="4353436">bool</span>&nbsp;<span class="comment" id="4353441">//&nbsp;if&nbsp;true,&nbsp;still&nbsp;need&nbsp;to&nbsp;process&nbsp;window[index-1].</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353494">//&nbsp;queued&nbsp;output&nbsp;tokens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353519">tokens</span>&nbsp;<span class="op" id="4353526">[</span><span class="op" id="4353527">]</span><span class="ident" id="4353528">token</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353536">//&nbsp;deflate&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353554">length</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4353569">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353574">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4353589">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353594">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4353609">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353614">maxInsertIndex</span>&nbsp;<span class="builtintype" id="4353629">int</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353634">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4353649">error</span><br>
<span class="lineno"></span><span class="op" id="4353655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4353658">func</span>&nbsp;<span class="op" id="4353663">(</span><span class="ident" id="4353664">d</span>&nbsp;<span class="op" id="4353666">*</span><span class="ident" id="4353667">compressor</span><span class="op" id="4353677">)</span>&nbsp;<span class="ident" id="4353679">fillDeflate</span><span class="op" id="4353690">(</span><span class="ident" id="4353691">b</span>&nbsp;<span class="op" id="4353693">[</span><span class="op" id="4353694">]</span><span class="builtintype" id="4353695">byte</span><span class="op" id="4353699">)</span>&nbsp;<span class="builtintype" id="4353701">int</span>&nbsp;<span class="op" id="4353705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4353708">if</span>&nbsp;<span class="ident" id="4353711">d</span><span class="op" id="4353712">.</span><span class="ident" id="4353713">index</span>&nbsp;<span class="op" id="4353719">&gt;=</span>&nbsp;<span class="num" id="4353722">2</span><span class="op" id="4353723">*</span><span class="ident" id="4353724">windowSize</span><span class="op" id="4353734">-</span><span class="op" id="4353735">(</span><span class="ident" id="4353736">minMatchLength</span><span class="op" id="4353750">+</span><span class="ident" id="4353751">maxMatchLength</span><span class="op" id="4353765">)</span>&nbsp;<span class="op" id="4353767">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4353771">//&nbsp;shift&nbsp;the&nbsp;window&nbsp;by&nbsp;windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4353807">copy</span><span class="op" id="4353811">(</span><span class="ident" id="4353812">d</span><span class="op" id="4353813">.</span><span class="ident" id="4353814">window</span><span class="op" id="4353820">,</span>&nbsp;<span class="ident" id="4353822">d</span><span class="op" id="4353823">.</span><span class="ident" id="4353824">window</span><span class="op" id="4353830">[</span><span class="ident" id="4353831">windowSize</span><span class="op" id="4353841">:</span><span class="num" id="4353842">2</span><span class="op" id="4353843">*</span><span class="ident" id="4353844">windowSize</span><span class="op" id="4353854">]</span><span class="op" id="4353855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353859">d</span><span class="op" id="4353860">.</span><span class="ident" id="4353861">index</span>&nbsp;<span class="op" id="4353867">-=</span>&nbsp;<span class="ident" id="4353870">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353883">d</span><span class="op" id="4353884">.</span><span class="ident" id="4353885">windowEnd</span>&nbsp;<span class="op" id="4353895">-=</span>&nbsp;<span class="ident" id="4353898">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4353911">if</span>&nbsp;<span class="ident" id="4353914">d</span><span class="op" id="4353915">.</span><span class="ident" id="4353916">blockStart</span>&nbsp;<span class="op" id="4353927">&gt;=</span>&nbsp;<span class="ident" id="4353930">windowSize</span>&nbsp;<span class="op" id="4353941">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353946">d</span><span class="op" id="4353947">.</span><span class="ident" id="4353948">blockStart</span>&nbsp;<span class="op" id="4353959">-=</span>&nbsp;<span class="ident" id="4353962">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4353975">}</span>&nbsp;<span class="keyword" id="4353977">else</span>&nbsp;<span class="op" id="4353982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4353987">d</span><span class="op" id="4353988">.</span><span class="ident" id="4353989">blockStart</span>&nbsp;<span class="op" id="4354000">=</span>&nbsp;<span class="ident" id="4354002">math</span><span class="op" id="4354006">.</span><span class="ident" id="4354007">MaxInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4354018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354022">d</span><span class="op" id="4354023">.</span><span class="ident" id="4354024">hashOffset</span>&nbsp;<span class="op" id="4354035">+=</span>&nbsp;<span class="ident" id="4354038">windowSize</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354051">if</span>&nbsp;<span class="ident" id="4354054">d</span><span class="op" id="4354055">.</span><span class="ident" id="4354056">hashOffset</span>&nbsp;<span class="op" id="4354067">&gt;</span>&nbsp;<span class="ident" id="4354069">maxHashOffset</span>&nbsp;<span class="op" id="4354083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354088">delta</span>&nbsp;<span class="op" id="4354094">:=</span>&nbsp;<span class="ident" id="4354097">d</span><span class="op" id="4354098">.</span><span class="ident" id="4354099">hashOffset</span>&nbsp;<span class="op" id="4354110">-</span>&nbsp;<span class="num" id="4354112">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354117">d</span><span class="op" id="4354118">.</span><span class="ident" id="4354119">hashOffset</span>&nbsp;<span class="op" id="4354130">-=</span>&nbsp;<span class="ident" id="4354133">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354142">d</span><span class="op" id="4354143">.</span><span class="ident" id="4354144">chainHead</span>&nbsp;<span class="op" id="4354154">-=</span>&nbsp;<span class="ident" id="4354157">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354166">for</span>&nbsp;<span class="ident" id="4354170">i</span><span class="op" id="4354171">,</span>&nbsp;<span class="ident" id="4354173">v</span>&nbsp;<span class="op" id="4354175">:=</span>&nbsp;<span class="keyword" id="4354178">range</span>&nbsp;<span class="ident" id="4354184">d</span><span class="op" id="4354185">.</span><span class="ident" id="4354186">hashPrev</span>&nbsp;<span class="op" id="4354195">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354201">if</span>&nbsp;<span class="ident" id="4354204">v</span>&nbsp;<span class="op" id="4354206">&gt;</span>&nbsp;<span class="ident" id="4354208">delta</span>&nbsp;<span class="op" id="4354214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354221">d</span><span class="op" id="4354222">.</span><span class="ident" id="4354223">hashPrev</span><span class="op" id="4354231">[</span><span class="ident" id="4354232">i</span><span class="op" id="4354233">]</span>&nbsp;<span class="op" id="4354235">-=</span>&nbsp;<span class="ident" id="4354238">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4354248">}</span>&nbsp;<span class="keyword" id="4354250">else</span>&nbsp;<span class="op" id="4354255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354262">d</span><span class="op" id="4354263">.</span><span class="ident" id="4354264">hashPrev</span><span class="op" id="4354272">[</span><span class="ident" id="4354273">i</span><span class="op" id="4354274">]</span>&nbsp;<span class="op" id="4354276">=</span>&nbsp;<span class="num" id="4354278">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4354284">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4354289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354294">for</span>&nbsp;<span class="ident" id="4354298">i</span><span class="op" id="4354299">,</span>&nbsp;<span class="ident" id="4354301">v</span>&nbsp;<span class="op" id="4354303">:=</span>&nbsp;<span class="keyword" id="4354306">range</span>&nbsp;<span class="ident" id="4354312">d</span><span class="op" id="4354313">.</span><span class="ident" id="4354314">hashHead</span>&nbsp;<span class="op" id="4354323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354329">if</span>&nbsp;<span class="ident" id="4354332">v</span>&nbsp;<span class="op" id="4354334">&gt;</span>&nbsp;<span class="ident" id="4354336">delta</span>&nbsp;<span class="op" id="4354342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354349">d</span><span class="op" id="4354350">.</span><span class="ident" id="4354351">hashHead</span><span class="op" id="4354359">[</span><span class="ident" id="4354360">i</span><span class="op" id="4354361">]</span>&nbsp;<span class="op" id="4354363">-=</span>&nbsp;<span class="ident" id="4354366">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4354376">}</span>&nbsp;<span class="keyword" id="4354378">else</span>&nbsp;<span class="op" id="4354383">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354390">d</span><span class="op" id="4354391">.</span><span class="ident" id="4354392">hashHead</span><span class="op" id="4354400">[</span><span class="ident" id="4354401">i</span><span class="op" id="4354402">]</span>&nbsp;<span class="op" id="4354404">=</span>&nbsp;<span class="num" id="4354406">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4354412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4354417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4354421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4354424">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354427">n</span>&nbsp;<span class="op" id="4354429">:=</span>&nbsp;<span class="builtinfunc" id="4354432">copy</span><span class="op" id="4354436">(</span><span class="ident" id="4354437">d</span><span class="op" id="4354438">.</span><span class="ident" id="4354439">window</span><span class="op" id="4354445">[</span><span class="ident" id="4354446">d</span><span class="op" id="4354447">.</span><span class="ident" id="4354448">windowEnd</span><span class="op" id="4354457">:</span><span class="op" id="4354458">]</span><span class="op" id="4354459">,</span>&nbsp;<span class="ident" id="4354461">b</span><span class="op" id="4354462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354465">d</span><span class="op" id="4354466">.</span><span class="ident" id="4354467">windowEnd</span>&nbsp;<span class="op" id="4354477">+=</span>&nbsp;<span class="ident" id="4354480">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354483">return</span>&nbsp;<span class="ident" id="4354490">n</span><br>
<span class="lineno"></span><span class="op" id="4354492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="4354495">func</span>&nbsp;<span class="op" id="4354500">(</span><span class="ident" id="4354501">d</span>&nbsp;<span class="op" id="4354503">*</span><span class="ident" id="4354504">compressor</span><span class="op" id="4354514">)</span>&nbsp;<span class="ident" id="4354516">writeBlock</span><span class="op" id="4354526">(</span><span class="ident" id="4354527">tokens</span>&nbsp;<span class="op" id="4354534">[</span><span class="op" id="4354535">]</span><span class="ident" id="4354536">token</span><span class="op" id="4354541">,</span>&nbsp;<span class="ident" id="4354543">index</span>&nbsp;<span class="builtintype" id="4354549">int</span><span class="op" id="4354552">,</span>&nbsp;<span class="ident" id="4354554">eof</span>&nbsp;<span class="builtintype" id="4354558">bool</span><span class="op" id="4354562">)</span>&nbsp;<span class="builtintype" id="4354564">error</span>&nbsp;<span class="op" id="4354570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354573">if</span>&nbsp;<span class="ident" id="4354576">index</span>&nbsp;<span class="op" id="4354582">&gt;</span>&nbsp;<span class="num" id="4354584">0</span>&nbsp;<span class="op" id="4354586">||</span>&nbsp;<span class="ident" id="4354589">eof</span>&nbsp;<span class="op" id="4354593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354597">var</span>&nbsp;<span class="ident" id="4354601">window</span>&nbsp;<span class="op" id="4354608">[</span><span class="op" id="4354609">]</span><span class="builtintype" id="4354610">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354617">if</span>&nbsp;<span class="ident" id="4354620">d</span><span class="op" id="4354621">.</span><span class="ident" id="4354622">blockStart</span>&nbsp;<span class="op" id="4354633">&lt;=</span>&nbsp;<span class="ident" id="4354636">index</span>&nbsp;<span class="op" id="4354642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354647">window</span>&nbsp;<span class="op" id="4354654">=</span>&nbsp;<span class="ident" id="4354656">d</span><span class="op" id="4354657">.</span><span class="ident" id="4354658">window</span><span class="op" id="4354664">[</span><span class="ident" id="4354665">d</span><span class="op" id="4354666">.</span><span class="ident" id="4354667">blockStart</span><span class="op" id="4354677">:</span><span class="ident" id="4354678">index</span><span class="op" id="4354683">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4354687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354691">d</span><span class="op" id="4354692">.</span><span class="ident" id="4354693">blockStart</span>&nbsp;<span class="op" id="4354704">=</span>&nbsp;<span class="ident" id="4354706">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4354714">d</span><span class="op" id="4354715">.</span><span class="ident" id="4354716">w</span><span class="op" id="4354717">.</span><span class="ident" id="4354718">writeBlock</span><span class="op" id="4354728">(</span><span class="ident" id="4354729">tokens</span><span class="op" id="4354735">,</span>&nbsp;<span class="ident" id="4354737">eof</span><span class="op" id="4354740">,</span>&nbsp;<span class="ident" id="4354742">window</span><span class="op" id="4354748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354752">return</span>&nbsp;<span class="ident" id="4354759">d</span><span class="op" id="4354760">.</span><span class="ident" id="4354761">w</span><span class="op" id="4354762">.</span><span class="ident" id="4354763">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4354768">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4354771">return</span>&nbsp;<span class="ident" id="4354778">nil</span><br>
<span class="lineno"></span><span class="op" id="4354782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4354785">//&nbsp;Try&nbsp;to&nbsp;find&nbsp;a&nbsp;match&nbsp;starting&nbsp;at&nbsp;index&nbsp;whose&nbsp;length&nbsp;is&nbsp;greater&nbsp;than&nbsp;prevSize.</span><br>
<span class="lineno"></span><span class="comment" id="4354865">//&nbsp;We&nbsp;only&nbsp;look&nbsp;at&nbsp;chainCount&nbsp;possibilities&nbsp;before&nbsp;giving&nbsp;up.</span><br>
<span class="lineno">150</span><span class="keyword" id="4354927">func</span>&nbsp;<span class="op" id="4354932">(</span><span class="ident" id="4354933">d</span>&nbsp;<span class="op" id="4354935">*</span><span class="ident" id="4354936">compressor</span><span class="op" id="4354946">)</span>&nbsp;<span class="ident" id="4354948">findMatch</span><span class="op" id="4354957">(</span><span class="ident" id="4354958">pos</span>&nbsp;<span class="builtintype" id="4354962">int</span><span class="op" id="4354965">,</span>&nbsp;<span class="ident" id="4354967">prevHead</span>&nbsp;<span class="builtintype" id="4354976">int</span><span class="op" id="4354979">,</span>&nbsp;<span class="ident" id="4354981">prevLength</span>&nbsp;<span class="builtintype" id="4354992">int</span><span class="op" id="4354995">,</span>&nbsp;<span class="ident" id="4354997">lookahead</span>&nbsp;<span class="builtintype" id="4355007">int</span><span class="op" id="4355010">)</span>&nbsp;<span class="op" id="4355012">(</span><span class="ident" id="4355013">length</span><span class="op" id="4355019">,</span>&nbsp;<span class="ident" id="4355021">offset</span>&nbsp;<span class="builtintype" id="4355028">int</span><span class="op" id="4355031">,</span>&nbsp;<span class="ident" id="4355033">ok</span>&nbsp;<span class="builtintype" id="4355036">bool</span><span class="op" id="4355040">)</span>&nbsp;<span class="op" id="4355042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355045">minMatchLook</span>&nbsp;<span class="op" id="4355058">:=</span>&nbsp;<span class="ident" id="4355061">maxMatchLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355077">if</span>&nbsp;<span class="ident" id="4355080">lookahead</span>&nbsp;<span class="op" id="4355090">&lt;</span>&nbsp;<span class="ident" id="4355092">minMatchLook</span>&nbsp;<span class="op" id="4355105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355109">minMatchLook</span>&nbsp;<span class="op" id="4355122">=</span>&nbsp;<span class="ident" id="4355124">lookahead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4355135">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355139">win</span>&nbsp;<span class="op" id="4355143">:=</span>&nbsp;<span class="ident" id="4355146">d</span><span class="op" id="4355147">.</span><span class="ident" id="4355148">window</span><span class="op" id="4355154">[</span><span class="num" id="4355155">0</span>&nbsp;<span class="op" id="4355157">:</span>&nbsp;<span class="ident" id="4355159">pos</span><span class="op" id="4355162">+</span><span class="ident" id="4355163">minMatchLook</span><span class="op" id="4355175">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4355179">//&nbsp;We&nbsp;quit&nbsp;when&nbsp;we&nbsp;get&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;at&nbsp;least&nbsp;nice&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355237">nice</span>&nbsp;<span class="op" id="4355242">:=</span>&nbsp;<span class="builtinfunc" id="4355245">len</span><span class="op" id="4355248">(</span><span class="ident" id="4355249">win</span><span class="op" id="4355252">)</span>&nbsp;<span class="op" id="4355254">-</span>&nbsp;<span class="ident" id="4355256">pos</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355261">if</span>&nbsp;<span class="ident" id="4355264">d</span><span class="op" id="4355265">.</span><span class="ident" id="4355266">nice</span>&nbsp;<span class="op" id="4355271">&lt;</span>&nbsp;<span class="ident" id="4355273">nice</span>&nbsp;<span class="op" id="4355278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355282">nice</span>&nbsp;<span class="op" id="4355287">=</span>&nbsp;<span class="ident" id="4355289">d</span><span class="op" id="4355290">.</span><span class="ident" id="4355291">nice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4355297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4355301">//&nbsp;If&nbsp;we&#39;ve&nbsp;got&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;good&nbsp;enough,&nbsp;only&nbsp;look&nbsp;in&nbsp;1/4&nbsp;the&nbsp;chain.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355374">tries</span>&nbsp;<span class="op" id="4355380">:=</span>&nbsp;<span class="ident" id="4355383">d</span><span class="op" id="4355384">.</span><span class="ident" id="4355385">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355392">length</span>&nbsp;<span class="op" id="4355399">=</span>&nbsp;<span class="ident" id="4355401">prevLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355413">if</span>&nbsp;<span class="ident" id="4355416">length</span>&nbsp;<span class="op" id="4355423">&gt;=</span>&nbsp;<span class="ident" id="4355426">d</span><span class="op" id="4355427">.</span><span class="ident" id="4355428">good</span>&nbsp;<span class="op" id="4355433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355437">tries</span>&nbsp;<span class="op" id="4355443">&gt;&gt;=</span>&nbsp;<span class="num" id="4355447">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4355450">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355454">w0</span>&nbsp;<span class="op" id="4355457">:=</span>&nbsp;<span class="ident" id="4355460">win</span><span class="op" id="4355463">[</span><span class="ident" id="4355464">pos</span><span class="op" id="4355467">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355470">w1</span>&nbsp;<span class="op" id="4355473">:=</span>&nbsp;<span class="ident" id="4355476">win</span><span class="op" id="4355479">[</span><span class="ident" id="4355480">pos</span><span class="op" id="4355483">+</span><span class="num" id="4355484">1</span><span class="op" id="4355485">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355488">wEnd</span>&nbsp;<span class="op" id="4355493">:=</span>&nbsp;<span class="ident" id="4355496">win</span><span class="op" id="4355499">[</span><span class="ident" id="4355500">pos</span><span class="op" id="4355503">+</span><span class="ident" id="4355504">length</span><span class="op" id="4355510">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355513">minIndex</span>&nbsp;<span class="op" id="4355522">:=</span>&nbsp;<span class="ident" id="4355525">pos</span>&nbsp;<span class="op" id="4355529">-</span>&nbsp;<span class="ident" id="4355531">windowSize</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355544">for</span>&nbsp;<span class="ident" id="4355548">i</span>&nbsp;<span class="op" id="4355550">:=</span>&nbsp;<span class="ident" id="4355553">prevHead</span><span class="op" id="4355561">;</span>&nbsp;<span class="ident" id="4355563">tries</span>&nbsp;<span class="op" id="4355569">&gt;</span>&nbsp;<span class="num" id="4355571">0</span><span class="op" id="4355572">;</span>&nbsp;<span class="ident" id="4355574">tries</span><span class="op" id="4355579">--</span>&nbsp;<span class="op" id="4355582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355586">if</span>&nbsp;<span class="ident" id="4355589">w0</span>&nbsp;<span class="op" id="4355592">==</span>&nbsp;<span class="ident" id="4355595">win</span><span class="op" id="4355598">[</span><span class="ident" id="4355599">i</span><span class="op" id="4355600">]</span>&nbsp;<span class="op" id="4355602">&amp;&amp;</span>&nbsp;<span class="ident" id="4355605">w1</span>&nbsp;<span class="op" id="4355608">==</span>&nbsp;<span class="ident" id="4355611">win</span><span class="op" id="4355614">[</span><span class="ident" id="4355615">i</span><span class="op" id="4355616">+</span><span class="num" id="4355617">1</span><span class="op" id="4355618">]</span>&nbsp;<span class="op" id="4355620">&amp;&amp;</span>&nbsp;<span class="ident" id="4355623">wEnd</span>&nbsp;<span class="op" id="4355628">==</span>&nbsp;<span class="ident" id="4355631">win</span><span class="op" id="4355634">[</span><span class="ident" id="4355635">i</span><span class="op" id="4355636">+</span><span class="ident" id="4355637">length</span><span class="op" id="4355643">]</span>&nbsp;<span class="op" id="4355645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4355650">//&nbsp;The&nbsp;hash&nbsp;function&nbsp;ensures&nbsp;that&nbsp;if&nbsp;win[i]&nbsp;and&nbsp;win[i+1]&nbsp;match,&nbsp;win[i+2]&nbsp;matches</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355735">n</span>&nbsp;<span class="op" id="4355737">:=</span>&nbsp;<span class="num" id="4355740">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355745">for</span>&nbsp;<span class="ident" id="4355749">pos</span><span class="op" id="4355752">+</span><span class="ident" id="4355753">n</span>&nbsp;<span class="op" id="4355755">&lt;</span>&nbsp;<span class="builtinfunc" id="4355757">len</span><span class="op" id="4355760">(</span><span class="ident" id="4355761">win</span><span class="op" id="4355764">)</span>&nbsp;<span class="op" id="4355766">&amp;&amp;</span>&nbsp;<span class="ident" id="4355769">win</span><span class="op" id="4355772">[</span><span class="ident" id="4355773">i</span><span class="op" id="4355774">+</span><span class="ident" id="4355775">n</span><span class="op" id="4355776">]</span>&nbsp;<span class="op" id="4355778">==</span>&nbsp;<span class="ident" id="4355781">win</span><span class="op" id="4355784">[</span><span class="ident" id="4355785">pos</span><span class="op" id="4355788">+</span><span class="ident" id="4355789">n</span><span class="op" id="4355790">]</span>&nbsp;<span class="op" id="4355792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355798">n</span><span class="op" id="4355799">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4355805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355810">if</span>&nbsp;<span class="ident" id="4355813">n</span>&nbsp;<span class="op" id="4355815">&gt;</span>&nbsp;<span class="ident" id="4355817">length</span>&nbsp;<span class="op" id="4355824">&amp;&amp;</span>&nbsp;<span class="op" id="4355827">(</span><span class="ident" id="4355828">n</span>&nbsp;<span class="op" id="4355830">&gt;</span>&nbsp;<span class="num" id="4355832">3</span>&nbsp;<span class="op" id="4355834">||</span>&nbsp;<span class="ident" id="4355837">pos</span><span class="op" id="4355840">-</span><span class="ident" id="4355841">i</span>&nbsp;<span class="op" id="4355843">&lt;=</span>&nbsp;<span class="num" id="4355846">4096</span><span class="op" id="4355850">)</span>&nbsp;<span class="op" id="4355852">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355858">length</span>&nbsp;<span class="op" id="4355865">=</span>&nbsp;<span class="ident" id="4355867">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355873">offset</span>&nbsp;<span class="op" id="4355880">=</span>&nbsp;<span class="ident" id="4355882">pos</span>&nbsp;<span class="op" id="4355886">-</span>&nbsp;<span class="ident" id="4355888">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4355894">ok</span>&nbsp;<span class="op" id="4355897">=</span>&nbsp;<span class="builtintype" id="4355899">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4355908">if</span>&nbsp;<span class="ident" id="4355911">n</span>&nbsp;<span class="op" id="4355913">&gt;=</span>&nbsp;<span class="ident" id="4355916">nice</span>&nbsp;<span class="op" id="4355921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4355928">//&nbsp;The&nbsp;match&nbsp;is&nbsp;good&nbsp;enough&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;try&nbsp;to&nbsp;find&nbsp;a&nbsp;better&nbsp;one.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356001">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356017">wEnd</span>&nbsp;<span class="op" id="4356022">=</span>&nbsp;<span class="ident" id="4356024">win</span><span class="op" id="4356027">[</span><span class="ident" id="4356028">pos</span><span class="op" id="4356031">+</span><span class="ident" id="4356032">n</span><span class="op" id="4356033">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356042">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356046">if</span>&nbsp;<span class="ident" id="4356049">i</span>&nbsp;<span class="op" id="4356051">==</span>&nbsp;<span class="ident" id="4356054">minIndex</span>&nbsp;<span class="op" id="4356063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4356068">//&nbsp;hashPrev[i&nbsp;&amp;&nbsp;windowMask]&nbsp;has&nbsp;already&nbsp;been&nbsp;overwritten,&nbsp;so&nbsp;stop&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356142">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356154">if</span>&nbsp;<span class="ident" id="4356157">i</span>&nbsp;<span class="op" id="4356159">=</span>&nbsp;<span class="ident" id="4356161">d</span><span class="op" id="4356162">.</span><span class="ident" id="4356163">hashPrev</span><span class="op" id="4356171">[</span><span class="ident" id="4356172">i</span><span class="op" id="4356173">&amp;</span><span class="ident" id="4356174">windowMask</span><span class="op" id="4356184">]</span>&nbsp;<span class="op" id="4356186">-</span>&nbsp;<span class="ident" id="4356188">d</span><span class="op" id="4356189">.</span><span class="ident" id="4356190">hashOffset</span><span class="op" id="4356200">;</span>&nbsp;<span class="ident" id="4356202">i</span>&nbsp;<span class="op" id="4356204">&lt;</span>&nbsp;<span class="ident" id="4356206">minIndex</span>&nbsp;<span class="op" id="4356215">||</span>&nbsp;<span class="ident" id="4356218">i</span>&nbsp;<span class="op" id="4356220">&lt;</span>&nbsp;<span class="num" id="4356222">0</span>&nbsp;<span class="op" id="4356224">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356229">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356243">return</span><br>
<span class="lineno"></span><span class="op" id="4356250">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="4356253">func</span>&nbsp;<span class="op" id="4356258">(</span><span class="ident" id="4356259">d</span>&nbsp;<span class="op" id="4356261">*</span><span class="ident" id="4356262">compressor</span><span class="op" id="4356272">)</span>&nbsp;<span class="ident" id="4356274">writeStoredBlock</span><span class="op" id="4356290">(</span><span class="ident" id="4356291">buf</span>&nbsp;<span class="op" id="4356295">[</span><span class="op" id="4356296">]</span><span class="builtintype" id="4356297">byte</span><span class="op" id="4356301">)</span>&nbsp;<span class="builtintype" id="4356303">error</span>&nbsp;<span class="op" id="4356309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356312">if</span>&nbsp;<span class="ident" id="4356315">d</span><span class="op" id="4356316">.</span><span class="ident" id="4356317">w</span><span class="op" id="4356318">.</span><span class="ident" id="4356319">writeStoredHeader</span><span class="op" id="4356336">(</span><span class="builtinfunc" id="4356337">len</span><span class="op" id="4356340">(</span><span class="ident" id="4356341">buf</span><span class="op" id="4356344">)</span><span class="op" id="4356345">,</span>&nbsp;<span class="builtintype" id="4356347">false</span><span class="op" id="4356352">)</span><span class="op" id="4356353">;</span>&nbsp;<span class="ident" id="4356355">d</span><span class="op" id="4356356">.</span><span class="ident" id="4356357">w</span><span class="op" id="4356358">.</span><span class="ident" id="4356359">err</span>&nbsp;<span class="op" id="4356363">!=</span>&nbsp;<span class="ident" id="4356366">nil</span>&nbsp;<span class="op" id="4356370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356374">return</span>&nbsp;<span class="ident" id="4356381">d</span><span class="op" id="4356382">.</span><span class="ident" id="4356383">w</span><span class="op" id="4356384">.</span><span class="ident" id="4356385">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356390">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356393">d</span><span class="op" id="4356394">.</span><span class="ident" id="4356395">w</span><span class="op" id="4356396">.</span><span class="ident" id="4356397">writeBytes</span><span class="op" id="4356407">(</span><span class="ident" id="4356408">buf</span><span class="op" id="4356411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356414">return</span>&nbsp;<span class="ident" id="4356421">d</span><span class="op" id="4356422">.</span><span class="ident" id="4356423">w</span><span class="op" id="4356424">.</span><span class="ident" id="4356425">err</span><br>
<span class="lineno"></span><span class="op" id="4356429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4356432">func</span>&nbsp;<span class="op" id="4356437">(</span><span class="ident" id="4356438">d</span>&nbsp;<span class="op" id="4356440">*</span><span class="ident" id="4356441">compressor</span><span class="op" id="4356451">)</span>&nbsp;<span class="ident" id="4356453">initDeflate</span><span class="op" id="4356464">(</span><span class="op" id="4356465">)</span>&nbsp;<span class="op" id="4356467">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356470">d</span><span class="op" id="4356471">.</span><span class="ident" id="4356472">hashHead</span>&nbsp;<span class="op" id="4356481">=</span>&nbsp;<span class="builtinfunc" id="4356483">make</span><span class="op" id="4356487">(</span><span class="op" id="4356488">[</span><span class="op" id="4356489">]</span><span class="builtintype" id="4356490">int</span><span class="op" id="4356493">,</span>&nbsp;<span class="ident" id="4356495">hashSize</span><span class="op" id="4356503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356506">d</span><span class="op" id="4356507">.</span><span class="ident" id="4356508">hashPrev</span>&nbsp;<span class="op" id="4356517">=</span>&nbsp;<span class="builtinfunc" id="4356519">make</span><span class="op" id="4356523">(</span><span class="op" id="4356524">[</span><span class="op" id="4356525">]</span><span class="builtintype" id="4356526">int</span><span class="op" id="4356529">,</span>&nbsp;<span class="ident" id="4356531">windowSize</span><span class="op" id="4356541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356544">d</span><span class="op" id="4356545">.</span><span class="ident" id="4356546">window</span>&nbsp;<span class="op" id="4356553">=</span>&nbsp;<span class="builtinfunc" id="4356555">make</span><span class="op" id="4356559">(</span><span class="op" id="4356560">[</span><span class="op" id="4356561">]</span><span class="builtintype" id="4356562">byte</span><span class="op" id="4356566">,</span>&nbsp;<span class="num" id="4356568">2</span><span class="op" id="4356569">*</span><span class="ident" id="4356570">windowSize</span><span class="op" id="4356580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356583">d</span><span class="op" id="4356584">.</span><span class="ident" id="4356585">hashOffset</span>&nbsp;<span class="op" id="4356596">=</span>&nbsp;<span class="num" id="4356598">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356601">d</span><span class="op" id="4356602">.</span><span class="ident" id="4356603">tokens</span>&nbsp;<span class="op" id="4356610">=</span>&nbsp;<span class="builtinfunc" id="4356612">make</span><span class="op" id="4356616">(</span><span class="op" id="4356617">[</span><span class="op" id="4356618">]</span><span class="ident" id="4356619">token</span><span class="op" id="4356624">,</span>&nbsp;<span class="num" id="4356626">0</span><span class="op" id="4356627">,</span>&nbsp;<span class="ident" id="4356629">maxFlateBlockTokens</span><span class="op" id="4356648">+</span><span class="num" id="4356649">1</span><span class="op" id="4356650">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356653">d</span><span class="op" id="4356654">.</span><span class="ident" id="4356655">length</span>&nbsp;<span class="op" id="4356662">=</span>&nbsp;<span class="ident" id="4356664">minMatchLength</span>&nbsp;<span class="op" id="4356679">-</span>&nbsp;<span class="num" id="4356681">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356684">d</span><span class="op" id="4356685">.</span><span class="ident" id="4356686">offset</span>&nbsp;<span class="op" id="4356693">=</span>&nbsp;<span class="num" id="4356695">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356698">d</span><span class="op" id="4356699">.</span><span class="ident" id="4356700">byteAvailable</span>&nbsp;<span class="op" id="4356714">=</span>&nbsp;<span class="builtintype" id="4356716">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356723">d</span><span class="op" id="4356724">.</span><span class="ident" id="4356725">index</span>&nbsp;<span class="op" id="4356731">=</span>&nbsp;<span class="num" id="4356733">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356736">d</span><span class="op" id="4356737">.</span><span class="ident" id="4356738">hash</span>&nbsp;<span class="op" id="4356743">=</span>&nbsp;<span class="num" id="4356745">0</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356748">d</span><span class="op" id="4356749">.</span><span class="ident" id="4356750">chainHead</span>&nbsp;<span class="op" id="4356760">=</span>&nbsp;<span class="op" id="4356762">-</span><span class="num" id="4356763">1</span><br>
<span class="lineno"></span><span class="op" id="4356765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4356768">func</span>&nbsp;<span class="op" id="4356773">(</span><span class="ident" id="4356774">d</span>&nbsp;<span class="op" id="4356776">*</span><span class="ident" id="4356777">compressor</span><span class="op" id="4356787">)</span>&nbsp;<span class="ident" id="4356789">deflate</span><span class="op" id="4356796">(</span><span class="op" id="4356797">)</span>&nbsp;<span class="op" id="4356799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356802">if</span>&nbsp;<span class="ident" id="4356805">d</span><span class="op" id="4356806">.</span><span class="ident" id="4356807">windowEnd</span><span class="op" id="4356816">-</span><span class="ident" id="4356817">d</span><span class="op" id="4356818">.</span><span class="ident" id="4356819">index</span>&nbsp;<span class="op" id="4356825">&lt;</span>&nbsp;<span class="ident" id="4356827">minMatchLength</span><span class="op" id="4356841">+</span><span class="ident" id="4356842">maxMatchLength</span>&nbsp;<span class="op" id="4356857">&amp;&amp;</span>&nbsp;<span class="op" id="4356860">!</span><span class="ident" id="4356861">d</span><span class="op" id="4356862">.</span><span class="ident" id="4356863">sync</span>&nbsp;<span class="op" id="4356868">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356872">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4356880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356884">d</span><span class="op" id="4356885">.</span><span class="ident" id="4356886">maxInsertIndex</span>&nbsp;<span class="op" id="4356901">=</span>&nbsp;<span class="ident" id="4356903">d</span><span class="op" id="4356904">.</span><span class="ident" id="4356905">windowEnd</span>&nbsp;<span class="op" id="4356915">-</span>&nbsp;<span class="op" id="4356917">(</span><span class="ident" id="4356918">minMatchLength</span>&nbsp;<span class="op" id="4356933">-</span>&nbsp;<span class="num" id="4356935">1</span><span class="op" id="4356936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4356939">if</span>&nbsp;<span class="ident" id="4356942">d</span><span class="op" id="4356943">.</span><span class="ident" id="4356944">index</span>&nbsp;<span class="op" id="4356950">&lt;</span>&nbsp;<span class="ident" id="4356952">d</span><span class="op" id="4356953">.</span><span class="ident" id="4356954">maxInsertIndex</span>&nbsp;<span class="op" id="4356969">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4356973">d</span><span class="op" id="4356974">.</span><span class="ident" id="4356975">hash</span>&nbsp;<span class="op" id="4356980">=</span>&nbsp;<span class="builtintype" id="4356982">int</span><span class="op" id="4356985">(</span><span class="ident" id="4356986">d</span><span class="op" id="4356987">.</span><span class="ident" id="4356988">window</span><span class="op" id="4356994">[</span><span class="ident" id="4356995">d</span><span class="op" id="4356996">.</span><span class="ident" id="4356997">index</span><span class="op" id="4357002">]</span><span class="op" id="4357003">)</span><span class="op" id="4357004">&lt;&lt;</span><span class="ident" id="4357006">hashShift</span>&nbsp;<span class="op" id="4357016">+</span>&nbsp;<span class="builtintype" id="4357018">int</span><span class="op" id="4357021">(</span><span class="ident" id="4357022">d</span><span class="op" id="4357023">.</span><span class="ident" id="4357024">window</span><span class="op" id="4357030">[</span><span class="ident" id="4357031">d</span><span class="op" id="4357032">.</span><span class="ident" id="4357033">index</span><span class="op" id="4357038">+</span><span class="num" id="4357039">1</span><span class="op" id="4357040">]</span><span class="op" id="4357041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4357047">Loop</span><span class="op" id="4357051">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357054">for</span>&nbsp;<span class="op" id="4357058">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357062">if</span>&nbsp;<span class="ident" id="4357065">d</span><span class="op" id="4357066">.</span><span class="ident" id="4357067">index</span>&nbsp;<span class="op" id="4357073">&gt;</span>&nbsp;<span class="ident" id="4357075">d</span><span class="op" id="4357076">.</span><span class="ident" id="4357077">windowEnd</span>&nbsp;<span class="op" id="4357087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4357092">panic</span><span class="op" id="4357097">(</span><span class="string" id="4357098">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4357117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357125">lookahead</span>&nbsp;<span class="op" id="4357135">:=</span>&nbsp;<span class="ident" id="4357138">d</span><span class="op" id="4357139">.</span><span class="ident" id="4357140">windowEnd</span>&nbsp;<span class="op" id="4357150">-</span>&nbsp;<span class="ident" id="4357152">d</span><span class="op" id="4357153">.</span><span class="ident" id="4357154">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357162">if</span>&nbsp;<span class="ident" id="4357165">lookahead</span>&nbsp;<span class="op" id="4357175">&lt;</span>&nbsp;<span class="ident" id="4357177">minMatchLength</span><span class="op" id="4357191">+</span><span class="ident" id="4357192">maxMatchLength</span>&nbsp;<span class="op" id="4357207">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357212">if</span>&nbsp;<span class="op" id="4357215">!</span><span class="ident" id="4357216">d</span><span class="op" id="4357217">.</span><span class="ident" id="4357218">sync</span>&nbsp;<span class="op" id="4357223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357229">break</span>&nbsp;<span class="ident" id="4357235">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357248">if</span>&nbsp;<span class="ident" id="4357251">d</span><span class="op" id="4357252">.</span><span class="ident" id="4357253">index</span>&nbsp;<span class="op" id="4357259">&gt;</span>&nbsp;<span class="ident" id="4357261">d</span><span class="op" id="4357262">.</span><span class="ident" id="4357263">windowEnd</span>&nbsp;<span class="op" id="4357273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4357279">panic</span><span class="op" id="4357284">(</span><span class="string" id="4357285">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4357304">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357314">if</span>&nbsp;<span class="ident" id="4357317">lookahead</span>&nbsp;<span class="op" id="4357327">==</span>&nbsp;<span class="num" id="4357330">0</span>&nbsp;<span class="op" id="4357332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4357338">//&nbsp;Flush&nbsp;current&nbsp;output&nbsp;block&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357380">if</span>&nbsp;<span class="ident" id="4357383">d</span><span class="op" id="4357384">.</span><span class="ident" id="4357385">byteAvailable</span>&nbsp;<span class="op" id="4357399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4357406">//&nbsp;There&nbsp;is&nbsp;still&nbsp;one&nbsp;pending&nbsp;token&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;flushed</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357472">d</span><span class="op" id="4357473">.</span><span class="ident" id="4357474">tokens</span>&nbsp;<span class="op" id="4357481">=</span>&nbsp;<span class="builtinfunc" id="4357483">append</span><span class="op" id="4357489">(</span><span class="ident" id="4357490">d</span><span class="op" id="4357491">.</span><span class="ident" id="4357492">tokens</span><span class="op" id="4357498">,</span>&nbsp;<span class="ident" id="4357500">literalToken</span><span class="op" id="4357512">(</span><span class="builtintype" id="4357513">uint32</span><span class="op" id="4357519">(</span><span class="ident" id="4357520">d</span><span class="op" id="4357521">.</span><span class="ident" id="4357522">window</span><span class="op" id="4357528">[</span><span class="ident" id="4357529">d</span><span class="op" id="4357530">.</span><span class="ident" id="4357531">index</span><span class="op" id="4357536">-</span><span class="num" id="4357537">1</span><span class="op" id="4357538">]</span><span class="op" id="4357539">)</span><span class="op" id="4357540">)</span><span class="op" id="4357541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357548">d</span><span class="op" id="4357549">.</span><span class="ident" id="4357550">byteAvailable</span>&nbsp;<span class="op" id="4357564">=</span>&nbsp;<span class="builtintype" id="4357566">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357582">if</span>&nbsp;<span class="builtinfunc" id="4357585">len</span><span class="op" id="4357588">(</span><span class="ident" id="4357589">d</span><span class="op" id="4357590">.</span><span class="ident" id="4357591">tokens</span><span class="op" id="4357597">)</span>&nbsp;<span class="op" id="4357599">&gt;</span>&nbsp;<span class="num" id="4357601">0</span>&nbsp;<span class="op" id="4357603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357610">if</span>&nbsp;<span class="ident" id="4357613">d</span><span class="op" id="4357614">.</span><span class="ident" id="4357615">err</span>&nbsp;<span class="op" id="4357619">=</span>&nbsp;<span class="ident" id="4357621">d</span><span class="op" id="4357622">.</span><span class="ident" id="4357623">writeBlock</span><span class="op" id="4357633">(</span><span class="ident" id="4357634">d</span><span class="op" id="4357635">.</span><span class="ident" id="4357636">tokens</span><span class="op" id="4357642">,</span>&nbsp;<span class="ident" id="4357644">d</span><span class="op" id="4357645">.</span><span class="ident" id="4357646">index</span><span class="op" id="4357651">,</span>&nbsp;<span class="builtintype" id="4357653">false</span><span class="op" id="4357658">)</span><span class="op" id="4357659">;</span>&nbsp;<span class="ident" id="4357661">d</span><span class="op" id="4357662">.</span><span class="ident" id="4357663">err</span>&nbsp;<span class="op" id="4357667">!=</span>&nbsp;<span class="ident" id="4357670">nil</span>&nbsp;<span class="op" id="4357674">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357682">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357701">d</span><span class="op" id="4357702">.</span><span class="ident" id="4357703">tokens</span>&nbsp;<span class="op" id="4357710">=</span>&nbsp;<span class="ident" id="4357712">d</span><span class="op" id="4357713">.</span><span class="ident" id="4357714">tokens</span><span class="op" id="4357720">[</span><span class="op" id="4357721">:</span><span class="num" id="4357722">0</span><span class="op" id="4357723">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357735">break</span>&nbsp;<span class="ident" id="4357741">Loop</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4357753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4357757">if</span>&nbsp;<span class="ident" id="4357760">d</span><span class="op" id="4357761">.</span><span class="ident" id="4357762">index</span>&nbsp;<span class="op" id="4357768">&lt;</span>&nbsp;<span class="ident" id="4357770">d</span><span class="op" id="4357771">.</span><span class="ident" id="4357772">maxInsertIndex</span>&nbsp;<span class="op" id="4357787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4357792">//&nbsp;Update&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357814">d</span><span class="op" id="4357815">.</span><span class="ident" id="4357816">hash</span>&nbsp;<span class="op" id="4357821">=</span>&nbsp;<span class="op" id="4357823">(</span><span class="ident" id="4357824">d</span><span class="op" id="4357825">.</span><span class="ident" id="4357826">hash</span><span class="op" id="4357830">&lt;&lt;</span><span class="ident" id="4357832">hashShift</span>&nbsp;<span class="op" id="4357842">+</span>&nbsp;<span class="builtintype" id="4357844">int</span><span class="op" id="4357847">(</span><span class="ident" id="4357848">d</span><span class="op" id="4357849">.</span><span class="ident" id="4357850">window</span><span class="op" id="4357856">[</span><span class="ident" id="4357857">d</span><span class="op" id="4357858">.</span><span class="ident" id="4357859">index</span><span class="op" id="4357864">+</span><span class="num" id="4357865">2</span><span class="op" id="4357866">]</span><span class="op" id="4357867">)</span><span class="op" id="4357868">)</span>&nbsp;<span class="op" id="4357870">&amp;</span>&nbsp;<span class="ident" id="4357872">hashMask</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357884">d</span><span class="op" id="4357885">.</span><span class="ident" id="4357886">chainHead</span>&nbsp;<span class="op" id="4357896">=</span>&nbsp;<span class="ident" id="4357898">d</span><span class="op" id="4357899">.</span><span class="ident" id="4357900">hashHead</span><span class="op" id="4357908">[</span><span class="ident" id="4357909">d</span><span class="op" id="4357910">.</span><span class="ident" id="4357911">hash</span><span class="op" id="4357915">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357920">d</span><span class="op" id="4357921">.</span><span class="ident" id="4357922">hashPrev</span><span class="op" id="4357930">[</span><span class="ident" id="4357931">d</span><span class="op" id="4357932">.</span><span class="ident" id="4357933">index</span><span class="op" id="4357938">&amp;</span><span class="ident" id="4357939">windowMask</span><span class="op" id="4357949">]</span>&nbsp;<span class="op" id="4357951">=</span>&nbsp;<span class="ident" id="4357953">d</span><span class="op" id="4357954">.</span><span class="ident" id="4357955">chainHead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4357968">d</span><span class="op" id="4357969">.</span><span class="ident" id="4357970">hashHead</span><span class="op" id="4357978">[</span><span class="ident" id="4357979">d</span><span class="op" id="4357980">.</span><span class="ident" id="4357981">hash</span><span class="op" id="4357985">]</span>&nbsp;<span class="op" id="4357987">=</span>&nbsp;<span class="ident" id="4357989">d</span><span class="op" id="4357990">.</span><span class="ident" id="4357991">index</span>&nbsp;<span class="op" id="4357997">+</span>&nbsp;<span class="ident" id="4357999">d</span><span class="op" id="4358000">.</span><span class="ident" id="4358001">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4358014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358018">prevLength</span>&nbsp;<span class="op" id="4358029">:=</span>&nbsp;<span class="ident" id="4358032">d</span><span class="op" id="4358033">.</span><span class="ident" id="4358034">length</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358043">prevOffset</span>&nbsp;<span class="op" id="4358054">:=</span>&nbsp;<span class="ident" id="4358057">d</span><span class="op" id="4358058">.</span><span class="ident" id="4358059">offset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358068">d</span><span class="op" id="4358069">.</span><span class="ident" id="4358070">length</span>&nbsp;<span class="op" id="4358077">=</span>&nbsp;<span class="ident" id="4358079">minMatchLength</span>&nbsp;<span class="op" id="4358094">-</span>&nbsp;<span class="num" id="4358096">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358100">d</span><span class="op" id="4358101">.</span><span class="ident" id="4358102">offset</span>&nbsp;<span class="op" id="4358109">=</span>&nbsp;<span class="num" id="4358111">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358115">minIndex</span>&nbsp;<span class="op" id="4358124">:=</span>&nbsp;<span class="ident" id="4358127">d</span><span class="op" id="4358128">.</span><span class="ident" id="4358129">index</span>&nbsp;<span class="op" id="4358135">-</span>&nbsp;<span class="ident" id="4358137">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4358150">if</span>&nbsp;<span class="ident" id="4358153">minIndex</span>&nbsp;<span class="op" id="4358162">&lt;</span>&nbsp;<span class="num" id="4358164">0</span>&nbsp;<span class="op" id="4358166">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358171">minIndex</span>&nbsp;<span class="op" id="4358180">=</span>&nbsp;<span class="num" id="4358182">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4358186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4358191">if</span>&nbsp;<span class="ident" id="4358194">d</span><span class="op" id="4358195">.</span><span class="ident" id="4358196">chainHead</span><span class="op" id="4358205">-</span><span class="ident" id="4358206">d</span><span class="op" id="4358207">.</span><span class="ident" id="4358208">hashOffset</span>&nbsp;<span class="op" id="4358219">&gt;=</span>&nbsp;<span class="ident" id="4358222">minIndex</span>&nbsp;<span class="op" id="4358231">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4358237">(</span><span class="ident" id="4358238">d</span><span class="op" id="4358239">.</span><span class="ident" id="4358240">fastSkipHashing</span>&nbsp;<span class="op" id="4358256">!=</span>&nbsp;<span class="ident" id="4358259">skipNever</span>&nbsp;<span class="op" id="4358269">&amp;&amp;</span>&nbsp;<span class="ident" id="4358272">lookahead</span>&nbsp;<span class="op" id="4358282">&gt;</span>&nbsp;<span class="ident" id="4358284">minMatchLength</span><span class="op" id="4358298">-</span><span class="num" id="4358299">1</span>&nbsp;<span class="op" id="4358301">||</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358308">d</span><span class="op" id="4358309">.</span><span class="ident" id="4358310">fastSkipHashing</span>&nbsp;<span class="op" id="4358326">==</span>&nbsp;<span class="ident" id="4358329">skipNever</span>&nbsp;<span class="op" id="4358339">&amp;&amp;</span>&nbsp;<span class="ident" id="4358342">lookahead</span>&nbsp;<span class="op" id="4358352">&gt;</span>&nbsp;<span class="ident" id="4358354">prevLength</span>&nbsp;<span class="op" id="4358365">&amp;&amp;</span>&nbsp;<span class="ident" id="4358368">prevLength</span>&nbsp;<span class="op" id="4358379">&lt;</span>&nbsp;<span class="ident" id="4358381">d</span><span class="op" id="4358382">.</span><span class="ident" id="4358383">lazy</span><span class="op" id="4358387">)</span>&nbsp;<span class="op" id="4358389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4358394">if</span>&nbsp;<span class="ident" id="4358397">newLength</span><span class="op" id="4358406">,</span>&nbsp;<span class="ident" id="4358408">newOffset</span><span class="op" id="4358417">,</span>&nbsp;<span class="ident" id="4358419">ok</span>&nbsp;<span class="op" id="4358422">:=</span>&nbsp;<span class="ident" id="4358425">d</span><span class="op" id="4358426">.</span><span class="ident" id="4358427">findMatch</span><span class="op" id="4358436">(</span><span class="ident" id="4358437">d</span><span class="op" id="4358438">.</span><span class="ident" id="4358439">index</span><span class="op" id="4358444">,</span>&nbsp;<span class="ident" id="4358446">d</span><span class="op" id="4358447">.</span><span class="ident" id="4358448">chainHead</span><span class="op" id="4358457">-</span><span class="ident" id="4358458">d</span><span class="op" id="4358459">.</span><span class="ident" id="4358460">hashOffset</span><span class="op" id="4358470">,</span>&nbsp;<span class="ident" id="4358472">minMatchLength</span><span class="op" id="4358486">-</span><span class="num" id="4358487">1</span><span class="op" id="4358488">,</span>&nbsp;<span class="ident" id="4358490">lookahead</span><span class="op" id="4358499">)</span><span class="op" id="4358500">;</span>&nbsp;<span class="ident" id="4358502">ok</span>&nbsp;<span class="op" id="4358505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358511">d</span><span class="op" id="4358512">.</span><span class="ident" id="4358513">length</span>&nbsp;<span class="op" id="4358520">=</span>&nbsp;<span class="ident" id="4358522">newLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358536">d</span><span class="op" id="4358537">.</span><span class="ident" id="4358538">offset</span>&nbsp;<span class="op" id="4358545">=</span>&nbsp;<span class="ident" id="4358547">newOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4358560">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4358564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4358568">if</span>&nbsp;<span class="ident" id="4358571">d</span><span class="op" id="4358572">.</span><span class="ident" id="4358573">fastSkipHashing</span>&nbsp;<span class="op" id="4358589">!=</span>&nbsp;<span class="ident" id="4358592">skipNever</span>&nbsp;<span class="op" id="4358602">&amp;&amp;</span>&nbsp;<span class="ident" id="4358605">d</span><span class="op" id="4358606">.</span><span class="ident" id="4358607">length</span>&nbsp;<span class="op" id="4358614">&gt;=</span>&nbsp;<span class="ident" id="4358617">minMatchLength</span>&nbsp;<span class="op" id="4358632">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358638">d</span><span class="op" id="4358639">.</span><span class="ident" id="4358640">fastSkipHashing</span>&nbsp;<span class="op" id="4358656">==</span>&nbsp;<span class="ident" id="4358659">skipNever</span>&nbsp;<span class="op" id="4358669">&amp;&amp;</span>&nbsp;<span class="ident" id="4358672">prevLength</span>&nbsp;<span class="op" id="4358683">&gt;=</span>&nbsp;<span class="ident" id="4358686">minMatchLength</span>&nbsp;<span class="op" id="4358701">&amp;&amp;</span>&nbsp;<span class="ident" id="4358704">d</span><span class="op" id="4358705">.</span><span class="ident" id="4358706">length</span>&nbsp;<span class="op" id="4358713">&lt;=</span>&nbsp;<span class="ident" id="4358716">prevLength</span>&nbsp;<span class="op" id="4358727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4358732">//&nbsp;There&nbsp;was&nbsp;a&nbsp;match&nbsp;at&nbsp;the&nbsp;previous&nbsp;step,&nbsp;and&nbsp;the&nbsp;current&nbsp;match&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4358803">//&nbsp;not&nbsp;better.&nbsp;Output&nbsp;the&nbsp;previous&nbsp;match.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4358848">if</span>&nbsp;<span class="ident" id="4358851">d</span><span class="op" id="4358852">.</span><span class="ident" id="4358853">fastSkipHashing</span>&nbsp;<span class="op" id="4358869">!=</span>&nbsp;<span class="ident" id="4358872">skipNever</span>&nbsp;<span class="op" id="4358882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4358888">d</span><span class="op" id="4358889">.</span><span class="ident" id="4358890">tokens</span>&nbsp;<span class="op" id="4358897">=</span>&nbsp;<span class="builtinfunc" id="4358899">append</span><span class="op" id="4358905">(</span><span class="ident" id="4358906">d</span><span class="op" id="4358907">.</span><span class="ident" id="4358908">tokens</span><span class="op" id="4358914">,</span>&nbsp;<span class="ident" id="4358916">matchToken</span><span class="op" id="4358926">(</span><span class="builtintype" id="4358927">uint32</span><span class="op" id="4358933">(</span><span class="ident" id="4358934">d</span><span class="op" id="4358935">.</span><span class="ident" id="4358936">length</span><span class="op" id="4358942">-</span><span class="ident" id="4358943">minMatchLength</span><span class="op" id="4358957">)</span><span class="op" id="4358958">,</span>&nbsp;<span class="builtintype" id="4358960">uint32</span><span class="op" id="4358966">(</span><span class="ident" id="4358967">d</span><span class="op" id="4358968">.</span><span class="ident" id="4358969">offset</span><span class="op" id="4358975">-</span><span class="ident" id="4358976">minOffsetSize</span><span class="op" id="4358989">)</span><span class="op" id="4358990">)</span><span class="op" id="4358991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4358996">}</span>&nbsp;<span class="keyword" id="4358998">else</span>&nbsp;<span class="op" id="4359003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4359009">d</span><span class="op" id="4359010">.</span><span class="ident" id="4359011">tokens</span>&nbsp;<span class="op" id="4359018">=</span>&nbsp;<span class="builtinfunc" id="4359020">append</span><span class="op" id="4359026">(</span><span class="ident" id="4359027">d</span><span class="op" id="4359028">.</span><span class="ident" id="4359029">tokens</span><span class="op" id="4359035">,</span>&nbsp;<span class="ident" id="4359037">matchToken</span><span class="op" id="4359047">(</span><span class="builtintype" id="4359048">uint32</span><span class="op" id="4359054">(</span><span class="ident" id="4359055">prevLength</span><span class="op" id="4359065">-</span><span class="ident" id="4359066">minMatchLength</span><span class="op" id="4359080">)</span><span class="op" id="4359081">,</span>&nbsp;<span class="builtintype" id="4359083">uint32</span><span class="op" id="4359089">(</span><span class="ident" id="4359090">prevOffset</span><span class="op" id="4359100">-</span><span class="ident" id="4359101">minOffsetSize</span><span class="op" id="4359114">)</span><span class="op" id="4359115">)</span><span class="op" id="4359116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4359121">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359126">//&nbsp;Insert&nbsp;in&nbsp;the&nbsp;hash&nbsp;table&nbsp;all&nbsp;strings&nbsp;up&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359197">//&nbsp;index&nbsp;and&nbsp;index-1&nbsp;are&nbsp;already&nbsp;inserted.&nbsp;If&nbsp;there&nbsp;is&nbsp;not&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359266">//&nbsp;lookahead,&nbsp;the&nbsp;last&nbsp;two&nbsp;strings&nbsp;are&nbsp;not&nbsp;inserted&nbsp;into&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359335">//&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359348">if</span>&nbsp;<span class="ident" id="4359351">d</span><span class="op" id="4359352">.</span><span class="ident" id="4359353">length</span>&nbsp;<span class="op" id="4359360">&lt;=</span>&nbsp;<span class="ident" id="4359363">d</span><span class="op" id="4359364">.</span><span class="ident" id="4359365">fastSkipHashing</span>&nbsp;<span class="op" id="4359381">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359387">var</span>&nbsp;<span class="ident" id="4359391">newIndex</span>&nbsp;<span class="builtintype" id="4359400">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359408">if</span>&nbsp;<span class="ident" id="4359411">d</span><span class="op" id="4359412">.</span><span class="ident" id="4359413">fastSkipHashing</span>&nbsp;<span class="op" id="4359429">!=</span>&nbsp;<span class="ident" id="4359432">skipNever</span>&nbsp;<span class="op" id="4359442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4359449">newIndex</span>&nbsp;<span class="op" id="4359458">=</span>&nbsp;<span class="ident" id="4359460">d</span><span class="op" id="4359461">.</span><span class="ident" id="4359462">index</span>&nbsp;<span class="op" id="4359468">+</span>&nbsp;<span class="ident" id="4359470">d</span><span class="op" id="4359471">.</span><span class="ident" id="4359472">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4359483">}</span>&nbsp;<span class="keyword" id="4359485">else</span>&nbsp;<span class="op" id="4359490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4359497">newIndex</span>&nbsp;<span class="op" id="4359506">=</span>&nbsp;<span class="ident" id="4359508">d</span><span class="op" id="4359509">.</span><span class="ident" id="4359510">index</span>&nbsp;<span class="op" id="4359516">+</span>&nbsp;<span class="ident" id="4359518">prevLength</span>&nbsp;<span class="op" id="4359529">-</span>&nbsp;<span class="num" id="4359531">1</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4359537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359543">for</span>&nbsp;<span class="ident" id="4359547">d</span><span class="op" id="4359548">.</span><span class="ident" id="4359549">index</span><span class="op" id="4359554">++</span><span class="op" id="4359556">;</span>&nbsp;<span class="ident" id="4359558">d</span><span class="op" id="4359559">.</span><span class="ident" id="4359560">index</span>&nbsp;<span class="op" id="4359566">&lt;</span>&nbsp;<span class="ident" id="4359568">newIndex</span><span class="op" id="4359576">;</span>&nbsp;<span class="ident" id="4359578">d</span><span class="op" id="4359579">.</span><span class="ident" id="4359580">index</span><span class="op" id="4359585">++</span>&nbsp;<span class="op" id="4359588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359595">if</span>&nbsp;<span class="ident" id="4359598">d</span><span class="op" id="4359599">.</span><span class="ident" id="4359600">index</span>&nbsp;<span class="op" id="4359606">&lt;</span>&nbsp;<span class="ident" id="4359608">d</span><span class="op" id="4359609">.</span><span class="ident" id="4359610">maxInsertIndex</span>&nbsp;<span class="op" id="4359625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4359633">d</span><span class="op" id="4359634">.</span><span class="ident" id="4359635">hash</span>&nbsp;<span class="op" id="4359640">=</span>&nbsp;<span class="op" id="4359642">(</span><span class="ident" id="4359643">d</span><span class="op" id="4359644">.</span><span class="ident" id="4359645">hash</span><span class="op" id="4359649">&lt;&lt;</span><span class="ident" id="4359651">hashShift</span>&nbsp;<span class="op" id="4359661">+</span>&nbsp;<span class="builtintype" id="4359663">int</span><span class="op" id="4359666">(</span><span class="ident" id="4359667">d</span><span class="op" id="4359668">.</span><span class="ident" id="4359669">window</span><span class="op" id="4359675">[</span><span class="ident" id="4359676">d</span><span class="op" id="4359677">.</span><span class="ident" id="4359678">index</span><span class="op" id="4359683">+</span><span class="num" id="4359684">2</span><span class="op" id="4359685">]</span><span class="op" id="4359686">)</span><span class="op" id="4359687">)</span>&nbsp;<span class="op" id="4359689">&amp;</span>&nbsp;<span class="ident" id="4359691">hashMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359706">//&nbsp;Get&nbsp;previous&nbsp;value&nbsp;with&nbsp;the&nbsp;same&nbsp;hash.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359754">//&nbsp;Our&nbsp;chain&nbsp;should&nbsp;point&nbsp;to&nbsp;the&nbsp;previous&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4359809">d</span><span class="op" id="4359810">.</span><span class="ident" id="4359811">hashPrev</span><span class="op" id="4359819">[</span><span class="ident" id="4359820">d</span><span class="op" id="4359821">.</span><span class="ident" id="4359822">index</span><span class="op" id="4359827">&amp;</span><span class="ident" id="4359828">windowMask</span><span class="op" id="4359838">]</span>&nbsp;<span class="op" id="4359840">=</span>&nbsp;<span class="ident" id="4359842">d</span><span class="op" id="4359843">.</span><span class="ident" id="4359844">hashHead</span><span class="op" id="4359852">[</span><span class="ident" id="4359853">d</span><span class="op" id="4359854">.</span><span class="ident" id="4359855">hash</span><span class="op" id="4359859">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4359867">//&nbsp;Set&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;hash&nbsp;chain&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4359914">d</span><span class="op" id="4359915">.</span><span class="ident" id="4359916">hashHead</span><span class="op" id="4359924">[</span><span class="ident" id="4359925">d</span><span class="op" id="4359926">.</span><span class="ident" id="4359927">hash</span><span class="op" id="4359931">]</span>&nbsp;<span class="op" id="4359933">=</span>&nbsp;<span class="ident" id="4359935">d</span><span class="op" id="4359936">.</span><span class="ident" id="4359937">index</span>&nbsp;<span class="op" id="4359943">+</span>&nbsp;<span class="ident" id="4359945">d</span><span class="op" id="4359946">.</span><span class="ident" id="4359947">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4359963">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4359969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4359975">if</span>&nbsp;<span class="ident" id="4359978">d</span><span class="op" id="4359979">.</span><span class="ident" id="4359980">fastSkipHashing</span>&nbsp;<span class="op" id="4359996">==</span>&nbsp;<span class="ident" id="4359999">skipNever</span>&nbsp;<span class="op" id="4360009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360016">d</span><span class="op" id="4360017">.</span><span class="ident" id="4360018">byteAvailable</span>&nbsp;<span class="op" id="4360032">=</span>&nbsp;<span class="builtintype" id="4360034">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360045">d</span><span class="op" id="4360046">.</span><span class="ident" id="4360047">length</span>&nbsp;<span class="op" id="4360054">=</span>&nbsp;<span class="ident" id="4360056">minMatchLength</span>&nbsp;<span class="op" id="4360071">-</span>&nbsp;<span class="num" id="4360073">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360079">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360084">}</span>&nbsp;<span class="keyword" id="4360086">else</span>&nbsp;<span class="op" id="4360091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4360097">//&nbsp;For&nbsp;matches&nbsp;this&nbsp;long,&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;inserting&nbsp;each&nbsp;individual</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4360169">//&nbsp;item&nbsp;into&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360197">d</span><span class="op" id="4360198">.</span><span class="ident" id="4360199">index</span>&nbsp;<span class="op" id="4360205">+=</span>&nbsp;<span class="ident" id="4360208">d</span><span class="op" id="4360209">.</span><span class="ident" id="4360210">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360221">if</span>&nbsp;<span class="ident" id="4360224">d</span><span class="op" id="4360225">.</span><span class="ident" id="4360226">index</span>&nbsp;<span class="op" id="4360232">&lt;</span>&nbsp;<span class="ident" id="4360234">d</span><span class="op" id="4360235">.</span><span class="ident" id="4360236">maxInsertIndex</span>&nbsp;<span class="op" id="4360251">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360258">d</span><span class="op" id="4360259">.</span><span class="ident" id="4360260">hash</span>&nbsp;<span class="op" id="4360265">=</span>&nbsp;<span class="op" id="4360267">(</span><span class="builtintype" id="4360268">int</span><span class="op" id="4360271">(</span><span class="ident" id="4360272">d</span><span class="op" id="4360273">.</span><span class="ident" id="4360274">window</span><span class="op" id="4360280">[</span><span class="ident" id="4360281">d</span><span class="op" id="4360282">.</span><span class="ident" id="4360283">index</span><span class="op" id="4360288">]</span><span class="op" id="4360289">)</span><span class="op" id="4360290">&lt;&lt;</span><span class="ident" id="4360292">hashShift</span>&nbsp;<span class="op" id="4360302">+</span>&nbsp;<span class="builtintype" id="4360304">int</span><span class="op" id="4360307">(</span><span class="ident" id="4360308">d</span><span class="op" id="4360309">.</span><span class="ident" id="4360310">window</span><span class="op" id="4360316">[</span><span class="ident" id="4360317">d</span><span class="op" id="4360318">.</span><span class="ident" id="4360319">index</span><span class="op" id="4360324">+</span><span class="num" id="4360325">1</span><span class="op" id="4360326">]</span><span class="op" id="4360327">)</span><span class="op" id="4360328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360344">if</span>&nbsp;<span class="builtinfunc" id="4360347">len</span><span class="op" id="4360350">(</span><span class="ident" id="4360351">d</span><span class="op" id="4360352">.</span><span class="ident" id="4360353">tokens</span><span class="op" id="4360359">)</span>&nbsp;<span class="op" id="4360361">==</span>&nbsp;<span class="ident" id="4360364">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4360384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4360390">//&nbsp;The&nbsp;block&nbsp;includes&nbsp;the&nbsp;current&nbsp;character</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360438">if</span>&nbsp;<span class="ident" id="4360441">d</span><span class="op" id="4360442">.</span><span class="ident" id="4360443">err</span>&nbsp;<span class="op" id="4360447">=</span>&nbsp;<span class="ident" id="4360449">d</span><span class="op" id="4360450">.</span><span class="ident" id="4360451">writeBlock</span><span class="op" id="4360461">(</span><span class="ident" id="4360462">d</span><span class="op" id="4360463">.</span><span class="ident" id="4360464">tokens</span><span class="op" id="4360470">,</span>&nbsp;<span class="ident" id="4360472">d</span><span class="op" id="4360473">.</span><span class="ident" id="4360474">index</span><span class="op" id="4360479">,</span>&nbsp;<span class="builtintype" id="4360481">false</span><span class="op" id="4360486">)</span><span class="op" id="4360487">;</span>&nbsp;<span class="ident" id="4360489">d</span><span class="op" id="4360490">.</span><span class="ident" id="4360491">err</span>&nbsp;<span class="op" id="4360495">!=</span>&nbsp;<span class="ident" id="4360498">nil</span>&nbsp;<span class="op" id="4360502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360509">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360526">d</span><span class="op" id="4360527">.</span><span class="ident" id="4360528">tokens</span>&nbsp;<span class="op" id="4360535">=</span>&nbsp;<span class="ident" id="4360537">d</span><span class="op" id="4360538">.</span><span class="ident" id="4360539">tokens</span><span class="op" id="4360545">[</span><span class="op" id="4360546">:</span><span class="num" id="4360547">0</span><span class="op" id="4360548">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360553">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360557">}</span>&nbsp;<span class="keyword" id="4360559">else</span>&nbsp;<span class="op" id="4360564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360569">if</span>&nbsp;<span class="ident" id="4360572">d</span><span class="op" id="4360573">.</span><span class="ident" id="4360574">fastSkipHashing</span>&nbsp;<span class="op" id="4360590">!=</span>&nbsp;<span class="ident" id="4360593">skipNever</span>&nbsp;<span class="op" id="4360603">||</span>&nbsp;<span class="ident" id="4360606">d</span><span class="op" id="4360607">.</span><span class="ident" id="4360608">byteAvailable</span>&nbsp;<span class="op" id="4360622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360628">i</span>&nbsp;<span class="op" id="4360630">:=</span>&nbsp;<span class="ident" id="4360633">d</span><span class="op" id="4360634">.</span><span class="ident" id="4360635">index</span>&nbsp;<span class="op" id="4360641">-</span>&nbsp;<span class="num" id="4360643">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360649">if</span>&nbsp;<span class="ident" id="4360652">d</span><span class="op" id="4360653">.</span><span class="ident" id="4360654">fastSkipHashing</span>&nbsp;<span class="op" id="4360670">!=</span>&nbsp;<span class="ident" id="4360673">skipNever</span>&nbsp;<span class="op" id="4360683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360690">i</span>&nbsp;<span class="op" id="4360692">=</span>&nbsp;<span class="ident" id="4360694">d</span><span class="op" id="4360695">.</span><span class="ident" id="4360696">index</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360712">d</span><span class="op" id="4360713">.</span><span class="ident" id="4360714">tokens</span>&nbsp;<span class="op" id="4360721">=</span>&nbsp;<span class="builtinfunc" id="4360723">append</span><span class="op" id="4360729">(</span><span class="ident" id="4360730">d</span><span class="op" id="4360731">.</span><span class="ident" id="4360732">tokens</span><span class="op" id="4360738">,</span>&nbsp;<span class="ident" id="4360740">literalToken</span><span class="op" id="4360752">(</span><span class="builtintype" id="4360753">uint32</span><span class="op" id="4360759">(</span><span class="ident" id="4360760">d</span><span class="op" id="4360761">.</span><span class="ident" id="4360762">window</span><span class="op" id="4360768">[</span><span class="ident" id="4360769">i</span><span class="op" id="4360770">]</span><span class="op" id="4360771">)</span><span class="op" id="4360772">)</span><span class="op" id="4360773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360779">if</span>&nbsp;<span class="builtinfunc" id="4360782">len</span><span class="op" id="4360785">(</span><span class="ident" id="4360786">d</span><span class="op" id="4360787">.</span><span class="ident" id="4360788">tokens</span><span class="op" id="4360794">)</span>&nbsp;<span class="op" id="4360796">==</span>&nbsp;<span class="ident" id="4360799">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4360819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360826">if</span>&nbsp;<span class="ident" id="4360829">d</span><span class="op" id="4360830">.</span><span class="ident" id="4360831">err</span>&nbsp;<span class="op" id="4360835">=</span>&nbsp;<span class="ident" id="4360837">d</span><span class="op" id="4360838">.</span><span class="ident" id="4360839">writeBlock</span><span class="op" id="4360849">(</span><span class="ident" id="4360850">d</span><span class="op" id="4360851">.</span><span class="ident" id="4360852">tokens</span><span class="op" id="4360858">,</span>&nbsp;<span class="ident" id="4360860">i</span><span class="op" id="4360861">+</span><span class="num" id="4360862">1</span><span class="op" id="4360863">,</span>&nbsp;<span class="builtintype" id="4360865">false</span><span class="op" id="4360870">)</span><span class="op" id="4360871">;</span>&nbsp;<span class="ident" id="4360873">d</span><span class="op" id="4360874">.</span><span class="ident" id="4360875">err</span>&nbsp;<span class="op" id="4360879">!=</span>&nbsp;<span class="ident" id="4360882">nil</span>&nbsp;<span class="op" id="4360886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360894">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360913">d</span><span class="op" id="4360914">.</span><span class="ident" id="4360915">tokens</span>&nbsp;<span class="op" id="4360922">=</span>&nbsp;<span class="ident" id="4360924">d</span><span class="op" id="4360925">.</span><span class="ident" id="4360926">tokens</span><span class="op" id="4360932">[</span><span class="op" id="4360933">:</span><span class="num" id="4360934">0</span><span class="op" id="4360935">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4360946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4360951">d</span><span class="op" id="4360952">.</span><span class="ident" id="4360953">index</span><span class="op" id="4360958">++</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4360964">if</span>&nbsp;<span class="ident" id="4360967">d</span><span class="op" id="4360968">.</span><span class="ident" id="4360969">fastSkipHashing</span>&nbsp;<span class="op" id="4360985">==</span>&nbsp;<span class="ident" id="4360988">skipNever</span>&nbsp;<span class="op" id="4360998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361004">d</span><span class="op" id="4361005">.</span><span class="ident" id="4361006">byteAvailable</span>&nbsp;<span class="op" id="4361020">=</span>&nbsp;<span class="builtintype" id="4361022">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4361030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4361034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4361037">}</span><br>
<span class="lineno">360</span><span class="op" id="4361039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4361042">func</span>&nbsp;<span class="op" id="4361047">(</span><span class="ident" id="4361048">d</span>&nbsp;<span class="op" id="4361050">*</span><span class="ident" id="4361051">compressor</span><span class="op" id="4361061">)</span>&nbsp;<span class="ident" id="4361063">fillStore</span><span class="op" id="4361072">(</span><span class="ident" id="4361073">b</span>&nbsp;<span class="op" id="4361075">[</span><span class="op" id="4361076">]</span><span class="builtintype" id="4361077">byte</span><span class="op" id="4361081">)</span>&nbsp;<span class="builtintype" id="4361083">int</span>&nbsp;<span class="op" id="4361087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361090">n</span>&nbsp;<span class="op" id="4361092">:=</span>&nbsp;<span class="builtinfunc" id="4361095">copy</span><span class="op" id="4361099">(</span><span class="ident" id="4361100">d</span><span class="op" id="4361101">.</span><span class="ident" id="4361102">window</span><span class="op" id="4361108">[</span><span class="ident" id="4361109">d</span><span class="op" id="4361110">.</span><span class="ident" id="4361111">windowEnd</span><span class="op" id="4361120">:</span><span class="op" id="4361121">]</span><span class="op" id="4361122">,</span>&nbsp;<span class="ident" id="4361124">b</span><span class="op" id="4361125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361128">d</span><span class="op" id="4361129">.</span><span class="ident" id="4361130">windowEnd</span>&nbsp;<span class="op" id="4361140">+=</span>&nbsp;<span class="ident" id="4361143">n</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361146">return</span>&nbsp;<span class="ident" id="4361153">n</span><br>
<span class="lineno"></span><span class="op" id="4361155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4361158">func</span>&nbsp;<span class="op" id="4361163">(</span><span class="ident" id="4361164">d</span>&nbsp;<span class="op" id="4361166">*</span><span class="ident" id="4361167">compressor</span><span class="op" id="4361177">)</span>&nbsp;<span class="ident" id="4361179">store</span><span class="op" id="4361184">(</span><span class="op" id="4361185">)</span>&nbsp;<span class="op" id="4361187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361190">if</span>&nbsp;<span class="ident" id="4361193">d</span><span class="op" id="4361194">.</span><span class="ident" id="4361195">windowEnd</span>&nbsp;<span class="op" id="4361205">&gt;</span>&nbsp;<span class="num" id="4361207">0</span>&nbsp;<span class="op" id="4361209">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361213">d</span><span class="op" id="4361214">.</span><span class="ident" id="4361215">err</span>&nbsp;<span class="op" id="4361219">=</span>&nbsp;<span class="ident" id="4361221">d</span><span class="op" id="4361222">.</span><span class="ident" id="4361223">writeStoredBlock</span><span class="op" id="4361239">(</span><span class="ident" id="4361240">d</span><span class="op" id="4361241">.</span><span class="ident" id="4361242">window</span><span class="op" id="4361248">[</span><span class="op" id="4361249">:</span><span class="ident" id="4361250">d</span><span class="op" id="4361251">.</span><span class="ident" id="4361252">windowEnd</span><span class="op" id="4361261">]</span><span class="op" id="4361262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4361265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361268">d</span><span class="op" id="4361269">.</span><span class="ident" id="4361270">windowEnd</span>&nbsp;<span class="op" id="4361280">=</span>&nbsp;<span class="num" id="4361282">0</span><br>
<span class="lineno"></span><span class="op" id="4361284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span><span class="keyword" id="4361287">func</span>&nbsp;<span class="op" id="4361292">(</span><span class="ident" id="4361293">d</span>&nbsp;<span class="op" id="4361295">*</span><span class="ident" id="4361296">compressor</span><span class="op" id="4361306">)</span>&nbsp;<span class="ident" id="4361308">write</span><span class="op" id="4361313">(</span><span class="ident" id="4361314">b</span>&nbsp;<span class="op" id="4361316">[</span><span class="op" id="4361317">]</span><span class="builtintype" id="4361318">byte</span><span class="op" id="4361322">)</span>&nbsp;<span class="op" id="4361324">(</span><span class="ident" id="4361325">n</span>&nbsp;<span class="builtintype" id="4361327">int</span><span class="op" id="4361330">,</span>&nbsp;<span class="ident" id="4361332">err</span>&nbsp;<span class="builtintype" id="4361336">error</span><span class="op" id="4361341">)</span>&nbsp;<span class="op" id="4361343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361346">n</span>&nbsp;<span class="op" id="4361348">=</span>&nbsp;<span class="builtinfunc" id="4361350">len</span><span class="op" id="4361353">(</span><span class="ident" id="4361354">b</span><span class="op" id="4361355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361358">b</span>&nbsp;<span class="op" id="4361360">=</span>&nbsp;<span class="ident" id="4361362">b</span><span class="op" id="4361363">[</span><span class="ident" id="4361364">d</span><span class="op" id="4361365">.</span><span class="ident" id="4361366">fill</span><span class="op" id="4361370">(</span><span class="ident" id="4361371">d</span><span class="op" id="4361372">,</span>&nbsp;<span class="ident" id="4361374">b</span><span class="op" id="4361375">)</span><span class="op" id="4361376">:</span><span class="op" id="4361377">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361380">for</span>&nbsp;<span class="builtinfunc" id="4361384">len</span><span class="op" id="4361387">(</span><span class="ident" id="4361388">b</span><span class="op" id="4361389">)</span>&nbsp;<span class="op" id="4361391">&gt;</span>&nbsp;<span class="num" id="4361393">0</span>&nbsp;<span class="op" id="4361395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361399">d</span><span class="op" id="4361400">.</span><span class="ident" id="4361401">step</span><span class="op" id="4361405">(</span><span class="ident" id="4361406">d</span><span class="op" id="4361407">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361411">b</span>&nbsp;<span class="op" id="4361413">=</span>&nbsp;<span class="ident" id="4361415">b</span><span class="op" id="4361416">[</span><span class="ident" id="4361417">d</span><span class="op" id="4361418">.</span><span class="ident" id="4361419">fill</span><span class="op" id="4361423">(</span><span class="ident" id="4361424">d</span><span class="op" id="4361425">,</span>&nbsp;<span class="ident" id="4361427">b</span><span class="op" id="4361428">)</span><span class="op" id="4361429">:</span><span class="op" id="4361430">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4361433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361436">return</span>&nbsp;<span class="ident" id="4361443">n</span><span class="op" id="4361444">,</span>&nbsp;<span class="ident" id="4361446">d</span><span class="op" id="4361447">.</span><span class="ident" id="4361448">err</span><br>
<span class="lineno"></span><span class="op" id="4361452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="4361455">func</span>&nbsp;<span class="op" id="4361460">(</span><span class="ident" id="4361461">d</span>&nbsp;<span class="op" id="4361463">*</span><span class="ident" id="4361464">compressor</span><span class="op" id="4361474">)</span>&nbsp;<span class="ident" id="4361476">syncFlush</span><span class="op" id="4361485">(</span><span class="op" id="4361486">)</span>&nbsp;<span class="builtintype" id="4361488">error</span>&nbsp;<span class="op" id="4361494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361497">d</span><span class="op" id="4361498">.</span><span class="ident" id="4361499">sync</span>&nbsp;<span class="op" id="4361504">=</span>&nbsp;<span class="builtintype" id="4361506">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361512">d</span><span class="op" id="4361513">.</span><span class="ident" id="4361514">step</span><span class="op" id="4361518">(</span><span class="ident" id="4361519">d</span><span class="op" id="4361520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361523">if</span>&nbsp;<span class="ident" id="4361526">d</span><span class="op" id="4361527">.</span><span class="ident" id="4361528">err</span>&nbsp;<span class="op" id="4361532">==</span>&nbsp;<span class="ident" id="4361535">nil</span>&nbsp;<span class="op" id="4361539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361543">d</span><span class="op" id="4361544">.</span><span class="ident" id="4361545">w</span><span class="op" id="4361546">.</span><span class="ident" id="4361547">writeStoredHeader</span><span class="op" id="4361564">(</span><span class="num" id="4361565">0</span><span class="op" id="4361566">,</span>&nbsp;<span class="builtintype" id="4361568">false</span><span class="op" id="4361573">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361577">d</span><span class="op" id="4361578">.</span><span class="ident" id="4361579">w</span><span class="op" id="4361580">.</span><span class="ident" id="4361581">flush</span><span class="op" id="4361586">(</span><span class="op" id="4361587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361591">d</span><span class="op" id="4361592">.</span><span class="ident" id="4361593">err</span>&nbsp;<span class="op" id="4361597">=</span>&nbsp;<span class="ident" id="4361599">d</span><span class="op" id="4361600">.</span><span class="ident" id="4361601">w</span><span class="op" id="4361602">.</span><span class="ident" id="4361603">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4361608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361611">d</span><span class="op" id="4361612">.</span><span class="ident" id="4361613">sync</span>&nbsp;<span class="op" id="4361618">=</span>&nbsp;<span class="builtintype" id="4361620">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361627">return</span>&nbsp;<span class="ident" id="4361634">d</span><span class="op" id="4361635">.</span><span class="ident" id="4361636">err</span><br>
<span class="lineno">395</span><span class="op" id="4361640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4361643">func</span>&nbsp;<span class="op" id="4361648">(</span><span class="ident" id="4361649">d</span>&nbsp;<span class="op" id="4361651">*</span><span class="ident" id="4361652">compressor</span><span class="op" id="4361662">)</span>&nbsp;<span class="ident" id="4361664">init</span><span class="op" id="4361668">(</span><span class="ident" id="4361669">w</span>&nbsp;<span class="ident" id="4361671">io</span><span class="op" id="4361673">.</span><span class="ident" id="4361674">Writer</span><span class="op" id="4361680">,</span>&nbsp;<span class="ident" id="4361682">level</span>&nbsp;<span class="builtintype" id="4361688">int</span><span class="op" id="4361691">)</span>&nbsp;<span class="op" id="4361693">(</span><span class="ident" id="4361694">err</span>&nbsp;<span class="builtintype" id="4361698">error</span><span class="op" id="4361703">)</span>&nbsp;<span class="op" id="4361705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361708">d</span><span class="op" id="4361709">.</span><span class="ident" id="4361710">w</span>&nbsp;<span class="op" id="4361712">=</span>&nbsp;<span class="ident" id="4361714">newHuffmanBitWriter</span><span class="op" id="4361733">(</span><span class="ident" id="4361734">w</span><span class="op" id="4361735">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361739">switch</span>&nbsp;<span class="op" id="4361746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361749">case</span>&nbsp;<span class="ident" id="4361754">level</span>&nbsp;<span class="op" id="4361760">==</span>&nbsp;<span class="ident" id="4361763">NoCompression</span><span class="op" id="4361776">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361780">d</span><span class="op" id="4361781">.</span><span class="ident" id="4361782">window</span>&nbsp;<span class="op" id="4361789">=</span>&nbsp;<span class="builtinfunc" id="4361791">make</span><span class="op" id="4361795">(</span><span class="op" id="4361796">[</span><span class="op" id="4361797">]</span><span class="builtintype" id="4361798">byte</span><span class="op" id="4361802">,</span>&nbsp;<span class="ident" id="4361804">maxStoreBlockSize</span><span class="op" id="4361821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361825">d</span><span class="op" id="4361826">.</span><span class="ident" id="4361827">fill</span>&nbsp;<span class="op" id="4361832">=</span>&nbsp;<span class="op" id="4361834">(</span><span class="op" id="4361835">*</span><span class="ident" id="4361836">compressor</span><span class="op" id="4361846">)</span><span class="op" id="4361847">.</span><span class="ident" id="4361848">fillStore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361860">d</span><span class="op" id="4361861">.</span><span class="ident" id="4361862">step</span>&nbsp;<span class="op" id="4361867">=</span>&nbsp;<span class="op" id="4361869">(</span><span class="op" id="4361870">*</span><span class="ident" id="4361871">compressor</span><span class="op" id="4361881">)</span><span class="op" id="4361882">.</span><span class="ident" id="4361883">store</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361890">case</span>&nbsp;<span class="ident" id="4361895">level</span>&nbsp;<span class="op" id="4361901">==</span>&nbsp;<span class="ident" id="4361904">DefaultCompression</span><span class="op" id="4361922">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361926">level</span>&nbsp;<span class="op" id="4361932">=</span>&nbsp;<span class="num" id="4361934">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361938">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4361951">case</span>&nbsp;<span class="num" id="4361956">1</span>&nbsp;<span class="op" id="4361958">&lt;=</span>&nbsp;<span class="ident" id="4361961">level</span>&nbsp;<span class="op" id="4361967">&amp;&amp;</span>&nbsp;<span class="ident" id="4361970">level</span>&nbsp;<span class="op" id="4361976">&lt;=</span>&nbsp;<span class="num" id="4361979">9</span><span class="op" id="4361980">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4361984">d</span><span class="op" id="4361985">.</span><span class="ident" id="4361986">compressionLevel</span>&nbsp;<span class="op" id="4362003">=</span>&nbsp;<span class="ident" id="4362005">levels</span><span class="op" id="4362011">[</span><span class="ident" id="4362012">level</span><span class="op" id="4362017">]</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362021">d</span><span class="op" id="4362022">.</span><span class="ident" id="4362023">initDeflate</span><span class="op" id="4362034">(</span><span class="op" id="4362035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362039">d</span><span class="op" id="4362040">.</span><span class="ident" id="4362041">fill</span>&nbsp;<span class="op" id="4362046">=</span>&nbsp;<span class="op" id="4362048">(</span><span class="op" id="4362049">*</span><span class="ident" id="4362050">compressor</span><span class="op" id="4362060">)</span><span class="op" id="4362061">.</span><span class="ident" id="4362062">fillDeflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362076">d</span><span class="op" id="4362077">.</span><span class="ident" id="4362078">step</span>&nbsp;<span class="op" id="4362083">=</span>&nbsp;<span class="op" id="4362085">(</span><span class="op" id="4362086">*</span><span class="ident" id="4362087">compressor</span><span class="op" id="4362097">)</span><span class="op" id="4362098">.</span><span class="ident" id="4362099">deflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362108">default</span><span class="op" id="4362115">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362119">return</span>&nbsp;<span class="ident" id="4362126">fmt</span><span class="op" id="4362129">.</span><span class="ident" id="4362130">Errorf</span><span class="op" id="4362136">(</span><span class="string" id="4362137">&#34;flate:&nbsp;invalid&nbsp;compression&nbsp;level&nbsp;%d:&nbsp;want&nbsp;value&nbsp;in&nbsp;range&nbsp;[-1,&nbsp;9]&#34;</span><span class="op" id="4362203">,</span>&nbsp;<span class="ident" id="4362205">level</span><span class="op" id="4362210">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4362213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362216">return</span>&nbsp;<span class="ident" id="4362223">nil</span><br>
<span class="lineno"></span><span class="op" id="4362227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4362230">var</span>&nbsp;<span class="ident" id="4362234">zeroes</span>&nbsp;<span class="op" id="4362241">[</span><span class="num" id="4362242">32</span><span class="op" id="4362244">]</span><span class="builtintype" id="4362245">int</span><br>
<span class="lineno">420</span><span class="keyword" id="4362249">var</span>&nbsp;<span class="ident" id="4362253">bzeroes</span>&nbsp;<span class="op" id="4362261">[</span><span class="num" id="4362262">256</span><span class="op" id="4362265">]</span><span class="builtintype" id="4362266">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4362272">func</span>&nbsp;<span class="op" id="4362277">(</span><span class="ident" id="4362278">d</span>&nbsp;<span class="op" id="4362280">*</span><span class="ident" id="4362281">compressor</span><span class="op" id="4362291">)</span>&nbsp;<span class="ident" id="4362293">reset</span><span class="op" id="4362298">(</span><span class="ident" id="4362299">w</span>&nbsp;<span class="ident" id="4362301">io</span><span class="op" id="4362303">.</span><span class="ident" id="4362304">Writer</span><span class="op" id="4362310">)</span>&nbsp;<span class="op" id="4362312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362315">d</span><span class="op" id="4362316">.</span><span class="ident" id="4362317">w</span><span class="op" id="4362318">.</span><span class="ident" id="4362319">reset</span><span class="op" id="4362324">(</span><span class="ident" id="4362325">w</span><span class="op" id="4362326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362329">d</span><span class="op" id="4362330">.</span><span class="ident" id="4362331">sync</span>&nbsp;<span class="op" id="4362336">=</span>&nbsp;<span class="builtintype" id="4362338">false</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362345">d</span><span class="op" id="4362346">.</span><span class="ident" id="4362347">err</span>&nbsp;<span class="op" id="4362351">=</span>&nbsp;<span class="ident" id="4362353">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362358">switch</span>&nbsp;<span class="ident" id="4362365">d</span><span class="op" id="4362366">.</span><span class="ident" id="4362367">compressionLevel</span><span class="op" id="4362383">.</span><span class="ident" id="4362384">chain</span>&nbsp;<span class="op" id="4362390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362393">case</span>&nbsp;<span class="num" id="4362398">0</span><span class="op" id="4362399">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4362403">//&nbsp;level&nbsp;was&nbsp;NoCompression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362433">for</span>&nbsp;<span class="ident" id="4362437">i</span>&nbsp;<span class="op" id="4362439">:=</span>&nbsp;<span class="keyword" id="4362442">range</span>&nbsp;<span class="ident" id="4362448">d</span><span class="op" id="4362449">.</span><span class="ident" id="4362450">window</span>&nbsp;<span class="op" id="4362457">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362462">d</span><span class="op" id="4362463">.</span><span class="ident" id="4362464">window</span><span class="op" id="4362470">[</span><span class="ident" id="4362471">i</span><span class="op" id="4362472">]</span>&nbsp;<span class="op" id="4362474">=</span>&nbsp;<span class="num" id="4362476">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4362480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362484">d</span><span class="op" id="4362485">.</span><span class="ident" id="4362486">windowEnd</span>&nbsp;<span class="op" id="4362496">=</span>&nbsp;<span class="num" id="4362498">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362501">default</span><span class="op" id="4362508">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362512">d</span><span class="op" id="4362513">.</span><span class="ident" id="4362514">chainHead</span>&nbsp;<span class="op" id="4362524">=</span>&nbsp;<span class="op" id="4362526">-</span><span class="num" id="4362527">1</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362531">for</span>&nbsp;<span class="ident" id="4362535">s</span>&nbsp;<span class="op" id="4362537">:=</span>&nbsp;<span class="ident" id="4362540">d</span><span class="op" id="4362541">.</span><span class="ident" id="4362542">hashHead</span><span class="op" id="4362550">;</span>&nbsp;<span class="builtinfunc" id="4362552">len</span><span class="op" id="4362555">(</span><span class="ident" id="4362556">s</span><span class="op" id="4362557">)</span>&nbsp;<span class="op" id="4362559">&gt;</span>&nbsp;<span class="num" id="4362561">0</span><span class="op" id="4362562">;</span>&nbsp;<span class="op" id="4362564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362569">n</span>&nbsp;<span class="op" id="4362571">:=</span>&nbsp;<span class="builtinfunc" id="4362574">copy</span><span class="op" id="4362578">(</span><span class="ident" id="4362579">s</span><span class="op" id="4362580">,</span>&nbsp;<span class="ident" id="4362582">zeroes</span><span class="op" id="4362588">[</span><span class="op" id="4362589">:</span><span class="op" id="4362590">]</span><span class="op" id="4362591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362596">s</span>&nbsp;<span class="op" id="4362598">=</span>&nbsp;<span class="ident" id="4362600">s</span><span class="op" id="4362601">[</span><span class="ident" id="4362602">n</span><span class="op" id="4362603">:</span><span class="op" id="4362604">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4362608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362612">for</span>&nbsp;<span class="ident" id="4362616">s</span>&nbsp;<span class="op" id="4362618">:=</span>&nbsp;<span class="ident" id="4362621">d</span><span class="op" id="4362622">.</span><span class="ident" id="4362623">hashPrev</span><span class="op" id="4362631">;</span>&nbsp;<span class="builtinfunc" id="4362633">len</span><span class="op" id="4362636">(</span><span class="ident" id="4362637">s</span><span class="op" id="4362638">)</span>&nbsp;<span class="op" id="4362640">&gt;</span>&nbsp;<span class="num" id="4362642">0</span><span class="op" id="4362643">;</span>&nbsp;<span class="ident" id="4362645">s</span>&nbsp;<span class="op" id="4362647">=</span>&nbsp;<span class="ident" id="4362649">s</span><span class="op" id="4362650">[</span><span class="builtinfunc" id="4362651">len</span><span class="op" id="4362654">(</span><span class="ident" id="4362655">zeroes</span><span class="op" id="4362661">)</span><span class="op" id="4362662">:</span><span class="op" id="4362663">]</span>&nbsp;<span class="op" id="4362665">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4362670">copy</span><span class="op" id="4362674">(</span><span class="ident" id="4362675">s</span><span class="op" id="4362676">,</span>&nbsp;<span class="ident" id="4362678">zeroes</span><span class="op" id="4362684">[</span><span class="op" id="4362685">:</span><span class="op" id="4362686">]</span><span class="op" id="4362687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4362691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362695">d</span><span class="op" id="4362696">.</span><span class="ident" id="4362697">hashOffset</span>&nbsp;<span class="op" id="4362708">=</span>&nbsp;<span class="num" id="4362710">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362715">d</span><span class="op" id="4362716">.</span><span class="ident" id="4362717">index</span><span class="op" id="4362722">,</span>&nbsp;<span class="ident" id="4362724">d</span><span class="op" id="4362725">.</span><span class="ident" id="4362726">windowEnd</span>&nbsp;<span class="op" id="4362736">=</span>&nbsp;<span class="num" id="4362738">0</span><span class="op" id="4362739">,</span>&nbsp;<span class="num" id="4362741">0</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362745">for</span>&nbsp;<span class="ident" id="4362749">s</span>&nbsp;<span class="op" id="4362751">:=</span>&nbsp;<span class="ident" id="4362754">d</span><span class="op" id="4362755">.</span><span class="ident" id="4362756">window</span><span class="op" id="4362762">;</span>&nbsp;<span class="builtinfunc" id="4362764">len</span><span class="op" id="4362767">(</span><span class="ident" id="4362768">s</span><span class="op" id="4362769">)</span>&nbsp;<span class="op" id="4362771">&gt;</span>&nbsp;<span class="num" id="4362773">0</span><span class="op" id="4362774">;</span>&nbsp;<span class="op" id="4362776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362781">n</span>&nbsp;<span class="op" id="4362783">:=</span>&nbsp;<span class="builtinfunc" id="4362786">copy</span><span class="op" id="4362790">(</span><span class="ident" id="4362791">s</span><span class="op" id="4362792">,</span>&nbsp;<span class="ident" id="4362794">bzeroes</span><span class="op" id="4362801">[</span><span class="op" id="4362802">:</span><span class="op" id="4362803">]</span><span class="op" id="4362804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362809">s</span>&nbsp;<span class="op" id="4362811">=</span>&nbsp;<span class="ident" id="4362813">s</span><span class="op" id="4362814">[</span><span class="ident" id="4362815">n</span><span class="op" id="4362816">:</span><span class="op" id="4362817">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4362821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362825">d</span><span class="op" id="4362826">.</span><span class="ident" id="4362827">blockStart</span><span class="op" id="4362837">,</span>&nbsp;<span class="ident" id="4362839">d</span><span class="op" id="4362840">.</span><span class="ident" id="4362841">byteAvailable</span>&nbsp;<span class="op" id="4362855">=</span>&nbsp;<span class="num" id="4362857">0</span><span class="op" id="4362858">,</span>&nbsp;<span class="builtintype" id="4362860">false</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362869">d</span><span class="op" id="4362870">.</span><span class="ident" id="4362871">tokens</span>&nbsp;<span class="op" id="4362878">=</span>&nbsp;<span class="ident" id="4362880">d</span><span class="op" id="4362881">.</span><span class="ident" id="4362882">tokens</span><span class="op" id="4362888">[</span><span class="op" id="4362889">:</span><span class="ident" id="4362890">maxFlateBlockTokens</span><span class="op" id="4362909">+</span><span class="num" id="4362910">1</span><span class="op" id="4362911">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4362915">for</span>&nbsp;<span class="ident" id="4362919">i</span>&nbsp;<span class="op" id="4362921">:=</span>&nbsp;<span class="num" id="4362924">0</span><span class="op" id="4362925">;</span>&nbsp;<span class="ident" id="4362927">i</span>&nbsp;<span class="op" id="4362929">&lt;=</span>&nbsp;<span class="ident" id="4362932">maxFlateBlockTokens</span><span class="op" id="4362951">;</span>&nbsp;<span class="ident" id="4362953">i</span><span class="op" id="4362954">++</span>&nbsp;<span class="op" id="4362957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362962">d</span><span class="op" id="4362963">.</span><span class="ident" id="4362964">tokens</span><span class="op" id="4362970">[</span><span class="ident" id="4362971">i</span><span class="op" id="4362972">]</span>&nbsp;<span class="op" id="4362974">=</span>&nbsp;<span class="num" id="4362976">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4362980">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4362984">d</span><span class="op" id="4362985">.</span><span class="ident" id="4362986">tokens</span>&nbsp;<span class="op" id="4362993">=</span>&nbsp;<span class="ident" id="4362995">d</span><span class="op" id="4362996">.</span><span class="ident" id="4362997">tokens</span><span class="op" id="4363003">[</span><span class="op" id="4363004">:</span><span class="num" id="4363005">0</span><span class="op" id="4363006">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363010">d</span><span class="op" id="4363011">.</span><span class="ident" id="4363012">length</span>&nbsp;<span class="op" id="4363019">=</span>&nbsp;<span class="ident" id="4363021">minMatchLength</span>&nbsp;<span class="op" id="4363036">-</span>&nbsp;<span class="num" id="4363038">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363042">d</span><span class="op" id="4363043">.</span><span class="ident" id="4363044">offset</span>&nbsp;<span class="op" id="4363051">=</span>&nbsp;<span class="num" id="4363053">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363057">d</span><span class="op" id="4363058">.</span><span class="ident" id="4363059">hash</span>&nbsp;<span class="op" id="4363064">=</span>&nbsp;<span class="num" id="4363066">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363070">d</span><span class="op" id="4363071">.</span><span class="ident" id="4363072">maxInsertIndex</span>&nbsp;<span class="op" id="4363087">=</span>&nbsp;<span class="num" id="4363089">0</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4363092">}</span><br>
<span class="lineno"></span><span class="op" id="4363094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4363097">func</span>&nbsp;<span class="op" id="4363102">(</span><span class="ident" id="4363103">d</span>&nbsp;<span class="op" id="4363105">*</span><span class="ident" id="4363106">compressor</span><span class="op" id="4363116">)</span>&nbsp;<span class="builtinfunc" id="4363118">close</span><span class="op" id="4363123">(</span><span class="op" id="4363124">)</span>&nbsp;<span class="builtintype" id="4363126">error</span>&nbsp;<span class="op" id="4363132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363135">d</span><span class="op" id="4363136">.</span><span class="ident" id="4363137">sync</span>&nbsp;<span class="op" id="4363142">=</span>&nbsp;<span class="builtintype" id="4363144">true</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363150">d</span><span class="op" id="4363151">.</span><span class="ident" id="4363152">step</span><span class="op" id="4363156">(</span><span class="ident" id="4363157">d</span><span class="op" id="4363158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363161">if</span>&nbsp;<span class="ident" id="4363164">d</span><span class="op" id="4363165">.</span><span class="ident" id="4363166">err</span>&nbsp;<span class="op" id="4363170">!=</span>&nbsp;<span class="ident" id="4363173">nil</span>&nbsp;<span class="op" id="4363177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363181">return</span>&nbsp;<span class="ident" id="4363188">d</span><span class="op" id="4363189">.</span><span class="ident" id="4363190">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4363195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363198">if</span>&nbsp;<span class="ident" id="4363201">d</span><span class="op" id="4363202">.</span><span class="ident" id="4363203">w</span><span class="op" id="4363204">.</span><span class="ident" id="4363205">writeStoredHeader</span><span class="op" id="4363222">(</span><span class="num" id="4363223">0</span><span class="op" id="4363224">,</span>&nbsp;<span class="builtintype" id="4363226">true</span><span class="op" id="4363230">)</span><span class="op" id="4363231">;</span>&nbsp;<span class="ident" id="4363233">d</span><span class="op" id="4363234">.</span><span class="ident" id="4363235">w</span><span class="op" id="4363236">.</span><span class="ident" id="4363237">err</span>&nbsp;<span class="op" id="4363241">!=</span>&nbsp;<span class="ident" id="4363244">nil</span>&nbsp;<span class="op" id="4363248">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363252">return</span>&nbsp;<span class="ident" id="4363259">d</span><span class="op" id="4363260">.</span><span class="ident" id="4363261">w</span><span class="op" id="4363262">.</span><span class="ident" id="4363263">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4363268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4363271">d</span><span class="op" id="4363272">.</span><span class="ident" id="4363273">w</span><span class="op" id="4363274">.</span><span class="ident" id="4363275">flush</span><span class="op" id="4363280">(</span><span class="op" id="4363281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363284">return</span>&nbsp;<span class="ident" id="4363291">d</span><span class="op" id="4363292">.</span><span class="ident" id="4363293">w</span><span class="op" id="4363294">.</span><span class="ident" id="4363295">err</span><br>
<span class="lineno"></span><span class="op" id="4363299">}</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span><span class="comment" id="4363302">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;compressing&nbsp;data&nbsp;at&nbsp;the&nbsp;given&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4363373">//&nbsp;Following&nbsp;zlib,&nbsp;levels&nbsp;range&nbsp;from&nbsp;1&nbsp;(BestSpeed)&nbsp;to&nbsp;9&nbsp;(BestCompression);</span><br>
<span class="lineno"></span><span class="comment" id="4363448">//&nbsp;higher&nbsp;levels&nbsp;typically&nbsp;run&nbsp;slower&nbsp;but&nbsp;compress&nbsp;more.&nbsp;Level&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="4363513">//&nbsp;(NoCompression)&nbsp;does&nbsp;not&nbsp;attempt&nbsp;any&nbsp;compression;&nbsp;it&nbsp;only&nbsp;adds&nbsp;the</span><br>
<span class="lineno">480</span><span class="comment" id="4363583">//&nbsp;necessary&nbsp;DEFLATE&nbsp;framing.&nbsp;Level&nbsp;-1&nbsp;(DefaultCompression)&nbsp;uses&nbsp;the&nbsp;default</span><br>
<span class="lineno"></span><span class="comment" id="4363660">//&nbsp;compression&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4363682">//</span><br>
<span class="lineno"></span><span class="comment" id="4363685">//&nbsp;If&nbsp;level&nbsp;is&nbsp;in&nbsp;the&nbsp;range&nbsp;[-1,&nbsp;9]&nbsp;then&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="4363758">//&nbsp;Otherwise&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;non-nil.</span><br>
<span class="lineno">485</span><span class="keyword" id="4363807">func</span>&nbsp;<span class="ident" id="4363812">NewWriter</span><span class="op" id="4363821">(</span><span class="ident" id="4363822">w</span>&nbsp;<span class="ident" id="4363824">io</span><span class="op" id="4363826">.</span><span class="ident" id="4363827">Writer</span><span class="op" id="4363833">,</span>&nbsp;<span class="ident" id="4363835">level</span>&nbsp;<span class="builtintype" id="4363841">int</span><span class="op" id="4363844">)</span>&nbsp;<span class="op" id="4363846">(</span><span class="op" id="4363847">*</span><span class="ident" id="4363848">Writer</span><span class="op" id="4363854">,</span>&nbsp;<span class="builtintype" id="4363856">error</span><span class="op" id="4363861">)</span>&nbsp;<span class="op" id="4363863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363866">var</span>&nbsp;<span class="ident" id="4363870">dw</span>&nbsp;<span class="ident" id="4363873">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363881">if</span>&nbsp;<span class="ident" id="4363884">err</span>&nbsp;<span class="op" id="4363888">:=</span>&nbsp;<span class="ident" id="4363891">dw</span><span class="op" id="4363893">.</span><span class="ident" id="4363894">d</span><span class="op" id="4363895">.</span><span class="ident" id="4363896">init</span><span class="op" id="4363900">(</span><span class="ident" id="4363901">w</span><span class="op" id="4363902">,</span>&nbsp;<span class="ident" id="4363904">level</span><span class="op" id="4363909">)</span><span class="op" id="4363910">;</span>&nbsp;<span class="ident" id="4363912">err</span>&nbsp;<span class="op" id="4363916">!=</span>&nbsp;<span class="ident" id="4363919">nil</span>&nbsp;<span class="op" id="4363923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363927">return</span>&nbsp;<span class="ident" id="4363934">nil</span><span class="op" id="4363937">,</span>&nbsp;<span class="ident" id="4363939">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4363944">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4363947">return</span>&nbsp;<span class="op" id="4363954">&amp;</span><span class="ident" id="4363955">dw</span><span class="op" id="4363957">,</span>&nbsp;<span class="ident" id="4363959">nil</span><br>
<span class="lineno"></span><span class="op" id="4363963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4363966">//&nbsp;NewWriterDict&nbsp;is&nbsp;like&nbsp;NewWriter&nbsp;but&nbsp;initializes&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4364025">//&nbsp;Writer&nbsp;with&nbsp;a&nbsp;preset&nbsp;dictionary.&nbsp;&nbsp;The&nbsp;returned&nbsp;Writer&nbsp;behaves</span><br>
<span class="lineno">495</span><span class="comment" id="4364090">//&nbsp;as&nbsp;if&nbsp;the&nbsp;dictionary&nbsp;had&nbsp;been&nbsp;written&nbsp;to&nbsp;it&nbsp;without&nbsp;producing</span><br>
<span class="lineno"></span><span class="comment" id="4364155">//&nbsp;any&nbsp;compressed&nbsp;output.&nbsp;&nbsp;The&nbsp;compressed&nbsp;data&nbsp;written&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span><span class="comment" id="4364215">//&nbsp;can&nbsp;only&nbsp;be&nbsp;decompressed&nbsp;by&nbsp;a&nbsp;Reader&nbsp;initialized&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4364276">//&nbsp;same&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4364296">func</span>&nbsp;<span class="ident" id="4364301">NewWriterDict</span><span class="op" id="4364314">(</span><span class="ident" id="4364315">w</span>&nbsp;<span class="ident" id="4364317">io</span><span class="op" id="4364319">.</span><span class="ident" id="4364320">Writer</span><span class="op" id="4364326">,</span>&nbsp;<span class="ident" id="4364328">level</span>&nbsp;<span class="builtintype" id="4364334">int</span><span class="op" id="4364337">,</span>&nbsp;<span class="ident" id="4364339">dict</span>&nbsp;<span class="op" id="4364344">[</span><span class="op" id="4364345">]</span><span class="builtintype" id="4364346">byte</span><span class="op" id="4364350">)</span>&nbsp;<span class="op" id="4364352">(</span><span class="op" id="4364353">*</span><span class="ident" id="4364354">Writer</span><span class="op" id="4364360">,</span>&nbsp;<span class="builtintype" id="4364362">error</span><span class="op" id="4364367">)</span>&nbsp;<span class="op" id="4364369">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364372">dw</span>&nbsp;<span class="op" id="4364375">:=</span>&nbsp;<span class="op" id="4364378">&amp;</span><span class="ident" id="4364379">dictWriter</span><span class="op" id="4364389">{</span><span class="ident" id="4364390">w</span><span class="op" id="4364391">,</span>&nbsp;<span class="builtintype" id="4364393">false</span><span class="op" id="4364398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364401">zw</span><span class="op" id="4364403">,</span>&nbsp;<span class="ident" id="4364405">err</span>&nbsp;<span class="op" id="4364409">:=</span>&nbsp;<span class="ident" id="4364412">NewWriter</span><span class="op" id="4364421">(</span><span class="ident" id="4364422">dw</span><span class="op" id="4364424">,</span>&nbsp;<span class="ident" id="4364426">level</span><span class="op" id="4364431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364434">if</span>&nbsp;<span class="ident" id="4364437">err</span>&nbsp;<span class="op" id="4364441">!=</span>&nbsp;<span class="ident" id="4364444">nil</span>&nbsp;<span class="op" id="4364448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364452">return</span>&nbsp;<span class="ident" id="4364459">nil</span><span class="op" id="4364462">,</span>&nbsp;<span class="ident" id="4364464">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4364469">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364472">zw</span><span class="op" id="4364474">.</span><span class="ident" id="4364475">Write</span><span class="op" id="4364480">(</span><span class="ident" id="4364481">dict</span><span class="op" id="4364485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364488">zw</span><span class="op" id="4364490">.</span><span class="ident" id="4364491">Flush</span><span class="op" id="4364496">(</span><span class="op" id="4364497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364500">dw</span><span class="op" id="4364502">.</span><span class="ident" id="4364503">enabled</span>&nbsp;<span class="op" id="4364511">=</span>&nbsp;<span class="builtintype" id="4364513">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364519">zw</span><span class="op" id="4364521">.</span><span class="ident" id="4364522">dict</span>&nbsp;<span class="op" id="4364527">=</span>&nbsp;<span class="builtinfunc" id="4364529">append</span><span class="op" id="4364535">(</span><span class="ident" id="4364536">zw</span><span class="op" id="4364538">.</span><span class="ident" id="4364539">dict</span><span class="op" id="4364543">,</span>&nbsp;<span class="ident" id="4364545">dict</span><span class="op" id="4364549">...</span><span class="op" id="4364552">)</span>&nbsp;<span class="comment" id="4364554">//&nbsp;duplicate&nbsp;dictionary&nbsp;for&nbsp;Reset&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364597">return</span>&nbsp;<span class="ident" id="4364604">zw</span><span class="op" id="4364606">,</span>&nbsp;<span class="ident" id="4364608">err</span><br>
<span class="lineno">510</span><span class="op" id="4364612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4364615">type</span>&nbsp;<span class="ident" id="4364620">dictWriter</span>&nbsp;<span class="keyword" id="4364631">struct</span>&nbsp;<span class="op" id="4364638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364641">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364649">io</span><span class="op" id="4364651">.</span><span class="ident" id="4364652">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364660">enabled</span>&nbsp;<span class="builtintype" id="4364668">bool</span><br>
<span class="lineno">515</span><span class="op" id="4364673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4364676">func</span>&nbsp;<span class="op" id="4364681">(</span><span class="ident" id="4364682">w</span>&nbsp;<span class="op" id="4364684">*</span><span class="ident" id="4364685">dictWriter</span><span class="op" id="4364695">)</span>&nbsp;<span class="ident" id="4364697">Write</span><span class="op" id="4364702">(</span><span class="ident" id="4364703">b</span>&nbsp;<span class="op" id="4364705">[</span><span class="op" id="4364706">]</span><span class="builtintype" id="4364707">byte</span><span class="op" id="4364711">)</span>&nbsp;<span class="op" id="4364713">(</span><span class="ident" id="4364714">n</span>&nbsp;<span class="builtintype" id="4364716">int</span><span class="op" id="4364719">,</span>&nbsp;<span class="ident" id="4364721">err</span>&nbsp;<span class="builtintype" id="4364725">error</span><span class="op" id="4364730">)</span>&nbsp;<span class="op" id="4364732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364735">if</span>&nbsp;<span class="ident" id="4364738">w</span><span class="op" id="4364739">.</span><span class="ident" id="4364740">enabled</span>&nbsp;<span class="op" id="4364748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364752">return</span>&nbsp;<span class="ident" id="4364759">w</span><span class="op" id="4364760">.</span><span class="ident" id="4364761">w</span><span class="op" id="4364762">.</span><span class="ident" id="4364763">Write</span><span class="op" id="4364768">(</span><span class="ident" id="4364769">b</span><span class="op" id="4364770">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4364773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4364776">return</span>&nbsp;<span class="builtinfunc" id="4364783">len</span><span class="op" id="4364786">(</span><span class="ident" id="4364787">b</span><span class="op" id="4364788">)</span><span class="op" id="4364789">,</span>&nbsp;<span class="ident" id="4364791">nil</span><br>
<span class="lineno"></span><span class="op" id="4364795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4364798">//&nbsp;A&nbsp;Writer&nbsp;takes&nbsp;data&nbsp;written&nbsp;to&nbsp;it&nbsp;and&nbsp;writes&nbsp;the&nbsp;compressed</span><br>
<span class="lineno">525</span><span class="comment" id="4364861">//&nbsp;form&nbsp;of&nbsp;that&nbsp;data&nbsp;to&nbsp;an&nbsp;underlying&nbsp;writer&nbsp;(see&nbsp;NewWriter).</span><br>
<span class="lineno"></span><span class="keyword" id="4364923">type</span>&nbsp;<span class="ident" id="4364928">Writer</span>&nbsp;<span class="keyword" id="4364935">struct</span>&nbsp;<span class="op" id="4364942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364945">d</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364950">compressor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4364962">dict</span>&nbsp;<span class="op" id="4364967">[</span><span class="op" id="4364968">]</span><span class="builtintype" id="4364969">byte</span><br>
<span class="lineno"></span><span class="op" id="4364974">}</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span><span class="comment" id="4364977">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;w,&nbsp;which&nbsp;will&nbsp;eventually&nbsp;write&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4365036">//&nbsp;compressed&nbsp;form&nbsp;of&nbsp;data&nbsp;to&nbsp;its&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4365089">func</span>&nbsp;<span class="op" id="4365094">(</span><span class="ident" id="4365095">w</span>&nbsp;<span class="op" id="4365097">*</span><span class="ident" id="4365098">Writer</span><span class="op" id="4365104">)</span>&nbsp;<span class="ident" id="4365106">Write</span><span class="op" id="4365111">(</span><span class="ident" id="4365112">data</span>&nbsp;<span class="op" id="4365117">[</span><span class="op" id="4365118">]</span><span class="builtintype" id="4365119">byte</span><span class="op" id="4365123">)</span>&nbsp;<span class="op" id="4365125">(</span><span class="ident" id="4365126">n</span>&nbsp;<span class="builtintype" id="4365128">int</span><span class="op" id="4365131">,</span>&nbsp;<span class="ident" id="4365133">err</span>&nbsp;<span class="builtintype" id="4365137">error</span><span class="op" id="4365142">)</span>&nbsp;<span class="op" id="4365144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4365147">return</span>&nbsp;<span class="ident" id="4365154">w</span><span class="op" id="4365155">.</span><span class="ident" id="4365156">d</span><span class="op" id="4365157">.</span><span class="ident" id="4365158">write</span><span class="op" id="4365163">(</span><span class="ident" id="4365164">data</span><span class="op" id="4365168">)</span><br>
<span class="lineno">535</span><span class="op" id="4365170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4365173">//&nbsp;Flush&nbsp;flushes&nbsp;any&nbsp;pending&nbsp;compressed&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4365244">//&nbsp;It&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;in&nbsp;compressed&nbsp;network&nbsp;protocols,&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4365315">//&nbsp;a&nbsp;remote&nbsp;reader&nbsp;has&nbsp;enough&nbsp;data&nbsp;to&nbsp;reconstruct&nbsp;a&nbsp;packet.</span><br>
<span class="lineno">540</span><span class="comment" id="4365375">//&nbsp;Flush&nbsp;does&nbsp;not&nbsp;return&nbsp;until&nbsp;the&nbsp;data&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="4365433">//&nbsp;If&nbsp;the&nbsp;underlying&nbsp;writer&nbsp;returns&nbsp;an&nbsp;error,&nbsp;Flush&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="4365505">//</span><br>
<span class="lineno"></span><span class="comment" id="4365508">//&nbsp;In&nbsp;the&nbsp;terminology&nbsp;of&nbsp;the&nbsp;zlib&nbsp;library,&nbsp;Flush&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;Z_SYNC_FLUSH.</span><br>
<span class="lineno"></span><span class="keyword" id="4365588">func</span>&nbsp;<span class="op" id="4365593">(</span><span class="ident" id="4365594">w</span>&nbsp;<span class="op" id="4365596">*</span><span class="ident" id="4365597">Writer</span><span class="op" id="4365603">)</span>&nbsp;<span class="ident" id="4365605">Flush</span><span class="op" id="4365610">(</span><span class="op" id="4365611">)</span>&nbsp;<span class="builtintype" id="4365613">error</span>&nbsp;<span class="op" id="4365619">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4365622">//&nbsp;For&nbsp;more&nbsp;about&nbsp;flushing:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4365651">//&nbsp;http://www.bolet.org/~pornin/deflate-flush.html</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4365703">return</span>&nbsp;<span class="ident" id="4365710">w</span><span class="op" id="4365711">.</span><span class="ident" id="4365712">d</span><span class="op" id="4365713">.</span><span class="ident" id="4365714">syncFlush</span><span class="op" id="4365723">(</span><span class="op" id="4365724">)</span><br>
<span class="lineno"></span><span class="op" id="4365726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span><span class="comment" id="4365729">//&nbsp;Close&nbsp;flushes&nbsp;and&nbsp;closes&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4365769">func</span>&nbsp;<span class="op" id="4365774">(</span><span class="ident" id="4365775">w</span>&nbsp;<span class="op" id="4365777">*</span><span class="ident" id="4365778">Writer</span><span class="op" id="4365784">)</span>&nbsp;<span class="ident" id="4365786">Close</span><span class="op" id="4365791">(</span><span class="op" id="4365792">)</span>&nbsp;<span class="builtintype" id="4365794">error</span>&nbsp;<span class="op" id="4365800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4365803">return</span>&nbsp;<span class="ident" id="4365810">w</span><span class="op" id="4365811">.</span><span class="ident" id="4365812">d</span><span class="op" id="4365813">.</span><span class="builtinfunc" id="4365814">close</span><span class="op" id="4365819">(</span><span class="op" id="4365820">)</span><br>
<span class="lineno"></span><span class="op" id="4365822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span><span class="comment" id="4365825">//&nbsp;Reset&nbsp;discards&nbsp;the&nbsp;writer&#39;s&nbsp;state&nbsp;and&nbsp;makes&nbsp;it&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4365889">//&nbsp;the&nbsp;result&nbsp;of&nbsp;NewWriter&nbsp;or&nbsp;NewWriterDict&nbsp;called&nbsp;with&nbsp;dst</span><br>
<span class="lineno"></span><span class="comment" id="4365949">//&nbsp;and&nbsp;w&#39;s&nbsp;level&nbsp;and&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4365982">func</span>&nbsp;<span class="op" id="4365987">(</span><span class="ident" id="4365988">w</span>&nbsp;<span class="op" id="4365990">*</span><span class="ident" id="4365991">Writer</span><span class="op" id="4365997">)</span>&nbsp;<span class="ident" id="4365999">Reset</span><span class="op" id="4366004">(</span><span class="ident" id="4366005">dst</span>&nbsp;<span class="ident" id="4366009">io</span><span class="op" id="4366011">.</span><span class="ident" id="4366012">Writer</span><span class="op" id="4366018">)</span>&nbsp;<span class="op" id="4366020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4366023">if</span>&nbsp;<span class="ident" id="4366026">dw</span><span class="op" id="4366028">,</span>&nbsp;<span class="ident" id="4366030">ok</span>&nbsp;<span class="op" id="4366033">:=</span>&nbsp;<span class="ident" id="4366036">w</span><span class="op" id="4366037">.</span><span class="ident" id="4366038">d</span><span class="op" id="4366039">.</span><span class="ident" id="4366040">w</span><span class="op" id="4366041">.</span><span class="ident" id="4366042">w</span><span class="op" id="4366043">.</span><span class="op" id="4366044">(</span><span class="op" id="4366045">*</span><span class="ident" id="4366046">dictWriter</span><span class="op" id="4366056">)</span><span class="op" id="4366057">;</span>&nbsp;<span class="ident" id="4366059">ok</span>&nbsp;<span class="op" id="4366062">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4366066">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriterDict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366104">dw</span><span class="op" id="4366106">.</span><span class="ident" id="4366107">w</span>&nbsp;<span class="op" id="4366109">=</span>&nbsp;<span class="ident" id="4366111">dst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366117">w</span><span class="op" id="4366118">.</span><span class="ident" id="4366119">d</span><span class="op" id="4366120">.</span><span class="ident" id="4366121">reset</span><span class="op" id="4366126">(</span><span class="ident" id="4366127">dw</span><span class="op" id="4366129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366133">dw</span><span class="op" id="4366135">.</span><span class="ident" id="4366136">enabled</span>&nbsp;<span class="op" id="4366144">=</span>&nbsp;<span class="builtintype" id="4366146">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366154">w</span><span class="op" id="4366155">.</span><span class="ident" id="4366156">Write</span><span class="op" id="4366161">(</span><span class="ident" id="4366162">w</span><span class="op" id="4366163">.</span><span class="ident" id="4366164">dict</span><span class="op" id="4366168">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366172">w</span><span class="op" id="4366173">.</span><span class="ident" id="4366174">Flush</span><span class="op" id="4366179">(</span><span class="op" id="4366180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366184">dw</span><span class="op" id="4366186">.</span><span class="ident" id="4366187">enabled</span>&nbsp;<span class="op" id="4366195">=</span>&nbsp;<span class="builtintype" id="4366197">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4366203">}</span>&nbsp;<span class="keyword" id="4366205">else</span>&nbsp;<span class="op" id="4366210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4366214">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4366248">w</span><span class="op" id="4366249">.</span><span class="ident" id="4366250">d</span><span class="op" id="4366251">.</span><span class="ident" id="4366252">reset</span><span class="op" id="4366257">(</span><span class="ident" id="4366258">dst</span><span class="op" id="4366261">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4366264">}</span><br>
<span class="lineno"></span><span class="op" id="4366266">}</span>
</div>
</body>
</html>
