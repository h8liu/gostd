<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>archive/tar</h2>
<ul>
<li><a href="/gostd/archive/tar/common.go.html">common.go</a></li>
<li><a href="/gostd/archive/tar/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/archive/tar/reader.go.html">reader.go</a></li>
<li><a href="/gostd/archive/tar/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/archive/tar/stat_atim.go.html">stat_atim.go</a></li>
<li><a href="/gostd/archive/tar/stat_unix.go.html">stat_unix.go</a></li>
<li><a href="/gostd/archive/tar/tar_test.go.html">tar_test.go</a></li>
<li><a href="/gostd/archive/tar/writer.go.html">writer.go</a></li>
<li><a href="/gostd/archive/tar/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4195273">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4195328">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4195382">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4195433">package</span>&nbsp;<span class="ident" id="4195441">tar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4195446">//&nbsp;TODO(dsymonds):</span><br>
<span class="lineno"></span><span class="comment" id="4195465">//&nbsp;-&nbsp;catch&nbsp;more&nbsp;errors&nbsp;(no&nbsp;first&nbsp;header,&nbsp;etc.)</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="4195513">import</span>&nbsp;<span class="op" id="4195520">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4195523">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4195532">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4195542">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4195549">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4195555">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4195561">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4195569">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4195580">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4195591">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4195598">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4195601">var</span>&nbsp;<span class="op" id="4195605">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195608">ErrWriteTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4195627">=</span>&nbsp;<span class="ident" id="4195629">errors</span><span class="op" id="4195635">.</span><span class="ident" id="4195636">New</span><span class="op" id="4195639">(</span><span class="string" id="4195640">&#34;archive/tar:&nbsp;write&nbsp;too&nbsp;long&#34;</span><span class="op" id="4195669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195672">ErrFieldTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4195691">=</span>&nbsp;<span class="ident" id="4195693">errors</span><span class="op" id="4195699">.</span><span class="ident" id="4195700">New</span><span class="op" id="4195703">(</span><span class="string" id="4195704">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&#34;</span><span class="op" id="4195740">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195743">ErrWriteAfterClose</span>&nbsp;<span class="op" id="4195762">=</span>&nbsp;<span class="ident" id="4195764">errors</span><span class="op" id="4195770">.</span><span class="ident" id="4195771">New</span><span class="op" id="4195774">(</span><span class="string" id="4195775">&#34;archive/tar:&nbsp;write&nbsp;after&nbsp;close&#34;</span><span class="op" id="4195807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195810">errNameTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4195829">=</span>&nbsp;<span class="ident" id="4195831">errors</span><span class="op" id="4195837">.</span><span class="ident" id="4195838">New</span><span class="op" id="4195841">(</span><span class="string" id="4195842">&#34;archive/tar:&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="4195870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4195873">errInvalidHeader</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4195892">=</span>&nbsp;<span class="ident" id="4195894">errors</span><span class="op" id="4195900">.</span><span class="ident" id="4195901">New</span><span class="op" id="4195904">(</span><span class="string" id="4195905">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&nbsp;or&nbsp;contains&nbsp;invalid&nbsp;values&#34;</span><span class="op" id="4195968">)</span><br>
<span class="lineno"></span><span class="op" id="4195970">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="4195973">//&nbsp;A&nbsp;Writer&nbsp;provides&nbsp;sequential&nbsp;writing&nbsp;of&nbsp;a&nbsp;tar&nbsp;archive&nbsp;in&nbsp;POSIX.1&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="4196049">//&nbsp;A&nbsp;tar&nbsp;archive&nbsp;consists&nbsp;of&nbsp;a&nbsp;sequence&nbsp;of&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="4196099">//&nbsp;Call&nbsp;WriteHeader&nbsp;to&nbsp;begin&nbsp;a&nbsp;new&nbsp;file,&nbsp;and&nbsp;then&nbsp;call&nbsp;Write&nbsp;to&nbsp;supply&nbsp;that&nbsp;file&#39;s&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="4196188">//&nbsp;writing&nbsp;at&nbsp;most&nbsp;hdr.Size&nbsp;bytes&nbsp;in&nbsp;total.</span><br>
<span class="lineno"></span><span class="keyword" id="4196232">type</span>&nbsp;<span class="ident" id="4196237">Writer</span>&nbsp;<span class="keyword" id="4196244">struct</span>&nbsp;<span class="op" id="4196251">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196254">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4196265">io</span><span class="op" id="4196267">.</span><span class="ident" id="4196268">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196276">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4196287">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196294">nb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4196305">int64</span>&nbsp;<span class="comment" id="4196311">//&nbsp;number&nbsp;of&nbsp;unwritten&nbsp;bytes&nbsp;for&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196364">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4196375">int64</span>&nbsp;<span class="comment" id="4196381">//&nbsp;amount&nbsp;of&nbsp;padding&nbsp;to&nbsp;write&nbsp;after&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196437">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4196448">bool</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196454">usedBinary</span>&nbsp;<span class="builtintype" id="4196465">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4196481">//&nbsp;whether&nbsp;the&nbsp;binary&nbsp;numeric&nbsp;field&nbsp;extension&nbsp;was&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196537">preferPax</span>&nbsp;&nbsp;<span class="builtintype" id="4196548">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4196564">//&nbsp;use&nbsp;pax&nbsp;header&nbsp;instead&nbsp;of&nbsp;binary&nbsp;numeric&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196616">hdrBuff</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4196627">[</span><span class="ident" id="4196628">blockSize</span><span class="op" id="4196637">]</span><span class="builtintype" id="4196638">byte</span>&nbsp;<span class="comment" id="4196643">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;regular&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4196706">paxHdrBuff</span>&nbsp;<span class="op" id="4196717">[</span><span class="ident" id="4196718">blockSize</span><span class="op" id="4196727">]</span><span class="builtintype" id="4196728">byte</span>&nbsp;<span class="comment" id="4196733">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span><span class="op" id="4196791">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="4196794">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;Writer&nbsp;writing&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="4196842">func</span>&nbsp;<span class="ident" id="4196847">NewWriter</span><span class="op" id="4196856">(</span><span class="ident" id="4196857">w</span>&nbsp;<span class="ident" id="4196859">io</span><span class="op" id="4196861">.</span><span class="ident" id="4196862">Writer</span><span class="op" id="4196868">)</span>&nbsp;<span class="op" id="4196870">*</span><span class="ident" id="4196871">Writer</span>&nbsp;<span class="op" id="4196878">{</span>&nbsp;<span class="keyword" id="4196880">return</span>&nbsp;<span class="op" id="4196887">&amp;</span><span class="ident" id="4196888">Writer</span><span class="op" id="4196894">{</span><span class="ident" id="4196895">w</span><span class="op" id="4196896">:</span>&nbsp;<span class="ident" id="4196898">w</span><span class="op" id="4196899">}</span>&nbsp;<span class="op" id="4196901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4196904">//&nbsp;Flush&nbsp;finishes&nbsp;writing&nbsp;the&nbsp;current&nbsp;file&nbsp;(optional).</span><br>
<span class="lineno">50</span><span class="keyword" id="4196959">func</span>&nbsp;<span class="op" id="4196964">(</span><span class="ident" id="4196965">tw</span>&nbsp;<span class="op" id="4196968">*</span><span class="ident" id="4196969">Writer</span><span class="op" id="4196975">)</span>&nbsp;<span class="ident" id="4196977">Flush</span><span class="op" id="4196982">(</span><span class="op" id="4196983">)</span>&nbsp;<span class="builtintype" id="4196985">error</span>&nbsp;<span class="op" id="4196991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4196994">if</span>&nbsp;<span class="ident" id="4196997">tw</span><span class="op" id="4196999">.</span><span class="ident" id="4197000">nb</span>&nbsp;<span class="op" id="4197003">&gt;</span>&nbsp;<span class="num" id="4197005">0</span>&nbsp;<span class="op" id="4197007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197011">tw</span><span class="op" id="4197013">.</span><span class="ident" id="4197014">err</span>&nbsp;<span class="op" id="4197018">=</span>&nbsp;<span class="ident" id="4197020">fmt</span><span class="op" id="4197023">.</span><span class="ident" id="4197024">Errorf</span><span class="op" id="4197030">(</span><span class="string" id="4197031">&#34;archive/tar:&nbsp;missed&nbsp;writing&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="4197069">,</span>&nbsp;<span class="ident" id="4197071">tw</span><span class="op" id="4197073">.</span><span class="ident" id="4197074">nb</span><span class="op" id="4197076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197080">return</span>&nbsp;<span class="ident" id="4197087">tw</span><span class="op" id="4197089">.</span><span class="ident" id="4197090">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197095">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197099">n</span>&nbsp;<span class="op" id="4197101">:=</span>&nbsp;<span class="ident" id="4197104">tw</span><span class="op" id="4197106">.</span><span class="ident" id="4197107">nb</span>&nbsp;<span class="op" id="4197110">+</span>&nbsp;<span class="ident" id="4197112">tw</span><span class="op" id="4197114">.</span><span class="ident" id="4197115">pad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197120">for</span>&nbsp;<span class="ident" id="4197124">n</span>&nbsp;<span class="op" id="4197126">&gt;</span>&nbsp;<span class="num" id="4197128">0</span>&nbsp;<span class="op" id="4197130">&amp;&amp;</span>&nbsp;<span class="ident" id="4197133">tw</span><span class="op" id="4197135">.</span><span class="ident" id="4197136">err</span>&nbsp;<span class="op" id="4197140">==</span>&nbsp;<span class="ident" id="4197143">nil</span>&nbsp;<span class="op" id="4197147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197151">nr</span>&nbsp;<span class="op" id="4197154">:=</span>&nbsp;<span class="ident" id="4197157">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197161">if</span>&nbsp;<span class="ident" id="4197164">nr</span>&nbsp;<span class="op" id="4197167">&gt;</span>&nbsp;<span class="ident" id="4197169">blockSize</span>&nbsp;<span class="op" id="4197179">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197184">nr</span>&nbsp;<span class="op" id="4197187">=</span>&nbsp;<span class="ident" id="4197189">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197205">var</span>&nbsp;<span class="ident" id="4197209">nw</span>&nbsp;<span class="builtintype" id="4197212">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197218">nw</span><span class="op" id="4197220">,</span>&nbsp;<span class="ident" id="4197222">tw</span><span class="op" id="4197224">.</span><span class="ident" id="4197225">err</span>&nbsp;<span class="op" id="4197229">=</span>&nbsp;<span class="ident" id="4197231">tw</span><span class="op" id="4197233">.</span><span class="ident" id="4197234">w</span><span class="op" id="4197235">.</span><span class="ident" id="4197236">Write</span><span class="op" id="4197241">(</span><span class="ident" id="4197242">zeroBlock</span><span class="op" id="4197251">[</span><span class="num" id="4197252">0</span><span class="op" id="4197253">:</span><span class="ident" id="4197254">nr</span><span class="op" id="4197256">]</span><span class="op" id="4197257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197261">n</span>&nbsp;<span class="op" id="4197263">-=</span>&nbsp;<span class="ident" id="4197266">int64</span><span class="op" id="4197271">(</span><span class="ident" id="4197272">nw</span><span class="op" id="4197274">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197280">tw</span><span class="op" id="4197282">.</span><span class="ident" id="4197283">nb</span>&nbsp;<span class="op" id="4197286">=</span>&nbsp;<span class="num" id="4197288">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197291">tw</span><span class="op" id="4197293">.</span><span class="ident" id="4197294">pad</span>&nbsp;<span class="op" id="4197298">=</span>&nbsp;<span class="num" id="4197300">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197303">return</span>&nbsp;<span class="ident" id="4197310">tw</span><span class="op" id="4197312">.</span><span class="ident" id="4197313">err</span><br>
<span class="lineno"></span><span class="op" id="4197317">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="4197320">//&nbsp;Write&nbsp;s&nbsp;into&nbsp;b,&nbsp;terminating&nbsp;it&nbsp;with&nbsp;a&nbsp;NUL&nbsp;if&nbsp;there&nbsp;is&nbsp;room.</span><br>
<span class="lineno"></span><span class="comment" id="4197383">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;allowPax&nbsp;is&nbsp;true&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="4197477">func</span>&nbsp;<span class="op" id="4197482">(</span><span class="ident" id="4197483">tw</span>&nbsp;<span class="op" id="4197486">*</span><span class="ident" id="4197487">Writer</span><span class="op" id="4197493">)</span>&nbsp;<span class="ident" id="4197495">cString</span><span class="op" id="4197502">(</span><span class="ident" id="4197503">b</span>&nbsp;<span class="op" id="4197505">[</span><span class="op" id="4197506">]</span><span class="builtintype" id="4197507">byte</span><span class="op" id="4197511">,</span>&nbsp;<span class="ident" id="4197513">s</span>&nbsp;<span class="builtintype" id="4197515">string</span><span class="op" id="4197521">,</span>&nbsp;<span class="ident" id="4197523">allowPax</span>&nbsp;<span class="builtintype" id="4197532">bool</span><span class="op" id="4197536">,</span>&nbsp;<span class="ident" id="4197538">paxKeyword</span>&nbsp;<span class="builtintype" id="4197549">string</span><span class="op" id="4197555">,</span>&nbsp;<span class="ident" id="4197557">paxHeaders</span>&nbsp;<span class="keyword" id="4197568">map</span><span class="op" id="4197571">[</span><span class="builtintype" id="4197572">string</span><span class="op" id="4197578">]</span><span class="builtintype" id="4197579">string</span><span class="op" id="4197585">)</span>&nbsp;<span class="op" id="4197587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197590">needsPaxHeader</span>&nbsp;<span class="op" id="4197605">:=</span>&nbsp;<span class="ident" id="4197608">allowPax</span>&nbsp;<span class="op" id="4197617">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4197620">len</span><span class="op" id="4197623">(</span><span class="ident" id="4197624">s</span><span class="op" id="4197625">)</span>&nbsp;<span class="op" id="4197627">&gt;</span>&nbsp;<span class="builtinfunc" id="4197629">len</span><span class="op" id="4197632">(</span><span class="ident" id="4197633">b</span><span class="op" id="4197634">)</span>&nbsp;<span class="op" id="4197636">||</span>&nbsp;<span class="op" id="4197639">!</span><span class="ident" id="4197640">isASCII</span><span class="op" id="4197647">(</span><span class="ident" id="4197648">s</span><span class="op" id="4197649">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197652">if</span>&nbsp;<span class="ident" id="4197655">needsPaxHeader</span>&nbsp;<span class="op" id="4197670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197674">paxHeaders</span><span class="op" id="4197684">[</span><span class="ident" id="4197685">paxKeyword</span><span class="op" id="4197695">]</span>&nbsp;<span class="op" id="4197697">=</span>&nbsp;<span class="ident" id="4197699">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197703">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197714">if</span>&nbsp;<span class="builtinfunc" id="4197717">len</span><span class="op" id="4197720">(</span><span class="ident" id="4197721">s</span><span class="op" id="4197722">)</span>&nbsp;<span class="op" id="4197724">&gt;</span>&nbsp;<span class="builtinfunc" id="4197726">len</span><span class="op" id="4197729">(</span><span class="ident" id="4197730">b</span><span class="op" id="4197731">)</span>&nbsp;<span class="op" id="4197733">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197737">if</span>&nbsp;<span class="ident" id="4197740">tw</span><span class="op" id="4197742">.</span><span class="ident" id="4197743">err</span>&nbsp;<span class="op" id="4197747">==</span>&nbsp;<span class="ident" id="4197750">nil</span>&nbsp;<span class="op" id="4197754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197759">tw</span><span class="op" id="4197761">.</span><span class="ident" id="4197762">err</span>&nbsp;<span class="op" id="4197766">=</span>&nbsp;<span class="ident" id="4197768">ErrFieldTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197790">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197798">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197801">ascii</span>&nbsp;<span class="op" id="4197807">:=</span>&nbsp;<span class="ident" id="4197810">toASCII</span><span class="op" id="4197817">(</span><span class="ident" id="4197818">s</span><span class="op" id="4197819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4197822">copy</span><span class="op" id="4197826">(</span><span class="ident" id="4197827">b</span><span class="op" id="4197828">,</span>&nbsp;<span class="ident" id="4197830">ascii</span><span class="op" id="4197835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4197838">if</span>&nbsp;<span class="builtinfunc" id="4197841">len</span><span class="op" id="4197844">(</span><span class="ident" id="4197845">ascii</span><span class="op" id="4197850">)</span>&nbsp;<span class="op" id="4197852">&lt;</span>&nbsp;<span class="builtinfunc" id="4197854">len</span><span class="op" id="4197857">(</span><span class="ident" id="4197858">b</span><span class="op" id="4197859">)</span>&nbsp;<span class="op" id="4197861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4197865">b</span><span class="op" id="4197866">[</span><span class="builtinfunc" id="4197867">len</span><span class="op" id="4197870">(</span><span class="ident" id="4197871">ascii</span><span class="op" id="4197876">)</span><span class="op" id="4197877">]</span>&nbsp;<span class="op" id="4197879">=</span>&nbsp;<span class="num" id="4197881">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4197884">}</span><br>
<span class="lineno">90</span><span class="op" id="4197886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4197889">//&nbsp;Encode&nbsp;x&nbsp;as&nbsp;an&nbsp;octal&nbsp;ASCII&nbsp;string&nbsp;and&nbsp;write&nbsp;it&nbsp;into&nbsp;b&nbsp;with&nbsp;leading&nbsp;zeros.</span><br>
<span class="lineno"></span><span class="keyword" id="4197966">func</span>&nbsp;<span class="op" id="4197971">(</span><span class="ident" id="4197972">tw</span>&nbsp;<span class="op" id="4197975">*</span><span class="ident" id="4197976">Writer</span><span class="op" id="4197982">)</span>&nbsp;<span class="ident" id="4197984">octal</span><span class="op" id="4197989">(</span><span class="ident" id="4197990">b</span>&nbsp;<span class="op" id="4197992">[</span><span class="op" id="4197993">]</span><span class="builtintype" id="4197994">byte</span><span class="op" id="4197998">,</span>&nbsp;<span class="ident" id="4198000">x</span>&nbsp;<span class="ident" id="4198002">int64</span><span class="op" id="4198007">)</span>&nbsp;<span class="op" id="4198009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4198012">s</span>&nbsp;<span class="op" id="4198014">:=</span>&nbsp;<span class="ident" id="4198017">strconv</span><span class="op" id="4198024">.</span><span class="ident" id="4198025">FormatInt</span><span class="op" id="4198034">(</span><span class="ident" id="4198035">x</span><span class="op" id="4198036">,</span>&nbsp;<span class="num" id="4198038">8</span><span class="op" id="4198039">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4198042">//&nbsp;leading&nbsp;zeros,&nbsp;but&nbsp;leave&nbsp;room&nbsp;for&nbsp;a&nbsp;NUL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198087">for</span>&nbsp;<span class="builtinfunc" id="4198091">len</span><span class="op" id="4198094">(</span><span class="ident" id="4198095">s</span><span class="op" id="4198096">)</span><span class="op" id="4198097">+</span><span class="num" id="4198098">1</span>&nbsp;<span class="op" id="4198100">&lt;</span>&nbsp;<span class="builtinfunc" id="4198102">len</span><span class="op" id="4198105">(</span><span class="ident" id="4198106">b</span><span class="op" id="4198107">)</span>&nbsp;<span class="op" id="4198109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4198113">s</span>&nbsp;<span class="op" id="4198115">=</span>&nbsp;<span class="string" id="4198117">&#34;0&#34;</span>&nbsp;<span class="op" id="4198121">+</span>&nbsp;<span class="ident" id="4198123">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4198126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4198129">tw</span><span class="op" id="4198131">.</span><span class="ident" id="4198132">cString</span><span class="op" id="4198139">(</span><span class="ident" id="4198140">b</span><span class="op" id="4198141">,</span>&nbsp;<span class="ident" id="4198143">s</span><span class="op" id="4198144">,</span>&nbsp;<span class="builtintype" id="4198146">false</span><span class="op" id="4198151">,</span>&nbsp;<span class="ident" id="4198153">paxNone</span><span class="op" id="4198160">,</span>&nbsp;<span class="ident" id="4198162">nil</span><span class="op" id="4198165">)</span><br>
<span class="lineno">100</span><span class="op" id="4198167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4198170">//&nbsp;Write&nbsp;x&nbsp;into&nbsp;b,&nbsp;either&nbsp;as&nbsp;octal&nbsp;or&nbsp;as&nbsp;binary&nbsp;(GNUtar/star&nbsp;extension).</span><br>
<span class="lineno"></span><span class="comment" id="4198243">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;writingPax&nbsp;is&nbsp;enabled&nbsp;both&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;the&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="4198369">func</span>&nbsp;<span class="op" id="4198374">(</span><span class="ident" id="4198375">tw</span>&nbsp;<span class="op" id="4198378">*</span><span class="ident" id="4198379">Writer</span><span class="op" id="4198385">)</span>&nbsp;<span class="ident" id="4198387">numeric</span><span class="op" id="4198394">(</span><span class="ident" id="4198395">b</span>&nbsp;<span class="op" id="4198397">[</span><span class="op" id="4198398">]</span><span class="builtintype" id="4198399">byte</span><span class="op" id="4198403">,</span>&nbsp;<span class="ident" id="4198405">x</span>&nbsp;<span class="ident" id="4198407">int64</span><span class="op" id="4198412">,</span>&nbsp;<span class="ident" id="4198414">allowPax</span>&nbsp;<span class="builtintype" id="4198423">bool</span><span class="op" id="4198427">,</span>&nbsp;<span class="ident" id="4198429">paxKeyword</span>&nbsp;<span class="builtintype" id="4198440">string</span><span class="op" id="4198446">,</span>&nbsp;<span class="ident" id="4198448">paxHeaders</span>&nbsp;<span class="keyword" id="4198459">map</span><span class="op" id="4198462">[</span><span class="builtintype" id="4198463">string</span><span class="op" id="4198469">]</span><span class="builtintype" id="4198470">string</span><span class="op" id="4198476">)</span>&nbsp;<span class="op" id="4198478">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4198481">//&nbsp;Try&nbsp;octal&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4198502">s</span>&nbsp;<span class="op" id="4198504">:=</span>&nbsp;<span class="ident" id="4198507">strconv</span><span class="op" id="4198514">.</span><span class="ident" id="4198515">FormatInt</span><span class="op" id="4198524">(</span><span class="ident" id="4198525">x</span><span class="op" id="4198526">,</span>&nbsp;<span class="num" id="4198528">8</span><span class="op" id="4198529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198532">if</span>&nbsp;<span class="builtinfunc" id="4198535">len</span><span class="op" id="4198538">(</span><span class="ident" id="4198539">s</span><span class="op" id="4198540">)</span>&nbsp;<span class="op" id="4198542">&lt;</span>&nbsp;<span class="builtinfunc" id="4198544">len</span><span class="op" id="4198547">(</span><span class="ident" id="4198548">b</span><span class="op" id="4198549">)</span>&nbsp;<span class="op" id="4198551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4198555">tw</span><span class="op" id="4198557">.</span><span class="ident" id="4198558">octal</span><span class="op" id="4198563">(</span><span class="ident" id="4198564">b</span><span class="op" id="4198565">,</span>&nbsp;<span class="ident" id="4198567">x</span><span class="op" id="4198568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198572">return</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4198580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4198584">//&nbsp;If&nbsp;it&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;octal,&nbsp;and&nbsp;pax&nbsp;is&nbsp;preferred,&nbsp;use&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198656">if</span>&nbsp;<span class="ident" id="4198659">allowPax</span>&nbsp;<span class="op" id="4198668">&amp;&amp;</span>&nbsp;<span class="ident" id="4198671">tw</span><span class="op" id="4198673">.</span><span class="ident" id="4198674">preferPax</span>&nbsp;<span class="op" id="4198684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4198688">tw</span><span class="op" id="4198690">.</span><span class="ident" id="4198691">octal</span><span class="op" id="4198696">(</span><span class="ident" id="4198697">b</span><span class="op" id="4198698">,</span>&nbsp;<span class="num" id="4198700">0</span><span class="op" id="4198701">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4198705">s</span>&nbsp;<span class="op" id="4198707">:=</span>&nbsp;<span class="ident" id="4198710">strconv</span><span class="op" id="4198717">.</span><span class="ident" id="4198718">FormatInt</span><span class="op" id="4198727">(</span><span class="ident" id="4198728">x</span><span class="op" id="4198729">,</span>&nbsp;<span class="num" id="4198731">10</span><span class="op" id="4198733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4198737">paxHeaders</span><span class="op" id="4198747">[</span><span class="ident" id="4198748">paxKeyword</span><span class="op" id="4198758">]</span>&nbsp;<span class="op" id="4198760">=</span>&nbsp;<span class="ident" id="4198762">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198766">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4198774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4198778">//&nbsp;Too&nbsp;big:&nbsp;use&nbsp;binary&nbsp;(big-endian).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4198816">tw</span><span class="op" id="4198818">.</span><span class="ident" id="4198819">usedBinary</span>&nbsp;<span class="op" id="4198830">=</span>&nbsp;<span class="builtintype" id="4198832">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4198838">for</span>&nbsp;<span class="ident" id="4198842">i</span>&nbsp;<span class="op" id="4198844">:=</span>&nbsp;<span class="builtinfunc" id="4198847">len</span><span class="op" id="4198850">(</span><span class="ident" id="4198851">b</span><span class="op" id="4198852">)</span>&nbsp;<span class="op" id="4198854">-</span>&nbsp;<span class="num" id="4198856">1</span><span class="op" id="4198857">;</span>&nbsp;<span class="ident" id="4198859">x</span>&nbsp;<span class="op" id="4198861">&gt;</span>&nbsp;<span class="num" id="4198863">0</span>&nbsp;<span class="op" id="4198865">&amp;&amp;</span>&nbsp;<span class="ident" id="4198868">i</span>&nbsp;<span class="op" id="4198870">&gt;=</span>&nbsp;<span class="num" id="4198873">0</span><span class="op" id="4198874">;</span>&nbsp;<span class="ident" id="4198876">i</span><span class="op" id="4198877">--</span>&nbsp;<span class="op" id="4198880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4198884">b</span><span class="op" id="4198885">[</span><span class="ident" id="4198886">i</span><span class="op" id="4198887">]</span>&nbsp;<span class="op" id="4198889">=</span>&nbsp;<span class="builtintype" id="4198891">byte</span><span class="op" id="4198895">(</span><span class="ident" id="4198896">x</span><span class="op" id="4198897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4198901">x</span>&nbsp;<span class="op" id="4198903">&gt;&gt;=</span>&nbsp;<span class="num" id="4198907">8</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4198910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4198913">b</span><span class="op" id="4198914">[</span><span class="num" id="4198915">0</span><span class="op" id="4198916">]</span>&nbsp;<span class="op" id="4198918">|=</span>&nbsp;<span class="num" id="4198921">0x80</span>&nbsp;<span class="comment" id="4198926">//&nbsp;highest&nbsp;bit&nbsp;indicates&nbsp;binary&nbsp;format</span><br>
<span class="lineno"></span><span class="op" id="4198965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4198968">var</span>&nbsp;<span class="op" id="4198972">(</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4198975">minTime</span>&nbsp;<span class="op" id="4198983">=</span>&nbsp;<span class="ident" id="4198985">time</span><span class="op" id="4198989">.</span><span class="ident" id="4198990">Unix</span><span class="op" id="4198994">(</span><span class="num" id="4198995">0</span><span class="op" id="4198996">,</span>&nbsp;<span class="num" id="4198998">0</span><span class="op" id="4198999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4199002">//&nbsp;There&nbsp;is&nbsp;room&nbsp;for&nbsp;11&nbsp;octal&nbsp;digits&nbsp;(33&nbsp;bits)&nbsp;of&nbsp;mtime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4199060">maxTime</span>&nbsp;<span class="op" id="4199068">=</span>&nbsp;<span class="ident" id="4199070">minTime</span><span class="op" id="4199077">.</span><span class="ident" id="4199078">Add</span><span class="op" id="4199081">(</span><span class="op" id="4199082">(</span><span class="num" id="4199083">1</span><span class="op" id="4199084">&lt;&lt;</span><span class="num" id="4199086">33</span>&nbsp;<span class="op" id="4199089">-</span>&nbsp;<span class="num" id="4199091">1</span><span class="op" id="4199092">)</span>&nbsp;<span class="op" id="4199094">*</span>&nbsp;<span class="ident" id="4199096">time</span><span class="op" id="4199100">.</span><span class="ident" id="4199101">Second</span><span class="op" id="4199107">)</span><br>
<span class="lineno"></span><span class="op" id="4199109">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="comment" id="4199112">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="4199182">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="4199240">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno"></span><span class="keyword" id="4199297">func</span>&nbsp;<span class="op" id="4199302">(</span><span class="ident" id="4199303">tw</span>&nbsp;<span class="op" id="4199306">*</span><span class="ident" id="4199307">Writer</span><span class="op" id="4199313">)</span>&nbsp;<span class="ident" id="4199315">WriteHeader</span><span class="op" id="4199326">(</span><span class="ident" id="4199327">hdr</span>&nbsp;<span class="op" id="4199331">*</span><span class="ident" id="4199332">Header</span><span class="op" id="4199338">)</span>&nbsp;<span class="builtintype" id="4199340">error</span>&nbsp;<span class="op" id="4199346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4199349">return</span>&nbsp;<span class="ident" id="4199356">tw</span><span class="op" id="4199358">.</span><span class="ident" id="4199359">writeHeader</span><span class="op" id="4199370">(</span><span class="ident" id="4199371">hdr</span><span class="op" id="4199374">,</span>&nbsp;<span class="builtintype" id="4199376">true</span><span class="op" id="4199380">)</span><br>
<span class="lineno">140</span><span class="op" id="4199382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4199385">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="4199455">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="4199513">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno">145</span><span class="comment" id="4199570">//&nbsp;As&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;internally&nbsp;by&nbsp;writePax&nbsp;header&nbsp;to&nbsp;allow&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4199643">//&nbsp;suppress&nbsp;writing&nbsp;the&nbsp;pax&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="4199679">func</span>&nbsp;<span class="op" id="4199684">(</span><span class="ident" id="4199685">tw</span>&nbsp;<span class="op" id="4199688">*</span><span class="ident" id="4199689">Writer</span><span class="op" id="4199695">)</span>&nbsp;<span class="ident" id="4199697">writeHeader</span><span class="op" id="4199708">(</span><span class="ident" id="4199709">hdr</span>&nbsp;<span class="op" id="4199713">*</span><span class="ident" id="4199714">Header</span><span class="op" id="4199720">,</span>&nbsp;<span class="ident" id="4199722">allowPax</span>&nbsp;<span class="builtintype" id="4199731">bool</span><span class="op" id="4199735">)</span>&nbsp;<span class="builtintype" id="4199737">error</span>&nbsp;<span class="op" id="4199743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4199746">if</span>&nbsp;<span class="ident" id="4199749">tw</span><span class="op" id="4199751">.</span><span class="ident" id="4199752">closed</span>&nbsp;<span class="op" id="4199759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4199763">return</span>&nbsp;<span class="ident" id="4199770">ErrWriteAfterClose</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4199790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4199793">if</span>&nbsp;<span class="ident" id="4199796">tw</span><span class="op" id="4199798">.</span><span class="ident" id="4199799">err</span>&nbsp;<span class="op" id="4199803">==</span>&nbsp;<span class="ident" id="4199806">nil</span>&nbsp;<span class="op" id="4199810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4199814">tw</span><span class="op" id="4199816">.</span><span class="ident" id="4199817">Flush</span><span class="op" id="4199822">(</span><span class="op" id="4199823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4199826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4199829">if</span>&nbsp;<span class="ident" id="4199832">tw</span><span class="op" id="4199834">.</span><span class="ident" id="4199835">err</span>&nbsp;<span class="op" id="4199839">!=</span>&nbsp;<span class="ident" id="4199842">nil</span>&nbsp;<span class="op" id="4199846">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4199850">return</span>&nbsp;<span class="ident" id="4199857">tw</span><span class="op" id="4199859">.</span><span class="ident" id="4199860">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4199865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4199869">//&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;pax&nbsp;header&nbsp;records,&nbsp;if&nbsp;any&nbsp;are&nbsp;needed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4199925">paxHeaders</span>&nbsp;<span class="op" id="4199936">:=</span>&nbsp;<span class="builtinfunc" id="4199939">make</span><span class="op" id="4199943">(</span><span class="keyword" id="4199944">map</span><span class="op" id="4199947">[</span><span class="builtintype" id="4199948">string</span><span class="op" id="4199954">]</span><span class="builtintype" id="4199955">string</span><span class="op" id="4199961">)</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4199965">//&nbsp;TODO(shanemhansen):&nbsp;we&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;PAX&nbsp;headers&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4200026">//&nbsp;subsecond&nbsp;time&nbsp;resolution,&nbsp;but&nbsp;for&nbsp;now&nbsp;let&#39;s&nbsp;just&nbsp;capture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4200088">//&nbsp;too&nbsp;long&nbsp;fields&nbsp;or&nbsp;non&nbsp;ascii&nbsp;characters</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4200133">var</span>&nbsp;<span class="ident" id="4200137">header</span>&nbsp;<span class="op" id="4200144">[</span><span class="op" id="4200145">]</span><span class="builtintype" id="4200146">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4200153">//&nbsp;We&nbsp;need&nbsp;to&nbsp;select&nbsp;which&nbsp;scratch&nbsp;buffer&nbsp;to&nbsp;use&nbsp;carefully,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4200214">//&nbsp;since&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;recursively&nbsp;to&nbsp;write&nbsp;PAX&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4200280">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;true,&nbsp;this&nbsp;is&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;and&nbsp;we&nbsp;will&nbsp;use&nbsp;hdrBuff.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4200362">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;false,&nbsp;we&nbsp;are&nbsp;being&nbsp;called&nbsp;by&nbsp;writePAXHeader,&nbsp;and&nbsp;hdrBuff&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4200442">//&nbsp;already&nbsp;being&nbsp;used&nbsp;by&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;so&nbsp;we&nbsp;must&nbsp;use&nbsp;paxHdrBuff.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4200519">header</span>&nbsp;<span class="op" id="4200526">=</span>&nbsp;<span class="ident" id="4200528">tw</span><span class="op" id="4200530">.</span><span class="ident" id="4200531">hdrBuff</span><span class="op" id="4200538">[</span><span class="op" id="4200539">:</span><span class="op" id="4200540">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4200543">if</span>&nbsp;<span class="op" id="4200546">!</span><span class="ident" id="4200547">allowPax</span>&nbsp;<span class="op" id="4200556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4200560">header</span>&nbsp;<span class="op" id="4200567">=</span>&nbsp;<span class="ident" id="4200569">tw</span><span class="op" id="4200571">.</span><span class="ident" id="4200572">paxHdrBuff</span><span class="op" id="4200582">[</span><span class="op" id="4200583">:</span><span class="op" id="4200584">]</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4200587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4200590">copy</span><span class="op" id="4200594">(</span><span class="ident" id="4200595">header</span><span class="op" id="4200601">,</span>&nbsp;<span class="ident" id="4200603">zeroBlock</span><span class="op" id="4200612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4200615">s</span>&nbsp;<span class="op" id="4200617">:=</span>&nbsp;<span class="ident" id="4200620">slicer</span><span class="op" id="4200626">(</span><span class="ident" id="4200627">header</span><span class="op" id="4200633">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4200637">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;filename&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4200765">pathHeaderBytes</span>&nbsp;<span class="op" id="4200781">:=</span>&nbsp;<span class="ident" id="4200784">s</span><span class="op" id="4200785">.</span><span class="ident" id="4200786">next</span><span class="op" id="4200790">(</span><span class="ident" id="4200791">fileNameSize</span><span class="op" id="4200803">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4200807">tw</span><span class="op" id="4200809">.</span><span class="ident" id="4200810">cString</span><span class="op" id="4200817">(</span><span class="ident" id="4200818">pathHeaderBytes</span><span class="op" id="4200833">,</span>&nbsp;<span class="ident" id="4200835">hdr</span><span class="op" id="4200838">.</span><span class="ident" id="4200839">Name</span><span class="op" id="4200843">,</span>&nbsp;<span class="builtintype" id="4200845">true</span><span class="op" id="4200849">,</span>&nbsp;<span class="ident" id="4200851">paxPath</span><span class="op" id="4200858">,</span>&nbsp;<span class="ident" id="4200860">paxHeaders</span><span class="op" id="4200870">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4200874">//&nbsp;Handle&nbsp;out&nbsp;of&nbsp;range&nbsp;ModTime&nbsp;carefully.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4200917">var</span>&nbsp;<span class="ident" id="4200921">modTime</span>&nbsp;<span class="ident" id="4200929">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4200936">if</span>&nbsp;<span class="op" id="4200939">!</span><span class="ident" id="4200940">hdr</span><span class="op" id="4200943">.</span><span class="ident" id="4200944">ModTime</span><span class="op" id="4200951">.</span><span class="ident" id="4200952">Before</span><span class="op" id="4200958">(</span><span class="ident" id="4200959">minTime</span><span class="op" id="4200966">)</span>&nbsp;<span class="op" id="4200968">&amp;&amp;</span>&nbsp;<span class="op" id="4200971">!</span><span class="ident" id="4200972">hdr</span><span class="op" id="4200975">.</span><span class="ident" id="4200976">ModTime</span><span class="op" id="4200983">.</span><span class="ident" id="4200984">After</span><span class="op" id="4200989">(</span><span class="ident" id="4200990">maxTime</span><span class="op" id="4200997">)</span>&nbsp;<span class="op" id="4200999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4201003">modTime</span>&nbsp;<span class="op" id="4201011">=</span>&nbsp;<span class="ident" id="4201013">hdr</span><span class="op" id="4201016">.</span><span class="ident" id="4201017">ModTime</span><span class="op" id="4201024">.</span><span class="ident" id="4201025">Unix</span><span class="op" id="4201029">(</span><span class="op" id="4201030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4201033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4201037">tw</span><span class="op" id="4201039">.</span><span class="ident" id="4201040">octal</span><span class="op" id="4201045">(</span><span class="ident" id="4201046">s</span><span class="op" id="4201047">.</span><span class="ident" id="4201048">next</span><span class="op" id="4201052">(</span><span class="num" id="4201053">8</span><span class="op" id="4201054">)</span><span class="op" id="4201055">,</span>&nbsp;<span class="ident" id="4201057">hdr</span><span class="op" id="4201060">.</span><span class="ident" id="4201061">Mode</span><span class="op" id="4201065">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4201101">//&nbsp;100:108</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4201113">tw</span><span class="op" id="4201115">.</span><span class="ident" id="4201116">numeric</span><span class="op" id="4201123">(</span><span class="ident" id="4201124">s</span><span class="op" id="4201125">.</span><span class="ident" id="4201126">next</span><span class="op" id="4201130">(</span><span class="num" id="4201131">8</span><span class="op" id="4201132">)</span><span class="op" id="4201133">,</span>&nbsp;<span class="ident" id="4201135">int64</span><span class="op" id="4201140">(</span><span class="ident" id="4201141">hdr</span><span class="op" id="4201144">.</span><span class="ident" id="4201145">Uid</span><span class="op" id="4201148">)</span><span class="op" id="4201149">,</span>&nbsp;<span class="builtintype" id="4201151">true</span><span class="op" id="4201155">,</span>&nbsp;<span class="ident" id="4201157">paxUid</span><span class="op" id="4201163">,</span>&nbsp;<span class="ident" id="4201165">paxHeaders</span><span class="op" id="4201175">)</span>&nbsp;<span class="comment" id="4201177">//&nbsp;108:116</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4201189">tw</span><span class="op" id="4201191">.</span><span class="ident" id="4201192">numeric</span><span class="op" id="4201199">(</span><span class="ident" id="4201200">s</span><span class="op" id="4201201">.</span><span class="ident" id="4201202">next</span><span class="op" id="4201206">(</span><span class="num" id="4201207">8</span><span class="op" id="4201208">)</span><span class="op" id="4201209">,</span>&nbsp;<span class="ident" id="4201211">int64</span><span class="op" id="4201216">(</span><span class="ident" id="4201217">hdr</span><span class="op" id="4201220">.</span><span class="ident" id="4201221">Gid</span><span class="op" id="4201224">)</span><span class="op" id="4201225">,</span>&nbsp;<span class="builtintype" id="4201227">true</span><span class="op" id="4201231">,</span>&nbsp;<span class="ident" id="4201233">paxGid</span><span class="op" id="4201239">,</span>&nbsp;<span class="ident" id="4201241">paxHeaders</span><span class="op" id="4201251">)</span>&nbsp;<span class="comment" id="4201253">//&nbsp;116:124</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4201265">tw</span><span class="op" id="4201267">.</span><span class="ident" id="4201268">numeric</span><span class="op" id="4201275">(</span><span class="ident" id="4201276">s</span><span class="op" id="4201277">.</span><span class="ident" id="4201278">next</span><span class="op" id="4201282">(</span><span class="num" id="4201283">12</span><span class="op" id="4201285">)</span><span class="op" id="4201286">,</span>&nbsp;<span class="ident" id="4201288">hdr</span><span class="op" id="4201291">.</span><span class="ident" id="4201292">Size</span><span class="op" id="4201296">,</span>&nbsp;<span class="builtintype" id="4201298">true</span><span class="op" id="4201302">,</span>&nbsp;<span class="ident" id="4201304">paxSize</span><span class="op" id="4201311">,</span>&nbsp;<span class="ident" id="4201313">paxHeaders</span><span class="op" id="4201323">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4201329">//&nbsp;124:136</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4201341">tw</span><span class="op" id="4201343">.</span><span class="ident" id="4201344">numeric</span><span class="op" id="4201351">(</span><span class="ident" id="4201352">s</span><span class="op" id="4201353">.</span><span class="ident" id="4201354">next</span><span class="op" id="4201358">(</span><span class="num" id="4201359">12</span><span class="op" id="4201361">)</span><span class="op" id="4201362">,</span>&nbsp;<span class="ident" id="4201364">modTime</span><span class="op" id="4201371">,</span>&nbsp;<span class="builtintype" id="4201373">false</span><span class="op" id="4201378">,</span>&nbsp;<span class="ident" id="4201380">paxNone</span><span class="op" id="4201387">,</span>&nbsp;<span class="ident" id="4201389">nil</span><span class="op" id="4201392">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4201405">//&nbsp;136:148&nbsp;---&nbsp;consider&nbsp;using&nbsp;pax&nbsp;for&nbsp;finer&nbsp;granularity</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4201462">s</span><span class="op" id="4201463">.</span><span class="ident" id="4201464">next</span><span class="op" id="4201468">(</span><span class="num" id="4201469">8</span><span class="op" id="4201470">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4201526">//&nbsp;chksum&nbsp;(148:156)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4201547">s</span><span class="op" id="4201548">.</span><span class="ident" id="4201549">next</span><span class="op" id="4201553">(</span><span class="num" id="4201554">1</span><span class="op" id="4201555">)</span><span class="op" id="4201556">[</span><span class="num" id="4201557">0</span><span class="op" id="4201558">]</span>&nbsp;<span class="op" id="4201560">=</span>&nbsp;<span class="ident" id="4201562">hdr</span><span class="op" id="4201565">.</span><span class="ident" id="4201566">Typeflag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4201611">//&nbsp;156:157</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4201624">tw</span><span class="op" id="4201626">.</span><span class="ident" id="4201627">cString</span><span class="op" id="4201634">(</span><span class="ident" id="4201635">s</span><span class="op" id="4201636">.</span><span class="ident" id="4201637">next</span><span class="op" id="4201641">(</span><span class="num" id="4201642">100</span><span class="op" id="4201645">)</span><span class="op" id="4201646">,</span>&nbsp;<span class="ident" id="4201648">hdr</span><span class="op" id="4201651">.</span><span class="ident" id="4201652">Linkname</span><span class="op" id="4201660">,</span>&nbsp;<span class="builtintype" id="4201662">true</span><span class="op" id="4201666">,</span>&nbsp;<span class="ident" id="4201668">paxLinkpath</span><span class="op" id="4201679">,</span>&nbsp;<span class="ident" id="4201681">paxHeaders</span><span class="op" id="4201691">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4201695">copy</span><span class="op" id="4201699">(</span><span class="ident" id="4201700">s</span><span class="op" id="4201701">.</span><span class="ident" id="4201702">next</span><span class="op" id="4201706">(</span><span class="num" id="4201707">8</span><span class="op" id="4201708">)</span><span class="op" id="4201709">,</span>&nbsp;<span class="op" id="4201711">[</span><span class="op" id="4201712">]</span><span class="builtintype" id="4201713">byte</span><span class="op" id="4201717">(</span><span class="string" id="4201718">&#34;ustar\x0000&#34;</span><span class="op" id="4201731">)</span><span class="op" id="4201732">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4201757">//&nbsp;257:265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4201769">tw</span><span class="op" id="4201771">.</span><span class="ident" id="4201772">cString</span><span class="op" id="4201779">(</span><span class="ident" id="4201780">s</span><span class="op" id="4201781">.</span><span class="ident" id="4201782">next</span><span class="op" id="4201786">(</span><span class="num" id="4201787">32</span><span class="op" id="4201789">)</span><span class="op" id="4201790">,</span>&nbsp;<span class="ident" id="4201792">hdr</span><span class="op" id="4201795">.</span><span class="ident" id="4201796">Uname</span><span class="op" id="4201801">,</span>&nbsp;<span class="builtintype" id="4201803">true</span><span class="op" id="4201807">,</span>&nbsp;<span class="ident" id="4201809">paxUname</span><span class="op" id="4201817">,</span>&nbsp;<span class="ident" id="4201819">paxHeaders</span><span class="op" id="4201829">)</span>&nbsp;<span class="comment" id="4201831">//&nbsp;265:297</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4201843">tw</span><span class="op" id="4201845">.</span><span class="ident" id="4201846">cString</span><span class="op" id="4201853">(</span><span class="ident" id="4201854">s</span><span class="op" id="4201855">.</span><span class="ident" id="4201856">next</span><span class="op" id="4201860">(</span><span class="num" id="4201861">32</span><span class="op" id="4201863">)</span><span class="op" id="4201864">,</span>&nbsp;<span class="ident" id="4201866">hdr</span><span class="op" id="4201869">.</span><span class="ident" id="4201870">Gname</span><span class="op" id="4201875">,</span>&nbsp;<span class="builtintype" id="4201877">true</span><span class="op" id="4201881">,</span>&nbsp;<span class="ident" id="4201883">paxGname</span><span class="op" id="4201891">,</span>&nbsp;<span class="ident" id="4201893">paxHeaders</span><span class="op" id="4201903">)</span>&nbsp;<span class="comment" id="4201905">//&nbsp;297:329</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4201917">tw</span><span class="op" id="4201919">.</span><span class="ident" id="4201920">numeric</span><span class="op" id="4201927">(</span><span class="ident" id="4201928">s</span><span class="op" id="4201929">.</span><span class="ident" id="4201930">next</span><span class="op" id="4201934">(</span><span class="num" id="4201935">8</span><span class="op" id="4201936">)</span><span class="op" id="4201937">,</span>&nbsp;<span class="ident" id="4201939">hdr</span><span class="op" id="4201942">.</span><span class="ident" id="4201943">Devmajor</span><span class="op" id="4201951">,</span>&nbsp;<span class="builtintype" id="4201953">false</span><span class="op" id="4201958">,</span>&nbsp;<span class="ident" id="4201960">paxNone</span><span class="op" id="4201967">,</span>&nbsp;<span class="ident" id="4201969">nil</span><span class="op" id="4201972">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4201979">//&nbsp;329:337</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4201991">tw</span><span class="op" id="4201993">.</span><span class="ident" id="4201994">numeric</span><span class="op" id="4202001">(</span><span class="ident" id="4202002">s</span><span class="op" id="4202003">.</span><span class="ident" id="4202004">next</span><span class="op" id="4202008">(</span><span class="num" id="4202009">8</span><span class="op" id="4202010">)</span><span class="op" id="4202011">,</span>&nbsp;<span class="ident" id="4202013">hdr</span><span class="op" id="4202016">.</span><span class="ident" id="4202017">Devminor</span><span class="op" id="4202025">,</span>&nbsp;<span class="builtintype" id="4202027">false</span><span class="op" id="4202032">,</span>&nbsp;<span class="ident" id="4202034">paxNone</span><span class="op" id="4202041">,</span>&nbsp;<span class="ident" id="4202043">nil</span><span class="op" id="4202046">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4202053">//&nbsp;337:345</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4202066">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;prefix&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4202192">prefixHeaderBytes</span>&nbsp;<span class="op" id="4202210">:=</span>&nbsp;<span class="ident" id="4202213">s</span><span class="op" id="4202214">.</span><span class="ident" id="4202215">next</span><span class="op" id="4202219">(</span><span class="num" id="4202220">155</span><span class="op" id="4202223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4202226">tw</span><span class="op" id="4202228">.</span><span class="ident" id="4202229">cString</span><span class="op" id="4202236">(</span><span class="ident" id="4202237">prefixHeaderBytes</span><span class="op" id="4202254">,</span>&nbsp;<span class="string" id="4202256">&#34;&#34;</span><span class="op" id="4202258">,</span>&nbsp;<span class="builtintype" id="4202260">false</span><span class="op" id="4202265">,</span>&nbsp;<span class="ident" id="4202267">paxNone</span><span class="op" id="4202274">,</span>&nbsp;<span class="ident" id="4202276">nil</span><span class="op" id="4202279">)</span>&nbsp;<span class="comment" id="4202281">//&nbsp;345:500&nbsp;&nbsp;prefix</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4202302">//&nbsp;Use&nbsp;the&nbsp;GNU&nbsp;magic&nbsp;instead&nbsp;of&nbsp;POSIX&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;any&nbsp;GNU&nbsp;extensions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4202378">if</span>&nbsp;<span class="ident" id="4202381">tw</span><span class="op" id="4202383">.</span><span class="ident" id="4202384">usedBinary</span>&nbsp;<span class="op" id="4202395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4202399">copy</span><span class="op" id="4202403">(</span><span class="ident" id="4202404">header</span><span class="op" id="4202410">[</span><span class="num" id="4202411">257</span><span class="op" id="4202414">:</span><span class="num" id="4202415">265</span><span class="op" id="4202418">]</span><span class="op" id="4202419">,</span>&nbsp;<span class="op" id="4202421">[</span><span class="op" id="4202422">]</span><span class="builtintype" id="4202423">byte</span><span class="op" id="4202427">(</span><span class="string" id="4202428">&#34;ustar&nbsp;&nbsp;\x00&#34;</span><span class="op" id="4202441">)</span><span class="op" id="4202442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4202445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4202449">_</span><span class="op" id="4202450">,</span>&nbsp;<span class="ident" id="4202452">paxPathUsed</span>&nbsp;<span class="op" id="4202464">:=</span>&nbsp;<span class="ident" id="4202467">paxHeaders</span><span class="op" id="4202477">[</span><span class="ident" id="4202478">paxPath</span><span class="op" id="4202485">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4202488">//&nbsp;try&nbsp;to&nbsp;use&nbsp;a&nbsp;ustar&nbsp;header&nbsp;when&nbsp;only&nbsp;the&nbsp;name&nbsp;is&nbsp;too&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4202549">if</span>&nbsp;<span class="op" id="4202552">!</span><span class="ident" id="4202553">tw</span><span class="op" id="4202555">.</span><span class="ident" id="4202556">preferPax</span>&nbsp;<span class="op" id="4202566">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4202569">len</span><span class="op" id="4202572">(</span><span class="ident" id="4202573">paxHeaders</span><span class="op" id="4202583">)</span>&nbsp;<span class="op" id="4202585">==</span>&nbsp;<span class="num" id="4202588">1</span>&nbsp;<span class="op" id="4202590">&amp;&amp;</span>&nbsp;<span class="ident" id="4202593">paxPathUsed</span>&nbsp;<span class="op" id="4202605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4202609">suffix</span>&nbsp;<span class="op" id="4202616">:=</span>&nbsp;<span class="ident" id="4202619">hdr</span><span class="op" id="4202622">.</span><span class="ident" id="4202623">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4202630">prefix</span>&nbsp;<span class="op" id="4202637">:=</span>&nbsp;<span class="string" id="4202640">&#34;&#34;</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4202645">if</span>&nbsp;<span class="builtinfunc" id="4202648">len</span><span class="op" id="4202651">(</span><span class="ident" id="4202652">hdr</span><span class="op" id="4202655">.</span><span class="ident" id="4202656">Name</span><span class="op" id="4202660">)</span>&nbsp;<span class="op" id="4202662">&gt;</span>&nbsp;<span class="ident" id="4202664">fileNameSize</span>&nbsp;<span class="op" id="4202677">&amp;&amp;</span>&nbsp;<span class="ident" id="4202680">isASCII</span><span class="op" id="4202687">(</span><span class="ident" id="4202688">hdr</span><span class="op" id="4202691">.</span><span class="ident" id="4202692">Name</span><span class="op" id="4202696">)</span>&nbsp;<span class="op" id="4202698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4202703">var</span>&nbsp;<span class="ident" id="4202707">err</span>&nbsp;<span class="builtintype" id="4202711">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4202720">prefix</span><span class="op" id="4202726">,</span>&nbsp;<span class="ident" id="4202728">suffix</span><span class="op" id="4202734">,</span>&nbsp;<span class="ident" id="4202736">err</span>&nbsp;<span class="op" id="4202740">=</span>&nbsp;<span class="ident" id="4202742">tw</span><span class="op" id="4202744">.</span><span class="ident" id="4202745">splitUSTARLongName</span><span class="op" id="4202763">(</span><span class="ident" id="4202764">hdr</span><span class="op" id="4202767">.</span><span class="ident" id="4202768">Name</span><span class="op" id="4202772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4202777">if</span>&nbsp;<span class="ident" id="4202780">err</span>&nbsp;<span class="op" id="4202784">==</span>&nbsp;<span class="ident" id="4202787">nil</span>&nbsp;<span class="op" id="4202791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4202797">//&nbsp;ok&nbsp;we&nbsp;can&nbsp;use&nbsp;a&nbsp;ustar&nbsp;long&nbsp;name&nbsp;instead&nbsp;of&nbsp;pax,&nbsp;now&nbsp;correct&nbsp;the&nbsp;fields</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4202876">//&nbsp;remove&nbsp;the&nbsp;path&nbsp;field&nbsp;from&nbsp;the&nbsp;pax&nbsp;header.&nbsp;this&nbsp;will&nbsp;suppress&nbsp;the&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4202960">delete</span><span class="op" id="4202966">(</span><span class="ident" id="4202967">paxHeaders</span><span class="op" id="4202977">,</span>&nbsp;<span class="ident" id="4202979">paxPath</span><span class="op" id="4202986">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4202993">//&nbsp;update&nbsp;the&nbsp;path&nbsp;fields</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4203023">tw</span><span class="op" id="4203025">.</span><span class="ident" id="4203026">cString</span><span class="op" id="4203033">(</span><span class="ident" id="4203034">pathHeaderBytes</span><span class="op" id="4203049">,</span>&nbsp;<span class="ident" id="4203051">suffix</span><span class="op" id="4203057">,</span>&nbsp;<span class="builtintype" id="4203059">false</span><span class="op" id="4203064">,</span>&nbsp;<span class="ident" id="4203066">paxNone</span><span class="op" id="4203073">,</span>&nbsp;<span class="ident" id="4203075">nil</span><span class="op" id="4203078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4203084">tw</span><span class="op" id="4203086">.</span><span class="ident" id="4203087">cString</span><span class="op" id="4203094">(</span><span class="ident" id="4203095">prefixHeaderBytes</span><span class="op" id="4203112">,</span>&nbsp;<span class="ident" id="4203114">prefix</span><span class="op" id="4203120">,</span>&nbsp;<span class="builtintype" id="4203122">false</span><span class="op" id="4203127">,</span>&nbsp;<span class="ident" id="4203129">paxNone</span><span class="op" id="4203136">,</span>&nbsp;<span class="ident" id="4203138">nil</span><span class="op" id="4203141">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4203148">//&nbsp;Use&nbsp;the&nbsp;ustar&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;ustar&nbsp;long&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4203204">if</span>&nbsp;<span class="builtinfunc" id="4203207">len</span><span class="op" id="4203210">(</span><span class="ident" id="4203211">prefix</span><span class="op" id="4203217">)</span>&nbsp;<span class="op" id="4203219">&gt;</span>&nbsp;<span class="num" id="4203221">0</span>&nbsp;<span class="op" id="4203223">&amp;&amp;</span>&nbsp;<span class="op" id="4203226">!</span><span class="ident" id="4203227">tw</span><span class="op" id="4203229">.</span><span class="ident" id="4203230">usedBinary</span>&nbsp;<span class="op" id="4203241">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4203248">copy</span><span class="op" id="4203252">(</span><span class="ident" id="4203253">header</span><span class="op" id="4203259">[</span><span class="num" id="4203260">257</span><span class="op" id="4203263">:</span><span class="num" id="4203264">265</span><span class="op" id="4203267">]</span><span class="op" id="4203268">,</span>&nbsp;<span class="op" id="4203270">[</span><span class="op" id="4203271">]</span><span class="builtintype" id="4203272">byte</span><span class="op" id="4203276">(</span><span class="string" id="4203277">&#34;ustar\x00&#34;</span><span class="op" id="4203288">)</span><span class="op" id="4203289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4203295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4203300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4203304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4203307">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4203311">//&nbsp;The&nbsp;chksum&nbsp;field&nbsp;is&nbsp;terminated&nbsp;by&nbsp;a&nbsp;NUL&nbsp;and&nbsp;a&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4203368">//&nbsp;This&nbsp;is&nbsp;different&nbsp;from&nbsp;the&nbsp;other&nbsp;octal&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4203419">chksum</span><span class="op" id="4203425">,</span>&nbsp;<span class="ident" id="4203427">_</span>&nbsp;<span class="op" id="4203429">:=</span>&nbsp;<span class="ident" id="4203432">checksum</span><span class="op" id="4203440">(</span><span class="ident" id="4203441">header</span><span class="op" id="4203447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4203450">tw</span><span class="op" id="4203452">.</span><span class="ident" id="4203453">octal</span><span class="op" id="4203458">(</span><span class="ident" id="4203459">header</span><span class="op" id="4203465">[</span><span class="num" id="4203466">148</span><span class="op" id="4203469">:</span><span class="num" id="4203470">155</span><span class="op" id="4203473">]</span><span class="op" id="4203474">,</span>&nbsp;<span class="ident" id="4203476">chksum</span><span class="op" id="4203482">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4203485">header</span><span class="op" id="4203491">[</span><span class="num" id="4203492">155</span><span class="op" id="4203495">]</span>&nbsp;<span class="op" id="4203497">=</span>&nbsp;<span class="string" id="4203499">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4203505">if</span>&nbsp;<span class="ident" id="4203508">tw</span><span class="op" id="4203510">.</span><span class="ident" id="4203511">err</span>&nbsp;<span class="op" id="4203515">!=</span>&nbsp;<span class="ident" id="4203518">nil</span>&nbsp;<span class="op" id="4203522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4203526">//&nbsp;problem&nbsp;with&nbsp;header;&nbsp;probably&nbsp;integer&nbsp;too&nbsp;big&nbsp;for&nbsp;a&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4203590">return</span>&nbsp;<span class="ident" id="4203597">tw</span><span class="op" id="4203599">.</span><span class="ident" id="4203600">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4203605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4203609">if</span>&nbsp;<span class="ident" id="4203612">allowPax</span>&nbsp;<span class="op" id="4203621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4203625">for</span>&nbsp;<span class="ident" id="4203629">k</span><span class="op" id="4203630">,</span>&nbsp;<span class="ident" id="4203632">v</span>&nbsp;<span class="op" id="4203634">:=</span>&nbsp;<span class="keyword" id="4203637">range</span>&nbsp;<span class="ident" id="4203643">hdr</span><span class="op" id="4203646">.</span><span class="ident" id="4203647">Xattrs</span>&nbsp;<span class="op" id="4203654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4203659">paxHeaders</span><span class="op" id="4203669">[</span><span class="ident" id="4203670">paxXattr</span><span class="op" id="4203678">+</span><span class="ident" id="4203679">k</span><span class="op" id="4203680">]</span>&nbsp;<span class="op" id="4203682">=</span>&nbsp;<span class="ident" id="4203684">v</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4203688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4203691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4203695">if</span>&nbsp;<span class="builtinfunc" id="4203698">len</span><span class="op" id="4203701">(</span><span class="ident" id="4203702">paxHeaders</span><span class="op" id="4203712">)</span>&nbsp;<span class="op" id="4203714">&gt;</span>&nbsp;<span class="num" id="4203716">0</span>&nbsp;<span class="op" id="4203718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4203722">if</span>&nbsp;<span class="op" id="4203725">!</span><span class="ident" id="4203726">allowPax</span>&nbsp;<span class="op" id="4203735">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4203740">return</span>&nbsp;<span class="ident" id="4203747">errInvalidHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4203766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4203770">if</span>&nbsp;<span class="ident" id="4203773">err</span>&nbsp;<span class="op" id="4203777">:=</span>&nbsp;<span class="ident" id="4203780">tw</span><span class="op" id="4203782">.</span><span class="ident" id="4203783">writePAXHeader</span><span class="op" id="4203797">(</span><span class="ident" id="4203798">hdr</span><span class="op" id="4203801">,</span>&nbsp;<span class="ident" id="4203803">paxHeaders</span><span class="op" id="4203813">)</span><span class="op" id="4203814">;</span>&nbsp;<span class="ident" id="4203816">err</span>&nbsp;<span class="op" id="4203820">!=</span>&nbsp;<span class="ident" id="4203823">nil</span>&nbsp;<span class="op" id="4203827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4203832">return</span>&nbsp;<span class="ident" id="4203839">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4203845">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4203848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4203851">tw</span><span class="op" id="4203853">.</span><span class="ident" id="4203854">nb</span>&nbsp;<span class="op" id="4203857">=</span>&nbsp;<span class="ident" id="4203859">int64</span><span class="op" id="4203864">(</span><span class="ident" id="4203865">hdr</span><span class="op" id="4203868">.</span><span class="ident" id="4203869">Size</span><span class="op" id="4203873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4203876">tw</span><span class="op" id="4203878">.</span><span class="ident" id="4203879">pad</span>&nbsp;<span class="op" id="4203883">=</span>&nbsp;<span class="op" id="4203885">(</span><span class="ident" id="4203886">blockSize</span>&nbsp;<span class="op" id="4203896">-</span>&nbsp;<span class="op" id="4203898">(</span><span class="ident" id="4203899">tw</span><span class="op" id="4203901">.</span><span class="ident" id="4203902">nb</span>&nbsp;<span class="op" id="4203905">%</span>&nbsp;<span class="ident" id="4203907">blockSize</span><span class="op" id="4203916">)</span><span class="op" id="4203917">)</span>&nbsp;<span class="op" id="4203919">%</span>&nbsp;<span class="ident" id="4203921">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4203933">_</span><span class="op" id="4203934">,</span>&nbsp;<span class="ident" id="4203936">tw</span><span class="op" id="4203938">.</span><span class="ident" id="4203939">err</span>&nbsp;<span class="op" id="4203943">=</span>&nbsp;<span class="ident" id="4203945">tw</span><span class="op" id="4203947">.</span><span class="ident" id="4203948">w</span><span class="op" id="4203949">.</span><span class="ident" id="4203950">Write</span><span class="op" id="4203955">(</span><span class="ident" id="4203956">header</span><span class="op" id="4203962">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4203965">return</span>&nbsp;<span class="ident" id="4203972">tw</span><span class="op" id="4203974">.</span><span class="ident" id="4203975">err</span><br>
<span class="lineno"></span><span class="op" id="4203979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4203982">//&nbsp;writeUSTARLongName&nbsp;splits&nbsp;a&nbsp;USTAR&nbsp;long&nbsp;name&nbsp;hdr.Name.</span><br>
<span class="lineno"></span><span class="comment" id="4204039">//&nbsp;name&nbsp;must&nbsp;be&nbsp;&lt;&nbsp;256&nbsp;characters.&nbsp;errNameTooLong&nbsp;is&nbsp;returned</span><br>
<span class="lineno">275</span><span class="comment" id="4204100">//&nbsp;if&nbsp;hdr.Name&nbsp;can&#39;t&nbsp;be&nbsp;split.&nbsp;The&nbsp;splitting&nbsp;heuristic</span><br>
<span class="lineno"></span><span class="comment" id="4204155">//&nbsp;is&nbsp;compatible&nbsp;with&nbsp;gnu&nbsp;tar.</span><br>
<span class="lineno"></span><span class="keyword" id="4204186">func</span>&nbsp;<span class="op" id="4204191">(</span><span class="ident" id="4204192">tw</span>&nbsp;<span class="op" id="4204195">*</span><span class="ident" id="4204196">Writer</span><span class="op" id="4204202">)</span>&nbsp;<span class="ident" id="4204204">splitUSTARLongName</span><span class="op" id="4204222">(</span><span class="ident" id="4204223">name</span>&nbsp;<span class="builtintype" id="4204228">string</span><span class="op" id="4204234">)</span>&nbsp;<span class="op" id="4204236">(</span><span class="ident" id="4204237">prefix</span><span class="op" id="4204243">,</span>&nbsp;<span class="ident" id="4204245">suffix</span>&nbsp;<span class="builtintype" id="4204252">string</span><span class="op" id="4204258">,</span>&nbsp;<span class="ident" id="4204260">err</span>&nbsp;<span class="builtintype" id="4204264">error</span><span class="op" id="4204269">)</span>&nbsp;<span class="op" id="4204271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204274">length</span>&nbsp;<span class="op" id="4204281">:=</span>&nbsp;<span class="builtinfunc" id="4204284">len</span><span class="op" id="4204287">(</span><span class="ident" id="4204288">name</span><span class="op" id="4204292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4204295">if</span>&nbsp;<span class="ident" id="4204298">length</span>&nbsp;<span class="op" id="4204305">&gt;</span>&nbsp;<span class="ident" id="4204307">fileNamePrefixSize</span><span class="op" id="4204325">+</span><span class="num" id="4204326">1</span>&nbsp;<span class="op" id="4204328">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204332">length</span>&nbsp;<span class="op" id="4204339">=</span>&nbsp;<span class="ident" id="4204341">fileNamePrefixSize</span>&nbsp;<span class="op" id="4204360">+</span>&nbsp;<span class="num" id="4204362">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4204365">}</span>&nbsp;<span class="keyword" id="4204367">else</span>&nbsp;<span class="keyword" id="4204372">if</span>&nbsp;<span class="ident" id="4204375">name</span><span class="op" id="4204379">[</span><span class="ident" id="4204380">length</span><span class="op" id="4204386">-</span><span class="num" id="4204387">1</span><span class="op" id="4204388">]</span>&nbsp;<span class="op" id="4204390">==</span>&nbsp;<span class="string" id="4204393">&#39;/&#39;</span>&nbsp;<span class="op" id="4204397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204401">length</span><span class="op" id="4204407">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4204411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204414">i</span>&nbsp;<span class="op" id="4204416">:=</span>&nbsp;<span class="ident" id="4204419">strings</span><span class="op" id="4204426">.</span><span class="ident" id="4204427">LastIndex</span><span class="op" id="4204436">(</span><span class="ident" id="4204437">name</span><span class="op" id="4204441">[</span><span class="op" id="4204442">:</span><span class="ident" id="4204443">length</span><span class="op" id="4204449">]</span><span class="op" id="4204450">,</span>&nbsp;<span class="string" id="4204452">&#34;/&#34;</span><span class="op" id="4204455">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4204458">//&nbsp;nlen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;name&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4204516">//&nbsp;plen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;prefix&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204576">nlen</span>&nbsp;<span class="op" id="4204581">:=</span>&nbsp;<span class="builtinfunc" id="4204584">len</span><span class="op" id="4204587">(</span><span class="ident" id="4204588">name</span><span class="op" id="4204592">)</span>&nbsp;<span class="op" id="4204594">-</span>&nbsp;<span class="ident" id="4204596">i</span>&nbsp;<span class="op" id="4204598">-</span>&nbsp;<span class="num" id="4204600">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204603">plen</span>&nbsp;<span class="op" id="4204608">:=</span>&nbsp;<span class="ident" id="4204611">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4204614">if</span>&nbsp;<span class="ident" id="4204617">i</span>&nbsp;<span class="op" id="4204619">&lt;=</span>&nbsp;<span class="num" id="4204622">0</span>&nbsp;<span class="op" id="4204624">||</span>&nbsp;<span class="ident" id="4204627">nlen</span>&nbsp;<span class="op" id="4204632">&gt;</span>&nbsp;<span class="ident" id="4204634">fileNameSize</span>&nbsp;<span class="op" id="4204647">||</span>&nbsp;<span class="ident" id="4204650">nlen</span>&nbsp;<span class="op" id="4204655">==</span>&nbsp;<span class="num" id="4204658">0</span>&nbsp;<span class="op" id="4204660">||</span>&nbsp;<span class="ident" id="4204663">plen</span>&nbsp;<span class="op" id="4204668">&gt;</span>&nbsp;<span class="ident" id="4204670">fileNamePrefixSize</span>&nbsp;<span class="op" id="4204689">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204693">err</span>&nbsp;<span class="op" id="4204697">=</span>&nbsp;<span class="ident" id="4204699">errNameTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4204716">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4204724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204727">prefix</span><span class="op" id="4204733">,</span>&nbsp;<span class="ident" id="4204735">suffix</span>&nbsp;<span class="op" id="4204742">=</span>&nbsp;<span class="ident" id="4204744">name</span><span class="op" id="4204748">[</span><span class="op" id="4204749">:</span><span class="ident" id="4204750">i</span><span class="op" id="4204751">]</span><span class="op" id="4204752">,</span>&nbsp;<span class="ident" id="4204754">name</span><span class="op" id="4204758">[</span><span class="ident" id="4204759">i</span><span class="op" id="4204760">+</span><span class="num" id="4204761">1</span><span class="op" id="4204762">:</span><span class="op" id="4204763">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4204766">return</span><br>
<span class="lineno">295</span><span class="op" id="4204773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4204776">//&nbsp;writePaxHeader&nbsp;writes&nbsp;an&nbsp;extended&nbsp;pax&nbsp;header&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4204831">//&nbsp;archive.</span><br>
<span class="lineno"></span><span class="keyword" id="4204843">func</span>&nbsp;<span class="op" id="4204848">(</span><span class="ident" id="4204849">tw</span>&nbsp;<span class="op" id="4204852">*</span><span class="ident" id="4204853">Writer</span><span class="op" id="4204859">)</span>&nbsp;<span class="ident" id="4204861">writePAXHeader</span><span class="op" id="4204875">(</span><span class="ident" id="4204876">hdr</span>&nbsp;<span class="op" id="4204880">*</span><span class="ident" id="4204881">Header</span><span class="op" id="4204887">,</span>&nbsp;<span class="ident" id="4204889">paxHeaders</span>&nbsp;<span class="keyword" id="4204900">map</span><span class="op" id="4204903">[</span><span class="builtintype" id="4204904">string</span><span class="op" id="4204910">]</span><span class="builtintype" id="4204911">string</span><span class="op" id="4204917">)</span>&nbsp;<span class="builtintype" id="4204919">error</span>&nbsp;<span class="op" id="4204925">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4204928">//&nbsp;Prepare&nbsp;extended&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204956">ext</span>&nbsp;<span class="op" id="4204960">:=</span>&nbsp;<span class="builtinfunc" id="4204963">new</span><span class="op" id="4204966">(</span><span class="ident" id="4204967">Header</span><span class="op" id="4204973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4204976">ext</span><span class="op" id="4204979">.</span><span class="ident" id="4204980">Typeflag</span>&nbsp;<span class="op" id="4204989">=</span>&nbsp;<span class="ident" id="4204991">TypeXHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4205004">//&nbsp;Setting&nbsp;ModTime&nbsp;is&nbsp;required&nbsp;for&nbsp;reader&nbsp;parsing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4205058">//&nbsp;succeed,&nbsp;and&nbsp;seems&nbsp;harmless&nbsp;enough.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205098">ext</span><span class="op" id="4205101">.</span><span class="ident" id="4205102">ModTime</span>&nbsp;<span class="op" id="4205110">=</span>&nbsp;<span class="ident" id="4205112">hdr</span><span class="op" id="4205115">.</span><span class="ident" id="4205116">ModTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4205125">//&nbsp;The&nbsp;spec&nbsp;asks&nbsp;that&nbsp;we&nbsp;namespace&nbsp;our&nbsp;pseudo&nbsp;files</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4205178">//&nbsp;with&nbsp;the&nbsp;current&nbsp;pid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205204">pid</span>&nbsp;<span class="op" id="4205208">:=</span>&nbsp;<span class="ident" id="4205211">os</span><span class="op" id="4205213">.</span><span class="ident" id="4205214">Getpid</span><span class="op" id="4205220">(</span><span class="op" id="4205221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205224">dir</span><span class="op" id="4205227">,</span>&nbsp;<span class="ident" id="4205229">file</span>&nbsp;<span class="op" id="4205234">:=</span>&nbsp;<span class="ident" id="4205237">path</span><span class="op" id="4205241">.</span><span class="ident" id="4205242">Split</span><span class="op" id="4205247">(</span><span class="ident" id="4205248">hdr</span><span class="op" id="4205251">.</span><span class="ident" id="4205252">Name</span><span class="op" id="4205256">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205259">fullName</span>&nbsp;<span class="op" id="4205268">:=</span>&nbsp;<span class="ident" id="4205271">path</span><span class="op" id="4205275">.</span><span class="ident" id="4205276">Join</span><span class="op" id="4205280">(</span><span class="ident" id="4205281">dir</span><span class="op" id="4205284">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205288">fmt</span><span class="op" id="4205291">.</span><span class="ident" id="4205292">Sprintf</span><span class="op" id="4205299">(</span><span class="string" id="4205300">&#34;PaxHeaders.%d&#34;</span><span class="op" id="4205315">,</span>&nbsp;<span class="ident" id="4205317">pid</span><span class="op" id="4205320">)</span><span class="op" id="4205321">,</span>&nbsp;<span class="ident" id="4205323">file</span><span class="op" id="4205327">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205331">ascii</span>&nbsp;<span class="op" id="4205337">:=</span>&nbsp;<span class="ident" id="4205340">toASCII</span><span class="op" id="4205347">(</span><span class="ident" id="4205348">fullName</span><span class="op" id="4205356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205359">if</span>&nbsp;<span class="builtinfunc" id="4205362">len</span><span class="op" id="4205365">(</span><span class="ident" id="4205366">ascii</span><span class="op" id="4205371">)</span>&nbsp;<span class="op" id="4205373">&gt;</span>&nbsp;<span class="num" id="4205375">100</span>&nbsp;<span class="op" id="4205379">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205383">ascii</span>&nbsp;<span class="op" id="4205389">=</span>&nbsp;<span class="ident" id="4205391">ascii</span><span class="op" id="4205396">[</span><span class="op" id="4205397">:</span><span class="num" id="4205398">100</span><span class="op" id="4205401">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205407">ext</span><span class="op" id="4205410">.</span><span class="ident" id="4205411">Name</span>&nbsp;<span class="op" id="4205416">=</span>&nbsp;<span class="ident" id="4205418">ascii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4205425">//&nbsp;Construct&nbsp;the&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205448">var</span>&nbsp;<span class="ident" id="4205452">buf</span>&nbsp;<span class="ident" id="4205456">bytes</span><span class="op" id="4205461">.</span><span class="ident" id="4205462">Buffer</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205471">for</span>&nbsp;<span class="ident" id="4205475">k</span><span class="op" id="4205476">,</span>&nbsp;<span class="ident" id="4205478">v</span>&nbsp;<span class="op" id="4205480">:=</span>&nbsp;<span class="keyword" id="4205483">range</span>&nbsp;<span class="ident" id="4205489">paxHeaders</span>&nbsp;<span class="op" id="4205500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205504">fmt</span><span class="op" id="4205507">.</span><span class="ident" id="4205508">Fprint</span><span class="op" id="4205514">(</span><span class="op" id="4205515">&amp;</span><span class="ident" id="4205516">buf</span><span class="op" id="4205519">,</span>&nbsp;<span class="ident" id="4205521">paxHeader</span><span class="op" id="4205530">(</span><span class="ident" id="4205531">k</span><span class="op" id="4205532">+</span><span class="string" id="4205533">&#34;=&#34;</span><span class="op" id="4205536">+</span><span class="ident" id="4205537">v</span><span class="op" id="4205538">)</span><span class="op" id="4205539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205546">ext</span><span class="op" id="4205549">.</span><span class="ident" id="4205550">Size</span>&nbsp;<span class="op" id="4205555">=</span>&nbsp;<span class="ident" id="4205557">int64</span><span class="op" id="4205562">(</span><span class="builtinfunc" id="4205563">len</span><span class="op" id="4205566">(</span><span class="ident" id="4205567">buf</span><span class="op" id="4205570">.</span><span class="ident" id="4205571">Bytes</span><span class="op" id="4205576">(</span><span class="op" id="4205577">)</span><span class="op" id="4205578">)</span><span class="op" id="4205579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205582">if</span>&nbsp;<span class="ident" id="4205585">err</span>&nbsp;<span class="op" id="4205589">:=</span>&nbsp;<span class="ident" id="4205592">tw</span><span class="op" id="4205594">.</span><span class="ident" id="4205595">writeHeader</span><span class="op" id="4205606">(</span><span class="ident" id="4205607">ext</span><span class="op" id="4205610">,</span>&nbsp;<span class="builtintype" id="4205612">false</span><span class="op" id="4205617">)</span><span class="op" id="4205618">;</span>&nbsp;<span class="ident" id="4205620">err</span>&nbsp;<span class="op" id="4205624">!=</span>&nbsp;<span class="ident" id="4205627">nil</span>&nbsp;<span class="op" id="4205631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205635">return</span>&nbsp;<span class="ident" id="4205642">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205650">if</span>&nbsp;<span class="ident" id="4205653">_</span><span class="op" id="4205654">,</span>&nbsp;<span class="ident" id="4205656">err</span>&nbsp;<span class="op" id="4205660">:=</span>&nbsp;<span class="ident" id="4205663">tw</span><span class="op" id="4205665">.</span><span class="ident" id="4205666">Write</span><span class="op" id="4205671">(</span><span class="ident" id="4205672">buf</span><span class="op" id="4205675">.</span><span class="ident" id="4205676">Bytes</span><span class="op" id="4205681">(</span><span class="op" id="4205682">)</span><span class="op" id="4205683">)</span><span class="op" id="4205684">;</span>&nbsp;<span class="ident" id="4205686">err</span>&nbsp;<span class="op" id="4205690">!=</span>&nbsp;<span class="ident" id="4205693">nil</span>&nbsp;<span class="op" id="4205697">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205701">return</span>&nbsp;<span class="ident" id="4205708">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205716">if</span>&nbsp;<span class="ident" id="4205719">err</span>&nbsp;<span class="op" id="4205723">:=</span>&nbsp;<span class="ident" id="4205726">tw</span><span class="op" id="4205728">.</span><span class="ident" id="4205729">Flush</span><span class="op" id="4205734">(</span><span class="op" id="4205735">)</span><span class="op" id="4205736">;</span>&nbsp;<span class="ident" id="4205738">err</span>&nbsp;<span class="op" id="4205742">!=</span>&nbsp;<span class="ident" id="4205745">nil</span>&nbsp;<span class="op" id="4205749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205753">return</span>&nbsp;<span class="ident" id="4205760">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4205765">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205768">return</span>&nbsp;<span class="ident" id="4205775">nil</span><br>
<span class="lineno"></span><span class="op" id="4205779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4205782">//&nbsp;paxHeader&nbsp;formats&nbsp;a&nbsp;single&nbsp;pax&nbsp;record,&nbsp;prefixing&nbsp;it&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="4205865">func</span>&nbsp;<span class="ident" id="4205870">paxHeader</span><span class="op" id="4205879">(</span><span class="ident" id="4205880">msg</span>&nbsp;<span class="builtintype" id="4205884">string</span><span class="op" id="4205890">)</span>&nbsp;<span class="builtintype" id="4205892">string</span>&nbsp;<span class="op" id="4205899">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4205902">const</span>&nbsp;<span class="ident" id="4205908">padding</span>&nbsp;<span class="op" id="4205916">=</span>&nbsp;<span class="num" id="4205918">2</span>&nbsp;<span class="comment" id="4205920">//&nbsp;Extra&nbsp;padding&nbsp;for&nbsp;space&nbsp;and&nbsp;newline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205960">size</span>&nbsp;<span class="op" id="4205965">:=</span>&nbsp;<span class="builtinfunc" id="4205968">len</span><span class="op" id="4205971">(</span><span class="ident" id="4205972">msg</span><span class="op" id="4205975">)</span>&nbsp;<span class="op" id="4205977">+</span>&nbsp;<span class="ident" id="4205979">padding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4205988">size</span>&nbsp;<span class="op" id="4205993">+=</span>&nbsp;<span class="builtinfunc" id="4205996">len</span><span class="op" id="4205999">(</span><span class="ident" id="4206000">strconv</span><span class="op" id="4206007">.</span><span class="ident" id="4206008">Itoa</span><span class="op" id="4206012">(</span><span class="ident" id="4206013">size</span><span class="op" id="4206017">)</span><span class="op" id="4206018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206021">record</span>&nbsp;<span class="op" id="4206028">:=</span>&nbsp;<span class="ident" id="4206031">fmt</span><span class="op" id="4206034">.</span><span class="ident" id="4206035">Sprintf</span><span class="op" id="4206042">(</span><span class="string" id="4206043">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="4206052">,</span>&nbsp;<span class="ident" id="4206054">size</span><span class="op" id="4206058">,</span>&nbsp;<span class="ident" id="4206060">msg</span><span class="op" id="4206063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206066">if</span>&nbsp;<span class="builtinfunc" id="4206069">len</span><span class="op" id="4206072">(</span><span class="ident" id="4206073">record</span><span class="op" id="4206079">)</span>&nbsp;<span class="op" id="4206081">!=</span>&nbsp;<span class="ident" id="4206084">size</span>&nbsp;<span class="op" id="4206089">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4206093">//&nbsp;Final&nbsp;adjustment&nbsp;if&nbsp;adding&nbsp;size&nbsp;increased</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4206140">//&nbsp;the&nbsp;number&nbsp;of&nbsp;digits&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206174">size</span>&nbsp;<span class="op" id="4206179">=</span>&nbsp;<span class="builtinfunc" id="4206181">len</span><span class="op" id="4206184">(</span><span class="ident" id="4206185">record</span><span class="op" id="4206191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206195">record</span>&nbsp;<span class="op" id="4206202">=</span>&nbsp;<span class="ident" id="4206204">fmt</span><span class="op" id="4206207">.</span><span class="ident" id="4206208">Sprintf</span><span class="op" id="4206215">(</span><span class="string" id="4206216">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="4206225">,</span>&nbsp;<span class="ident" id="4206227">size</span><span class="op" id="4206231">,</span>&nbsp;<span class="ident" id="4206233">msg</span><span class="op" id="4206236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4206239">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206242">return</span>&nbsp;<span class="ident" id="4206249">record</span><br>
<span class="lineno"></span><span class="op" id="4206256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4206259">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;current&nbsp;entry&nbsp;in&nbsp;the&nbsp;tar&nbsp;archive.</span><br>
<span class="lineno"></span><span class="comment" id="4206316">//&nbsp;Write&nbsp;returns&nbsp;the&nbsp;error&nbsp;ErrWriteTooLong&nbsp;if&nbsp;more&nbsp;than</span><br>
<span class="lineno">355</span><span class="comment" id="4206372">//&nbsp;hdr.Size&nbsp;bytes&nbsp;are&nbsp;written&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span><span class="keyword" id="4206421">func</span>&nbsp;<span class="op" id="4206426">(</span><span class="ident" id="4206427">tw</span>&nbsp;<span class="op" id="4206430">*</span><span class="ident" id="4206431">Writer</span><span class="op" id="4206437">)</span>&nbsp;<span class="ident" id="4206439">Write</span><span class="op" id="4206444">(</span><span class="ident" id="4206445">b</span>&nbsp;<span class="op" id="4206447">[</span><span class="op" id="4206448">]</span><span class="builtintype" id="4206449">byte</span><span class="op" id="4206453">)</span>&nbsp;<span class="op" id="4206455">(</span><span class="ident" id="4206456">n</span>&nbsp;<span class="builtintype" id="4206458">int</span><span class="op" id="4206461">,</span>&nbsp;<span class="ident" id="4206463">err</span>&nbsp;<span class="builtintype" id="4206467">error</span><span class="op" id="4206472">)</span>&nbsp;<span class="op" id="4206474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206477">if</span>&nbsp;<span class="ident" id="4206480">tw</span><span class="op" id="4206482">.</span><span class="ident" id="4206483">closed</span>&nbsp;<span class="op" id="4206490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206494">err</span>&nbsp;<span class="op" id="4206498">=</span>&nbsp;<span class="ident" id="4206500">ErrWriteTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206518">return</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4206526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206529">overwrite</span>&nbsp;<span class="op" id="4206539">:=</span>&nbsp;<span class="builtintype" id="4206542">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206549">if</span>&nbsp;<span class="ident" id="4206552">int64</span><span class="op" id="4206557">(</span><span class="builtinfunc" id="4206558">len</span><span class="op" id="4206561">(</span><span class="ident" id="4206562">b</span><span class="op" id="4206563">)</span><span class="op" id="4206564">)</span>&nbsp;<span class="op" id="4206566">&gt;</span>&nbsp;<span class="ident" id="4206568">tw</span><span class="op" id="4206570">.</span><span class="ident" id="4206571">nb</span>&nbsp;<span class="op" id="4206574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206578">b</span>&nbsp;<span class="op" id="4206580">=</span>&nbsp;<span class="ident" id="4206582">b</span><span class="op" id="4206583">[</span><span class="num" id="4206584">0</span><span class="op" id="4206585">:</span><span class="ident" id="4206586">tw</span><span class="op" id="4206588">.</span><span class="ident" id="4206589">nb</span><span class="op" id="4206591">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206595">overwrite</span>&nbsp;<span class="op" id="4206605">=</span>&nbsp;<span class="builtintype" id="4206607">true</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4206613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206616">n</span><span class="op" id="4206617">,</span>&nbsp;<span class="ident" id="4206619">err</span>&nbsp;<span class="op" id="4206623">=</span>&nbsp;<span class="ident" id="4206625">tw</span><span class="op" id="4206627">.</span><span class="ident" id="4206628">w</span><span class="op" id="4206629">.</span><span class="ident" id="4206630">Write</span><span class="op" id="4206635">(</span><span class="ident" id="4206636">b</span><span class="op" id="4206637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206640">tw</span><span class="op" id="4206642">.</span><span class="ident" id="4206643">nb</span>&nbsp;<span class="op" id="4206646">-=</span>&nbsp;<span class="ident" id="4206649">int64</span><span class="op" id="4206654">(</span><span class="ident" id="4206655">n</span><span class="op" id="4206656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206659">if</span>&nbsp;<span class="ident" id="4206662">err</span>&nbsp;<span class="op" id="4206666">==</span>&nbsp;<span class="ident" id="4206669">nil</span>&nbsp;<span class="op" id="4206673">&amp;&amp;</span>&nbsp;<span class="ident" id="4206676">overwrite</span>&nbsp;<span class="op" id="4206686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206690">err</span>&nbsp;<span class="op" id="4206694">=</span>&nbsp;<span class="ident" id="4206696">ErrWriteTooLong</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206714">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4206722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206725">tw</span><span class="op" id="4206727">.</span><span class="ident" id="4206728">err</span>&nbsp;<span class="op" id="4206732">=</span>&nbsp;<span class="ident" id="4206734">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206739">return</span><br>
<span class="lineno"></span><span class="op" id="4206746">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="comment" id="4206749">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;tar&nbsp;archive,&nbsp;flushing&nbsp;any&nbsp;unwritten</span><br>
<span class="lineno"></span><span class="comment" id="4206805">//&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4206839">func</span>&nbsp;<span class="op" id="4206844">(</span><span class="ident" id="4206845">tw</span>&nbsp;<span class="op" id="4206848">*</span><span class="ident" id="4206849">Writer</span><span class="op" id="4206855">)</span>&nbsp;<span class="ident" id="4206857">Close</span><span class="op" id="4206862">(</span><span class="op" id="4206863">)</span>&nbsp;<span class="builtintype" id="4206865">error</span>&nbsp;<span class="op" id="4206871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206874">if</span>&nbsp;<span class="ident" id="4206877">tw</span><span class="op" id="4206879">.</span><span class="ident" id="4206880">err</span>&nbsp;<span class="op" id="4206884">!=</span>&nbsp;<span class="ident" id="4206887">nil</span>&nbsp;<span class="op" id="4206891">||</span>&nbsp;<span class="ident" id="4206894">tw</span><span class="op" id="4206896">.</span><span class="ident" id="4206897">closed</span>&nbsp;<span class="op" id="4206904">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206908">return</span>&nbsp;<span class="ident" id="4206915">tw</span><span class="op" id="4206917">.</span><span class="ident" id="4206918">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4206923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206926">tw</span><span class="op" id="4206928">.</span><span class="ident" id="4206929">Flush</span><span class="op" id="4206934">(</span><span class="op" id="4206935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206938">tw</span><span class="op" id="4206940">.</span><span class="ident" id="4206941">closed</span>&nbsp;<span class="op" id="4206948">=</span>&nbsp;<span class="builtintype" id="4206950">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206956">if</span>&nbsp;<span class="ident" id="4206959">tw</span><span class="op" id="4206961">.</span><span class="ident" id="4206962">err</span>&nbsp;<span class="op" id="4206966">!=</span>&nbsp;<span class="ident" id="4206969">nil</span>&nbsp;<span class="op" id="4206973">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4206977">return</span>&nbsp;<span class="ident" id="4206984">tw</span><span class="op" id="4206986">.</span><span class="ident" id="4206987">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4206992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4206996">//&nbsp;trailer:&nbsp;two&nbsp;zero&nbsp;blocks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207025">for</span>&nbsp;<span class="ident" id="4207029">i</span>&nbsp;<span class="op" id="4207031">:=</span>&nbsp;<span class="num" id="4207034">0</span><span class="op" id="4207035">;</span>&nbsp;<span class="ident" id="4207037">i</span>&nbsp;<span class="op" id="4207039">&lt;</span>&nbsp;<span class="num" id="4207041">2</span><span class="op" id="4207042">;</span>&nbsp;<span class="ident" id="4207044">i</span><span class="op" id="4207045">++</span>&nbsp;<span class="op" id="4207048">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207052">_</span><span class="op" id="4207053">,</span>&nbsp;<span class="ident" id="4207055">tw</span><span class="op" id="4207057">.</span><span class="ident" id="4207058">err</span>&nbsp;<span class="op" id="4207062">=</span>&nbsp;<span class="ident" id="4207064">tw</span><span class="op" id="4207066">.</span><span class="ident" id="4207067">w</span><span class="op" id="4207068">.</span><span class="ident" id="4207069">Write</span><span class="op" id="4207074">(</span><span class="ident" id="4207075">zeroBlock</span><span class="op" id="4207084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207088">if</span>&nbsp;<span class="ident" id="4207091">tw</span><span class="op" id="4207093">.</span><span class="ident" id="4207094">err</span>&nbsp;<span class="op" id="4207098">!=</span>&nbsp;<span class="ident" id="4207101">nil</span>&nbsp;<span class="op" id="4207105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207110">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207121">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207124">return</span>&nbsp;<span class="ident" id="4207131">tw</span><span class="op" id="4207133">.</span><span class="ident" id="4207134">err</span><br>
<span class="lineno"></span><span class="op" id="4207138">}</span>
</div>
</body>
</html>
