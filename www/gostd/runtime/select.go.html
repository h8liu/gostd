<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html" class="current">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1632620">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1632675">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1632729">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1632780">package</span>&nbsp;<span class="ident" id="1632788">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1632797">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;select&nbsp;statements.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1632864">import</span>&nbsp;<span class="string" id="1632871">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1632881">const</span>&nbsp;<span class="op" id="1632887">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1632890">debugSelect</span>&nbsp;<span class="op" id="1632902">=</span>&nbsp;<span class="builtintype" id="1632904">false</span><br>
<span class="lineno"></span><span class="op" id="1632910">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1632913">var</span>&nbsp;<span class="op" id="1632917">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1632920">chansendpc</span>&nbsp;<span class="op" id="1632931">=</span>&nbsp;<span class="ident" id="1632933">funcPC</span><span class="op" id="1632939">(</span><span class="ident" id="1632940">chansend</span><span class="op" id="1632948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1632951">chanrecvpc</span>&nbsp;<span class="op" id="1632962">=</span>&nbsp;<span class="ident" id="1632964">funcPC</span><span class="op" id="1632970">(</span><span class="ident" id="1632971">chanrecv</span><span class="op" id="1632979">)</span><br>
<span class="lineno"></span><span class="op" id="1632981">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1632984">func</span>&nbsp;<span class="ident" id="1632989">selectsize</span><span class="op" id="1632999">(</span><span class="ident" id="1633000">size</span>&nbsp;<span class="builtintype" id="1633005">uintptr</span><span class="op" id="1633012">)</span>&nbsp;<span class="builtintype" id="1633014">uintptr</span>&nbsp;<span class="op" id="1633022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1633025">selsize</span>&nbsp;<span class="op" id="1633033">:=</span>&nbsp;<span class="ident" id="1633036">unsafe</span><span class="op" id="1633042">.</span><span class="ident" id="1633043">Sizeof</span><span class="op" id="1633049">(</span><span class="ident" id="1633050">_select</span><span class="op" id="1633057">{</span><span class="op" id="1633058">}</span><span class="op" id="1633059">)</span>&nbsp;<span class="op" id="1633061">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1633065">(</span><span class="ident" id="1633066">size</span><span class="op" id="1633070">-</span><span class="num" id="1633071">1</span><span class="op" id="1633072">)</span><span class="op" id="1633073">*</span><span class="ident" id="1633074">unsafe</span><span class="op" id="1633080">.</span><span class="ident" id="1633081">Sizeof</span><span class="op" id="1633087">(</span><span class="ident" id="1633088">_select</span><span class="op" id="1633095">{</span><span class="op" id="1633096">}</span><span class="op" id="1633097">.</span><span class="ident" id="1633098">scase</span><span class="op" id="1633103">[</span><span class="num" id="1633104">0</span><span class="op" id="1633105">]</span><span class="op" id="1633106">)</span>&nbsp;<span class="op" id="1633108">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1633112">size</span><span class="op" id="1633116">*</span><span class="ident" id="1633117">unsafe</span><span class="op" id="1633123">.</span><span class="ident" id="1633124">Sizeof</span><span class="op" id="1633130">(</span><span class="op" id="1633131">*</span><span class="ident" id="1633132">_select</span><span class="op" id="1633139">{</span><span class="op" id="1633140">}</span><span class="op" id="1633141">.</span><span class="ident" id="1633142">lockorder</span><span class="op" id="1633151">)</span>&nbsp;<span class="op" id="1633153">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1633157">size</span><span class="op" id="1633161">*</span><span class="ident" id="1633162">unsafe</span><span class="op" id="1633168">.</span><span class="ident" id="1633169">Sizeof</span><span class="op" id="1633175">(</span><span class="op" id="1633176">*</span><span class="ident" id="1633177">_select</span><span class="op" id="1633184">{</span><span class="op" id="1633185">}</span><span class="op" id="1633186">.</span><span class="ident" id="1633187">pollorder</span><span class="op" id="1633196">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1633199">return</span>&nbsp;<span class="ident" id="1633206">round</span><span class="op" id="1633211">(</span><span class="ident" id="1633212">selsize</span><span class="op" id="1633219">,</span>&nbsp;<span class="ident" id="1633221">_Int64Align</span><span class="op" id="1633232">)</span><br>
<span class="lineno"></span><span class="op" id="1633234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1633237">func</span>&nbsp;<span class="ident" id="1633242">newselect</span><span class="op" id="1633251">(</span><span class="ident" id="1633252">sel</span>&nbsp;<span class="op" id="1633256">*</span><span class="ident" id="1633257">_select</span><span class="op" id="1633264">,</span>&nbsp;<span class="ident" id="1633266">selsize</span>&nbsp;<span class="ident" id="1633274">int64</span><span class="op" id="1633279">,</span>&nbsp;<span class="ident" id="1633281">size</span>&nbsp;<span class="builtintype" id="1633286">int32</span><span class="op" id="1633291">)</span>&nbsp;<span class="op" id="1633293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1633296">if</span>&nbsp;<span class="ident" id="1633299">selsize</span>&nbsp;<span class="op" id="1633307">!=</span>&nbsp;<span class="ident" id="1633310">int64</span><span class="op" id="1633315">(</span><span class="ident" id="1633316">selectsize</span><span class="op" id="1633326">(</span><span class="builtintype" id="1633327">uintptr</span><span class="op" id="1633334">(</span><span class="ident" id="1633335">size</span><span class="op" id="1633339">)</span><span class="op" id="1633340">)</span><span class="op" id="1633341">)</span>&nbsp;<span class="op" id="1633343">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1633347">print</span><span class="op" id="1633352">(</span><span class="string" id="1633353">&#34;runtime:&nbsp;bad&nbsp;select&nbsp;size&nbsp;&#34;</span><span class="op" id="1633380">,</span>&nbsp;<span class="ident" id="1633382">selsize</span><span class="op" id="1633389">,</span>&nbsp;<span class="string" id="1633391">&#34;,&nbsp;want&nbsp;&#34;</span><span class="op" id="1633400">,</span>&nbsp;<span class="ident" id="1633402">selectsize</span><span class="op" id="1633412">(</span><span class="builtintype" id="1633413">uintptr</span><span class="op" id="1633420">(</span><span class="ident" id="1633421">size</span><span class="op" id="1633425">)</span><span class="op" id="1633426">)</span><span class="op" id="1633427">,</span>&nbsp;<span class="string" id="1633429">&#34;\n&#34;</span><span class="op" id="1633433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1633437">gothrow</span><span class="op" id="1633444">(</span><span class="string" id="1633445">&#34;bad&nbsp;select&nbsp;size&#34;</span><span class="op" id="1633462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1633465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1633468">sel</span><span class="op" id="1633471">.</span><span class="ident" id="1633472">tcase</span>&nbsp;<span class="op" id="1633478">=</span>&nbsp;<span class="builtintype" id="1633480">uint16</span><span class="op" id="1633486">(</span><span class="ident" id="1633487">size</span><span class="op" id="1633491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1633494">sel</span><span class="op" id="1633497">.</span><span class="ident" id="1633498">ncase</span>&nbsp;<span class="op" id="1633504">=</span>&nbsp;<span class="num" id="1633506">0</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1633509">sel</span><span class="op" id="1633512">.</span><span class="ident" id="1633513">lockorder</span>&nbsp;<span class="op" id="1633523">=</span>&nbsp;<span class="op" id="1633525">(</span><span class="op" id="1633526">*</span><span class="op" id="1633527">*</span><span class="ident" id="1633528">hchan</span><span class="op" id="1633533">)</span><span class="op" id="1633534">(</span><span class="ident" id="1633535">add</span><span class="op" id="1633538">(</span><span class="ident" id="1633539">unsafe</span><span class="op" id="1633545">.</span><span class="ident" id="1633546">Pointer</span><span class="op" id="1633553">(</span><span class="op" id="1633554">&amp;</span><span class="ident" id="1633555">sel</span><span class="op" id="1633558">.</span><span class="ident" id="1633559">scase</span><span class="op" id="1633564">)</span><span class="op" id="1633565">,</span>&nbsp;<span class="builtintype" id="1633567">uintptr</span><span class="op" id="1633574">(</span><span class="ident" id="1633575">size</span><span class="op" id="1633579">)</span><span class="op" id="1633580">*</span><span class="ident" id="1633581">unsafe</span><span class="op" id="1633587">.</span><span class="ident" id="1633588">Sizeof</span><span class="op" id="1633594">(</span><span class="ident" id="1633595">_select</span><span class="op" id="1633602">{</span><span class="op" id="1633603">}</span><span class="op" id="1633604">.</span><span class="ident" id="1633605">scase</span><span class="op" id="1633610">[</span><span class="num" id="1633611">0</span><span class="op" id="1633612">]</span><span class="op" id="1633613">)</span><span class="op" id="1633614">)</span><span class="op" id="1633615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1633618">sel</span><span class="op" id="1633621">.</span><span class="ident" id="1633622">pollorder</span>&nbsp;<span class="op" id="1633632">=</span>&nbsp;<span class="op" id="1633634">(</span><span class="op" id="1633635">*</span><span class="builtintype" id="1633636">uint16</span><span class="op" id="1633642">)</span><span class="op" id="1633643">(</span><span class="ident" id="1633644">add</span><span class="op" id="1633647">(</span><span class="ident" id="1633648">unsafe</span><span class="op" id="1633654">.</span><span class="ident" id="1633655">Pointer</span><span class="op" id="1633662">(</span><span class="ident" id="1633663">sel</span><span class="op" id="1633666">.</span><span class="ident" id="1633667">lockorder</span><span class="op" id="1633676">)</span><span class="op" id="1633677">,</span>&nbsp;<span class="builtintype" id="1633679">uintptr</span><span class="op" id="1633686">(</span><span class="ident" id="1633687">size</span><span class="op" id="1633691">)</span><span class="op" id="1633692">*</span><span class="ident" id="1633693">unsafe</span><span class="op" id="1633699">.</span><span class="ident" id="1633700">Sizeof</span><span class="op" id="1633706">(</span><span class="op" id="1633707">*</span><span class="ident" id="1633708">_select</span><span class="op" id="1633715">{</span><span class="op" id="1633716">}</span><span class="op" id="1633717">.</span><span class="ident" id="1633718">lockorder</span><span class="op" id="1633727">)</span><span class="op" id="1633728">)</span><span class="op" id="1633729">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1633733">if</span>&nbsp;<span class="ident" id="1633736">debugSelect</span>&nbsp;<span class="op" id="1633748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1633752">print</span><span class="op" id="1633757">(</span><span class="string" id="1633758">&#34;newselect&nbsp;s=&#34;</span><span class="op" id="1633772">,</span>&nbsp;<span class="ident" id="1633774">sel</span><span class="op" id="1633777">,</span>&nbsp;<span class="string" id="1633779">&#34;&nbsp;size=&#34;</span><span class="op" id="1633787">,</span>&nbsp;<span class="ident" id="1633789">size</span><span class="op" id="1633793">,</span>&nbsp;<span class="string" id="1633795">&#34;\n&#34;</span><span class="op" id="1633799">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1633802">}</span><br>
<span class="lineno"></span><span class="op" id="1633804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1633807">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1633820">func</span>&nbsp;<span class="ident" id="1633825">selectsend</span><span class="op" id="1633835">(</span><span class="ident" id="1633836">sel</span>&nbsp;<span class="op" id="1633840">*</span><span class="ident" id="1633841">_select</span><span class="op" id="1633848">,</span>&nbsp;<span class="ident" id="1633850">c</span>&nbsp;<span class="op" id="1633852">*</span><span class="ident" id="1633853">hchan</span><span class="op" id="1633858">,</span>&nbsp;<span class="ident" id="1633860">elem</span>&nbsp;<span class="ident" id="1633865">unsafe</span><span class="op" id="1633871">.</span><span class="ident" id="1633872">Pointer</span><span class="op" id="1633879">)</span>&nbsp;<span class="op" id="1633881">(</span><span class="ident" id="1633882">selected</span>&nbsp;<span class="builtintype" id="1633891">bool</span><span class="op" id="1633895">)</span>&nbsp;<span class="op" id="1633897">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1633900">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1633929">if</span>&nbsp;<span class="ident" id="1633932">c</span>&nbsp;<span class="op" id="1633934">!=</span>&nbsp;<span class="ident" id="1633937">nil</span>&nbsp;<span class="op" id="1633941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1633945">selectsendImpl</span><span class="op" id="1633959">(</span><span class="ident" id="1633960">sel</span><span class="op" id="1633963">,</span>&nbsp;<span class="ident" id="1633965">c</span><span class="op" id="1633966">,</span>&nbsp;<span class="ident" id="1633968">getcallerpc</span><span class="op" id="1633979">(</span><span class="ident" id="1633980">unsafe</span><span class="op" id="1633986">.</span><span class="ident" id="1633987">Pointer</span><span class="op" id="1633994">(</span><span class="op" id="1633995">&amp;</span><span class="ident" id="1633996">sel</span><span class="op" id="1633999">)</span><span class="op" id="1634000">)</span><span class="op" id="1634001">,</span>&nbsp;<span class="ident" id="1634003">elem</span><span class="op" id="1634007">,</span>&nbsp;<span class="builtintype" id="1634009">uintptr</span><span class="op" id="1634016">(</span><span class="ident" id="1634017">unsafe</span><span class="op" id="1634023">.</span><span class="ident" id="1634024">Pointer</span><span class="op" id="1634031">(</span><span class="op" id="1634032">&amp;</span><span class="ident" id="1634033">selected</span><span class="op" id="1634041">)</span><span class="op" id="1634042">)</span><span class="op" id="1634043">-</span><span class="builtintype" id="1634044">uintptr</span><span class="op" id="1634051">(</span><span class="ident" id="1634052">unsafe</span><span class="op" id="1634058">.</span><span class="ident" id="1634059">Pointer</span><span class="op" id="1634066">(</span><span class="op" id="1634067">&amp;</span><span class="ident" id="1634068">sel</span><span class="op" id="1634071">)</span><span class="op" id="1634072">)</span><span class="op" id="1634073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1634076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1634079">return</span><br>
<span class="lineno">50</span><span class="op" id="1634086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1634089">//&nbsp;cut&nbsp;in&nbsp;half&nbsp;to&nbsp;give&nbsp;stack&nbsp;a&nbsp;chance&nbsp;to&nbsp;split</span><br>
<span class="lineno"></span><span class="keyword" id="1634136">func</span>&nbsp;<span class="ident" id="1634141">selectsendImpl</span><span class="op" id="1634155">(</span><span class="ident" id="1634156">sel</span>&nbsp;<span class="op" id="1634160">*</span><span class="ident" id="1634161">_select</span><span class="op" id="1634168">,</span>&nbsp;<span class="ident" id="1634170">c</span>&nbsp;<span class="op" id="1634172">*</span><span class="ident" id="1634173">hchan</span><span class="op" id="1634178">,</span>&nbsp;<span class="ident" id="1634180">pc</span>&nbsp;<span class="builtintype" id="1634183">uintptr</span><span class="op" id="1634190">,</span>&nbsp;<span class="ident" id="1634192">elem</span>&nbsp;<span class="ident" id="1634197">unsafe</span><span class="op" id="1634203">.</span><span class="ident" id="1634204">Pointer</span><span class="op" id="1634211">,</span>&nbsp;<span class="ident" id="1634213">so</span>&nbsp;<span class="builtintype" id="1634216">uintptr</span><span class="op" id="1634223">)</span>&nbsp;<span class="op" id="1634225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1634228">i</span>&nbsp;<span class="op" id="1634230">:=</span>&nbsp;<span class="ident" id="1634233">sel</span><span class="op" id="1634236">.</span><span class="ident" id="1634237">ncase</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1634244">if</span>&nbsp;<span class="ident" id="1634247">i</span>&nbsp;<span class="op" id="1634249">&gt;=</span>&nbsp;<span class="ident" id="1634252">sel</span><span class="op" id="1634255">.</span><span class="ident" id="1634256">tcase</span>&nbsp;<span class="op" id="1634262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1634266">gothrow</span><span class="op" id="1634273">(</span><span class="string" id="1634274">&#34;selectsend:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1634302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1634305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1634308">sel</span><span class="op" id="1634311">.</span><span class="ident" id="1634312">ncase</span>&nbsp;<span class="op" id="1634318">=</span>&nbsp;<span class="ident" id="1634320">i</span>&nbsp;<span class="op" id="1634322">+</span>&nbsp;<span class="num" id="1634324">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1634327">cas</span>&nbsp;<span class="op" id="1634331">:=</span>&nbsp;<span class="op" id="1634334">(</span><span class="op" id="1634335">*</span><span class="ident" id="1634336">scase</span><span class="op" id="1634341">)</span><span class="op" id="1634342">(</span><span class="ident" id="1634343">add</span><span class="op" id="1634346">(</span><span class="ident" id="1634347">unsafe</span><span class="op" id="1634353">.</span><span class="ident" id="1634354">Pointer</span><span class="op" id="1634361">(</span><span class="op" id="1634362">&amp;</span><span class="ident" id="1634363">sel</span><span class="op" id="1634366">.</span><span class="ident" id="1634367">scase</span><span class="op" id="1634372">)</span><span class="op" id="1634373">,</span>&nbsp;<span class="builtintype" id="1634375">uintptr</span><span class="op" id="1634382">(</span><span class="ident" id="1634383">i</span><span class="op" id="1634384">)</span><span class="op" id="1634385">*</span><span class="ident" id="1634386">unsafe</span><span class="op" id="1634392">.</span><span class="ident" id="1634393">Sizeof</span><span class="op" id="1634399">(</span><span class="ident" id="1634400">sel</span><span class="op" id="1634403">.</span><span class="ident" id="1634404">scase</span><span class="op" id="1634409">[</span><span class="num" id="1634410">0</span><span class="op" id="1634411">]</span><span class="op" id="1634412">)</span><span class="op" id="1634413">)</span><span class="op" id="1634414">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1634418">cas</span><span class="op" id="1634421">.</span><span class="ident" id="1634422">pc</span>&nbsp;<span class="op" id="1634425">=</span>&nbsp;<span class="ident" id="1634427">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1634431">cas</span><span class="op" id="1634434">.</span><span class="ident" id="1634435">_chan</span>&nbsp;<span class="op" id="1634441">=</span>&nbsp;<span class="ident" id="1634443">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1634446">cas</span><span class="op" id="1634449">.</span><span class="ident" id="1634450">so</span>&nbsp;<span class="op" id="1634453">=</span>&nbsp;<span class="builtintype" id="1634455">uint16</span><span class="op" id="1634461">(</span><span class="ident" id="1634462">so</span><span class="op" id="1634464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1634467">cas</span><span class="op" id="1634470">.</span><span class="ident" id="1634471">kind</span>&nbsp;<span class="op" id="1634476">=</span>&nbsp;<span class="ident" id="1634478">_CaseSend</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1634489">cas</span><span class="op" id="1634492">.</span><span class="ident" id="1634493">elem</span>&nbsp;<span class="op" id="1634498">=</span>&nbsp;<span class="ident" id="1634500">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1634507">if</span>&nbsp;<span class="ident" id="1634510">debugSelect</span>&nbsp;<span class="op" id="1634522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1634526">print</span><span class="op" id="1634531">(</span><span class="string" id="1634532">&#34;selectsend&nbsp;s=&#34;</span><span class="op" id="1634547">,</span>&nbsp;<span class="ident" id="1634549">sel</span><span class="op" id="1634552">,</span>&nbsp;<span class="string" id="1634554">&#34;&nbsp;pc=&#34;</span><span class="op" id="1634560">,</span>&nbsp;<span class="ident" id="1634562">hex</span><span class="op" id="1634565">(</span><span class="ident" id="1634566">cas</span><span class="op" id="1634569">.</span><span class="ident" id="1634570">pc</span><span class="op" id="1634572">)</span><span class="op" id="1634573">,</span>&nbsp;<span class="string" id="1634575">&#34;&nbsp;chan=&#34;</span><span class="op" id="1634583">,</span>&nbsp;<span class="ident" id="1634585">cas</span><span class="op" id="1634588">.</span><span class="ident" id="1634589">_chan</span><span class="op" id="1634594">,</span>&nbsp;<span class="string" id="1634596">&#34;&nbsp;so=&#34;</span><span class="op" id="1634602">,</span>&nbsp;<span class="ident" id="1634604">cas</span><span class="op" id="1634607">.</span><span class="ident" id="1634608">so</span><span class="op" id="1634610">,</span>&nbsp;<span class="string" id="1634612">&#34;\n&#34;</span><span class="op" id="1634616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1634619">}</span><br>
<span class="lineno">70</span><span class="op" id="1634621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1634624">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1634637">func</span>&nbsp;<span class="ident" id="1634642">selectrecv</span><span class="op" id="1634652">(</span><span class="ident" id="1634653">sel</span>&nbsp;<span class="op" id="1634657">*</span><span class="ident" id="1634658">_select</span><span class="op" id="1634665">,</span>&nbsp;<span class="ident" id="1634667">c</span>&nbsp;<span class="op" id="1634669">*</span><span class="ident" id="1634670">hchan</span><span class="op" id="1634675">,</span>&nbsp;<span class="ident" id="1634677">elem</span>&nbsp;<span class="ident" id="1634682">unsafe</span><span class="op" id="1634688">.</span><span class="ident" id="1634689">Pointer</span><span class="op" id="1634696">)</span>&nbsp;<span class="op" id="1634698">(</span><span class="ident" id="1634699">selected</span>&nbsp;<span class="builtintype" id="1634708">bool</span><span class="op" id="1634712">)</span>&nbsp;<span class="op" id="1634714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1634717">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1634746">if</span>&nbsp;<span class="ident" id="1634749">c</span>&nbsp;<span class="op" id="1634751">!=</span>&nbsp;<span class="ident" id="1634754">nil</span>&nbsp;<span class="op" id="1634758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1634762">selectrecvImpl</span><span class="op" id="1634776">(</span><span class="ident" id="1634777">sel</span><span class="op" id="1634780">,</span>&nbsp;<span class="ident" id="1634782">c</span><span class="op" id="1634783">,</span>&nbsp;<span class="ident" id="1634785">getcallerpc</span><span class="op" id="1634796">(</span><span class="ident" id="1634797">unsafe</span><span class="op" id="1634803">.</span><span class="ident" id="1634804">Pointer</span><span class="op" id="1634811">(</span><span class="op" id="1634812">&amp;</span><span class="ident" id="1634813">sel</span><span class="op" id="1634816">)</span><span class="op" id="1634817">)</span><span class="op" id="1634818">,</span>&nbsp;<span class="ident" id="1634820">elem</span><span class="op" id="1634824">,</span>&nbsp;<span class="ident" id="1634826">nil</span><span class="op" id="1634829">,</span>&nbsp;<span class="builtintype" id="1634831">uintptr</span><span class="op" id="1634838">(</span><span class="ident" id="1634839">unsafe</span><span class="op" id="1634845">.</span><span class="ident" id="1634846">Pointer</span><span class="op" id="1634853">(</span><span class="op" id="1634854">&amp;</span><span class="ident" id="1634855">selected</span><span class="op" id="1634863">)</span><span class="op" id="1634864">)</span><span class="op" id="1634865">-</span><span class="builtintype" id="1634866">uintptr</span><span class="op" id="1634873">(</span><span class="ident" id="1634874">unsafe</span><span class="op" id="1634880">.</span><span class="ident" id="1634881">Pointer</span><span class="op" id="1634888">(</span><span class="op" id="1634889">&amp;</span><span class="ident" id="1634890">sel</span><span class="op" id="1634893">)</span><span class="op" id="1634894">)</span><span class="op" id="1634895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1634898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1634901">return</span><br>
<span class="lineno"></span><span class="op" id="1634908">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment" id="1634911">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1634924">func</span>&nbsp;<span class="ident" id="1634929">selectrecv2</span><span class="op" id="1634940">(</span><span class="ident" id="1634941">sel</span>&nbsp;<span class="op" id="1634945">*</span><span class="ident" id="1634946">_select</span><span class="op" id="1634953">,</span>&nbsp;<span class="ident" id="1634955">c</span>&nbsp;<span class="op" id="1634957">*</span><span class="ident" id="1634958">hchan</span><span class="op" id="1634963">,</span>&nbsp;<span class="ident" id="1634965">elem</span>&nbsp;<span class="ident" id="1634970">unsafe</span><span class="op" id="1634976">.</span><span class="ident" id="1634977">Pointer</span><span class="op" id="1634984">,</span>&nbsp;<span class="ident" id="1634986">received</span>&nbsp;<span class="op" id="1634995">*</span><span class="builtintype" id="1634996">bool</span><span class="op" id="1635000">)</span>&nbsp;<span class="op" id="1635002">(</span><span class="ident" id="1635003">selected</span>&nbsp;<span class="builtintype" id="1635012">bool</span><span class="op" id="1635016">)</span>&nbsp;<span class="op" id="1635018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1635021">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1635050">if</span>&nbsp;<span class="ident" id="1635053">c</span>&nbsp;<span class="op" id="1635055">!=</span>&nbsp;<span class="ident" id="1635058">nil</span>&nbsp;<span class="op" id="1635062">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1635066">selectrecvImpl</span><span class="op" id="1635080">(</span><span class="ident" id="1635081">sel</span><span class="op" id="1635084">,</span>&nbsp;<span class="ident" id="1635086">c</span><span class="op" id="1635087">,</span>&nbsp;<span class="ident" id="1635089">getcallerpc</span><span class="op" id="1635100">(</span><span class="ident" id="1635101">unsafe</span><span class="op" id="1635107">.</span><span class="ident" id="1635108">Pointer</span><span class="op" id="1635115">(</span><span class="op" id="1635116">&amp;</span><span class="ident" id="1635117">sel</span><span class="op" id="1635120">)</span><span class="op" id="1635121">)</span><span class="op" id="1635122">,</span>&nbsp;<span class="ident" id="1635124">elem</span><span class="op" id="1635128">,</span>&nbsp;<span class="ident" id="1635130">received</span><span class="op" id="1635138">,</span>&nbsp;<span class="builtintype" id="1635140">uintptr</span><span class="op" id="1635147">(</span><span class="ident" id="1635148">unsafe</span><span class="op" id="1635154">.</span><span class="ident" id="1635155">Pointer</span><span class="op" id="1635162">(</span><span class="op" id="1635163">&amp;</span><span class="ident" id="1635164">selected</span><span class="op" id="1635172">)</span><span class="op" id="1635173">)</span><span class="op" id="1635174">-</span><span class="builtintype" id="1635175">uintptr</span><span class="op" id="1635182">(</span><span class="ident" id="1635183">unsafe</span><span class="op" id="1635189">.</span><span class="ident" id="1635190">Pointer</span><span class="op" id="1635197">(</span><span class="op" id="1635198">&amp;</span><span class="ident" id="1635199">sel</span><span class="op" id="1635202">)</span><span class="op" id="1635203">)</span><span class="op" id="1635204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1635207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1635210">return</span><br>
<span class="lineno"></span><span class="op" id="1635217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="1635220">func</span>&nbsp;<span class="ident" id="1635225">selectrecvImpl</span><span class="op" id="1635239">(</span><span class="ident" id="1635240">sel</span>&nbsp;<span class="op" id="1635244">*</span><span class="ident" id="1635245">_select</span><span class="op" id="1635252">,</span>&nbsp;<span class="ident" id="1635254">c</span>&nbsp;<span class="op" id="1635256">*</span><span class="ident" id="1635257">hchan</span><span class="op" id="1635262">,</span>&nbsp;<span class="ident" id="1635264">pc</span>&nbsp;<span class="builtintype" id="1635267">uintptr</span><span class="op" id="1635274">,</span>&nbsp;<span class="ident" id="1635276">elem</span>&nbsp;<span class="ident" id="1635281">unsafe</span><span class="op" id="1635287">.</span><span class="ident" id="1635288">Pointer</span><span class="op" id="1635295">,</span>&nbsp;<span class="ident" id="1635297">received</span>&nbsp;<span class="op" id="1635306">*</span><span class="builtintype" id="1635307">bool</span><span class="op" id="1635311">,</span>&nbsp;<span class="ident" id="1635313">so</span>&nbsp;<span class="builtintype" id="1635316">uintptr</span><span class="op" id="1635323">)</span>&nbsp;<span class="op" id="1635325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1635328">i</span>&nbsp;<span class="op" id="1635330">:=</span>&nbsp;<span class="ident" id="1635333">sel</span><span class="op" id="1635336">.</span><span class="ident" id="1635337">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1635344">if</span>&nbsp;<span class="ident" id="1635347">i</span>&nbsp;<span class="op" id="1635349">&gt;=</span>&nbsp;<span class="ident" id="1635352">sel</span><span class="op" id="1635355">.</span><span class="ident" id="1635356">tcase</span>&nbsp;<span class="op" id="1635362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1635366">gothrow</span><span class="op" id="1635373">(</span><span class="string" id="1635374">&#34;selectrecv:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1635402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1635405">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1635408">sel</span><span class="op" id="1635411">.</span><span class="ident" id="1635412">ncase</span>&nbsp;<span class="op" id="1635418">=</span>&nbsp;<span class="ident" id="1635420">i</span>&nbsp;<span class="op" id="1635422">+</span>&nbsp;<span class="num" id="1635424">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1635427">cas</span>&nbsp;<span class="op" id="1635431">:=</span>&nbsp;<span class="op" id="1635434">(</span><span class="op" id="1635435">*</span><span class="ident" id="1635436">scase</span><span class="op" id="1635441">)</span><span class="op" id="1635442">(</span><span class="ident" id="1635443">add</span><span class="op" id="1635446">(</span><span class="ident" id="1635447">unsafe</span><span class="op" id="1635453">.</span><span class="ident" id="1635454">Pointer</span><span class="op" id="1635461">(</span><span class="op" id="1635462">&amp;</span><span class="ident" id="1635463">sel</span><span class="op" id="1635466">.</span><span class="ident" id="1635467">scase</span><span class="op" id="1635472">)</span><span class="op" id="1635473">,</span>&nbsp;<span class="builtintype" id="1635475">uintptr</span><span class="op" id="1635482">(</span><span class="ident" id="1635483">i</span><span class="op" id="1635484">)</span><span class="op" id="1635485">*</span><span class="ident" id="1635486">unsafe</span><span class="op" id="1635492">.</span><span class="ident" id="1635493">Sizeof</span><span class="op" id="1635499">(</span><span class="ident" id="1635500">sel</span><span class="op" id="1635503">.</span><span class="ident" id="1635504">scase</span><span class="op" id="1635509">[</span><span class="num" id="1635510">0</span><span class="op" id="1635511">]</span><span class="op" id="1635512">)</span><span class="op" id="1635513">)</span><span class="op" id="1635514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1635517">cas</span><span class="op" id="1635520">.</span><span class="ident" id="1635521">pc</span>&nbsp;<span class="op" id="1635524">=</span>&nbsp;<span class="ident" id="1635526">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1635530">cas</span><span class="op" id="1635533">.</span><span class="ident" id="1635534">_chan</span>&nbsp;<span class="op" id="1635540">=</span>&nbsp;<span class="ident" id="1635542">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1635545">cas</span><span class="op" id="1635548">.</span><span class="ident" id="1635549">so</span>&nbsp;<span class="op" id="1635552">=</span>&nbsp;<span class="builtintype" id="1635554">uint16</span><span class="op" id="1635560">(</span><span class="ident" id="1635561">so</span><span class="op" id="1635563">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1635566">cas</span><span class="op" id="1635569">.</span><span class="ident" id="1635570">kind</span>&nbsp;<span class="op" id="1635575">=</span>&nbsp;<span class="ident" id="1635577">_CaseRecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1635588">cas</span><span class="op" id="1635591">.</span><span class="ident" id="1635592">elem</span>&nbsp;<span class="op" id="1635597">=</span>&nbsp;<span class="ident" id="1635599">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1635605">cas</span><span class="op" id="1635608">.</span><span class="ident" id="1635609">receivedp</span>&nbsp;<span class="op" id="1635619">=</span>&nbsp;<span class="ident" id="1635621">received</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1635632">if</span>&nbsp;<span class="ident" id="1635635">debugSelect</span>&nbsp;<span class="op" id="1635647">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1635651">print</span><span class="op" id="1635656">(</span><span class="string" id="1635657">&#34;selectrecv&nbsp;s=&#34;</span><span class="op" id="1635672">,</span>&nbsp;<span class="ident" id="1635674">sel</span><span class="op" id="1635677">,</span>&nbsp;<span class="string" id="1635679">&#34;&nbsp;pc=&#34;</span><span class="op" id="1635685">,</span>&nbsp;<span class="ident" id="1635687">hex</span><span class="op" id="1635690">(</span><span class="ident" id="1635691">cas</span><span class="op" id="1635694">.</span><span class="ident" id="1635695">pc</span><span class="op" id="1635697">)</span><span class="op" id="1635698">,</span>&nbsp;<span class="string" id="1635700">&#34;&nbsp;chan=&#34;</span><span class="op" id="1635708">,</span>&nbsp;<span class="ident" id="1635710">cas</span><span class="op" id="1635713">.</span><span class="ident" id="1635714">_chan</span><span class="op" id="1635719">,</span>&nbsp;<span class="string" id="1635721">&#34;&nbsp;so=&#34;</span><span class="op" id="1635727">,</span>&nbsp;<span class="ident" id="1635729">cas</span><span class="op" id="1635732">.</span><span class="ident" id="1635733">so</span><span class="op" id="1635735">,</span>&nbsp;<span class="string" id="1635737">&#34;\n&#34;</span><span class="op" id="1635741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1635744">}</span><br>
<span class="lineno"></span><span class="op" id="1635746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1635749">//go:nosplit</span><br>
<span class="lineno">110</span><span class="keyword" id="1635762">func</span>&nbsp;<span class="ident" id="1635767">selectdefault</span><span class="op" id="1635780">(</span><span class="ident" id="1635781">sel</span>&nbsp;<span class="op" id="1635785">*</span><span class="ident" id="1635786">_select</span><span class="op" id="1635793">)</span>&nbsp;<span class="op" id="1635795">(</span><span class="ident" id="1635796">selected</span>&nbsp;<span class="builtintype" id="1635805">bool</span><span class="op" id="1635809">)</span>&nbsp;<span class="op" id="1635811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1635814">selectdefaultImpl</span><span class="op" id="1635831">(</span><span class="ident" id="1635832">sel</span><span class="op" id="1635835">,</span>&nbsp;<span class="ident" id="1635837">getcallerpc</span><span class="op" id="1635848">(</span><span class="ident" id="1635849">unsafe</span><span class="op" id="1635855">.</span><span class="ident" id="1635856">Pointer</span><span class="op" id="1635863">(</span><span class="op" id="1635864">&amp;</span><span class="ident" id="1635865">sel</span><span class="op" id="1635868">)</span><span class="op" id="1635869">)</span><span class="op" id="1635870">,</span>&nbsp;<span class="builtintype" id="1635872">uintptr</span><span class="op" id="1635879">(</span><span class="ident" id="1635880">unsafe</span><span class="op" id="1635886">.</span><span class="ident" id="1635887">Pointer</span><span class="op" id="1635894">(</span><span class="op" id="1635895">&amp;</span><span class="ident" id="1635896">selected</span><span class="op" id="1635904">)</span><span class="op" id="1635905">)</span><span class="op" id="1635906">-</span><span class="builtintype" id="1635907">uintptr</span><span class="op" id="1635914">(</span><span class="ident" id="1635915">unsafe</span><span class="op" id="1635921">.</span><span class="ident" id="1635922">Pointer</span><span class="op" id="1635929">(</span><span class="op" id="1635930">&amp;</span><span class="ident" id="1635931">sel</span><span class="op" id="1635934">)</span><span class="op" id="1635935">)</span><span class="op" id="1635936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1635939">return</span><br>
<span class="lineno"></span><span class="op" id="1635946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="1635949">func</span>&nbsp;<span class="ident" id="1635954">selectdefaultImpl</span><span class="op" id="1635971">(</span><span class="ident" id="1635972">sel</span>&nbsp;<span class="op" id="1635976">*</span><span class="ident" id="1635977">_select</span><span class="op" id="1635984">,</span>&nbsp;<span class="ident" id="1635986">callerpc</span>&nbsp;<span class="builtintype" id="1635995">uintptr</span><span class="op" id="1636002">,</span>&nbsp;<span class="ident" id="1636004">so</span>&nbsp;<span class="builtintype" id="1636007">uintptr</span><span class="op" id="1636014">)</span>&nbsp;<span class="op" id="1636016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636019">i</span>&nbsp;<span class="op" id="1636021">:=</span>&nbsp;<span class="ident" id="1636024">sel</span><span class="op" id="1636027">.</span><span class="ident" id="1636028">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1636035">if</span>&nbsp;<span class="ident" id="1636038">i</span>&nbsp;<span class="op" id="1636040">&gt;=</span>&nbsp;<span class="ident" id="1636043">sel</span><span class="op" id="1636046">.</span><span class="ident" id="1636047">tcase</span>&nbsp;<span class="op" id="1636053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636057">gothrow</span><span class="op" id="1636064">(</span><span class="string" id="1636065">&#34;selectdefault:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1636096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1636099">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636102">sel</span><span class="op" id="1636105">.</span><span class="ident" id="1636106">ncase</span>&nbsp;<span class="op" id="1636112">=</span>&nbsp;<span class="ident" id="1636114">i</span>&nbsp;<span class="op" id="1636116">+</span>&nbsp;<span class="num" id="1636118">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636121">cas</span>&nbsp;<span class="op" id="1636125">:=</span>&nbsp;<span class="op" id="1636128">(</span><span class="op" id="1636129">*</span><span class="ident" id="1636130">scase</span><span class="op" id="1636135">)</span><span class="op" id="1636136">(</span><span class="ident" id="1636137">add</span><span class="op" id="1636140">(</span><span class="ident" id="1636141">unsafe</span><span class="op" id="1636147">.</span><span class="ident" id="1636148">Pointer</span><span class="op" id="1636155">(</span><span class="op" id="1636156">&amp;</span><span class="ident" id="1636157">sel</span><span class="op" id="1636160">.</span><span class="ident" id="1636161">scase</span><span class="op" id="1636166">)</span><span class="op" id="1636167">,</span>&nbsp;<span class="builtintype" id="1636169">uintptr</span><span class="op" id="1636176">(</span><span class="ident" id="1636177">i</span><span class="op" id="1636178">)</span><span class="op" id="1636179">*</span><span class="ident" id="1636180">unsafe</span><span class="op" id="1636186">.</span><span class="ident" id="1636187">Sizeof</span><span class="op" id="1636193">(</span><span class="ident" id="1636194">sel</span><span class="op" id="1636197">.</span><span class="ident" id="1636198">scase</span><span class="op" id="1636203">[</span><span class="num" id="1636204">0</span><span class="op" id="1636205">]</span><span class="op" id="1636206">)</span><span class="op" id="1636207">)</span><span class="op" id="1636208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636211">cas</span><span class="op" id="1636214">.</span><span class="ident" id="1636215">pc</span>&nbsp;<span class="op" id="1636218">=</span>&nbsp;<span class="ident" id="1636220">callerpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636230">cas</span><span class="op" id="1636233">.</span><span class="ident" id="1636234">_chan</span>&nbsp;<span class="op" id="1636240">=</span>&nbsp;<span class="ident" id="1636242">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636247">cas</span><span class="op" id="1636250">.</span><span class="ident" id="1636251">so</span>&nbsp;<span class="op" id="1636254">=</span>&nbsp;<span class="builtintype" id="1636256">uint16</span><span class="op" id="1636262">(</span><span class="ident" id="1636263">so</span><span class="op" id="1636265">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636268">cas</span><span class="op" id="1636271">.</span><span class="ident" id="1636272">kind</span>&nbsp;<span class="op" id="1636277">=</span>&nbsp;<span class="ident" id="1636279">_CaseDefault</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1636294">if</span>&nbsp;<span class="ident" id="1636297">debugSelect</span>&nbsp;<span class="op" id="1636309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1636313">print</span><span class="op" id="1636318">(</span><span class="string" id="1636319">&#34;selectdefault&nbsp;s=&#34;</span><span class="op" id="1636337">,</span>&nbsp;<span class="ident" id="1636339">sel</span><span class="op" id="1636342">,</span>&nbsp;<span class="string" id="1636344">&#34;&nbsp;pc=&#34;</span><span class="op" id="1636350">,</span>&nbsp;<span class="ident" id="1636352">hex</span><span class="op" id="1636355">(</span><span class="ident" id="1636356">cas</span><span class="op" id="1636359">.</span><span class="ident" id="1636360">pc</span><span class="op" id="1636362">)</span><span class="op" id="1636363">,</span>&nbsp;<span class="string" id="1636365">&#34;&nbsp;so=&#34;</span><span class="op" id="1636371">,</span>&nbsp;<span class="ident" id="1636373">cas</span><span class="op" id="1636376">.</span><span class="ident" id="1636377">so</span><span class="op" id="1636379">,</span>&nbsp;<span class="string" id="1636381">&#34;\n&#34;</span><span class="op" id="1636385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1636388">}</span><br>
<span class="lineno">130</span><span class="op" id="1636390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1636393">func</span>&nbsp;<span class="ident" id="1636398">sellock</span><span class="op" id="1636405">(</span><span class="ident" id="1636406">sel</span>&nbsp;<span class="op" id="1636410">*</span><span class="ident" id="1636411">_select</span><span class="op" id="1636418">)</span>&nbsp;<span class="op" id="1636420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636423">lockslice</span>&nbsp;<span class="op" id="1636433">:=</span>&nbsp;<span class="ident" id="1636436">sliceStruct</span><span class="op" id="1636447">{</span><span class="ident" id="1636448">unsafe</span><span class="op" id="1636454">.</span><span class="ident" id="1636455">Pointer</span><span class="op" id="1636462">(</span><span class="ident" id="1636463">sel</span><span class="op" id="1636466">.</span><span class="ident" id="1636467">lockorder</span><span class="op" id="1636476">)</span><span class="op" id="1636477">,</span>&nbsp;<span class="builtintype" id="1636479">int</span><span class="op" id="1636482">(</span><span class="ident" id="1636483">sel</span><span class="op" id="1636486">.</span><span class="ident" id="1636487">ncase</span><span class="op" id="1636492">)</span><span class="op" id="1636493">,</span>&nbsp;<span class="builtintype" id="1636495">int</span><span class="op" id="1636498">(</span><span class="ident" id="1636499">sel</span><span class="op" id="1636502">.</span><span class="ident" id="1636503">ncase</span><span class="op" id="1636508">)</span><span class="op" id="1636509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636512">lockorder</span>&nbsp;<span class="op" id="1636522">:=</span>&nbsp;<span class="op" id="1636525">*</span><span class="op" id="1636526">(</span><span class="op" id="1636527">*</span><span class="op" id="1636528">[</span><span class="op" id="1636529">]</span><span class="op" id="1636530">*</span><span class="ident" id="1636531">hchan</span><span class="op" id="1636536">)</span><span class="op" id="1636537">(</span><span class="ident" id="1636538">unsafe</span><span class="op" id="1636544">.</span><span class="ident" id="1636545">Pointer</span><span class="op" id="1636552">(</span><span class="op" id="1636553">&amp;</span><span class="ident" id="1636554">lockslice</span><span class="op" id="1636563">)</span><span class="op" id="1636564">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1636567">var</span>&nbsp;<span class="ident" id="1636571">c</span>&nbsp;<span class="op" id="1636573">*</span><span class="ident" id="1636574">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1636581">for</span>&nbsp;<span class="ident" id="1636585">_</span><span class="op" id="1636586">,</span>&nbsp;<span class="ident" id="1636588">c0</span>&nbsp;<span class="op" id="1636591">:=</span>&nbsp;<span class="keyword" id="1636594">range</span>&nbsp;<span class="ident" id="1636600">lockorder</span>&nbsp;<span class="op" id="1636610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1636614">if</span>&nbsp;<span class="ident" id="1636617">c0</span>&nbsp;<span class="op" id="1636620">!=</span>&nbsp;<span class="ident" id="1636623">nil</span>&nbsp;<span class="op" id="1636627">&amp;&amp;</span>&nbsp;<span class="ident" id="1636630">c0</span>&nbsp;<span class="op" id="1636633">!=</span>&nbsp;<span class="ident" id="1636636">c</span>&nbsp;<span class="op" id="1636638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636643">c</span>&nbsp;<span class="op" id="1636645">=</span>&nbsp;<span class="ident" id="1636647">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636653">lock</span><span class="op" id="1636657">(</span><span class="op" id="1636658">&amp;</span><span class="ident" id="1636659">c</span><span class="op" id="1636660">.</span><span class="ident" id="1636661">lock</span><span class="op" id="1636665">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1636669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1636672">}</span><br>
<span class="lineno"></span><span class="op" id="1636674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1636677">func</span>&nbsp;<span class="ident" id="1636682">selunlock</span><span class="op" id="1636691">(</span><span class="ident" id="1636692">sel</span>&nbsp;<span class="op" id="1636696">*</span><span class="ident" id="1636697">_select</span><span class="op" id="1636704">)</span>&nbsp;<span class="op" id="1636706">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636709">//&nbsp;We&nbsp;must&nbsp;be&nbsp;very&nbsp;careful&nbsp;here&nbsp;to&nbsp;not&nbsp;touch&nbsp;sel&nbsp;after&nbsp;we&nbsp;have&nbsp;unlocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636782">//&nbsp;the&nbsp;last&nbsp;lock,&nbsp;because&nbsp;sel&nbsp;can&nbsp;be&nbsp;freed&nbsp;right&nbsp;after&nbsp;the&nbsp;last&nbsp;unlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636855">//&nbsp;Consider&nbsp;the&nbsp;following&nbsp;situation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636893">//&nbsp;First&nbsp;M&nbsp;calls&nbsp;runtimepark()&nbsp;in&nbsp;runtimeselectgo()&nbsp;passing&nbsp;the&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636967">//&nbsp;Once&nbsp;runtimepark()&nbsp;has&nbsp;unlocked&nbsp;the&nbsp;last&nbsp;lock,&nbsp;another&nbsp;M&nbsp;makes</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1637036">//&nbsp;the&nbsp;G&nbsp;that&nbsp;calls&nbsp;select&nbsp;runnable&nbsp;again&nbsp;and&nbsp;schedules&nbsp;it&nbsp;for&nbsp;execution.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1637111">//&nbsp;When&nbsp;the&nbsp;G&nbsp;runs&nbsp;on&nbsp;another&nbsp;M,&nbsp;it&nbsp;locks&nbsp;all&nbsp;the&nbsp;locks&nbsp;and&nbsp;frees&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1637183">//&nbsp;Now&nbsp;if&nbsp;the&nbsp;first&nbsp;M&nbsp;touches&nbsp;sel,&nbsp;it&nbsp;will&nbsp;access&nbsp;freed&nbsp;memory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637248">n</span>&nbsp;<span class="op" id="1637250">:=</span>&nbsp;<span class="builtintype" id="1637253">int</span><span class="op" id="1637256">(</span><span class="ident" id="1637257">sel</span><span class="op" id="1637260">.</span><span class="ident" id="1637261">ncase</span><span class="op" id="1637266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637269">r</span>&nbsp;<span class="op" id="1637271">:=</span>&nbsp;<span class="num" id="1637274">0</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637277">lockslice</span>&nbsp;<span class="op" id="1637287">:=</span>&nbsp;<span class="ident" id="1637290">sliceStruct</span><span class="op" id="1637301">{</span><span class="ident" id="1637302">unsafe</span><span class="op" id="1637308">.</span><span class="ident" id="1637309">Pointer</span><span class="op" id="1637316">(</span><span class="ident" id="1637317">sel</span><span class="op" id="1637320">.</span><span class="ident" id="1637321">lockorder</span><span class="op" id="1637330">)</span><span class="op" id="1637331">,</span>&nbsp;<span class="ident" id="1637333">n</span><span class="op" id="1637334">,</span>&nbsp;<span class="ident" id="1637336">n</span><span class="op" id="1637337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637340">lockorder</span>&nbsp;<span class="op" id="1637350">:=</span>&nbsp;<span class="op" id="1637353">*</span><span class="op" id="1637354">(</span><span class="op" id="1637355">*</span><span class="op" id="1637356">[</span><span class="op" id="1637357">]</span><span class="op" id="1637358">*</span><span class="ident" id="1637359">hchan</span><span class="op" id="1637364">)</span><span class="op" id="1637365">(</span><span class="ident" id="1637366">unsafe</span><span class="op" id="1637372">.</span><span class="ident" id="1637373">Pointer</span><span class="op" id="1637380">(</span><span class="op" id="1637381">&amp;</span><span class="ident" id="1637382">lockslice</span><span class="op" id="1637391">)</span><span class="op" id="1637392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1637395">//&nbsp;skip&nbsp;the&nbsp;default&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637421">if</span>&nbsp;<span class="ident" id="1637424">n</span>&nbsp;<span class="op" id="1637426">&gt;</span>&nbsp;<span class="num" id="1637428">0</span>&nbsp;<span class="op" id="1637430">&amp;&amp;</span>&nbsp;<span class="ident" id="1637433">lockorder</span><span class="op" id="1637442">[</span><span class="num" id="1637443">0</span><span class="op" id="1637444">]</span>&nbsp;<span class="op" id="1637446">==</span>&nbsp;<span class="ident" id="1637449">nil</span>&nbsp;<span class="op" id="1637453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637457">r</span>&nbsp;<span class="op" id="1637459">=</span>&nbsp;<span class="num" id="1637461">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1637464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637467">for</span>&nbsp;<span class="ident" id="1637471">i</span>&nbsp;<span class="op" id="1637473">:=</span>&nbsp;<span class="ident" id="1637476">n</span>&nbsp;<span class="op" id="1637478">-</span>&nbsp;<span class="num" id="1637480">1</span><span class="op" id="1637481">;</span>&nbsp;<span class="ident" id="1637483">i</span>&nbsp;<span class="op" id="1637485">&gt;=</span>&nbsp;<span class="ident" id="1637488">r</span><span class="op" id="1637489">;</span>&nbsp;<span class="ident" id="1637491">i</span><span class="op" id="1637492">--</span>&nbsp;<span class="op" id="1637495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637499">c</span>&nbsp;<span class="op" id="1637501">:=</span>&nbsp;<span class="ident" id="1637504">lockorder</span><span class="op" id="1637513">[</span><span class="ident" id="1637514">i</span><span class="op" id="1637515">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637519">if</span>&nbsp;<span class="ident" id="1637522">i</span>&nbsp;<span class="op" id="1637524">&gt;</span>&nbsp;<span class="num" id="1637526">0</span>&nbsp;<span class="op" id="1637528">&amp;&amp;</span>&nbsp;<span class="ident" id="1637531">c</span>&nbsp;<span class="op" id="1637533">==</span>&nbsp;<span class="ident" id="1637536">lockorder</span><span class="op" id="1637545">[</span><span class="ident" id="1637546">i</span><span class="op" id="1637547">-</span><span class="num" id="1637548">1</span><span class="op" id="1637549">]</span>&nbsp;<span class="op" id="1637551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637556">continue</span>&nbsp;<span class="comment" id="1637565">//&nbsp;will&nbsp;unlock&nbsp;it&nbsp;on&nbsp;the&nbsp;next&nbsp;iteration</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1637607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637611">unlock</span><span class="op" id="1637617">(</span><span class="op" id="1637618">&amp;</span><span class="ident" id="1637619">c</span><span class="op" id="1637620">.</span><span class="ident" id="1637621">lock</span><span class="op" id="1637625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1637628">}</span><br>
<span class="lineno"></span><span class="op" id="1637630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword" id="1637633">func</span>&nbsp;<span class="ident" id="1637638">selparkcommit</span><span class="op" id="1637651">(</span><span class="ident" id="1637652">gp</span>&nbsp;<span class="op" id="1637655">*</span><span class="ident" id="1637656">g</span><span class="op" id="1637657">,</span>&nbsp;<span class="ident" id="1637659">sel</span>&nbsp;<span class="op" id="1637663">*</span><span class="ident" id="1637664">_select</span><span class="op" id="1637671">)</span>&nbsp;<span class="builtintype" id="1637673">bool</span>&nbsp;<span class="op" id="1637678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637681">selunlock</span><span class="op" id="1637690">(</span><span class="ident" id="1637691">sel</span><span class="op" id="1637694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1637697">return</span>&nbsp;<span class="builtintype" id="1637704">true</span><br>
<span class="lineno"></span><span class="op" id="1637709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="1637712">func</span>&nbsp;<span class="ident" id="1637717">block</span><span class="op" id="1637722">(</span><span class="op" id="1637723">)</span>&nbsp;<span class="op" id="1637725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637728">gopark</span><span class="op" id="1637734">(</span><span class="ident" id="1637735">nil</span><span class="op" id="1637738">,</span>&nbsp;<span class="ident" id="1637740">nil</span><span class="op" id="1637743">,</span>&nbsp;<span class="string" id="1637745">&#34;select&nbsp;(no&nbsp;cases)&#34;</span><span class="op" id="1637764">)</span>&nbsp;<span class="comment" id="1637766">//&nbsp;forever</span><br>
<span class="lineno"></span><span class="op" id="1637777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1637780">//&nbsp;overwrites&nbsp;return&nbsp;pc&nbsp;on&nbsp;stack&nbsp;to&nbsp;signal&nbsp;which&nbsp;case&nbsp;of&nbsp;the&nbsp;select</span><br>
<span class="lineno">180</span><span class="comment" id="1637848">//&nbsp;to&nbsp;run,&nbsp;so&nbsp;cannot&nbsp;appear&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1637905">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1637918">func</span>&nbsp;<span class="ident" id="1637923">selectgo</span><span class="op" id="1637931">(</span><span class="ident" id="1637932">sel</span>&nbsp;<span class="op" id="1637936">*</span><span class="ident" id="1637937">_select</span><span class="op" id="1637944">)</span>&nbsp;<span class="op" id="1637946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1637949">pc</span><span class="op" id="1637951">,</span>&nbsp;<span class="ident" id="1637953">offset</span>&nbsp;<span class="op" id="1637960">:=</span>&nbsp;<span class="ident" id="1637963">selectgoImpl</span><span class="op" id="1637975">(</span><span class="ident" id="1637976">sel</span><span class="op" id="1637979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1637982">*</span><span class="op" id="1637983">(</span><span class="op" id="1637984">*</span><span class="builtintype" id="1637985">bool</span><span class="op" id="1637989">)</span><span class="op" id="1637990">(</span><span class="ident" id="1637991">add</span><span class="op" id="1637994">(</span><span class="ident" id="1637995">unsafe</span><span class="op" id="1638001">.</span><span class="ident" id="1638002">Pointer</span><span class="op" id="1638009">(</span><span class="op" id="1638010">&amp;</span><span class="ident" id="1638011">sel</span><span class="op" id="1638014">)</span><span class="op" id="1638015">,</span>&nbsp;<span class="builtintype" id="1638017">uintptr</span><span class="op" id="1638024">(</span><span class="ident" id="1638025">offset</span><span class="op" id="1638031">)</span><span class="op" id="1638032">)</span><span class="op" id="1638033">)</span>&nbsp;<span class="op" id="1638035">=</span>&nbsp;<span class="builtintype" id="1638037">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638043">setcallerpc</span><span class="op" id="1638054">(</span><span class="ident" id="1638055">unsafe</span><span class="op" id="1638061">.</span><span class="ident" id="1638062">Pointer</span><span class="op" id="1638069">(</span><span class="op" id="1638070">&amp;</span><span class="ident" id="1638071">sel</span><span class="op" id="1638074">)</span><span class="op" id="1638075">,</span>&nbsp;<span class="ident" id="1638077">pc</span><span class="op" id="1638079">)</span><br>
<span class="lineno"></span><span class="op" id="1638081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1638084">//&nbsp;selectgoImpl&nbsp;returns&nbsp;scase.pc&nbsp;and&nbsp;scase.so&nbsp;for&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span><span class="comment" id="1638145">//&nbsp;case&nbsp;which&nbsp;fired.</span><br>
<span class="lineno">190</span><span class="keyword" id="1638166">func</span>&nbsp;<span class="ident" id="1638171">selectgoImpl</span><span class="op" id="1638183">(</span><span class="ident" id="1638184">sel</span>&nbsp;<span class="op" id="1638188">*</span><span class="ident" id="1638189">_select</span><span class="op" id="1638196">)</span>&nbsp;<span class="op" id="1638198">(</span><span class="builtintype" id="1638199">uintptr</span><span class="op" id="1638206">,</span>&nbsp;<span class="builtintype" id="1638208">uint16</span><span class="op" id="1638214">)</span>&nbsp;<span class="op" id="1638216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1638219">if</span>&nbsp;<span class="ident" id="1638222">debugSelect</span>&nbsp;<span class="op" id="1638234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1638238">print</span><span class="op" id="1638243">(</span><span class="string" id="1638244">&#34;select:&nbsp;sel=&#34;</span><span class="op" id="1638258">,</span>&nbsp;<span class="ident" id="1638260">sel</span><span class="op" id="1638263">,</span>&nbsp;<span class="string" id="1638265">&#34;\n&#34;</span><span class="op" id="1638269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1638272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638276">scaseslice</span>&nbsp;<span class="op" id="1638287">:=</span>&nbsp;<span class="ident" id="1638290">sliceStruct</span><span class="op" id="1638301">{</span><span class="ident" id="1638302">unsafe</span><span class="op" id="1638308">.</span><span class="ident" id="1638309">Pointer</span><span class="op" id="1638316">(</span><span class="op" id="1638317">&amp;</span><span class="ident" id="1638318">sel</span><span class="op" id="1638321">.</span><span class="ident" id="1638322">scase</span><span class="op" id="1638327">)</span><span class="op" id="1638328">,</span>&nbsp;<span class="builtintype" id="1638330">int</span><span class="op" id="1638333">(</span><span class="ident" id="1638334">sel</span><span class="op" id="1638337">.</span><span class="ident" id="1638338">ncase</span><span class="op" id="1638343">)</span><span class="op" id="1638344">,</span>&nbsp;<span class="builtintype" id="1638346">int</span><span class="op" id="1638349">(</span><span class="ident" id="1638350">sel</span><span class="op" id="1638353">.</span><span class="ident" id="1638354">ncase</span><span class="op" id="1638359">)</span><span class="op" id="1638360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638363">scases</span>&nbsp;<span class="op" id="1638370">:=</span>&nbsp;<span class="op" id="1638373">*</span><span class="op" id="1638374">(</span><span class="op" id="1638375">*</span><span class="op" id="1638376">[</span><span class="op" id="1638377">]</span><span class="ident" id="1638378">scase</span><span class="op" id="1638383">)</span><span class="op" id="1638384">(</span><span class="ident" id="1638385">unsafe</span><span class="op" id="1638391">.</span><span class="ident" id="1638392">Pointer</span><span class="op" id="1638399">(</span><span class="op" id="1638400">&amp;</span><span class="ident" id="1638401">scaseslice</span><span class="op" id="1638411">)</span><span class="op" id="1638412">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1638416">var</span>&nbsp;<span class="ident" id="1638420">t0</span>&nbsp;<span class="ident" id="1638423">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1638430">if</span>&nbsp;<span class="ident" id="1638433">blockprofilerate</span>&nbsp;<span class="op" id="1638450">&gt;</span>&nbsp;<span class="num" id="1638452">0</span>&nbsp;<span class="op" id="1638454">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638458">t0</span>&nbsp;<span class="op" id="1638461">=</span>&nbsp;<span class="ident" id="1638463">cputicks</span><span class="op" id="1638471">(</span><span class="op" id="1638472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1638476">for</span>&nbsp;<span class="ident" id="1638480">i</span>&nbsp;<span class="op" id="1638482">:=</span>&nbsp;<span class="num" id="1638485">0</span><span class="op" id="1638486">;</span>&nbsp;<span class="ident" id="1638488">i</span>&nbsp;<span class="op" id="1638490">&lt;</span>&nbsp;<span class="builtintype" id="1638492">int</span><span class="op" id="1638495">(</span><span class="ident" id="1638496">sel</span><span class="op" id="1638499">.</span><span class="ident" id="1638500">ncase</span><span class="op" id="1638505">)</span><span class="op" id="1638506">;</span>&nbsp;<span class="ident" id="1638508">i</span><span class="op" id="1638509">++</span>&nbsp;<span class="op" id="1638512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638517">scases</span><span class="op" id="1638523">[</span><span class="ident" id="1638524">i</span><span class="op" id="1638525">]</span><span class="op" id="1638526">.</span><span class="ident" id="1638527">releasetime</span>&nbsp;<span class="op" id="1638539">=</span>&nbsp;<span class="op" id="1638541">-</span><span class="num" id="1638542">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1638546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1638549">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1638553">//&nbsp;The&nbsp;compiler&nbsp;rewrites&nbsp;selects&nbsp;that&nbsp;statically&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1638608">//&nbsp;only&nbsp;0&nbsp;or&nbsp;1&nbsp;cases&nbsp;plus&nbsp;default&nbsp;into&nbsp;simpler&nbsp;constructs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1638668">//&nbsp;The&nbsp;only&nbsp;way&nbsp;we&nbsp;can&nbsp;end&nbsp;up&nbsp;with&nbsp;such&nbsp;small&nbsp;sel.ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1638725">//&nbsp;values&nbsp;here&nbsp;is&nbsp;for&nbsp;a&nbsp;larger&nbsp;select&nbsp;in&nbsp;which&nbsp;most&nbsp;channels</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1638787">//&nbsp;have&nbsp;been&nbsp;nilled&nbsp;out.&nbsp;&nbsp;The&nbsp;general&nbsp;code&nbsp;handles&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1638845">//&nbsp;cases&nbsp;correctly,&nbsp;and&nbsp;they&nbsp;are&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1638905">//&nbsp;optimizing&nbsp;(and&nbsp;needing&nbsp;to&nbsp;test).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1638944">//&nbsp;generate&nbsp;permuted&nbsp;order</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1638972">pollslice</span>&nbsp;<span class="op" id="1638982">:=</span>&nbsp;<span class="ident" id="1638985">sliceStruct</span><span class="op" id="1638996">{</span><span class="ident" id="1638997">unsafe</span><span class="op" id="1639003">.</span><span class="ident" id="1639004">Pointer</span><span class="op" id="1639011">(</span><span class="ident" id="1639012">sel</span><span class="op" id="1639015">.</span><span class="ident" id="1639016">pollorder</span><span class="op" id="1639025">)</span><span class="op" id="1639026">,</span>&nbsp;<span class="builtintype" id="1639028">int</span><span class="op" id="1639031">(</span><span class="ident" id="1639032">sel</span><span class="op" id="1639035">.</span><span class="ident" id="1639036">ncase</span><span class="op" id="1639041">)</span><span class="op" id="1639042">,</span>&nbsp;<span class="builtintype" id="1639044">int</span><span class="op" id="1639047">(</span><span class="ident" id="1639048">sel</span><span class="op" id="1639051">.</span><span class="ident" id="1639052">ncase</span><span class="op" id="1639057">)</span><span class="op" id="1639058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639061">pollorder</span>&nbsp;<span class="op" id="1639071">:=</span>&nbsp;<span class="op" id="1639074">*</span><span class="op" id="1639075">(</span><span class="op" id="1639076">*</span><span class="op" id="1639077">[</span><span class="op" id="1639078">]</span><span class="builtintype" id="1639079">uint16</span><span class="op" id="1639085">)</span><span class="op" id="1639086">(</span><span class="ident" id="1639087">unsafe</span><span class="op" id="1639093">.</span><span class="ident" id="1639094">Pointer</span><span class="op" id="1639101">(</span><span class="op" id="1639102">&amp;</span><span class="ident" id="1639103">pollslice</span><span class="op" id="1639112">)</span><span class="op" id="1639113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639116">for</span>&nbsp;<span class="ident" id="1639120">i</span>&nbsp;<span class="op" id="1639122">:=</span>&nbsp;<span class="num" id="1639125">0</span><span class="op" id="1639126">;</span>&nbsp;<span class="ident" id="1639128">i</span>&nbsp;<span class="op" id="1639130">&lt;</span>&nbsp;<span class="builtintype" id="1639132">int</span><span class="op" id="1639135">(</span><span class="ident" id="1639136">sel</span><span class="op" id="1639139">.</span><span class="ident" id="1639140">ncase</span><span class="op" id="1639145">)</span><span class="op" id="1639146">;</span>&nbsp;<span class="ident" id="1639148">i</span><span class="op" id="1639149">++</span>&nbsp;<span class="op" id="1639152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639156">pollorder</span><span class="op" id="1639165">[</span><span class="ident" id="1639166">i</span><span class="op" id="1639167">]</span>&nbsp;<span class="op" id="1639169">=</span>&nbsp;<span class="builtintype" id="1639171">uint16</span><span class="op" id="1639177">(</span><span class="ident" id="1639178">i</span><span class="op" id="1639179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1639182">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639185">for</span>&nbsp;<span class="ident" id="1639189">i</span>&nbsp;<span class="op" id="1639191">:=</span>&nbsp;<span class="num" id="1639194">1</span><span class="op" id="1639195">;</span>&nbsp;<span class="ident" id="1639197">i</span>&nbsp;<span class="op" id="1639199">&lt;</span>&nbsp;<span class="builtintype" id="1639201">int</span><span class="op" id="1639204">(</span><span class="ident" id="1639205">sel</span><span class="op" id="1639208">.</span><span class="ident" id="1639209">ncase</span><span class="op" id="1639214">)</span><span class="op" id="1639215">;</span>&nbsp;<span class="ident" id="1639217">i</span><span class="op" id="1639218">++</span>&nbsp;<span class="op" id="1639221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639225">o</span>&nbsp;<span class="op" id="1639227">:=</span>&nbsp;<span class="ident" id="1639230">pollorder</span><span class="op" id="1639239">[</span><span class="ident" id="1639240">i</span><span class="op" id="1639241">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639245">j</span>&nbsp;<span class="op" id="1639247">:=</span>&nbsp;<span class="builtintype" id="1639250">int</span><span class="op" id="1639253">(</span><span class="ident" id="1639254">fastrand1</span><span class="op" id="1639263">(</span><span class="op" id="1639264">)</span><span class="op" id="1639265">)</span>&nbsp;<span class="op" id="1639267">%</span>&nbsp;<span class="op" id="1639269">(</span><span class="ident" id="1639270">i</span>&nbsp;<span class="op" id="1639272">+</span>&nbsp;<span class="num" id="1639274">1</span><span class="op" id="1639275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639279">pollorder</span><span class="op" id="1639288">[</span><span class="ident" id="1639289">i</span><span class="op" id="1639290">]</span>&nbsp;<span class="op" id="1639292">=</span>&nbsp;<span class="ident" id="1639294">pollorder</span><span class="op" id="1639303">[</span><span class="ident" id="1639304">j</span><span class="op" id="1639305">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639309">pollorder</span><span class="op" id="1639318">[</span><span class="ident" id="1639319">j</span><span class="op" id="1639320">]</span>&nbsp;<span class="op" id="1639322">=</span>&nbsp;<span class="ident" id="1639324">o</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1639327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1639331">//&nbsp;sort&nbsp;the&nbsp;cases&nbsp;by&nbsp;Hchan&nbsp;address&nbsp;to&nbsp;get&nbsp;the&nbsp;locking&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1639393">//&nbsp;simple&nbsp;heap&nbsp;sort,&nbsp;to&nbsp;guarantee&nbsp;n&nbsp;log&nbsp;n&nbsp;time&nbsp;and&nbsp;constant&nbsp;stack&nbsp;footprint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639471">lockslice</span>&nbsp;<span class="op" id="1639481">:=</span>&nbsp;<span class="ident" id="1639484">sliceStruct</span><span class="op" id="1639495">{</span><span class="ident" id="1639496">unsafe</span><span class="op" id="1639502">.</span><span class="ident" id="1639503">Pointer</span><span class="op" id="1639510">(</span><span class="ident" id="1639511">sel</span><span class="op" id="1639514">.</span><span class="ident" id="1639515">lockorder</span><span class="op" id="1639524">)</span><span class="op" id="1639525">,</span>&nbsp;<span class="builtintype" id="1639527">int</span><span class="op" id="1639530">(</span><span class="ident" id="1639531">sel</span><span class="op" id="1639534">.</span><span class="ident" id="1639535">ncase</span><span class="op" id="1639540">)</span><span class="op" id="1639541">,</span>&nbsp;<span class="builtintype" id="1639543">int</span><span class="op" id="1639546">(</span><span class="ident" id="1639547">sel</span><span class="op" id="1639550">.</span><span class="ident" id="1639551">ncase</span><span class="op" id="1639556">)</span><span class="op" id="1639557">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639560">lockorder</span>&nbsp;<span class="op" id="1639570">:=</span>&nbsp;<span class="op" id="1639573">*</span><span class="op" id="1639574">(</span><span class="op" id="1639575">*</span><span class="op" id="1639576">[</span><span class="op" id="1639577">]</span><span class="op" id="1639578">*</span><span class="ident" id="1639579">hchan</span><span class="op" id="1639584">)</span><span class="op" id="1639585">(</span><span class="ident" id="1639586">unsafe</span><span class="op" id="1639592">.</span><span class="ident" id="1639593">Pointer</span><span class="op" id="1639600">(</span><span class="op" id="1639601">&amp;</span><span class="ident" id="1639602">lockslice</span><span class="op" id="1639611">)</span><span class="op" id="1639612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639615">for</span>&nbsp;<span class="ident" id="1639619">i</span>&nbsp;<span class="op" id="1639621">:=</span>&nbsp;<span class="num" id="1639624">0</span><span class="op" id="1639625">;</span>&nbsp;<span class="ident" id="1639627">i</span>&nbsp;<span class="op" id="1639629">&lt;</span>&nbsp;<span class="builtintype" id="1639631">int</span><span class="op" id="1639634">(</span><span class="ident" id="1639635">sel</span><span class="op" id="1639638">.</span><span class="ident" id="1639639">ncase</span><span class="op" id="1639644">)</span><span class="op" id="1639645">;</span>&nbsp;<span class="ident" id="1639647">i</span><span class="op" id="1639648">++</span>&nbsp;<span class="op" id="1639651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639655">j</span>&nbsp;<span class="op" id="1639657">:=</span>&nbsp;<span class="ident" id="1639660">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639664">c</span>&nbsp;<span class="op" id="1639666">:=</span>&nbsp;<span class="ident" id="1639669">scases</span><span class="op" id="1639675">[</span><span class="ident" id="1639676">j</span><span class="op" id="1639677">]</span><span class="op" id="1639678">.</span><span class="ident" id="1639679">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639687">for</span>&nbsp;<span class="ident" id="1639691">j</span>&nbsp;<span class="op" id="1639693">&gt;</span>&nbsp;<span class="num" id="1639695">0</span>&nbsp;<span class="op" id="1639697">&amp;&amp;</span>&nbsp;<span class="ident" id="1639700">lockorder</span><span class="op" id="1639709">[</span><span class="op" id="1639710">(</span><span class="ident" id="1639711">j</span><span class="op" id="1639712">-</span><span class="num" id="1639713">1</span><span class="op" id="1639714">)</span><span class="op" id="1639715">/</span><span class="num" id="1639716">2</span><span class="op" id="1639717">]</span><span class="op" id="1639718">.</span><span class="ident" id="1639719">sortkey</span><span class="op" id="1639726">(</span><span class="op" id="1639727">)</span>&nbsp;<span class="op" id="1639729">&lt;</span>&nbsp;<span class="ident" id="1639731">c</span><span class="op" id="1639732">.</span><span class="ident" id="1639733">sortkey</span><span class="op" id="1639740">(</span><span class="op" id="1639741">)</span>&nbsp;<span class="op" id="1639743">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639748">k</span>&nbsp;<span class="op" id="1639750">:=</span>&nbsp;<span class="op" id="1639753">(</span><span class="ident" id="1639754">j</span>&nbsp;<span class="op" id="1639756">-</span>&nbsp;<span class="num" id="1639758">1</span><span class="op" id="1639759">)</span>&nbsp;<span class="op" id="1639761">/</span>&nbsp;<span class="num" id="1639763">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639768">lockorder</span><span class="op" id="1639777">[</span><span class="ident" id="1639778">j</span><span class="op" id="1639779">]</span>&nbsp;<span class="op" id="1639781">=</span>&nbsp;<span class="ident" id="1639783">lockorder</span><span class="op" id="1639792">[</span><span class="ident" id="1639793">k</span><span class="op" id="1639794">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639799">j</span>&nbsp;<span class="op" id="1639801">=</span>&nbsp;<span class="ident" id="1639803">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1639807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639811">lockorder</span><span class="op" id="1639820">[</span><span class="ident" id="1639821">j</span><span class="op" id="1639822">]</span>&nbsp;<span class="op" id="1639824">=</span>&nbsp;<span class="ident" id="1639826">c</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1639829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639832">for</span>&nbsp;<span class="ident" id="1639836">i</span>&nbsp;<span class="op" id="1639838">:=</span>&nbsp;<span class="builtintype" id="1639841">int</span><span class="op" id="1639844">(</span><span class="ident" id="1639845">sel</span><span class="op" id="1639848">.</span><span class="ident" id="1639849">ncase</span><span class="op" id="1639854">)</span>&nbsp;<span class="op" id="1639856">-</span>&nbsp;<span class="num" id="1639858">1</span><span class="op" id="1639859">;</span>&nbsp;<span class="ident" id="1639861">i</span>&nbsp;<span class="op" id="1639863">&gt;=</span>&nbsp;<span class="num" id="1639866">0</span><span class="op" id="1639867">;</span>&nbsp;<span class="ident" id="1639869">i</span><span class="op" id="1639870">--</span>&nbsp;<span class="op" id="1639873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639877">c</span>&nbsp;<span class="op" id="1639879">:=</span>&nbsp;<span class="ident" id="1639882">lockorder</span><span class="op" id="1639891">[</span><span class="ident" id="1639892">i</span><span class="op" id="1639893">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639897">lockorder</span><span class="op" id="1639906">[</span><span class="ident" id="1639907">i</span><span class="op" id="1639908">]</span>&nbsp;<span class="op" id="1639910">=</span>&nbsp;<span class="ident" id="1639912">lockorder</span><span class="op" id="1639921">[</span><span class="num" id="1639922">0</span><span class="op" id="1639923">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639927">j</span>&nbsp;<span class="op" id="1639929">:=</span>&nbsp;<span class="num" id="1639932">0</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639936">for</span>&nbsp;<span class="op" id="1639940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1639945">k</span>&nbsp;<span class="op" id="1639947">:=</span>&nbsp;<span class="ident" id="1639950">j</span><span class="op" id="1639951">*</span><span class="num" id="1639952">2</span>&nbsp;<span class="op" id="1639954">+</span>&nbsp;<span class="num" id="1639956">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639961">if</span>&nbsp;<span class="ident" id="1639964">k</span>&nbsp;<span class="op" id="1639966">&gt;=</span>&nbsp;<span class="ident" id="1639969">i</span>&nbsp;<span class="op" id="1639971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639977">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1639986">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1639991">if</span>&nbsp;<span class="ident" id="1639994">k</span><span class="op" id="1639995">+</span><span class="num" id="1639996">1</span>&nbsp;<span class="op" id="1639998">&lt;</span>&nbsp;<span class="ident" id="1640000">i</span>&nbsp;<span class="op" id="1640002">&amp;&amp;</span>&nbsp;<span class="ident" id="1640005">lockorder</span><span class="op" id="1640014">[</span><span class="ident" id="1640015">k</span><span class="op" id="1640016">]</span><span class="op" id="1640017">.</span><span class="ident" id="1640018">sortkey</span><span class="op" id="1640025">(</span><span class="op" id="1640026">)</span>&nbsp;<span class="op" id="1640028">&lt;</span>&nbsp;<span class="ident" id="1640030">lockorder</span><span class="op" id="1640039">[</span><span class="ident" id="1640040">k</span><span class="op" id="1640041">+</span><span class="num" id="1640042">1</span><span class="op" id="1640043">]</span><span class="op" id="1640044">.</span><span class="ident" id="1640045">sortkey</span><span class="op" id="1640052">(</span><span class="op" id="1640053">)</span>&nbsp;<span class="op" id="1640055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640061">k</span><span class="op" id="1640062">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640073">if</span>&nbsp;<span class="ident" id="1640076">c</span><span class="op" id="1640077">.</span><span class="ident" id="1640078">sortkey</span><span class="op" id="1640085">(</span><span class="op" id="1640086">)</span>&nbsp;<span class="op" id="1640088">&lt;</span>&nbsp;<span class="ident" id="1640090">lockorder</span><span class="op" id="1640099">[</span><span class="ident" id="1640100">k</span><span class="op" id="1640101">]</span><span class="op" id="1640102">.</span><span class="ident" id="1640103">sortkey</span><span class="op" id="1640110">(</span><span class="op" id="1640111">)</span>&nbsp;<span class="op" id="1640113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640119">lockorder</span><span class="op" id="1640128">[</span><span class="ident" id="1640129">j</span><span class="op" id="1640130">]</span>&nbsp;<span class="op" id="1640132">=</span>&nbsp;<span class="ident" id="1640134">lockorder</span><span class="op" id="1640143">[</span><span class="ident" id="1640144">k</span><span class="op" id="1640145">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640151">j</span>&nbsp;<span class="op" id="1640153">=</span>&nbsp;<span class="ident" id="1640155">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640161">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640178">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640186">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640190">lockorder</span><span class="op" id="1640199">[</span><span class="ident" id="1640200">j</span><span class="op" id="1640201">]</span>&nbsp;<span class="op" id="1640203">=</span>&nbsp;<span class="ident" id="1640205">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1640211">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;:=&nbsp;0;&nbsp;i+1&nbsp;&lt;&nbsp;int(sel.ncase);&nbsp;i++&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;lockorder[i].sortkey()&nbsp;&gt;&nbsp;lockorder[i+1].sortkey()&nbsp;{<br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#34;i=&#34;,&nbsp;i,&nbsp;&#34;&nbsp;x=&#34;,&nbsp;lockorder[i],&nbsp;&#34;&nbsp;y=&#34;,&nbsp;lockorder[i+1],&nbsp;&#34;\n&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gothrow(&#34;select:&nbsp;broken&nbsp;sort&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;*/</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1640433">//&nbsp;lock&nbsp;all&nbsp;the&nbsp;channels&nbsp;involved&nbsp;in&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640482">sellock</span><span class="op" id="1640489">(</span><span class="ident" id="1640490">sel</span><span class="op" id="1640493">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640497">var</span>&nbsp;<span class="op" id="1640501">(</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640505">gp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640512">*</span><span class="ident" id="1640513">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640517">done</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1640524">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640533">sg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640540">*</span><span class="ident" id="1640541">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640549">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640556">*</span><span class="ident" id="1640557">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640565">k</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640572">*</span><span class="ident" id="1640573">scase</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640581">sglist</span>&nbsp;<span class="op" id="1640588">*</span><span class="ident" id="1640589">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640597">sgnext</span>&nbsp;<span class="op" id="1640604">*</span><span class="ident" id="1640605">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640612">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1640615">loop</span><span class="op" id="1640619">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1640622">//&nbsp;pass&nbsp;1&nbsp;-&nbsp;look&nbsp;for&nbsp;something&nbsp;already&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640670">var</span>&nbsp;<span class="ident" id="1640674">dfl</span>&nbsp;<span class="op" id="1640678">*</span><span class="ident" id="1640679">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640686">var</span>&nbsp;<span class="ident" id="1640690">cas</span>&nbsp;<span class="op" id="1640694">*</span><span class="ident" id="1640695">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640702">for</span>&nbsp;<span class="ident" id="1640706">i</span>&nbsp;<span class="op" id="1640708">:=</span>&nbsp;<span class="num" id="1640711">0</span><span class="op" id="1640712">;</span>&nbsp;<span class="ident" id="1640714">i</span>&nbsp;<span class="op" id="1640716">&lt;</span>&nbsp;<span class="builtintype" id="1640718">int</span><span class="op" id="1640721">(</span><span class="ident" id="1640722">sel</span><span class="op" id="1640725">.</span><span class="ident" id="1640726">ncase</span><span class="op" id="1640731">)</span><span class="op" id="1640732">;</span>&nbsp;<span class="ident" id="1640734">i</span><span class="op" id="1640735">++</span>&nbsp;<span class="op" id="1640738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640742">cas</span>&nbsp;<span class="op" id="1640746">=</span>&nbsp;<span class="op" id="1640748">&amp;</span><span class="ident" id="1640749">scases</span><span class="op" id="1640755">[</span><span class="ident" id="1640756">pollorder</span><span class="op" id="1640765">[</span><span class="ident" id="1640766">i</span><span class="op" id="1640767">]</span><span class="op" id="1640768">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640772">c</span>&nbsp;<span class="op" id="1640774">=</span>&nbsp;<span class="ident" id="1640776">cas</span><span class="op" id="1640779">.</span><span class="ident" id="1640780">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640789">switch</span>&nbsp;<span class="ident" id="1640796">cas</span><span class="op" id="1640799">.</span><span class="ident" id="1640800">kind</span>&nbsp;<span class="op" id="1640805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640809">case</span>&nbsp;<span class="ident" id="1640814">_CaseRecv</span><span class="op" id="1640823">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640828">if</span>&nbsp;<span class="ident" id="1640831">c</span><span class="op" id="1640832">.</span><span class="ident" id="1640833">dataqsiz</span>&nbsp;<span class="op" id="1640842">&gt;</span>&nbsp;<span class="num" id="1640844">0</span>&nbsp;<span class="op" id="1640846">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640852">if</span>&nbsp;<span class="ident" id="1640855">c</span><span class="op" id="1640856">.</span><span class="ident" id="1640857">qcount</span>&nbsp;<span class="op" id="1640864">&gt;</span>&nbsp;<span class="num" id="1640866">0</span>&nbsp;<span class="op" id="1640868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640875">goto</span>&nbsp;<span class="ident" id="1640880">asyncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640899">}</span>&nbsp;<span class="keyword" id="1640901">else</span>&nbsp;<span class="op" id="1640906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1640912">sg</span>&nbsp;<span class="op" id="1640915">=</span>&nbsp;<span class="ident" id="1640917">c</span><span class="op" id="1640918">.</span><span class="ident" id="1640919">sendq</span><span class="op" id="1640924">.</span><span class="ident" id="1640925">dequeue</span><span class="op" id="1640932">(</span><span class="op" id="1640933">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640939">if</span>&nbsp;<span class="ident" id="1640942">sg</span>&nbsp;<span class="op" id="1640945">!=</span>&nbsp;<span class="ident" id="1640948">nil</span>&nbsp;<span class="op" id="1640952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640959">goto</span>&nbsp;<span class="ident" id="1640964">syncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1640982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1640987">if</span>&nbsp;<span class="ident" id="1640990">c</span><span class="op" id="1640991">.</span><span class="ident" id="1640992">closed</span>&nbsp;<span class="op" id="1640999">!=</span>&nbsp;<span class="num" id="1641002">0</span>&nbsp;<span class="op" id="1641004">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641010">goto</span>&nbsp;<span class="ident" id="1641015">rclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641030">case</span>&nbsp;<span class="ident" id="1641035">_CaseSend</span><span class="op" id="1641044">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641049">if</span>&nbsp;<span class="ident" id="1641052">raceenabled</span>&nbsp;<span class="op" id="1641064">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641070">racereadpc</span><span class="op" id="1641080">(</span><span class="ident" id="1641081">unsafe</span><span class="op" id="1641087">.</span><span class="ident" id="1641088">Pointer</span><span class="op" id="1641095">(</span><span class="ident" id="1641096">c</span><span class="op" id="1641097">)</span><span class="op" id="1641098">,</span>&nbsp;<span class="ident" id="1641100">cas</span><span class="op" id="1641103">.</span><span class="ident" id="1641104">pc</span><span class="op" id="1641106">,</span>&nbsp;<span class="ident" id="1641108">chansendpc</span><span class="op" id="1641118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641128">if</span>&nbsp;<span class="ident" id="1641131">c</span><span class="op" id="1641132">.</span><span class="ident" id="1641133">closed</span>&nbsp;<span class="op" id="1641140">!=</span>&nbsp;<span class="num" id="1641143">0</span>&nbsp;<span class="op" id="1641145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641151">goto</span>&nbsp;<span class="ident" id="1641156">sclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641166">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641171">if</span>&nbsp;<span class="ident" id="1641174">c</span><span class="op" id="1641175">.</span><span class="ident" id="1641176">dataqsiz</span>&nbsp;<span class="op" id="1641185">&gt;</span>&nbsp;<span class="num" id="1641187">0</span>&nbsp;<span class="op" id="1641189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641195">if</span>&nbsp;<span class="ident" id="1641198">c</span><span class="op" id="1641199">.</span><span class="ident" id="1641200">qcount</span>&nbsp;<span class="op" id="1641207">&lt;</span>&nbsp;<span class="ident" id="1641209">c</span><span class="op" id="1641210">.</span><span class="ident" id="1641211">dataqsiz</span>&nbsp;<span class="op" id="1641220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641227">goto</span>&nbsp;<span class="ident" id="1641232">asyncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641251">}</span>&nbsp;<span class="keyword" id="1641253">else</span>&nbsp;<span class="op" id="1641258">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641264">sg</span>&nbsp;<span class="op" id="1641267">=</span>&nbsp;<span class="ident" id="1641269">c</span><span class="op" id="1641270">.</span><span class="ident" id="1641271">recvq</span><span class="op" id="1641276">.</span><span class="ident" id="1641277">dequeue</span><span class="op" id="1641284">(</span><span class="op" id="1641285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641291">if</span>&nbsp;<span class="ident" id="1641294">sg</span>&nbsp;<span class="op" id="1641297">!=</span>&nbsp;<span class="ident" id="1641300">nil</span>&nbsp;<span class="op" id="1641304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641311">goto</span>&nbsp;<span class="ident" id="1641316">syncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641334">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641339">case</span>&nbsp;<span class="ident" id="1641344">_CaseDefault</span><span class="op" id="1641356">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641361">dfl</span>&nbsp;<span class="op" id="1641365">=</span>&nbsp;<span class="ident" id="1641367">cas</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641376">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641380">if</span>&nbsp;<span class="ident" id="1641383">dfl</span>&nbsp;<span class="op" id="1641387">!=</span>&nbsp;<span class="ident" id="1641390">nil</span>&nbsp;<span class="op" id="1641394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641398">selunlock</span><span class="op" id="1641407">(</span><span class="ident" id="1641408">sel</span><span class="op" id="1641411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641415">cas</span>&nbsp;<span class="op" id="1641419">=</span>&nbsp;<span class="ident" id="1641421">dfl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641427">goto</span>&nbsp;<span class="ident" id="1641432">retc</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1641442">//&nbsp;pass&nbsp;2&nbsp;-&nbsp;enqueue&nbsp;on&nbsp;all&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641476">gp</span>&nbsp;<span class="op" id="1641479">=</span>&nbsp;<span class="ident" id="1641481">getg</span><span class="op" id="1641485">(</span><span class="op" id="1641486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641489">done</span>&nbsp;<span class="op" id="1641494">=</span>&nbsp;<span class="num" id="1641496">0</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641499">for</span>&nbsp;<span class="ident" id="1641503">i</span>&nbsp;<span class="op" id="1641505">:=</span>&nbsp;<span class="num" id="1641508">0</span><span class="op" id="1641509">;</span>&nbsp;<span class="ident" id="1641511">i</span>&nbsp;<span class="op" id="1641513">&lt;</span>&nbsp;<span class="builtintype" id="1641515">int</span><span class="op" id="1641518">(</span><span class="ident" id="1641519">sel</span><span class="op" id="1641522">.</span><span class="ident" id="1641523">ncase</span><span class="op" id="1641528">)</span><span class="op" id="1641529">;</span>&nbsp;<span class="ident" id="1641531">i</span><span class="op" id="1641532">++</span>&nbsp;<span class="op" id="1641535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641539">cas</span>&nbsp;<span class="op" id="1641543">=</span>&nbsp;<span class="op" id="1641545">&amp;</span><span class="ident" id="1641546">scases</span><span class="op" id="1641552">[</span><span class="ident" id="1641553">pollorder</span><span class="op" id="1641562">[</span><span class="ident" id="1641563">i</span><span class="op" id="1641564">]</span><span class="op" id="1641565">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641569">c</span>&nbsp;<span class="op" id="1641571">=</span>&nbsp;<span class="ident" id="1641573">cas</span><span class="op" id="1641576">.</span><span class="ident" id="1641577">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641585">sg</span>&nbsp;<span class="op" id="1641588">:=</span>&nbsp;<span class="ident" id="1641591">acquireSudog</span><span class="op" id="1641603">(</span><span class="op" id="1641604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641608">sg</span><span class="op" id="1641610">.</span><span class="ident" id="1641611">g</span>&nbsp;<span class="op" id="1641613">=</span>&nbsp;<span class="ident" id="1641615">gp</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1641620">//&nbsp;Note:&nbsp;selectdone&nbsp;is&nbsp;adjusted&nbsp;for&nbsp;stack&nbsp;copies&nbsp;in&nbsp;stack.c:adjustsudogs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641695">sg</span><span class="op" id="1641697">.</span><span class="ident" id="1641698">selectdone</span>&nbsp;<span class="op" id="1641709">=</span>&nbsp;<span class="op" id="1641711">(</span><span class="op" id="1641712">*</span><span class="builtintype" id="1641713">uint32</span><span class="op" id="1641719">)</span><span class="op" id="1641720">(</span><span class="ident" id="1641721">noescape</span><span class="op" id="1641729">(</span><span class="ident" id="1641730">unsafe</span><span class="op" id="1641736">.</span><span class="ident" id="1641737">Pointer</span><span class="op" id="1641744">(</span><span class="op" id="1641745">&amp;</span><span class="ident" id="1641746">done</span><span class="op" id="1641750">)</span><span class="op" id="1641751">)</span><span class="op" id="1641752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641756">sg</span><span class="op" id="1641758">.</span><span class="ident" id="1641759">elem</span>&nbsp;<span class="op" id="1641764">=</span>&nbsp;<span class="ident" id="1641766">cas</span><span class="op" id="1641769">.</span><span class="ident" id="1641770">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641777">sg</span><span class="op" id="1641779">.</span><span class="ident" id="1641780">releasetime</span>&nbsp;<span class="op" id="1641792">=</span>&nbsp;<span class="num" id="1641794">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641798">if</span>&nbsp;<span class="ident" id="1641801">t0</span>&nbsp;<span class="op" id="1641804">!=</span>&nbsp;<span class="num" id="1641807">0</span>&nbsp;<span class="op" id="1641809">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641814">sg</span><span class="op" id="1641816">.</span><span class="ident" id="1641817">releasetime</span>&nbsp;<span class="op" id="1641829">=</span>&nbsp;<span class="op" id="1641831">-</span><span class="num" id="1641832">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641840">sg</span><span class="op" id="1641842">.</span><span class="ident" id="1641843">waitlink</span>&nbsp;<span class="op" id="1641852">=</span>&nbsp;<span class="ident" id="1641854">gp</span><span class="op" id="1641856">.</span><span class="ident" id="1641857">waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641867">gp</span><span class="op" id="1641869">.</span><span class="ident" id="1641870">waiting</span>&nbsp;<span class="op" id="1641878">=</span>&nbsp;<span class="ident" id="1641880">sg</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641886">switch</span>&nbsp;<span class="ident" id="1641893">cas</span><span class="op" id="1641896">.</span><span class="ident" id="1641897">kind</span>&nbsp;<span class="op" id="1641902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641906">case</span>&nbsp;<span class="ident" id="1641911">_CaseRecv</span><span class="op" id="1641920">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641925">c</span><span class="op" id="1641926">.</span><span class="ident" id="1641927">recvq</span><span class="op" id="1641932">.</span><span class="ident" id="1641933">enqueue</span><span class="op" id="1641940">(</span><span class="ident" id="1641941">sg</span><span class="op" id="1641943">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1641948">case</span>&nbsp;<span class="ident" id="1641953">_CaseSend</span><span class="op" id="1641962">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1641967">c</span><span class="op" id="1641968">.</span><span class="ident" id="1641969">sendq</span><span class="op" id="1641974">.</span><span class="ident" id="1641975">enqueue</span><span class="op" id="1641982">(</span><span class="ident" id="1641983">sg</span><span class="op" id="1641985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1641996">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;wake&nbsp;us&nbsp;up</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1642031">gp</span><span class="op" id="1642033">.</span><span class="ident" id="1642034">param</span>&nbsp;<span class="op" id="1642040">=</span>&nbsp;<span class="ident" id="1642042">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1642047">gopark</span><span class="op" id="1642053">(</span><span class="ident" id="1642054">unsafe</span><span class="op" id="1642060">.</span><span class="ident" id="1642061">Pointer</span><span class="op" id="1642068">(</span><span class="ident" id="1642069">funcPC</span><span class="op" id="1642075">(</span><span class="ident" id="1642076">selparkcommit</span><span class="op" id="1642089">)</span><span class="op" id="1642090">)</span><span class="op" id="1642091">,</span>&nbsp;<span class="ident" id="1642093">unsafe</span><span class="op" id="1642099">.</span><span class="ident" id="1642100">Pointer</span><span class="op" id="1642107">(</span><span class="ident" id="1642108">sel</span><span class="op" id="1642111">)</span><span class="op" id="1642112">,</span>&nbsp;<span class="string" id="1642114">&#34;select&#34;</span><span class="op" id="1642122">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1642126">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1642149">sellock</span><span class="op" id="1642156">(</span><span class="ident" id="1642157">sel</span><span class="op" id="1642160">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1642163">sg</span>&nbsp;<span class="op" id="1642166">=</span>&nbsp;<span class="op" id="1642168">(</span><span class="op" id="1642169">*</span><span class="ident" id="1642170">sudog</span><span class="op" id="1642175">)</span><span class="op" id="1642176">(</span><span class="ident" id="1642177">gp</span><span class="op" id="1642179">.</span><span class="ident" id="1642180">param</span><span class="op" id="1642185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1642188">gp</span><span class="op" id="1642190">.</span><span class="ident" id="1642191">param</span>&nbsp;<span class="op" id="1642197">=</span>&nbsp;<span class="ident" id="1642199">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1642205">//&nbsp;pass&nbsp;3&nbsp;-&nbsp;dequeue&nbsp;from&nbsp;unsuccessful&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1642250">//&nbsp;otherwise&nbsp;they&nbsp;stack&nbsp;up&nbsp;on&nbsp;quiet&nbsp;channels</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1642296">//&nbsp;record&nbsp;the&nbsp;successful&nbsp;case,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1642336">//&nbsp;We&nbsp;singly-linked&nbsp;up&nbsp;the&nbsp;SudoGs&nbsp;in&nbsp;case&nbsp;order,&nbsp;so&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1642394">//&nbsp;iterating&nbsp;through&nbsp;the&nbsp;linked&nbsp;list&nbsp;they&nbsp;are&nbsp;in&nbsp;reverse&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1642459">cas</span>&nbsp;<span class="op" id="1642463">=</span>&nbsp;<span class="ident" id="1642465">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1642470">sglist</span>&nbsp;<span class="op" id="1642477">=</span>&nbsp;<span class="ident" id="1642479">gp</span><span class="op" id="1642481">.</span><span class="ident" id="1642482">waiting</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1642491">//&nbsp;Clear&nbsp;all&nbsp;selectdone&nbsp;and&nbsp;elem&nbsp;before&nbsp;unlinking&nbsp;from&nbsp;gp.waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1642559">//&nbsp;They&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;being&nbsp;put&nbsp;back&nbsp;into&nbsp;the&nbsp;sudog&nbsp;cache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1642628">//&nbsp;Clear&nbsp;before&nbsp;unlinking,&nbsp;because&nbsp;if&nbsp;a&nbsp;stack&nbsp;copy&nbsp;happens&nbsp;after&nbsp;the&nbsp;unlink,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1642706">//&nbsp;they&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;they&nbsp;will&nbsp;be&nbsp;left&nbsp;pointing&nbsp;to&nbsp;the&nbsp;old&nbsp;stack,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1642781">//&nbsp;which&nbsp;creates&nbsp;dangling&nbsp;pointers,&nbsp;which&nbsp;may&nbsp;be&nbsp;detected&nbsp;by&nbsp;the</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1642847">//&nbsp;garbage&nbsp;collector.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1642870">for</span>&nbsp;<span class="ident" id="1642874">sg1</span>&nbsp;<span class="op" id="1642878">:=</span>&nbsp;<span class="ident" id="1642881">gp</span><span class="op" id="1642883">.</span><span class="ident" id="1642884">waiting</span><span class="op" id="1642891">;</span>&nbsp;<span class="ident" id="1642893">sg1</span>&nbsp;<span class="op" id="1642897">!=</span>&nbsp;<span class="ident" id="1642900">nil</span><span class="op" id="1642903">;</span>&nbsp;<span class="ident" id="1642905">sg1</span>&nbsp;<span class="op" id="1642909">=</span>&nbsp;<span class="ident" id="1642911">sg1</span><span class="op" id="1642914">.</span><span class="ident" id="1642915">waitlink</span>&nbsp;<span class="op" id="1642924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1642928">sg1</span><span class="op" id="1642931">.</span><span class="ident" id="1642932">selectdone</span>&nbsp;<span class="op" id="1642943">=</span>&nbsp;<span class="ident" id="1642945">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1642951">sg1</span><span class="op" id="1642954">.</span><span class="ident" id="1642955">elem</span>&nbsp;<span class="op" id="1642960">=</span>&nbsp;<span class="ident" id="1642962">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1642967">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1642970">gp</span><span class="op" id="1642972">.</span><span class="ident" id="1642973">waiting</span>&nbsp;<span class="op" id="1642981">=</span>&nbsp;<span class="ident" id="1642983">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1642988">for</span>&nbsp;<span class="ident" id="1642992">i</span>&nbsp;<span class="op" id="1642994">:=</span>&nbsp;<span class="builtintype" id="1642997">int</span><span class="op" id="1643000">(</span><span class="ident" id="1643001">sel</span><span class="op" id="1643004">.</span><span class="ident" id="1643005">ncase</span><span class="op" id="1643010">)</span>&nbsp;<span class="op" id="1643012">-</span>&nbsp;<span class="num" id="1643014">1</span><span class="op" id="1643015">;</span>&nbsp;<span class="ident" id="1643017">i</span>&nbsp;<span class="op" id="1643019">&gt;=</span>&nbsp;<span class="num" id="1643022">0</span><span class="op" id="1643023">;</span>&nbsp;<span class="ident" id="1643025">i</span><span class="op" id="1643026">--</span>&nbsp;<span class="op" id="1643029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643033">k</span>&nbsp;<span class="op" id="1643035">=</span>&nbsp;<span class="op" id="1643037">&amp;</span><span class="ident" id="1643038">scases</span><span class="op" id="1643044">[</span><span class="ident" id="1643045">pollorder</span><span class="op" id="1643054">[</span><span class="ident" id="1643055">i</span><span class="op" id="1643056">]</span><span class="op" id="1643057">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1643061">if</span>&nbsp;<span class="ident" id="1643064">sglist</span><span class="op" id="1643070">.</span><span class="ident" id="1643071">releasetime</span>&nbsp;<span class="op" id="1643083">&gt;</span>&nbsp;<span class="num" id="1643085">0</span>&nbsp;<span class="op" id="1643087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643092">k</span><span class="op" id="1643093">.</span><span class="ident" id="1643094">releasetime</span>&nbsp;<span class="op" id="1643106">=</span>&nbsp;<span class="ident" id="1643108">sglist</span><span class="op" id="1643114">.</span><span class="ident" id="1643115">releasetime</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1643133">if</span>&nbsp;<span class="ident" id="1643136">sg</span>&nbsp;<span class="op" id="1643139">==</span>&nbsp;<span class="ident" id="1643142">sglist</span>&nbsp;<span class="op" id="1643149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643154">cas</span>&nbsp;<span class="op" id="1643158">=</span>&nbsp;<span class="ident" id="1643160">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643164">}</span>&nbsp;<span class="keyword" id="1643166">else</span>&nbsp;<span class="op" id="1643171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643176">c</span>&nbsp;<span class="op" id="1643178">=</span>&nbsp;<span class="ident" id="1643180">k</span><span class="op" id="1643181">.</span><span class="ident" id="1643182">_chan</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1643191">if</span>&nbsp;<span class="ident" id="1643194">k</span><span class="op" id="1643195">.</span><span class="ident" id="1643196">kind</span>&nbsp;<span class="op" id="1643201">==</span>&nbsp;<span class="ident" id="1643204">_CaseSend</span>&nbsp;<span class="op" id="1643214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643220">c</span><span class="op" id="1643221">.</span><span class="ident" id="1643222">sendq</span><span class="op" id="1643227">.</span><span class="ident" id="1643228">dequeueSudoG</span><span class="op" id="1643240">(</span><span class="ident" id="1643241">sglist</span><span class="op" id="1643247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643252">}</span>&nbsp;<span class="keyword" id="1643254">else</span>&nbsp;<span class="op" id="1643259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643265">c</span><span class="op" id="1643266">.</span><span class="ident" id="1643267">recvq</span><span class="op" id="1643272">.</span><span class="ident" id="1643273">dequeueSudoG</span><span class="op" id="1643285">(</span><span class="ident" id="1643286">sglist</span><span class="op" id="1643292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643297">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643305">sgnext</span>&nbsp;<span class="op" id="1643312">=</span>&nbsp;<span class="ident" id="1643314">sglist</span><span class="op" id="1643320">.</span><span class="ident" id="1643321">waitlink</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643332">sglist</span><span class="op" id="1643338">.</span><span class="ident" id="1643339">waitlink</span>&nbsp;<span class="op" id="1643348">=</span>&nbsp;<span class="ident" id="1643350">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643356">releaseSudog</span><span class="op" id="1643368">(</span><span class="ident" id="1643369">sglist</span><span class="op" id="1643375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643379">sglist</span>&nbsp;<span class="op" id="1643386">=</span>&nbsp;<span class="ident" id="1643388">sgnext</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1643400">if</span>&nbsp;<span class="ident" id="1643403">cas</span>&nbsp;<span class="op" id="1643407">==</span>&nbsp;<span class="ident" id="1643410">nil</span>&nbsp;<span class="op" id="1643414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1643418">goto</span>&nbsp;<span class="ident" id="1643423">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643429">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643433">c</span>&nbsp;<span class="op" id="1643435">=</span>&nbsp;<span class="ident" id="1643437">cas</span><span class="op" id="1643440">.</span><span class="ident" id="1643441">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1643449">if</span>&nbsp;<span class="ident" id="1643452">c</span><span class="op" id="1643453">.</span><span class="ident" id="1643454">dataqsiz</span>&nbsp;<span class="op" id="1643463">&gt;</span>&nbsp;<span class="num" id="1643465">0</span>&nbsp;<span class="op" id="1643467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643471">gothrow</span><span class="op" id="1643478">(</span><span class="string" id="1643479">&#34;selectgo:&nbsp;shouldn&#39;t&nbsp;happen&#34;</span><span class="op" id="1643507">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1643514">if</span>&nbsp;<span class="ident" id="1643517">debugSelect</span>&nbsp;<span class="op" id="1643529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1643533">print</span><span class="op" id="1643538">(</span><span class="string" id="1643539">&#34;wait-return:&nbsp;sel=&#34;</span><span class="op" id="1643558">,</span>&nbsp;<span class="ident" id="1643560">sel</span><span class="op" id="1643563">,</span>&nbsp;<span class="string" id="1643565">&#34;&nbsp;c=&#34;</span><span class="op" id="1643570">,</span>&nbsp;<span class="ident" id="1643572">c</span><span class="op" id="1643573">,</span>&nbsp;<span class="string" id="1643575">&#34;&nbsp;cas=&#34;</span><span class="op" id="1643582">,</span>&nbsp;<span class="ident" id="1643584">cas</span><span class="op" id="1643587">,</span>&nbsp;<span class="string" id="1643589">&#34;&nbsp;kind=&#34;</span><span class="op" id="1643597">,</span>&nbsp;<span class="ident" id="1643599">cas</span><span class="op" id="1643602">.</span><span class="ident" id="1643603">kind</span><span class="op" id="1643607">,</span>&nbsp;<span class="string" id="1643609">&#34;\n&#34;</span><span class="op" id="1643613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643616">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1643620">if</span>&nbsp;<span class="ident" id="1643623">cas</span><span class="op" id="1643626">.</span><span class="ident" id="1643627">kind</span>&nbsp;<span class="op" id="1643632">==</span>&nbsp;<span class="ident" id="1643635">_CaseRecv</span>&nbsp;<span class="op" id="1643645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1643649">if</span>&nbsp;<span class="ident" id="1643652">cas</span><span class="op" id="1643655">.</span><span class="ident" id="1643656">receivedp</span>&nbsp;<span class="op" id="1643666">!=</span>&nbsp;<span class="ident" id="1643669">nil</span>&nbsp;<span class="op" id="1643673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643678">*</span><span class="ident" id="1643679">cas</span><span class="op" id="1643682">.</span><span class="ident" id="1643683">receivedp</span>&nbsp;<span class="op" id="1643693">=</span>&nbsp;<span class="builtintype" id="1643695">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643702">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1643709">if</span>&nbsp;<span class="ident" id="1643712">raceenabled</span>&nbsp;<span class="op" id="1643724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1643728">if</span>&nbsp;<span class="ident" id="1643731">cas</span><span class="op" id="1643734">.</span><span class="ident" id="1643735">kind</span>&nbsp;<span class="op" id="1643740">==</span>&nbsp;<span class="ident" id="1643743">_CaseRecv</span>&nbsp;<span class="op" id="1643753">&amp;&amp;</span>&nbsp;<span class="ident" id="1643756">cas</span><span class="op" id="1643759">.</span><span class="ident" id="1643760">elem</span>&nbsp;<span class="op" id="1643765">!=</span>&nbsp;<span class="ident" id="1643768">nil</span>&nbsp;<span class="op" id="1643772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643777">raceWriteObjectPC</span><span class="op" id="1643794">(</span><span class="ident" id="1643795">c</span><span class="op" id="1643796">.</span><span class="ident" id="1643797">elemtype</span><span class="op" id="1643805">,</span>&nbsp;<span class="ident" id="1643807">cas</span><span class="op" id="1643810">.</span><span class="ident" id="1643811">elem</span><span class="op" id="1643815">,</span>&nbsp;<span class="ident" id="1643817">cas</span><span class="op" id="1643820">.</span><span class="ident" id="1643821">pc</span><span class="op" id="1643823">,</span>&nbsp;<span class="ident" id="1643825">chanrecvpc</span><span class="op" id="1643835">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643839">}</span>&nbsp;<span class="keyword" id="1643841">else</span>&nbsp;<span class="keyword" id="1643846">if</span>&nbsp;<span class="ident" id="1643849">cas</span><span class="op" id="1643852">.</span><span class="ident" id="1643853">kind</span>&nbsp;<span class="op" id="1643858">==</span>&nbsp;<span class="ident" id="1643861">_CaseSend</span>&nbsp;<span class="op" id="1643871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643876">raceReadObjectPC</span><span class="op" id="1643892">(</span><span class="ident" id="1643893">c</span><span class="op" id="1643894">.</span><span class="ident" id="1643895">elemtype</span><span class="op" id="1643903">,</span>&nbsp;<span class="ident" id="1643905">cas</span><span class="op" id="1643908">.</span><span class="ident" id="1643909">elem</span><span class="op" id="1643913">,</span>&nbsp;<span class="ident" id="1643915">cas</span><span class="op" id="1643918">.</span><span class="ident" id="1643919">pc</span><span class="op" id="1643921">,</span>&nbsp;<span class="ident" id="1643923">chansendpc</span><span class="op" id="1643933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1643940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1643944">selunlock</span><span class="op" id="1643953">(</span><span class="ident" id="1643954">sel</span><span class="op" id="1643957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1643960">goto</span>&nbsp;<span class="ident" id="1643965">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1643971">asyncrecv</span><span class="op" id="1643980">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1643983">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;buffer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1644011">if</span>&nbsp;<span class="ident" id="1644014">raceenabled</span>&nbsp;<span class="op" id="1644026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1644030">if</span>&nbsp;<span class="ident" id="1644033">cas</span><span class="op" id="1644036">.</span><span class="ident" id="1644037">elem</span>&nbsp;<span class="op" id="1644042">!=</span>&nbsp;<span class="ident" id="1644045">nil</span>&nbsp;<span class="op" id="1644049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644054">raceWriteObjectPC</span><span class="op" id="1644071">(</span><span class="ident" id="1644072">c</span><span class="op" id="1644073">.</span><span class="ident" id="1644074">elemtype</span><span class="op" id="1644082">,</span>&nbsp;<span class="ident" id="1644084">cas</span><span class="op" id="1644087">.</span><span class="ident" id="1644088">elem</span><span class="op" id="1644092">,</span>&nbsp;<span class="ident" id="1644094">cas</span><span class="op" id="1644097">.</span><span class="ident" id="1644098">pc</span><span class="op" id="1644100">,</span>&nbsp;<span class="ident" id="1644102">chanrecvpc</span><span class="op" id="1644112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1644116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644120">raceacquire</span><span class="op" id="1644131">(</span><span class="ident" id="1644132">chanbuf</span><span class="op" id="1644139">(</span><span class="ident" id="1644140">c</span><span class="op" id="1644141">,</span>&nbsp;<span class="ident" id="1644143">c</span><span class="op" id="1644144">.</span><span class="ident" id="1644145">recvx</span><span class="op" id="1644150">)</span><span class="op" id="1644151">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644155">racerelease</span><span class="op" id="1644166">(</span><span class="ident" id="1644167">chanbuf</span><span class="op" id="1644174">(</span><span class="ident" id="1644175">c</span><span class="op" id="1644176">,</span>&nbsp;<span class="ident" id="1644178">c</span><span class="op" id="1644179">.</span><span class="ident" id="1644180">recvx</span><span class="op" id="1644185">)</span><span class="op" id="1644186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1644189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1644192">if</span>&nbsp;<span class="ident" id="1644195">cas</span><span class="op" id="1644198">.</span><span class="ident" id="1644199">receivedp</span>&nbsp;<span class="op" id="1644209">!=</span>&nbsp;<span class="ident" id="1644212">nil</span>&nbsp;<span class="op" id="1644216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1644220">*</span><span class="ident" id="1644221">cas</span><span class="op" id="1644224">.</span><span class="ident" id="1644225">receivedp</span>&nbsp;<span class="op" id="1644235">=</span>&nbsp;<span class="builtintype" id="1644237">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1644243">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1644246">if</span>&nbsp;<span class="ident" id="1644249">cas</span><span class="op" id="1644252">.</span><span class="ident" id="1644253">elem</span>&nbsp;<span class="op" id="1644258">!=</span>&nbsp;<span class="ident" id="1644261">nil</span>&nbsp;<span class="op" id="1644265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644269">memmove</span><span class="op" id="1644276">(</span><span class="ident" id="1644277">cas</span><span class="op" id="1644280">.</span><span class="ident" id="1644281">elem</span><span class="op" id="1644285">,</span>&nbsp;<span class="ident" id="1644287">chanbuf</span><span class="op" id="1644294">(</span><span class="ident" id="1644295">c</span><span class="op" id="1644296">,</span>&nbsp;<span class="ident" id="1644298">c</span><span class="op" id="1644299">.</span><span class="ident" id="1644300">recvx</span><span class="op" id="1644305">)</span><span class="op" id="1644306">,</span>&nbsp;<span class="builtintype" id="1644308">uintptr</span><span class="op" id="1644315">(</span><span class="ident" id="1644316">c</span><span class="op" id="1644317">.</span><span class="ident" id="1644318">elemsize</span><span class="op" id="1644326">)</span><span class="op" id="1644327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1644330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644333">memclr</span><span class="op" id="1644339">(</span><span class="ident" id="1644340">chanbuf</span><span class="op" id="1644347">(</span><span class="ident" id="1644348">c</span><span class="op" id="1644349">,</span>&nbsp;<span class="ident" id="1644351">c</span><span class="op" id="1644352">.</span><span class="ident" id="1644353">recvx</span><span class="op" id="1644358">)</span><span class="op" id="1644359">,</span>&nbsp;<span class="builtintype" id="1644361">uintptr</span><span class="op" id="1644368">(</span><span class="ident" id="1644369">c</span><span class="op" id="1644370">.</span><span class="ident" id="1644371">elemsize</span><span class="op" id="1644379">)</span><span class="op" id="1644380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644383">c</span><span class="op" id="1644384">.</span><span class="ident" id="1644385">recvx</span><span class="op" id="1644390">++</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1644394">if</span>&nbsp;<span class="ident" id="1644397">c</span><span class="op" id="1644398">.</span><span class="ident" id="1644399">recvx</span>&nbsp;<span class="op" id="1644405">==</span>&nbsp;<span class="ident" id="1644408">c</span><span class="op" id="1644409">.</span><span class="ident" id="1644410">dataqsiz</span>&nbsp;<span class="op" id="1644419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644423">c</span><span class="op" id="1644424">.</span><span class="ident" id="1644425">recvx</span>&nbsp;<span class="op" id="1644431">=</span>&nbsp;<span class="num" id="1644433">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1644436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644439">c</span><span class="op" id="1644440">.</span><span class="ident" id="1644441">qcount</span><span class="op" id="1644447">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644451">sg</span>&nbsp;<span class="op" id="1644454">=</span>&nbsp;<span class="ident" id="1644456">c</span><span class="op" id="1644457">.</span><span class="ident" id="1644458">sendq</span><span class="op" id="1644463">.</span><span class="ident" id="1644464">dequeue</span><span class="op" id="1644471">(</span><span class="op" id="1644472">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1644475">if</span>&nbsp;<span class="ident" id="1644478">sg</span>&nbsp;<span class="op" id="1644481">!=</span>&nbsp;<span class="ident" id="1644484">nil</span>&nbsp;<span class="op" id="1644488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644492">gp</span>&nbsp;<span class="op" id="1644495">=</span>&nbsp;<span class="ident" id="1644497">sg</span><span class="op" id="1644499">.</span><span class="ident" id="1644500">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644504">selunlock</span><span class="op" id="1644513">(</span><span class="ident" id="1644514">sel</span><span class="op" id="1644517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1644521">if</span>&nbsp;<span class="ident" id="1644524">sg</span><span class="op" id="1644526">.</span><span class="ident" id="1644527">releasetime</span>&nbsp;<span class="op" id="1644539">!=</span>&nbsp;<span class="num" id="1644542">0</span>&nbsp;<span class="op" id="1644544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644549">sg</span><span class="op" id="1644551">.</span><span class="ident" id="1644552">releasetime</span>&nbsp;<span class="op" id="1644564">=</span>&nbsp;<span class="ident" id="1644566">cputicks</span><span class="op" id="1644574">(</span><span class="op" id="1644575">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1644579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644583">goready</span><span class="op" id="1644590">(</span><span class="ident" id="1644591">gp</span><span class="op" id="1644593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1644596">}</span>&nbsp;<span class="keyword" id="1644598">else</span>&nbsp;<span class="op" id="1644603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644607">selunlock</span><span class="op" id="1644616">(</span><span class="ident" id="1644617">sel</span><span class="op" id="1644620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1644623">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1644626">goto</span>&nbsp;<span class="ident" id="1644631">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1644637">asyncsend</span><span class="op" id="1644646">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1644649">//&nbsp;can&nbsp;send&nbsp;to&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1644672">if</span>&nbsp;<span class="ident" id="1644675">raceenabled</span>&nbsp;<span class="op" id="1644687">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644691">raceacquire</span><span class="op" id="1644702">(</span><span class="ident" id="1644703">chanbuf</span><span class="op" id="1644710">(</span><span class="ident" id="1644711">c</span><span class="op" id="1644712">,</span>&nbsp;<span class="ident" id="1644714">c</span><span class="op" id="1644715">.</span><span class="ident" id="1644716">sendx</span><span class="op" id="1644721">)</span><span class="op" id="1644722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644726">racerelease</span><span class="op" id="1644737">(</span><span class="ident" id="1644738">chanbuf</span><span class="op" id="1644745">(</span><span class="ident" id="1644746">c</span><span class="op" id="1644747">,</span>&nbsp;<span class="ident" id="1644749">c</span><span class="op" id="1644750">.</span><span class="ident" id="1644751">sendx</span><span class="op" id="1644756">)</span><span class="op" id="1644757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644761">raceReadObjectPC</span><span class="op" id="1644777">(</span><span class="ident" id="1644778">c</span><span class="op" id="1644779">.</span><span class="ident" id="1644780">elemtype</span><span class="op" id="1644788">,</span>&nbsp;<span class="ident" id="1644790">cas</span><span class="op" id="1644793">.</span><span class="ident" id="1644794">elem</span><span class="op" id="1644798">,</span>&nbsp;<span class="ident" id="1644800">cas</span><span class="op" id="1644803">.</span><span class="ident" id="1644804">pc</span><span class="op" id="1644806">,</span>&nbsp;<span class="ident" id="1644808">chansendpc</span><span class="op" id="1644818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1644821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644824">memmove</span><span class="op" id="1644831">(</span><span class="ident" id="1644832">chanbuf</span><span class="op" id="1644839">(</span><span class="ident" id="1644840">c</span><span class="op" id="1644841">,</span>&nbsp;<span class="ident" id="1644843">c</span><span class="op" id="1644844">.</span><span class="ident" id="1644845">sendx</span><span class="op" id="1644850">)</span><span class="op" id="1644851">,</span>&nbsp;<span class="ident" id="1644853">cas</span><span class="op" id="1644856">.</span><span class="ident" id="1644857">elem</span><span class="op" id="1644861">,</span>&nbsp;<span class="builtintype" id="1644863">uintptr</span><span class="op" id="1644870">(</span><span class="ident" id="1644871">c</span><span class="op" id="1644872">.</span><span class="ident" id="1644873">elemsize</span><span class="op" id="1644881">)</span><span class="op" id="1644882">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644885">c</span><span class="op" id="1644886">.</span><span class="ident" id="1644887">sendx</span><span class="op" id="1644892">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1644896">if</span>&nbsp;<span class="ident" id="1644899">c</span><span class="op" id="1644900">.</span><span class="ident" id="1644901">sendx</span>&nbsp;<span class="op" id="1644907">==</span>&nbsp;<span class="ident" id="1644910">c</span><span class="op" id="1644911">.</span><span class="ident" id="1644912">dataqsiz</span>&nbsp;<span class="op" id="1644921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644925">c</span><span class="op" id="1644926">.</span><span class="ident" id="1644927">sendx</span>&nbsp;<span class="op" id="1644933">=</span>&nbsp;<span class="num" id="1644935">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1644938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644941">c</span><span class="op" id="1644942">.</span><span class="ident" id="1644943">qcount</span><span class="op" id="1644949">++</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644953">sg</span>&nbsp;<span class="op" id="1644956">=</span>&nbsp;<span class="ident" id="1644958">c</span><span class="op" id="1644959">.</span><span class="ident" id="1644960">recvq</span><span class="op" id="1644965">.</span><span class="ident" id="1644966">dequeue</span><span class="op" id="1644973">(</span><span class="op" id="1644974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1644977">if</span>&nbsp;<span class="ident" id="1644980">sg</span>&nbsp;<span class="op" id="1644983">!=</span>&nbsp;<span class="ident" id="1644986">nil</span>&nbsp;<span class="op" id="1644990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1644994">gp</span>&nbsp;<span class="op" id="1644997">=</span>&nbsp;<span class="ident" id="1644999">sg</span><span class="op" id="1645001">.</span><span class="ident" id="1645002">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645006">selunlock</span><span class="op" id="1645015">(</span><span class="ident" id="1645016">sel</span><span class="op" id="1645019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645023">if</span>&nbsp;<span class="ident" id="1645026">sg</span><span class="op" id="1645028">.</span><span class="ident" id="1645029">releasetime</span>&nbsp;<span class="op" id="1645041">!=</span>&nbsp;<span class="num" id="1645044">0</span>&nbsp;<span class="op" id="1645046">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645051">sg</span><span class="op" id="1645053">.</span><span class="ident" id="1645054">releasetime</span>&nbsp;<span class="op" id="1645066">=</span>&nbsp;<span class="ident" id="1645068">cputicks</span><span class="op" id="1645076">(</span><span class="op" id="1645077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645085">goready</span><span class="op" id="1645092">(</span><span class="ident" id="1645093">gp</span><span class="op" id="1645095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645098">}</span>&nbsp;<span class="keyword" id="1645100">else</span>&nbsp;<span class="op" id="1645105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645109">selunlock</span><span class="op" id="1645118">(</span><span class="ident" id="1645119">sel</span><span class="op" id="1645122">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645128">goto</span>&nbsp;<span class="ident" id="1645133">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1645139">syncrecv</span><span class="op" id="1645147">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1645150">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;sleeping&nbsp;sender&nbsp;(sg)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645192">if</span>&nbsp;<span class="ident" id="1645195">raceenabled</span>&nbsp;<span class="op" id="1645207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645211">if</span>&nbsp;<span class="ident" id="1645214">cas</span><span class="op" id="1645217">.</span><span class="ident" id="1645218">elem</span>&nbsp;<span class="op" id="1645223">!=</span>&nbsp;<span class="ident" id="1645226">nil</span>&nbsp;<span class="op" id="1645230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645235">raceWriteObjectPC</span><span class="op" id="1645252">(</span><span class="ident" id="1645253">c</span><span class="op" id="1645254">.</span><span class="ident" id="1645255">elemtype</span><span class="op" id="1645263">,</span>&nbsp;<span class="ident" id="1645265">cas</span><span class="op" id="1645268">.</span><span class="ident" id="1645269">elem</span><span class="op" id="1645273">,</span>&nbsp;<span class="ident" id="1645275">cas</span><span class="op" id="1645278">.</span><span class="ident" id="1645279">pc</span><span class="op" id="1645281">,</span>&nbsp;<span class="ident" id="1645283">chanrecvpc</span><span class="op" id="1645293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645301">racesync</span><span class="op" id="1645309">(</span><span class="ident" id="1645310">c</span><span class="op" id="1645311">,</span>&nbsp;<span class="ident" id="1645313">sg</span><span class="op" id="1645315">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645321">selunlock</span><span class="op" id="1645330">(</span><span class="ident" id="1645331">sel</span><span class="op" id="1645334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645337">if</span>&nbsp;<span class="ident" id="1645340">debugSelect</span>&nbsp;<span class="op" id="1645352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1645356">print</span><span class="op" id="1645361">(</span><span class="string" id="1645362">&#34;syncrecv:&nbsp;sel=&#34;</span><span class="op" id="1645378">,</span>&nbsp;<span class="ident" id="1645380">sel</span><span class="op" id="1645383">,</span>&nbsp;<span class="string" id="1645385">&#34;&nbsp;c=&#34;</span><span class="op" id="1645390">,</span>&nbsp;<span class="ident" id="1645392">c</span><span class="op" id="1645393">,</span>&nbsp;<span class="string" id="1645395">&#34;\n&#34;</span><span class="op" id="1645399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645402">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645405">if</span>&nbsp;<span class="ident" id="1645408">cas</span><span class="op" id="1645411">.</span><span class="ident" id="1645412">receivedp</span>&nbsp;<span class="op" id="1645422">!=</span>&nbsp;<span class="ident" id="1645425">nil</span>&nbsp;<span class="op" id="1645429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645433">*</span><span class="ident" id="1645434">cas</span><span class="op" id="1645437">.</span><span class="ident" id="1645438">receivedp</span>&nbsp;<span class="op" id="1645448">=</span>&nbsp;<span class="builtintype" id="1645450">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645459">if</span>&nbsp;<span class="ident" id="1645462">cas</span><span class="op" id="1645465">.</span><span class="ident" id="1645466">elem</span>&nbsp;<span class="op" id="1645471">!=</span>&nbsp;<span class="ident" id="1645474">nil</span>&nbsp;<span class="op" id="1645478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645482">memmove</span><span class="op" id="1645489">(</span><span class="ident" id="1645490">cas</span><span class="op" id="1645493">.</span><span class="ident" id="1645494">elem</span><span class="op" id="1645498">,</span>&nbsp;<span class="ident" id="1645500">sg</span><span class="op" id="1645502">.</span><span class="ident" id="1645503">elem</span><span class="op" id="1645507">,</span>&nbsp;<span class="builtintype" id="1645509">uintptr</span><span class="op" id="1645516">(</span><span class="ident" id="1645517">c</span><span class="op" id="1645518">.</span><span class="ident" id="1645519">elemsize</span><span class="op" id="1645527">)</span><span class="op" id="1645528">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645534">sg</span><span class="op" id="1645536">.</span><span class="ident" id="1645537">elem</span>&nbsp;<span class="op" id="1645542">=</span>&nbsp;<span class="ident" id="1645544">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645549">gp</span>&nbsp;<span class="op" id="1645552">=</span>&nbsp;<span class="ident" id="1645554">sg</span><span class="op" id="1645556">.</span><span class="ident" id="1645557">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645560">gp</span><span class="op" id="1645562">.</span><span class="ident" id="1645563">param</span>&nbsp;<span class="op" id="1645569">=</span>&nbsp;<span class="ident" id="1645571">unsafe</span><span class="op" id="1645577">.</span><span class="ident" id="1645578">Pointer</span><span class="op" id="1645585">(</span><span class="ident" id="1645586">sg</span><span class="op" id="1645588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645591">if</span>&nbsp;<span class="ident" id="1645594">sg</span><span class="op" id="1645596">.</span><span class="ident" id="1645597">releasetime</span>&nbsp;<span class="op" id="1645609">!=</span>&nbsp;<span class="num" id="1645612">0</span>&nbsp;<span class="op" id="1645614">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645618">sg</span><span class="op" id="1645620">.</span><span class="ident" id="1645621">releasetime</span>&nbsp;<span class="op" id="1645633">=</span>&nbsp;<span class="ident" id="1645635">cputicks</span><span class="op" id="1645643">(</span><span class="op" id="1645644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645650">goready</span><span class="op" id="1645657">(</span><span class="ident" id="1645658">gp</span><span class="op" id="1645660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645663">goto</span>&nbsp;<span class="ident" id="1645668">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="ident" id="1645674">rclose</span><span class="op" id="1645680">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1645683">//&nbsp;read&nbsp;at&nbsp;end&nbsp;of&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645717">selunlock</span><span class="op" id="1645726">(</span><span class="ident" id="1645727">sel</span><span class="op" id="1645730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645733">if</span>&nbsp;<span class="ident" id="1645736">cas</span><span class="op" id="1645739">.</span><span class="ident" id="1645740">receivedp</span>&nbsp;<span class="op" id="1645750">!=</span>&nbsp;<span class="ident" id="1645753">nil</span>&nbsp;<span class="op" id="1645757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645761">*</span><span class="ident" id="1645762">cas</span><span class="op" id="1645765">.</span><span class="ident" id="1645766">receivedp</span>&nbsp;<span class="op" id="1645776">=</span>&nbsp;<span class="builtintype" id="1645778">false</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645788">if</span>&nbsp;<span class="ident" id="1645791">cas</span><span class="op" id="1645794">.</span><span class="ident" id="1645795">elem</span>&nbsp;<span class="op" id="1645800">!=</span>&nbsp;<span class="ident" id="1645803">nil</span>&nbsp;<span class="op" id="1645807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645811">memclr</span><span class="op" id="1645817">(</span><span class="ident" id="1645818">cas</span><span class="op" id="1645821">.</span><span class="ident" id="1645822">elem</span><span class="op" id="1645826">,</span>&nbsp;<span class="builtintype" id="1645828">uintptr</span><span class="op" id="1645835">(</span><span class="ident" id="1645836">c</span><span class="op" id="1645837">.</span><span class="ident" id="1645838">elemsize</span><span class="op" id="1645846">)</span><span class="op" id="1645847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645853">if</span>&nbsp;<span class="ident" id="1645856">raceenabled</span>&nbsp;<span class="op" id="1645868">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645872">raceacquire</span><span class="op" id="1645883">(</span><span class="ident" id="1645884">unsafe</span><span class="op" id="1645890">.</span><span class="ident" id="1645891">Pointer</span><span class="op" id="1645898">(</span><span class="ident" id="1645899">c</span><span class="op" id="1645900">)</span><span class="op" id="1645901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645907">goto</span>&nbsp;<span class="ident" id="1645912">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1645918">syncsend</span><span class="op" id="1645926">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1645929">//&nbsp;can&nbsp;send&nbsp;to&nbsp;sleeping&nbsp;receiver&nbsp;(sg)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645968">if</span>&nbsp;<span class="ident" id="1645971">raceenabled</span>&nbsp;<span class="op" id="1645983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645987">raceReadObjectPC</span><span class="op" id="1646003">(</span><span class="ident" id="1646004">c</span><span class="op" id="1646005">.</span><span class="ident" id="1646006">elemtype</span><span class="op" id="1646014">,</span>&nbsp;<span class="ident" id="1646016">cas</span><span class="op" id="1646019">.</span><span class="ident" id="1646020">elem</span><span class="op" id="1646024">,</span>&nbsp;<span class="ident" id="1646026">cas</span><span class="op" id="1646029">.</span><span class="ident" id="1646030">pc</span><span class="op" id="1646032">,</span>&nbsp;<span class="ident" id="1646034">chansendpc</span><span class="op" id="1646044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646048">racesync</span><span class="op" id="1646056">(</span><span class="ident" id="1646057">c</span><span class="op" id="1646058">,</span>&nbsp;<span class="ident" id="1646060">sg</span><span class="op" id="1646062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1646065">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646068">selunlock</span><span class="op" id="1646077">(</span><span class="ident" id="1646078">sel</span><span class="op" id="1646081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1646084">if</span>&nbsp;<span class="ident" id="1646087">debugSelect</span>&nbsp;<span class="op" id="1646099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1646103">print</span><span class="op" id="1646108">(</span><span class="string" id="1646109">&#34;syncsend:&nbsp;sel=&#34;</span><span class="op" id="1646125">,</span>&nbsp;<span class="ident" id="1646127">sel</span><span class="op" id="1646130">,</span>&nbsp;<span class="string" id="1646132">&#34;&nbsp;c=&#34;</span><span class="op" id="1646137">,</span>&nbsp;<span class="ident" id="1646139">c</span><span class="op" id="1646140">,</span>&nbsp;<span class="string" id="1646142">&#34;\n&#34;</span><span class="op" id="1646146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1646149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1646152">if</span>&nbsp;<span class="ident" id="1646155">sg</span><span class="op" id="1646157">.</span><span class="ident" id="1646158">elem</span>&nbsp;<span class="op" id="1646163">!=</span>&nbsp;<span class="ident" id="1646166">nil</span>&nbsp;<span class="op" id="1646170">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646174">memmove</span><span class="op" id="1646181">(</span><span class="ident" id="1646182">sg</span><span class="op" id="1646184">.</span><span class="ident" id="1646185">elem</span><span class="op" id="1646189">,</span>&nbsp;<span class="ident" id="1646191">cas</span><span class="op" id="1646194">.</span><span class="ident" id="1646195">elem</span><span class="op" id="1646199">,</span>&nbsp;<span class="builtintype" id="1646201">uintptr</span><span class="op" id="1646208">(</span><span class="ident" id="1646209">c</span><span class="op" id="1646210">.</span><span class="ident" id="1646211">elemsize</span><span class="op" id="1646219">)</span><span class="op" id="1646220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1646223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646226">sg</span><span class="op" id="1646228">.</span><span class="ident" id="1646229">elem</span>&nbsp;<span class="op" id="1646234">=</span>&nbsp;<span class="ident" id="1646236">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646241">gp</span>&nbsp;<span class="op" id="1646244">=</span>&nbsp;<span class="ident" id="1646246">sg</span><span class="op" id="1646248">.</span><span class="ident" id="1646249">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646252">gp</span><span class="op" id="1646254">.</span><span class="ident" id="1646255">param</span>&nbsp;<span class="op" id="1646261">=</span>&nbsp;<span class="ident" id="1646263">unsafe</span><span class="op" id="1646269">.</span><span class="ident" id="1646270">Pointer</span><span class="op" id="1646277">(</span><span class="ident" id="1646278">sg</span><span class="op" id="1646280">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1646283">if</span>&nbsp;<span class="ident" id="1646286">sg</span><span class="op" id="1646288">.</span><span class="ident" id="1646289">releasetime</span>&nbsp;<span class="op" id="1646301">!=</span>&nbsp;<span class="num" id="1646304">0</span>&nbsp;<span class="op" id="1646306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646310">sg</span><span class="op" id="1646312">.</span><span class="ident" id="1646313">releasetime</span>&nbsp;<span class="op" id="1646325">=</span>&nbsp;<span class="ident" id="1646327">cputicks</span><span class="op" id="1646335">(</span><span class="op" id="1646336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1646339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646342">goready</span><span class="op" id="1646349">(</span><span class="ident" id="1646350">gp</span><span class="op" id="1646352">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span><span class="ident" id="1646355">retc</span><span class="op" id="1646359">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1646362">if</span>&nbsp;<span class="ident" id="1646365">cas</span><span class="op" id="1646368">.</span><span class="ident" id="1646369">releasetime</span>&nbsp;<span class="op" id="1646381">&gt;</span>&nbsp;<span class="num" id="1646383">0</span>&nbsp;<span class="op" id="1646385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646389">blockevent</span><span class="op" id="1646399">(</span><span class="ident" id="1646400">cas</span><span class="op" id="1646403">.</span><span class="ident" id="1646404">releasetime</span><span class="op" id="1646415">-</span><span class="ident" id="1646416">t0</span><span class="op" id="1646418">,</span>&nbsp;<span class="num" id="1646420">2</span><span class="op" id="1646421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1646424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1646427">return</span>&nbsp;<span class="ident" id="1646434">cas</span><span class="op" id="1646437">.</span><span class="ident" id="1646438">pc</span><span class="op" id="1646440">,</span>&nbsp;<span class="ident" id="1646442">cas</span><span class="op" id="1646445">.</span><span class="ident" id="1646446">so</span><br>
<span class="lineno">570</span><br>
<span class="lineno"></span><span class="ident" id="1646450">sclose</span><span class="op" id="1646456">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1646459">//&nbsp;send&nbsp;on&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646486">selunlock</span><span class="op" id="1646495">(</span><span class="ident" id="1646496">sel</span><span class="op" id="1646499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1646502">panic</span><span class="op" id="1646507">(</span><span class="string" id="1646508">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1646532">)</span><br>
<span class="lineno">575</span><span class="op" id="1646534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1646537">func</span>&nbsp;<span class="op" id="1646542">(</span><span class="ident" id="1646543">c</span>&nbsp;<span class="op" id="1646545">*</span><span class="ident" id="1646546">hchan</span><span class="op" id="1646551">)</span>&nbsp;<span class="ident" id="1646553">sortkey</span><span class="op" id="1646560">(</span><span class="op" id="1646561">)</span>&nbsp;<span class="builtintype" id="1646563">uintptr</span>&nbsp;<span class="op" id="1646571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1646574">//&nbsp;TODO(khr):&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;moving&nbsp;garbage&nbsp;collector,&nbsp;we&#39;ll&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1646642">//&nbsp;change&nbsp;this&nbsp;function.</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1646668">return</span>&nbsp;<span class="builtintype" id="1646675">uintptr</span><span class="op" id="1646682">(</span><span class="ident" id="1646683">unsafe</span><span class="op" id="1646689">.</span><span class="ident" id="1646690">Pointer</span><span class="op" id="1646697">(</span><span class="ident" id="1646698">c</span><span class="op" id="1646699">)</span><span class="op" id="1646700">)</span><br>
<span class="lineno"></span><span class="op" id="1646702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1646705">//&nbsp;A&nbsp;runtimeSelect&nbsp;is&nbsp;a&nbsp;single&nbsp;case&nbsp;passed&nbsp;to&nbsp;rselect.</span><br>
<span class="lineno"></span><span class="comment" id="1646760">//&nbsp;This&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/runtimeSelect</span><br>
<span class="lineno">585</span><span class="keyword" id="1646814">type</span>&nbsp;<span class="ident" id="1646819">runtimeSelect</span>&nbsp;<span class="keyword" id="1646833">struct</span>&nbsp;<span class="op" id="1646840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646843">dir</span>&nbsp;<span class="ident" id="1646847">selectDir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646858">typ</span>&nbsp;<span class="ident" id="1646862">unsafe</span><span class="op" id="1646868">.</span><span class="ident" id="1646869">Pointer</span>&nbsp;<span class="comment" id="1646877">//&nbsp;channel&nbsp;type&nbsp;(not&nbsp;used&nbsp;here)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646910">ch</span>&nbsp;&nbsp;<span class="op" id="1646914">*</span><span class="ident" id="1646915">hchan</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1646929">//&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646941">val</span>&nbsp;<span class="ident" id="1646945">unsafe</span><span class="op" id="1646951">.</span><span class="ident" id="1646952">Pointer</span>&nbsp;<span class="comment" id="1646960">//&nbsp;ptr&nbsp;to&nbsp;data&nbsp;(SendDir)&nbsp;or&nbsp;ptr&nbsp;to&nbsp;receive&nbsp;buffer&nbsp;(RecvDir)</span><br>
<span class="lineno">590</span><span class="op" id="1647020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1647023">//&nbsp;These&nbsp;values&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/SelectDir.</span><br>
<span class="lineno"></span><span class="keyword" id="1647082">type</span>&nbsp;<span class="ident" id="1647087">selectDir</span>&nbsp;<span class="builtintype" id="1647097">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="keyword" id="1647102">const</span>&nbsp;<span class="op" id="1647108">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647111">_</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647125">selectDir</span>&nbsp;<span class="op" id="1647135">=</span>&nbsp;<span class="ident" id="1647137">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647143">selectSend</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1647167">//&nbsp;case&nbsp;Chan&nbsp;&lt;-&nbsp;Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647189">selectRecv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1647213">//&nbsp;case&nbsp;&lt;-Chan:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647230">selectDefault</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1647254">//&nbsp;default</span><br>
<span class="lineno">600</span><span class="op" id="1647265">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1647268">func</span>&nbsp;<span class="ident" id="1647273">reflect_rselect</span><span class="op" id="1647288">(</span><span class="ident" id="1647289">cases</span>&nbsp;<span class="op" id="1647295">[</span><span class="op" id="1647296">]</span><span class="ident" id="1647297">runtimeSelect</span><span class="op" id="1647310">)</span>&nbsp;<span class="op" id="1647312">(</span><span class="ident" id="1647313">chosen</span>&nbsp;<span class="builtintype" id="1647320">int</span><span class="op" id="1647323">,</span>&nbsp;<span class="ident" id="1647325">recvOK</span>&nbsp;<span class="builtintype" id="1647332">bool</span><span class="op" id="1647336">)</span>&nbsp;<span class="op" id="1647338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1647341">//&nbsp;flagNoScan&nbsp;is&nbsp;safe&nbsp;here,&nbsp;because&nbsp;all&nbsp;objects&nbsp;are&nbsp;also&nbsp;referenced&nbsp;from&nbsp;cases.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647422">size</span>&nbsp;<span class="op" id="1647427">:=</span>&nbsp;<span class="ident" id="1647430">selectsize</span><span class="op" id="1647440">(</span><span class="builtintype" id="1647441">uintptr</span><span class="op" id="1647448">(</span><span class="builtinfunc" id="1647449">len</span><span class="op" id="1647452">(</span><span class="ident" id="1647453">cases</span><span class="op" id="1647458">)</span><span class="op" id="1647459">)</span><span class="op" id="1647460">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647463">sel</span>&nbsp;<span class="op" id="1647467">:=</span>&nbsp;<span class="op" id="1647470">(</span><span class="op" id="1647471">*</span><span class="ident" id="1647472">_select</span><span class="op" id="1647479">)</span><span class="op" id="1647480">(</span><span class="ident" id="1647481">mallocgc</span><span class="op" id="1647489">(</span><span class="ident" id="1647490">size</span><span class="op" id="1647494">,</span>&nbsp;<span class="ident" id="1647496">nil</span><span class="op" id="1647499">,</span>&nbsp;<span class="ident" id="1647501">flagNoScan</span><span class="op" id="1647511">)</span><span class="op" id="1647512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647515">newselect</span><span class="op" id="1647524">(</span><span class="ident" id="1647525">sel</span><span class="op" id="1647528">,</span>&nbsp;<span class="ident" id="1647530">int64</span><span class="op" id="1647535">(</span><span class="ident" id="1647536">size</span><span class="op" id="1647540">)</span><span class="op" id="1647541">,</span>&nbsp;<span class="builtintype" id="1647543">int32</span><span class="op" id="1647548">(</span><span class="builtinfunc" id="1647549">len</span><span class="op" id="1647552">(</span><span class="ident" id="1647553">cases</span><span class="op" id="1647558">)</span><span class="op" id="1647559">)</span><span class="op" id="1647560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647563">r</span>&nbsp;<span class="op" id="1647565">:=</span>&nbsp;<span class="builtinfunc" id="1647568">new</span><span class="op" id="1647571">(</span><span class="builtintype" id="1647572">bool</span><span class="op" id="1647576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647579">for</span>&nbsp;<span class="ident" id="1647583">i</span>&nbsp;<span class="op" id="1647585">:=</span>&nbsp;<span class="keyword" id="1647588">range</span>&nbsp;<span class="ident" id="1647594">cases</span>&nbsp;<span class="op" id="1647600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647604">rc</span>&nbsp;<span class="op" id="1647607">:=</span>&nbsp;<span class="op" id="1647610">&amp;</span><span class="ident" id="1647611">cases</span><span class="op" id="1647616">[</span><span class="ident" id="1647617">i</span><span class="op" id="1647618">]</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647622">switch</span>&nbsp;<span class="ident" id="1647629">rc</span><span class="op" id="1647631">.</span><span class="ident" id="1647632">dir</span>&nbsp;<span class="op" id="1647636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647640">case</span>&nbsp;<span class="ident" id="1647645">selectDefault</span><span class="op" id="1647658">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647663">selectdefaultImpl</span><span class="op" id="1647680">(</span><span class="ident" id="1647681">sel</span><span class="op" id="1647684">,</span>&nbsp;<span class="builtintype" id="1647686">uintptr</span><span class="op" id="1647693">(</span><span class="ident" id="1647694">i</span><span class="op" id="1647695">)</span><span class="op" id="1647696">,</span>&nbsp;<span class="num" id="1647698">0</span><span class="op" id="1647699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647703">case</span>&nbsp;<span class="ident" id="1647708">selectSend</span><span class="op" id="1647718">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647723">if</span>&nbsp;<span class="ident" id="1647726">rc</span><span class="op" id="1647728">.</span><span class="ident" id="1647729">ch</span>&nbsp;<span class="op" id="1647732">==</span>&nbsp;<span class="ident" id="1647735">nil</span>&nbsp;<span class="op" id="1647739">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647745">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1647754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647759">selectsendImpl</span><span class="op" id="1647773">(</span><span class="ident" id="1647774">sel</span><span class="op" id="1647777">,</span>&nbsp;<span class="ident" id="1647779">rc</span><span class="op" id="1647781">.</span><span class="ident" id="1647782">ch</span><span class="op" id="1647784">,</span>&nbsp;<span class="builtintype" id="1647786">uintptr</span><span class="op" id="1647793">(</span><span class="ident" id="1647794">i</span><span class="op" id="1647795">)</span><span class="op" id="1647796">,</span>&nbsp;<span class="ident" id="1647798">rc</span><span class="op" id="1647800">.</span><span class="ident" id="1647801">val</span><span class="op" id="1647804">,</span>&nbsp;<span class="num" id="1647806">0</span><span class="op" id="1647807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647811">case</span>&nbsp;<span class="ident" id="1647816">selectRecv</span><span class="op" id="1647826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647831">if</span>&nbsp;<span class="ident" id="1647834">rc</span><span class="op" id="1647836">.</span><span class="ident" id="1647837">ch</span>&nbsp;<span class="op" id="1647840">==</span>&nbsp;<span class="ident" id="1647843">nil</span>&nbsp;<span class="op" id="1647847">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647853">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1647862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647867">selectrecvImpl</span><span class="op" id="1647881">(</span><span class="ident" id="1647882">sel</span><span class="op" id="1647885">,</span>&nbsp;<span class="ident" id="1647887">rc</span><span class="op" id="1647889">.</span><span class="ident" id="1647890">ch</span><span class="op" id="1647892">,</span>&nbsp;<span class="builtintype" id="1647894">uintptr</span><span class="op" id="1647901">(</span><span class="ident" id="1647902">i</span><span class="op" id="1647903">)</span><span class="op" id="1647904">,</span>&nbsp;<span class="ident" id="1647906">rc</span><span class="op" id="1647908">.</span><span class="ident" id="1647909">val</span><span class="op" id="1647912">,</span>&nbsp;<span class="ident" id="1647914">r</span><span class="op" id="1647915">,</span>&nbsp;<span class="num" id="1647917">0</span><span class="op" id="1647918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1647922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1647925">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647929">pc</span><span class="op" id="1647931">,</span>&nbsp;<span class="ident" id="1647933">_</span>&nbsp;<span class="op" id="1647935">:=</span>&nbsp;<span class="ident" id="1647938">selectgoImpl</span><span class="op" id="1647950">(</span><span class="ident" id="1647951">sel</span><span class="op" id="1647954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647957">chosen</span>&nbsp;<span class="op" id="1647964">=</span>&nbsp;<span class="builtintype" id="1647966">int</span><span class="op" id="1647969">(</span><span class="ident" id="1647970">pc</span><span class="op" id="1647972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647975">recvOK</span>&nbsp;<span class="op" id="1647982">=</span>&nbsp;<span class="op" id="1647984">*</span><span class="ident" id="1647985">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647988">return</span><br>
<span class="lineno">630</span><span class="op" id="1647995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1647998">func</span>&nbsp;<span class="op" id="1648003">(</span><span class="ident" id="1648004">q</span>&nbsp;<span class="op" id="1648006">*</span><span class="ident" id="1648007">waitq</span><span class="op" id="1648012">)</span>&nbsp;<span class="ident" id="1648014">dequeueSudoG</span><span class="op" id="1648026">(</span><span class="ident" id="1648027">s</span>&nbsp;<span class="op" id="1648029">*</span><span class="ident" id="1648030">sudog</span><span class="op" id="1648035">)</span>&nbsp;<span class="op" id="1648037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1648040">var</span>&nbsp;<span class="ident" id="1648044">prevsgp</span>&nbsp;<span class="op" id="1648052">*</span><span class="ident" id="1648053">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648060">l</span>&nbsp;<span class="op" id="1648062">:=</span>&nbsp;<span class="op" id="1648065">&amp;</span><span class="ident" id="1648066">q</span><span class="op" id="1648067">.</span><span class="ident" id="1648068">first</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1648075">for</span>&nbsp;<span class="op" id="1648079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648083">sgp</span>&nbsp;<span class="op" id="1648087">:=</span>&nbsp;<span class="op" id="1648090">*</span><span class="ident" id="1648091">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1648095">if</span>&nbsp;<span class="ident" id="1648098">sgp</span>&nbsp;<span class="op" id="1648102">==</span>&nbsp;<span class="ident" id="1648105">nil</span>&nbsp;<span class="op" id="1648109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1648114">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1648123">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1648127">if</span>&nbsp;<span class="ident" id="1648130">sgp</span>&nbsp;<span class="op" id="1648134">==</span>&nbsp;<span class="ident" id="1648137">s</span>&nbsp;<span class="op" id="1648139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1648144">*</span><span class="ident" id="1648145">l</span>&nbsp;<span class="op" id="1648147">=</span>&nbsp;<span class="ident" id="1648149">sgp</span><span class="op" id="1648152">.</span><span class="ident" id="1648153">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1648161">if</span>&nbsp;<span class="ident" id="1648164">q</span><span class="op" id="1648165">.</span><span class="ident" id="1648166">last</span>&nbsp;<span class="op" id="1648171">==</span>&nbsp;<span class="ident" id="1648174">sgp</span>&nbsp;<span class="op" id="1648178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648184">q</span><span class="op" id="1648185">.</span><span class="ident" id="1648186">last</span>&nbsp;<span class="op" id="1648191">=</span>&nbsp;<span class="ident" id="1648193">prevsgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1648204">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648209">s</span><span class="op" id="1648210">.</span><span class="ident" id="1648211">next</span>&nbsp;<span class="op" id="1648216">=</span>&nbsp;<span class="ident" id="1648218">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1648225">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1648234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648238">l</span>&nbsp;<span class="op" id="1648240">=</span>&nbsp;<span class="op" id="1648242">&amp;</span><span class="ident" id="1648243">sgp</span><span class="op" id="1648246">.</span><span class="ident" id="1648247">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648254">prevsgp</span>&nbsp;<span class="op" id="1648262">=</span>&nbsp;<span class="ident" id="1648264">sgp</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1648269">}</span><br>
<span class="lineno"></span><span class="op" id="1648271">}</span>
</div>
</body>
</html>
