<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>lonnie.io/e8vm/arch8</h2>
<ul>
<li><a href="/gostd/lonnie.io/e8vm/arch8/console.go.html">console.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu.go.html">cpu.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/cpu_test.go.html">cpu_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/device.go.html">device.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/exception.go.html">exception.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_all.go.html">inst_all.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br.go.html">inst_br.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_br_test.go.html">inst_br_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm.go.html">inst_imm.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_imm_test.go.html">inst_imm_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_jmp.go.html">inst_jmp.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg.go.html">inst_reg.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_reg_test.go.html">inst_reg_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/inst_sys.go.html">inst_sys.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/int_bus.go.html">int_bus.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt.go.html">interrupt.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/interrupt_test.go.html">interrupt_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/machine.go.html">machine.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/multi_core.go.html">multi_core.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page.go.html">page.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table.go.html">page_table.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_table_test.go.html">page_table_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/page_test.go.html">page_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory.go.html">phy_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/phy_memory_test.go.html">phy_memory_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs.go.html">regs.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/regs_test.go.html">regs_test.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/run_image.go.html">run_image.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/serial.go.html">serial.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/ticker.go.html">ticker.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory.go.html">virt_memory.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/arch8/virt_memory_test.go.html">virt_memory_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="keyword" id="3589367">package</span>&nbsp;<span class="ident" id="3589375">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3589382">import</span>&nbsp;<span class="op" id="3589389">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3589392">&#34;bytes&#34;</span><br>
<span class="lineno">5</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3589401">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3589407">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3589414">&#34;os&#34;</span><br>
<span class="lineno"></span><span class="op" id="3589419">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3589422">//&nbsp;Serial&nbsp;is&nbsp;a&nbsp;serial&nbsp;console&nbsp;device</span><br>
<span class="lineno"></span><span class="comment" id="3589459">//&nbsp;It&nbsp;is&nbsp;basically&nbsp;two&nbsp;DMA&nbsp;pipes&nbsp;of&nbsp;ring&nbsp;buffered&nbsp;bytes:</span><br>
<span class="lineno"></span><span class="comment" id="3589516">//&nbsp;one&nbsp;pipe&nbsp;for&nbsp;input,&nbsp;one&nbsp;pipe&nbsp;for&nbsp;output.</span><br>
<span class="lineno"></span><span class="keyword" id="3589560">type</span>&nbsp;<span class="ident" id="3589565">serial</span>&nbsp;<span class="keyword" id="3589572">struct</span>&nbsp;<span class="op" id="3589579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589582">intBus</span>&nbsp;<span class="ident" id="3589589">intBus</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589597">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589604">*</span><span class="ident" id="3589605">page</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589612">Core</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3589619">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589625">IntIn</span>&nbsp;&nbsp;<span class="builtintype" id="3589632">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589638">IntOut</span>&nbsp;<span class="builtintype" id="3589645">byte</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589652">Output</span>&nbsp;<span class="ident" id="3589659">io</span><span class="op" id="3589661">.</span><span class="ident" id="3589662">Writer</span><br>
<span class="lineno"></span><span class="op" id="3589669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3589672">var</span>&nbsp;<span class="ident" id="3589676">_</span>&nbsp;<span class="ident" id="3589678">device</span>&nbsp;<span class="op" id="3589685">=</span>&nbsp;<span class="builtinfunc" id="3589687">new</span><span class="op" id="3589690">(</span><span class="ident" id="3589691">serial</span><span class="op" id="3589697">)</span>&nbsp;<span class="comment" id="3589699">//&nbsp;Serial&nbsp;is&nbsp;a&nbsp;device</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="3589722">const</span>&nbsp;<span class="op" id="3589728">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589731">serialBase</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3589746">=</span>&nbsp;<span class="num" id="3589748">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589753">serialInHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3589768">=</span>&nbsp;<span class="ident" id="3589770">serialBase</span>&nbsp;<span class="op" id="3589781">+</span>&nbsp;<span class="num" id="3589783">0</span>&nbsp;&nbsp;<span class="comment" id="3589786">//&nbsp;updated&nbsp;by&nbsp;hardware</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589810">serialInTail</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3589825">=</span>&nbsp;<span class="ident" id="3589827">serialBase</span>&nbsp;<span class="op" id="3589838">+</span>&nbsp;<span class="num" id="3589840">4</span>&nbsp;&nbsp;<span class="comment" id="3589843">//&nbsp;updated&nbsp;by&nbsp;cpu</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589862">serialInWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3589877">=</span>&nbsp;<span class="ident" id="3589879">serialBase</span>&nbsp;<span class="op" id="3589890">+</span>&nbsp;<span class="num" id="3589892">8</span>&nbsp;&nbsp;<span class="comment" id="3589895">//&nbsp;cycles&nbsp;to&nbsp;wait&nbsp;to&nbsp;raise&nbsp;an&nbsp;interrupt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3589936">serialInThresh</span>&nbsp;<span class="op" id="3589951">=</span>&nbsp;<span class="ident" id="3589953">serialBase</span>&nbsp;<span class="op" id="3589964">+</span>&nbsp;<span class="num" id="3589966">12</span>&nbsp;<span class="comment" id="3589969">//&nbsp;threashold&nbsp;to&nbsp;raise&nbsp;an&nbsp;input&nbsp;interrupt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590013">serialOutHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3590029">=</span>&nbsp;<span class="ident" id="3590031">serialBase</span>&nbsp;<span class="op" id="3590042">+</span>&nbsp;<span class="num" id="3590044">16</span>&nbsp;<span class="comment" id="3590047">//&nbsp;updated&nbsp;by&nbsp;cpu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590066">serialOutTail</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3590082">=</span>&nbsp;<span class="ident" id="3590084">serialBase</span>&nbsp;<span class="op" id="3590095">+</span>&nbsp;<span class="num" id="3590097">20</span>&nbsp;<span class="comment" id="3590100">//&nbsp;updated&nbsp;by&nbsp;hardware</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590124">serialOutWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3590140">=</span>&nbsp;<span class="ident" id="3590142">serialBase</span>&nbsp;<span class="op" id="3590153">+</span>&nbsp;<span class="num" id="3590155">24</span>&nbsp;<span class="comment" id="3590158">//&nbsp;cycles&nbsp;to&nbsp;wait&nbsp;to&nbsp;raise&nbsp;an&nbsp;interrupt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590199">serialOutThresh</span>&nbsp;<span class="op" id="3590215">=</span>&nbsp;<span class="ident" id="3590217">serialBase</span>&nbsp;<span class="op" id="3590228">+</span>&nbsp;<span class="num" id="3590230">28</span>&nbsp;<span class="comment" id="3590233">//&nbsp;threashold&nbsp;to&nbsp;raise&nbsp;an&nbsp;output&nbsp;interrupt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590278">serialInBuf</span>&nbsp;&nbsp;<span class="op" id="3590291">=</span>&nbsp;<span class="ident" id="3590293">serialBase</span>&nbsp;<span class="op" id="3590304">+</span>&nbsp;<span class="num" id="3590306">64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590310">serialOutBuf</span>&nbsp;<span class="op" id="3590323">=</span>&nbsp;<span class="ident" id="3590325">serialBase</span>&nbsp;<span class="op" id="3590336">+</span>&nbsp;<span class="num" id="3590338">96</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590343">serialCap</span>&nbsp;<span class="op" id="3590353">=</span>&nbsp;<span class="num" id="3590355">30</span>&nbsp;<span class="comment" id="3590358">//&nbsp;30&nbsp;bytes&nbsp;maximum&nbsp;in&nbsp;each&nbsp;pipe</span><br>
<span class="lineno"></span><span class="op" id="3590391">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3590394">//&nbsp;NewSerial&nbsp;creates&nbsp;a&nbsp;new&nbsp;serial&nbsp;controller.</span><br>
<span class="lineno">45</span><span class="keyword" id="3590440">func</span>&nbsp;<span class="ident" id="3590445">newSerial</span><span class="op" id="3590454">(</span><span class="ident" id="3590455">p</span>&nbsp;<span class="op" id="3590457">*</span><span class="ident" id="3590458">page</span><span class="op" id="3590462">,</span>&nbsp;<span class="ident" id="3590464">i</span>&nbsp;<span class="ident" id="3590466">intBus</span><span class="op" id="3590472">)</span>&nbsp;<span class="op" id="3590474">*</span><span class="ident" id="3590475">serial</span>&nbsp;<span class="op" id="3590482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590485">ret</span>&nbsp;<span class="op" id="3590489">:=</span>&nbsp;<span class="builtinfunc" id="3590492">new</span><span class="op" id="3590495">(</span><span class="ident" id="3590496">serial</span><span class="op" id="3590502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590505">ret</span><span class="op" id="3590508">.</span><span class="ident" id="3590509">intBus</span>&nbsp;<span class="op" id="3590516">=</span>&nbsp;<span class="ident" id="3590518">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590521">ret</span><span class="op" id="3590524">.</span><span class="ident" id="3590525">p</span>&nbsp;<span class="op" id="3590527">=</span>&nbsp;<span class="ident" id="3590529">p</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3590533">//&nbsp;default&nbsp;interrupts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590556">ret</span><span class="op" id="3590559">.</span><span class="ident" id="3590560">Core</span>&nbsp;<span class="op" id="3590565">=</span>&nbsp;<span class="num" id="3590567">0</span>&nbsp;<span class="comment" id="3590569">//&nbsp;to&nbsp;core&nbsp;0&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590588">ret</span><span class="op" id="3590591">.</span><span class="ident" id="3590592">IntIn</span>&nbsp;<span class="op" id="3590598">=</span>&nbsp;<span class="num" id="3590600">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590603">ret</span><span class="op" id="3590606">.</span><span class="ident" id="3590607">IntOut</span>&nbsp;<span class="op" id="3590614">=</span>&nbsp;<span class="num" id="3590616">9</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590620">ret</span><span class="op" id="3590623">.</span><span class="ident" id="3590624">Output</span>&nbsp;<span class="op" id="3590631">=</span>&nbsp;<span class="ident" id="3590633">os</span><span class="op" id="3590635">.</span><span class="ident" id="3590636">Stdout</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3590645">return</span>&nbsp;<span class="ident" id="3590652">ret</span><br>
<span class="lineno"></span><span class="op" id="3590656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3590659">func</span>&nbsp;<span class="op" id="3590664">(</span><span class="ident" id="3590665">s</span>&nbsp;<span class="op" id="3590667">*</span><span class="ident" id="3590668">serial</span><span class="op" id="3590674">)</span>&nbsp;<span class="ident" id="3590676">interrupt</span><span class="op" id="3590685">(</span><span class="ident" id="3590686">code</span>&nbsp;<span class="builtintype" id="3590691">byte</span><span class="op" id="3590695">)</span>&nbsp;<span class="op" id="3590697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590700">s</span><span class="op" id="3590701">.</span><span class="ident" id="3590702">intBus</span><span class="op" id="3590708">.</span><span class="ident" id="3590709">Interrupt</span><span class="op" id="3590718">(</span><span class="ident" id="3590719">code</span><span class="op" id="3590723">,</span>&nbsp;<span class="ident" id="3590725">s</span><span class="op" id="3590726">.</span><span class="ident" id="3590727">Core</span><span class="op" id="3590731">)</span><br>
<span class="lineno"></span><span class="op" id="3590733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3590736">//&nbsp;WriteByte&nbsp;appends&nbsp;a&nbsp;byte&nbsp;into&nbsp;the&nbsp;input&nbsp;ring&nbsp;buffer.</span><br>
<span class="lineno">65</span><span class="keyword" id="3590792">func</span>&nbsp;<span class="op" id="3590797">(</span><span class="ident" id="3590798">s</span>&nbsp;<span class="op" id="3590800">*</span><span class="ident" id="3590801">serial</span><span class="op" id="3590807">)</span>&nbsp;<span class="ident" id="3590809">WriteByte</span><span class="op" id="3590818">(</span><span class="ident" id="3590819">b</span>&nbsp;<span class="builtintype" id="3590821">byte</span><span class="op" id="3590825">)</span>&nbsp;<span class="builtintype" id="3590827">bool</span>&nbsp;<span class="op" id="3590832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590835">head</span>&nbsp;<span class="op" id="3590840">:=</span>&nbsp;<span class="ident" id="3590843">s</span><span class="op" id="3590844">.</span><span class="ident" id="3590845">p</span><span class="op" id="3590846">.</span><span class="ident" id="3590847">ReadWord</span><span class="op" id="3590855">(</span><span class="ident" id="3590856">serialInHead</span><span class="op" id="3590868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590871">tail</span>&nbsp;<span class="op" id="3590876">:=</span>&nbsp;<span class="ident" id="3590879">s</span><span class="op" id="3590880">.</span><span class="ident" id="3590881">p</span><span class="op" id="3590882">.</span><span class="ident" id="3590883">ReadWord</span><span class="op" id="3590891">(</span><span class="ident" id="3590892">serialInTail</span><span class="op" id="3590904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590907">n</span>&nbsp;<span class="op" id="3590909">:=</span>&nbsp;<span class="ident" id="3590912">head</span>&nbsp;<span class="op" id="3590917">-</span>&nbsp;<span class="ident" id="3590919">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3590925">if</span>&nbsp;<span class="ident" id="3590928">n</span>&nbsp;<span class="op" id="3590930">&gt;=</span>&nbsp;<span class="ident" id="3590933">serialCap</span>&nbsp;<span class="op" id="3590943">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3590947">return</span>&nbsp;<span class="builtintype" id="3590954">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3590961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3590965">s</span><span class="op" id="3590966">.</span><span class="ident" id="3590967">p</span><span class="op" id="3590968">.</span><span class="ident" id="3590969">WriteByte</span><span class="op" id="3590978">(</span><span class="ident" id="3590979">serialInBuf</span><span class="op" id="3590990">+</span><span class="ident" id="3590991">head</span><span class="op" id="3590995">%</span><span class="num" id="3590996">32</span><span class="op" id="3590998">,</span>&nbsp;<span class="ident" id="3591000">b</span><span class="op" id="3591001">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591005">head</span><span class="op" id="3591009">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591013">s</span><span class="op" id="3591014">.</span><span class="ident" id="3591015">p</span><span class="op" id="3591016">.</span><span class="ident" id="3591017">WriteWord</span><span class="op" id="3591026">(</span><span class="ident" id="3591027">serialInTail</span><span class="op" id="3591039">,</span>&nbsp;<span class="ident" id="3591041">head</span><span class="op" id="3591045">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591049">n</span><span class="op" id="3591050">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591054">thresh</span>&nbsp;<span class="op" id="3591061">:=</span>&nbsp;<span class="ident" id="3591064">s</span><span class="op" id="3591065">.</span><span class="ident" id="3591066">p</span><span class="op" id="3591067">.</span><span class="ident" id="3591068">ReadWord</span><span class="op" id="3591076">(</span><span class="ident" id="3591077">serialInThresh</span><span class="op" id="3591091">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3591094">if</span>&nbsp;<span class="ident" id="3591097">n</span>&nbsp;<span class="op" id="3591099">&gt;=</span>&nbsp;<span class="ident" id="3591102">thresh</span>&nbsp;<span class="op" id="3591109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591113">s</span><span class="op" id="3591114">.</span><span class="ident" id="3591115">interrupt</span><span class="op" id="3591124">(</span><span class="ident" id="3591125">s</span><span class="op" id="3591126">.</span><span class="ident" id="3591127">IntIn</span><span class="op" id="3591132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3591135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3591139">return</span>&nbsp;<span class="builtintype" id="3591146">true</span><br>
<span class="lineno">85</span><span class="op" id="3591151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3591154">//&nbsp;OutLen&nbsp;returns&nbsp;the&nbsp;current&nbsp;buffer&nbsp;length&nbsp;of&nbsp;the&nbsp;output&nbsp;ring&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3591225">func</span>&nbsp;<span class="op" id="3591230">(</span><span class="ident" id="3591231">s</span>&nbsp;<span class="op" id="3591233">*</span><span class="ident" id="3591234">serial</span><span class="op" id="3591240">)</span>&nbsp;<span class="ident" id="3591242">OutLen</span><span class="op" id="3591248">(</span><span class="op" id="3591249">)</span>&nbsp;<span class="builtintype" id="3591251">uint32</span>&nbsp;<span class="op" id="3591258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591261">head</span>&nbsp;<span class="op" id="3591266">:=</span>&nbsp;<span class="ident" id="3591269">s</span><span class="op" id="3591270">.</span><span class="ident" id="3591271">p</span><span class="op" id="3591272">.</span><span class="ident" id="3591273">ReadWord</span><span class="op" id="3591281">(</span><span class="ident" id="3591282">serialOutHead</span><span class="op" id="3591295">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591298">tail</span>&nbsp;<span class="op" id="3591303">:=</span>&nbsp;<span class="ident" id="3591306">s</span><span class="op" id="3591307">.</span><span class="ident" id="3591308">p</span><span class="op" id="3591309">.</span><span class="ident" id="3591310">ReadWord</span><span class="op" id="3591318">(</span><span class="ident" id="3591319">serialOutTail</span><span class="op" id="3591332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591335">ret</span>&nbsp;<span class="op" id="3591339">:=</span>&nbsp;<span class="ident" id="3591342">head</span>&nbsp;<span class="op" id="3591347">-</span>&nbsp;<span class="ident" id="3591349">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3591355">if</span>&nbsp;<span class="ident" id="3591358">ret</span>&nbsp;<span class="op" id="3591362">&gt;</span>&nbsp;<span class="ident" id="3591364">serialCap</span>&nbsp;<span class="op" id="3591374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591378">log</span><span class="op" id="3591381">.</span><span class="ident" id="3591382">Printf</span><span class="op" id="3591388">(</span><span class="string" id="3591389">&#34;error&nbsp;output&nbsp;buffer&nbsp;length&#34;</span><span class="op" id="3591417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3591421">//&nbsp;on&nbsp;error&nbsp;set&nbsp;the&nbsp;length&nbsp;to&nbsp;full</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3591458">//&nbsp;to&nbsp;avoid&nbsp;trigger&nbsp;interrupt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591490">ret</span>&nbsp;<span class="op" id="3591494">=</span>&nbsp;<span class="ident" id="3591496">serialCap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3591507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3591510">return</span>&nbsp;<span class="ident" id="3591517">ret</span><br>
<span class="lineno"></span><span class="op" id="3591521">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="3591524">//&nbsp;InLen&nbsp;returns&nbsp;the&nbsp;current&nbsp;buffer&nbsp;length&nbsp;of&nbsp;the&nbsp;input&nbsp;ring&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3591593">func</span>&nbsp;<span class="op" id="3591598">(</span><span class="ident" id="3591599">s</span>&nbsp;<span class="op" id="3591601">*</span><span class="ident" id="3591602">serial</span><span class="op" id="3591608">)</span>&nbsp;<span class="ident" id="3591610">InLen</span><span class="op" id="3591615">(</span><span class="op" id="3591616">)</span>&nbsp;<span class="builtintype" id="3591618">uint32</span>&nbsp;<span class="op" id="3591625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591628">head</span>&nbsp;<span class="op" id="3591633">:=</span>&nbsp;<span class="ident" id="3591636">s</span><span class="op" id="3591637">.</span><span class="ident" id="3591638">p</span><span class="op" id="3591639">.</span><span class="ident" id="3591640">ReadWord</span><span class="op" id="3591648">(</span><span class="ident" id="3591649">serialInHead</span><span class="op" id="3591661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591664">tail</span>&nbsp;<span class="op" id="3591669">:=</span>&nbsp;<span class="ident" id="3591672">s</span><span class="op" id="3591673">.</span><span class="ident" id="3591674">p</span><span class="op" id="3591675">.</span><span class="ident" id="3591676">ReadWord</span><span class="op" id="3591684">(</span><span class="ident" id="3591685">serialInTail</span><span class="op" id="3591697">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591700">ret</span>&nbsp;<span class="op" id="3591704">:=</span>&nbsp;<span class="ident" id="3591707">head</span>&nbsp;<span class="op" id="3591712">-</span>&nbsp;<span class="ident" id="3591714">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3591720">if</span>&nbsp;<span class="ident" id="3591723">ret</span>&nbsp;<span class="op" id="3591727">&gt;</span>&nbsp;<span class="ident" id="3591729">serialCap</span>&nbsp;<span class="op" id="3591739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591743">log</span><span class="op" id="3591746">.</span><span class="ident" id="3591747">Printf</span><span class="op" id="3591753">(</span><span class="string" id="3591754">&#34;error&nbsp;input&nbsp;buffer&nbsp;length&#34;</span><span class="op" id="3591781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3591785">//&nbsp;on&nbsp;error,&nbsp;set&nbsp;the&nbsp;length&nbsp;to&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3591824">//&nbsp;to&nbsp;avoid&nbsp;trigger&nbsp;interrupt</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591856">ret</span>&nbsp;<span class="op" id="3591860">=</span>&nbsp;<span class="num" id="3591862">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3591865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3591868">return</span>&nbsp;<span class="ident" id="3591875">ret</span><br>
<span class="lineno"></span><span class="op" id="3591879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="3591882">//&nbsp;ReadByte&nbsp;reads&nbsp;a&nbsp;byte&nbsp;out&nbsp;of&nbsp;serial&nbsp;output&nbsp;ring&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3591941">func</span>&nbsp;<span class="op" id="3591946">(</span><span class="ident" id="3591947">s</span>&nbsp;<span class="op" id="3591949">*</span><span class="ident" id="3591950">serial</span><span class="op" id="3591956">)</span>&nbsp;<span class="ident" id="3591958">ReadByte</span><span class="op" id="3591966">(</span><span class="op" id="3591967">)</span>&nbsp;<span class="op" id="3591969">(</span><span class="builtintype" id="3591970">byte</span><span class="op" id="3591974">,</span>&nbsp;<span class="builtintype" id="3591976">bool</span><span class="op" id="3591980">)</span>&nbsp;<span class="op" id="3591982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3591985">head</span>&nbsp;<span class="op" id="3591990">:=</span>&nbsp;<span class="ident" id="3591993">s</span><span class="op" id="3591994">.</span><span class="ident" id="3591995">p</span><span class="op" id="3591996">.</span><span class="ident" id="3591997">ReadWord</span><span class="op" id="3592005">(</span><span class="ident" id="3592006">serialOutHead</span><span class="op" id="3592019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592022">tail</span>&nbsp;<span class="op" id="3592027">:=</span>&nbsp;<span class="ident" id="3592030">s</span><span class="op" id="3592031">.</span><span class="ident" id="3592032">p</span><span class="op" id="3592033">.</span><span class="ident" id="3592034">ReadWord</span><span class="op" id="3592042">(</span><span class="ident" id="3592043">serialOutTail</span><span class="op" id="3592056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592059">n</span>&nbsp;<span class="op" id="3592061">:=</span>&nbsp;<span class="ident" id="3592064">head</span>&nbsp;<span class="op" id="3592069">-</span>&nbsp;<span class="ident" id="3592071">tail</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592077">if</span>&nbsp;<span class="ident" id="3592080">n</span>&nbsp;<span class="op" id="3592082">==</span>&nbsp;<span class="num" id="3592085">0</span>&nbsp;<span class="op" id="3592087">||</span>&nbsp;<span class="ident" id="3592090">n</span>&nbsp;<span class="op" id="3592092">&gt;</span>&nbsp;<span class="ident" id="3592094">serialCap</span>&nbsp;<span class="op" id="3592104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592108">return</span>&nbsp;<span class="num" id="3592115">0</span><span class="op" id="3592116">,</span>&nbsp;<span class="builtintype" id="3592118">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592129">b</span>&nbsp;<span class="op" id="3592131">:=</span>&nbsp;<span class="ident" id="3592134">s</span><span class="op" id="3592135">.</span><span class="ident" id="3592136">p</span><span class="op" id="3592137">.</span><span class="ident" id="3592138">ReadByte</span><span class="op" id="3592146">(</span><span class="ident" id="3592147">serialOutBuf</span>&nbsp;<span class="op" id="3592160">+</span>&nbsp;<span class="ident" id="3592162">tail</span><span class="op" id="3592166">%</span><span class="num" id="3592167">32</span><span class="op" id="3592169">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592172">tail</span><span class="op" id="3592176">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592180">s</span><span class="op" id="3592181">.</span><span class="ident" id="3592182">p</span><span class="op" id="3592183">.</span><span class="ident" id="3592184">WriteWord</span><span class="op" id="3592193">(</span><span class="ident" id="3592194">serialOutTail</span><span class="op" id="3592207">,</span>&nbsp;<span class="ident" id="3592209">tail</span><span class="op" id="3592213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592217">n</span><span class="op" id="3592218">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592222">thresh</span>&nbsp;<span class="op" id="3592229">:=</span>&nbsp;<span class="ident" id="3592232">s</span><span class="op" id="3592233">.</span><span class="ident" id="3592234">p</span><span class="op" id="3592235">.</span><span class="ident" id="3592236">ReadWord</span><span class="op" id="3592244">(</span><span class="ident" id="3592245">serialOutThresh</span><span class="op" id="3592260">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592263">if</span>&nbsp;<span class="ident" id="3592266">n</span>&nbsp;<span class="op" id="3592268">&lt;=</span>&nbsp;<span class="ident" id="3592271">thresh</span>&nbsp;<span class="op" id="3592278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592282">s</span><span class="op" id="3592283">.</span><span class="ident" id="3592284">interrupt</span><span class="op" id="3592293">(</span><span class="ident" id="3592294">s</span><span class="op" id="3592295">.</span><span class="ident" id="3592296">IntOut</span><span class="op" id="3592302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592309">return</span>&nbsp;<span class="ident" id="3592316">b</span><span class="op" id="3592317">,</span>&nbsp;<span class="builtintype" id="3592319">true</span><br>
<span class="lineno">135</span><span class="op" id="3592324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3592327">func</span>&nbsp;<span class="op" id="3592332">(</span><span class="ident" id="3592333">s</span>&nbsp;<span class="op" id="3592335">*</span><span class="ident" id="3592336">serial</span><span class="op" id="3592342">)</span>&nbsp;<span class="ident" id="3592344">countDown</span><span class="op" id="3592353">(</span><span class="op" id="3592354">)</span>&nbsp;<span class="op" id="3592356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592359">inWait</span>&nbsp;<span class="op" id="3592366">:=</span>&nbsp;<span class="ident" id="3592369">s</span><span class="op" id="3592370">.</span><span class="ident" id="3592371">p</span><span class="op" id="3592372">.</span><span class="ident" id="3592373">ReadWord</span><span class="op" id="3592381">(</span><span class="ident" id="3592382">serialInWait</span><span class="op" id="3592394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592397">outWait</span>&nbsp;<span class="op" id="3592405">:=</span>&nbsp;<span class="ident" id="3592408">s</span><span class="op" id="3592409">.</span><span class="ident" id="3592410">p</span><span class="op" id="3592411">.</span><span class="ident" id="3592412">ReadWord</span><span class="op" id="3592420">(</span><span class="ident" id="3592421">serialOutWait</span><span class="op" id="3592434">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592438">if</span>&nbsp;<span class="ident" id="3592441">inWait</span>&nbsp;<span class="op" id="3592448">&gt;</span>&nbsp;<span class="num" id="3592450">0</span>&nbsp;<span class="op" id="3592452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592456">inWait</span><span class="op" id="3592462">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592469">if</span>&nbsp;<span class="ident" id="3592472">outWait</span>&nbsp;<span class="op" id="3592480">&gt;</span>&nbsp;<span class="num" id="3592482">0</span>&nbsp;<span class="op" id="3592484">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592488">outWait</span><span class="op" id="3592495">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592503">if</span>&nbsp;<span class="ident" id="3592506">inWait</span>&nbsp;<span class="op" id="3592513">==</span>&nbsp;<span class="num" id="3592516">0</span>&nbsp;<span class="op" id="3592518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592522">if</span>&nbsp;<span class="ident" id="3592525">s</span><span class="op" id="3592526">.</span><span class="ident" id="3592527">InLen</span><span class="op" id="3592532">(</span><span class="op" id="3592533">)</span>&nbsp;<span class="op" id="3592535">&gt;</span>&nbsp;<span class="num" id="3592537">0</span>&nbsp;<span class="op" id="3592539">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592544">s</span><span class="op" id="3592545">.</span><span class="ident" id="3592546">interrupt</span><span class="op" id="3592555">(</span><span class="ident" id="3592556">s</span><span class="op" id="3592557">.</span><span class="ident" id="3592558">IntIn</span><span class="op" id="3592563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592574">if</span>&nbsp;<span class="ident" id="3592577">outWait</span>&nbsp;<span class="op" id="3592585">==</span>&nbsp;<span class="num" id="3592588">0</span>&nbsp;<span class="op" id="3592590">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592594">if</span>&nbsp;<span class="ident" id="3592597">s</span><span class="op" id="3592598">.</span><span class="ident" id="3592599">OutLen</span><span class="op" id="3592605">(</span><span class="op" id="3592606">)</span>&nbsp;<span class="op" id="3592608">&lt;</span>&nbsp;<span class="ident" id="3592610">serialCap</span>&nbsp;<span class="op" id="3592620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592625">s</span><span class="op" id="3592626">.</span><span class="ident" id="3592627">interrupt</span><span class="op" id="3592636">(</span><span class="ident" id="3592637">s</span><span class="op" id="3592638">.</span><span class="ident" id="3592639">IntOut</span><span class="op" id="3592645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592656">s</span><span class="op" id="3592657">.</span><span class="ident" id="3592658">p</span><span class="op" id="3592659">.</span><span class="ident" id="3592660">WriteWord</span><span class="op" id="3592669">(</span><span class="ident" id="3592670">serialInWait</span><span class="op" id="3592682">,</span>&nbsp;<span class="ident" id="3592684">inWait</span><span class="op" id="3592690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592693">s</span><span class="op" id="3592694">.</span><span class="ident" id="3592695">p</span><span class="op" id="3592696">.</span><span class="ident" id="3592697">WriteWord</span><span class="op" id="3592706">(</span><span class="ident" id="3592707">serialOutWait</span><span class="op" id="3592720">,</span>&nbsp;<span class="ident" id="3592722">outWait</span><span class="op" id="3592729">)</span><br>
<span class="lineno"></span><span class="op" id="3592731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3592734">func</span>&nbsp;<span class="op" id="3592739">(</span><span class="ident" id="3592740">s</span>&nbsp;<span class="op" id="3592742">*</span><span class="ident" id="3592743">serial</span><span class="op" id="3592749">)</span>&nbsp;<span class="ident" id="3592751">flush</span><span class="op" id="3592756">(</span><span class="op" id="3592757">)</span>&nbsp;<span class="op" id="3592759">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592762">buf</span>&nbsp;<span class="op" id="3592766">:=</span>&nbsp;<span class="builtinfunc" id="3592769">new</span><span class="op" id="3592772">(</span><span class="ident" id="3592773">bytes</span><span class="op" id="3592778">.</span><span class="ident" id="3592779">Buffer</span><span class="op" id="3592785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592788">for</span>&nbsp;<span class="op" id="3592792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592796">b</span><span class="op" id="3592797">,</span>&nbsp;<span class="ident" id="3592799">valid</span>&nbsp;<span class="op" id="3592805">:=</span>&nbsp;<span class="ident" id="3592808">s</span><span class="op" id="3592809">.</span><span class="ident" id="3592810">ReadByte</span><span class="op" id="3592818">(</span><span class="op" id="3592819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592823">if</span>&nbsp;<span class="ident" id="3592826">valid</span>&nbsp;<span class="op" id="3592832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592837">buf</span><span class="op" id="3592840">.</span><span class="ident" id="3592841">WriteByte</span><span class="op" id="3592850">(</span><span class="ident" id="3592851">b</span><span class="op" id="3592852">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592856">}</span>&nbsp;<span class="keyword" id="3592858">else</span>&nbsp;<span class="op" id="3592863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592868">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592883">if</span>&nbsp;<span class="ident" id="3592886">s</span><span class="op" id="3592887">.</span><span class="ident" id="3592888">Output</span>&nbsp;<span class="op" id="3592895">!=</span>&nbsp;<span class="ident" id="3592898">nil</span>&nbsp;<span class="op" id="3592902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592906">_</span><span class="op" id="3592907">,</span>&nbsp;<span class="ident" id="3592909">e</span>&nbsp;<span class="op" id="3592911">:=</span>&nbsp;<span class="ident" id="3592914">s</span><span class="op" id="3592915">.</span><span class="ident" id="3592916">Output</span><span class="op" id="3592922">.</span><span class="ident" id="3592923">Write</span><span class="op" id="3592928">(</span><span class="ident" id="3592929">buf</span><span class="op" id="3592932">.</span><span class="ident" id="3592933">Bytes</span><span class="op" id="3592938">(</span><span class="op" id="3592939">)</span><span class="op" id="3592940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592944">if</span>&nbsp;<span class="ident" id="3592947">e</span>&nbsp;<span class="op" id="3592949">!=</span>&nbsp;<span class="ident" id="3592952">nil</span>&nbsp;<span class="op" id="3592956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592961">log</span><span class="op" id="3592964">.</span><span class="ident" id="3592965">Print</span><span class="op" id="3592970">(</span><span class="ident" id="3592971">e</span><span class="op" id="3592972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592976">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3592979">}</span><br>
<span class="lineno"></span><span class="op" id="3592981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3592984">//&nbsp;Tick&nbsp;counts&nbsp;down&nbsp;the&nbsp;waiting&nbsp;counters&nbsp;and&nbsp;triggers</span><br>
<span class="lineno"></span><span class="comment" id="3593038">//&nbsp;interrupt&nbsp;when&nbsp;the&nbsp;count&nbsp;down&nbsp;reaches&nbsp;zero.</span><br>
<span class="lineno">185</span><span class="keyword" id="3593085">func</span>&nbsp;<span class="op" id="3593090">(</span><span class="ident" id="3593091">s</span>&nbsp;<span class="op" id="3593093">*</span><span class="ident" id="3593094">serial</span><span class="op" id="3593100">)</span>&nbsp;<span class="ident" id="3593102">Tick</span><span class="op" id="3593106">(</span><span class="op" id="3593107">)</span>&nbsp;<span class="op" id="3593109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3593112">s</span><span class="op" id="3593113">.</span><span class="ident" id="3593114">flush</span><span class="op" id="3593119">(</span><span class="op" id="3593120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3593123">s</span><span class="op" id="3593124">.</span><span class="ident" id="3593125">countDown</span><span class="op" id="3593134">(</span><span class="op" id="3593135">)</span><br>
<span class="lineno"></span><span class="op" id="3593137">}</span>
</div>
</body>
</html>
