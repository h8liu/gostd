<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/flate</h2>
<ul>
<li><a href="/gostd/compress/flate/copy.go.html">copy.go</a></li>
<li><a href="/gostd/compress/flate/copy_test.go.html">copy_test.go</a></li>
<li><a href="/gostd/compress/flate/deflate.go.html" class="current">deflate.go</a></li>
<li><a href="/gostd/compress/flate/deflate_test.go.html">deflate_test.go</a></li>
<li><a href="/gostd/compress/flate/fixedhuff.go.html">fixedhuff.go</a></li>
<li><a href="/gostd/compress/flate/flate_test.go.html">flate_test.go</a></li>
<li><a href="/gostd/compress/flate/huffman_bit_writer.go.html">huffman_bit_writer.go</a></li>
<li><a href="/gostd/compress/flate/huffman_code.go.html">huffman_code.go</a></li>
<li><a href="/gostd/compress/flate/inflate.go.html">inflate.go</a></li>
<li><a href="/gostd/compress/flate/inflate_test.go.html">inflate_test.go</a></li>
<li><a href="/gostd/compress/flate/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/flate/reverse_bits.go.html">reverse_bits.go</a></li>
<li><a href="/gostd/compress/flate/token.go.html">token.go</a></li>
<li><a href="/gostd/compress/flate/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4774527">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4774582">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4774636">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4774687">package</span>&nbsp;<span class="ident" id="4774695">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4774702">import</span>&nbsp;<span class="op" id="4774709">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4774712">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4774719">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4774725">&#34;math&#34;</span><br>
<span class="lineno"></span><span class="op" id="4774732">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4774735">const</span>&nbsp;<span class="op" id="4774741">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4774744">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4774763">=</span>&nbsp;<span class="num" id="4774765">0</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4774768">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4774787">=</span>&nbsp;<span class="num" id="4774789">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4774792">fastCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4774811">=</span>&nbsp;<span class="num" id="4774813">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4774816">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4774835">=</span>&nbsp;<span class="num" id="4774837">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4774840">DefaultCompression</span>&nbsp;<span class="op" id="4774859">=</span>&nbsp;<span class="op" id="4774861">-</span><span class="num" id="4774862">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4774865">logWindowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4774884">=</span>&nbsp;<span class="num" id="4774886">15</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4774890">windowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4774909">=</span>&nbsp;<span class="num" id="4774911">1</span>&nbsp;<span class="op" id="4774913">&lt;&lt;</span>&nbsp;<span class="ident" id="4774916">logWindowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4774931">windowMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4774950">=</span>&nbsp;<span class="ident" id="4774952">windowSize</span>&nbsp;<span class="op" id="4774963">-</span>&nbsp;<span class="num" id="4774965">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4774968">logMaxOffsetSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4774987">=</span>&nbsp;<span class="num" id="4774989">15</span>&nbsp;&nbsp;<span class="comment" id="4774993">//&nbsp;Standard&nbsp;DEFLATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4775014">minMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4775033">=</span>&nbsp;<span class="num" id="4775035">3</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4775039">//&nbsp;The&nbsp;smallest&nbsp;match&nbsp;that&nbsp;the&nbsp;compressor&nbsp;looks&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4775092">maxMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4775111">=</span>&nbsp;<span class="num" id="4775113">258</span>&nbsp;<span class="comment" id="4775117">//&nbsp;The&nbsp;longest&nbsp;match&nbsp;for&nbsp;the&nbsp;compressor</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4775158">minOffsetSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4775177">=</span>&nbsp;<span class="num" id="4775179">1</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4775183">//&nbsp;The&nbsp;shortest&nbsp;offset&nbsp;that&nbsp;makes&nbsp;any&nbsp;sense</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4775229">//&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;tokens&nbsp;we&nbsp;put&nbsp;into&nbsp;a&nbsp;single&nbsp;flat&nbsp;block,&nbsp;just&nbsp;too</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4775304">//&nbsp;stop&nbsp;things&nbsp;from&nbsp;getting&nbsp;too&nbsp;large.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4775344">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4775364">=</span>&nbsp;<span class="num" id="4775366">1</span>&nbsp;<span class="op" id="4775368">&lt;&lt;</span>&nbsp;<span class="num" id="4775371">14</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4775375">maxStoreBlockSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4775395">=</span>&nbsp;<span class="num" id="4775397">65535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4775404">hashBits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4775424">=</span>&nbsp;<span class="num" id="4775426">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4775430">hashSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4775450">=</span>&nbsp;<span class="num" id="4775452">1</span>&nbsp;<span class="op" id="4775454">&lt;&lt;</span>&nbsp;<span class="ident" id="4775457">hashBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4775467">hashMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4775487">=</span>&nbsp;<span class="op" id="4775489">(</span><span class="num" id="4775490">1</span>&nbsp;<span class="op" id="4775492">&lt;&lt;</span>&nbsp;<span class="ident" id="4775495">hashBits</span><span class="op" id="4775503">)</span>&nbsp;<span class="op" id="4775505">-</span>&nbsp;<span class="num" id="4775507">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4775510">hashShift</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4775530">=</span>&nbsp;<span class="op" id="4775532">(</span><span class="ident" id="4775533">hashBits</span>&nbsp;<span class="op" id="4775542">+</span>&nbsp;<span class="ident" id="4775544">minMatchLength</span>&nbsp;<span class="op" id="4775559">-</span>&nbsp;<span class="num" id="4775561">1</span><span class="op" id="4775562">)</span>&nbsp;<span class="op" id="4775564">/</span>&nbsp;<span class="ident" id="4775566">minMatchLength</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4775582">maxHashOffset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4775602">=</span>&nbsp;<span class="num" id="4775604">1</span>&nbsp;<span class="op" id="4775606">&lt;&lt;</span>&nbsp;<span class="num" id="4775609">24</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4775614">skipNever</span>&nbsp;<span class="op" id="4775624">=</span>&nbsp;<span class="ident" id="4775626">math</span><span class="op" id="4775630">.</span><span class="ident" id="4775631">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="4775640">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="4775643">type</span>&nbsp;<span class="ident" id="4775648">compressionLevel</span>&nbsp;<span class="keyword" id="4775665">struct</span>&nbsp;<span class="op" id="4775672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4775675">good</span><span class="op" id="4775679">,</span>&nbsp;<span class="ident" id="4775681">lazy</span><span class="op" id="4775685">,</span>&nbsp;<span class="ident" id="4775687">nice</span><span class="op" id="4775691">,</span>&nbsp;<span class="ident" id="4775693">chain</span><span class="op" id="4775698">,</span>&nbsp;<span class="ident" id="4775700">fastSkipHashing</span>&nbsp;<span class="builtintype" id="4775716">int</span><br>
<span class="lineno"></span><span class="op" id="4775720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4775723">var</span>&nbsp;<span class="ident" id="4775727">levels</span>&nbsp;<span class="op" id="4775734">=</span>&nbsp;<span class="op" id="4775736">[</span><span class="op" id="4775737">]</span><span class="ident" id="4775738">compressionLevel</span><span class="op" id="4775754">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4775757">{</span><span class="op" id="4775758">}</span><span class="op" id="4775759">,</span>&nbsp;<span class="comment" id="4775761">//&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4775767">//&nbsp;For&nbsp;levels&nbsp;1-3&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;trying&nbsp;with&nbsp;lazy&nbsp;matches</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4775827">{</span><span class="num" id="4775828">3</span><span class="op" id="4775829">,</span>&nbsp;<span class="num" id="4775831">0</span><span class="op" id="4775832">,</span>&nbsp;<span class="num" id="4775834">8</span><span class="op" id="4775835">,</span>&nbsp;<span class="num" id="4775837">4</span><span class="op" id="4775838">,</span>&nbsp;<span class="num" id="4775840">4</span><span class="op" id="4775841">}</span><span class="op" id="4775842">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4775845">{</span><span class="num" id="4775846">3</span><span class="op" id="4775847">,</span>&nbsp;<span class="num" id="4775849">0</span><span class="op" id="4775850">,</span>&nbsp;<span class="num" id="4775852">16</span><span class="op" id="4775854">,</span>&nbsp;<span class="num" id="4775856">8</span><span class="op" id="4775857">,</span>&nbsp;<span class="num" id="4775859">5</span><span class="op" id="4775860">}</span><span class="op" id="4775861">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4775864">{</span><span class="num" id="4775865">3</span><span class="op" id="4775866">,</span>&nbsp;<span class="num" id="4775868">0</span><span class="op" id="4775869">,</span>&nbsp;<span class="num" id="4775871">32</span><span class="op" id="4775873">,</span>&nbsp;<span class="num" id="4775875">32</span><span class="op" id="4775877">,</span>&nbsp;<span class="num" id="4775879">6</span><span class="op" id="4775880">}</span><span class="op" id="4775881">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4775884">//&nbsp;Levels&nbsp;4-9&nbsp;use&nbsp;increasingly&nbsp;more&nbsp;lazy&nbsp;matching</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4775935">//&nbsp;and&nbsp;increasingly&nbsp;stringent&nbsp;conditions&nbsp;for&nbsp;&#34;good&nbsp;enough&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4775996">{</span><span class="num" id="4775997">4</span><span class="op" id="4775998">,</span>&nbsp;<span class="num" id="4776000">4</span><span class="op" id="4776001">,</span>&nbsp;<span class="num" id="4776003">16</span><span class="op" id="4776005">,</span>&nbsp;<span class="num" id="4776007">16</span><span class="op" id="4776009">,</span>&nbsp;<span class="ident" id="4776011">skipNever</span><span class="op" id="4776020">}</span><span class="op" id="4776021">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4776024">{</span><span class="num" id="4776025">8</span><span class="op" id="4776026">,</span>&nbsp;<span class="num" id="4776028">16</span><span class="op" id="4776030">,</span>&nbsp;<span class="num" id="4776032">32</span><span class="op" id="4776034">,</span>&nbsp;<span class="num" id="4776036">32</span><span class="op" id="4776038">,</span>&nbsp;<span class="ident" id="4776040">skipNever</span><span class="op" id="4776049">}</span><span class="op" id="4776050">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4776053">{</span><span class="num" id="4776054">8</span><span class="op" id="4776055">,</span>&nbsp;<span class="num" id="4776057">16</span><span class="op" id="4776059">,</span>&nbsp;<span class="num" id="4776061">128</span><span class="op" id="4776064">,</span>&nbsp;<span class="num" id="4776066">128</span><span class="op" id="4776069">,</span>&nbsp;<span class="ident" id="4776071">skipNever</span><span class="op" id="4776080">}</span><span class="op" id="4776081">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4776084">{</span><span class="num" id="4776085">8</span><span class="op" id="4776086">,</span>&nbsp;<span class="num" id="4776088">32</span><span class="op" id="4776090">,</span>&nbsp;<span class="num" id="4776092">128</span><span class="op" id="4776095">,</span>&nbsp;<span class="num" id="4776097">256</span><span class="op" id="4776100">,</span>&nbsp;<span class="ident" id="4776102">skipNever</span><span class="op" id="4776111">}</span><span class="op" id="4776112">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4776115">{</span><span class="num" id="4776116">32</span><span class="op" id="4776118">,</span>&nbsp;<span class="num" id="4776120">128</span><span class="op" id="4776123">,</span>&nbsp;<span class="num" id="4776125">258</span><span class="op" id="4776128">,</span>&nbsp;<span class="num" id="4776130">1024</span><span class="op" id="4776134">,</span>&nbsp;<span class="ident" id="4776136">skipNever</span><span class="op" id="4776145">}</span><span class="op" id="4776146">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4776149">{</span><span class="num" id="4776150">32</span><span class="op" id="4776152">,</span>&nbsp;<span class="num" id="4776154">258</span><span class="op" id="4776157">,</span>&nbsp;<span class="num" id="4776159">258</span><span class="op" id="4776162">,</span>&nbsp;<span class="num" id="4776164">4096</span><span class="op" id="4776168">,</span>&nbsp;<span class="ident" id="4776170">skipNever</span><span class="op" id="4776179">}</span><span class="op" id="4776180">,</span><br>
<span class="lineno"></span><span class="op" id="4776182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4776185">type</span>&nbsp;<span class="ident" id="4776190">compressor</span>&nbsp;<span class="keyword" id="4776201">struct</span>&nbsp;<span class="op" id="4776208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776211">compressionLevel</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776230">w</span>&nbsp;<span class="op" id="4776232">*</span><span class="ident" id="4776233">huffmanBitWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4776252">//&nbsp;compression&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776278">fill</span>&nbsp;<span class="keyword" id="4776283">func</span><span class="op" id="4776287">(</span><span class="op" id="4776288">*</span><span class="ident" id="4776289">compressor</span><span class="op" id="4776299">,</span>&nbsp;<span class="op" id="4776301">[</span><span class="op" id="4776302">]</span><span class="builtintype" id="4776303">byte</span><span class="op" id="4776307">)</span>&nbsp;<span class="builtintype" id="4776309">int</span>&nbsp;<span class="comment" id="4776313">//&nbsp;copy&nbsp;data&nbsp;to&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776337">step</span>&nbsp;<span class="keyword" id="4776342">func</span><span class="op" id="4776346">(</span><span class="op" id="4776347">*</span><span class="ident" id="4776348">compressor</span><span class="op" id="4776358">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4776372">//&nbsp;process&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776391">sync</span>&nbsp;<span class="builtintype" id="4776396">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4776426">//&nbsp;requesting&nbsp;flush</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4776448">//&nbsp;Input&nbsp;hash&nbsp;chains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4776470">//&nbsp;hashHead[hashValue]&nbsp;contains&nbsp;the&nbsp;largest&nbsp;inputIndex&nbsp;with&nbsp;the&nbsp;specified&nbsp;hash&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4776556">//&nbsp;If&nbsp;hashHead[hashValue]&nbsp;is&nbsp;within&nbsp;the&nbsp;current&nbsp;window,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4776618">//&nbsp;hashPrev[hashHead[hashValue]&nbsp;&amp;&nbsp;windowMask]&nbsp;contains&nbsp;the&nbsp;previous&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4776693">//&nbsp;with&nbsp;the&nbsp;same&nbsp;hash&nbsp;value.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776723">chainHead</span>&nbsp;&nbsp;<span class="builtintype" id="4776734">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776739">hashHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4776750">[</span><span class="op" id="4776751">]</span><span class="builtintype" id="4776752">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776757">hashPrev</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4776768">[</span><span class="op" id="4776769">]</span><span class="builtintype" id="4776770">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776775">hashOffset</span>&nbsp;<span class="builtintype" id="4776786">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4776792">//&nbsp;input&nbsp;window:&nbsp;unprocessed&nbsp;data&nbsp;is&nbsp;window[index:windowEnd]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776854">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4776868">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776873">window</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4776887">[</span><span class="op" id="4776888">]</span><span class="builtintype" id="4776889">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776895">windowEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4776909">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776914">blockStart</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4776928">int</span>&nbsp;&nbsp;<span class="comment" id="4776933">//&nbsp;window&nbsp;index&nbsp;where&nbsp;current&nbsp;tokens&nbsp;start</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4776977">byteAvailable</span>&nbsp;<span class="builtintype" id="4776991">bool</span>&nbsp;<span class="comment" id="4776996">//&nbsp;if&nbsp;true,&nbsp;still&nbsp;need&nbsp;to&nbsp;process&nbsp;window[index-1].</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4777049">//&nbsp;queued&nbsp;output&nbsp;tokens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777074">tokens</span>&nbsp;<span class="op" id="4777081">[</span><span class="op" id="4777082">]</span><span class="ident" id="4777083">token</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4777091">//&nbsp;deflate&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777109">length</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4777124">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777129">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4777144">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777149">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4777164">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777169">maxInsertIndex</span>&nbsp;<span class="builtintype" id="4777184">int</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777189">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4777204">error</span><br>
<span class="lineno"></span><span class="op" id="4777210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4777213">func</span>&nbsp;<span class="op" id="4777218">(</span><span class="ident" id="4777219">d</span>&nbsp;<span class="op" id="4777221">*</span><span class="ident" id="4777222">compressor</span><span class="op" id="4777232">)</span>&nbsp;<span class="ident" id="4777234">fillDeflate</span><span class="op" id="4777245">(</span><span class="ident" id="4777246">b</span>&nbsp;<span class="op" id="4777248">[</span><span class="op" id="4777249">]</span><span class="builtintype" id="4777250">byte</span><span class="op" id="4777254">)</span>&nbsp;<span class="builtintype" id="4777256">int</span>&nbsp;<span class="op" id="4777260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4777263">if</span>&nbsp;<span class="ident" id="4777266">d</span><span class="op" id="4777267">.</span><span class="ident" id="4777268">index</span>&nbsp;<span class="op" id="4777274">&gt;=</span>&nbsp;<span class="num" id="4777277">2</span><span class="op" id="4777278">*</span><span class="ident" id="4777279">windowSize</span><span class="op" id="4777289">-</span><span class="op" id="4777290">(</span><span class="ident" id="4777291">minMatchLength</span><span class="op" id="4777305">+</span><span class="ident" id="4777306">maxMatchLength</span><span class="op" id="4777320">)</span>&nbsp;<span class="op" id="4777322">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4777326">//&nbsp;shift&nbsp;the&nbsp;window&nbsp;by&nbsp;windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4777362">copy</span><span class="op" id="4777366">(</span><span class="ident" id="4777367">d</span><span class="op" id="4777368">.</span><span class="ident" id="4777369">window</span><span class="op" id="4777375">,</span>&nbsp;<span class="ident" id="4777377">d</span><span class="op" id="4777378">.</span><span class="ident" id="4777379">window</span><span class="op" id="4777385">[</span><span class="ident" id="4777386">windowSize</span><span class="op" id="4777396">:</span><span class="num" id="4777397">2</span><span class="op" id="4777398">*</span><span class="ident" id="4777399">windowSize</span><span class="op" id="4777409">]</span><span class="op" id="4777410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777414">d</span><span class="op" id="4777415">.</span><span class="ident" id="4777416">index</span>&nbsp;<span class="op" id="4777422">-=</span>&nbsp;<span class="ident" id="4777425">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777438">d</span><span class="op" id="4777439">.</span><span class="ident" id="4777440">windowEnd</span>&nbsp;<span class="op" id="4777450">-=</span>&nbsp;<span class="ident" id="4777453">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4777466">if</span>&nbsp;<span class="ident" id="4777469">d</span><span class="op" id="4777470">.</span><span class="ident" id="4777471">blockStart</span>&nbsp;<span class="op" id="4777482">&gt;=</span>&nbsp;<span class="ident" id="4777485">windowSize</span>&nbsp;<span class="op" id="4777496">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777501">d</span><span class="op" id="4777502">.</span><span class="ident" id="4777503">blockStart</span>&nbsp;<span class="op" id="4777514">-=</span>&nbsp;<span class="ident" id="4777517">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4777530">}</span>&nbsp;<span class="keyword" id="4777532">else</span>&nbsp;<span class="op" id="4777537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777542">d</span><span class="op" id="4777543">.</span><span class="ident" id="4777544">blockStart</span>&nbsp;<span class="op" id="4777555">=</span>&nbsp;<span class="ident" id="4777557">math</span><span class="op" id="4777561">.</span><span class="ident" id="4777562">MaxInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4777573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777577">d</span><span class="op" id="4777578">.</span><span class="ident" id="4777579">hashOffset</span>&nbsp;<span class="op" id="4777590">+=</span>&nbsp;<span class="ident" id="4777593">windowSize</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4777606">if</span>&nbsp;<span class="ident" id="4777609">d</span><span class="op" id="4777610">.</span><span class="ident" id="4777611">hashOffset</span>&nbsp;<span class="op" id="4777622">&gt;</span>&nbsp;<span class="ident" id="4777624">maxHashOffset</span>&nbsp;<span class="op" id="4777638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777643">delta</span>&nbsp;<span class="op" id="4777649">:=</span>&nbsp;<span class="ident" id="4777652">d</span><span class="op" id="4777653">.</span><span class="ident" id="4777654">hashOffset</span>&nbsp;<span class="op" id="4777665">-</span>&nbsp;<span class="num" id="4777667">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777672">d</span><span class="op" id="4777673">.</span><span class="ident" id="4777674">hashOffset</span>&nbsp;<span class="op" id="4777685">-=</span>&nbsp;<span class="ident" id="4777688">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777697">d</span><span class="op" id="4777698">.</span><span class="ident" id="4777699">chainHead</span>&nbsp;<span class="op" id="4777709">-=</span>&nbsp;<span class="ident" id="4777712">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4777721">for</span>&nbsp;<span class="ident" id="4777725">i</span><span class="op" id="4777726">,</span>&nbsp;<span class="ident" id="4777728">v</span>&nbsp;<span class="op" id="4777730">:=</span>&nbsp;<span class="keyword" id="4777733">range</span>&nbsp;<span class="ident" id="4777739">d</span><span class="op" id="4777740">.</span><span class="ident" id="4777741">hashPrev</span>&nbsp;<span class="op" id="4777750">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4777756">if</span>&nbsp;<span class="ident" id="4777759">v</span>&nbsp;<span class="op" id="4777761">&gt;</span>&nbsp;<span class="ident" id="4777763">delta</span>&nbsp;<span class="op" id="4777769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777776">d</span><span class="op" id="4777777">.</span><span class="ident" id="4777778">hashPrev</span><span class="op" id="4777786">[</span><span class="ident" id="4777787">i</span><span class="op" id="4777788">]</span>&nbsp;<span class="op" id="4777790">-=</span>&nbsp;<span class="ident" id="4777793">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4777803">}</span>&nbsp;<span class="keyword" id="4777805">else</span>&nbsp;<span class="op" id="4777810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777817">d</span><span class="op" id="4777818">.</span><span class="ident" id="4777819">hashPrev</span><span class="op" id="4777827">[</span><span class="ident" id="4777828">i</span><span class="op" id="4777829">]</span>&nbsp;<span class="op" id="4777831">=</span>&nbsp;<span class="num" id="4777833">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4777839">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4777844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4777849">for</span>&nbsp;<span class="ident" id="4777853">i</span><span class="op" id="4777854">,</span>&nbsp;<span class="ident" id="4777856">v</span>&nbsp;<span class="op" id="4777858">:=</span>&nbsp;<span class="keyword" id="4777861">range</span>&nbsp;<span class="ident" id="4777867">d</span><span class="op" id="4777868">.</span><span class="ident" id="4777869">hashHead</span>&nbsp;<span class="op" id="4777878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4777884">if</span>&nbsp;<span class="ident" id="4777887">v</span>&nbsp;<span class="op" id="4777889">&gt;</span>&nbsp;<span class="ident" id="4777891">delta</span>&nbsp;<span class="op" id="4777897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777904">d</span><span class="op" id="4777905">.</span><span class="ident" id="4777906">hashHead</span><span class="op" id="4777914">[</span><span class="ident" id="4777915">i</span><span class="op" id="4777916">]</span>&nbsp;<span class="op" id="4777918">-=</span>&nbsp;<span class="ident" id="4777921">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4777931">}</span>&nbsp;<span class="keyword" id="4777933">else</span>&nbsp;<span class="op" id="4777938">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777945">d</span><span class="op" id="4777946">.</span><span class="ident" id="4777947">hashHead</span><span class="op" id="4777955">[</span><span class="ident" id="4777956">i</span><span class="op" id="4777957">]</span>&nbsp;<span class="op" id="4777959">=</span>&nbsp;<span class="num" id="4777961">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4777967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4777972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4777976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4777979">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4777982">n</span>&nbsp;<span class="op" id="4777984">:=</span>&nbsp;<span class="builtinfunc" id="4777987">copy</span><span class="op" id="4777991">(</span><span class="ident" id="4777992">d</span><span class="op" id="4777993">.</span><span class="ident" id="4777994">window</span><span class="op" id="4778000">[</span><span class="ident" id="4778001">d</span><span class="op" id="4778002">.</span><span class="ident" id="4778003">windowEnd</span><span class="op" id="4778012">:</span><span class="op" id="4778013">]</span><span class="op" id="4778014">,</span>&nbsp;<span class="ident" id="4778016">b</span><span class="op" id="4778017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4778020">d</span><span class="op" id="4778021">.</span><span class="ident" id="4778022">windowEnd</span>&nbsp;<span class="op" id="4778032">+=</span>&nbsp;<span class="ident" id="4778035">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4778038">return</span>&nbsp;<span class="ident" id="4778045">n</span><br>
<span class="lineno"></span><span class="op" id="4778047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="4778050">func</span>&nbsp;<span class="op" id="4778055">(</span><span class="ident" id="4778056">d</span>&nbsp;<span class="op" id="4778058">*</span><span class="ident" id="4778059">compressor</span><span class="op" id="4778069">)</span>&nbsp;<span class="ident" id="4778071">writeBlock</span><span class="op" id="4778081">(</span><span class="ident" id="4778082">tokens</span>&nbsp;<span class="op" id="4778089">[</span><span class="op" id="4778090">]</span><span class="ident" id="4778091">token</span><span class="op" id="4778096">,</span>&nbsp;<span class="ident" id="4778098">index</span>&nbsp;<span class="builtintype" id="4778104">int</span><span class="op" id="4778107">,</span>&nbsp;<span class="ident" id="4778109">eof</span>&nbsp;<span class="builtintype" id="4778113">bool</span><span class="op" id="4778117">)</span>&nbsp;<span class="builtintype" id="4778119">error</span>&nbsp;<span class="op" id="4778125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4778128">if</span>&nbsp;<span class="ident" id="4778131">index</span>&nbsp;<span class="op" id="4778137">&gt;</span>&nbsp;<span class="num" id="4778139">0</span>&nbsp;<span class="op" id="4778141">||</span>&nbsp;<span class="ident" id="4778144">eof</span>&nbsp;<span class="op" id="4778148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4778152">var</span>&nbsp;<span class="ident" id="4778156">window</span>&nbsp;<span class="op" id="4778163">[</span><span class="op" id="4778164">]</span><span class="builtintype" id="4778165">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4778172">if</span>&nbsp;<span class="ident" id="4778175">d</span><span class="op" id="4778176">.</span><span class="ident" id="4778177">blockStart</span>&nbsp;<span class="op" id="4778188">&lt;=</span>&nbsp;<span class="ident" id="4778191">index</span>&nbsp;<span class="op" id="4778197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4778202">window</span>&nbsp;<span class="op" id="4778209">=</span>&nbsp;<span class="ident" id="4778211">d</span><span class="op" id="4778212">.</span><span class="ident" id="4778213">window</span><span class="op" id="4778219">[</span><span class="ident" id="4778220">d</span><span class="op" id="4778221">.</span><span class="ident" id="4778222">blockStart</span><span class="op" id="4778232">:</span><span class="ident" id="4778233">index</span><span class="op" id="4778238">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4778242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4778246">d</span><span class="op" id="4778247">.</span><span class="ident" id="4778248">blockStart</span>&nbsp;<span class="op" id="4778259">=</span>&nbsp;<span class="ident" id="4778261">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4778269">d</span><span class="op" id="4778270">.</span><span class="ident" id="4778271">w</span><span class="op" id="4778272">.</span><span class="ident" id="4778273">writeBlock</span><span class="op" id="4778283">(</span><span class="ident" id="4778284">tokens</span><span class="op" id="4778290">,</span>&nbsp;<span class="ident" id="4778292">eof</span><span class="op" id="4778295">,</span>&nbsp;<span class="ident" id="4778297">window</span><span class="op" id="4778303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4778307">return</span>&nbsp;<span class="ident" id="4778314">d</span><span class="op" id="4778315">.</span><span class="ident" id="4778316">w</span><span class="op" id="4778317">.</span><span class="ident" id="4778318">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4778323">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4778326">return</span>&nbsp;<span class="builtintype" id="4778333">nil</span><br>
<span class="lineno"></span><span class="op" id="4778337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4778340">//&nbsp;Try&nbsp;to&nbsp;find&nbsp;a&nbsp;match&nbsp;starting&nbsp;at&nbsp;index&nbsp;whose&nbsp;length&nbsp;is&nbsp;greater&nbsp;than&nbsp;prevSize.</span><br>
<span class="lineno"></span><span class="comment" id="4778420">//&nbsp;We&nbsp;only&nbsp;look&nbsp;at&nbsp;chainCount&nbsp;possibilities&nbsp;before&nbsp;giving&nbsp;up.</span><br>
<span class="lineno">150</span><span class="keyword" id="4778482">func</span>&nbsp;<span class="op" id="4778487">(</span><span class="ident" id="4778488">d</span>&nbsp;<span class="op" id="4778490">*</span><span class="ident" id="4778491">compressor</span><span class="op" id="4778501">)</span>&nbsp;<span class="ident" id="4778503">findMatch</span><span class="op" id="4778512">(</span><span class="ident" id="4778513">pos</span>&nbsp;<span class="builtintype" id="4778517">int</span><span class="op" id="4778520">,</span>&nbsp;<span class="ident" id="4778522">prevHead</span>&nbsp;<span class="builtintype" id="4778531">int</span><span class="op" id="4778534">,</span>&nbsp;<span class="ident" id="4778536">prevLength</span>&nbsp;<span class="builtintype" id="4778547">int</span><span class="op" id="4778550">,</span>&nbsp;<span class="ident" id="4778552">lookahead</span>&nbsp;<span class="builtintype" id="4778562">int</span><span class="op" id="4778565">)</span>&nbsp;<span class="op" id="4778567">(</span><span class="ident" id="4778568">length</span><span class="op" id="4778574">,</span>&nbsp;<span class="ident" id="4778576">offset</span>&nbsp;<span class="builtintype" id="4778583">int</span><span class="op" id="4778586">,</span>&nbsp;<span class="ident" id="4778588">ok</span>&nbsp;<span class="builtintype" id="4778591">bool</span><span class="op" id="4778595">)</span>&nbsp;<span class="op" id="4778597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4778600">minMatchLook</span>&nbsp;<span class="op" id="4778613">:=</span>&nbsp;<span class="ident" id="4778616">maxMatchLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4778632">if</span>&nbsp;<span class="ident" id="4778635">lookahead</span>&nbsp;<span class="op" id="4778645">&lt;</span>&nbsp;<span class="ident" id="4778647">minMatchLook</span>&nbsp;<span class="op" id="4778660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4778664">minMatchLook</span>&nbsp;<span class="op" id="4778677">=</span>&nbsp;<span class="ident" id="4778679">lookahead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4778690">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4778694">win</span>&nbsp;<span class="op" id="4778698">:=</span>&nbsp;<span class="ident" id="4778701">d</span><span class="op" id="4778702">.</span><span class="ident" id="4778703">window</span><span class="op" id="4778709">[</span><span class="num" id="4778710">0</span>&nbsp;<span class="op" id="4778712">:</span>&nbsp;<span class="ident" id="4778714">pos</span><span class="op" id="4778717">+</span><span class="ident" id="4778718">minMatchLook</span><span class="op" id="4778730">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4778734">//&nbsp;We&nbsp;quit&nbsp;when&nbsp;we&nbsp;get&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;at&nbsp;least&nbsp;nice&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4778792">nice</span>&nbsp;<span class="op" id="4778797">:=</span>&nbsp;<span class="builtinfunc" id="4778800">len</span><span class="op" id="4778803">(</span><span class="ident" id="4778804">win</span><span class="op" id="4778807">)</span>&nbsp;<span class="op" id="4778809">-</span>&nbsp;<span class="ident" id="4778811">pos</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4778816">if</span>&nbsp;<span class="ident" id="4778819">d</span><span class="op" id="4778820">.</span><span class="ident" id="4778821">nice</span>&nbsp;<span class="op" id="4778826">&lt;</span>&nbsp;<span class="ident" id="4778828">nice</span>&nbsp;<span class="op" id="4778833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4778837">nice</span>&nbsp;<span class="op" id="4778842">=</span>&nbsp;<span class="ident" id="4778844">d</span><span class="op" id="4778845">.</span><span class="ident" id="4778846">nice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4778852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4778856">//&nbsp;If&nbsp;we&#39;ve&nbsp;got&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;good&nbsp;enough,&nbsp;only&nbsp;look&nbsp;in&nbsp;1/4&nbsp;the&nbsp;chain.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4778929">tries</span>&nbsp;<span class="op" id="4778935">:=</span>&nbsp;<span class="ident" id="4778938">d</span><span class="op" id="4778939">.</span><span class="ident" id="4778940">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4778947">length</span>&nbsp;<span class="op" id="4778954">=</span>&nbsp;<span class="ident" id="4778956">prevLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4778968">if</span>&nbsp;<span class="ident" id="4778971">length</span>&nbsp;<span class="op" id="4778978">&gt;=</span>&nbsp;<span class="ident" id="4778981">d</span><span class="op" id="4778982">.</span><span class="ident" id="4778983">good</span>&nbsp;<span class="op" id="4778988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4778992">tries</span>&nbsp;<span class="op" id="4778998">&gt;&gt;=</span>&nbsp;<span class="num" id="4779002">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4779005">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4779009">w0</span>&nbsp;<span class="op" id="4779012">:=</span>&nbsp;<span class="ident" id="4779015">win</span><span class="op" id="4779018">[</span><span class="ident" id="4779019">pos</span><span class="op" id="4779022">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4779025">w1</span>&nbsp;<span class="op" id="4779028">:=</span>&nbsp;<span class="ident" id="4779031">win</span><span class="op" id="4779034">[</span><span class="ident" id="4779035">pos</span><span class="op" id="4779038">+</span><span class="num" id="4779039">1</span><span class="op" id="4779040">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4779043">wEnd</span>&nbsp;<span class="op" id="4779048">:=</span>&nbsp;<span class="ident" id="4779051">win</span><span class="op" id="4779054">[</span><span class="ident" id="4779055">pos</span><span class="op" id="4779058">+</span><span class="ident" id="4779059">length</span><span class="op" id="4779065">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4779068">minIndex</span>&nbsp;<span class="op" id="4779077">:=</span>&nbsp;<span class="ident" id="4779080">pos</span>&nbsp;<span class="op" id="4779084">-</span>&nbsp;<span class="ident" id="4779086">windowSize</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779099">for</span>&nbsp;<span class="ident" id="4779103">i</span>&nbsp;<span class="op" id="4779105">:=</span>&nbsp;<span class="ident" id="4779108">prevHead</span><span class="op" id="4779116">;</span>&nbsp;<span class="ident" id="4779118">tries</span>&nbsp;<span class="op" id="4779124">&gt;</span>&nbsp;<span class="num" id="4779126">0</span><span class="op" id="4779127">;</span>&nbsp;<span class="ident" id="4779129">tries</span><span class="op" id="4779134">--</span>&nbsp;<span class="op" id="4779137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779141">if</span>&nbsp;<span class="ident" id="4779144">w0</span>&nbsp;<span class="op" id="4779147">==</span>&nbsp;<span class="ident" id="4779150">win</span><span class="op" id="4779153">[</span><span class="ident" id="4779154">i</span><span class="op" id="4779155">]</span>&nbsp;<span class="op" id="4779157">&amp;&amp;</span>&nbsp;<span class="ident" id="4779160">w1</span>&nbsp;<span class="op" id="4779163">==</span>&nbsp;<span class="ident" id="4779166">win</span><span class="op" id="4779169">[</span><span class="ident" id="4779170">i</span><span class="op" id="4779171">+</span><span class="num" id="4779172">1</span><span class="op" id="4779173">]</span>&nbsp;<span class="op" id="4779175">&amp;&amp;</span>&nbsp;<span class="ident" id="4779178">wEnd</span>&nbsp;<span class="op" id="4779183">==</span>&nbsp;<span class="ident" id="4779186">win</span><span class="op" id="4779189">[</span><span class="ident" id="4779190">i</span><span class="op" id="4779191">+</span><span class="ident" id="4779192">length</span><span class="op" id="4779198">]</span>&nbsp;<span class="op" id="4779200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4779205">//&nbsp;The&nbsp;hash&nbsp;function&nbsp;ensures&nbsp;that&nbsp;if&nbsp;win[i]&nbsp;and&nbsp;win[i+1]&nbsp;match,&nbsp;win[i+2]&nbsp;matches</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4779290">n</span>&nbsp;<span class="op" id="4779292">:=</span>&nbsp;<span class="num" id="4779295">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779300">for</span>&nbsp;<span class="ident" id="4779304">pos</span><span class="op" id="4779307">+</span><span class="ident" id="4779308">n</span>&nbsp;<span class="op" id="4779310">&lt;</span>&nbsp;<span class="builtinfunc" id="4779312">len</span><span class="op" id="4779315">(</span><span class="ident" id="4779316">win</span><span class="op" id="4779319">)</span>&nbsp;<span class="op" id="4779321">&amp;&amp;</span>&nbsp;<span class="ident" id="4779324">win</span><span class="op" id="4779327">[</span><span class="ident" id="4779328">i</span><span class="op" id="4779329">+</span><span class="ident" id="4779330">n</span><span class="op" id="4779331">]</span>&nbsp;<span class="op" id="4779333">==</span>&nbsp;<span class="ident" id="4779336">win</span><span class="op" id="4779339">[</span><span class="ident" id="4779340">pos</span><span class="op" id="4779343">+</span><span class="ident" id="4779344">n</span><span class="op" id="4779345">]</span>&nbsp;<span class="op" id="4779347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4779353">n</span><span class="op" id="4779354">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4779360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779365">if</span>&nbsp;<span class="ident" id="4779368">n</span>&nbsp;<span class="op" id="4779370">&gt;</span>&nbsp;<span class="ident" id="4779372">length</span>&nbsp;<span class="op" id="4779379">&amp;&amp;</span>&nbsp;<span class="op" id="4779382">(</span><span class="ident" id="4779383">n</span>&nbsp;<span class="op" id="4779385">&gt;</span>&nbsp;<span class="num" id="4779387">3</span>&nbsp;<span class="op" id="4779389">||</span>&nbsp;<span class="ident" id="4779392">pos</span><span class="op" id="4779395">-</span><span class="ident" id="4779396">i</span>&nbsp;<span class="op" id="4779398">&lt;=</span>&nbsp;<span class="num" id="4779401">4096</span><span class="op" id="4779405">)</span>&nbsp;<span class="op" id="4779407">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4779413">length</span>&nbsp;<span class="op" id="4779420">=</span>&nbsp;<span class="ident" id="4779422">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4779428">offset</span>&nbsp;<span class="op" id="4779435">=</span>&nbsp;<span class="ident" id="4779437">pos</span>&nbsp;<span class="op" id="4779441">-</span>&nbsp;<span class="ident" id="4779443">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4779449">ok</span>&nbsp;<span class="op" id="4779452">=</span>&nbsp;<span class="builtintype" id="4779454">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779463">if</span>&nbsp;<span class="ident" id="4779466">n</span>&nbsp;<span class="op" id="4779468">&gt;=</span>&nbsp;<span class="ident" id="4779471">nice</span>&nbsp;<span class="op" id="4779476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4779483">//&nbsp;The&nbsp;match&nbsp;is&nbsp;good&nbsp;enough&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;try&nbsp;to&nbsp;find&nbsp;a&nbsp;better&nbsp;one.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779556">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4779566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4779572">wEnd</span>&nbsp;<span class="op" id="4779577">=</span>&nbsp;<span class="ident" id="4779579">win</span><span class="op" id="4779582">[</span><span class="ident" id="4779583">pos</span><span class="op" id="4779586">+</span><span class="ident" id="4779587">n</span><span class="op" id="4779588">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4779593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4779597">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779601">if</span>&nbsp;<span class="ident" id="4779604">i</span>&nbsp;<span class="op" id="4779606">==</span>&nbsp;<span class="ident" id="4779609">minIndex</span>&nbsp;<span class="op" id="4779618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4779623">//&nbsp;hashPrev[i&nbsp;&amp;&nbsp;windowMask]&nbsp;has&nbsp;already&nbsp;been&nbsp;overwritten,&nbsp;so&nbsp;stop&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779697">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4779705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779709">if</span>&nbsp;<span class="ident" id="4779712">i</span>&nbsp;<span class="op" id="4779714">=</span>&nbsp;<span class="ident" id="4779716">d</span><span class="op" id="4779717">.</span><span class="ident" id="4779718">hashPrev</span><span class="op" id="4779726">[</span><span class="ident" id="4779727">i</span><span class="op" id="4779728">&amp;</span><span class="ident" id="4779729">windowMask</span><span class="op" id="4779739">]</span>&nbsp;<span class="op" id="4779741">-</span>&nbsp;<span class="ident" id="4779743">d</span><span class="op" id="4779744">.</span><span class="ident" id="4779745">hashOffset</span><span class="op" id="4779755">;</span>&nbsp;<span class="ident" id="4779757">i</span>&nbsp;<span class="op" id="4779759">&lt;</span>&nbsp;<span class="ident" id="4779761">minIndex</span>&nbsp;<span class="op" id="4779770">||</span>&nbsp;<span class="ident" id="4779773">i</span>&nbsp;<span class="op" id="4779775">&lt;</span>&nbsp;<span class="num" id="4779777">0</span>&nbsp;<span class="op" id="4779779">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779784">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4779792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4779795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779798">return</span><br>
<span class="lineno"></span><span class="op" id="4779805">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="4779808">func</span>&nbsp;<span class="op" id="4779813">(</span><span class="ident" id="4779814">d</span>&nbsp;<span class="op" id="4779816">*</span><span class="ident" id="4779817">compressor</span><span class="op" id="4779827">)</span>&nbsp;<span class="ident" id="4779829">writeStoredBlock</span><span class="op" id="4779845">(</span><span class="ident" id="4779846">buf</span>&nbsp;<span class="op" id="4779850">[</span><span class="op" id="4779851">]</span><span class="builtintype" id="4779852">byte</span><span class="op" id="4779856">)</span>&nbsp;<span class="builtintype" id="4779858">error</span>&nbsp;<span class="op" id="4779864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779867">if</span>&nbsp;<span class="ident" id="4779870">d</span><span class="op" id="4779871">.</span><span class="ident" id="4779872">w</span><span class="op" id="4779873">.</span><span class="ident" id="4779874">writeStoredHeader</span><span class="op" id="4779891">(</span><span class="builtinfunc" id="4779892">len</span><span class="op" id="4779895">(</span><span class="ident" id="4779896">buf</span><span class="op" id="4779899">)</span><span class="op" id="4779900">,</span>&nbsp;<span class="builtintype" id="4779902">false</span><span class="op" id="4779907">)</span><span class="op" id="4779908">;</span>&nbsp;<span class="ident" id="4779910">d</span><span class="op" id="4779911">.</span><span class="ident" id="4779912">w</span><span class="op" id="4779913">.</span><span class="ident" id="4779914">err</span>&nbsp;<span class="op" id="4779918">!=</span>&nbsp;<span class="builtintype" id="4779921">nil</span>&nbsp;<span class="op" id="4779925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779929">return</span>&nbsp;<span class="ident" id="4779936">d</span><span class="op" id="4779937">.</span><span class="ident" id="4779938">w</span><span class="op" id="4779939">.</span><span class="ident" id="4779940">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4779945">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4779948">d</span><span class="op" id="4779949">.</span><span class="ident" id="4779950">w</span><span class="op" id="4779951">.</span><span class="ident" id="4779952">writeBytes</span><span class="op" id="4779962">(</span><span class="ident" id="4779963">buf</span><span class="op" id="4779966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4779969">return</span>&nbsp;<span class="ident" id="4779976">d</span><span class="op" id="4779977">.</span><span class="ident" id="4779978">w</span><span class="op" id="4779979">.</span><span class="ident" id="4779980">err</span><br>
<span class="lineno"></span><span class="op" id="4779984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4779987">func</span>&nbsp;<span class="op" id="4779992">(</span><span class="ident" id="4779993">d</span>&nbsp;<span class="op" id="4779995">*</span><span class="ident" id="4779996">compressor</span><span class="op" id="4780006">)</span>&nbsp;<span class="ident" id="4780008">initDeflate</span><span class="op" id="4780019">(</span><span class="op" id="4780020">)</span>&nbsp;<span class="op" id="4780022">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780025">d</span><span class="op" id="4780026">.</span><span class="ident" id="4780027">hashHead</span>&nbsp;<span class="op" id="4780036">=</span>&nbsp;<span class="builtinfunc" id="4780038">make</span><span class="op" id="4780042">(</span><span class="op" id="4780043">[</span><span class="op" id="4780044">]</span><span class="builtintype" id="4780045">int</span><span class="op" id="4780048">,</span>&nbsp;<span class="ident" id="4780050">hashSize</span><span class="op" id="4780058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780061">d</span><span class="op" id="4780062">.</span><span class="ident" id="4780063">hashPrev</span>&nbsp;<span class="op" id="4780072">=</span>&nbsp;<span class="builtinfunc" id="4780074">make</span><span class="op" id="4780078">(</span><span class="op" id="4780079">[</span><span class="op" id="4780080">]</span><span class="builtintype" id="4780081">int</span><span class="op" id="4780084">,</span>&nbsp;<span class="ident" id="4780086">windowSize</span><span class="op" id="4780096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780099">d</span><span class="op" id="4780100">.</span><span class="ident" id="4780101">window</span>&nbsp;<span class="op" id="4780108">=</span>&nbsp;<span class="builtinfunc" id="4780110">make</span><span class="op" id="4780114">(</span><span class="op" id="4780115">[</span><span class="op" id="4780116">]</span><span class="builtintype" id="4780117">byte</span><span class="op" id="4780121">,</span>&nbsp;<span class="num" id="4780123">2</span><span class="op" id="4780124">*</span><span class="ident" id="4780125">windowSize</span><span class="op" id="4780135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780138">d</span><span class="op" id="4780139">.</span><span class="ident" id="4780140">hashOffset</span>&nbsp;<span class="op" id="4780151">=</span>&nbsp;<span class="num" id="4780153">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780156">d</span><span class="op" id="4780157">.</span><span class="ident" id="4780158">tokens</span>&nbsp;<span class="op" id="4780165">=</span>&nbsp;<span class="builtinfunc" id="4780167">make</span><span class="op" id="4780171">(</span><span class="op" id="4780172">[</span><span class="op" id="4780173">]</span><span class="ident" id="4780174">token</span><span class="op" id="4780179">,</span>&nbsp;<span class="num" id="4780181">0</span><span class="op" id="4780182">,</span>&nbsp;<span class="ident" id="4780184">maxFlateBlockTokens</span><span class="op" id="4780203">+</span><span class="num" id="4780204">1</span><span class="op" id="4780205">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780208">d</span><span class="op" id="4780209">.</span><span class="ident" id="4780210">length</span>&nbsp;<span class="op" id="4780217">=</span>&nbsp;<span class="ident" id="4780219">minMatchLength</span>&nbsp;<span class="op" id="4780234">-</span>&nbsp;<span class="num" id="4780236">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780239">d</span><span class="op" id="4780240">.</span><span class="ident" id="4780241">offset</span>&nbsp;<span class="op" id="4780248">=</span>&nbsp;<span class="num" id="4780250">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780253">d</span><span class="op" id="4780254">.</span><span class="ident" id="4780255">byteAvailable</span>&nbsp;<span class="op" id="4780269">=</span>&nbsp;<span class="builtintype" id="4780271">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780278">d</span><span class="op" id="4780279">.</span><span class="ident" id="4780280">index</span>&nbsp;<span class="op" id="4780286">=</span>&nbsp;<span class="num" id="4780288">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780291">d</span><span class="op" id="4780292">.</span><span class="ident" id="4780293">hash</span>&nbsp;<span class="op" id="4780298">=</span>&nbsp;<span class="num" id="4780300">0</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780303">d</span><span class="op" id="4780304">.</span><span class="ident" id="4780305">chainHead</span>&nbsp;<span class="op" id="4780315">=</span>&nbsp;<span class="op" id="4780317">-</span><span class="num" id="4780318">1</span><br>
<span class="lineno"></span><span class="op" id="4780320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4780323">func</span>&nbsp;<span class="op" id="4780328">(</span><span class="ident" id="4780329">d</span>&nbsp;<span class="op" id="4780331">*</span><span class="ident" id="4780332">compressor</span><span class="op" id="4780342">)</span>&nbsp;<span class="ident" id="4780344">deflate</span><span class="op" id="4780351">(</span><span class="op" id="4780352">)</span>&nbsp;<span class="op" id="4780354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4780357">if</span>&nbsp;<span class="ident" id="4780360">d</span><span class="op" id="4780361">.</span><span class="ident" id="4780362">windowEnd</span><span class="op" id="4780371">-</span><span class="ident" id="4780372">d</span><span class="op" id="4780373">.</span><span class="ident" id="4780374">index</span>&nbsp;<span class="op" id="4780380">&lt;</span>&nbsp;<span class="ident" id="4780382">minMatchLength</span><span class="op" id="4780396">+</span><span class="ident" id="4780397">maxMatchLength</span>&nbsp;<span class="op" id="4780412">&amp;&amp;</span>&nbsp;<span class="op" id="4780415">!</span><span class="ident" id="4780416">d</span><span class="op" id="4780417">.</span><span class="ident" id="4780418">sync</span>&nbsp;<span class="op" id="4780423">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4780427">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4780435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780439">d</span><span class="op" id="4780440">.</span><span class="ident" id="4780441">maxInsertIndex</span>&nbsp;<span class="op" id="4780456">=</span>&nbsp;<span class="ident" id="4780458">d</span><span class="op" id="4780459">.</span><span class="ident" id="4780460">windowEnd</span>&nbsp;<span class="op" id="4780470">-</span>&nbsp;<span class="op" id="4780472">(</span><span class="ident" id="4780473">minMatchLength</span>&nbsp;<span class="op" id="4780488">-</span>&nbsp;<span class="num" id="4780490">1</span><span class="op" id="4780491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4780494">if</span>&nbsp;<span class="ident" id="4780497">d</span><span class="op" id="4780498">.</span><span class="ident" id="4780499">index</span>&nbsp;<span class="op" id="4780505">&lt;</span>&nbsp;<span class="ident" id="4780507">d</span><span class="op" id="4780508">.</span><span class="ident" id="4780509">maxInsertIndex</span>&nbsp;<span class="op" id="4780524">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780528">d</span><span class="op" id="4780529">.</span><span class="ident" id="4780530">hash</span>&nbsp;<span class="op" id="4780535">=</span>&nbsp;<span class="builtintype" id="4780537">int</span><span class="op" id="4780540">(</span><span class="ident" id="4780541">d</span><span class="op" id="4780542">.</span><span class="ident" id="4780543">window</span><span class="op" id="4780549">[</span><span class="ident" id="4780550">d</span><span class="op" id="4780551">.</span><span class="ident" id="4780552">index</span><span class="op" id="4780557">]</span><span class="op" id="4780558">)</span><span class="op" id="4780559">&lt;&lt;</span><span class="ident" id="4780561">hashShift</span>&nbsp;<span class="op" id="4780571">+</span>&nbsp;<span class="builtintype" id="4780573">int</span><span class="op" id="4780576">(</span><span class="ident" id="4780577">d</span><span class="op" id="4780578">.</span><span class="ident" id="4780579">window</span><span class="op" id="4780585">[</span><span class="ident" id="4780586">d</span><span class="op" id="4780587">.</span><span class="ident" id="4780588">index</span><span class="op" id="4780593">+</span><span class="num" id="4780594">1</span><span class="op" id="4780595">]</span><span class="op" id="4780596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4780599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4780602">Loop</span><span class="op" id="4780606">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4780609">for</span>&nbsp;<span class="op" id="4780613">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4780617">if</span>&nbsp;<span class="ident" id="4780620">d</span><span class="op" id="4780621">.</span><span class="ident" id="4780622">index</span>&nbsp;<span class="op" id="4780628">&gt;</span>&nbsp;<span class="ident" id="4780630">d</span><span class="op" id="4780631">.</span><span class="ident" id="4780632">windowEnd</span>&nbsp;<span class="op" id="4780642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4780647">panic</span><span class="op" id="4780652">(</span><span class="string" id="4780653">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4780672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4780676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780680">lookahead</span>&nbsp;<span class="op" id="4780690">:=</span>&nbsp;<span class="ident" id="4780693">d</span><span class="op" id="4780694">.</span><span class="ident" id="4780695">windowEnd</span>&nbsp;<span class="op" id="4780705">-</span>&nbsp;<span class="ident" id="4780707">d</span><span class="op" id="4780708">.</span><span class="ident" id="4780709">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4780717">if</span>&nbsp;<span class="ident" id="4780720">lookahead</span>&nbsp;<span class="op" id="4780730">&lt;</span>&nbsp;<span class="ident" id="4780732">minMatchLength</span><span class="op" id="4780746">+</span><span class="ident" id="4780747">maxMatchLength</span>&nbsp;<span class="op" id="4780762">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4780767">if</span>&nbsp;<span class="op" id="4780770">!</span><span class="ident" id="4780771">d</span><span class="op" id="4780772">.</span><span class="ident" id="4780773">sync</span>&nbsp;<span class="op" id="4780778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4780784">break</span>&nbsp;<span class="ident" id="4780790">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4780798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4780803">if</span>&nbsp;<span class="ident" id="4780806">d</span><span class="op" id="4780807">.</span><span class="ident" id="4780808">index</span>&nbsp;<span class="op" id="4780814">&gt;</span>&nbsp;<span class="ident" id="4780816">d</span><span class="op" id="4780817">.</span><span class="ident" id="4780818">windowEnd</span>&nbsp;<span class="op" id="4780828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4780834">panic</span><span class="op" id="4780839">(</span><span class="string" id="4780840">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4780859">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4780864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4780869">if</span>&nbsp;<span class="ident" id="4780872">lookahead</span>&nbsp;<span class="op" id="4780882">==</span>&nbsp;<span class="num" id="4780885">0</span>&nbsp;<span class="op" id="4780887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4780893">//&nbsp;Flush&nbsp;current&nbsp;output&nbsp;block&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4780935">if</span>&nbsp;<span class="ident" id="4780938">d</span><span class="op" id="4780939">.</span><span class="ident" id="4780940">byteAvailable</span>&nbsp;<span class="op" id="4780954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4780961">//&nbsp;There&nbsp;is&nbsp;still&nbsp;one&nbsp;pending&nbsp;token&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;flushed</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781027">d</span><span class="op" id="4781028">.</span><span class="ident" id="4781029">tokens</span>&nbsp;<span class="op" id="4781036">=</span>&nbsp;<span class="builtinfunc" id="4781038">append</span><span class="op" id="4781044">(</span><span class="ident" id="4781045">d</span><span class="op" id="4781046">.</span><span class="ident" id="4781047">tokens</span><span class="op" id="4781053">,</span>&nbsp;<span class="ident" id="4781055">literalToken</span><span class="op" id="4781067">(</span><span class="builtintype" id="4781068">uint32</span><span class="op" id="4781074">(</span><span class="ident" id="4781075">d</span><span class="op" id="4781076">.</span><span class="ident" id="4781077">window</span><span class="op" id="4781083">[</span><span class="ident" id="4781084">d</span><span class="op" id="4781085">.</span><span class="ident" id="4781086">index</span><span class="op" id="4781091">-</span><span class="num" id="4781092">1</span><span class="op" id="4781093">]</span><span class="op" id="4781094">)</span><span class="op" id="4781095">)</span><span class="op" id="4781096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781103">d</span><span class="op" id="4781104">.</span><span class="ident" id="4781105">byteAvailable</span>&nbsp;<span class="op" id="4781119">=</span>&nbsp;<span class="builtintype" id="4781121">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4781131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4781137">if</span>&nbsp;<span class="builtinfunc" id="4781140">len</span><span class="op" id="4781143">(</span><span class="ident" id="4781144">d</span><span class="op" id="4781145">.</span><span class="ident" id="4781146">tokens</span><span class="op" id="4781152">)</span>&nbsp;<span class="op" id="4781154">&gt;</span>&nbsp;<span class="num" id="4781156">0</span>&nbsp;<span class="op" id="4781158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4781165">if</span>&nbsp;<span class="ident" id="4781168">d</span><span class="op" id="4781169">.</span><span class="ident" id="4781170">err</span>&nbsp;<span class="op" id="4781174">=</span>&nbsp;<span class="ident" id="4781176">d</span><span class="op" id="4781177">.</span><span class="ident" id="4781178">writeBlock</span><span class="op" id="4781188">(</span><span class="ident" id="4781189">d</span><span class="op" id="4781190">.</span><span class="ident" id="4781191">tokens</span><span class="op" id="4781197">,</span>&nbsp;<span class="ident" id="4781199">d</span><span class="op" id="4781200">.</span><span class="ident" id="4781201">index</span><span class="op" id="4781206">,</span>&nbsp;<span class="builtintype" id="4781208">false</span><span class="op" id="4781213">)</span><span class="op" id="4781214">;</span>&nbsp;<span class="ident" id="4781216">d</span><span class="op" id="4781217">.</span><span class="ident" id="4781218">err</span>&nbsp;<span class="op" id="4781222">!=</span>&nbsp;<span class="builtintype" id="4781225">nil</span>&nbsp;<span class="op" id="4781229">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4781237">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4781249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781256">d</span><span class="op" id="4781257">.</span><span class="ident" id="4781258">tokens</span>&nbsp;<span class="op" id="4781265">=</span>&nbsp;<span class="ident" id="4781267">d</span><span class="op" id="4781268">.</span><span class="ident" id="4781269">tokens</span><span class="op" id="4781275">[</span><span class="op" id="4781276">:</span><span class="num" id="4781277">0</span><span class="op" id="4781278">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4781284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4781290">break</span>&nbsp;<span class="ident" id="4781296">Loop</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4781304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4781308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4781312">if</span>&nbsp;<span class="ident" id="4781315">d</span><span class="op" id="4781316">.</span><span class="ident" id="4781317">index</span>&nbsp;<span class="op" id="4781323">&lt;</span>&nbsp;<span class="ident" id="4781325">d</span><span class="op" id="4781326">.</span><span class="ident" id="4781327">maxInsertIndex</span>&nbsp;<span class="op" id="4781342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4781347">//&nbsp;Update&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781369">d</span><span class="op" id="4781370">.</span><span class="ident" id="4781371">hash</span>&nbsp;<span class="op" id="4781376">=</span>&nbsp;<span class="op" id="4781378">(</span><span class="ident" id="4781379">d</span><span class="op" id="4781380">.</span><span class="ident" id="4781381">hash</span><span class="op" id="4781385">&lt;&lt;</span><span class="ident" id="4781387">hashShift</span>&nbsp;<span class="op" id="4781397">+</span>&nbsp;<span class="builtintype" id="4781399">int</span><span class="op" id="4781402">(</span><span class="ident" id="4781403">d</span><span class="op" id="4781404">.</span><span class="ident" id="4781405">window</span><span class="op" id="4781411">[</span><span class="ident" id="4781412">d</span><span class="op" id="4781413">.</span><span class="ident" id="4781414">index</span><span class="op" id="4781419">+</span><span class="num" id="4781420">2</span><span class="op" id="4781421">]</span><span class="op" id="4781422">)</span><span class="op" id="4781423">)</span>&nbsp;<span class="op" id="4781425">&amp;</span>&nbsp;<span class="ident" id="4781427">hashMask</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781439">d</span><span class="op" id="4781440">.</span><span class="ident" id="4781441">chainHead</span>&nbsp;<span class="op" id="4781451">=</span>&nbsp;<span class="ident" id="4781453">d</span><span class="op" id="4781454">.</span><span class="ident" id="4781455">hashHead</span><span class="op" id="4781463">[</span><span class="ident" id="4781464">d</span><span class="op" id="4781465">.</span><span class="ident" id="4781466">hash</span><span class="op" id="4781470">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781475">d</span><span class="op" id="4781476">.</span><span class="ident" id="4781477">hashPrev</span><span class="op" id="4781485">[</span><span class="ident" id="4781486">d</span><span class="op" id="4781487">.</span><span class="ident" id="4781488">index</span><span class="op" id="4781493">&amp;</span><span class="ident" id="4781494">windowMask</span><span class="op" id="4781504">]</span>&nbsp;<span class="op" id="4781506">=</span>&nbsp;<span class="ident" id="4781508">d</span><span class="op" id="4781509">.</span><span class="ident" id="4781510">chainHead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781523">d</span><span class="op" id="4781524">.</span><span class="ident" id="4781525">hashHead</span><span class="op" id="4781533">[</span><span class="ident" id="4781534">d</span><span class="op" id="4781535">.</span><span class="ident" id="4781536">hash</span><span class="op" id="4781540">]</span>&nbsp;<span class="op" id="4781542">=</span>&nbsp;<span class="ident" id="4781544">d</span><span class="op" id="4781545">.</span><span class="ident" id="4781546">index</span>&nbsp;<span class="op" id="4781552">+</span>&nbsp;<span class="ident" id="4781554">d</span><span class="op" id="4781555">.</span><span class="ident" id="4781556">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4781569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781573">prevLength</span>&nbsp;<span class="op" id="4781584">:=</span>&nbsp;<span class="ident" id="4781587">d</span><span class="op" id="4781588">.</span><span class="ident" id="4781589">length</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781598">prevOffset</span>&nbsp;<span class="op" id="4781609">:=</span>&nbsp;<span class="ident" id="4781612">d</span><span class="op" id="4781613">.</span><span class="ident" id="4781614">offset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781623">d</span><span class="op" id="4781624">.</span><span class="ident" id="4781625">length</span>&nbsp;<span class="op" id="4781632">=</span>&nbsp;<span class="ident" id="4781634">minMatchLength</span>&nbsp;<span class="op" id="4781649">-</span>&nbsp;<span class="num" id="4781651">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781655">d</span><span class="op" id="4781656">.</span><span class="ident" id="4781657">offset</span>&nbsp;<span class="op" id="4781664">=</span>&nbsp;<span class="num" id="4781666">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781670">minIndex</span>&nbsp;<span class="op" id="4781679">:=</span>&nbsp;<span class="ident" id="4781682">d</span><span class="op" id="4781683">.</span><span class="ident" id="4781684">index</span>&nbsp;<span class="op" id="4781690">-</span>&nbsp;<span class="ident" id="4781692">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4781705">if</span>&nbsp;<span class="ident" id="4781708">minIndex</span>&nbsp;<span class="op" id="4781717">&lt;</span>&nbsp;<span class="num" id="4781719">0</span>&nbsp;<span class="op" id="4781721">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781726">minIndex</span>&nbsp;<span class="op" id="4781735">=</span>&nbsp;<span class="num" id="4781737">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4781741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4781746">if</span>&nbsp;<span class="ident" id="4781749">d</span><span class="op" id="4781750">.</span><span class="ident" id="4781751">chainHead</span><span class="op" id="4781760">-</span><span class="ident" id="4781761">d</span><span class="op" id="4781762">.</span><span class="ident" id="4781763">hashOffset</span>&nbsp;<span class="op" id="4781774">&gt;=</span>&nbsp;<span class="ident" id="4781777">minIndex</span>&nbsp;<span class="op" id="4781786">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4781792">(</span><span class="ident" id="4781793">d</span><span class="op" id="4781794">.</span><span class="ident" id="4781795">fastSkipHashing</span>&nbsp;<span class="op" id="4781811">!=</span>&nbsp;<span class="ident" id="4781814">skipNever</span>&nbsp;<span class="op" id="4781824">&amp;&amp;</span>&nbsp;<span class="ident" id="4781827">lookahead</span>&nbsp;<span class="op" id="4781837">&gt;</span>&nbsp;<span class="ident" id="4781839">minMatchLength</span><span class="op" id="4781853">-</span><span class="num" id="4781854">1</span>&nbsp;<span class="op" id="4781856">||</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781863">d</span><span class="op" id="4781864">.</span><span class="ident" id="4781865">fastSkipHashing</span>&nbsp;<span class="op" id="4781881">==</span>&nbsp;<span class="ident" id="4781884">skipNever</span>&nbsp;<span class="op" id="4781894">&amp;&amp;</span>&nbsp;<span class="ident" id="4781897">lookahead</span>&nbsp;<span class="op" id="4781907">&gt;</span>&nbsp;<span class="ident" id="4781909">prevLength</span>&nbsp;<span class="op" id="4781920">&amp;&amp;</span>&nbsp;<span class="ident" id="4781923">prevLength</span>&nbsp;<span class="op" id="4781934">&lt;</span>&nbsp;<span class="ident" id="4781936">d</span><span class="op" id="4781937">.</span><span class="ident" id="4781938">lazy</span><span class="op" id="4781942">)</span>&nbsp;<span class="op" id="4781944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4781949">if</span>&nbsp;<span class="ident" id="4781952">newLength</span><span class="op" id="4781961">,</span>&nbsp;<span class="ident" id="4781963">newOffset</span><span class="op" id="4781972">,</span>&nbsp;<span class="ident" id="4781974">ok</span>&nbsp;<span class="op" id="4781977">:=</span>&nbsp;<span class="ident" id="4781980">d</span><span class="op" id="4781981">.</span><span class="ident" id="4781982">findMatch</span><span class="op" id="4781991">(</span><span class="ident" id="4781992">d</span><span class="op" id="4781993">.</span><span class="ident" id="4781994">index</span><span class="op" id="4781999">,</span>&nbsp;<span class="ident" id="4782001">d</span><span class="op" id="4782002">.</span><span class="ident" id="4782003">chainHead</span><span class="op" id="4782012">-</span><span class="ident" id="4782013">d</span><span class="op" id="4782014">.</span><span class="ident" id="4782015">hashOffset</span><span class="op" id="4782025">,</span>&nbsp;<span class="ident" id="4782027">minMatchLength</span><span class="op" id="4782041">-</span><span class="num" id="4782042">1</span><span class="op" id="4782043">,</span>&nbsp;<span class="ident" id="4782045">lookahead</span><span class="op" id="4782054">)</span><span class="op" id="4782055">;</span>&nbsp;<span class="ident" id="4782057">ok</span>&nbsp;<span class="op" id="4782060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4782066">d</span><span class="op" id="4782067">.</span><span class="ident" id="4782068">length</span>&nbsp;<span class="op" id="4782075">=</span>&nbsp;<span class="ident" id="4782077">newLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4782091">d</span><span class="op" id="4782092">.</span><span class="ident" id="4782093">offset</span>&nbsp;<span class="op" id="4782100">=</span>&nbsp;<span class="ident" id="4782102">newOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4782115">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4782119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4782123">if</span>&nbsp;<span class="ident" id="4782126">d</span><span class="op" id="4782127">.</span><span class="ident" id="4782128">fastSkipHashing</span>&nbsp;<span class="op" id="4782144">!=</span>&nbsp;<span class="ident" id="4782147">skipNever</span>&nbsp;<span class="op" id="4782157">&amp;&amp;</span>&nbsp;<span class="ident" id="4782160">d</span><span class="op" id="4782161">.</span><span class="ident" id="4782162">length</span>&nbsp;<span class="op" id="4782169">&gt;=</span>&nbsp;<span class="ident" id="4782172">minMatchLength</span>&nbsp;<span class="op" id="4782187">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4782193">d</span><span class="op" id="4782194">.</span><span class="ident" id="4782195">fastSkipHashing</span>&nbsp;<span class="op" id="4782211">==</span>&nbsp;<span class="ident" id="4782214">skipNever</span>&nbsp;<span class="op" id="4782224">&amp;&amp;</span>&nbsp;<span class="ident" id="4782227">prevLength</span>&nbsp;<span class="op" id="4782238">&gt;=</span>&nbsp;<span class="ident" id="4782241">minMatchLength</span>&nbsp;<span class="op" id="4782256">&amp;&amp;</span>&nbsp;<span class="ident" id="4782259">d</span><span class="op" id="4782260">.</span><span class="ident" id="4782261">length</span>&nbsp;<span class="op" id="4782268">&lt;=</span>&nbsp;<span class="ident" id="4782271">prevLength</span>&nbsp;<span class="op" id="4782282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4782287">//&nbsp;There&nbsp;was&nbsp;a&nbsp;match&nbsp;at&nbsp;the&nbsp;previous&nbsp;step,&nbsp;and&nbsp;the&nbsp;current&nbsp;match&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4782358">//&nbsp;not&nbsp;better.&nbsp;Output&nbsp;the&nbsp;previous&nbsp;match.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4782403">if</span>&nbsp;<span class="ident" id="4782406">d</span><span class="op" id="4782407">.</span><span class="ident" id="4782408">fastSkipHashing</span>&nbsp;<span class="op" id="4782424">!=</span>&nbsp;<span class="ident" id="4782427">skipNever</span>&nbsp;<span class="op" id="4782437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4782443">d</span><span class="op" id="4782444">.</span><span class="ident" id="4782445">tokens</span>&nbsp;<span class="op" id="4782452">=</span>&nbsp;<span class="builtinfunc" id="4782454">append</span><span class="op" id="4782460">(</span><span class="ident" id="4782461">d</span><span class="op" id="4782462">.</span><span class="ident" id="4782463">tokens</span><span class="op" id="4782469">,</span>&nbsp;<span class="ident" id="4782471">matchToken</span><span class="op" id="4782481">(</span><span class="builtintype" id="4782482">uint32</span><span class="op" id="4782488">(</span><span class="ident" id="4782489">d</span><span class="op" id="4782490">.</span><span class="ident" id="4782491">length</span><span class="op" id="4782497">-</span><span class="ident" id="4782498">minMatchLength</span><span class="op" id="4782512">)</span><span class="op" id="4782513">,</span>&nbsp;<span class="builtintype" id="4782515">uint32</span><span class="op" id="4782521">(</span><span class="ident" id="4782522">d</span><span class="op" id="4782523">.</span><span class="ident" id="4782524">offset</span><span class="op" id="4782530">-</span><span class="ident" id="4782531">minOffsetSize</span><span class="op" id="4782544">)</span><span class="op" id="4782545">)</span><span class="op" id="4782546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4782551">}</span>&nbsp;<span class="keyword" id="4782553">else</span>&nbsp;<span class="op" id="4782558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4782564">d</span><span class="op" id="4782565">.</span><span class="ident" id="4782566">tokens</span>&nbsp;<span class="op" id="4782573">=</span>&nbsp;<span class="builtinfunc" id="4782575">append</span><span class="op" id="4782581">(</span><span class="ident" id="4782582">d</span><span class="op" id="4782583">.</span><span class="ident" id="4782584">tokens</span><span class="op" id="4782590">,</span>&nbsp;<span class="ident" id="4782592">matchToken</span><span class="op" id="4782602">(</span><span class="builtintype" id="4782603">uint32</span><span class="op" id="4782609">(</span><span class="ident" id="4782610">prevLength</span><span class="op" id="4782620">-</span><span class="ident" id="4782621">minMatchLength</span><span class="op" id="4782635">)</span><span class="op" id="4782636">,</span>&nbsp;<span class="builtintype" id="4782638">uint32</span><span class="op" id="4782644">(</span><span class="ident" id="4782645">prevOffset</span><span class="op" id="4782655">-</span><span class="ident" id="4782656">minOffsetSize</span><span class="op" id="4782669">)</span><span class="op" id="4782670">)</span><span class="op" id="4782671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4782676">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4782681">//&nbsp;Insert&nbsp;in&nbsp;the&nbsp;hash&nbsp;table&nbsp;all&nbsp;strings&nbsp;up&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4782752">//&nbsp;index&nbsp;and&nbsp;index-1&nbsp;are&nbsp;already&nbsp;inserted.&nbsp;If&nbsp;there&nbsp;is&nbsp;not&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4782821">//&nbsp;lookahead,&nbsp;the&nbsp;last&nbsp;two&nbsp;strings&nbsp;are&nbsp;not&nbsp;inserted&nbsp;into&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4782890">//&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4782903">if</span>&nbsp;<span class="ident" id="4782906">d</span><span class="op" id="4782907">.</span><span class="ident" id="4782908">length</span>&nbsp;<span class="op" id="4782915">&lt;=</span>&nbsp;<span class="ident" id="4782918">d</span><span class="op" id="4782919">.</span><span class="ident" id="4782920">fastSkipHashing</span>&nbsp;<span class="op" id="4782936">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4782942">var</span>&nbsp;<span class="ident" id="4782946">newIndex</span>&nbsp;<span class="builtintype" id="4782955">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4782963">if</span>&nbsp;<span class="ident" id="4782966">d</span><span class="op" id="4782967">.</span><span class="ident" id="4782968">fastSkipHashing</span>&nbsp;<span class="op" id="4782984">!=</span>&nbsp;<span class="ident" id="4782987">skipNever</span>&nbsp;<span class="op" id="4782997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4783004">newIndex</span>&nbsp;<span class="op" id="4783013">=</span>&nbsp;<span class="ident" id="4783015">d</span><span class="op" id="4783016">.</span><span class="ident" id="4783017">index</span>&nbsp;<span class="op" id="4783023">+</span>&nbsp;<span class="ident" id="4783025">d</span><span class="op" id="4783026">.</span><span class="ident" id="4783027">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4783038">}</span>&nbsp;<span class="keyword" id="4783040">else</span>&nbsp;<span class="op" id="4783045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4783052">newIndex</span>&nbsp;<span class="op" id="4783061">=</span>&nbsp;<span class="ident" id="4783063">d</span><span class="op" id="4783064">.</span><span class="ident" id="4783065">index</span>&nbsp;<span class="op" id="4783071">+</span>&nbsp;<span class="ident" id="4783073">prevLength</span>&nbsp;<span class="op" id="4783084">-</span>&nbsp;<span class="num" id="4783086">1</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4783092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4783098">for</span>&nbsp;<span class="ident" id="4783102">d</span><span class="op" id="4783103">.</span><span class="ident" id="4783104">index</span><span class="op" id="4783109">++</span><span class="op" id="4783111">;</span>&nbsp;<span class="ident" id="4783113">d</span><span class="op" id="4783114">.</span><span class="ident" id="4783115">index</span>&nbsp;<span class="op" id="4783121">&lt;</span>&nbsp;<span class="ident" id="4783123">newIndex</span><span class="op" id="4783131">;</span>&nbsp;<span class="ident" id="4783133">d</span><span class="op" id="4783134">.</span><span class="ident" id="4783135">index</span><span class="op" id="4783140">++</span>&nbsp;<span class="op" id="4783143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4783150">if</span>&nbsp;<span class="ident" id="4783153">d</span><span class="op" id="4783154">.</span><span class="ident" id="4783155">index</span>&nbsp;<span class="op" id="4783161">&lt;</span>&nbsp;<span class="ident" id="4783163">d</span><span class="op" id="4783164">.</span><span class="ident" id="4783165">maxInsertIndex</span>&nbsp;<span class="op" id="4783180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4783188">d</span><span class="op" id="4783189">.</span><span class="ident" id="4783190">hash</span>&nbsp;<span class="op" id="4783195">=</span>&nbsp;<span class="op" id="4783197">(</span><span class="ident" id="4783198">d</span><span class="op" id="4783199">.</span><span class="ident" id="4783200">hash</span><span class="op" id="4783204">&lt;&lt;</span><span class="ident" id="4783206">hashShift</span>&nbsp;<span class="op" id="4783216">+</span>&nbsp;<span class="builtintype" id="4783218">int</span><span class="op" id="4783221">(</span><span class="ident" id="4783222">d</span><span class="op" id="4783223">.</span><span class="ident" id="4783224">window</span><span class="op" id="4783230">[</span><span class="ident" id="4783231">d</span><span class="op" id="4783232">.</span><span class="ident" id="4783233">index</span><span class="op" id="4783238">+</span><span class="num" id="4783239">2</span><span class="op" id="4783240">]</span><span class="op" id="4783241">)</span><span class="op" id="4783242">)</span>&nbsp;<span class="op" id="4783244">&amp;</span>&nbsp;<span class="ident" id="4783246">hashMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4783261">//&nbsp;Get&nbsp;previous&nbsp;value&nbsp;with&nbsp;the&nbsp;same&nbsp;hash.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4783309">//&nbsp;Our&nbsp;chain&nbsp;should&nbsp;point&nbsp;to&nbsp;the&nbsp;previous&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4783364">d</span><span class="op" id="4783365">.</span><span class="ident" id="4783366">hashPrev</span><span class="op" id="4783374">[</span><span class="ident" id="4783375">d</span><span class="op" id="4783376">.</span><span class="ident" id="4783377">index</span><span class="op" id="4783382">&amp;</span><span class="ident" id="4783383">windowMask</span><span class="op" id="4783393">]</span>&nbsp;<span class="op" id="4783395">=</span>&nbsp;<span class="ident" id="4783397">d</span><span class="op" id="4783398">.</span><span class="ident" id="4783399">hashHead</span><span class="op" id="4783407">[</span><span class="ident" id="4783408">d</span><span class="op" id="4783409">.</span><span class="ident" id="4783410">hash</span><span class="op" id="4783414">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4783422">//&nbsp;Set&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;hash&nbsp;chain&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4783469">d</span><span class="op" id="4783470">.</span><span class="ident" id="4783471">hashHead</span><span class="op" id="4783479">[</span><span class="ident" id="4783480">d</span><span class="op" id="4783481">.</span><span class="ident" id="4783482">hash</span><span class="op" id="4783486">]</span>&nbsp;<span class="op" id="4783488">=</span>&nbsp;<span class="ident" id="4783490">d</span><span class="op" id="4783491">.</span><span class="ident" id="4783492">index</span>&nbsp;<span class="op" id="4783498">+</span>&nbsp;<span class="ident" id="4783500">d</span><span class="op" id="4783501">.</span><span class="ident" id="4783502">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4783518">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4783524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4783530">if</span>&nbsp;<span class="ident" id="4783533">d</span><span class="op" id="4783534">.</span><span class="ident" id="4783535">fastSkipHashing</span>&nbsp;<span class="op" id="4783551">==</span>&nbsp;<span class="ident" id="4783554">skipNever</span>&nbsp;<span class="op" id="4783564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4783571">d</span><span class="op" id="4783572">.</span><span class="ident" id="4783573">byteAvailable</span>&nbsp;<span class="op" id="4783587">=</span>&nbsp;<span class="builtintype" id="4783589">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4783600">d</span><span class="op" id="4783601">.</span><span class="ident" id="4783602">length</span>&nbsp;<span class="op" id="4783609">=</span>&nbsp;<span class="ident" id="4783611">minMatchLength</span>&nbsp;<span class="op" id="4783626">-</span>&nbsp;<span class="num" id="4783628">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4783634">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4783639">}</span>&nbsp;<span class="keyword" id="4783641">else</span>&nbsp;<span class="op" id="4783646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4783652">//&nbsp;For&nbsp;matches&nbsp;this&nbsp;long,&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;inserting&nbsp;each&nbsp;individual</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4783724">//&nbsp;item&nbsp;into&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4783752">d</span><span class="op" id="4783753">.</span><span class="ident" id="4783754">index</span>&nbsp;<span class="op" id="4783760">+=</span>&nbsp;<span class="ident" id="4783763">d</span><span class="op" id="4783764">.</span><span class="ident" id="4783765">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4783776">if</span>&nbsp;<span class="ident" id="4783779">d</span><span class="op" id="4783780">.</span><span class="ident" id="4783781">index</span>&nbsp;<span class="op" id="4783787">&lt;</span>&nbsp;<span class="ident" id="4783789">d</span><span class="op" id="4783790">.</span><span class="ident" id="4783791">maxInsertIndex</span>&nbsp;<span class="op" id="4783806">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4783813">d</span><span class="op" id="4783814">.</span><span class="ident" id="4783815">hash</span>&nbsp;<span class="op" id="4783820">=</span>&nbsp;<span class="op" id="4783822">(</span><span class="builtintype" id="4783823">int</span><span class="op" id="4783826">(</span><span class="ident" id="4783827">d</span><span class="op" id="4783828">.</span><span class="ident" id="4783829">window</span><span class="op" id="4783835">[</span><span class="ident" id="4783836">d</span><span class="op" id="4783837">.</span><span class="ident" id="4783838">index</span><span class="op" id="4783843">]</span><span class="op" id="4783844">)</span><span class="op" id="4783845">&lt;&lt;</span><span class="ident" id="4783847">hashShift</span>&nbsp;<span class="op" id="4783857">+</span>&nbsp;<span class="builtintype" id="4783859">int</span><span class="op" id="4783862">(</span><span class="ident" id="4783863">d</span><span class="op" id="4783864">.</span><span class="ident" id="4783865">window</span><span class="op" id="4783871">[</span><span class="ident" id="4783872">d</span><span class="op" id="4783873">.</span><span class="ident" id="4783874">index</span><span class="op" id="4783879">+</span><span class="num" id="4783880">1</span><span class="op" id="4783881">]</span><span class="op" id="4783882">)</span><span class="op" id="4783883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4783889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4783894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4783899">if</span>&nbsp;<span class="builtinfunc" id="4783902">len</span><span class="op" id="4783905">(</span><span class="ident" id="4783906">d</span><span class="op" id="4783907">.</span><span class="ident" id="4783908">tokens</span><span class="op" id="4783914">)</span>&nbsp;<span class="op" id="4783916">==</span>&nbsp;<span class="ident" id="4783919">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4783939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4783945">//&nbsp;The&nbsp;block&nbsp;includes&nbsp;the&nbsp;current&nbsp;character</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4783993">if</span>&nbsp;<span class="ident" id="4783996">d</span><span class="op" id="4783997">.</span><span class="ident" id="4783998">err</span>&nbsp;<span class="op" id="4784002">=</span>&nbsp;<span class="ident" id="4784004">d</span><span class="op" id="4784005">.</span><span class="ident" id="4784006">writeBlock</span><span class="op" id="4784016">(</span><span class="ident" id="4784017">d</span><span class="op" id="4784018">.</span><span class="ident" id="4784019">tokens</span><span class="op" id="4784025">,</span>&nbsp;<span class="ident" id="4784027">d</span><span class="op" id="4784028">.</span><span class="ident" id="4784029">index</span><span class="op" id="4784034">,</span>&nbsp;<span class="builtintype" id="4784036">false</span><span class="op" id="4784041">)</span><span class="op" id="4784042">;</span>&nbsp;<span class="ident" id="4784044">d</span><span class="op" id="4784045">.</span><span class="ident" id="4784046">err</span>&nbsp;<span class="op" id="4784050">!=</span>&nbsp;<span class="builtintype" id="4784053">nil</span>&nbsp;<span class="op" id="4784057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4784064">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4784075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784081">d</span><span class="op" id="4784082">.</span><span class="ident" id="4784083">tokens</span>&nbsp;<span class="op" id="4784090">=</span>&nbsp;<span class="ident" id="4784092">d</span><span class="op" id="4784093">.</span><span class="ident" id="4784094">tokens</span><span class="op" id="4784100">[</span><span class="op" id="4784101">:</span><span class="num" id="4784102">0</span><span class="op" id="4784103">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4784108">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4784112">}</span>&nbsp;<span class="keyword" id="4784114">else</span>&nbsp;<span class="op" id="4784119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4784124">if</span>&nbsp;<span class="ident" id="4784127">d</span><span class="op" id="4784128">.</span><span class="ident" id="4784129">fastSkipHashing</span>&nbsp;<span class="op" id="4784145">!=</span>&nbsp;<span class="ident" id="4784148">skipNever</span>&nbsp;<span class="op" id="4784158">||</span>&nbsp;<span class="ident" id="4784161">d</span><span class="op" id="4784162">.</span><span class="ident" id="4784163">byteAvailable</span>&nbsp;<span class="op" id="4784177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784183">i</span>&nbsp;<span class="op" id="4784185">:=</span>&nbsp;<span class="ident" id="4784188">d</span><span class="op" id="4784189">.</span><span class="ident" id="4784190">index</span>&nbsp;<span class="op" id="4784196">-</span>&nbsp;<span class="num" id="4784198">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4784204">if</span>&nbsp;<span class="ident" id="4784207">d</span><span class="op" id="4784208">.</span><span class="ident" id="4784209">fastSkipHashing</span>&nbsp;<span class="op" id="4784225">!=</span>&nbsp;<span class="ident" id="4784228">skipNever</span>&nbsp;<span class="op" id="4784238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784245">i</span>&nbsp;<span class="op" id="4784247">=</span>&nbsp;<span class="ident" id="4784249">d</span><span class="op" id="4784250">.</span><span class="ident" id="4784251">index</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4784261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784267">d</span><span class="op" id="4784268">.</span><span class="ident" id="4784269">tokens</span>&nbsp;<span class="op" id="4784276">=</span>&nbsp;<span class="builtinfunc" id="4784278">append</span><span class="op" id="4784284">(</span><span class="ident" id="4784285">d</span><span class="op" id="4784286">.</span><span class="ident" id="4784287">tokens</span><span class="op" id="4784293">,</span>&nbsp;<span class="ident" id="4784295">literalToken</span><span class="op" id="4784307">(</span><span class="builtintype" id="4784308">uint32</span><span class="op" id="4784314">(</span><span class="ident" id="4784315">d</span><span class="op" id="4784316">.</span><span class="ident" id="4784317">window</span><span class="op" id="4784323">[</span><span class="ident" id="4784324">i</span><span class="op" id="4784325">]</span><span class="op" id="4784326">)</span><span class="op" id="4784327">)</span><span class="op" id="4784328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4784334">if</span>&nbsp;<span class="builtinfunc" id="4784337">len</span><span class="op" id="4784340">(</span><span class="ident" id="4784341">d</span><span class="op" id="4784342">.</span><span class="ident" id="4784343">tokens</span><span class="op" id="4784349">)</span>&nbsp;<span class="op" id="4784351">==</span>&nbsp;<span class="ident" id="4784354">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4784374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4784381">if</span>&nbsp;<span class="ident" id="4784384">d</span><span class="op" id="4784385">.</span><span class="ident" id="4784386">err</span>&nbsp;<span class="op" id="4784390">=</span>&nbsp;<span class="ident" id="4784392">d</span><span class="op" id="4784393">.</span><span class="ident" id="4784394">writeBlock</span><span class="op" id="4784404">(</span><span class="ident" id="4784405">d</span><span class="op" id="4784406">.</span><span class="ident" id="4784407">tokens</span><span class="op" id="4784413">,</span>&nbsp;<span class="ident" id="4784415">i</span><span class="op" id="4784416">+</span><span class="num" id="4784417">1</span><span class="op" id="4784418">,</span>&nbsp;<span class="builtintype" id="4784420">false</span><span class="op" id="4784425">)</span><span class="op" id="4784426">;</span>&nbsp;<span class="ident" id="4784428">d</span><span class="op" id="4784429">.</span><span class="ident" id="4784430">err</span>&nbsp;<span class="op" id="4784434">!=</span>&nbsp;<span class="builtintype" id="4784437">nil</span>&nbsp;<span class="op" id="4784441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4784449">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4784461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784468">d</span><span class="op" id="4784469">.</span><span class="ident" id="4784470">tokens</span>&nbsp;<span class="op" id="4784477">=</span>&nbsp;<span class="ident" id="4784479">d</span><span class="op" id="4784480">.</span><span class="ident" id="4784481">tokens</span><span class="op" id="4784487">[</span><span class="op" id="4784488">:</span><span class="num" id="4784489">0</span><span class="op" id="4784490">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4784496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4784501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784506">d</span><span class="op" id="4784507">.</span><span class="ident" id="4784508">index</span><span class="op" id="4784513">++</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4784519">if</span>&nbsp;<span class="ident" id="4784522">d</span><span class="op" id="4784523">.</span><span class="ident" id="4784524">fastSkipHashing</span>&nbsp;<span class="op" id="4784540">==</span>&nbsp;<span class="ident" id="4784543">skipNever</span>&nbsp;<span class="op" id="4784553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784559">d</span><span class="op" id="4784560">.</span><span class="ident" id="4784561">byteAvailable</span>&nbsp;<span class="op" id="4784575">=</span>&nbsp;<span class="builtintype" id="4784577">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4784585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4784589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4784592">}</span><br>
<span class="lineno">360</span><span class="op" id="4784594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4784597">func</span>&nbsp;<span class="op" id="4784602">(</span><span class="ident" id="4784603">d</span>&nbsp;<span class="op" id="4784605">*</span><span class="ident" id="4784606">compressor</span><span class="op" id="4784616">)</span>&nbsp;<span class="ident" id="4784618">fillStore</span><span class="op" id="4784627">(</span><span class="ident" id="4784628">b</span>&nbsp;<span class="op" id="4784630">[</span><span class="op" id="4784631">]</span><span class="builtintype" id="4784632">byte</span><span class="op" id="4784636">)</span>&nbsp;<span class="builtintype" id="4784638">int</span>&nbsp;<span class="op" id="4784642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784645">n</span>&nbsp;<span class="op" id="4784647">:=</span>&nbsp;<span class="builtinfunc" id="4784650">copy</span><span class="op" id="4784654">(</span><span class="ident" id="4784655">d</span><span class="op" id="4784656">.</span><span class="ident" id="4784657">window</span><span class="op" id="4784663">[</span><span class="ident" id="4784664">d</span><span class="op" id="4784665">.</span><span class="ident" id="4784666">windowEnd</span><span class="op" id="4784675">:</span><span class="op" id="4784676">]</span><span class="op" id="4784677">,</span>&nbsp;<span class="ident" id="4784679">b</span><span class="op" id="4784680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784683">d</span><span class="op" id="4784684">.</span><span class="ident" id="4784685">windowEnd</span>&nbsp;<span class="op" id="4784695">+=</span>&nbsp;<span class="ident" id="4784698">n</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4784701">return</span>&nbsp;<span class="ident" id="4784708">n</span><br>
<span class="lineno"></span><span class="op" id="4784710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4784713">func</span>&nbsp;<span class="op" id="4784718">(</span><span class="ident" id="4784719">d</span>&nbsp;<span class="op" id="4784721">*</span><span class="ident" id="4784722">compressor</span><span class="op" id="4784732">)</span>&nbsp;<span class="ident" id="4784734">store</span><span class="op" id="4784739">(</span><span class="op" id="4784740">)</span>&nbsp;<span class="op" id="4784742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4784745">if</span>&nbsp;<span class="ident" id="4784748">d</span><span class="op" id="4784749">.</span><span class="ident" id="4784750">windowEnd</span>&nbsp;<span class="op" id="4784760">&gt;</span>&nbsp;<span class="num" id="4784762">0</span>&nbsp;<span class="op" id="4784764">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784768">d</span><span class="op" id="4784769">.</span><span class="ident" id="4784770">err</span>&nbsp;<span class="op" id="4784774">=</span>&nbsp;<span class="ident" id="4784776">d</span><span class="op" id="4784777">.</span><span class="ident" id="4784778">writeStoredBlock</span><span class="op" id="4784794">(</span><span class="ident" id="4784795">d</span><span class="op" id="4784796">.</span><span class="ident" id="4784797">window</span><span class="op" id="4784803">[</span><span class="op" id="4784804">:</span><span class="ident" id="4784805">d</span><span class="op" id="4784806">.</span><span class="ident" id="4784807">windowEnd</span><span class="op" id="4784816">]</span><span class="op" id="4784817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4784820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784823">d</span><span class="op" id="4784824">.</span><span class="ident" id="4784825">windowEnd</span>&nbsp;<span class="op" id="4784835">=</span>&nbsp;<span class="num" id="4784837">0</span><br>
<span class="lineno"></span><span class="op" id="4784839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span><span class="keyword" id="4784842">func</span>&nbsp;<span class="op" id="4784847">(</span><span class="ident" id="4784848">d</span>&nbsp;<span class="op" id="4784850">*</span><span class="ident" id="4784851">compressor</span><span class="op" id="4784861">)</span>&nbsp;<span class="ident" id="4784863">write</span><span class="op" id="4784868">(</span><span class="ident" id="4784869">b</span>&nbsp;<span class="op" id="4784871">[</span><span class="op" id="4784872">]</span><span class="builtintype" id="4784873">byte</span><span class="op" id="4784877">)</span>&nbsp;<span class="op" id="4784879">(</span><span class="ident" id="4784880">n</span>&nbsp;<span class="builtintype" id="4784882">int</span><span class="op" id="4784885">,</span>&nbsp;<span class="ident" id="4784887">err</span>&nbsp;<span class="builtintype" id="4784891">error</span><span class="op" id="4784896">)</span>&nbsp;<span class="op" id="4784898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784901">n</span>&nbsp;<span class="op" id="4784903">=</span>&nbsp;<span class="builtinfunc" id="4784905">len</span><span class="op" id="4784908">(</span><span class="ident" id="4784909">b</span><span class="op" id="4784910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784913">b</span>&nbsp;<span class="op" id="4784915">=</span>&nbsp;<span class="ident" id="4784917">b</span><span class="op" id="4784918">[</span><span class="ident" id="4784919">d</span><span class="op" id="4784920">.</span><span class="ident" id="4784921">fill</span><span class="op" id="4784925">(</span><span class="ident" id="4784926">d</span><span class="op" id="4784927">,</span>&nbsp;<span class="ident" id="4784929">b</span><span class="op" id="4784930">)</span><span class="op" id="4784931">:</span><span class="op" id="4784932">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4784935">for</span>&nbsp;<span class="builtinfunc" id="4784939">len</span><span class="op" id="4784942">(</span><span class="ident" id="4784943">b</span><span class="op" id="4784944">)</span>&nbsp;<span class="op" id="4784946">&gt;</span>&nbsp;<span class="num" id="4784948">0</span>&nbsp;<span class="op" id="4784950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784954">d</span><span class="op" id="4784955">.</span><span class="ident" id="4784956">step</span><span class="op" id="4784960">(</span><span class="ident" id="4784961">d</span><span class="op" id="4784962">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4784966">b</span>&nbsp;<span class="op" id="4784968">=</span>&nbsp;<span class="ident" id="4784970">b</span><span class="op" id="4784971">[</span><span class="ident" id="4784972">d</span><span class="op" id="4784973">.</span><span class="ident" id="4784974">fill</span><span class="op" id="4784978">(</span><span class="ident" id="4784979">d</span><span class="op" id="4784980">,</span>&nbsp;<span class="ident" id="4784982">b</span><span class="op" id="4784983">)</span><span class="op" id="4784984">:</span><span class="op" id="4784985">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4784988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4784991">return</span>&nbsp;<span class="ident" id="4784998">n</span><span class="op" id="4784999">,</span>&nbsp;<span class="ident" id="4785001">d</span><span class="op" id="4785002">.</span><span class="ident" id="4785003">err</span><br>
<span class="lineno"></span><span class="op" id="4785007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="4785010">func</span>&nbsp;<span class="op" id="4785015">(</span><span class="ident" id="4785016">d</span>&nbsp;<span class="op" id="4785018">*</span><span class="ident" id="4785019">compressor</span><span class="op" id="4785029">)</span>&nbsp;<span class="ident" id="4785031">syncFlush</span><span class="op" id="4785040">(</span><span class="op" id="4785041">)</span>&nbsp;<span class="builtintype" id="4785043">error</span>&nbsp;<span class="op" id="4785049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785052">d</span><span class="op" id="4785053">.</span><span class="ident" id="4785054">sync</span>&nbsp;<span class="op" id="4785059">=</span>&nbsp;<span class="builtintype" id="4785061">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785067">d</span><span class="op" id="4785068">.</span><span class="ident" id="4785069">step</span><span class="op" id="4785073">(</span><span class="ident" id="4785074">d</span><span class="op" id="4785075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4785078">if</span>&nbsp;<span class="ident" id="4785081">d</span><span class="op" id="4785082">.</span><span class="ident" id="4785083">err</span>&nbsp;<span class="op" id="4785087">==</span>&nbsp;<span class="builtintype" id="4785090">nil</span>&nbsp;<span class="op" id="4785094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785098">d</span><span class="op" id="4785099">.</span><span class="ident" id="4785100">w</span><span class="op" id="4785101">.</span><span class="ident" id="4785102">writeStoredHeader</span><span class="op" id="4785119">(</span><span class="num" id="4785120">0</span><span class="op" id="4785121">,</span>&nbsp;<span class="builtintype" id="4785123">false</span><span class="op" id="4785128">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785132">d</span><span class="op" id="4785133">.</span><span class="ident" id="4785134">w</span><span class="op" id="4785135">.</span><span class="ident" id="4785136">flush</span><span class="op" id="4785141">(</span><span class="op" id="4785142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785146">d</span><span class="op" id="4785147">.</span><span class="ident" id="4785148">err</span>&nbsp;<span class="op" id="4785152">=</span>&nbsp;<span class="ident" id="4785154">d</span><span class="op" id="4785155">.</span><span class="ident" id="4785156">w</span><span class="op" id="4785157">.</span><span class="ident" id="4785158">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4785163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785166">d</span><span class="op" id="4785167">.</span><span class="ident" id="4785168">sync</span>&nbsp;<span class="op" id="4785173">=</span>&nbsp;<span class="builtintype" id="4785175">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4785182">return</span>&nbsp;<span class="ident" id="4785189">d</span><span class="op" id="4785190">.</span><span class="ident" id="4785191">err</span><br>
<span class="lineno">395</span><span class="op" id="4785195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4785198">func</span>&nbsp;<span class="op" id="4785203">(</span><span class="ident" id="4785204">d</span>&nbsp;<span class="op" id="4785206">*</span><span class="ident" id="4785207">compressor</span><span class="op" id="4785217">)</span>&nbsp;<span class="ident" id="4785219">init</span><span class="op" id="4785223">(</span><span class="ident" id="4785224">w</span>&nbsp;<span class="ident" id="4785226">io</span><span class="op" id="4785228">.</span><span class="ident" id="4785229">Writer</span><span class="op" id="4785235">,</span>&nbsp;<span class="ident" id="4785237">level</span>&nbsp;<span class="builtintype" id="4785243">int</span><span class="op" id="4785246">)</span>&nbsp;<span class="op" id="4785248">(</span><span class="ident" id="4785249">err</span>&nbsp;<span class="builtintype" id="4785253">error</span><span class="op" id="4785258">)</span>&nbsp;<span class="op" id="4785260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785263">d</span><span class="op" id="4785264">.</span><span class="ident" id="4785265">w</span>&nbsp;<span class="op" id="4785267">=</span>&nbsp;<span class="ident" id="4785269">newHuffmanBitWriter</span><span class="op" id="4785288">(</span><span class="ident" id="4785289">w</span><span class="op" id="4785290">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4785294">switch</span>&nbsp;<span class="op" id="4785301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4785304">case</span>&nbsp;<span class="ident" id="4785309">level</span>&nbsp;<span class="op" id="4785315">==</span>&nbsp;<span class="ident" id="4785318">NoCompression</span><span class="op" id="4785331">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785335">d</span><span class="op" id="4785336">.</span><span class="ident" id="4785337">window</span>&nbsp;<span class="op" id="4785344">=</span>&nbsp;<span class="builtinfunc" id="4785346">make</span><span class="op" id="4785350">(</span><span class="op" id="4785351">[</span><span class="op" id="4785352">]</span><span class="builtintype" id="4785353">byte</span><span class="op" id="4785357">,</span>&nbsp;<span class="ident" id="4785359">maxStoreBlockSize</span><span class="op" id="4785376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785380">d</span><span class="op" id="4785381">.</span><span class="ident" id="4785382">fill</span>&nbsp;<span class="op" id="4785387">=</span>&nbsp;<span class="op" id="4785389">(</span><span class="op" id="4785390">*</span><span class="ident" id="4785391">compressor</span><span class="op" id="4785401">)</span><span class="op" id="4785402">.</span><span class="ident" id="4785403">fillStore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785415">d</span><span class="op" id="4785416">.</span><span class="ident" id="4785417">step</span>&nbsp;<span class="op" id="4785422">=</span>&nbsp;<span class="op" id="4785424">(</span><span class="op" id="4785425">*</span><span class="ident" id="4785426">compressor</span><span class="op" id="4785436">)</span><span class="op" id="4785437">.</span><span class="ident" id="4785438">store</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4785445">case</span>&nbsp;<span class="ident" id="4785450">level</span>&nbsp;<span class="op" id="4785456">==</span>&nbsp;<span class="ident" id="4785459">DefaultCompression</span><span class="op" id="4785477">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785481">level</span>&nbsp;<span class="op" id="4785487">=</span>&nbsp;<span class="num" id="4785489">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4785493">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4785506">case</span>&nbsp;<span class="num" id="4785511">1</span>&nbsp;<span class="op" id="4785513">&lt;=</span>&nbsp;<span class="ident" id="4785516">level</span>&nbsp;<span class="op" id="4785522">&amp;&amp;</span>&nbsp;<span class="ident" id="4785525">level</span>&nbsp;<span class="op" id="4785531">&lt;=</span>&nbsp;<span class="num" id="4785534">9</span><span class="op" id="4785535">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785539">d</span><span class="op" id="4785540">.</span><span class="ident" id="4785541">compressionLevel</span>&nbsp;<span class="op" id="4785558">=</span>&nbsp;<span class="ident" id="4785560">levels</span><span class="op" id="4785566">[</span><span class="ident" id="4785567">level</span><span class="op" id="4785572">]</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785576">d</span><span class="op" id="4785577">.</span><span class="ident" id="4785578">initDeflate</span><span class="op" id="4785589">(</span><span class="op" id="4785590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785594">d</span><span class="op" id="4785595">.</span><span class="ident" id="4785596">fill</span>&nbsp;<span class="op" id="4785601">=</span>&nbsp;<span class="op" id="4785603">(</span><span class="op" id="4785604">*</span><span class="ident" id="4785605">compressor</span><span class="op" id="4785615">)</span><span class="op" id="4785616">.</span><span class="ident" id="4785617">fillDeflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785631">d</span><span class="op" id="4785632">.</span><span class="ident" id="4785633">step</span>&nbsp;<span class="op" id="4785638">=</span>&nbsp;<span class="op" id="4785640">(</span><span class="op" id="4785641">*</span><span class="ident" id="4785642">compressor</span><span class="op" id="4785652">)</span><span class="op" id="4785653">.</span><span class="ident" id="4785654">deflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4785663">default</span><span class="op" id="4785670">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4785674">return</span>&nbsp;<span class="ident" id="4785681">fmt</span><span class="op" id="4785684">.</span><span class="ident" id="4785685">Errorf</span><span class="op" id="4785691">(</span><span class="string" id="4785692">&#34;flate:&nbsp;invalid&nbsp;compression&nbsp;level&nbsp;%d:&nbsp;want&nbsp;value&nbsp;in&nbsp;range&nbsp;[-1,&nbsp;9]&#34;</span><span class="op" id="4785758">,</span>&nbsp;<span class="ident" id="4785760">level</span><span class="op" id="4785765">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4785768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4785771">return</span>&nbsp;<span class="builtintype" id="4785778">nil</span><br>
<span class="lineno"></span><span class="op" id="4785782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4785785">var</span>&nbsp;<span class="ident" id="4785789">zeroes</span>&nbsp;<span class="op" id="4785796">[</span><span class="num" id="4785797">32</span><span class="op" id="4785799">]</span><span class="builtintype" id="4785800">int</span><br>
<span class="lineno">420</span><span class="keyword" id="4785804">var</span>&nbsp;<span class="ident" id="4785808">bzeroes</span>&nbsp;<span class="op" id="4785816">[</span><span class="num" id="4785817">256</span><span class="op" id="4785820">]</span><span class="builtintype" id="4785821">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4785827">func</span>&nbsp;<span class="op" id="4785832">(</span><span class="ident" id="4785833">d</span>&nbsp;<span class="op" id="4785835">*</span><span class="ident" id="4785836">compressor</span><span class="op" id="4785846">)</span>&nbsp;<span class="ident" id="4785848">reset</span><span class="op" id="4785853">(</span><span class="ident" id="4785854">w</span>&nbsp;<span class="ident" id="4785856">io</span><span class="op" id="4785858">.</span><span class="ident" id="4785859">Writer</span><span class="op" id="4785865">)</span>&nbsp;<span class="op" id="4785867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785870">d</span><span class="op" id="4785871">.</span><span class="ident" id="4785872">w</span><span class="op" id="4785873">.</span><span class="ident" id="4785874">reset</span><span class="op" id="4785879">(</span><span class="ident" id="4785880">w</span><span class="op" id="4785881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785884">d</span><span class="op" id="4785885">.</span><span class="ident" id="4785886">sync</span>&nbsp;<span class="op" id="4785891">=</span>&nbsp;<span class="builtintype" id="4785893">false</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4785900">d</span><span class="op" id="4785901">.</span><span class="ident" id="4785902">err</span>&nbsp;<span class="op" id="4785906">=</span>&nbsp;<span class="builtintype" id="4785908">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4785913">switch</span>&nbsp;<span class="ident" id="4785920">d</span><span class="op" id="4785921">.</span><span class="ident" id="4785922">compressionLevel</span><span class="op" id="4785938">.</span><span class="ident" id="4785939">chain</span>&nbsp;<span class="op" id="4785945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4785948">case</span>&nbsp;<span class="num" id="4785953">0</span><span class="op" id="4785954">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4785958">//&nbsp;level&nbsp;was&nbsp;NoCompression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4785988">for</span>&nbsp;<span class="ident" id="4785992">i</span>&nbsp;<span class="op" id="4785994">:=</span>&nbsp;<span class="keyword" id="4785997">range</span>&nbsp;<span class="ident" id="4786003">d</span><span class="op" id="4786004">.</span><span class="ident" id="4786005">window</span>&nbsp;<span class="op" id="4786012">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786017">d</span><span class="op" id="4786018">.</span><span class="ident" id="4786019">window</span><span class="op" id="4786025">[</span><span class="ident" id="4786026">i</span><span class="op" id="4786027">]</span>&nbsp;<span class="op" id="4786029">=</span>&nbsp;<span class="num" id="4786031">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4786035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786039">d</span><span class="op" id="4786040">.</span><span class="ident" id="4786041">windowEnd</span>&nbsp;<span class="op" id="4786051">=</span>&nbsp;<span class="num" id="4786053">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4786056">default</span><span class="op" id="4786063">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786067">d</span><span class="op" id="4786068">.</span><span class="ident" id="4786069">chainHead</span>&nbsp;<span class="op" id="4786079">=</span>&nbsp;<span class="op" id="4786081">-</span><span class="num" id="4786082">1</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4786086">for</span>&nbsp;<span class="ident" id="4786090">s</span>&nbsp;<span class="op" id="4786092">:=</span>&nbsp;<span class="ident" id="4786095">d</span><span class="op" id="4786096">.</span><span class="ident" id="4786097">hashHead</span><span class="op" id="4786105">;</span>&nbsp;<span class="builtinfunc" id="4786107">len</span><span class="op" id="4786110">(</span><span class="ident" id="4786111">s</span><span class="op" id="4786112">)</span>&nbsp;<span class="op" id="4786114">&gt;</span>&nbsp;<span class="num" id="4786116">0</span><span class="op" id="4786117">;</span>&nbsp;<span class="op" id="4786119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786124">n</span>&nbsp;<span class="op" id="4786126">:=</span>&nbsp;<span class="builtinfunc" id="4786129">copy</span><span class="op" id="4786133">(</span><span class="ident" id="4786134">s</span><span class="op" id="4786135">,</span>&nbsp;<span class="ident" id="4786137">zeroes</span><span class="op" id="4786143">[</span><span class="op" id="4786144">:</span><span class="op" id="4786145">]</span><span class="op" id="4786146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786151">s</span>&nbsp;<span class="op" id="4786153">=</span>&nbsp;<span class="ident" id="4786155">s</span><span class="op" id="4786156">[</span><span class="ident" id="4786157">n</span><span class="op" id="4786158">:</span><span class="op" id="4786159">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4786163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4786167">for</span>&nbsp;<span class="ident" id="4786171">s</span>&nbsp;<span class="op" id="4786173">:=</span>&nbsp;<span class="ident" id="4786176">d</span><span class="op" id="4786177">.</span><span class="ident" id="4786178">hashPrev</span><span class="op" id="4786186">;</span>&nbsp;<span class="builtinfunc" id="4786188">len</span><span class="op" id="4786191">(</span><span class="ident" id="4786192">s</span><span class="op" id="4786193">)</span>&nbsp;<span class="op" id="4786195">&gt;</span>&nbsp;<span class="num" id="4786197">0</span><span class="op" id="4786198">;</span>&nbsp;<span class="ident" id="4786200">s</span>&nbsp;<span class="op" id="4786202">=</span>&nbsp;<span class="ident" id="4786204">s</span><span class="op" id="4786205">[</span><span class="builtinfunc" id="4786206">len</span><span class="op" id="4786209">(</span><span class="ident" id="4786210">zeroes</span><span class="op" id="4786216">)</span><span class="op" id="4786217">:</span><span class="op" id="4786218">]</span>&nbsp;<span class="op" id="4786220">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4786225">copy</span><span class="op" id="4786229">(</span><span class="ident" id="4786230">s</span><span class="op" id="4786231">,</span>&nbsp;<span class="ident" id="4786233">zeroes</span><span class="op" id="4786239">[</span><span class="op" id="4786240">:</span><span class="op" id="4786241">]</span><span class="op" id="4786242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4786246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786250">d</span><span class="op" id="4786251">.</span><span class="ident" id="4786252">hashOffset</span>&nbsp;<span class="op" id="4786263">=</span>&nbsp;<span class="num" id="4786265">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786270">d</span><span class="op" id="4786271">.</span><span class="ident" id="4786272">index</span><span class="op" id="4786277">,</span>&nbsp;<span class="ident" id="4786279">d</span><span class="op" id="4786280">.</span><span class="ident" id="4786281">windowEnd</span>&nbsp;<span class="op" id="4786291">=</span>&nbsp;<span class="num" id="4786293">0</span><span class="op" id="4786294">,</span>&nbsp;<span class="num" id="4786296">0</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4786300">for</span>&nbsp;<span class="ident" id="4786304">s</span>&nbsp;<span class="op" id="4786306">:=</span>&nbsp;<span class="ident" id="4786309">d</span><span class="op" id="4786310">.</span><span class="ident" id="4786311">window</span><span class="op" id="4786317">;</span>&nbsp;<span class="builtinfunc" id="4786319">len</span><span class="op" id="4786322">(</span><span class="ident" id="4786323">s</span><span class="op" id="4786324">)</span>&nbsp;<span class="op" id="4786326">&gt;</span>&nbsp;<span class="num" id="4786328">0</span><span class="op" id="4786329">;</span>&nbsp;<span class="op" id="4786331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786336">n</span>&nbsp;<span class="op" id="4786338">:=</span>&nbsp;<span class="builtinfunc" id="4786341">copy</span><span class="op" id="4786345">(</span><span class="ident" id="4786346">s</span><span class="op" id="4786347">,</span>&nbsp;<span class="ident" id="4786349">bzeroes</span><span class="op" id="4786356">[</span><span class="op" id="4786357">:</span><span class="op" id="4786358">]</span><span class="op" id="4786359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786364">s</span>&nbsp;<span class="op" id="4786366">=</span>&nbsp;<span class="ident" id="4786368">s</span><span class="op" id="4786369">[</span><span class="ident" id="4786370">n</span><span class="op" id="4786371">:</span><span class="op" id="4786372">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4786376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786380">d</span><span class="op" id="4786381">.</span><span class="ident" id="4786382">blockStart</span><span class="op" id="4786392">,</span>&nbsp;<span class="ident" id="4786394">d</span><span class="op" id="4786395">.</span><span class="ident" id="4786396">byteAvailable</span>&nbsp;<span class="op" id="4786410">=</span>&nbsp;<span class="num" id="4786412">0</span><span class="op" id="4786413">,</span>&nbsp;<span class="builtintype" id="4786415">false</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786424">d</span><span class="op" id="4786425">.</span><span class="ident" id="4786426">tokens</span>&nbsp;<span class="op" id="4786433">=</span>&nbsp;<span class="ident" id="4786435">d</span><span class="op" id="4786436">.</span><span class="ident" id="4786437">tokens</span><span class="op" id="4786443">[</span><span class="op" id="4786444">:</span><span class="ident" id="4786445">maxFlateBlockTokens</span><span class="op" id="4786464">+</span><span class="num" id="4786465">1</span><span class="op" id="4786466">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4786470">for</span>&nbsp;<span class="ident" id="4786474">i</span>&nbsp;<span class="op" id="4786476">:=</span>&nbsp;<span class="num" id="4786479">0</span><span class="op" id="4786480">;</span>&nbsp;<span class="ident" id="4786482">i</span>&nbsp;<span class="op" id="4786484">&lt;=</span>&nbsp;<span class="ident" id="4786487">maxFlateBlockTokens</span><span class="op" id="4786506">;</span>&nbsp;<span class="ident" id="4786508">i</span><span class="op" id="4786509">++</span>&nbsp;<span class="op" id="4786512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786517">d</span><span class="op" id="4786518">.</span><span class="ident" id="4786519">tokens</span><span class="op" id="4786525">[</span><span class="ident" id="4786526">i</span><span class="op" id="4786527">]</span>&nbsp;<span class="op" id="4786529">=</span>&nbsp;<span class="num" id="4786531">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4786535">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786539">d</span><span class="op" id="4786540">.</span><span class="ident" id="4786541">tokens</span>&nbsp;<span class="op" id="4786548">=</span>&nbsp;<span class="ident" id="4786550">d</span><span class="op" id="4786551">.</span><span class="ident" id="4786552">tokens</span><span class="op" id="4786558">[</span><span class="op" id="4786559">:</span><span class="num" id="4786560">0</span><span class="op" id="4786561">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786565">d</span><span class="op" id="4786566">.</span><span class="ident" id="4786567">length</span>&nbsp;<span class="op" id="4786574">=</span>&nbsp;<span class="ident" id="4786576">minMatchLength</span>&nbsp;<span class="op" id="4786591">-</span>&nbsp;<span class="num" id="4786593">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786597">d</span><span class="op" id="4786598">.</span><span class="ident" id="4786599">offset</span>&nbsp;<span class="op" id="4786606">=</span>&nbsp;<span class="num" id="4786608">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786612">d</span><span class="op" id="4786613">.</span><span class="ident" id="4786614">hash</span>&nbsp;<span class="op" id="4786619">=</span>&nbsp;<span class="num" id="4786621">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786625">d</span><span class="op" id="4786626">.</span><span class="ident" id="4786627">maxInsertIndex</span>&nbsp;<span class="op" id="4786642">=</span>&nbsp;<span class="num" id="4786644">0</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4786647">}</span><br>
<span class="lineno"></span><span class="op" id="4786649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4786652">func</span>&nbsp;<span class="op" id="4786657">(</span><span class="ident" id="4786658">d</span>&nbsp;<span class="op" id="4786660">*</span><span class="ident" id="4786661">compressor</span><span class="op" id="4786671">)</span>&nbsp;<span class="builtinfunc" id="4786673">close</span><span class="op" id="4786678">(</span><span class="op" id="4786679">)</span>&nbsp;<span class="builtintype" id="4786681">error</span>&nbsp;<span class="op" id="4786687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786690">d</span><span class="op" id="4786691">.</span><span class="ident" id="4786692">sync</span>&nbsp;<span class="op" id="4786697">=</span>&nbsp;<span class="builtintype" id="4786699">true</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786705">d</span><span class="op" id="4786706">.</span><span class="ident" id="4786707">step</span><span class="op" id="4786711">(</span><span class="ident" id="4786712">d</span><span class="op" id="4786713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4786716">if</span>&nbsp;<span class="ident" id="4786719">d</span><span class="op" id="4786720">.</span><span class="ident" id="4786721">err</span>&nbsp;<span class="op" id="4786725">!=</span>&nbsp;<span class="builtintype" id="4786728">nil</span>&nbsp;<span class="op" id="4786732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4786736">return</span>&nbsp;<span class="ident" id="4786743">d</span><span class="op" id="4786744">.</span><span class="ident" id="4786745">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4786750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4786753">if</span>&nbsp;<span class="ident" id="4786756">d</span><span class="op" id="4786757">.</span><span class="ident" id="4786758">w</span><span class="op" id="4786759">.</span><span class="ident" id="4786760">writeStoredHeader</span><span class="op" id="4786777">(</span><span class="num" id="4786778">0</span><span class="op" id="4786779">,</span>&nbsp;<span class="builtintype" id="4786781">true</span><span class="op" id="4786785">)</span><span class="op" id="4786786">;</span>&nbsp;<span class="ident" id="4786788">d</span><span class="op" id="4786789">.</span><span class="ident" id="4786790">w</span><span class="op" id="4786791">.</span><span class="ident" id="4786792">err</span>&nbsp;<span class="op" id="4786796">!=</span>&nbsp;<span class="builtintype" id="4786799">nil</span>&nbsp;<span class="op" id="4786803">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4786807">return</span>&nbsp;<span class="ident" id="4786814">d</span><span class="op" id="4786815">.</span><span class="ident" id="4786816">w</span><span class="op" id="4786817">.</span><span class="ident" id="4786818">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4786823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4786826">d</span><span class="op" id="4786827">.</span><span class="ident" id="4786828">w</span><span class="op" id="4786829">.</span><span class="ident" id="4786830">flush</span><span class="op" id="4786835">(</span><span class="op" id="4786836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4786839">return</span>&nbsp;<span class="ident" id="4786846">d</span><span class="op" id="4786847">.</span><span class="ident" id="4786848">w</span><span class="op" id="4786849">.</span><span class="ident" id="4786850">err</span><br>
<span class="lineno"></span><span class="op" id="4786854">}</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span><span class="comment" id="4786857">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;compressing&nbsp;data&nbsp;at&nbsp;the&nbsp;given&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4786928">//&nbsp;Following&nbsp;zlib,&nbsp;levels&nbsp;range&nbsp;from&nbsp;1&nbsp;(BestSpeed)&nbsp;to&nbsp;9&nbsp;(BestCompression);</span><br>
<span class="lineno"></span><span class="comment" id="4787003">//&nbsp;higher&nbsp;levels&nbsp;typically&nbsp;run&nbsp;slower&nbsp;but&nbsp;compress&nbsp;more.&nbsp;Level&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="4787068">//&nbsp;(NoCompression)&nbsp;does&nbsp;not&nbsp;attempt&nbsp;any&nbsp;compression;&nbsp;it&nbsp;only&nbsp;adds&nbsp;the</span><br>
<span class="lineno">480</span><span class="comment" id="4787138">//&nbsp;necessary&nbsp;DEFLATE&nbsp;framing.&nbsp;Level&nbsp;-1&nbsp;(DefaultCompression)&nbsp;uses&nbsp;the&nbsp;default</span><br>
<span class="lineno"></span><span class="comment" id="4787215">//&nbsp;compression&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4787237">//</span><br>
<span class="lineno"></span><span class="comment" id="4787240">//&nbsp;If&nbsp;level&nbsp;is&nbsp;in&nbsp;the&nbsp;range&nbsp;[-1,&nbsp;9]&nbsp;then&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="4787313">//&nbsp;Otherwise&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;non-nil.</span><br>
<span class="lineno">485</span><span class="keyword" id="4787362">func</span>&nbsp;<span class="ident" id="4787367">NewWriter</span><span class="op" id="4787376">(</span><span class="ident" id="4787377">w</span>&nbsp;<span class="ident" id="4787379">io</span><span class="op" id="4787381">.</span><span class="ident" id="4787382">Writer</span><span class="op" id="4787388">,</span>&nbsp;<span class="ident" id="4787390">level</span>&nbsp;<span class="builtintype" id="4787396">int</span><span class="op" id="4787399">)</span>&nbsp;<span class="op" id="4787401">(</span><span class="op" id="4787402">*</span><span class="ident" id="4787403">Writer</span><span class="op" id="4787409">,</span>&nbsp;<span class="builtintype" id="4787411">error</span><span class="op" id="4787416">)</span>&nbsp;<span class="op" id="4787418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4787421">var</span>&nbsp;<span class="ident" id="4787425">dw</span>&nbsp;<span class="ident" id="4787428">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4787436">if</span>&nbsp;<span class="ident" id="4787439">err</span>&nbsp;<span class="op" id="4787443">:=</span>&nbsp;<span class="ident" id="4787446">dw</span><span class="op" id="4787448">.</span><span class="ident" id="4787449">d</span><span class="op" id="4787450">.</span><span class="ident" id="4787451">init</span><span class="op" id="4787455">(</span><span class="ident" id="4787456">w</span><span class="op" id="4787457">,</span>&nbsp;<span class="ident" id="4787459">level</span><span class="op" id="4787464">)</span><span class="op" id="4787465">;</span>&nbsp;<span class="ident" id="4787467">err</span>&nbsp;<span class="op" id="4787471">!=</span>&nbsp;<span class="builtintype" id="4787474">nil</span>&nbsp;<span class="op" id="4787478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4787482">return</span>&nbsp;<span class="builtintype" id="4787489">nil</span><span class="op" id="4787492">,</span>&nbsp;<span class="ident" id="4787494">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4787499">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4787502">return</span>&nbsp;<span class="op" id="4787509">&amp;</span><span class="ident" id="4787510">dw</span><span class="op" id="4787512">,</span>&nbsp;<span class="builtintype" id="4787514">nil</span><br>
<span class="lineno"></span><span class="op" id="4787518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4787521">//&nbsp;NewWriterDict&nbsp;is&nbsp;like&nbsp;NewWriter&nbsp;but&nbsp;initializes&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4787580">//&nbsp;Writer&nbsp;with&nbsp;a&nbsp;preset&nbsp;dictionary.&nbsp;&nbsp;The&nbsp;returned&nbsp;Writer&nbsp;behaves</span><br>
<span class="lineno">495</span><span class="comment" id="4787645">//&nbsp;as&nbsp;if&nbsp;the&nbsp;dictionary&nbsp;had&nbsp;been&nbsp;written&nbsp;to&nbsp;it&nbsp;without&nbsp;producing</span><br>
<span class="lineno"></span><span class="comment" id="4787710">//&nbsp;any&nbsp;compressed&nbsp;output.&nbsp;&nbsp;The&nbsp;compressed&nbsp;data&nbsp;written&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span><span class="comment" id="4787770">//&nbsp;can&nbsp;only&nbsp;be&nbsp;decompressed&nbsp;by&nbsp;a&nbsp;Reader&nbsp;initialized&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4787831">//&nbsp;same&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4787851">func</span>&nbsp;<span class="ident" id="4787856">NewWriterDict</span><span class="op" id="4787869">(</span><span class="ident" id="4787870">w</span>&nbsp;<span class="ident" id="4787872">io</span><span class="op" id="4787874">.</span><span class="ident" id="4787875">Writer</span><span class="op" id="4787881">,</span>&nbsp;<span class="ident" id="4787883">level</span>&nbsp;<span class="builtintype" id="4787889">int</span><span class="op" id="4787892">,</span>&nbsp;<span class="ident" id="4787894">dict</span>&nbsp;<span class="op" id="4787899">[</span><span class="op" id="4787900">]</span><span class="builtintype" id="4787901">byte</span><span class="op" id="4787905">)</span>&nbsp;<span class="op" id="4787907">(</span><span class="op" id="4787908">*</span><span class="ident" id="4787909">Writer</span><span class="op" id="4787915">,</span>&nbsp;<span class="builtintype" id="4787917">error</span><span class="op" id="4787922">)</span>&nbsp;<span class="op" id="4787924">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4787927">dw</span>&nbsp;<span class="op" id="4787930">:=</span>&nbsp;<span class="op" id="4787933">&amp;</span><span class="ident" id="4787934">dictWriter</span><span class="op" id="4787944">{</span><span class="ident" id="4787945">w</span><span class="op" id="4787946">,</span>&nbsp;<span class="builtintype" id="4787948">false</span><span class="op" id="4787953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4787956">zw</span><span class="op" id="4787958">,</span>&nbsp;<span class="ident" id="4787960">err</span>&nbsp;<span class="op" id="4787964">:=</span>&nbsp;<span class="ident" id="4787967">NewWriter</span><span class="op" id="4787976">(</span><span class="ident" id="4787977">dw</span><span class="op" id="4787979">,</span>&nbsp;<span class="ident" id="4787981">level</span><span class="op" id="4787986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4787989">if</span>&nbsp;<span class="ident" id="4787992">err</span>&nbsp;<span class="op" id="4787996">!=</span>&nbsp;<span class="builtintype" id="4787999">nil</span>&nbsp;<span class="op" id="4788003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4788007">return</span>&nbsp;<span class="builtintype" id="4788014">nil</span><span class="op" id="4788017">,</span>&nbsp;<span class="ident" id="4788019">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4788024">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4788027">zw</span><span class="op" id="4788029">.</span><span class="ident" id="4788030">Write</span><span class="op" id="4788035">(</span><span class="ident" id="4788036">dict</span><span class="op" id="4788040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4788043">zw</span><span class="op" id="4788045">.</span><span class="ident" id="4788046">Flush</span><span class="op" id="4788051">(</span><span class="op" id="4788052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4788055">dw</span><span class="op" id="4788057">.</span><span class="ident" id="4788058">enabled</span>&nbsp;<span class="op" id="4788066">=</span>&nbsp;<span class="builtintype" id="4788068">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4788074">zw</span><span class="op" id="4788076">.</span><span class="ident" id="4788077">dict</span>&nbsp;<span class="op" id="4788082">=</span>&nbsp;<span class="builtinfunc" id="4788084">append</span><span class="op" id="4788090">(</span><span class="ident" id="4788091">zw</span><span class="op" id="4788093">.</span><span class="ident" id="4788094">dict</span><span class="op" id="4788098">,</span>&nbsp;<span class="ident" id="4788100">dict</span><span class="op" id="4788104">...</span><span class="op" id="4788107">)</span>&nbsp;<span class="comment" id="4788109">//&nbsp;duplicate&nbsp;dictionary&nbsp;for&nbsp;Reset&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4788152">return</span>&nbsp;<span class="ident" id="4788159">zw</span><span class="op" id="4788161">,</span>&nbsp;<span class="ident" id="4788163">err</span><br>
<span class="lineno">510</span><span class="op" id="4788167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4788170">type</span>&nbsp;<span class="ident" id="4788175">dictWriter</span>&nbsp;<span class="keyword" id="4788186">struct</span>&nbsp;<span class="op" id="4788193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4788196">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4788204">io</span><span class="op" id="4788206">.</span><span class="ident" id="4788207">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4788215">enabled</span>&nbsp;<span class="builtintype" id="4788223">bool</span><br>
<span class="lineno">515</span><span class="op" id="4788228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4788231">func</span>&nbsp;<span class="op" id="4788236">(</span><span class="ident" id="4788237">w</span>&nbsp;<span class="op" id="4788239">*</span><span class="ident" id="4788240">dictWriter</span><span class="op" id="4788250">)</span>&nbsp;<span class="ident" id="4788252">Write</span><span class="op" id="4788257">(</span><span class="ident" id="4788258">b</span>&nbsp;<span class="op" id="4788260">[</span><span class="op" id="4788261">]</span><span class="builtintype" id="4788262">byte</span><span class="op" id="4788266">)</span>&nbsp;<span class="op" id="4788268">(</span><span class="ident" id="4788269">n</span>&nbsp;<span class="builtintype" id="4788271">int</span><span class="op" id="4788274">,</span>&nbsp;<span class="ident" id="4788276">err</span>&nbsp;<span class="builtintype" id="4788280">error</span><span class="op" id="4788285">)</span>&nbsp;<span class="op" id="4788287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4788290">if</span>&nbsp;<span class="ident" id="4788293">w</span><span class="op" id="4788294">.</span><span class="ident" id="4788295">enabled</span>&nbsp;<span class="op" id="4788303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4788307">return</span>&nbsp;<span class="ident" id="4788314">w</span><span class="op" id="4788315">.</span><span class="ident" id="4788316">w</span><span class="op" id="4788317">.</span><span class="ident" id="4788318">Write</span><span class="op" id="4788323">(</span><span class="ident" id="4788324">b</span><span class="op" id="4788325">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4788328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4788331">return</span>&nbsp;<span class="builtinfunc" id="4788338">len</span><span class="op" id="4788341">(</span><span class="ident" id="4788342">b</span><span class="op" id="4788343">)</span><span class="op" id="4788344">,</span>&nbsp;<span class="builtintype" id="4788346">nil</span><br>
<span class="lineno"></span><span class="op" id="4788350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4788353">//&nbsp;A&nbsp;Writer&nbsp;takes&nbsp;data&nbsp;written&nbsp;to&nbsp;it&nbsp;and&nbsp;writes&nbsp;the&nbsp;compressed</span><br>
<span class="lineno">525</span><span class="comment" id="4788416">//&nbsp;form&nbsp;of&nbsp;that&nbsp;data&nbsp;to&nbsp;an&nbsp;underlying&nbsp;writer&nbsp;(see&nbsp;NewWriter).</span><br>
<span class="lineno"></span><span class="keyword" id="4788478">type</span>&nbsp;<span class="ident" id="4788483">Writer</span>&nbsp;<span class="keyword" id="4788490">struct</span>&nbsp;<span class="op" id="4788497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4788500">d</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4788505">compressor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4788517">dict</span>&nbsp;<span class="op" id="4788522">[</span><span class="op" id="4788523">]</span><span class="builtintype" id="4788524">byte</span><br>
<span class="lineno"></span><span class="op" id="4788529">}</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span><span class="comment" id="4788532">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;w,&nbsp;which&nbsp;will&nbsp;eventually&nbsp;write&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4788591">//&nbsp;compressed&nbsp;form&nbsp;of&nbsp;data&nbsp;to&nbsp;its&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4788644">func</span>&nbsp;<span class="op" id="4788649">(</span><span class="ident" id="4788650">w</span>&nbsp;<span class="op" id="4788652">*</span><span class="ident" id="4788653">Writer</span><span class="op" id="4788659">)</span>&nbsp;<span class="ident" id="4788661">Write</span><span class="op" id="4788666">(</span><span class="ident" id="4788667">data</span>&nbsp;<span class="op" id="4788672">[</span><span class="op" id="4788673">]</span><span class="builtintype" id="4788674">byte</span><span class="op" id="4788678">)</span>&nbsp;<span class="op" id="4788680">(</span><span class="ident" id="4788681">n</span>&nbsp;<span class="builtintype" id="4788683">int</span><span class="op" id="4788686">,</span>&nbsp;<span class="ident" id="4788688">err</span>&nbsp;<span class="builtintype" id="4788692">error</span><span class="op" id="4788697">)</span>&nbsp;<span class="op" id="4788699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4788702">return</span>&nbsp;<span class="ident" id="4788709">w</span><span class="op" id="4788710">.</span><span class="ident" id="4788711">d</span><span class="op" id="4788712">.</span><span class="ident" id="4788713">write</span><span class="op" id="4788718">(</span><span class="ident" id="4788719">data</span><span class="op" id="4788723">)</span><br>
<span class="lineno">535</span><span class="op" id="4788725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4788728">//&nbsp;Flush&nbsp;flushes&nbsp;any&nbsp;pending&nbsp;compressed&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4788799">//&nbsp;It&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;in&nbsp;compressed&nbsp;network&nbsp;protocols,&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4788870">//&nbsp;a&nbsp;remote&nbsp;reader&nbsp;has&nbsp;enough&nbsp;data&nbsp;to&nbsp;reconstruct&nbsp;a&nbsp;packet.</span><br>
<span class="lineno">540</span><span class="comment" id="4788930">//&nbsp;Flush&nbsp;does&nbsp;not&nbsp;return&nbsp;until&nbsp;the&nbsp;data&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="4788988">//&nbsp;If&nbsp;the&nbsp;underlying&nbsp;writer&nbsp;returns&nbsp;an&nbsp;error,&nbsp;Flush&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="4789060">//</span><br>
<span class="lineno"></span><span class="comment" id="4789063">//&nbsp;In&nbsp;the&nbsp;terminology&nbsp;of&nbsp;the&nbsp;zlib&nbsp;library,&nbsp;Flush&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;Z_SYNC_FLUSH.</span><br>
<span class="lineno"></span><span class="keyword" id="4789143">func</span>&nbsp;<span class="op" id="4789148">(</span><span class="ident" id="4789149">w</span>&nbsp;<span class="op" id="4789151">*</span><span class="ident" id="4789152">Writer</span><span class="op" id="4789158">)</span>&nbsp;<span class="ident" id="4789160">Flush</span><span class="op" id="4789165">(</span><span class="op" id="4789166">)</span>&nbsp;<span class="builtintype" id="4789168">error</span>&nbsp;<span class="op" id="4789174">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4789177">//&nbsp;For&nbsp;more&nbsp;about&nbsp;flushing:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4789206">//&nbsp;http://www.bolet.org/~pornin/deflate-flush.html</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4789258">return</span>&nbsp;<span class="ident" id="4789265">w</span><span class="op" id="4789266">.</span><span class="ident" id="4789267">d</span><span class="op" id="4789268">.</span><span class="ident" id="4789269">syncFlush</span><span class="op" id="4789278">(</span><span class="op" id="4789279">)</span><br>
<span class="lineno"></span><span class="op" id="4789281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span><span class="comment" id="4789284">//&nbsp;Close&nbsp;flushes&nbsp;and&nbsp;closes&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4789324">func</span>&nbsp;<span class="op" id="4789329">(</span><span class="ident" id="4789330">w</span>&nbsp;<span class="op" id="4789332">*</span><span class="ident" id="4789333">Writer</span><span class="op" id="4789339">)</span>&nbsp;<span class="ident" id="4789341">Close</span><span class="op" id="4789346">(</span><span class="op" id="4789347">)</span>&nbsp;<span class="builtintype" id="4789349">error</span>&nbsp;<span class="op" id="4789355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4789358">return</span>&nbsp;<span class="ident" id="4789365">w</span><span class="op" id="4789366">.</span><span class="ident" id="4789367">d</span><span class="op" id="4789368">.</span><span class="builtinfunc" id="4789369">close</span><span class="op" id="4789374">(</span><span class="op" id="4789375">)</span><br>
<span class="lineno"></span><span class="op" id="4789377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span><span class="comment" id="4789380">//&nbsp;Reset&nbsp;discards&nbsp;the&nbsp;writer&#39;s&nbsp;state&nbsp;and&nbsp;makes&nbsp;it&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4789444">//&nbsp;the&nbsp;result&nbsp;of&nbsp;NewWriter&nbsp;or&nbsp;NewWriterDict&nbsp;called&nbsp;with&nbsp;dst</span><br>
<span class="lineno"></span><span class="comment" id="4789504">//&nbsp;and&nbsp;w&#39;s&nbsp;level&nbsp;and&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4789537">func</span>&nbsp;<span class="op" id="4789542">(</span><span class="ident" id="4789543">w</span>&nbsp;<span class="op" id="4789545">*</span><span class="ident" id="4789546">Writer</span><span class="op" id="4789552">)</span>&nbsp;<span class="ident" id="4789554">Reset</span><span class="op" id="4789559">(</span><span class="ident" id="4789560">dst</span>&nbsp;<span class="ident" id="4789564">io</span><span class="op" id="4789566">.</span><span class="ident" id="4789567">Writer</span><span class="op" id="4789573">)</span>&nbsp;<span class="op" id="4789575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4789578">if</span>&nbsp;<span class="ident" id="4789581">dw</span><span class="op" id="4789583">,</span>&nbsp;<span class="ident" id="4789585">ok</span>&nbsp;<span class="op" id="4789588">:=</span>&nbsp;<span class="ident" id="4789591">w</span><span class="op" id="4789592">.</span><span class="ident" id="4789593">d</span><span class="op" id="4789594">.</span><span class="ident" id="4789595">w</span><span class="op" id="4789596">.</span><span class="ident" id="4789597">w</span><span class="op" id="4789598">.</span><span class="op" id="4789599">(</span><span class="op" id="4789600">*</span><span class="ident" id="4789601">dictWriter</span><span class="op" id="4789611">)</span><span class="op" id="4789612">;</span>&nbsp;<span class="ident" id="4789614">ok</span>&nbsp;<span class="op" id="4789617">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4789621">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriterDict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4789659">dw</span><span class="op" id="4789661">.</span><span class="ident" id="4789662">w</span>&nbsp;<span class="op" id="4789664">=</span>&nbsp;<span class="ident" id="4789666">dst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4789672">w</span><span class="op" id="4789673">.</span><span class="ident" id="4789674">d</span><span class="op" id="4789675">.</span><span class="ident" id="4789676">reset</span><span class="op" id="4789681">(</span><span class="ident" id="4789682">dw</span><span class="op" id="4789684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4789688">dw</span><span class="op" id="4789690">.</span><span class="ident" id="4789691">enabled</span>&nbsp;<span class="op" id="4789699">=</span>&nbsp;<span class="builtintype" id="4789701">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4789709">w</span><span class="op" id="4789710">.</span><span class="ident" id="4789711">Write</span><span class="op" id="4789716">(</span><span class="ident" id="4789717">w</span><span class="op" id="4789718">.</span><span class="ident" id="4789719">dict</span><span class="op" id="4789723">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4789727">w</span><span class="op" id="4789728">.</span><span class="ident" id="4789729">Flush</span><span class="op" id="4789734">(</span><span class="op" id="4789735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4789739">dw</span><span class="op" id="4789741">.</span><span class="ident" id="4789742">enabled</span>&nbsp;<span class="op" id="4789750">=</span>&nbsp;<span class="builtintype" id="4789752">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4789758">}</span>&nbsp;<span class="keyword" id="4789760">else</span>&nbsp;<span class="op" id="4789765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4789769">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4789803">w</span><span class="op" id="4789804">.</span><span class="ident" id="4789805">d</span><span class="op" id="4789806">.</span><span class="ident" id="4789807">reset</span><span class="op" id="4789812">(</span><span class="ident" id="4789813">dst</span><span class="op" id="4789816">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4789819">}</span><br>
<span class="lineno"></span><span class="op" id="4789821">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
