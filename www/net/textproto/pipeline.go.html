<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3626957">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3627013">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3627067">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3627118">package</span>&nbsp;<span class="ident" id="3627126">textproto</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3627137">import</span>&nbsp;<span class="op" id="3627144">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3627147">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="3627154">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="3627157">//&nbsp;A&nbsp;Pipeline&nbsp;manages&nbsp;a&nbsp;pipelined&nbsp;in-order&nbsp;request/response&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="comment" id="3627227">//</span><br>
<span class="lineno"></span><span class="comment" id="3627230">//&nbsp;To&nbsp;use&nbsp;a&nbsp;Pipeline&nbsp;p&nbsp;to&nbsp;manage&nbsp;multiple&nbsp;clients&nbsp;on&nbsp;a&nbsp;connection,</span><br>
<span class="lineno"></span><span class="comment" id="3627297">//&nbsp;each&nbsp;client&nbsp;should&nbsp;run:</span><br>
<span class="lineno">15</span><span class="comment" id="3627324">//</span><br>
<span class="lineno"></span><span class="comment" id="3627327">//&nbsp;&nbsp;&nbsp;&nbspid&nbsp;:=&nbsp;p.Next()&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;take&nbsp;a&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="3627362">//</span><br>
<span class="lineno"></span><span class="comment" id="3627365">//&nbsp;&nbsp;&nbsp;&nbspp.StartRequest(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;send&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3627420">//&nbsp;&nbsp;&nbsp;&nbsp«send&nbsp;request»</span><br>
<span class="lineno">20</span><span class="comment" id="3627440">//&nbsp;&nbsp;&nbsp;&nbspp.EndRequest(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;request&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="3627500">//</span><br>
<span class="lineno"></span><span class="comment" id="3627503">//&nbsp;&nbsp;&nbsp;&nbspp.StartResponse(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;read&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3627560">//&nbsp;&nbsp;&nbsp;&nbsp«read&nbsp;response»</span><br>
<span class="lineno"></span><span class="comment" id="3627581">//&nbsp;&nbsp;&nbsp;&nbspp.EndResponse(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;response&nbsp;is&nbsp;read</span><br>
<span class="lineno">25</span><span class="comment" id="3627643">//</span><br>
<span class="lineno"></span><span class="comment" id="3627646">//&nbsp;A&nbsp;pipelined&nbsp;server&nbsp;can&nbsp;use&nbsp;the&nbsp;same&nbsp;calls&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3627706">//&nbsp;responses&nbsp;computed&nbsp;in&nbsp;parallel&nbsp;are&nbsp;written&nbsp;in&nbsp;the&nbsp;correct&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="3627774">type</span>&nbsp;<span class="ident" id="3627779">Pipeline</span>&nbsp;<span class="keyword" id="3627788">struct</span>&nbsp;<span class="op" id="3627795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627798">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3627807"><a href="/net/textproto/pipeline.go.html#3627147">sync</a></span><span class="op" id="3627811">.</span><span class="ident" id="3627812">Mutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627819">id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3627828">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627834">request</span>&nbsp;&nbsp;<span class="ident" id="3627843"><a href="/net/textproto/pipeline.go.html#3629040">sequencer</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627854">response</span>&nbsp;<span class="ident" id="3627863"><a href="/net/textproto/pipeline.go.html#3629040">sequencer</a></span><br>
<span class="lineno"></span><span class="op" id="3627873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3627876">//&nbsp;Next&nbsp;returns&nbsp;the&nbsp;next&nbsp;id&nbsp;for&nbsp;a&nbsp;request/response&nbsp;pair.</span><br>
<span class="lineno"></span><span class="keyword" id="3627933">func</span>&nbsp;<span class="op" id="3627938">(</span><span class="ident" id="3627939">p</span>&nbsp;<span class="op" id="3627941">*</span><span class="ident" id="3627942"><a href="/net/textproto/pipeline.go.html#3627779">Pipeline</a></span><span class="op" id="3627950">)</span>&nbsp;<span class="ident" id="3627952">Next</span><span class="op" id="3627956">(</span><span class="op" id="3627957">)</span>&nbsp;<span class="builtintype" id="3627959">uint</span>&nbsp;<span class="op" id="3627964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627967"><a href="/net/textproto/pipeline.go.html#3627939">p</a></span><span class="op" id="3627968">.</span><span class="ident" id="3627969">mu</span><span class="op" id="3627971">.</span><span class="ident" id="3627972">Lock</span><span class="op" id="3627976">(</span><span class="op" id="3627977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627980">id</span>&nbsp;<span class="op" id="3627983">:=</span>&nbsp;<span class="ident" id="3627986"><a href="/net/textproto/pipeline.go.html#3627939">p</a></span><span class="op" id="3627987">.</span><span class="ident" id="3627988">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627992"><a href="/net/textproto/pipeline.go.html#3627939">p</a></span><span class="op" id="3627993">.</span><span class="ident" id="3627994">id</span><span class="op" id="3627996">++</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628000"><a href="/net/textproto/pipeline.go.html#3627939">p</a></span><span class="op" id="3628001">.</span><span class="ident" id="3628002">mu</span><span class="op" id="3628004">.</span><span class="ident" id="3628005">Unlock</span><span class="op" id="3628011">(</span><span class="op" id="3628012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628015">return</span>&nbsp;<span class="ident" id="3628022"><a href="/net/textproto/pipeline.go.html#3627980">id</a></span><br>
<span class="lineno"></span><span class="op" id="3628025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3628028">//&nbsp;StartRequest&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;send&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;receive)</span><br>
<span class="lineno">45</span><span class="comment" id="3628111">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="3628145">func</span>&nbsp;<span class="op" id="3628150">(</span><span class="ident" id="3628151">p</span>&nbsp;<span class="op" id="3628153">*</span><span class="ident" id="3628154"><a href="/net/textproto/pipeline.go.html#3627779">Pipeline</a></span><span class="op" id="3628162">)</span>&nbsp;<span class="ident" id="3628164">StartRequest</span><span class="op" id="3628176">(</span><span class="ident" id="3628177">id</span>&nbsp;<span class="builtintype" id="3628180">uint</span><span class="op" id="3628184">)</span>&nbsp;<span class="op" id="3628186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628189"><a href="/net/textproto/pipeline.go.html#3628151">p</a></span><span class="op" id="3628190">.</span><span class="ident" id="3628191">request</span><span class="op" id="3628198">.</span><span class="ident" id="3628199">Start</span><span class="op" id="3628204">(</span><span class="ident" id="3628205"><a href="/net/textproto/pipeline.go.html#3628177">id</a></span><span class="op" id="3628207">)</span><br>
<span class="lineno"></span><span class="op" id="3628209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3628212">//&nbsp;EndRequest&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="3628286">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;received).</span><br>
<span class="lineno"></span><span class="keyword" id="3628326">func</span>&nbsp;<span class="op" id="3628331">(</span><span class="ident" id="3628332">p</span>&nbsp;<span class="op" id="3628334">*</span><span class="ident" id="3628335"><a href="/net/textproto/pipeline.go.html#3627779">Pipeline</a></span><span class="op" id="3628343">)</span>&nbsp;<span class="ident" id="3628345">EndRequest</span><span class="op" id="3628355">(</span><span class="ident" id="3628356">id</span>&nbsp;<span class="builtintype" id="3628359">uint</span><span class="op" id="3628363">)</span>&nbsp;<span class="op" id="3628365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628368"><a href="/net/textproto/pipeline.go.html#3628332">p</a></span><span class="op" id="3628369">.</span><span class="ident" id="3628370">request</span><span class="op" id="3628377">.</span><span class="ident" id="3628378">End</span><span class="op" id="3628381">(</span><span class="ident" id="3628382"><a href="/net/textproto/pipeline.go.html#3628356">id</a></span><span class="op" id="3628384">)</span><br>
<span class="lineno"></span><span class="op" id="3628386">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="3628389">//&nbsp;StartResponse&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;receive&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;send)</span><br>
<span class="lineno"></span><span class="comment" id="3628473">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="3628507">func</span>&nbsp;<span class="op" id="3628512">(</span><span class="ident" id="3628513">p</span>&nbsp;<span class="op" id="3628515">*</span><span class="ident" id="3628516"><a href="/net/textproto/pipeline.go.html#3627779">Pipeline</a></span><span class="op" id="3628524">)</span>&nbsp;<span class="ident" id="3628526">StartResponse</span><span class="op" id="3628539">(</span><span class="ident" id="3628540">id</span>&nbsp;<span class="builtintype" id="3628543">uint</span><span class="op" id="3628547">)</span>&nbsp;<span class="op" id="3628549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628552"><a href="/net/textproto/pipeline.go.html#3628513">p</a></span><span class="op" id="3628553">.</span><span class="ident" id="3628554">response</span><span class="op" id="3628562">.</span><span class="ident" id="3628563">Start</span><span class="op" id="3628568">(</span><span class="ident" id="3628569"><a href="/net/textproto/pipeline.go.html#3628540">id</a></span><span class="op" id="3628571">)</span><br>
<span class="lineno">60</span><span class="op" id="3628573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3628576">//&nbsp;EndResponse&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;response&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;received</span><br>
<span class="lineno"></span><span class="comment" id="3628656">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;sent).</span><br>
<span class="lineno"></span><span class="keyword" id="3628692">func</span>&nbsp;<span class="op" id="3628697">(</span><span class="ident" id="3628698">p</span>&nbsp;<span class="op" id="3628700">*</span><span class="ident" id="3628701"><a href="/net/textproto/pipeline.go.html#3627779">Pipeline</a></span><span class="op" id="3628709">)</span>&nbsp;<span class="ident" id="3628711">EndResponse</span><span class="op" id="3628722">(</span><span class="ident" id="3628723">id</span>&nbsp;<span class="builtintype" id="3628726">uint</span><span class="op" id="3628730">)</span>&nbsp;<span class="op" id="3628732">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628735"><a href="/net/textproto/pipeline.go.html#3628698">p</a></span><span class="op" id="3628736">.</span><span class="ident" id="3628737">response</span><span class="op" id="3628745">.</span><span class="ident" id="3628746">End</span><span class="op" id="3628749">(</span><span class="ident" id="3628750"><a href="/net/textproto/pipeline.go.html#3628723">id</a></span><span class="op" id="3628752">)</span><br>
<span class="lineno"></span><span class="op" id="3628754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3628757">//&nbsp;A&nbsp;sequencer&nbsp;schedules&nbsp;a&nbsp;sequence&nbsp;of&nbsp;numbered&nbsp;events&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="3628822">//&nbsp;happen&nbsp;in&nbsp;order,&nbsp;one&nbsp;after&nbsp;the&nbsp;other.&nbsp;&nbsp;The&nbsp;event&nbsp;numbering&nbsp;must&nbsp;start</span><br>
<span class="lineno">70</span><span class="comment" id="3628895">//&nbsp;at&nbsp;0&nbsp;and&nbsp;increment&nbsp;without&nbsp;skipping.&nbsp;&nbsp;The&nbsp;event&nbsp;number&nbsp;wraps&nbsp;around</span><br>
<span class="lineno"></span><span class="comment" id="3628966">//&nbsp;safely&nbsp;as&nbsp;long&nbsp;as&nbsp;there&nbsp;are&nbsp;not&nbsp;2^32&nbsp;simultaneous&nbsp;events&nbsp;pending.</span><br>
<span class="lineno"></span><span class="keyword" id="3629035">type</span>&nbsp;<span class="ident" id="3629040">sequencer</span>&nbsp;<span class="keyword" id="3629050">struct</span>&nbsp;<span class="op" id="3629057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629060">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3629065"><a href="/net/textproto/pipeline.go.html#3627147">sync</a></span><span class="op" id="3629069">.</span><span class="ident" id="3629070">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629077">id</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3629082">uint</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629088">wait</span>&nbsp;<span class="keyword" id="3629093">map</span><span class="op" id="3629096">[</span><span class="builtintype" id="3629097">uint</span><span class="op" id="3629101">]</span><span class="keyword" id="3629102">chan</span>&nbsp;<span class="builtintype" id="3629107">uint</span><br>
<span class="lineno"></span><span class="op" id="3629112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3629115">//&nbsp;Start&nbsp;waits&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;for&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;to&nbsp;begin.</span><br>
<span class="lineno"></span><span class="comment" id="3629183">//&nbsp;That&nbsp;is,&nbsp;except&nbsp;for&nbsp;the&nbsp;first&nbsp;event,&nbsp;it&nbsp;waits&nbsp;until&nbsp;End(id-1)&nbsp;has</span><br>
<span class="lineno">80</span><span class="comment" id="3629252">//&nbsp;been&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="3629268">func</span>&nbsp;<span class="op" id="3629273">(</span><span class="ident" id="3629274">s</span>&nbsp;<span class="op" id="3629276">*</span><span class="ident" id="3629277"><a href="/net/textproto/pipeline.go.html#3629040">sequencer</a></span><span class="op" id="3629286">)</span>&nbsp;<span class="ident" id="3629288">Start</span><span class="op" id="3629293">(</span><span class="ident" id="3629294">id</span>&nbsp;<span class="builtintype" id="3629297">uint</span><span class="op" id="3629301">)</span>&nbsp;<span class="op" id="3629303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629306"><a href="/net/textproto/pipeline.go.html#3629274">s</a></span><span class="op" id="3629307">.</span><span class="ident" id="3629308">mu</span><span class="op" id="3629310">.</span><span class="ident" id="3629311">Lock</span><span class="op" id="3629315">(</span><span class="op" id="3629316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629319">if</span>&nbsp;<span class="ident" id="3629322"><a href="/net/textproto/pipeline.go.html#3629274">s</a></span><span class="op" id="3629323">.</span><span class="ident" id="3629324">id</span>&nbsp;<span class="op" id="3629327">==</span>&nbsp;<span class="ident" id="3629330"><a href="/net/textproto/pipeline.go.html#3629294">id</a></span>&nbsp;<span class="op" id="3629333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629337"><a href="/net/textproto/pipeline.go.html#3629274">s</a></span><span class="op" id="3629338">.</span><span class="ident" id="3629339">mu</span><span class="op" id="3629341">.</span><span class="ident" id="3629342">Unlock</span><span class="op" id="3629348">(</span><span class="op" id="3629349">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629353">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629364">c</span>&nbsp;<span class="op" id="3629366">:=</span>&nbsp;<span class="builtinfunc" id="3629369">make</span><span class="op" id="3629373">(</span><span class="keyword" id="3629374">chan</span>&nbsp;<span class="builtintype" id="3629379">uint</span><span class="op" id="3629383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629386">if</span>&nbsp;<span class="ident" id="3629389"><a href="/net/textproto/pipeline.go.html#3629274">s</a></span><span class="op" id="3629390">.</span><span class="ident" id="3629391">wait</span>&nbsp;<span class="op" id="3629396">==</span>&nbsp;<span class="ident" id="3629399">nil</span>&nbsp;<span class="op" id="3629403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629407"><a href="/net/textproto/pipeline.go.html#3629274">s</a></span><span class="op" id="3629408">.</span><span class="ident" id="3629409">wait</span>&nbsp;<span class="op" id="3629414">=</span>&nbsp;<span class="builtinfunc" id="3629416">make</span><span class="op" id="3629420">(</span><span class="keyword" id="3629421">map</span><span class="op" id="3629424">[</span><span class="builtintype" id="3629425">uint</span><span class="op" id="3629429">]</span><span class="keyword" id="3629430">chan</span>&nbsp;<span class="builtintype" id="3629435">uint</span><span class="op" id="3629439">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629445"><a href="/net/textproto/pipeline.go.html#3629274">s</a></span><span class="op" id="3629446">.</span><span class="ident" id="3629447">wait</span><span class="op" id="3629451">[</span><span class="ident" id="3629452"><a href="/net/textproto/pipeline.go.html#3629294">id</a></span><span class="op" id="3629454">]</span>&nbsp;<span class="op" id="3629456">=</span>&nbsp;<span class="ident" id="3629458"><a href="/net/textproto/pipeline.go.html#3629364">c</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629461"><a href="/net/textproto/pipeline.go.html#3629274">s</a></span><span class="op" id="3629462">.</span><span class="ident" id="3629463">mu</span><span class="op" id="3629465">.</span><span class="ident" id="3629466">Unlock</span><span class="op" id="3629472">(</span><span class="op" id="3629473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629476">&lt;-</span><span class="ident" id="3629478"><a href="/net/textproto/pipeline.go.html#3629364">c</a></span><br>
<span class="lineno"></span><span class="op" id="3629480">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="3629483">//&nbsp;End&nbsp;notifies&nbsp;the&nbsp;sequencer&nbsp;that&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;has&nbsp;completed,</span><br>
<span class="lineno"></span><span class="comment" id="3629555">//&nbsp;allowing&nbsp;it&nbsp;to&nbsp;schedule&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id+1.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3629631">//&nbsp;to&nbsp;call&nbsp;End&nbsp;with&nbsp;an&nbsp;id&nbsp;that&nbsp;is&nbsp;not&nbsp;the&nbsp;number&nbsp;of&nbsp;the&nbsp;active&nbsp;event.</span><br>
<span class="lineno"></span><span class="keyword" id="3629701">func</span>&nbsp;<span class="op" id="3629706">(</span><span class="ident" id="3629707">s</span>&nbsp;<span class="op" id="3629709">*</span><span class="ident" id="3629710"><a href="/net/textproto/pipeline.go.html#3629040">sequencer</a></span><span class="op" id="3629719">)</span>&nbsp;<span class="ident" id="3629721">End</span><span class="op" id="3629724">(</span><span class="ident" id="3629725">id</span>&nbsp;<span class="builtintype" id="3629728">uint</span><span class="op" id="3629732">)</span>&nbsp;<span class="op" id="3629734">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629737"><a href="/net/textproto/pipeline.go.html#3629707">s</a></span><span class="op" id="3629738">.</span><span class="ident" id="3629739">mu</span><span class="op" id="3629741">.</span><span class="ident" id="3629742">Lock</span><span class="op" id="3629746">(</span><span class="op" id="3629747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629750">if</span>&nbsp;<span class="ident" id="3629753"><a href="/net/textproto/pipeline.go.html#3629707">s</a></span><span class="op" id="3629754">.</span><span class="ident" id="3629755">id</span>&nbsp;<span class="op" id="3629758">!=</span>&nbsp;<span class="ident" id="3629761"><a href="/net/textproto/pipeline.go.html#3629725">id</a></span>&nbsp;<span class="op" id="3629764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3629768">panic</span><span class="op" id="3629773">(</span><span class="string" id="3629774">&#34;out&nbsp;of&nbsp;sync&#34;</span><span class="op" id="3629787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629793"><a href="/net/textproto/pipeline.go.html#3629725">id</a></span><span class="op" id="3629795">++</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629799"><a href="/net/textproto/pipeline.go.html#3629707">s</a></span><span class="op" id="3629800">.</span><span class="ident" id="3629801">id</span>&nbsp;<span class="op" id="3629804">=</span>&nbsp;<span class="ident" id="3629806"><a href="/net/textproto/pipeline.go.html#3629725">id</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629810">if</span>&nbsp;<span class="ident" id="3629813"><a href="/net/textproto/pipeline.go.html#3629707">s</a></span><span class="op" id="3629814">.</span><span class="ident" id="3629815">wait</span>&nbsp;<span class="op" id="3629820">==</span>&nbsp;<span class="ident" id="3629823">nil</span>&nbsp;<span class="op" id="3629827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629831"><a href="/net/textproto/pipeline.go.html#3629707">s</a></span><span class="op" id="3629832">.</span><span class="ident" id="3629833">wait</span>&nbsp;<span class="op" id="3629838">=</span>&nbsp;<span class="builtinfunc" id="3629840">make</span><span class="op" id="3629844">(</span><span class="keyword" id="3629845">map</span><span class="op" id="3629848">[</span><span class="builtintype" id="3629849">uint</span><span class="op" id="3629853">]</span><span class="keyword" id="3629854">chan</span>&nbsp;<span class="builtintype" id="3629859">uint</span><span class="op" id="3629863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629869">c</span><span class="op" id="3629870">,</span>&nbsp;<span class="ident" id="3629872">ok</span>&nbsp;<span class="op" id="3629875">:=</span>&nbsp;<span class="ident" id="3629878"><a href="/net/textproto/pipeline.go.html#3629707">s</a></span><span class="op" id="3629879">.</span><span class="ident" id="3629880">wait</span><span class="op" id="3629884">[</span><span class="ident" id="3629885"><a href="/net/textproto/pipeline.go.html#3629725">id</a></span><span class="op" id="3629887">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629890">if</span>&nbsp;<span class="ident" id="3629893"><a href="/net/textproto/pipeline.go.html#3629872">ok</a></span>&nbsp;<span class="op" id="3629896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3629900">delete</span><span class="op" id="3629906">(</span><span class="ident" id="3629907"><a href="/net/textproto/pipeline.go.html#3629707">s</a></span><span class="op" id="3629908">.</span><span class="ident" id="3629909">wait</span><span class="op" id="3629913">,</span>&nbsp;<span class="ident" id="3629915"><a href="/net/textproto/pipeline.go.html#3629725">id</a></span><span class="op" id="3629917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629923"><a href="/net/textproto/pipeline.go.html#3629707">s</a></span><span class="op" id="3629924">.</span><span class="ident" id="3629925">mu</span><span class="op" id="3629927">.</span><span class="ident" id="3629928">Unlock</span><span class="op" id="3629934">(</span><span class="op" id="3629935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629938">if</span>&nbsp;<span class="ident" id="3629941"><a href="/net/textproto/pipeline.go.html#3629872">ok</a></span>&nbsp;<span class="op" id="3629944">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3629948"><a href="/net/textproto/pipeline.go.html#3629869">c</a></span>&nbsp;<span class="op" id="3629950">&lt;-</span>&nbsp;<span class="num" id="3629953">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629956">}</span><br>
<span class="lineno"></span><span class="op" id="3629958">}</span>
</div>
</body>
</html>
