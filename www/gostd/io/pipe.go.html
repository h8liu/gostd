<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>io</h2>
<ul>
<li><a href="/gostd/io/io.go.html">io.go</a></li>
<li><a href="/gostd/io/io_test.go.html">io_test.go</a></li>
<li><a href="/gostd/io/multi.go.html">multi.go</a></li>
<li><a href="/gostd/io/multi_test.go.html">multi_test.go</a></li>
<li><a href="/gostd/io/pipe.go.html" class="current">pipe.go</a></li>
<li><a href="/gostd/io/pipe_test.go.html">pipe_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1401081">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1401136">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1401190">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1401241">//&nbsp;Pipe&nbsp;adapter&nbsp;to&nbsp;connect&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Reader</span><br>
<span class="lineno"></span><span class="comment" id="1401296">//&nbsp;with&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1401334">package</span>&nbsp;<span class="ident" id="1401342">io</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1401346">import</span>&nbsp;<span class="op" id="1401353">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1401356">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1401366">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="1401373">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="1401376">//&nbsp;ErrClosedPipe&nbsp;is&nbsp;the&nbsp;error&nbsp;used&nbsp;for&nbsp;read&nbsp;or&nbsp;write&nbsp;operations&nbsp;on&nbsp;a&nbsp;closed&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1401458">var</span>&nbsp;<span class="ident" id="1401462">ErrClosedPipe</span>&nbsp;<span class="op" id="1401476">=</span>&nbsp;<span class="ident" id="1401478">errors</span><span class="op" id="1401484">.</span><span class="ident" id="1401485">New</span><span class="op" id="1401488">(</span><span class="string" id="1401489">&#34;io:&nbsp;read/write&nbsp;on&nbsp;closed&nbsp;pipe&#34;</span><span class="op" id="1401520">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1401523">type</span>&nbsp;<span class="ident" id="1401528">pipeResult</span>&nbsp;<span class="keyword" id="1401539">struct</span>&nbsp;<span class="op" id="1401546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1401549">n</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1401553">int</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1401558">err</span>&nbsp;<span class="builtintype" id="1401562">error</span><br>
<span class="lineno"></span><span class="op" id="1401568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1401571">//&nbsp;A&nbsp;pipe&nbsp;is&nbsp;the&nbsp;shared&nbsp;pipe&nbsp;structure&nbsp;underlying&nbsp;PipeReader&nbsp;and&nbsp;PipeWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="1401648">type</span>&nbsp;<span class="ident" id="1401653">pipe</span>&nbsp;<span class="keyword" id="1401658">struct</span>&nbsp;<span class="op" id="1401665">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1401668">rl</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1401674">sync</span><span class="op" id="1401678">.</span><span class="ident" id="1401679">Mutex</span>&nbsp;<span class="comment" id="1401685">//&nbsp;gates&nbsp;readers&nbsp;one&nbsp;at&nbsp;a&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1401717">wl</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1401723">sync</span><span class="op" id="1401727">.</span><span class="ident" id="1401728">Mutex</span>&nbsp;<span class="comment" id="1401734">//&nbsp;gates&nbsp;writers&nbsp;one&nbsp;at&nbsp;a&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1401766">l</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1401772">sync</span><span class="op" id="1401776">.</span><span class="ident" id="1401777">Mutex</span>&nbsp;<span class="comment" id="1401783">//&nbsp;protects&nbsp;remaining&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1401813">data</span>&nbsp;&nbsp;<span class="op" id="1401819">[</span><span class="op" id="1401820">]</span><span class="builtintype" id="1401821">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1401830">//&nbsp;data&nbsp;remaining&nbsp;in&nbsp;pending&nbsp;write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1401866">rwait</span>&nbsp;<span class="ident" id="1401872">sync</span><span class="op" id="1401876">.</span><span class="ident" id="1401877">Cond</span>&nbsp;&nbsp;<span class="comment" id="1401883">//&nbsp;waiting&nbsp;reader</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1401902">wwait</span>&nbsp;<span class="ident" id="1401908">sync</span><span class="op" id="1401912">.</span><span class="ident" id="1401913">Cond</span>&nbsp;&nbsp;<span class="comment" id="1401919">//&nbsp;waiting&nbsp;writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1401938">rerr</span>&nbsp;&nbsp;<span class="builtintype" id="1401944">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1401955">//&nbsp;if&nbsp;reader&nbsp;closed,&nbsp;error&nbsp;to&nbsp;give&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1401998">werr</span>&nbsp;&nbsp;<span class="builtintype" id="1402004">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1402015">//&nbsp;if&nbsp;writer&nbsp;closed,&nbsp;error&nbsp;to&nbsp;give&nbsp;reads</span><br>
<span class="lineno"></span><span class="op" id="1402056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="1402059">func</span>&nbsp;<span class="op" id="1402064">(</span><span class="ident" id="1402065">p</span>&nbsp;<span class="op" id="1402067">*</span><span class="ident" id="1402068">pipe</span><span class="op" id="1402072">)</span>&nbsp;<span class="ident" id="1402074">read</span><span class="op" id="1402078">(</span><span class="ident" id="1402079">b</span>&nbsp;<span class="op" id="1402081">[</span><span class="op" id="1402082">]</span><span class="builtintype" id="1402083">byte</span><span class="op" id="1402087">)</span>&nbsp;<span class="op" id="1402089">(</span><span class="ident" id="1402090">n</span>&nbsp;<span class="builtintype" id="1402092">int</span><span class="op" id="1402095">,</span>&nbsp;<span class="ident" id="1402097">err</span>&nbsp;<span class="builtintype" id="1402101">error</span><span class="op" id="1402106">)</span>&nbsp;<span class="op" id="1402108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1402111">//&nbsp;One&nbsp;reader&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402137">p</span><span class="op" id="1402138">.</span><span class="ident" id="1402139">rl</span><span class="op" id="1402141">.</span><span class="ident" id="1402142">Lock</span><span class="op" id="1402146">(</span><span class="op" id="1402147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402150">defer</span>&nbsp;<span class="ident" id="1402156">p</span><span class="op" id="1402157">.</span><span class="ident" id="1402158">rl</span><span class="op" id="1402160">.</span><span class="ident" id="1402161">Unlock</span><span class="op" id="1402167">(</span><span class="op" id="1402168">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402172">p</span><span class="op" id="1402173">.</span><span class="ident" id="1402174">l</span><span class="op" id="1402175">.</span><span class="ident" id="1402176">Lock</span><span class="op" id="1402180">(</span><span class="op" id="1402181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402184">defer</span>&nbsp;<span class="ident" id="1402190">p</span><span class="op" id="1402191">.</span><span class="ident" id="1402192">l</span><span class="op" id="1402193">.</span><span class="ident" id="1402194">Unlock</span><span class="op" id="1402200">(</span><span class="op" id="1402201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402204">for</span>&nbsp;<span class="op" id="1402208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402212">if</span>&nbsp;<span class="ident" id="1402215">p</span><span class="op" id="1402216">.</span><span class="ident" id="1402217">rerr</span>&nbsp;<span class="op" id="1402222">!=</span>&nbsp;<span class="builtintype" id="1402225">nil</span>&nbsp;<span class="op" id="1402229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402234">return</span>&nbsp;<span class="num" id="1402241">0</span><span class="op" id="1402242">,</span>&nbsp;<span class="ident" id="1402244">ErrClosedPipe</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1402260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402264">if</span>&nbsp;<span class="ident" id="1402267">p</span><span class="op" id="1402268">.</span><span class="ident" id="1402269">data</span>&nbsp;<span class="op" id="1402274">!=</span>&nbsp;<span class="builtintype" id="1402277">nil</span>&nbsp;<span class="op" id="1402281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402286">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1402294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402298">if</span>&nbsp;<span class="ident" id="1402301">p</span><span class="op" id="1402302">.</span><span class="ident" id="1402303">werr</span>&nbsp;<span class="op" id="1402308">!=</span>&nbsp;<span class="builtintype" id="1402311">nil</span>&nbsp;<span class="op" id="1402315">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402320">return</span>&nbsp;<span class="num" id="1402327">0</span><span class="op" id="1402328">,</span>&nbsp;<span class="ident" id="1402330">p</span><span class="op" id="1402331">.</span><span class="ident" id="1402332">werr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1402339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402343">p</span><span class="op" id="1402344">.</span><span class="ident" id="1402345">rwait</span><span class="op" id="1402350">.</span><span class="ident" id="1402351">Wait</span><span class="op" id="1402355">(</span><span class="op" id="1402356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1402359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402362">n</span>&nbsp;<span class="op" id="1402364">=</span>&nbsp;<span class="builtinfunc" id="1402366">copy</span><span class="op" id="1402370">(</span><span class="ident" id="1402371">b</span><span class="op" id="1402372">,</span>&nbsp;<span class="ident" id="1402374">p</span><span class="op" id="1402375">.</span><span class="ident" id="1402376">data</span><span class="op" id="1402380">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402383">p</span><span class="op" id="1402384">.</span><span class="ident" id="1402385">data</span>&nbsp;<span class="op" id="1402390">=</span>&nbsp;<span class="ident" id="1402392">p</span><span class="op" id="1402393">.</span><span class="ident" id="1402394">data</span><span class="op" id="1402398">[</span><span class="ident" id="1402399">n</span><span class="op" id="1402400">:</span><span class="op" id="1402401">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402404">if</span>&nbsp;<span class="builtinfunc" id="1402407">len</span><span class="op" id="1402410">(</span><span class="ident" id="1402411">p</span><span class="op" id="1402412">.</span><span class="ident" id="1402413">data</span><span class="op" id="1402417">)</span>&nbsp;<span class="op" id="1402419">==</span>&nbsp;<span class="num" id="1402422">0</span>&nbsp;<span class="op" id="1402424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402428">p</span><span class="op" id="1402429">.</span><span class="ident" id="1402430">data</span>&nbsp;<span class="op" id="1402435">=</span>&nbsp;<span class="builtintype" id="1402437">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402443">p</span><span class="op" id="1402444">.</span><span class="ident" id="1402445">wwait</span><span class="op" id="1402450">.</span><span class="ident" id="1402451">Signal</span><span class="op" id="1402457">(</span><span class="op" id="1402458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1402461">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402464">return</span><br>
<span class="lineno"></span><span class="op" id="1402471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1402474">var</span>&nbsp;<span class="ident" id="1402478">zero</span>&nbsp;<span class="op" id="1402483">[</span><span class="num" id="1402484">0</span><span class="op" id="1402485">]</span><span class="builtintype" id="1402486">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="1402492">func</span>&nbsp;<span class="op" id="1402497">(</span><span class="ident" id="1402498">p</span>&nbsp;<span class="op" id="1402500">*</span><span class="ident" id="1402501">pipe</span><span class="op" id="1402505">)</span>&nbsp;<span class="ident" id="1402507">write</span><span class="op" id="1402512">(</span><span class="ident" id="1402513">b</span>&nbsp;<span class="op" id="1402515">[</span><span class="op" id="1402516">]</span><span class="builtintype" id="1402517">byte</span><span class="op" id="1402521">)</span>&nbsp;<span class="op" id="1402523">(</span><span class="ident" id="1402524">n</span>&nbsp;<span class="builtintype" id="1402526">int</span><span class="op" id="1402529">,</span>&nbsp;<span class="ident" id="1402531">err</span>&nbsp;<span class="builtintype" id="1402535">error</span><span class="op" id="1402540">)</span>&nbsp;<span class="op" id="1402542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1402545">//&nbsp;pipe&nbsp;uses&nbsp;nil&nbsp;to&nbsp;mean&nbsp;not&nbsp;available</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402585">if</span>&nbsp;<span class="ident" id="1402588">b</span>&nbsp;<span class="op" id="1402590">==</span>&nbsp;<span class="builtintype" id="1402593">nil</span>&nbsp;<span class="op" id="1402597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402601">b</span>&nbsp;<span class="op" id="1402603">=</span>&nbsp;<span class="ident" id="1402605">zero</span><span class="op" id="1402609">[</span><span class="op" id="1402610">:</span><span class="op" id="1402611">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1402614">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1402618">//&nbsp;One&nbsp;writer&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402644">p</span><span class="op" id="1402645">.</span><span class="ident" id="1402646">wl</span><span class="op" id="1402648">.</span><span class="ident" id="1402649">Lock</span><span class="op" id="1402653">(</span><span class="op" id="1402654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402657">defer</span>&nbsp;<span class="ident" id="1402663">p</span><span class="op" id="1402664">.</span><span class="ident" id="1402665">wl</span><span class="op" id="1402667">.</span><span class="ident" id="1402668">Unlock</span><span class="op" id="1402674">(</span><span class="op" id="1402675">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402679">p</span><span class="op" id="1402680">.</span><span class="ident" id="1402681">l</span><span class="op" id="1402682">.</span><span class="ident" id="1402683">Lock</span><span class="op" id="1402687">(</span><span class="op" id="1402688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402691">defer</span>&nbsp;<span class="ident" id="1402697">p</span><span class="op" id="1402698">.</span><span class="ident" id="1402699">l</span><span class="op" id="1402700">.</span><span class="ident" id="1402701">Unlock</span><span class="op" id="1402707">(</span><span class="op" id="1402708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402711">if</span>&nbsp;<span class="ident" id="1402714">p</span><span class="op" id="1402715">.</span><span class="ident" id="1402716">werr</span>&nbsp;<span class="op" id="1402721">!=</span>&nbsp;<span class="builtintype" id="1402724">nil</span>&nbsp;<span class="op" id="1402728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402732">err</span>&nbsp;<span class="op" id="1402736">=</span>&nbsp;<span class="ident" id="1402738">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402754">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1402762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402765">p</span><span class="op" id="1402766">.</span><span class="ident" id="1402767">data</span>&nbsp;<span class="op" id="1402772">=</span>&nbsp;<span class="ident" id="1402774">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402777">p</span><span class="op" id="1402778">.</span><span class="ident" id="1402779">rwait</span><span class="op" id="1402784">.</span><span class="ident" id="1402785">Signal</span><span class="op" id="1402791">(</span><span class="op" id="1402792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402795">for</span>&nbsp;<span class="op" id="1402799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402803">if</span>&nbsp;<span class="ident" id="1402806">p</span><span class="op" id="1402807">.</span><span class="ident" id="1402808">data</span>&nbsp;<span class="op" id="1402813">==</span>&nbsp;<span class="builtintype" id="1402816">nil</span>&nbsp;<span class="op" id="1402820">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402825">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1402833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402837">if</span>&nbsp;<span class="ident" id="1402840">p</span><span class="op" id="1402841">.</span><span class="ident" id="1402842">rerr</span>&nbsp;<span class="op" id="1402847">!=</span>&nbsp;<span class="builtintype" id="1402850">nil</span>&nbsp;<span class="op" id="1402854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402859">err</span>&nbsp;<span class="op" id="1402863">=</span>&nbsp;<span class="ident" id="1402865">p</span><span class="op" id="1402866">.</span><span class="ident" id="1402867">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402875">break</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1402883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1402887">if</span>&nbsp;<span class="ident" id="1402890">p</span><span class="op" id="1402891">.</span><span class="ident" id="1402892">werr</span>&nbsp;<span class="op" id="1402897">!=</span>&nbsp;<span class="builtintype" id="1402900">nil</span>&nbsp;<span class="op" id="1402904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402909">err</span>&nbsp;<span class="op" id="1402913">=</span>&nbsp;<span class="ident" id="1402915">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1402931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402935">p</span><span class="op" id="1402936">.</span><span class="ident" id="1402937">wwait</span><span class="op" id="1402942">.</span><span class="ident" id="1402943">Wait</span><span class="op" id="1402947">(</span><span class="op" id="1402948">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1402951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402954">n</span>&nbsp;<span class="op" id="1402956">=</span>&nbsp;<span class="builtinfunc" id="1402958">len</span><span class="op" id="1402961">(</span><span class="ident" id="1402962">b</span><span class="op" id="1402963">)</span>&nbsp;<span class="op" id="1402965">-</span>&nbsp;<span class="builtinfunc" id="1402967">len</span><span class="op" id="1402970">(</span><span class="ident" id="1402971">p</span><span class="op" id="1402972">.</span><span class="ident" id="1402973">data</span><span class="op" id="1402977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1402980">p</span><span class="op" id="1402981">.</span><span class="ident" id="1402982">data</span>&nbsp;<span class="op" id="1402987">=</span>&nbsp;<span class="builtintype" id="1402989">nil</span>&nbsp;<span class="comment" id="1402993">//&nbsp;in&nbsp;case&nbsp;of&nbsp;rerr&nbsp;or&nbsp;werr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403021">return</span><br>
<span class="lineno"></span><span class="op" id="1403028">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="1403031">func</span>&nbsp;<span class="op" id="1403036">(</span><span class="ident" id="1403037">p</span>&nbsp;<span class="op" id="1403039">*</span><span class="ident" id="1403040">pipe</span><span class="op" id="1403044">)</span>&nbsp;<span class="ident" id="1403046">rclose</span><span class="op" id="1403052">(</span><span class="ident" id="1403053">err</span>&nbsp;<span class="builtintype" id="1403057">error</span><span class="op" id="1403062">)</span>&nbsp;<span class="op" id="1403064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403067">if</span>&nbsp;<span class="ident" id="1403070">err</span>&nbsp;<span class="op" id="1403074">==</span>&nbsp;<span class="builtintype" id="1403077">nil</span>&nbsp;<span class="op" id="1403081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403085">err</span>&nbsp;<span class="op" id="1403089">=</span>&nbsp;<span class="ident" id="1403091">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1403106">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403109">p</span><span class="op" id="1403110">.</span><span class="ident" id="1403111">l</span><span class="op" id="1403112">.</span><span class="ident" id="1403113">Lock</span><span class="op" id="1403117">(</span><span class="op" id="1403118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403121">defer</span>&nbsp;<span class="ident" id="1403127">p</span><span class="op" id="1403128">.</span><span class="ident" id="1403129">l</span><span class="op" id="1403130">.</span><span class="ident" id="1403131">Unlock</span><span class="op" id="1403137">(</span><span class="op" id="1403138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403141">p</span><span class="op" id="1403142">.</span><span class="ident" id="1403143">rerr</span>&nbsp;<span class="op" id="1403148">=</span>&nbsp;<span class="ident" id="1403150">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403155">p</span><span class="op" id="1403156">.</span><span class="ident" id="1403157">rwait</span><span class="op" id="1403162">.</span><span class="ident" id="1403163">Signal</span><span class="op" id="1403169">(</span><span class="op" id="1403170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403173">p</span><span class="op" id="1403174">.</span><span class="ident" id="1403175">wwait</span><span class="op" id="1403180">.</span><span class="ident" id="1403181">Signal</span><span class="op" id="1403187">(</span><span class="op" id="1403188">)</span><br>
<span class="lineno">110</span><span class="op" id="1403190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1403193">func</span>&nbsp;<span class="op" id="1403198">(</span><span class="ident" id="1403199">p</span>&nbsp;<span class="op" id="1403201">*</span><span class="ident" id="1403202">pipe</span><span class="op" id="1403206">)</span>&nbsp;<span class="ident" id="1403208">wclose</span><span class="op" id="1403214">(</span><span class="ident" id="1403215">err</span>&nbsp;<span class="builtintype" id="1403219">error</span><span class="op" id="1403224">)</span>&nbsp;<span class="op" id="1403226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403229">if</span>&nbsp;<span class="ident" id="1403232">err</span>&nbsp;<span class="op" id="1403236">==</span>&nbsp;<span class="builtintype" id="1403239">nil</span>&nbsp;<span class="op" id="1403243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403247">err</span>&nbsp;<span class="op" id="1403251">=</span>&nbsp;<span class="ident" id="1403253">EOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1403258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403261">p</span><span class="op" id="1403262">.</span><span class="ident" id="1403263">l</span><span class="op" id="1403264">.</span><span class="ident" id="1403265">Lock</span><span class="op" id="1403269">(</span><span class="op" id="1403270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403273">defer</span>&nbsp;<span class="ident" id="1403279">p</span><span class="op" id="1403280">.</span><span class="ident" id="1403281">l</span><span class="op" id="1403282">.</span><span class="ident" id="1403283">Unlock</span><span class="op" id="1403289">(</span><span class="op" id="1403290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403293">p</span><span class="op" id="1403294">.</span><span class="ident" id="1403295">werr</span>&nbsp;<span class="op" id="1403300">=</span>&nbsp;<span class="ident" id="1403302">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403307">p</span><span class="op" id="1403308">.</span><span class="ident" id="1403309">rwait</span><span class="op" id="1403314">.</span><span class="ident" id="1403315">Signal</span><span class="op" id="1403321">(</span><span class="op" id="1403322">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403325">p</span><span class="op" id="1403326">.</span><span class="ident" id="1403327">wwait</span><span class="op" id="1403332">.</span><span class="ident" id="1403333">Signal</span><span class="op" id="1403339">(</span><span class="op" id="1403340">)</span><br>
<span class="lineno"></span><span class="op" id="1403342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1403345">//&nbsp;A&nbsp;PipeReader&nbsp;is&nbsp;the&nbsp;read&nbsp;half&nbsp;of&nbsp;a&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1403389">type</span>&nbsp;<span class="ident" id="1403394">PipeReader</span>&nbsp;<span class="keyword" id="1403405">struct</span>&nbsp;<span class="op" id="1403412">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1403415">p</span>&nbsp;<span class="op" id="1403417">*</span><span class="ident" id="1403418">pipe</span><br>
<span class="lineno"></span><span class="op" id="1403423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1403426">//&nbsp;Read&nbsp;implements&nbsp;the&nbsp;standard&nbsp;Read&nbsp;interface:</span><br>
<span class="lineno"></span><span class="comment" id="1403474">//&nbsp;it&nbsp;reads&nbsp;data&nbsp;from&nbsp;the&nbsp;pipe,&nbsp;blocking&nbsp;until&nbsp;a&nbsp;writer</span><br>
<span class="lineno">130</span><span class="comment" id="1403530">//&nbsp;arrives&nbsp;or&nbsp;the&nbsp;write&nbsp;end&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="1403569">//&nbsp;If&nbsp;the&nbsp;write&nbsp;end&nbsp;is&nbsp;closed&nbsp;with&nbsp;an&nbsp;error,&nbsp;that&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1403628">//&nbsp;returned&nbsp;as&nbsp;err;&nbsp;otherwise&nbsp;err&nbsp;is&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="1403670">func</span>&nbsp;<span class="op" id="1403675">(</span><span class="ident" id="1403676">r</span>&nbsp;<span class="op" id="1403678">*</span><span class="ident" id="1403679">PipeReader</span><span class="op" id="1403689">)</span>&nbsp;<span class="ident" id="1403691">Read</span><span class="op" id="1403695">(</span><span class="ident" id="1403696">data</span>&nbsp;<span class="op" id="1403701">[</span><span class="op" id="1403702">]</span><span class="builtintype" id="1403703">byte</span><span class="op" id="1403707">)</span>&nbsp;<span class="op" id="1403709">(</span><span class="ident" id="1403710">n</span>&nbsp;<span class="builtintype" id="1403712">int</span><span class="op" id="1403715">,</span>&nbsp;<span class="ident" id="1403717">err</span>&nbsp;<span class="builtintype" id="1403721">error</span><span class="op" id="1403726">)</span>&nbsp;<span class="op" id="1403728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403731">return</span>&nbsp;<span class="ident" id="1403738">r</span><span class="op" id="1403739">.</span><span class="ident" id="1403740">p</span><span class="op" id="1403741">.</span><span class="ident" id="1403742">read</span><span class="op" id="1403746">(</span><span class="ident" id="1403747">data</span><span class="op" id="1403751">)</span><br>
<span class="lineno">135</span><span class="op" id="1403753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1403756">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;reader;&nbsp;subsequent&nbsp;writes&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1403809">//&nbsp;write&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;the&nbsp;error&nbsp;ErrClosedPipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1403872">func</span>&nbsp;<span class="op" id="1403877">(</span><span class="ident" id="1403878">r</span>&nbsp;<span class="op" id="1403880">*</span><span class="ident" id="1403881">PipeReader</span><span class="op" id="1403891">)</span>&nbsp;<span class="ident" id="1403893">Close</span><span class="op" id="1403898">(</span><span class="op" id="1403899">)</span>&nbsp;<span class="builtintype" id="1403901">error</span>&nbsp;<span class="op" id="1403907">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1403910">return</span>&nbsp;<span class="ident" id="1403917">r</span><span class="op" id="1403918">.</span><span class="ident" id="1403919">CloseWithError</span><span class="op" id="1403933">(</span><span class="builtintype" id="1403934">nil</span><span class="op" id="1403937">)</span><br>
<span class="lineno"></span><span class="op" id="1403939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1403942">//&nbsp;CloseWithError&nbsp;closes&nbsp;the&nbsp;reader;&nbsp;subsequent&nbsp;writes</span><br>
<span class="lineno"></span><span class="comment" id="1403997">//&nbsp;to&nbsp;the&nbsp;write&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;the&nbsp;error&nbsp;err.</span><br>
<span class="lineno">145</span><span class="keyword" id="1404057">func</span>&nbsp;<span class="op" id="1404062">(</span><span class="ident" id="1404063">r</span>&nbsp;<span class="op" id="1404065">*</span><span class="ident" id="1404066">PipeReader</span><span class="op" id="1404076">)</span>&nbsp;<span class="ident" id="1404078">CloseWithError</span><span class="op" id="1404092">(</span><span class="ident" id="1404093">err</span>&nbsp;<span class="builtintype" id="1404097">error</span><span class="op" id="1404102">)</span>&nbsp;<span class="builtintype" id="1404104">error</span>&nbsp;<span class="op" id="1404110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404113">r</span><span class="op" id="1404114">.</span><span class="ident" id="1404115">p</span><span class="op" id="1404116">.</span><span class="ident" id="1404117">rclose</span><span class="op" id="1404123">(</span><span class="ident" id="1404124">err</span><span class="op" id="1404127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404130">return</span>&nbsp;<span class="builtintype" id="1404137">nil</span><br>
<span class="lineno"></span><span class="op" id="1404141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1404144">//&nbsp;A&nbsp;PipeWriter&nbsp;is&nbsp;the&nbsp;write&nbsp;half&nbsp;of&nbsp;a&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1404189">type</span>&nbsp;<span class="ident" id="1404194">PipeWriter</span>&nbsp;<span class="keyword" id="1404205">struct</span>&nbsp;<span class="op" id="1404212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404215">p</span>&nbsp;<span class="op" id="1404217">*</span><span class="ident" id="1404218">pipe</span><br>
<span class="lineno"></span><span class="op" id="1404223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="1404226">//&nbsp;Write&nbsp;implements&nbsp;the&nbsp;standard&nbsp;Write&nbsp;interface:</span><br>
<span class="lineno"></span><span class="comment" id="1404276">//&nbsp;it&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;pipe,&nbsp;blocking&nbsp;until&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1404330">//&nbsp;have&nbsp;consumed&nbsp;all&nbsp;the&nbsp;data&nbsp;or&nbsp;the&nbsp;read&nbsp;end&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="1404387">//&nbsp;If&nbsp;the&nbsp;read&nbsp;end&nbsp;is&nbsp;closed&nbsp;with&nbsp;an&nbsp;error,&nbsp;that&nbsp;err&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1404443">//&nbsp;returned&nbsp;as&nbsp;err;&nbsp;otherwise&nbsp;err&nbsp;is&nbsp;ErrClosedPipe.</span><br>
<span class="lineno">160</span><span class="keyword" id="1404495">func</span>&nbsp;<span class="op" id="1404500">(</span><span class="ident" id="1404501">w</span>&nbsp;<span class="op" id="1404503">*</span><span class="ident" id="1404504">PipeWriter</span><span class="op" id="1404514">)</span>&nbsp;<span class="ident" id="1404516">Write</span><span class="op" id="1404521">(</span><span class="ident" id="1404522">data</span>&nbsp;<span class="op" id="1404527">[</span><span class="op" id="1404528">]</span><span class="builtintype" id="1404529">byte</span><span class="op" id="1404533">)</span>&nbsp;<span class="op" id="1404535">(</span><span class="ident" id="1404536">n</span>&nbsp;<span class="builtintype" id="1404538">int</span><span class="op" id="1404541">,</span>&nbsp;<span class="ident" id="1404543">err</span>&nbsp;<span class="builtintype" id="1404547">error</span><span class="op" id="1404552">)</span>&nbsp;<span class="op" id="1404554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404557">return</span>&nbsp;<span class="ident" id="1404564">w</span><span class="op" id="1404565">.</span><span class="ident" id="1404566">p</span><span class="op" id="1404567">.</span><span class="ident" id="1404568">write</span><span class="op" id="1404573">(</span><span class="ident" id="1404574">data</span><span class="op" id="1404578">)</span><br>
<span class="lineno"></span><span class="op" id="1404580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1404583">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;writer;&nbsp;subsequent&nbsp;reads&nbsp;from&nbsp;the</span><br>
<span class="lineno">165</span><span class="comment" id="1404637">//&nbsp;read&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;no&nbsp;bytes&nbsp;and&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="1404692">func</span>&nbsp;<span class="op" id="1404697">(</span><span class="ident" id="1404698">w</span>&nbsp;<span class="op" id="1404700">*</span><span class="ident" id="1404701">PipeWriter</span><span class="op" id="1404711">)</span>&nbsp;<span class="ident" id="1404713">Close</span><span class="op" id="1404718">(</span><span class="op" id="1404719">)</span>&nbsp;<span class="builtintype" id="1404721">error</span>&nbsp;<span class="op" id="1404727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404730">return</span>&nbsp;<span class="ident" id="1404737">w</span><span class="op" id="1404738">.</span><span class="ident" id="1404739">CloseWithError</span><span class="op" id="1404753">(</span><span class="builtintype" id="1404754">nil</span><span class="op" id="1404757">)</span><br>
<span class="lineno"></span><span class="op" id="1404759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="1404762">//&nbsp;CloseWithError&nbsp;closes&nbsp;the&nbsp;writer;&nbsp;subsequent&nbsp;reads&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1404825">//&nbsp;read&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;no&nbsp;bytes&nbsp;and&nbsp;the&nbsp;error&nbsp;err.</span><br>
<span class="lineno"></span><span class="keyword" id="1404890">func</span>&nbsp;<span class="op" id="1404895">(</span><span class="ident" id="1404896">w</span>&nbsp;<span class="op" id="1404898">*</span><span class="ident" id="1404899">PipeWriter</span><span class="op" id="1404909">)</span>&nbsp;<span class="ident" id="1404911">CloseWithError</span><span class="op" id="1404925">(</span><span class="ident" id="1404926">err</span>&nbsp;<span class="builtintype" id="1404930">error</span><span class="op" id="1404935">)</span>&nbsp;<span class="builtintype" id="1404937">error</span>&nbsp;<span class="op" id="1404943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404946">w</span><span class="op" id="1404947">.</span><span class="ident" id="1404948">p</span><span class="op" id="1404949">.</span><span class="ident" id="1404950">wclose</span><span class="op" id="1404956">(</span><span class="ident" id="1404957">err</span><span class="op" id="1404960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404963">return</span>&nbsp;<span class="builtintype" id="1404970">nil</span><br>
<span class="lineno">175</span><span class="op" id="1404974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1404977">//&nbsp;Pipe&nbsp;creates&nbsp;a&nbsp;synchronous&nbsp;in-memory&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="1405023">//&nbsp;It&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;connect&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Reader</span><br>
<span class="lineno"></span><span class="comment" id="1405080">//&nbsp;with&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno">180</span><span class="comment" id="1405117">//&nbsp;Reads&nbsp;on&nbsp;one&nbsp;end&nbsp;are&nbsp;matched&nbsp;with&nbsp;writes&nbsp;on&nbsp;the&nbsp;other,</span><br>
<span class="lineno"></span><span class="comment" id="1405175">//&nbsp;copying&nbsp;data&nbsp;directly&nbsp;between&nbsp;the&nbsp;two;&nbsp;there&nbsp;is&nbsp;no&nbsp;internal&nbsp;buffering.</span><br>
<span class="lineno"></span><span class="comment" id="1405249">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;Read&nbsp;and&nbsp;Write&nbsp;in&nbsp;parallel&nbsp;with&nbsp;each&nbsp;other&nbsp;or&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1405322">//&nbsp;Close.&nbsp;Close&nbsp;will&nbsp;complete&nbsp;once&nbsp;pending&nbsp;I/O&nbsp;is&nbsp;done.&nbsp;Parallel&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1405396">//&nbsp;Read,&nbsp;and&nbsp;parallel&nbsp;calls&nbsp;to&nbsp;Write,&nbsp;are&nbsp;also&nbsp;safe:</span><br>
<span class="lineno">185</span><span class="comment" id="1405449">//&nbsp;the&nbsp;individual&nbsp;calls&nbsp;will&nbsp;be&nbsp;gated&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="keyword" id="1405501">func</span>&nbsp;<span class="ident" id="1405506">Pipe</span><span class="op" id="1405510">(</span><span class="op" id="1405511">)</span>&nbsp;<span class="op" id="1405513">(</span><span class="op" id="1405514">*</span><span class="ident" id="1405515">PipeReader</span><span class="op" id="1405525">,</span>&nbsp;<span class="op" id="1405527">*</span><span class="ident" id="1405528">PipeWriter</span><span class="op" id="1405538">)</span>&nbsp;<span class="op" id="1405540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405543">p</span>&nbsp;<span class="op" id="1405545">:=</span>&nbsp;<span class="builtinfunc" id="1405548">new</span><span class="op" id="1405551">(</span><span class="ident" id="1405552">pipe</span><span class="op" id="1405556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405559">p</span><span class="op" id="1405560">.</span><span class="ident" id="1405561">rwait</span><span class="op" id="1405566">.</span><span class="ident" id="1405567">L</span>&nbsp;<span class="op" id="1405569">=</span>&nbsp;<span class="op" id="1405571">&amp;</span><span class="ident" id="1405572">p</span><span class="op" id="1405573">.</span><span class="ident" id="1405574">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405577">p</span><span class="op" id="1405578">.</span><span class="ident" id="1405579">wwait</span><span class="op" id="1405584">.</span><span class="ident" id="1405585">L</span>&nbsp;<span class="op" id="1405587">=</span>&nbsp;<span class="op" id="1405589">&amp;</span><span class="ident" id="1405590">p</span><span class="op" id="1405591">.</span><span class="ident" id="1405592">l</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405595">r</span>&nbsp;<span class="op" id="1405597">:=</span>&nbsp;<span class="op" id="1405600">&amp;</span><span class="ident" id="1405601">PipeReader</span><span class="op" id="1405611">{</span><span class="ident" id="1405612">p</span><span class="op" id="1405613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405616">w</span>&nbsp;<span class="op" id="1405618">:=</span>&nbsp;<span class="op" id="1405621">&amp;</span><span class="ident" id="1405622">PipeWriter</span><span class="op" id="1405632">{</span><span class="ident" id="1405633">p</span><span class="op" id="1405634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405637">return</span>&nbsp;<span class="ident" id="1405644">r</span><span class="op" id="1405645">,</span>&nbsp;<span class="ident" id="1405647">w</span><br>
<span class="lineno"></span><span class="op" id="1405649">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
