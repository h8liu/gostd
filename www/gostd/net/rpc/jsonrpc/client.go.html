<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4689193">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4689249">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4689303">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4689354">//&nbsp;Package&nbsp;jsonrpc&nbsp;implements&nbsp;a&nbsp;JSON-RPC&nbsp;ClientCodec&nbsp;and&nbsp;ServerCodec</span><br>
<span class="lineno"></span><span class="comment" id="4689423">//&nbsp;for&nbsp;the&nbsp;rpc&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4689447">package</span>&nbsp;<span class="ident" id="4689455">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4689464">import</span>&nbsp;<span class="op" id="4689471">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4689474">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4689491">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4689498">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4689504">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4689511">&#34;net/rpc&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4689522">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4689529">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4689532">type</span>&nbsp;<span class="ident" id="4689537">clientCodec</span>&nbsp;<span class="keyword" id="4689549">struct</span>&nbsp;<span class="op" id="4689556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689559">dec</span>&nbsp;<span class="op" id="4689563">*</span><span class="ident" id="4689564">json</span><span class="op" id="4689568">.</span><span class="ident" id="4689569">Decoder</span>&nbsp;<span class="comment" id="4689577">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689605">enc</span>&nbsp;<span class="op" id="4689609">*</span><span class="ident" id="4689610">json</span><span class="op" id="4689614">.</span><span class="ident" id="4689615">Encoder</span>&nbsp;<span class="comment" id="4689623">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689651">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4689655">io</span><span class="op" id="4689657">.</span><span class="ident" id="4689658">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4689667">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689692">req</span>&nbsp;&nbsp;<span class="ident" id="4689697">clientRequest</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689712">resp</span>&nbsp;<span class="ident" id="4689717">clientResponse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4689734">//&nbsp;JSON-RPC&nbsp;responses&nbsp;include&nbsp;the&nbsp;request&nbsp;id&nbsp;but&nbsp;not&nbsp;the&nbsp;request&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4689808">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;both.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4689838">//&nbsp;We&nbsp;save&nbsp;the&nbsp;request&nbsp;method&nbsp;in&nbsp;pending&nbsp;when&nbsp;sending&nbsp;a&nbsp;request</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4689903">//&nbsp;and&nbsp;then&nbsp;look&nbsp;it&nbsp;up&nbsp;by&nbsp;request&nbsp;ID&nbsp;when&nbsp;filling&nbsp;out&nbsp;the&nbsp;rpc&nbsp;Response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4689976">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4689984">sync</span><span class="op" id="4689988">.</span><span class="ident" id="4689989">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4690002">//&nbsp;protects&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690023">pending</span>&nbsp;<span class="keyword" id="4690031">map</span><span class="op" id="4690034">[</span><span class="ident" id="4690035">uint64</span><span class="op" id="4690041">]</span><span class="builtintype" id="4690042">string</span>&nbsp;<span class="comment" id="4690049">//&nbsp;map&nbsp;request&nbsp;id&nbsp;to&nbsp;method&nbsp;name</span><br>
<span class="lineno"></span><span class="op" id="4690082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="4690085">//&nbsp;NewClientCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ClientCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="4690157">func</span>&nbsp;<span class="ident" id="4690162">NewClientCodec</span><span class="op" id="4690176">(</span><span class="ident" id="4690177">conn</span>&nbsp;<span class="ident" id="4690182">io</span><span class="op" id="4690184">.</span><span class="ident" id="4690185">ReadWriteCloser</span><span class="op" id="4690200">)</span>&nbsp;<span class="ident" id="4690202">rpc</span><span class="op" id="4690205">.</span><span class="ident" id="4690206">ClientCodec</span>&nbsp;<span class="op" id="4690218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690221">return</span>&nbsp;<span class="op" id="4690228">&amp;</span><span class="ident" id="4690229">clientCodec</span><span class="op" id="4690240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690244">dec</span><span class="op" id="4690247">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4690253">json</span><span class="op" id="4690257">.</span><span class="ident" id="4690258">NewDecoder</span><span class="op" id="4690268">(</span><span class="ident" id="4690269">conn</span><span class="op" id="4690273">)</span><span class="op" id="4690274">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690278">enc</span><span class="op" id="4690281">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4690287">json</span><span class="op" id="4690291">.</span><span class="ident" id="4690292">NewEncoder</span><span class="op" id="4690302">(</span><span class="ident" id="4690303">conn</span><span class="op" id="4690307">)</span><span class="op" id="4690308">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690312">c</span><span class="op" id="4690313">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4690321">conn</span><span class="op" id="4690325">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690329">pending</span><span class="op" id="4690336">:</span>&nbsp;<span class="builtinfunc" id="4690338">make</span><span class="op" id="4690342">(</span><span class="keyword" id="4690343">map</span><span class="op" id="4690346">[</span><span class="ident" id="4690347">uint64</span><span class="op" id="4690353">]</span><span class="builtintype" id="4690354">string</span><span class="op" id="4690360">)</span><span class="op" id="4690361">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4690364">}</span><br>
<span class="lineno"></span><span class="op" id="4690366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="4690369">type</span>&nbsp;<span class="ident" id="4690374">clientRequest</span>&nbsp;<span class="keyword" id="4690388">struct</span>&nbsp;<span class="op" id="4690395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690398">Method</span>&nbsp;<span class="builtintype" id="4690405">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4690420">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690437">Params</span>&nbsp;<span class="op" id="4690444">[</span><span class="num" id="4690445">1</span><span class="op" id="4690446">]</span><span class="keyword" id="4690447">interface</span><span class="op" id="4690456">{</span><span class="op" id="4690457">}</span>&nbsp;<span class="string" id="4690459">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690476">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4690483">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4690498">`json:&#34;id&#34;`</span><br>
<span class="lineno"></span><span class="op" id="4690510">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="4690513">func</span>&nbsp;<span class="op" id="4690518">(</span><span class="ident" id="4690519">c</span>&nbsp;<span class="op" id="4690521">*</span><span class="ident" id="4690522">clientCodec</span><span class="op" id="4690533">)</span>&nbsp;<span class="ident" id="4690535">WriteRequest</span><span class="op" id="4690547">(</span><span class="ident" id="4690548">r</span>&nbsp;<span class="op" id="4690550">*</span><span class="ident" id="4690551">rpc</span><span class="op" id="4690554">.</span><span class="ident" id="4690555">Request</span><span class="op" id="4690562">,</span>&nbsp;<span class="ident" id="4690564">param</span>&nbsp;<span class="keyword" id="4690570">interface</span><span class="op" id="4690579">{</span><span class="op" id="4690580">}</span><span class="op" id="4690581">)</span>&nbsp;<span class="builtintype" id="4690583">error</span>&nbsp;<span class="op" id="4690589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690592">c</span><span class="op" id="4690593">.</span><span class="ident" id="4690594">mutex</span><span class="op" id="4690599">.</span><span class="ident" id="4690600">Lock</span><span class="op" id="4690604">(</span><span class="op" id="4690605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690608">c</span><span class="op" id="4690609">.</span><span class="ident" id="4690610">pending</span><span class="op" id="4690617">[</span><span class="ident" id="4690618">r</span><span class="op" id="4690619">.</span><span class="ident" id="4690620">Seq</span><span class="op" id="4690623">]</span>&nbsp;<span class="op" id="4690625">=</span>&nbsp;<span class="ident" id="4690627">r</span><span class="op" id="4690628">.</span><span class="ident" id="4690629">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690644">c</span><span class="op" id="4690645">.</span><span class="ident" id="4690646">mutex</span><span class="op" id="4690651">.</span><span class="ident" id="4690652">Unlock</span><span class="op" id="4690658">(</span><span class="op" id="4690659">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690662">c</span><span class="op" id="4690663">.</span><span class="ident" id="4690664">req</span><span class="op" id="4690667">.</span><span class="ident" id="4690668">Method</span>&nbsp;<span class="op" id="4690675">=</span>&nbsp;<span class="ident" id="4690677">r</span><span class="op" id="4690678">.</span><span class="ident" id="4690679">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690694">c</span><span class="op" id="4690695">.</span><span class="ident" id="4690696">req</span><span class="op" id="4690699">.</span><span class="ident" id="4690700">Params</span><span class="op" id="4690706">[</span><span class="num" id="4690707">0</span><span class="op" id="4690708">]</span>&nbsp;<span class="op" id="4690710">=</span>&nbsp;<span class="ident" id="4690712">param</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690719">c</span><span class="op" id="4690720">.</span><span class="ident" id="4690721">req</span><span class="op" id="4690724">.</span><span class="ident" id="4690725">Id</span>&nbsp;<span class="op" id="4690728">=</span>&nbsp;<span class="ident" id="4690730">r</span><span class="op" id="4690731">.</span><span class="ident" id="4690732">Seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4690737">return</span>&nbsp;<span class="ident" id="4690744">c</span><span class="op" id="4690745">.</span><span class="ident" id="4690746">enc</span><span class="op" id="4690749">.</span><span class="ident" id="4690750">Encode</span><span class="op" id="4690756">(</span><span class="op" id="4690757">&amp;</span><span class="ident" id="4690758">c</span><span class="op" id="4690759">.</span><span class="ident" id="4690760">req</span><span class="op" id="4690763">)</span><br>
<span class="lineno"></span><span class="op" id="4690765">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="4690768">type</span>&nbsp;<span class="ident" id="4690773">clientResponse</span>&nbsp;<span class="keyword" id="4690788">struct</span>&nbsp;<span class="op" id="4690795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690798">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4690805">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4690822">`json:&#34;id&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690835">Result</span>&nbsp;<span class="op" id="4690842">*</span><span class="ident" id="4690843">json</span><span class="op" id="4690847">.</span><span class="ident" id="4690848">RawMessage</span>&nbsp;<span class="string" id="4690859">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690876">Error</span>&nbsp;&nbsp;<span class="keyword" id="4690883">interface</span><span class="op" id="4690892">{</span><span class="op" id="4690893">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4690900">`json:&#34;error&#34;`</span><br>
<span class="lineno">65</span><span class="op" id="4690915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4690918">func</span>&nbsp;<span class="op" id="4690923">(</span><span class="ident" id="4690924">r</span>&nbsp;<span class="op" id="4690926">*</span><span class="ident" id="4690927">clientResponse</span><span class="op" id="4690941">)</span>&nbsp;<span class="ident" id="4690943">reset</span><span class="op" id="4690948">(</span><span class="op" id="4690949">)</span>&nbsp;<span class="op" id="4690951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690954">r</span><span class="op" id="4690955">.</span><span class="ident" id="4690956">Id</span>&nbsp;<span class="op" id="4690959">=</span>&nbsp;<span class="num" id="4690961">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690964">r</span><span class="op" id="4690965">.</span><span class="ident" id="4690966">Result</span>&nbsp;<span class="op" id="4690973">=</span>&nbsp;<span class="ident" id="4690975">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4690980">r</span><span class="op" id="4690981">.</span><span class="ident" id="4690982">Error</span>&nbsp;<span class="op" id="4690988">=</span>&nbsp;<span class="ident" id="4690990">nil</span><br>
<span class="lineno"></span><span class="op" id="4690994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4690997">func</span>&nbsp;<span class="op" id="4691002">(</span><span class="ident" id="4691003">c</span>&nbsp;<span class="op" id="4691005">*</span><span class="ident" id="4691006">clientCodec</span><span class="op" id="4691017">)</span>&nbsp;<span class="ident" id="4691019">ReadResponseHeader</span><span class="op" id="4691037">(</span><span class="ident" id="4691038">r</span>&nbsp;<span class="op" id="4691040">*</span><span class="ident" id="4691041">rpc</span><span class="op" id="4691044">.</span><span class="ident" id="4691045">Response</span><span class="op" id="4691053">)</span>&nbsp;<span class="builtintype" id="4691055">error</span>&nbsp;<span class="op" id="4691061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691064">c</span><span class="op" id="4691065">.</span><span class="ident" id="4691066">resp</span><span class="op" id="4691070">.</span><span class="ident" id="4691071">reset</span><span class="op" id="4691076">(</span><span class="op" id="4691077">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691080">if</span>&nbsp;<span class="ident" id="4691083">err</span>&nbsp;<span class="op" id="4691087">:=</span>&nbsp;<span class="ident" id="4691090">c</span><span class="op" id="4691091">.</span><span class="ident" id="4691092">dec</span><span class="op" id="4691095">.</span><span class="ident" id="4691096">Decode</span><span class="op" id="4691102">(</span><span class="op" id="4691103">&amp;</span><span class="ident" id="4691104">c</span><span class="op" id="4691105">.</span><span class="ident" id="4691106">resp</span><span class="op" id="4691110">)</span><span class="op" id="4691111">;</span>&nbsp;<span class="ident" id="4691113">err</span>&nbsp;<span class="op" id="4691117">!=</span>&nbsp;<span class="ident" id="4691120">nil</span>&nbsp;<span class="op" id="4691124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691128">return</span>&nbsp;<span class="ident" id="4691135">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4691140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691144">c</span><span class="op" id="4691145">.</span><span class="ident" id="4691146">mutex</span><span class="op" id="4691151">.</span><span class="ident" id="4691152">Lock</span><span class="op" id="4691156">(</span><span class="op" id="4691157">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691160">r</span><span class="op" id="4691161">.</span><span class="ident" id="4691162">ServiceMethod</span>&nbsp;<span class="op" id="4691176">=</span>&nbsp;<span class="ident" id="4691178">c</span><span class="op" id="4691179">.</span><span class="ident" id="4691180">pending</span><span class="op" id="4691187">[</span><span class="ident" id="4691188">c</span><span class="op" id="4691189">.</span><span class="ident" id="4691190">resp</span><span class="op" id="4691194">.</span><span class="ident" id="4691195">Id</span><span class="op" id="4691197">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4691200">delete</span><span class="op" id="4691206">(</span><span class="ident" id="4691207">c</span><span class="op" id="4691208">.</span><span class="ident" id="4691209">pending</span><span class="op" id="4691216">,</span>&nbsp;<span class="ident" id="4691218">c</span><span class="op" id="4691219">.</span><span class="ident" id="4691220">resp</span><span class="op" id="4691224">.</span><span class="ident" id="4691225">Id</span><span class="op" id="4691227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691230">c</span><span class="op" id="4691231">.</span><span class="ident" id="4691232">mutex</span><span class="op" id="4691237">.</span><span class="ident" id="4691238">Unlock</span><span class="op" id="4691244">(</span><span class="op" id="4691245">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691249">r</span><span class="op" id="4691250">.</span><span class="ident" id="4691251">Error</span>&nbsp;<span class="op" id="4691257">=</span>&nbsp;<span class="string" id="4691259">&#34;&#34;</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691263">r</span><span class="op" id="4691264">.</span><span class="ident" id="4691265">Seq</span>&nbsp;<span class="op" id="4691269">=</span>&nbsp;<span class="ident" id="4691271">c</span><span class="op" id="4691272">.</span><span class="ident" id="4691273">resp</span><span class="op" id="4691277">.</span><span class="ident" id="4691278">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691282">if</span>&nbsp;<span class="ident" id="4691285">c</span><span class="op" id="4691286">.</span><span class="ident" id="4691287">resp</span><span class="op" id="4691291">.</span><span class="ident" id="4691292">Error</span>&nbsp;<span class="op" id="4691298">!=</span>&nbsp;<span class="ident" id="4691301">nil</span>&nbsp;<span class="op" id="4691305">||</span>&nbsp;<span class="ident" id="4691308">c</span><span class="op" id="4691309">.</span><span class="ident" id="4691310">resp</span><span class="op" id="4691314">.</span><span class="ident" id="4691315">Result</span>&nbsp;<span class="op" id="4691322">==</span>&nbsp;<span class="ident" id="4691325">nil</span>&nbsp;<span class="op" id="4691329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691333">x</span><span class="op" id="4691334">,</span>&nbsp;<span class="ident" id="4691336">ok</span>&nbsp;<span class="op" id="4691339">:=</span>&nbsp;<span class="ident" id="4691342">c</span><span class="op" id="4691343">.</span><span class="ident" id="4691344">resp</span><span class="op" id="4691348">.</span><span class="ident" id="4691349">Error</span><span class="op" id="4691354">.</span><span class="op" id="4691355">(</span><span class="builtintype" id="4691356">string</span><span class="op" id="4691362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691366">if</span>&nbsp;<span class="op" id="4691369">!</span><span class="ident" id="4691370">ok</span>&nbsp;<span class="op" id="4691373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691378">return</span>&nbsp;<span class="ident" id="4691385">fmt</span><span class="op" id="4691388">.</span><span class="ident" id="4691389">Errorf</span><span class="op" id="4691395">(</span><span class="string" id="4691396">&#34;invalid&nbsp;error&nbsp;%v&#34;</span><span class="op" id="4691414">,</span>&nbsp;<span class="ident" id="4691416">c</span><span class="op" id="4691417">.</span><span class="ident" id="4691418">resp</span><span class="op" id="4691422">.</span><span class="ident" id="4691423">Error</span><span class="op" id="4691428">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4691432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691436">if</span>&nbsp;<span class="ident" id="4691439">x</span>&nbsp;<span class="op" id="4691441">==</span>&nbsp;<span class="string" id="4691444">&#34;&#34;</span>&nbsp;<span class="op" id="4691447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691452">x</span>&nbsp;<span class="op" id="4691454">=</span>&nbsp;<span class="string" id="4691456">&#34;unspecified&nbsp;error&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4691478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4691482">r</span><span class="op" id="4691483">.</span><span class="ident" id="4691484">Error</span>&nbsp;<span class="op" id="4691490">=</span>&nbsp;<span class="ident" id="4691492">x</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4691495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691498">return</span>&nbsp;<span class="ident" id="4691505">nil</span><br>
<span class="lineno"></span><span class="op" id="4691509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4691512">func</span>&nbsp;<span class="op" id="4691517">(</span><span class="ident" id="4691518">c</span>&nbsp;<span class="op" id="4691520">*</span><span class="ident" id="4691521">clientCodec</span><span class="op" id="4691532">)</span>&nbsp;<span class="ident" id="4691534">ReadResponseBody</span><span class="op" id="4691550">(</span><span class="ident" id="4691551">x</span>&nbsp;<span class="keyword" id="4691553">interface</span><span class="op" id="4691562">{</span><span class="op" id="4691563">}</span><span class="op" id="4691564">)</span>&nbsp;<span class="builtintype" id="4691566">error</span>&nbsp;<span class="op" id="4691572">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691575">if</span>&nbsp;<span class="ident" id="4691578">x</span>&nbsp;<span class="op" id="4691580">==</span>&nbsp;<span class="ident" id="4691583">nil</span>&nbsp;<span class="op" id="4691587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691591">return</span>&nbsp;<span class="ident" id="4691598">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4691603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691606">return</span>&nbsp;<span class="ident" id="4691613">json</span><span class="op" id="4691617">.</span><span class="ident" id="4691618">Unmarshal</span><span class="op" id="4691627">(</span><span class="op" id="4691628">*</span><span class="ident" id="4691629">c</span><span class="op" id="4691630">.</span><span class="ident" id="4691631">resp</span><span class="op" id="4691635">.</span><span class="ident" id="4691636">Result</span><span class="op" id="4691642">,</span>&nbsp;<span class="ident" id="4691644">x</span><span class="op" id="4691645">)</span><br>
<span class="lineno"></span><span class="op" id="4691647">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="4691650">func</span>&nbsp;<span class="op" id="4691655">(</span><span class="ident" id="4691656">c</span>&nbsp;<span class="op" id="4691658">*</span><span class="ident" id="4691659">clientCodec</span><span class="op" id="4691670">)</span>&nbsp;<span class="ident" id="4691672">Close</span><span class="op" id="4691677">(</span><span class="op" id="4691678">)</span>&nbsp;<span class="builtintype" id="4691680">error</span>&nbsp;<span class="op" id="4691686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691689">return</span>&nbsp;<span class="ident" id="4691696">c</span><span class="op" id="4691697">.</span><span class="ident" id="4691698">c</span><span class="op" id="4691699">.</span><span class="ident" id="4691700">Close</span><span class="op" id="4691705">(</span><span class="op" id="4691706">)</span><br>
<span class="lineno"></span><span class="op" id="4691708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="4691711">//&nbsp;NewClient&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.Client&nbsp;to&nbsp;handle&nbsp;requests&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4691775">//&nbsp;set&nbsp;of&nbsp;services&nbsp;at&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4691830">func</span>&nbsp;<span class="ident" id="4691835">NewClient</span><span class="op" id="4691844">(</span><span class="ident" id="4691845">conn</span>&nbsp;<span class="ident" id="4691850">io</span><span class="op" id="4691852">.</span><span class="ident" id="4691853">ReadWriteCloser</span><span class="op" id="4691868">)</span>&nbsp;<span class="op" id="4691870">*</span><span class="ident" id="4691871">rpc</span><span class="op" id="4691874">.</span><span class="ident" id="4691875">Client</span>&nbsp;<span class="op" id="4691882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4691885">return</span>&nbsp;<span class="ident" id="4691892">rpc</span><span class="op" id="4691895">.</span><span class="ident" id="4691896">NewClientWithCodec</span><span class="op" id="4691914">(</span><span class="ident" id="4691915">NewClientCodec</span><span class="op" id="4691929">(</span><span class="ident" id="4691930">conn</span><span class="op" id="4691934">)</span><span class="op" id="4691935">)</span><br>
<span class="lineno"></span><span class="op" id="4691937">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="4691940">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;a&nbsp;JSON-RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4692012">func</span>&nbsp;<span class="ident" id="4692017">Dial</span><span class="op" id="4692021">(</span><span class="ident" id="4692022">network</span><span class="op" id="4692029">,</span>&nbsp;<span class="ident" id="4692031">address</span>&nbsp;<span class="builtintype" id="4692039">string</span><span class="op" id="4692045">)</span>&nbsp;<span class="op" id="4692047">(</span><span class="op" id="4692048">*</span><span class="ident" id="4692049">rpc</span><span class="op" id="4692052">.</span><span class="ident" id="4692053">Client</span><span class="op" id="4692059">,</span>&nbsp;<span class="builtintype" id="4692061">error</span><span class="op" id="4692066">)</span>&nbsp;<span class="op" id="4692068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4692071">conn</span><span class="op" id="4692075">,</span>&nbsp;<span class="ident" id="4692077">err</span>&nbsp;<span class="op" id="4692081">:=</span>&nbsp;<span class="ident" id="4692084">net</span><span class="op" id="4692087">.</span><span class="ident" id="4692088">Dial</span><span class="op" id="4692092">(</span><span class="ident" id="4692093">network</span><span class="op" id="4692100">,</span>&nbsp;<span class="ident" id="4692102">address</span><span class="op" id="4692109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692112">if</span>&nbsp;<span class="ident" id="4692115">err</span>&nbsp;<span class="op" id="4692119">!=</span>&nbsp;<span class="ident" id="4692122">nil</span>&nbsp;<span class="op" id="4692126">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692130">return</span>&nbsp;<span class="ident" id="4692137">nil</span><span class="op" id="4692140">,</span>&nbsp;<span class="ident" id="4692142">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4692147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4692150">return</span>&nbsp;<span class="ident" id="4692157">NewClient</span><span class="op" id="4692166">(</span><span class="ident" id="4692167">conn</span><span class="op" id="4692171">)</span><span class="op" id="4692172">,</span>&nbsp;<span class="ident" id="4692174">err</span><br>
<span class="lineno"></span><span class="op" id="4692178">}</span>
</div>
</body>
</html>
