<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3425899">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3425954">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3426008">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3426059">//&nbsp;HTTP&nbsp;Response&nbsp;reading&nbsp;and&nbsp;parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3426098">package</span>&nbsp;<span class="ident" id="3426106">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3426112">import</span>&nbsp;<span class="op" id="3426119">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3426122">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3426131">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3426140">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3426154">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3426164">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3426170">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3426187">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3426198">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3426209">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="3426219">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3426222">var</span>&nbsp;<span class="ident" id="3426226">respExcludeHeader</span>&nbsp;<span class="op" id="3426244">=</span>&nbsp;<span class="keyword" id="3426246">map</span><span class="op" id="3426249">[</span><span class="builtintype" id="3426250">string</span><span class="op" id="3426256">]</span><span class="builtintype" id="3426257">bool</span><span class="op" id="3426261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3426264">&#34;Content-Length&#34;</span><span class="op" id="3426280">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3426285">true</span><span class="op" id="3426289">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3426292">&#34;Transfer-Encoding&#34;</span><span class="op" id="3426311">:</span>&nbsp;<span class="builtintype" id="3426313">true</span><span class="op" id="3426317">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3426320">&#34;Trailer&#34;</span><span class="op" id="3426329">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3426341">true</span><span class="op" id="3426345">,</span><br>
<span class="lineno">25</span><span class="op" id="3426347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3426350">//&nbsp;Response&nbsp;represents&nbsp;the&nbsp;response&nbsp;from&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3426408">//</span><br>
<span class="lineno"></span><span class="keyword" id="3426411">type</span>&nbsp;<span class="ident" id="3426416">Response</span>&nbsp;<span class="keyword" id="3426425">struct</span>&nbsp;<span class="op" id="3426432">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3426435">Status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3426446">string</span>&nbsp;<span class="comment" id="3426453">//&nbsp;e.g.&nbsp;&#34;200&nbsp;OK&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3426471">StatusCode</span>&nbsp;<span class="builtintype" id="3426482">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3426489">//&nbsp;e.g.&nbsp;200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3426502">Proto</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3426513">string</span>&nbsp;<span class="comment" id="3426520">//&nbsp;e.g.&nbsp;&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3426540">ProtoMajor</span>&nbsp;<span class="builtintype" id="3426551">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3426558">//&nbsp;e.g.&nbsp;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3426569">ProtoMinor</span>&nbsp;<span class="builtintype" id="3426580">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3426587">//&nbsp;e.g.&nbsp;0</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3426599">//&nbsp;Header&nbsp;maps&nbsp;header&nbsp;keys&nbsp;to&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;response&nbsp;had&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3426668">//&nbsp;headers&nbsp;with&nbsp;the&nbsp;same&nbsp;key,&nbsp;they&nbsp;may&nbsp;be&nbsp;concatenated,&nbsp;with&nbsp;comma</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3426736">//&nbsp;delimiters.&nbsp;&nbsp;(Section&nbsp;4.2&nbsp;of&nbsp;RFC&nbsp;2616&nbsp;requires&nbsp;that&nbsp;multiple&nbsp;headers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3426809">//&nbsp;be&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;a&nbsp;comma-delimited&nbsp;sequence.)&nbsp;Values</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3426879">//&nbsp;duplicated&nbsp;by&nbsp;other&nbsp;fields&nbsp;in&nbsp;this&nbsp;struct&nbsp;(e.g.,&nbsp;ContentLength)&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3426951">//&nbsp;omitted&nbsp;from&nbsp;Header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3426976">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3426980">//&nbsp;Keys&nbsp;in&nbsp;the&nbsp;map&nbsp;are&nbsp;canonicalized&nbsp;(see&nbsp;CanonicalHeaderKey).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3427044">Header</span>&nbsp;<span class="ident" id="3427051">Header</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427060">//&nbsp;Body&nbsp;represents&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427099">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427103">//&nbsp;The&nbsp;http&nbsp;Client&nbsp;and&nbsp;Transport&nbsp;guarantee&nbsp;that&nbsp;Body&nbsp;is&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427167">//&nbsp;non-nil,&nbsp;even&nbsp;on&nbsp;responses&nbsp;without&nbsp;a&nbsp;body&nbsp;or&nbsp;responses&nbsp;with</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427231">//&nbsp;a&nbsp;zero-length&nbsp;body.&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427292">//&nbsp;close&nbsp;Body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427308">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427312">//&nbsp;The&nbsp;Body&nbsp;is&nbsp;automatically&nbsp;dechunked&nbsp;if&nbsp;the&nbsp;server&nbsp;replied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427374">//&nbsp;with&nbsp;a&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3427414">Body</span>&nbsp;<span class="ident" id="3427419">io</span><span class="op" id="3427421">.</span><span class="ident" id="3427422">ReadCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427435">//&nbsp;ContentLength&nbsp;records&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;associated&nbsp;content.&nbsp;&nbsp;The</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427504">//&nbsp;value&nbsp;-1&nbsp;indicates&nbsp;that&nbsp;the&nbsp;length&nbsp;is&nbsp;unknown.&nbsp;&nbsp;Unless&nbsp;Request.Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427578">//&nbsp;is&nbsp;&#34;HEAD&#34;,&nbsp;values&nbsp;&gt;=&nbsp;0&nbsp;indicate&nbsp;that&nbsp;the&nbsp;given&nbsp;number&nbsp;of&nbsp;bytes&nbsp;may</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427649">//&nbsp;be&nbsp;read&nbsp;from&nbsp;Body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3427672">ContentLength</span>&nbsp;<span class="ident" id="3427686">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427694">//&nbsp;Contains&nbsp;transfer&nbsp;encodings&nbsp;from&nbsp;outer-most&nbsp;to&nbsp;inner-most.&nbsp;Value&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427766">//&nbsp;nil,&nbsp;means&nbsp;that&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3427815">TransferEncoding</span>&nbsp;<span class="op" id="3427832">[</span><span class="op" id="3427833">]</span><span class="builtintype" id="3427834">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427843">//&nbsp;Close&nbsp;records&nbsp;whether&nbsp;the&nbsp;header&nbsp;directed&nbsp;that&nbsp;the&nbsp;connection&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427912">//&nbsp;closed&nbsp;after&nbsp;reading&nbsp;Body.&nbsp;&nbsp;The&nbsp;value&nbsp;is&nbsp;advice&nbsp;for&nbsp;clients:&nbsp;neither</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3427985">//&nbsp;ReadResponse&nbsp;nor&nbsp;Response.Write&nbsp;ever&nbsp;closes&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428047">Close</span>&nbsp;<span class="builtintype" id="3428053">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3428060">//&nbsp;Trailer&nbsp;maps&nbsp;trailer&nbsp;keys&nbsp;to&nbsp;values,&nbsp;in&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3428113">//&nbsp;format&nbsp;as&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428139">Trailer</span>&nbsp;<span class="ident" id="3428147">Header</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3428156">//&nbsp;The&nbsp;Request&nbsp;that&nbsp;was&nbsp;sent&nbsp;to&nbsp;obtain&nbsp;this&nbsp;Response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3428211">//&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;nil&nbsp;(having&nbsp;already&nbsp;been&nbsp;consumed).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3428269">//&nbsp;This&nbsp;is&nbsp;only&nbsp;populated&nbsp;for&nbsp;Client&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428317">Request</span>&nbsp;<span class="op" id="3428325">*</span><span class="ident" id="3428326">Request</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3428336">//&nbsp;TLS&nbsp;contains&nbsp;information&nbsp;about&nbsp;the&nbsp;TLS&nbsp;connection&nbsp;on&nbsp;which&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3428403">//&nbsp;response&nbsp;was&nbsp;received.&nbsp;It&nbsp;is&nbsp;nil&nbsp;for&nbsp;unencrypted&nbsp;responses.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3428467">//&nbsp;The&nbsp;pointer&nbsp;is&nbsp;shared&nbsp;between&nbsp;responses&nbsp;and&nbsp;should&nbsp;not&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3428529">//&nbsp;modified.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3428543">TLS</span>&nbsp;<span class="op" id="3428547">*</span><span class="ident" id="3428548">tls</span><span class="op" id="3428551">.</span><span class="ident" id="3428552">ConnectionState</span><br>
<span class="lineno"></span><span class="op" id="3428568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3428571">//&nbsp;Cookies&nbsp;parses&nbsp;and&nbsp;returns&nbsp;the&nbsp;cookies&nbsp;set&nbsp;in&nbsp;the&nbsp;Set-Cookie&nbsp;headers.</span><br>
<span class="lineno"></span><span class="keyword" id="3428644">func</span>&nbsp;<span class="op" id="3428649">(</span><span class="ident" id="3428650">r</span>&nbsp;<span class="op" id="3428652">*</span><span class="ident" id="3428653">Response</span><span class="op" id="3428661">)</span>&nbsp;<span class="ident" id="3428663">Cookies</span><span class="op" id="3428670">(</span><span class="op" id="3428671">)</span>&nbsp;<span class="op" id="3428673">[</span><span class="op" id="3428674">]</span><span class="op" id="3428675">*</span><span class="ident" id="3428676">Cookie</span>&nbsp;<span class="op" id="3428683">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3428686">return</span>&nbsp;<span class="ident" id="3428693">readSetCookies</span><span class="op" id="3428707">(</span><span class="ident" id="3428708">r</span><span class="op" id="3428709">.</span><span class="ident" id="3428710">Header</span><span class="op" id="3428716">)</span><br>
<span class="lineno"></span><span class="op" id="3428718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3428721">var</span>&nbsp;<span class="ident" id="3428725">ErrNoLocation</span>&nbsp;<span class="op" id="3428739">=</span>&nbsp;<span class="ident" id="3428741">errors</span><span class="op" id="3428747">.</span><span class="ident" id="3428748">New</span><span class="op" id="3428751">(</span><span class="string" id="3428752">&#34;http:&nbsp;no&nbsp;Location&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="3428790">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3428793">//&nbsp;Location&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;response&#39;s&nbsp;&#34;Location&#34;&nbsp;header,</span><br>
<span class="lineno"></span><span class="comment" id="3428858">//&nbsp;if&nbsp;present.&nbsp;&nbsp;Relative&nbsp;redirects&nbsp;are&nbsp;resolved&nbsp;relative&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3428918">//&nbsp;the&nbsp;Response&#39;s&nbsp;Request.&nbsp;&nbsp;ErrNoLocation&nbsp;is&nbsp;returned&nbsp;if&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="3428978">//&nbsp;Location&nbsp;header&nbsp;is&nbsp;present.</span><br>
<span class="lineno"></span><span class="keyword" id="3429009">func</span>&nbsp;<span class="op" id="3429014">(</span><span class="ident" id="3429015">r</span>&nbsp;<span class="op" id="3429017">*</span><span class="ident" id="3429018">Response</span><span class="op" id="3429026">)</span>&nbsp;<span class="ident" id="3429028">Location</span><span class="op" id="3429036">(</span><span class="op" id="3429037">)</span>&nbsp;<span class="op" id="3429039">(</span><span class="op" id="3429040">*</span><span class="ident" id="3429041">url</span><span class="op" id="3429044">.</span><span class="ident" id="3429045">URL</span><span class="op" id="3429048">,</span>&nbsp;<span class="builtintype" id="3429050">error</span><span class="op" id="3429055">)</span>&nbsp;<span class="op" id="3429057">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429060">lv</span>&nbsp;<span class="op" id="3429063">:=</span>&nbsp;<span class="ident" id="3429066">r</span><span class="op" id="3429067">.</span><span class="ident" id="3429068">Header</span><span class="op" id="3429074">.</span><span class="ident" id="3429075">Get</span><span class="op" id="3429078">(</span><span class="string" id="3429079">&#34;Location&#34;</span><span class="op" id="3429089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429092">if</span>&nbsp;<span class="ident" id="3429095">lv</span>&nbsp;<span class="op" id="3429098">==</span>&nbsp;<span class="string" id="3429101">&#34;&#34;</span>&nbsp;<span class="op" id="3429104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429108">return</span>&nbsp;<span class="ident" id="3429115">nil</span><span class="op" id="3429118">,</span>&nbsp;<span class="ident" id="3429120">ErrNoLocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429138">if</span>&nbsp;<span class="ident" id="3429141">r</span><span class="op" id="3429142">.</span><span class="ident" id="3429143">Request</span>&nbsp;<span class="op" id="3429151">!=</span>&nbsp;<span class="ident" id="3429154">nil</span>&nbsp;<span class="op" id="3429158">&amp;&amp;</span>&nbsp;<span class="ident" id="3429161">r</span><span class="op" id="3429162">.</span><span class="ident" id="3429163">Request</span><span class="op" id="3429170">.</span><span class="ident" id="3429171">URL</span>&nbsp;<span class="op" id="3429175">!=</span>&nbsp;<span class="ident" id="3429178">nil</span>&nbsp;<span class="op" id="3429182">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429186">return</span>&nbsp;<span class="ident" id="3429193">r</span><span class="op" id="3429194">.</span><span class="ident" id="3429195">Request</span><span class="op" id="3429202">.</span><span class="ident" id="3429203">URL</span><span class="op" id="3429206">.</span><span class="ident" id="3429207">Parse</span><span class="op" id="3429212">(</span><span class="ident" id="3429213">lv</span><span class="op" id="3429215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429221">return</span>&nbsp;<span class="ident" id="3429228">url</span><span class="op" id="3429231">.</span><span class="ident" id="3429232">Parse</span><span class="op" id="3429237">(</span><span class="ident" id="3429238">lv</span><span class="op" id="3429240">)</span><br>
<span class="lineno"></span><span class="op" id="3429242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="3429245">//&nbsp;ReadResponse&nbsp;reads&nbsp;and&nbsp;returns&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="3429304">//&nbsp;The&nbsp;req&nbsp;parameter&nbsp;optionally&nbsp;specifies&nbsp;the&nbsp;Request&nbsp;that&nbsp;corresponds</span><br>
<span class="lineno"></span><span class="comment" id="3429375">//&nbsp;to&nbsp;this&nbsp;Response.&nbsp;If&nbsp;nil,&nbsp;a&nbsp;GET&nbsp;request&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="3429430">//&nbsp;Clients&nbsp;must&nbsp;call&nbsp;resp.Body.Close&nbsp;when&nbsp;finished&nbsp;reading&nbsp;resp.Body.</span><br>
<span class="lineno"></span><span class="comment" id="3429500">//&nbsp;After&nbsp;that&nbsp;call,&nbsp;clients&nbsp;can&nbsp;inspect&nbsp;resp.Trailer&nbsp;to&nbsp;find&nbsp;key/value</span><br>
<span class="lineno">115</span><span class="comment" id="3429571">//&nbsp;pairs&nbsp;included&nbsp;in&nbsp;the&nbsp;response&nbsp;trailer.</span><br>
<span class="lineno"></span><span class="keyword" id="3429614">func</span>&nbsp;<span class="ident" id="3429619">ReadResponse</span><span class="op" id="3429631">(</span><span class="ident" id="3429632">r</span>&nbsp;<span class="op" id="3429634">*</span><span class="ident" id="3429635">bufio</span><span class="op" id="3429640">.</span><span class="ident" id="3429641">Reader</span><span class="op" id="3429647">,</span>&nbsp;<span class="ident" id="3429649">req</span>&nbsp;<span class="op" id="3429653">*</span><span class="ident" id="3429654">Request</span><span class="op" id="3429661">)</span>&nbsp;<span class="op" id="3429663">(</span><span class="op" id="3429664">*</span><span class="ident" id="3429665">Response</span><span class="op" id="3429673">,</span>&nbsp;<span class="builtintype" id="3429675">error</span><span class="op" id="3429680">)</span>&nbsp;<span class="op" id="3429682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429685">tp</span>&nbsp;<span class="op" id="3429688">:=</span>&nbsp;<span class="ident" id="3429691">textproto</span><span class="op" id="3429700">.</span><span class="ident" id="3429701">NewReader</span><span class="op" id="3429710">(</span><span class="ident" id="3429711">r</span><span class="op" id="3429712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429715">resp</span>&nbsp;<span class="op" id="3429720">:=</span>&nbsp;<span class="op" id="3429723">&amp;</span><span class="ident" id="3429724">Response</span><span class="op" id="3429732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429736">Request</span><span class="op" id="3429743">:</span>&nbsp;<span class="ident" id="3429745">req</span><span class="op" id="3429748">,</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3429755">//&nbsp;Parse&nbsp;the&nbsp;first&nbsp;line&nbsp;of&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429797">line</span><span class="op" id="3429801">,</span>&nbsp;<span class="ident" id="3429803">err</span>&nbsp;<span class="op" id="3429807">:=</span>&nbsp;<span class="ident" id="3429810">tp</span><span class="op" id="3429812">.</span><span class="ident" id="3429813">ReadLine</span><span class="op" id="3429821">(</span><span class="op" id="3429822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429825">if</span>&nbsp;<span class="ident" id="3429828">err</span>&nbsp;<span class="op" id="3429832">!=</span>&nbsp;<span class="ident" id="3429835">nil</span>&nbsp;<span class="op" id="3429839">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429843">if</span>&nbsp;<span class="ident" id="3429846">err</span>&nbsp;<span class="op" id="3429850">==</span>&nbsp;<span class="ident" id="3429853">io</span><span class="op" id="3429855">.</span><span class="ident" id="3429856">EOF</span>&nbsp;<span class="op" id="3429860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429865">err</span>&nbsp;<span class="op" id="3429869">=</span>&nbsp;<span class="ident" id="3429871">io</span><span class="op" id="3429873">.</span><span class="ident" id="3429874">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429897">return</span>&nbsp;<span class="ident" id="3429904">nil</span><span class="op" id="3429907">,</span>&nbsp;<span class="ident" id="3429909">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3429914">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3429917">f</span>&nbsp;<span class="op" id="3429919">:=</span>&nbsp;<span class="ident" id="3429922">strings</span><span class="op" id="3429929">.</span><span class="ident" id="3429930">SplitN</span><span class="op" id="3429936">(</span><span class="ident" id="3429937">line</span><span class="op" id="3429941">,</span>&nbsp;<span class="string" id="3429943">&#34;&nbsp;&#34;</span><span class="op" id="3429946">,</span>&nbsp;<span class="num" id="3429948">3</span><span class="op" id="3429949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429952">if</span>&nbsp;<span class="builtinfunc" id="3429955">len</span><span class="op" id="3429958">(</span><span class="ident" id="3429959">f</span><span class="op" id="3429960">)</span>&nbsp;<span class="op" id="3429962">&lt;</span>&nbsp;<span class="num" id="3429964">2</span>&nbsp;<span class="op" id="3429966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3429970">return</span>&nbsp;<span class="ident" id="3429977">nil</span><span class="op" id="3429980">,</span>&nbsp;<span class="op" id="3429982">&amp;</span><span class="ident" id="3429983">badStringError</span><span class="op" id="3429997">{</span><span class="string" id="3429998">&#34;malformed&nbsp;HTTP&nbsp;response&#34;</span><span class="op" id="3430023">,</span>&nbsp;<span class="ident" id="3430025">line</span><span class="op" id="3430029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430035">reasonPhrase</span>&nbsp;<span class="op" id="3430048">:=</span>&nbsp;<span class="string" id="3430051">&#34;&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430055">if</span>&nbsp;<span class="builtinfunc" id="3430058">len</span><span class="op" id="3430061">(</span><span class="ident" id="3430062">f</span><span class="op" id="3430063">)</span>&nbsp;<span class="op" id="3430065">&gt;</span>&nbsp;<span class="num" id="3430067">2</span>&nbsp;<span class="op" id="3430069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430073">reasonPhrase</span>&nbsp;<span class="op" id="3430086">=</span>&nbsp;<span class="ident" id="3430088">f</span><span class="op" id="3430089">[</span><span class="num" id="3430090">2</span><span class="op" id="3430091">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430097">resp</span><span class="op" id="3430101">.</span><span class="ident" id="3430102">Status</span>&nbsp;<span class="op" id="3430109">=</span>&nbsp;<span class="ident" id="3430111">f</span><span class="op" id="3430112">[</span><span class="num" id="3430113">1</span><span class="op" id="3430114">]</span>&nbsp;<span class="op" id="3430116">+</span>&nbsp;<span class="string" id="3430118">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3430122">+</span>&nbsp;<span class="ident" id="3430124">reasonPhrase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430138">resp</span><span class="op" id="3430142">.</span><span class="ident" id="3430143">StatusCode</span><span class="op" id="3430153">,</span>&nbsp;<span class="ident" id="3430155">err</span>&nbsp;<span class="op" id="3430159">=</span>&nbsp;<span class="ident" id="3430161">strconv</span><span class="op" id="3430168">.</span><span class="ident" id="3430169">Atoi</span><span class="op" id="3430173">(</span><span class="ident" id="3430174">f</span><span class="op" id="3430175">[</span><span class="num" id="3430176">1</span><span class="op" id="3430177">]</span><span class="op" id="3430178">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430181">if</span>&nbsp;<span class="ident" id="3430184">err</span>&nbsp;<span class="op" id="3430188">!=</span>&nbsp;<span class="ident" id="3430191">nil</span>&nbsp;<span class="op" id="3430195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430199">return</span>&nbsp;<span class="ident" id="3430206">nil</span><span class="op" id="3430209">,</span>&nbsp;<span class="op" id="3430211">&amp;</span><span class="ident" id="3430212">badStringError</span><span class="op" id="3430226">{</span><span class="string" id="3430227">&#34;malformed&nbsp;HTTP&nbsp;status&nbsp;code&#34;</span><span class="op" id="3430255">,</span>&nbsp;<span class="ident" id="3430257">f</span><span class="op" id="3430258">[</span><span class="num" id="3430259">1</span><span class="op" id="3430260">]</span><span class="op" id="3430261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430268">resp</span><span class="op" id="3430272">.</span><span class="ident" id="3430273">Proto</span>&nbsp;<span class="op" id="3430279">=</span>&nbsp;<span class="ident" id="3430281">f</span><span class="op" id="3430282">[</span><span class="num" id="3430283">0</span><span class="op" id="3430284">]</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430287">var</span>&nbsp;<span class="ident" id="3430291">ok</span>&nbsp;<span class="builtintype" id="3430294">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430300">if</span>&nbsp;<span class="ident" id="3430303">resp</span><span class="op" id="3430307">.</span><span class="ident" id="3430308">ProtoMajor</span><span class="op" id="3430318">,</span>&nbsp;<span class="ident" id="3430320">resp</span><span class="op" id="3430324">.</span><span class="ident" id="3430325">ProtoMinor</span><span class="op" id="3430335">,</span>&nbsp;<span class="ident" id="3430337">ok</span>&nbsp;<span class="op" id="3430340">=</span>&nbsp;<span class="ident" id="3430342">ParseHTTPVersion</span><span class="op" id="3430358">(</span><span class="ident" id="3430359">resp</span><span class="op" id="3430363">.</span><span class="ident" id="3430364">Proto</span><span class="op" id="3430369">)</span><span class="op" id="3430370">;</span>&nbsp;<span class="op" id="3430372">!</span><span class="ident" id="3430373">ok</span>&nbsp;<span class="op" id="3430376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430380">return</span>&nbsp;<span class="ident" id="3430387">nil</span><span class="op" id="3430390">,</span>&nbsp;<span class="op" id="3430392">&amp;</span><span class="ident" id="3430393">badStringError</span><span class="op" id="3430407">{</span><span class="string" id="3430408">&#34;malformed&nbsp;HTTP&nbsp;version&#34;</span><span class="op" id="3430432">,</span>&nbsp;<span class="ident" id="3430434">resp</span><span class="op" id="3430438">.</span><span class="ident" id="3430439">Proto</span><span class="op" id="3430444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3430451">//&nbsp;Parse&nbsp;the&nbsp;response&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430483">mimeHeader</span><span class="op" id="3430493">,</span>&nbsp;<span class="ident" id="3430495">err</span>&nbsp;<span class="op" id="3430499">:=</span>&nbsp;<span class="ident" id="3430502">tp</span><span class="op" id="3430504">.</span><span class="ident" id="3430505">ReadMIMEHeader</span><span class="op" id="3430519">(</span><span class="op" id="3430520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430523">if</span>&nbsp;<span class="ident" id="3430526">err</span>&nbsp;<span class="op" id="3430530">!=</span>&nbsp;<span class="ident" id="3430533">nil</span>&nbsp;<span class="op" id="3430537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430541">if</span>&nbsp;<span class="ident" id="3430544">err</span>&nbsp;<span class="op" id="3430548">==</span>&nbsp;<span class="ident" id="3430551">io</span><span class="op" id="3430553">.</span><span class="ident" id="3430554">EOF</span>&nbsp;<span class="op" id="3430558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430563">err</span>&nbsp;<span class="op" id="3430567">=</span>&nbsp;<span class="ident" id="3430569">io</span><span class="op" id="3430571">.</span><span class="ident" id="3430572">ErrUnexpectedEOF</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430595">return</span>&nbsp;<span class="ident" id="3430602">nil</span><span class="op" id="3430605">,</span>&nbsp;<span class="ident" id="3430607">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430615">resp</span><span class="op" id="3430619">.</span><span class="ident" id="3430620">Header</span>&nbsp;<span class="op" id="3430627">=</span>&nbsp;<span class="ident" id="3430629">Header</span><span class="op" id="3430635">(</span><span class="ident" id="3430636">mimeHeader</span><span class="op" id="3430646">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430650">fixPragmaCacheControl</span><span class="op" id="3430671">(</span><span class="ident" id="3430672">resp</span><span class="op" id="3430676">.</span><span class="ident" id="3430677">Header</span><span class="op" id="3430683">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3430687">err</span>&nbsp;<span class="op" id="3430691">=</span>&nbsp;<span class="ident" id="3430693">readTransfer</span><span class="op" id="3430705">(</span><span class="ident" id="3430706">resp</span><span class="op" id="3430710">,</span>&nbsp;<span class="ident" id="3430712">r</span><span class="op" id="3430713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430716">if</span>&nbsp;<span class="ident" id="3430719">err</span>&nbsp;<span class="op" id="3430723">!=</span>&nbsp;<span class="ident" id="3430726">nil</span>&nbsp;<span class="op" id="3430730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430734">return</span>&nbsp;<span class="ident" id="3430741">nil</span><span class="op" id="3430744">,</span>&nbsp;<span class="ident" id="3430746">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3430751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430755">return</span>&nbsp;<span class="ident" id="3430762">resp</span><span class="op" id="3430766">,</span>&nbsp;<span class="ident" id="3430768">nil</span><br>
<span class="lineno"></span><span class="op" id="3430772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="3430775">//&nbsp;RFC2616:&nbsp;Should&nbsp;treat</span><br>
<span class="lineno"></span><span class="comment" id="3430800">//&nbsp;&nbsp;&nbsp;&nbspPragma:&nbsp;no-cache</span><br>
<span class="lineno"></span><span class="comment" id="3430820">//&nbsp;like</span><br>
<span class="lineno"></span><span class="comment" id="3430828">//&nbsp;&nbsp;&nbsp;&nbspCache-Control:&nbsp;no-cache</span><br>
<span class="lineno"></span><span class="keyword" id="3430855">func</span>&nbsp;<span class="ident" id="3430860">fixPragmaCacheControl</span><span class="op" id="3430881">(</span><span class="ident" id="3430882">header</span>&nbsp;<span class="ident" id="3430889">Header</span><span class="op" id="3430895">)</span>&nbsp;<span class="op" id="3430897">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430900">if</span>&nbsp;<span class="ident" id="3430903">hp</span><span class="op" id="3430905">,</span>&nbsp;<span class="ident" id="3430907">ok</span>&nbsp;<span class="op" id="3430910">:=</span>&nbsp;<span class="ident" id="3430913">header</span><span class="op" id="3430919">[</span><span class="string" id="3430920">&#34;Pragma&#34;</span><span class="op" id="3430928">]</span><span class="op" id="3430929">;</span>&nbsp;<span class="ident" id="3430931">ok</span>&nbsp;<span class="op" id="3430934">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3430937">len</span><span class="op" id="3430940">(</span><span class="ident" id="3430941">hp</span><span class="op" id="3430943">)</span>&nbsp;<span class="op" id="3430945">&gt;</span>&nbsp;<span class="num" id="3430947">0</span>&nbsp;<span class="op" id="3430949">&amp;&amp;</span>&nbsp;<span class="ident" id="3430952">hp</span><span class="op" id="3430954">[</span><span class="num" id="3430955">0</span><span class="op" id="3430956">]</span>&nbsp;<span class="op" id="3430958">==</span>&nbsp;<span class="string" id="3430961">&#34;no-cache&#34;</span>&nbsp;<span class="op" id="3430972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3430976">if</span>&nbsp;<span class="ident" id="3430979">_</span><span class="op" id="3430980">,</span>&nbsp;<span class="ident" id="3430982">presentcc</span>&nbsp;<span class="op" id="3430992">:=</span>&nbsp;<span class="ident" id="3430995">header</span><span class="op" id="3431001">[</span><span class="string" id="3431002">&#34;Cache-Control&#34;</span><span class="op" id="3431017">]</span><span class="op" id="3431018">;</span>&nbsp;<span class="op" id="3431020">!</span><span class="ident" id="3431021">presentcc</span>&nbsp;<span class="op" id="3431031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431036">header</span><span class="op" id="3431042">[</span><span class="string" id="3431043">&#34;Cache-Control&#34;</span><span class="op" id="3431058">]</span>&nbsp;<span class="op" id="3431060">=</span>&nbsp;<span class="op" id="3431062">[</span><span class="op" id="3431063">]</span><span class="builtintype" id="3431064">string</span><span class="op" id="3431070">{</span><span class="string" id="3431071">&#34;no-cache&#34;</span><span class="op" id="3431081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431088">}</span><br>
<span class="lineno">180</span><span class="op" id="3431090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3431093">//&nbsp;ProtoAtLeast&nbsp;reports&nbsp;whether&nbsp;the&nbsp;HTTP&nbsp;protocol&nbsp;used</span><br>
<span class="lineno"></span><span class="comment" id="3431148">//&nbsp;in&nbsp;the&nbsp;response&nbsp;is&nbsp;at&nbsp;least&nbsp;major.minor.</span><br>
<span class="lineno"></span><span class="keyword" id="3431192">func</span>&nbsp;<span class="op" id="3431197">(</span><span class="ident" id="3431198">r</span>&nbsp;<span class="op" id="3431200">*</span><span class="ident" id="3431201">Response</span><span class="op" id="3431209">)</span>&nbsp;<span class="ident" id="3431211">ProtoAtLeast</span><span class="op" id="3431223">(</span><span class="ident" id="3431224">major</span><span class="op" id="3431229">,</span>&nbsp;<span class="ident" id="3431231">minor</span>&nbsp;<span class="builtintype" id="3431237">int</span><span class="op" id="3431240">)</span>&nbsp;<span class="builtintype" id="3431242">bool</span>&nbsp;<span class="op" id="3431247">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431250">return</span>&nbsp;<span class="ident" id="3431257">r</span><span class="op" id="3431258">.</span><span class="ident" id="3431259">ProtoMajor</span>&nbsp;<span class="op" id="3431270">&gt;</span>&nbsp;<span class="ident" id="3431272">major</span>&nbsp;<span class="op" id="3431278">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431283">r</span><span class="op" id="3431284">.</span><span class="ident" id="3431285">ProtoMajor</span>&nbsp;<span class="op" id="3431296">==</span>&nbsp;<span class="ident" id="3431299">major</span>&nbsp;<span class="op" id="3431305">&amp;&amp;</span>&nbsp;<span class="ident" id="3431308">r</span><span class="op" id="3431309">.</span><span class="ident" id="3431310">ProtoMinor</span>&nbsp;<span class="op" id="3431321">&gt;=</span>&nbsp;<span class="ident" id="3431324">minor</span><br>
<span class="lineno"></span><span class="op" id="3431330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3431333">//&nbsp;Writes&nbsp;the&nbsp;response&nbsp;(header,&nbsp;body&nbsp;and&nbsp;trailer)&nbsp;in&nbsp;wire&nbsp;format.&nbsp;This&nbsp;method</span><br>
<span class="lineno">190</span><span class="comment" id="3431411">//&nbsp;consults&nbsp;the&nbsp;following&nbsp;fields&nbsp;of&nbsp;the&nbsp;response:</span><br>
<span class="lineno"></span><span class="comment" id="3431461">//</span><br>
<span class="lineno"></span><span class="comment" id="3431464">//&nbsp;&nbsp;StatusCode</span><br>
<span class="lineno"></span><span class="comment" id="3431479">//&nbsp;&nbsp;ProtoMajor</span><br>
<span class="lineno"></span><span class="comment" id="3431494">//&nbsp;&nbsp;ProtoMinor</span><br>
<span class="lineno">195</span><span class="comment" id="3431509">//&nbsp;&nbsp;Request.Method</span><br>
<span class="lineno"></span><span class="comment" id="3431528">//&nbsp;&nbsp;TransferEncoding</span><br>
<span class="lineno"></span><span class="comment" id="3431549">//&nbsp;&nbsp;Trailer</span><br>
<span class="lineno"></span><span class="comment" id="3431561">//&nbsp;&nbsp;Body</span><br>
<span class="lineno"></span><span class="comment" id="3431570">//&nbsp;&nbsp;ContentLength</span><br>
<span class="lineno">200</span><span class="comment" id="3431588">//&nbsp;&nbsp;Header,&nbsp;values&nbsp;for&nbsp;non-canonical&nbsp;keys&nbsp;will&nbsp;have&nbsp;unpredictable&nbsp;behavior</span><br>
<span class="lineno"></span><span class="comment" id="3431663">//</span><br>
<span class="lineno"></span><span class="comment" id="3431666">//&nbsp;Body&nbsp;is&nbsp;closed&nbsp;after&nbsp;it&nbsp;is&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="3431702">func</span>&nbsp;<span class="op" id="3431707">(</span><span class="ident" id="3431708">r</span>&nbsp;<span class="op" id="3431710">*</span><span class="ident" id="3431711">Response</span><span class="op" id="3431719">)</span>&nbsp;<span class="ident" id="3431721">Write</span><span class="op" id="3431726">(</span><span class="ident" id="3431727">w</span>&nbsp;<span class="ident" id="3431729">io</span><span class="op" id="3431731">.</span><span class="ident" id="3431732">Writer</span><span class="op" id="3431738">)</span>&nbsp;<span class="builtintype" id="3431740">error</span>&nbsp;<span class="op" id="3431746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3431749">//&nbsp;Status&nbsp;line</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431765">text</span>&nbsp;<span class="op" id="3431770">:=</span>&nbsp;<span class="ident" id="3431773">r</span><span class="op" id="3431774">.</span><span class="ident" id="3431775">Status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431783">if</span>&nbsp;<span class="ident" id="3431786">text</span>&nbsp;<span class="op" id="3431791">==</span>&nbsp;<span class="string" id="3431794">&#34;&#34;</span>&nbsp;<span class="op" id="3431797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431801">var</span>&nbsp;<span class="ident" id="3431805">ok</span>&nbsp;<span class="builtintype" id="3431808">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431815">text</span><span class="op" id="3431819">,</span>&nbsp;<span class="ident" id="3431821">ok</span>&nbsp;<span class="op" id="3431824">=</span>&nbsp;<span class="ident" id="3431826">statusText</span><span class="op" id="3431836">[</span><span class="ident" id="3431837">r</span><span class="op" id="3431838">.</span><span class="ident" id="3431839">StatusCode</span><span class="op" id="3431849">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3431853">if</span>&nbsp;<span class="op" id="3431856">!</span><span class="ident" id="3431857">ok</span>&nbsp;<span class="op" id="3431860">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431865">text</span>&nbsp;<span class="op" id="3431870">=</span>&nbsp;<span class="string" id="3431872">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="3431887">+</span>&nbsp;<span class="ident" id="3431889">strconv</span><span class="op" id="3431896">.</span><span class="ident" id="3431897">Itoa</span><span class="op" id="3431901">(</span><span class="ident" id="3431902">r</span><span class="op" id="3431903">.</span><span class="ident" id="3431904">StatusCode</span><span class="op" id="3431914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3431921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3431924">protoMajor</span><span class="op" id="3431934">,</span>&nbsp;<span class="ident" id="3431936">protoMinor</span>&nbsp;<span class="op" id="3431947">:=</span>&nbsp;<span class="ident" id="3431950">strconv</span><span class="op" id="3431957">.</span><span class="ident" id="3431958">Itoa</span><span class="op" id="3431962">(</span><span class="ident" id="3431963">r</span><span class="op" id="3431964">.</span><span class="ident" id="3431965">ProtoMajor</span><span class="op" id="3431975">)</span><span class="op" id="3431976">,</span>&nbsp;<span class="ident" id="3431978">strconv</span><span class="op" id="3431985">.</span><span class="ident" id="3431986">Itoa</span><span class="op" id="3431990">(</span><span class="ident" id="3431991">r</span><span class="op" id="3431992">.</span><span class="ident" id="3431993">ProtoMinor</span><span class="op" id="3432003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432006">statusCode</span>&nbsp;<span class="op" id="3432017">:=</span>&nbsp;<span class="ident" id="3432020">strconv</span><span class="op" id="3432027">.</span><span class="ident" id="3432028">Itoa</span><span class="op" id="3432032">(</span><span class="ident" id="3432033">r</span><span class="op" id="3432034">.</span><span class="ident" id="3432035">StatusCode</span><span class="op" id="3432045">)</span>&nbsp;<span class="op" id="3432047">+</span>&nbsp;<span class="string" id="3432049">&#34;&nbsp;&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432054">text</span>&nbsp;<span class="op" id="3432059">=</span>&nbsp;<span class="ident" id="3432061">strings</span><span class="op" id="3432068">.</span><span class="ident" id="3432069">TrimPrefix</span><span class="op" id="3432079">(</span><span class="ident" id="3432080">text</span><span class="op" id="3432084">,</span>&nbsp;<span class="ident" id="3432086">statusCode</span><span class="op" id="3432096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432099">if</span>&nbsp;<span class="ident" id="3432102">_</span><span class="op" id="3432103">,</span>&nbsp;<span class="ident" id="3432105">err</span>&nbsp;<span class="op" id="3432109">:=</span>&nbsp;<span class="ident" id="3432112">io</span><span class="op" id="3432114">.</span><span class="ident" id="3432115">WriteString</span><span class="op" id="3432126">(</span><span class="ident" id="3432127">w</span><span class="op" id="3432128">,</span>&nbsp;<span class="string" id="3432130">&#34;HTTP/&#34;</span><span class="op" id="3432137">+</span><span class="ident" id="3432138">protoMajor</span><span class="op" id="3432148">+</span><span class="string" id="3432149">&#34;.&#34;</span><span class="op" id="3432152">+</span><span class="ident" id="3432153">protoMinor</span><span class="op" id="3432163">+</span><span class="string" id="3432164">&#34;&nbsp;&#34;</span><span class="op" id="3432167">+</span><span class="ident" id="3432168">statusCode</span><span class="op" id="3432178">+</span><span class="ident" id="3432179">text</span><span class="op" id="3432183">+</span><span class="string" id="3432184">&#34;\r\n&#34;</span><span class="op" id="3432190">)</span><span class="op" id="3432191">;</span>&nbsp;<span class="ident" id="3432193">err</span>&nbsp;<span class="op" id="3432197">!=</span>&nbsp;<span class="ident" id="3432200">nil</span>&nbsp;<span class="op" id="3432204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432208">return</span>&nbsp;<span class="ident" id="3432215">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3432224">//&nbsp;Clone&nbsp;it,&nbsp;so&nbsp;we&nbsp;can&nbsp;modify&nbsp;r1&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432269">r1</span>&nbsp;<span class="op" id="3432272">:=</span>&nbsp;<span class="builtinfunc" id="3432275">new</span><span class="op" id="3432278">(</span><span class="ident" id="3432279">Response</span><span class="op" id="3432287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432290">*</span><span class="ident" id="3432291">r1</span>&nbsp;<span class="op" id="3432294">=</span>&nbsp;<span class="op" id="3432296">*</span><span class="ident" id="3432297">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432300">if</span>&nbsp;<span class="ident" id="3432303">r1</span><span class="op" id="3432305">.</span><span class="ident" id="3432306">ContentLength</span>&nbsp;<span class="op" id="3432320">==</span>&nbsp;<span class="num" id="3432323">0</span>&nbsp;<span class="op" id="3432325">&amp;&amp;</span>&nbsp;<span class="ident" id="3432328">r1</span><span class="op" id="3432330">.</span><span class="ident" id="3432331">Body</span>&nbsp;<span class="op" id="3432336">!=</span>&nbsp;<span class="ident" id="3432339">nil</span>&nbsp;<span class="op" id="3432343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3432347">//&nbsp;Is&nbsp;it&nbsp;actually&nbsp;0&nbsp;length?&nbsp;Or&nbsp;just&nbsp;unknown?</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432394">var</span>&nbsp;<span class="ident" id="3432398">buf</span>&nbsp;<span class="op" id="3432402">[</span><span class="num" id="3432403">1</span><span class="op" id="3432404">]</span><span class="builtintype" id="3432405">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432412">n</span><span class="op" id="3432413">,</span>&nbsp;<span class="ident" id="3432415">err</span>&nbsp;<span class="op" id="3432419">:=</span>&nbsp;<span class="ident" id="3432422">r1</span><span class="op" id="3432424">.</span><span class="ident" id="3432425">Body</span><span class="op" id="3432429">.</span><span class="ident" id="3432430">Read</span><span class="op" id="3432434">(</span><span class="ident" id="3432435">buf</span><span class="op" id="3432438">[</span><span class="op" id="3432439">:</span><span class="op" id="3432440">]</span><span class="op" id="3432441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432445">if</span>&nbsp;<span class="ident" id="3432448">err</span>&nbsp;<span class="op" id="3432452">!=</span>&nbsp;<span class="ident" id="3432455">nil</span>&nbsp;<span class="op" id="3432459">&amp;&amp;</span>&nbsp;<span class="ident" id="3432462">err</span>&nbsp;<span class="op" id="3432466">!=</span>&nbsp;<span class="ident" id="3432469">io</span><span class="op" id="3432471">.</span><span class="ident" id="3432472">EOF</span>&nbsp;<span class="op" id="3432476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432481">return</span>&nbsp;<span class="ident" id="3432488">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432494">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3432498">if</span>&nbsp;<span class="ident" id="3432501">n</span>&nbsp;<span class="op" id="3432503">==</span>&nbsp;<span class="num" id="3432506">0</span>&nbsp;<span class="op" id="3432508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3432513">//&nbsp;Reset&nbsp;it&nbsp;to&nbsp;a&nbsp;known&nbsp;zero&nbsp;reader,&nbsp;in&nbsp;case&nbsp;underlying&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3432575">//&nbsp;is&nbsp;unhappy&nbsp;being&nbsp;read&nbsp;repeatedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432615">r1</span><span class="op" id="3432617">.</span><span class="ident" id="3432618">Body</span>&nbsp;<span class="op" id="3432623">=</span>&nbsp;<span class="ident" id="3432625">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432637">}</span>&nbsp;<span class="keyword" id="3432639">else</span>&nbsp;<span class="op" id="3432644">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432649">r1</span><span class="op" id="3432651">.</span><span class="ident" id="3432652">ContentLength</span>&nbsp;<span class="op" id="3432666">=</span>&nbsp;<span class="op" id="3432668">-</span><span class="num" id="3432669">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432674">r1</span><span class="op" id="3432676">.</span><span class="ident" id="3432677">Body</span>&nbsp;<span class="op" id="3432682">=</span>&nbsp;<span class="keyword" id="3432684">struct</span>&nbsp;<span class="op" id="3432691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432697">io</span><span class="op" id="3432699">.</span><span class="ident" id="3432700">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432711">io</span><span class="op" id="3432713">.</span><span class="ident" id="3432714">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432724">}</span><span class="op" id="3432725">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432731">io</span><span class="op" id="3432733">.</span><span class="ident" id="3432734">MultiReader</span><span class="op" id="3432745">(</span><span class="ident" id="3432746">bytes</span><span class="op" id="3432751">.</span><span class="ident" id="3432752">NewReader</span><span class="op" id="3432761">(</span><span class="ident" id="3432762">buf</span><span class="op" id="3432765">[</span><span class="op" id="3432766">:</span><span class="num" id="3432767">1</span><span class="op" id="3432768">]</span><span class="op" id="3432769">)</span><span class="op" id="3432770">,</span>&nbsp;<span class="ident" id="3432772">r</span><span class="op" id="3432773">.</span><span class="ident" id="3432774">Body</span><span class="op" id="3432778">)</span><span class="op" id="3432779">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3432785">r</span><span class="op" id="3432786">.</span><span class="ident" id="3432787">Body</span><span class="op" id="3432791">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3432803">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3432806">//&nbsp;If&nbsp;we&#39;re&nbsp;sending&nbsp;a&nbsp;non-chunked&nbsp;HTTP/1.1&nbsp;response&nbsp;without&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3432869">//&nbsp;content-length,&nbsp;the&nbsp;only&nbsp;way&nbsp;to&nbsp;do&nbsp;that&nbsp;is&nbsp;the&nbsp;old&nbsp;HTTP/1.0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3432933">//&nbsp;way,&nbsp;by&nbsp;noting&nbsp;the&nbsp;EOF&nbsp;with&nbsp;a&nbsp;connection&nbsp;close,&nbsp;so&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3432996">//&nbsp;to&nbsp;set&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433014">if</span>&nbsp;<span class="ident" id="3433017">r1</span><span class="op" id="3433019">.</span><span class="ident" id="3433020">ContentLength</span>&nbsp;<span class="op" id="3433034">==</span>&nbsp;<span class="op" id="3433037">-</span><span class="num" id="3433038">1</span>&nbsp;<span class="op" id="3433040">&amp;&amp;</span>&nbsp;<span class="op" id="3433043">!</span><span class="ident" id="3433044">r1</span><span class="op" id="3433046">.</span><span class="ident" id="3433047">Close</span>&nbsp;<span class="op" id="3433053">&amp;&amp;</span>&nbsp;<span class="ident" id="3433056">r1</span><span class="op" id="3433058">.</span><span class="ident" id="3433059">ProtoAtLeast</span><span class="op" id="3433071">(</span><span class="num" id="3433072">1</span><span class="op" id="3433073">,</span>&nbsp;<span class="num" id="3433075">1</span><span class="op" id="3433076">)</span>&nbsp;<span class="op" id="3433078">&amp;&amp;</span>&nbsp;<span class="op" id="3433081">!</span><span class="ident" id="3433082">chunked</span><span class="op" id="3433089">(</span><span class="ident" id="3433090">r1</span><span class="op" id="3433092">.</span><span class="ident" id="3433093">TransferEncoding</span><span class="op" id="3433109">)</span>&nbsp;<span class="op" id="3433111">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433115">r1</span><span class="op" id="3433117">.</span><span class="ident" id="3433118">Close</span>&nbsp;<span class="op" id="3433124">=</span>&nbsp;<span class="builtintype" id="3433126">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433136">//&nbsp;Process&nbsp;Body,ContentLength,Close,Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433181">tw</span><span class="op" id="3433183">,</span>&nbsp;<span class="ident" id="3433185">err</span>&nbsp;<span class="op" id="3433189">:=</span>&nbsp;<span class="ident" id="3433192">newTransferWriter</span><span class="op" id="3433209">(</span><span class="ident" id="3433210">r1</span><span class="op" id="3433212">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433215">if</span>&nbsp;<span class="ident" id="3433218">err</span>&nbsp;<span class="op" id="3433222">!=</span>&nbsp;<span class="ident" id="3433225">nil</span>&nbsp;<span class="op" id="3433229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433233">return</span>&nbsp;<span class="ident" id="3433240">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433248">err</span>&nbsp;<span class="op" id="3433252">=</span>&nbsp;<span class="ident" id="3433254">tw</span><span class="op" id="3433256">.</span><span class="ident" id="3433257">WriteHeader</span><span class="op" id="3433268">(</span><span class="ident" id="3433269">w</span><span class="op" id="3433270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433273">if</span>&nbsp;<span class="ident" id="3433276">err</span>&nbsp;<span class="op" id="3433280">!=</span>&nbsp;<span class="ident" id="3433283">nil</span>&nbsp;<span class="op" id="3433287">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433291">return</span>&nbsp;<span class="ident" id="3433298">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433307">//&nbsp;Rest&nbsp;of&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433326">err</span>&nbsp;<span class="op" id="3433330">=</span>&nbsp;<span class="ident" id="3433332">r</span><span class="op" id="3433333">.</span><span class="ident" id="3433334">Header</span><span class="op" id="3433340">.</span><span class="ident" id="3433341">WriteSubset</span><span class="op" id="3433352">(</span><span class="ident" id="3433353">w</span><span class="op" id="3433354">,</span>&nbsp;<span class="ident" id="3433356">respExcludeHeader</span><span class="op" id="3433373">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433376">if</span>&nbsp;<span class="ident" id="3433379">err</span>&nbsp;<span class="op" id="3433383">!=</span>&nbsp;<span class="ident" id="3433386">nil</span>&nbsp;<span class="op" id="3433390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433394">return</span>&nbsp;<span class="ident" id="3433401">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433410">//&nbsp;contentLengthAlreadySent&nbsp;may&nbsp;have&nbsp;been&nbsp;already&nbsp;sent&nbsp;for</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433470">//&nbsp;POST/PUT&nbsp;requests,&nbsp;even&nbsp;if&nbsp;zero&nbsp;length.&nbsp;See&nbsp;Issue&nbsp;8180.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433530">contentLengthAlreadySent</span>&nbsp;<span class="op" id="3433555">:=</span>&nbsp;<span class="ident" id="3433558">tw</span><span class="op" id="3433560">.</span><span class="ident" id="3433561">shouldSendContentLength</span><span class="op" id="3433584">(</span><span class="op" id="3433585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433588">if</span>&nbsp;<span class="ident" id="3433591">r1</span><span class="op" id="3433593">.</span><span class="ident" id="3433594">ContentLength</span>&nbsp;<span class="op" id="3433608">==</span>&nbsp;<span class="num" id="3433611">0</span>&nbsp;<span class="op" id="3433613">&amp;&amp;</span>&nbsp;<span class="op" id="3433616">!</span><span class="ident" id="3433617">chunked</span><span class="op" id="3433624">(</span><span class="ident" id="3433625">r1</span><span class="op" id="3433627">.</span><span class="ident" id="3433628">TransferEncoding</span><span class="op" id="3433644">)</span>&nbsp;<span class="op" id="3433646">&amp;&amp;</span>&nbsp;<span class="op" id="3433649">!</span><span class="ident" id="3433650">contentLengthAlreadySent</span>&nbsp;<span class="op" id="3433675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433679">if</span>&nbsp;<span class="ident" id="3433682">_</span><span class="op" id="3433683">,</span>&nbsp;<span class="ident" id="3433685">err</span>&nbsp;<span class="op" id="3433689">:=</span>&nbsp;<span class="ident" id="3433692">io</span><span class="op" id="3433694">.</span><span class="ident" id="3433695">WriteString</span><span class="op" id="3433706">(</span><span class="ident" id="3433707">w</span><span class="op" id="3433708">,</span>&nbsp;<span class="string" id="3433710">&#34;Content-Length:&nbsp;0\r\n&#34;</span><span class="op" id="3433733">)</span><span class="op" id="3433734">;</span>&nbsp;<span class="ident" id="3433736">err</span>&nbsp;<span class="op" id="3433740">!=</span>&nbsp;<span class="ident" id="3433743">nil</span>&nbsp;<span class="op" id="3433747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433752">return</span>&nbsp;<span class="ident" id="3433759">err</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433772">//&nbsp;End-of-header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433790">if</span>&nbsp;<span class="ident" id="3433793">_</span><span class="op" id="3433794">,</span>&nbsp;<span class="ident" id="3433796">err</span>&nbsp;<span class="op" id="3433800">:=</span>&nbsp;<span class="ident" id="3433803">io</span><span class="op" id="3433805">.</span><span class="ident" id="3433806">WriteString</span><span class="op" id="3433817">(</span><span class="ident" id="3433818">w</span><span class="op" id="3433819">,</span>&nbsp;<span class="string" id="3433821">&#34;\r\n&#34;</span><span class="op" id="3433827">)</span><span class="op" id="3433828">;</span>&nbsp;<span class="ident" id="3433830">err</span>&nbsp;<span class="op" id="3433834">!=</span>&nbsp;<span class="ident" id="3433837">nil</span>&nbsp;<span class="op" id="3433841">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433845">return</span>&nbsp;<span class="ident" id="3433852">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433861">//&nbsp;Write&nbsp;body&nbsp;and&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3433888">err</span>&nbsp;<span class="op" id="3433892">=</span>&nbsp;<span class="ident" id="3433894">tw</span><span class="op" id="3433896">.</span><span class="ident" id="3433897">WriteBody</span><span class="op" id="3433906">(</span><span class="ident" id="3433907">w</span><span class="op" id="3433908">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433911">if</span>&nbsp;<span class="ident" id="3433914">err</span>&nbsp;<span class="op" id="3433918">!=</span>&nbsp;<span class="ident" id="3433921">nil</span>&nbsp;<span class="op" id="3433925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433929">return</span>&nbsp;<span class="ident" id="3433936">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3433941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3433945">//&nbsp;Success</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3433957">return</span>&nbsp;<span class="ident" id="3433964">nil</span><br>
<span class="lineno"></span><span class="op" id="3433968">}</span>
</div>
</body>
</html>
