<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html" class="current">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5990480">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5990535">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5990589">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5990640">package</span>&nbsp;<span class="ident" id="5990648">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5990653">import</span>&nbsp;<span class="op" id="5990660">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5990663">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5990669">&#34;reflect&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5990680">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5990687">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5990690">//&nbsp;An&nbsp;Encoder&nbsp;manages&nbsp;the&nbsp;transmission&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5990765">//&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">15</span><span class="keyword" id="5990796">type</span>&nbsp;<span class="ident" id="5990801">Encoder</span>&nbsp;<span class="keyword" id="5990809">struct</span>&nbsp;<span class="op" id="5990816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990819">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5990830">sync</span><span class="op" id="5990834">.</span><span class="ident" id="5990835">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5990854">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;sent&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990892">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5990903">[</span><span class="op" id="5990904">]</span><span class="ident" id="5990905">io</span><span class="op" id="5990907">.</span><span class="ident" id="5990908">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5990927">//&nbsp;where&nbsp;to&nbsp;send&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990954">sent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5990965">map</span><span class="op" id="5990968">[</span><span class="ident" id="5990969">reflect</span><span class="op" id="5990976">.</span><span class="ident" id="5990977">Type</span><span class="op" id="5990981">]</span><span class="ident" id="5990982">typeId</span>&nbsp;<span class="comment" id="5990989">//&nbsp;which&nbsp;types&nbsp;we&#39;ve&nbsp;already&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991024">countState</span>&nbsp;<span class="op" id="5991035">*</span><span class="ident" id="5991036">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5991059">//&nbsp;stage&nbsp;for&nbsp;writing&nbsp;counts</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991088">freeList</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5991099">*</span><span class="ident" id="5991100">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5991123">//&nbsp;list&nbsp;of&nbsp;free&nbsp;encoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991175">byteBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5991186">encBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5991210">//&nbsp;buffer&nbsp;for&nbsp;top-level&nbsp;encoderState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991248">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5991259">error</span><br>
<span class="lineno"></span><span class="op" id="5991265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5991268">//&nbsp;Before&nbsp;we&nbsp;encode&nbsp;a&nbsp;message,&nbsp;we&nbsp;reserve&nbsp;space&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5991335">//&nbsp;buffer&nbsp;in&nbsp;which&nbsp;to&nbsp;encode&nbsp;its&nbsp;length.&nbsp;This&nbsp;means&nbsp;we&nbsp;can&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5991402">//&nbsp;buffer&nbsp;to&nbsp;assemble&nbsp;the&nbsp;message&nbsp;without&nbsp;another&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="5991464">const</span>&nbsp;<span class="ident" id="5991470">maxLength</span>&nbsp;<span class="op" id="5991480">=</span>&nbsp;<span class="num" id="5991482">9</span>&nbsp;<span class="comment" id="5991484">//&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;an&nbsp;encoded&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="5991522">var</span>&nbsp;<span class="ident" id="5991526">spaceForLength</span>&nbsp;<span class="op" id="5991541">=</span>&nbsp;<span class="builtinfunc" id="5991543">make</span><span class="op" id="5991547">(</span><span class="op" id="5991548">[</span><span class="op" id="5991549">]</span><span class="builtintype" id="5991550">byte</span><span class="op" id="5991554">,</span>&nbsp;<span class="ident" id="5991556">maxLength</span><span class="op" id="5991565">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="5991568">//&nbsp;NewEncoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;encoder&nbsp;that&nbsp;will&nbsp;transmit&nbsp;on&nbsp;the&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5991641">func</span>&nbsp;<span class="ident" id="5991646">NewEncoder</span><span class="op" id="5991656">(</span><span class="ident" id="5991657">w</span>&nbsp;<span class="ident" id="5991659">io</span><span class="op" id="5991661">.</span><span class="ident" id="5991662">Writer</span><span class="op" id="5991668">)</span>&nbsp;<span class="op" id="5991670">*</span><span class="ident" id="5991671">Encoder</span>&nbsp;<span class="op" id="5991679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991682">enc</span>&nbsp;<span class="op" id="5991686">:=</span>&nbsp;<span class="builtinfunc" id="5991689">new</span><span class="op" id="5991692">(</span><span class="ident" id="5991693">Encoder</span><span class="op" id="5991700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991703">enc</span><span class="op" id="5991706">.</span><span class="ident" id="5991707">w</span>&nbsp;<span class="op" id="5991709">=</span>&nbsp;<span class="op" id="5991711">[</span><span class="op" id="5991712">]</span><span class="ident" id="5991713">io</span><span class="op" id="5991715">.</span><span class="ident" id="5991716">Writer</span><span class="op" id="5991722">{</span><span class="ident" id="5991723">w</span><span class="op" id="5991724">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991727">enc</span><span class="op" id="5991730">.</span><span class="ident" id="5991731">sent</span>&nbsp;<span class="op" id="5991736">=</span>&nbsp;<span class="builtinfunc" id="5991738">make</span><span class="op" id="5991742">(</span><span class="keyword" id="5991743">map</span><span class="op" id="5991746">[</span><span class="ident" id="5991747">reflect</span><span class="op" id="5991754">.</span><span class="ident" id="5991755">Type</span><span class="op" id="5991759">]</span><span class="ident" id="5991760">typeId</span><span class="op" id="5991766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991769">enc</span><span class="op" id="5991772">.</span><span class="ident" id="5991773">countState</span>&nbsp;<span class="op" id="5991784">=</span>&nbsp;<span class="ident" id="5991786">enc</span><span class="op" id="5991789">.</span><span class="ident" id="5991790">newEncoderState</span><span class="op" id="5991805">(</span><span class="builtinfunc" id="5991806">new</span><span class="op" id="5991809">(</span><span class="ident" id="5991810">encBuffer</span><span class="op" id="5991819">)</span><span class="op" id="5991820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5991823">return</span>&nbsp;<span class="ident" id="5991830">enc</span><br>
<span class="lineno"></span><span class="op" id="5991834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="5991837">//&nbsp;writer()&nbsp;returns&nbsp;the&nbsp;innermost&nbsp;writer&nbsp;the&nbsp;encoder&nbsp;is&nbsp;using</span><br>
<span class="lineno"></span><span class="keyword" id="5991899">func</span>&nbsp;<span class="op" id="5991904">(</span><span class="ident" id="5991905">enc</span>&nbsp;<span class="op" id="5991909">*</span><span class="ident" id="5991910">Encoder</span><span class="op" id="5991917">)</span>&nbsp;<span class="ident" id="5991919">writer</span><span class="op" id="5991925">(</span><span class="op" id="5991926">)</span>&nbsp;<span class="ident" id="5991928">io</span><span class="op" id="5991930">.</span><span class="ident" id="5991931">Writer</span>&nbsp;<span class="op" id="5991938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5991941">return</span>&nbsp;<span class="ident" id="5991948">enc</span><span class="op" id="5991951">.</span><span class="ident" id="5991952">w</span><span class="op" id="5991953">[</span><span class="builtinfunc" id="5991954">len</span><span class="op" id="5991957">(</span><span class="ident" id="5991958">enc</span><span class="op" id="5991961">.</span><span class="ident" id="5991962">w</span><span class="op" id="5991963">)</span><span class="op" id="5991964">-</span><span class="num" id="5991965">1</span><span class="op" id="5991966">]</span><br>
<span class="lineno"></span><span class="op" id="5991968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5991971">//&nbsp;pushWriter&nbsp;adds&nbsp;a&nbsp;writer&nbsp;to&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword" id="5992015">func</span>&nbsp;<span class="op" id="5992020">(</span><span class="ident" id="5992021">enc</span>&nbsp;<span class="op" id="5992025">*</span><span class="ident" id="5992026">Encoder</span><span class="op" id="5992033">)</span>&nbsp;<span class="ident" id="5992035">pushWriter</span><span class="op" id="5992045">(</span><span class="ident" id="5992046">w</span>&nbsp;<span class="ident" id="5992048">io</span><span class="op" id="5992050">.</span><span class="ident" id="5992051">Writer</span><span class="op" id="5992057">)</span>&nbsp;<span class="op" id="5992059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992062">enc</span><span class="op" id="5992065">.</span><span class="ident" id="5992066">w</span>&nbsp;<span class="op" id="5992068">=</span>&nbsp;<span class="builtinfunc" id="5992070">append</span><span class="op" id="5992076">(</span><span class="ident" id="5992077">enc</span><span class="op" id="5992080">.</span><span class="ident" id="5992081">w</span><span class="op" id="5992082">,</span>&nbsp;<span class="ident" id="5992084">w</span><span class="op" id="5992085">)</span><br>
<span class="lineno"></span><span class="op" id="5992087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5992090">//&nbsp;popWriter&nbsp;pops&nbsp;the&nbsp;innermost&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5992130">func</span>&nbsp;<span class="op" id="5992135">(</span><span class="ident" id="5992136">enc</span>&nbsp;<span class="op" id="5992140">*</span><span class="ident" id="5992141">Encoder</span><span class="op" id="5992148">)</span>&nbsp;<span class="ident" id="5992150">popWriter</span><span class="op" id="5992159">(</span><span class="op" id="5992160">)</span>&nbsp;<span class="op" id="5992162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992165">enc</span><span class="op" id="5992168">.</span><span class="ident" id="5992169">w</span>&nbsp;<span class="op" id="5992171">=</span>&nbsp;<span class="ident" id="5992173">enc</span><span class="op" id="5992176">.</span><span class="ident" id="5992177">w</span><span class="op" id="5992178">[</span><span class="num" id="5992179">0</span>&nbsp;<span class="op" id="5992181">:</span>&nbsp;<span class="builtinfunc" id="5992183">len</span><span class="op" id="5992186">(</span><span class="ident" id="5992187">enc</span><span class="op" id="5992190">.</span><span class="ident" id="5992191">w</span><span class="op" id="5992192">)</span><span class="op" id="5992193">-</span><span class="num" id="5992194">1</span><span class="op" id="5992195">]</span><br>
<span class="lineno"></span><span class="op" id="5992197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="5992200">func</span>&nbsp;<span class="op" id="5992205">(</span><span class="ident" id="5992206">enc</span>&nbsp;<span class="op" id="5992210">*</span><span class="ident" id="5992211">Encoder</span><span class="op" id="5992218">)</span>&nbsp;<span class="ident" id="5992220">setError</span><span class="op" id="5992228">(</span><span class="ident" id="5992229">err</span>&nbsp;<span class="builtintype" id="5992233">error</span><span class="op" id="5992238">)</span>&nbsp;<span class="op" id="5992240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5992243">if</span>&nbsp;<span class="ident" id="5992246">enc</span><span class="op" id="5992249">.</span><span class="ident" id="5992250">err</span>&nbsp;<span class="op" id="5992254">==</span>&nbsp;<span class="ident" id="5992257">nil</span>&nbsp;<span class="op" id="5992261">{</span>&nbsp;<span class="comment" id="5992263">//&nbsp;remember&nbsp;the&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992288">enc</span><span class="op" id="5992291">.</span><span class="ident" id="5992292">err</span>&nbsp;<span class="op" id="5992296">=</span>&nbsp;<span class="ident" id="5992298">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5992303">}</span><br>
<span class="lineno"></span><span class="op" id="5992305">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="5992308">//&nbsp;writeMessage&nbsp;sends&nbsp;the&nbsp;data&nbsp;item&nbsp;preceded&nbsp;by&nbsp;a&nbsp;unsigned&nbsp;count&nbsp;of&nbsp;its&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="5992388">func</span>&nbsp;<span class="op" id="5992393">(</span><span class="ident" id="5992394">enc</span>&nbsp;<span class="op" id="5992398">*</span><span class="ident" id="5992399">Encoder</span><span class="op" id="5992406">)</span>&nbsp;<span class="ident" id="5992408">writeMessage</span><span class="op" id="5992420">(</span><span class="ident" id="5992421">w</span>&nbsp;<span class="ident" id="5992423">io</span><span class="op" id="5992425">.</span><span class="ident" id="5992426">Writer</span><span class="op" id="5992432">,</span>&nbsp;<span class="ident" id="5992434">b</span>&nbsp;<span class="op" id="5992436">*</span><span class="ident" id="5992437">encBuffer</span><span class="op" id="5992446">)</span>&nbsp;<span class="op" id="5992448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5992451">//&nbsp;Space&nbsp;has&nbsp;been&nbsp;reserved&nbsp;for&nbsp;the&nbsp;length&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5992522">//&nbsp;This&nbsp;is&nbsp;a&nbsp;little&nbsp;dirty:&nbsp;we&nbsp;grab&nbsp;the&nbsp;slice&nbsp;from&nbsp;the&nbsp;bytes.Buffer&nbsp;and&nbsp;massage</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5992602">//&nbsp;it&nbsp;by&nbsp;hand.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992618">message</span>&nbsp;<span class="op" id="5992626">:=</span>&nbsp;<span class="ident" id="5992629">b</span><span class="op" id="5992630">.</span><span class="ident" id="5992631">Bytes</span><span class="op" id="5992636">(</span><span class="op" id="5992637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992640">messageLen</span>&nbsp;<span class="op" id="5992651">:=</span>&nbsp;<span class="builtinfunc" id="5992654">len</span><span class="op" id="5992657">(</span><span class="ident" id="5992658">message</span><span class="op" id="5992665">)</span>&nbsp;<span class="op" id="5992667">-</span>&nbsp;<span class="ident" id="5992669">maxLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5992680">//&nbsp;Encode&nbsp;the&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992703">enc</span><span class="op" id="5992706">.</span><span class="ident" id="5992707">countState</span><span class="op" id="5992717">.</span><span class="ident" id="5992718">b</span><span class="op" id="5992719">.</span><span class="ident" id="5992720">Reset</span><span class="op" id="5992725">(</span><span class="op" id="5992726">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992729">enc</span><span class="op" id="5992732">.</span><span class="ident" id="5992733">countState</span><span class="op" id="5992743">.</span><span class="ident" id="5992744">encodeUint</span><span class="op" id="5992754">(</span><span class="ident" id="5992755">uint64</span><span class="op" id="5992761">(</span><span class="ident" id="5992762">messageLen</span><span class="op" id="5992772">)</span><span class="op" id="5992773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5992776">//&nbsp;Copy&nbsp;the&nbsp;length&nbsp;to&nbsp;be&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992827">offset</span>&nbsp;<span class="op" id="5992834">:=</span>&nbsp;<span class="ident" id="5992837">maxLength</span>&nbsp;<span class="op" id="5992847">-</span>&nbsp;<span class="ident" id="5992849">enc</span><span class="op" id="5992852">.</span><span class="ident" id="5992853">countState</span><span class="op" id="5992863">.</span><span class="ident" id="5992864">b</span><span class="op" id="5992865">.</span><span class="ident" id="5992866">Len</span><span class="op" id="5992869">(</span><span class="op" id="5992870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5992873">copy</span><span class="op" id="5992877">(</span><span class="ident" id="5992878">message</span><span class="op" id="5992885">[</span><span class="ident" id="5992886">offset</span><span class="op" id="5992892">:</span><span class="op" id="5992893">]</span><span class="op" id="5992894">,</span>&nbsp;<span class="ident" id="5992896">enc</span><span class="op" id="5992899">.</span><span class="ident" id="5992900">countState</span><span class="op" id="5992910">.</span><span class="ident" id="5992911">b</span><span class="op" id="5992912">.</span><span class="ident" id="5992913">Bytes</span><span class="op" id="5992918">(</span><span class="op" id="5992919">)</span><span class="op" id="5992920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5992923">//&nbsp;Write&nbsp;the&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992943">_</span><span class="op" id="5992944">,</span>&nbsp;<span class="ident" id="5992946">err</span>&nbsp;<span class="op" id="5992950">:=</span>&nbsp;<span class="ident" id="5992953">w</span><span class="op" id="5992954">.</span><span class="ident" id="5992955">Write</span><span class="op" id="5992960">(</span><span class="ident" id="5992961">message</span><span class="op" id="5992968">[</span><span class="ident" id="5992969">offset</span><span class="op" id="5992975">:</span><span class="op" id="5992976">]</span><span class="op" id="5992977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5992980">//&nbsp;Drain&nbsp;the&nbsp;buffer&nbsp;and&nbsp;restore&nbsp;the&nbsp;space&nbsp;at&nbsp;the&nbsp;front&nbsp;for&nbsp;the&nbsp;count&nbsp;of&nbsp;the&nbsp;next&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993071">b</span><span class="op" id="5993072">.</span><span class="ident" id="5993073">Reset</span><span class="op" id="5993078">(</span><span class="op" id="5993079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993082">b</span><span class="op" id="5993083">.</span><span class="ident" id="5993084">Write</span><span class="op" id="5993089">(</span><span class="ident" id="5993090">spaceForLength</span><span class="op" id="5993104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993107">if</span>&nbsp;<span class="ident" id="5993110">err</span>&nbsp;<span class="op" id="5993114">!=</span>&nbsp;<span class="ident" id="5993117">nil</span>&nbsp;<span class="op" id="5993121">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993125">enc</span><span class="op" id="5993128">.</span><span class="ident" id="5993129">setError</span><span class="op" id="5993137">(</span><span class="ident" id="5993138">err</span><span class="op" id="5993141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5993144">}</span><br>
<span class="lineno"></span><span class="op" id="5993146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5993149">//&nbsp;sendActualType&nbsp;sends&nbsp;the&nbsp;requested&nbsp;type,&nbsp;without&nbsp;further&nbsp;investigation,&nbsp;unless</span><br>
<span class="lineno">85</span><span class="comment" id="5993231">//&nbsp;it&#39;s&nbsp;been&nbsp;sent&nbsp;before.</span><br>
<span class="lineno"></span><span class="keyword" id="5993257">func</span>&nbsp;<span class="op" id="5993262">(</span><span class="ident" id="5993263">enc</span>&nbsp;<span class="op" id="5993267">*</span><span class="ident" id="5993268">Encoder</span><span class="op" id="5993275">)</span>&nbsp;<span class="ident" id="5993277">sendActualType</span><span class="op" id="5993291">(</span><span class="ident" id="5993292">w</span>&nbsp;<span class="ident" id="5993294">io</span><span class="op" id="5993296">.</span><span class="ident" id="5993297">Writer</span><span class="op" id="5993303">,</span>&nbsp;<span class="ident" id="5993305">state</span>&nbsp;<span class="op" id="5993311">*</span><span class="ident" id="5993312">encoderState</span><span class="op" id="5993324">,</span>&nbsp;<span class="ident" id="5993326">ut</span>&nbsp;<span class="op" id="5993329">*</span><span class="ident" id="5993330">userTypeInfo</span><span class="op" id="5993342">,</span>&nbsp;<span class="ident" id="5993344">actual</span>&nbsp;<span class="ident" id="5993351">reflect</span><span class="op" id="5993358">.</span><span class="ident" id="5993359">Type</span><span class="op" id="5993363">)</span>&nbsp;<span class="op" id="5993365">(</span><span class="ident" id="5993366">sent</span>&nbsp;<span class="builtintype" id="5993371">bool</span><span class="op" id="5993375">)</span>&nbsp;<span class="op" id="5993377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993380">if</span>&nbsp;<span class="ident" id="5993383">_</span><span class="op" id="5993384">,</span>&nbsp;<span class="ident" id="5993386">alreadySent</span>&nbsp;<span class="op" id="5993398">:=</span>&nbsp;<span class="ident" id="5993401">enc</span><span class="op" id="5993404">.</span><span class="ident" id="5993405">sent</span><span class="op" id="5993409">[</span><span class="ident" id="5993410">actual</span><span class="op" id="5993416">]</span><span class="op" id="5993417">;</span>&nbsp;<span class="ident" id="5993419">alreadySent</span>&nbsp;<span class="op" id="5993431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993435">return</span>&nbsp;<span class="builtintype" id="5993442">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5993449">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993452">info</span><span class="op" id="5993456">,</span>&nbsp;<span class="ident" id="5993458">err</span>&nbsp;<span class="op" id="5993462">:=</span>&nbsp;<span class="ident" id="5993465">getTypeInfo</span><span class="op" id="5993476">(</span><span class="ident" id="5993477">ut</span><span class="op" id="5993479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993482">if</span>&nbsp;<span class="ident" id="5993485">err</span>&nbsp;<span class="op" id="5993489">!=</span>&nbsp;<span class="ident" id="5993492">nil</span>&nbsp;<span class="op" id="5993496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993500">enc</span><span class="op" id="5993503">.</span><span class="ident" id="5993504">setError</span><span class="op" id="5993512">(</span><span class="ident" id="5993513">err</span><span class="op" id="5993516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993520">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5993528">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5993531">//&nbsp;Send&nbsp;the&nbsp;pair&nbsp;(-id,&nbsp;type)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5993561">//&nbsp;Id:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993569">state</span><span class="op" id="5993574">.</span><span class="ident" id="5993575">encodeInt</span><span class="op" id="5993584">(</span><span class="op" id="5993585">-</span><span class="ident" id="5993586">int64</span><span class="op" id="5993591">(</span><span class="ident" id="5993592">info</span><span class="op" id="5993596">.</span><span class="ident" id="5993597">id</span><span class="op" id="5993599">)</span><span class="op" id="5993600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5993603">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993613">enc</span><span class="op" id="5993616">.</span><span class="ident" id="5993617">encode</span><span class="op" id="5993623">(</span><span class="ident" id="5993624">state</span><span class="op" id="5993629">.</span><span class="ident" id="5993630">b</span><span class="op" id="5993631">,</span>&nbsp;<span class="ident" id="5993633">reflect</span><span class="op" id="5993640">.</span><span class="ident" id="5993641">ValueOf</span><span class="op" id="5993648">(</span><span class="ident" id="5993649">info</span><span class="op" id="5993653">.</span><span class="ident" id="5993654">wire</span><span class="op" id="5993658">)</span><span class="op" id="5993659">,</span>&nbsp;<span class="ident" id="5993661">wireTypeUserInfo</span><span class="op" id="5993677">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993680">enc</span><span class="op" id="5993683">.</span><span class="ident" id="5993684">writeMessage</span><span class="op" id="5993696">(</span><span class="ident" id="5993697">w</span><span class="op" id="5993698">,</span>&nbsp;<span class="ident" id="5993700">state</span><span class="op" id="5993705">.</span><span class="ident" id="5993706">b</span><span class="op" id="5993707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993710">if</span>&nbsp;<span class="ident" id="5993713">enc</span><span class="op" id="5993716">.</span><span class="ident" id="5993717">err</span>&nbsp;<span class="op" id="5993721">!=</span>&nbsp;<span class="ident" id="5993724">nil</span>&nbsp;<span class="op" id="5993728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993732">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5993740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5993744">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;sent&nbsp;this&nbsp;type,&nbsp;both&nbsp;what&nbsp;the&nbsp;user&nbsp;gave&nbsp;us&nbsp;and&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993825">enc</span><span class="op" id="5993828">.</span><span class="ident" id="5993829">sent</span><span class="op" id="5993833">[</span><span class="ident" id="5993834">ut</span><span class="op" id="5993836">.</span><span class="ident" id="5993837">base</span><span class="op" id="5993841">]</span>&nbsp;<span class="op" id="5993843">=</span>&nbsp;<span class="ident" id="5993845">info</span><span class="op" id="5993849">.</span><span class="ident" id="5993850">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993854">if</span>&nbsp;<span class="ident" id="5993857">ut</span><span class="op" id="5993859">.</span><span class="ident" id="5993860">user</span>&nbsp;<span class="op" id="5993865">!=</span>&nbsp;<span class="ident" id="5993868">ut</span><span class="op" id="5993870">.</span><span class="ident" id="5993871">base</span>&nbsp;<span class="op" id="5993876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5993880">enc</span><span class="op" id="5993883">.</span><span class="ident" id="5993884">sent</span><span class="op" id="5993888">[</span><span class="ident" id="5993889">ut</span><span class="op" id="5993891">.</span><span class="ident" id="5993892">user</span><span class="op" id="5993896">]</span>&nbsp;<span class="op" id="5993898">=</span>&nbsp;<span class="ident" id="5993900">info</span><span class="op" id="5993904">.</span><span class="ident" id="5993905">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5993909">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5993912">//&nbsp;Now&nbsp;send&nbsp;the&nbsp;inner&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993941">switch</span>&nbsp;<span class="ident" id="5993948">st</span>&nbsp;<span class="op" id="5993951">:=</span>&nbsp;<span class="ident" id="5993954">actual</span><span class="op" id="5993960">;</span>&nbsp;<span class="ident" id="5993962">st</span><span class="op" id="5993964">.</span><span class="ident" id="5993965">Kind</span><span class="op" id="5993969">(</span><span class="op" id="5993970">)</span>&nbsp;<span class="op" id="5993972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993975">case</span>&nbsp;<span class="ident" id="5993980">reflect</span><span class="op" id="5993987">.</span><span class="ident" id="5993988">Struct</span><span class="op" id="5993994">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993998">for</span>&nbsp;<span class="ident" id="5994002">i</span>&nbsp;<span class="op" id="5994004">:=</span>&nbsp;<span class="num" id="5994007">0</span><span class="op" id="5994008">;</span>&nbsp;<span class="ident" id="5994010">i</span>&nbsp;<span class="op" id="5994012">&lt;</span>&nbsp;<span class="ident" id="5994014">st</span><span class="op" id="5994016">.</span><span class="ident" id="5994017">NumField</span><span class="op" id="5994025">(</span><span class="op" id="5994026">)</span><span class="op" id="5994027">;</span>&nbsp;<span class="ident" id="5994029">i</span><span class="op" id="5994030">++</span>&nbsp;<span class="op" id="5994033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994038">if</span>&nbsp;<span class="ident" id="5994041">isExported</span><span class="op" id="5994051">(</span><span class="ident" id="5994052">st</span><span class="op" id="5994054">.</span><span class="ident" id="5994055">Field</span><span class="op" id="5994060">(</span><span class="ident" id="5994061">i</span><span class="op" id="5994062">)</span><span class="op" id="5994063">.</span><span class="ident" id="5994064">Name</span><span class="op" id="5994068">)</span>&nbsp;<span class="op" id="5994070">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994076">enc</span><span class="op" id="5994079">.</span><span class="ident" id="5994080">sendType</span><span class="op" id="5994088">(</span><span class="ident" id="5994089">w</span><span class="op" id="5994090">,</span>&nbsp;<span class="ident" id="5994092">state</span><span class="op" id="5994097">,</span>&nbsp;<span class="ident" id="5994099">st</span><span class="op" id="5994101">.</span><span class="ident" id="5994102">Field</span><span class="op" id="5994107">(</span><span class="ident" id="5994108">i</span><span class="op" id="5994109">)</span><span class="op" id="5994110">.</span><span class="ident" id="5994111">Type</span><span class="op" id="5994115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5994120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5994124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994127">case</span>&nbsp;<span class="ident" id="5994132">reflect</span><span class="op" id="5994139">.</span><span class="ident" id="5994140">Array</span><span class="op" id="5994145">,</span>&nbsp;<span class="ident" id="5994147">reflect</span><span class="op" id="5994154">.</span><span class="ident" id="5994155">Slice</span><span class="op" id="5994160">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994164">enc</span><span class="op" id="5994167">.</span><span class="ident" id="5994168">sendType</span><span class="op" id="5994176">(</span><span class="ident" id="5994177">w</span><span class="op" id="5994178">,</span>&nbsp;<span class="ident" id="5994180">state</span><span class="op" id="5994185">,</span>&nbsp;<span class="ident" id="5994187">st</span><span class="op" id="5994189">.</span><span class="ident" id="5994190">Elem</span><span class="op" id="5994194">(</span><span class="op" id="5994195">)</span><span class="op" id="5994196">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994199">case</span>&nbsp;<span class="ident" id="5994204">reflect</span><span class="op" id="5994211">.</span><span class="ident" id="5994212">Map</span><span class="op" id="5994215">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994219">enc</span><span class="op" id="5994222">.</span><span class="ident" id="5994223">sendType</span><span class="op" id="5994231">(</span><span class="ident" id="5994232">w</span><span class="op" id="5994233">,</span>&nbsp;<span class="ident" id="5994235">state</span><span class="op" id="5994240">,</span>&nbsp;<span class="ident" id="5994242">st</span><span class="op" id="5994244">.</span><span class="ident" id="5994245">Key</span><span class="op" id="5994248">(</span><span class="op" id="5994249">)</span><span class="op" id="5994250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994254">enc</span><span class="op" id="5994257">.</span><span class="ident" id="5994258">sendType</span><span class="op" id="5994266">(</span><span class="ident" id="5994267">w</span><span class="op" id="5994268">,</span>&nbsp;<span class="ident" id="5994270">state</span><span class="op" id="5994275">,</span>&nbsp;<span class="ident" id="5994277">st</span><span class="op" id="5994279">.</span><span class="ident" id="5994280">Elem</span><span class="op" id="5994284">(</span><span class="op" id="5994285">)</span><span class="op" id="5994286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5994289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994292">return</span>&nbsp;<span class="builtintype" id="5994299">true</span><br>
<span class="lineno">125</span><span class="op" id="5994304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5994307">//&nbsp;sendType&nbsp;sends&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;the&nbsp;other&nbsp;side,&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="5994372">func</span>&nbsp;<span class="op" id="5994377">(</span><span class="ident" id="5994378">enc</span>&nbsp;<span class="op" id="5994382">*</span><span class="ident" id="5994383">Encoder</span><span class="op" id="5994390">)</span>&nbsp;<span class="ident" id="5994392">sendType</span><span class="op" id="5994400">(</span><span class="ident" id="5994401">w</span>&nbsp;<span class="ident" id="5994403">io</span><span class="op" id="5994405">.</span><span class="ident" id="5994406">Writer</span><span class="op" id="5994412">,</span>&nbsp;<span class="ident" id="5994414">state</span>&nbsp;<span class="op" id="5994420">*</span><span class="ident" id="5994421">encoderState</span><span class="op" id="5994433">,</span>&nbsp;<span class="ident" id="5994435">origt</span>&nbsp;<span class="ident" id="5994441">reflect</span><span class="op" id="5994448">.</span><span class="ident" id="5994449">Type</span><span class="op" id="5994453">)</span>&nbsp;<span class="op" id="5994455">(</span><span class="ident" id="5994456">sent</span>&nbsp;<span class="builtintype" id="5994461">bool</span><span class="op" id="5994465">)</span>&nbsp;<span class="op" id="5994467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994470">ut</span>&nbsp;<span class="op" id="5994473">:=</span>&nbsp;<span class="ident" id="5994476">userType</span><span class="op" id="5994484">(</span><span class="ident" id="5994485">origt</span><span class="op" id="5994490">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994493">if</span>&nbsp;<span class="ident" id="5994496">ut</span><span class="op" id="5994498">.</span><span class="ident" id="5994499">externalEnc</span>&nbsp;<span class="op" id="5994511">!=</span>&nbsp;<span class="num" id="5994514">0</span>&nbsp;<span class="op" id="5994516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5994520">//&nbsp;The&nbsp;rules&nbsp;are&nbsp;different:&nbsp;regardless&nbsp;of&nbsp;the&nbsp;underlying&nbsp;type&#39;s&nbsp;representation,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5994602">//&nbsp;we&nbsp;need&nbsp;to&nbsp;tell&nbsp;the&nbsp;other&nbsp;side&nbsp;that&nbsp;the&nbsp;base&nbsp;type&nbsp;is&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994674">return</span>&nbsp;<span class="ident" id="5994681">enc</span><span class="op" id="5994684">.</span><span class="ident" id="5994685">sendActualType</span><span class="op" id="5994699">(</span><span class="ident" id="5994700">w</span><span class="op" id="5994701">,</span>&nbsp;<span class="ident" id="5994703">state</span><span class="op" id="5994708">,</span>&nbsp;<span class="ident" id="5994710">ut</span><span class="op" id="5994712">,</span>&nbsp;<span class="ident" id="5994714">ut</span><span class="op" id="5994716">.</span><span class="ident" id="5994717">base</span><span class="op" id="5994721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5994724">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5994728">//&nbsp;It&#39;s&nbsp;a&nbsp;concrete&nbsp;value,&nbsp;so&nbsp;drill&nbsp;down&nbsp;to&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994787">switch</span>&nbsp;<span class="ident" id="5994794">rt</span>&nbsp;<span class="op" id="5994797">:=</span>&nbsp;<span class="ident" id="5994800">ut</span><span class="op" id="5994802">.</span><span class="ident" id="5994803">base</span><span class="op" id="5994807">;</span>&nbsp;<span class="ident" id="5994809">rt</span><span class="op" id="5994811">.</span><span class="ident" id="5994812">Kind</span><span class="op" id="5994816">(</span><span class="op" id="5994817">)</span>&nbsp;<span class="op" id="5994819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994822">default</span><span class="op" id="5994829">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5994833">//&nbsp;Basic&nbsp;types&nbsp;and&nbsp;interfaces&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;described.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994894">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994902">case</span>&nbsp;<span class="ident" id="5994907">reflect</span><span class="op" id="5994914">.</span><span class="ident" id="5994915">Slice</span><span class="op" id="5994920">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5994924">//&nbsp;If&nbsp;it&#39;s&nbsp;[]uint8,&nbsp;don&#39;t&nbsp;send;&nbsp;it&#39;s&nbsp;considered&nbsp;basic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994981">if</span>&nbsp;<span class="ident" id="5994984">rt</span><span class="op" id="5994986">.</span><span class="ident" id="5994987">Elem</span><span class="op" id="5994991">(</span><span class="op" id="5994992">)</span><span class="op" id="5994993">.</span><span class="ident" id="5994994">Kind</span><span class="op" id="5994998">(</span><span class="op" id="5994999">)</span>&nbsp;<span class="op" id="5995001">==</span>&nbsp;<span class="ident" id="5995004">reflect</span><span class="op" id="5995011">.</span><span class="ident" id="5995012">Uint8</span>&nbsp;<span class="op" id="5995018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995023">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5995032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5995036">//&nbsp;Otherwise&nbsp;we&nbsp;do&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995063">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995070">case</span>&nbsp;<span class="ident" id="5995075">reflect</span><span class="op" id="5995082">.</span><span class="ident" id="5995083">Array</span><span class="op" id="5995088">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5995092">//&nbsp;arrays&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;element&nbsp;types.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995161">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995168">case</span>&nbsp;<span class="ident" id="5995173">reflect</span><span class="op" id="5995180">.</span><span class="ident" id="5995181">Map</span><span class="op" id="5995184">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5995188">//&nbsp;maps&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;key/value&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995257">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995264">case</span>&nbsp;<span class="ident" id="5995269">reflect</span><span class="op" id="5995276">.</span><span class="ident" id="5995277">Struct</span><span class="op" id="5995283">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5995287">//&nbsp;structs&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995338">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995345">case</span>&nbsp;<span class="ident" id="5995350">reflect</span><span class="op" id="5995357">.</span><span class="ident" id="5995358">Chan</span><span class="op" id="5995362">,</span>&nbsp;<span class="ident" id="5995364">reflect</span><span class="op" id="5995371">.</span><span class="ident" id="5995372">Func</span><span class="op" id="5995376">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5995380">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&#39;s&nbsp;a&nbsp;field&nbsp;of&nbsp;a&nbsp;struct;&nbsp;ignore&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995438">return</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5995446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995450">return</span>&nbsp;<span class="ident" id="5995457">enc</span><span class="op" id="5995460">.</span><span class="ident" id="5995461">sendActualType</span><span class="op" id="5995475">(</span><span class="ident" id="5995476">w</span><span class="op" id="5995477">,</span>&nbsp;<span class="ident" id="5995479">state</span><span class="op" id="5995484">,</span>&nbsp;<span class="ident" id="5995486">ut</span><span class="op" id="5995488">,</span>&nbsp;<span class="ident" id="5995490">ut</span><span class="op" id="5995492">.</span><span class="ident" id="5995493">base</span><span class="op" id="5995497">)</span><br>
<span class="lineno"></span><span class="op" id="5995499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="5995502">//&nbsp;Encode&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="5995578">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="5995658">func</span>&nbsp;<span class="op" id="5995663">(</span><span class="ident" id="5995664">enc</span>&nbsp;<span class="op" id="5995668">*</span><span class="ident" id="5995669">Encoder</span><span class="op" id="5995676">)</span>&nbsp;<span class="ident" id="5995678">Encode</span><span class="op" id="5995684">(</span><span class="ident" id="5995685">e</span>&nbsp;<span class="keyword" id="5995687">interface</span><span class="op" id="5995696">{</span><span class="op" id="5995697">}</span><span class="op" id="5995698">)</span>&nbsp;<span class="builtintype" id="5995700">error</span>&nbsp;<span class="op" id="5995706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995709">return</span>&nbsp;<span class="ident" id="5995716">enc</span><span class="op" id="5995719">.</span><span class="ident" id="5995720">EncodeValue</span><span class="op" id="5995731">(</span><span class="ident" id="5995732">reflect</span><span class="op" id="5995739">.</span><span class="ident" id="5995740">ValueOf</span><span class="op" id="5995747">(</span><span class="ident" id="5995748">e</span><span class="op" id="5995749">)</span><span class="op" id="5995750">)</span><br>
<span class="lineno"></span><span class="op" id="5995752">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="5995755">//&nbsp;sendTypeDescriptor&nbsp;makes&nbsp;sure&nbsp;the&nbsp;remote&nbsp;side&nbsp;knows&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="5995827">//&nbsp;It&nbsp;will&nbsp;send&nbsp;a&nbsp;descriptor&nbsp;if&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;type&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span><span class="comment" id="5995900">//&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="5995909">func</span>&nbsp;<span class="op" id="5995914">(</span><span class="ident" id="5995915">enc</span>&nbsp;<span class="op" id="5995919">*</span><span class="ident" id="5995920">Encoder</span><span class="op" id="5995927">)</span>&nbsp;<span class="ident" id="5995929">sendTypeDescriptor</span><span class="op" id="5995947">(</span><span class="ident" id="5995948">w</span>&nbsp;<span class="ident" id="5995950">io</span><span class="op" id="5995952">.</span><span class="ident" id="5995953">Writer</span><span class="op" id="5995959">,</span>&nbsp;<span class="ident" id="5995961">state</span>&nbsp;<span class="op" id="5995967">*</span><span class="ident" id="5995968">encoderState</span><span class="op" id="5995980">,</span>&nbsp;<span class="ident" id="5995982">ut</span>&nbsp;<span class="op" id="5995985">*</span><span class="ident" id="5995986">userTypeInfo</span><span class="op" id="5995998">)</span>&nbsp;<span class="op" id="5996000">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5996003">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;type&nbsp;is&nbsp;known&nbsp;to&nbsp;the&nbsp;other&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5996054">//&nbsp;First,&nbsp;have&nbsp;we&nbsp;already&nbsp;sent&nbsp;this&nbsp;type?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996097">rt</span>&nbsp;<span class="op" id="5996100">:=</span>&nbsp;<span class="ident" id="5996103">ut</span><span class="op" id="5996105">.</span><span class="ident" id="5996106">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996112">if</span>&nbsp;<span class="ident" id="5996115">ut</span><span class="op" id="5996117">.</span><span class="ident" id="5996118">externalEnc</span>&nbsp;<span class="op" id="5996130">!=</span>&nbsp;<span class="num" id="5996133">0</span>&nbsp;<span class="op" id="5996135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996139">rt</span>&nbsp;<span class="op" id="5996142">=</span>&nbsp;<span class="ident" id="5996144">ut</span><span class="op" id="5996146">.</span><span class="ident" id="5996147">user</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996156">if</span>&nbsp;<span class="ident" id="5996159">_</span><span class="op" id="5996160">,</span>&nbsp;<span class="ident" id="5996162">alreadySent</span>&nbsp;<span class="op" id="5996174">:=</span>&nbsp;<span class="ident" id="5996177">enc</span><span class="op" id="5996180">.</span><span class="ident" id="5996181">sent</span><span class="op" id="5996185">[</span><span class="ident" id="5996186">rt</span><span class="op" id="5996188">]</span><span class="op" id="5996189">;</span>&nbsp;<span class="op" id="5996191">!</span><span class="ident" id="5996192">alreadySent</span>&nbsp;<span class="op" id="5996204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5996208">//&nbsp;No,&nbsp;so&nbsp;send&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996229">sent</span>&nbsp;<span class="op" id="5996234">:=</span>&nbsp;<span class="ident" id="5996237">enc</span><span class="op" id="5996240">.</span><span class="ident" id="5996241">sendType</span><span class="op" id="5996249">(</span><span class="ident" id="5996250">w</span><span class="op" id="5996251">,</span>&nbsp;<span class="ident" id="5996253">state</span><span class="op" id="5996258">,</span>&nbsp;<span class="ident" id="5996260">rt</span><span class="op" id="5996262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996266">if</span>&nbsp;<span class="ident" id="5996269">enc</span><span class="op" id="5996272">.</span><span class="ident" id="5996273">err</span>&nbsp;<span class="op" id="5996277">!=</span>&nbsp;<span class="ident" id="5996280">nil</span>&nbsp;<span class="op" id="5996284">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996289">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5996302">//&nbsp;If&nbsp;the&nbsp;type&nbsp;info&nbsp;has&nbsp;still&nbsp;not&nbsp;been&nbsp;transmitted,&nbsp;it&nbsp;means&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5996373">//&nbsp;a&nbsp;singleton&nbsp;basic&nbsp;type&nbsp;(int,&nbsp;[]byte&nbsp;etc.)&nbsp;at&nbsp;top&nbsp;level.&nbsp;&nbsp;We&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5996444">//&nbsp;need&nbsp;to&nbsp;send&nbsp;the&nbsp;type&nbsp;info&nbsp;but&nbsp;we&nbsp;do&nbsp;need&nbsp;to&nbsp;update&nbsp;enc.sent.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996511">if</span>&nbsp;<span class="op" id="5996514">!</span><span class="ident" id="5996515">sent</span>&nbsp;<span class="op" id="5996520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996525">info</span><span class="op" id="5996529">,</span>&nbsp;<span class="ident" id="5996531">err</span>&nbsp;<span class="op" id="5996535">:=</span>&nbsp;<span class="ident" id="5996538">getTypeInfo</span><span class="op" id="5996549">(</span><span class="ident" id="5996550">ut</span><span class="op" id="5996552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996557">if</span>&nbsp;<span class="ident" id="5996560">err</span>&nbsp;<span class="op" id="5996564">!=</span>&nbsp;<span class="ident" id="5996567">nil</span>&nbsp;<span class="op" id="5996571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996577">enc</span><span class="op" id="5996580">.</span><span class="ident" id="5996581">setError</span><span class="op" id="5996589">(</span><span class="ident" id="5996590">err</span><span class="op" id="5996593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996599">return</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996614">enc</span><span class="op" id="5996617">.</span><span class="ident" id="5996618">sent</span><span class="op" id="5996622">[</span><span class="ident" id="5996623">rt</span><span class="op" id="5996625">]</span>&nbsp;<span class="op" id="5996627">=</span>&nbsp;<span class="ident" id="5996629">info</span><span class="op" id="5996633">.</span><span class="ident" id="5996634">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996642">}</span><br>
<span class="lineno"></span><span class="op" id="5996644">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5996647">//&nbsp;sendTypeId&nbsp;sends&nbsp;the&nbsp;id,&nbsp;which&nbsp;must&nbsp;have&nbsp;already&nbsp;been&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="5996713">func</span>&nbsp;<span class="op" id="5996718">(</span><span class="ident" id="5996719">enc</span>&nbsp;<span class="op" id="5996723">*</span><span class="ident" id="5996724">Encoder</span><span class="op" id="5996731">)</span>&nbsp;<span class="ident" id="5996733">sendTypeId</span><span class="op" id="5996743">(</span><span class="ident" id="5996744">state</span>&nbsp;<span class="op" id="5996750">*</span><span class="ident" id="5996751">encoderState</span><span class="op" id="5996763">,</span>&nbsp;<span class="ident" id="5996765">ut</span>&nbsp;<span class="op" id="5996768">*</span><span class="ident" id="5996769">userTypeInfo</span><span class="op" id="5996781">)</span>&nbsp;<span class="op" id="5996783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5996786">//&nbsp;Identify&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;top-level&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996833">state</span><span class="op" id="5996838">.</span><span class="ident" id="5996839">encodeInt</span><span class="op" id="5996848">(</span><span class="ident" id="5996849">int64</span><span class="op" id="5996854">(</span><span class="ident" id="5996855">enc</span><span class="op" id="5996858">.</span><span class="ident" id="5996859">sent</span><span class="op" id="5996863">[</span><span class="ident" id="5996864">ut</span><span class="op" id="5996866">.</span><span class="ident" id="5996867">base</span><span class="op" id="5996871">]</span><span class="op" id="5996872">)</span><span class="op" id="5996873">)</span><br>
<span class="lineno">205</span><span class="op" id="5996875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5996878">//&nbsp;EncodeValue&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;reflection&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="5996954">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="5997034">func</span>&nbsp;<span class="op" id="5997039">(</span><span class="ident" id="5997040">enc</span>&nbsp;<span class="op" id="5997044">*</span><span class="ident" id="5997045">Encoder</span><span class="op" id="5997052">)</span>&nbsp;<span class="ident" id="5997054">EncodeValue</span><span class="op" id="5997065">(</span><span class="ident" id="5997066">value</span>&nbsp;<span class="ident" id="5997072">reflect</span><span class="op" id="5997079">.</span><span class="ident" id="5997080">Value</span><span class="op" id="5997085">)</span>&nbsp;<span class="builtintype" id="5997087">error</span>&nbsp;<span class="op" id="5997093">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5997096">//&nbsp;Gobs&nbsp;contain&nbsp;values.&nbsp;They&nbsp;cannot&nbsp;represent&nbsp;nil&nbsp;pointers,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5997163">//&nbsp;have&nbsp;no&nbsp;value&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997192">if</span>&nbsp;<span class="ident" id="5997195">value</span><span class="op" id="5997200">.</span><span class="ident" id="5997201">Kind</span><span class="op" id="5997205">(</span><span class="op" id="5997206">)</span>&nbsp;<span class="op" id="5997208">==</span>&nbsp;<span class="ident" id="5997211">reflect</span><span class="op" id="5997218">.</span><span class="ident" id="5997219">Ptr</span>&nbsp;<span class="op" id="5997223">&amp;&amp;</span>&nbsp;<span class="ident" id="5997226">value</span><span class="op" id="5997231">.</span><span class="ident" id="5997232">IsNil</span><span class="op" id="5997237">(</span><span class="op" id="5997238">)</span>&nbsp;<span class="op" id="5997240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5997244">panic</span><span class="op" id="5997249">(</span><span class="string" id="5997250">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5997292">+</span>&nbsp;<span class="ident" id="5997294">value</span><span class="op" id="5997299">.</span><span class="ident" id="5997300">Type</span><span class="op" id="5997304">(</span><span class="op" id="5997305">)</span><span class="op" id="5997306">.</span><span class="ident" id="5997307">String</span><span class="op" id="5997313">(</span><span class="op" id="5997314">)</span><span class="op" id="5997315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997318">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5997322">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here,&nbsp;so&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5997384">//&nbsp;goroutines&nbsp;can&nbsp;share&nbsp;an&nbsp;encoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997421">enc</span><span class="op" id="5997424">.</span><span class="ident" id="5997425">mutex</span><span class="op" id="5997430">.</span><span class="ident" id="5997431">Lock</span><span class="op" id="5997435">(</span><span class="op" id="5997436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997439">defer</span>&nbsp;<span class="ident" id="5997445">enc</span><span class="op" id="5997448">.</span><span class="ident" id="5997449">mutex</span><span class="op" id="5997454">.</span><span class="ident" id="5997455">Unlock</span><span class="op" id="5997461">(</span><span class="op" id="5997462">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5997466">//&nbsp;Remove&nbsp;any&nbsp;nested&nbsp;writers&nbsp;remaining&nbsp;due&nbsp;to&nbsp;previous&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997530">enc</span><span class="op" id="5997533">.</span><span class="ident" id="5997534">w</span>&nbsp;<span class="op" id="5997536">=</span>&nbsp;<span class="ident" id="5997538">enc</span><span class="op" id="5997541">.</span><span class="ident" id="5997542">w</span><span class="op" id="5997543">[</span><span class="num" id="5997544">0</span><span class="op" id="5997545">:</span><span class="num" id="5997546">1</span><span class="op" id="5997547">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997551">ut</span><span class="op" id="5997553">,</span>&nbsp;<span class="ident" id="5997555">err</span>&nbsp;<span class="op" id="5997559">:=</span>&nbsp;<span class="ident" id="5997562">validUserType</span><span class="op" id="5997575">(</span><span class="ident" id="5997576">value</span><span class="op" id="5997581">.</span><span class="ident" id="5997582">Type</span><span class="op" id="5997586">(</span><span class="op" id="5997587">)</span><span class="op" id="5997588">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997591">if</span>&nbsp;<span class="ident" id="5997594">err</span>&nbsp;<span class="op" id="5997598">!=</span>&nbsp;<span class="ident" id="5997601">nil</span>&nbsp;<span class="op" id="5997605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997609">return</span>&nbsp;<span class="ident" id="5997616">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997625">enc</span><span class="op" id="5997628">.</span><span class="ident" id="5997629">err</span>&nbsp;<span class="op" id="5997633">=</span>&nbsp;<span class="ident" id="5997635">nil</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997640">enc</span><span class="op" id="5997643">.</span><span class="ident" id="5997644">byteBuf</span><span class="op" id="5997651">.</span><span class="ident" id="5997652">Reset</span><span class="op" id="5997657">(</span><span class="op" id="5997658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997661">enc</span><span class="op" id="5997664">.</span><span class="ident" id="5997665">byteBuf</span><span class="op" id="5997672">.</span><span class="ident" id="5997673">Write</span><span class="op" id="5997678">(</span><span class="ident" id="5997679">spaceForLength</span><span class="op" id="5997693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997696">state</span>&nbsp;<span class="op" id="5997702">:=</span>&nbsp;<span class="ident" id="5997705">enc</span><span class="op" id="5997708">.</span><span class="ident" id="5997709">newEncoderState</span><span class="op" id="5997724">(</span><span class="op" id="5997725">&amp;</span><span class="ident" id="5997726">enc</span><span class="op" id="5997729">.</span><span class="ident" id="5997730">byteBuf</span><span class="op" id="5997737">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997741">enc</span><span class="op" id="5997744">.</span><span class="ident" id="5997745">sendTypeDescriptor</span><span class="op" id="5997763">(</span><span class="ident" id="5997764">enc</span><span class="op" id="5997767">.</span><span class="ident" id="5997768">writer</span><span class="op" id="5997774">(</span><span class="op" id="5997775">)</span><span class="op" id="5997776">,</span>&nbsp;<span class="ident" id="5997778">state</span><span class="op" id="5997783">,</span>&nbsp;<span class="ident" id="5997785">ut</span><span class="op" id="5997787">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997790">enc</span><span class="op" id="5997793">.</span><span class="ident" id="5997794">sendTypeId</span><span class="op" id="5997804">(</span><span class="ident" id="5997805">state</span><span class="op" id="5997810">,</span>&nbsp;<span class="ident" id="5997812">ut</span><span class="op" id="5997814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997817">if</span>&nbsp;<span class="ident" id="5997820">enc</span><span class="op" id="5997823">.</span><span class="ident" id="5997824">err</span>&nbsp;<span class="op" id="5997828">!=</span>&nbsp;<span class="ident" id="5997831">nil</span>&nbsp;<span class="op" id="5997835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997839">return</span>&nbsp;<span class="ident" id="5997846">enc</span><span class="op" id="5997849">.</span><span class="ident" id="5997850">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5997859">//&nbsp;Encode&nbsp;the&nbsp;object.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997882">enc</span><span class="op" id="5997885">.</span><span class="ident" id="5997886">encode</span><span class="op" id="5997892">(</span><span class="ident" id="5997893">state</span><span class="op" id="5997898">.</span><span class="ident" id="5997899">b</span><span class="op" id="5997900">,</span>&nbsp;<span class="ident" id="5997902">value</span><span class="op" id="5997907">,</span>&nbsp;<span class="ident" id="5997909">ut</span><span class="op" id="5997911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997914">if</span>&nbsp;<span class="ident" id="5997917">enc</span><span class="op" id="5997920">.</span><span class="ident" id="5997921">err</span>&nbsp;<span class="op" id="5997925">==</span>&nbsp;<span class="ident" id="5997928">nil</span>&nbsp;<span class="op" id="5997932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997936">enc</span><span class="op" id="5997939">.</span><span class="ident" id="5997940">writeMessage</span><span class="op" id="5997952">(</span><span class="ident" id="5997953">enc</span><span class="op" id="5997956">.</span><span class="ident" id="5997957">writer</span><span class="op" id="5997963">(</span><span class="op" id="5997964">)</span><span class="op" id="5997965">,</span>&nbsp;<span class="ident" id="5997967">state</span><span class="op" id="5997972">.</span><span class="ident" id="5997973">b</span><span class="op" id="5997974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997977">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997981">enc</span><span class="op" id="5997984">.</span><span class="ident" id="5997985">freeEncoderState</span><span class="op" id="5998001">(</span><span class="ident" id="5998002">state</span><span class="op" id="5998007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998010">return</span>&nbsp;<span class="ident" id="5998017">enc</span><span class="op" id="5998020">.</span><span class="ident" id="5998021">err</span><br>
<span class="lineno"></span><span class="op" id="5998025">}</span>
</div>
</body>
</html>
