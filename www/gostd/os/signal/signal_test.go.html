<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7259143">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7259198">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7259252">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7259303">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7259368">package</span>&nbsp;<span class="ident" id="7259376">signal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7259384">import</span>&nbsp;<span class="op" id="7259391">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7259394">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7259402">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7259415">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7259421">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7259432">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7259443">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7259454">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7259465">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7259476">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7259483">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7259486">func</span>&nbsp;<span class="ident" id="7259491">waitSig</span><span class="op" id="7259498">(</span><span class="ident" id="7259499">t</span>&nbsp;<span class="op" id="7259501">*</span><span class="ident" id="7259502">testing</span><span class="op" id="7259509">.</span><span class="ident" id="7259510">T</span><span class="op" id="7259511">,</span>&nbsp;<span class="ident" id="7259513">c</span>&nbsp;<span class="op" id="7259515">&lt;-</span><span class="keyword" id="7259517">chan</span>&nbsp;<span class="ident" id="7259522">os</span><span class="op" id="7259524">.</span><span class="ident" id="7259525">Signal</span><span class="op" id="7259531">,</span>&nbsp;<span class="ident" id="7259533">sig</span>&nbsp;<span class="ident" id="7259537">os</span><span class="op" id="7259539">.</span><span class="ident" id="7259540">Signal</span><span class="op" id="7259546">)</span>&nbsp;<span class="op" id="7259548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259551">select</span>&nbsp;<span class="op" id="7259558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259561">case</span>&nbsp;<span class="ident" id="7259566">s</span>&nbsp;<span class="op" id="7259568">:=</span>&nbsp;<span class="op" id="7259571">&lt;-</span><span class="ident" id="7259573">c</span><span class="op" id="7259574">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259578">if</span>&nbsp;<span class="ident" id="7259581">s</span>&nbsp;<span class="op" id="7259583">!=</span>&nbsp;<span class="ident" id="7259586">sig</span>&nbsp;<span class="op" id="7259590">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259595">t</span><span class="op" id="7259596">.</span><span class="ident" id="7259597">Fatalf</span><span class="op" id="7259603">(</span><span class="string" id="7259604">&#34;signal&nbsp;was&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7259628">,</span>&nbsp;<span class="ident" id="7259630">s</span><span class="op" id="7259631">,</span>&nbsp;<span class="ident" id="7259633">sig</span><span class="op" id="7259636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7259640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259643">case</span>&nbsp;<span class="op" id="7259648">&lt;-</span><span class="ident" id="7259650">time</span><span class="op" id="7259654">.</span><span class="ident" id="7259655">After</span><span class="op" id="7259660">(</span><span class="num" id="7259661">1</span>&nbsp;<span class="op" id="7259663">*</span>&nbsp;<span class="ident" id="7259665">time</span><span class="op" id="7259669">.</span><span class="ident" id="7259670">Second</span><span class="op" id="7259676">)</span><span class="op" id="7259677">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259681">t</span><span class="op" id="7259682">.</span><span class="ident" id="7259683">Fatalf</span><span class="op" id="7259689">(</span><span class="string" id="7259690">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;%v&#34;</span><span class="op" id="7259714">,</span>&nbsp;<span class="ident" id="7259716">sig</span><span class="op" id="7259719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7259722">}</span><br>
<span class="lineno">30</span><span class="op" id="7259724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7259727">//&nbsp;Test&nbsp;that&nbsp;basic&nbsp;signal&nbsp;handling&nbsp;works.</span><br>
<span class="lineno"></span><span class="keyword" id="7259769">func</span>&nbsp;<span class="ident" id="7259774">TestSignal</span><span class="op" id="7259784">(</span><span class="ident" id="7259785">t</span>&nbsp;<span class="op" id="7259787">*</span><span class="ident" id="7259788">testing</span><span class="op" id="7259795">.</span><span class="ident" id="7259796">T</span><span class="op" id="7259797">)</span>&nbsp;<span class="op" id="7259799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7259802">//&nbsp;Ask&nbsp;for&nbsp;SIGHUP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259821">c</span>&nbsp;<span class="op" id="7259823">:=</span>&nbsp;<span class="builtinfunc" id="7259826">make</span><span class="op" id="7259830">(</span><span class="keyword" id="7259831">chan</span>&nbsp;<span class="ident" id="7259836">os</span><span class="op" id="7259838">.</span><span class="ident" id="7259839">Signal</span><span class="op" id="7259845">,</span>&nbsp;<span class="num" id="7259847">1</span><span class="op" id="7259848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259851">Notify</span><span class="op" id="7259857">(</span><span class="ident" id="7259858">c</span><span class="op" id="7259859">,</span>&nbsp;<span class="ident" id="7259861">syscall</span><span class="op" id="7259868">.</span><span class="ident" id="7259869">SIGHUP</span><span class="op" id="7259875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7259878">defer</span>&nbsp;<span class="ident" id="7259884">Stop</span><span class="op" id="7259888">(</span><span class="ident" id="7259889">c</span><span class="op" id="7259890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7259894">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGHUP</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259925">t</span><span class="op" id="7259926">.</span><span class="ident" id="7259927">Logf</span><span class="op" id="7259931">(</span><span class="string" id="7259932">&#34;sighup...&#34;</span><span class="op" id="7259943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259946">syscall</span><span class="op" id="7259953">.</span><span class="ident" id="7259954">Kill</span><span class="op" id="7259958">(</span><span class="ident" id="7259959">syscall</span><span class="op" id="7259966">.</span><span class="ident" id="7259967">Getpid</span><span class="op" id="7259973">(</span><span class="op" id="7259974">)</span><span class="op" id="7259975">,</span>&nbsp;<span class="ident" id="7259977">syscall</span><span class="op" id="7259984">.</span><span class="ident" id="7259985">SIGHUP</span><span class="op" id="7259991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7259994">waitSig</span><span class="op" id="7260001">(</span><span class="ident" id="7260002">t</span><span class="op" id="7260003">,</span>&nbsp;<span class="ident" id="7260005">c</span><span class="op" id="7260006">,</span>&nbsp;<span class="ident" id="7260008">syscall</span><span class="op" id="7260015">.</span><span class="ident" id="7260016">SIGHUP</span><span class="op" id="7260022">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7260026">//&nbsp;Ask&nbsp;for&nbsp;everything&nbsp;we&nbsp;can&nbsp;get.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260061">c1</span>&nbsp;<span class="op" id="7260064">:=</span>&nbsp;<span class="builtinfunc" id="7260067">make</span><span class="op" id="7260071">(</span><span class="keyword" id="7260072">chan</span>&nbsp;<span class="ident" id="7260077">os</span><span class="op" id="7260079">.</span><span class="ident" id="7260080">Signal</span><span class="op" id="7260086">,</span>&nbsp;<span class="num" id="7260088">1</span><span class="op" id="7260089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260092">Notify</span><span class="op" id="7260098">(</span><span class="ident" id="7260099">c1</span><span class="op" id="7260101">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7260105">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGWINCH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260138">t</span><span class="op" id="7260139">.</span><span class="ident" id="7260140">Logf</span><span class="op" id="7260144">(</span><span class="string" id="7260145">&#34;sigwinch...&#34;</span><span class="op" id="7260158">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260161">syscall</span><span class="op" id="7260168">.</span><span class="ident" id="7260169">Kill</span><span class="op" id="7260173">(</span><span class="ident" id="7260174">syscall</span><span class="op" id="7260181">.</span><span class="ident" id="7260182">Getpid</span><span class="op" id="7260188">(</span><span class="op" id="7260189">)</span><span class="op" id="7260190">,</span>&nbsp;<span class="ident" id="7260192">syscall</span><span class="op" id="7260199">.</span><span class="ident" id="7260200">SIGWINCH</span><span class="op" id="7260208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260211">waitSig</span><span class="op" id="7260218">(</span><span class="ident" id="7260219">t</span><span class="op" id="7260220">,</span>&nbsp;<span class="ident" id="7260222">c1</span><span class="op" id="7260224">,</span>&nbsp;<span class="ident" id="7260226">syscall</span><span class="op" id="7260233">.</span><span class="ident" id="7260234">SIGWINCH</span><span class="op" id="7260242">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7260246">//&nbsp;Send&nbsp;two&nbsp;more&nbsp;SIGHUPs,&nbsp;to&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7260291">//&nbsp;they&nbsp;get&nbsp;delivered&nbsp;on&nbsp;c1&nbsp;and&nbsp;that&nbsp;not&nbsp;reading</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7260341">//&nbsp;from&nbsp;c&nbsp;does&nbsp;not&nbsp;block&nbsp;everything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260379">t</span><span class="op" id="7260380">.</span><span class="ident" id="7260381">Logf</span><span class="op" id="7260385">(</span><span class="string" id="7260386">&#34;sighup...&#34;</span><span class="op" id="7260397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260400">syscall</span><span class="op" id="7260407">.</span><span class="ident" id="7260408">Kill</span><span class="op" id="7260412">(</span><span class="ident" id="7260413">syscall</span><span class="op" id="7260420">.</span><span class="ident" id="7260421">Getpid</span><span class="op" id="7260427">(</span><span class="op" id="7260428">)</span><span class="op" id="7260429">,</span>&nbsp;<span class="ident" id="7260431">syscall</span><span class="op" id="7260438">.</span><span class="ident" id="7260439">SIGHUP</span><span class="op" id="7260445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260448">waitSig</span><span class="op" id="7260455">(</span><span class="ident" id="7260456">t</span><span class="op" id="7260457">,</span>&nbsp;<span class="ident" id="7260459">c1</span><span class="op" id="7260461">,</span>&nbsp;<span class="ident" id="7260463">syscall</span><span class="op" id="7260470">.</span><span class="ident" id="7260471">SIGHUP</span><span class="op" id="7260477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260480">t</span><span class="op" id="7260481">.</span><span class="ident" id="7260482">Logf</span><span class="op" id="7260486">(</span><span class="string" id="7260487">&#34;sighup...&#34;</span><span class="op" id="7260498">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260501">syscall</span><span class="op" id="7260508">.</span><span class="ident" id="7260509">Kill</span><span class="op" id="7260513">(</span><span class="ident" id="7260514">syscall</span><span class="op" id="7260521">.</span><span class="ident" id="7260522">Getpid</span><span class="op" id="7260528">(</span><span class="op" id="7260529">)</span><span class="op" id="7260530">,</span>&nbsp;<span class="ident" id="7260532">syscall</span><span class="op" id="7260539">.</span><span class="ident" id="7260540">SIGHUP</span><span class="op" id="7260546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260549">waitSig</span><span class="op" id="7260556">(</span><span class="ident" id="7260557">t</span><span class="op" id="7260558">,</span>&nbsp;<span class="ident" id="7260560">c1</span><span class="op" id="7260562">,</span>&nbsp;<span class="ident" id="7260564">syscall</span><span class="op" id="7260571">.</span><span class="ident" id="7260572">SIGHUP</span><span class="op" id="7260578">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7260582">//&nbsp;The&nbsp;first&nbsp;SIGHUP&nbsp;should&nbsp;be&nbsp;waiting&nbsp;for&nbsp;us&nbsp;on&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260634">waitSig</span><span class="op" id="7260641">(</span><span class="ident" id="7260642">t</span><span class="op" id="7260643">,</span>&nbsp;<span class="ident" id="7260645">c</span><span class="op" id="7260646">,</span>&nbsp;<span class="ident" id="7260648">syscall</span><span class="op" id="7260655">.</span><span class="ident" id="7260656">SIGHUP</span><span class="op" id="7260662">)</span><br>
<span class="lineno">65</span><span class="op" id="7260664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7260667">func</span>&nbsp;<span class="ident" id="7260672">TestStress</span><span class="op" id="7260682">(</span><span class="ident" id="7260683">t</span>&nbsp;<span class="op" id="7260685">*</span><span class="ident" id="7260686">testing</span><span class="op" id="7260693">.</span><span class="ident" id="7260694">T</span><span class="op" id="7260695">)</span>&nbsp;<span class="op" id="7260697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260700">dur</span>&nbsp;<span class="op" id="7260704">:=</span>&nbsp;<span class="num" id="7260707">3</span>&nbsp;<span class="op" id="7260709">*</span>&nbsp;<span class="ident" id="7260711">time</span><span class="op" id="7260715">.</span><span class="ident" id="7260716">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260724">if</span>&nbsp;<span class="ident" id="7260727">testing</span><span class="op" id="7260734">.</span><span class="ident" id="7260735">Short</span><span class="op" id="7260740">(</span><span class="op" id="7260741">)</span>&nbsp;<span class="op" id="7260743">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260747">dur</span>&nbsp;<span class="op" id="7260751">=</span>&nbsp;<span class="num" id="7260753">100</span>&nbsp;<span class="op" id="7260757">*</span>&nbsp;<span class="ident" id="7260759">time</span><span class="op" id="7260763">.</span><span class="ident" id="7260764">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7260777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260780">defer</span>&nbsp;<span class="ident" id="7260786">runtime</span><span class="op" id="7260793">.</span><span class="ident" id="7260794">GOMAXPROCS</span><span class="op" id="7260804">(</span><span class="ident" id="7260805">runtime</span><span class="op" id="7260812">.</span><span class="ident" id="7260813">GOMAXPROCS</span><span class="op" id="7260823">(</span><span class="num" id="7260824">4</span><span class="op" id="7260825">)</span><span class="op" id="7260826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260829">done</span>&nbsp;<span class="op" id="7260834">:=</span>&nbsp;<span class="builtinfunc" id="7260837">make</span><span class="op" id="7260841">(</span><span class="keyword" id="7260842">chan</span>&nbsp;<span class="builtintype" id="7260847">bool</span><span class="op" id="7260851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260854">finished</span>&nbsp;<span class="op" id="7260863">:=</span>&nbsp;<span class="builtinfunc" id="7260866">make</span><span class="op" id="7260870">(</span><span class="keyword" id="7260871">chan</span>&nbsp;<span class="builtintype" id="7260876">bool</span><span class="op" id="7260880">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260883">go</span>&nbsp;<span class="keyword" id="7260886">func</span><span class="op" id="7260890">(</span><span class="op" id="7260891">)</span>&nbsp;<span class="op" id="7260893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260897">sig</span>&nbsp;<span class="op" id="7260901">:=</span>&nbsp;<span class="builtinfunc" id="7260904">make</span><span class="op" id="7260908">(</span><span class="keyword" id="7260909">chan</span>&nbsp;<span class="ident" id="7260914">os</span><span class="op" id="7260916">.</span><span class="ident" id="7260917">Signal</span><span class="op" id="7260923">,</span>&nbsp;<span class="num" id="7260925">1</span><span class="op" id="7260926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260930">Notify</span><span class="op" id="7260936">(</span><span class="ident" id="7260937">sig</span><span class="op" id="7260940">,</span>&nbsp;<span class="ident" id="7260942">syscall</span><span class="op" id="7260949">.</span><span class="ident" id="7260950">SIGUSR1</span><span class="op" id="7260957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260961">defer</span>&nbsp;<span class="ident" id="7260967">Stop</span><span class="op" id="7260971">(</span><span class="ident" id="7260972">sig</span><span class="op" id="7260975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7260978">Loop</span><span class="op" id="7260982">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260986">for</span>&nbsp;<span class="op" id="7260990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7260995">select</span>&nbsp;<span class="op" id="7261002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261007">case</span>&nbsp;<span class="op" id="7261012">&lt;-</span><span class="ident" id="7261014">sig</span><span class="op" id="7261017">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261022">case</span>&nbsp;<span class="op" id="7261027">&lt;-</span><span class="ident" id="7261029">done</span><span class="op" id="7261033">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261039">break</span>&nbsp;<span class="ident" id="7261045">Loop</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261061">finished</span>&nbsp;<span class="op" id="7261070">&lt;-</span>&nbsp;<span class="builtintype" id="7261073">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261079">}</span><span class="op" id="7261080">(</span><span class="op" id="7261081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261084">go</span>&nbsp;<span class="keyword" id="7261087">func</span><span class="op" id="7261091">(</span><span class="op" id="7261092">)</span>&nbsp;<span class="op" id="7261094">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261097">Loop</span><span class="op" id="7261101">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261105">for</span>&nbsp;<span class="op" id="7261109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261114">select</span>&nbsp;<span class="op" id="7261121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261126">case</span>&nbsp;<span class="op" id="7261131">&lt;-</span><span class="ident" id="7261133">done</span><span class="op" id="7261137">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261143">break</span>&nbsp;<span class="ident" id="7261149">Loop</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261157">default</span><span class="op" id="7261164">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261170">syscall</span><span class="op" id="7261177">.</span><span class="ident" id="7261178">Kill</span><span class="op" id="7261182">(</span><span class="ident" id="7261183">syscall</span><span class="op" id="7261190">.</span><span class="ident" id="7261191">Getpid</span><span class="op" id="7261197">(</span><span class="op" id="7261198">)</span><span class="op" id="7261199">,</span>&nbsp;<span class="ident" id="7261201">syscall</span><span class="op" id="7261208">.</span><span class="ident" id="7261209">SIGUSR1</span><span class="op" id="7261216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261222">runtime</span><span class="op" id="7261229">.</span><span class="ident" id="7261230">Gosched</span><span class="op" id="7261237">(</span><span class="op" id="7261238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261247">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261251">finished</span>&nbsp;<span class="op" id="7261260">&lt;-</span>&nbsp;<span class="builtintype" id="7261263">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261269">}</span><span class="op" id="7261270">(</span><span class="op" id="7261271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261274">time</span><span class="op" id="7261278">.</span><span class="ident" id="7261279">Sleep</span><span class="op" id="7261284">(</span><span class="ident" id="7261285">dur</span><span class="op" id="7261288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7261291">close</span><span class="op" id="7261296">(</span><span class="ident" id="7261297">done</span><span class="op" id="7261301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261304">&lt;-</span><span class="ident" id="7261306">finished</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261316">&lt;-</span><span class="ident" id="7261318">finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7261328">//&nbsp;When&nbsp;run&nbsp;with&nbsp;&#39;go&nbsp;test&nbsp;-cpu=1,2,4&#39;&nbsp;SIGUSR1&nbsp;from&nbsp;this&nbsp;test&nbsp;can&nbsp;slip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7261399">//&nbsp;into&nbsp;subsequent&nbsp;TestSignal()&nbsp;causing&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7261449">//&nbsp;Sleep&nbsp;for&nbsp;a&nbsp;while&nbsp;to&nbsp;reduce&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261513">time</span><span class="op" id="7261517">.</span><span class="ident" id="7261518">Sleep</span><span class="op" id="7261523">(</span><span class="num" id="7261524">10</span>&nbsp;<span class="op" id="7261527">*</span>&nbsp;<span class="ident" id="7261529">time</span><span class="op" id="7261533">.</span><span class="ident" id="7261534">Millisecond</span><span class="op" id="7261545">)</span><br>
<span class="lineno">110</span><span class="op" id="7261547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7261550">var</span>&nbsp;<span class="ident" id="7261554">sendUncaughtSighup</span>&nbsp;<span class="op" id="7261573">=</span>&nbsp;<span class="ident" id="7261575">flag</span><span class="op" id="7261579">.</span><span class="ident" id="7261580">Int</span><span class="op" id="7261583">(</span><span class="string" id="7261584">&#34;send_uncaught_sighup&#34;</span><span class="op" id="7261606">,</span>&nbsp;<span class="num" id="7261608">0</span><span class="op" id="7261609">,</span>&nbsp;<span class="string" id="7261611">&#34;send&nbsp;uncaught&nbsp;SIGHUP&nbsp;during&nbsp;TestStop&#34;</span><span class="op" id="7261649">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7261652">//&nbsp;Test&nbsp;that&nbsp;Stop&nbsp;cancels&nbsp;the&nbsp;channel&#39;s&nbsp;registrations.</span><br>
<span class="lineno">115</span><span class="keyword" id="7261707">func</span>&nbsp;<span class="ident" id="7261712">TestStop</span><span class="op" id="7261720">(</span><span class="ident" id="7261721">t</span>&nbsp;<span class="op" id="7261723">*</span><span class="ident" id="7261724">testing</span><span class="op" id="7261731">.</span><span class="ident" id="7261732">T</span><span class="op" id="7261733">)</span>&nbsp;<span class="op" id="7261735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261738">sigs</span>&nbsp;<span class="op" id="7261743">:=</span>&nbsp;<span class="op" id="7261746">[</span><span class="op" id="7261747">]</span><span class="ident" id="7261748">syscall</span><span class="op" id="7261755">.</span><span class="ident" id="7261756">Signal</span><span class="op" id="7261762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261766">syscall</span><span class="op" id="7261773">.</span><span class="ident" id="7261774">SIGWINCH</span><span class="op" id="7261782">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7261786">syscall</span><span class="op" id="7261793">.</span><span class="ident" id="7261794">SIGHUP</span><span class="op" id="7261800">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7261803">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261807">for</span>&nbsp;<span class="ident" id="7261811">_</span><span class="op" id="7261812">,</span>&nbsp;<span class="ident" id="7261814">sig</span>&nbsp;<span class="op" id="7261818">:=</span>&nbsp;<span class="keyword" id="7261821">range</span>&nbsp;<span class="ident" id="7261827">sigs</span>&nbsp;<span class="op" id="7261832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7261836">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7261858">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7261903">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7261974">if</span>&nbsp;<span class="ident" id="7261977">sig</span>&nbsp;<span class="op" id="7261981">!=</span>&nbsp;<span class="ident" id="7261984">syscall</span><span class="op" id="7261991">.</span><span class="ident" id="7261992">SIGHUP</span>&nbsp;<span class="op" id="7261999">||</span>&nbsp;<span class="op" id="7262002">*</span><span class="ident" id="7262003">sendUncaughtSighup</span>&nbsp;<span class="op" id="7262022">==</span>&nbsp;<span class="num" id="7262025">1</span>&nbsp;<span class="op" id="7262027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262032">syscall</span><span class="op" id="7262039">.</span><span class="ident" id="7262040">Kill</span><span class="op" id="7262044">(</span><span class="ident" id="7262045">syscall</span><span class="op" id="7262052">.</span><span class="ident" id="7262053">Getpid</span><span class="op" id="7262059">(</span><span class="op" id="7262060">)</span><span class="op" id="7262061">,</span>&nbsp;<span class="ident" id="7262063">sig</span><span class="op" id="7262066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7262070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262074">time</span><span class="op" id="7262078">.</span><span class="ident" id="7262079">Sleep</span><span class="op" id="7262084">(</span><span class="num" id="7262085">100</span>&nbsp;<span class="op" id="7262089">*</span>&nbsp;<span class="ident" id="7262091">time</span><span class="op" id="7262095">.</span><span class="ident" id="7262096">Millisecond</span><span class="op" id="7262107">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7262112">//&nbsp;Ask&nbsp;for&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262132">c</span>&nbsp;<span class="op" id="7262134">:=</span>&nbsp;<span class="builtinfunc" id="7262137">make</span><span class="op" id="7262141">(</span><span class="keyword" id="7262142">chan</span>&nbsp;<span class="ident" id="7262147">os</span><span class="op" id="7262149">.</span><span class="ident" id="7262150">Signal</span><span class="op" id="7262156">,</span>&nbsp;<span class="num" id="7262158">1</span><span class="op" id="7262159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262163">Notify</span><span class="op" id="7262169">(</span><span class="ident" id="7262170">c</span><span class="op" id="7262171">,</span>&nbsp;<span class="ident" id="7262173">sig</span><span class="op" id="7262176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262180">defer</span>&nbsp;<span class="ident" id="7262186">Stop</span><span class="op" id="7262190">(</span><span class="ident" id="7262191">c</span><span class="op" id="7262192">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7262197">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;that&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262232">syscall</span><span class="op" id="7262239">.</span><span class="ident" id="7262240">Kill</span><span class="op" id="7262244">(</span><span class="ident" id="7262245">syscall</span><span class="op" id="7262252">.</span><span class="ident" id="7262253">Getpid</span><span class="op" id="7262259">(</span><span class="op" id="7262260">)</span><span class="op" id="7262261">,</span>&nbsp;<span class="ident" id="7262263">sig</span><span class="op" id="7262266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262270">waitSig</span><span class="op" id="7262277">(</span><span class="ident" id="7262278">t</span><span class="op" id="7262279">,</span>&nbsp;<span class="ident" id="7262281">c</span><span class="op" id="7262282">,</span>&nbsp;<span class="ident" id="7262284">sig</span><span class="op" id="7262287">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262292">Stop</span><span class="op" id="7262296">(</span><span class="ident" id="7262297">c</span><span class="op" id="7262298">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262302">select</span>&nbsp;<span class="op" id="7262309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262313">case</span>&nbsp;<span class="ident" id="7262318">s</span>&nbsp;<span class="op" id="7262320">:=</span>&nbsp;<span class="op" id="7262323">&lt;-</span><span class="ident" id="7262325">c</span><span class="op" id="7262326">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262331">t</span><span class="op" id="7262332">.</span><span class="ident" id="7262333">Fatalf</span><span class="op" id="7262339">(</span><span class="string" id="7262340">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7262362">,</span>&nbsp;<span class="ident" id="7262364">s</span><span class="op" id="7262365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262369">case</span>&nbsp;<span class="op" id="7262374">&lt;-</span><span class="ident" id="7262376">time</span><span class="op" id="7262380">.</span><span class="ident" id="7262381">After</span><span class="op" id="7262386">(</span><span class="num" id="7262387">100</span>&nbsp;<span class="op" id="7262391">*</span>&nbsp;<span class="ident" id="7262393">time</span><span class="op" id="7262397">.</span><span class="ident" id="7262398">Millisecond</span><span class="op" id="7262409">)</span><span class="op" id="7262410">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7262415">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7262443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7262448">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7262470">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7262515">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262586">if</span>&nbsp;<span class="ident" id="7262589">sig</span>&nbsp;<span class="op" id="7262593">!=</span>&nbsp;<span class="ident" id="7262596">syscall</span><span class="op" id="7262603">.</span><span class="ident" id="7262604">SIGHUP</span>&nbsp;<span class="op" id="7262611">||</span>&nbsp;<span class="op" id="7262614">*</span><span class="ident" id="7262615">sendUncaughtSighup</span>&nbsp;<span class="op" id="7262634">==</span>&nbsp;<span class="num" id="7262637">2</span>&nbsp;<span class="op" id="7262639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262644">syscall</span><span class="op" id="7262651">.</span><span class="ident" id="7262652">Kill</span><span class="op" id="7262656">(</span><span class="ident" id="7262657">syscall</span><span class="op" id="7262664">.</span><span class="ident" id="7262665">Getpid</span><span class="op" id="7262671">(</span><span class="op" id="7262672">)</span><span class="op" id="7262673">,</span>&nbsp;<span class="ident" id="7262675">sig</span><span class="op" id="7262678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7262682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262687">select</span>&nbsp;<span class="op" id="7262694">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262698">case</span>&nbsp;<span class="ident" id="7262703">s</span>&nbsp;<span class="op" id="7262705">:=</span>&nbsp;<span class="op" id="7262708">&lt;-</span><span class="ident" id="7262710">c</span><span class="op" id="7262711">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7262716">t</span><span class="op" id="7262717">.</span><span class="ident" id="7262718">Fatalf</span><span class="op" id="7262724">(</span><span class="string" id="7262725">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7262747">,</span>&nbsp;<span class="ident" id="7262749">s</span><span class="op" id="7262750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7262754">case</span>&nbsp;<span class="op" id="7262759">&lt;-</span><span class="ident" id="7262761">time</span><span class="op" id="7262765">.</span><span class="ident" id="7262766">After</span><span class="op" id="7262771">(</span><span class="num" id="7262772">100</span>&nbsp;<span class="op" id="7262776">*</span>&nbsp;<span class="ident" id="7262778">time</span><span class="op" id="7262782">.</span><span class="ident" id="7262783">Millisecond</span><span class="op" id="7262794">)</span><span class="op" id="7262795">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7262800">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7262828">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7262831">}</span><br>
<span class="lineno"></span><span class="op" id="7262833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7262836">//&nbsp;Test&nbsp;that&nbsp;when&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;an&nbsp;uncaught&nbsp;SIGHUP&nbsp;does&nbsp;not&nbsp;kill&nbsp;the&nbsp;program,</span><br>
<span class="lineno"></span><span class="comment" id="7262917">//&nbsp;but&nbsp;a</span><br>
<span class="lineno">165</span><span class="keyword" id="7262926">func</span>&nbsp;<span class="ident" id="7262931">TestNohup</span><span class="op" id="7262940">(</span><span class="ident" id="7262941">t</span>&nbsp;<span class="op" id="7262943">*</span><span class="ident" id="7262944">testing</span><span class="op" id="7262951">.</span><span class="ident" id="7262952">T</span><span class="op" id="7262953">)</span>&nbsp;<span class="op" id="7262955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7262958">//&nbsp;Ugly:&nbsp;ask&nbsp;for&nbsp;SIGHUP&nbsp;so&nbsp;that&nbsp;child&nbsp;will&nbsp;not&nbsp;have&nbsp;no-hup&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263022">//&nbsp;even&nbsp;if&nbsp;test&nbsp;is&nbsp;running&nbsp;under&nbsp;nohup&nbsp;environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263075">//&nbsp;We&nbsp;have&nbsp;no&nbsp;intention&nbsp;of&nbsp;reading&nbsp;from&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7263119">c</span>&nbsp;<span class="op" id="7263121">:=</span>&nbsp;<span class="builtinfunc" id="7263124">make</span><span class="op" id="7263128">(</span><span class="keyword" id="7263129">chan</span>&nbsp;<span class="ident" id="7263134">os</span><span class="op" id="7263136">.</span><span class="ident" id="7263137">Signal</span><span class="op" id="7263143">,</span>&nbsp;<span class="num" id="7263145">1</span><span class="op" id="7263146">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7263149">Notify</span><span class="op" id="7263155">(</span><span class="ident" id="7263156">c</span><span class="op" id="7263157">,</span>&nbsp;<span class="ident" id="7263159">syscall</span><span class="op" id="7263166">.</span><span class="ident" id="7263167">SIGHUP</span><span class="op" id="7263173">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263177">//&nbsp;When&nbsp;run&nbsp;without&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;crash&nbsp;on&nbsp;an&nbsp;uncaught&nbsp;SIGHUP.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263250">//&nbsp;When&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;ignore&nbsp;uncaught&nbsp;SIGHUPs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263317">//&nbsp;because&nbsp;the&nbsp;runtime&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;listening&nbsp;for&nbsp;them.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263383">//&nbsp;Either&nbsp;way,&nbsp;TestStop&nbsp;should&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;catch&nbsp;them&nbsp;when&nbsp;it&nbsp;wants&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263462">//&nbsp;and&nbsp;then&nbsp;when&nbsp;it&nbsp;stops&nbsp;wanting&nbsp;them,&nbsp;the&nbsp;original&nbsp;behavior&nbsp;should&nbsp;resume.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263540">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263544">//&nbsp;send_uncaught_sighup=1&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;before&nbsp;starting&nbsp;to&nbsp;listen&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263627">//&nbsp;send_uncaught_sighup=2&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;after&nbsp;no&nbsp;longer&nbsp;listening&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263710">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7263714">//&nbsp;Both&nbsp;should&nbsp;fail&nbsp;without&nbsp;nohup&nbsp;and&nbsp;succeed&nbsp;with&nbsp;nohup.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7263774">for</span>&nbsp;<span class="ident" id="7263778">i</span>&nbsp;<span class="op" id="7263780">:=</span>&nbsp;<span class="num" id="7263783">1</span><span class="op" id="7263784">;</span>&nbsp;<span class="ident" id="7263786">i</span>&nbsp;<span class="op" id="7263788">&lt;=</span>&nbsp;<span class="num" id="7263791">2</span><span class="op" id="7263792">;</span>&nbsp;<span class="ident" id="7263794">i</span><span class="op" id="7263795">++</span>&nbsp;<span class="op" id="7263798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7263802">out</span><span class="op" id="7263805">,</span>&nbsp;<span class="ident" id="7263807">err</span>&nbsp;<span class="op" id="7263811">:=</span>&nbsp;<span class="ident" id="7263814">exec</span><span class="op" id="7263818">.</span><span class="ident" id="7263819">Command</span><span class="op" id="7263826">(</span><span class="ident" id="7263827">os</span><span class="op" id="7263829">.</span><span class="ident" id="7263830">Args</span><span class="op" id="7263834">[</span><span class="num" id="7263835">0</span><span class="op" id="7263836">]</span><span class="op" id="7263837">,</span>&nbsp;<span class="string" id="7263839">&#34;-test.run=TestStop&#34;</span><span class="op" id="7263859">,</span>&nbsp;<span class="string" id="7263861">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7263885">+</span><span class="ident" id="7263886">strconv</span><span class="op" id="7263893">.</span><span class="ident" id="7263894">Itoa</span><span class="op" id="7263898">(</span><span class="ident" id="7263899">i</span><span class="op" id="7263900">)</span><span class="op" id="7263901">)</span><span class="op" id="7263902">.</span><span class="ident" id="7263903">CombinedOutput</span><span class="op" id="7263917">(</span><span class="op" id="7263918">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7263922">if</span>&nbsp;<span class="ident" id="7263925">err</span>&nbsp;<span class="op" id="7263929">==</span>&nbsp;<span class="ident" id="7263932">nil</span>&nbsp;<span class="op" id="7263936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7263941">t</span><span class="op" id="7263942">.</span><span class="ident" id="7263943">Fatalf</span><span class="op" id="7263949">(</span><span class="string" id="7263950">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;and&nbsp;it&nbsp;succeeded:&nbsp;expected&nbsp;failure.\nOutput:\n%s&#34;</span><span class="op" id="7264039">,</span>&nbsp;<span class="ident" id="7264041">i</span><span class="op" id="7264042">,</span>&nbsp;<span class="ident" id="7264044">out</span><span class="op" id="7264047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7264051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7264054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264058">Stop</span><span class="op" id="7264062">(</span><span class="ident" id="7264063">c</span><span class="op" id="7264064">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7264068">//&nbsp;Again,&nbsp;this&nbsp;time&nbsp;with&nbsp;nohup,&nbsp;assuming&nbsp;we&nbsp;can&nbsp;find&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264126">_</span><span class="op" id="7264127">,</span>&nbsp;<span class="ident" id="7264129">err</span>&nbsp;<span class="op" id="7264133">:=</span>&nbsp;<span class="ident" id="7264136">os</span><span class="op" id="7264138">.</span><span class="ident" id="7264139">Stat</span><span class="op" id="7264143">(</span><span class="string" id="7264144">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7264160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7264163">if</span>&nbsp;<span class="ident" id="7264166">err</span>&nbsp;<span class="op" id="7264170">!=</span>&nbsp;<span class="ident" id="7264173">nil</span>&nbsp;<span class="op" id="7264177">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264181">t</span><span class="op" id="7264182">.</span><span class="ident" id="7264183">Skip</span><span class="op" id="7264187">(</span><span class="string" id="7264188">&#34;cannot&nbsp;find&nbsp;nohup;&nbsp;skipping&nbsp;second&nbsp;half&nbsp;of&nbsp;test&#34;</span><span class="op" id="7264237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7264240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7264244">for</span>&nbsp;<span class="ident" id="7264248">i</span>&nbsp;<span class="op" id="7264250">:=</span>&nbsp;<span class="num" id="7264253">1</span><span class="op" id="7264254">;</span>&nbsp;<span class="ident" id="7264256">i</span>&nbsp;<span class="op" id="7264258">&lt;=</span>&nbsp;<span class="num" id="7264261">2</span><span class="op" id="7264262">;</span>&nbsp;<span class="ident" id="7264264">i</span><span class="op" id="7264265">++</span>&nbsp;<span class="op" id="7264268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264272">os</span><span class="op" id="7264274">.</span><span class="ident" id="7264275">Remove</span><span class="op" id="7264281">(</span><span class="string" id="7264282">&#34;nohup.out&#34;</span><span class="op" id="7264293">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264297">out</span><span class="op" id="7264300">,</span>&nbsp;<span class="ident" id="7264302">err</span>&nbsp;<span class="op" id="7264306">:=</span>&nbsp;<span class="ident" id="7264309">exec</span><span class="op" id="7264313">.</span><span class="ident" id="7264314">Command</span><span class="op" id="7264321">(</span><span class="string" id="7264322">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7264338">,</span>&nbsp;<span class="ident" id="7264340">os</span><span class="op" id="7264342">.</span><span class="ident" id="7264343">Args</span><span class="op" id="7264347">[</span><span class="num" id="7264348">0</span><span class="op" id="7264349">]</span><span class="op" id="7264350">,</span>&nbsp;<span class="string" id="7264352">&#34;-test.run=TestStop&#34;</span><span class="op" id="7264372">,</span>&nbsp;<span class="string" id="7264374">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7264398">+</span><span class="ident" id="7264399">strconv</span><span class="op" id="7264406">.</span><span class="ident" id="7264407">Itoa</span><span class="op" id="7264411">(</span><span class="ident" id="7264412">i</span><span class="op" id="7264413">)</span><span class="op" id="7264414">)</span><span class="op" id="7264415">.</span><span class="ident" id="7264416">CombinedOutput</span><span class="op" id="7264430">(</span><span class="op" id="7264431">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264436">data</span><span class="op" id="7264440">,</span>&nbsp;<span class="ident" id="7264442">_</span>&nbsp;<span class="op" id="7264444">:=</span>&nbsp;<span class="ident" id="7264447">ioutil</span><span class="op" id="7264453">.</span><span class="ident" id="7264454">ReadFile</span><span class="op" id="7264462">(</span><span class="string" id="7264463">&#34;nohup.out&#34;</span><span class="op" id="7264474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264478">os</span><span class="op" id="7264480">.</span><span class="ident" id="7264481">Remove</span><span class="op" id="7264487">(</span><span class="string" id="7264488">&#34;nohup.out&#34;</span><span class="op" id="7264499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7264503">if</span>&nbsp;<span class="ident" id="7264506">err</span>&nbsp;<span class="op" id="7264510">!=</span>&nbsp;<span class="ident" id="7264513">nil</span>&nbsp;<span class="op" id="7264517">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7264522">t</span><span class="op" id="7264523">.</span><span class="ident" id="7264524">Fatalf</span><span class="op" id="7264530">(</span><span class="string" id="7264531">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;under&nbsp;nohup&nbsp;and&nbsp;it&nbsp;failed:&nbsp;expected&nbsp;success.\nError:&nbsp;%v\nOutput:\n%s%s&#34;</span><span class="op" id="7264642">,</span>&nbsp;<span class="ident" id="7264644">i</span><span class="op" id="7264645">,</span>&nbsp;<span class="ident" id="7264647">err</span><span class="op" id="7264650">,</span>&nbsp;<span class="ident" id="7264652">out</span><span class="op" id="7264655">,</span>&nbsp;<span class="ident" id="7264657">data</span><span class="op" id="7264661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7264665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7264668">}</span><br>
<span class="lineno"></span><span class="op" id="7264670">}</span>
</div>
</body>
</html>
