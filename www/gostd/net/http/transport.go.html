<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html" class="current">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1509109">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1509164">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1509218">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1509269">//&nbsp;HTTP&nbsp;client&nbsp;implementation.&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="comment" id="1509314">//</span><br>
<span class="lineno"></span><span class="comment" id="1509317">//&nbsp;This&nbsp;is&nbsp;the&nbsp;low-level&nbsp;Transport&nbsp;implementation&nbsp;of&nbsp;RoundTripper.</span><br>
<span class="lineno"></span><span class="comment" id="1509384">//&nbsp;The&nbsp;high-level&nbsp;interface&nbsp;is&nbsp;in&nbsp;client.go.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1509430">package</span>&nbsp;<span class="ident" id="1509438">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1509444">import</span>&nbsp;<span class="op" id="1509451">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1509454">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1509463">&#34;compress/gzip&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1509480">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1509494">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1509504">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1509511">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1509517">&#34;log&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1509524">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1509531">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1509542">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1509548">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1509559">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1509567">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="1509574">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1509577">//&nbsp;DefaultTransport&nbsp;is&nbsp;the&nbsp;default&nbsp;implementation&nbsp;of&nbsp;Transport&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1509647">//&nbsp;used&nbsp;by&nbsp;DefaultClient.&nbsp;It&nbsp;establishes&nbsp;network&nbsp;connections&nbsp;as&nbsp;needed</span><br>
<span class="lineno">30</span><span class="comment" id="1509718">//&nbsp;and&nbsp;caches&nbsp;them&nbsp;for&nbsp;reuse&nbsp;by&nbsp;subsequent&nbsp;calls.&nbsp;It&nbsp;uses&nbsp;HTTP&nbsp;proxies</span><br>
<span class="lineno"></span><span class="comment" id="1509789">//&nbsp;as&nbsp;directed&nbsp;by&nbsp;the&nbsp;$HTTP_PROXY&nbsp;and&nbsp;$NO_PROXY&nbsp;(or&nbsp;$http_proxy&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1509857">//&nbsp;$no_proxy)&nbsp;environment&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="1509894">var</span>&nbsp;<span class="ident" id="1509898">DefaultTransport</span>&nbsp;<span class="ident" id="1509915">RoundTripper</span>&nbsp;<span class="op" id="1509928">=</span>&nbsp;<span class="op" id="1509930">&amp;</span><span class="ident" id="1509931">Transport</span><span class="op" id="1509940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509943">Proxy</span><span class="op" id="1509948">:</span>&nbsp;<span class="ident" id="1509950">ProxyFromEnvironment</span><span class="op" id="1509970">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509973">Dial</span><span class="op" id="1509977">:</span>&nbsp;<span class="op" id="1509979">(</span><span class="op" id="1509980">&amp;</span><span class="ident" id="1509981">net</span><span class="op" id="1509984">.</span><span class="ident" id="1509985">Dialer</span><span class="op" id="1509991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509995">Timeout</span><span class="op" id="1510002">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="1510006">30</span>&nbsp;<span class="op" id="1510009">*</span>&nbsp;<span class="ident" id="1510011">time</span><span class="op" id="1510015">.</span><span class="ident" id="1510016">Second</span><span class="op" id="1510022">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510026">KeepAlive</span><span class="op" id="1510035">:</span>&nbsp;<span class="num" id="1510037">30</span>&nbsp;<span class="op" id="1510040">*</span>&nbsp;<span class="ident" id="1510042">time</span><span class="op" id="1510046">.</span><span class="ident" id="1510047">Second</span><span class="op" id="1510053">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1510056">}</span><span class="op" id="1510057">)</span><span class="op" id="1510058">.</span><span class="ident" id="1510059">Dial</span><span class="op" id="1510063">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510066">TLSHandshakeTimeout</span><span class="op" id="1510085">:</span>&nbsp;<span class="num" id="1510087">10</span>&nbsp;<span class="op" id="1510090">*</span>&nbsp;<span class="ident" id="1510092">time</span><span class="op" id="1510096">.</span><span class="ident" id="1510097">Second</span><span class="op" id="1510103">,</span><br>
<span class="lineno">40</span><span class="op" id="1510105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1510108">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;the&nbsp;default&nbsp;value&nbsp;of&nbsp;Transport&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="1510174">//&nbsp;MaxIdleConnsPerHost.</span><br>
<span class="lineno"></span><span class="keyword" id="1510198">const</span>&nbsp;<span class="ident" id="1510204">DefaultMaxIdleConnsPerHost</span>&nbsp;<span class="op" id="1510231">=</span>&nbsp;<span class="num" id="1510233">2</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="1510236">//&nbsp;Transport&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;RoundTripper&nbsp;that&nbsp;supports&nbsp;HTTP,</span><br>
<span class="lineno"></span><span class="comment" id="1510306">//&nbsp;HTTPS,&nbsp;and&nbsp;HTTP&nbsp;proxies&nbsp;(for&nbsp;either&nbsp;HTTP&nbsp;or&nbsp;HTTPS&nbsp;with&nbsp;CONNECT).</span><br>
<span class="lineno"></span><span class="comment" id="1510374">//&nbsp;Transport&nbsp;can&nbsp;also&nbsp;cache&nbsp;connections&nbsp;for&nbsp;future&nbsp;re-use.</span><br>
<span class="lineno"></span><span class="keyword" id="1510433">type</span>&nbsp;<span class="ident" id="1510438">Transport</span>&nbsp;<span class="keyword" id="1510448">struct</span>&nbsp;<span class="op" id="1510455">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510458">idleMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510469">sync</span><span class="op" id="1510473">.</span><span class="ident" id="1510474">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510481">wantIdle</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1510492">bool</span>&nbsp;<span class="comment" id="1510497">//&nbsp;user&nbsp;has&nbsp;requested&nbsp;to&nbsp;close&nbsp;all&nbsp;idle&nbsp;conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510544">idleConn</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="1510555">map</span><span class="op" id="1510558">[</span><span class="ident" id="1510559">connectMethodKey</span><span class="op" id="1510575">]</span><span class="op" id="1510576">[</span><span class="op" id="1510577">]</span><span class="op" id="1510578">*</span><span class="ident" id="1510579">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510592">idleConnCh</span>&nbsp;<span class="keyword" id="1510603">map</span><span class="op" id="1510606">[</span><span class="ident" id="1510607">connectMethodKey</span><span class="op" id="1510623">]</span><span class="keyword" id="1510624">chan</span>&nbsp;<span class="op" id="1510629">*</span><span class="ident" id="1510630">persistConn</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510644">reqMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510656">sync</span><span class="op" id="1510660">.</span><span class="ident" id="1510661">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510668">reqCanceler</span>&nbsp;<span class="keyword" id="1510680">map</span><span class="op" id="1510683">[</span><span class="op" id="1510684">*</span><span class="ident" id="1510685">Request</span><span class="op" id="1510692">]</span><span class="keyword" id="1510693">func</span><span class="op" id="1510697">(</span><span class="op" id="1510698">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510702">altMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1510711">sync</span><span class="op" id="1510715">.</span><span class="ident" id="1510716">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510725">altProto</span>&nbsp;<span class="keyword" id="1510734">map</span><span class="op" id="1510737">[</span><span class="builtintype" id="1510738">string</span><span class="op" id="1510744">]</span><span class="ident" id="1510745">RoundTripper</span>&nbsp;<span class="comment" id="1510758">//&nbsp;nil&nbsp;or&nbsp;map&nbsp;of&nbsp;URI&nbsp;scheme&nbsp;=&gt;&nbsp;RoundTripper</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510804">//&nbsp;Proxy&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;return&nbsp;a&nbsp;proxy&nbsp;for&nbsp;a&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510865">//&nbsp;Request.&nbsp;If&nbsp;the&nbsp;function&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510923">//&nbsp;request&nbsp;is&nbsp;aborted&nbsp;with&nbsp;the&nbsp;provided&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1510971">//&nbsp;If&nbsp;Proxy&nbsp;is&nbsp;nil&nbsp;or&nbsp;returns&nbsp;a&nbsp;nil&nbsp;*URL,&nbsp;no&nbsp;proxy&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511032">Proxy</span>&nbsp;<span class="keyword" id="1511038">func</span><span class="op" id="1511042">(</span><span class="op" id="1511043">*</span><span class="ident" id="1511044">Request</span><span class="op" id="1511051">)</span>&nbsp;<span class="op" id="1511053">(</span><span class="op" id="1511054">*</span><span class="ident" id="1511055">url</span><span class="op" id="1511058">.</span><span class="ident" id="1511059">URL</span><span class="op" id="1511062">,</span>&nbsp;<span class="builtintype" id="1511064">error</span><span class="op" id="1511069">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511073">//&nbsp;Dial&nbsp;specifies&nbsp;the&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating&nbsp;unencrypted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511135">//&nbsp;TCP&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511156">//&nbsp;If&nbsp;Dial&nbsp;is&nbsp;nil,&nbsp;net.Dial&nbsp;is&nbsp;used.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511194">Dial</span>&nbsp;<span class="keyword" id="1511199">func</span><span class="op" id="1511203">(</span><span class="ident" id="1511204">network</span><span class="op" id="1511211">,</span>&nbsp;<span class="ident" id="1511213">addr</span>&nbsp;<span class="builtintype" id="1511218">string</span><span class="op" id="1511224">)</span>&nbsp;<span class="op" id="1511226">(</span><span class="ident" id="1511227">net</span><span class="op" id="1511230">.</span><span class="ident" id="1511231">Conn</span><span class="op" id="1511235">,</span>&nbsp;<span class="builtintype" id="1511237">error</span><span class="op" id="1511242">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511246">//&nbsp;DialTLS&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511307">//&nbsp;TLS&nbsp;connections&nbsp;for&nbsp;non-proxied&nbsp;HTTPS&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511359">//</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511363">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;nil,&nbsp;Dial&nbsp;and&nbsp;TLSClientConfig&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511421">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511425">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;set,&nbsp;the&nbsp;Dial&nbsp;hook&nbsp;is&nbsp;not&nbsp;used&nbsp;for&nbsp;HTTPS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511484">//&nbsp;requests&nbsp;and&nbsp;the&nbsp;TLSClientConfig&nbsp;and&nbsp;TLSHandshakeTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511545">//&nbsp;are&nbsp;ignored.&nbsp;The&nbsp;returned&nbsp;net.Conn&nbsp;is&nbsp;assumed&nbsp;to&nbsp;already&nbsp;be</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511609">//&nbsp;past&nbsp;the&nbsp;TLS&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511637">DialTLS</span>&nbsp;<span class="keyword" id="1511645">func</span><span class="op" id="1511649">(</span><span class="ident" id="1511650">network</span><span class="op" id="1511657">,</span>&nbsp;<span class="ident" id="1511659">addr</span>&nbsp;<span class="builtintype" id="1511664">string</span><span class="op" id="1511670">)</span>&nbsp;<span class="op" id="1511672">(</span><span class="ident" id="1511673">net</span><span class="op" id="1511676">.</span><span class="ident" id="1511677">Conn</span><span class="op" id="1511681">,</span>&nbsp;<span class="builtintype" id="1511683">error</span><span class="op" id="1511688">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511692">//&nbsp;TLSClientConfig&nbsp;specifies&nbsp;the&nbsp;TLS&nbsp;configuration&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511756">//&nbsp;tls.Client.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;default&nbsp;configuration&nbsp;is&nbsp;used.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511815">TLSClientConfig</span>&nbsp;<span class="op" id="1511831">*</span><span class="ident" id="1511832">tls</span><span class="op" id="1511835">.</span><span class="ident" id="1511836">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511845">//&nbsp;TLSHandshakeTimeout&nbsp;specifies&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;time&nbsp;waiting&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1511917">//&nbsp;wait&nbsp;for&nbsp;a&nbsp;TLS&nbsp;handshake.&nbsp;Zero&nbsp;means&nbsp;no&nbsp;timeout.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1511970">TLSHandshakeTimeout</span>&nbsp;<span class="ident" id="1511990">time</span><span class="op" id="1511994">.</span><span class="ident" id="1511995">Duration</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512006">//&nbsp;DisableKeepAlives,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;re-use&nbsp;of&nbsp;TCP&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512073">//&nbsp;between&nbsp;different&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512110">DisableKeepAlives</span>&nbsp;<span class="builtintype" id="1512128">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512135">//&nbsp;DisableCompression,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;the&nbsp;Transport&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512196">//&nbsp;requesting&nbsp;compression&nbsp;with&nbsp;an&nbsp;&#34;Accept-Encoding:&nbsp;gzip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512255">//&nbsp;request&nbsp;header&nbsp;when&nbsp;the&nbsp;Request&nbsp;contains&nbsp;no&nbsp;existing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512312">//&nbsp;Accept-Encoding&nbsp;value.&nbsp;If&nbsp;the&nbsp;Transport&nbsp;requests&nbsp;gzip&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512373">//&nbsp;its&nbsp;own&nbsp;and&nbsp;gets&nbsp;a&nbsp;gzipped&nbsp;response,&nbsp;it&#39;s&nbsp;transparently</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512433">//&nbsp;decoded&nbsp;in&nbsp;the&nbsp;Response.Body.&nbsp;However,&nbsp;if&nbsp;the&nbsp;user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512488">//&nbsp;explicitly&nbsp;requested&nbsp;gzip&nbsp;it&nbsp;is&nbsp;not&nbsp;automatically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512542">//&nbsp;uncompressed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512560">DisableCompression</span>&nbsp;<span class="builtintype" id="1512579">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512586">//&nbsp;MaxIdleConnsPerHost,&nbsp;if&nbsp;non-zero,&nbsp;controls&nbsp;the&nbsp;maximum&nbsp;idle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512650">//&nbsp;(keep-alive)&nbsp;to&nbsp;keep&nbsp;per-host.&nbsp;&nbsp;If&nbsp;zero,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512695">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1512735">MaxIdleConnsPerHost</span>&nbsp;<span class="builtintype" id="1512755">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512761">//&nbsp;ResponseHeaderTimeout,&nbsp;if&nbsp;non-zero,&nbsp;specifies&nbsp;the&nbsp;amount&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512825">//&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;a&nbsp;server&#39;s&nbsp;response&nbsp;headers&nbsp;after&nbsp;fully</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512886">//&nbsp;writing&nbsp;the&nbsp;request&nbsp;(including&nbsp;its&nbsp;body,&nbsp;if&nbsp;any).&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1512945">//&nbsp;time&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;time&nbsp;to&nbsp;read&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1513007">ResponseHeaderTimeout</span>&nbsp;<span class="ident" id="1513029">time</span><span class="op" id="1513033">.</span><span class="ident" id="1513034">Duration</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513045">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;global&nbsp;max&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1513096">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;timeout&nbsp;on&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span><span class="op" id="1513146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="1513149">//&nbsp;ProxyFromEnvironment&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;proxy&nbsp;to&nbsp;use&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1513215">//&nbsp;given&nbsp;request,&nbsp;as&nbsp;indicated&nbsp;by&nbsp;the&nbsp;environment&nbsp;variables</span><br>
<span class="lineno"></span><span class="comment" id="1513275">//&nbsp;HTTP_PROXY,&nbsp;HTTPS_PROXY&nbsp;and&nbsp;NO_PROXY&nbsp;(or&nbsp;the&nbsp;lowercase&nbsp;versions</span><br>
<span class="lineno"></span><span class="comment" id="1513342">//&nbsp;thereof).&nbsp;HTTPS_PROXY&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;HTTP_PROXY&nbsp;for&nbsp;https</span><br>
<span class="lineno"></span><span class="comment" id="1513410">//&nbsp;requests.</span><br>
<span class="lineno">125</span><span class="comment" id="1513423">//</span><br>
<span class="lineno"></span><span class="comment" id="1513426">//&nbsp;The&nbsp;environment&nbsp;values&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;complete&nbsp;URL&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1513486">//&nbsp;&#34;host[:port]&#34;,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;&#34;http&#34;&nbsp;scheme&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="1513548">//&nbsp;An&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;a&nbsp;different&nbsp;form.</span><br>
<span class="lineno"></span><span class="comment" id="1513606">//</span><br>
<span class="lineno">130</span><span class="comment" id="1513609">//&nbsp;A&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;are&nbsp;returned&nbsp;if&nbsp;no&nbsp;proxy&nbsp;is&nbsp;defined&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1513679">//&nbsp;environment,&nbsp;or&nbsp;a&nbsp;proxy&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="1513748">//&nbsp;as&nbsp;defined&nbsp;by&nbsp;NO_PROXY.</span><br>
<span class="lineno"></span><span class="comment" id="1513775">//</span><br>
<span class="lineno"></span><span class="comment" id="1513778">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;req.URL.Host&nbsp;is&nbsp;&#34;localhost&#34;&nbsp;(with&nbsp;or&nbsp;without</span><br>
<span class="lineno">135</span><span class="comment" id="1513848">//&nbsp;a&nbsp;port&nbsp;number),&nbsp;then&nbsp;a&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="1513914">func</span>&nbsp;<span class="ident" id="1513919">ProxyFromEnvironment</span><span class="op" id="1513939">(</span><span class="ident" id="1513940">req</span>&nbsp;<span class="op" id="1513944">*</span><span class="ident" id="1513945">Request</span><span class="op" id="1513952">)</span>&nbsp;<span class="op" id="1513954">(</span><span class="op" id="1513955">*</span><span class="ident" id="1513956">url</span><span class="op" id="1513959">.</span><span class="ident" id="1513960">URL</span><span class="op" id="1513963">,</span>&nbsp;<span class="builtintype" id="1513965">error</span><span class="op" id="1513970">)</span>&nbsp;<span class="op" id="1513972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513975">var</span>&nbsp;<span class="ident" id="1513979">proxy</span>&nbsp;<span class="builtintype" id="1513985">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1513993">if</span>&nbsp;<span class="ident" id="1513996">req</span><span class="op" id="1513999">.</span><span class="ident" id="1514000">URL</span><span class="op" id="1514003">.</span><span class="ident" id="1514004">Scheme</span>&nbsp;<span class="op" id="1514011">==</span>&nbsp;<span class="string" id="1514014">&#34;https&#34;</span>&nbsp;<span class="op" id="1514022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514026">proxy</span>&nbsp;<span class="op" id="1514032">=</span>&nbsp;<span class="ident" id="1514034">httpsProxyEnv</span><span class="op" id="1514047">.</span><span class="ident" id="1514048">Get</span><span class="op" id="1514051">(</span><span class="op" id="1514052">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514058">if</span>&nbsp;<span class="ident" id="1514061">proxy</span>&nbsp;<span class="op" id="1514067">==</span>&nbsp;<span class="string" id="1514070">&#34;&#34;</span>&nbsp;<span class="op" id="1514073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514077">proxy</span>&nbsp;<span class="op" id="1514083">=</span>&nbsp;<span class="ident" id="1514085">httpProxyEnv</span><span class="op" id="1514097">.</span><span class="ident" id="1514098">Get</span><span class="op" id="1514101">(</span><span class="op" id="1514102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514108">if</span>&nbsp;<span class="ident" id="1514111">proxy</span>&nbsp;<span class="op" id="1514117">==</span>&nbsp;<span class="string" id="1514120">&#34;&#34;</span>&nbsp;<span class="op" id="1514123">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514127">return</span>&nbsp;<span class="ident" id="1514134">nil</span><span class="op" id="1514137">,</span>&nbsp;<span class="ident" id="1514139">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514147">if</span>&nbsp;<span class="op" id="1514150">!</span><span class="ident" id="1514151">useProxy</span><span class="op" id="1514159">(</span><span class="ident" id="1514160">canonicalAddr</span><span class="op" id="1514173">(</span><span class="ident" id="1514174">req</span><span class="op" id="1514177">.</span><span class="ident" id="1514178">URL</span><span class="op" id="1514181">)</span><span class="op" id="1514182">)</span>&nbsp;<span class="op" id="1514184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514188">return</span>&nbsp;<span class="ident" id="1514195">nil</span><span class="op" id="1514198">,</span>&nbsp;<span class="ident" id="1514200">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514205">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1514208">proxyURL</span><span class="op" id="1514216">,</span>&nbsp;<span class="ident" id="1514218">err</span>&nbsp;<span class="op" id="1514222">:=</span>&nbsp;<span class="ident" id="1514225">url</span><span class="op" id="1514228">.</span><span class="ident" id="1514229">Parse</span><span class="op" id="1514234">(</span><span class="ident" id="1514235">proxy</span><span class="op" id="1514240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514243">if</span>&nbsp;<span class="ident" id="1514246">err</span>&nbsp;<span class="op" id="1514250">!=</span>&nbsp;<span class="ident" id="1514253">nil</span>&nbsp;<span class="op" id="1514257">||</span>&nbsp;<span class="op" id="1514260">!</span><span class="ident" id="1514261">strings</span><span class="op" id="1514268">.</span><span class="ident" id="1514269">HasPrefix</span><span class="op" id="1514278">(</span><span class="ident" id="1514279">proxyURL</span><span class="op" id="1514287">.</span><span class="ident" id="1514288">Scheme</span><span class="op" id="1514294">,</span>&nbsp;<span class="string" id="1514296">&#34;http&#34;</span><span class="op" id="1514302">)</span>&nbsp;<span class="op" id="1514304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514308">//&nbsp;proxy&nbsp;was&nbsp;bogus.&nbsp;Try&nbsp;prepending&nbsp;&#34;http://&#34;&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514365">//&nbsp;see&nbsp;if&nbsp;that&nbsp;parses&nbsp;correctly.&nbsp;If&nbsp;not,&nbsp;we&nbsp;fall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1514416">//&nbsp;through&nbsp;and&nbsp;complain&nbsp;about&nbsp;the&nbsp;original&nbsp;one.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514466">if</span>&nbsp;<span class="ident" id="1514469">proxyURL</span><span class="op" id="1514477">,</span>&nbsp;<span class="ident" id="1514479">err</span>&nbsp;<span class="op" id="1514483">:=</span>&nbsp;<span class="ident" id="1514486">url</span><span class="op" id="1514489">.</span><span class="ident" id="1514490">Parse</span><span class="op" id="1514495">(</span><span class="string" id="1514496">&#34;http://&#34;</span>&nbsp;<span class="op" id="1514506">+</span>&nbsp;<span class="ident" id="1514508">proxy</span><span class="op" id="1514513">)</span><span class="op" id="1514514">;</span>&nbsp;<span class="ident" id="1514516">err</span>&nbsp;<span class="op" id="1514520">==</span>&nbsp;<span class="ident" id="1514523">nil</span>&nbsp;<span class="op" id="1514527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514532">return</span>&nbsp;<span class="ident" id="1514539">proxyURL</span><span class="op" id="1514547">,</span>&nbsp;<span class="ident" id="1514549">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514561">if</span>&nbsp;<span class="ident" id="1514564">err</span>&nbsp;<span class="op" id="1514568">!=</span>&nbsp;<span class="ident" id="1514571">nil</span>&nbsp;<span class="op" id="1514575">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514579">return</span>&nbsp;<span class="ident" id="1514586">nil</span><span class="op" id="1514589">,</span>&nbsp;<span class="ident" id="1514591">fmt</span><span class="op" id="1514594">.</span><span class="ident" id="1514595">Errorf</span><span class="op" id="1514601">(</span><span class="string" id="1514602">&#34;invalid&nbsp;proxy&nbsp;address&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="1514632">,</span>&nbsp;<span class="ident" id="1514634">proxy</span><span class="op" id="1514639">,</span>&nbsp;<span class="ident" id="1514641">err</span><span class="op" id="1514644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514650">return</span>&nbsp;<span class="ident" id="1514657">proxyURL</span><span class="op" id="1514665">,</span>&nbsp;<span class="ident" id="1514667">nil</span><br>
<span class="lineno"></span><span class="op" id="1514671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="1514674">//&nbsp;ProxyURL&nbsp;returns&nbsp;a&nbsp;proxy&nbsp;function&nbsp;(for&nbsp;use&nbsp;in&nbsp;a&nbsp;Transport)</span><br>
<span class="lineno"></span><span class="comment" id="1514736">//&nbsp;that&nbsp;always&nbsp;returns&nbsp;the&nbsp;same&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="1514773">func</span>&nbsp;<span class="ident" id="1514778">ProxyURL</span><span class="op" id="1514786">(</span><span class="ident" id="1514787">fixedURL</span>&nbsp;<span class="op" id="1514796">*</span><span class="ident" id="1514797">url</span><span class="op" id="1514800">.</span><span class="ident" id="1514801">URL</span><span class="op" id="1514804">)</span>&nbsp;<span class="keyword" id="1514806">func</span><span class="op" id="1514810">(</span><span class="op" id="1514811">*</span><span class="ident" id="1514812">Request</span><span class="op" id="1514819">)</span>&nbsp;<span class="op" id="1514821">(</span><span class="op" id="1514822">*</span><span class="ident" id="1514823">url</span><span class="op" id="1514826">.</span><span class="ident" id="1514827">URL</span><span class="op" id="1514830">,</span>&nbsp;<span class="builtintype" id="1514832">error</span><span class="op" id="1514837">)</span>&nbsp;<span class="op" id="1514839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514842">return</span>&nbsp;<span class="keyword" id="1514849">func</span><span class="op" id="1514853">(</span><span class="op" id="1514854">*</span><span class="ident" id="1514855">Request</span><span class="op" id="1514862">)</span>&nbsp;<span class="op" id="1514864">(</span><span class="op" id="1514865">*</span><span class="ident" id="1514866">url</span><span class="op" id="1514869">.</span><span class="ident" id="1514870">URL</span><span class="op" id="1514873">,</span>&nbsp;<span class="builtintype" id="1514875">error</span><span class="op" id="1514880">)</span>&nbsp;<span class="op" id="1514882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1514886">return</span>&nbsp;<span class="ident" id="1514893">fixedURL</span><span class="op" id="1514901">,</span>&nbsp;<span class="ident" id="1514903">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1514908">}</span><br>
<span class="lineno"></span><span class="op" id="1514910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1514913">//&nbsp;transportRequest&nbsp;is&nbsp;a&nbsp;wrapper&nbsp;around&nbsp;a&nbsp;*Request&nbsp;that&nbsp;adds</span><br>
<span class="lineno"></span><span class="comment" id="1514974">//&nbsp;optional&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write.</span><br>
<span class="lineno">175</span><span class="keyword" id="1515010">type</span>&nbsp;<span class="ident" id="1515015">transportRequest</span>&nbsp;<span class="keyword" id="1515032">struct</span>&nbsp;<span class="op" id="1515039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515042">*</span><span class="ident" id="1515043">Request</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1515058">//&nbsp;original&nbsp;request,&nbsp;not&nbsp;to&nbsp;be&nbsp;mutated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515098">extra</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1515107">Header</span>&nbsp;<span class="comment" id="1515114">//&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write,&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="1515148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="1515151">func</span>&nbsp;<span class="op" id="1515156">(</span><span class="ident" id="1515157">tr</span>&nbsp;<span class="op" id="1515160">*</span><span class="ident" id="1515161">transportRequest</span><span class="op" id="1515177">)</span>&nbsp;<span class="ident" id="1515179">extraHeaders</span><span class="op" id="1515191">(</span><span class="op" id="1515192">)</span>&nbsp;<span class="ident" id="1515194">Header</span>&nbsp;<span class="op" id="1515201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515204">if</span>&nbsp;<span class="ident" id="1515207">tr</span><span class="op" id="1515209">.</span><span class="ident" id="1515210">extra</span>&nbsp;<span class="op" id="1515216">==</span>&nbsp;<span class="ident" id="1515219">nil</span>&nbsp;<span class="op" id="1515223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515227">tr</span><span class="op" id="1515229">.</span><span class="ident" id="1515230">extra</span>&nbsp;<span class="op" id="1515236">=</span>&nbsp;<span class="builtinfunc" id="1515238">make</span><span class="op" id="1515242">(</span><span class="ident" id="1515243">Header</span><span class="op" id="1515249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515255">return</span>&nbsp;<span class="ident" id="1515262">tr</span><span class="op" id="1515264">.</span><span class="ident" id="1515265">extra</span><br>
<span class="lineno">185</span><span class="op" id="1515271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1515274">//&nbsp;RoundTrip&nbsp;implements&nbsp;the&nbsp;RoundTripper&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="1515326">//</span><br>
<span class="lineno"></span><span class="comment" id="1515329">//&nbsp;For&nbsp;higher-level&nbsp;HTTP&nbsp;client&nbsp;support&nbsp;(such&nbsp;as&nbsp;handling&nbsp;of&nbsp;cookies</span><br>
<span class="lineno">190</span><span class="comment" id="1515398">//&nbsp;and&nbsp;redirects),&nbsp;see&nbsp;Get,&nbsp;Post,&nbsp;and&nbsp;the&nbsp;Client&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="1515453">func</span>&nbsp;<span class="op" id="1515458">(</span><span class="ident" id="1515459">t</span>&nbsp;<span class="op" id="1515461">*</span><span class="ident" id="1515462">Transport</span><span class="op" id="1515471">)</span>&nbsp;<span class="ident" id="1515473">RoundTrip</span><span class="op" id="1515482">(</span><span class="ident" id="1515483">req</span>&nbsp;<span class="op" id="1515487">*</span><span class="ident" id="1515488">Request</span><span class="op" id="1515495">)</span>&nbsp;<span class="op" id="1515497">(</span><span class="ident" id="1515498">resp</span>&nbsp;<span class="op" id="1515503">*</span><span class="ident" id="1515504">Response</span><span class="op" id="1515512">,</span>&nbsp;<span class="ident" id="1515514">err</span>&nbsp;<span class="builtintype" id="1515518">error</span><span class="op" id="1515523">)</span>&nbsp;<span class="op" id="1515525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515528">if</span>&nbsp;<span class="ident" id="1515531">req</span><span class="op" id="1515534">.</span><span class="ident" id="1515535">URL</span>&nbsp;<span class="op" id="1515539">==</span>&nbsp;<span class="ident" id="1515542">nil</span>&nbsp;<span class="op" id="1515546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515550">req</span><span class="op" id="1515553">.</span><span class="ident" id="1515554">closeBody</span><span class="op" id="1515563">(</span><span class="op" id="1515564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515568">return</span>&nbsp;<span class="ident" id="1515575">nil</span><span class="op" id="1515578">,</span>&nbsp;<span class="ident" id="1515580">errors</span><span class="op" id="1515586">.</span><span class="ident" id="1515587">New</span><span class="op" id="1515590">(</span><span class="string" id="1515591">&#34;http:&nbsp;nil&nbsp;Request.URL&#34;</span><span class="op" id="1515614">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515620">if</span>&nbsp;<span class="ident" id="1515623">req</span><span class="op" id="1515626">.</span><span class="ident" id="1515627">Header</span>&nbsp;<span class="op" id="1515634">==</span>&nbsp;<span class="ident" id="1515637">nil</span>&nbsp;<span class="op" id="1515641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515645">req</span><span class="op" id="1515648">.</span><span class="ident" id="1515649">closeBody</span><span class="op" id="1515658">(</span><span class="op" id="1515659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515663">return</span>&nbsp;<span class="ident" id="1515670">nil</span><span class="op" id="1515673">,</span>&nbsp;<span class="ident" id="1515675">errors</span><span class="op" id="1515681">.</span><span class="ident" id="1515682">New</span><span class="op" id="1515685">(</span><span class="string" id="1515686">&#34;http:&nbsp;nil&nbsp;Request.Header&#34;</span><span class="op" id="1515712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515715">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515718">if</span>&nbsp;<span class="ident" id="1515721">req</span><span class="op" id="1515724">.</span><span class="ident" id="1515725">URL</span><span class="op" id="1515728">.</span><span class="ident" id="1515729">Scheme</span>&nbsp;<span class="op" id="1515736">!=</span>&nbsp;<span class="string" id="1515739">&#34;http&#34;</span>&nbsp;<span class="op" id="1515746">&amp;&amp;</span>&nbsp;<span class="ident" id="1515749">req</span><span class="op" id="1515752">.</span><span class="ident" id="1515753">URL</span><span class="op" id="1515756">.</span><span class="ident" id="1515757">Scheme</span>&nbsp;<span class="op" id="1515764">!=</span>&nbsp;<span class="string" id="1515767">&#34;https&#34;</span>&nbsp;<span class="op" id="1515775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515779">t</span><span class="op" id="1515780">.</span><span class="ident" id="1515781">altMu</span><span class="op" id="1515786">.</span><span class="ident" id="1515787">RLock</span><span class="op" id="1515792">(</span><span class="op" id="1515793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515797">var</span>&nbsp;<span class="ident" id="1515801">rt</span>&nbsp;<span class="ident" id="1515804">RoundTripper</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515819">if</span>&nbsp;<span class="ident" id="1515822">t</span><span class="op" id="1515823">.</span><span class="ident" id="1515824">altProto</span>&nbsp;<span class="op" id="1515833">!=</span>&nbsp;<span class="ident" id="1515836">nil</span>&nbsp;<span class="op" id="1515840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515845">rt</span>&nbsp;<span class="op" id="1515848">=</span>&nbsp;<span class="ident" id="1515850">t</span><span class="op" id="1515851">.</span><span class="ident" id="1515852">altProto</span><span class="op" id="1515860">[</span><span class="ident" id="1515861">req</span><span class="op" id="1515864">.</span><span class="ident" id="1515865">URL</span><span class="op" id="1515868">.</span><span class="ident" id="1515869">Scheme</span><span class="op" id="1515875">]</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1515879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515883">t</span><span class="op" id="1515884">.</span><span class="ident" id="1515885">altMu</span><span class="op" id="1515890">.</span><span class="ident" id="1515891">RUnlock</span><span class="op" id="1515898">(</span><span class="op" id="1515899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515903">if</span>&nbsp;<span class="ident" id="1515906">rt</span>&nbsp;<span class="op" id="1515909">==</span>&nbsp;<span class="ident" id="1515912">nil</span>&nbsp;<span class="op" id="1515916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1515921">req</span><span class="op" id="1515924">.</span><span class="ident" id="1515925">closeBody</span><span class="op" id="1515934">(</span><span class="op" id="1515935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1515940">return</span>&nbsp;<span class="ident" id="1515947">nil</span><span class="op" id="1515950">,</span>&nbsp;<span class="op" id="1515952">&amp;</span><span class="ident" id="1515953">badStringError</span><span class="op" id="1515967">{</span><span class="string" id="1515968">&#34;unsupported&nbsp;protocol&nbsp;scheme&#34;</span><span class="op" id="1515997">,</span>&nbsp;<span class="ident" id="1515999">req</span><span class="op" id="1516002">.</span><span class="ident" id="1516003">URL</span><span class="op" id="1516006">.</span><span class="ident" id="1516007">Scheme</span><span class="op" id="1516013">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516021">return</span>&nbsp;<span class="ident" id="1516028">rt</span><span class="op" id="1516030">.</span><span class="ident" id="1516031">RoundTrip</span><span class="op" id="1516040">(</span><span class="ident" id="1516041">req</span><span class="op" id="1516044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516050">if</span>&nbsp;<span class="ident" id="1516053">req</span><span class="op" id="1516056">.</span><span class="ident" id="1516057">URL</span><span class="op" id="1516060">.</span><span class="ident" id="1516061">Host</span>&nbsp;<span class="op" id="1516066">==</span>&nbsp;<span class="string" id="1516069">&#34;&#34;</span>&nbsp;<span class="op" id="1516072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516076">req</span><span class="op" id="1516079">.</span><span class="ident" id="1516080">closeBody</span><span class="op" id="1516089">(</span><span class="op" id="1516090">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516094">return</span>&nbsp;<span class="ident" id="1516101">nil</span><span class="op" id="1516104">,</span>&nbsp;<span class="ident" id="1516106">errors</span><span class="op" id="1516112">.</span><span class="ident" id="1516113">New</span><span class="op" id="1516116">(</span><span class="string" id="1516117">&#34;http:&nbsp;no&nbsp;Host&nbsp;in&nbsp;request&nbsp;URL&#34;</span><span class="op" id="1516147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516153">treq</span>&nbsp;<span class="op" id="1516158">:=</span>&nbsp;<span class="op" id="1516161">&amp;</span><span class="ident" id="1516162">transportRequest</span><span class="op" id="1516178">{</span><span class="ident" id="1516179">Request</span><span class="op" id="1516186">:</span>&nbsp;<span class="ident" id="1516188">req</span><span class="op" id="1516191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516194">cm</span><span class="op" id="1516196">,</span>&nbsp;<span class="ident" id="1516198">err</span>&nbsp;<span class="op" id="1516202">:=</span>&nbsp;<span class="ident" id="1516205">t</span><span class="op" id="1516206">.</span><span class="ident" id="1516207">connectMethodForRequest</span><span class="op" id="1516230">(</span><span class="ident" id="1516231">treq</span><span class="op" id="1516235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516238">if</span>&nbsp;<span class="ident" id="1516241">err</span>&nbsp;<span class="op" id="1516245">!=</span>&nbsp;<span class="ident" id="1516248">nil</span>&nbsp;<span class="op" id="1516252">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516256">req</span><span class="op" id="1516259">.</span><span class="ident" id="1516260">closeBody</span><span class="op" id="1516269">(</span><span class="op" id="1516270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516274">return</span>&nbsp;<span class="ident" id="1516281">nil</span><span class="op" id="1516284">,</span>&nbsp;<span class="ident" id="1516286">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516295">//&nbsp;Get&nbsp;the&nbsp;cached&nbsp;or&nbsp;newly-created&nbsp;connection&nbsp;to&nbsp;either&nbsp;the</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516356">//&nbsp;host&nbsp;(for&nbsp;http&nbsp;or&nbsp;https),&nbsp;the&nbsp;http&nbsp;proxy,&nbsp;or&nbsp;the&nbsp;http&nbsp;proxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516420">//&nbsp;pre-CONNECTed&nbsp;to&nbsp;https&nbsp;server.&nbsp;&nbsp;In&nbsp;any&nbsp;case,&nbsp;we&#39;ll&nbsp;be&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1516484">//&nbsp;to&nbsp;send&nbsp;it&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516509">pconn</span><span class="op" id="1516514">,</span>&nbsp;<span class="ident" id="1516516">err</span>&nbsp;<span class="op" id="1516520">:=</span>&nbsp;<span class="ident" id="1516523">t</span><span class="op" id="1516524">.</span><span class="ident" id="1516525">getConn</span><span class="op" id="1516532">(</span><span class="ident" id="1516533">req</span><span class="op" id="1516536">,</span>&nbsp;<span class="ident" id="1516538">cm</span><span class="op" id="1516540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516543">if</span>&nbsp;<span class="ident" id="1516546">err</span>&nbsp;<span class="op" id="1516550">!=</span>&nbsp;<span class="ident" id="1516553">nil</span>&nbsp;<span class="op" id="1516557">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516561">t</span><span class="op" id="1516562">.</span><span class="ident" id="1516563">setReqCanceler</span><span class="op" id="1516577">(</span><span class="ident" id="1516578">req</span><span class="op" id="1516581">,</span>&nbsp;<span class="ident" id="1516583">nil</span><span class="op" id="1516586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1516590">req</span><span class="op" id="1516593">.</span><span class="ident" id="1516594">closeBody</span><span class="op" id="1516603">(</span><span class="op" id="1516604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516608">return</span>&nbsp;<span class="ident" id="1516615">nil</span><span class="op" id="1516618">,</span>&nbsp;<span class="ident" id="1516620">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1516625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1516629">return</span>&nbsp;<span class="ident" id="1516636">pconn</span><span class="op" id="1516641">.</span><span class="ident" id="1516642">roundTrip</span><span class="op" id="1516651">(</span><span class="ident" id="1516652">treq</span><span class="op" id="1516656">)</span><br>
<span class="lineno"></span><span class="op" id="1516658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1516661">//&nbsp;RegisterProtocol&nbsp;registers&nbsp;a&nbsp;new&nbsp;protocol&nbsp;with&nbsp;scheme.</span><br>
<span class="lineno"></span><span class="comment" id="1516719">//&nbsp;The&nbsp;Transport&nbsp;will&nbsp;pass&nbsp;requests&nbsp;using&nbsp;the&nbsp;given&nbsp;scheme&nbsp;to&nbsp;rt.</span><br>
<span class="lineno">240</span><span class="comment" id="1516785">//&nbsp;It&nbsp;is&nbsp;rt&#39;s&nbsp;responsibility&nbsp;to&nbsp;simulate&nbsp;HTTP&nbsp;request&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="1516850">//</span><br>
<span class="lineno"></span><span class="comment" id="1516853">//&nbsp;RegisterProtocol&nbsp;can&nbsp;be&nbsp;used&nbsp;by&nbsp;other&nbsp;packages&nbsp;to&nbsp;provide</span><br>
<span class="lineno"></span><span class="comment" id="1516914">//&nbsp;implementations&nbsp;of&nbsp;protocol&nbsp;schemes&nbsp;like&nbsp;&#34;ftp&#34;&nbsp;or&nbsp;&#34;file&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="1516975">func</span>&nbsp;<span class="op" id="1516980">(</span><span class="ident" id="1516981">t</span>&nbsp;<span class="op" id="1516983">*</span><span class="ident" id="1516984">Transport</span><span class="op" id="1516993">)</span>&nbsp;<span class="ident" id="1516995">RegisterProtocol</span><span class="op" id="1517011">(</span><span class="ident" id="1517012">scheme</span>&nbsp;<span class="builtintype" id="1517019">string</span><span class="op" id="1517025">,</span>&nbsp;<span class="ident" id="1517027">rt</span>&nbsp;<span class="ident" id="1517030">RoundTripper</span><span class="op" id="1517042">)</span>&nbsp;<span class="op" id="1517044">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517047">if</span>&nbsp;<span class="ident" id="1517050">scheme</span>&nbsp;<span class="op" id="1517057">==</span>&nbsp;<span class="string" id="1517060">&#34;http&#34;</span>&nbsp;<span class="op" id="1517067">||</span>&nbsp;<span class="ident" id="1517070">scheme</span>&nbsp;<span class="op" id="1517077">==</span>&nbsp;<span class="string" id="1517080">&#34;https&#34;</span>&nbsp;<span class="op" id="1517088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1517092">panic</span><span class="op" id="1517097">(</span><span class="string" id="1517098">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="1517110">+</span>&nbsp;<span class="ident" id="1517112">scheme</span>&nbsp;<span class="op" id="1517119">+</span>&nbsp;<span class="string" id="1517121">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="1517142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517148">t</span><span class="op" id="1517149">.</span><span class="ident" id="1517150">altMu</span><span class="op" id="1517155">.</span><span class="ident" id="1517156">Lock</span><span class="op" id="1517160">(</span><span class="op" id="1517161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517164">defer</span>&nbsp;<span class="ident" id="1517170">t</span><span class="op" id="1517171">.</span><span class="ident" id="1517172">altMu</span><span class="op" id="1517177">.</span><span class="ident" id="1517178">Unlock</span><span class="op" id="1517184">(</span><span class="op" id="1517185">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517188">if</span>&nbsp;<span class="ident" id="1517191">t</span><span class="op" id="1517192">.</span><span class="ident" id="1517193">altProto</span>&nbsp;<span class="op" id="1517202">==</span>&nbsp;<span class="ident" id="1517205">nil</span>&nbsp;<span class="op" id="1517209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517213">t</span><span class="op" id="1517214">.</span><span class="ident" id="1517215">altProto</span>&nbsp;<span class="op" id="1517224">=</span>&nbsp;<span class="builtinfunc" id="1517226">make</span><span class="op" id="1517230">(</span><span class="keyword" id="1517231">map</span><span class="op" id="1517234">[</span><span class="builtintype" id="1517235">string</span><span class="op" id="1517241">]</span><span class="ident" id="1517242">RoundTripper</span><span class="op" id="1517254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517260">if</span>&nbsp;<span class="ident" id="1517263">_</span><span class="op" id="1517264">,</span>&nbsp;<span class="ident" id="1517266">exists</span>&nbsp;<span class="op" id="1517273">:=</span>&nbsp;<span class="ident" id="1517276">t</span><span class="op" id="1517277">.</span><span class="ident" id="1517278">altProto</span><span class="op" id="1517286">[</span><span class="ident" id="1517287">scheme</span><span class="op" id="1517293">]</span><span class="op" id="1517294">;</span>&nbsp;<span class="ident" id="1517296">exists</span>&nbsp;<span class="op" id="1517303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1517307">panic</span><span class="op" id="1517312">(</span><span class="string" id="1517313">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="1517325">+</span>&nbsp;<span class="ident" id="1517327">scheme</span>&nbsp;<span class="op" id="1517334">+</span>&nbsp;<span class="string" id="1517336">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="1517357">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517363">t</span><span class="op" id="1517364">.</span><span class="ident" id="1517365">altProto</span><span class="op" id="1517373">[</span><span class="ident" id="1517374">scheme</span><span class="op" id="1517380">]</span>&nbsp;<span class="op" id="1517382">=</span>&nbsp;<span class="ident" id="1517384">rt</span><br>
<span class="lineno"></span><span class="op" id="1517387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1517390">//&nbsp;CloseIdleConnections&nbsp;closes&nbsp;any&nbsp;connections&nbsp;which&nbsp;were&nbsp;previously</span><br>
<span class="lineno">260</span><span class="comment" id="1517459">//&nbsp;connected&nbsp;from&nbsp;previous&nbsp;requests&nbsp;but&nbsp;are&nbsp;now&nbsp;sitting&nbsp;idle&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1517523">//&nbsp;a&nbsp;&#34;keep-alive&#34;&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;interrupt&nbsp;any&nbsp;connections&nbsp;currently</span><br>
<span class="lineno"></span><span class="comment" id="1517596">//&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="1517607">func</span>&nbsp;<span class="op" id="1517612">(</span><span class="ident" id="1517613">t</span>&nbsp;<span class="op" id="1517615">*</span><span class="ident" id="1517616">Transport</span><span class="op" id="1517625">)</span>&nbsp;<span class="ident" id="1517627">CloseIdleConnections</span><span class="op" id="1517647">(</span><span class="op" id="1517648">)</span>&nbsp;<span class="op" id="1517650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517653">t</span><span class="op" id="1517654">.</span><span class="ident" id="1517655">idleMu</span><span class="op" id="1517661">.</span><span class="ident" id="1517662">Lock</span><span class="op" id="1517666">(</span><span class="op" id="1517667">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517670">m</span>&nbsp;<span class="op" id="1517672">:=</span>&nbsp;<span class="ident" id="1517675">t</span><span class="op" id="1517676">.</span><span class="ident" id="1517677">idleConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517687">t</span><span class="op" id="1517688">.</span><span class="ident" id="1517689">idleConn</span>&nbsp;<span class="op" id="1517698">=</span>&nbsp;<span class="ident" id="1517700">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517705">t</span><span class="op" id="1517706">.</span><span class="ident" id="1517707">idleConnCh</span>&nbsp;<span class="op" id="1517718">=</span>&nbsp;<span class="ident" id="1517720">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517725">t</span><span class="op" id="1517726">.</span><span class="ident" id="1517727">wantIdle</span>&nbsp;<span class="op" id="1517736">=</span>&nbsp;<span class="builtintype" id="1517738">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517744">t</span><span class="op" id="1517745">.</span><span class="ident" id="1517746">idleMu</span><span class="op" id="1517752">.</span><span class="ident" id="1517753">Unlock</span><span class="op" id="1517759">(</span><span class="op" id="1517760">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517763">for</span>&nbsp;<span class="ident" id="1517767">_</span><span class="op" id="1517768">,</span>&nbsp;<span class="ident" id="1517770">conns</span>&nbsp;<span class="op" id="1517776">:=</span>&nbsp;<span class="keyword" id="1517779">range</span>&nbsp;<span class="ident" id="1517785">m</span>&nbsp;<span class="op" id="1517787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1517791">for</span>&nbsp;<span class="ident" id="1517795">_</span><span class="op" id="1517796">,</span>&nbsp;<span class="ident" id="1517798">pconn</span>&nbsp;<span class="op" id="1517804">:=</span>&nbsp;<span class="keyword" id="1517807">range</span>&nbsp;<span class="ident" id="1517813">conns</span>&nbsp;<span class="op" id="1517819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517824">pconn</span><span class="op" id="1517829">.</span><span class="builtinfunc" id="1517830">close</span><span class="op" id="1517835">(</span><span class="op" id="1517836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1517843">}</span><br>
<span class="lineno">275</span><span class="op" id="1517845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1517848">//&nbsp;CancelRequest&nbsp;cancels&nbsp;an&nbsp;in-flight&nbsp;request&nbsp;by&nbsp;closing&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="1517909">//&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="1517924">func</span>&nbsp;<span class="op" id="1517929">(</span><span class="ident" id="1517930">t</span>&nbsp;<span class="op" id="1517932">*</span><span class="ident" id="1517933">Transport</span><span class="op" id="1517942">)</span>&nbsp;<span class="ident" id="1517944">CancelRequest</span><span class="op" id="1517957">(</span><span class="ident" id="1517958">req</span>&nbsp;<span class="op" id="1517962">*</span><span class="ident" id="1517963">Request</span><span class="op" id="1517970">)</span>&nbsp;<span class="op" id="1517972">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517975">t</span><span class="op" id="1517976">.</span><span class="ident" id="1517977">reqMu</span><span class="op" id="1517982">.</span><span class="ident" id="1517983">Lock</span><span class="op" id="1517987">(</span><span class="op" id="1517988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1517991">cancel</span>&nbsp;<span class="op" id="1517998">:=</span>&nbsp;<span class="ident" id="1518001">t</span><span class="op" id="1518002">.</span><span class="ident" id="1518003">reqCanceler</span><span class="op" id="1518014">[</span><span class="ident" id="1518015">req</span><span class="op" id="1518018">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518021">t</span><span class="op" id="1518022">.</span><span class="ident" id="1518023">reqMu</span><span class="op" id="1518028">.</span><span class="ident" id="1518029">Unlock</span><span class="op" id="1518035">(</span><span class="op" id="1518036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518039">if</span>&nbsp;<span class="ident" id="1518042">cancel</span>&nbsp;<span class="op" id="1518049">!=</span>&nbsp;<span class="ident" id="1518052">nil</span>&nbsp;<span class="op" id="1518056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518060">cancel</span><span class="op" id="1518066">(</span><span class="op" id="1518067">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518070">}</span><br>
<span class="lineno"></span><span class="op" id="1518072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1518075">//</span><br>
<span class="lineno"></span><span class="comment" id="1518078">//&nbsp;Private&nbsp;implementation&nbsp;past&nbsp;this&nbsp;point.</span><br>
<span class="lineno">290</span><span class="comment" id="1518121">//</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1518125">var</span>&nbsp;<span class="op" id="1518129">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518132">httpProxyEnv</span>&nbsp;<span class="op" id="1518145">=</span>&nbsp;<span class="op" id="1518147">&amp;</span><span class="ident" id="1518148">envOnce</span><span class="op" id="1518155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518159">names</span><span class="op" id="1518164">:</span>&nbsp;<span class="op" id="1518166">[</span><span class="op" id="1518167">]</span><span class="builtintype" id="1518168">string</span><span class="op" id="1518174">{</span><span class="string" id="1518175">&#34;HTTP_PROXY&#34;</span><span class="op" id="1518187">,</span>&nbsp;<span class="string" id="1518189">&#34;http_proxy&#34;</span><span class="op" id="1518201">}</span><span class="op" id="1518202">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518208">httpsProxyEnv</span>&nbsp;<span class="op" id="1518222">=</span>&nbsp;<span class="op" id="1518224">&amp;</span><span class="ident" id="1518225">envOnce</span><span class="op" id="1518232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518236">names</span><span class="op" id="1518241">:</span>&nbsp;<span class="op" id="1518243">[</span><span class="op" id="1518244">]</span><span class="builtintype" id="1518245">string</span><span class="op" id="1518251">{</span><span class="string" id="1518252">&#34;HTTPS_PROXY&#34;</span><span class="op" id="1518265">,</span>&nbsp;<span class="string" id="1518267">&#34;https_proxy&#34;</span><span class="op" id="1518280">}</span><span class="op" id="1518281">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518287">noProxyEnv</span>&nbsp;<span class="op" id="1518298">=</span>&nbsp;<span class="op" id="1518300">&amp;</span><span class="ident" id="1518301">envOnce</span><span class="op" id="1518308">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518312">names</span><span class="op" id="1518317">:</span>&nbsp;<span class="op" id="1518319">[</span><span class="op" id="1518320">]</span><span class="builtintype" id="1518321">string</span><span class="op" id="1518327">{</span><span class="string" id="1518328">&#34;NO_PROXY&#34;</span><span class="op" id="1518338">,</span>&nbsp;<span class="string" id="1518340">&#34;no_proxy&#34;</span><span class="op" id="1518350">}</span><span class="op" id="1518351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518354">}</span><br>
<span class="lineno"></span><span class="op" id="1518356">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1518359">//&nbsp;envOnce&nbsp;looks&nbsp;up&nbsp;an&nbsp;environment&nbsp;variable&nbsp;(optionally&nbsp;by&nbsp;multiple</span><br>
<span class="lineno">305</span><span class="comment" id="1518427">//&nbsp;names)&nbsp;once.&nbsp;It&nbsp;mitigates&nbsp;expensive&nbsp;lookups&nbsp;on&nbsp;some&nbsp;platforms</span><br>
<span class="lineno"></span><span class="comment" id="1518492">//&nbsp;(e.g.&nbsp;Windows).</span><br>
<span class="lineno"></span><span class="keyword" id="1518511">type</span>&nbsp;<span class="ident" id="1518516">envOnce</span>&nbsp;<span class="keyword" id="1518524">struct</span>&nbsp;<span class="op" id="1518531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518534">names</span>&nbsp;<span class="op" id="1518540">[</span><span class="op" id="1518541">]</span><span class="builtintype" id="1518542">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518550">once</span>&nbsp;&nbsp;<span class="ident" id="1518556">sync</span><span class="op" id="1518560">.</span><span class="ident" id="1518561">Once</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518567">val</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1518573">string</span><br>
<span class="lineno"></span><span class="op" id="1518580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1518583">func</span>&nbsp;<span class="op" id="1518588">(</span><span class="ident" id="1518589">e</span>&nbsp;<span class="op" id="1518591">*</span><span class="ident" id="1518592">envOnce</span><span class="op" id="1518599">)</span>&nbsp;<span class="ident" id="1518601">Get</span><span class="op" id="1518604">(</span><span class="op" id="1518605">)</span>&nbsp;<span class="builtintype" id="1518607">string</span>&nbsp;<span class="op" id="1518614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518617">e</span><span class="op" id="1518618">.</span><span class="ident" id="1518619">once</span><span class="op" id="1518623">.</span><span class="ident" id="1518624">Do</span><span class="op" id="1518626">(</span><span class="ident" id="1518627">e</span><span class="op" id="1518628">.</span><span class="ident" id="1518629">init</span><span class="op" id="1518633">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518636">return</span>&nbsp;<span class="ident" id="1518643">e</span><span class="op" id="1518644">.</span><span class="ident" id="1518645">val</span><br>
<span class="lineno"></span><span class="op" id="1518649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1518652">func</span>&nbsp;<span class="op" id="1518657">(</span><span class="ident" id="1518658">e</span>&nbsp;<span class="op" id="1518660">*</span><span class="ident" id="1518661">envOnce</span><span class="op" id="1518668">)</span>&nbsp;<span class="ident" id="1518670">init</span><span class="op" id="1518674">(</span><span class="op" id="1518675">)</span>&nbsp;<span class="op" id="1518677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518680">for</span>&nbsp;<span class="ident" id="1518684">_</span><span class="op" id="1518685">,</span>&nbsp;<span class="ident" id="1518687">n</span>&nbsp;<span class="op" id="1518689">:=</span>&nbsp;<span class="keyword" id="1518692">range</span>&nbsp;<span class="ident" id="1518698">e</span><span class="op" id="1518699">.</span><span class="ident" id="1518700">names</span>&nbsp;<span class="op" id="1518706">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518710">e</span><span class="op" id="1518711">.</span><span class="ident" id="1518712">val</span>&nbsp;<span class="op" id="1518716">=</span>&nbsp;<span class="ident" id="1518718">os</span><span class="op" id="1518720">.</span><span class="ident" id="1518721">Getenv</span><span class="op" id="1518727">(</span><span class="ident" id="1518728">n</span><span class="op" id="1518729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518733">if</span>&nbsp;<span class="ident" id="1518736">e</span><span class="op" id="1518737">.</span><span class="ident" id="1518738">val</span>&nbsp;<span class="op" id="1518742">!=</span>&nbsp;<span class="string" id="1518745">&#34;&#34;</span>&nbsp;<span class="op" id="1518748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1518753">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1518765">}</span><br>
<span class="lineno">325</span><span class="op" id="1518767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1518770">//&nbsp;reset&nbsp;is&nbsp;used&nbsp;by&nbsp;tests</span><br>
<span class="lineno"></span><span class="keyword" id="1518796">func</span>&nbsp;<span class="op" id="1518801">(</span><span class="ident" id="1518802">e</span>&nbsp;<span class="op" id="1518804">*</span><span class="ident" id="1518805">envOnce</span><span class="op" id="1518812">)</span>&nbsp;<span class="ident" id="1518814">reset</span><span class="op" id="1518819">(</span><span class="op" id="1518820">)</span>&nbsp;<span class="op" id="1518822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518825">e</span><span class="op" id="1518826">.</span><span class="ident" id="1518827">once</span>&nbsp;<span class="op" id="1518832">=</span>&nbsp;<span class="ident" id="1518834">sync</span><span class="op" id="1518838">.</span><span class="ident" id="1518839">Once</span><span class="op" id="1518843">{</span><span class="op" id="1518844">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518847">e</span><span class="op" id="1518848">.</span><span class="ident" id="1518849">val</span>&nbsp;<span class="op" id="1518853">=</span>&nbsp;<span class="string" id="1518855">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="1518858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1518861">func</span>&nbsp;<span class="op" id="1518866">(</span><span class="ident" id="1518867">t</span>&nbsp;<span class="op" id="1518869">*</span><span class="ident" id="1518870">Transport</span><span class="op" id="1518879">)</span>&nbsp;<span class="ident" id="1518881">connectMethodForRequest</span><span class="op" id="1518904">(</span><span class="ident" id="1518905">treq</span>&nbsp;<span class="op" id="1518910">*</span><span class="ident" id="1518911">transportRequest</span><span class="op" id="1518927">)</span>&nbsp;<span class="op" id="1518929">(</span><span class="ident" id="1518930">cm</span>&nbsp;<span class="ident" id="1518933">connectMethod</span><span class="op" id="1518946">,</span>&nbsp;<span class="ident" id="1518948">err</span>&nbsp;<span class="builtintype" id="1518952">error</span><span class="op" id="1518957">)</span>&nbsp;<span class="op" id="1518959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518962">cm</span><span class="op" id="1518964">.</span><span class="ident" id="1518965">targetScheme</span>&nbsp;<span class="op" id="1518978">=</span>&nbsp;<span class="ident" id="1518980">treq</span><span class="op" id="1518984">.</span><span class="ident" id="1518985">URL</span><span class="op" id="1518988">.</span><span class="ident" id="1518989">Scheme</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1518997">cm</span><span class="op" id="1518999">.</span><span class="ident" id="1519000">targetAddr</span>&nbsp;<span class="op" id="1519011">=</span>&nbsp;<span class="ident" id="1519013">canonicalAddr</span><span class="op" id="1519026">(</span><span class="ident" id="1519027">treq</span><span class="op" id="1519031">.</span><span class="ident" id="1519032">URL</span><span class="op" id="1519035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519038">if</span>&nbsp;<span class="ident" id="1519041">t</span><span class="op" id="1519042">.</span><span class="ident" id="1519043">Proxy</span>&nbsp;<span class="op" id="1519049">!=</span>&nbsp;<span class="ident" id="1519052">nil</span>&nbsp;<span class="op" id="1519056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519060">cm</span><span class="op" id="1519062">.</span><span class="ident" id="1519063">proxyURL</span><span class="op" id="1519071">,</span>&nbsp;<span class="ident" id="1519073">err</span>&nbsp;<span class="op" id="1519077">=</span>&nbsp;<span class="ident" id="1519079">t</span><span class="op" id="1519080">.</span><span class="ident" id="1519081">Proxy</span><span class="op" id="1519086">(</span><span class="ident" id="1519087">treq</span><span class="op" id="1519091">.</span><span class="ident" id="1519092">Request</span><span class="op" id="1519099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519105">return</span>&nbsp;<span class="ident" id="1519112">cm</span><span class="op" id="1519114">,</span>&nbsp;<span class="ident" id="1519116">err</span><br>
<span class="lineno">340</span><span class="op" id="1519120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1519123">//&nbsp;proxyAuth&nbsp;returns&nbsp;the&nbsp;Proxy-Authorization&nbsp;header&nbsp;to&nbsp;set</span><br>
<span class="lineno"></span><span class="comment" id="1519182">//&nbsp;on&nbsp;requests,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="1519213">func</span>&nbsp;<span class="op" id="1519218">(</span><span class="ident" id="1519219">cm</span>&nbsp;<span class="op" id="1519222">*</span><span class="ident" id="1519223">connectMethod</span><span class="op" id="1519236">)</span>&nbsp;<span class="ident" id="1519238">proxyAuth</span><span class="op" id="1519247">(</span><span class="op" id="1519248">)</span>&nbsp;<span class="builtintype" id="1519250">string</span>&nbsp;<span class="op" id="1519257">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519260">if</span>&nbsp;<span class="ident" id="1519263">cm</span><span class="op" id="1519265">.</span><span class="ident" id="1519266">proxyURL</span>&nbsp;<span class="op" id="1519275">==</span>&nbsp;<span class="ident" id="1519278">nil</span>&nbsp;<span class="op" id="1519282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519286">return</span>&nbsp;<span class="string" id="1519293">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519300">if</span>&nbsp;<span class="ident" id="1519303">u</span>&nbsp;<span class="op" id="1519305">:=</span>&nbsp;<span class="ident" id="1519308">cm</span><span class="op" id="1519310">.</span><span class="ident" id="1519311">proxyURL</span><span class="op" id="1519319">.</span><span class="ident" id="1519320">User</span><span class="op" id="1519324">;</span>&nbsp;<span class="ident" id="1519326">u</span>&nbsp;<span class="op" id="1519328">!=</span>&nbsp;<span class="ident" id="1519331">nil</span>&nbsp;<span class="op" id="1519335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519339">username</span>&nbsp;<span class="op" id="1519348">:=</span>&nbsp;<span class="ident" id="1519351">u</span><span class="op" id="1519352">.</span><span class="ident" id="1519353">Username</span><span class="op" id="1519361">(</span><span class="op" id="1519362">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519366">password</span><span class="op" id="1519374">,</span>&nbsp;<span class="ident" id="1519376">_</span>&nbsp;<span class="op" id="1519378">:=</span>&nbsp;<span class="ident" id="1519381">u</span><span class="op" id="1519382">.</span><span class="ident" id="1519383">Password</span><span class="op" id="1519391">(</span><span class="op" id="1519392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519396">return</span>&nbsp;<span class="string" id="1519403">&#34;Basic&nbsp;&#34;</span>&nbsp;<span class="op" id="1519412">+</span>&nbsp;<span class="ident" id="1519414">basicAuth</span><span class="op" id="1519423">(</span><span class="ident" id="1519424">username</span><span class="op" id="1519432">,</span>&nbsp;<span class="ident" id="1519434">password</span><span class="op" id="1519442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519448">return</span>&nbsp;<span class="string" id="1519455">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="1519458">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="1519461">//&nbsp;putIdleConn&nbsp;adds&nbsp;pconn&nbsp;to&nbsp;the&nbsp;list&nbsp;of&nbsp;idle&nbsp;persistent&nbsp;connections&nbsp;awaiting</span><br>
<span class="lineno"></span><span class="comment" id="1519539">//&nbsp;a&nbsp;new&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="1519557">//&nbsp;If&nbsp;pconn&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;or&nbsp;not&nbsp;in&nbsp;a&nbsp;good&nbsp;state,&nbsp;putIdleConn</span><br>
<span class="lineno"></span><span class="comment" id="1519625">//&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">360</span><span class="keyword" id="1519643">func</span>&nbsp;<span class="op" id="1519648">(</span><span class="ident" id="1519649">t</span>&nbsp;<span class="op" id="1519651">*</span><span class="ident" id="1519652">Transport</span><span class="op" id="1519661">)</span>&nbsp;<span class="ident" id="1519663">putIdleConn</span><span class="op" id="1519674">(</span><span class="ident" id="1519675">pconn</span>&nbsp;<span class="op" id="1519681">*</span><span class="ident" id="1519682">persistConn</span><span class="op" id="1519693">)</span>&nbsp;<span class="builtintype" id="1519695">bool</span>&nbsp;<span class="op" id="1519700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519703">if</span>&nbsp;<span class="ident" id="1519706">t</span><span class="op" id="1519707">.</span><span class="ident" id="1519708">DisableKeepAlives</span>&nbsp;<span class="op" id="1519726">||</span>&nbsp;<span class="ident" id="1519729">t</span><span class="op" id="1519730">.</span><span class="ident" id="1519731">MaxIdleConnsPerHost</span>&nbsp;<span class="op" id="1519751">&lt;</span>&nbsp;<span class="num" id="1519753">0</span>&nbsp;<span class="op" id="1519755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519759">pconn</span><span class="op" id="1519764">.</span><span class="builtinfunc" id="1519765">close</span><span class="op" id="1519770">(</span><span class="op" id="1519771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519775">return</span>&nbsp;<span class="builtintype" id="1519782">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519789">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519792">if</span>&nbsp;<span class="ident" id="1519795">pconn</span><span class="op" id="1519800">.</span><span class="ident" id="1519801">isBroken</span><span class="op" id="1519809">(</span><span class="op" id="1519810">)</span>&nbsp;<span class="op" id="1519812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519816">return</span>&nbsp;<span class="builtintype" id="1519823">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519833">key</span>&nbsp;<span class="op" id="1519837">:=</span>&nbsp;<span class="ident" id="1519840">pconn</span><span class="op" id="1519845">.</span><span class="ident" id="1519846">cacheKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519856">max</span>&nbsp;<span class="op" id="1519860">:=</span>&nbsp;<span class="ident" id="1519863">t</span><span class="op" id="1519864">.</span><span class="ident" id="1519865">MaxIdleConnsPerHost</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519886">if</span>&nbsp;<span class="ident" id="1519889">max</span>&nbsp;<span class="op" id="1519893">==</span>&nbsp;<span class="num" id="1519896">0</span>&nbsp;<span class="op" id="1519898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519902">max</span>&nbsp;<span class="op" id="1519906">=</span>&nbsp;<span class="ident" id="1519908">DefaultMaxIdleConnsPerHost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1519936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519939">t</span><span class="op" id="1519940">.</span><span class="ident" id="1519941">idleMu</span><span class="op" id="1519947">.</span><span class="ident" id="1519948">Lock</span><span class="op" id="1519952">(</span><span class="op" id="1519953">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1519957">waitingDialer</span>&nbsp;<span class="op" id="1519971">:=</span>&nbsp;<span class="ident" id="1519974">t</span><span class="op" id="1519975">.</span><span class="ident" id="1519976">idleConnCh</span><span class="op" id="1519986">[</span><span class="ident" id="1519987">key</span><span class="op" id="1519990">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1519993">select</span>&nbsp;<span class="op" id="1520000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520003">case</span>&nbsp;<span class="ident" id="1520008">waitingDialer</span>&nbsp;<span class="op" id="1520022">&lt;-</span>&nbsp;<span class="ident" id="1520025">pconn</span><span class="op" id="1520030">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1520034">//&nbsp;We&#39;re&nbsp;done&nbsp;with&nbsp;this&nbsp;pconn&nbsp;and&nbsp;somebody&nbsp;else&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1520087">//&nbsp;currently&nbsp;waiting&nbsp;for&nbsp;a&nbsp;conn&nbsp;of&nbsp;this&nbsp;type&nbsp;(they&#39;re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1520143">//&nbsp;actively&nbsp;dialing,&nbsp;but&nbsp;this&nbsp;conn&nbsp;is&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1520189">//&nbsp;first).&nbsp;Chrome&nbsp;calls&nbsp;this&nbsp;socket&nbsp;late&nbsp;binding.&nbsp;&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1520246">//&nbsp;https://insouciant.org/tech/connection-management-in-chromium/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520314">t</span><span class="op" id="1520315">.</span><span class="ident" id="1520316">idleMu</span><span class="op" id="1520322">.</span><span class="ident" id="1520323">Unlock</span><span class="op" id="1520329">(</span><span class="op" id="1520330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520334">return</span>&nbsp;<span class="builtintype" id="1520341">true</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520347">default</span><span class="op" id="1520354">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520358">if</span>&nbsp;<span class="ident" id="1520361">waitingDialer</span>&nbsp;<span class="op" id="1520375">!=</span>&nbsp;<span class="ident" id="1520378">nil</span>&nbsp;<span class="op" id="1520382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1520387">//&nbsp;They&nbsp;had&nbsp;populated&nbsp;this,&nbsp;but&nbsp;their&nbsp;dial&nbsp;won</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1520437">//&nbsp;first,&nbsp;so&nbsp;we&nbsp;can&nbsp;clean&nbsp;up&nbsp;this&nbsp;map&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1520485">delete</span><span class="op" id="1520491">(</span><span class="ident" id="1520492">t</span><span class="op" id="1520493">.</span><span class="ident" id="1520494">idleConnCh</span><span class="op" id="1520504">,</span>&nbsp;<span class="ident" id="1520506">key</span><span class="op" id="1520509">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1520513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1520516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520519">if</span>&nbsp;<span class="ident" id="1520522">t</span><span class="op" id="1520523">.</span><span class="ident" id="1520524">wantIdle</span>&nbsp;<span class="op" id="1520533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520537">t</span><span class="op" id="1520538">.</span><span class="ident" id="1520539">idleMu</span><span class="op" id="1520545">.</span><span class="ident" id="1520546">Unlock</span><span class="op" id="1520552">(</span><span class="op" id="1520553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520557">pconn</span><span class="op" id="1520562">.</span><span class="builtinfunc" id="1520563">close</span><span class="op" id="1520568">(</span><span class="op" id="1520569">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520573">return</span>&nbsp;<span class="builtintype" id="1520580">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1520587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520590">if</span>&nbsp;<span class="ident" id="1520593">t</span><span class="op" id="1520594">.</span><span class="ident" id="1520595">idleConn</span>&nbsp;<span class="op" id="1520604">==</span>&nbsp;<span class="ident" id="1520607">nil</span>&nbsp;<span class="op" id="1520611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520615">t</span><span class="op" id="1520616">.</span><span class="ident" id="1520617">idleConn</span>&nbsp;<span class="op" id="1520626">=</span>&nbsp;<span class="builtinfunc" id="1520628">make</span><span class="op" id="1520632">(</span><span class="keyword" id="1520633">map</span><span class="op" id="1520636">[</span><span class="ident" id="1520637">connectMethodKey</span><span class="op" id="1520653">]</span><span class="op" id="1520654">[</span><span class="op" id="1520655">]</span><span class="op" id="1520656">*</span><span class="ident" id="1520657">persistConn</span><span class="op" id="1520668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1520671">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520674">if</span>&nbsp;<span class="builtinfunc" id="1520677">len</span><span class="op" id="1520680">(</span><span class="ident" id="1520681">t</span><span class="op" id="1520682">.</span><span class="ident" id="1520683">idleConn</span><span class="op" id="1520691">[</span><span class="ident" id="1520692">key</span><span class="op" id="1520695">]</span><span class="op" id="1520696">)</span>&nbsp;<span class="op" id="1520698">&gt;=</span>&nbsp;<span class="ident" id="1520701">max</span>&nbsp;<span class="op" id="1520705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520709">t</span><span class="op" id="1520710">.</span><span class="ident" id="1520711">idleMu</span><span class="op" id="1520717">.</span><span class="ident" id="1520718">Unlock</span><span class="op" id="1520724">(</span><span class="op" id="1520725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520729">pconn</span><span class="op" id="1520734">.</span><span class="builtinfunc" id="1520735">close</span><span class="op" id="1520740">(</span><span class="op" id="1520741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520745">return</span>&nbsp;<span class="builtintype" id="1520752">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1520759">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520762">for</span>&nbsp;<span class="ident" id="1520766">_</span><span class="op" id="1520767">,</span>&nbsp;<span class="ident" id="1520769">exist</span>&nbsp;<span class="op" id="1520775">:=</span>&nbsp;<span class="keyword" id="1520778">range</span>&nbsp;<span class="ident" id="1520784">t</span><span class="op" id="1520785">.</span><span class="ident" id="1520786">idleConn</span><span class="op" id="1520794">[</span><span class="ident" id="1520795">key</span><span class="op" id="1520798">]</span>&nbsp;<span class="op" id="1520800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520804">if</span>&nbsp;<span class="ident" id="1520807">exist</span>&nbsp;<span class="op" id="1520813">==</span>&nbsp;<span class="ident" id="1520816">pconn</span>&nbsp;<span class="op" id="1520822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520827">log</span><span class="op" id="1520830">.</span><span class="ident" id="1520831">Fatalf</span><span class="op" id="1520837">(</span><span class="string" id="1520838">&#34;dup&nbsp;idle&nbsp;pconn&nbsp;%p&nbsp;in&nbsp;freelist&#34;</span><span class="op" id="1520869">,</span>&nbsp;<span class="ident" id="1520871">pconn</span><span class="op" id="1520876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1520880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1520883">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520886">t</span><span class="op" id="1520887">.</span><span class="ident" id="1520888">idleConn</span><span class="op" id="1520896">[</span><span class="ident" id="1520897">key</span><span class="op" id="1520900">]</span>&nbsp;<span class="op" id="1520902">=</span>&nbsp;<span class="builtinfunc" id="1520904">append</span><span class="op" id="1520910">(</span><span class="ident" id="1520911">t</span><span class="op" id="1520912">.</span><span class="ident" id="1520913">idleConn</span><span class="op" id="1520921">[</span><span class="ident" id="1520922">key</span><span class="op" id="1520925">]</span><span class="op" id="1520926">,</span>&nbsp;<span class="ident" id="1520928">pconn</span><span class="op" id="1520933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1520936">t</span><span class="op" id="1520937">.</span><span class="ident" id="1520938">idleMu</span><span class="op" id="1520944">.</span><span class="ident" id="1520945">Unlock</span><span class="op" id="1520951">(</span><span class="op" id="1520952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1520955">return</span>&nbsp;<span class="builtintype" id="1520962">true</span><br>
<span class="lineno"></span><span class="op" id="1520967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1520970">//&nbsp;getIdleConnCh&nbsp;returns&nbsp;a&nbsp;channel&nbsp;to&nbsp;receive&nbsp;and&nbsp;return&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="1521032">//&nbsp;persistent&nbsp;connection&nbsp;for&nbsp;the&nbsp;given&nbsp;connectMethod.</span><br>
<span class="lineno"></span><span class="comment" id="1521086">//&nbsp;It&nbsp;may&nbsp;return&nbsp;nil,&nbsp;if&nbsp;persistent&nbsp;connections&nbsp;are&nbsp;not&nbsp;being&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="1521154">func</span>&nbsp;<span class="op" id="1521159">(</span><span class="ident" id="1521160">t</span>&nbsp;<span class="op" id="1521162">*</span><span class="ident" id="1521163">Transport</span><span class="op" id="1521172">)</span>&nbsp;<span class="ident" id="1521174">getIdleConnCh</span><span class="op" id="1521187">(</span><span class="ident" id="1521188">cm</span>&nbsp;<span class="ident" id="1521191">connectMethod</span><span class="op" id="1521204">)</span>&nbsp;<span class="keyword" id="1521206">chan</span>&nbsp;<span class="op" id="1521211">*</span><span class="ident" id="1521212">persistConn</span>&nbsp;<span class="op" id="1521224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521227">if</span>&nbsp;<span class="ident" id="1521230">t</span><span class="op" id="1521231">.</span><span class="ident" id="1521232">DisableKeepAlives</span>&nbsp;<span class="op" id="1521250">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521254">return</span>&nbsp;<span class="ident" id="1521261">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1521266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521269">key</span>&nbsp;<span class="op" id="1521273">:=</span>&nbsp;<span class="ident" id="1521276">cm</span><span class="op" id="1521278">.</span><span class="ident" id="1521279">key</span><span class="op" id="1521282">(</span><span class="op" id="1521283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521286">t</span><span class="op" id="1521287">.</span><span class="ident" id="1521288">idleMu</span><span class="op" id="1521294">.</span><span class="ident" id="1521295">Lock</span><span class="op" id="1521299">(</span><span class="op" id="1521300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521303">defer</span>&nbsp;<span class="ident" id="1521309">t</span><span class="op" id="1521310">.</span><span class="ident" id="1521311">idleMu</span><span class="op" id="1521317">.</span><span class="ident" id="1521318">Unlock</span><span class="op" id="1521324">(</span><span class="op" id="1521325">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521328">t</span><span class="op" id="1521329">.</span><span class="ident" id="1521330">wantIdle</span>&nbsp;<span class="op" id="1521339">=</span>&nbsp;<span class="builtintype" id="1521341">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521348">if</span>&nbsp;<span class="ident" id="1521351">t</span><span class="op" id="1521352">.</span><span class="ident" id="1521353">idleConnCh</span>&nbsp;<span class="op" id="1521364">==</span>&nbsp;<span class="ident" id="1521367">nil</span>&nbsp;<span class="op" id="1521371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521375">t</span><span class="op" id="1521376">.</span><span class="ident" id="1521377">idleConnCh</span>&nbsp;<span class="op" id="1521388">=</span>&nbsp;<span class="builtinfunc" id="1521390">make</span><span class="op" id="1521394">(</span><span class="keyword" id="1521395">map</span><span class="op" id="1521398">[</span><span class="ident" id="1521399">connectMethodKey</span><span class="op" id="1521415">]</span><span class="keyword" id="1521416">chan</span>&nbsp;<span class="op" id="1521421">*</span><span class="ident" id="1521422">persistConn</span><span class="op" id="1521433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1521436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521439">ch</span><span class="op" id="1521441">,</span>&nbsp;<span class="ident" id="1521443">ok</span>&nbsp;<span class="op" id="1521446">:=</span>&nbsp;<span class="ident" id="1521449">t</span><span class="op" id="1521450">.</span><span class="ident" id="1521451">idleConnCh</span><span class="op" id="1521461">[</span><span class="ident" id="1521462">key</span><span class="op" id="1521465">]</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521468">if</span>&nbsp;<span class="op" id="1521471">!</span><span class="ident" id="1521472">ok</span>&nbsp;<span class="op" id="1521475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521479">ch</span>&nbsp;<span class="op" id="1521482">=</span>&nbsp;<span class="builtinfunc" id="1521484">make</span><span class="op" id="1521488">(</span><span class="keyword" id="1521489">chan</span>&nbsp;<span class="op" id="1521494">*</span><span class="ident" id="1521495">persistConn</span><span class="op" id="1521506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521510">t</span><span class="op" id="1521511">.</span><span class="ident" id="1521512">idleConnCh</span><span class="op" id="1521522">[</span><span class="ident" id="1521523">key</span><span class="op" id="1521526">]</span>&nbsp;<span class="op" id="1521528">=</span>&nbsp;<span class="ident" id="1521530">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1521534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521537">return</span>&nbsp;<span class="ident" id="1521544">ch</span><br>
<span class="lineno">435</span><span class="op" id="1521547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1521550">func</span>&nbsp;<span class="op" id="1521555">(</span><span class="ident" id="1521556">t</span>&nbsp;<span class="op" id="1521558">*</span><span class="ident" id="1521559">Transport</span><span class="op" id="1521568">)</span>&nbsp;<span class="ident" id="1521570">getIdleConn</span><span class="op" id="1521581">(</span><span class="ident" id="1521582">cm</span>&nbsp;<span class="ident" id="1521585">connectMethod</span><span class="op" id="1521598">)</span>&nbsp;<span class="op" id="1521600">(</span><span class="ident" id="1521601">pconn</span>&nbsp;<span class="op" id="1521607">*</span><span class="ident" id="1521608">persistConn</span><span class="op" id="1521619">)</span>&nbsp;<span class="op" id="1521621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521624">key</span>&nbsp;<span class="op" id="1521628">:=</span>&nbsp;<span class="ident" id="1521631">cm</span><span class="op" id="1521633">.</span><span class="ident" id="1521634">key</span><span class="op" id="1521637">(</span><span class="op" id="1521638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521641">t</span><span class="op" id="1521642">.</span><span class="ident" id="1521643">idleMu</span><span class="op" id="1521649">.</span><span class="ident" id="1521650">Lock</span><span class="op" id="1521654">(</span><span class="op" id="1521655">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521658">defer</span>&nbsp;<span class="ident" id="1521664">t</span><span class="op" id="1521665">.</span><span class="ident" id="1521666">idleMu</span><span class="op" id="1521672">.</span><span class="ident" id="1521673">Unlock</span><span class="op" id="1521679">(</span><span class="op" id="1521680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521683">if</span>&nbsp;<span class="ident" id="1521686">t</span><span class="op" id="1521687">.</span><span class="ident" id="1521688">idleConn</span>&nbsp;<span class="op" id="1521697">==</span>&nbsp;<span class="ident" id="1521700">nil</span>&nbsp;<span class="op" id="1521704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521708">return</span>&nbsp;<span class="ident" id="1521715">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1521720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521723">for</span>&nbsp;<span class="op" id="1521727">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521731">pconns</span><span class="op" id="1521737">,</span>&nbsp;<span class="ident" id="1521739">ok</span>&nbsp;<span class="op" id="1521742">:=</span>&nbsp;<span class="ident" id="1521745">t</span><span class="op" id="1521746">.</span><span class="ident" id="1521747">idleConn</span><span class="op" id="1521755">[</span><span class="ident" id="1521756">key</span><span class="op" id="1521759">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521763">if</span>&nbsp;<span class="op" id="1521766">!</span><span class="ident" id="1521767">ok</span>&nbsp;<span class="op" id="1521770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521775">return</span>&nbsp;<span class="ident" id="1521782">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1521788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1521792">if</span>&nbsp;<span class="builtinfunc" id="1521795">len</span><span class="op" id="1521798">(</span><span class="ident" id="1521799">pconns</span><span class="op" id="1521805">)</span>&nbsp;<span class="op" id="1521807">==</span>&nbsp;<span class="num" id="1521810">1</span>&nbsp;<span class="op" id="1521812">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521817">pconn</span>&nbsp;<span class="op" id="1521823">=</span>&nbsp;<span class="ident" id="1521825">pconns</span><span class="op" id="1521831">[</span><span class="num" id="1521832">0</span><span class="op" id="1521833">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1521838">delete</span><span class="op" id="1521844">(</span><span class="ident" id="1521845">t</span><span class="op" id="1521846">.</span><span class="ident" id="1521847">idleConn</span><span class="op" id="1521855">,</span>&nbsp;<span class="ident" id="1521857">key</span><span class="op" id="1521860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1521864">}</span>&nbsp;<span class="keyword" id="1521866">else</span>&nbsp;<span class="op" id="1521871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1521876">//&nbsp;2&nbsp;or&nbsp;more&nbsp;cached&nbsp;connections;&nbsp;pop&nbsp;last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1521921">//&nbsp;TODO:&nbsp;queue?</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521940">pconn</span>&nbsp;<span class="op" id="1521946">=</span>&nbsp;<span class="ident" id="1521948">pconns</span><span class="op" id="1521954">[</span><span class="builtinfunc" id="1521955">len</span><span class="op" id="1521958">(</span><span class="ident" id="1521959">pconns</span><span class="op" id="1521965">)</span><span class="op" id="1521966">-</span><span class="num" id="1521967">1</span><span class="op" id="1521968">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1521973">t</span><span class="op" id="1521974">.</span><span class="ident" id="1521975">idleConn</span><span class="op" id="1521983">[</span><span class="ident" id="1521984">key</span><span class="op" id="1521987">]</span>&nbsp;<span class="op" id="1521989">=</span>&nbsp;<span class="ident" id="1521991">pconns</span><span class="op" id="1521997">[</span><span class="op" id="1521998">:</span><span class="builtinfunc" id="1521999">len</span><span class="op" id="1522002">(</span><span class="ident" id="1522003">pconns</span><span class="op" id="1522009">)</span><span class="op" id="1522010">-</span><span class="num" id="1522011">1</span><span class="op" id="1522012">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1522016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522020">if</span>&nbsp;<span class="op" id="1522023">!</span><span class="ident" id="1522024">pconn</span><span class="op" id="1522029">.</span><span class="ident" id="1522030">isBroken</span><span class="op" id="1522038">(</span><span class="op" id="1522039">)</span>&nbsp;<span class="op" id="1522041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522046">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1522055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1522058">}</span><br>
<span class="lineno"></span><span class="op" id="1522060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1522063">func</span>&nbsp;<span class="op" id="1522068">(</span><span class="ident" id="1522069">t</span>&nbsp;<span class="op" id="1522071">*</span><span class="ident" id="1522072">Transport</span><span class="op" id="1522081">)</span>&nbsp;<span class="ident" id="1522083">setReqCanceler</span><span class="op" id="1522097">(</span><span class="ident" id="1522098">r</span>&nbsp;<span class="op" id="1522100">*</span><span class="ident" id="1522101">Request</span><span class="op" id="1522108">,</span>&nbsp;<span class="ident" id="1522110">fn</span>&nbsp;<span class="keyword" id="1522113">func</span><span class="op" id="1522117">(</span><span class="op" id="1522118">)</span><span class="op" id="1522119">)</span>&nbsp;<span class="op" id="1522121">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522124">t</span><span class="op" id="1522125">.</span><span class="ident" id="1522126">reqMu</span><span class="op" id="1522131">.</span><span class="ident" id="1522132">Lock</span><span class="op" id="1522136">(</span><span class="op" id="1522137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522140">defer</span>&nbsp;<span class="ident" id="1522146">t</span><span class="op" id="1522147">.</span><span class="ident" id="1522148">reqMu</span><span class="op" id="1522153">.</span><span class="ident" id="1522154">Unlock</span><span class="op" id="1522160">(</span><span class="op" id="1522161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522164">if</span>&nbsp;<span class="ident" id="1522167">t</span><span class="op" id="1522168">.</span><span class="ident" id="1522169">reqCanceler</span>&nbsp;<span class="op" id="1522181">==</span>&nbsp;<span class="ident" id="1522184">nil</span>&nbsp;<span class="op" id="1522188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522192">t</span><span class="op" id="1522193">.</span><span class="ident" id="1522194">reqCanceler</span>&nbsp;<span class="op" id="1522206">=</span>&nbsp;<span class="builtinfunc" id="1522208">make</span><span class="op" id="1522212">(</span><span class="keyword" id="1522213">map</span><span class="op" id="1522216">[</span><span class="op" id="1522217">*</span><span class="ident" id="1522218">Request</span><span class="op" id="1522225">]</span><span class="keyword" id="1522226">func</span><span class="op" id="1522230">(</span><span class="op" id="1522231">)</span><span class="op" id="1522232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1522235">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522238">if</span>&nbsp;<span class="ident" id="1522241">fn</span>&nbsp;<span class="op" id="1522244">!=</span>&nbsp;<span class="ident" id="1522247">nil</span>&nbsp;<span class="op" id="1522251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522255">t</span><span class="op" id="1522256">.</span><span class="ident" id="1522257">reqCanceler</span><span class="op" id="1522268">[</span><span class="ident" id="1522269">r</span><span class="op" id="1522270">]</span>&nbsp;<span class="op" id="1522272">=</span>&nbsp;<span class="ident" id="1522274">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1522278">}</span>&nbsp;<span class="keyword" id="1522280">else</span>&nbsp;<span class="op" id="1522285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1522289">delete</span><span class="op" id="1522295">(</span><span class="ident" id="1522296">t</span><span class="op" id="1522297">.</span><span class="ident" id="1522298">reqCanceler</span><span class="op" id="1522309">,</span>&nbsp;<span class="ident" id="1522311">r</span><span class="op" id="1522312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1522315">}</span><br>
<span class="lineno">475</span><span class="op" id="1522317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1522320">func</span>&nbsp;<span class="op" id="1522325">(</span><span class="ident" id="1522326">t</span>&nbsp;<span class="op" id="1522328">*</span><span class="ident" id="1522329">Transport</span><span class="op" id="1522338">)</span>&nbsp;<span class="ident" id="1522340">dial</span><span class="op" id="1522344">(</span><span class="ident" id="1522345">network</span><span class="op" id="1522352">,</span>&nbsp;<span class="ident" id="1522354">addr</span>&nbsp;<span class="builtintype" id="1522359">string</span><span class="op" id="1522365">)</span>&nbsp;<span class="op" id="1522367">(</span><span class="ident" id="1522368">c</span>&nbsp;<span class="ident" id="1522370">net</span><span class="op" id="1522373">.</span><span class="ident" id="1522374">Conn</span><span class="op" id="1522378">,</span>&nbsp;<span class="ident" id="1522380">err</span>&nbsp;<span class="builtintype" id="1522384">error</span><span class="op" id="1522389">)</span>&nbsp;<span class="op" id="1522391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522394">if</span>&nbsp;<span class="ident" id="1522397">t</span><span class="op" id="1522398">.</span><span class="ident" id="1522399">Dial</span>&nbsp;<span class="op" id="1522404">!=</span>&nbsp;<span class="ident" id="1522407">nil</span>&nbsp;<span class="op" id="1522411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522415">return</span>&nbsp;<span class="ident" id="1522422">t</span><span class="op" id="1522423">.</span><span class="ident" id="1522424">Dial</span><span class="op" id="1522428">(</span><span class="ident" id="1522429">network</span><span class="op" id="1522436">,</span>&nbsp;<span class="ident" id="1522438">addr</span><span class="op" id="1522442">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1522445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522448">return</span>&nbsp;<span class="ident" id="1522455">net</span><span class="op" id="1522458">.</span><span class="ident" id="1522459">Dial</span><span class="op" id="1522463">(</span><span class="ident" id="1522464">network</span><span class="op" id="1522471">,</span>&nbsp;<span class="ident" id="1522473">addr</span><span class="op" id="1522477">)</span><br>
<span class="lineno"></span><span class="op" id="1522479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1522482">//&nbsp;Testing&nbsp;hooks:</span><br>
<span class="lineno">485</span><span class="keyword" id="1522500">var</span>&nbsp;<span class="ident" id="1522504">prePendingDial</span><span class="op" id="1522518">,</span>&nbsp;<span class="ident" id="1522520">postPendingDial</span>&nbsp;<span class="keyword" id="1522536">func</span><span class="op" id="1522540">(</span><span class="op" id="1522541">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1522544">//&nbsp;getConn&nbsp;dials&nbsp;and&nbsp;creates&nbsp;a&nbsp;new&nbsp;persistConn&nbsp;to&nbsp;the&nbsp;target&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1522608">//&nbsp;specified&nbsp;in&nbsp;the&nbsp;connectMethod.&nbsp;&nbsp;This&nbsp;includes&nbsp;doing&nbsp;a&nbsp;proxy&nbsp;CONNECT</span><br>
<span class="lineno"></span><span class="comment" id="1522680">//&nbsp;and/or&nbsp;setting&nbsp;up&nbsp;TLS.&nbsp;&nbsp;If&nbsp;this&nbsp;doesn&#39;t&nbsp;return&nbsp;an&nbsp;error,&nbsp;the&nbsp;persistConn</span><br>
<span class="lineno">490</span><span class="comment" id="1522756">//&nbsp;is&nbsp;ready&nbsp;to&nbsp;write&nbsp;requests&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="1522790">func</span>&nbsp;<span class="op" id="1522795">(</span><span class="ident" id="1522796">t</span>&nbsp;<span class="op" id="1522798">*</span><span class="ident" id="1522799">Transport</span><span class="op" id="1522808">)</span>&nbsp;<span class="ident" id="1522810">getConn</span><span class="op" id="1522817">(</span><span class="ident" id="1522818">req</span>&nbsp;<span class="op" id="1522822">*</span><span class="ident" id="1522823">Request</span><span class="op" id="1522830">,</span>&nbsp;<span class="ident" id="1522832">cm</span>&nbsp;<span class="ident" id="1522835">connectMethod</span><span class="op" id="1522848">)</span>&nbsp;<span class="op" id="1522850">(</span><span class="op" id="1522851">*</span><span class="ident" id="1522852">persistConn</span><span class="op" id="1522863">,</span>&nbsp;<span class="builtintype" id="1522865">error</span><span class="op" id="1522870">)</span>&nbsp;<span class="op" id="1522872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522875">if</span>&nbsp;<span class="ident" id="1522878">pc</span>&nbsp;<span class="op" id="1522881">:=</span>&nbsp;<span class="ident" id="1522884">t</span><span class="op" id="1522885">.</span><span class="ident" id="1522886">getIdleConn</span><span class="op" id="1522897">(</span><span class="ident" id="1522898">cm</span><span class="op" id="1522900">)</span><span class="op" id="1522901">;</span>&nbsp;<span class="ident" id="1522903">pc</span>&nbsp;<span class="op" id="1522906">!=</span>&nbsp;<span class="ident" id="1522909">nil</span>&nbsp;<span class="op" id="1522913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522917">return</span>&nbsp;<span class="ident" id="1522924">pc</span><span class="op" id="1522926">,</span>&nbsp;<span class="ident" id="1522928">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1522933">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1522937">type</span>&nbsp;<span class="ident" id="1522942">dialRes</span>&nbsp;<span class="keyword" id="1522950">struct</span>&nbsp;<span class="op" id="1522957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522961">pc</span>&nbsp;&nbsp;<span class="op" id="1522965">*</span><span class="ident" id="1522966">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522980">err</span>&nbsp;<span class="builtintype" id="1522984">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1522991">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1522994">dialc</span>&nbsp;<span class="op" id="1523000">:=</span>&nbsp;<span class="builtinfunc" id="1523003">make</span><span class="op" id="1523007">(</span><span class="keyword" id="1523008">chan</span>&nbsp;<span class="ident" id="1523013">dialRes</span><span class="op" id="1523020">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523024">handlePendingDial</span>&nbsp;<span class="op" id="1523042">:=</span>&nbsp;<span class="keyword" id="1523045">func</span><span class="op" id="1523049">(</span><span class="op" id="1523050">)</span>&nbsp;<span class="op" id="1523052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523056">if</span>&nbsp;<span class="ident" id="1523059">prePendingDial</span>&nbsp;<span class="op" id="1523074">!=</span>&nbsp;<span class="ident" id="1523077">nil</span>&nbsp;<span class="op" id="1523081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523086">prePendingDial</span><span class="op" id="1523100">(</span><span class="op" id="1523101">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1523105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523109">go</span>&nbsp;<span class="keyword" id="1523112">func</span><span class="op" id="1523116">(</span><span class="op" id="1523117">)</span>&nbsp;<span class="op" id="1523119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523124">if</span>&nbsp;<span class="ident" id="1523127">v</span>&nbsp;<span class="op" id="1523129">:=</span>&nbsp;<span class="op" id="1523132">&lt;-</span><span class="ident" id="1523134">dialc</span><span class="op" id="1523139">;</span>&nbsp;<span class="ident" id="1523141">v</span><span class="op" id="1523142">.</span><span class="ident" id="1523143">err</span>&nbsp;<span class="op" id="1523147">==</span>&nbsp;<span class="ident" id="1523150">nil</span>&nbsp;<span class="op" id="1523154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523160">t</span><span class="op" id="1523161">.</span><span class="ident" id="1523162">putIdleConn</span><span class="op" id="1523173">(</span><span class="ident" id="1523174">v</span><span class="op" id="1523175">.</span><span class="ident" id="1523176">pc</span><span class="op" id="1523178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1523183">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523188">if</span>&nbsp;<span class="ident" id="1523191">postPendingDial</span>&nbsp;<span class="op" id="1523207">!=</span>&nbsp;<span class="ident" id="1523210">nil</span>&nbsp;<span class="op" id="1523214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523220">postPendingDial</span><span class="op" id="1523235">(</span><span class="op" id="1523236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1523241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1523245">}</span><span class="op" id="1523246">(</span><span class="op" id="1523247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1523250">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523254">cancelc</span>&nbsp;<span class="op" id="1523262">:=</span>&nbsp;<span class="builtinfunc" id="1523265">make</span><span class="op" id="1523269">(</span><span class="keyword" id="1523270">chan</span>&nbsp;<span class="keyword" id="1523275">struct</span><span class="op" id="1523281">{</span><span class="op" id="1523282">}</span><span class="op" id="1523283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523286">t</span><span class="op" id="1523287">.</span><span class="ident" id="1523288">setReqCanceler</span><span class="op" id="1523302">(</span><span class="ident" id="1523303">req</span><span class="op" id="1523306">,</span>&nbsp;<span class="keyword" id="1523308">func</span><span class="op" id="1523312">(</span><span class="op" id="1523313">)</span>&nbsp;<span class="op" id="1523315">{</span>&nbsp;<span class="builtinfunc" id="1523317">close</span><span class="op" id="1523322">(</span><span class="ident" id="1523323">cancelc</span><span class="op" id="1523330">)</span>&nbsp;<span class="op" id="1523332">}</span><span class="op" id="1523333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523337">go</span>&nbsp;<span class="keyword" id="1523340">func</span><span class="op" id="1523344">(</span><span class="op" id="1523345">)</span>&nbsp;<span class="op" id="1523347">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523351">pc</span><span class="op" id="1523353">,</span>&nbsp;<span class="ident" id="1523355">err</span>&nbsp;<span class="op" id="1523359">:=</span>&nbsp;<span class="ident" id="1523362">t</span><span class="op" id="1523363">.</span><span class="ident" id="1523364">dialConn</span><span class="op" id="1523372">(</span><span class="ident" id="1523373">cm</span><span class="op" id="1523375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523379">dialc</span>&nbsp;<span class="op" id="1523385">&lt;-</span>&nbsp;<span class="ident" id="1523388">dialRes</span><span class="op" id="1523395">{</span><span class="ident" id="1523396">pc</span><span class="op" id="1523398">,</span>&nbsp;<span class="ident" id="1523400">err</span><span class="op" id="1523403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1523406">}</span><span class="op" id="1523407">(</span><span class="op" id="1523408">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523412">idleConnCh</span>&nbsp;<span class="op" id="1523423">:=</span>&nbsp;<span class="ident" id="1523426">t</span><span class="op" id="1523427">.</span><span class="ident" id="1523428">getIdleConnCh</span><span class="op" id="1523441">(</span><span class="ident" id="1523442">cm</span><span class="op" id="1523444">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523447">select</span>&nbsp;<span class="op" id="1523454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523457">case</span>&nbsp;<span class="ident" id="1523462">v</span>&nbsp;<span class="op" id="1523464">:=</span>&nbsp;<span class="op" id="1523467">&lt;-</span><span class="ident" id="1523469">dialc</span><span class="op" id="1523474">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523478">//&nbsp;Our&nbsp;dial&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523502">return</span>&nbsp;<span class="ident" id="1523509">v</span><span class="op" id="1523510">.</span><span class="ident" id="1523511">pc</span><span class="op" id="1523513">,</span>&nbsp;<span class="ident" id="1523515">v</span><span class="op" id="1523516">.</span><span class="ident" id="1523517">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523522">case</span>&nbsp;<span class="ident" id="1523527">pc</span>&nbsp;<span class="op" id="1523530">:=</span>&nbsp;<span class="op" id="1523533">&lt;-</span><span class="ident" id="1523535">idleConnCh</span><span class="op" id="1523545">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523549">//&nbsp;Another&nbsp;request&nbsp;finished&nbsp;first&nbsp;and&nbsp;its&nbsp;net.Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523602">//&nbsp;became&nbsp;available&nbsp;before&nbsp;our&nbsp;dial.&nbsp;Or&nbsp;somebody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523653">//&nbsp;else&#39;s&nbsp;dial&nbsp;that&nbsp;they&nbsp;didn&#39;t&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523692">//&nbsp;But&nbsp;our&nbsp;dial&nbsp;is&nbsp;still&nbsp;going,&nbsp;so&nbsp;give&nbsp;it&nbsp;away</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1523742">//&nbsp;when&nbsp;it&nbsp;finishes:</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523765">handlePendingDial</span><span class="op" id="1523782">(</span><span class="op" id="1523783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523787">return</span>&nbsp;<span class="ident" id="1523794">pc</span><span class="op" id="1523796">,</span>&nbsp;<span class="ident" id="1523798">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523803">case</span>&nbsp;<span class="op" id="1523808">&lt;-</span><span class="ident" id="1523810">cancelc</span><span class="op" id="1523817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1523821">handlePendingDial</span><span class="op" id="1523838">(</span><span class="op" id="1523839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1523843">return</span>&nbsp;<span class="ident" id="1523850">nil</span><span class="op" id="1523853">,</span>&nbsp;<span class="ident" id="1523855">errors</span><span class="op" id="1523861">.</span><span class="ident" id="1523862">New</span><span class="op" id="1523865">(</span><span class="string" id="1523866">&#34;net/http:&nbsp;request&nbsp;canceled&nbsp;while&nbsp;waiting&nbsp;for&nbsp;connection&#34;</span><span class="op" id="1523923">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1523926">}</span><br>
<span class="lineno"></span><span class="op" id="1523928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1523931">func</span>&nbsp;<span class="op" id="1523936">(</span><span class="ident" id="1523937">t</span>&nbsp;<span class="op" id="1523939">*</span><span class="ident" id="1523940">Transport</span><span class="op" id="1523949">)</span>&nbsp;<span class="ident" id="1523951">dialConn</span><span class="op" id="1523959">(</span><span class="ident" id="1523960">cm</span>&nbsp;<span class="ident" id="1523963">connectMethod</span><span class="op" id="1523976">)</span>&nbsp;<span class="op" id="1523978">(</span><span class="op" id="1523979">*</span><span class="ident" id="1523980">persistConn</span><span class="op" id="1523991">,</span>&nbsp;<span class="builtintype" id="1523993">error</span><span class="op" id="1523998">)</span>&nbsp;<span class="op" id="1524000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524003">pconn</span>&nbsp;<span class="op" id="1524009">:=</span>&nbsp;<span class="op" id="1524012">&amp;</span><span class="ident" id="1524013">persistConn</span><span class="op" id="1524024">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524028">t</span><span class="op" id="1524029">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1524040">t</span><span class="op" id="1524041">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524045">cacheKey</span><span class="op" id="1524053">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1524057">cm</span><span class="op" id="1524059">.</span><span class="ident" id="1524060">key</span><span class="op" id="1524063">(</span><span class="op" id="1524064">)</span><span class="op" id="1524065">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524069">reqch</span><span class="op" id="1524074">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1524081">make</span><span class="op" id="1524085">(</span><span class="keyword" id="1524086">chan</span>&nbsp;<span class="ident" id="1524091">requestAndChan</span><span class="op" id="1524105">,</span>&nbsp;<span class="num" id="1524107">1</span><span class="op" id="1524108">)</span><span class="op" id="1524109">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524113">writech</span><span class="op" id="1524120">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1524125">make</span><span class="op" id="1524129">(</span><span class="keyword" id="1524130">chan</span>&nbsp;<span class="ident" id="1524135">writeRequest</span><span class="op" id="1524147">,</span>&nbsp;<span class="num" id="1524149">1</span><span class="op" id="1524150">)</span><span class="op" id="1524151">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524155">closech</span><span class="op" id="1524162">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1524167">make</span><span class="op" id="1524171">(</span><span class="keyword" id="1524172">chan</span>&nbsp;<span class="keyword" id="1524177">struct</span><span class="op" id="1524183">{</span><span class="op" id="1524184">}</span><span class="op" id="1524185">)</span><span class="op" id="1524186">,</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524190">writeErrCh</span><span class="op" id="1524200">:</span>&nbsp;<span class="builtinfunc" id="1524202">make</span><span class="op" id="1524206">(</span><span class="keyword" id="1524207">chan</span>&nbsp;<span class="builtintype" id="1524212">error</span><span class="op" id="1524217">,</span>&nbsp;<span class="num" id="1524219">1</span><span class="op" id="1524220">)</span><span class="op" id="1524221">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1524224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524227">tlsDial</span>&nbsp;<span class="op" id="1524235">:=</span>&nbsp;<span class="ident" id="1524238">t</span><span class="op" id="1524239">.</span><span class="ident" id="1524240">DialTLS</span>&nbsp;<span class="op" id="1524248">!=</span>&nbsp;<span class="ident" id="1524251">nil</span>&nbsp;<span class="op" id="1524255">&amp;&amp;</span>&nbsp;<span class="ident" id="1524258">cm</span><span class="op" id="1524260">.</span><span class="ident" id="1524261">targetScheme</span>&nbsp;<span class="op" id="1524274">==</span>&nbsp;<span class="string" id="1524277">&#34;https&#34;</span>&nbsp;<span class="op" id="1524285">&amp;&amp;</span>&nbsp;<span class="ident" id="1524288">cm</span><span class="op" id="1524290">.</span><span class="ident" id="1524291">proxyURL</span>&nbsp;<span class="op" id="1524300">==</span>&nbsp;<span class="ident" id="1524303">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1524308">if</span>&nbsp;<span class="ident" id="1524311">tlsDial</span>&nbsp;<span class="op" id="1524319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1524323">var</span>&nbsp;<span class="ident" id="1524327">err</span>&nbsp;<span class="builtintype" id="1524331">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524339">pconn</span><span class="op" id="1524344">.</span><span class="ident" id="1524345">conn</span><span class="op" id="1524349">,</span>&nbsp;<span class="ident" id="1524351">err</span>&nbsp;<span class="op" id="1524355">=</span>&nbsp;<span class="ident" id="1524357">t</span><span class="op" id="1524358">.</span><span class="ident" id="1524359">DialTLS</span><span class="op" id="1524366">(</span><span class="string" id="1524367">&#34;tcp&#34;</span><span class="op" id="1524372">,</span>&nbsp;<span class="ident" id="1524374">cm</span><span class="op" id="1524376">.</span><span class="ident" id="1524377">addr</span><span class="op" id="1524381">(</span><span class="op" id="1524382">)</span><span class="op" id="1524383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1524387">if</span>&nbsp;<span class="ident" id="1524390">err</span>&nbsp;<span class="op" id="1524394">!=</span>&nbsp;<span class="ident" id="1524397">nil</span>&nbsp;<span class="op" id="1524401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1524406">return</span>&nbsp;<span class="ident" id="1524413">nil</span><span class="op" id="1524416">,</span>&nbsp;<span class="ident" id="1524418">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1524424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1524428">if</span>&nbsp;<span class="ident" id="1524431">tc</span><span class="op" id="1524433">,</span>&nbsp;<span class="ident" id="1524435">ok</span>&nbsp;<span class="op" id="1524438">:=</span>&nbsp;<span class="ident" id="1524441">pconn</span><span class="op" id="1524446">.</span><span class="ident" id="1524447">conn</span><span class="op" id="1524451">.</span><span class="op" id="1524452">(</span><span class="op" id="1524453">*</span><span class="ident" id="1524454">tls</span><span class="op" id="1524457">.</span><span class="ident" id="1524458">Conn</span><span class="op" id="1524462">)</span><span class="op" id="1524463">;</span>&nbsp;<span class="ident" id="1524465">ok</span>&nbsp;<span class="op" id="1524468">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524473">cs</span>&nbsp;<span class="op" id="1524476">:=</span>&nbsp;<span class="ident" id="1524479">tc</span><span class="op" id="1524481">.</span><span class="ident" id="1524482">ConnectionState</span><span class="op" id="1524497">(</span><span class="op" id="1524498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524503">pconn</span><span class="op" id="1524508">.</span><span class="ident" id="1524509">tlsState</span>&nbsp;<span class="op" id="1524518">=</span>&nbsp;<span class="op" id="1524520">&amp;</span><span class="ident" id="1524521">cs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1524526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1524529">}</span>&nbsp;<span class="keyword" id="1524531">else</span>&nbsp;<span class="op" id="1524536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524540">conn</span><span class="op" id="1524544">,</span>&nbsp;<span class="ident" id="1524546">err</span>&nbsp;<span class="op" id="1524550">:=</span>&nbsp;<span class="ident" id="1524553">t</span><span class="op" id="1524554">.</span><span class="ident" id="1524555">dial</span><span class="op" id="1524559">(</span><span class="string" id="1524560">&#34;tcp&#34;</span><span class="op" id="1524565">,</span>&nbsp;<span class="ident" id="1524567">cm</span><span class="op" id="1524569">.</span><span class="ident" id="1524570">addr</span><span class="op" id="1524574">(</span><span class="op" id="1524575">)</span><span class="op" id="1524576">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1524580">if</span>&nbsp;<span class="ident" id="1524583">err</span>&nbsp;<span class="op" id="1524587">!=</span>&nbsp;<span class="ident" id="1524590">nil</span>&nbsp;<span class="op" id="1524594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1524599">if</span>&nbsp;<span class="ident" id="1524602">cm</span><span class="op" id="1524604">.</span><span class="ident" id="1524605">proxyURL</span>&nbsp;<span class="op" id="1524614">!=</span>&nbsp;<span class="ident" id="1524617">nil</span>&nbsp;<span class="op" id="1524621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524627">err</span>&nbsp;<span class="op" id="1524631">=</span>&nbsp;<span class="ident" id="1524633">fmt</span><span class="op" id="1524636">.</span><span class="ident" id="1524637">Errorf</span><span class="op" id="1524643">(</span><span class="string" id="1524644">&#34;http:&nbsp;error&nbsp;connecting&nbsp;to&nbsp;proxy&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="1524684">,</span>&nbsp;<span class="ident" id="1524686">cm</span><span class="op" id="1524688">.</span><span class="ident" id="1524689">proxyURL</span><span class="op" id="1524697">,</span>&nbsp;<span class="ident" id="1524699">err</span><span class="op" id="1524702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1524707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1524712">return</span>&nbsp;<span class="ident" id="1524719">nil</span><span class="op" id="1524722">,</span>&nbsp;<span class="ident" id="1524724">err</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1524730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524734">pconn</span><span class="op" id="1524739">.</span><span class="ident" id="1524740">conn</span>&nbsp;<span class="op" id="1524745">=</span>&nbsp;<span class="ident" id="1524747">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1524753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1524757">//&nbsp;Proxy&nbsp;setup.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1524774">switch</span>&nbsp;<span class="op" id="1524781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1524784">case</span>&nbsp;<span class="ident" id="1524789">cm</span><span class="op" id="1524791">.</span><span class="ident" id="1524792">proxyURL</span>&nbsp;<span class="op" id="1524801">==</span>&nbsp;<span class="ident" id="1524804">nil</span><span class="op" id="1524807">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1524811">//&nbsp;Do&nbsp;nothing.&nbsp;Not&nbsp;using&nbsp;a&nbsp;proxy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1524846">case</span>&nbsp;<span class="ident" id="1524851">cm</span><span class="op" id="1524853">.</span><span class="ident" id="1524854">targetScheme</span>&nbsp;<span class="op" id="1524867">==</span>&nbsp;<span class="string" id="1524870">&#34;http&#34;</span><span class="op" id="1524876">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524880">pconn</span><span class="op" id="1524885">.</span><span class="ident" id="1524886">isProxy</span>&nbsp;<span class="op" id="1524894">=</span>&nbsp;<span class="builtintype" id="1524896">true</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1524903">if</span>&nbsp;<span class="ident" id="1524906">pa</span>&nbsp;<span class="op" id="1524909">:=</span>&nbsp;<span class="ident" id="1524912">cm</span><span class="op" id="1524914">.</span><span class="ident" id="1524915">proxyAuth</span><span class="op" id="1524924">(</span><span class="op" id="1524925">)</span><span class="op" id="1524926">;</span>&nbsp;<span class="ident" id="1524928">pa</span>&nbsp;<span class="op" id="1524931">!=</span>&nbsp;<span class="string" id="1524934">&#34;&#34;</span>&nbsp;<span class="op" id="1524937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524942">pconn</span><span class="op" id="1524947">.</span><span class="ident" id="1524948">mutateHeaderFunc</span>&nbsp;<span class="op" id="1524965">=</span>&nbsp;<span class="keyword" id="1524967">func</span><span class="op" id="1524971">(</span><span class="ident" id="1524972">h</span>&nbsp;<span class="ident" id="1524974">Header</span><span class="op" id="1524980">)</span>&nbsp;<span class="op" id="1524982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1524988">h</span><span class="op" id="1524989">.</span><span class="ident" id="1524990">Set</span><span class="op" id="1524993">(</span><span class="string" id="1524994">&#34;Proxy-Authorization&#34;</span><span class="op" id="1525015">,</span>&nbsp;<span class="ident" id="1525017">pa</span><span class="op" id="1525019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1525024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1525028">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1525031">case</span>&nbsp;<span class="ident" id="1525036">cm</span><span class="op" id="1525038">.</span><span class="ident" id="1525039">targetScheme</span>&nbsp;<span class="op" id="1525052">==</span>&nbsp;<span class="string" id="1525055">&#34;https&#34;</span><span class="op" id="1525062">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525066">conn</span>&nbsp;<span class="op" id="1525071">:=</span>&nbsp;<span class="ident" id="1525074">pconn</span><span class="op" id="1525079">.</span><span class="ident" id="1525080">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525087">connectReq</span>&nbsp;<span class="op" id="1525098">:=</span>&nbsp;<span class="op" id="1525101">&amp;</span><span class="ident" id="1525102">Request</span><span class="op" id="1525109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525114">Method</span><span class="op" id="1525120">:</span>&nbsp;<span class="string" id="1525122">&#34;CONNECT&#34;</span><span class="op" id="1525131">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525136">URL</span><span class="op" id="1525139">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1525144">&amp;</span><span class="ident" id="1525145">url</span><span class="op" id="1525148">.</span><span class="ident" id="1525149">URL</span><span class="op" id="1525152">{</span><span class="ident" id="1525153">Opaque</span><span class="op" id="1525159">:</span>&nbsp;<span class="ident" id="1525161">cm</span><span class="op" id="1525163">.</span><span class="ident" id="1525164">targetAddr</span><span class="op" id="1525174">}</span><span class="op" id="1525175">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525180">Host</span><span class="op" id="1525184">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1525188">cm</span><span class="op" id="1525190">.</span><span class="ident" id="1525191">targetAddr</span><span class="op" id="1525201">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525206">Header</span><span class="op" id="1525212">:</span>&nbsp;<span class="builtinfunc" id="1525214">make</span><span class="op" id="1525218">(</span><span class="ident" id="1525219">Header</span><span class="op" id="1525225">)</span><span class="op" id="1525226">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1525230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1525234">if</span>&nbsp;<span class="ident" id="1525237">pa</span>&nbsp;<span class="op" id="1525240">:=</span>&nbsp;<span class="ident" id="1525243">cm</span><span class="op" id="1525245">.</span><span class="ident" id="1525246">proxyAuth</span><span class="op" id="1525255">(</span><span class="op" id="1525256">)</span><span class="op" id="1525257">;</span>&nbsp;<span class="ident" id="1525259">pa</span>&nbsp;<span class="op" id="1525262">!=</span>&nbsp;<span class="string" id="1525265">&#34;&#34;</span>&nbsp;<span class="op" id="1525268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525273">connectReq</span><span class="op" id="1525283">.</span><span class="ident" id="1525284">Header</span><span class="op" id="1525290">.</span><span class="ident" id="1525291">Set</span><span class="op" id="1525294">(</span><span class="string" id="1525295">&#34;Proxy-Authorization&#34;</span><span class="op" id="1525316">,</span>&nbsp;<span class="ident" id="1525318">pa</span><span class="op" id="1525320">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1525324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525328">connectReq</span><span class="op" id="1525338">.</span><span class="ident" id="1525339">Write</span><span class="op" id="1525344">(</span><span class="ident" id="1525345">conn</span><span class="op" id="1525349">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1525354">//&nbsp;Read&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1525374">//&nbsp;Okay&nbsp;to&nbsp;use&nbsp;and&nbsp;discard&nbsp;buffered&nbsp;reader&nbsp;here,&nbsp;because</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1525433">//&nbsp;TLS&nbsp;server&nbsp;will&nbsp;not&nbsp;speak&nbsp;until&nbsp;spoken&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525481">br</span>&nbsp;<span class="op" id="1525484">:=</span>&nbsp;<span class="ident" id="1525487">bufio</span><span class="op" id="1525492">.</span><span class="ident" id="1525493">NewReader</span><span class="op" id="1525502">(</span><span class="ident" id="1525503">conn</span><span class="op" id="1525507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525511">resp</span><span class="op" id="1525515">,</span>&nbsp;<span class="ident" id="1525517">err</span>&nbsp;<span class="op" id="1525521">:=</span>&nbsp;<span class="ident" id="1525524">ReadResponse</span><span class="op" id="1525536">(</span><span class="ident" id="1525537">br</span><span class="op" id="1525539">,</span>&nbsp;<span class="ident" id="1525541">connectReq</span><span class="op" id="1525551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1525555">if</span>&nbsp;<span class="ident" id="1525558">err</span>&nbsp;<span class="op" id="1525562">!=</span>&nbsp;<span class="ident" id="1525565">nil</span>&nbsp;<span class="op" id="1525569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525574">conn</span><span class="op" id="1525578">.</span><span class="ident" id="1525579">Close</span><span class="op" id="1525584">(</span><span class="op" id="1525585">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1525590">return</span>&nbsp;<span class="ident" id="1525597">nil</span><span class="op" id="1525600">,</span>&nbsp;<span class="ident" id="1525602">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1525608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1525612">if</span>&nbsp;<span class="ident" id="1525615">resp</span><span class="op" id="1525619">.</span><span class="ident" id="1525620">StatusCode</span>&nbsp;<span class="op" id="1525631">!=</span>&nbsp;<span class="num" id="1525634">200</span>&nbsp;<span class="op" id="1525638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525643">f</span>&nbsp;<span class="op" id="1525645">:=</span>&nbsp;<span class="ident" id="1525648">strings</span><span class="op" id="1525655">.</span><span class="ident" id="1525656">SplitN</span><span class="op" id="1525662">(</span><span class="ident" id="1525663">resp</span><span class="op" id="1525667">.</span><span class="ident" id="1525668">Status</span><span class="op" id="1525674">,</span>&nbsp;<span class="string" id="1525676">&#34;&nbsp;&#34;</span><span class="op" id="1525679">,</span>&nbsp;<span class="num" id="1525681">2</span><span class="op" id="1525682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525687">conn</span><span class="op" id="1525691">.</span><span class="ident" id="1525692">Close</span><span class="op" id="1525697">(</span><span class="op" id="1525698">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1525703">return</span>&nbsp;<span class="ident" id="1525710">nil</span><span class="op" id="1525713">,</span>&nbsp;<span class="ident" id="1525715">errors</span><span class="op" id="1525721">.</span><span class="ident" id="1525722">New</span><span class="op" id="1525725">(</span><span class="ident" id="1525726">f</span><span class="op" id="1525727">[</span><span class="num" id="1525728">1</span><span class="op" id="1525729">]</span><span class="op" id="1525730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1525734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1525737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1525741">if</span>&nbsp;<span class="ident" id="1525744">cm</span><span class="op" id="1525746">.</span><span class="ident" id="1525747">targetScheme</span>&nbsp;<span class="op" id="1525760">==</span>&nbsp;<span class="string" id="1525763">&#34;https&#34;</span>&nbsp;<span class="op" id="1525771">&amp;&amp;</span>&nbsp;<span class="op" id="1525774">!</span><span class="ident" id="1525775">tlsDial</span>&nbsp;<span class="op" id="1525783">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1525787">//&nbsp;Initiate&nbsp;TLS&nbsp;and&nbsp;check&nbsp;remote&nbsp;host&nbsp;name&nbsp;against&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525853">cfg</span>&nbsp;<span class="op" id="1525857">:=</span>&nbsp;<span class="ident" id="1525860">t</span><span class="op" id="1525861">.</span><span class="ident" id="1525862">TLSClientConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1525880">if</span>&nbsp;<span class="ident" id="1525883">cfg</span>&nbsp;<span class="op" id="1525887">==</span>&nbsp;<span class="ident" id="1525890">nil</span>&nbsp;<span class="op" id="1525894">||</span>&nbsp;<span class="ident" id="1525897">cfg</span><span class="op" id="1525900">.</span><span class="ident" id="1525901">ServerName</span>&nbsp;<span class="op" id="1525912">==</span>&nbsp;<span class="string" id="1525915">&#34;&#34;</span>&nbsp;<span class="op" id="1525918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525923">host</span>&nbsp;<span class="op" id="1525928">:=</span>&nbsp;<span class="ident" id="1525931">cm</span><span class="op" id="1525933">.</span><span class="ident" id="1525934">tlsHost</span><span class="op" id="1525941">(</span><span class="op" id="1525942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1525947">if</span>&nbsp;<span class="ident" id="1525950">cfg</span>&nbsp;<span class="op" id="1525954">==</span>&nbsp;<span class="ident" id="1525957">nil</span>&nbsp;<span class="op" id="1525961">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1525967">cfg</span>&nbsp;<span class="op" id="1525971">=</span>&nbsp;<span class="op" id="1525973">&amp;</span><span class="ident" id="1525974">tls</span><span class="op" id="1525977">.</span><span class="ident" id="1525978">Config</span><span class="op" id="1525984">{</span><span class="ident" id="1525985">ServerName</span><span class="op" id="1525995">:</span>&nbsp;<span class="ident" id="1525997">host</span><span class="op" id="1526001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526006">}</span>&nbsp;<span class="keyword" id="1526008">else</span>&nbsp;<span class="op" id="1526013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526019">clone</span>&nbsp;<span class="op" id="1526025">:=</span>&nbsp;<span class="op" id="1526028">*</span><span class="ident" id="1526029">cfg</span>&nbsp;<span class="comment" id="1526033">//&nbsp;shallow&nbsp;clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526054">clone</span><span class="op" id="1526059">.</span><span class="ident" id="1526060">ServerName</span>&nbsp;<span class="op" id="1526071">=</span>&nbsp;<span class="ident" id="1526073">host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526082">cfg</span>&nbsp;<span class="op" id="1526086">=</span>&nbsp;<span class="op" id="1526088">&amp;</span><span class="ident" id="1526089">clone</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526106">plainConn</span>&nbsp;<span class="op" id="1526116">:=</span>&nbsp;<span class="ident" id="1526119">pconn</span><span class="op" id="1526124">.</span><span class="ident" id="1526125">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526132">tlsConn</span>&nbsp;<span class="op" id="1526140">:=</span>&nbsp;<span class="ident" id="1526143">tls</span><span class="op" id="1526146">.</span><span class="ident" id="1526147">Client</span><span class="op" id="1526153">(</span><span class="ident" id="1526154">plainConn</span><span class="op" id="1526163">,</span>&nbsp;<span class="ident" id="1526165">cfg</span><span class="op" id="1526168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526172">errc</span>&nbsp;<span class="op" id="1526177">:=</span>&nbsp;<span class="builtinfunc" id="1526180">make</span><span class="op" id="1526184">(</span><span class="keyword" id="1526185">chan</span>&nbsp;<span class="builtintype" id="1526190">error</span><span class="op" id="1526195">,</span>&nbsp;<span class="num" id="1526197">2</span><span class="op" id="1526198">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526202">var</span>&nbsp;<span class="ident" id="1526206">timer</span>&nbsp;<span class="op" id="1526212">*</span><span class="ident" id="1526213">time</span><span class="op" id="1526217">.</span><span class="ident" id="1526218">Timer</span>&nbsp;<span class="comment" id="1526224">//&nbsp;for&nbsp;canceling&nbsp;TLS&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526257">if</span>&nbsp;<span class="ident" id="1526260">d</span>&nbsp;<span class="op" id="1526262">:=</span>&nbsp;<span class="ident" id="1526265">t</span><span class="op" id="1526266">.</span><span class="ident" id="1526267">TLSHandshakeTimeout</span><span class="op" id="1526286">;</span>&nbsp;<span class="ident" id="1526288">d</span>&nbsp;<span class="op" id="1526290">!=</span>&nbsp;<span class="num" id="1526293">0</span>&nbsp;<span class="op" id="1526295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526300">timer</span>&nbsp;<span class="op" id="1526306">=</span>&nbsp;<span class="ident" id="1526308">time</span><span class="op" id="1526312">.</span><span class="ident" id="1526313">AfterFunc</span><span class="op" id="1526322">(</span><span class="ident" id="1526323">d</span><span class="op" id="1526324">,</span>&nbsp;<span class="keyword" id="1526326">func</span><span class="op" id="1526330">(</span><span class="op" id="1526331">)</span>&nbsp;<span class="op" id="1526333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526339">errc</span>&nbsp;<span class="op" id="1526344">&lt;-</span>&nbsp;<span class="ident" id="1526347">tlsHandshakeTimeoutError</span><span class="op" id="1526371">{</span><span class="op" id="1526372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526377">}</span><span class="op" id="1526378">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526386">go</span>&nbsp;<span class="keyword" id="1526389">func</span><span class="op" id="1526393">(</span><span class="op" id="1526394">)</span>&nbsp;<span class="op" id="1526396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526401">err</span>&nbsp;<span class="op" id="1526405">:=</span>&nbsp;<span class="ident" id="1526408">tlsConn</span><span class="op" id="1526415">.</span><span class="ident" id="1526416">Handshake</span><span class="op" id="1526425">(</span><span class="op" id="1526426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526431">if</span>&nbsp;<span class="ident" id="1526434">timer</span>&nbsp;<span class="op" id="1526440">!=</span>&nbsp;<span class="ident" id="1526443">nil</span>&nbsp;<span class="op" id="1526447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526453">timer</span><span class="op" id="1526458">.</span><span class="ident" id="1526459">Stop</span><span class="op" id="1526463">(</span><span class="op" id="1526464">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526474">errc</span>&nbsp;<span class="op" id="1526479">&lt;-</span>&nbsp;<span class="ident" id="1526482">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526488">}</span><span class="op" id="1526489">(</span><span class="op" id="1526490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526494">if</span>&nbsp;<span class="ident" id="1526497">err</span>&nbsp;<span class="op" id="1526501">:=</span>&nbsp;<span class="op" id="1526504">&lt;-</span><span class="ident" id="1526506">errc</span><span class="op" id="1526510">;</span>&nbsp;<span class="ident" id="1526512">err</span>&nbsp;<span class="op" id="1526516">!=</span>&nbsp;<span class="ident" id="1526519">nil</span>&nbsp;<span class="op" id="1526523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526528">plainConn</span><span class="op" id="1526537">.</span><span class="ident" id="1526538">Close</span><span class="op" id="1526543">(</span><span class="op" id="1526544">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526549">return</span>&nbsp;<span class="ident" id="1526556">nil</span><span class="op" id="1526559">,</span>&nbsp;<span class="ident" id="1526561">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526571">if</span>&nbsp;<span class="op" id="1526574">!</span><span class="ident" id="1526575">cfg</span><span class="op" id="1526578">.</span><span class="ident" id="1526579">InsecureSkipVerify</span>&nbsp;<span class="op" id="1526598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526603">if</span>&nbsp;<span class="ident" id="1526606">err</span>&nbsp;<span class="op" id="1526610">:=</span>&nbsp;<span class="ident" id="1526613">tlsConn</span><span class="op" id="1526620">.</span><span class="ident" id="1526621">VerifyHostname</span><span class="op" id="1526635">(</span><span class="ident" id="1526636">cfg</span><span class="op" id="1526639">.</span><span class="ident" id="1526640">ServerName</span><span class="op" id="1526650">)</span><span class="op" id="1526651">;</span>&nbsp;<span class="ident" id="1526653">err</span>&nbsp;<span class="op" id="1526657">!=</span>&nbsp;<span class="ident" id="1526660">nil</span>&nbsp;<span class="op" id="1526664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526670">plainConn</span><span class="op" id="1526679">.</span><span class="ident" id="1526680">Close</span><span class="op" id="1526685">(</span><span class="op" id="1526686">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526692">return</span>&nbsp;<span class="ident" id="1526699">nil</span><span class="op" id="1526702">,</span>&nbsp;<span class="ident" id="1526704">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526719">cs</span>&nbsp;<span class="op" id="1526722">:=</span>&nbsp;<span class="ident" id="1526725">tlsConn</span><span class="op" id="1526732">.</span><span class="ident" id="1526733">ConnectionState</span><span class="op" id="1526748">(</span><span class="op" id="1526749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526753">pconn</span><span class="op" id="1526758">.</span><span class="ident" id="1526759">tlsState</span>&nbsp;<span class="op" id="1526768">=</span>&nbsp;<span class="op" id="1526770">&amp;</span><span class="ident" id="1526771">cs</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526776">pconn</span><span class="op" id="1526781">.</span><span class="ident" id="1526782">conn</span>&nbsp;<span class="op" id="1526787">=</span>&nbsp;<span class="ident" id="1526789">tlsConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1526798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526802">pconn</span><span class="op" id="1526807">.</span><span class="ident" id="1526808">br</span>&nbsp;<span class="op" id="1526811">=</span>&nbsp;<span class="ident" id="1526813">bufio</span><span class="op" id="1526818">.</span><span class="ident" id="1526819">NewReader</span><span class="op" id="1526828">(</span><span class="ident" id="1526829">noteEOFReader</span><span class="op" id="1526842">{</span><span class="ident" id="1526843">pconn</span><span class="op" id="1526848">.</span><span class="ident" id="1526849">conn</span><span class="op" id="1526853">,</span>&nbsp;<span class="op" id="1526855">&amp;</span><span class="ident" id="1526856">pconn</span><span class="op" id="1526861">.</span><span class="ident" id="1526862">sawEOF</span><span class="op" id="1526868">}</span><span class="op" id="1526869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1526872">pconn</span><span class="op" id="1526877">.</span><span class="ident" id="1526878">bw</span>&nbsp;<span class="op" id="1526881">=</span>&nbsp;<span class="ident" id="1526883">bufio</span><span class="op" id="1526888">.</span><span class="ident" id="1526889">NewWriter</span><span class="op" id="1526898">(</span><span class="ident" id="1526899">pconn</span><span class="op" id="1526904">.</span><span class="ident" id="1526905">conn</span><span class="op" id="1526909">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526912">go</span>&nbsp;<span class="ident" id="1526915">pconn</span><span class="op" id="1526920">.</span><span class="ident" id="1526921">readLoop</span><span class="op" id="1526929">(</span><span class="op" id="1526930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526933">go</span>&nbsp;<span class="ident" id="1526936">pconn</span><span class="op" id="1526941">.</span><span class="ident" id="1526942">writeLoop</span><span class="op" id="1526951">(</span><span class="op" id="1526952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1526955">return</span>&nbsp;<span class="ident" id="1526962">pconn</span><span class="op" id="1526967">,</span>&nbsp;<span class="ident" id="1526969">nil</span><br>
<span class="lineno"></span><span class="op" id="1526973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="1526976">//&nbsp;useProxy&nbsp;returns&nbsp;true&nbsp;if&nbsp;requests&nbsp;to&nbsp;addr&nbsp;should&nbsp;use&nbsp;a&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="1527041">//&nbsp;according&nbsp;to&nbsp;the&nbsp;NO_PROXY&nbsp;or&nbsp;no_proxy&nbsp;environment&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="1527104">//&nbsp;addr&nbsp;is&nbsp;always&nbsp;a&nbsp;canonicalAddr&nbsp;with&nbsp;a&nbsp;host&nbsp;and&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword" id="1527160">func</span>&nbsp;<span class="ident" id="1527165">useProxy</span><span class="op" id="1527173">(</span><span class="ident" id="1527174">addr</span>&nbsp;<span class="builtintype" id="1527179">string</span><span class="op" id="1527185">)</span>&nbsp;<span class="builtintype" id="1527187">bool</span>&nbsp;<span class="op" id="1527192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527195">if</span>&nbsp;<span class="builtinfunc" id="1527198">len</span><span class="op" id="1527201">(</span><span class="ident" id="1527202">addr</span><span class="op" id="1527206">)</span>&nbsp;<span class="op" id="1527208">==</span>&nbsp;<span class="num" id="1527211">0</span>&nbsp;<span class="op" id="1527213">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527217">return</span>&nbsp;<span class="builtintype" id="1527224">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527233">host</span><span class="op" id="1527237">,</span>&nbsp;<span class="ident" id="1527239">_</span><span class="op" id="1527240">,</span>&nbsp;<span class="ident" id="1527242">err</span>&nbsp;<span class="op" id="1527246">:=</span>&nbsp;<span class="ident" id="1527249">net</span><span class="op" id="1527252">.</span><span class="ident" id="1527253">SplitHostPort</span><span class="op" id="1527266">(</span><span class="ident" id="1527267">addr</span><span class="op" id="1527271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527274">if</span>&nbsp;<span class="ident" id="1527277">err</span>&nbsp;<span class="op" id="1527281">!=</span>&nbsp;<span class="ident" id="1527284">nil</span>&nbsp;<span class="op" id="1527288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527292">return</span>&nbsp;<span class="builtintype" id="1527299">false</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527309">if</span>&nbsp;<span class="ident" id="1527312">host</span>&nbsp;<span class="op" id="1527317">==</span>&nbsp;<span class="string" id="1527320">&#34;localhost&#34;</span>&nbsp;<span class="op" id="1527332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527336">return</span>&nbsp;<span class="builtintype" id="1527343">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527353">if</span>&nbsp;<span class="ident" id="1527356">ip</span>&nbsp;<span class="op" id="1527359">:=</span>&nbsp;<span class="ident" id="1527362">net</span><span class="op" id="1527365">.</span><span class="ident" id="1527366">ParseIP</span><span class="op" id="1527373">(</span><span class="ident" id="1527374">host</span><span class="op" id="1527378">)</span><span class="op" id="1527379">;</span>&nbsp;<span class="ident" id="1527381">ip</span>&nbsp;<span class="op" id="1527384">!=</span>&nbsp;<span class="ident" id="1527387">nil</span>&nbsp;<span class="op" id="1527391">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527395">if</span>&nbsp;<span class="ident" id="1527398">ip</span><span class="op" id="1527400">.</span><span class="ident" id="1527401">IsLoopback</span><span class="op" id="1527411">(</span><span class="op" id="1527412">)</span>&nbsp;<span class="op" id="1527414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527419">return</span>&nbsp;<span class="builtintype" id="1527426">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527441">no_proxy</span>&nbsp;<span class="op" id="1527450">:=</span>&nbsp;<span class="ident" id="1527453">noProxyEnv</span><span class="op" id="1527463">.</span><span class="ident" id="1527464">Get</span><span class="op" id="1527467">(</span><span class="op" id="1527468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527471">if</span>&nbsp;<span class="ident" id="1527474">no_proxy</span>&nbsp;<span class="op" id="1527483">==</span>&nbsp;<span class="string" id="1527486">&#34;*&#34;</span>&nbsp;<span class="op" id="1527490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527494">return</span>&nbsp;<span class="builtintype" id="1527501">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527512">addr</span>&nbsp;<span class="op" id="1527517">=</span>&nbsp;<span class="ident" id="1527519">strings</span><span class="op" id="1527526">.</span><span class="ident" id="1527527">ToLower</span><span class="op" id="1527534">(</span><span class="ident" id="1527535">strings</span><span class="op" id="1527542">.</span><span class="ident" id="1527543">TrimSpace</span><span class="op" id="1527552">(</span><span class="ident" id="1527553">addr</span><span class="op" id="1527557">)</span><span class="op" id="1527558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527561">if</span>&nbsp;<span class="ident" id="1527564">hasPort</span><span class="op" id="1527571">(</span><span class="ident" id="1527572">addr</span><span class="op" id="1527576">)</span>&nbsp;<span class="op" id="1527578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527582">addr</span>&nbsp;<span class="op" id="1527587">=</span>&nbsp;<span class="ident" id="1527589">addr</span><span class="op" id="1527593">[</span><span class="op" id="1527594">:</span><span class="ident" id="1527595">strings</span><span class="op" id="1527602">.</span><span class="ident" id="1527603">LastIndex</span><span class="op" id="1527612">(</span><span class="ident" id="1527613">addr</span><span class="op" id="1527617">,</span>&nbsp;<span class="string" id="1527619">&#34;:&#34;</span><span class="op" id="1527622">)</span><span class="op" id="1527623">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527630">for</span>&nbsp;<span class="ident" id="1527634">_</span><span class="op" id="1527635">,</span>&nbsp;<span class="ident" id="1527637">p</span>&nbsp;<span class="op" id="1527639">:=</span>&nbsp;<span class="keyword" id="1527642">range</span>&nbsp;<span class="ident" id="1527648">strings</span><span class="op" id="1527655">.</span><span class="ident" id="1527656">Split</span><span class="op" id="1527661">(</span><span class="ident" id="1527662">no_proxy</span><span class="op" id="1527670">,</span>&nbsp;<span class="string" id="1527672">&#34;,&#34;</span><span class="op" id="1527675">)</span>&nbsp;<span class="op" id="1527677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527681">p</span>&nbsp;<span class="op" id="1527683">=</span>&nbsp;<span class="ident" id="1527685">strings</span><span class="op" id="1527692">.</span><span class="ident" id="1527693">ToLower</span><span class="op" id="1527700">(</span><span class="ident" id="1527701">strings</span><span class="op" id="1527708">.</span><span class="ident" id="1527709">TrimSpace</span><span class="op" id="1527718">(</span><span class="ident" id="1527719">p</span><span class="op" id="1527720">)</span><span class="op" id="1527721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527725">if</span>&nbsp;<span class="builtinfunc" id="1527728">len</span><span class="op" id="1527731">(</span><span class="ident" id="1527732">p</span><span class="op" id="1527733">)</span>&nbsp;<span class="op" id="1527735">==</span>&nbsp;<span class="num" id="1527738">0</span>&nbsp;<span class="op" id="1527740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527745">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527756">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527760">if</span>&nbsp;<span class="ident" id="1527763">hasPort</span><span class="op" id="1527770">(</span><span class="ident" id="1527771">p</span><span class="op" id="1527772">)</span>&nbsp;<span class="op" id="1527774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1527779">p</span>&nbsp;<span class="op" id="1527781">=</span>&nbsp;<span class="ident" id="1527783">p</span><span class="op" id="1527784">[</span><span class="op" id="1527785">:</span><span class="ident" id="1527786">strings</span><span class="op" id="1527793">.</span><span class="ident" id="1527794">LastIndex</span><span class="op" id="1527803">(</span><span class="ident" id="1527804">p</span><span class="op" id="1527805">,</span>&nbsp;<span class="string" id="1527807">&#34;:&#34;</span><span class="op" id="1527810">)</span><span class="op" id="1527811">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527819">if</span>&nbsp;<span class="ident" id="1527822">addr</span>&nbsp;<span class="op" id="1527827">==</span>&nbsp;<span class="ident" id="1527830">p</span>&nbsp;<span class="op" id="1527832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527837">return</span>&nbsp;<span class="builtintype" id="1527844">false</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1527852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527856">if</span>&nbsp;<span class="ident" id="1527859">p</span><span class="op" id="1527860">[</span><span class="num" id="1527861">0</span><span class="op" id="1527862">]</span>&nbsp;<span class="op" id="1527864">==</span>&nbsp;<span class="string" id="1527867">&#39;.&#39;</span>&nbsp;<span class="op" id="1527871">&amp;&amp;</span>&nbsp;<span class="op" id="1527874">(</span><span class="ident" id="1527875">strings</span><span class="op" id="1527882">.</span><span class="ident" id="1527883">HasSuffix</span><span class="op" id="1527892">(</span><span class="ident" id="1527893">addr</span><span class="op" id="1527897">,</span>&nbsp;<span class="ident" id="1527899">p</span><span class="op" id="1527900">)</span>&nbsp;<span class="op" id="1527902">||</span>&nbsp;<span class="ident" id="1527905">addr</span>&nbsp;<span class="op" id="1527910">==</span>&nbsp;<span class="ident" id="1527913">p</span><span class="op" id="1527914">[</span><span class="num" id="1527915">1</span><span class="op" id="1527916">:</span><span class="op" id="1527917">]</span><span class="op" id="1527918">)</span>&nbsp;<span class="op" id="1527920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1527925">//&nbsp;no_proxy&nbsp;&#34;.foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;&nbsp;or&nbsp;&#34;foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1527986">return</span>&nbsp;<span class="builtintype" id="1527993">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528001">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528005">if</span>&nbsp;<span class="ident" id="1528008">p</span><span class="op" id="1528009">[</span><span class="num" id="1528010">0</span><span class="op" id="1528011">]</span>&nbsp;<span class="op" id="1528013">!=</span>&nbsp;<span class="string" id="1528016">&#39;.&#39;</span>&nbsp;<span class="op" id="1528020">&amp;&amp;</span>&nbsp;<span class="ident" id="1528023">strings</span><span class="op" id="1528030">.</span><span class="ident" id="1528031">HasSuffix</span><span class="op" id="1528040">(</span><span class="ident" id="1528041">addr</span><span class="op" id="1528045">,</span>&nbsp;<span class="ident" id="1528047">p</span><span class="op" id="1528048">)</span>&nbsp;<span class="op" id="1528050">&amp;&amp;</span>&nbsp;<span class="ident" id="1528053">addr</span><span class="op" id="1528057">[</span><span class="builtinfunc" id="1528058">len</span><span class="op" id="1528061">(</span><span class="ident" id="1528062">addr</span><span class="op" id="1528066">)</span><span class="op" id="1528067">-</span><span class="builtinfunc" id="1528068">len</span><span class="op" id="1528071">(</span><span class="ident" id="1528072">p</span><span class="op" id="1528073">)</span><span class="op" id="1528074">-</span><span class="num" id="1528075">1</span><span class="op" id="1528076">]</span>&nbsp;<span class="op" id="1528078">==</span>&nbsp;<span class="string" id="1528081">&#39;.&#39;</span>&nbsp;<span class="op" id="1528085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1528090">//&nbsp;no_proxy&nbsp;&#34;foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528137">return</span>&nbsp;<span class="builtintype" id="1528144">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1528155">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1528158">return</span>&nbsp;<span class="builtintype" id="1528165">true</span><br>
<span class="lineno"></span><span class="op" id="1528170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1528173">//&nbsp;connectMethod&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;(in&nbsp;its&nbsp;String&nbsp;form)&nbsp;for&nbsp;keeping&nbsp;persistent</span><br>
<span class="lineno"></span><span class="comment" id="1528249">//&nbsp;TCP&nbsp;connections&nbsp;alive&nbsp;for&nbsp;subsequent&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno">720</span><span class="comment" id="1528304">//</span><br>
<span class="lineno"></span><span class="comment" id="1528307">//&nbsp;A&nbsp;connect&nbsp;method&nbsp;may&nbsp;be&nbsp;of&nbsp;the&nbsp;following&nbsp;types:</span><br>
<span class="lineno"></span><span class="comment" id="1528358">//</span><br>
<span class="lineno"></span><span class="comment" id="1528361">//&nbsp;Cache&nbsp;key&nbsp;form&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description</span><br>
<span class="lineno"></span><span class="comment" id="1528406">//&nbsp;-----------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------</span><br>
<span class="lineno">725</span><span class="comment" id="1528465">//&nbsp;|http|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="1528532">//&nbsp;|https|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="1528600">//&nbsp;http://proxy.com|https|foo.com&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;then&nbsp;CONNECT&nbsp;to&nbsp;foo.com</span><br>
<span class="lineno"></span><span class="comment" id="1528674">//&nbsp;http://proxy.com|http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;http&nbsp;to&nbsp;anywhere&nbsp;after&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1528752">//</span><br>
<span class="lineno">730</span><span class="comment" id="1528755">//&nbsp;Note:&nbsp;no&nbsp;support&nbsp;to&nbsp;https&nbsp;to&nbsp;the&nbsp;proxy&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="1528802">//</span><br>
<span class="lineno"></span><span class="keyword" id="1528805">type</span>&nbsp;<span class="ident" id="1528810">connectMethod</span>&nbsp;<span class="keyword" id="1528824">struct</span>&nbsp;<span class="op" id="1528831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528834">proxyURL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1528847">*</span><span class="ident" id="1528848">url</span><span class="op" id="1528851">.</span><span class="ident" id="1528852">URL</span>&nbsp;<span class="comment" id="1528856">//&nbsp;nil&nbsp;for&nbsp;no&nbsp;proxy,&nbsp;else&nbsp;full&nbsp;proxy&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528898">targetScheme</span>&nbsp;<span class="builtintype" id="1528911">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1528920">//&nbsp;&#34;http&#34;&nbsp;or&nbsp;&#34;https&#34;</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1528942">targetAddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1528955">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1528964">//&nbsp;Not&nbsp;used&nbsp;if&nbsp;proxy&nbsp;+&nbsp;http&nbsp;targetScheme&nbsp;(4th&nbsp;example&nbsp;in&nbsp;table)</span><br>
<span class="lineno"></span><span class="op" id="1529028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1529031">func</span>&nbsp;<span class="op" id="1529036">(</span><span class="ident" id="1529037">cm</span>&nbsp;<span class="op" id="1529040">*</span><span class="ident" id="1529041">connectMethod</span><span class="op" id="1529054">)</span>&nbsp;<span class="ident" id="1529056">key</span><span class="op" id="1529059">(</span><span class="op" id="1529060">)</span>&nbsp;<span class="ident" id="1529062">connectMethodKey</span>&nbsp;<span class="op" id="1529079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529082">proxyStr</span>&nbsp;<span class="op" id="1529091">:=</span>&nbsp;<span class="string" id="1529094">&#34;&#34;</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529098">targetAddr</span>&nbsp;<span class="op" id="1529109">:=</span>&nbsp;<span class="ident" id="1529112">cm</span><span class="op" id="1529114">.</span><span class="ident" id="1529115">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529127">if</span>&nbsp;<span class="ident" id="1529130">cm</span><span class="op" id="1529132">.</span><span class="ident" id="1529133">proxyURL</span>&nbsp;<span class="op" id="1529142">!=</span>&nbsp;<span class="ident" id="1529145">nil</span>&nbsp;<span class="op" id="1529149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529153">proxyStr</span>&nbsp;<span class="op" id="1529162">=</span>&nbsp;<span class="ident" id="1529164">cm</span><span class="op" id="1529166">.</span><span class="ident" id="1529167">proxyURL</span><span class="op" id="1529175">.</span><span class="ident" id="1529176">String</span><span class="op" id="1529182">(</span><span class="op" id="1529183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529187">if</span>&nbsp;<span class="ident" id="1529190">cm</span><span class="op" id="1529192">.</span><span class="ident" id="1529193">targetScheme</span>&nbsp;<span class="op" id="1529206">==</span>&nbsp;<span class="string" id="1529209">&#34;http&#34;</span>&nbsp;<span class="op" id="1529216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529221">targetAddr</span>&nbsp;<span class="op" id="1529232">=</span>&nbsp;<span class="string" id="1529234">&#34;&#34;</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529245">return</span>&nbsp;<span class="ident" id="1529252">connectMethodKey</span><span class="op" id="1529268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529272">proxy</span><span class="op" id="1529277">:</span>&nbsp;&nbsp;<span class="ident" id="1529280">proxyStr</span><span class="op" id="1529288">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529292">scheme</span><span class="op" id="1529298">:</span>&nbsp;<span class="ident" id="1529300">cm</span><span class="op" id="1529302">.</span><span class="ident" id="1529303">targetScheme</span><span class="op" id="1529315">,</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529319">addr</span><span class="op" id="1529323">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1529327">targetAddr</span><span class="op" id="1529337">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529340">}</span><br>
<span class="lineno"></span><span class="op" id="1529342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1529345">//&nbsp;addr&nbsp;returns&nbsp;the&nbsp;first&nbsp;hop&nbsp;&#34;host:port&#34;&nbsp;to&nbsp;which&nbsp;we&nbsp;need&nbsp;to&nbsp;TCP&nbsp;connect.</span><br>
<span class="lineno">755</span><span class="keyword" id="1529420">func</span>&nbsp;<span class="op" id="1529425">(</span><span class="ident" id="1529426">cm</span>&nbsp;<span class="op" id="1529429">*</span><span class="ident" id="1529430">connectMethod</span><span class="op" id="1529443">)</span>&nbsp;<span class="ident" id="1529445">addr</span><span class="op" id="1529449">(</span><span class="op" id="1529450">)</span>&nbsp;<span class="builtintype" id="1529452">string</span>&nbsp;<span class="op" id="1529459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529462">if</span>&nbsp;<span class="ident" id="1529465">cm</span><span class="op" id="1529467">.</span><span class="ident" id="1529468">proxyURL</span>&nbsp;<span class="op" id="1529477">!=</span>&nbsp;<span class="ident" id="1529480">nil</span>&nbsp;<span class="op" id="1529484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529488">return</span>&nbsp;<span class="ident" id="1529495">canonicalAddr</span><span class="op" id="1529508">(</span><span class="ident" id="1529509">cm</span><span class="op" id="1529511">.</span><span class="ident" id="1529512">proxyURL</span><span class="op" id="1529520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529526">return</span>&nbsp;<span class="ident" id="1529533">cm</span><span class="op" id="1529535">.</span><span class="ident" id="1529536">targetAddr</span><br>
<span class="lineno">760</span><span class="op" id="1529547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1529550">//&nbsp;tlsHost&nbsp;returns&nbsp;the&nbsp;host&nbsp;name&nbsp;to&nbsp;match&nbsp;against&nbsp;the&nbsp;peer&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="1529611">//&nbsp;TLS&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="1529631">func</span>&nbsp;<span class="op" id="1529636">(</span><span class="ident" id="1529637">cm</span>&nbsp;<span class="op" id="1529640">*</span><span class="ident" id="1529641">connectMethod</span><span class="op" id="1529654">)</span>&nbsp;<span class="ident" id="1529656">tlsHost</span><span class="op" id="1529663">(</span><span class="op" id="1529664">)</span>&nbsp;<span class="builtintype" id="1529666">string</span>&nbsp;<span class="op" id="1529673">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529676">h</span>&nbsp;<span class="op" id="1529678">:=</span>&nbsp;<span class="ident" id="1529681">cm</span><span class="op" id="1529683">.</span><span class="ident" id="1529684">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529696">if</span>&nbsp;<span class="ident" id="1529699">hasPort</span><span class="op" id="1529706">(</span><span class="ident" id="1529707">h</span><span class="op" id="1529708">)</span>&nbsp;<span class="op" id="1529710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529714">h</span>&nbsp;<span class="op" id="1529716">=</span>&nbsp;<span class="ident" id="1529718">h</span><span class="op" id="1529719">[</span><span class="op" id="1529720">:</span><span class="ident" id="1529721">strings</span><span class="op" id="1529728">.</span><span class="ident" id="1529729">LastIndex</span><span class="op" id="1529738">(</span><span class="ident" id="1529739">h</span><span class="op" id="1529740">,</span>&nbsp;<span class="string" id="1529742">&#34;:&#34;</span><span class="op" id="1529745">)</span><span class="op" id="1529746">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1529749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1529752">return</span>&nbsp;<span class="ident" id="1529759">h</span><br>
<span class="lineno">770</span><span class="op" id="1529761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1529764">//&nbsp;connectMethodKey&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;version&nbsp;of&nbsp;connectMethod,&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1529832">//&nbsp;stringified&nbsp;proxy&nbsp;URL&nbsp;(or&nbsp;the&nbsp;empty&nbsp;string)&nbsp;instead&nbsp;of&nbsp;a&nbsp;pointer&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1529903">//&nbsp;a&nbsp;URL.</span><br>
<span class="lineno">775</span><span class="keyword" id="1529913">type</span>&nbsp;<span class="ident" id="1529918">connectMethodKey</span>&nbsp;<span class="keyword" id="1529935">struct</span>&nbsp;<span class="op" id="1529942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1529945">proxy</span><span class="op" id="1529950">,</span>&nbsp;<span class="ident" id="1529952">scheme</span><span class="op" id="1529958">,</span>&nbsp;<span class="ident" id="1529960">addr</span>&nbsp;<span class="builtintype" id="1529965">string</span><br>
<span class="lineno"></span><span class="op" id="1529972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1529975">func</span>&nbsp;<span class="op" id="1529980">(</span><span class="ident" id="1529981">k</span>&nbsp;<span class="ident" id="1529983">connectMethodKey</span><span class="op" id="1529999">)</span>&nbsp;<span class="ident" id="1530001">String</span><span class="op" id="1530007">(</span><span class="op" id="1530008">)</span>&nbsp;<span class="builtintype" id="1530010">string</span>&nbsp;<span class="op" id="1530017">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1530020">//&nbsp;Only&nbsp;used&nbsp;by&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1530044">return</span>&nbsp;<span class="ident" id="1530051">fmt</span><span class="op" id="1530054">.</span><span class="ident" id="1530055">Sprintf</span><span class="op" id="1530062">(</span><span class="string" id="1530063">&#34;%s|%s|%s&#34;</span><span class="op" id="1530073">,</span>&nbsp;<span class="ident" id="1530075">k</span><span class="op" id="1530076">.</span><span class="ident" id="1530077">proxy</span><span class="op" id="1530082">,</span>&nbsp;<span class="ident" id="1530084">k</span><span class="op" id="1530085">.</span><span class="ident" id="1530086">scheme</span><span class="op" id="1530092">,</span>&nbsp;<span class="ident" id="1530094">k</span><span class="op" id="1530095">.</span><span class="ident" id="1530096">addr</span><span class="op" id="1530100">)</span><br>
<span class="lineno"></span><span class="op" id="1530102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1530105">//&nbsp;persistConn&nbsp;wraps&nbsp;a&nbsp;connection,&nbsp;usually&nbsp;a&nbsp;persistent&nbsp;one</span><br>
<span class="lineno">785</span><span class="comment" id="1530165">//&nbsp;(but&nbsp;may&nbsp;be&nbsp;used&nbsp;for&nbsp;non-keep-alive&nbsp;requests&nbsp;as&nbsp;well)</span><br>
<span class="lineno"></span><span class="keyword" id="1530222">type</span>&nbsp;<span class="ident" id="1530227">persistConn</span>&nbsp;<span class="keyword" id="1530239">struct</span>&nbsp;<span class="op" id="1530246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530249">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1530258">*</span><span class="ident" id="1530259">Transport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530270">cacheKey</span>&nbsp;<span class="ident" id="1530279">connectMethodKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530297">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1530306">net</span><span class="op" id="1530309">.</span><span class="ident" id="1530310">Conn</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530316">tlsState</span>&nbsp;<span class="op" id="1530325">*</span><span class="ident" id="1530326">tls</span><span class="op" id="1530329">.</span><span class="ident" id="1530330">ConnectionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530347">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1530356">*</span><span class="ident" id="1530357">bufio</span><span class="op" id="1530362">.</span><span class="ident" id="1530363">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1530376">//&nbsp;from&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530390">sawEOF</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1530399">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1530419">//&nbsp;whether&nbsp;we&#39;ve&nbsp;seen&nbsp;EOF&nbsp;from&nbsp;conn;&nbsp;owned&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530475">bw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1530484">*</span><span class="ident" id="1530485">bufio</span><span class="op" id="1530490">.</span><span class="ident" id="1530491">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1530504">//&nbsp;to&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530516">reqch</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1530525">chan</span>&nbsp;<span class="ident" id="1530530">requestAndChan</span>&nbsp;<span class="comment" id="1530545">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530588">writech</span>&nbsp;&nbsp;<span class="keyword" id="1530597">chan</span>&nbsp;<span class="ident" id="1530602">writeRequest</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1530617">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;writeLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530661">closech</span>&nbsp;&nbsp;<span class="keyword" id="1530670">chan</span>&nbsp;<span class="keyword" id="1530675">struct</span><span class="op" id="1530681">{</span><span class="op" id="1530682">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1530690">//&nbsp;closed&nbsp;when&nbsp;conn&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530718">isProxy</span>&nbsp;&nbsp;<span class="builtintype" id="1530727">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1530733">//&nbsp;writeErrCh&nbsp;passes&nbsp;the&nbsp;request&nbsp;write&nbsp;error&nbsp;(usually&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1530793">//&nbsp;from&nbsp;the&nbsp;writeLoop&nbsp;goroutine&nbsp;to&nbsp;the&nbsp;readLoop&nbsp;which&nbsp;passes</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1530855">//&nbsp;it&nbsp;off&nbsp;to&nbsp;the&nbsp;res.Body&nbsp;reader,&nbsp;which&nbsp;then&nbsp;uses&nbsp;it&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1530919">//&nbsp;whether&nbsp;or&nbsp;not&nbsp;a&nbsp;connection&nbsp;can&nbsp;be&nbsp;reused.&nbsp;Issue&nbsp;7569.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1530978">writeErrCh</span>&nbsp;<span class="keyword" id="1530989">chan</span>&nbsp;<span class="builtintype" id="1530994">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531002">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1531023">sync</span><span class="op" id="1531027">.</span><span class="ident" id="1531028">Mutex</span>&nbsp;<span class="comment" id="1531034">//&nbsp;guards&nbsp;following&nbsp;fields</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531062">numExpectedResponses</span>&nbsp;<span class="builtintype" id="1531083">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531088">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1531109">bool</span>&nbsp;<span class="comment" id="1531114">//&nbsp;whether&nbsp;conn&nbsp;has&nbsp;been&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531147">broken</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1531168">bool</span>&nbsp;<span class="comment" id="1531173">//&nbsp;an&nbsp;error&nbsp;has&nbsp;happened&nbsp;on&nbsp;this&nbsp;connection;&nbsp;marked&nbsp;broken&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1531253">//&nbsp;mutateHeaderFunc&nbsp;is&nbsp;an&nbsp;optional&nbsp;func&nbsp;to&nbsp;modify&nbsp;extra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1531310">//&nbsp;headers&nbsp;on&nbsp;each&nbsp;outbound&nbsp;request&nbsp;before&nbsp;it&#39;s&nbsp;written.&nbsp;(the</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1531373">//&nbsp;original&nbsp;Request&nbsp;given&nbsp;to&nbsp;RoundTrip&nbsp;is&nbsp;not&nbsp;modified)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531430">mutateHeaderFunc</span>&nbsp;<span class="keyword" id="1531447">func</span><span class="op" id="1531451">(</span><span class="ident" id="1531452">Header</span><span class="op" id="1531458">)</span><br>
<span class="lineno"></span><span class="op" id="1531460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1531463">//&nbsp;isBroken&nbsp;reports&nbsp;whether&nbsp;this&nbsp;connection&nbsp;is&nbsp;in&nbsp;a&nbsp;known&nbsp;broken&nbsp;state.</span><br>
<span class="lineno">815</span><span class="keyword" id="1531535">func</span>&nbsp;<span class="op" id="1531540">(</span><span class="ident" id="1531541">pc</span>&nbsp;<span class="op" id="1531544">*</span><span class="ident" id="1531545">persistConn</span><span class="op" id="1531556">)</span>&nbsp;<span class="ident" id="1531558">isBroken</span><span class="op" id="1531566">(</span><span class="op" id="1531567">)</span>&nbsp;<span class="builtintype" id="1531569">bool</span>&nbsp;<span class="op" id="1531574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531577">pc</span><span class="op" id="1531579">.</span><span class="ident" id="1531580">lk</span><span class="op" id="1531582">.</span><span class="ident" id="1531583">Lock</span><span class="op" id="1531587">(</span><span class="op" id="1531588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531591">b</span>&nbsp;<span class="op" id="1531593">:=</span>&nbsp;<span class="ident" id="1531596">pc</span><span class="op" id="1531598">.</span><span class="ident" id="1531599">broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531607">pc</span><span class="op" id="1531609">.</span><span class="ident" id="1531610">lk</span><span class="op" id="1531612">.</span><span class="ident" id="1531613">Unlock</span><span class="op" id="1531619">(</span><span class="op" id="1531620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531623">return</span>&nbsp;<span class="ident" id="1531630">b</span><br>
<span class="lineno">820</span><span class="op" id="1531632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1531635">func</span>&nbsp;<span class="op" id="1531640">(</span><span class="ident" id="1531641">pc</span>&nbsp;<span class="op" id="1531644">*</span><span class="ident" id="1531645">persistConn</span><span class="op" id="1531656">)</span>&nbsp;<span class="ident" id="1531658">cancelRequest</span><span class="op" id="1531671">(</span><span class="op" id="1531672">)</span>&nbsp;<span class="op" id="1531674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531677">pc</span><span class="op" id="1531679">.</span><span class="ident" id="1531680">conn</span><span class="op" id="1531684">.</span><span class="ident" id="1531685">Close</span><span class="op" id="1531690">(</span><span class="op" id="1531691">)</span><br>
<span class="lineno"></span><span class="op" id="1531693">}</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="keyword" id="1531696">var</span>&nbsp;<span class="ident" id="1531700">remoteSideClosedFunc</span>&nbsp;<span class="keyword" id="1531721">func</span><span class="op" id="1531725">(</span><span class="builtintype" id="1531726">error</span><span class="op" id="1531731">)</span>&nbsp;<span class="builtintype" id="1531733">bool</span>&nbsp;<span class="comment" id="1531738">//&nbsp;or&nbsp;nil&nbsp;to&nbsp;use&nbsp;default</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1531764">func</span>&nbsp;<span class="ident" id="1531769">remoteSideClosed</span><span class="op" id="1531785">(</span><span class="ident" id="1531786">err</span>&nbsp;<span class="builtintype" id="1531790">error</span><span class="op" id="1531795">)</span>&nbsp;<span class="builtintype" id="1531797">bool</span>&nbsp;<span class="op" id="1531802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531805">if</span>&nbsp;<span class="ident" id="1531808">err</span>&nbsp;<span class="op" id="1531812">==</span>&nbsp;<span class="ident" id="1531815">io</span><span class="op" id="1531817">.</span><span class="ident" id="1531818">EOF</span>&nbsp;<span class="op" id="1531822">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531826">return</span>&nbsp;<span class="builtintype" id="1531833">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531842">if</span>&nbsp;<span class="ident" id="1531845">remoteSideClosedFunc</span>&nbsp;<span class="op" id="1531866">!=</span>&nbsp;<span class="ident" id="1531869">nil</span>&nbsp;<span class="op" id="1531873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531877">return</span>&nbsp;<span class="ident" id="1531884">remoteSideClosedFunc</span><span class="op" id="1531904">(</span><span class="ident" id="1531905">err</span><span class="op" id="1531908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1531911">}</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531914">return</span>&nbsp;<span class="builtintype" id="1531921">false</span><br>
<span class="lineno"></span><span class="op" id="1531927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1531930">func</span>&nbsp;<span class="op" id="1531935">(</span><span class="ident" id="1531936">pc</span>&nbsp;<span class="op" id="1531939">*</span><span class="ident" id="1531940">persistConn</span><span class="op" id="1531951">)</span>&nbsp;<span class="ident" id="1531953">readLoop</span><span class="op" id="1531961">(</span><span class="op" id="1531962">)</span>&nbsp;<span class="op" id="1531964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531967">alive</span>&nbsp;<span class="op" id="1531973">:=</span>&nbsp;<span class="builtintype" id="1531976">true</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1531983">for</span>&nbsp;<span class="ident" id="1531987">alive</span>&nbsp;<span class="op" id="1531993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1531997">pb</span><span class="op" id="1531999">,</span>&nbsp;<span class="ident" id="1532001">err</span>&nbsp;<span class="op" id="1532005">:=</span>&nbsp;<span class="ident" id="1532008">pc</span><span class="op" id="1532010">.</span><span class="ident" id="1532011">br</span><span class="op" id="1532013">.</span><span class="ident" id="1532014">Peek</span><span class="op" id="1532018">(</span><span class="num" id="1532019">1</span><span class="op" id="1532020">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532025">pc</span><span class="op" id="1532027">.</span><span class="ident" id="1532028">lk</span><span class="op" id="1532030">.</span><span class="ident" id="1532031">Lock</span><span class="op" id="1532035">(</span><span class="op" id="1532036">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532040">if</span>&nbsp;<span class="ident" id="1532043">pc</span><span class="op" id="1532045">.</span><span class="ident" id="1532046">numExpectedResponses</span>&nbsp;<span class="op" id="1532067">==</span>&nbsp;<span class="num" id="1532070">0</span>&nbsp;<span class="op" id="1532072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532077">if</span>&nbsp;<span class="op" id="1532080">!</span><span class="ident" id="1532081">pc</span><span class="op" id="1532083">.</span><span class="ident" id="1532084">closed</span>&nbsp;<span class="op" id="1532091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532097">pc</span><span class="op" id="1532099">.</span><span class="ident" id="1532100">closeLocked</span><span class="op" id="1532111">(</span><span class="op" id="1532112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532118">if</span>&nbsp;<span class="builtinfunc" id="1532121">len</span><span class="op" id="1532124">(</span><span class="ident" id="1532125">pb</span><span class="op" id="1532127">)</span>&nbsp;<span class="op" id="1532129">&gt;</span>&nbsp;<span class="num" id="1532131">0</span>&nbsp;<span class="op" id="1532133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532140">log</span><span class="op" id="1532143">.</span><span class="ident" id="1532144">Printf</span><span class="op" id="1532150">(</span><span class="string" id="1532151">&#34;Unsolicited&nbsp;response&nbsp;received&nbsp;on&nbsp;idle&nbsp;HTTP&nbsp;channel&nbsp;starting&nbsp;with&nbsp;%q;&nbsp;err=%v&#34;</span><span class="op" id="1532228">,</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1532236">string</span><span class="op" id="1532242">(</span><span class="ident" id="1532243">pb</span><span class="op" id="1532245">)</span><span class="op" id="1532246">,</span>&nbsp;<span class="ident" id="1532248">err</span><span class="op" id="1532251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532267">pc</span><span class="op" id="1532269">.</span><span class="ident" id="1532270">lk</span><span class="op" id="1532272">.</span><span class="ident" id="1532273">Unlock</span><span class="op" id="1532279">(</span><span class="op" id="1532280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532285">return</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532298">pc</span><span class="op" id="1532300">.</span><span class="ident" id="1532301">lk</span><span class="op" id="1532303">.</span><span class="ident" id="1532304">Unlock</span><span class="op" id="1532310">(</span><span class="op" id="1532311">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532316">rc</span>&nbsp;<span class="op" id="1532319">:=</span>&nbsp;<span class="op" id="1532322">&lt;-</span><span class="ident" id="1532324">pc</span><span class="op" id="1532326">.</span><span class="ident" id="1532327">reqch</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532336">var</span>&nbsp;<span class="ident" id="1532340">resp</span>&nbsp;<span class="op" id="1532345">*</span><span class="ident" id="1532346">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532357">if</span>&nbsp;<span class="ident" id="1532360">err</span>&nbsp;<span class="op" id="1532364">==</span>&nbsp;<span class="ident" id="1532367">nil</span>&nbsp;<span class="op" id="1532371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532376">resp</span><span class="op" id="1532380">,</span>&nbsp;<span class="ident" id="1532382">err</span>&nbsp;<span class="op" id="1532386">=</span>&nbsp;<span class="ident" id="1532388">ReadResponse</span><span class="op" id="1532400">(</span><span class="ident" id="1532401">pc</span><span class="op" id="1532403">.</span><span class="ident" id="1532404">br</span><span class="op" id="1532406">,</span>&nbsp;<span class="ident" id="1532408">rc</span><span class="op" id="1532410">.</span><span class="ident" id="1532411">req</span><span class="op" id="1532414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532419">if</span>&nbsp;<span class="ident" id="1532422">err</span>&nbsp;<span class="op" id="1532426">==</span>&nbsp;<span class="ident" id="1532429">nil</span>&nbsp;<span class="op" id="1532433">&amp;&amp;</span>&nbsp;<span class="ident" id="1532436">resp</span><span class="op" id="1532440">.</span><span class="ident" id="1532441">StatusCode</span>&nbsp;<span class="op" id="1532452">==</span>&nbsp;<span class="num" id="1532455">100</span>&nbsp;<span class="op" id="1532459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532465">//&nbsp;Skip&nbsp;any&nbsp;100-continue&nbsp;for&nbsp;now.</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532503">//&nbsp;TODO(bradfitz):&nbsp;if&nbsp;rc.req&nbsp;had&nbsp;&#34;Expect:&nbsp;100-continue&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532564">//&nbsp;actually&nbsp;block&nbsp;the&nbsp;request&nbsp;body&nbsp;write&nbsp;and&nbsp;signal&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532624">//&nbsp;writeLoop&nbsp;now&nbsp;to&nbsp;begin&nbsp;sending&nbsp;it.&nbsp;(Issue&nbsp;2184)&nbsp;For&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1532690">//&nbsp;eat&nbsp;it,&nbsp;since&nbsp;we&#39;re&nbsp;never&nbsp;expecting&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532738">resp</span><span class="op" id="1532742">,</span>&nbsp;<span class="ident" id="1532744">err</span>&nbsp;<span class="op" id="1532748">=</span>&nbsp;<span class="ident" id="1532750">ReadResponse</span><span class="op" id="1532762">(</span><span class="ident" id="1532763">pc</span><span class="op" id="1532765">.</span><span class="ident" id="1532766">br</span><span class="op" id="1532768">,</span>&nbsp;<span class="ident" id="1532770">rc</span><span class="op" id="1532772">.</span><span class="ident" id="1532773">req</span><span class="op" id="1532776">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532790">if</span>&nbsp;<span class="ident" id="1532793">resp</span>&nbsp;<span class="op" id="1532798">!=</span>&nbsp;<span class="ident" id="1532801">nil</span>&nbsp;<span class="op" id="1532805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532810">resp</span><span class="op" id="1532814">.</span><span class="ident" id="1532815">TLS</span>&nbsp;<span class="op" id="1532819">=</span>&nbsp;<span class="ident" id="1532821">pc</span><span class="op" id="1532823">.</span><span class="ident" id="1532824">tlsState</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532840">hasBody</span>&nbsp;<span class="op" id="1532848">:=</span>&nbsp;<span class="ident" id="1532851">resp</span>&nbsp;<span class="op" id="1532856">!=</span>&nbsp;<span class="ident" id="1532859">nil</span>&nbsp;<span class="op" id="1532863">&amp;&amp;</span>&nbsp;<span class="ident" id="1532866">rc</span><span class="op" id="1532868">.</span><span class="ident" id="1532869">req</span><span class="op" id="1532872">.</span><span class="ident" id="1532873">Method</span>&nbsp;<span class="op" id="1532880">!=</span>&nbsp;<span class="string" id="1532883">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="1532890">&amp;&amp;</span>&nbsp;<span class="ident" id="1532893">resp</span><span class="op" id="1532897">.</span><span class="ident" id="1532898">ContentLength</span>&nbsp;<span class="op" id="1532912">!=</span>&nbsp;<span class="num" id="1532915">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532920">if</span>&nbsp;<span class="ident" id="1532923">err</span>&nbsp;<span class="op" id="1532927">!=</span>&nbsp;<span class="ident" id="1532930">nil</span>&nbsp;<span class="op" id="1532934">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1532939">pc</span><span class="op" id="1532941">.</span><span class="builtinfunc" id="1532942">close</span><span class="op" id="1532947">(</span><span class="op" id="1532948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1532952">}</span>&nbsp;<span class="keyword" id="1532954">else</span>&nbsp;<span class="op" id="1532959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1532964">if</span>&nbsp;<span class="ident" id="1532967">rc</span><span class="op" id="1532969">.</span><span class="ident" id="1532970">addedGzip</span>&nbsp;<span class="op" id="1532980">&amp;&amp;</span>&nbsp;<span class="ident" id="1532983">hasBody</span>&nbsp;<span class="op" id="1532991">&amp;&amp;</span>&nbsp;<span class="ident" id="1532994">resp</span><span class="op" id="1532998">.</span><span class="ident" id="1532999">Header</span><span class="op" id="1533005">.</span><span class="ident" id="1533006">Get</span><span class="op" id="1533009">(</span><span class="string" id="1533010">&#34;Content-Encoding&#34;</span><span class="op" id="1533028">)</span>&nbsp;<span class="op" id="1533030">==</span>&nbsp;<span class="string" id="1533033">&#34;gzip&#34;</span>&nbsp;<span class="op" id="1533040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533046">resp</span><span class="op" id="1533050">.</span><span class="ident" id="1533051">Header</span><span class="op" id="1533057">.</span><span class="ident" id="1533058">Del</span><span class="op" id="1533061">(</span><span class="string" id="1533062">&#34;Content-Encoding&#34;</span><span class="op" id="1533080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533086">resp</span><span class="op" id="1533090">.</span><span class="ident" id="1533091">Header</span><span class="op" id="1533097">.</span><span class="ident" id="1533098">Del</span><span class="op" id="1533101">(</span><span class="string" id="1533102">&#34;Content-Length&#34;</span><span class="op" id="1533118">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533124">resp</span><span class="op" id="1533128">.</span><span class="ident" id="1533129">ContentLength</span>&nbsp;<span class="op" id="1533143">=</span>&nbsp;<span class="op" id="1533145">-</span><span class="num" id="1533146">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533152">resp</span><span class="op" id="1533156">.</span><span class="ident" id="1533157">Body</span>&nbsp;<span class="op" id="1533162">=</span>&nbsp;<span class="op" id="1533164">&amp;</span><span class="ident" id="1533165">gzipReader</span><span class="op" id="1533175">{</span><span class="ident" id="1533176">body</span><span class="op" id="1533180">:</span>&nbsp;<span class="ident" id="1533182">resp</span><span class="op" id="1533186">.</span><span class="ident" id="1533187">Body</span><span class="op" id="1533191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533201">resp</span><span class="op" id="1533205">.</span><span class="ident" id="1533206">Body</span>&nbsp;<span class="op" id="1533211">=</span>&nbsp;<span class="op" id="1533213">&amp;</span><span class="ident" id="1533214">bodyEOFSignal</span><span class="op" id="1533227">{</span><span class="ident" id="1533228">body</span><span class="op" id="1533232">:</span>&nbsp;<span class="ident" id="1533234">resp</span><span class="op" id="1533238">.</span><span class="ident" id="1533239">Body</span><span class="op" id="1533243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533247">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533252">if</span>&nbsp;<span class="ident" id="1533255">err</span>&nbsp;<span class="op" id="1533259">!=</span>&nbsp;<span class="ident" id="1533262">nil</span>&nbsp;<span class="op" id="1533266">||</span>&nbsp;<span class="ident" id="1533269">resp</span><span class="op" id="1533273">.</span><span class="ident" id="1533274">Close</span>&nbsp;<span class="op" id="1533280">||</span>&nbsp;<span class="ident" id="1533283">rc</span><span class="op" id="1533285">.</span><span class="ident" id="1533286">req</span><span class="op" id="1533289">.</span><span class="ident" id="1533290">Close</span>&nbsp;<span class="op" id="1533296">||</span>&nbsp;<span class="ident" id="1533299">resp</span><span class="op" id="1533303">.</span><span class="ident" id="1533304">StatusCode</span>&nbsp;<span class="op" id="1533315">&lt;=</span>&nbsp;<span class="num" id="1533318">199</span>&nbsp;<span class="op" id="1533322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533327">//&nbsp;Don&#39;t&nbsp;do&nbsp;keep-alive&nbsp;on&nbsp;error&nbsp;if&nbsp;either&nbsp;party&nbsp;requested&nbsp;a&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533396">//&nbsp;or&nbsp;we&nbsp;get&nbsp;an&nbsp;unexpected&nbsp;informational&nbsp;(1xx)&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533456">//&nbsp;StatusCode&nbsp;100&nbsp;is&nbsp;already&nbsp;handled&nbsp;above.</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533503">alive</span>&nbsp;<span class="op" id="1533509">=</span>&nbsp;<span class="builtintype" id="1533511">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533524">var</span>&nbsp;<span class="ident" id="1533528">waitForBodyRead</span>&nbsp;<span class="keyword" id="1533544">chan</span>&nbsp;<span class="builtintype" id="1533549">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533556">if</span>&nbsp;<span class="ident" id="1533559">hasBody</span>&nbsp;<span class="op" id="1533567">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533572">waitForBodyRead</span>&nbsp;<span class="op" id="1533588">=</span>&nbsp;<span class="builtinfunc" id="1533590">make</span><span class="op" id="1533594">(</span><span class="keyword" id="1533595">chan</span>&nbsp;<span class="builtintype" id="1533600">bool</span><span class="op" id="1533604">,</span>&nbsp;<span class="num" id="1533606">2</span><span class="op" id="1533607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533612">resp</span><span class="op" id="1533616">.</span><span class="ident" id="1533617">Body</span><span class="op" id="1533621">.</span><span class="op" id="1533622">(</span><span class="op" id="1533623">*</span><span class="ident" id="1533624">bodyEOFSignal</span><span class="op" id="1533637">)</span><span class="op" id="1533638">.</span><span class="ident" id="1533639">earlyCloseFn</span>&nbsp;<span class="op" id="1533652">=</span>&nbsp;<span class="keyword" id="1533654">func</span><span class="op" id="1533658">(</span><span class="op" id="1533659">)</span>&nbsp;<span class="builtintype" id="1533661">error</span>&nbsp;<span class="op" id="1533667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533673">//&nbsp;Sending&nbsp;false&nbsp;here&nbsp;sets&nbsp;alive&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533713">//&nbsp;false&nbsp;and&nbsp;closes&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1533752">//&nbsp;below.</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533766">waitForBodyRead</span>&nbsp;<span class="op" id="1533782">&lt;-</span>&nbsp;<span class="builtintype" id="1533785">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533795">return</span>&nbsp;<span class="ident" id="1533802">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533814">resp</span><span class="op" id="1533818">.</span><span class="ident" id="1533819">Body</span><span class="op" id="1533823">.</span><span class="op" id="1533824">(</span><span class="op" id="1533825">*</span><span class="ident" id="1533826">bodyEOFSignal</span><span class="op" id="1533839">)</span><span class="op" id="1533840">.</span><span class="ident" id="1533841">fn</span>&nbsp;<span class="op" id="1533844">=</span>&nbsp;<span class="keyword" id="1533846">func</span><span class="op" id="1533850">(</span><span class="ident" id="1533851">err</span>&nbsp;<span class="builtintype" id="1533855">error</span><span class="op" id="1533860">)</span>&nbsp;<span class="op" id="1533862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533868">waitForBodyRead</span>&nbsp;<span class="op" id="1533884">&lt;-</span>&nbsp;<span class="ident" id="1533887">alive</span>&nbsp;<span class="op" id="1533893">&amp;&amp;</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533901">err</span>&nbsp;<span class="op" id="1533905">==</span>&nbsp;<span class="ident" id="1533908">nil</span>&nbsp;<span class="op" id="1533912">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533920">!</span><span class="ident" id="1533921">pc</span><span class="op" id="1533923">.</span><span class="ident" id="1533924">sawEOF</span>&nbsp;<span class="op" id="1533931">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533939">pc</span><span class="op" id="1533941">.</span><span class="ident" id="1533942">wroteRequest</span><span class="op" id="1533954">(</span><span class="op" id="1533955">)</span>&nbsp;<span class="op" id="1533957">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1533965">pc</span><span class="op" id="1533967">.</span><span class="ident" id="1533968">t</span><span class="op" id="1533969">.</span><span class="ident" id="1533970">putIdleConn</span><span class="op" id="1533981">(</span><span class="ident" id="1533982">pc</span><span class="op" id="1533984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533989">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1533993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1533998">if</span>&nbsp;<span class="ident" id="1534001">alive</span>&nbsp;<span class="op" id="1534007">&amp;&amp;</span>&nbsp;<span class="op" id="1534010">!</span><span class="ident" id="1534011">hasBody</span>&nbsp;<span class="op" id="1534019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534024">alive</span>&nbsp;<span class="op" id="1534030">=</span>&nbsp;<span class="op" id="1534032">!</span><span class="ident" id="1534033">pc</span><span class="op" id="1534035">.</span><span class="ident" id="1534036">sawEOF</span>&nbsp;<span class="op" id="1534043">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534050">pc</span><span class="op" id="1534052">.</span><span class="ident" id="1534053">wroteRequest</span><span class="op" id="1534065">(</span><span class="op" id="1534066">)</span>&nbsp;<span class="op" id="1534068">&amp;&amp;</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534075">pc</span><span class="op" id="1534077">.</span><span class="ident" id="1534078">t</span><span class="op" id="1534079">.</span><span class="ident" id="1534080">putIdleConn</span><span class="op" id="1534091">(</span><span class="ident" id="1534092">pc</span><span class="op" id="1534094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534103">rc</span><span class="op" id="1534105">.</span><span class="ident" id="1534106">ch</span>&nbsp;<span class="op" id="1534109">&lt;-</span>&nbsp;<span class="ident" id="1534112">responseAndError</span><span class="op" id="1534128">{</span><span class="ident" id="1534129">resp</span><span class="op" id="1534133">,</span>&nbsp;<span class="ident" id="1534135">err</span><span class="op" id="1534138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1534143">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;just-returned&nbsp;response&nbsp;body&nbsp;to&nbsp;be&nbsp;fully&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1534210">//&nbsp;before&nbsp;we&nbsp;race&nbsp;and&nbsp;peek&nbsp;on&nbsp;the&nbsp;underlying&nbsp;bufio&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534271">if</span>&nbsp;<span class="ident" id="1534274">waitForBodyRead</span>&nbsp;<span class="op" id="1534290">!=</span>&nbsp;<span class="ident" id="1534293">nil</span>&nbsp;<span class="op" id="1534297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534302">select</span>&nbsp;<span class="op" id="1534309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534314">case</span>&nbsp;<span class="ident" id="1534319">alive</span>&nbsp;<span class="op" id="1534325">=</span>&nbsp;<span class="op" id="1534327">&lt;-</span><span class="ident" id="1534329">waitForBodyRead</span><span class="op" id="1534344">:</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534349">case</span>&nbsp;<span class="op" id="1534354">&lt;-</span><span class="ident" id="1534356">pc</span><span class="op" id="1534358">.</span><span class="ident" id="1534359">closech</span><span class="op" id="1534366">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534372">alive</span>&nbsp;<span class="op" id="1534378">=</span>&nbsp;<span class="builtintype" id="1534380">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534398">pc</span><span class="op" id="1534400">.</span><span class="ident" id="1534401">t</span><span class="op" id="1534402">.</span><span class="ident" id="1534403">setReqCanceler</span><span class="op" id="1534417">(</span><span class="ident" id="1534418">rc</span><span class="op" id="1534420">.</span><span class="ident" id="1534421">req</span><span class="op" id="1534424">,</span>&nbsp;<span class="ident" id="1534426">nil</span><span class="op" id="1534429">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534434">if</span>&nbsp;<span class="op" id="1534437">!</span><span class="ident" id="1534438">alive</span>&nbsp;<span class="op" id="1534444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534449">pc</span><span class="op" id="1534451">.</span><span class="builtinfunc" id="1534452">close</span><span class="op" id="1534457">(</span><span class="op" id="1534458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534462">}</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534465">}</span><br>
<span class="lineno"></span><span class="op" id="1534467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1534470">func</span>&nbsp;<span class="op" id="1534475">(</span><span class="ident" id="1534476">pc</span>&nbsp;<span class="op" id="1534479">*</span><span class="ident" id="1534480">persistConn</span><span class="op" id="1534491">)</span>&nbsp;<span class="ident" id="1534493">writeLoop</span><span class="op" id="1534502">(</span><span class="op" id="1534503">)</span>&nbsp;<span class="op" id="1534505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534508">for</span>&nbsp;<span class="op" id="1534512">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534516">select</span>&nbsp;<span class="op" id="1534523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534527">case</span>&nbsp;<span class="ident" id="1534532">wr</span>&nbsp;<span class="op" id="1534535">:=</span>&nbsp;<span class="op" id="1534538">&lt;-</span><span class="ident" id="1534540">pc</span><span class="op" id="1534542">.</span><span class="ident" id="1534543">writech</span><span class="op" id="1534550">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534555">if</span>&nbsp;<span class="ident" id="1534558">pc</span><span class="op" id="1534560">.</span><span class="ident" id="1534561">isBroken</span><span class="op" id="1534569">(</span><span class="op" id="1534570">)</span>&nbsp;<span class="op" id="1534572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534578">wr</span><span class="op" id="1534580">.</span><span class="ident" id="1534581">ch</span>&nbsp;<span class="op" id="1534584">&lt;-</span>&nbsp;<span class="ident" id="1534587">errors</span><span class="op" id="1534593">.</span><span class="ident" id="1534594">New</span><span class="op" id="1534597">(</span><span class="string" id="1534598">&#34;http:&nbsp;can&#39;t&nbsp;write&nbsp;HTTP&nbsp;request&nbsp;on&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="1534651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534657">continue</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534674">err</span>&nbsp;<span class="op" id="1534678">:=</span>&nbsp;<span class="ident" id="1534681">wr</span><span class="op" id="1534683">.</span><span class="ident" id="1534684">req</span><span class="op" id="1534687">.</span><span class="ident" id="1534688">Request</span><span class="op" id="1534695">.</span><span class="ident" id="1534696">write</span><span class="op" id="1534701">(</span><span class="ident" id="1534702">pc</span><span class="op" id="1534704">.</span><span class="ident" id="1534705">bw</span><span class="op" id="1534707">,</span>&nbsp;<span class="ident" id="1534709">pc</span><span class="op" id="1534711">.</span><span class="ident" id="1534712">isProxy</span><span class="op" id="1534719">,</span>&nbsp;<span class="ident" id="1534721">wr</span><span class="op" id="1534723">.</span><span class="ident" id="1534724">req</span><span class="op" id="1534727">.</span><span class="ident" id="1534728">extra</span><span class="op" id="1534733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534738">if</span>&nbsp;<span class="ident" id="1534741">err</span>&nbsp;<span class="op" id="1534745">==</span>&nbsp;<span class="ident" id="1534748">nil</span>&nbsp;<span class="op" id="1534752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534758">err</span>&nbsp;<span class="op" id="1534762">=</span>&nbsp;<span class="ident" id="1534764">pc</span><span class="op" id="1534766">.</span><span class="ident" id="1534767">bw</span><span class="op" id="1534769">.</span><span class="ident" id="1534770">Flush</span><span class="op" id="1534775">(</span><span class="op" id="1534776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534781">}</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534786">if</span>&nbsp;<span class="ident" id="1534789">err</span>&nbsp;<span class="op" id="1534793">!=</span>&nbsp;<span class="ident" id="1534796">nil</span>&nbsp;<span class="op" id="1534800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534806">pc</span><span class="op" id="1534808">.</span><span class="ident" id="1534809">markBroken</span><span class="op" id="1534819">(</span><span class="op" id="1534820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534826">wr</span><span class="op" id="1534828">.</span><span class="ident" id="1534829">req</span><span class="op" id="1534832">.</span><span class="ident" id="1534833">Request</span><span class="op" id="1534840">.</span><span class="ident" id="1534841">closeBody</span><span class="op" id="1534850">(</span><span class="op" id="1534851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1534856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534861">pc</span><span class="op" id="1534863">.</span><span class="ident" id="1534864">writeErrCh</span>&nbsp;<span class="op" id="1534875">&lt;-</span>&nbsp;<span class="ident" id="1534878">err</span>&nbsp;<span class="comment" id="1534882">//&nbsp;to&nbsp;the&nbsp;body&nbsp;reader,&nbsp;which&nbsp;might&nbsp;recycle&nbsp;us</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1534931">wr</span><span class="op" id="1534933">.</span><span class="ident" id="1534934">ch</span>&nbsp;<span class="op" id="1534937">&lt;-</span>&nbsp;<span class="ident" id="1534940">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1534952">//&nbsp;to&nbsp;the&nbsp;roundTrip&nbsp;function</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1534983">case</span>&nbsp;<span class="op" id="1534988">&lt;-</span><span class="ident" id="1534990">pc</span><span class="op" id="1534992">.</span><span class="ident" id="1534993">closech</span><span class="op" id="1535000">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535005">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1535017">}</span><br>
<span class="lineno">965</span><span class="op" id="1535019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1535022">//&nbsp;wroteRequest&nbsp;is&nbsp;a&nbsp;check&nbsp;before&nbsp;recycling&nbsp;a&nbsp;connection&nbsp;that&nbsp;the&nbsp;previous&nbsp;write</span><br>
<span class="lineno"></span><span class="comment" id="1535103">//&nbsp;(from&nbsp;writeLoop&nbsp;above)&nbsp;happened&nbsp;and&nbsp;was&nbsp;successful.</span><br>
<span class="lineno"></span><span class="keyword" id="1535158">func</span>&nbsp;<span class="op" id="1535163">(</span><span class="ident" id="1535164">pc</span>&nbsp;<span class="op" id="1535167">*</span><span class="ident" id="1535168">persistConn</span><span class="op" id="1535179">)</span>&nbsp;<span class="ident" id="1535181">wroteRequest</span><span class="op" id="1535193">(</span><span class="op" id="1535194">)</span>&nbsp;<span class="builtintype" id="1535196">bool</span>&nbsp;<span class="op" id="1535201">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535204">select</span>&nbsp;<span class="op" id="1535211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535214">case</span>&nbsp;<span class="ident" id="1535219">err</span>&nbsp;<span class="op" id="1535223">:=</span>&nbsp;<span class="op" id="1535226">&lt;-</span><span class="ident" id="1535228">pc</span><span class="op" id="1535230">.</span><span class="ident" id="1535231">writeErrCh</span><span class="op" id="1535241">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535245">//&nbsp;Common&nbsp;case:&nbsp;the&nbsp;write&nbsp;happened&nbsp;well&nbsp;before&nbsp;the&nbsp;response,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535311">//&nbsp;avoid&nbsp;creating&nbsp;a&nbsp;timer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535340">return</span>&nbsp;<span class="ident" id="1535347">err</span>&nbsp;<span class="op" id="1535351">==</span>&nbsp;<span class="ident" id="1535354">nil</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535359">default</span><span class="op" id="1535366">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535370">//&nbsp;Rare&nbsp;case:&nbsp;the&nbsp;request&nbsp;was&nbsp;written&nbsp;in&nbsp;writeLoop&nbsp;above&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535433">//&nbsp;before&nbsp;it&nbsp;could&nbsp;send&nbsp;to&nbsp;pc.writeErrCh,&nbsp;the&nbsp;reader&nbsp;read&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535496">//&nbsp;all,&nbsp;processed&nbsp;it,&nbsp;and&nbsp;called&nbsp;us&nbsp;here.&nbsp;In&nbsp;this&nbsp;case,&nbsp;give&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535563">//&nbsp;write&nbsp;goroutine&nbsp;a&nbsp;bit&nbsp;of&nbsp;time&nbsp;to&nbsp;finish&nbsp;its&nbsp;send.</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535618">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535623">//&nbsp;Less&nbsp;rare&nbsp;case:&nbsp;We&nbsp;also&nbsp;get&nbsp;here&nbsp;in&nbsp;the&nbsp;legitimate&nbsp;case&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535687">//&nbsp;Issue&nbsp;7569,&nbsp;where&nbsp;the&nbsp;writer&nbsp;is&nbsp;still&nbsp;writing&nbsp;(or&nbsp;stalled),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535752">//&nbsp;but&nbsp;the&nbsp;server&nbsp;has&nbsp;already&nbsp;replied.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535816">//&nbsp;want&nbsp;to&nbsp;wait&nbsp;too&nbsp;long,&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;return&nbsp;false&nbsp;so&nbsp;this</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1535880">//&nbsp;connection&nbsp;isn&#39;t&nbsp;re-used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535911">select</span>&nbsp;<span class="op" id="1535918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535922">case</span>&nbsp;<span class="ident" id="1535927">err</span>&nbsp;<span class="op" id="1535931">:=</span>&nbsp;<span class="op" id="1535934">&lt;-</span><span class="ident" id="1535936">pc</span><span class="op" id="1535938">.</span><span class="ident" id="1535939">writeErrCh</span><span class="op" id="1535949">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535954">return</span>&nbsp;<span class="ident" id="1535961">err</span>&nbsp;<span class="op" id="1535965">==</span>&nbsp;<span class="ident" id="1535968">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1535974">case</span>&nbsp;<span class="op" id="1535979">&lt;-</span><span class="ident" id="1535981">time</span><span class="op" id="1535985">.</span><span class="ident" id="1535986">After</span><span class="op" id="1535991">(</span><span class="num" id="1535992">50</span>&nbsp;<span class="op" id="1535995">*</span>&nbsp;<span class="ident" id="1535997">time</span><span class="op" id="1536001">.</span><span class="ident" id="1536002">Millisecond</span><span class="op" id="1536013">)</span><span class="op" id="1536014">:</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1536019">return</span>&nbsp;<span class="builtintype" id="1536026">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1536037">}</span><br>
<span class="lineno"></span><span class="op" id="1536039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">995</span><span class="keyword" id="1536042">type</span>&nbsp;<span class="ident" id="1536047">responseAndError</span>&nbsp;<span class="keyword" id="1536064">struct</span>&nbsp;<span class="op" id="1536071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536074">res</span>&nbsp;<span class="op" id="1536078">*</span><span class="ident" id="1536079">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536089">err</span>&nbsp;<span class="builtintype" id="1536093">error</span><br>
<span class="lineno"></span><span class="op" id="1536099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span><span class="keyword" id="1536102">type</span>&nbsp;<span class="ident" id="1536107">requestAndChan</span>&nbsp;<span class="keyword" id="1536122">struct</span>&nbsp;<span class="op" id="1536129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536132">req</span>&nbsp;<span class="op" id="1536136">*</span><span class="ident" id="1536137">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536146">ch</span>&nbsp;&nbsp;<span class="keyword" id="1536150">chan</span>&nbsp;<span class="ident" id="1536155">responseAndError</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1536174">//&nbsp;did&nbsp;the&nbsp;Transport&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;the&nbsp;client&nbsp;code)&nbsp;add&nbsp;an</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1536235">//&nbsp;Accept-Encoding&nbsp;gzip&nbsp;header?&nbsp;only&nbsp;if&nbsp;it&nbsp;we&nbsp;set&nbsp;it&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1536292">//&nbsp;we&nbsp;transparently&nbsp;decode&nbsp;the&nbsp;gzip.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536330">addedGzip</span>&nbsp;<span class="builtintype" id="1536340">bool</span><br>
<span class="lineno"></span><span class="op" id="1536345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1010</span><span class="comment" id="1536348">//&nbsp;A&nbsp;writeRequest&nbsp;is&nbsp;sent&nbsp;by&nbsp;the&nbsp;readLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1536409">//&nbsp;writeLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;while&nbsp;the&nbsp;read&nbsp;loop</span><br>
<span class="lineno"></span><span class="comment" id="1536473">//&nbsp;concurrently&nbsp;waits&nbsp;on&nbsp;both&nbsp;the&nbsp;write&nbsp;response&nbsp;and&nbsp;the&nbsp;server&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="1536539">//&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="1536549">type</span>&nbsp;<span class="ident" id="1536554">writeRequest</span>&nbsp;<span class="keyword" id="1536567">struct</span>&nbsp;<span class="op" id="1536574">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536577">req</span>&nbsp;<span class="op" id="1536581">*</span><span class="ident" id="1536582">transportRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536600">ch</span>&nbsp;&nbsp;<span class="keyword" id="1536604">chan</span><span class="op" id="1536608">&lt;-</span>&nbsp;<span class="builtintype" id="1536611">error</span><br>
<span class="lineno"></span><span class="op" id="1536617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1536620">type</span>&nbsp;<span class="ident" id="1536625">httpError</span>&nbsp;<span class="keyword" id="1536635">struct</span>&nbsp;<span class="op" id="1536642">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536645">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1536653">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1536661">timeout</span>&nbsp;<span class="builtintype" id="1536669">bool</span><br>
<span class="lineno"></span><span class="op" id="1536674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1536677">func</span>&nbsp;<span class="op" id="1536682">(</span><span class="ident" id="1536683">e</span>&nbsp;<span class="op" id="1536685">*</span><span class="ident" id="1536686">httpError</span><span class="op" id="1536695">)</span>&nbsp;<span class="ident" id="1536697">Error</span><span class="op" id="1536702">(</span><span class="op" id="1536703">)</span>&nbsp;<span class="builtintype" id="1536705">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1536714">{</span>&nbsp;<span class="keyword" id="1536716">return</span>&nbsp;<span class="ident" id="1536723">e</span><span class="op" id="1536724">.</span><span class="ident" id="1536725">err</span>&nbsp;<span class="op" id="1536729">}</span><br>
<span class="lineno">1025</span><span class="keyword" id="1536731">func</span>&nbsp;<span class="op" id="1536736">(</span><span class="ident" id="1536737">e</span>&nbsp;<span class="op" id="1536739">*</span><span class="ident" id="1536740">httpError</span><span class="op" id="1536749">)</span>&nbsp;<span class="ident" id="1536751">Timeout</span><span class="op" id="1536758">(</span><span class="op" id="1536759">)</span>&nbsp;<span class="builtintype" id="1536761">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1536768">{</span>&nbsp;<span class="keyword" id="1536770">return</span>&nbsp;<span class="ident" id="1536777">e</span><span class="op" id="1536778">.</span><span class="ident" id="1536779">timeout</span>&nbsp;<span class="op" id="1536787">}</span><br>
<span class="lineno"></span><span class="keyword" id="1536789">func</span>&nbsp;<span class="op" id="1536794">(</span><span class="ident" id="1536795">e</span>&nbsp;<span class="op" id="1536797">*</span><span class="ident" id="1536798">httpError</span><span class="op" id="1536807">)</span>&nbsp;<span class="ident" id="1536809">Temporary</span><span class="op" id="1536818">(</span><span class="op" id="1536819">)</span>&nbsp;<span class="builtintype" id="1536821">bool</span>&nbsp;<span class="op" id="1536826">{</span>&nbsp;<span class="keyword" id="1536828">return</span>&nbsp;<span class="builtintype" id="1536835">true</span>&nbsp;<span class="op" id="1536840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1536843">var</span>&nbsp;<span class="ident" id="1536847">errTimeout</span>&nbsp;<span class="builtintype" id="1536858">error</span>&nbsp;<span class="op" id="1536864">=</span>&nbsp;<span class="op" id="1536866">&amp;</span><span class="ident" id="1536867">httpError</span><span class="op" id="1536876">{</span><span class="ident" id="1536877">err</span><span class="op" id="1536880">:</span>&nbsp;<span class="string" id="1536882">&#34;net/http:&nbsp;timeout&nbsp;awaiting&nbsp;response&nbsp;headers&#34;</span><span class="op" id="1536927">,</span>&nbsp;<span class="ident" id="1536929">timeout</span><span class="op" id="1536936">:</span>&nbsp;<span class="builtintype" id="1536938">true</span><span class="op" id="1536942">}</span><br>
<span class="lineno"></span><span class="keyword" id="1536944">var</span>&nbsp;<span class="ident" id="1536948">errClosed</span>&nbsp;<span class="builtintype" id="1536958">error</span>&nbsp;<span class="op" id="1536964">=</span>&nbsp;<span class="op" id="1536966">&amp;</span><span class="ident" id="1536967">httpError</span><span class="op" id="1536976">{</span><span class="ident" id="1536977">err</span><span class="op" id="1536980">:</span>&nbsp;<span class="string" id="1536982">&#34;net/http:&nbsp;transport&nbsp;closed&nbsp;before&nbsp;response&nbsp;was&nbsp;received&#34;</span><span class="op" id="1537039">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span><span class="keyword" id="1537042">func</span>&nbsp;<span class="op" id="1537047">(</span><span class="ident" id="1537048">pc</span>&nbsp;<span class="op" id="1537051">*</span><span class="ident" id="1537052">persistConn</span><span class="op" id="1537063">)</span>&nbsp;<span class="ident" id="1537065">roundTrip</span><span class="op" id="1537074">(</span><span class="ident" id="1537075">req</span>&nbsp;<span class="op" id="1537079">*</span><span class="ident" id="1537080">transportRequest</span><span class="op" id="1537096">)</span>&nbsp;<span class="op" id="1537098">(</span><span class="ident" id="1537099">resp</span>&nbsp;<span class="op" id="1537104">*</span><span class="ident" id="1537105">Response</span><span class="op" id="1537113">,</span>&nbsp;<span class="ident" id="1537115">err</span>&nbsp;<span class="builtintype" id="1537119">error</span><span class="op" id="1537124">)</span>&nbsp;<span class="op" id="1537126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537129">pc</span><span class="op" id="1537131">.</span><span class="ident" id="1537132">t</span><span class="op" id="1537133">.</span><span class="ident" id="1537134">setReqCanceler</span><span class="op" id="1537148">(</span><span class="ident" id="1537149">req</span><span class="op" id="1537152">.</span><span class="ident" id="1537153">Request</span><span class="op" id="1537160">,</span>&nbsp;<span class="ident" id="1537162">pc</span><span class="op" id="1537164">.</span><span class="ident" id="1537165">cancelRequest</span><span class="op" id="1537178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537181">pc</span><span class="op" id="1537183">.</span><span class="ident" id="1537184">lk</span><span class="op" id="1537186">.</span><span class="ident" id="1537187">Lock</span><span class="op" id="1537191">(</span><span class="op" id="1537192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537195">pc</span><span class="op" id="1537197">.</span><span class="ident" id="1537198">numExpectedResponses</span><span class="op" id="1537218">++</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537222">headerFn</span>&nbsp;<span class="op" id="1537231">:=</span>&nbsp;<span class="ident" id="1537234">pc</span><span class="op" id="1537236">.</span><span class="ident" id="1537237">mutateHeaderFunc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537255">pc</span><span class="op" id="1537257">.</span><span class="ident" id="1537258">lk</span><span class="op" id="1537260">.</span><span class="ident" id="1537261">Unlock</span><span class="op" id="1537267">(</span><span class="op" id="1537268">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537272">if</span>&nbsp;<span class="ident" id="1537275">headerFn</span>&nbsp;<span class="op" id="1537284">!=</span>&nbsp;<span class="ident" id="1537287">nil</span>&nbsp;<span class="op" id="1537291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537295">headerFn</span><span class="op" id="1537303">(</span><span class="ident" id="1537304">req</span><span class="op" id="1537307">.</span><span class="ident" id="1537308">extraHeaders</span><span class="op" id="1537320">(</span><span class="op" id="1537321">)</span><span class="op" id="1537322">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1537325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537329">//&nbsp;Ask&nbsp;for&nbsp;a&nbsp;compressed&nbsp;version&nbsp;if&nbsp;the&nbsp;caller&nbsp;didn&#39;t&nbsp;set&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537393">//&nbsp;own&nbsp;value&nbsp;for&nbsp;Accept-Encoding.&nbsp;We&nbsp;only&nbsp;attempt&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537447">//&nbsp;uncompress&nbsp;the&nbsp;gzip&nbsp;stream&nbsp;if&nbsp;we&nbsp;were&nbsp;the&nbsp;layer&nbsp;that</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537504">//&nbsp;requested&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537522">requestedGzip</span>&nbsp;<span class="op" id="1537536">:=</span>&nbsp;<span class="builtintype" id="1537539">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1537546">if</span>&nbsp;<span class="op" id="1537549">!</span><span class="ident" id="1537550">pc</span><span class="op" id="1537552">.</span><span class="ident" id="1537553">t</span><span class="op" id="1537554">.</span><span class="ident" id="1537555">DisableCompression</span>&nbsp;<span class="op" id="1537574">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537579">req</span><span class="op" id="1537582">.</span><span class="ident" id="1537583">Header</span><span class="op" id="1537589">.</span><span class="ident" id="1537590">Get</span><span class="op" id="1537593">(</span><span class="string" id="1537594">&#34;Accept-Encoding&#34;</span><span class="op" id="1537611">)</span>&nbsp;<span class="op" id="1537613">==</span>&nbsp;<span class="string" id="1537616">&#34;&#34;</span>&nbsp;<span class="op" id="1537619">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537624">req</span><span class="op" id="1537627">.</span><span class="ident" id="1537628">Header</span><span class="op" id="1537634">.</span><span class="ident" id="1537635">Get</span><span class="op" id="1537638">(</span><span class="string" id="1537639">&#34;Range&#34;</span><span class="op" id="1537646">)</span>&nbsp;<span class="op" id="1537648">==</span>&nbsp;<span class="string" id="1537651">&#34;&#34;</span>&nbsp;<span class="op" id="1537654">&amp;&amp;</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1537659">req</span><span class="op" id="1537662">.</span><span class="ident" id="1537663">Method</span>&nbsp;<span class="op" id="1537670">!=</span>&nbsp;<span class="string" id="1537673">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="1537680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537684">//&nbsp;Request&nbsp;gzip&nbsp;only,&nbsp;not&nbsp;deflate.&nbsp;Deflate&nbsp;is&nbsp;ambiguous&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537746">//&nbsp;not&nbsp;as&nbsp;universally&nbsp;supported&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537788">//&nbsp;See:&nbsp;http://www.gzip.org/zlib/zlib_faq.html#faq38</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537843">//</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537848">//&nbsp;Note&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;request&nbsp;this&nbsp;for&nbsp;HEAD&nbsp;requests,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537904">//&nbsp;due&nbsp;to&nbsp;a&nbsp;bug&nbsp;in&nbsp;nginx:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537932">//&nbsp;&nbsp;&nbsp;http://trac.nginx.org/nginx/ticket/358</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1537978">//&nbsp;&nbsp;&nbsp;http://golang.org/issue/5522</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538014">//</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538019">//&nbsp;We&nbsp;don&#39;t&nbsp;request&nbsp;gzip&nbsp;if&nbsp;the&nbsp;request&nbsp;is&nbsp;for&nbsp;a&nbsp;range,&nbsp;since</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538083">//&nbsp;auto-decoding&nbsp;a&nbsp;portion&nbsp;of&nbsp;a&nbsp;gzipped&nbsp;document&nbsp;will&nbsp;just&nbsp;fail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538149">//&nbsp;anyway.&nbsp;See&nbsp;http://golang.org/issue/8923</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538195">requestedGzip</span>&nbsp;<span class="op" id="1538209">=</span>&nbsp;<span class="builtintype" id="1538211">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538218">req</span><span class="op" id="1538221">.</span><span class="ident" id="1538222">extraHeaders</span><span class="op" id="1538234">(</span><span class="op" id="1538235">)</span><span class="op" id="1538236">.</span><span class="ident" id="1538237">Set</span><span class="op" id="1538240">(</span><span class="string" id="1538241">&#34;Accept-Encoding&#34;</span><span class="op" id="1538258">,</span>&nbsp;<span class="string" id="1538260">&#34;gzip&#34;</span><span class="op" id="1538266">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538273">//&nbsp;Write&nbsp;the&nbsp;request&nbsp;concurrently&nbsp;with&nbsp;waiting&nbsp;for&nbsp;a&nbsp;response,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538337">//&nbsp;in&nbsp;case&nbsp;the&nbsp;server&nbsp;decides&nbsp;to&nbsp;reply&nbsp;before&nbsp;reading&nbsp;our&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538401">//&nbsp;request&nbsp;body.</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538419">writeErrCh</span>&nbsp;<span class="op" id="1538430">:=</span>&nbsp;<span class="builtinfunc" id="1538433">make</span><span class="op" id="1538437">(</span><span class="keyword" id="1538438">chan</span>&nbsp;<span class="builtintype" id="1538443">error</span><span class="op" id="1538448">,</span>&nbsp;<span class="num" id="1538450">1</span><span class="op" id="1538451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538454">pc</span><span class="op" id="1538456">.</span><span class="ident" id="1538457">writech</span>&nbsp;<span class="op" id="1538465">&lt;-</span>&nbsp;<span class="ident" id="1538468">writeRequest</span><span class="op" id="1538480">{</span><span class="ident" id="1538481">req</span><span class="op" id="1538484">,</span>&nbsp;<span class="ident" id="1538486">writeErrCh</span><span class="op" id="1538496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538500">resc</span>&nbsp;<span class="op" id="1538505">:=</span>&nbsp;<span class="builtinfunc" id="1538508">make</span><span class="op" id="1538512">(</span><span class="keyword" id="1538513">chan</span>&nbsp;<span class="ident" id="1538518">responseAndError</span><span class="op" id="1538534">,</span>&nbsp;<span class="num" id="1538536">1</span><span class="op" id="1538537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538540">pc</span><span class="op" id="1538542">.</span><span class="ident" id="1538543">reqch</span>&nbsp;<span class="op" id="1538549">&lt;-</span>&nbsp;<span class="ident" id="1538552">requestAndChan</span><span class="op" id="1538566">{</span><span class="ident" id="1538567">req</span><span class="op" id="1538570">.</span><span class="ident" id="1538571">Request</span><span class="op" id="1538578">,</span>&nbsp;<span class="ident" id="1538580">resc</span><span class="op" id="1538584">,</span>&nbsp;<span class="ident" id="1538586">requestedGzip</span><span class="op" id="1538599">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538603">var</span>&nbsp;<span class="ident" id="1538607">re</span>&nbsp;<span class="ident" id="1538610">responseAndError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538628">var</span>&nbsp;<span class="ident" id="1538632">pconnDeadCh</span>&nbsp;<span class="op" id="1538644">=</span>&nbsp;<span class="ident" id="1538646">pc</span><span class="op" id="1538648">.</span><span class="ident" id="1538649">closech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538658">var</span>&nbsp;<span class="ident" id="1538662">failTicker</span>&nbsp;<span class="op" id="1538673">&lt;-</span><span class="keyword" id="1538675">chan</span>&nbsp;<span class="ident" id="1538680">time</span><span class="op" id="1538684">.</span><span class="ident" id="1538685">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538691">var</span>&nbsp;<span class="ident" id="1538695">respHeaderTimer</span>&nbsp;<span class="op" id="1538711">&lt;-</span><span class="keyword" id="1538713">chan</span>&nbsp;<span class="ident" id="1538718">time</span><span class="op" id="1538722">.</span><span class="ident" id="1538723">Time</span><br>
<span class="lineno">1080</span><span class="ident" id="1538728">WaitResponse</span><span class="op" id="1538740">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538743">for</span>&nbsp;<span class="op" id="1538747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538751">select</span>&nbsp;<span class="op" id="1538758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538762">case</span>&nbsp;<span class="ident" id="1538767">err</span>&nbsp;<span class="op" id="1538771">:=</span>&nbsp;<span class="op" id="1538774">&lt;-</span><span class="ident" id="1538776">writeErrCh</span><span class="op" id="1538786">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538791">if</span>&nbsp;<span class="ident" id="1538794">err</span>&nbsp;<span class="op" id="1538798">!=</span>&nbsp;<span class="ident" id="1538801">nil</span>&nbsp;<span class="op" id="1538805">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538811">re</span>&nbsp;<span class="op" id="1538814">=</span>&nbsp;<span class="ident" id="1538816">responseAndError</span><span class="op" id="1538832">{</span><span class="ident" id="1538833">nil</span><span class="op" id="1538836">,</span>&nbsp;<span class="ident" id="1538838">err</span><span class="op" id="1538841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538847">pc</span><span class="op" id="1538849">.</span><span class="builtinfunc" id="1538850">close</span><span class="op" id="1538855">(</span><span class="op" id="1538856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538862">break</span>&nbsp;<span class="ident" id="1538868">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538889">if</span>&nbsp;<span class="ident" id="1538892">d</span>&nbsp;<span class="op" id="1538894">:=</span>&nbsp;<span class="ident" id="1538897">pc</span><span class="op" id="1538899">.</span><span class="ident" id="1538900">t</span><span class="op" id="1538901">.</span><span class="ident" id="1538902">ResponseHeaderTimeout</span><span class="op" id="1538923">;</span>&nbsp;<span class="ident" id="1538925">d</span>&nbsp;<span class="op" id="1538927">&gt;</span>&nbsp;<span class="num" id="1538929">0</span>&nbsp;<span class="op" id="1538931">{</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1538937">respHeaderTimer</span>&nbsp;<span class="op" id="1538953">=</span>&nbsp;<span class="ident" id="1538955">time</span><span class="op" id="1538959">.</span><span class="ident" id="1538960">After</span><span class="op" id="1538965">(</span><span class="ident" id="1538966">d</span><span class="op" id="1538967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1538972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1538976">case</span>&nbsp;<span class="op" id="1538981">&lt;-</span><span class="ident" id="1538983">pconnDeadCh</span><span class="op" id="1538994">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1538999">//&nbsp;The&nbsp;persist&nbsp;connection&nbsp;is&nbsp;dead.&nbsp;This&nbsp;shouldn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539052">//&nbsp;usually&nbsp;happen&nbsp;(only&nbsp;with&nbsp;Connection:&nbsp;close&nbsp;responses</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539112">//&nbsp;with&nbsp;no&nbsp;response&nbsp;bodies),&nbsp;but&nbsp;if&nbsp;it&nbsp;does&nbsp;happen&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539169">//&nbsp;means&nbsp;either&nbsp;a)&nbsp;the&nbsp;remote&nbsp;server&nbsp;hung&nbsp;up&nbsp;on&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539223">//&nbsp;prematurely,&nbsp;or&nbsp;b)&nbsp;the&nbsp;readLoop&nbsp;sent&nbsp;us&nbsp;a&nbsp;response&nbsp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539282">//&nbsp;closed&nbsp;its&nbsp;closech&nbsp;at&nbsp;roughly&nbsp;the&nbsp;same&nbsp;time,&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539340">//&nbsp;selected&nbsp;this&nbsp;case&nbsp;first,&nbsp;in&nbsp;which&nbsp;case&nbsp;a&nbsp;response</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539397">//&nbsp;might&nbsp;still&nbsp;be&nbsp;coming&nbsp;soon.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539431">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539437">//&nbsp;We&nbsp;can&#39;t&nbsp;avoid&nbsp;the&nbsp;select&nbsp;race&nbsp;in&nbsp;b)&nbsp;by&nbsp;using&nbsp;a&nbsp;unbuffered</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539502">//&nbsp;resc&nbsp;channel&nbsp;instead,&nbsp;because&nbsp;then&nbsp;goroutines&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1539558">//&nbsp;leak&nbsp;if&nbsp;we&nbsp;exit&nbsp;due&nbsp;to&nbsp;other&nbsp;errors.</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539601">pconnDeadCh</span>&nbsp;<span class="op" id="1539613">=</span>&nbsp;<span class="ident" id="1539615">nil</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1539649">//&nbsp;avoid&nbsp;spinning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539670">failTicker</span>&nbsp;<span class="op" id="1539681">=</span>&nbsp;<span class="ident" id="1539683">time</span><span class="op" id="1539687">.</span><span class="ident" id="1539688">After</span><span class="op" id="1539693">(</span><span class="num" id="1539694">100</span>&nbsp;<span class="op" id="1539698">*</span>&nbsp;<span class="ident" id="1539700">time</span><span class="op" id="1539704">.</span><span class="ident" id="1539705">Millisecond</span><span class="op" id="1539716">)</span>&nbsp;<span class="comment" id="1539718">//&nbsp;arbitrary&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539755">case</span>&nbsp;<span class="op" id="1539760">&lt;-</span><span class="ident" id="1539762">failTicker</span><span class="op" id="1539772">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539777">re</span>&nbsp;<span class="op" id="1539780">=</span>&nbsp;<span class="ident" id="1539782">responseAndError</span><span class="op" id="1539798">{</span><span class="ident" id="1539799">err</span><span class="op" id="1539802">:</span>&nbsp;<span class="ident" id="1539804">errClosed</span><span class="op" id="1539813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539818">break</span>&nbsp;<span class="ident" id="1539824">WaitResponse</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539839">case</span>&nbsp;<span class="op" id="1539844">&lt;-</span><span class="ident" id="1539846">respHeaderTimer</span><span class="op" id="1539861">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539866">pc</span><span class="op" id="1539868">.</span><span class="builtinfunc" id="1539869">close</span><span class="op" id="1539874">(</span><span class="op" id="1539875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539880">re</span>&nbsp;<span class="op" id="1539883">=</span>&nbsp;<span class="ident" id="1539885">responseAndError</span><span class="op" id="1539901">{</span><span class="ident" id="1539902">err</span><span class="op" id="1539905">:</span>&nbsp;<span class="ident" id="1539907">errTimeout</span><span class="op" id="1539917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539922">break</span>&nbsp;<span class="ident" id="1539928">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539943">case</span>&nbsp;<span class="ident" id="1539948">re</span>&nbsp;<span class="op" id="1539951">=</span>&nbsp;<span class="op" id="1539953">&lt;-</span><span class="ident" id="1539955">resc</span><span class="op" id="1539959">:</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1539964">break</span>&nbsp;<span class="ident" id="1539970">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1539988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1539992">pc</span><span class="op" id="1539994">.</span><span class="ident" id="1539995">lk</span><span class="op" id="1539997">.</span><span class="ident" id="1539998">Lock</span><span class="op" id="1540002">(</span><span class="op" id="1540003">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540006">pc</span><span class="op" id="1540008">.</span><span class="ident" id="1540009">numExpectedResponses</span><span class="op" id="1540029">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540033">pc</span><span class="op" id="1540035">.</span><span class="ident" id="1540036">lk</span><span class="op" id="1540038">.</span><span class="ident" id="1540039">Unlock</span><span class="op" id="1540045">(</span><span class="op" id="1540046">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540050">if</span>&nbsp;<span class="ident" id="1540053">re</span><span class="op" id="1540055">.</span><span class="ident" id="1540056">err</span>&nbsp;<span class="op" id="1540060">!=</span>&nbsp;<span class="ident" id="1540063">nil</span>&nbsp;<span class="op" id="1540067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540071">pc</span><span class="op" id="1540073">.</span><span class="ident" id="1540074">t</span><span class="op" id="1540075">.</span><span class="ident" id="1540076">setReqCanceler</span><span class="op" id="1540090">(</span><span class="ident" id="1540091">req</span><span class="op" id="1540094">.</span><span class="ident" id="1540095">Request</span><span class="op" id="1540102">,</span>&nbsp;<span class="ident" id="1540104">nil</span><span class="op" id="1540107">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540113">return</span>&nbsp;<span class="ident" id="1540120">re</span><span class="op" id="1540122">.</span><span class="ident" id="1540123">res</span><span class="op" id="1540126">,</span>&nbsp;<span class="ident" id="1540128">re</span><span class="op" id="1540130">.</span><span class="ident" id="1540131">err</span><br>
<span class="lineno"></span><span class="op" id="1540135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1540138">//&nbsp;markBroken&nbsp;marks&nbsp;a&nbsp;connection&nbsp;as&nbsp;broken&nbsp;(so&nbsp;it&#39;s&nbsp;not&nbsp;reused).</span><br>
<span class="lineno">1130</span><span class="comment" id="1540203">//&nbsp;It&nbsp;differs&nbsp;from&nbsp;close&nbsp;in&nbsp;that&nbsp;it&nbsp;doesn&#39;t&nbsp;close&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="1540268">//&nbsp;connection&nbsp;for&nbsp;use&nbsp;when&nbsp;it&#39;s&nbsp;still&nbsp;being&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="1540318">func</span>&nbsp;<span class="op" id="1540323">(</span><span class="ident" id="1540324">pc</span>&nbsp;<span class="op" id="1540327">*</span><span class="ident" id="1540328">persistConn</span><span class="op" id="1540339">)</span>&nbsp;<span class="ident" id="1540341">markBroken</span><span class="op" id="1540351">(</span><span class="op" id="1540352">)</span>&nbsp;<span class="op" id="1540354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540357">pc</span><span class="op" id="1540359">.</span><span class="ident" id="1540360">lk</span><span class="op" id="1540362">.</span><span class="ident" id="1540363">Lock</span><span class="op" id="1540367">(</span><span class="op" id="1540368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540371">defer</span>&nbsp;<span class="ident" id="1540377">pc</span><span class="op" id="1540379">.</span><span class="ident" id="1540380">lk</span><span class="op" id="1540382">.</span><span class="ident" id="1540383">Unlock</span><span class="op" id="1540389">(</span><span class="op" id="1540390">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540393">pc</span><span class="op" id="1540395">.</span><span class="ident" id="1540396">broken</span>&nbsp;<span class="op" id="1540403">=</span>&nbsp;<span class="builtintype" id="1540405">true</span><br>
<span class="lineno"></span><span class="op" id="1540410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1540413">func</span>&nbsp;<span class="op" id="1540418">(</span><span class="ident" id="1540419">pc</span>&nbsp;<span class="op" id="1540422">*</span><span class="ident" id="1540423">persistConn</span><span class="op" id="1540434">)</span>&nbsp;<span class="builtinfunc" id="1540436">close</span><span class="op" id="1540441">(</span><span class="op" id="1540442">)</span>&nbsp;<span class="op" id="1540444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540447">pc</span><span class="op" id="1540449">.</span><span class="ident" id="1540450">lk</span><span class="op" id="1540452">.</span><span class="ident" id="1540453">Lock</span><span class="op" id="1540457">(</span><span class="op" id="1540458">)</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540461">defer</span>&nbsp;<span class="ident" id="1540467">pc</span><span class="op" id="1540469">.</span><span class="ident" id="1540470">lk</span><span class="op" id="1540472">.</span><span class="ident" id="1540473">Unlock</span><span class="op" id="1540479">(</span><span class="op" id="1540480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540483">pc</span><span class="op" id="1540485">.</span><span class="ident" id="1540486">closeLocked</span><span class="op" id="1540497">(</span><span class="op" id="1540498">)</span><br>
<span class="lineno"></span><span class="op" id="1540500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1540503">func</span>&nbsp;<span class="op" id="1540508">(</span><span class="ident" id="1540509">pc</span>&nbsp;<span class="op" id="1540512">*</span><span class="ident" id="1540513">persistConn</span><span class="op" id="1540524">)</span>&nbsp;<span class="ident" id="1540526">closeLocked</span><span class="op" id="1540537">(</span><span class="op" id="1540538">)</span>&nbsp;<span class="op" id="1540540">{</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540543">pc</span><span class="op" id="1540545">.</span><span class="ident" id="1540546">broken</span>&nbsp;<span class="op" id="1540553">=</span>&nbsp;<span class="builtintype" id="1540555">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540561">if</span>&nbsp;<span class="op" id="1540564">!</span><span class="ident" id="1540565">pc</span><span class="op" id="1540567">.</span><span class="ident" id="1540568">closed</span>&nbsp;<span class="op" id="1540575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540579">pc</span><span class="op" id="1540581">.</span><span class="ident" id="1540582">conn</span><span class="op" id="1540586">.</span><span class="ident" id="1540587">Close</span><span class="op" id="1540592">(</span><span class="op" id="1540593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540597">pc</span><span class="op" id="1540599">.</span><span class="ident" id="1540600">closed</span>&nbsp;<span class="op" id="1540607">=</span>&nbsp;<span class="builtintype" id="1540609">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1540616">close</span><span class="op" id="1540621">(</span><span class="ident" id="1540622">pc</span><span class="op" id="1540624">.</span><span class="ident" id="1540625">closech</span><span class="op" id="1540632">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540638">pc</span><span class="op" id="1540640">.</span><span class="ident" id="1540641">mutateHeaderFunc</span>&nbsp;<span class="op" id="1540658">=</span>&nbsp;<span class="ident" id="1540660">nil</span><br>
<span class="lineno"></span><span class="op" id="1540664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1540667">var</span>&nbsp;<span class="ident" id="1540671">portMap</span>&nbsp;<span class="op" id="1540679">=</span>&nbsp;<span class="keyword" id="1540681">map</span><span class="op" id="1540684">[</span><span class="builtintype" id="1540685">string</span><span class="op" id="1540691">]</span><span class="builtintype" id="1540692">string</span><span class="op" id="1540698">{</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1540701">&#34;http&#34;</span><span class="op" id="1540707">:</span>&nbsp;&nbsp;<span class="string" id="1540710">&#34;80&#34;</span><span class="op" id="1540714">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1540717">&#34;https&#34;</span><span class="op" id="1540724">:</span>&nbsp;<span class="string" id="1540726">&#34;443&#34;</span><span class="op" id="1540731">,</span><br>
<span class="lineno"></span><span class="op" id="1540733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1540736">//&nbsp;canonicalAddr&nbsp;returns&nbsp;url.Host&nbsp;but&nbsp;always&nbsp;with&nbsp;a&nbsp;&#34;:port&#34;&nbsp;suffix</span><br>
<span class="lineno">1160</span><span class="keyword" id="1540803">func</span>&nbsp;<span class="ident" id="1540808">canonicalAddr</span><span class="op" id="1540821">(</span><span class="ident" id="1540822">url</span>&nbsp;<span class="op" id="1540826">*</span><span class="ident" id="1540827">url</span><span class="op" id="1540830">.</span><span class="ident" id="1540831">URL</span><span class="op" id="1540834">)</span>&nbsp;<span class="builtintype" id="1540836">string</span>&nbsp;<span class="op" id="1540843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1540846">addr</span>&nbsp;<span class="op" id="1540851">:=</span>&nbsp;<span class="ident" id="1540854">url</span><span class="op" id="1540857">.</span><span class="ident" id="1540858">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540864">if</span>&nbsp;<span class="op" id="1540867">!</span><span class="ident" id="1540868">hasPort</span><span class="op" id="1540875">(</span><span class="ident" id="1540876">addr</span><span class="op" id="1540880">)</span>&nbsp;<span class="op" id="1540882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540886">return</span>&nbsp;<span class="ident" id="1540893">addr</span>&nbsp;<span class="op" id="1540898">+</span>&nbsp;<span class="string" id="1540900">&#34;:&#34;</span>&nbsp;<span class="op" id="1540904">+</span>&nbsp;<span class="ident" id="1540906">portMap</span><span class="op" id="1540913">[</span><span class="ident" id="1540914">url</span><span class="op" id="1540917">.</span><span class="ident" id="1540918">Scheme</span><span class="op" id="1540924">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1540927">}</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1540930">return</span>&nbsp;<span class="ident" id="1540937">addr</span><br>
<span class="lineno"></span><span class="op" id="1540942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1540945">//&nbsp;bodyEOFSignal&nbsp;wraps&nbsp;a&nbsp;ReadCloser&nbsp;but&nbsp;runs&nbsp;fn&nbsp;(if&nbsp;non-nil)&nbsp;at&nbsp;most</span><br>
<span class="lineno"></span><span class="comment" id="1541014">//&nbsp;once,&nbsp;right&nbsp;before&nbsp;its&nbsp;final&nbsp;(error-producing)&nbsp;Read&nbsp;or&nbsp;Close&nbsp;call</span><br>
<span class="lineno">1170</span><span class="comment" id="1541083">//&nbsp;returns.&nbsp;If&nbsp;earlyCloseFn&nbsp;is&nbsp;non-nil&nbsp;and&nbsp;Close&nbsp;is&nbsp;called&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="1541149">//&nbsp;io.EOF&nbsp;is&nbsp;seen,&nbsp;earlyCloseFn&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;fn,&nbsp;and&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="1541214">//&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="1541262">type</span>&nbsp;<span class="ident" id="1541267">bodyEOFSignal</span>&nbsp;<span class="keyword" id="1541281">struct</span>&nbsp;<span class="op" id="1541288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541291">body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541304">io</span><span class="op" id="1541306">.</span><span class="ident" id="1541307">ReadCloser</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541319">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541332">sync</span><span class="op" id="1541336">.</span><span class="ident" id="1541337">Mutex</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1541345">//&nbsp;guards&nbsp;following&nbsp;4&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541375">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1541388">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1541401">//&nbsp;whether&nbsp;Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541435">rerr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1541448">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1541461">//&nbsp;sticky&nbsp;Read&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541483">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1541496">func</span><span class="op" id="1541500">(</span><span class="builtintype" id="1541501">error</span><span class="op" id="1541506">)</span>&nbsp;&nbsp;<span class="comment" id="1541509">//&nbsp;error&nbsp;will&nbsp;be&nbsp;nil&nbsp;on&nbsp;Read&nbsp;io.EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541546">earlyCloseFn</span>&nbsp;<span class="keyword" id="1541559">func</span><span class="op" id="1541563">(</span><span class="op" id="1541564">)</span>&nbsp;<span class="builtintype" id="1541566">error</span>&nbsp;<span class="comment" id="1541572">//&nbsp;optional&nbsp;alt&nbsp;Close&nbsp;func&nbsp;used&nbsp;if&nbsp;io.EOF&nbsp;not&nbsp;seen</span><br>
<span class="lineno">1180</span><span class="op" id="1541623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1541626">func</span>&nbsp;<span class="op" id="1541631">(</span><span class="ident" id="1541632">es</span>&nbsp;<span class="op" id="1541635">*</span><span class="ident" id="1541636">bodyEOFSignal</span><span class="op" id="1541649">)</span>&nbsp;<span class="ident" id="1541651">Read</span><span class="op" id="1541655">(</span><span class="ident" id="1541656">p</span>&nbsp;<span class="op" id="1541658">[</span><span class="op" id="1541659">]</span><span class="builtintype" id="1541660">byte</span><span class="op" id="1541664">)</span>&nbsp;<span class="op" id="1541666">(</span><span class="ident" id="1541667">n</span>&nbsp;<span class="builtintype" id="1541669">int</span><span class="op" id="1541672">,</span>&nbsp;<span class="ident" id="1541674">err</span>&nbsp;<span class="builtintype" id="1541678">error</span><span class="op" id="1541683">)</span>&nbsp;<span class="op" id="1541685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541688">es</span><span class="op" id="1541690">.</span><span class="ident" id="1541691">mu</span><span class="op" id="1541693">.</span><span class="ident" id="1541694">Lock</span><span class="op" id="1541698">(</span><span class="op" id="1541699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541702">closed</span><span class="op" id="1541708">,</span>&nbsp;<span class="ident" id="1541710">rerr</span>&nbsp;<span class="op" id="1541715">:=</span>&nbsp;<span class="ident" id="1541718">es</span><span class="op" id="1541720">.</span><span class="ident" id="1541721">closed</span><span class="op" id="1541727">,</span>&nbsp;<span class="ident" id="1541729">es</span><span class="op" id="1541731">.</span><span class="ident" id="1541732">rerr</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541738">es</span><span class="op" id="1541740">.</span><span class="ident" id="1541741">mu</span><span class="op" id="1541743">.</span><span class="ident" id="1541744">Unlock</span><span class="op" id="1541750">(</span><span class="op" id="1541751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541754">if</span>&nbsp;<span class="ident" id="1541757">closed</span>&nbsp;<span class="op" id="1541764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541768">return</span>&nbsp;<span class="num" id="1541775">0</span><span class="op" id="1541776">,</span>&nbsp;<span class="ident" id="1541778">errors</span><span class="op" id="1541784">.</span><span class="ident" id="1541785">New</span><span class="op" id="1541788">(</span><span class="string" id="1541789">&#34;http:&nbsp;read&nbsp;on&nbsp;closed&nbsp;response&nbsp;body&#34;</span><span class="op" id="1541825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541831">if</span>&nbsp;<span class="ident" id="1541834">rerr</span>&nbsp;<span class="op" id="1541839">!=</span>&nbsp;<span class="ident" id="1541842">nil</span>&nbsp;<span class="op" id="1541846">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541850">return</span>&nbsp;<span class="num" id="1541857">0</span><span class="op" id="1541858">,</span>&nbsp;<span class="ident" id="1541860">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541870">n</span><span class="op" id="1541871">,</span>&nbsp;<span class="ident" id="1541873">err</span>&nbsp;<span class="op" id="1541877">=</span>&nbsp;<span class="ident" id="1541879">es</span><span class="op" id="1541881">.</span><span class="ident" id="1541882">body</span><span class="op" id="1541886">.</span><span class="ident" id="1541887">Read</span><span class="op" id="1541891">(</span><span class="ident" id="1541892">p</span><span class="op" id="1541893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541896">if</span>&nbsp;<span class="ident" id="1541899">err</span>&nbsp;<span class="op" id="1541903">!=</span>&nbsp;<span class="ident" id="1541906">nil</span>&nbsp;<span class="op" id="1541910">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541914">es</span><span class="op" id="1541916">.</span><span class="ident" id="1541917">mu</span><span class="op" id="1541919">.</span><span class="ident" id="1541920">Lock</span><span class="op" id="1541924">(</span><span class="op" id="1541925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541929">defer</span>&nbsp;<span class="ident" id="1541935">es</span><span class="op" id="1541937">.</span><span class="ident" id="1541938">mu</span><span class="op" id="1541940">.</span><span class="ident" id="1541941">Unlock</span><span class="op" id="1541947">(</span><span class="op" id="1541948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1541952">if</span>&nbsp;<span class="ident" id="1541955">es</span><span class="op" id="1541957">.</span><span class="ident" id="1541958">rerr</span>&nbsp;<span class="op" id="1541963">==</span>&nbsp;<span class="ident" id="1541966">nil</span>&nbsp;<span class="op" id="1541970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541975">es</span><span class="op" id="1541977">.</span><span class="ident" id="1541978">rerr</span>&nbsp;<span class="op" id="1541983">=</span>&nbsp;<span class="ident" id="1541985">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1541991">}</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1541995">es</span><span class="op" id="1541997">.</span><span class="ident" id="1541998">condfn</span><span class="op" id="1542004">(</span><span class="ident" id="1542005">err</span><span class="op" id="1542008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542014">return</span><br>
<span class="lineno"></span><span class="op" id="1542021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1205</span><span class="keyword" id="1542024">func</span>&nbsp;<span class="op" id="1542029">(</span><span class="ident" id="1542030">es</span>&nbsp;<span class="op" id="1542033">*</span><span class="ident" id="1542034">bodyEOFSignal</span><span class="op" id="1542047">)</span>&nbsp;<span class="ident" id="1542049">Close</span><span class="op" id="1542054">(</span><span class="op" id="1542055">)</span>&nbsp;<span class="builtintype" id="1542057">error</span>&nbsp;<span class="op" id="1542063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542066">es</span><span class="op" id="1542068">.</span><span class="ident" id="1542069">mu</span><span class="op" id="1542071">.</span><span class="ident" id="1542072">Lock</span><span class="op" id="1542076">(</span><span class="op" id="1542077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542080">defer</span>&nbsp;<span class="ident" id="1542086">es</span><span class="op" id="1542088">.</span><span class="ident" id="1542089">mu</span><span class="op" id="1542091">.</span><span class="ident" id="1542092">Unlock</span><span class="op" id="1542098">(</span><span class="op" id="1542099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542102">if</span>&nbsp;<span class="ident" id="1542105">es</span><span class="op" id="1542107">.</span><span class="ident" id="1542108">closed</span>&nbsp;<span class="op" id="1542115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542119">return</span>&nbsp;<span class="ident" id="1542126">nil</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542134">es</span><span class="op" id="1542136">.</span><span class="ident" id="1542137">closed</span>&nbsp;<span class="op" id="1542144">=</span>&nbsp;<span class="builtintype" id="1542146">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542152">if</span>&nbsp;<span class="ident" id="1542155">es</span><span class="op" id="1542157">.</span><span class="ident" id="1542158">earlyCloseFn</span>&nbsp;<span class="op" id="1542171">!=</span>&nbsp;<span class="ident" id="1542174">nil</span>&nbsp;<span class="op" id="1542178">&amp;&amp;</span>&nbsp;<span class="ident" id="1542181">es</span><span class="op" id="1542183">.</span><span class="ident" id="1542184">rerr</span>&nbsp;<span class="op" id="1542189">!=</span>&nbsp;<span class="ident" id="1542192">io</span><span class="op" id="1542194">.</span><span class="ident" id="1542195">EOF</span>&nbsp;<span class="op" id="1542199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542203">return</span>&nbsp;<span class="ident" id="1542210">es</span><span class="op" id="1542212">.</span><span class="ident" id="1542213">earlyCloseFn</span><span class="op" id="1542225">(</span><span class="op" id="1542226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542229">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542232">err</span>&nbsp;<span class="op" id="1542236">:=</span>&nbsp;<span class="ident" id="1542239">es</span><span class="op" id="1542241">.</span><span class="ident" id="1542242">body</span><span class="op" id="1542246">.</span><span class="ident" id="1542247">Close</span><span class="op" id="1542252">(</span><span class="op" id="1542253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542256">es</span><span class="op" id="1542258">.</span><span class="ident" id="1542259">condfn</span><span class="op" id="1542265">(</span><span class="ident" id="1542266">err</span><span class="op" id="1542269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542272">return</span>&nbsp;<span class="ident" id="1542279">err</span><br>
<span class="lineno"></span><span class="op" id="1542283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span><span class="comment" id="1542286">//&nbsp;caller&nbsp;must&nbsp;hold&nbsp;es.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="1542313">func</span>&nbsp;<span class="op" id="1542318">(</span><span class="ident" id="1542319">es</span>&nbsp;<span class="op" id="1542322">*</span><span class="ident" id="1542323">bodyEOFSignal</span><span class="op" id="1542336">)</span>&nbsp;<span class="ident" id="1542338">condfn</span><span class="op" id="1542344">(</span><span class="ident" id="1542345">err</span>&nbsp;<span class="builtintype" id="1542349">error</span><span class="op" id="1542354">)</span>&nbsp;<span class="op" id="1542356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542359">if</span>&nbsp;<span class="ident" id="1542362">es</span><span class="op" id="1542364">.</span><span class="ident" id="1542365">fn</span>&nbsp;<span class="op" id="1542368">==</span>&nbsp;<span class="ident" id="1542371">nil</span>&nbsp;<span class="op" id="1542375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542379">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542387">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542390">if</span>&nbsp;<span class="ident" id="1542393">err</span>&nbsp;<span class="op" id="1542397">==</span>&nbsp;<span class="ident" id="1542400">io</span><span class="op" id="1542402">.</span><span class="ident" id="1542403">EOF</span>&nbsp;<span class="op" id="1542407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542411">err</span>&nbsp;<span class="op" id="1542415">=</span>&nbsp;<span class="ident" id="1542417">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542425">es</span><span class="op" id="1542427">.</span><span class="ident" id="1542428">fn</span><span class="op" id="1542430">(</span><span class="ident" id="1542431">err</span><span class="op" id="1542434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542437">es</span><span class="op" id="1542439">.</span><span class="ident" id="1542440">fn</span>&nbsp;<span class="op" id="1542443">=</span>&nbsp;<span class="ident" id="1542445">nil</span><br>
<span class="lineno">1230</span><span class="op" id="1542449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1542452">//&nbsp;gzipReader&nbsp;wraps&nbsp;a&nbsp;response&nbsp;body&nbsp;so&nbsp;it&nbsp;can&nbsp;lazily</span><br>
<span class="lineno"></span><span class="comment" id="1542505">//&nbsp;call&nbsp;gzip.NewReader&nbsp;on&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Read</span><br>
<span class="lineno"></span><span class="keyword" id="1542554">type</span>&nbsp;<span class="ident" id="1542559">gzipReader</span>&nbsp;<span class="keyword" id="1542570">struct</span>&nbsp;<span class="op" id="1542577">{</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542580">body</span>&nbsp;<span class="ident" id="1542585">io</span><span class="op" id="1542587">.</span><span class="ident" id="1542588">ReadCloser</span>&nbsp;<span class="comment" id="1542599">//&nbsp;underlying&nbsp;Response.Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542628">zr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1542633">io</span><span class="op" id="1542635">.</span><span class="ident" id="1542636">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1542647">//&nbsp;lazily-initialized&nbsp;gzip&nbsp;reader</span><br>
<span class="lineno"></span><span class="op" id="1542681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1542684">func</span>&nbsp;<span class="op" id="1542689">(</span><span class="ident" id="1542690">gz</span>&nbsp;<span class="op" id="1542693">*</span><span class="ident" id="1542694">gzipReader</span><span class="op" id="1542704">)</span>&nbsp;<span class="ident" id="1542706">Read</span><span class="op" id="1542710">(</span><span class="ident" id="1542711">p</span>&nbsp;<span class="op" id="1542713">[</span><span class="op" id="1542714">]</span><span class="builtintype" id="1542715">byte</span><span class="op" id="1542719">)</span>&nbsp;<span class="op" id="1542721">(</span><span class="ident" id="1542722">n</span>&nbsp;<span class="builtintype" id="1542724">int</span><span class="op" id="1542727">,</span>&nbsp;<span class="ident" id="1542729">err</span>&nbsp;<span class="builtintype" id="1542733">error</span><span class="op" id="1542738">)</span>&nbsp;<span class="op" id="1542740">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542743">if</span>&nbsp;<span class="ident" id="1542746">gz</span><span class="op" id="1542748">.</span><span class="ident" id="1542749">zr</span>&nbsp;<span class="op" id="1542752">==</span>&nbsp;<span class="ident" id="1542755">nil</span>&nbsp;<span class="op" id="1542759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542763">gz</span><span class="op" id="1542765">.</span><span class="ident" id="1542766">zr</span><span class="op" id="1542768">,</span>&nbsp;<span class="ident" id="1542770">err</span>&nbsp;<span class="op" id="1542774">=</span>&nbsp;<span class="ident" id="1542776">gzip</span><span class="op" id="1542780">.</span><span class="ident" id="1542781">NewReader</span><span class="op" id="1542790">(</span><span class="ident" id="1542791">gz</span><span class="op" id="1542793">.</span><span class="ident" id="1542794">body</span><span class="op" id="1542798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542802">if</span>&nbsp;<span class="ident" id="1542805">err</span>&nbsp;<span class="op" id="1542809">!=</span>&nbsp;<span class="ident" id="1542812">nil</span>&nbsp;<span class="op" id="1542816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542821">return</span>&nbsp;<span class="num" id="1542828">0</span><span class="op" id="1542829">,</span>&nbsp;<span class="ident" id="1542831">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542837">}</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1542840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542843">return</span>&nbsp;<span class="ident" id="1542850">gz</span><span class="op" id="1542852">.</span><span class="ident" id="1542853">zr</span><span class="op" id="1542855">.</span><span class="ident" id="1542856">Read</span><span class="op" id="1542860">(</span><span class="ident" id="1542861">p</span><span class="op" id="1542862">)</span><br>
<span class="lineno"></span><span class="op" id="1542864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1542867">func</span>&nbsp;<span class="op" id="1542872">(</span><span class="ident" id="1542873">gz</span>&nbsp;<span class="op" id="1542876">*</span><span class="ident" id="1542877">gzipReader</span><span class="op" id="1542887">)</span>&nbsp;<span class="ident" id="1542889">Close</span><span class="op" id="1542894">(</span><span class="op" id="1542895">)</span>&nbsp;<span class="builtintype" id="1542897">error</span>&nbsp;<span class="op" id="1542903">{</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1542906">return</span>&nbsp;<span class="ident" id="1542913">gz</span><span class="op" id="1542915">.</span><span class="ident" id="1542916">body</span><span class="op" id="1542920">.</span><span class="ident" id="1542921">Close</span><span class="op" id="1542926">(</span><span class="op" id="1542927">)</span><br>
<span class="lineno"></span><span class="op" id="1542929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1542932">type</span>&nbsp;<span class="ident" id="1542937">readerAndCloser</span>&nbsp;<span class="keyword" id="1542953">struct</span>&nbsp;<span class="op" id="1542960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542963">io</span><span class="op" id="1542965">.</span><span class="ident" id="1542966">Reader</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1542974">io</span><span class="op" id="1542976">.</span><span class="ident" id="1542977">Closer</span><br>
<span class="lineno"></span><span class="op" id="1542984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1542987">type</span>&nbsp;<span class="ident" id="1542992">tlsHandshakeTimeoutError</span>&nbsp;<span class="keyword" id="1543017">struct</span><span class="op" id="1543023">{</span><span class="op" id="1543024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1260</span><span class="keyword" id="1543027">func</span>&nbsp;<span class="op" id="1543032">(</span><span class="ident" id="1543033">tlsHandshakeTimeoutError</span><span class="op" id="1543057">)</span>&nbsp;<span class="ident" id="1543059">Timeout</span><span class="op" id="1543066">(</span><span class="op" id="1543067">)</span>&nbsp;<span class="builtintype" id="1543069">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1543076">{</span>&nbsp;<span class="keyword" id="1543078">return</span>&nbsp;<span class="builtintype" id="1543085">true</span>&nbsp;<span class="op" id="1543090">}</span><br>
<span class="lineno"></span><span class="keyword" id="1543092">func</span>&nbsp;<span class="op" id="1543097">(</span><span class="ident" id="1543098">tlsHandshakeTimeoutError</span><span class="op" id="1543122">)</span>&nbsp;<span class="ident" id="1543124">Temporary</span><span class="op" id="1543133">(</span><span class="op" id="1543134">)</span>&nbsp;<span class="builtintype" id="1543136">bool</span>&nbsp;<span class="op" id="1543141">{</span>&nbsp;<span class="keyword" id="1543143">return</span>&nbsp;<span class="builtintype" id="1543150">true</span>&nbsp;<span class="op" id="1543155">}</span><br>
<span class="lineno"></span><span class="keyword" id="1543157">func</span>&nbsp;<span class="op" id="1543162">(</span><span class="ident" id="1543163">tlsHandshakeTimeoutError</span><span class="op" id="1543187">)</span>&nbsp;<span class="ident" id="1543189">Error</span><span class="op" id="1543194">(</span><span class="op" id="1543195">)</span>&nbsp;<span class="builtintype" id="1543197">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1543206">{</span>&nbsp;<span class="keyword" id="1543208">return</span>&nbsp;<span class="string" id="1543215">&#34;net/http:&nbsp;TLS&nbsp;handshake&nbsp;timeout&#34;</span>&nbsp;<span class="op" id="1543249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1543252">type</span>&nbsp;<span class="ident" id="1543257">noteEOFReader</span>&nbsp;<span class="keyword" id="1543271">struct</span>&nbsp;<span class="op" id="1543278">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543281">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543288">io</span><span class="op" id="1543290">.</span><span class="ident" id="1543291">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543299">sawEOF</span>&nbsp;<span class="op" id="1543306">*</span><span class="builtintype" id="1543307">bool</span><br>
<span class="lineno"></span><span class="op" id="1543312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1543315">func</span>&nbsp;<span class="op" id="1543320">(</span><span class="ident" id="1543321">nr</span>&nbsp;<span class="ident" id="1543324">noteEOFReader</span><span class="op" id="1543337">)</span>&nbsp;<span class="ident" id="1543339">Read</span><span class="op" id="1543343">(</span><span class="ident" id="1543344">p</span>&nbsp;<span class="op" id="1543346">[</span><span class="op" id="1543347">]</span><span class="builtintype" id="1543348">byte</span><span class="op" id="1543352">)</span>&nbsp;<span class="op" id="1543354">(</span><span class="ident" id="1543355">n</span>&nbsp;<span class="builtintype" id="1543357">int</span><span class="op" id="1543360">,</span>&nbsp;<span class="ident" id="1543362">err</span>&nbsp;<span class="builtintype" id="1543366">error</span><span class="op" id="1543371">)</span>&nbsp;<span class="op" id="1543373">{</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1543376">n</span><span class="op" id="1543377">,</span>&nbsp;<span class="ident" id="1543379">err</span>&nbsp;<span class="op" id="1543383">=</span>&nbsp;<span class="ident" id="1543385">nr</span><span class="op" id="1543387">.</span><span class="ident" id="1543388">r</span><span class="op" id="1543389">.</span><span class="ident" id="1543390">Read</span><span class="op" id="1543394">(</span><span class="ident" id="1543395">p</span><span class="op" id="1543396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543399">if</span>&nbsp;<span class="ident" id="1543402">err</span>&nbsp;<span class="op" id="1543406">==</span>&nbsp;<span class="ident" id="1543409">io</span><span class="op" id="1543411">.</span><span class="ident" id="1543412">EOF</span>&nbsp;<span class="op" id="1543416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543420">*</span><span class="ident" id="1543421">nr</span><span class="op" id="1543423">.</span><span class="ident" id="1543424">sawEOF</span>&nbsp;<span class="op" id="1543431">=</span>&nbsp;<span class="builtintype" id="1543433">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1543439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1543442">return</span><br>
<span class="lineno">1275</span><span class="op" id="1543449">}</span>
</div>
</body>
</html>
