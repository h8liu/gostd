<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html" class="current">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1467615">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1467671">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1467725">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1467776">//&nbsp;CPU&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1467794">//&nbsp;Based&nbsp;on&nbsp;algorithms&nbsp;and&nbsp;data&nbsp;structures&nbsp;used&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1467845">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="comment" id="1467892">//</span><br>
<span class="lineno"></span><span class="comment" id="1467895">//&nbsp;The&nbsp;main&nbsp;difference&nbsp;between&nbsp;this&nbsp;code&nbsp;and&nbsp;the&nbsp;google-perftools</span><br>
<span class="lineno">10</span><span class="comment" id="1467961">//&nbsp;code&nbsp;is&nbsp;that&nbsp;this&nbsp;code&nbsp;is&nbsp;written&nbsp;to&nbsp;allow&nbsp;copying&nbsp;the&nbsp;profile&nbsp;data</span><br>
<span class="lineno"></span><span class="comment" id="1468032">//&nbsp;to&nbsp;an&nbsp;arbitrary&nbsp;io.Writer,&nbsp;while&nbsp;the&nbsp;google-perftools&nbsp;code&nbsp;always</span><br>
<span class="lineno"></span><span class="comment" id="1468101">//&nbsp;writes&nbsp;to&nbsp;an&nbsp;operating&nbsp;system&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1468140">//</span><br>
<span class="lineno"></span><span class="comment" id="1468143">//&nbsp;The&nbsp;signal&nbsp;handler&nbsp;for&nbsp;the&nbsp;profiling&nbsp;clock&nbsp;tick&nbsp;adds&nbsp;a&nbsp;new&nbsp;stack&nbsp;trace</span><br>
<span class="lineno">15</span><span class="comment" id="1468217">//&nbsp;to&nbsp;a&nbsp;hash&nbsp;table&nbsp;tracking&nbsp;counts&nbsp;for&nbsp;recent&nbsp;traces.&nbsp;&nbsp;Most&nbsp;clock&nbsp;ticks</span><br>
<span class="lineno"></span><span class="comment" id="1468289">//&nbsp;hit&nbsp;in&nbsp;the&nbsp;cache.&nbsp;&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;cache&nbsp;miss,&nbsp;an&nbsp;entry&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1468358">//&nbsp;evicted&nbsp;from&nbsp;the&nbsp;hash&nbsp;table,&nbsp;copied&nbsp;to&nbsp;a&nbsp;log&nbsp;that&nbsp;will&nbsp;eventually&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1468430">//&nbsp;written&nbsp;as&nbsp;profile&nbsp;data.&nbsp;&nbsp;The&nbsp;google-perftools&nbsp;code&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1468497">//&nbsp;log&nbsp;itself&nbsp;during&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;This&nbsp;code&nbsp;cannot&nbsp;do&nbsp;that,&nbsp;because</span><br>
<span class="lineno">20</span><span class="comment" id="1468573">//&nbsp;the&nbsp;io.Writer&nbsp;might&nbsp;block&nbsp;or&nbsp;need&nbsp;system&nbsp;calls&nbsp;or&nbsp;locks&nbsp;that&nbsp;are&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1468645">//&nbsp;safe&nbsp;to&nbsp;use&nbsp;from&nbsp;within&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;Instead,&nbsp;we&nbsp;split&nbsp;the&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1468719">//&nbsp;into&nbsp;two&nbsp;halves&nbsp;and&nbsp;let&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fill&nbsp;one&nbsp;half&nbsp;while&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1468797">//&nbsp;is&nbsp;writing&nbsp;out&nbsp;the&nbsp;other&nbsp;half.&nbsp;&nbsp;When&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fills&nbsp;its&nbsp;half,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1468875">//&nbsp;offers&nbsp;to&nbsp;swap&nbsp;with&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;If&nbsp;the&nbsp;writer&nbsp;is&nbsp;not&nbsp;done&nbsp;with&nbsp;its&nbsp;half,</span><br>
<span class="lineno">25</span><span class="comment" id="1468955">//&nbsp;we&nbsp;lose&nbsp;the&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;clock&nbsp;tick&nbsp;(and&nbsp;record&nbsp;that&nbsp;loss).</span><br>
<span class="lineno"></span><span class="comment" id="1469026">//&nbsp;The&nbsp;goroutine&nbsp;interacts&nbsp;with&nbsp;the&nbsp;signal&nbsp;handler&nbsp;by&nbsp;calling&nbsp;getprofile()&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1469104">//&nbsp;get&nbsp;the&nbsp;next&nbsp;log&nbsp;piece&nbsp;to&nbsp;write,&nbsp;implicitly&nbsp;handing&nbsp;back&nbsp;the&nbsp;last&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1469177">//&nbsp;piece&nbsp;it&nbsp;obtained.</span><br>
<span class="lineno"></span><span class="comment" id="1469199">//</span><br>
<span class="lineno">30</span><span class="comment" id="1469202">//&nbsp;The&nbsp;state&nbsp;of&nbsp;this&nbsp;dance&nbsp;between&nbsp;the&nbsp;signal&nbsp;handler&nbsp;and&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1469274">//&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the&nbsp;Profile.handoff&nbsp;field.&nbsp;&nbsp;If&nbsp;handoff&nbsp;==&nbsp;0,&nbsp;then&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1469355">//&nbsp;is&nbsp;not&nbsp;using&nbsp;either&nbsp;log&nbsp;half&nbsp;and&nbsp;is&nbsp;waiting&nbsp;(or&nbsp;will&nbsp;soon&nbsp;be&nbsp;waiting)&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1469432">//&nbsp;a&nbsp;new&nbsp;piece&nbsp;by&nbsp;calling&nbsp;notesleep(&amp;p-&gt;wait).&nbsp;&nbsp;If&nbsp;the&nbsp;signal&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1469502">//&nbsp;changes&nbsp;handoff&nbsp;from&nbsp;0&nbsp;to&nbsp;non-zero,&nbsp;it&nbsp;must&nbsp;call&nbsp;notewakeup(&amp;p-&gt;wait)</span><br>
<span class="lineno">35</span><span class="comment" id="1469575">//&nbsp;to&nbsp;wake&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;The&nbsp;value&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1469651">//&nbsp;log&nbsp;half&nbsp;being&nbsp;handed&nbsp;off.&nbsp;&nbsp;The&nbsp;goroutine&nbsp;leaves&nbsp;the&nbsp;non-zero&nbsp;value&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1469725">//&nbsp;place&nbsp;until&nbsp;it&nbsp;has&nbsp;finished&nbsp;processing&nbsp;the&nbsp;log&nbsp;half&nbsp;and&nbsp;then&nbsp;flips&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="1469806">//&nbsp;back&nbsp;to&nbsp;zero.&nbsp;&nbsp;Setting&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;handoff&nbsp;means&nbsp;that&nbsp;the&nbsp;profiling&nbsp;is&nbsp;over,</span><br>
<span class="lineno"></span><span class="comment" id="1469890">//&nbsp;and&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;now&nbsp;in&nbsp;charge&nbsp;of&nbsp;flushing&nbsp;the&nbsp;data&nbsp;left&nbsp;in&nbsp;the&nbsp;hash&nbsp;table</span><br>
<span class="lineno">40</span><span class="comment" id="1469972">//&nbsp;to&nbsp;the&nbsp;log&nbsp;and&nbsp;returning&nbsp;that&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1470011">//</span><br>
<span class="lineno"></span><span class="comment" id="1470014">//&nbsp;The&nbsp;handoff&nbsp;field&nbsp;is&nbsp;manipulated&nbsp;using&nbsp;atomic&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1470075">//&nbsp;For&nbsp;the&nbsp;most&nbsp;part,&nbsp;the&nbsp;manipulation&nbsp;of&nbsp;handoff&nbsp;is&nbsp;orderly:&nbsp;if&nbsp;handoff&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="1470153">//&nbsp;then&nbsp;the&nbsp;signal&nbsp;handler&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;non-zero.</span><br>
<span class="lineno">45</span><span class="comment" id="1470219">//&nbsp;If&nbsp;handoff&nbsp;!=&nbsp;0&nbsp;then&nbsp;the&nbsp;goroutine&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="comment" id="1470292">//&nbsp;If&nbsp;that&nbsp;were&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;story&nbsp;then&nbsp;we&nbsp;would&nbsp;not&nbsp;need&nbsp;to&nbsp;manipulate</span><br>
<span class="lineno"></span><span class="comment" id="1470366">//&nbsp;handoff&nbsp;using&nbsp;atomic&nbsp;operations.&nbsp;&nbsp;The&nbsp;operations&nbsp;are&nbsp;needed,&nbsp;however,</span><br>
<span class="lineno"></span><span class="comment" id="1470439">//&nbsp;in&nbsp;order&nbsp;to&nbsp;let&nbsp;the&nbsp;log&nbsp;closer&nbsp;set&nbsp;the&nbsp;high&nbsp;bit&nbsp;to&nbsp;indicate&nbsp;&#34;EOF&#34;&nbsp;safely</span><br>
<span class="lineno"></span><span class="comment" id="1470515">//&nbsp;in&nbsp;the&nbsp;situation&nbsp;when&nbsp;normally&nbsp;the&nbsp;goroutine&nbsp;&#34;owns&#34;&nbsp;handoff.</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="1470580">package</span>&nbsp;<span class="ident" id="1470588">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1470597">import</span>&nbsp;<span class="string" id="1470604">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1470614">const</span>&nbsp;<span class="op" id="1470620">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470623">numBuckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1470639">=</span>&nbsp;<span class="num" id="1470641">1</span>&nbsp;<span class="op" id="1470643">&lt;&lt;</span>&nbsp;<span class="num" id="1470646">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470650">logSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1470666">=</span>&nbsp;<span class="num" id="1470668">1</span>&nbsp;<span class="op" id="1470670">&lt;&lt;</span>&nbsp;<span class="num" id="1470673">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470677">assoc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1470693">=</span>&nbsp;<span class="num" id="1470695">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470698">maxCPUProfStack</span>&nbsp;<span class="op" id="1470714">=</span>&nbsp;<span class="num" id="1470716">64</span><br>
<span class="lineno">60</span><span class="op" id="1470719">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1470722">type</span>&nbsp;<span class="ident" id="1470727">cpuprofEntry</span>&nbsp;<span class="keyword" id="1470740">struct</span>&nbsp;<span class="op" id="1470747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470750">count</span>&nbsp;<span class="builtintype" id="1470756">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470765">depth</span>&nbsp;<span class="builtintype" id="1470771">uintptr</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470780">stack</span>&nbsp;<span class="op" id="1470786">[</span><span class="ident" id="1470787">maxCPUProfStack</span><span class="op" id="1470802">]</span><span class="builtintype" id="1470803">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1470811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1470814">type</span>&nbsp;<span class="ident" id="1470819">cpuProfile</span>&nbsp;<span class="keyword" id="1470830">struct</span>&nbsp;<span class="op" id="1470837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470840">on</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1470847">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1470855">//&nbsp;profiling&nbsp;is&nbsp;on</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470875">wait</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1470882">note</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1470890">//&nbsp;goroutine&nbsp;waits&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470915">count</span>&nbsp;&nbsp;<span class="builtintype" id="1470922">uintptr</span>&nbsp;<span class="comment" id="1470930">//&nbsp;tick&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470945">evicts</span>&nbsp;<span class="builtintype" id="1470952">uintptr</span>&nbsp;<span class="comment" id="1470960">//&nbsp;eviction&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1470979">lost</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1470986">uintptr</span>&nbsp;<span class="comment" id="1470994">//&nbsp;lost&nbsp;ticks&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;logged</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471033">//&nbsp;Active&nbsp;recent&nbsp;stack&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471065">hash</span>&nbsp;<span class="op" id="1471070">[</span><span class="ident" id="1471071">numBuckets</span><span class="op" id="1471081">]</span><span class="keyword" id="1471082">struct</span>&nbsp;<span class="op" id="1471089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471093">entry</span>&nbsp;<span class="op" id="1471099">[</span><span class="ident" id="1471100">assoc</span><span class="op" id="1471105">]</span><span class="ident" id="1471106">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471124">//&nbsp;Log&nbsp;of&nbsp;traces&nbsp;evicted&nbsp;from&nbsp;hash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471161">//&nbsp;Signal&nbsp;handler&nbsp;has&nbsp;filled&nbsp;log[toggle][:nlog].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471211">//&nbsp;Goroutine&nbsp;is&nbsp;writing&nbsp;log[1-toggle][:handoff].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471261">log</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471269">[</span><span class="num" id="1471270">2</span><span class="op" id="1471271">]</span><span class="op" id="1471272">[</span><span class="ident" id="1471273">logSize</span>&nbsp;<span class="op" id="1471281">/</span>&nbsp;<span class="num" id="1471283">2</span><span class="op" id="1471284">]</span><span class="builtintype" id="1471285">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471294">nlog</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1471302">uintptr</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471311">toggle</span>&nbsp;&nbsp;<span class="builtintype" id="1471319">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471326">handoff</span>&nbsp;<span class="builtintype" id="1471334">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471343">//&nbsp;Writer&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471361">//&nbsp;Writer&nbsp;maintains&nbsp;its&nbsp;own&nbsp;toggle&nbsp;to&nbsp;avoid&nbsp;races</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1471412">//&nbsp;looking&nbsp;at&nbsp;signal&nbsp;handler&#39;s&nbsp;toggle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471452">wtoggle</span>&nbsp;&nbsp;<span class="builtintype" id="1471461">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471469">wholding</span>&nbsp;<span class="builtintype" id="1471478">bool</span>&nbsp;<span class="comment" id="1471483">//&nbsp;holding&nbsp;&amp;&nbsp;need&nbsp;to&nbsp;release&nbsp;a&nbsp;log&nbsp;half</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471524">flushing</span>&nbsp;<span class="builtintype" id="1471533">bool</span>&nbsp;<span class="comment" id="1471538">//&nbsp;flushing&nbsp;hash&nbsp;table&nbsp;-&nbsp;profile&nbsp;is&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471580">eodSent</span>&nbsp;&nbsp;<span class="builtintype" id="1471589">bool</span>&nbsp;<span class="comment" id="1471594">//&nbsp;special&nbsp;end-of-data&nbsp;record&nbsp;sent;&nbsp;=&gt;&nbsp;flushing</span><br>
<span class="lineno">95</span><span class="op" id="1471642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1471645">var</span>&nbsp;<span class="op" id="1471649">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471652">cpuprofLock</span>&nbsp;<span class="ident" id="1471664">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471671">cpuprof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1471683">*</span><span class="ident" id="1471684">cpuProfile</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471697">eod</span>&nbsp;<span class="op" id="1471701">=</span>&nbsp;<span class="op" id="1471703">[</span><span class="num" id="1471704">3</span><span class="op" id="1471705">]</span><span class="builtintype" id="1471706">uintptr</span><span class="op" id="1471713">{</span><span class="num" id="1471714">0</span><span class="op" id="1471715">,</span>&nbsp;<span class="num" id="1471717">1</span><span class="op" id="1471718">,</span>&nbsp;<span class="num" id="1471720">0</span><span class="op" id="1471721">}</span><br>
<span class="lineno"></span><span class="op" id="1471723">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1471726">func</span>&nbsp;<span class="ident" id="1471731">setcpuprofilerate_m</span><span class="op" id="1471750">(</span><span class="op" id="1471751">)</span>&nbsp;<span class="comment" id="1471753">//&nbsp;proc.c</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1471764">func</span>&nbsp;<span class="ident" id="1471769">setcpuprofilerate</span><span class="op" id="1471786">(</span><span class="ident" id="1471787">hz</span>&nbsp;<span class="builtintype" id="1471790">int32</span><span class="op" id="1471795">)</span>&nbsp;<span class="op" id="1471797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471800">g</span>&nbsp;<span class="op" id="1471802">:=</span>&nbsp;<span class="ident" id="1471805">getg</span><span class="op" id="1471809">(</span><span class="op" id="1471810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471813">g</span><span class="op" id="1471814">.</span><span class="ident" id="1471815">m</span><span class="op" id="1471816">.</span><span class="ident" id="1471817">scalararg</span><span class="op" id="1471826">[</span><span class="num" id="1471827">0</span><span class="op" id="1471828">]</span>&nbsp;<span class="op" id="1471830">=</span>&nbsp;<span class="builtintype" id="1471832">uintptr</span><span class="op" id="1471839">(</span><span class="ident" id="1471840">hz</span><span class="op" id="1471842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1471845">onM</span><span class="op" id="1471848">(</span><span class="ident" id="1471849">setcpuprofilerate_m</span><span class="op" id="1471868">)</span><br>
<span class="lineno">110</span><span class="op" id="1471870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1471873">//&nbsp;lostProfileData&nbsp;is&nbsp;a&nbsp;no-op&nbsp;function&nbsp;used&nbsp;in&nbsp;profiles</span><br>
<span class="lineno"></span><span class="comment" id="1471929">//&nbsp;to&nbsp;mark&nbsp;the&nbsp;number&nbsp;of&nbsp;profiling&nbsp;stack&nbsp;traces&nbsp;that&nbsp;were</span><br>
<span class="lineno"></span><span class="comment" id="1471987">//&nbsp;discarded&nbsp;due&nbsp;to&nbsp;slow&nbsp;data&nbsp;writers.</span><br>
<span class="lineno">115</span><span class="keyword" id="1472026">func</span>&nbsp;<span class="ident" id="1472031">lostProfileData</span><span class="op" id="1472046">(</span><span class="op" id="1472047">)</span>&nbsp;<span class="op" id="1472049">{</span><span class="op" id="1472050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1472053">//&nbsp;SetCPUProfileRate&nbsp;sets&nbsp;the&nbsp;CPU&nbsp;profiling&nbsp;rate&nbsp;to&nbsp;hz&nbsp;samples&nbsp;per&nbsp;second.</span><br>
<span class="lineno"></span><span class="comment" id="1472128">//&nbsp;If&nbsp;hz&nbsp;&lt;=&nbsp;0,&nbsp;SetCPUProfileRate&nbsp;turns&nbsp;off&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1472182">//&nbsp;If&nbsp;the&nbsp;profiler&nbsp;is&nbsp;on,&nbsp;the&nbsp;rate&nbsp;cannot&nbsp;be&nbsp;changed&nbsp;without&nbsp;first&nbsp;turning&nbsp;it&nbsp;off.</span><br>
<span class="lineno">120</span><span class="comment" id="1472265">//</span><br>
<span class="lineno"></span><span class="comment" id="1472268">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1472324">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1472390">//&nbsp;SetCPUProfileRate&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1472421">func</span>&nbsp;<span class="ident" id="1472426">SetCPUProfileRate</span><span class="op" id="1472443">(</span><span class="ident" id="1472444">hz</span>&nbsp;<span class="builtintype" id="1472447">int</span><span class="op" id="1472450">)</span>&nbsp;<span class="op" id="1472452">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1472455">//&nbsp;Clamp&nbsp;hz&nbsp;to&nbsp;something&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472493">if</span>&nbsp;<span class="ident" id="1472496">hz</span>&nbsp;<span class="op" id="1472499">&lt;</span>&nbsp;<span class="num" id="1472501">0</span>&nbsp;<span class="op" id="1472503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472507">hz</span>&nbsp;<span class="op" id="1472510">=</span>&nbsp;<span class="num" id="1472512">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472518">if</span>&nbsp;<span class="ident" id="1472521">hz</span>&nbsp;<span class="op" id="1472524">&gt;</span>&nbsp;<span class="num" id="1472526">1000000</span>&nbsp;<span class="op" id="1472534">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472538">hz</span>&nbsp;<span class="op" id="1472541">=</span>&nbsp;<span class="num" id="1472543">1000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472556">lock</span><span class="op" id="1472560">(</span><span class="op" id="1472561">&amp;</span><span class="ident" id="1472562">cpuprofLock</span><span class="op" id="1472573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472576">if</span>&nbsp;<span class="ident" id="1472579">hz</span>&nbsp;<span class="op" id="1472582">&gt;</span>&nbsp;<span class="num" id="1472584">0</span>&nbsp;<span class="op" id="1472586">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472590">if</span>&nbsp;<span class="ident" id="1472593">cpuprof</span>&nbsp;<span class="op" id="1472601">==</span>&nbsp;<span class="builtintype" id="1472604">nil</span>&nbsp;<span class="op" id="1472608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472613">cpuprof</span>&nbsp;<span class="op" id="1472621">=</span>&nbsp;<span class="op" id="1472623">(</span><span class="op" id="1472624">*</span><span class="ident" id="1472625">cpuProfile</span><span class="op" id="1472635">)</span><span class="op" id="1472636">(</span><span class="ident" id="1472637">sysAlloc</span><span class="op" id="1472645">(</span><span class="ident" id="1472646">unsafe</span><span class="op" id="1472652">.</span><span class="ident" id="1472653">Sizeof</span><span class="op" id="1472659">(</span><span class="ident" id="1472660">cpuProfile</span><span class="op" id="1472670">{</span><span class="op" id="1472671">}</span><span class="op" id="1472672">)</span><span class="op" id="1472673">,</span>&nbsp;<span class="op" id="1472675">&amp;</span><span class="ident" id="1472676">memstats</span><span class="op" id="1472684">.</span><span class="ident" id="1472685">other_sys</span><span class="op" id="1472694">)</span><span class="op" id="1472695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472700">if</span>&nbsp;<span class="ident" id="1472703">cpuprof</span>&nbsp;<span class="op" id="1472711">==</span>&nbsp;<span class="builtintype" id="1472714">nil</span>&nbsp;<span class="op" id="1472718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1472724">print</span><span class="op" id="1472729">(</span><span class="string" id="1472730">&#34;runtime:&nbsp;cpu&nbsp;profiling&nbsp;cannot&nbsp;allocate&nbsp;memory\n&#34;</span><span class="op" id="1472779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472785">unlock</span><span class="op" id="1472791">(</span><span class="op" id="1472792">&amp;</span><span class="ident" id="1472793">cpuprofLock</span><span class="op" id="1472804">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472810">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472828">if</span>&nbsp;<span class="ident" id="1472831">cpuprof</span><span class="op" id="1472838">.</span><span class="ident" id="1472839">on</span>&nbsp;<span class="op" id="1472842">||</span>&nbsp;<span class="ident" id="1472845">cpuprof</span><span class="op" id="1472852">.</span><span class="ident" id="1472853">handoff</span>&nbsp;<span class="op" id="1472861">!=</span>&nbsp;<span class="num" id="1472864">0</span>&nbsp;<span class="op" id="1472866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1472871">print</span><span class="op" id="1472876">(</span><span class="string" id="1472877">&#34;runtime:&nbsp;cannot&nbsp;set&nbsp;cpu&nbsp;profile&nbsp;rate&nbsp;until&nbsp;previous&nbsp;profile&nbsp;has&nbsp;finished.\n&#34;</span><span class="op" id="1472954">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472959">unlock</span><span class="op" id="1472965">(</span><span class="op" id="1472966">&amp;</span><span class="ident" id="1472967">cpuprofLock</span><span class="op" id="1472978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1472983">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1472992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1472997">cpuprof</span><span class="op" id="1473004">.</span><span class="ident" id="1473005">on</span>&nbsp;<span class="op" id="1473008">=</span>&nbsp;<span class="builtintype" id="1473010">true</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1473017">//&nbsp;pprof&nbsp;binary&nbsp;header&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1473050">//&nbsp;http://code.google.com/p/google-perftools/source/browse/trunk/src/profiledata.cc#117</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473140">p</span>&nbsp;<span class="op" id="1473142">:=</span>&nbsp;<span class="op" id="1473145">&amp;</span><span class="ident" id="1473146">cpuprof</span><span class="op" id="1473153">.</span><span class="ident" id="1473154">log</span><span class="op" id="1473157">[</span><span class="num" id="1473158">0</span><span class="op" id="1473159">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473163">p</span><span class="op" id="1473164">[</span><span class="num" id="1473165">0</span><span class="op" id="1473166">]</span>&nbsp;<span class="op" id="1473168">=</span>&nbsp;<span class="num" id="1473170">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1473188">//&nbsp;count&nbsp;for&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473210">p</span><span class="op" id="1473211">[</span><span class="num" id="1473212">1</span><span class="op" id="1473213">]</span>&nbsp;<span class="op" id="1473215">=</span>&nbsp;<span class="num" id="1473217">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1473235">//&nbsp;depth&nbsp;for&nbsp;header</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473257">p</span><span class="op" id="1473258">[</span><span class="num" id="1473259">2</span><span class="op" id="1473260">]</span>&nbsp;<span class="op" id="1473262">=</span>&nbsp;<span class="num" id="1473264">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1473282">//&nbsp;version&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473302">p</span><span class="op" id="1473303">[</span><span class="num" id="1473304">3</span><span class="op" id="1473305">]</span>&nbsp;<span class="op" id="1473307">=</span>&nbsp;<span class="builtintype" id="1473309">uintptr</span><span class="op" id="1473316">(</span><span class="num" id="1473317">1e6</span>&nbsp;<span class="op" id="1473321">/</span>&nbsp;<span class="ident" id="1473323">hz</span><span class="op" id="1473325">)</span>&nbsp;<span class="comment" id="1473327">//&nbsp;period&nbsp;(microseconds)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473354">p</span><span class="op" id="1473355">[</span><span class="num" id="1473356">4</span><span class="op" id="1473357">]</span>&nbsp;<span class="op" id="1473359">=</span>&nbsp;<span class="num" id="1473361">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473365">cpuprof</span><span class="op" id="1473372">.</span><span class="ident" id="1473373">nlog</span>&nbsp;<span class="op" id="1473378">=</span>&nbsp;<span class="num" id="1473380">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473384">cpuprof</span><span class="op" id="1473391">.</span><span class="ident" id="1473392">toggle</span>&nbsp;<span class="op" id="1473399">=</span>&nbsp;<span class="num" id="1473401">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473405">cpuprof</span><span class="op" id="1473412">.</span><span class="ident" id="1473413">wholding</span>&nbsp;<span class="op" id="1473422">=</span>&nbsp;<span class="builtintype" id="1473424">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473432">cpuprof</span><span class="op" id="1473439">.</span><span class="ident" id="1473440">wtoggle</span>&nbsp;<span class="op" id="1473448">=</span>&nbsp;<span class="num" id="1473450">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473454">cpuprof</span><span class="op" id="1473461">.</span><span class="ident" id="1473462">flushing</span>&nbsp;<span class="op" id="1473471">=</span>&nbsp;<span class="builtintype" id="1473473">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473481">cpuprof</span><span class="op" id="1473488">.</span><span class="ident" id="1473489">eodSent</span>&nbsp;<span class="op" id="1473497">=</span>&nbsp;<span class="builtintype" id="1473499">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473507">noteclear</span><span class="op" id="1473516">(</span><span class="op" id="1473517">&amp;</span><span class="ident" id="1473518">cpuprof</span><span class="op" id="1473525">.</span><span class="ident" id="1473526">wait</span><span class="op" id="1473530">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473535">setcpuprofilerate</span><span class="op" id="1473552">(</span><span class="builtintype" id="1473553">int32</span><span class="op" id="1473558">(</span><span class="ident" id="1473559">hz</span><span class="op" id="1473561">)</span><span class="op" id="1473562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473565">}</span>&nbsp;<span class="keyword" id="1473567">else</span>&nbsp;<span class="keyword" id="1473572">if</span>&nbsp;<span class="ident" id="1473575">cpuprof</span>&nbsp;<span class="op" id="1473583">!=</span>&nbsp;<span class="builtintype" id="1473586">nil</span>&nbsp;<span class="op" id="1473590">&amp;&amp;</span>&nbsp;<span class="ident" id="1473593">cpuprof</span><span class="op" id="1473600">.</span><span class="ident" id="1473601">on</span>&nbsp;<span class="op" id="1473604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473608">setcpuprofilerate</span><span class="op" id="1473625">(</span><span class="num" id="1473626">0</span><span class="op" id="1473627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473631">cpuprof</span><span class="op" id="1473638">.</span><span class="ident" id="1473639">on</span>&nbsp;<span class="op" id="1473642">=</span>&nbsp;<span class="builtintype" id="1473644">false</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1473653">//&nbsp;Now&nbsp;add&nbsp;is&nbsp;not&nbsp;running&nbsp;anymore,&nbsp;and&nbsp;getprofile&nbsp;owns&nbsp;the&nbsp;entire&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1473726">//&nbsp;Set&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;prof-&gt;handoff&nbsp;to&nbsp;tell&nbsp;getprofile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1473785">for</span>&nbsp;<span class="op" id="1473789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1473794">n</span>&nbsp;<span class="op" id="1473796">:=</span>&nbsp;<span class="ident" id="1473799">cpuprof</span><span class="op" id="1473806">.</span><span class="ident" id="1473807">handoff</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1473818">if</span>&nbsp;<span class="ident" id="1473821">n</span><span class="op" id="1473822">&amp;</span><span class="num" id="1473823">0x80000000</span>&nbsp;<span class="op" id="1473834">!=</span>&nbsp;<span class="num" id="1473837">0</span>&nbsp;<span class="op" id="1473839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1473845">print</span><span class="op" id="1473850">(</span><span class="string" id="1473851">&#34;runtime:&nbsp;setcpuprofile(off)&nbsp;twice\n&#34;</span><span class="op" id="1473888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1473893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1473898">if</span>&nbsp;<span class="ident" id="1473901">cas</span><span class="op" id="1473904">(</span><span class="op" id="1473905">&amp;</span><span class="ident" id="1473906">cpuprof</span><span class="op" id="1473913">.</span><span class="ident" id="1473914">handoff</span><span class="op" id="1473921">,</span>&nbsp;<span class="ident" id="1473923">n</span><span class="op" id="1473924">,</span>&nbsp;<span class="ident" id="1473926">n</span><span class="op" id="1473927">|</span><span class="num" id="1473928">0x80000000</span><span class="op" id="1473938">)</span>&nbsp;<span class="op" id="1473940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1473946">if</span>&nbsp;<span class="ident" id="1473949">n</span>&nbsp;<span class="op" id="1473951">==</span>&nbsp;<span class="num" id="1473954">0</span>&nbsp;<span class="op" id="1473956">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1473963">//&nbsp;we&nbsp;did&nbsp;the&nbsp;transition&nbsp;from&nbsp;0&nbsp;-&gt;&nbsp;nonzero&nbsp;so&nbsp;we&nbsp;wake&nbsp;getprofile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474033">notewakeup</span><span class="op" id="1474043">(</span><span class="op" id="1474044">&amp;</span><span class="ident" id="1474045">cpuprof</span><span class="op" id="1474052">.</span><span class="ident" id="1474053">wait</span><span class="op" id="1474057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1474063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474069">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1474078">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1474082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1474085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474088">unlock</span><span class="op" id="1474094">(</span><span class="op" id="1474095">&amp;</span><span class="ident" id="1474096">cpuprofLock</span><span class="op" id="1474107">)</span><br>
<span class="lineno"></span><span class="op" id="1474109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="keyword" id="1474112">func</span>&nbsp;<span class="ident" id="1474117">cpuproftick</span><span class="op" id="1474128">(</span><span class="ident" id="1474129">pc</span>&nbsp;<span class="op" id="1474132">*</span><span class="builtintype" id="1474133">uintptr</span><span class="op" id="1474140">,</span>&nbsp;<span class="ident" id="1474142">n</span>&nbsp;<span class="builtintype" id="1474144">int32</span><span class="op" id="1474149">)</span>&nbsp;<span class="op" id="1474151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474154">if</span>&nbsp;<span class="ident" id="1474157">n</span>&nbsp;<span class="op" id="1474159">&gt;</span>&nbsp;<span class="ident" id="1474161">maxCPUProfStack</span>&nbsp;<span class="op" id="1474177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474181">n</span>&nbsp;<span class="op" id="1474183">=</span>&nbsp;<span class="ident" id="1474185">maxCPUProfStack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1474202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474205">s</span>&nbsp;<span class="op" id="1474207">:=</span>&nbsp;<span class="op" id="1474210">(</span><span class="op" id="1474211">*</span><span class="op" id="1474212">[</span><span class="ident" id="1474213">maxCPUProfStack</span><span class="op" id="1474228">]</span><span class="builtintype" id="1474229">uintptr</span><span class="op" id="1474236">)</span><span class="op" id="1474237">(</span><span class="ident" id="1474238">unsafe</span><span class="op" id="1474244">.</span><span class="ident" id="1474245">Pointer</span><span class="op" id="1474252">(</span><span class="ident" id="1474253">pc</span><span class="op" id="1474255">)</span><span class="op" id="1474256">)</span><span class="op" id="1474257">[</span><span class="op" id="1474258">:</span><span class="ident" id="1474259">n</span><span class="op" id="1474260">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474263">cpuprof</span><span class="op" id="1474270">.</span><span class="ident" id="1474271">add</span><span class="op" id="1474274">(</span><span class="ident" id="1474275">s</span><span class="op" id="1474276">)</span><br>
<span class="lineno"></span><span class="op" id="1474278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1474281">//&nbsp;add&nbsp;adds&nbsp;the&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1474325">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;other&nbsp;limited&nbsp;environments</span><br>
<span class="lineno">200</span><span class="comment" id="1474393">//&nbsp;and&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;acquire&nbsp;locks&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1474454">//&nbsp;held&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;signal,&nbsp;nor&nbsp;can&nbsp;it&nbsp;use&nbsp;substantial&nbsp;amounts</span><br>
<span class="lineno"></span><span class="comment" id="1474524">//&nbsp;of&nbsp;stack.&nbsp;&nbsp;It&nbsp;is&nbsp;allowed&nbsp;to&nbsp;call&nbsp;evict.</span><br>
<span class="lineno"></span><span class="keyword" id="1474567">func</span>&nbsp;<span class="op" id="1474572">(</span><span class="ident" id="1474573">p</span>&nbsp;<span class="op" id="1474575">*</span><span class="ident" id="1474576">cpuProfile</span><span class="op" id="1474586">)</span>&nbsp;<span class="ident" id="1474588">add</span><span class="op" id="1474591">(</span><span class="ident" id="1474592">pc</span>&nbsp;<span class="op" id="1474595">[</span><span class="op" id="1474596">]</span><span class="builtintype" id="1474597">uintptr</span><span class="op" id="1474604">)</span>&nbsp;<span class="op" id="1474606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1474609">//&nbsp;Compute&nbsp;hash.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474627">h</span>&nbsp;<span class="op" id="1474629">:=</span>&nbsp;<span class="builtintype" id="1474632">uintptr</span><span class="op" id="1474639">(</span><span class="num" id="1474640">0</span><span class="op" id="1474641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474644">for</span>&nbsp;<span class="ident" id="1474648">_</span><span class="op" id="1474649">,</span>&nbsp;<span class="ident" id="1474651">x</span>&nbsp;<span class="op" id="1474653">:=</span>&nbsp;<span class="keyword" id="1474656">range</span>&nbsp;<span class="ident" id="1474662">pc</span>&nbsp;<span class="op" id="1474665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474669">h</span>&nbsp;<span class="op" id="1474671">=</span>&nbsp;<span class="ident" id="1474673">h</span><span class="op" id="1474674">&lt;&lt;</span><span class="num" id="1474676">8</span>&nbsp;<span class="op" id="1474678">|</span>&nbsp;<span class="op" id="1474680">(</span><span class="ident" id="1474681">h</span>&nbsp;<span class="op" id="1474683">&gt;&gt;</span>&nbsp;<span class="op" id="1474686">(</span><span class="num" id="1474687">8</span>&nbsp;<span class="op" id="1474689">*</span>&nbsp;<span class="op" id="1474691">(</span><span class="ident" id="1474692">unsafe</span><span class="op" id="1474698">.</span><span class="ident" id="1474699">Sizeof</span><span class="op" id="1474705">(</span><span class="ident" id="1474706">h</span><span class="op" id="1474707">)</span>&nbsp;<span class="op" id="1474709">-</span>&nbsp;<span class="num" id="1474711">1</span><span class="op" id="1474712">)</span><span class="op" id="1474713">)</span><span class="op" id="1474714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474718">h</span>&nbsp;<span class="op" id="1474720">+=</span>&nbsp;<span class="ident" id="1474723">x</span><span class="op" id="1474724">*</span><span class="num" id="1474725">31</span>&nbsp;<span class="op" id="1474728">+</span>&nbsp;<span class="ident" id="1474730">x</span><span class="op" id="1474731">*</span><span class="num" id="1474732">7</span>&nbsp;<span class="op" id="1474734">+</span>&nbsp;<span class="ident" id="1474736">x</span><span class="op" id="1474737">*</span><span class="num" id="1474738">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1474741">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474744">p</span><span class="op" id="1474745">.</span><span class="ident" id="1474746">count</span><span class="op" id="1474751">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1474756">//&nbsp;Add&nbsp;to&nbsp;entry&nbsp;count&nbsp;if&nbsp;already&nbsp;present&nbsp;in&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474808">b</span>&nbsp;<span class="op" id="1474810">:=</span>&nbsp;<span class="op" id="1474813">&amp;</span><span class="ident" id="1474814">p</span><span class="op" id="1474815">.</span><span class="ident" id="1474816">hash</span><span class="op" id="1474820">[</span><span class="ident" id="1474821">h</span><span class="op" id="1474822">%</span><span class="ident" id="1474823">numBuckets</span><span class="op" id="1474833">]</span><br>
<span class="lineno"></span><span class="ident" id="1474835">Assoc</span><span class="op" id="1474840">:</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474843">for</span>&nbsp;<span class="ident" id="1474847">i</span>&nbsp;<span class="op" id="1474849">:=</span>&nbsp;<span class="keyword" id="1474852">range</span>&nbsp;<span class="ident" id="1474858">b</span><span class="op" id="1474859">.</span><span class="ident" id="1474860">entry</span>&nbsp;<span class="op" id="1474866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1474870">e</span>&nbsp;<span class="op" id="1474872">:=</span>&nbsp;<span class="op" id="1474875">&amp;</span><span class="ident" id="1474876">b</span><span class="op" id="1474877">.</span><span class="ident" id="1474878">entry</span><span class="op" id="1474883">[</span><span class="ident" id="1474884">i</span><span class="op" id="1474885">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474889">if</span>&nbsp;<span class="ident" id="1474892">e</span><span class="op" id="1474893">.</span><span class="ident" id="1474894">depth</span>&nbsp;<span class="op" id="1474900">!=</span>&nbsp;<span class="builtintype" id="1474903">uintptr</span><span class="op" id="1474910">(</span><span class="builtinfunc" id="1474911">len</span><span class="op" id="1474914">(</span><span class="ident" id="1474915">pc</span><span class="op" id="1474917">)</span><span class="op" id="1474918">)</span>&nbsp;<span class="op" id="1474920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474925">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1474936">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474940">for</span>&nbsp;<span class="ident" id="1474944">j</span>&nbsp;<span class="op" id="1474946">:=</span>&nbsp;<span class="keyword" id="1474949">range</span>&nbsp;<span class="ident" id="1474955">pc</span>&nbsp;<span class="op" id="1474958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474963">if</span>&nbsp;<span class="ident" id="1474966">e</span><span class="op" id="1474967">.</span><span class="ident" id="1474968">stack</span><span class="op" id="1474973">[</span><span class="ident" id="1474974">j</span><span class="op" id="1474975">]</span>&nbsp;<span class="op" id="1474977">!=</span>&nbsp;<span class="ident" id="1474980">pc</span><span class="op" id="1474982">[</span><span class="ident" id="1474983">j</span><span class="op" id="1474984">]</span>&nbsp;<span class="op" id="1474986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1474992">continue</span>&nbsp;<span class="ident" id="1475001">Assoc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1475010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1475014">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1475018">e</span><span class="op" id="1475019">.</span><span class="ident" id="1475020">count</span><span class="op" id="1475025">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1475030">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1475038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1475042">//&nbsp;Evict&nbsp;entry&nbsp;with&nbsp;smallest&nbsp;count.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1475079">var</span>&nbsp;<span class="ident" id="1475083">e</span>&nbsp;<span class="op" id="1475085">*</span><span class="ident" id="1475086">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1475100">for</span>&nbsp;<span class="ident" id="1475104">i</span>&nbsp;<span class="op" id="1475106">:=</span>&nbsp;<span class="keyword" id="1475109">range</span>&nbsp;<span class="ident" id="1475115">b</span><span class="op" id="1475116">.</span><span class="ident" id="1475117">entry</span>&nbsp;<span class="op" id="1475123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1475127">if</span>&nbsp;<span class="ident" id="1475130">e</span>&nbsp;<span class="op" id="1475132">==</span>&nbsp;<span class="builtintype" id="1475135">nil</span>&nbsp;<span class="op" id="1475139">||</span>&nbsp;<span class="ident" id="1475142">b</span><span class="op" id="1475143">.</span><span class="ident" id="1475144">entry</span><span class="op" id="1475149">[</span><span class="ident" id="1475150">i</span><span class="op" id="1475151">]</span><span class="op" id="1475152">.</span><span class="ident" id="1475153">count</span>&nbsp;<span class="op" id="1475159">&lt;</span>&nbsp;<span class="ident" id="1475161">e</span><span class="op" id="1475162">.</span><span class="ident" id="1475163">count</span>&nbsp;<span class="op" id="1475169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1475174">e</span>&nbsp;<span class="op" id="1475176">=</span>&nbsp;<span class="op" id="1475178">&amp;</span><span class="ident" id="1475179">b</span><span class="op" id="1475180">.</span><span class="ident" id="1475181">entry</span><span class="op" id="1475186">[</span><span class="ident" id="1475187">i</span><span class="op" id="1475188">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1475192">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1475195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1475198">if</span>&nbsp;<span class="ident" id="1475201">e</span><span class="op" id="1475202">.</span><span class="ident" id="1475203">count</span>&nbsp;<span class="op" id="1475209">&gt;</span>&nbsp;<span class="num" id="1475211">0</span>&nbsp;<span class="op" id="1475213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1475217">if</span>&nbsp;<span class="op" id="1475220">!</span><span class="ident" id="1475221">p</span><span class="op" id="1475222">.</span><span class="ident" id="1475223">evict</span><span class="op" id="1475228">(</span><span class="ident" id="1475229">e</span><span class="op" id="1475230">)</span>&nbsp;<span class="op" id="1475232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1475237">//&nbsp;Could&nbsp;not&nbsp;evict&nbsp;entry.&nbsp;&nbsp;Record&nbsp;lost&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1475286">p</span><span class="op" id="1475287">.</span><span class="ident" id="1475288">lost</span><span class="op" id="1475292">++</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1475298">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1475307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1475311">p</span><span class="op" id="1475312">.</span><span class="ident" id="1475313">evicts</span><span class="op" id="1475319">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1475323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1475327">//&nbsp;Reuse&nbsp;the&nbsp;newly&nbsp;evicted&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1475362">e</span><span class="op" id="1475363">.</span><span class="ident" id="1475364">depth</span>&nbsp;<span class="op" id="1475370">=</span>&nbsp;<span class="builtintype" id="1475372">uintptr</span><span class="op" id="1475379">(</span><span class="builtinfunc" id="1475380">len</span><span class="op" id="1475383">(</span><span class="ident" id="1475384">pc</span><span class="op" id="1475386">)</span><span class="op" id="1475387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1475390">e</span><span class="op" id="1475391">.</span><span class="ident" id="1475392">count</span>&nbsp;<span class="op" id="1475398">=</span>&nbsp;<span class="num" id="1475400">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1475403">copy</span><span class="op" id="1475407">(</span><span class="ident" id="1475408">e</span><span class="op" id="1475409">.</span><span class="ident" id="1475410">stack</span><span class="op" id="1475415">[</span><span class="op" id="1475416">:</span><span class="op" id="1475417">]</span><span class="op" id="1475418">,</span>&nbsp;<span class="ident" id="1475420">pc</span><span class="op" id="1475422">)</span><br>
<span class="lineno"></span><span class="op" id="1475424">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="1475427">//&nbsp;evict&nbsp;copies&nbsp;the&nbsp;given&nbsp;entry&#39;s&nbsp;data&nbsp;into&nbsp;the&nbsp;log,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1475488">//&nbsp;the&nbsp;entry&nbsp;can&nbsp;be&nbsp;reused.&nbsp;&nbsp;evict&nbsp;is&nbsp;called&nbsp;from&nbsp;add,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1475549">//&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;profiling&nbsp;signal&nbsp;handler,&nbsp;so&nbsp;it&nbsp;must&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1475612">//&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;flushlog.</span><br>
<span class="lineno">255</span><span class="comment" id="1475671">//&nbsp;evict&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;entry&nbsp;was&nbsp;copied&nbsp;to&nbsp;the&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1475729">//&nbsp;false&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;room&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1475770">func</span>&nbsp;<span class="op" id="1475775">(</span><span class="ident" id="1475776">p</span>&nbsp;<span class="op" id="1475778">*</span><span class="ident" id="1475779">cpuProfile</span><span class="op" id="1475789">)</span>&nbsp;<span class="ident" id="1475791">evict</span><span class="op" id="1475796">(</span><span class="ident" id="1475797">e</span>&nbsp;<span class="op" id="1475799">*</span><span class="ident" id="1475800">cpuprofEntry</span><span class="op" id="1475812">)</span>&nbsp;<span class="builtintype" id="1475814">bool</span>&nbsp;<span class="op" id="1475819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1475822">d</span>&nbsp;<span class="op" id="1475824">:=</span>&nbsp;<span class="ident" id="1475827">e</span><span class="op" id="1475828">.</span><span class="ident" id="1475829">depth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1475836">nslot</span>&nbsp;<span class="op" id="1475842">:=</span>&nbsp;<span class="ident" id="1475845">d</span>&nbsp;<span class="op" id="1475847">+</span>&nbsp;<span class="num" id="1475849">2</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1475852">log</span>&nbsp;<span class="op" id="1475856">:=</span>&nbsp;<span class="op" id="1475859">&amp;</span><span class="ident" id="1475860">p</span><span class="op" id="1475861">.</span><span class="ident" id="1475862">log</span><span class="op" id="1475865">[</span><span class="ident" id="1475866">p</span><span class="op" id="1475867">.</span><span class="ident" id="1475868">toggle</span><span class="op" id="1475874">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1475877">if</span>&nbsp;<span class="ident" id="1475880">p</span><span class="op" id="1475881">.</span><span class="ident" id="1475882">nlog</span><span class="op" id="1475886">+</span><span class="ident" id="1475887">nslot</span>&nbsp;<span class="op" id="1475893">&gt;</span>&nbsp;<span class="builtintype" id="1475895">uintptr</span><span class="op" id="1475902">(</span><span class="builtinfunc" id="1475903">len</span><span class="op" id="1475906">(</span><span class="ident" id="1475907">p</span><span class="op" id="1475908">.</span><span class="ident" id="1475909">log</span><span class="op" id="1475912">[</span><span class="num" id="1475913">0</span><span class="op" id="1475914">]</span><span class="op" id="1475915">)</span><span class="op" id="1475916">)</span>&nbsp;<span class="op" id="1475918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1475922">if</span>&nbsp;<span class="op" id="1475925">!</span><span class="ident" id="1475926">p</span><span class="op" id="1475927">.</span><span class="ident" id="1475928">flushlog</span><span class="op" id="1475936">(</span><span class="op" id="1475937">)</span>&nbsp;<span class="op" id="1475939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1475944">return</span>&nbsp;<span class="builtintype" id="1475951">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1475959">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1475963">log</span>&nbsp;<span class="op" id="1475967">=</span>&nbsp;<span class="op" id="1475969">&amp;</span><span class="ident" id="1475970">p</span><span class="op" id="1475971">.</span><span class="ident" id="1475972">log</span><span class="op" id="1475975">[</span><span class="ident" id="1475976">p</span><span class="op" id="1475977">.</span><span class="ident" id="1475978">toggle</span><span class="op" id="1475984">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1475987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1475991">q</span>&nbsp;<span class="op" id="1475993">:=</span>&nbsp;<span class="ident" id="1475996">p</span><span class="op" id="1475997">.</span><span class="ident" id="1475998">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476004">log</span><span class="op" id="1476007">[</span><span class="ident" id="1476008">q</span><span class="op" id="1476009">]</span>&nbsp;<span class="op" id="1476011">=</span>&nbsp;<span class="ident" id="1476013">e</span><span class="op" id="1476014">.</span><span class="ident" id="1476015">count</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476022">q</span><span class="op" id="1476023">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476027">log</span><span class="op" id="1476030">[</span><span class="ident" id="1476031">q</span><span class="op" id="1476032">]</span>&nbsp;<span class="op" id="1476034">=</span>&nbsp;<span class="ident" id="1476036">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476039">q</span><span class="op" id="1476040">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1476044">copy</span><span class="op" id="1476048">(</span><span class="ident" id="1476049">log</span><span class="op" id="1476052">[</span><span class="ident" id="1476053">q</span><span class="op" id="1476054">:</span><span class="op" id="1476055">]</span><span class="op" id="1476056">,</span>&nbsp;<span class="ident" id="1476058">e</span><span class="op" id="1476059">.</span><span class="ident" id="1476060">stack</span><span class="op" id="1476065">[</span><span class="op" id="1476066">:</span><span class="ident" id="1476067">d</span><span class="op" id="1476068">]</span><span class="op" id="1476069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476072">q</span>&nbsp;<span class="op" id="1476074">+=</span>&nbsp;<span class="ident" id="1476077">d</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476080">p</span><span class="op" id="1476081">.</span><span class="ident" id="1476082">nlog</span>&nbsp;<span class="op" id="1476087">=</span>&nbsp;<span class="ident" id="1476089">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476092">e</span><span class="op" id="1476093">.</span><span class="ident" id="1476094">count</span>&nbsp;<span class="op" id="1476100">=</span>&nbsp;<span class="num" id="1476102">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1476105">return</span>&nbsp;<span class="builtintype" id="1476112">true</span><br>
<span class="lineno"></span><span class="op" id="1476117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1476120">//&nbsp;flushlog&nbsp;tries&nbsp;to&nbsp;flush&nbsp;the&nbsp;current&nbsp;log&nbsp;and&nbsp;switch&nbsp;to&nbsp;the&nbsp;other&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1476192">//&nbsp;flushlog&nbsp;is&nbsp;called&nbsp;from&nbsp;evict,&nbsp;called&nbsp;from&nbsp;add,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler,</span><br>
<span class="lineno"></span><span class="comment" id="1476275">//&nbsp;so&nbsp;it&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;can&nbsp;try&nbsp;to&nbsp;swap&nbsp;logs&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1476347">//&nbsp;the&nbsp;writing&nbsp;goroutine,&nbsp;as&nbsp;explained&nbsp;in&nbsp;the&nbsp;comment&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;this&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="1476426">func</span>&nbsp;<span class="op" id="1476431">(</span><span class="ident" id="1476432">p</span>&nbsp;<span class="op" id="1476434">*</span><span class="ident" id="1476435">cpuProfile</span><span class="op" id="1476445">)</span>&nbsp;<span class="ident" id="1476447">flushlog</span><span class="op" id="1476455">(</span><span class="op" id="1476456">)</span>&nbsp;<span class="builtintype" id="1476458">bool</span>&nbsp;<span class="op" id="1476463">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1476466">if</span>&nbsp;<span class="op" id="1476469">!</span><span class="ident" id="1476470">cas</span><span class="op" id="1476473">(</span><span class="op" id="1476474">&amp;</span><span class="ident" id="1476475">p</span><span class="op" id="1476476">.</span><span class="ident" id="1476477">handoff</span><span class="op" id="1476484">,</span>&nbsp;<span class="num" id="1476486">0</span><span class="op" id="1476487">,</span>&nbsp;<span class="builtintype" id="1476489">uint32</span><span class="op" id="1476495">(</span><span class="ident" id="1476496">p</span><span class="op" id="1476497">.</span><span class="ident" id="1476498">nlog</span><span class="op" id="1476502">)</span><span class="op" id="1476503">)</span>&nbsp;<span class="op" id="1476505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1476509">return</span>&nbsp;<span class="builtintype" id="1476516">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1476523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476526">notewakeup</span><span class="op" id="1476536">(</span><span class="op" id="1476537">&amp;</span><span class="ident" id="1476538">p</span><span class="op" id="1476539">.</span><span class="ident" id="1476540">wait</span><span class="op" id="1476544">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476548">p</span><span class="op" id="1476549">.</span><span class="ident" id="1476550">toggle</span>&nbsp;<span class="op" id="1476557">=</span>&nbsp;<span class="num" id="1476559">1</span>&nbsp;<span class="op" id="1476561">-</span>&nbsp;<span class="ident" id="1476563">p</span><span class="op" id="1476564">.</span><span class="ident" id="1476565">toggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476573">log</span>&nbsp;<span class="op" id="1476577">:=</span>&nbsp;<span class="op" id="1476580">&amp;</span><span class="ident" id="1476581">p</span><span class="op" id="1476582">.</span><span class="ident" id="1476583">log</span><span class="op" id="1476586">[</span><span class="ident" id="1476587">p</span><span class="op" id="1476588">.</span><span class="ident" id="1476589">toggle</span><span class="op" id="1476595">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476598">q</span>&nbsp;<span class="op" id="1476600">:=</span>&nbsp;<span class="builtintype" id="1476603">uintptr</span><span class="op" id="1476610">(</span><span class="num" id="1476611">0</span><span class="op" id="1476612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1476615">if</span>&nbsp;<span class="ident" id="1476618">p</span><span class="op" id="1476619">.</span><span class="ident" id="1476620">lost</span>&nbsp;<span class="op" id="1476625">&gt;</span>&nbsp;<span class="num" id="1476627">0</span>&nbsp;<span class="op" id="1476629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476633">lostPC</span>&nbsp;<span class="op" id="1476640">:=</span>&nbsp;<span class="ident" id="1476643">funcPC</span><span class="op" id="1476649">(</span><span class="ident" id="1476650">lostProfileData</span><span class="op" id="1476665">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476669">log</span><span class="op" id="1476672">[</span><span class="num" id="1476673">0</span><span class="op" id="1476674">]</span>&nbsp;<span class="op" id="1476676">=</span>&nbsp;<span class="ident" id="1476678">p</span><span class="op" id="1476679">.</span><span class="ident" id="1476680">lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476687">log</span><span class="op" id="1476690">[</span><span class="num" id="1476691">1</span><span class="op" id="1476692">]</span>&nbsp;<span class="op" id="1476694">=</span>&nbsp;<span class="num" id="1476696">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476700">log</span><span class="op" id="1476703">[</span><span class="num" id="1476704">2</span><span class="op" id="1476705">]</span>&nbsp;<span class="op" id="1476707">=</span>&nbsp;<span class="ident" id="1476709">lostPC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476718">q</span>&nbsp;<span class="op" id="1476720">=</span>&nbsp;<span class="num" id="1476722">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476726">p</span><span class="op" id="1476727">.</span><span class="ident" id="1476728">lost</span>&nbsp;<span class="op" id="1476733">=</span>&nbsp;<span class="num" id="1476735">0</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1476738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1476741">p</span><span class="op" id="1476742">.</span><span class="ident" id="1476743">nlog</span>&nbsp;<span class="op" id="1476748">=</span>&nbsp;<span class="ident" id="1476750">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1476753">return</span>&nbsp;<span class="builtintype" id="1476760">true</span><br>
<span class="lineno"></span><span class="op" id="1476765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="comment" id="1476768">//&nbsp;getprofile&nbsp;blocks&nbsp;until&nbsp;the&nbsp;next&nbsp;block&nbsp;of&nbsp;profiling&nbsp;data&nbsp;is&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="1476841">//&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;[]byte.&nbsp;&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;writing&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1476914">func</span>&nbsp;<span class="op" id="1476919">(</span><span class="ident" id="1476920">p</span>&nbsp;<span class="op" id="1476922">*</span><span class="ident" id="1476923">cpuProfile</span><span class="op" id="1476933">)</span>&nbsp;<span class="ident" id="1476935">getprofile</span><span class="op" id="1476945">(</span><span class="op" id="1476946">)</span>&nbsp;<span class="op" id="1476948">[</span><span class="op" id="1476949">]</span><span class="builtintype" id="1476950">byte</span>&nbsp;<span class="op" id="1476955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1476958">if</span>&nbsp;<span class="ident" id="1476961">p</span>&nbsp;<span class="op" id="1476963">==</span>&nbsp;<span class="builtintype" id="1476966">nil</span>&nbsp;<span class="op" id="1476970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1476974">return</span>&nbsp;<span class="builtintype" id="1476981">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1476986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1476990">if</span>&nbsp;<span class="ident" id="1476993">p</span><span class="op" id="1476994">.</span><span class="ident" id="1476995">wholding</span>&nbsp;<span class="op" id="1477004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1477008">//&nbsp;Release&nbsp;previous&nbsp;log&nbsp;to&nbsp;signal&nbsp;handling&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1477059">//&nbsp;Loop&nbsp;because&nbsp;we&nbsp;are&nbsp;racing&nbsp;against&nbsp;SetCPUProfileRate(0).</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477121">for</span>&nbsp;<span class="op" id="1477125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477130">n</span>&nbsp;<span class="op" id="1477132">:=</span>&nbsp;<span class="ident" id="1477135">p</span><span class="op" id="1477136">.</span><span class="ident" id="1477137">handoff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477148">if</span>&nbsp;<span class="ident" id="1477151">n</span>&nbsp;<span class="op" id="1477153">==</span>&nbsp;<span class="num" id="1477156">0</span>&nbsp;<span class="op" id="1477158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1477164">print</span><span class="op" id="1477169">(</span><span class="string" id="1477170">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;handoff\n&#34;</span><span class="op" id="1477221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477227">return</span>&nbsp;<span class="builtintype" id="1477234">nil</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1477241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477246">if</span>&nbsp;<span class="ident" id="1477249">n</span><span class="op" id="1477250">&amp;</span><span class="num" id="1477251">0x80000000</span>&nbsp;<span class="op" id="1477262">!=</span>&nbsp;<span class="num" id="1477265">0</span>&nbsp;<span class="op" id="1477267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477273">p</span><span class="op" id="1477274">.</span><span class="ident" id="1477275">wtoggle</span>&nbsp;<span class="op" id="1477283">=</span>&nbsp;<span class="num" id="1477285">1</span>&nbsp;<span class="op" id="1477287">-</span>&nbsp;<span class="ident" id="1477289">p</span><span class="op" id="1477290">.</span><span class="ident" id="1477291">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477303">p</span><span class="op" id="1477304">.</span><span class="ident" id="1477305">wholding</span>&nbsp;<span class="op" id="1477314">=</span>&nbsp;<span class="builtintype" id="1477316">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477326">p</span><span class="op" id="1477327">.</span><span class="ident" id="1477328">flushing</span>&nbsp;<span class="op" id="1477337">=</span>&nbsp;<span class="builtintype" id="1477339">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477348">goto</span>&nbsp;<span class="ident" id="1477353">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1477362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477367">if</span>&nbsp;<span class="ident" id="1477370">cas</span><span class="op" id="1477373">(</span><span class="op" id="1477374">&amp;</span><span class="ident" id="1477375">p</span><span class="op" id="1477376">.</span><span class="ident" id="1477377">handoff</span><span class="op" id="1477384">,</span>&nbsp;<span class="ident" id="1477386">n</span><span class="op" id="1477387">,</span>&nbsp;<span class="num" id="1477389">0</span><span class="op" id="1477390">)</span>&nbsp;<span class="op" id="1477392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477398">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1477407">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1477411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477415">p</span><span class="op" id="1477416">.</span><span class="ident" id="1477417">wtoggle</span>&nbsp;<span class="op" id="1477425">=</span>&nbsp;<span class="num" id="1477427">1</span>&nbsp;<span class="op" id="1477429">-</span>&nbsp;<span class="ident" id="1477431">p</span><span class="op" id="1477432">.</span><span class="ident" id="1477433">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477443">p</span><span class="op" id="1477444">.</span><span class="ident" id="1477445">wholding</span>&nbsp;<span class="op" id="1477454">=</span>&nbsp;<span class="builtintype" id="1477456">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1477463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477467">if</span>&nbsp;<span class="ident" id="1477470">p</span><span class="op" id="1477471">.</span><span class="ident" id="1477472">flushing</span>&nbsp;<span class="op" id="1477481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477485">goto</span>&nbsp;<span class="ident" id="1477490">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1477497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477501">if</span>&nbsp;<span class="op" id="1477504">!</span><span class="ident" id="1477505">p</span><span class="op" id="1477506">.</span><span class="ident" id="1477507">on</span>&nbsp;<span class="op" id="1477510">&amp;&amp;</span>&nbsp;<span class="ident" id="1477513">p</span><span class="op" id="1477514">.</span><span class="ident" id="1477515">handoff</span>&nbsp;<span class="op" id="1477523">==</span>&nbsp;<span class="num" id="1477526">0</span>&nbsp;<span class="op" id="1477528">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477532">return</span>&nbsp;<span class="builtintype" id="1477539">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1477544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1477548">//&nbsp;Wait&nbsp;for&nbsp;new&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477570">notetsleepg</span><span class="op" id="1477581">(</span><span class="op" id="1477582">&amp;</span><span class="ident" id="1477583">p</span><span class="op" id="1477584">.</span><span class="ident" id="1477585">wait</span><span class="op" id="1477589">,</span>&nbsp;<span class="op" id="1477591">-</span><span class="num" id="1477592">1</span><span class="op" id="1477593">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477596">noteclear</span><span class="op" id="1477605">(</span><span class="op" id="1477606">&amp;</span><span class="ident" id="1477607">p</span><span class="op" id="1477608">.</span><span class="ident" id="1477609">wait</span><span class="op" id="1477613">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477617">switch</span>&nbsp;<span class="ident" id="1477624">n</span>&nbsp;<span class="op" id="1477626">:=</span>&nbsp;<span class="ident" id="1477629">p</span><span class="op" id="1477630">.</span><span class="ident" id="1477631">handoff</span><span class="op" id="1477638">;</span>&nbsp;<span class="op" id="1477640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477643">case</span>&nbsp;<span class="ident" id="1477648">n</span>&nbsp;<span class="op" id="1477650">==</span>&nbsp;<span class="num" id="1477653">0</span><span class="op" id="1477654">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1477658">print</span><span class="op" id="1477663">(</span><span class="string" id="1477664">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;wait\n&#34;</span><span class="op" id="1477712">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477716">return</span>&nbsp;<span class="builtintype" id="1477723">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477728">case</span>&nbsp;<span class="ident" id="1477733">n</span>&nbsp;<span class="op" id="1477735">==</span>&nbsp;<span class="num" id="1477738">0x80000000</span><span class="op" id="1477748">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477752">p</span><span class="op" id="1477753">.</span><span class="ident" id="1477754">flushing</span>&nbsp;<span class="op" id="1477763">=</span>&nbsp;<span class="builtintype" id="1477765">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477772">goto</span>&nbsp;<span class="ident" id="1477777">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477784">default</span><span class="op" id="1477791">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477795">n</span>&nbsp;<span class="op" id="1477797">&amp;^=</span>&nbsp;<span class="num" id="1477801">0x80000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1477815">//&nbsp;Return&nbsp;new&nbsp;log&nbsp;to&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1477846">p</span><span class="op" id="1477847">.</span><span class="ident" id="1477848">wholding</span>&nbsp;<span class="op" id="1477857">=</span>&nbsp;<span class="builtintype" id="1477859">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1477867">return</span>&nbsp;<span class="ident" id="1477874">uintptrBytes</span><span class="op" id="1477886">(</span><span class="ident" id="1477887">p</span><span class="op" id="1477888">.</span><span class="ident" id="1477889">log</span><span class="op" id="1477892">[</span><span class="ident" id="1477893">p</span><span class="op" id="1477894">.</span><span class="ident" id="1477895">wtoggle</span><span class="op" id="1477902">]</span><span class="op" id="1477903">[</span><span class="op" id="1477904">:</span><span class="ident" id="1477905">n</span><span class="op" id="1477906">]</span><span class="op" id="1477907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1477910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1477914">//&nbsp;In&nbsp;flush&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1477933">//&nbsp;Add&nbsp;is&nbsp;no&nbsp;longer&nbsp;being&nbsp;called.&nbsp;&nbsp;We&nbsp;own&nbsp;the&nbsp;log.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1477985">//&nbsp;Also,&nbsp;p-&gt;handoff&nbsp;is&nbsp;non-zero,&nbsp;so&nbsp;flushlog&nbsp;will&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1478050">//&nbsp;Evict&nbsp;the&nbsp;hash&nbsp;table&nbsp;into&nbsp;the&nbsp;log&nbsp;and&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span><span class="ident" id="1478102">Flush</span><span class="op" id="1478107">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478110">for</span>&nbsp;<span class="ident" id="1478114">i</span>&nbsp;<span class="op" id="1478116">:=</span>&nbsp;<span class="keyword" id="1478119">range</span>&nbsp;<span class="ident" id="1478125">p</span><span class="op" id="1478126">.</span><span class="ident" id="1478127">hash</span>&nbsp;<span class="op" id="1478132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478136">b</span>&nbsp;<span class="op" id="1478138">:=</span>&nbsp;<span class="op" id="1478141">&amp;</span><span class="ident" id="1478142">p</span><span class="op" id="1478143">.</span><span class="ident" id="1478144">hash</span><span class="op" id="1478148">[</span><span class="ident" id="1478149">i</span><span class="op" id="1478150">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478154">for</span>&nbsp;<span class="ident" id="1478158">j</span>&nbsp;<span class="op" id="1478160">:=</span>&nbsp;<span class="keyword" id="1478163">range</span>&nbsp;<span class="ident" id="1478169">b</span><span class="op" id="1478170">.</span><span class="ident" id="1478171">entry</span>&nbsp;<span class="op" id="1478177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478182">e</span>&nbsp;<span class="op" id="1478184">:=</span>&nbsp;<span class="op" id="1478187">&amp;</span><span class="ident" id="1478188">b</span><span class="op" id="1478189">.</span><span class="ident" id="1478190">entry</span><span class="op" id="1478195">[</span><span class="ident" id="1478196">j</span><span class="op" id="1478197">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478202">if</span>&nbsp;<span class="ident" id="1478205">e</span><span class="op" id="1478206">.</span><span class="ident" id="1478207">count</span>&nbsp;<span class="op" id="1478213">&gt;</span>&nbsp;<span class="num" id="1478215">0</span>&nbsp;<span class="op" id="1478217">&amp;&amp;</span>&nbsp;<span class="op" id="1478220">!</span><span class="ident" id="1478221">p</span><span class="op" id="1478222">.</span><span class="ident" id="1478223">evict</span><span class="op" id="1478228">(</span><span class="ident" id="1478229">e</span><span class="op" id="1478230">)</span>&nbsp;<span class="op" id="1478232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1478238">//&nbsp;Filled&nbsp;the&nbsp;log.&nbsp;&nbsp;Stop&nbsp;the&nbsp;loop&nbsp;and&nbsp;return&nbsp;what&nbsp;we&#39;ve&nbsp;got.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478303">break</span>&nbsp;<span class="ident" id="1478309">Flush</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1478318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1478322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1478325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1478329">//&nbsp;Return&nbsp;pending&nbsp;log&nbsp;data.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478358">if</span>&nbsp;<span class="ident" id="1478361">p</span><span class="op" id="1478362">.</span><span class="ident" id="1478363">nlog</span>&nbsp;<span class="op" id="1478368">&gt;</span>&nbsp;<span class="num" id="1478370">0</span>&nbsp;<span class="op" id="1478372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1478376">//&nbsp;Note&nbsp;that&nbsp;we&#39;re&nbsp;using&nbsp;toggle&nbsp;now,&nbsp;not&nbsp;wtoggle,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1478428">//&nbsp;because&nbsp;we&#39;re&nbsp;working&nbsp;on&nbsp;the&nbsp;log&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478476">n</span>&nbsp;<span class="op" id="1478478">:=</span>&nbsp;<span class="ident" id="1478481">p</span><span class="op" id="1478482">.</span><span class="ident" id="1478483">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478490">p</span><span class="op" id="1478491">.</span><span class="ident" id="1478492">nlog</span>&nbsp;<span class="op" id="1478497">=</span>&nbsp;<span class="num" id="1478499">0</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478503">return</span>&nbsp;<span class="ident" id="1478510">uintptrBytes</span><span class="op" id="1478522">(</span><span class="ident" id="1478523">p</span><span class="op" id="1478524">.</span><span class="ident" id="1478525">log</span><span class="op" id="1478528">[</span><span class="ident" id="1478529">p</span><span class="op" id="1478530">.</span><span class="ident" id="1478531">toggle</span><span class="op" id="1478537">]</span><span class="op" id="1478538">[</span><span class="op" id="1478539">:</span><span class="ident" id="1478540">n</span><span class="op" id="1478541">]</span><span class="op" id="1478542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1478545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1478549">//&nbsp;Made&nbsp;it&nbsp;through&nbsp;the&nbsp;table&nbsp;without&nbsp;finding&nbsp;anything&nbsp;to&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478612">if</span>&nbsp;<span class="op" id="1478615">!</span><span class="ident" id="1478616">p</span><span class="op" id="1478617">.</span><span class="ident" id="1478618">eodSent</span>&nbsp;<span class="op" id="1478626">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1478630">//&nbsp;We&nbsp;may&nbsp;not&nbsp;have&nbsp;space&nbsp;to&nbsp;append&nbsp;this&nbsp;to&nbsp;the&nbsp;partial&nbsp;log&nbsp;buf,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1478696">//&nbsp;so&nbsp;we&nbsp;always&nbsp;return&nbsp;a&nbsp;new&nbsp;slice&nbsp;for&nbsp;the&nbsp;end-of-data&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478761">p</span><span class="op" id="1478762">.</span><span class="ident" id="1478763">eodSent</span>&nbsp;<span class="op" id="1478771">=</span>&nbsp;<span class="builtintype" id="1478773">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478780">return</span>&nbsp;<span class="ident" id="1478787">uintptrBytes</span><span class="op" id="1478799">(</span><span class="ident" id="1478800">eod</span><span class="op" id="1478803">[</span><span class="op" id="1478804">:</span><span class="op" id="1478805">]</span><span class="op" id="1478806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1478809">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1478813">//&nbsp;Finally&nbsp;done.&nbsp;&nbsp;Clean&nbsp;up&nbsp;and&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1478857">p</span><span class="op" id="1478858">.</span><span class="ident" id="1478859">flushing</span>&nbsp;<span class="op" id="1478868">=</span>&nbsp;<span class="builtintype" id="1478870">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478877">if</span>&nbsp;<span class="op" id="1478880">!</span><span class="ident" id="1478881">cas</span><span class="op" id="1478884">(</span><span class="op" id="1478885">&amp;</span><span class="ident" id="1478886">p</span><span class="op" id="1478887">.</span><span class="ident" id="1478888">handoff</span><span class="op" id="1478895">,</span>&nbsp;<span class="ident" id="1478897">p</span><span class="op" id="1478898">.</span><span class="ident" id="1478899">handoff</span><span class="op" id="1478906">,</span>&nbsp;<span class="num" id="1478908">0</span><span class="op" id="1478909">)</span>&nbsp;<span class="op" id="1478911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1478915">print</span><span class="op" id="1478920">(</span><span class="string" id="1478921">&#34;runtime:&nbsp;profile&nbsp;flush&nbsp;racing&nbsp;with&nbsp;something\n&#34;</span><span class="op" id="1478969">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1478972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1478975">return</span>&nbsp;<span class="builtintype" id="1478982">nil</span><br>
<span class="lineno"></span><span class="op" id="1478986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1478989">func</span>&nbsp;<span class="ident" id="1478994">uintptrBytes</span><span class="op" id="1479006">(</span><span class="ident" id="1479007">p</span>&nbsp;<span class="op" id="1479009">[</span><span class="op" id="1479010">]</span><span class="builtintype" id="1479011">uintptr</span><span class="op" id="1479018">)</span>&nbsp;<span class="op" id="1479020">(</span><span class="ident" id="1479021">ret</span>&nbsp;<span class="op" id="1479025">[</span><span class="op" id="1479026">]</span><span class="builtintype" id="1479027">byte</span><span class="op" id="1479031">)</span>&nbsp;<span class="op" id="1479033">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479036">pp</span>&nbsp;<span class="op" id="1479039">:=</span>&nbsp;<span class="op" id="1479042">(</span><span class="op" id="1479043">*</span><span class="ident" id="1479044">sliceStruct</span><span class="op" id="1479055">)</span><span class="op" id="1479056">(</span><span class="ident" id="1479057">unsafe</span><span class="op" id="1479063">.</span><span class="ident" id="1479064">Pointer</span><span class="op" id="1479071">(</span><span class="op" id="1479072">&amp;</span><span class="ident" id="1479073">p</span><span class="op" id="1479074">)</span><span class="op" id="1479075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479078">rp</span>&nbsp;<span class="op" id="1479081">:=</span>&nbsp;<span class="op" id="1479084">(</span><span class="op" id="1479085">*</span><span class="ident" id="1479086">sliceStruct</span><span class="op" id="1479097">)</span><span class="op" id="1479098">(</span><span class="ident" id="1479099">unsafe</span><span class="op" id="1479105">.</span><span class="ident" id="1479106">Pointer</span><span class="op" id="1479113">(</span><span class="op" id="1479114">&amp;</span><span class="ident" id="1479115">ret</span><span class="op" id="1479118">)</span><span class="op" id="1479119">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479123">rp</span><span class="op" id="1479125">.</span><span class="ident" id="1479126">array</span>&nbsp;<span class="op" id="1479132">=</span>&nbsp;<span class="ident" id="1479134">pp</span><span class="op" id="1479136">.</span><span class="ident" id="1479137">array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479144">rp</span><span class="op" id="1479146">.</span><span class="builtinfunc" id="1479147">len</span>&nbsp;<span class="op" id="1479151">=</span>&nbsp;<span class="ident" id="1479153">pp</span><span class="op" id="1479155">.</span><span class="builtinfunc" id="1479156">len</span>&nbsp;<span class="op" id="1479160">*</span>&nbsp;<span class="builtintype" id="1479162">int</span><span class="op" id="1479165">(</span><span class="ident" id="1479166">unsafe</span><span class="op" id="1479172">.</span><span class="ident" id="1479173">Sizeof</span><span class="op" id="1479179">(</span><span class="ident" id="1479180">p</span><span class="op" id="1479181">[</span><span class="num" id="1479182">0</span><span class="op" id="1479183">]</span><span class="op" id="1479184">)</span><span class="op" id="1479185">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1479188">rp</span><span class="op" id="1479190">.</span><span class="builtinfunc" id="1479191">cap</span>&nbsp;<span class="op" id="1479195">=</span>&nbsp;<span class="ident" id="1479197">rp</span><span class="op" id="1479199">.</span><span class="builtinfunc" id="1479200">len</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1479206">return</span><br>
<span class="lineno"></span><span class="op" id="1479213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1479216">//&nbsp;CPUProfile&nbsp;returns&nbsp;the&nbsp;next&nbsp;chunk&nbsp;of&nbsp;binary&nbsp;CPU&nbsp;profiling&nbsp;stack&nbsp;trace&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1479295">//&nbsp;blocking&nbsp;until&nbsp;data&nbsp;is&nbsp;available.&nbsp;&nbsp;If&nbsp;profiling&nbsp;is&nbsp;turned&nbsp;off&nbsp;and&nbsp;all&nbsp;the&nbsp;profile</span><br>
<span class="lineno"></span><span class="comment" id="1479380">//&nbsp;data&nbsp;accumulated&nbsp;while&nbsp;it&nbsp;was&nbsp;on&nbsp;has&nbsp;been&nbsp;returned,&nbsp;CPUProfile&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1479459">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;save&nbsp;the&nbsp;returned&nbsp;data&nbsp;before&nbsp;calling&nbsp;CPUProfile&nbsp;again.</span><br>
<span class="lineno"></span><span class="comment" id="1479534">//</span><br>
<span class="lineno">420</span><span class="comment" id="1479537">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1479593">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1479659">//&nbsp;CPUProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1479683">func</span>&nbsp;<span class="ident" id="1479688">CPUProfile</span><span class="op" id="1479698">(</span><span class="op" id="1479699">)</span>&nbsp;<span class="op" id="1479701">[</span><span class="op" id="1479702">]</span><span class="builtintype" id="1479703">byte</span>&nbsp;<span class="op" id="1479708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1479711">return</span>&nbsp;<span class="ident" id="1479718">cpuprof</span><span class="op" id="1479725">.</span><span class="ident" id="1479726">getprofile</span><span class="op" id="1479736">(</span><span class="op" id="1479737">)</span><br>
<span class="lineno">425</span><span class="op" id="1479739">}</span>
</div>
</body>
</html>
