<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/draw</h2>
<ul>
<li><a href="/gostd/image/draw/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/image/draw/clip_test.go.html">clip_test.go</a></li>
<li><a href="/gostd/image/draw/draw.go.html">draw.go</a></li>
<li><a href="/gostd/image/draw/draw_test.go.html">draw_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5366363">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5366419">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5366473">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5366524">//&nbsp;Package&nbsp;draw&nbsp;provides&nbsp;image&nbsp;composition&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="5366578">//</span><br>
<span class="lineno"></span><span class="comment" id="5366581">//&nbsp;See&nbsp;&#34;The&nbsp;Go&nbsp;image/draw&nbsp;package&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno"></span><span class="comment" id="5366653">//&nbsp;http://golang.org/doc/articles/image_draw.html</span><br>
<span class="lineno"></span><span class="keyword" id="5366703">package</span>&nbsp;<span class="ident" id="5366711">draw</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5366717">import</span>&nbsp;<span class="op" id="5366724">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5366727">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5366736">&#34;image/color&#34;</span><br>
<span class="lineno"></span><span class="op" id="5366750">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5366753">//&nbsp;m&nbsp;is&nbsp;the&nbsp;maximum&nbsp;color&nbsp;value&nbsp;returned&nbsp;by&nbsp;image.Color.RGBA.</span><br>
<span class="lineno"></span><span class="keyword" id="5366815">const</span>&nbsp;<span class="ident" id="5366821">m</span>&nbsp;<span class="op" id="5366823">=</span>&nbsp;<span class="num" id="5366825">1</span><span class="op" id="5366826">&lt;&lt;</span><span class="num" id="5366828">16</span>&nbsp;<span class="op" id="5366831">-</span>&nbsp;<span class="num" id="5366833">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5366836">//&nbsp;Image&nbsp;is&nbsp;an&nbsp;image.Image&nbsp;with&nbsp;a&nbsp;Set&nbsp;method&nbsp;to&nbsp;change&nbsp;a&nbsp;single&nbsp;pixel.</span><br>
<span class="lineno">20</span><span class="keyword" id="5366907">type</span>&nbsp;<span class="ident" id="5366912">Image</span>&nbsp;<span class="keyword" id="5366918">interface</span>&nbsp;<span class="op" id="5366928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366931">image</span><span class="op" id="5366936">.</span><span class="ident" id="5366937">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366944">Set</span><span class="op" id="5366947">(</span><span class="ident" id="5366948">x</span><span class="op" id="5366949">,</span>&nbsp;<span class="ident" id="5366951">y</span>&nbsp;<span class="builtintype" id="5366953">int</span><span class="op" id="5366956">,</span>&nbsp;<span class="ident" id="5366958">c</span>&nbsp;<span class="ident" id="5366960">color</span><span class="op" id="5366965">.</span><span class="ident" id="5366966">Color</span><span class="op" id="5366971">)</span><br>
<span class="lineno"></span><span class="op" id="5366973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5366976">//&nbsp;Quantizer&nbsp;produces&nbsp;a&nbsp;palette&nbsp;for&nbsp;an&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5367022">type</span>&nbsp;<span class="ident" id="5367027">Quantizer</span>&nbsp;<span class="keyword" id="5367037">interface</span>&nbsp;<span class="op" id="5367047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5367050">//&nbsp;Quantize&nbsp;appends&nbsp;up&nbsp;to&nbsp;cap(p)&nbsp;-&nbsp;len(p)&nbsp;colors&nbsp;to&nbsp;p&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5367121">//&nbsp;updated&nbsp;palette&nbsp;suitable&nbsp;for&nbsp;converting&nbsp;m&nbsp;to&nbsp;a&nbsp;paletted&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367188">Quantize</span><span class="op" id="5367196">(</span><span class="ident" id="5367197">p</span>&nbsp;<span class="ident" id="5367199">color</span><span class="op" id="5367204">.</span><span class="ident" id="5367205">Palette</span><span class="op" id="5367212">,</span>&nbsp;<span class="ident" id="5367214">m</span>&nbsp;<span class="ident" id="5367216">image</span><span class="op" id="5367221">.</span><span class="ident" id="5367222">Image</span><span class="op" id="5367227">)</span>&nbsp;<span class="ident" id="5367229">color</span><span class="op" id="5367234">.</span><span class="ident" id="5367235">Palette</span><br>
<span class="lineno">30</span><span class="op" id="5367243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5367246">//&nbsp;Op&nbsp;is&nbsp;a&nbsp;Porter-Duff&nbsp;compositing&nbsp;operator.</span><br>
<span class="lineno"></span><span class="keyword" id="5367291">type</span>&nbsp;<span class="ident" id="5367296">Op</span>&nbsp;<span class="builtintype" id="5367299">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5367304">const</span>&nbsp;<span class="op" id="5367310">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5367313">//&nbsp;Over&nbsp;specifies&nbsp;``(src&nbsp;in&nbsp;mask)&nbsp;over&nbsp;dst&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367360">Over</span>&nbsp;<span class="ident" id="5367365">Op</span>&nbsp;<span class="op" id="5367368">=</span>&nbsp;<span class="ident" id="5367370">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5367376">//&nbsp;Src&nbsp;specifies&nbsp;``src&nbsp;in&nbsp;mask&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367411">Src</span><br>
<span class="lineno">40</span><span class="op" id="5367415">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5367418">//&nbsp;Draw&nbsp;implements&nbsp;the&nbsp;Drawer&nbsp;interface&nbsp;by&nbsp;calling&nbsp;the&nbsp;Draw&nbsp;function&nbsp;with&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5367497">//&nbsp;Op.</span><br>
<span class="lineno"></span><span class="keyword" id="5367504">func</span>&nbsp;<span class="op" id="5367509">(</span><span class="ident" id="5367510">op</span>&nbsp;<span class="ident" id="5367513">Op</span><span class="op" id="5367515">)</span>&nbsp;<span class="ident" id="5367517">Draw</span><span class="op" id="5367521">(</span><span class="ident" id="5367522">dst</span>&nbsp;<span class="ident" id="5367526">Image</span><span class="op" id="5367531">,</span>&nbsp;<span class="ident" id="5367533">r</span>&nbsp;<span class="ident" id="5367535">image</span><span class="op" id="5367540">.</span><span class="ident" id="5367541">Rectangle</span><span class="op" id="5367550">,</span>&nbsp;<span class="ident" id="5367552">src</span>&nbsp;<span class="ident" id="5367556">image</span><span class="op" id="5367561">.</span><span class="ident" id="5367562">Image</span><span class="op" id="5367567">,</span>&nbsp;<span class="ident" id="5367569">sp</span>&nbsp;<span class="ident" id="5367572">image</span><span class="op" id="5367577">.</span><span class="ident" id="5367578">Point</span><span class="op" id="5367583">)</span>&nbsp;<span class="op" id="5367585">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367588">DrawMask</span><span class="op" id="5367596">(</span><span class="ident" id="5367597">dst</span><span class="op" id="5367600">,</span>&nbsp;<span class="ident" id="5367602">r</span><span class="op" id="5367603">,</span>&nbsp;<span class="ident" id="5367605">src</span><span class="op" id="5367608">,</span>&nbsp;<span class="ident" id="5367610">sp</span><span class="op" id="5367612">,</span>&nbsp;<span class="ident" id="5367614">nil</span><span class="op" id="5367617">,</span>&nbsp;<span class="ident" id="5367619">image</span><span class="op" id="5367624">.</span><span class="ident" id="5367625">Point</span><span class="op" id="5367630">{</span><span class="op" id="5367631">}</span><span class="op" id="5367632">,</span>&nbsp;<span class="ident" id="5367634">op</span><span class="op" id="5367636">)</span><br>
<span class="lineno"></span><span class="op" id="5367638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5367641">//&nbsp;Drawer&nbsp;contains&nbsp;the&nbsp;Draw&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="5367677">type</span>&nbsp;<span class="ident" id="5367682">Drawer</span>&nbsp;<span class="keyword" id="5367689">interface</span>&nbsp;<span class="op" id="5367699">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5367702">//&nbsp;Draw&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5367768">//&nbsp;rectangle&nbsp;r&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;drawing&nbsp;src&nbsp;on&nbsp;dst.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367830">Draw</span><span class="op" id="5367834">(</span><span class="ident" id="5367835">dst</span>&nbsp;<span class="ident" id="5367839">Image</span><span class="op" id="5367844">,</span>&nbsp;<span class="ident" id="5367846">r</span>&nbsp;<span class="ident" id="5367848">image</span><span class="op" id="5367853">.</span><span class="ident" id="5367854">Rectangle</span><span class="op" id="5367863">,</span>&nbsp;<span class="ident" id="5367865">src</span>&nbsp;<span class="ident" id="5367869">image</span><span class="op" id="5367874">.</span><span class="ident" id="5367875">Image</span><span class="op" id="5367880">,</span>&nbsp;<span class="ident" id="5367882">sp</span>&nbsp;<span class="ident" id="5367885">image</span><span class="op" id="5367890">.</span><span class="ident" id="5367891">Point</span><span class="op" id="5367896">)</span><br>
<span class="lineno"></span><span class="op" id="5367898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5367901">//&nbsp;FloydSteinberg&nbsp;is&nbsp;a&nbsp;Drawer&nbsp;that&nbsp;is&nbsp;the&nbsp;Src&nbsp;Op&nbsp;with&nbsp;Floyd-Steinberg&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5367977">//&nbsp;diffusion.</span><br>
<span class="lineno"></span><span class="keyword" id="5367991">var</span>&nbsp;<span class="ident" id="5367995">FloydSteinberg</span>&nbsp;<span class="ident" id="5368010">Drawer</span>&nbsp;<span class="op" id="5368017">=</span>&nbsp;<span class="ident" id="5368019">floydSteinberg</span><span class="op" id="5368033">{</span><span class="op" id="5368034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5368037">type</span>&nbsp;<span class="ident" id="5368042">floydSteinberg</span>&nbsp;<span class="keyword" id="5368057">struct</span><span class="op" id="5368063">{</span><span class="op" id="5368064">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5368067">func</span>&nbsp;<span class="op" id="5368072">(</span><span class="ident" id="5368073">floydSteinberg</span><span class="op" id="5368087">)</span>&nbsp;<span class="ident" id="5368089">Draw</span><span class="op" id="5368093">(</span><span class="ident" id="5368094">dst</span>&nbsp;<span class="ident" id="5368098">Image</span><span class="op" id="5368103">,</span>&nbsp;<span class="ident" id="5368105">r</span>&nbsp;<span class="ident" id="5368107">image</span><span class="op" id="5368112">.</span><span class="ident" id="5368113">Rectangle</span><span class="op" id="5368122">,</span>&nbsp;<span class="ident" id="5368124">src</span>&nbsp;<span class="ident" id="5368128">image</span><span class="op" id="5368133">.</span><span class="ident" id="5368134">Image</span><span class="op" id="5368139">,</span>&nbsp;<span class="ident" id="5368141">sp</span>&nbsp;<span class="ident" id="5368144">image</span><span class="op" id="5368149">.</span><span class="ident" id="5368150">Point</span><span class="op" id="5368155">)</span>&nbsp;<span class="op" id="5368157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368160">clip</span><span class="op" id="5368164">(</span><span class="ident" id="5368165">dst</span><span class="op" id="5368168">,</span>&nbsp;<span class="op" id="5368170">&amp;</span><span class="ident" id="5368171">r</span><span class="op" id="5368172">,</span>&nbsp;<span class="ident" id="5368174">src</span><span class="op" id="5368177">,</span>&nbsp;<span class="op" id="5368179">&amp;</span><span class="ident" id="5368180">sp</span><span class="op" id="5368182">,</span>&nbsp;<span class="ident" id="5368184">nil</span><span class="op" id="5368187">,</span>&nbsp;<span class="ident" id="5368189">nil</span><span class="op" id="5368192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368195">if</span>&nbsp;<span class="ident" id="5368198">r</span><span class="op" id="5368199">.</span><span class="ident" id="5368200">Empty</span><span class="op" id="5368205">(</span><span class="op" id="5368206">)</span>&nbsp;<span class="op" id="5368208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368212">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368223">drawPaletted</span><span class="op" id="5368235">(</span><span class="ident" id="5368236">dst</span><span class="op" id="5368239">,</span>&nbsp;<span class="ident" id="5368241">r</span><span class="op" id="5368242">,</span>&nbsp;<span class="ident" id="5368244">src</span><span class="op" id="5368247">,</span>&nbsp;<span class="ident" id="5368249">sp</span><span class="op" id="5368251">,</span>&nbsp;<span class="builtintype" id="5368253">true</span><span class="op" id="5368257">)</span><br>
<span class="lineno"></span><span class="op" id="5368259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5368262">//&nbsp;clip&nbsp;clips&nbsp;r&nbsp;against&nbsp;each&nbsp;image&#39;s&nbsp;bounds&nbsp;(after&nbsp;translating&nbsp;into&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="5368334">//&nbsp;destination&nbsp;image&#39;s&nbsp;co-ordinate&nbsp;space)&nbsp;and&nbsp;shifts&nbsp;the&nbsp;points&nbsp;sp&nbsp;and&nbsp;mp&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5368411">//&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;change&nbsp;in&nbsp;r.Min.</span><br>
<span class="lineno"></span><span class="keyword" id="5368454">func</span>&nbsp;<span class="ident" id="5368459">clip</span><span class="op" id="5368463">(</span><span class="ident" id="5368464">dst</span>&nbsp;<span class="ident" id="5368468">Image</span><span class="op" id="5368473">,</span>&nbsp;<span class="ident" id="5368475">r</span>&nbsp;<span class="op" id="5368477">*</span><span class="ident" id="5368478">image</span><span class="op" id="5368483">.</span><span class="ident" id="5368484">Rectangle</span><span class="op" id="5368493">,</span>&nbsp;<span class="ident" id="5368495">src</span>&nbsp;<span class="ident" id="5368499">image</span><span class="op" id="5368504">.</span><span class="ident" id="5368505">Image</span><span class="op" id="5368510">,</span>&nbsp;<span class="ident" id="5368512">sp</span>&nbsp;<span class="op" id="5368515">*</span><span class="ident" id="5368516">image</span><span class="op" id="5368521">.</span><span class="ident" id="5368522">Point</span><span class="op" id="5368527">,</span>&nbsp;<span class="ident" id="5368529">mask</span>&nbsp;<span class="ident" id="5368534">image</span><span class="op" id="5368539">.</span><span class="ident" id="5368540">Image</span><span class="op" id="5368545">,</span>&nbsp;<span class="ident" id="5368547">mp</span>&nbsp;<span class="op" id="5368550">*</span><span class="ident" id="5368551">image</span><span class="op" id="5368556">.</span><span class="ident" id="5368557">Point</span><span class="op" id="5368562">)</span>&nbsp;<span class="op" id="5368564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368567">orig</span>&nbsp;<span class="op" id="5368572">:=</span>&nbsp;<span class="ident" id="5368575">r</span><span class="op" id="5368576">.</span><span class="ident" id="5368577">Min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368582">*</span><span class="ident" id="5368583">r</span>&nbsp;<span class="op" id="5368585">=</span>&nbsp;<span class="ident" id="5368587">r</span><span class="op" id="5368588">.</span><span class="ident" id="5368589">Intersect</span><span class="op" id="5368598">(</span><span class="ident" id="5368599">dst</span><span class="op" id="5368602">.</span><span class="ident" id="5368603">Bounds</span><span class="op" id="5368609">(</span><span class="op" id="5368610">)</span><span class="op" id="5368611">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368614">*</span><span class="ident" id="5368615">r</span>&nbsp;<span class="op" id="5368617">=</span>&nbsp;<span class="ident" id="5368619">r</span><span class="op" id="5368620">.</span><span class="ident" id="5368621">Intersect</span><span class="op" id="5368630">(</span><span class="ident" id="5368631">src</span><span class="op" id="5368634">.</span><span class="ident" id="5368635">Bounds</span><span class="op" id="5368641">(</span><span class="op" id="5368642">)</span><span class="op" id="5368643">.</span><span class="ident" id="5368644">Add</span><span class="op" id="5368647">(</span><span class="ident" id="5368648">orig</span><span class="op" id="5368652">.</span><span class="ident" id="5368653">Sub</span><span class="op" id="5368656">(</span><span class="op" id="5368657">*</span><span class="ident" id="5368658">sp</span><span class="op" id="5368660">)</span><span class="op" id="5368661">)</span><span class="op" id="5368662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368665">if</span>&nbsp;<span class="ident" id="5368668">mask</span>&nbsp;<span class="op" id="5368673">!=</span>&nbsp;<span class="ident" id="5368676">nil</span>&nbsp;<span class="op" id="5368680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368684">*</span><span class="ident" id="5368685">r</span>&nbsp;<span class="op" id="5368687">=</span>&nbsp;<span class="ident" id="5368689">r</span><span class="op" id="5368690">.</span><span class="ident" id="5368691">Intersect</span><span class="op" id="5368700">(</span><span class="ident" id="5368701">mask</span><span class="op" id="5368705">.</span><span class="ident" id="5368706">Bounds</span><span class="op" id="5368712">(</span><span class="op" id="5368713">)</span><span class="op" id="5368714">.</span><span class="ident" id="5368715">Add</span><span class="op" id="5368718">(</span><span class="ident" id="5368719">orig</span><span class="op" id="5368723">.</span><span class="ident" id="5368724">Sub</span><span class="op" id="5368727">(</span><span class="op" id="5368728">*</span><span class="ident" id="5368729">mp</span><span class="op" id="5368731">)</span><span class="op" id="5368732">)</span><span class="op" id="5368733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368739">dx</span>&nbsp;<span class="op" id="5368742">:=</span>&nbsp;<span class="ident" id="5368745">r</span><span class="op" id="5368746">.</span><span class="ident" id="5368747">Min</span><span class="op" id="5368750">.</span><span class="ident" id="5368751">X</span>&nbsp;<span class="op" id="5368753">-</span>&nbsp;<span class="ident" id="5368755">orig</span><span class="op" id="5368759">.</span><span class="ident" id="5368760">X</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368763">dy</span>&nbsp;<span class="op" id="5368766">:=</span>&nbsp;<span class="ident" id="5368769">r</span><span class="op" id="5368770">.</span><span class="ident" id="5368771">Min</span><span class="op" id="5368774">.</span><span class="ident" id="5368775">Y</span>&nbsp;<span class="op" id="5368777">-</span>&nbsp;<span class="ident" id="5368779">orig</span><span class="op" id="5368783">.</span><span class="ident" id="5368784">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368787">if</span>&nbsp;<span class="ident" id="5368790">dx</span>&nbsp;<span class="op" id="5368793">==</span>&nbsp;<span class="num" id="5368796">0</span>&nbsp;<span class="op" id="5368798">&amp;&amp;</span>&nbsp;<span class="ident" id="5368801">dy</span>&nbsp;<span class="op" id="5368804">==</span>&nbsp;<span class="num" id="5368807">0</span>&nbsp;<span class="op" id="5368809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368813">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368824">(</span><span class="op" id="5368825">*</span><span class="ident" id="5368826">sp</span><span class="op" id="5368828">)</span><span class="op" id="5368829">.</span><span class="ident" id="5368830">X</span>&nbsp;<span class="op" id="5368832">+=</span>&nbsp;<span class="ident" id="5368835">dx</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368839">(</span><span class="op" id="5368840">*</span><span class="ident" id="5368841">sp</span><span class="op" id="5368843">)</span><span class="op" id="5368844">.</span><span class="ident" id="5368845">Y</span>&nbsp;<span class="op" id="5368847">+=</span>&nbsp;<span class="ident" id="5368850">dy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368854">(</span><span class="op" id="5368855">*</span><span class="ident" id="5368856">mp</span><span class="op" id="5368858">)</span><span class="op" id="5368859">.</span><span class="ident" id="5368860">X</span>&nbsp;<span class="op" id="5368862">+=</span>&nbsp;<span class="ident" id="5368865">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368869">(</span><span class="op" id="5368870">*</span><span class="ident" id="5368871">mp</span><span class="op" id="5368873">)</span><span class="op" id="5368874">.</span><span class="ident" id="5368875">Y</span>&nbsp;<span class="op" id="5368877">+=</span>&nbsp;<span class="ident" id="5368880">dy</span><br>
<span class="lineno"></span><span class="op" id="5368883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="5368886">func</span>&nbsp;<span class="ident" id="5368891">processBackward</span><span class="op" id="5368906">(</span><span class="ident" id="5368907">dst</span>&nbsp;<span class="ident" id="5368911">Image</span><span class="op" id="5368916">,</span>&nbsp;<span class="ident" id="5368918">r</span>&nbsp;<span class="ident" id="5368920">image</span><span class="op" id="5368925">.</span><span class="ident" id="5368926">Rectangle</span><span class="op" id="5368935">,</span>&nbsp;<span class="ident" id="5368937">src</span>&nbsp;<span class="ident" id="5368941">image</span><span class="op" id="5368946">.</span><span class="ident" id="5368947">Image</span><span class="op" id="5368952">,</span>&nbsp;<span class="ident" id="5368954">sp</span>&nbsp;<span class="ident" id="5368957">image</span><span class="op" id="5368962">.</span><span class="ident" id="5368963">Point</span><span class="op" id="5368968">)</span>&nbsp;<span class="builtintype" id="5368970">bool</span>&nbsp;<span class="op" id="5368975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368978">return</span>&nbsp;<span class="ident" id="5368985">image</span><span class="op" id="5368990">.</span><span class="ident" id="5368991">Image</span><span class="op" id="5368996">(</span><span class="ident" id="5368997">dst</span><span class="op" id="5369000">)</span>&nbsp;<span class="op" id="5369002">==</span>&nbsp;<span class="ident" id="5369005">src</span>&nbsp;<span class="op" id="5369009">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369014">r</span><span class="op" id="5369015">.</span><span class="ident" id="5369016">Overlaps</span><span class="op" id="5369024">(</span><span class="ident" id="5369025">r</span><span class="op" id="5369026">.</span><span class="ident" id="5369027">Add</span><span class="op" id="5369030">(</span><span class="ident" id="5369031">sp</span><span class="op" id="5369033">.</span><span class="ident" id="5369034">Sub</span><span class="op" id="5369037">(</span><span class="ident" id="5369038">r</span><span class="op" id="5369039">.</span><span class="ident" id="5369040">Min</span><span class="op" id="5369043">)</span><span class="op" id="5369044">)</span><span class="op" id="5369045">)</span>&nbsp;<span class="op" id="5369047">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369052">(</span><span class="ident" id="5369053">sp</span><span class="op" id="5369055">.</span><span class="ident" id="5369056">Y</span>&nbsp;<span class="op" id="5369058">&lt;</span>&nbsp;<span class="ident" id="5369060">r</span><span class="op" id="5369061">.</span><span class="ident" id="5369062">Min</span><span class="op" id="5369065">.</span><span class="ident" id="5369066">Y</span>&nbsp;<span class="op" id="5369068">||</span>&nbsp;<span class="op" id="5369071">(</span><span class="ident" id="5369072">sp</span><span class="op" id="5369074">.</span><span class="ident" id="5369075">Y</span>&nbsp;<span class="op" id="5369077">==</span>&nbsp;<span class="ident" id="5369080">r</span><span class="op" id="5369081">.</span><span class="ident" id="5369082">Min</span><span class="op" id="5369085">.</span><span class="ident" id="5369086">Y</span>&nbsp;<span class="op" id="5369088">&amp;&amp;</span>&nbsp;<span class="ident" id="5369091">sp</span><span class="op" id="5369093">.</span><span class="ident" id="5369094">X</span>&nbsp;<span class="op" id="5369096">&lt;</span>&nbsp;<span class="ident" id="5369098">r</span><span class="op" id="5369099">.</span><span class="ident" id="5369100">Min</span><span class="op" id="5369103">.</span><span class="ident" id="5369104">X</span><span class="op" id="5369105">)</span><span class="op" id="5369106">)</span><br>
<span class="lineno"></span><span class="op" id="5369108">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5369111">//&nbsp;Draw&nbsp;calls&nbsp;DrawMask&nbsp;with&nbsp;a&nbsp;nil&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="5369151">func</span>&nbsp;<span class="ident" id="5369156">Draw</span><span class="op" id="5369160">(</span><span class="ident" id="5369161">dst</span>&nbsp;<span class="ident" id="5369165">Image</span><span class="op" id="5369170">,</span>&nbsp;<span class="ident" id="5369172">r</span>&nbsp;<span class="ident" id="5369174">image</span><span class="op" id="5369179">.</span><span class="ident" id="5369180">Rectangle</span><span class="op" id="5369189">,</span>&nbsp;<span class="ident" id="5369191">src</span>&nbsp;<span class="ident" id="5369195">image</span><span class="op" id="5369200">.</span><span class="ident" id="5369201">Image</span><span class="op" id="5369206">,</span>&nbsp;<span class="ident" id="5369208">sp</span>&nbsp;<span class="ident" id="5369211">image</span><span class="op" id="5369216">.</span><span class="ident" id="5369217">Point</span><span class="op" id="5369222">,</span>&nbsp;<span class="ident" id="5369224">op</span>&nbsp;<span class="ident" id="5369227">Op</span><span class="op" id="5369229">)</span>&nbsp;<span class="op" id="5369231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369234">DrawMask</span><span class="op" id="5369242">(</span><span class="ident" id="5369243">dst</span><span class="op" id="5369246">,</span>&nbsp;<span class="ident" id="5369248">r</span><span class="op" id="5369249">,</span>&nbsp;<span class="ident" id="5369251">src</span><span class="op" id="5369254">,</span>&nbsp;<span class="ident" id="5369256">sp</span><span class="op" id="5369258">,</span>&nbsp;<span class="ident" id="5369260">nil</span><span class="op" id="5369263">,</span>&nbsp;<span class="ident" id="5369265">image</span><span class="op" id="5369270">.</span><span class="ident" id="5369271">Point</span><span class="op" id="5369276">{</span><span class="op" id="5369277">}</span><span class="op" id="5369278">,</span>&nbsp;<span class="ident" id="5369280">op</span><span class="op" id="5369282">)</span><br>
<span class="lineno"></span><span class="op" id="5369284">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5369287">//&nbsp;DrawMask&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;mp&nbsp;in&nbsp;mask&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the&nbsp;rectangle&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5369383">//&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;Porter-Duff&nbsp;composition.&nbsp;A&nbsp;nil&nbsp;mask&nbsp;is&nbsp;treated&nbsp;as&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5369472">func</span>&nbsp;<span class="ident" id="5369477">DrawMask</span><span class="op" id="5369485">(</span><span class="ident" id="5369486">dst</span>&nbsp;<span class="ident" id="5369490">Image</span><span class="op" id="5369495">,</span>&nbsp;<span class="ident" id="5369497">r</span>&nbsp;<span class="ident" id="5369499">image</span><span class="op" id="5369504">.</span><span class="ident" id="5369505">Rectangle</span><span class="op" id="5369514">,</span>&nbsp;<span class="ident" id="5369516">src</span>&nbsp;<span class="ident" id="5369520">image</span><span class="op" id="5369525">.</span><span class="ident" id="5369526">Image</span><span class="op" id="5369531">,</span>&nbsp;<span class="ident" id="5369533">sp</span>&nbsp;<span class="ident" id="5369536">image</span><span class="op" id="5369541">.</span><span class="ident" id="5369542">Point</span><span class="op" id="5369547">,</span>&nbsp;<span class="ident" id="5369549">mask</span>&nbsp;<span class="ident" id="5369554">image</span><span class="op" id="5369559">.</span><span class="ident" id="5369560">Image</span><span class="op" id="5369565">,</span>&nbsp;<span class="ident" id="5369567">mp</span>&nbsp;<span class="ident" id="5369570">image</span><span class="op" id="5369575">.</span><span class="ident" id="5369576">Point</span><span class="op" id="5369581">,</span>&nbsp;<span class="ident" id="5369583">op</span>&nbsp;<span class="ident" id="5369586">Op</span><span class="op" id="5369588">)</span>&nbsp;<span class="op" id="5369590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369593">clip</span><span class="op" id="5369597">(</span><span class="ident" id="5369598">dst</span><span class="op" id="5369601">,</span>&nbsp;<span class="op" id="5369603">&amp;</span><span class="ident" id="5369604">r</span><span class="op" id="5369605">,</span>&nbsp;<span class="ident" id="5369607">src</span><span class="op" id="5369610">,</span>&nbsp;<span class="op" id="5369612">&amp;</span><span class="ident" id="5369613">sp</span><span class="op" id="5369615">,</span>&nbsp;<span class="ident" id="5369617">mask</span><span class="op" id="5369621">,</span>&nbsp;<span class="op" id="5369623">&amp;</span><span class="ident" id="5369624">mp</span><span class="op" id="5369626">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369629">if</span>&nbsp;<span class="ident" id="5369632">r</span><span class="op" id="5369633">.</span><span class="ident" id="5369634">Empty</span><span class="op" id="5369639">(</span><span class="op" id="5369640">)</span>&nbsp;<span class="op" id="5369642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369646">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5369658">//&nbsp;Fast&nbsp;paths&nbsp;for&nbsp;special&nbsp;cases.&nbsp;If&nbsp;none&nbsp;of&nbsp;them&nbsp;apply,&nbsp;then&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;a&nbsp;general&nbsp;but&nbsp;slow&nbsp;implementation.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369771">switch</span>&nbsp;<span class="ident" id="5369778">dst0</span>&nbsp;<span class="op" id="5369783">:=</span>&nbsp;<span class="ident" id="5369786">dst</span><span class="op" id="5369789">.</span><span class="op" id="5369790">(</span><span class="keyword" id="5369791">type</span><span class="op" id="5369795">)</span>&nbsp;<span class="op" id="5369797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369800">case</span>&nbsp;<span class="op" id="5369805">*</span><span class="ident" id="5369806">image</span><span class="op" id="5369811">.</span><span class="ident" id="5369812">RGBA</span><span class="op" id="5369816">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369820">if</span>&nbsp;<span class="ident" id="5369823">op</span>&nbsp;<span class="op" id="5369826">==</span>&nbsp;<span class="ident" id="5369829">Over</span>&nbsp;<span class="op" id="5369834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369839">if</span>&nbsp;<span class="ident" id="5369842">mask</span>&nbsp;<span class="op" id="5369847">==</span>&nbsp;<span class="ident" id="5369850">nil</span>&nbsp;<span class="op" id="5369854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369860">switch</span>&nbsp;<span class="ident" id="5369867">src0</span>&nbsp;<span class="op" id="5369872">:=</span>&nbsp;<span class="ident" id="5369875">src</span><span class="op" id="5369878">.</span><span class="op" id="5369879">(</span><span class="keyword" id="5369880">type</span><span class="op" id="5369884">)</span>&nbsp;<span class="op" id="5369886">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369892">case</span>&nbsp;<span class="op" id="5369897">*</span><span class="ident" id="5369898">image</span><span class="op" id="5369903">.</span><span class="ident" id="5369904">Uniform</span><span class="op" id="5369911">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369918">drawFillOver</span><span class="op" id="5369930">(</span><span class="ident" id="5369931">dst0</span><span class="op" id="5369935">,</span>&nbsp;<span class="ident" id="5369937">r</span><span class="op" id="5369938">,</span>&nbsp;<span class="ident" id="5369940">src0</span><span class="op" id="5369944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369951">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369962">case</span>&nbsp;<span class="op" id="5369967">*</span><span class="ident" id="5369968">image</span><span class="op" id="5369973">.</span><span class="ident" id="5369974">RGBA</span><span class="op" id="5369978">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369985">drawCopyOver</span><span class="op" id="5369997">(</span><span class="ident" id="5369998">dst0</span><span class="op" id="5370002">,</span>&nbsp;<span class="ident" id="5370004">r</span><span class="op" id="5370005">,</span>&nbsp;<span class="ident" id="5370007">src0</span><span class="op" id="5370011">,</span>&nbsp;<span class="ident" id="5370013">sp</span><span class="op" id="5370015">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370022">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370033">case</span>&nbsp;<span class="op" id="5370038">*</span><span class="ident" id="5370039">image</span><span class="op" id="5370044">.</span><span class="ident" id="5370045">NRGBA</span><span class="op" id="5370050">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370057">drawNRGBAOver</span><span class="op" id="5370070">(</span><span class="ident" id="5370071">dst0</span><span class="op" id="5370075">,</span>&nbsp;<span class="ident" id="5370077">r</span><span class="op" id="5370078">,</span>&nbsp;<span class="ident" id="5370080">src0</span><span class="op" id="5370084">,</span>&nbsp;<span class="ident" id="5370086">sp</span><span class="op" id="5370088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370095">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370106">case</span>&nbsp;<span class="op" id="5370111">*</span><span class="ident" id="5370112">image</span><span class="op" id="5370117">.</span><span class="ident" id="5370118">YCbCr</span><span class="op" id="5370123">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370130">if</span>&nbsp;<span class="ident" id="5370133">drawYCbCr</span><span class="op" id="5370142">(</span><span class="ident" id="5370143">dst0</span><span class="op" id="5370147">,</span>&nbsp;<span class="ident" id="5370149">r</span><span class="op" id="5370150">,</span>&nbsp;<span class="ident" id="5370152">src0</span><span class="op" id="5370156">,</span>&nbsp;<span class="ident" id="5370158">sp</span><span class="op" id="5370160">)</span>&nbsp;<span class="op" id="5370162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370170">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370193">}</span>&nbsp;<span class="keyword" id="5370195">else</span>&nbsp;<span class="keyword" id="5370200">if</span>&nbsp;<span class="ident" id="5370203">mask0</span><span class="op" id="5370208">,</span>&nbsp;<span class="ident" id="5370210">ok</span>&nbsp;<span class="op" id="5370213">:=</span>&nbsp;<span class="ident" id="5370216">mask</span><span class="op" id="5370220">.</span><span class="op" id="5370221">(</span><span class="op" id="5370222">*</span><span class="ident" id="5370223">image</span><span class="op" id="5370228">.</span><span class="ident" id="5370229">Alpha</span><span class="op" id="5370234">)</span><span class="op" id="5370235">;</span>&nbsp;<span class="ident" id="5370237">ok</span>&nbsp;<span class="op" id="5370240">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370246">switch</span>&nbsp;<span class="ident" id="5370253">src0</span>&nbsp;<span class="op" id="5370258">:=</span>&nbsp;<span class="ident" id="5370261">src</span><span class="op" id="5370264">.</span><span class="op" id="5370265">(</span><span class="keyword" id="5370266">type</span><span class="op" id="5370270">)</span>&nbsp;<span class="op" id="5370272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370278">case</span>&nbsp;<span class="op" id="5370283">*</span><span class="ident" id="5370284">image</span><span class="op" id="5370289">.</span><span class="ident" id="5370290">Uniform</span><span class="op" id="5370297">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370304">drawGlyphOver</span><span class="op" id="5370317">(</span><span class="ident" id="5370318">dst0</span><span class="op" id="5370322">,</span>&nbsp;<span class="ident" id="5370324">r</span><span class="op" id="5370325">,</span>&nbsp;<span class="ident" id="5370327">src0</span><span class="op" id="5370331">,</span>&nbsp;<span class="ident" id="5370333">mask0</span><span class="op" id="5370338">,</span>&nbsp;<span class="ident" id="5370340">mp</span><span class="op" id="5370342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370349">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370360">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370369">}</span>&nbsp;<span class="keyword" id="5370371">else</span>&nbsp;<span class="op" id="5370376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370381">if</span>&nbsp;<span class="ident" id="5370384">mask</span>&nbsp;<span class="op" id="5370389">==</span>&nbsp;<span class="ident" id="5370392">nil</span>&nbsp;<span class="op" id="5370396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370402">switch</span>&nbsp;<span class="ident" id="5370409">src0</span>&nbsp;<span class="op" id="5370414">:=</span>&nbsp;<span class="ident" id="5370417">src</span><span class="op" id="5370420">.</span><span class="op" id="5370421">(</span><span class="keyword" id="5370422">type</span><span class="op" id="5370426">)</span>&nbsp;<span class="op" id="5370428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370434">case</span>&nbsp;<span class="op" id="5370439">*</span><span class="ident" id="5370440">image</span><span class="op" id="5370445">.</span><span class="ident" id="5370446">Uniform</span><span class="op" id="5370453">:</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370460">drawFillSrc</span><span class="op" id="5370471">(</span><span class="ident" id="5370472">dst0</span><span class="op" id="5370476">,</span>&nbsp;<span class="ident" id="5370478">r</span><span class="op" id="5370479">,</span>&nbsp;<span class="ident" id="5370481">src0</span><span class="op" id="5370485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370492">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370503">case</span>&nbsp;<span class="op" id="5370508">*</span><span class="ident" id="5370509">image</span><span class="op" id="5370514">.</span><span class="ident" id="5370515">RGBA</span><span class="op" id="5370519">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370526">drawCopySrc</span><span class="op" id="5370537">(</span><span class="ident" id="5370538">dst0</span><span class="op" id="5370542">,</span>&nbsp;<span class="ident" id="5370544">r</span><span class="op" id="5370545">,</span>&nbsp;<span class="ident" id="5370547">src0</span><span class="op" id="5370551">,</span>&nbsp;<span class="ident" id="5370553">sp</span><span class="op" id="5370555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370562">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370573">case</span>&nbsp;<span class="op" id="5370578">*</span><span class="ident" id="5370579">image</span><span class="op" id="5370584">.</span><span class="ident" id="5370585">NRGBA</span><span class="op" id="5370590">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370597">drawNRGBASrc</span><span class="op" id="5370609">(</span><span class="ident" id="5370610">dst0</span><span class="op" id="5370614">,</span>&nbsp;<span class="ident" id="5370616">r</span><span class="op" id="5370617">,</span>&nbsp;<span class="ident" id="5370619">src0</span><span class="op" id="5370623">,</span>&nbsp;<span class="ident" id="5370625">sp</span><span class="op" id="5370627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370634">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370645">case</span>&nbsp;<span class="op" id="5370650">*</span><span class="ident" id="5370651">image</span><span class="op" id="5370656">.</span><span class="ident" id="5370657">YCbCr</span><span class="op" id="5370662">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370669">if</span>&nbsp;<span class="ident" id="5370672">drawYCbCr</span><span class="op" id="5370681">(</span><span class="ident" id="5370682">dst0</span><span class="op" id="5370686">,</span>&nbsp;<span class="ident" id="5370688">r</span><span class="op" id="5370689">,</span>&nbsp;<span class="ident" id="5370691">src0</span><span class="op" id="5370695">,</span>&nbsp;<span class="ident" id="5370697">sp</span><span class="op" id="5370699">)</span>&nbsp;<span class="op" id="5370701">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370709">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370736">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370740">drawRGBA</span><span class="op" id="5370748">(</span><span class="ident" id="5370749">dst0</span><span class="op" id="5370753">,</span>&nbsp;<span class="ident" id="5370755">r</span><span class="op" id="5370756">,</span>&nbsp;<span class="ident" id="5370758">src</span><span class="op" id="5370761">,</span>&nbsp;<span class="ident" id="5370763">sp</span><span class="op" id="5370765">,</span>&nbsp;<span class="ident" id="5370767">mask</span><span class="op" id="5370771">,</span>&nbsp;<span class="ident" id="5370773">mp</span><span class="op" id="5370775">,</span>&nbsp;<span class="ident" id="5370777">op</span><span class="op" id="5370779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370783">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370791">case</span>&nbsp;<span class="op" id="5370796">*</span><span class="ident" id="5370797">image</span><span class="op" id="5370802">.</span><span class="ident" id="5370803">Paletted</span><span class="op" id="5370811">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370815">if</span>&nbsp;<span class="ident" id="5370818">op</span>&nbsp;<span class="op" id="5370821">==</span>&nbsp;<span class="ident" id="5370824">Src</span>&nbsp;<span class="op" id="5370828">&amp;&amp;</span>&nbsp;<span class="ident" id="5370831">mask</span>&nbsp;<span class="op" id="5370836">==</span>&nbsp;<span class="ident" id="5370839">nil</span>&nbsp;<span class="op" id="5370843">&amp;&amp;</span>&nbsp;<span class="op" id="5370846">!</span><span class="ident" id="5370847">processBackward</span><span class="op" id="5370862">(</span><span class="ident" id="5370863">dst</span><span class="op" id="5370866">,</span>&nbsp;<span class="ident" id="5370868">r</span><span class="op" id="5370869">,</span>&nbsp;<span class="ident" id="5370871">src</span><span class="op" id="5370874">,</span>&nbsp;<span class="ident" id="5370876">sp</span><span class="op" id="5370878">)</span>&nbsp;<span class="op" id="5370880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370885">drawPaletted</span><span class="op" id="5370897">(</span><span class="ident" id="5370898">dst0</span><span class="op" id="5370902">,</span>&nbsp;<span class="ident" id="5370904">r</span><span class="op" id="5370905">,</span>&nbsp;<span class="ident" id="5370907">src</span><span class="op" id="5370910">,</span>&nbsp;<span class="ident" id="5370912">sp</span><span class="op" id="5370914">,</span>&nbsp;<span class="builtintype" id="5370916">false</span><span class="op" id="5370921">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370932">x0</span><span class="op" id="5370934">,</span>&nbsp;<span class="ident" id="5370936">x1</span><span class="op" id="5370938">,</span>&nbsp;<span class="ident" id="5370940">dx</span>&nbsp;<span class="op" id="5370943">:=</span>&nbsp;<span class="ident" id="5370946">r</span><span class="op" id="5370947">.</span><span class="ident" id="5370948">Min</span><span class="op" id="5370951">.</span><span class="ident" id="5370952">X</span><span class="op" id="5370953">,</span>&nbsp;<span class="ident" id="5370955">r</span><span class="op" id="5370956">.</span><span class="ident" id="5370957">Max</span><span class="op" id="5370960">.</span><span class="ident" id="5370961">X</span><span class="op" id="5370962">,</span>&nbsp;<span class="num" id="5370964">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370967">y0</span><span class="op" id="5370969">,</span>&nbsp;<span class="ident" id="5370971">y1</span><span class="op" id="5370973">,</span>&nbsp;<span class="ident" id="5370975">dy</span>&nbsp;<span class="op" id="5370978">:=</span>&nbsp;<span class="ident" id="5370981">r</span><span class="op" id="5370982">.</span><span class="ident" id="5370983">Min</span><span class="op" id="5370986">.</span><span class="ident" id="5370987">Y</span><span class="op" id="5370988">,</span>&nbsp;<span class="ident" id="5370990">r</span><span class="op" id="5370991">.</span><span class="ident" id="5370992">Max</span><span class="op" id="5370995">.</span><span class="ident" id="5370996">Y</span><span class="op" id="5370997">,</span>&nbsp;<span class="num" id="5370999">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371002">if</span>&nbsp;<span class="ident" id="5371005">processBackward</span><span class="op" id="5371020">(</span><span class="ident" id="5371021">dst</span><span class="op" id="5371024">,</span>&nbsp;<span class="ident" id="5371026">r</span><span class="op" id="5371027">,</span>&nbsp;<span class="ident" id="5371029">src</span><span class="op" id="5371032">,</span>&nbsp;<span class="ident" id="5371034">sp</span><span class="op" id="5371036">)</span>&nbsp;<span class="op" id="5371038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371042">x0</span><span class="op" id="5371044">,</span>&nbsp;<span class="ident" id="5371046">x1</span><span class="op" id="5371048">,</span>&nbsp;<span class="ident" id="5371050">dx</span>&nbsp;<span class="op" id="5371053">=</span>&nbsp;<span class="ident" id="5371055">x1</span><span class="op" id="5371057">-</span><span class="num" id="5371058">1</span><span class="op" id="5371059">,</span>&nbsp;<span class="ident" id="5371061">x0</span><span class="op" id="5371063">-</span><span class="num" id="5371064">1</span><span class="op" id="5371065">,</span>&nbsp;<span class="op" id="5371067">-</span><span class="num" id="5371068">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371072">y0</span><span class="op" id="5371074">,</span>&nbsp;<span class="ident" id="5371076">y1</span><span class="op" id="5371078">,</span>&nbsp;<span class="ident" id="5371080">dy</span>&nbsp;<span class="op" id="5371083">=</span>&nbsp;<span class="ident" id="5371085">y1</span><span class="op" id="5371087">-</span><span class="num" id="5371088">1</span><span class="op" id="5371089">,</span>&nbsp;<span class="ident" id="5371091">y0</span><span class="op" id="5371093">-</span><span class="num" id="5371094">1</span><span class="op" id="5371095">,</span>&nbsp;<span class="op" id="5371097">-</span><span class="num" id="5371098">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371105">var</span>&nbsp;<span class="ident" id="5371109">out</span>&nbsp;<span class="ident" id="5371113">color</span><span class="op" id="5371118">.</span><span class="ident" id="5371119">RGBA64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371127">sy</span>&nbsp;<span class="op" id="5371130">:=</span>&nbsp;<span class="ident" id="5371133">sp</span><span class="op" id="5371135">.</span><span class="ident" id="5371136">Y</span>&nbsp;<span class="op" id="5371138">+</span>&nbsp;<span class="ident" id="5371140">y0</span>&nbsp;<span class="op" id="5371143">-</span>&nbsp;<span class="ident" id="5371145">r</span><span class="op" id="5371146">.</span><span class="ident" id="5371147">Min</span><span class="op" id="5371150">.</span><span class="ident" id="5371151">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371154">my</span>&nbsp;<span class="op" id="5371157">:=</span>&nbsp;<span class="ident" id="5371160">mp</span><span class="op" id="5371162">.</span><span class="ident" id="5371163">Y</span>&nbsp;<span class="op" id="5371165">+</span>&nbsp;<span class="ident" id="5371167">y0</span>&nbsp;<span class="op" id="5371170">-</span>&nbsp;<span class="ident" id="5371172">r</span><span class="op" id="5371173">.</span><span class="ident" id="5371174">Min</span><span class="op" id="5371177">.</span><span class="ident" id="5371178">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371181">for</span>&nbsp;<span class="ident" id="5371185">y</span>&nbsp;<span class="op" id="5371187">:=</span>&nbsp;<span class="ident" id="5371190">y0</span><span class="op" id="5371192">;</span>&nbsp;<span class="ident" id="5371194">y</span>&nbsp;<span class="op" id="5371196">!=</span>&nbsp;<span class="ident" id="5371199">y1</span><span class="op" id="5371201">;</span>&nbsp;<span class="ident" id="5371203">y</span><span class="op" id="5371204">,</span>&nbsp;<span class="ident" id="5371206">sy</span><span class="op" id="5371208">,</span>&nbsp;<span class="ident" id="5371210">my</span>&nbsp;<span class="op" id="5371213">=</span>&nbsp;<span class="ident" id="5371215">y</span><span class="op" id="5371216">+</span><span class="ident" id="5371217">dy</span><span class="op" id="5371219">,</span>&nbsp;<span class="ident" id="5371221">sy</span><span class="op" id="5371223">+</span><span class="ident" id="5371224">dy</span><span class="op" id="5371226">,</span>&nbsp;<span class="ident" id="5371228">my</span><span class="op" id="5371230">+</span><span class="ident" id="5371231">dy</span>&nbsp;<span class="op" id="5371234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371238">sx</span>&nbsp;<span class="op" id="5371241">:=</span>&nbsp;<span class="ident" id="5371244">sp</span><span class="op" id="5371246">.</span><span class="ident" id="5371247">X</span>&nbsp;<span class="op" id="5371249">+</span>&nbsp;<span class="ident" id="5371251">x0</span>&nbsp;<span class="op" id="5371254">-</span>&nbsp;<span class="ident" id="5371256">r</span><span class="op" id="5371257">.</span><span class="ident" id="5371258">Min</span><span class="op" id="5371261">.</span><span class="ident" id="5371262">X</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371266">mx</span>&nbsp;<span class="op" id="5371269">:=</span>&nbsp;<span class="ident" id="5371272">mp</span><span class="op" id="5371274">.</span><span class="ident" id="5371275">X</span>&nbsp;<span class="op" id="5371277">+</span>&nbsp;<span class="ident" id="5371279">x0</span>&nbsp;<span class="op" id="5371282">-</span>&nbsp;<span class="ident" id="5371284">r</span><span class="op" id="5371285">.</span><span class="ident" id="5371286">Min</span><span class="op" id="5371289">.</span><span class="ident" id="5371290">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371294">for</span>&nbsp;<span class="ident" id="5371298">x</span>&nbsp;<span class="op" id="5371300">:=</span>&nbsp;<span class="ident" id="5371303">x0</span><span class="op" id="5371305">;</span>&nbsp;<span class="ident" id="5371307">x</span>&nbsp;<span class="op" id="5371309">!=</span>&nbsp;<span class="ident" id="5371312">x1</span><span class="op" id="5371314">;</span>&nbsp;<span class="ident" id="5371316">x</span><span class="op" id="5371317">,</span>&nbsp;<span class="ident" id="5371319">sx</span><span class="op" id="5371321">,</span>&nbsp;<span class="ident" id="5371323">mx</span>&nbsp;<span class="op" id="5371326">=</span>&nbsp;<span class="ident" id="5371328">x</span><span class="op" id="5371329">+</span><span class="ident" id="5371330">dx</span><span class="op" id="5371332">,</span>&nbsp;<span class="ident" id="5371334">sx</span><span class="op" id="5371336">+</span><span class="ident" id="5371337">dx</span><span class="op" id="5371339">,</span>&nbsp;<span class="ident" id="5371341">mx</span><span class="op" id="5371343">+</span><span class="ident" id="5371344">dx</span>&nbsp;<span class="op" id="5371347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371352">ma</span>&nbsp;<span class="op" id="5371355">:=</span>&nbsp;<span class="builtintype" id="5371358">uint32</span><span class="op" id="5371364">(</span><span class="ident" id="5371365">m</span><span class="op" id="5371366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371371">if</span>&nbsp;<span class="ident" id="5371374">mask</span>&nbsp;<span class="op" id="5371379">!=</span>&nbsp;<span class="ident" id="5371382">nil</span>&nbsp;<span class="op" id="5371386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371392">_</span><span class="op" id="5371393">,</span>&nbsp;<span class="ident" id="5371395">_</span><span class="op" id="5371396">,</span>&nbsp;<span class="ident" id="5371398">_</span><span class="op" id="5371399">,</span>&nbsp;<span class="ident" id="5371401">ma</span>&nbsp;<span class="op" id="5371404">=</span>&nbsp;<span class="ident" id="5371406">mask</span><span class="op" id="5371410">.</span><span class="ident" id="5371411">At</span><span class="op" id="5371413">(</span><span class="ident" id="5371414">mx</span><span class="op" id="5371416">,</span>&nbsp;<span class="ident" id="5371418">my</span><span class="op" id="5371420">)</span><span class="op" id="5371421">.</span><span class="ident" id="5371422">RGBA</span><span class="op" id="5371426">(</span><span class="op" id="5371427">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371437">switch</span>&nbsp;<span class="op" id="5371444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371449">case</span>&nbsp;<span class="ident" id="5371454">ma</span>&nbsp;<span class="op" id="5371457">==</span>&nbsp;<span class="num" id="5371460">0</span><span class="op" id="5371461">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371467">if</span>&nbsp;<span class="ident" id="5371470">op</span>&nbsp;<span class="op" id="5371473">==</span>&nbsp;<span class="ident" id="5371476">Over</span>&nbsp;<span class="op" id="5371481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371488">//&nbsp;No-op.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371502">}</span>&nbsp;<span class="keyword" id="5371504">else</span>&nbsp;<span class="op" id="5371509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371516">dst</span><span class="op" id="5371519">.</span><span class="ident" id="5371520">Set</span><span class="op" id="5371523">(</span><span class="ident" id="5371524">x</span><span class="op" id="5371525">,</span>&nbsp;<span class="ident" id="5371527">y</span><span class="op" id="5371528">,</span>&nbsp;<span class="ident" id="5371530">color</span><span class="op" id="5371535">.</span><span class="ident" id="5371536">Transparent</span><span class="op" id="5371547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371558">case</span>&nbsp;<span class="ident" id="5371563">ma</span>&nbsp;<span class="op" id="5371566">==</span>&nbsp;<span class="ident" id="5371569">m</span>&nbsp;<span class="op" id="5371571">&amp;&amp;</span>&nbsp;<span class="ident" id="5371574">op</span>&nbsp;<span class="op" id="5371577">==</span>&nbsp;<span class="ident" id="5371580">Src</span><span class="op" id="5371583">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371589">dst</span><span class="op" id="5371592">.</span><span class="ident" id="5371593">Set</span><span class="op" id="5371596">(</span><span class="ident" id="5371597">x</span><span class="op" id="5371598">,</span>&nbsp;<span class="ident" id="5371600">y</span><span class="op" id="5371601">,</span>&nbsp;<span class="ident" id="5371603">src</span><span class="op" id="5371606">.</span><span class="ident" id="5371607">At</span><span class="op" id="5371609">(</span><span class="ident" id="5371610">sx</span><span class="op" id="5371612">,</span>&nbsp;<span class="ident" id="5371614">sy</span><span class="op" id="5371616">)</span><span class="op" id="5371617">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371622">default</span><span class="op" id="5371629">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371635">sr</span><span class="op" id="5371637">,</span>&nbsp;<span class="ident" id="5371639">sg</span><span class="op" id="5371641">,</span>&nbsp;<span class="ident" id="5371643">sb</span><span class="op" id="5371645">,</span>&nbsp;<span class="ident" id="5371647">sa</span>&nbsp;<span class="op" id="5371650">:=</span>&nbsp;<span class="ident" id="5371653">src</span><span class="op" id="5371656">.</span><span class="ident" id="5371657">At</span><span class="op" id="5371659">(</span><span class="ident" id="5371660">sx</span><span class="op" id="5371662">,</span>&nbsp;<span class="ident" id="5371664">sy</span><span class="op" id="5371666">)</span><span class="op" id="5371667">.</span><span class="ident" id="5371668">RGBA</span><span class="op" id="5371672">(</span><span class="op" id="5371673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371679">if</span>&nbsp;<span class="ident" id="5371682">op</span>&nbsp;<span class="op" id="5371685">==</span>&nbsp;<span class="ident" id="5371688">Over</span>&nbsp;<span class="op" id="5371693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371700">dr</span><span class="op" id="5371702">,</span>&nbsp;<span class="ident" id="5371704">dg</span><span class="op" id="5371706">,</span>&nbsp;<span class="ident" id="5371708">db</span><span class="op" id="5371710">,</span>&nbsp;<span class="ident" id="5371712">da</span>&nbsp;<span class="op" id="5371715">:=</span>&nbsp;<span class="ident" id="5371718">dst</span><span class="op" id="5371721">.</span><span class="ident" id="5371722">At</span><span class="op" id="5371724">(</span><span class="ident" id="5371725">x</span><span class="op" id="5371726">,</span>&nbsp;<span class="ident" id="5371728">y</span><span class="op" id="5371729">)</span><span class="op" id="5371730">.</span><span class="ident" id="5371731">RGBA</span><span class="op" id="5371735">(</span><span class="op" id="5371736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371743">a</span>&nbsp;<span class="op" id="5371745">:=</span>&nbsp;<span class="ident" id="5371748">m</span>&nbsp;<span class="op" id="5371750">-</span>&nbsp;<span class="op" id="5371752">(</span><span class="ident" id="5371753">sa</span>&nbsp;<span class="op" id="5371756">*</span>&nbsp;<span class="ident" id="5371758">ma</span>&nbsp;<span class="op" id="5371761">/</span>&nbsp;<span class="ident" id="5371763">m</span><span class="op" id="5371764">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371771">out</span><span class="op" id="5371774">.</span><span class="ident" id="5371775">R</span>&nbsp;<span class="op" id="5371777">=</span>&nbsp;<span class="builtintype" id="5371779">uint16</span><span class="op" id="5371785">(</span><span class="op" id="5371786">(</span><span class="ident" id="5371787">dr</span><span class="op" id="5371789">*</span><span class="ident" id="5371790">a</span>&nbsp;<span class="op" id="5371792">+</span>&nbsp;<span class="ident" id="5371794">sr</span><span class="op" id="5371796">*</span><span class="ident" id="5371797">ma</span><span class="op" id="5371799">)</span>&nbsp;<span class="op" id="5371801">/</span>&nbsp;<span class="ident" id="5371803">m</span><span class="op" id="5371804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371811">out</span><span class="op" id="5371814">.</span><span class="ident" id="5371815">G</span>&nbsp;<span class="op" id="5371817">=</span>&nbsp;<span class="builtintype" id="5371819">uint16</span><span class="op" id="5371825">(</span><span class="op" id="5371826">(</span><span class="ident" id="5371827">dg</span><span class="op" id="5371829">*</span><span class="ident" id="5371830">a</span>&nbsp;<span class="op" id="5371832">+</span>&nbsp;<span class="ident" id="5371834">sg</span><span class="op" id="5371836">*</span><span class="ident" id="5371837">ma</span><span class="op" id="5371839">)</span>&nbsp;<span class="op" id="5371841">/</span>&nbsp;<span class="ident" id="5371843">m</span><span class="op" id="5371844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371851">out</span><span class="op" id="5371854">.</span><span class="ident" id="5371855">B</span>&nbsp;<span class="op" id="5371857">=</span>&nbsp;<span class="builtintype" id="5371859">uint16</span><span class="op" id="5371865">(</span><span class="op" id="5371866">(</span><span class="ident" id="5371867">db</span><span class="op" id="5371869">*</span><span class="ident" id="5371870">a</span>&nbsp;<span class="op" id="5371872">+</span>&nbsp;<span class="ident" id="5371874">sb</span><span class="op" id="5371876">*</span><span class="ident" id="5371877">ma</span><span class="op" id="5371879">)</span>&nbsp;<span class="op" id="5371881">/</span>&nbsp;<span class="ident" id="5371883">m</span><span class="op" id="5371884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371891">out</span><span class="op" id="5371894">.</span><span class="ident" id="5371895">A</span>&nbsp;<span class="op" id="5371897">=</span>&nbsp;<span class="builtintype" id="5371899">uint16</span><span class="op" id="5371905">(</span><span class="op" id="5371906">(</span><span class="ident" id="5371907">da</span><span class="op" id="5371909">*</span><span class="ident" id="5371910">a</span>&nbsp;<span class="op" id="5371912">+</span>&nbsp;<span class="ident" id="5371914">sa</span><span class="op" id="5371916">*</span><span class="ident" id="5371917">ma</span><span class="op" id="5371919">)</span>&nbsp;<span class="op" id="5371921">/</span>&nbsp;<span class="ident" id="5371923">m</span><span class="op" id="5371924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371930">}</span>&nbsp;<span class="keyword" id="5371932">else</span>&nbsp;<span class="op" id="5371937">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371944">out</span><span class="op" id="5371947">.</span><span class="ident" id="5371948">R</span>&nbsp;<span class="op" id="5371950">=</span>&nbsp;<span class="builtintype" id="5371952">uint16</span><span class="op" id="5371958">(</span><span class="ident" id="5371959">sr</span>&nbsp;<span class="op" id="5371962">*</span>&nbsp;<span class="ident" id="5371964">ma</span>&nbsp;<span class="op" id="5371967">/</span>&nbsp;<span class="ident" id="5371969">m</span><span class="op" id="5371970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371977">out</span><span class="op" id="5371980">.</span><span class="ident" id="5371981">G</span>&nbsp;<span class="op" id="5371983">=</span>&nbsp;<span class="builtintype" id="5371985">uint16</span><span class="op" id="5371991">(</span><span class="ident" id="5371992">sg</span>&nbsp;<span class="op" id="5371995">*</span>&nbsp;<span class="ident" id="5371997">ma</span>&nbsp;<span class="op" id="5372000">/</span>&nbsp;<span class="ident" id="5372002">m</span><span class="op" id="5372003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372010">out</span><span class="op" id="5372013">.</span><span class="ident" id="5372014">B</span>&nbsp;<span class="op" id="5372016">=</span>&nbsp;<span class="builtintype" id="5372018">uint16</span><span class="op" id="5372024">(</span><span class="ident" id="5372025">sb</span>&nbsp;<span class="op" id="5372028">*</span>&nbsp;<span class="ident" id="5372030">ma</span>&nbsp;<span class="op" id="5372033">/</span>&nbsp;<span class="ident" id="5372035">m</span><span class="op" id="5372036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372043">out</span><span class="op" id="5372046">.</span><span class="ident" id="5372047">A</span>&nbsp;<span class="op" id="5372049">=</span>&nbsp;<span class="builtintype" id="5372051">uint16</span><span class="op" id="5372057">(</span><span class="ident" id="5372058">sa</span>&nbsp;<span class="op" id="5372061">*</span>&nbsp;<span class="ident" id="5372063">ma</span>&nbsp;<span class="op" id="5372066">/</span>&nbsp;<span class="ident" id="5372068">m</span><span class="op" id="5372069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372075">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372081">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372142">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372207">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372270">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372331">dst</span><span class="op" id="5372334">.</span><span class="ident" id="5372335">Set</span><span class="op" id="5372338">(</span><span class="ident" id="5372339">x</span><span class="op" id="5372340">,</span>&nbsp;<span class="ident" id="5372342">y</span><span class="op" id="5372343">,</span>&nbsp;<span class="op" id="5372345">&amp;</span><span class="ident" id="5372346">out</span><span class="op" id="5372349">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372361">}</span><br>
<span class="lineno"></span><span class="op" id="5372363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="5372366">func</span>&nbsp;<span class="ident" id="5372371">drawFillOver</span><span class="op" id="5372383">(</span><span class="ident" id="5372384">dst</span>&nbsp;<span class="op" id="5372388">*</span><span class="ident" id="5372389">image</span><span class="op" id="5372394">.</span><span class="ident" id="5372395">RGBA</span><span class="op" id="5372399">,</span>&nbsp;<span class="ident" id="5372401">r</span>&nbsp;<span class="ident" id="5372403">image</span><span class="op" id="5372408">.</span><span class="ident" id="5372409">Rectangle</span><span class="op" id="5372418">,</span>&nbsp;<span class="ident" id="5372420">src</span>&nbsp;<span class="op" id="5372424">*</span><span class="ident" id="5372425">image</span><span class="op" id="5372430">.</span><span class="ident" id="5372431">Uniform</span><span class="op" id="5372438">)</span>&nbsp;<span class="op" id="5372440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372443">sr</span><span class="op" id="5372445">,</span>&nbsp;<span class="ident" id="5372447">sg</span><span class="op" id="5372449">,</span>&nbsp;<span class="ident" id="5372451">sb</span><span class="op" id="5372453">,</span>&nbsp;<span class="ident" id="5372455">sa</span>&nbsp;<span class="op" id="5372458">:=</span>&nbsp;<span class="ident" id="5372461">src</span><span class="op" id="5372464">.</span><span class="ident" id="5372465">RGBA</span><span class="op" id="5372469">(</span><span class="op" id="5372470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372473">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372531">a</span>&nbsp;<span class="op" id="5372533">:=</span>&nbsp;<span class="op" id="5372536">(</span><span class="ident" id="5372537">m</span>&nbsp;<span class="op" id="5372539">-</span>&nbsp;<span class="ident" id="5372541">sa</span><span class="op" id="5372543">)</span>&nbsp;<span class="op" id="5372545">*</span>&nbsp;<span class="num" id="5372547">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372554">i0</span>&nbsp;<span class="op" id="5372557">:=</span>&nbsp;<span class="ident" id="5372560">dst</span><span class="op" id="5372563">.</span><span class="ident" id="5372564">PixOffset</span><span class="op" id="5372573">(</span><span class="ident" id="5372574">r</span><span class="op" id="5372575">.</span><span class="ident" id="5372576">Min</span><span class="op" id="5372579">.</span><span class="ident" id="5372580">X</span><span class="op" id="5372581">,</span>&nbsp;<span class="ident" id="5372583">r</span><span class="op" id="5372584">.</span><span class="ident" id="5372585">Min</span><span class="op" id="5372588">.</span><span class="ident" id="5372589">Y</span><span class="op" id="5372590">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372593">i1</span>&nbsp;<span class="op" id="5372596">:=</span>&nbsp;<span class="ident" id="5372599">i0</span>&nbsp;<span class="op" id="5372602">+</span>&nbsp;<span class="ident" id="5372604">r</span><span class="op" id="5372605">.</span><span class="ident" id="5372606">Dx</span><span class="op" id="5372608">(</span><span class="op" id="5372609">)</span><span class="op" id="5372610">*</span><span class="num" id="5372611">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372614">for</span>&nbsp;<span class="ident" id="5372618">y</span>&nbsp;<span class="op" id="5372620">:=</span>&nbsp;<span class="ident" id="5372623">r</span><span class="op" id="5372624">.</span><span class="ident" id="5372625">Min</span><span class="op" id="5372628">.</span><span class="ident" id="5372629">Y</span><span class="op" id="5372630">;</span>&nbsp;<span class="ident" id="5372632">y</span>&nbsp;<span class="op" id="5372634">!=</span>&nbsp;<span class="ident" id="5372637">r</span><span class="op" id="5372638">.</span><span class="ident" id="5372639">Max</span><span class="op" id="5372642">.</span><span class="ident" id="5372643">Y</span><span class="op" id="5372644">;</span>&nbsp;<span class="ident" id="5372646">y</span><span class="op" id="5372647">++</span>&nbsp;<span class="op" id="5372650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372654">for</span>&nbsp;<span class="ident" id="5372658">i</span>&nbsp;<span class="op" id="5372660">:=</span>&nbsp;<span class="ident" id="5372663">i0</span><span class="op" id="5372665">;</span>&nbsp;<span class="ident" id="5372667">i</span>&nbsp;<span class="op" id="5372669">&lt;</span>&nbsp;<span class="ident" id="5372671">i1</span><span class="op" id="5372673">;</span>&nbsp;<span class="ident" id="5372675">i</span>&nbsp;<span class="op" id="5372677">+=</span>&nbsp;<span class="num" id="5372680">4</span>&nbsp;<span class="op" id="5372682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372687">dr</span>&nbsp;<span class="op" id="5372690">:=</span>&nbsp;<span class="builtintype" id="5372693">uint32</span><span class="op" id="5372699">(</span><span class="ident" id="5372700">dst</span><span class="op" id="5372703">.</span><span class="ident" id="5372704">Pix</span><span class="op" id="5372707">[</span><span class="ident" id="5372708">i</span><span class="op" id="5372709">+</span><span class="num" id="5372710">0</span><span class="op" id="5372711">]</span><span class="op" id="5372712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372717">dg</span>&nbsp;<span class="op" id="5372720">:=</span>&nbsp;<span class="builtintype" id="5372723">uint32</span><span class="op" id="5372729">(</span><span class="ident" id="5372730">dst</span><span class="op" id="5372733">.</span><span class="ident" id="5372734">Pix</span><span class="op" id="5372737">[</span><span class="ident" id="5372738">i</span><span class="op" id="5372739">+</span><span class="num" id="5372740">1</span><span class="op" id="5372741">]</span><span class="op" id="5372742">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372747">db</span>&nbsp;<span class="op" id="5372750">:=</span>&nbsp;<span class="builtintype" id="5372753">uint32</span><span class="op" id="5372759">(</span><span class="ident" id="5372760">dst</span><span class="op" id="5372763">.</span><span class="ident" id="5372764">Pix</span><span class="op" id="5372767">[</span><span class="ident" id="5372768">i</span><span class="op" id="5372769">+</span><span class="num" id="5372770">2</span><span class="op" id="5372771">]</span><span class="op" id="5372772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372777">da</span>&nbsp;<span class="op" id="5372780">:=</span>&nbsp;<span class="builtintype" id="5372783">uint32</span><span class="op" id="5372789">(</span><span class="ident" id="5372790">dst</span><span class="op" id="5372793">.</span><span class="ident" id="5372794">Pix</span><span class="op" id="5372797">[</span><span class="ident" id="5372798">i</span><span class="op" id="5372799">+</span><span class="num" id="5372800">3</span><span class="op" id="5372801">]</span><span class="op" id="5372802">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372808">dst</span><span class="op" id="5372811">.</span><span class="ident" id="5372812">Pix</span><span class="op" id="5372815">[</span><span class="ident" id="5372816">i</span><span class="op" id="5372817">+</span><span class="num" id="5372818">0</span><span class="op" id="5372819">]</span>&nbsp;<span class="op" id="5372821">=</span>&nbsp;<span class="builtintype" id="5372823">uint8</span><span class="op" id="5372828">(</span><span class="op" id="5372829">(</span><span class="ident" id="5372830">dr</span><span class="op" id="5372832">*</span><span class="ident" id="5372833">a</span><span class="op" id="5372834">/</span><span class="ident" id="5372835">m</span>&nbsp;<span class="op" id="5372837">+</span>&nbsp;<span class="ident" id="5372839">sr</span><span class="op" id="5372841">)</span>&nbsp;<span class="op" id="5372843">&gt;&gt;</span>&nbsp;<span class="num" id="5372846">8</span><span class="op" id="5372847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372852">dst</span><span class="op" id="5372855">.</span><span class="ident" id="5372856">Pix</span><span class="op" id="5372859">[</span><span class="ident" id="5372860">i</span><span class="op" id="5372861">+</span><span class="num" id="5372862">1</span><span class="op" id="5372863">]</span>&nbsp;<span class="op" id="5372865">=</span>&nbsp;<span class="builtintype" id="5372867">uint8</span><span class="op" id="5372872">(</span><span class="op" id="5372873">(</span><span class="ident" id="5372874">dg</span><span class="op" id="5372876">*</span><span class="ident" id="5372877">a</span><span class="op" id="5372878">/</span><span class="ident" id="5372879">m</span>&nbsp;<span class="op" id="5372881">+</span>&nbsp;<span class="ident" id="5372883">sg</span><span class="op" id="5372885">)</span>&nbsp;<span class="op" id="5372887">&gt;&gt;</span>&nbsp;<span class="num" id="5372890">8</span><span class="op" id="5372891">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372896">dst</span><span class="op" id="5372899">.</span><span class="ident" id="5372900">Pix</span><span class="op" id="5372903">[</span><span class="ident" id="5372904">i</span><span class="op" id="5372905">+</span><span class="num" id="5372906">2</span><span class="op" id="5372907">]</span>&nbsp;<span class="op" id="5372909">=</span>&nbsp;<span class="builtintype" id="5372911">uint8</span><span class="op" id="5372916">(</span><span class="op" id="5372917">(</span><span class="ident" id="5372918">db</span><span class="op" id="5372920">*</span><span class="ident" id="5372921">a</span><span class="op" id="5372922">/</span><span class="ident" id="5372923">m</span>&nbsp;<span class="op" id="5372925">+</span>&nbsp;<span class="ident" id="5372927">sb</span><span class="op" id="5372929">)</span>&nbsp;<span class="op" id="5372931">&gt;&gt;</span>&nbsp;<span class="num" id="5372934">8</span><span class="op" id="5372935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372940">dst</span><span class="op" id="5372943">.</span><span class="ident" id="5372944">Pix</span><span class="op" id="5372947">[</span><span class="ident" id="5372948">i</span><span class="op" id="5372949">+</span><span class="num" id="5372950">3</span><span class="op" id="5372951">]</span>&nbsp;<span class="op" id="5372953">=</span>&nbsp;<span class="builtintype" id="5372955">uint8</span><span class="op" id="5372960">(</span><span class="op" id="5372961">(</span><span class="ident" id="5372962">da</span><span class="op" id="5372964">*</span><span class="ident" id="5372965">a</span><span class="op" id="5372966">/</span><span class="ident" id="5372967">m</span>&nbsp;<span class="op" id="5372969">+</span>&nbsp;<span class="ident" id="5372971">sa</span><span class="op" id="5372973">)</span>&nbsp;<span class="op" id="5372975">&gt;&gt;</span>&nbsp;<span class="num" id="5372978">8</span><span class="op" id="5372979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372987">i0</span>&nbsp;<span class="op" id="5372990">+=</span>&nbsp;<span class="ident" id="5372993">dst</span><span class="op" id="5372996">.</span><span class="ident" id="5372997">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373006">i1</span>&nbsp;<span class="op" id="5373009">+=</span>&nbsp;<span class="ident" id="5373012">dst</span><span class="op" id="5373015">.</span><span class="ident" id="5373016">Stride</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373024">}</span><br>
<span class="lineno"></span><span class="op" id="5373026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5373029">func</span>&nbsp;<span class="ident" id="5373034">drawFillSrc</span><span class="op" id="5373045">(</span><span class="ident" id="5373046">dst</span>&nbsp;<span class="op" id="5373050">*</span><span class="ident" id="5373051">image</span><span class="op" id="5373056">.</span><span class="ident" id="5373057">RGBA</span><span class="op" id="5373061">,</span>&nbsp;<span class="ident" id="5373063">r</span>&nbsp;<span class="ident" id="5373065">image</span><span class="op" id="5373070">.</span><span class="ident" id="5373071">Rectangle</span><span class="op" id="5373080">,</span>&nbsp;<span class="ident" id="5373082">src</span>&nbsp;<span class="op" id="5373086">*</span><span class="ident" id="5373087">image</span><span class="op" id="5373092">.</span><span class="ident" id="5373093">Uniform</span><span class="op" id="5373100">)</span>&nbsp;<span class="op" id="5373102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373105">sr</span><span class="op" id="5373107">,</span>&nbsp;<span class="ident" id="5373109">sg</span><span class="op" id="5373111">,</span>&nbsp;<span class="ident" id="5373113">sb</span><span class="op" id="5373115">,</span>&nbsp;<span class="ident" id="5373117">sa</span>&nbsp;<span class="op" id="5373120">:=</span>&nbsp;<span class="ident" id="5373123">src</span><span class="op" id="5373126">.</span><span class="ident" id="5373127">RGBA</span><span class="op" id="5373131">(</span><span class="op" id="5373132">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5373135">//&nbsp;The&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;is&nbsp;faster&nbsp;than&nbsp;a&nbsp;straightforward&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;destination&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5373237">//&nbsp;the&nbsp;color,&nbsp;but&nbsp;copy&nbsp;requires&nbsp;a&nbsp;slice&nbsp;source.&nbsp;We&nbsp;therefore&nbsp;use&nbsp;a&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;first&nbsp;row,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5373341">//&nbsp;then&nbsp;use&nbsp;the&nbsp;first&nbsp;row&nbsp;as&nbsp;the&nbsp;slice&nbsp;source&nbsp;for&nbsp;the&nbsp;remaining&nbsp;rows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373412">i0</span>&nbsp;<span class="op" id="5373415">:=</span>&nbsp;<span class="ident" id="5373418">dst</span><span class="op" id="5373421">.</span><span class="ident" id="5373422">PixOffset</span><span class="op" id="5373431">(</span><span class="ident" id="5373432">r</span><span class="op" id="5373433">.</span><span class="ident" id="5373434">Min</span><span class="op" id="5373437">.</span><span class="ident" id="5373438">X</span><span class="op" id="5373439">,</span>&nbsp;<span class="ident" id="5373441">r</span><span class="op" id="5373442">.</span><span class="ident" id="5373443">Min</span><span class="op" id="5373446">.</span><span class="ident" id="5373447">Y</span><span class="op" id="5373448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373451">i1</span>&nbsp;<span class="op" id="5373454">:=</span>&nbsp;<span class="ident" id="5373457">i0</span>&nbsp;<span class="op" id="5373460">+</span>&nbsp;<span class="ident" id="5373462">r</span><span class="op" id="5373463">.</span><span class="ident" id="5373464">Dx</span><span class="op" id="5373466">(</span><span class="op" id="5373467">)</span><span class="op" id="5373468">*</span><span class="num" id="5373469">4</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373472">for</span>&nbsp;<span class="ident" id="5373476">i</span>&nbsp;<span class="op" id="5373478">:=</span>&nbsp;<span class="ident" id="5373481">i0</span><span class="op" id="5373483">;</span>&nbsp;<span class="ident" id="5373485">i</span>&nbsp;<span class="op" id="5373487">&lt;</span>&nbsp;<span class="ident" id="5373489">i1</span><span class="op" id="5373491">;</span>&nbsp;<span class="ident" id="5373493">i</span>&nbsp;<span class="op" id="5373495">+=</span>&nbsp;<span class="num" id="5373498">4</span>&nbsp;<span class="op" id="5373500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373504">dst</span><span class="op" id="5373507">.</span><span class="ident" id="5373508">Pix</span><span class="op" id="5373511">[</span><span class="ident" id="5373512">i</span><span class="op" id="5373513">+</span><span class="num" id="5373514">0</span><span class="op" id="5373515">]</span>&nbsp;<span class="op" id="5373517">=</span>&nbsp;<span class="builtintype" id="5373519">uint8</span><span class="op" id="5373524">(</span><span class="ident" id="5373525">sr</span>&nbsp;<span class="op" id="5373528">&gt;&gt;</span>&nbsp;<span class="num" id="5373531">8</span><span class="op" id="5373532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373536">dst</span><span class="op" id="5373539">.</span><span class="ident" id="5373540">Pix</span><span class="op" id="5373543">[</span><span class="ident" id="5373544">i</span><span class="op" id="5373545">+</span><span class="num" id="5373546">1</span><span class="op" id="5373547">]</span>&nbsp;<span class="op" id="5373549">=</span>&nbsp;<span class="builtintype" id="5373551">uint8</span><span class="op" id="5373556">(</span><span class="ident" id="5373557">sg</span>&nbsp;<span class="op" id="5373560">&gt;&gt;</span>&nbsp;<span class="num" id="5373563">8</span><span class="op" id="5373564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373568">dst</span><span class="op" id="5373571">.</span><span class="ident" id="5373572">Pix</span><span class="op" id="5373575">[</span><span class="ident" id="5373576">i</span><span class="op" id="5373577">+</span><span class="num" id="5373578">2</span><span class="op" id="5373579">]</span>&nbsp;<span class="op" id="5373581">=</span>&nbsp;<span class="builtintype" id="5373583">uint8</span><span class="op" id="5373588">(</span><span class="ident" id="5373589">sb</span>&nbsp;<span class="op" id="5373592">&gt;&gt;</span>&nbsp;<span class="num" id="5373595">8</span><span class="op" id="5373596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373600">dst</span><span class="op" id="5373603">.</span><span class="ident" id="5373604">Pix</span><span class="op" id="5373607">[</span><span class="ident" id="5373608">i</span><span class="op" id="5373609">+</span><span class="num" id="5373610">3</span><span class="op" id="5373611">]</span>&nbsp;<span class="op" id="5373613">=</span>&nbsp;<span class="builtintype" id="5373615">uint8</span><span class="op" id="5373620">(</span><span class="ident" id="5373621">sa</span>&nbsp;<span class="op" id="5373624">&gt;&gt;</span>&nbsp;<span class="num" id="5373627">8</span><span class="op" id="5373628">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373634">firstRow</span>&nbsp;<span class="op" id="5373643">:=</span>&nbsp;<span class="ident" id="5373646">dst</span><span class="op" id="5373649">.</span><span class="ident" id="5373650">Pix</span><span class="op" id="5373653">[</span><span class="ident" id="5373654">i0</span><span class="op" id="5373656">:</span><span class="ident" id="5373657">i1</span><span class="op" id="5373659">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373662">for</span>&nbsp;<span class="ident" id="5373666">y</span>&nbsp;<span class="op" id="5373668">:=</span>&nbsp;<span class="ident" id="5373671">r</span><span class="op" id="5373672">.</span><span class="ident" id="5373673">Min</span><span class="op" id="5373676">.</span><span class="ident" id="5373677">Y</span>&nbsp;<span class="op" id="5373679">+</span>&nbsp;<span class="num" id="5373681">1</span><span class="op" id="5373682">;</span>&nbsp;<span class="ident" id="5373684">y</span>&nbsp;<span class="op" id="5373686">&lt;</span>&nbsp;<span class="ident" id="5373688">r</span><span class="op" id="5373689">.</span><span class="ident" id="5373690">Max</span><span class="op" id="5373693">.</span><span class="ident" id="5373694">Y</span><span class="op" id="5373695">;</span>&nbsp;<span class="ident" id="5373697">y</span><span class="op" id="5373698">++</span>&nbsp;<span class="op" id="5373701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373705">i0</span>&nbsp;<span class="op" id="5373708">+=</span>&nbsp;<span class="ident" id="5373711">dst</span><span class="op" id="5373714">.</span><span class="ident" id="5373715">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373724">i1</span>&nbsp;<span class="op" id="5373727">+=</span>&nbsp;<span class="ident" id="5373730">dst</span><span class="op" id="5373733">.</span><span class="ident" id="5373734">Stride</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5373743">copy</span><span class="op" id="5373747">(</span><span class="ident" id="5373748">dst</span><span class="op" id="5373751">.</span><span class="ident" id="5373752">Pix</span><span class="op" id="5373755">[</span><span class="ident" id="5373756">i0</span><span class="op" id="5373758">:</span><span class="ident" id="5373759">i1</span><span class="op" id="5373761">]</span><span class="op" id="5373762">,</span>&nbsp;<span class="ident" id="5373764">firstRow</span><span class="op" id="5373772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373775">}</span><br>
<span class="lineno"></span><span class="op" id="5373777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5373780">func</span>&nbsp;<span class="ident" id="5373785">drawCopyOver</span><span class="op" id="5373797">(</span><span class="ident" id="5373798">dst</span>&nbsp;<span class="op" id="5373802">*</span><span class="ident" id="5373803">image</span><span class="op" id="5373808">.</span><span class="ident" id="5373809">RGBA</span><span class="op" id="5373813">,</span>&nbsp;<span class="ident" id="5373815">r</span>&nbsp;<span class="ident" id="5373817">image</span><span class="op" id="5373822">.</span><span class="ident" id="5373823">Rectangle</span><span class="op" id="5373832">,</span>&nbsp;<span class="ident" id="5373834">src</span>&nbsp;<span class="op" id="5373838">*</span><span class="ident" id="5373839">image</span><span class="op" id="5373844">.</span><span class="ident" id="5373845">RGBA</span><span class="op" id="5373849">,</span>&nbsp;<span class="ident" id="5373851">sp</span>&nbsp;<span class="ident" id="5373854">image</span><span class="op" id="5373859">.</span><span class="ident" id="5373860">Point</span><span class="op" id="5373865">)</span>&nbsp;<span class="op" id="5373867">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373870">dx</span><span class="op" id="5373872">,</span>&nbsp;<span class="ident" id="5373874">dy</span>&nbsp;<span class="op" id="5373877">:=</span>&nbsp;<span class="ident" id="5373880">r</span><span class="op" id="5373881">.</span><span class="ident" id="5373882">Dx</span><span class="op" id="5373884">(</span><span class="op" id="5373885">)</span><span class="op" id="5373886">,</span>&nbsp;<span class="ident" id="5373888">r</span><span class="op" id="5373889">.</span><span class="ident" id="5373890">Dy</span><span class="op" id="5373892">(</span><span class="op" id="5373893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373896">d0</span>&nbsp;<span class="op" id="5373899">:=</span>&nbsp;<span class="ident" id="5373902">dst</span><span class="op" id="5373905">.</span><span class="ident" id="5373906">PixOffset</span><span class="op" id="5373915">(</span><span class="ident" id="5373916">r</span><span class="op" id="5373917">.</span><span class="ident" id="5373918">Min</span><span class="op" id="5373921">.</span><span class="ident" id="5373922">X</span><span class="op" id="5373923">,</span>&nbsp;<span class="ident" id="5373925">r</span><span class="op" id="5373926">.</span><span class="ident" id="5373927">Min</span><span class="op" id="5373930">.</span><span class="ident" id="5373931">Y</span><span class="op" id="5373932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373935">s0</span>&nbsp;<span class="op" id="5373938">:=</span>&nbsp;<span class="ident" id="5373941">src</span><span class="op" id="5373944">.</span><span class="ident" id="5373945">PixOffset</span><span class="op" id="5373954">(</span><span class="ident" id="5373955">sp</span><span class="op" id="5373957">.</span><span class="ident" id="5373958">X</span><span class="op" id="5373959">,</span>&nbsp;<span class="ident" id="5373961">sp</span><span class="op" id="5373963">.</span><span class="ident" id="5373964">Y</span><span class="op" id="5373965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373968">var</span>&nbsp;<span class="op" id="5373972">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373976">ddelta</span><span class="op" id="5373982">,</span>&nbsp;<span class="ident" id="5373984">sdelta</span>&nbsp;<span class="builtintype" id="5373991">int</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373997">i0</span><span class="op" id="5373999">,</span>&nbsp;<span class="ident" id="5374001">i1</span><span class="op" id="5374003">,</span>&nbsp;<span class="ident" id="5374005">idelta</span>&nbsp;<span class="builtintype" id="5374012">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374020">if</span>&nbsp;<span class="ident" id="5374023">r</span><span class="op" id="5374024">.</span><span class="ident" id="5374025">Min</span><span class="op" id="5374028">.</span><span class="ident" id="5374029">Y</span>&nbsp;<span class="op" id="5374031">&lt;</span>&nbsp;<span class="ident" id="5374033">sp</span><span class="op" id="5374035">.</span><span class="ident" id="5374036">Y</span>&nbsp;<span class="op" id="5374038">||</span>&nbsp;<span class="ident" id="5374041">r</span><span class="op" id="5374042">.</span><span class="ident" id="5374043">Min</span><span class="op" id="5374046">.</span><span class="ident" id="5374047">Y</span>&nbsp;<span class="op" id="5374049">==</span>&nbsp;<span class="ident" id="5374052">sp</span><span class="op" id="5374054">.</span><span class="ident" id="5374055">Y</span>&nbsp;<span class="op" id="5374057">&amp;&amp;</span>&nbsp;<span class="ident" id="5374060">r</span><span class="op" id="5374061">.</span><span class="ident" id="5374062">Min</span><span class="op" id="5374065">.</span><span class="ident" id="5374066">X</span>&nbsp;<span class="op" id="5374068">&lt;=</span>&nbsp;<span class="ident" id="5374071">sp</span><span class="op" id="5374073">.</span><span class="ident" id="5374074">X</span>&nbsp;<span class="op" id="5374076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374080">ddelta</span>&nbsp;<span class="op" id="5374087">=</span>&nbsp;<span class="ident" id="5374089">dst</span><span class="op" id="5374092">.</span><span class="ident" id="5374093">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374102">sdelta</span>&nbsp;<span class="op" id="5374109">=</span>&nbsp;<span class="ident" id="5374111">src</span><span class="op" id="5374114">.</span><span class="ident" id="5374115">Stride</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374124">i0</span><span class="op" id="5374126">,</span>&nbsp;<span class="ident" id="5374128">i1</span><span class="op" id="5374130">,</span>&nbsp;<span class="ident" id="5374132">idelta</span>&nbsp;<span class="op" id="5374139">=</span>&nbsp;<span class="num" id="5374141">0</span><span class="op" id="5374142">,</span>&nbsp;<span class="ident" id="5374144">dx</span><span class="op" id="5374146">*</span><span class="num" id="5374147">4</span><span class="op" id="5374148">,</span>&nbsp;<span class="op" id="5374150">+</span><span class="num" id="5374151">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374154">}</span>&nbsp;<span class="keyword" id="5374156">else</span>&nbsp;<span class="op" id="5374161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5374165">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;or&nbsp;equal&nbsp;height&nbsp;but&nbsp;to&nbsp;the&nbsp;left,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5374273">//&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows&nbsp;in&nbsp;right-to-left,&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;left-to-right,&nbsp;top-down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374373">d0</span>&nbsp;<span class="op" id="5374376">+=</span>&nbsp;<span class="op" id="5374379">(</span><span class="ident" id="5374380">dy</span>&nbsp;<span class="op" id="5374383">-</span>&nbsp;<span class="num" id="5374385">1</span><span class="op" id="5374386">)</span>&nbsp;<span class="op" id="5374388">*</span>&nbsp;<span class="ident" id="5374390">dst</span><span class="op" id="5374393">.</span><span class="ident" id="5374394">Stride</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374403">s0</span>&nbsp;<span class="op" id="5374406">+=</span>&nbsp;<span class="op" id="5374409">(</span><span class="ident" id="5374410">dy</span>&nbsp;<span class="op" id="5374413">-</span>&nbsp;<span class="num" id="5374415">1</span><span class="op" id="5374416">)</span>&nbsp;<span class="op" id="5374418">*</span>&nbsp;<span class="ident" id="5374420">src</span><span class="op" id="5374423">.</span><span class="ident" id="5374424">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374433">ddelta</span>&nbsp;<span class="op" id="5374440">=</span>&nbsp;<span class="op" id="5374442">-</span><span class="ident" id="5374443">dst</span><span class="op" id="5374446">.</span><span class="ident" id="5374447">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374456">sdelta</span>&nbsp;<span class="op" id="5374463">=</span>&nbsp;<span class="op" id="5374465">-</span><span class="ident" id="5374466">src</span><span class="op" id="5374469">.</span><span class="ident" id="5374470">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374479">i0</span><span class="op" id="5374481">,</span>&nbsp;<span class="ident" id="5374483">i1</span><span class="op" id="5374485">,</span>&nbsp;<span class="ident" id="5374487">idelta</span>&nbsp;<span class="op" id="5374494">=</span>&nbsp;<span class="op" id="5374496">(</span><span class="ident" id="5374497">dx</span><span class="op" id="5374499">-</span><span class="num" id="5374500">1</span><span class="op" id="5374501">)</span><span class="op" id="5374502">*</span><span class="num" id="5374503">4</span><span class="op" id="5374504">,</span>&nbsp;<span class="op" id="5374506">-</span><span class="num" id="5374507">4</span><span class="op" id="5374508">,</span>&nbsp;<span class="op" id="5374510">-</span><span class="num" id="5374511">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374514">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374517">for</span>&nbsp;<span class="op" id="5374521">;</span>&nbsp;<span class="ident" id="5374523">dy</span>&nbsp;<span class="op" id="5374526">&gt;</span>&nbsp;<span class="num" id="5374528">0</span><span class="op" id="5374529">;</span>&nbsp;<span class="ident" id="5374531">dy</span><span class="op" id="5374533">--</span>&nbsp;<span class="op" id="5374536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374540">dpix</span>&nbsp;<span class="op" id="5374545">:=</span>&nbsp;<span class="ident" id="5374548">dst</span><span class="op" id="5374551">.</span><span class="ident" id="5374552">Pix</span><span class="op" id="5374555">[</span><span class="ident" id="5374556">d0</span><span class="op" id="5374558">:</span><span class="op" id="5374559">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374563">spix</span>&nbsp;<span class="op" id="5374568">:=</span>&nbsp;<span class="ident" id="5374571">src</span><span class="op" id="5374574">.</span><span class="ident" id="5374575">Pix</span><span class="op" id="5374578">[</span><span class="ident" id="5374579">s0</span><span class="op" id="5374581">:</span><span class="op" id="5374582">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374586">for</span>&nbsp;<span class="ident" id="5374590">i</span>&nbsp;<span class="op" id="5374592">:=</span>&nbsp;<span class="ident" id="5374595">i0</span><span class="op" id="5374597">;</span>&nbsp;<span class="ident" id="5374599">i</span>&nbsp;<span class="op" id="5374601">!=</span>&nbsp;<span class="ident" id="5374604">i1</span><span class="op" id="5374606">;</span>&nbsp;<span class="ident" id="5374608">i</span>&nbsp;<span class="op" id="5374610">+=</span>&nbsp;<span class="ident" id="5374613">idelta</span>&nbsp;<span class="op" id="5374620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374625">sr</span>&nbsp;<span class="op" id="5374628">:=</span>&nbsp;<span class="builtintype" id="5374631">uint32</span><span class="op" id="5374637">(</span><span class="ident" id="5374638">spix</span><span class="op" id="5374642">[</span><span class="ident" id="5374643">i</span><span class="op" id="5374644">+</span><span class="num" id="5374645">0</span><span class="op" id="5374646">]</span><span class="op" id="5374647">)</span>&nbsp;<span class="op" id="5374649">*</span>&nbsp;<span class="num" id="5374651">0x101</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374660">sg</span>&nbsp;<span class="op" id="5374663">:=</span>&nbsp;<span class="builtintype" id="5374666">uint32</span><span class="op" id="5374672">(</span><span class="ident" id="5374673">spix</span><span class="op" id="5374677">[</span><span class="ident" id="5374678">i</span><span class="op" id="5374679">+</span><span class="num" id="5374680">1</span><span class="op" id="5374681">]</span><span class="op" id="5374682">)</span>&nbsp;<span class="op" id="5374684">*</span>&nbsp;<span class="num" id="5374686">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374695">sb</span>&nbsp;<span class="op" id="5374698">:=</span>&nbsp;<span class="builtintype" id="5374701">uint32</span><span class="op" id="5374707">(</span><span class="ident" id="5374708">spix</span><span class="op" id="5374712">[</span><span class="ident" id="5374713">i</span><span class="op" id="5374714">+</span><span class="num" id="5374715">2</span><span class="op" id="5374716">]</span><span class="op" id="5374717">)</span>&nbsp;<span class="op" id="5374719">*</span>&nbsp;<span class="num" id="5374721">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374730">sa</span>&nbsp;<span class="op" id="5374733">:=</span>&nbsp;<span class="builtintype" id="5374736">uint32</span><span class="op" id="5374742">(</span><span class="ident" id="5374743">spix</span><span class="op" id="5374747">[</span><span class="ident" id="5374748">i</span><span class="op" id="5374749">+</span><span class="num" id="5374750">3</span><span class="op" id="5374751">]</span><span class="op" id="5374752">)</span>&nbsp;<span class="op" id="5374754">*</span>&nbsp;<span class="num" id="5374756">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374766">dr</span>&nbsp;<span class="op" id="5374769">:=</span>&nbsp;<span class="builtintype" id="5374772">uint32</span><span class="op" id="5374778">(</span><span class="ident" id="5374779">dpix</span><span class="op" id="5374783">[</span><span class="ident" id="5374784">i</span><span class="op" id="5374785">+</span><span class="num" id="5374786">0</span><span class="op" id="5374787">]</span><span class="op" id="5374788">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374793">dg</span>&nbsp;<span class="op" id="5374796">:=</span>&nbsp;<span class="builtintype" id="5374799">uint32</span><span class="op" id="5374805">(</span><span class="ident" id="5374806">dpix</span><span class="op" id="5374810">[</span><span class="ident" id="5374811">i</span><span class="op" id="5374812">+</span><span class="num" id="5374813">1</span><span class="op" id="5374814">]</span><span class="op" id="5374815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374820">db</span>&nbsp;<span class="op" id="5374823">:=</span>&nbsp;<span class="builtintype" id="5374826">uint32</span><span class="op" id="5374832">(</span><span class="ident" id="5374833">dpix</span><span class="op" id="5374837">[</span><span class="ident" id="5374838">i</span><span class="op" id="5374839">+</span><span class="num" id="5374840">2</span><span class="op" id="5374841">]</span><span class="op" id="5374842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374847">da</span>&nbsp;<span class="op" id="5374850">:=</span>&nbsp;<span class="builtintype" id="5374853">uint32</span><span class="op" id="5374859">(</span><span class="ident" id="5374860">dpix</span><span class="op" id="5374864">[</span><span class="ident" id="5374865">i</span><span class="op" id="5374866">+</span><span class="num" id="5374867">3</span><span class="op" id="5374868">]</span><span class="op" id="5374869">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5374875">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374935">a</span>&nbsp;<span class="op" id="5374937">:=</span>&nbsp;<span class="op" id="5374940">(</span><span class="ident" id="5374941">m</span>&nbsp;<span class="op" id="5374943">-</span>&nbsp;<span class="ident" id="5374945">sa</span><span class="op" id="5374947">)</span>&nbsp;<span class="op" id="5374949">*</span>&nbsp;<span class="num" id="5374951">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374961">dpix</span><span class="op" id="5374965">[</span><span class="ident" id="5374966">i</span><span class="op" id="5374967">+</span><span class="num" id="5374968">0</span><span class="op" id="5374969">]</span>&nbsp;<span class="op" id="5374971">=</span>&nbsp;<span class="builtintype" id="5374973">uint8</span><span class="op" id="5374978">(</span><span class="op" id="5374979">(</span><span class="ident" id="5374980">dr</span><span class="op" id="5374982">*</span><span class="ident" id="5374983">a</span><span class="op" id="5374984">/</span><span class="ident" id="5374985">m</span>&nbsp;<span class="op" id="5374987">+</span>&nbsp;<span class="ident" id="5374989">sr</span><span class="op" id="5374991">)</span>&nbsp;<span class="op" id="5374993">&gt;&gt;</span>&nbsp;<span class="num" id="5374996">8</span><span class="op" id="5374997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375002">dpix</span><span class="op" id="5375006">[</span><span class="ident" id="5375007">i</span><span class="op" id="5375008">+</span><span class="num" id="5375009">1</span><span class="op" id="5375010">]</span>&nbsp;<span class="op" id="5375012">=</span>&nbsp;<span class="builtintype" id="5375014">uint8</span><span class="op" id="5375019">(</span><span class="op" id="5375020">(</span><span class="ident" id="5375021">dg</span><span class="op" id="5375023">*</span><span class="ident" id="5375024">a</span><span class="op" id="5375025">/</span><span class="ident" id="5375026">m</span>&nbsp;<span class="op" id="5375028">+</span>&nbsp;<span class="ident" id="5375030">sg</span><span class="op" id="5375032">)</span>&nbsp;<span class="op" id="5375034">&gt;&gt;</span>&nbsp;<span class="num" id="5375037">8</span><span class="op" id="5375038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375043">dpix</span><span class="op" id="5375047">[</span><span class="ident" id="5375048">i</span><span class="op" id="5375049">+</span><span class="num" id="5375050">2</span><span class="op" id="5375051">]</span>&nbsp;<span class="op" id="5375053">=</span>&nbsp;<span class="builtintype" id="5375055">uint8</span><span class="op" id="5375060">(</span><span class="op" id="5375061">(</span><span class="ident" id="5375062">db</span><span class="op" id="5375064">*</span><span class="ident" id="5375065">a</span><span class="op" id="5375066">/</span><span class="ident" id="5375067">m</span>&nbsp;<span class="op" id="5375069">+</span>&nbsp;<span class="ident" id="5375071">sb</span><span class="op" id="5375073">)</span>&nbsp;<span class="op" id="5375075">&gt;&gt;</span>&nbsp;<span class="num" id="5375078">8</span><span class="op" id="5375079">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375084">dpix</span><span class="op" id="5375088">[</span><span class="ident" id="5375089">i</span><span class="op" id="5375090">+</span><span class="num" id="5375091">3</span><span class="op" id="5375092">]</span>&nbsp;<span class="op" id="5375094">=</span>&nbsp;<span class="builtintype" id="5375096">uint8</span><span class="op" id="5375101">(</span><span class="op" id="5375102">(</span><span class="ident" id="5375103">da</span><span class="op" id="5375105">*</span><span class="ident" id="5375106">a</span><span class="op" id="5375107">/</span><span class="ident" id="5375108">m</span>&nbsp;<span class="op" id="5375110">+</span>&nbsp;<span class="ident" id="5375112">sa</span><span class="op" id="5375114">)</span>&nbsp;<span class="op" id="5375116">&gt;&gt;</span>&nbsp;<span class="num" id="5375119">8</span><span class="op" id="5375120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375128">d0</span>&nbsp;<span class="op" id="5375131">+=</span>&nbsp;<span class="ident" id="5375134">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375143">s0</span>&nbsp;<span class="op" id="5375146">+=</span>&nbsp;<span class="ident" id="5375149">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375157">}</span><br>
<span class="lineno">305</span><span class="op" id="5375159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5375162">func</span>&nbsp;<span class="ident" id="5375167">drawCopySrc</span><span class="op" id="5375178">(</span><span class="ident" id="5375179">dst</span>&nbsp;<span class="op" id="5375183">*</span><span class="ident" id="5375184">image</span><span class="op" id="5375189">.</span><span class="ident" id="5375190">RGBA</span><span class="op" id="5375194">,</span>&nbsp;<span class="ident" id="5375196">r</span>&nbsp;<span class="ident" id="5375198">image</span><span class="op" id="5375203">.</span><span class="ident" id="5375204">Rectangle</span><span class="op" id="5375213">,</span>&nbsp;<span class="ident" id="5375215">src</span>&nbsp;<span class="op" id="5375219">*</span><span class="ident" id="5375220">image</span><span class="op" id="5375225">.</span><span class="ident" id="5375226">RGBA</span><span class="op" id="5375230">,</span>&nbsp;<span class="ident" id="5375232">sp</span>&nbsp;<span class="ident" id="5375235">image</span><span class="op" id="5375240">.</span><span class="ident" id="5375241">Point</span><span class="op" id="5375246">)</span>&nbsp;<span class="op" id="5375248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375251">n</span><span class="op" id="5375252">,</span>&nbsp;<span class="ident" id="5375254">dy</span>&nbsp;<span class="op" id="5375257">:=</span>&nbsp;<span class="num" id="5375260">4</span><span class="op" id="5375261">*</span><span class="ident" id="5375262">r</span><span class="op" id="5375263">.</span><span class="ident" id="5375264">Dx</span><span class="op" id="5375266">(</span><span class="op" id="5375267">)</span><span class="op" id="5375268">,</span>&nbsp;<span class="ident" id="5375270">r</span><span class="op" id="5375271">.</span><span class="ident" id="5375272">Dy</span><span class="op" id="5375274">(</span><span class="op" id="5375275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375278">d0</span>&nbsp;<span class="op" id="5375281">:=</span>&nbsp;<span class="ident" id="5375284">dst</span><span class="op" id="5375287">.</span><span class="ident" id="5375288">PixOffset</span><span class="op" id="5375297">(</span><span class="ident" id="5375298">r</span><span class="op" id="5375299">.</span><span class="ident" id="5375300">Min</span><span class="op" id="5375303">.</span><span class="ident" id="5375304">X</span><span class="op" id="5375305">,</span>&nbsp;<span class="ident" id="5375307">r</span><span class="op" id="5375308">.</span><span class="ident" id="5375309">Min</span><span class="op" id="5375312">.</span><span class="ident" id="5375313">Y</span><span class="op" id="5375314">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375317">s0</span>&nbsp;<span class="op" id="5375320">:=</span>&nbsp;<span class="ident" id="5375323">src</span><span class="op" id="5375326">.</span><span class="ident" id="5375327">PixOffset</span><span class="op" id="5375336">(</span><span class="ident" id="5375337">sp</span><span class="op" id="5375339">.</span><span class="ident" id="5375340">X</span><span class="op" id="5375341">,</span>&nbsp;<span class="ident" id="5375343">sp</span><span class="op" id="5375345">.</span><span class="ident" id="5375346">Y</span><span class="op" id="5375347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375350">var</span>&nbsp;<span class="ident" id="5375354">ddelta</span><span class="op" id="5375360">,</span>&nbsp;<span class="ident" id="5375362">sdelta</span>&nbsp;<span class="builtintype" id="5375369">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375374">if</span>&nbsp;<span class="ident" id="5375377">r</span><span class="op" id="5375378">.</span><span class="ident" id="5375379">Min</span><span class="op" id="5375382">.</span><span class="ident" id="5375383">Y</span>&nbsp;<span class="op" id="5375385">&lt;=</span>&nbsp;<span class="ident" id="5375388">sp</span><span class="op" id="5375390">.</span><span class="ident" id="5375391">Y</span>&nbsp;<span class="op" id="5375393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375397">ddelta</span>&nbsp;<span class="op" id="5375404">=</span>&nbsp;<span class="ident" id="5375406">dst</span><span class="op" id="5375409">.</span><span class="ident" id="5375410">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375419">sdelta</span>&nbsp;<span class="op" id="5375426">=</span>&nbsp;<span class="ident" id="5375428">src</span><span class="op" id="5375431">.</span><span class="ident" id="5375432">Stride</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375440">}</span>&nbsp;<span class="keyword" id="5375442">else</span>&nbsp;<span class="op" id="5375447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5375451">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5375551">//&nbsp;in&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;top-down.&nbsp;Unlike&nbsp;the&nbsp;drawCopyOver&nbsp;function,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5375647">//&nbsp;check&nbsp;the&nbsp;x&nbsp;co-ordinates&nbsp;because&nbsp;the&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;can&nbsp;handle&nbsp;overlapping&nbsp;slices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375743">d0</span>&nbsp;<span class="op" id="5375746">+=</span>&nbsp;<span class="op" id="5375749">(</span><span class="ident" id="5375750">dy</span>&nbsp;<span class="op" id="5375753">-</span>&nbsp;<span class="num" id="5375755">1</span><span class="op" id="5375756">)</span>&nbsp;<span class="op" id="5375758">*</span>&nbsp;<span class="ident" id="5375760">dst</span><span class="op" id="5375763">.</span><span class="ident" id="5375764">Stride</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375773">s0</span>&nbsp;<span class="op" id="5375776">+=</span>&nbsp;<span class="op" id="5375779">(</span><span class="ident" id="5375780">dy</span>&nbsp;<span class="op" id="5375783">-</span>&nbsp;<span class="num" id="5375785">1</span><span class="op" id="5375786">)</span>&nbsp;<span class="op" id="5375788">*</span>&nbsp;<span class="ident" id="5375790">src</span><span class="op" id="5375793">.</span><span class="ident" id="5375794">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375803">ddelta</span>&nbsp;<span class="op" id="5375810">=</span>&nbsp;<span class="op" id="5375812">-</span><span class="ident" id="5375813">dst</span><span class="op" id="5375816">.</span><span class="ident" id="5375817">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375826">sdelta</span>&nbsp;<span class="op" id="5375833">=</span>&nbsp;<span class="op" id="5375835">-</span><span class="ident" id="5375836">src</span><span class="op" id="5375839">.</span><span class="ident" id="5375840">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375851">for</span>&nbsp;<span class="op" id="5375855">;</span>&nbsp;<span class="ident" id="5375857">dy</span>&nbsp;<span class="op" id="5375860">&gt;</span>&nbsp;<span class="num" id="5375862">0</span><span class="op" id="5375863">;</span>&nbsp;<span class="ident" id="5375865">dy</span><span class="op" id="5375867">--</span>&nbsp;<span class="op" id="5375870">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5375874">copy</span><span class="op" id="5375878">(</span><span class="ident" id="5375879">dst</span><span class="op" id="5375882">.</span><span class="ident" id="5375883">Pix</span><span class="op" id="5375886">[</span><span class="ident" id="5375887">d0</span><span class="op" id="5375889">:</span><span class="ident" id="5375890">d0</span><span class="op" id="5375892">+</span><span class="ident" id="5375893">n</span><span class="op" id="5375894">]</span><span class="op" id="5375895">,</span>&nbsp;<span class="ident" id="5375897">src</span><span class="op" id="5375900">.</span><span class="ident" id="5375901">Pix</span><span class="op" id="5375904">[</span><span class="ident" id="5375905">s0</span><span class="op" id="5375907">:</span><span class="ident" id="5375908">s0</span><span class="op" id="5375910">+</span><span class="ident" id="5375911">n</span><span class="op" id="5375912">]</span><span class="op" id="5375913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375917">d0</span>&nbsp;<span class="op" id="5375920">+=</span>&nbsp;<span class="ident" id="5375923">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375932">s0</span>&nbsp;<span class="op" id="5375935">+=</span>&nbsp;<span class="ident" id="5375938">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375946">}</span><br>
<span class="lineno"></span><span class="op" id="5375948">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="5375951">func</span>&nbsp;<span class="ident" id="5375956">drawNRGBAOver</span><span class="op" id="5375969">(</span><span class="ident" id="5375970">dst</span>&nbsp;<span class="op" id="5375974">*</span><span class="ident" id="5375975">image</span><span class="op" id="5375980">.</span><span class="ident" id="5375981">RGBA</span><span class="op" id="5375985">,</span>&nbsp;<span class="ident" id="5375987">r</span>&nbsp;<span class="ident" id="5375989">image</span><span class="op" id="5375994">.</span><span class="ident" id="5375995">Rectangle</span><span class="op" id="5376004">,</span>&nbsp;<span class="ident" id="5376006">src</span>&nbsp;<span class="op" id="5376010">*</span><span class="ident" id="5376011">image</span><span class="op" id="5376016">.</span><span class="ident" id="5376017">NRGBA</span><span class="op" id="5376022">,</span>&nbsp;<span class="ident" id="5376024">sp</span>&nbsp;<span class="ident" id="5376027">image</span><span class="op" id="5376032">.</span><span class="ident" id="5376033">Point</span><span class="op" id="5376038">)</span>&nbsp;<span class="op" id="5376040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376043">i0</span>&nbsp;<span class="op" id="5376046">:=</span>&nbsp;<span class="op" id="5376049">(</span><span class="ident" id="5376050">r</span><span class="op" id="5376051">.</span><span class="ident" id="5376052">Min</span><span class="op" id="5376055">.</span><span class="ident" id="5376056">X</span>&nbsp;<span class="op" id="5376058">-</span>&nbsp;<span class="ident" id="5376060">dst</span><span class="op" id="5376063">.</span><span class="ident" id="5376064">Rect</span><span class="op" id="5376068">.</span><span class="ident" id="5376069">Min</span><span class="op" id="5376072">.</span><span class="ident" id="5376073">X</span><span class="op" id="5376074">)</span>&nbsp;<span class="op" id="5376076">*</span>&nbsp;<span class="num" id="5376078">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376081">i1</span>&nbsp;<span class="op" id="5376084">:=</span>&nbsp;<span class="op" id="5376087">(</span><span class="ident" id="5376088">r</span><span class="op" id="5376089">.</span><span class="ident" id="5376090">Max</span><span class="op" id="5376093">.</span><span class="ident" id="5376094">X</span>&nbsp;<span class="op" id="5376096">-</span>&nbsp;<span class="ident" id="5376098">dst</span><span class="op" id="5376101">.</span><span class="ident" id="5376102">Rect</span><span class="op" id="5376106">.</span><span class="ident" id="5376107">Min</span><span class="op" id="5376110">.</span><span class="ident" id="5376111">X</span><span class="op" id="5376112">)</span>&nbsp;<span class="op" id="5376114">*</span>&nbsp;<span class="num" id="5376116">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376119">si0</span>&nbsp;<span class="op" id="5376123">:=</span>&nbsp;<span class="op" id="5376126">(</span><span class="ident" id="5376127">sp</span><span class="op" id="5376129">.</span><span class="ident" id="5376130">X</span>&nbsp;<span class="op" id="5376132">-</span>&nbsp;<span class="ident" id="5376134">src</span><span class="op" id="5376137">.</span><span class="ident" id="5376138">Rect</span><span class="op" id="5376142">.</span><span class="ident" id="5376143">Min</span><span class="op" id="5376146">.</span><span class="ident" id="5376147">X</span><span class="op" id="5376148">)</span>&nbsp;<span class="op" id="5376150">*</span>&nbsp;<span class="num" id="5376152">4</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376155">yMax</span>&nbsp;<span class="op" id="5376160">:=</span>&nbsp;<span class="ident" id="5376163">r</span><span class="op" id="5376164">.</span><span class="ident" id="5376165">Max</span><span class="op" id="5376168">.</span><span class="ident" id="5376169">Y</span>&nbsp;<span class="op" id="5376171">-</span>&nbsp;<span class="ident" id="5376173">dst</span><span class="op" id="5376176">.</span><span class="ident" id="5376177">Rect</span><span class="op" id="5376181">.</span><span class="ident" id="5376182">Min</span><span class="op" id="5376185">.</span><span class="ident" id="5376186">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376190">y</span>&nbsp;<span class="op" id="5376192">:=</span>&nbsp;<span class="ident" id="5376195">r</span><span class="op" id="5376196">.</span><span class="ident" id="5376197">Min</span><span class="op" id="5376200">.</span><span class="ident" id="5376201">Y</span>&nbsp;<span class="op" id="5376203">-</span>&nbsp;<span class="ident" id="5376205">dst</span><span class="op" id="5376208">.</span><span class="ident" id="5376209">Rect</span><span class="op" id="5376213">.</span><span class="ident" id="5376214">Min</span><span class="op" id="5376217">.</span><span class="ident" id="5376218">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376221">sy</span>&nbsp;<span class="op" id="5376224">:=</span>&nbsp;<span class="ident" id="5376227">sp</span><span class="op" id="5376229">.</span><span class="ident" id="5376230">Y</span>&nbsp;<span class="op" id="5376232">-</span>&nbsp;<span class="ident" id="5376234">src</span><span class="op" id="5376237">.</span><span class="ident" id="5376238">Rect</span><span class="op" id="5376242">.</span><span class="ident" id="5376243">Min</span><span class="op" id="5376246">.</span><span class="ident" id="5376247">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376250">for</span>&nbsp;<span class="op" id="5376254">;</span>&nbsp;<span class="ident" id="5376256">y</span>&nbsp;<span class="op" id="5376258">!=</span>&nbsp;<span class="ident" id="5376261">yMax</span><span class="op" id="5376265">;</span>&nbsp;<span class="ident" id="5376267">y</span><span class="op" id="5376268">,</span>&nbsp;<span class="ident" id="5376270">sy</span>&nbsp;<span class="op" id="5376273">=</span>&nbsp;<span class="ident" id="5376275">y</span><span class="op" id="5376276">+</span><span class="num" id="5376277">1</span><span class="op" id="5376278">,</span>&nbsp;<span class="ident" id="5376280">sy</span><span class="op" id="5376282">+</span><span class="num" id="5376283">1</span>&nbsp;<span class="op" id="5376285">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376289">dpix</span>&nbsp;<span class="op" id="5376294">:=</span>&nbsp;<span class="ident" id="5376297">dst</span><span class="op" id="5376300">.</span><span class="ident" id="5376301">Pix</span><span class="op" id="5376304">[</span><span class="ident" id="5376305">y</span><span class="op" id="5376306">*</span><span class="ident" id="5376307">dst</span><span class="op" id="5376310">.</span><span class="ident" id="5376311">Stride</span><span class="op" id="5376317">:</span><span class="op" id="5376318">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376322">spix</span>&nbsp;<span class="op" id="5376327">:=</span>&nbsp;<span class="ident" id="5376330">src</span><span class="op" id="5376333">.</span><span class="ident" id="5376334">Pix</span><span class="op" id="5376337">[</span><span class="ident" id="5376338">sy</span><span class="op" id="5376340">*</span><span class="ident" id="5376341">src</span><span class="op" id="5376344">.</span><span class="ident" id="5376345">Stride</span><span class="op" id="5376351">:</span><span class="op" id="5376352">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376357">for</span>&nbsp;<span class="ident" id="5376361">i</span><span class="op" id="5376362">,</span>&nbsp;<span class="ident" id="5376364">si</span>&nbsp;<span class="op" id="5376367">:=</span>&nbsp;<span class="ident" id="5376370">i0</span><span class="op" id="5376372">,</span>&nbsp;<span class="ident" id="5376374">si0</span><span class="op" id="5376377">;</span>&nbsp;<span class="ident" id="5376379">i</span>&nbsp;<span class="op" id="5376381">&lt;</span>&nbsp;<span class="ident" id="5376383">i1</span><span class="op" id="5376385">;</span>&nbsp;<span class="ident" id="5376387">i</span><span class="op" id="5376388">,</span>&nbsp;<span class="ident" id="5376390">si</span>&nbsp;<span class="op" id="5376393">=</span>&nbsp;<span class="ident" id="5376395">i</span><span class="op" id="5376396">+</span><span class="num" id="5376397">4</span><span class="op" id="5376398">,</span>&nbsp;<span class="ident" id="5376400">si</span><span class="op" id="5376402">+</span><span class="num" id="5376403">4</span>&nbsp;<span class="op" id="5376405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5376410">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376478">sa</span>&nbsp;<span class="op" id="5376481">:=</span>&nbsp;<span class="builtintype" id="5376484">uint32</span><span class="op" id="5376490">(</span><span class="ident" id="5376491">spix</span><span class="op" id="5376495">[</span><span class="ident" id="5376496">si</span><span class="op" id="5376498">+</span><span class="num" id="5376499">3</span><span class="op" id="5376500">]</span><span class="op" id="5376501">)</span>&nbsp;<span class="op" id="5376503">*</span>&nbsp;<span class="num" id="5376505">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376514">sr</span>&nbsp;<span class="op" id="5376517">:=</span>&nbsp;<span class="builtintype" id="5376520">uint32</span><span class="op" id="5376526">(</span><span class="ident" id="5376527">spix</span><span class="op" id="5376531">[</span><span class="ident" id="5376532">si</span><span class="op" id="5376534">+</span><span class="num" id="5376535">0</span><span class="op" id="5376536">]</span><span class="op" id="5376537">)</span>&nbsp;<span class="op" id="5376539">*</span>&nbsp;<span class="ident" id="5376541">sa</span>&nbsp;<span class="op" id="5376544">/</span>&nbsp;<span class="num" id="5376546">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376554">sg</span>&nbsp;<span class="op" id="5376557">:=</span>&nbsp;<span class="builtintype" id="5376560">uint32</span><span class="op" id="5376566">(</span><span class="ident" id="5376567">spix</span><span class="op" id="5376571">[</span><span class="ident" id="5376572">si</span><span class="op" id="5376574">+</span><span class="num" id="5376575">1</span><span class="op" id="5376576">]</span><span class="op" id="5376577">)</span>&nbsp;<span class="op" id="5376579">*</span>&nbsp;<span class="ident" id="5376581">sa</span>&nbsp;<span class="op" id="5376584">/</span>&nbsp;<span class="num" id="5376586">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376594">sb</span>&nbsp;<span class="op" id="5376597">:=</span>&nbsp;<span class="builtintype" id="5376600">uint32</span><span class="op" id="5376606">(</span><span class="ident" id="5376607">spix</span><span class="op" id="5376611">[</span><span class="ident" id="5376612">si</span><span class="op" id="5376614">+</span><span class="num" id="5376615">2</span><span class="op" id="5376616">]</span><span class="op" id="5376617">)</span>&nbsp;<span class="op" id="5376619">*</span>&nbsp;<span class="ident" id="5376621">sa</span>&nbsp;<span class="op" id="5376624">/</span>&nbsp;<span class="num" id="5376626">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376635">dr</span>&nbsp;<span class="op" id="5376638">:=</span>&nbsp;<span class="builtintype" id="5376641">uint32</span><span class="op" id="5376647">(</span><span class="ident" id="5376648">dpix</span><span class="op" id="5376652">[</span><span class="ident" id="5376653">i</span><span class="op" id="5376654">+</span><span class="num" id="5376655">0</span><span class="op" id="5376656">]</span><span class="op" id="5376657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376662">dg</span>&nbsp;<span class="op" id="5376665">:=</span>&nbsp;<span class="builtintype" id="5376668">uint32</span><span class="op" id="5376674">(</span><span class="ident" id="5376675">dpix</span><span class="op" id="5376679">[</span><span class="ident" id="5376680">i</span><span class="op" id="5376681">+</span><span class="num" id="5376682">1</span><span class="op" id="5376683">]</span><span class="op" id="5376684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376689">db</span>&nbsp;<span class="op" id="5376692">:=</span>&nbsp;<span class="builtintype" id="5376695">uint32</span><span class="op" id="5376701">(</span><span class="ident" id="5376702">dpix</span><span class="op" id="5376706">[</span><span class="ident" id="5376707">i</span><span class="op" id="5376708">+</span><span class="num" id="5376709">2</span><span class="op" id="5376710">]</span><span class="op" id="5376711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376716">da</span>&nbsp;<span class="op" id="5376719">:=</span>&nbsp;<span class="builtintype" id="5376722">uint32</span><span class="op" id="5376728">(</span><span class="ident" id="5376729">dpix</span><span class="op" id="5376733">[</span><span class="ident" id="5376734">i</span><span class="op" id="5376735">+</span><span class="num" id="5376736">3</span><span class="op" id="5376737">]</span><span class="op" id="5376738">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5376744">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376804">a</span>&nbsp;<span class="op" id="5376806">:=</span>&nbsp;<span class="op" id="5376809">(</span><span class="ident" id="5376810">m</span>&nbsp;<span class="op" id="5376812">-</span>&nbsp;<span class="ident" id="5376814">sa</span><span class="op" id="5376816">)</span>&nbsp;<span class="op" id="5376818">*</span>&nbsp;<span class="num" id="5376820">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376830">dpix</span><span class="op" id="5376834">[</span><span class="ident" id="5376835">i</span><span class="op" id="5376836">+</span><span class="num" id="5376837">0</span><span class="op" id="5376838">]</span>&nbsp;<span class="op" id="5376840">=</span>&nbsp;<span class="builtintype" id="5376842">uint8</span><span class="op" id="5376847">(</span><span class="op" id="5376848">(</span><span class="ident" id="5376849">dr</span><span class="op" id="5376851">*</span><span class="ident" id="5376852">a</span><span class="op" id="5376853">/</span><span class="ident" id="5376854">m</span>&nbsp;<span class="op" id="5376856">+</span>&nbsp;<span class="ident" id="5376858">sr</span><span class="op" id="5376860">)</span>&nbsp;<span class="op" id="5376862">&gt;&gt;</span>&nbsp;<span class="num" id="5376865">8</span><span class="op" id="5376866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376871">dpix</span><span class="op" id="5376875">[</span><span class="ident" id="5376876">i</span><span class="op" id="5376877">+</span><span class="num" id="5376878">1</span><span class="op" id="5376879">]</span>&nbsp;<span class="op" id="5376881">=</span>&nbsp;<span class="builtintype" id="5376883">uint8</span><span class="op" id="5376888">(</span><span class="op" id="5376889">(</span><span class="ident" id="5376890">dg</span><span class="op" id="5376892">*</span><span class="ident" id="5376893">a</span><span class="op" id="5376894">/</span><span class="ident" id="5376895">m</span>&nbsp;<span class="op" id="5376897">+</span>&nbsp;<span class="ident" id="5376899">sg</span><span class="op" id="5376901">)</span>&nbsp;<span class="op" id="5376903">&gt;&gt;</span>&nbsp;<span class="num" id="5376906">8</span><span class="op" id="5376907">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376912">dpix</span><span class="op" id="5376916">[</span><span class="ident" id="5376917">i</span><span class="op" id="5376918">+</span><span class="num" id="5376919">2</span><span class="op" id="5376920">]</span>&nbsp;<span class="op" id="5376922">=</span>&nbsp;<span class="builtintype" id="5376924">uint8</span><span class="op" id="5376929">(</span><span class="op" id="5376930">(</span><span class="ident" id="5376931">db</span><span class="op" id="5376933">*</span><span class="ident" id="5376934">a</span><span class="op" id="5376935">/</span><span class="ident" id="5376936">m</span>&nbsp;<span class="op" id="5376938">+</span>&nbsp;<span class="ident" id="5376940">sb</span><span class="op" id="5376942">)</span>&nbsp;<span class="op" id="5376944">&gt;&gt;</span>&nbsp;<span class="num" id="5376947">8</span><span class="op" id="5376948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376953">dpix</span><span class="op" id="5376957">[</span><span class="ident" id="5376958">i</span><span class="op" id="5376959">+</span><span class="num" id="5376960">3</span><span class="op" id="5376961">]</span>&nbsp;<span class="op" id="5376963">=</span>&nbsp;<span class="builtintype" id="5376965">uint8</span><span class="op" id="5376970">(</span><span class="op" id="5376971">(</span><span class="ident" id="5376972">da</span><span class="op" id="5376974">*</span><span class="ident" id="5376975">a</span><span class="op" id="5376976">/</span><span class="ident" id="5376977">m</span>&nbsp;<span class="op" id="5376979">+</span>&nbsp;<span class="ident" id="5376981">sa</span><span class="op" id="5376983">)</span>&nbsp;<span class="op" id="5376985">&gt;&gt;</span>&nbsp;<span class="num" id="5376988">8</span><span class="op" id="5376989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376996">}</span><br>
<span class="lineno"></span><span class="op" id="5376998">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="5377001">func</span>&nbsp;<span class="ident" id="5377006">drawNRGBASrc</span><span class="op" id="5377018">(</span><span class="ident" id="5377019">dst</span>&nbsp;<span class="op" id="5377023">*</span><span class="ident" id="5377024">image</span><span class="op" id="5377029">.</span><span class="ident" id="5377030">RGBA</span><span class="op" id="5377034">,</span>&nbsp;<span class="ident" id="5377036">r</span>&nbsp;<span class="ident" id="5377038">image</span><span class="op" id="5377043">.</span><span class="ident" id="5377044">Rectangle</span><span class="op" id="5377053">,</span>&nbsp;<span class="ident" id="5377055">src</span>&nbsp;<span class="op" id="5377059">*</span><span class="ident" id="5377060">image</span><span class="op" id="5377065">.</span><span class="ident" id="5377066">NRGBA</span><span class="op" id="5377071">,</span>&nbsp;<span class="ident" id="5377073">sp</span>&nbsp;<span class="ident" id="5377076">image</span><span class="op" id="5377081">.</span><span class="ident" id="5377082">Point</span><span class="op" id="5377087">)</span>&nbsp;<span class="op" id="5377089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377092">i0</span>&nbsp;<span class="op" id="5377095">:=</span>&nbsp;<span class="op" id="5377098">(</span><span class="ident" id="5377099">r</span><span class="op" id="5377100">.</span><span class="ident" id="5377101">Min</span><span class="op" id="5377104">.</span><span class="ident" id="5377105">X</span>&nbsp;<span class="op" id="5377107">-</span>&nbsp;<span class="ident" id="5377109">dst</span><span class="op" id="5377112">.</span><span class="ident" id="5377113">Rect</span><span class="op" id="5377117">.</span><span class="ident" id="5377118">Min</span><span class="op" id="5377121">.</span><span class="ident" id="5377122">X</span><span class="op" id="5377123">)</span>&nbsp;<span class="op" id="5377125">*</span>&nbsp;<span class="num" id="5377127">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377130">i1</span>&nbsp;<span class="op" id="5377133">:=</span>&nbsp;<span class="op" id="5377136">(</span><span class="ident" id="5377137">r</span><span class="op" id="5377138">.</span><span class="ident" id="5377139">Max</span><span class="op" id="5377142">.</span><span class="ident" id="5377143">X</span>&nbsp;<span class="op" id="5377145">-</span>&nbsp;<span class="ident" id="5377147">dst</span><span class="op" id="5377150">.</span><span class="ident" id="5377151">Rect</span><span class="op" id="5377155">.</span><span class="ident" id="5377156">Min</span><span class="op" id="5377159">.</span><span class="ident" id="5377160">X</span><span class="op" id="5377161">)</span>&nbsp;<span class="op" id="5377163">*</span>&nbsp;<span class="num" id="5377165">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377168">si0</span>&nbsp;<span class="op" id="5377172">:=</span>&nbsp;<span class="op" id="5377175">(</span><span class="ident" id="5377176">sp</span><span class="op" id="5377178">.</span><span class="ident" id="5377179">X</span>&nbsp;<span class="op" id="5377181">-</span>&nbsp;<span class="ident" id="5377183">src</span><span class="op" id="5377186">.</span><span class="ident" id="5377187">Rect</span><span class="op" id="5377191">.</span><span class="ident" id="5377192">Min</span><span class="op" id="5377195">.</span><span class="ident" id="5377196">X</span><span class="op" id="5377197">)</span>&nbsp;<span class="op" id="5377199">*</span>&nbsp;<span class="num" id="5377201">4</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377204">yMax</span>&nbsp;<span class="op" id="5377209">:=</span>&nbsp;<span class="ident" id="5377212">r</span><span class="op" id="5377213">.</span><span class="ident" id="5377214">Max</span><span class="op" id="5377217">.</span><span class="ident" id="5377218">Y</span>&nbsp;<span class="op" id="5377220">-</span>&nbsp;<span class="ident" id="5377222">dst</span><span class="op" id="5377225">.</span><span class="ident" id="5377226">Rect</span><span class="op" id="5377230">.</span><span class="ident" id="5377231">Min</span><span class="op" id="5377234">.</span><span class="ident" id="5377235">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377239">y</span>&nbsp;<span class="op" id="5377241">:=</span>&nbsp;<span class="ident" id="5377244">r</span><span class="op" id="5377245">.</span><span class="ident" id="5377246">Min</span><span class="op" id="5377249">.</span><span class="ident" id="5377250">Y</span>&nbsp;<span class="op" id="5377252">-</span>&nbsp;<span class="ident" id="5377254">dst</span><span class="op" id="5377257">.</span><span class="ident" id="5377258">Rect</span><span class="op" id="5377262">.</span><span class="ident" id="5377263">Min</span><span class="op" id="5377266">.</span><span class="ident" id="5377267">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377270">sy</span>&nbsp;<span class="op" id="5377273">:=</span>&nbsp;<span class="ident" id="5377276">sp</span><span class="op" id="5377278">.</span><span class="ident" id="5377279">Y</span>&nbsp;<span class="op" id="5377281">-</span>&nbsp;<span class="ident" id="5377283">src</span><span class="op" id="5377286">.</span><span class="ident" id="5377287">Rect</span><span class="op" id="5377291">.</span><span class="ident" id="5377292">Min</span><span class="op" id="5377295">.</span><span class="ident" id="5377296">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377299">for</span>&nbsp;<span class="op" id="5377303">;</span>&nbsp;<span class="ident" id="5377305">y</span>&nbsp;<span class="op" id="5377307">!=</span>&nbsp;<span class="ident" id="5377310">yMax</span><span class="op" id="5377314">;</span>&nbsp;<span class="ident" id="5377316">y</span><span class="op" id="5377317">,</span>&nbsp;<span class="ident" id="5377319">sy</span>&nbsp;<span class="op" id="5377322">=</span>&nbsp;<span class="ident" id="5377324">y</span><span class="op" id="5377325">+</span><span class="num" id="5377326">1</span><span class="op" id="5377327">,</span>&nbsp;<span class="ident" id="5377329">sy</span><span class="op" id="5377331">+</span><span class="num" id="5377332">1</span>&nbsp;<span class="op" id="5377334">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377338">dpix</span>&nbsp;<span class="op" id="5377343">:=</span>&nbsp;<span class="ident" id="5377346">dst</span><span class="op" id="5377349">.</span><span class="ident" id="5377350">Pix</span><span class="op" id="5377353">[</span><span class="ident" id="5377354">y</span><span class="op" id="5377355">*</span><span class="ident" id="5377356">dst</span><span class="op" id="5377359">.</span><span class="ident" id="5377360">Stride</span><span class="op" id="5377366">:</span><span class="op" id="5377367">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377371">spix</span>&nbsp;<span class="op" id="5377376">:=</span>&nbsp;<span class="ident" id="5377379">src</span><span class="op" id="5377382">.</span><span class="ident" id="5377383">Pix</span><span class="op" id="5377386">[</span><span class="ident" id="5377387">sy</span><span class="op" id="5377389">*</span><span class="ident" id="5377390">src</span><span class="op" id="5377393">.</span><span class="ident" id="5377394">Stride</span><span class="op" id="5377400">:</span><span class="op" id="5377401">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377406">for</span>&nbsp;<span class="ident" id="5377410">i</span><span class="op" id="5377411">,</span>&nbsp;<span class="ident" id="5377413">si</span>&nbsp;<span class="op" id="5377416">:=</span>&nbsp;<span class="ident" id="5377419">i0</span><span class="op" id="5377421">,</span>&nbsp;<span class="ident" id="5377423">si0</span><span class="op" id="5377426">;</span>&nbsp;<span class="ident" id="5377428">i</span>&nbsp;<span class="op" id="5377430">&lt;</span>&nbsp;<span class="ident" id="5377432">i1</span><span class="op" id="5377434">;</span>&nbsp;<span class="ident" id="5377436">i</span><span class="op" id="5377437">,</span>&nbsp;<span class="ident" id="5377439">si</span>&nbsp;<span class="op" id="5377442">=</span>&nbsp;<span class="ident" id="5377444">i</span><span class="op" id="5377445">+</span><span class="num" id="5377446">4</span><span class="op" id="5377447">,</span>&nbsp;<span class="ident" id="5377449">si</span><span class="op" id="5377451">+</span><span class="num" id="5377452">4</span>&nbsp;<span class="op" id="5377454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5377459">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377527">sa</span>&nbsp;<span class="op" id="5377530">:=</span>&nbsp;<span class="builtintype" id="5377533">uint32</span><span class="op" id="5377539">(</span><span class="ident" id="5377540">spix</span><span class="op" id="5377544">[</span><span class="ident" id="5377545">si</span><span class="op" id="5377547">+</span><span class="num" id="5377548">3</span><span class="op" id="5377549">]</span><span class="op" id="5377550">)</span>&nbsp;<span class="op" id="5377552">*</span>&nbsp;<span class="num" id="5377554">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377563">sr</span>&nbsp;<span class="op" id="5377566">:=</span>&nbsp;<span class="builtintype" id="5377569">uint32</span><span class="op" id="5377575">(</span><span class="ident" id="5377576">spix</span><span class="op" id="5377580">[</span><span class="ident" id="5377581">si</span><span class="op" id="5377583">+</span><span class="num" id="5377584">0</span><span class="op" id="5377585">]</span><span class="op" id="5377586">)</span>&nbsp;<span class="op" id="5377588">*</span>&nbsp;<span class="ident" id="5377590">sa</span>&nbsp;<span class="op" id="5377593">/</span>&nbsp;<span class="num" id="5377595">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377603">sg</span>&nbsp;<span class="op" id="5377606">:=</span>&nbsp;<span class="builtintype" id="5377609">uint32</span><span class="op" id="5377615">(</span><span class="ident" id="5377616">spix</span><span class="op" id="5377620">[</span><span class="ident" id="5377621">si</span><span class="op" id="5377623">+</span><span class="num" id="5377624">1</span><span class="op" id="5377625">]</span><span class="op" id="5377626">)</span>&nbsp;<span class="op" id="5377628">*</span>&nbsp;<span class="ident" id="5377630">sa</span>&nbsp;<span class="op" id="5377633">/</span>&nbsp;<span class="num" id="5377635">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377643">sb</span>&nbsp;<span class="op" id="5377646">:=</span>&nbsp;<span class="builtintype" id="5377649">uint32</span><span class="op" id="5377655">(</span><span class="ident" id="5377656">spix</span><span class="op" id="5377660">[</span><span class="ident" id="5377661">si</span><span class="op" id="5377663">+</span><span class="num" id="5377664">2</span><span class="op" id="5377665">]</span><span class="op" id="5377666">)</span>&nbsp;<span class="op" id="5377668">*</span>&nbsp;<span class="ident" id="5377670">sa</span>&nbsp;<span class="op" id="5377673">/</span>&nbsp;<span class="num" id="5377675">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377684">dpix</span><span class="op" id="5377688">[</span><span class="ident" id="5377689">i</span><span class="op" id="5377690">+</span><span class="num" id="5377691">0</span><span class="op" id="5377692">]</span>&nbsp;<span class="op" id="5377694">=</span>&nbsp;<span class="builtintype" id="5377696">uint8</span><span class="op" id="5377701">(</span><span class="ident" id="5377702">sr</span>&nbsp;<span class="op" id="5377705">&gt;&gt;</span>&nbsp;<span class="num" id="5377708">8</span><span class="op" id="5377709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377714">dpix</span><span class="op" id="5377718">[</span><span class="ident" id="5377719">i</span><span class="op" id="5377720">+</span><span class="num" id="5377721">1</span><span class="op" id="5377722">]</span>&nbsp;<span class="op" id="5377724">=</span>&nbsp;<span class="builtintype" id="5377726">uint8</span><span class="op" id="5377731">(</span><span class="ident" id="5377732">sg</span>&nbsp;<span class="op" id="5377735">&gt;&gt;</span>&nbsp;<span class="num" id="5377738">8</span><span class="op" id="5377739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377744">dpix</span><span class="op" id="5377748">[</span><span class="ident" id="5377749">i</span><span class="op" id="5377750">+</span><span class="num" id="5377751">2</span><span class="op" id="5377752">]</span>&nbsp;<span class="op" id="5377754">=</span>&nbsp;<span class="builtintype" id="5377756">uint8</span><span class="op" id="5377761">(</span><span class="ident" id="5377762">sb</span>&nbsp;<span class="op" id="5377765">&gt;&gt;</span>&nbsp;<span class="num" id="5377768">8</span><span class="op" id="5377769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377774">dpix</span><span class="op" id="5377778">[</span><span class="ident" id="5377779">i</span><span class="op" id="5377780">+</span><span class="num" id="5377781">3</span><span class="op" id="5377782">]</span>&nbsp;<span class="op" id="5377784">=</span>&nbsp;<span class="builtintype" id="5377786">uint8</span><span class="op" id="5377791">(</span><span class="ident" id="5377792">sa</span>&nbsp;<span class="op" id="5377795">&gt;&gt;</span>&nbsp;<span class="num" id="5377798">8</span><span class="op" id="5377799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5377803">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5377806">}</span><br>
<span class="lineno"></span><span class="op" id="5377808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5377811">func</span>&nbsp;<span class="ident" id="5377816">drawYCbCr</span><span class="op" id="5377825">(</span><span class="ident" id="5377826">dst</span>&nbsp;<span class="op" id="5377830">*</span><span class="ident" id="5377831">image</span><span class="op" id="5377836">.</span><span class="ident" id="5377837">RGBA</span><span class="op" id="5377841">,</span>&nbsp;<span class="ident" id="5377843">r</span>&nbsp;<span class="ident" id="5377845">image</span><span class="op" id="5377850">.</span><span class="ident" id="5377851">Rectangle</span><span class="op" id="5377860">,</span>&nbsp;<span class="ident" id="5377862">src</span>&nbsp;<span class="op" id="5377866">*</span><span class="ident" id="5377867">image</span><span class="op" id="5377872">.</span><span class="ident" id="5377873">YCbCr</span><span class="op" id="5377878">,</span>&nbsp;<span class="ident" id="5377880">sp</span>&nbsp;<span class="ident" id="5377883">image</span><span class="op" id="5377888">.</span><span class="ident" id="5377889">Point</span><span class="op" id="5377894">)</span>&nbsp;<span class="op" id="5377896">(</span><span class="ident" id="5377897">ok</span>&nbsp;<span class="builtintype" id="5377900">bool</span><span class="op" id="5377904">)</span>&nbsp;<span class="op" id="5377906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5377909">//&nbsp;An&nbsp;image.YCbCr&nbsp;is&nbsp;always&nbsp;fully&nbsp;opaque,&nbsp;and&nbsp;so&nbsp;if&nbsp;the&nbsp;mask&nbsp;is&nbsp;implicitly&nbsp;nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5377989">//&nbsp;(i.e.&nbsp;fully&nbsp;opaque)&nbsp;then&nbsp;the&nbsp;op&nbsp;is&nbsp;effectively&nbsp;always&nbsp;Src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378052">x0</span>&nbsp;<span class="op" id="5378055">:=</span>&nbsp;<span class="op" id="5378058">(</span><span class="ident" id="5378059">r</span><span class="op" id="5378060">.</span><span class="ident" id="5378061">Min</span><span class="op" id="5378064">.</span><span class="ident" id="5378065">X</span>&nbsp;<span class="op" id="5378067">-</span>&nbsp;<span class="ident" id="5378069">dst</span><span class="op" id="5378072">.</span><span class="ident" id="5378073">Rect</span><span class="op" id="5378077">.</span><span class="ident" id="5378078">Min</span><span class="op" id="5378081">.</span><span class="ident" id="5378082">X</span><span class="op" id="5378083">)</span>&nbsp;<span class="op" id="5378085">*</span>&nbsp;<span class="num" id="5378087">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378090">x1</span>&nbsp;<span class="op" id="5378093">:=</span>&nbsp;<span class="op" id="5378096">(</span><span class="ident" id="5378097">r</span><span class="op" id="5378098">.</span><span class="ident" id="5378099">Max</span><span class="op" id="5378102">.</span><span class="ident" id="5378103">X</span>&nbsp;<span class="op" id="5378105">-</span>&nbsp;<span class="ident" id="5378107">dst</span><span class="op" id="5378110">.</span><span class="ident" id="5378111">Rect</span><span class="op" id="5378115">.</span><span class="ident" id="5378116">Min</span><span class="op" id="5378119">.</span><span class="ident" id="5378120">X</span><span class="op" id="5378121">)</span>&nbsp;<span class="op" id="5378123">*</span>&nbsp;<span class="num" id="5378125">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378128">y0</span>&nbsp;<span class="op" id="5378131">:=</span>&nbsp;<span class="ident" id="5378134">r</span><span class="op" id="5378135">.</span><span class="ident" id="5378136">Min</span><span class="op" id="5378139">.</span><span class="ident" id="5378140">Y</span>&nbsp;<span class="op" id="5378142">-</span>&nbsp;<span class="ident" id="5378144">dst</span><span class="op" id="5378147">.</span><span class="ident" id="5378148">Rect</span><span class="op" id="5378152">.</span><span class="ident" id="5378153">Min</span><span class="op" id="5378156">.</span><span class="ident" id="5378157">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378160">y1</span>&nbsp;<span class="op" id="5378163">:=</span>&nbsp;<span class="ident" id="5378166">r</span><span class="op" id="5378167">.</span><span class="ident" id="5378168">Max</span><span class="op" id="5378171">.</span><span class="ident" id="5378172">Y</span>&nbsp;<span class="op" id="5378174">-</span>&nbsp;<span class="ident" id="5378176">dst</span><span class="op" id="5378179">.</span><span class="ident" id="5378180">Rect</span><span class="op" id="5378184">.</span><span class="ident" id="5378185">Min</span><span class="op" id="5378188">.</span><span class="ident" id="5378189">Y</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378192">switch</span>&nbsp;<span class="ident" id="5378199">src</span><span class="op" id="5378202">.</span><span class="ident" id="5378203">SubsampleRatio</span>&nbsp;<span class="op" id="5378218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378221">case</span>&nbsp;<span class="ident" id="5378226">image</span><span class="op" id="5378231">.</span><span class="ident" id="5378232">YCbCrSubsampleRatio444</span><span class="op" id="5378254">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378258">for</span>&nbsp;<span class="ident" id="5378262">y</span><span class="op" id="5378263">,</span>&nbsp;<span class="ident" id="5378265">sy</span>&nbsp;<span class="op" id="5378268">:=</span>&nbsp;<span class="ident" id="5378271">y0</span><span class="op" id="5378273">,</span>&nbsp;<span class="ident" id="5378275">sp</span><span class="op" id="5378277">.</span><span class="ident" id="5378278">Y</span><span class="op" id="5378279">;</span>&nbsp;<span class="ident" id="5378281">y</span>&nbsp;<span class="op" id="5378283">!=</span>&nbsp;<span class="ident" id="5378286">y1</span><span class="op" id="5378288">;</span>&nbsp;<span class="ident" id="5378290">y</span><span class="op" id="5378291">,</span>&nbsp;<span class="ident" id="5378293">sy</span>&nbsp;<span class="op" id="5378296">=</span>&nbsp;<span class="ident" id="5378298">y</span><span class="op" id="5378299">+</span><span class="num" id="5378300">1</span><span class="op" id="5378301">,</span>&nbsp;<span class="ident" id="5378303">sy</span><span class="op" id="5378305">+</span><span class="num" id="5378306">1</span>&nbsp;<span class="op" id="5378308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378313">dpix</span>&nbsp;<span class="op" id="5378318">:=</span>&nbsp;<span class="ident" id="5378321">dst</span><span class="op" id="5378324">.</span><span class="ident" id="5378325">Pix</span><span class="op" id="5378328">[</span><span class="ident" id="5378329">y</span><span class="op" id="5378330">*</span><span class="ident" id="5378331">dst</span><span class="op" id="5378334">.</span><span class="ident" id="5378335">Stride</span><span class="op" id="5378341">:</span><span class="op" id="5378342">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378347">yi</span>&nbsp;<span class="op" id="5378350">:=</span>&nbsp;<span class="op" id="5378353">(</span><span class="ident" id="5378354">sy</span><span class="op" id="5378356">-</span><span class="ident" id="5378357">src</span><span class="op" id="5378360">.</span><span class="ident" id="5378361">Rect</span><span class="op" id="5378365">.</span><span class="ident" id="5378366">Min</span><span class="op" id="5378369">.</span><span class="ident" id="5378370">Y</span><span class="op" id="5378371">)</span><span class="op" id="5378372">*</span><span class="ident" id="5378373">src</span><span class="op" id="5378376">.</span><span class="ident" id="5378377">YStride</span>&nbsp;<span class="op" id="5378385">+</span>&nbsp;<span class="op" id="5378387">(</span><span class="ident" id="5378388">sp</span><span class="op" id="5378390">.</span><span class="ident" id="5378391">X</span>&nbsp;<span class="op" id="5378393">-</span>&nbsp;<span class="ident" id="5378395">src</span><span class="op" id="5378398">.</span><span class="ident" id="5378399">Rect</span><span class="op" id="5378403">.</span><span class="ident" id="5378404">Min</span><span class="op" id="5378407">.</span><span class="ident" id="5378408">X</span><span class="op" id="5378409">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378414">ci</span>&nbsp;<span class="op" id="5378417">:=</span>&nbsp;<span class="op" id="5378420">(</span><span class="ident" id="5378421">sy</span><span class="op" id="5378423">-</span><span class="ident" id="5378424">src</span><span class="op" id="5378427">.</span><span class="ident" id="5378428">Rect</span><span class="op" id="5378432">.</span><span class="ident" id="5378433">Min</span><span class="op" id="5378436">.</span><span class="ident" id="5378437">Y</span><span class="op" id="5378438">)</span><span class="op" id="5378439">*</span><span class="ident" id="5378440">src</span><span class="op" id="5378443">.</span><span class="ident" id="5378444">CStride</span>&nbsp;<span class="op" id="5378452">+</span>&nbsp;<span class="op" id="5378454">(</span><span class="ident" id="5378455">sp</span><span class="op" id="5378457">.</span><span class="ident" id="5378458">X</span>&nbsp;<span class="op" id="5378460">-</span>&nbsp;<span class="ident" id="5378462">src</span><span class="op" id="5378465">.</span><span class="ident" id="5378466">Rect</span><span class="op" id="5378470">.</span><span class="ident" id="5378471">Min</span><span class="op" id="5378474">.</span><span class="ident" id="5378475">X</span><span class="op" id="5378476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378481">for</span>&nbsp;<span class="ident" id="5378485">x</span>&nbsp;<span class="op" id="5378487">:=</span>&nbsp;<span class="ident" id="5378490">x0</span><span class="op" id="5378492">;</span>&nbsp;<span class="ident" id="5378494">x</span>&nbsp;<span class="op" id="5378496">!=</span>&nbsp;<span class="ident" id="5378499">x1</span><span class="op" id="5378501">;</span>&nbsp;<span class="ident" id="5378503">x</span><span class="op" id="5378504">,</span>&nbsp;<span class="ident" id="5378506">yi</span><span class="op" id="5378508">,</span>&nbsp;<span class="ident" id="5378510">ci</span>&nbsp;<span class="op" id="5378513">=</span>&nbsp;<span class="ident" id="5378515">x</span><span class="op" id="5378516">+</span><span class="num" id="5378517">4</span><span class="op" id="5378518">,</span>&nbsp;<span class="ident" id="5378520">yi</span><span class="op" id="5378522">+</span><span class="num" id="5378523">1</span><span class="op" id="5378524">,</span>&nbsp;<span class="ident" id="5378526">ci</span><span class="op" id="5378528">+</span><span class="num" id="5378529">1</span>&nbsp;<span class="op" id="5378531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378537">rr</span><span class="op" id="5378539">,</span>&nbsp;<span class="ident" id="5378541">gg</span><span class="op" id="5378543">,</span>&nbsp;<span class="ident" id="5378545">bb</span>&nbsp;<span class="op" id="5378548">:=</span>&nbsp;<span class="ident" id="5378551">color</span><span class="op" id="5378556">.</span><span class="ident" id="5378557">YCbCrToRGB</span><span class="op" id="5378567">(</span><span class="ident" id="5378568">src</span><span class="op" id="5378571">.</span><span class="ident" id="5378572">Y</span><span class="op" id="5378573">[</span><span class="ident" id="5378574">yi</span><span class="op" id="5378576">]</span><span class="op" id="5378577">,</span>&nbsp;<span class="ident" id="5378579">src</span><span class="op" id="5378582">.</span><span class="ident" id="5378583">Cb</span><span class="op" id="5378585">[</span><span class="ident" id="5378586">ci</span><span class="op" id="5378588">]</span><span class="op" id="5378589">,</span>&nbsp;<span class="ident" id="5378591">src</span><span class="op" id="5378594">.</span><span class="ident" id="5378595">Cr</span><span class="op" id="5378597">[</span><span class="ident" id="5378598">ci</span><span class="op" id="5378600">]</span><span class="op" id="5378601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378607">dpix</span><span class="op" id="5378611">[</span><span class="ident" id="5378612">x</span><span class="op" id="5378613">+</span><span class="num" id="5378614">0</span><span class="op" id="5378615">]</span>&nbsp;<span class="op" id="5378617">=</span>&nbsp;<span class="ident" id="5378619">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378626">dpix</span><span class="op" id="5378630">[</span><span class="ident" id="5378631">x</span><span class="op" id="5378632">+</span><span class="num" id="5378633">1</span><span class="op" id="5378634">]</span>&nbsp;<span class="op" id="5378636">=</span>&nbsp;<span class="ident" id="5378638">gg</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378645">dpix</span><span class="op" id="5378649">[</span><span class="ident" id="5378650">x</span><span class="op" id="5378651">+</span><span class="num" id="5378652">2</span><span class="op" id="5378653">]</span>&nbsp;<span class="op" id="5378655">=</span>&nbsp;<span class="ident" id="5378657">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378664">dpix</span><span class="op" id="5378668">[</span><span class="ident" id="5378669">x</span><span class="op" id="5378670">+</span><span class="num" id="5378671">3</span><span class="op" id="5378672">]</span>&nbsp;<span class="op" id="5378674">=</span>&nbsp;<span class="num" id="5378676">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5378683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5378687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378690">case</span>&nbsp;<span class="ident" id="5378695">image</span><span class="op" id="5378700">.</span><span class="ident" id="5378701">YCbCrSubsampleRatio422</span><span class="op" id="5378723">:</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378727">for</span>&nbsp;<span class="ident" id="5378731">y</span><span class="op" id="5378732">,</span>&nbsp;<span class="ident" id="5378734">sy</span>&nbsp;<span class="op" id="5378737">:=</span>&nbsp;<span class="ident" id="5378740">y0</span><span class="op" id="5378742">,</span>&nbsp;<span class="ident" id="5378744">sp</span><span class="op" id="5378746">.</span><span class="ident" id="5378747">Y</span><span class="op" id="5378748">;</span>&nbsp;<span class="ident" id="5378750">y</span>&nbsp;<span class="op" id="5378752">!=</span>&nbsp;<span class="ident" id="5378755">y1</span><span class="op" id="5378757">;</span>&nbsp;<span class="ident" id="5378759">y</span><span class="op" id="5378760">,</span>&nbsp;<span class="ident" id="5378762">sy</span>&nbsp;<span class="op" id="5378765">=</span>&nbsp;<span class="ident" id="5378767">y</span><span class="op" id="5378768">+</span><span class="num" id="5378769">1</span><span class="op" id="5378770">,</span>&nbsp;<span class="ident" id="5378772">sy</span><span class="op" id="5378774">+</span><span class="num" id="5378775">1</span>&nbsp;<span class="op" id="5378777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378782">dpix</span>&nbsp;<span class="op" id="5378787">:=</span>&nbsp;<span class="ident" id="5378790">dst</span><span class="op" id="5378793">.</span><span class="ident" id="5378794">Pix</span><span class="op" id="5378797">[</span><span class="ident" id="5378798">y</span><span class="op" id="5378799">*</span><span class="ident" id="5378800">dst</span><span class="op" id="5378803">.</span><span class="ident" id="5378804">Stride</span><span class="op" id="5378810">:</span><span class="op" id="5378811">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378816">yi</span>&nbsp;<span class="op" id="5378819">:=</span>&nbsp;<span class="op" id="5378822">(</span><span class="ident" id="5378823">sy</span><span class="op" id="5378825">-</span><span class="ident" id="5378826">src</span><span class="op" id="5378829">.</span><span class="ident" id="5378830">Rect</span><span class="op" id="5378834">.</span><span class="ident" id="5378835">Min</span><span class="op" id="5378838">.</span><span class="ident" id="5378839">Y</span><span class="op" id="5378840">)</span><span class="op" id="5378841">*</span><span class="ident" id="5378842">src</span><span class="op" id="5378845">.</span><span class="ident" id="5378846">YStride</span>&nbsp;<span class="op" id="5378854">+</span>&nbsp;<span class="op" id="5378856">(</span><span class="ident" id="5378857">sp</span><span class="op" id="5378859">.</span><span class="ident" id="5378860">X</span>&nbsp;<span class="op" id="5378862">-</span>&nbsp;<span class="ident" id="5378864">src</span><span class="op" id="5378867">.</span><span class="ident" id="5378868">Rect</span><span class="op" id="5378872">.</span><span class="ident" id="5378873">Min</span><span class="op" id="5378876">.</span><span class="ident" id="5378877">X</span><span class="op" id="5378878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378883">ciBase</span>&nbsp;<span class="op" id="5378890">:=</span>&nbsp;<span class="op" id="5378893">(</span><span class="ident" id="5378894">sy</span><span class="op" id="5378896">-</span><span class="ident" id="5378897">src</span><span class="op" id="5378900">.</span><span class="ident" id="5378901">Rect</span><span class="op" id="5378905">.</span><span class="ident" id="5378906">Min</span><span class="op" id="5378909">.</span><span class="ident" id="5378910">Y</span><span class="op" id="5378911">)</span><span class="op" id="5378912">*</span><span class="ident" id="5378913">src</span><span class="op" id="5378916">.</span><span class="ident" id="5378917">CStride</span>&nbsp;<span class="op" id="5378925">-</span>&nbsp;<span class="ident" id="5378927">src</span><span class="op" id="5378930">.</span><span class="ident" id="5378931">Rect</span><span class="op" id="5378935">.</span><span class="ident" id="5378936">Min</span><span class="op" id="5378939">.</span><span class="ident" id="5378940">X</span><span class="op" id="5378941">/</span><span class="num" id="5378942">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378947">for</span>&nbsp;<span class="ident" id="5378951">x</span><span class="op" id="5378952">,</span>&nbsp;<span class="ident" id="5378954">sx</span>&nbsp;<span class="op" id="5378957">:=</span>&nbsp;<span class="ident" id="5378960">x0</span><span class="op" id="5378962">,</span>&nbsp;<span class="ident" id="5378964">sp</span><span class="op" id="5378966">.</span><span class="ident" id="5378967">X</span><span class="op" id="5378968">;</span>&nbsp;<span class="ident" id="5378970">x</span>&nbsp;<span class="op" id="5378972">!=</span>&nbsp;<span class="ident" id="5378975">x1</span><span class="op" id="5378977">;</span>&nbsp;<span class="ident" id="5378979">x</span><span class="op" id="5378980">,</span>&nbsp;<span class="ident" id="5378982">sx</span><span class="op" id="5378984">,</span>&nbsp;<span class="ident" id="5378986">yi</span>&nbsp;<span class="op" id="5378989">=</span>&nbsp;<span class="ident" id="5378991">x</span><span class="op" id="5378992">+</span><span class="num" id="5378993">4</span><span class="op" id="5378994">,</span>&nbsp;<span class="ident" id="5378996">sx</span><span class="op" id="5378998">+</span><span class="num" id="5378999">1</span><span class="op" id="5379000">,</span>&nbsp;<span class="ident" id="5379002">yi</span><span class="op" id="5379004">+</span><span class="num" id="5379005">1</span>&nbsp;<span class="op" id="5379007">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379013">ci</span>&nbsp;<span class="op" id="5379016">:=</span>&nbsp;<span class="ident" id="5379019">ciBase</span>&nbsp;<span class="op" id="5379026">+</span>&nbsp;<span class="ident" id="5379028">sx</span><span class="op" id="5379030">/</span><span class="num" id="5379031">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379037">rr</span><span class="op" id="5379039">,</span>&nbsp;<span class="ident" id="5379041">gg</span><span class="op" id="5379043">,</span>&nbsp;<span class="ident" id="5379045">bb</span>&nbsp;<span class="op" id="5379048">:=</span>&nbsp;<span class="ident" id="5379051">color</span><span class="op" id="5379056">.</span><span class="ident" id="5379057">YCbCrToRGB</span><span class="op" id="5379067">(</span><span class="ident" id="5379068">src</span><span class="op" id="5379071">.</span><span class="ident" id="5379072">Y</span><span class="op" id="5379073">[</span><span class="ident" id="5379074">yi</span><span class="op" id="5379076">]</span><span class="op" id="5379077">,</span>&nbsp;<span class="ident" id="5379079">src</span><span class="op" id="5379082">.</span><span class="ident" id="5379083">Cb</span><span class="op" id="5379085">[</span><span class="ident" id="5379086">ci</span><span class="op" id="5379088">]</span><span class="op" id="5379089">,</span>&nbsp;<span class="ident" id="5379091">src</span><span class="op" id="5379094">.</span><span class="ident" id="5379095">Cr</span><span class="op" id="5379097">[</span><span class="ident" id="5379098">ci</span><span class="op" id="5379100">]</span><span class="op" id="5379101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379107">dpix</span><span class="op" id="5379111">[</span><span class="ident" id="5379112">x</span><span class="op" id="5379113">+</span><span class="num" id="5379114">0</span><span class="op" id="5379115">]</span>&nbsp;<span class="op" id="5379117">=</span>&nbsp;<span class="ident" id="5379119">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379126">dpix</span><span class="op" id="5379130">[</span><span class="ident" id="5379131">x</span><span class="op" id="5379132">+</span><span class="num" id="5379133">1</span><span class="op" id="5379134">]</span>&nbsp;<span class="op" id="5379136">=</span>&nbsp;<span class="ident" id="5379138">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379145">dpix</span><span class="op" id="5379149">[</span><span class="ident" id="5379150">x</span><span class="op" id="5379151">+</span><span class="num" id="5379152">2</span><span class="op" id="5379153">]</span>&nbsp;<span class="op" id="5379155">=</span>&nbsp;<span class="ident" id="5379157">bb</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379164">dpix</span><span class="op" id="5379168">[</span><span class="ident" id="5379169">x</span><span class="op" id="5379170">+</span><span class="num" id="5379171">3</span><span class="op" id="5379172">]</span>&nbsp;<span class="op" id="5379174">=</span>&nbsp;<span class="num" id="5379176">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5379183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5379187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379190">case</span>&nbsp;<span class="ident" id="5379195">image</span><span class="op" id="5379200">.</span><span class="ident" id="5379201">YCbCrSubsampleRatio420</span><span class="op" id="5379223">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379227">for</span>&nbsp;<span class="ident" id="5379231">y</span><span class="op" id="5379232">,</span>&nbsp;<span class="ident" id="5379234">sy</span>&nbsp;<span class="op" id="5379237">:=</span>&nbsp;<span class="ident" id="5379240">y0</span><span class="op" id="5379242">,</span>&nbsp;<span class="ident" id="5379244">sp</span><span class="op" id="5379246">.</span><span class="ident" id="5379247">Y</span><span class="op" id="5379248">;</span>&nbsp;<span class="ident" id="5379250">y</span>&nbsp;<span class="op" id="5379252">!=</span>&nbsp;<span class="ident" id="5379255">y1</span><span class="op" id="5379257">;</span>&nbsp;<span class="ident" id="5379259">y</span><span class="op" id="5379260">,</span>&nbsp;<span class="ident" id="5379262">sy</span>&nbsp;<span class="op" id="5379265">=</span>&nbsp;<span class="ident" id="5379267">y</span><span class="op" id="5379268">+</span><span class="num" id="5379269">1</span><span class="op" id="5379270">,</span>&nbsp;<span class="ident" id="5379272">sy</span><span class="op" id="5379274">+</span><span class="num" id="5379275">1</span>&nbsp;<span class="op" id="5379277">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379282">dpix</span>&nbsp;<span class="op" id="5379287">:=</span>&nbsp;<span class="ident" id="5379290">dst</span><span class="op" id="5379293">.</span><span class="ident" id="5379294">Pix</span><span class="op" id="5379297">[</span><span class="ident" id="5379298">y</span><span class="op" id="5379299">*</span><span class="ident" id="5379300">dst</span><span class="op" id="5379303">.</span><span class="ident" id="5379304">Stride</span><span class="op" id="5379310">:</span><span class="op" id="5379311">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379316">yi</span>&nbsp;<span class="op" id="5379319">:=</span>&nbsp;<span class="op" id="5379322">(</span><span class="ident" id="5379323">sy</span><span class="op" id="5379325">-</span><span class="ident" id="5379326">src</span><span class="op" id="5379329">.</span><span class="ident" id="5379330">Rect</span><span class="op" id="5379334">.</span><span class="ident" id="5379335">Min</span><span class="op" id="5379338">.</span><span class="ident" id="5379339">Y</span><span class="op" id="5379340">)</span><span class="op" id="5379341">*</span><span class="ident" id="5379342">src</span><span class="op" id="5379345">.</span><span class="ident" id="5379346">YStride</span>&nbsp;<span class="op" id="5379354">+</span>&nbsp;<span class="op" id="5379356">(</span><span class="ident" id="5379357">sp</span><span class="op" id="5379359">.</span><span class="ident" id="5379360">X</span>&nbsp;<span class="op" id="5379362">-</span>&nbsp;<span class="ident" id="5379364">src</span><span class="op" id="5379367">.</span><span class="ident" id="5379368">Rect</span><span class="op" id="5379372">.</span><span class="ident" id="5379373">Min</span><span class="op" id="5379376">.</span><span class="ident" id="5379377">X</span><span class="op" id="5379378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379383">ciBase</span>&nbsp;<span class="op" id="5379390">:=</span>&nbsp;<span class="op" id="5379393">(</span><span class="ident" id="5379394">sy</span><span class="op" id="5379396">/</span><span class="num" id="5379397">2</span><span class="op" id="5379398">-</span><span class="ident" id="5379399">src</span><span class="op" id="5379402">.</span><span class="ident" id="5379403">Rect</span><span class="op" id="5379407">.</span><span class="ident" id="5379408">Min</span><span class="op" id="5379411">.</span><span class="ident" id="5379412">Y</span><span class="op" id="5379413">/</span><span class="num" id="5379414">2</span><span class="op" id="5379415">)</span><span class="op" id="5379416">*</span><span class="ident" id="5379417">src</span><span class="op" id="5379420">.</span><span class="ident" id="5379421">CStride</span>&nbsp;<span class="op" id="5379429">-</span>&nbsp;<span class="ident" id="5379431">src</span><span class="op" id="5379434">.</span><span class="ident" id="5379435">Rect</span><span class="op" id="5379439">.</span><span class="ident" id="5379440">Min</span><span class="op" id="5379443">.</span><span class="ident" id="5379444">X</span><span class="op" id="5379445">/</span><span class="num" id="5379446">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379451">for</span>&nbsp;<span class="ident" id="5379455">x</span><span class="op" id="5379456">,</span>&nbsp;<span class="ident" id="5379458">sx</span>&nbsp;<span class="op" id="5379461">:=</span>&nbsp;<span class="ident" id="5379464">x0</span><span class="op" id="5379466">,</span>&nbsp;<span class="ident" id="5379468">sp</span><span class="op" id="5379470">.</span><span class="ident" id="5379471">X</span><span class="op" id="5379472">;</span>&nbsp;<span class="ident" id="5379474">x</span>&nbsp;<span class="op" id="5379476">!=</span>&nbsp;<span class="ident" id="5379479">x1</span><span class="op" id="5379481">;</span>&nbsp;<span class="ident" id="5379483">x</span><span class="op" id="5379484">,</span>&nbsp;<span class="ident" id="5379486">sx</span><span class="op" id="5379488">,</span>&nbsp;<span class="ident" id="5379490">yi</span>&nbsp;<span class="op" id="5379493">=</span>&nbsp;<span class="ident" id="5379495">x</span><span class="op" id="5379496">+</span><span class="num" id="5379497">4</span><span class="op" id="5379498">,</span>&nbsp;<span class="ident" id="5379500">sx</span><span class="op" id="5379502">+</span><span class="num" id="5379503">1</span><span class="op" id="5379504">,</span>&nbsp;<span class="ident" id="5379506">yi</span><span class="op" id="5379508">+</span><span class="num" id="5379509">1</span>&nbsp;<span class="op" id="5379511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379517">ci</span>&nbsp;<span class="op" id="5379520">:=</span>&nbsp;<span class="ident" id="5379523">ciBase</span>&nbsp;<span class="op" id="5379530">+</span>&nbsp;<span class="ident" id="5379532">sx</span><span class="op" id="5379534">/</span><span class="num" id="5379535">2</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379541">rr</span><span class="op" id="5379543">,</span>&nbsp;<span class="ident" id="5379545">gg</span><span class="op" id="5379547">,</span>&nbsp;<span class="ident" id="5379549">bb</span>&nbsp;<span class="op" id="5379552">:=</span>&nbsp;<span class="ident" id="5379555">color</span><span class="op" id="5379560">.</span><span class="ident" id="5379561">YCbCrToRGB</span><span class="op" id="5379571">(</span><span class="ident" id="5379572">src</span><span class="op" id="5379575">.</span><span class="ident" id="5379576">Y</span><span class="op" id="5379577">[</span><span class="ident" id="5379578">yi</span><span class="op" id="5379580">]</span><span class="op" id="5379581">,</span>&nbsp;<span class="ident" id="5379583">src</span><span class="op" id="5379586">.</span><span class="ident" id="5379587">Cb</span><span class="op" id="5379589">[</span><span class="ident" id="5379590">ci</span><span class="op" id="5379592">]</span><span class="op" id="5379593">,</span>&nbsp;<span class="ident" id="5379595">src</span><span class="op" id="5379598">.</span><span class="ident" id="5379599">Cr</span><span class="op" id="5379601">[</span><span class="ident" id="5379602">ci</span><span class="op" id="5379604">]</span><span class="op" id="5379605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379611">dpix</span><span class="op" id="5379615">[</span><span class="ident" id="5379616">x</span><span class="op" id="5379617">+</span><span class="num" id="5379618">0</span><span class="op" id="5379619">]</span>&nbsp;<span class="op" id="5379621">=</span>&nbsp;<span class="ident" id="5379623">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379630">dpix</span><span class="op" id="5379634">[</span><span class="ident" id="5379635">x</span><span class="op" id="5379636">+</span><span class="num" id="5379637">1</span><span class="op" id="5379638">]</span>&nbsp;<span class="op" id="5379640">=</span>&nbsp;<span class="ident" id="5379642">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379649">dpix</span><span class="op" id="5379653">[</span><span class="ident" id="5379654">x</span><span class="op" id="5379655">+</span><span class="num" id="5379656">2</span><span class="op" id="5379657">]</span>&nbsp;<span class="op" id="5379659">=</span>&nbsp;<span class="ident" id="5379661">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379668">dpix</span><span class="op" id="5379672">[</span><span class="ident" id="5379673">x</span><span class="op" id="5379674">+</span><span class="num" id="5379675">3</span><span class="op" id="5379676">]</span>&nbsp;<span class="op" id="5379678">=</span>&nbsp;<span class="num" id="5379680">255</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5379687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5379691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379694">case</span>&nbsp;<span class="ident" id="5379699">image</span><span class="op" id="5379704">.</span><span class="ident" id="5379705">YCbCrSubsampleRatio440</span><span class="op" id="5379727">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379731">for</span>&nbsp;<span class="ident" id="5379735">y</span><span class="op" id="5379736">,</span>&nbsp;<span class="ident" id="5379738">sy</span>&nbsp;<span class="op" id="5379741">:=</span>&nbsp;<span class="ident" id="5379744">y0</span><span class="op" id="5379746">,</span>&nbsp;<span class="ident" id="5379748">sp</span><span class="op" id="5379750">.</span><span class="ident" id="5379751">Y</span><span class="op" id="5379752">;</span>&nbsp;<span class="ident" id="5379754">y</span>&nbsp;<span class="op" id="5379756">!=</span>&nbsp;<span class="ident" id="5379759">y1</span><span class="op" id="5379761">;</span>&nbsp;<span class="ident" id="5379763">y</span><span class="op" id="5379764">,</span>&nbsp;<span class="ident" id="5379766">sy</span>&nbsp;<span class="op" id="5379769">=</span>&nbsp;<span class="ident" id="5379771">y</span><span class="op" id="5379772">+</span><span class="num" id="5379773">1</span><span class="op" id="5379774">,</span>&nbsp;<span class="ident" id="5379776">sy</span><span class="op" id="5379778">+</span><span class="num" id="5379779">1</span>&nbsp;<span class="op" id="5379781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379786">dpix</span>&nbsp;<span class="op" id="5379791">:=</span>&nbsp;<span class="ident" id="5379794">dst</span><span class="op" id="5379797">.</span><span class="ident" id="5379798">Pix</span><span class="op" id="5379801">[</span><span class="ident" id="5379802">y</span><span class="op" id="5379803">*</span><span class="ident" id="5379804">dst</span><span class="op" id="5379807">.</span><span class="ident" id="5379808">Stride</span><span class="op" id="5379814">:</span><span class="op" id="5379815">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379820">yi</span>&nbsp;<span class="op" id="5379823">:=</span>&nbsp;<span class="op" id="5379826">(</span><span class="ident" id="5379827">sy</span><span class="op" id="5379829">-</span><span class="ident" id="5379830">src</span><span class="op" id="5379833">.</span><span class="ident" id="5379834">Rect</span><span class="op" id="5379838">.</span><span class="ident" id="5379839">Min</span><span class="op" id="5379842">.</span><span class="ident" id="5379843">Y</span><span class="op" id="5379844">)</span><span class="op" id="5379845">*</span><span class="ident" id="5379846">src</span><span class="op" id="5379849">.</span><span class="ident" id="5379850">YStride</span>&nbsp;<span class="op" id="5379858">+</span>&nbsp;<span class="op" id="5379860">(</span><span class="ident" id="5379861">sp</span><span class="op" id="5379863">.</span><span class="ident" id="5379864">X</span>&nbsp;<span class="op" id="5379866">-</span>&nbsp;<span class="ident" id="5379868">src</span><span class="op" id="5379871">.</span><span class="ident" id="5379872">Rect</span><span class="op" id="5379876">.</span><span class="ident" id="5379877">Min</span><span class="op" id="5379880">.</span><span class="ident" id="5379881">X</span><span class="op" id="5379882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379887">ci</span>&nbsp;<span class="op" id="5379890">:=</span>&nbsp;<span class="op" id="5379893">(</span><span class="ident" id="5379894">sy</span><span class="op" id="5379896">/</span><span class="num" id="5379897">2</span><span class="op" id="5379898">-</span><span class="ident" id="5379899">src</span><span class="op" id="5379902">.</span><span class="ident" id="5379903">Rect</span><span class="op" id="5379907">.</span><span class="ident" id="5379908">Min</span><span class="op" id="5379911">.</span><span class="ident" id="5379912">Y</span><span class="op" id="5379913">/</span><span class="num" id="5379914">2</span><span class="op" id="5379915">)</span><span class="op" id="5379916">*</span><span class="ident" id="5379917">src</span><span class="op" id="5379920">.</span><span class="ident" id="5379921">CStride</span>&nbsp;<span class="op" id="5379929">+</span>&nbsp;<span class="op" id="5379931">(</span><span class="ident" id="5379932">sp</span><span class="op" id="5379934">.</span><span class="ident" id="5379935">X</span>&nbsp;<span class="op" id="5379937">-</span>&nbsp;<span class="ident" id="5379939">src</span><span class="op" id="5379942">.</span><span class="ident" id="5379943">Rect</span><span class="op" id="5379947">.</span><span class="ident" id="5379948">Min</span><span class="op" id="5379951">.</span><span class="ident" id="5379952">X</span><span class="op" id="5379953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379958">for</span>&nbsp;<span class="ident" id="5379962">x</span>&nbsp;<span class="op" id="5379964">:=</span>&nbsp;<span class="ident" id="5379967">x0</span><span class="op" id="5379969">;</span>&nbsp;<span class="ident" id="5379971">x</span>&nbsp;<span class="op" id="5379973">!=</span>&nbsp;<span class="ident" id="5379976">x1</span><span class="op" id="5379978">;</span>&nbsp;<span class="ident" id="5379980">x</span><span class="op" id="5379981">,</span>&nbsp;<span class="ident" id="5379983">yi</span><span class="op" id="5379985">,</span>&nbsp;<span class="ident" id="5379987">ci</span>&nbsp;<span class="op" id="5379990">=</span>&nbsp;<span class="ident" id="5379992">x</span><span class="op" id="5379993">+</span><span class="num" id="5379994">4</span><span class="op" id="5379995">,</span>&nbsp;<span class="ident" id="5379997">yi</span><span class="op" id="5379999">+</span><span class="num" id="5380000">1</span><span class="op" id="5380001">,</span>&nbsp;<span class="ident" id="5380003">ci</span><span class="op" id="5380005">+</span><span class="num" id="5380006">1</span>&nbsp;<span class="op" id="5380008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380014">rr</span><span class="op" id="5380016">,</span>&nbsp;<span class="ident" id="5380018">gg</span><span class="op" id="5380020">,</span>&nbsp;<span class="ident" id="5380022">bb</span>&nbsp;<span class="op" id="5380025">:=</span>&nbsp;<span class="ident" id="5380028">color</span><span class="op" id="5380033">.</span><span class="ident" id="5380034">YCbCrToRGB</span><span class="op" id="5380044">(</span><span class="ident" id="5380045">src</span><span class="op" id="5380048">.</span><span class="ident" id="5380049">Y</span><span class="op" id="5380050">[</span><span class="ident" id="5380051">yi</span><span class="op" id="5380053">]</span><span class="op" id="5380054">,</span>&nbsp;<span class="ident" id="5380056">src</span><span class="op" id="5380059">.</span><span class="ident" id="5380060">Cb</span><span class="op" id="5380062">[</span><span class="ident" id="5380063">ci</span><span class="op" id="5380065">]</span><span class="op" id="5380066">,</span>&nbsp;<span class="ident" id="5380068">src</span><span class="op" id="5380071">.</span><span class="ident" id="5380072">Cr</span><span class="op" id="5380074">[</span><span class="ident" id="5380075">ci</span><span class="op" id="5380077">]</span><span class="op" id="5380078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380084">dpix</span><span class="op" id="5380088">[</span><span class="ident" id="5380089">x</span><span class="op" id="5380090">+</span><span class="num" id="5380091">0</span><span class="op" id="5380092">]</span>&nbsp;<span class="op" id="5380094">=</span>&nbsp;<span class="ident" id="5380096">rr</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380103">dpix</span><span class="op" id="5380107">[</span><span class="ident" id="5380108">x</span><span class="op" id="5380109">+</span><span class="num" id="5380110">1</span><span class="op" id="5380111">]</span>&nbsp;<span class="op" id="5380113">=</span>&nbsp;<span class="ident" id="5380115">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380122">dpix</span><span class="op" id="5380126">[</span><span class="ident" id="5380127">x</span><span class="op" id="5380128">+</span><span class="num" id="5380129">2</span><span class="op" id="5380130">]</span>&nbsp;<span class="op" id="5380132">=</span>&nbsp;<span class="ident" id="5380134">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380141">dpix</span><span class="op" id="5380145">[</span><span class="ident" id="5380146">x</span><span class="op" id="5380147">+</span><span class="num" id="5380148">3</span><span class="op" id="5380149">]</span>&nbsp;<span class="op" id="5380151">=</span>&nbsp;<span class="num" id="5380153">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5380160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5380164">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380167">default</span><span class="op" id="5380174">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380178">return</span>&nbsp;<span class="builtintype" id="5380185">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5380192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380195">return</span>&nbsp;<span class="builtintype" id="5380202">true</span><br>
<span class="lineno"></span><span class="op" id="5380207">}</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="5380210">func</span>&nbsp;<span class="ident" id="5380215">drawGlyphOver</span><span class="op" id="5380228">(</span><span class="ident" id="5380229">dst</span>&nbsp;<span class="op" id="5380233">*</span><span class="ident" id="5380234">image</span><span class="op" id="5380239">.</span><span class="ident" id="5380240">RGBA</span><span class="op" id="5380244">,</span>&nbsp;<span class="ident" id="5380246">r</span>&nbsp;<span class="ident" id="5380248">image</span><span class="op" id="5380253">.</span><span class="ident" id="5380254">Rectangle</span><span class="op" id="5380263">,</span>&nbsp;<span class="ident" id="5380265">src</span>&nbsp;<span class="op" id="5380269">*</span><span class="ident" id="5380270">image</span><span class="op" id="5380275">.</span><span class="ident" id="5380276">Uniform</span><span class="op" id="5380283">,</span>&nbsp;<span class="ident" id="5380285">mask</span>&nbsp;<span class="op" id="5380290">*</span><span class="ident" id="5380291">image</span><span class="op" id="5380296">.</span><span class="ident" id="5380297">Alpha</span><span class="op" id="5380302">,</span>&nbsp;<span class="ident" id="5380304">mp</span>&nbsp;<span class="ident" id="5380307">image</span><span class="op" id="5380312">.</span><span class="ident" id="5380313">Point</span><span class="op" id="5380318">)</span>&nbsp;<span class="op" id="5380320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380323">i0</span>&nbsp;<span class="op" id="5380326">:=</span>&nbsp;<span class="ident" id="5380329">dst</span><span class="op" id="5380332">.</span><span class="ident" id="5380333">PixOffset</span><span class="op" id="5380342">(</span><span class="ident" id="5380343">r</span><span class="op" id="5380344">.</span><span class="ident" id="5380345">Min</span><span class="op" id="5380348">.</span><span class="ident" id="5380349">X</span><span class="op" id="5380350">,</span>&nbsp;<span class="ident" id="5380352">r</span><span class="op" id="5380353">.</span><span class="ident" id="5380354">Min</span><span class="op" id="5380357">.</span><span class="ident" id="5380358">Y</span><span class="op" id="5380359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380362">i1</span>&nbsp;<span class="op" id="5380365">:=</span>&nbsp;<span class="ident" id="5380368">i0</span>&nbsp;<span class="op" id="5380371">+</span>&nbsp;<span class="ident" id="5380373">r</span><span class="op" id="5380374">.</span><span class="ident" id="5380375">Dx</span><span class="op" id="5380377">(</span><span class="op" id="5380378">)</span><span class="op" id="5380379">*</span><span class="num" id="5380380">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380383">mi0</span>&nbsp;<span class="op" id="5380387">:=</span>&nbsp;<span class="ident" id="5380390">mask</span><span class="op" id="5380394">.</span><span class="ident" id="5380395">PixOffset</span><span class="op" id="5380404">(</span><span class="ident" id="5380405">mp</span><span class="op" id="5380407">.</span><span class="ident" id="5380408">X</span><span class="op" id="5380409">,</span>&nbsp;<span class="ident" id="5380411">mp</span><span class="op" id="5380413">.</span><span class="ident" id="5380414">Y</span><span class="op" id="5380415">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380418">sr</span><span class="op" id="5380420">,</span>&nbsp;<span class="ident" id="5380422">sg</span><span class="op" id="5380424">,</span>&nbsp;<span class="ident" id="5380426">sb</span><span class="op" id="5380428">,</span>&nbsp;<span class="ident" id="5380430">sa</span>&nbsp;<span class="op" id="5380433">:=</span>&nbsp;<span class="ident" id="5380436">src</span><span class="op" id="5380439">.</span><span class="ident" id="5380440">RGBA</span><span class="op" id="5380444">(</span><span class="op" id="5380445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380448">for</span>&nbsp;<span class="ident" id="5380452">y</span><span class="op" id="5380453">,</span>&nbsp;<span class="ident" id="5380455">my</span>&nbsp;<span class="op" id="5380458">:=</span>&nbsp;<span class="ident" id="5380461">r</span><span class="op" id="5380462">.</span><span class="ident" id="5380463">Min</span><span class="op" id="5380466">.</span><span class="ident" id="5380467">Y</span><span class="op" id="5380468">,</span>&nbsp;<span class="ident" id="5380470">mp</span><span class="op" id="5380472">.</span><span class="ident" id="5380473">Y</span><span class="op" id="5380474">;</span>&nbsp;<span class="ident" id="5380476">y</span>&nbsp;<span class="op" id="5380478">!=</span>&nbsp;<span class="ident" id="5380481">r</span><span class="op" id="5380482">.</span><span class="ident" id="5380483">Max</span><span class="op" id="5380486">.</span><span class="ident" id="5380487">Y</span><span class="op" id="5380488">;</span>&nbsp;<span class="ident" id="5380490">y</span><span class="op" id="5380491">,</span>&nbsp;<span class="ident" id="5380493">my</span>&nbsp;<span class="op" id="5380496">=</span>&nbsp;<span class="ident" id="5380498">y</span><span class="op" id="5380499">+</span><span class="num" id="5380500">1</span><span class="op" id="5380501">,</span>&nbsp;<span class="ident" id="5380503">my</span><span class="op" id="5380505">+</span><span class="num" id="5380506">1</span>&nbsp;<span class="op" id="5380508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380512">for</span>&nbsp;<span class="ident" id="5380516">i</span><span class="op" id="5380517">,</span>&nbsp;<span class="ident" id="5380519">mi</span>&nbsp;<span class="op" id="5380522">:=</span>&nbsp;<span class="ident" id="5380525">i0</span><span class="op" id="5380527">,</span>&nbsp;<span class="ident" id="5380529">mi0</span><span class="op" id="5380532">;</span>&nbsp;<span class="ident" id="5380534">i</span>&nbsp;<span class="op" id="5380536">&lt;</span>&nbsp;<span class="ident" id="5380538">i1</span><span class="op" id="5380540">;</span>&nbsp;<span class="ident" id="5380542">i</span><span class="op" id="5380543">,</span>&nbsp;<span class="ident" id="5380545">mi</span>&nbsp;<span class="op" id="5380548">=</span>&nbsp;<span class="ident" id="5380550">i</span><span class="op" id="5380551">+</span><span class="num" id="5380552">4</span><span class="op" id="5380553">,</span>&nbsp;<span class="ident" id="5380555">mi</span><span class="op" id="5380557">+</span><span class="num" id="5380558">1</span>&nbsp;<span class="op" id="5380560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380565">ma</span>&nbsp;<span class="op" id="5380568">:=</span>&nbsp;<span class="builtintype" id="5380571">uint32</span><span class="op" id="5380577">(</span><span class="ident" id="5380578">mask</span><span class="op" id="5380582">.</span><span class="ident" id="5380583">Pix</span><span class="op" id="5380586">[</span><span class="ident" id="5380587">mi</span><span class="op" id="5380589">]</span><span class="op" id="5380590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380595">if</span>&nbsp;<span class="ident" id="5380598">ma</span>&nbsp;<span class="op" id="5380601">==</span>&nbsp;<span class="num" id="5380604">0</span>&nbsp;<span class="op" id="5380606">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380612">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5380624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380629">ma</span>&nbsp;<span class="op" id="5380632">|=</span>&nbsp;<span class="ident" id="5380635">ma</span>&nbsp;<span class="op" id="5380638">&lt;&lt;</span>&nbsp;<span class="num" id="5380641">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380647">dr</span>&nbsp;<span class="op" id="5380650">:=</span>&nbsp;<span class="builtintype" id="5380653">uint32</span><span class="op" id="5380659">(</span><span class="ident" id="5380660">dst</span><span class="op" id="5380663">.</span><span class="ident" id="5380664">Pix</span><span class="op" id="5380667">[</span><span class="ident" id="5380668">i</span><span class="op" id="5380669">+</span><span class="num" id="5380670">0</span><span class="op" id="5380671">]</span><span class="op" id="5380672">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380677">dg</span>&nbsp;<span class="op" id="5380680">:=</span>&nbsp;<span class="builtintype" id="5380683">uint32</span><span class="op" id="5380689">(</span><span class="ident" id="5380690">dst</span><span class="op" id="5380693">.</span><span class="ident" id="5380694">Pix</span><span class="op" id="5380697">[</span><span class="ident" id="5380698">i</span><span class="op" id="5380699">+</span><span class="num" id="5380700">1</span><span class="op" id="5380701">]</span><span class="op" id="5380702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380707">db</span>&nbsp;<span class="op" id="5380710">:=</span>&nbsp;<span class="builtintype" id="5380713">uint32</span><span class="op" id="5380719">(</span><span class="ident" id="5380720">dst</span><span class="op" id="5380723">.</span><span class="ident" id="5380724">Pix</span><span class="op" id="5380727">[</span><span class="ident" id="5380728">i</span><span class="op" id="5380729">+</span><span class="num" id="5380730">2</span><span class="op" id="5380731">]</span><span class="op" id="5380732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380737">da</span>&nbsp;<span class="op" id="5380740">:=</span>&nbsp;<span class="builtintype" id="5380743">uint32</span><span class="op" id="5380749">(</span><span class="ident" id="5380750">dst</span><span class="op" id="5380753">.</span><span class="ident" id="5380754">Pix</span><span class="op" id="5380757">[</span><span class="ident" id="5380758">i</span><span class="op" id="5380759">+</span><span class="num" id="5380760">3</span><span class="op" id="5380761">]</span><span class="op" id="5380762">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5380768">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380828">a</span>&nbsp;<span class="op" id="5380830">:=</span>&nbsp;<span class="op" id="5380833">(</span><span class="ident" id="5380834">m</span>&nbsp;<span class="op" id="5380836">-</span>&nbsp;<span class="op" id="5380838">(</span><span class="ident" id="5380839">sa</span>&nbsp;<span class="op" id="5380842">*</span>&nbsp;<span class="ident" id="5380844">ma</span>&nbsp;<span class="op" id="5380847">/</span>&nbsp;<span class="ident" id="5380849">m</span><span class="op" id="5380850">)</span><span class="op" id="5380851">)</span>&nbsp;<span class="op" id="5380853">*</span>&nbsp;<span class="num" id="5380855">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380865">dst</span><span class="op" id="5380868">.</span><span class="ident" id="5380869">Pix</span><span class="op" id="5380872">[</span><span class="ident" id="5380873">i</span><span class="op" id="5380874">+</span><span class="num" id="5380875">0</span><span class="op" id="5380876">]</span>&nbsp;<span class="op" id="5380878">=</span>&nbsp;<span class="builtintype" id="5380880">uint8</span><span class="op" id="5380885">(</span><span class="op" id="5380886">(</span><span class="ident" id="5380887">dr</span><span class="op" id="5380889">*</span><span class="ident" id="5380890">a</span>&nbsp;<span class="op" id="5380892">+</span>&nbsp;<span class="ident" id="5380894">sr</span><span class="op" id="5380896">*</span><span class="ident" id="5380897">ma</span><span class="op" id="5380899">)</span>&nbsp;<span class="op" id="5380901">/</span>&nbsp;<span class="ident" id="5380903">m</span>&nbsp;<span class="op" id="5380905">&gt;&gt;</span>&nbsp;<span class="num" id="5380908">8</span><span class="op" id="5380909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380914">dst</span><span class="op" id="5380917">.</span><span class="ident" id="5380918">Pix</span><span class="op" id="5380921">[</span><span class="ident" id="5380922">i</span><span class="op" id="5380923">+</span><span class="num" id="5380924">1</span><span class="op" id="5380925">]</span>&nbsp;<span class="op" id="5380927">=</span>&nbsp;<span class="builtintype" id="5380929">uint8</span><span class="op" id="5380934">(</span><span class="op" id="5380935">(</span><span class="ident" id="5380936">dg</span><span class="op" id="5380938">*</span><span class="ident" id="5380939">a</span>&nbsp;<span class="op" id="5380941">+</span>&nbsp;<span class="ident" id="5380943">sg</span><span class="op" id="5380945">*</span><span class="ident" id="5380946">ma</span><span class="op" id="5380948">)</span>&nbsp;<span class="op" id="5380950">/</span>&nbsp;<span class="ident" id="5380952">m</span>&nbsp;<span class="op" id="5380954">&gt;&gt;</span>&nbsp;<span class="num" id="5380957">8</span><span class="op" id="5380958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380963">dst</span><span class="op" id="5380966">.</span><span class="ident" id="5380967">Pix</span><span class="op" id="5380970">[</span><span class="ident" id="5380971">i</span><span class="op" id="5380972">+</span><span class="num" id="5380973">2</span><span class="op" id="5380974">]</span>&nbsp;<span class="op" id="5380976">=</span>&nbsp;<span class="builtintype" id="5380978">uint8</span><span class="op" id="5380983">(</span><span class="op" id="5380984">(</span><span class="ident" id="5380985">db</span><span class="op" id="5380987">*</span><span class="ident" id="5380988">a</span>&nbsp;<span class="op" id="5380990">+</span>&nbsp;<span class="ident" id="5380992">sb</span><span class="op" id="5380994">*</span><span class="ident" id="5380995">ma</span><span class="op" id="5380997">)</span>&nbsp;<span class="op" id="5380999">/</span>&nbsp;<span class="ident" id="5381001">m</span>&nbsp;<span class="op" id="5381003">&gt;&gt;</span>&nbsp;<span class="num" id="5381006">8</span><span class="op" id="5381007">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381012">dst</span><span class="op" id="5381015">.</span><span class="ident" id="5381016">Pix</span><span class="op" id="5381019">[</span><span class="ident" id="5381020">i</span><span class="op" id="5381021">+</span><span class="num" id="5381022">3</span><span class="op" id="5381023">]</span>&nbsp;<span class="op" id="5381025">=</span>&nbsp;<span class="builtintype" id="5381027">uint8</span><span class="op" id="5381032">(</span><span class="op" id="5381033">(</span><span class="ident" id="5381034">da</span><span class="op" id="5381036">*</span><span class="ident" id="5381037">a</span>&nbsp;<span class="op" id="5381039">+</span>&nbsp;<span class="ident" id="5381041">sa</span><span class="op" id="5381043">*</span><span class="ident" id="5381044">ma</span><span class="op" id="5381046">)</span>&nbsp;<span class="op" id="5381048">/</span>&nbsp;<span class="ident" id="5381050">m</span>&nbsp;<span class="op" id="5381052">&gt;&gt;</span>&nbsp;<span class="num" id="5381055">8</span><span class="op" id="5381056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381064">i0</span>&nbsp;<span class="op" id="5381067">+=</span>&nbsp;<span class="ident" id="5381070">dst</span><span class="op" id="5381073">.</span><span class="ident" id="5381074">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381083">i1</span>&nbsp;<span class="op" id="5381086">+=</span>&nbsp;<span class="ident" id="5381089">dst</span><span class="op" id="5381092">.</span><span class="ident" id="5381093">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381102">mi0</span>&nbsp;<span class="op" id="5381106">+=</span>&nbsp;<span class="ident" id="5381109">mask</span><span class="op" id="5381113">.</span><span class="ident" id="5381114">Stride</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381122">}</span><br>
<span class="lineno"></span><span class="op" id="5381124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5381127">func</span>&nbsp;<span class="ident" id="5381132">drawRGBA</span><span class="op" id="5381140">(</span><span class="ident" id="5381141">dst</span>&nbsp;<span class="op" id="5381145">*</span><span class="ident" id="5381146">image</span><span class="op" id="5381151">.</span><span class="ident" id="5381152">RGBA</span><span class="op" id="5381156">,</span>&nbsp;<span class="ident" id="5381158">r</span>&nbsp;<span class="ident" id="5381160">image</span><span class="op" id="5381165">.</span><span class="ident" id="5381166">Rectangle</span><span class="op" id="5381175">,</span>&nbsp;<span class="ident" id="5381177">src</span>&nbsp;<span class="ident" id="5381181">image</span><span class="op" id="5381186">.</span><span class="ident" id="5381187">Image</span><span class="op" id="5381192">,</span>&nbsp;<span class="ident" id="5381194">sp</span>&nbsp;<span class="ident" id="5381197">image</span><span class="op" id="5381202">.</span><span class="ident" id="5381203">Point</span><span class="op" id="5381208">,</span>&nbsp;<span class="ident" id="5381210">mask</span>&nbsp;<span class="ident" id="5381215">image</span><span class="op" id="5381220">.</span><span class="ident" id="5381221">Image</span><span class="op" id="5381226">,</span>&nbsp;<span class="ident" id="5381228">mp</span>&nbsp;<span class="ident" id="5381231">image</span><span class="op" id="5381236">.</span><span class="ident" id="5381237">Point</span><span class="op" id="5381242">,</span>&nbsp;<span class="ident" id="5381244">op</span>&nbsp;<span class="ident" id="5381247">Op</span><span class="op" id="5381249">)</span>&nbsp;<span class="op" id="5381251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381254">x0</span><span class="op" id="5381256">,</span>&nbsp;<span class="ident" id="5381258">x1</span><span class="op" id="5381260">,</span>&nbsp;<span class="ident" id="5381262">dx</span>&nbsp;<span class="op" id="5381265">:=</span>&nbsp;<span class="ident" id="5381268">r</span><span class="op" id="5381269">.</span><span class="ident" id="5381270">Min</span><span class="op" id="5381273">.</span><span class="ident" id="5381274">X</span><span class="op" id="5381275">,</span>&nbsp;<span class="ident" id="5381277">r</span><span class="op" id="5381278">.</span><span class="ident" id="5381279">Max</span><span class="op" id="5381282">.</span><span class="ident" id="5381283">X</span><span class="op" id="5381284">,</span>&nbsp;<span class="num" id="5381286">1</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381289">y0</span><span class="op" id="5381291">,</span>&nbsp;<span class="ident" id="5381293">y1</span><span class="op" id="5381295">,</span>&nbsp;<span class="ident" id="5381297">dy</span>&nbsp;<span class="op" id="5381300">:=</span>&nbsp;<span class="ident" id="5381303">r</span><span class="op" id="5381304">.</span><span class="ident" id="5381305">Min</span><span class="op" id="5381308">.</span><span class="ident" id="5381309">Y</span><span class="op" id="5381310">,</span>&nbsp;<span class="ident" id="5381312">r</span><span class="op" id="5381313">.</span><span class="ident" id="5381314">Max</span><span class="op" id="5381317">.</span><span class="ident" id="5381318">Y</span><span class="op" id="5381319">,</span>&nbsp;<span class="num" id="5381321">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381324">if</span>&nbsp;<span class="ident" id="5381327">image</span><span class="op" id="5381332">.</span><span class="ident" id="5381333">Image</span><span class="op" id="5381338">(</span><span class="ident" id="5381339">dst</span><span class="op" id="5381342">)</span>&nbsp;<span class="op" id="5381344">==</span>&nbsp;<span class="ident" id="5381347">src</span>&nbsp;<span class="op" id="5381351">&amp;&amp;</span>&nbsp;<span class="ident" id="5381354">r</span><span class="op" id="5381355">.</span><span class="ident" id="5381356">Overlaps</span><span class="op" id="5381364">(</span><span class="ident" id="5381365">r</span><span class="op" id="5381366">.</span><span class="ident" id="5381367">Add</span><span class="op" id="5381370">(</span><span class="ident" id="5381371">sp</span><span class="op" id="5381373">.</span><span class="ident" id="5381374">Sub</span><span class="op" id="5381377">(</span><span class="ident" id="5381378">r</span><span class="op" id="5381379">.</span><span class="ident" id="5381380">Min</span><span class="op" id="5381383">)</span><span class="op" id="5381384">)</span><span class="op" id="5381385">)</span>&nbsp;<span class="op" id="5381387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381391">if</span>&nbsp;<span class="ident" id="5381394">sp</span><span class="op" id="5381396">.</span><span class="ident" id="5381397">Y</span>&nbsp;<span class="op" id="5381399">&lt;</span>&nbsp;<span class="ident" id="5381401">r</span><span class="op" id="5381402">.</span><span class="ident" id="5381403">Min</span><span class="op" id="5381406">.</span><span class="ident" id="5381407">Y</span>&nbsp;<span class="op" id="5381409">||</span>&nbsp;<span class="ident" id="5381412">sp</span><span class="op" id="5381414">.</span><span class="ident" id="5381415">Y</span>&nbsp;<span class="op" id="5381417">==</span>&nbsp;<span class="ident" id="5381420">r</span><span class="op" id="5381421">.</span><span class="ident" id="5381422">Min</span><span class="op" id="5381425">.</span><span class="ident" id="5381426">Y</span>&nbsp;<span class="op" id="5381428">&amp;&amp;</span>&nbsp;<span class="ident" id="5381431">sp</span><span class="op" id="5381433">.</span><span class="ident" id="5381434">X</span>&nbsp;<span class="op" id="5381436">&lt;</span>&nbsp;<span class="ident" id="5381438">r</span><span class="op" id="5381439">.</span><span class="ident" id="5381440">Min</span><span class="op" id="5381443">.</span><span class="ident" id="5381444">X</span>&nbsp;<span class="op" id="5381446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381451">x0</span><span class="op" id="5381453">,</span>&nbsp;<span class="ident" id="5381455">x1</span><span class="op" id="5381457">,</span>&nbsp;<span class="ident" id="5381459">dx</span>&nbsp;<span class="op" id="5381462">=</span>&nbsp;<span class="ident" id="5381464">x1</span><span class="op" id="5381466">-</span><span class="num" id="5381467">1</span><span class="op" id="5381468">,</span>&nbsp;<span class="ident" id="5381470">x0</span><span class="op" id="5381472">-</span><span class="num" id="5381473">1</span><span class="op" id="5381474">,</span>&nbsp;<span class="op" id="5381476">-</span><span class="num" id="5381477">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381482">y0</span><span class="op" id="5381484">,</span>&nbsp;<span class="ident" id="5381486">y1</span><span class="op" id="5381488">,</span>&nbsp;<span class="ident" id="5381490">dy</span>&nbsp;<span class="op" id="5381493">=</span>&nbsp;<span class="ident" id="5381495">y1</span><span class="op" id="5381497">-</span><span class="num" id="5381498">1</span><span class="op" id="5381499">,</span>&nbsp;<span class="ident" id="5381501">y0</span><span class="op" id="5381503">-</span><span class="num" id="5381504">1</span><span class="op" id="5381505">,</span>&nbsp;<span class="op" id="5381507">-</span><span class="num" id="5381508">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381519">sy</span>&nbsp;<span class="op" id="5381522">:=</span>&nbsp;<span class="ident" id="5381525">sp</span><span class="op" id="5381527">.</span><span class="ident" id="5381528">Y</span>&nbsp;<span class="op" id="5381530">+</span>&nbsp;<span class="ident" id="5381532">y0</span>&nbsp;<span class="op" id="5381535">-</span>&nbsp;<span class="ident" id="5381537">r</span><span class="op" id="5381538">.</span><span class="ident" id="5381539">Min</span><span class="op" id="5381542">.</span><span class="ident" id="5381543">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381546">my</span>&nbsp;<span class="op" id="5381549">:=</span>&nbsp;<span class="ident" id="5381552">mp</span><span class="op" id="5381554">.</span><span class="ident" id="5381555">Y</span>&nbsp;<span class="op" id="5381557">+</span>&nbsp;<span class="ident" id="5381559">y0</span>&nbsp;<span class="op" id="5381562">-</span>&nbsp;<span class="ident" id="5381564">r</span><span class="op" id="5381565">.</span><span class="ident" id="5381566">Min</span><span class="op" id="5381569">.</span><span class="ident" id="5381570">Y</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381573">sx0</span>&nbsp;<span class="op" id="5381577">:=</span>&nbsp;<span class="ident" id="5381580">sp</span><span class="op" id="5381582">.</span><span class="ident" id="5381583">X</span>&nbsp;<span class="op" id="5381585">+</span>&nbsp;<span class="ident" id="5381587">x0</span>&nbsp;<span class="op" id="5381590">-</span>&nbsp;<span class="ident" id="5381592">r</span><span class="op" id="5381593">.</span><span class="ident" id="5381594">Min</span><span class="op" id="5381597">.</span><span class="ident" id="5381598">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381601">mx0</span>&nbsp;<span class="op" id="5381605">:=</span>&nbsp;<span class="ident" id="5381608">mp</span><span class="op" id="5381610">.</span><span class="ident" id="5381611">X</span>&nbsp;<span class="op" id="5381613">+</span>&nbsp;<span class="ident" id="5381615">x0</span>&nbsp;<span class="op" id="5381618">-</span>&nbsp;<span class="ident" id="5381620">r</span><span class="op" id="5381621">.</span><span class="ident" id="5381622">Min</span><span class="op" id="5381625">.</span><span class="ident" id="5381626">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381629">sx1</span>&nbsp;<span class="op" id="5381633">:=</span>&nbsp;<span class="ident" id="5381636">sx0</span>&nbsp;<span class="op" id="5381640">+</span>&nbsp;<span class="op" id="5381642">(</span><span class="ident" id="5381643">x1</span>&nbsp;<span class="op" id="5381646">-</span>&nbsp;<span class="ident" id="5381648">x0</span><span class="op" id="5381650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381653">i0</span>&nbsp;<span class="op" id="5381656">:=</span>&nbsp;<span class="ident" id="5381659">dst</span><span class="op" id="5381662">.</span><span class="ident" id="5381663">PixOffset</span><span class="op" id="5381672">(</span><span class="ident" id="5381673">x0</span><span class="op" id="5381675">,</span>&nbsp;<span class="ident" id="5381677">y0</span><span class="op" id="5381679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381682">di</span>&nbsp;<span class="op" id="5381685">:=</span>&nbsp;<span class="ident" id="5381688">dx</span>&nbsp;<span class="op" id="5381691">*</span>&nbsp;<span class="num" id="5381693">4</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381696">for</span>&nbsp;<span class="ident" id="5381700">y</span>&nbsp;<span class="op" id="5381702">:=</span>&nbsp;<span class="ident" id="5381705">y0</span><span class="op" id="5381707">;</span>&nbsp;<span class="ident" id="5381709">y</span>&nbsp;<span class="op" id="5381711">!=</span>&nbsp;<span class="ident" id="5381714">y1</span><span class="op" id="5381716">;</span>&nbsp;<span class="ident" id="5381718">y</span><span class="op" id="5381719">,</span>&nbsp;<span class="ident" id="5381721">sy</span><span class="op" id="5381723">,</span>&nbsp;<span class="ident" id="5381725">my</span>&nbsp;<span class="op" id="5381728">=</span>&nbsp;<span class="ident" id="5381730">y</span><span class="op" id="5381731">+</span><span class="ident" id="5381732">dy</span><span class="op" id="5381734">,</span>&nbsp;<span class="ident" id="5381736">sy</span><span class="op" id="5381738">+</span><span class="ident" id="5381739">dy</span><span class="op" id="5381741">,</span>&nbsp;<span class="ident" id="5381743">my</span><span class="op" id="5381745">+</span><span class="ident" id="5381746">dy</span>&nbsp;<span class="op" id="5381749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381753">for</span>&nbsp;<span class="ident" id="5381757">i</span><span class="op" id="5381758">,</span>&nbsp;<span class="ident" id="5381760">sx</span><span class="op" id="5381762">,</span>&nbsp;<span class="ident" id="5381764">mx</span>&nbsp;<span class="op" id="5381767">:=</span>&nbsp;<span class="ident" id="5381770">i0</span><span class="op" id="5381772">,</span>&nbsp;<span class="ident" id="5381774">sx0</span><span class="op" id="5381777">,</span>&nbsp;<span class="ident" id="5381779">mx0</span><span class="op" id="5381782">;</span>&nbsp;<span class="ident" id="5381784">sx</span>&nbsp;<span class="op" id="5381787">!=</span>&nbsp;<span class="ident" id="5381790">sx1</span><span class="op" id="5381793">;</span>&nbsp;<span class="ident" id="5381795">i</span><span class="op" id="5381796">,</span>&nbsp;<span class="ident" id="5381798">sx</span><span class="op" id="5381800">,</span>&nbsp;<span class="ident" id="5381802">mx</span>&nbsp;<span class="op" id="5381805">=</span>&nbsp;<span class="ident" id="5381807">i</span><span class="op" id="5381808">+</span><span class="ident" id="5381809">di</span><span class="op" id="5381811">,</span>&nbsp;<span class="ident" id="5381813">sx</span><span class="op" id="5381815">+</span><span class="ident" id="5381816">dx</span><span class="op" id="5381818">,</span>&nbsp;<span class="ident" id="5381820">mx</span><span class="op" id="5381822">+</span><span class="ident" id="5381823">dx</span>&nbsp;<span class="op" id="5381826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381831">ma</span>&nbsp;<span class="op" id="5381834">:=</span>&nbsp;<span class="builtintype" id="5381837">uint32</span><span class="op" id="5381843">(</span><span class="ident" id="5381844">m</span><span class="op" id="5381845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381850">if</span>&nbsp;<span class="ident" id="5381853">mask</span>&nbsp;<span class="op" id="5381858">!=</span>&nbsp;<span class="ident" id="5381861">nil</span>&nbsp;<span class="op" id="5381865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381871">_</span><span class="op" id="5381872">,</span>&nbsp;<span class="ident" id="5381874">_</span><span class="op" id="5381875">,</span>&nbsp;<span class="ident" id="5381877">_</span><span class="op" id="5381878">,</span>&nbsp;<span class="ident" id="5381880">ma</span>&nbsp;<span class="op" id="5381883">=</span>&nbsp;<span class="ident" id="5381885">mask</span><span class="op" id="5381889">.</span><span class="ident" id="5381890">At</span><span class="op" id="5381892">(</span><span class="ident" id="5381893">mx</span><span class="op" id="5381895">,</span>&nbsp;<span class="ident" id="5381897">my</span><span class="op" id="5381899">)</span><span class="op" id="5381900">.</span><span class="ident" id="5381901">RGBA</span><span class="op" id="5381905">(</span><span class="op" id="5381906">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381916">sr</span><span class="op" id="5381918">,</span>&nbsp;<span class="ident" id="5381920">sg</span><span class="op" id="5381922">,</span>&nbsp;<span class="ident" id="5381924">sb</span><span class="op" id="5381926">,</span>&nbsp;<span class="ident" id="5381928">sa</span>&nbsp;<span class="op" id="5381931">:=</span>&nbsp;<span class="ident" id="5381934">src</span><span class="op" id="5381937">.</span><span class="ident" id="5381938">At</span><span class="op" id="5381940">(</span><span class="ident" id="5381941">sx</span><span class="op" id="5381943">,</span>&nbsp;<span class="ident" id="5381945">sy</span><span class="op" id="5381947">)</span><span class="op" id="5381948">.</span><span class="ident" id="5381949">RGBA</span><span class="op" id="5381953">(</span><span class="op" id="5381954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381959">if</span>&nbsp;<span class="ident" id="5381962">op</span>&nbsp;<span class="op" id="5381965">==</span>&nbsp;<span class="ident" id="5381968">Over</span>&nbsp;<span class="op" id="5381973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381979">dr</span>&nbsp;<span class="op" id="5381982">:=</span>&nbsp;<span class="builtintype" id="5381985">uint32</span><span class="op" id="5381991">(</span><span class="ident" id="5381992">dst</span><span class="op" id="5381995">.</span><span class="ident" id="5381996">Pix</span><span class="op" id="5381999">[</span><span class="ident" id="5382000">i</span><span class="op" id="5382001">+</span><span class="num" id="5382002">0</span><span class="op" id="5382003">]</span><span class="op" id="5382004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382010">dg</span>&nbsp;<span class="op" id="5382013">:=</span>&nbsp;<span class="builtintype" id="5382016">uint32</span><span class="op" id="5382022">(</span><span class="ident" id="5382023">dst</span><span class="op" id="5382026">.</span><span class="ident" id="5382027">Pix</span><span class="op" id="5382030">[</span><span class="ident" id="5382031">i</span><span class="op" id="5382032">+</span><span class="num" id="5382033">1</span><span class="op" id="5382034">]</span><span class="op" id="5382035">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382041">db</span>&nbsp;<span class="op" id="5382044">:=</span>&nbsp;<span class="builtintype" id="5382047">uint32</span><span class="op" id="5382053">(</span><span class="ident" id="5382054">dst</span><span class="op" id="5382057">.</span><span class="ident" id="5382058">Pix</span><span class="op" id="5382061">[</span><span class="ident" id="5382062">i</span><span class="op" id="5382063">+</span><span class="num" id="5382064">2</span><span class="op" id="5382065">]</span><span class="op" id="5382066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382072">da</span>&nbsp;<span class="op" id="5382075">:=</span>&nbsp;<span class="builtintype" id="5382078">uint32</span><span class="op" id="5382084">(</span><span class="ident" id="5382085">dst</span><span class="op" id="5382088">.</span><span class="ident" id="5382089">Pix</span><span class="op" id="5382092">[</span><span class="ident" id="5382093">i</span><span class="op" id="5382094">+</span><span class="num" id="5382095">3</span><span class="op" id="5382096">]</span><span class="op" id="5382097">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382104">//&nbsp;dr,&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da&nbsp;are&nbsp;all&nbsp;8-bit&nbsp;color&nbsp;at&nbsp;the&nbsp;moment,&nbsp;ranging&nbsp;in&nbsp;[0,255].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382184">//&nbsp;We&nbsp;work&nbsp;in&nbsp;16-bit&nbsp;color,&nbsp;and&nbsp;so&nbsp;would&nbsp;normally&nbsp;do:</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382242">//&nbsp;dr&nbsp;|=&nbsp;dr&nbsp;&lt;&lt;&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382263">//&nbsp;and&nbsp;similarly&nbsp;for&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da,&nbsp;but&nbsp;instead&nbsp;we&nbsp;multiply&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382329">//&nbsp;(which&nbsp;is&nbsp;a&nbsp;16-bit&nbsp;color,&nbsp;ranging&nbsp;in&nbsp;[0,65535])&nbsp;by&nbsp;0x101.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382394">//&nbsp;This&nbsp;yields&nbsp;the&nbsp;same&nbsp;result,&nbsp;but&nbsp;is&nbsp;fewer&nbsp;arithmetic&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382466">a</span>&nbsp;<span class="op" id="5382468">:=</span>&nbsp;<span class="op" id="5382471">(</span><span class="ident" id="5382472">m</span>&nbsp;<span class="op" id="5382474">-</span>&nbsp;<span class="op" id="5382476">(</span><span class="ident" id="5382477">sa</span>&nbsp;<span class="op" id="5382480">*</span>&nbsp;<span class="ident" id="5382482">ma</span>&nbsp;<span class="op" id="5382485">/</span>&nbsp;<span class="ident" id="5382487">m</span><span class="op" id="5382488">)</span><span class="op" id="5382489">)</span>&nbsp;<span class="op" id="5382491">*</span>&nbsp;<span class="num" id="5382493">0x101</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382504">dst</span><span class="op" id="5382507">.</span><span class="ident" id="5382508">Pix</span><span class="op" id="5382511">[</span><span class="ident" id="5382512">i</span><span class="op" id="5382513">+</span><span class="num" id="5382514">0</span><span class="op" id="5382515">]</span>&nbsp;<span class="op" id="5382517">=</span>&nbsp;<span class="builtintype" id="5382519">uint8</span><span class="op" id="5382524">(</span><span class="op" id="5382525">(</span><span class="ident" id="5382526">dr</span><span class="op" id="5382528">*</span><span class="ident" id="5382529">a</span>&nbsp;<span class="op" id="5382531">+</span>&nbsp;<span class="ident" id="5382533">sr</span><span class="op" id="5382535">*</span><span class="ident" id="5382536">ma</span><span class="op" id="5382538">)</span>&nbsp;<span class="op" id="5382540">/</span>&nbsp;<span class="ident" id="5382542">m</span>&nbsp;<span class="op" id="5382544">&gt;&gt;</span>&nbsp;<span class="num" id="5382547">8</span><span class="op" id="5382548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382554">dst</span><span class="op" id="5382557">.</span><span class="ident" id="5382558">Pix</span><span class="op" id="5382561">[</span><span class="ident" id="5382562">i</span><span class="op" id="5382563">+</span><span class="num" id="5382564">1</span><span class="op" id="5382565">]</span>&nbsp;<span class="op" id="5382567">=</span>&nbsp;<span class="builtintype" id="5382569">uint8</span><span class="op" id="5382574">(</span><span class="op" id="5382575">(</span><span class="ident" id="5382576">dg</span><span class="op" id="5382578">*</span><span class="ident" id="5382579">a</span>&nbsp;<span class="op" id="5382581">+</span>&nbsp;<span class="ident" id="5382583">sg</span><span class="op" id="5382585">*</span><span class="ident" id="5382586">ma</span><span class="op" id="5382588">)</span>&nbsp;<span class="op" id="5382590">/</span>&nbsp;<span class="ident" id="5382592">m</span>&nbsp;<span class="op" id="5382594">&gt;&gt;</span>&nbsp;<span class="num" id="5382597">8</span><span class="op" id="5382598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382604">dst</span><span class="op" id="5382607">.</span><span class="ident" id="5382608">Pix</span><span class="op" id="5382611">[</span><span class="ident" id="5382612">i</span><span class="op" id="5382613">+</span><span class="num" id="5382614">2</span><span class="op" id="5382615">]</span>&nbsp;<span class="op" id="5382617">=</span>&nbsp;<span class="builtintype" id="5382619">uint8</span><span class="op" id="5382624">(</span><span class="op" id="5382625">(</span><span class="ident" id="5382626">db</span><span class="op" id="5382628">*</span><span class="ident" id="5382629">a</span>&nbsp;<span class="op" id="5382631">+</span>&nbsp;<span class="ident" id="5382633">sb</span><span class="op" id="5382635">*</span><span class="ident" id="5382636">ma</span><span class="op" id="5382638">)</span>&nbsp;<span class="op" id="5382640">/</span>&nbsp;<span class="ident" id="5382642">m</span>&nbsp;<span class="op" id="5382644">&gt;&gt;</span>&nbsp;<span class="num" id="5382647">8</span><span class="op" id="5382648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382654">dst</span><span class="op" id="5382657">.</span><span class="ident" id="5382658">Pix</span><span class="op" id="5382661">[</span><span class="ident" id="5382662">i</span><span class="op" id="5382663">+</span><span class="num" id="5382664">3</span><span class="op" id="5382665">]</span>&nbsp;<span class="op" id="5382667">=</span>&nbsp;<span class="builtintype" id="5382669">uint8</span><span class="op" id="5382674">(</span><span class="op" id="5382675">(</span><span class="ident" id="5382676">da</span><span class="op" id="5382678">*</span><span class="ident" id="5382679">a</span>&nbsp;<span class="op" id="5382681">+</span>&nbsp;<span class="ident" id="5382683">sa</span><span class="op" id="5382685">*</span><span class="ident" id="5382686">ma</span><span class="op" id="5382688">)</span>&nbsp;<span class="op" id="5382690">/</span>&nbsp;<span class="ident" id="5382692">m</span>&nbsp;<span class="op" id="5382694">&gt;&gt;</span>&nbsp;<span class="num" id="5382697">8</span><span class="op" id="5382698">)</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382704">}</span>&nbsp;<span class="keyword" id="5382706">else</span>&nbsp;<span class="op" id="5382711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382717">dst</span><span class="op" id="5382720">.</span><span class="ident" id="5382721">Pix</span><span class="op" id="5382724">[</span><span class="ident" id="5382725">i</span><span class="op" id="5382726">+</span><span class="num" id="5382727">0</span><span class="op" id="5382728">]</span>&nbsp;<span class="op" id="5382730">=</span>&nbsp;<span class="builtintype" id="5382732">uint8</span><span class="op" id="5382737">(</span><span class="ident" id="5382738">sr</span>&nbsp;<span class="op" id="5382741">*</span>&nbsp;<span class="ident" id="5382743">ma</span>&nbsp;<span class="op" id="5382746">/</span>&nbsp;<span class="ident" id="5382748">m</span>&nbsp;<span class="op" id="5382750">&gt;&gt;</span>&nbsp;<span class="num" id="5382753">8</span><span class="op" id="5382754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382760">dst</span><span class="op" id="5382763">.</span><span class="ident" id="5382764">Pix</span><span class="op" id="5382767">[</span><span class="ident" id="5382768">i</span><span class="op" id="5382769">+</span><span class="num" id="5382770">1</span><span class="op" id="5382771">]</span>&nbsp;<span class="op" id="5382773">=</span>&nbsp;<span class="builtintype" id="5382775">uint8</span><span class="op" id="5382780">(</span><span class="ident" id="5382781">sg</span>&nbsp;<span class="op" id="5382784">*</span>&nbsp;<span class="ident" id="5382786">ma</span>&nbsp;<span class="op" id="5382789">/</span>&nbsp;<span class="ident" id="5382791">m</span>&nbsp;<span class="op" id="5382793">&gt;&gt;</span>&nbsp;<span class="num" id="5382796">8</span><span class="op" id="5382797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382803">dst</span><span class="op" id="5382806">.</span><span class="ident" id="5382807">Pix</span><span class="op" id="5382810">[</span><span class="ident" id="5382811">i</span><span class="op" id="5382812">+</span><span class="num" id="5382813">2</span><span class="op" id="5382814">]</span>&nbsp;<span class="op" id="5382816">=</span>&nbsp;<span class="builtintype" id="5382818">uint8</span><span class="op" id="5382823">(</span><span class="ident" id="5382824">sb</span>&nbsp;<span class="op" id="5382827">*</span>&nbsp;<span class="ident" id="5382829">ma</span>&nbsp;<span class="op" id="5382832">/</span>&nbsp;<span class="ident" id="5382834">m</span>&nbsp;<span class="op" id="5382836">&gt;&gt;</span>&nbsp;<span class="num" id="5382839">8</span><span class="op" id="5382840">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382846">dst</span><span class="op" id="5382849">.</span><span class="ident" id="5382850">Pix</span><span class="op" id="5382853">[</span><span class="ident" id="5382854">i</span><span class="op" id="5382855">+</span><span class="num" id="5382856">3</span><span class="op" id="5382857">]</span>&nbsp;<span class="op" id="5382859">=</span>&nbsp;<span class="builtintype" id="5382861">uint8</span><span class="op" id="5382866">(</span><span class="ident" id="5382867">sa</span>&nbsp;<span class="op" id="5382870">*</span>&nbsp;<span class="ident" id="5382872">ma</span>&nbsp;<span class="op" id="5382875">/</span>&nbsp;<span class="ident" id="5382877">m</span>&nbsp;<span class="op" id="5382879">&gt;&gt;</span>&nbsp;<span class="num" id="5382882">8</span><span class="op" id="5382883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382896">i0</span>&nbsp;<span class="op" id="5382899">+=</span>&nbsp;<span class="ident" id="5382902">dy</span>&nbsp;<span class="op" id="5382905">*</span>&nbsp;<span class="ident" id="5382907">dst</span><span class="op" id="5382910">.</span><span class="ident" id="5382911">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382919">}</span><br>
<span class="lineno">545</span><span class="op" id="5382921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5382924">//&nbsp;clamp&nbsp;clamps&nbsp;i&nbsp;to&nbsp;the&nbsp;interval&nbsp;[0,&nbsp;0xffff].</span><br>
<span class="lineno"></span><span class="keyword" id="5382971">func</span>&nbsp;<span class="ident" id="5382976">clamp</span><span class="op" id="5382981">(</span><span class="ident" id="5382982">i</span>&nbsp;<span class="builtintype" id="5382984">int32</span><span class="op" id="5382989">)</span>&nbsp;<span class="builtintype" id="5382991">int32</span>&nbsp;<span class="op" id="5382997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383000">if</span>&nbsp;<span class="ident" id="5383003">i</span>&nbsp;<span class="op" id="5383005">&lt;</span>&nbsp;<span class="num" id="5383007">0</span>&nbsp;<span class="op" id="5383009">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383013">return</span>&nbsp;<span class="num" id="5383020">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383026">if</span>&nbsp;<span class="ident" id="5383029">i</span>&nbsp;<span class="op" id="5383031">&gt;</span>&nbsp;<span class="num" id="5383033">0xffff</span>&nbsp;<span class="op" id="5383040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383044">return</span>&nbsp;<span class="num" id="5383051">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383059">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383062">return</span>&nbsp;<span class="ident" id="5383069">i</span><br>
<span class="lineno"></span><span class="op" id="5383071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5383074">func</span>&nbsp;<span class="ident" id="5383079">drawPaletted</span><span class="op" id="5383091">(</span><span class="ident" id="5383092">dst</span>&nbsp;<span class="ident" id="5383096">Image</span><span class="op" id="5383101">,</span>&nbsp;<span class="ident" id="5383103">r</span>&nbsp;<span class="ident" id="5383105">image</span><span class="op" id="5383110">.</span><span class="ident" id="5383111">Rectangle</span><span class="op" id="5383120">,</span>&nbsp;<span class="ident" id="5383122">src</span>&nbsp;<span class="ident" id="5383126">image</span><span class="op" id="5383131">.</span><span class="ident" id="5383132">Image</span><span class="op" id="5383137">,</span>&nbsp;<span class="ident" id="5383139">sp</span>&nbsp;<span class="ident" id="5383142">image</span><span class="op" id="5383147">.</span><span class="ident" id="5383148">Point</span><span class="op" id="5383153">,</span>&nbsp;<span class="ident" id="5383155">floydSteinberg</span>&nbsp;<span class="builtintype" id="5383170">bool</span><span class="op" id="5383174">)</span>&nbsp;<span class="op" id="5383176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383179">//&nbsp;TODO(nigeltao):&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;dst&nbsp;and&nbsp;src&nbsp;overlap.</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383246">//&nbsp;Does&nbsp;it&nbsp;even&nbsp;make&nbsp;sense&nbsp;to&nbsp;try&nbsp;and&nbsp;do&nbsp;Floyd-Steinberg&nbsp;whilst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383311">//&nbsp;walking&nbsp;the&nbsp;image&nbsp;backward&nbsp;(right-to-left&nbsp;bottom-to-top)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383374">//&nbsp;If&nbsp;dst&nbsp;is&nbsp;an&nbsp;*image.Paletted,&nbsp;we&nbsp;have&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;dst.Set&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383444">//&nbsp;dst.At.&nbsp;The&nbsp;dst.Set&nbsp;equivalent&nbsp;is&nbsp;a&nbsp;batch&nbsp;version&nbsp;of&nbsp;the&nbsp;algorithm</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383515">//&nbsp;used&nbsp;by&nbsp;color.Palette&#39;s&nbsp;Index&nbsp;method&nbsp;in&nbsp;image/color/color.go,&nbsp;plus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383586">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error&nbsp;diffusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383632">palette</span><span class="op" id="5383639">,</span>&nbsp;<span class="ident" id="5383641">pix</span><span class="op" id="5383644">,</span>&nbsp;<span class="ident" id="5383646">stride</span>&nbsp;<span class="op" id="5383653">:=</span>&nbsp;<span class="op" id="5383656">[</span><span class="op" id="5383657">]</span><span class="op" id="5383658">[</span><span class="num" id="5383659">3</span><span class="op" id="5383660">]</span><span class="builtintype" id="5383661">int32</span><span class="op" id="5383666">(</span><span class="ident" id="5383667">nil</span><span class="op" id="5383670">)</span><span class="op" id="5383671">,</span>&nbsp;<span class="op" id="5383673">[</span><span class="op" id="5383674">]</span><span class="builtintype" id="5383675">byte</span><span class="op" id="5383679">(</span><span class="ident" id="5383680">nil</span><span class="op" id="5383683">)</span><span class="op" id="5383684">,</span>&nbsp;<span class="num" id="5383686">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383689">if</span>&nbsp;<span class="ident" id="5383692">p</span><span class="op" id="5383693">,</span>&nbsp;<span class="ident" id="5383695">ok</span>&nbsp;<span class="op" id="5383698">:=</span>&nbsp;<span class="ident" id="5383701">dst</span><span class="op" id="5383704">.</span><span class="op" id="5383705">(</span><span class="op" id="5383706">*</span><span class="ident" id="5383707">image</span><span class="op" id="5383712">.</span><span class="ident" id="5383713">Paletted</span><span class="op" id="5383721">)</span><span class="op" id="5383722">;</span>&nbsp;<span class="ident" id="5383724">ok</span>&nbsp;<span class="op" id="5383727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383731">palette</span>&nbsp;<span class="op" id="5383739">=</span>&nbsp;<span class="builtinfunc" id="5383741">make</span><span class="op" id="5383745">(</span><span class="op" id="5383746">[</span><span class="op" id="5383747">]</span><span class="op" id="5383748">[</span><span class="num" id="5383749">3</span><span class="op" id="5383750">]</span><span class="builtintype" id="5383751">int32</span><span class="op" id="5383756">,</span>&nbsp;<span class="builtinfunc" id="5383758">len</span><span class="op" id="5383761">(</span><span class="ident" id="5383762">p</span><span class="op" id="5383763">.</span><span class="ident" id="5383764">Palette</span><span class="op" id="5383771">)</span><span class="op" id="5383772">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383776">for</span>&nbsp;<span class="ident" id="5383780">i</span><span class="op" id="5383781">,</span>&nbsp;<span class="ident" id="5383783">col</span>&nbsp;<span class="op" id="5383787">:=</span>&nbsp;<span class="keyword" id="5383790">range</span>&nbsp;<span class="ident" id="5383796">p</span><span class="op" id="5383797">.</span><span class="ident" id="5383798">Palette</span>&nbsp;<span class="op" id="5383806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383811">r</span><span class="op" id="5383812">,</span>&nbsp;<span class="ident" id="5383814">g</span><span class="op" id="5383815">,</span>&nbsp;<span class="ident" id="5383817">b</span><span class="op" id="5383818">,</span>&nbsp;<span class="ident" id="5383820">_</span>&nbsp;<span class="op" id="5383822">:=</span>&nbsp;<span class="ident" id="5383825">col</span><span class="op" id="5383828">.</span><span class="ident" id="5383829">RGBA</span><span class="op" id="5383833">(</span><span class="op" id="5383834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383839">palette</span><span class="op" id="5383846">[</span><span class="ident" id="5383847">i</span><span class="op" id="5383848">]</span><span class="op" id="5383849">[</span><span class="num" id="5383850">0</span><span class="op" id="5383851">]</span>&nbsp;<span class="op" id="5383853">=</span>&nbsp;<span class="builtintype" id="5383855">int32</span><span class="op" id="5383860">(</span><span class="ident" id="5383861">r</span><span class="op" id="5383862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383867">palette</span><span class="op" id="5383874">[</span><span class="ident" id="5383875">i</span><span class="op" id="5383876">]</span><span class="op" id="5383877">[</span><span class="num" id="5383878">1</span><span class="op" id="5383879">]</span>&nbsp;<span class="op" id="5383881">=</span>&nbsp;<span class="builtintype" id="5383883">int32</span><span class="op" id="5383888">(</span><span class="ident" id="5383889">g</span><span class="op" id="5383890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383895">palette</span><span class="op" id="5383902">[</span><span class="ident" id="5383903">i</span><span class="op" id="5383904">]</span><span class="op" id="5383905">[</span><span class="num" id="5383906">2</span><span class="op" id="5383907">]</span>&nbsp;<span class="op" id="5383909">=</span>&nbsp;<span class="builtintype" id="5383911">int32</span><span class="op" id="5383916">(</span><span class="ident" id="5383917">b</span><span class="op" id="5383918">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383926">pix</span><span class="op" id="5383929">,</span>&nbsp;<span class="ident" id="5383931">stride</span>&nbsp;<span class="op" id="5383938">=</span>&nbsp;<span class="ident" id="5383940">p</span><span class="op" id="5383941">.</span><span class="ident" id="5383942">Pix</span><span class="op" id="5383945">[</span><span class="ident" id="5383946">p</span><span class="op" id="5383947">.</span><span class="ident" id="5383948">PixOffset</span><span class="op" id="5383957">(</span><span class="ident" id="5383958">r</span><span class="op" id="5383959">.</span><span class="ident" id="5383960">Min</span><span class="op" id="5383963">.</span><span class="ident" id="5383964">X</span><span class="op" id="5383965">,</span>&nbsp;<span class="ident" id="5383967">r</span><span class="op" id="5383968">.</span><span class="ident" id="5383969">Min</span><span class="op" id="5383972">.</span><span class="ident" id="5383973">Y</span><span class="op" id="5383974">)</span><span class="op" id="5383975">:</span><span class="op" id="5383976">]</span><span class="op" id="5383977">,</span>&nbsp;<span class="ident" id="5383979">p</span><span class="op" id="5383980">.</span><span class="ident" id="5383981">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383993">//&nbsp;quantErrorCurr&nbsp;and&nbsp;quantErrorNext&nbsp;are&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384068">//&nbsp;errors&nbsp;that&nbsp;have&nbsp;been&nbsp;propagated&nbsp;to&nbsp;the&nbsp;pixels&nbsp;in&nbsp;the&nbsp;current&nbsp;and&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384143">//&nbsp;rows.&nbsp;The&nbsp;+2&nbsp;simplifies&nbsp;calculation&nbsp;near&nbsp;the&nbsp;edges.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384199">var</span>&nbsp;<span class="ident" id="5384203">quantErrorCurr</span><span class="op" id="5384217">,</span>&nbsp;<span class="ident" id="5384219">quantErrorNext</span>&nbsp;<span class="op" id="5384234">[</span><span class="op" id="5384235">]</span><span class="op" id="5384236">[</span><span class="num" id="5384237">3</span><span class="op" id="5384238">]</span><span class="builtintype" id="5384239">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384246">if</span>&nbsp;<span class="ident" id="5384249">floydSteinberg</span>&nbsp;<span class="op" id="5384264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384268">quantErrorCurr</span>&nbsp;<span class="op" id="5384283">=</span>&nbsp;<span class="builtinfunc" id="5384285">make</span><span class="op" id="5384289">(</span><span class="op" id="5384290">[</span><span class="op" id="5384291">]</span><span class="op" id="5384292">[</span><span class="num" id="5384293">3</span><span class="op" id="5384294">]</span><span class="builtintype" id="5384295">int32</span><span class="op" id="5384300">,</span>&nbsp;<span class="ident" id="5384302">r</span><span class="op" id="5384303">.</span><span class="ident" id="5384304">Dx</span><span class="op" id="5384306">(</span><span class="op" id="5384307">)</span><span class="op" id="5384308">+</span><span class="num" id="5384309">2</span><span class="op" id="5384310">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384314">quantErrorNext</span>&nbsp;<span class="op" id="5384329">=</span>&nbsp;<span class="builtinfunc" id="5384331">make</span><span class="op" id="5384335">(</span><span class="op" id="5384336">[</span><span class="op" id="5384337">]</span><span class="op" id="5384338">[</span><span class="num" id="5384339">3</span><span class="op" id="5384340">]</span><span class="builtintype" id="5384341">int32</span><span class="op" id="5384346">,</span>&nbsp;<span class="ident" id="5384348">r</span><span class="op" id="5384349">.</span><span class="ident" id="5384350">Dx</span><span class="op" id="5384352">(</span><span class="op" id="5384353">)</span><span class="op" id="5384354">+</span><span class="num" id="5384355">2</span><span class="op" id="5384356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384363">//&nbsp;Loop&nbsp;over&nbsp;each&nbsp;source&nbsp;pixel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384396">out</span>&nbsp;<span class="op" id="5384400">:=</span>&nbsp;<span class="ident" id="5384403">color</span><span class="op" id="5384408">.</span><span class="ident" id="5384409">RGBA64</span><span class="op" id="5384415">{</span><span class="ident" id="5384416">A</span><span class="op" id="5384417">:</span>&nbsp;<span class="num" id="5384419">0xffff</span><span class="op" id="5384425">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384428">for</span>&nbsp;<span class="ident" id="5384432">y</span>&nbsp;<span class="op" id="5384434">:=</span>&nbsp;<span class="num" id="5384437">0</span><span class="op" id="5384438">;</span>&nbsp;<span class="ident" id="5384440">y</span>&nbsp;<span class="op" id="5384442">!=</span>&nbsp;<span class="ident" id="5384445">r</span><span class="op" id="5384446">.</span><span class="ident" id="5384447">Dy</span><span class="op" id="5384449">(</span><span class="op" id="5384450">)</span><span class="op" id="5384451">;</span>&nbsp;<span class="ident" id="5384453">y</span><span class="op" id="5384454">++</span>&nbsp;<span class="op" id="5384457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384461">for</span>&nbsp;<span class="ident" id="5384465">x</span>&nbsp;<span class="op" id="5384467">:=</span>&nbsp;<span class="num" id="5384470">0</span><span class="op" id="5384471">;</span>&nbsp;<span class="ident" id="5384473">x</span>&nbsp;<span class="op" id="5384475">!=</span>&nbsp;<span class="ident" id="5384478">r</span><span class="op" id="5384479">.</span><span class="ident" id="5384480">Dx</span><span class="op" id="5384482">(</span><span class="op" id="5384483">)</span><span class="op" id="5384484">;</span>&nbsp;<span class="ident" id="5384486">x</span><span class="op" id="5384487">++</span>&nbsp;<span class="op" id="5384490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384495">//&nbsp;er,&nbsp;eg&nbsp;and&nbsp;eb&nbsp;are&nbsp;the&nbsp;pixel&#39;s&nbsp;R,G,B&nbsp;values&nbsp;plus&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384553">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384591">sr</span><span class="op" id="5384593">,</span>&nbsp;<span class="ident" id="5384595">sg</span><span class="op" id="5384597">,</span>&nbsp;<span class="ident" id="5384599">sb</span><span class="op" id="5384601">,</span>&nbsp;<span class="ident" id="5384603">_</span>&nbsp;<span class="op" id="5384605">:=</span>&nbsp;<span class="ident" id="5384608">src</span><span class="op" id="5384611">.</span><span class="ident" id="5384612">At</span><span class="op" id="5384614">(</span><span class="ident" id="5384615">sp</span><span class="op" id="5384617">.</span><span class="ident" id="5384618">X</span><span class="op" id="5384619">+</span><span class="ident" id="5384620">x</span><span class="op" id="5384621">,</span>&nbsp;<span class="ident" id="5384623">sp</span><span class="op" id="5384625">.</span><span class="ident" id="5384626">Y</span><span class="op" id="5384627">+</span><span class="ident" id="5384628">y</span><span class="op" id="5384629">)</span><span class="op" id="5384630">.</span><span class="ident" id="5384631">RGBA</span><span class="op" id="5384635">(</span><span class="op" id="5384636">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384641">er</span><span class="op" id="5384643">,</span>&nbsp;<span class="ident" id="5384645">eg</span><span class="op" id="5384647">,</span>&nbsp;<span class="ident" id="5384649">eb</span>&nbsp;<span class="op" id="5384652">:=</span>&nbsp;<span class="builtintype" id="5384655">int32</span><span class="op" id="5384660">(</span><span class="ident" id="5384661">sr</span><span class="op" id="5384663">)</span><span class="op" id="5384664">,</span>&nbsp;<span class="builtintype" id="5384666">int32</span><span class="op" id="5384671">(</span><span class="ident" id="5384672">sg</span><span class="op" id="5384674">)</span><span class="op" id="5384675">,</span>&nbsp;<span class="builtintype" id="5384677">int32</span><span class="op" id="5384682">(</span><span class="ident" id="5384683">sb</span><span class="op" id="5384685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384690">if</span>&nbsp;<span class="ident" id="5384693">floydSteinberg</span>&nbsp;<span class="op" id="5384708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384714">er</span>&nbsp;<span class="op" id="5384717">=</span>&nbsp;<span class="ident" id="5384719">clamp</span><span class="op" id="5384724">(</span><span class="ident" id="5384725">er</span>&nbsp;<span class="op" id="5384728">+</span>&nbsp;<span class="ident" id="5384730">quantErrorCurr</span><span class="op" id="5384744">[</span><span class="ident" id="5384745">x</span><span class="op" id="5384746">+</span><span class="num" id="5384747">1</span><span class="op" id="5384748">]</span><span class="op" id="5384749">[</span><span class="num" id="5384750">0</span><span class="op" id="5384751">]</span><span class="op" id="5384752">/</span><span class="num" id="5384753">16</span><span class="op" id="5384755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384761">eg</span>&nbsp;<span class="op" id="5384764">=</span>&nbsp;<span class="ident" id="5384766">clamp</span><span class="op" id="5384771">(</span><span class="ident" id="5384772">eg</span>&nbsp;<span class="op" id="5384775">+</span>&nbsp;<span class="ident" id="5384777">quantErrorCurr</span><span class="op" id="5384791">[</span><span class="ident" id="5384792">x</span><span class="op" id="5384793">+</span><span class="num" id="5384794">1</span><span class="op" id="5384795">]</span><span class="op" id="5384796">[</span><span class="num" id="5384797">1</span><span class="op" id="5384798">]</span><span class="op" id="5384799">/</span><span class="num" id="5384800">16</span><span class="op" id="5384802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384808">eb</span>&nbsp;<span class="op" id="5384811">=</span>&nbsp;<span class="ident" id="5384813">clamp</span><span class="op" id="5384818">(</span><span class="ident" id="5384819">eb</span>&nbsp;<span class="op" id="5384822">+</span>&nbsp;<span class="ident" id="5384824">quantErrorCurr</span><span class="op" id="5384838">[</span><span class="ident" id="5384839">x</span><span class="op" id="5384840">+</span><span class="num" id="5384841">1</span><span class="op" id="5384842">]</span><span class="op" id="5384843">[</span><span class="num" id="5384844">2</span><span class="op" id="5384845">]</span><span class="op" id="5384846">/</span><span class="num" id="5384847">16</span><span class="op" id="5384849">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384860">if</span>&nbsp;<span class="ident" id="5384863">palette</span>&nbsp;<span class="op" id="5384871">!=</span>&nbsp;<span class="ident" id="5384874">nil</span>&nbsp;<span class="op" id="5384878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384884">//&nbsp;Find&nbsp;the&nbsp;closest&nbsp;palette&nbsp;color&nbsp;in&nbsp;Euclidean&nbsp;R,G,B&nbsp;space:&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384952">//&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;sum-squared-difference.&nbsp;We&nbsp;shift&nbsp;by&nbsp;1&nbsp;bit</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385020">//&nbsp;to&nbsp;avoid&nbsp;potential&nbsp;uint32&nbsp;overflow&nbsp;in&nbsp;sum-squared-difference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385089">//&nbsp;TODO(nigeltao):&nbsp;consider&nbsp;smarter&nbsp;algorithms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385141">bestIndex</span><span class="op" id="5385150">,</span>&nbsp;<span class="ident" id="5385152">bestSSD</span>&nbsp;<span class="op" id="5385160">:=</span>&nbsp;<span class="num" id="5385163">0</span><span class="op" id="5385164">,</span>&nbsp;<span class="builtintype" id="5385166">uint32</span><span class="op" id="5385172">(</span><span class="num" id="5385173">1</span><span class="op" id="5385174">&lt;&lt;</span><span class="num" id="5385176">32</span><span class="op" id="5385178">-</span><span class="num" id="5385179">1</span><span class="op" id="5385180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385186">for</span>&nbsp;<span class="ident" id="5385190">index</span><span class="op" id="5385195">,</span>&nbsp;<span class="ident" id="5385197">p</span>&nbsp;<span class="op" id="5385199">:=</span>&nbsp;<span class="keyword" id="5385202">range</span>&nbsp;<span class="ident" id="5385208">palette</span>&nbsp;<span class="op" id="5385216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385223">delta</span>&nbsp;<span class="op" id="5385229">:=</span>&nbsp;<span class="op" id="5385232">(</span><span class="ident" id="5385233">er</span>&nbsp;<span class="op" id="5385236">-</span>&nbsp;<span class="ident" id="5385238">p</span><span class="op" id="5385239">[</span><span class="num" id="5385240">0</span><span class="op" id="5385241">]</span><span class="op" id="5385242">)</span>&nbsp;<span class="op" id="5385244">&gt;&gt;</span>&nbsp;<span class="num" id="5385247">1</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385254">ssd</span>&nbsp;<span class="op" id="5385258">:=</span>&nbsp;<span class="builtintype" id="5385261">uint32</span><span class="op" id="5385267">(</span><span class="ident" id="5385268">delta</span>&nbsp;<span class="op" id="5385274">*</span>&nbsp;<span class="ident" id="5385276">delta</span><span class="op" id="5385281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385288">delta</span>&nbsp;<span class="op" id="5385294">=</span>&nbsp;<span class="op" id="5385296">(</span><span class="ident" id="5385297">eg</span>&nbsp;<span class="op" id="5385300">-</span>&nbsp;<span class="ident" id="5385302">p</span><span class="op" id="5385303">[</span><span class="num" id="5385304">1</span><span class="op" id="5385305">]</span><span class="op" id="5385306">)</span>&nbsp;<span class="op" id="5385308">&gt;&gt;</span>&nbsp;<span class="num" id="5385311">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385318">ssd</span>&nbsp;<span class="op" id="5385322">+=</span>&nbsp;<span class="builtintype" id="5385325">uint32</span><span class="op" id="5385331">(</span><span class="ident" id="5385332">delta</span>&nbsp;<span class="op" id="5385338">*</span>&nbsp;<span class="ident" id="5385340">delta</span><span class="op" id="5385345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385352">delta</span>&nbsp;<span class="op" id="5385358">=</span>&nbsp;<span class="op" id="5385360">(</span><span class="ident" id="5385361">eb</span>&nbsp;<span class="op" id="5385364">-</span>&nbsp;<span class="ident" id="5385366">p</span><span class="op" id="5385367">[</span><span class="num" id="5385368">2</span><span class="op" id="5385369">]</span><span class="op" id="5385370">)</span>&nbsp;<span class="op" id="5385372">&gt;&gt;</span>&nbsp;<span class="num" id="5385375">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385382">ssd</span>&nbsp;<span class="op" id="5385386">+=</span>&nbsp;<span class="builtintype" id="5385389">uint32</span><span class="op" id="5385395">(</span><span class="ident" id="5385396">delta</span>&nbsp;<span class="op" id="5385402">*</span>&nbsp;<span class="ident" id="5385404">delta</span><span class="op" id="5385409">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385416">if</span>&nbsp;<span class="ident" id="5385419">ssd</span>&nbsp;<span class="op" id="5385423">&lt;</span>&nbsp;<span class="ident" id="5385425">bestSSD</span>&nbsp;<span class="op" id="5385433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385441">bestIndex</span><span class="op" id="5385450">,</span>&nbsp;<span class="ident" id="5385452">bestSSD</span>&nbsp;<span class="op" id="5385460">=</span>&nbsp;<span class="ident" id="5385462">index</span><span class="op" id="5385467">,</span>&nbsp;<span class="ident" id="5385469">ssd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385479">if</span>&nbsp;<span class="ident" id="5385482">ssd</span>&nbsp;<span class="op" id="5385486">==</span>&nbsp;<span class="num" id="5385489">0</span>&nbsp;<span class="op" id="5385491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385500">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385512">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385531">pix</span><span class="op" id="5385534">[</span><span class="ident" id="5385535">y</span><span class="op" id="5385536">*</span><span class="ident" id="5385537">stride</span><span class="op" id="5385543">+</span><span class="ident" id="5385544">x</span><span class="op" id="5385545">]</span>&nbsp;<span class="op" id="5385547">=</span>&nbsp;<span class="builtintype" id="5385549">byte</span><span class="op" id="5385553">(</span><span class="ident" id="5385554">bestIndex</span><span class="op" id="5385563">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385570">if</span>&nbsp;<span class="op" id="5385573">!</span><span class="ident" id="5385574">floydSteinberg</span>&nbsp;<span class="op" id="5385589">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385596">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385615">er</span>&nbsp;<span class="op" id="5385618">-=</span>&nbsp;<span class="builtintype" id="5385621">int32</span><span class="op" id="5385626">(</span><span class="ident" id="5385627">palette</span><span class="op" id="5385634">[</span><span class="ident" id="5385635">bestIndex</span><span class="op" id="5385644">]</span><span class="op" id="5385645">[</span><span class="num" id="5385646">0</span><span class="op" id="5385647">]</span><span class="op" id="5385648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385654">eg</span>&nbsp;<span class="op" id="5385657">-=</span>&nbsp;<span class="builtintype" id="5385660">int32</span><span class="op" id="5385665">(</span><span class="ident" id="5385666">palette</span><span class="op" id="5385673">[</span><span class="ident" id="5385674">bestIndex</span><span class="op" id="5385683">]</span><span class="op" id="5385684">[</span><span class="num" id="5385685">1</span><span class="op" id="5385686">]</span><span class="op" id="5385687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385693">eb</span>&nbsp;<span class="op" id="5385696">-=</span>&nbsp;<span class="builtintype" id="5385699">int32</span><span class="op" id="5385704">(</span><span class="ident" id="5385705">palette</span><span class="op" id="5385712">[</span><span class="ident" id="5385713">bestIndex</span><span class="op" id="5385722">]</span><span class="op" id="5385723">[</span><span class="num" id="5385724">2</span><span class="op" id="5385725">]</span><span class="op" id="5385726">)</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385732">}</span>&nbsp;<span class="keyword" id="5385734">else</span>&nbsp;<span class="op" id="5385739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385745">out</span><span class="op" id="5385748">.</span><span class="ident" id="5385749">R</span>&nbsp;<span class="op" id="5385751">=</span>&nbsp;<span class="builtintype" id="5385753">uint16</span><span class="op" id="5385759">(</span><span class="ident" id="5385760">er</span><span class="op" id="5385762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385768">out</span><span class="op" id="5385771">.</span><span class="ident" id="5385772">G</span>&nbsp;<span class="op" id="5385774">=</span>&nbsp;<span class="builtintype" id="5385776">uint16</span><span class="op" id="5385782">(</span><span class="ident" id="5385783">eg</span><span class="op" id="5385785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385791">out</span><span class="op" id="5385794">.</span><span class="ident" id="5385795">B</span>&nbsp;<span class="op" id="5385797">=</span>&nbsp;<span class="builtintype" id="5385799">uint16</span><span class="op" id="5385805">(</span><span class="ident" id="5385806">eb</span><span class="op" id="5385808">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385814">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385875">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385940">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386003">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386064">dst</span><span class="op" id="5386067">.</span><span class="ident" id="5386068">Set</span><span class="op" id="5386071">(</span><span class="ident" id="5386072">r</span><span class="op" id="5386073">.</span><span class="ident" id="5386074">Min</span><span class="op" id="5386077">.</span><span class="ident" id="5386078">X</span><span class="op" id="5386079">+</span><span class="ident" id="5386080">x</span><span class="op" id="5386081">,</span>&nbsp;<span class="ident" id="5386083">r</span><span class="op" id="5386084">.</span><span class="ident" id="5386085">Min</span><span class="op" id="5386088">.</span><span class="ident" id="5386089">Y</span><span class="op" id="5386090">+</span><span class="ident" id="5386091">y</span><span class="op" id="5386092">,</span>&nbsp;<span class="op" id="5386094">&amp;</span><span class="ident" id="5386095">out</span><span class="op" id="5386098">)</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386105">if</span>&nbsp;<span class="op" id="5386108">!</span><span class="ident" id="5386109">floydSteinberg</span>&nbsp;<span class="op" id="5386124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386131">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386150">sr</span><span class="op" id="5386152">,</span>&nbsp;<span class="ident" id="5386154">sg</span><span class="op" id="5386156">,</span>&nbsp;<span class="ident" id="5386158">sb</span><span class="op" id="5386160">,</span>&nbsp;<span class="ident" id="5386162">_</span>&nbsp;<span class="op" id="5386164">=</span>&nbsp;<span class="ident" id="5386166">dst</span><span class="op" id="5386169">.</span><span class="ident" id="5386170">At</span><span class="op" id="5386172">(</span><span class="ident" id="5386173">r</span><span class="op" id="5386174">.</span><span class="ident" id="5386175">Min</span><span class="op" id="5386178">.</span><span class="ident" id="5386179">X</span><span class="op" id="5386180">+</span><span class="ident" id="5386181">x</span><span class="op" id="5386182">,</span>&nbsp;<span class="ident" id="5386184">r</span><span class="op" id="5386185">.</span><span class="ident" id="5386186">Min</span><span class="op" id="5386189">.</span><span class="ident" id="5386190">Y</span><span class="op" id="5386191">+</span><span class="ident" id="5386192">y</span><span class="op" id="5386193">)</span><span class="op" id="5386194">.</span><span class="ident" id="5386195">RGBA</span><span class="op" id="5386199">(</span><span class="op" id="5386200">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386206">er</span>&nbsp;<span class="op" id="5386209">-=</span>&nbsp;<span class="builtintype" id="5386212">int32</span><span class="op" id="5386217">(</span><span class="ident" id="5386218">sr</span><span class="op" id="5386220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386226">eg</span>&nbsp;<span class="op" id="5386229">-=</span>&nbsp;<span class="builtintype" id="5386232">int32</span><span class="op" id="5386237">(</span><span class="ident" id="5386238">sg</span><span class="op" id="5386240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386246">eb</span>&nbsp;<span class="op" id="5386249">-=</span>&nbsp;<span class="builtintype" id="5386252">int32</span><span class="op" id="5386257">(</span><span class="ident" id="5386258">sb</span><span class="op" id="5386260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386271">//&nbsp;Propagate&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386327">quantErrorNext</span><span class="op" id="5386341">[</span><span class="ident" id="5386342">x</span><span class="op" id="5386343">+</span><span class="num" id="5386344">0</span><span class="op" id="5386345">]</span><span class="op" id="5386346">[</span><span class="num" id="5386347">0</span><span class="op" id="5386348">]</span>&nbsp;<span class="op" id="5386350">+=</span>&nbsp;<span class="ident" id="5386353">er</span>&nbsp;<span class="op" id="5386356">*</span>&nbsp;<span class="num" id="5386358">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386363">quantErrorNext</span><span class="op" id="5386377">[</span><span class="ident" id="5386378">x</span><span class="op" id="5386379">+</span><span class="num" id="5386380">0</span><span class="op" id="5386381">]</span><span class="op" id="5386382">[</span><span class="num" id="5386383">1</span><span class="op" id="5386384">]</span>&nbsp;<span class="op" id="5386386">+=</span>&nbsp;<span class="ident" id="5386389">eg</span>&nbsp;<span class="op" id="5386392">*</span>&nbsp;<span class="num" id="5386394">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386399">quantErrorNext</span><span class="op" id="5386413">[</span><span class="ident" id="5386414">x</span><span class="op" id="5386415">+</span><span class="num" id="5386416">0</span><span class="op" id="5386417">]</span><span class="op" id="5386418">[</span><span class="num" id="5386419">2</span><span class="op" id="5386420">]</span>&nbsp;<span class="op" id="5386422">+=</span>&nbsp;<span class="ident" id="5386425">eb</span>&nbsp;<span class="op" id="5386428">*</span>&nbsp;<span class="num" id="5386430">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386435">quantErrorNext</span><span class="op" id="5386449">[</span><span class="ident" id="5386450">x</span><span class="op" id="5386451">+</span><span class="num" id="5386452">1</span><span class="op" id="5386453">]</span><span class="op" id="5386454">[</span><span class="num" id="5386455">0</span><span class="op" id="5386456">]</span>&nbsp;<span class="op" id="5386458">+=</span>&nbsp;<span class="ident" id="5386461">er</span>&nbsp;<span class="op" id="5386464">*</span>&nbsp;<span class="num" id="5386466">5</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386471">quantErrorNext</span><span class="op" id="5386485">[</span><span class="ident" id="5386486">x</span><span class="op" id="5386487">+</span><span class="num" id="5386488">1</span><span class="op" id="5386489">]</span><span class="op" id="5386490">[</span><span class="num" id="5386491">1</span><span class="op" id="5386492">]</span>&nbsp;<span class="op" id="5386494">+=</span>&nbsp;<span class="ident" id="5386497">eg</span>&nbsp;<span class="op" id="5386500">*</span>&nbsp;<span class="num" id="5386502">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386507">quantErrorNext</span><span class="op" id="5386521">[</span><span class="ident" id="5386522">x</span><span class="op" id="5386523">+</span><span class="num" id="5386524">1</span><span class="op" id="5386525">]</span><span class="op" id="5386526">[</span><span class="num" id="5386527">2</span><span class="op" id="5386528">]</span>&nbsp;<span class="op" id="5386530">+=</span>&nbsp;<span class="ident" id="5386533">eb</span>&nbsp;<span class="op" id="5386536">*</span>&nbsp;<span class="num" id="5386538">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386543">quantErrorNext</span><span class="op" id="5386557">[</span><span class="ident" id="5386558">x</span><span class="op" id="5386559">+</span><span class="num" id="5386560">2</span><span class="op" id="5386561">]</span><span class="op" id="5386562">[</span><span class="num" id="5386563">0</span><span class="op" id="5386564">]</span>&nbsp;<span class="op" id="5386566">+=</span>&nbsp;<span class="ident" id="5386569">er</span>&nbsp;<span class="op" id="5386572">*</span>&nbsp;<span class="num" id="5386574">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386579">quantErrorNext</span><span class="op" id="5386593">[</span><span class="ident" id="5386594">x</span><span class="op" id="5386595">+</span><span class="num" id="5386596">2</span><span class="op" id="5386597">]</span><span class="op" id="5386598">[</span><span class="num" id="5386599">1</span><span class="op" id="5386600">]</span>&nbsp;<span class="op" id="5386602">+=</span>&nbsp;<span class="ident" id="5386605">eg</span>&nbsp;<span class="op" id="5386608">*</span>&nbsp;<span class="num" id="5386610">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386615">quantErrorNext</span><span class="op" id="5386629">[</span><span class="ident" id="5386630">x</span><span class="op" id="5386631">+</span><span class="num" id="5386632">2</span><span class="op" id="5386633">]</span><span class="op" id="5386634">[</span><span class="num" id="5386635">2</span><span class="op" id="5386636">]</span>&nbsp;<span class="op" id="5386638">+=</span>&nbsp;<span class="ident" id="5386641">eb</span>&nbsp;<span class="op" id="5386644">*</span>&nbsp;<span class="num" id="5386646">1</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386651">quantErrorCurr</span><span class="op" id="5386665">[</span><span class="ident" id="5386666">x</span><span class="op" id="5386667">+</span><span class="num" id="5386668">2</span><span class="op" id="5386669">]</span><span class="op" id="5386670">[</span><span class="num" id="5386671">0</span><span class="op" id="5386672">]</span>&nbsp;<span class="op" id="5386674">+=</span>&nbsp;<span class="ident" id="5386677">er</span>&nbsp;<span class="op" id="5386680">*</span>&nbsp;<span class="num" id="5386682">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386687">quantErrorCurr</span><span class="op" id="5386701">[</span><span class="ident" id="5386702">x</span><span class="op" id="5386703">+</span><span class="num" id="5386704">2</span><span class="op" id="5386705">]</span><span class="op" id="5386706">[</span><span class="num" id="5386707">1</span><span class="op" id="5386708">]</span>&nbsp;<span class="op" id="5386710">+=</span>&nbsp;<span class="ident" id="5386713">eg</span>&nbsp;<span class="op" id="5386716">*</span>&nbsp;<span class="num" id="5386718">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386723">quantErrorCurr</span><span class="op" id="5386737">[</span><span class="ident" id="5386738">x</span><span class="op" id="5386739">+</span><span class="num" id="5386740">2</span><span class="op" id="5386741">]</span><span class="op" id="5386742">[</span><span class="num" id="5386743">2</span><span class="op" id="5386744">]</span>&nbsp;<span class="op" id="5386746">+=</span>&nbsp;<span class="ident" id="5386749">eb</span>&nbsp;<span class="op" id="5386752">*</span>&nbsp;<span class="num" id="5386754">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386763">//&nbsp;Recycle&nbsp;the&nbsp;quantization&nbsp;error&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386808">if</span>&nbsp;<span class="ident" id="5386811">floydSteinberg</span>&nbsp;<span class="op" id="5386826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386831">quantErrorCurr</span><span class="op" id="5386845">,</span>&nbsp;<span class="ident" id="5386847">quantErrorNext</span>&nbsp;<span class="op" id="5386862">=</span>&nbsp;<span class="ident" id="5386864">quantErrorNext</span><span class="op" id="5386878">,</span>&nbsp;<span class="ident" id="5386880">quantErrorCurr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386898">for</span>&nbsp;<span class="ident" id="5386902">i</span>&nbsp;<span class="op" id="5386904">:=</span>&nbsp;<span class="keyword" id="5386907">range</span>&nbsp;<span class="ident" id="5386913">quantErrorNext</span>&nbsp;<span class="op" id="5386928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386934">quantErrorNext</span><span class="op" id="5386948">[</span><span class="ident" id="5386949">i</span><span class="op" id="5386950">]</span>&nbsp;<span class="op" id="5386952">=</span>&nbsp;<span class="op" id="5386954">[</span><span class="num" id="5386955">3</span><span class="op" id="5386956">]</span><span class="builtintype" id="5386957">int32</span><span class="op" id="5386962">{</span><span class="op" id="5386963">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386975">}</span><br>
<span class="lineno"></span><span class="op" id="5386977">}</span>
</div>
</body>
</html>
