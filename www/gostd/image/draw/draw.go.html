<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/draw</h2>
<ul>
<li><a href="/gostd/image/draw/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/image/draw/clip_test.go.html">clip_test.go</a></li>
<li><a href="/gostd/image/draw/draw.go.html">draw.go</a></li>
<li><a href="/gostd/image/draw/draw_test.go.html">draw_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4047712">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4047768">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4047822">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4047873">//&nbsp;Package&nbsp;draw&nbsp;provides&nbsp;image&nbsp;composition&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="4047927">//</span><br>
<span class="lineno"></span><span class="comment" id="4047930">//&nbsp;See&nbsp;&#34;The&nbsp;Go&nbsp;image/draw&nbsp;package&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno"></span><span class="comment" id="4048002">//&nbsp;http://golang.org/doc/articles/image_draw.html</span><br>
<span class="lineno"></span><span class="keyword" id="4048052">package</span>&nbsp;<span class="ident" id="4048060">draw</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4048066">import</span>&nbsp;<span class="op" id="4048073">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4048076">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4048085">&#34;image/color&#34;</span><br>
<span class="lineno"></span><span class="op" id="4048099">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="4048102">//&nbsp;m&nbsp;is&nbsp;the&nbsp;maximum&nbsp;color&nbsp;value&nbsp;returned&nbsp;by&nbsp;image.Color.RGBA.</span><br>
<span class="lineno"></span><span class="keyword" id="4048164">const</span>&nbsp;<span class="ident" id="4048170">m</span>&nbsp;<span class="op" id="4048172">=</span>&nbsp;<span class="num" id="4048174">1</span><span class="op" id="4048175">&lt;&lt;</span><span class="num" id="4048177">16</span>&nbsp;<span class="op" id="4048180">-</span>&nbsp;<span class="num" id="4048182">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4048185">//&nbsp;Image&nbsp;is&nbsp;an&nbsp;image.Image&nbsp;with&nbsp;a&nbsp;Set&nbsp;method&nbsp;to&nbsp;change&nbsp;a&nbsp;single&nbsp;pixel.</span><br>
<span class="lineno">20</span><span class="keyword" id="4048256">type</span>&nbsp;<span class="ident" id="4048261">Image</span>&nbsp;<span class="keyword" id="4048267">interface</span>&nbsp;<span class="op" id="4048277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4048280">image</span><span class="op" id="4048285">.</span><span class="ident" id="4048286">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4048293">Set</span><span class="op" id="4048296">(</span><span class="ident" id="4048297">x</span><span class="op" id="4048298">,</span>&nbsp;<span class="ident" id="4048300">y</span>&nbsp;<span class="builtintype" id="4048302">int</span><span class="op" id="4048305">,</span>&nbsp;<span class="ident" id="4048307">c</span>&nbsp;<span class="ident" id="4048309">color</span><span class="op" id="4048314">.</span><span class="ident" id="4048315">Color</span><span class="op" id="4048320">)</span><br>
<span class="lineno"></span><span class="op" id="4048322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4048325">//&nbsp;Quantizer&nbsp;produces&nbsp;a&nbsp;palette&nbsp;for&nbsp;an&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="4048371">type</span>&nbsp;<span class="ident" id="4048376">Quantizer</span>&nbsp;<span class="keyword" id="4048386">interface</span>&nbsp;<span class="op" id="4048396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4048399">//&nbsp;Quantize&nbsp;appends&nbsp;up&nbsp;to&nbsp;cap(p)&nbsp;-&nbsp;len(p)&nbsp;colors&nbsp;to&nbsp;p&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4048470">//&nbsp;updated&nbsp;palette&nbsp;suitable&nbsp;for&nbsp;converting&nbsp;m&nbsp;to&nbsp;a&nbsp;paletted&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4048537">Quantize</span><span class="op" id="4048545">(</span><span class="ident" id="4048546">p</span>&nbsp;<span class="ident" id="4048548">color</span><span class="op" id="4048553">.</span><span class="ident" id="4048554">Palette</span><span class="op" id="4048561">,</span>&nbsp;<span class="ident" id="4048563">m</span>&nbsp;<span class="ident" id="4048565">image</span><span class="op" id="4048570">.</span><span class="ident" id="4048571">Image</span><span class="op" id="4048576">)</span>&nbsp;<span class="ident" id="4048578">color</span><span class="op" id="4048583">.</span><span class="ident" id="4048584">Palette</span><br>
<span class="lineno">30</span><span class="op" id="4048592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4048595">//&nbsp;Op&nbsp;is&nbsp;a&nbsp;Porter-Duff&nbsp;compositing&nbsp;operator.</span><br>
<span class="lineno"></span><span class="keyword" id="4048640">type</span>&nbsp;<span class="ident" id="4048645">Op</span>&nbsp;<span class="builtintype" id="4048648">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="4048653">const</span>&nbsp;<span class="op" id="4048659">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4048662">//&nbsp;Over&nbsp;specifies&nbsp;``(src&nbsp;in&nbsp;mask)&nbsp;over&nbsp;dst&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4048709">Over</span>&nbsp;<span class="ident" id="4048714">Op</span>&nbsp;<span class="op" id="4048717">=</span>&nbsp;<span class="ident" id="4048719">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4048725">//&nbsp;Src&nbsp;specifies&nbsp;``src&nbsp;in&nbsp;mask&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4048760">Src</span><br>
<span class="lineno">40</span><span class="op" id="4048764">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4048767">//&nbsp;Draw&nbsp;implements&nbsp;the&nbsp;Drawer&nbsp;interface&nbsp;by&nbsp;calling&nbsp;the&nbsp;Draw&nbsp;function&nbsp;with&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="4048846">//&nbsp;Op.</span><br>
<span class="lineno"></span><span class="keyword" id="4048853">func</span>&nbsp;<span class="op" id="4048858">(</span><span class="ident" id="4048859">op</span>&nbsp;<span class="ident" id="4048862">Op</span><span class="op" id="4048864">)</span>&nbsp;<span class="ident" id="4048866">Draw</span><span class="op" id="4048870">(</span><span class="ident" id="4048871">dst</span>&nbsp;<span class="ident" id="4048875">Image</span><span class="op" id="4048880">,</span>&nbsp;<span class="ident" id="4048882">r</span>&nbsp;<span class="ident" id="4048884">image</span><span class="op" id="4048889">.</span><span class="ident" id="4048890">Rectangle</span><span class="op" id="4048899">,</span>&nbsp;<span class="ident" id="4048901">src</span>&nbsp;<span class="ident" id="4048905">image</span><span class="op" id="4048910">.</span><span class="ident" id="4048911">Image</span><span class="op" id="4048916">,</span>&nbsp;<span class="ident" id="4048918">sp</span>&nbsp;<span class="ident" id="4048921">image</span><span class="op" id="4048926">.</span><span class="ident" id="4048927">Point</span><span class="op" id="4048932">)</span>&nbsp;<span class="op" id="4048934">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4048937">DrawMask</span><span class="op" id="4048945">(</span><span class="ident" id="4048946">dst</span><span class="op" id="4048949">,</span>&nbsp;<span class="ident" id="4048951">r</span><span class="op" id="4048952">,</span>&nbsp;<span class="ident" id="4048954">src</span><span class="op" id="4048957">,</span>&nbsp;<span class="ident" id="4048959">sp</span><span class="op" id="4048961">,</span>&nbsp;<span class="ident" id="4048963">nil</span><span class="op" id="4048966">,</span>&nbsp;<span class="ident" id="4048968">image</span><span class="op" id="4048973">.</span><span class="ident" id="4048974">Point</span><span class="op" id="4048979">{</span><span class="op" id="4048980">}</span><span class="op" id="4048981">,</span>&nbsp;<span class="ident" id="4048983">op</span><span class="op" id="4048985">)</span><br>
<span class="lineno"></span><span class="op" id="4048987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4048990">//&nbsp;Drawer&nbsp;contains&nbsp;the&nbsp;Draw&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="4049026">type</span>&nbsp;<span class="ident" id="4049031">Drawer</span>&nbsp;<span class="keyword" id="4049038">interface</span>&nbsp;<span class="op" id="4049048">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4049051">//&nbsp;Draw&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4049117">//&nbsp;rectangle&nbsp;r&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;drawing&nbsp;src&nbsp;on&nbsp;dst.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4049179">Draw</span><span class="op" id="4049183">(</span><span class="ident" id="4049184">dst</span>&nbsp;<span class="ident" id="4049188">Image</span><span class="op" id="4049193">,</span>&nbsp;<span class="ident" id="4049195">r</span>&nbsp;<span class="ident" id="4049197">image</span><span class="op" id="4049202">.</span><span class="ident" id="4049203">Rectangle</span><span class="op" id="4049212">,</span>&nbsp;<span class="ident" id="4049214">src</span>&nbsp;<span class="ident" id="4049218">image</span><span class="op" id="4049223">.</span><span class="ident" id="4049224">Image</span><span class="op" id="4049229">,</span>&nbsp;<span class="ident" id="4049231">sp</span>&nbsp;<span class="ident" id="4049234">image</span><span class="op" id="4049239">.</span><span class="ident" id="4049240">Point</span><span class="op" id="4049245">)</span><br>
<span class="lineno"></span><span class="op" id="4049247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="4049250">//&nbsp;FloydSteinberg&nbsp;is&nbsp;a&nbsp;Drawer&nbsp;that&nbsp;is&nbsp;the&nbsp;Src&nbsp;Op&nbsp;with&nbsp;Floyd-Steinberg&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4049326">//&nbsp;diffusion.</span><br>
<span class="lineno"></span><span class="keyword" id="4049340">var</span>&nbsp;<span class="ident" id="4049344">FloydSteinberg</span>&nbsp;<span class="ident" id="4049359">Drawer</span>&nbsp;<span class="op" id="4049366">=</span>&nbsp;<span class="ident" id="4049368">floydSteinberg</span><span class="op" id="4049382">{</span><span class="op" id="4049383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4049386">type</span>&nbsp;<span class="ident" id="4049391">floydSteinberg</span>&nbsp;<span class="keyword" id="4049406">struct</span><span class="op" id="4049412">{</span><span class="op" id="4049413">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="4049416">func</span>&nbsp;<span class="op" id="4049421">(</span><span class="ident" id="4049422">floydSteinberg</span><span class="op" id="4049436">)</span>&nbsp;<span class="ident" id="4049438">Draw</span><span class="op" id="4049442">(</span><span class="ident" id="4049443">dst</span>&nbsp;<span class="ident" id="4049447">Image</span><span class="op" id="4049452">,</span>&nbsp;<span class="ident" id="4049454">r</span>&nbsp;<span class="ident" id="4049456">image</span><span class="op" id="4049461">.</span><span class="ident" id="4049462">Rectangle</span><span class="op" id="4049471">,</span>&nbsp;<span class="ident" id="4049473">src</span>&nbsp;<span class="ident" id="4049477">image</span><span class="op" id="4049482">.</span><span class="ident" id="4049483">Image</span><span class="op" id="4049488">,</span>&nbsp;<span class="ident" id="4049490">sp</span>&nbsp;<span class="ident" id="4049493">image</span><span class="op" id="4049498">.</span><span class="ident" id="4049499">Point</span><span class="op" id="4049504">)</span>&nbsp;<span class="op" id="4049506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4049509">clip</span><span class="op" id="4049513">(</span><span class="ident" id="4049514">dst</span><span class="op" id="4049517">,</span>&nbsp;<span class="op" id="4049519">&amp;</span><span class="ident" id="4049520">r</span><span class="op" id="4049521">,</span>&nbsp;<span class="ident" id="4049523">src</span><span class="op" id="4049526">,</span>&nbsp;<span class="op" id="4049528">&amp;</span><span class="ident" id="4049529">sp</span><span class="op" id="4049531">,</span>&nbsp;<span class="ident" id="4049533">nil</span><span class="op" id="4049536">,</span>&nbsp;<span class="ident" id="4049538">nil</span><span class="op" id="4049541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4049544">if</span>&nbsp;<span class="ident" id="4049547">r</span><span class="op" id="4049548">.</span><span class="ident" id="4049549">Empty</span><span class="op" id="4049554">(</span><span class="op" id="4049555">)</span>&nbsp;<span class="op" id="4049557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4049561">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4049569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4049572">drawPaletted</span><span class="op" id="4049584">(</span><span class="ident" id="4049585">dst</span><span class="op" id="4049588">,</span>&nbsp;<span class="ident" id="4049590">r</span><span class="op" id="4049591">,</span>&nbsp;<span class="ident" id="4049593">src</span><span class="op" id="4049596">,</span>&nbsp;<span class="ident" id="4049598">sp</span><span class="op" id="4049600">,</span>&nbsp;<span class="builtintype" id="4049602">true</span><span class="op" id="4049606">)</span><br>
<span class="lineno"></span><span class="op" id="4049608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4049611">//&nbsp;clip&nbsp;clips&nbsp;r&nbsp;against&nbsp;each&nbsp;image&#39;s&nbsp;bounds&nbsp;(after&nbsp;translating&nbsp;into&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="4049683">//&nbsp;destination&nbsp;image&#39;s&nbsp;co-ordinate&nbsp;space)&nbsp;and&nbsp;shifts&nbsp;the&nbsp;points&nbsp;sp&nbsp;and&nbsp;mp&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4049760">//&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;change&nbsp;in&nbsp;r.Min.</span><br>
<span class="lineno"></span><span class="keyword" id="4049803">func</span>&nbsp;<span class="ident" id="4049808">clip</span><span class="op" id="4049812">(</span><span class="ident" id="4049813">dst</span>&nbsp;<span class="ident" id="4049817">Image</span><span class="op" id="4049822">,</span>&nbsp;<span class="ident" id="4049824">r</span>&nbsp;<span class="op" id="4049826">*</span><span class="ident" id="4049827">image</span><span class="op" id="4049832">.</span><span class="ident" id="4049833">Rectangle</span><span class="op" id="4049842">,</span>&nbsp;<span class="ident" id="4049844">src</span>&nbsp;<span class="ident" id="4049848">image</span><span class="op" id="4049853">.</span><span class="ident" id="4049854">Image</span><span class="op" id="4049859">,</span>&nbsp;<span class="ident" id="4049861">sp</span>&nbsp;<span class="op" id="4049864">*</span><span class="ident" id="4049865">image</span><span class="op" id="4049870">.</span><span class="ident" id="4049871">Point</span><span class="op" id="4049876">,</span>&nbsp;<span class="ident" id="4049878">mask</span>&nbsp;<span class="ident" id="4049883">image</span><span class="op" id="4049888">.</span><span class="ident" id="4049889">Image</span><span class="op" id="4049894">,</span>&nbsp;<span class="ident" id="4049896">mp</span>&nbsp;<span class="op" id="4049899">*</span><span class="ident" id="4049900">image</span><span class="op" id="4049905">.</span><span class="ident" id="4049906">Point</span><span class="op" id="4049911">)</span>&nbsp;<span class="op" id="4049913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4049916">orig</span>&nbsp;<span class="op" id="4049921">:=</span>&nbsp;<span class="ident" id="4049924">r</span><span class="op" id="4049925">.</span><span class="ident" id="4049926">Min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4049931">*</span><span class="ident" id="4049932">r</span>&nbsp;<span class="op" id="4049934">=</span>&nbsp;<span class="ident" id="4049936">r</span><span class="op" id="4049937">.</span><span class="ident" id="4049938">Intersect</span><span class="op" id="4049947">(</span><span class="ident" id="4049948">dst</span><span class="op" id="4049951">.</span><span class="ident" id="4049952">Bounds</span><span class="op" id="4049958">(</span><span class="op" id="4049959">)</span><span class="op" id="4049960">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4049963">*</span><span class="ident" id="4049964">r</span>&nbsp;<span class="op" id="4049966">=</span>&nbsp;<span class="ident" id="4049968">r</span><span class="op" id="4049969">.</span><span class="ident" id="4049970">Intersect</span><span class="op" id="4049979">(</span><span class="ident" id="4049980">src</span><span class="op" id="4049983">.</span><span class="ident" id="4049984">Bounds</span><span class="op" id="4049990">(</span><span class="op" id="4049991">)</span><span class="op" id="4049992">.</span><span class="ident" id="4049993">Add</span><span class="op" id="4049996">(</span><span class="ident" id="4049997">orig</span><span class="op" id="4050001">.</span><span class="ident" id="4050002">Sub</span><span class="op" id="4050005">(</span><span class="op" id="4050006">*</span><span class="ident" id="4050007">sp</span><span class="op" id="4050009">)</span><span class="op" id="4050010">)</span><span class="op" id="4050011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050014">if</span>&nbsp;<span class="ident" id="4050017">mask</span>&nbsp;<span class="op" id="4050022">!=</span>&nbsp;<span class="ident" id="4050025">nil</span>&nbsp;<span class="op" id="4050029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050033">*</span><span class="ident" id="4050034">r</span>&nbsp;<span class="op" id="4050036">=</span>&nbsp;<span class="ident" id="4050038">r</span><span class="op" id="4050039">.</span><span class="ident" id="4050040">Intersect</span><span class="op" id="4050049">(</span><span class="ident" id="4050050">mask</span><span class="op" id="4050054">.</span><span class="ident" id="4050055">Bounds</span><span class="op" id="4050061">(</span><span class="op" id="4050062">)</span><span class="op" id="4050063">.</span><span class="ident" id="4050064">Add</span><span class="op" id="4050067">(</span><span class="ident" id="4050068">orig</span><span class="op" id="4050072">.</span><span class="ident" id="4050073">Sub</span><span class="op" id="4050076">(</span><span class="op" id="4050077">*</span><span class="ident" id="4050078">mp</span><span class="op" id="4050080">)</span><span class="op" id="4050081">)</span><span class="op" id="4050082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4050088">dx</span>&nbsp;<span class="op" id="4050091">:=</span>&nbsp;<span class="ident" id="4050094">r</span><span class="op" id="4050095">.</span><span class="ident" id="4050096">Min</span><span class="op" id="4050099">.</span><span class="ident" id="4050100">X</span>&nbsp;<span class="op" id="4050102">-</span>&nbsp;<span class="ident" id="4050104">orig</span><span class="op" id="4050108">.</span><span class="ident" id="4050109">X</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4050112">dy</span>&nbsp;<span class="op" id="4050115">:=</span>&nbsp;<span class="ident" id="4050118">r</span><span class="op" id="4050119">.</span><span class="ident" id="4050120">Min</span><span class="op" id="4050123">.</span><span class="ident" id="4050124">Y</span>&nbsp;<span class="op" id="4050126">-</span>&nbsp;<span class="ident" id="4050128">orig</span><span class="op" id="4050132">.</span><span class="ident" id="4050133">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050136">if</span>&nbsp;<span class="ident" id="4050139">dx</span>&nbsp;<span class="op" id="4050142">==</span>&nbsp;<span class="num" id="4050145">0</span>&nbsp;<span class="op" id="4050147">&amp;&amp;</span>&nbsp;<span class="ident" id="4050150">dy</span>&nbsp;<span class="op" id="4050153">==</span>&nbsp;<span class="num" id="4050156">0</span>&nbsp;<span class="op" id="4050158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050162">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050173">(</span><span class="op" id="4050174">*</span><span class="ident" id="4050175">sp</span><span class="op" id="4050177">)</span><span class="op" id="4050178">.</span><span class="ident" id="4050179">X</span>&nbsp;<span class="op" id="4050181">+=</span>&nbsp;<span class="ident" id="4050184">dx</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050188">(</span><span class="op" id="4050189">*</span><span class="ident" id="4050190">sp</span><span class="op" id="4050192">)</span><span class="op" id="4050193">.</span><span class="ident" id="4050194">Y</span>&nbsp;<span class="op" id="4050196">+=</span>&nbsp;<span class="ident" id="4050199">dy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050203">(</span><span class="op" id="4050204">*</span><span class="ident" id="4050205">mp</span><span class="op" id="4050207">)</span><span class="op" id="4050208">.</span><span class="ident" id="4050209">X</span>&nbsp;<span class="op" id="4050211">+=</span>&nbsp;<span class="ident" id="4050214">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050218">(</span><span class="op" id="4050219">*</span><span class="ident" id="4050220">mp</span><span class="op" id="4050222">)</span><span class="op" id="4050223">.</span><span class="ident" id="4050224">Y</span>&nbsp;<span class="op" id="4050226">+=</span>&nbsp;<span class="ident" id="4050229">dy</span><br>
<span class="lineno"></span><span class="op" id="4050232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="4050235">func</span>&nbsp;<span class="ident" id="4050240">processBackward</span><span class="op" id="4050255">(</span><span class="ident" id="4050256">dst</span>&nbsp;<span class="ident" id="4050260">Image</span><span class="op" id="4050265">,</span>&nbsp;<span class="ident" id="4050267">r</span>&nbsp;<span class="ident" id="4050269">image</span><span class="op" id="4050274">.</span><span class="ident" id="4050275">Rectangle</span><span class="op" id="4050284">,</span>&nbsp;<span class="ident" id="4050286">src</span>&nbsp;<span class="ident" id="4050290">image</span><span class="op" id="4050295">.</span><span class="ident" id="4050296">Image</span><span class="op" id="4050301">,</span>&nbsp;<span class="ident" id="4050303">sp</span>&nbsp;<span class="ident" id="4050306">image</span><span class="op" id="4050311">.</span><span class="ident" id="4050312">Point</span><span class="op" id="4050317">)</span>&nbsp;<span class="builtintype" id="4050319">bool</span>&nbsp;<span class="op" id="4050324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050327">return</span>&nbsp;<span class="ident" id="4050334">image</span><span class="op" id="4050339">.</span><span class="ident" id="4050340">Image</span><span class="op" id="4050345">(</span><span class="ident" id="4050346">dst</span><span class="op" id="4050349">)</span>&nbsp;<span class="op" id="4050351">==</span>&nbsp;<span class="ident" id="4050354">src</span>&nbsp;<span class="op" id="4050358">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4050363">r</span><span class="op" id="4050364">.</span><span class="ident" id="4050365">Overlaps</span><span class="op" id="4050373">(</span><span class="ident" id="4050374">r</span><span class="op" id="4050375">.</span><span class="ident" id="4050376">Add</span><span class="op" id="4050379">(</span><span class="ident" id="4050380">sp</span><span class="op" id="4050382">.</span><span class="ident" id="4050383">Sub</span><span class="op" id="4050386">(</span><span class="ident" id="4050387">r</span><span class="op" id="4050388">.</span><span class="ident" id="4050389">Min</span><span class="op" id="4050392">)</span><span class="op" id="4050393">)</span><span class="op" id="4050394">)</span>&nbsp;<span class="op" id="4050396">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4050401">(</span><span class="ident" id="4050402">sp</span><span class="op" id="4050404">.</span><span class="ident" id="4050405">Y</span>&nbsp;<span class="op" id="4050407">&lt;</span>&nbsp;<span class="ident" id="4050409">r</span><span class="op" id="4050410">.</span><span class="ident" id="4050411">Min</span><span class="op" id="4050414">.</span><span class="ident" id="4050415">Y</span>&nbsp;<span class="op" id="4050417">||</span>&nbsp;<span class="op" id="4050420">(</span><span class="ident" id="4050421">sp</span><span class="op" id="4050423">.</span><span class="ident" id="4050424">Y</span>&nbsp;<span class="op" id="4050426">==</span>&nbsp;<span class="ident" id="4050429">r</span><span class="op" id="4050430">.</span><span class="ident" id="4050431">Min</span><span class="op" id="4050434">.</span><span class="ident" id="4050435">Y</span>&nbsp;<span class="op" id="4050437">&amp;&amp;</span>&nbsp;<span class="ident" id="4050440">sp</span><span class="op" id="4050442">.</span><span class="ident" id="4050443">X</span>&nbsp;<span class="op" id="4050445">&lt;</span>&nbsp;<span class="ident" id="4050447">r</span><span class="op" id="4050448">.</span><span class="ident" id="4050449">Min</span><span class="op" id="4050452">.</span><span class="ident" id="4050453">X</span><span class="op" id="4050454">)</span><span class="op" id="4050455">)</span><br>
<span class="lineno"></span><span class="op" id="4050457">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="4050460">//&nbsp;Draw&nbsp;calls&nbsp;DrawMask&nbsp;with&nbsp;a&nbsp;nil&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="4050500">func</span>&nbsp;<span class="ident" id="4050505">Draw</span><span class="op" id="4050509">(</span><span class="ident" id="4050510">dst</span>&nbsp;<span class="ident" id="4050514">Image</span><span class="op" id="4050519">,</span>&nbsp;<span class="ident" id="4050521">r</span>&nbsp;<span class="ident" id="4050523">image</span><span class="op" id="4050528">.</span><span class="ident" id="4050529">Rectangle</span><span class="op" id="4050538">,</span>&nbsp;<span class="ident" id="4050540">src</span>&nbsp;<span class="ident" id="4050544">image</span><span class="op" id="4050549">.</span><span class="ident" id="4050550">Image</span><span class="op" id="4050555">,</span>&nbsp;<span class="ident" id="4050557">sp</span>&nbsp;<span class="ident" id="4050560">image</span><span class="op" id="4050565">.</span><span class="ident" id="4050566">Point</span><span class="op" id="4050571">,</span>&nbsp;<span class="ident" id="4050573">op</span>&nbsp;<span class="ident" id="4050576">Op</span><span class="op" id="4050578">)</span>&nbsp;<span class="op" id="4050580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4050583">DrawMask</span><span class="op" id="4050591">(</span><span class="ident" id="4050592">dst</span><span class="op" id="4050595">,</span>&nbsp;<span class="ident" id="4050597">r</span><span class="op" id="4050598">,</span>&nbsp;<span class="ident" id="4050600">src</span><span class="op" id="4050603">,</span>&nbsp;<span class="ident" id="4050605">sp</span><span class="op" id="4050607">,</span>&nbsp;<span class="ident" id="4050609">nil</span><span class="op" id="4050612">,</span>&nbsp;<span class="ident" id="4050614">image</span><span class="op" id="4050619">.</span><span class="ident" id="4050620">Point</span><span class="op" id="4050625">{</span><span class="op" id="4050626">}</span><span class="op" id="4050627">,</span>&nbsp;<span class="ident" id="4050629">op</span><span class="op" id="4050631">)</span><br>
<span class="lineno"></span><span class="op" id="4050633">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="4050636">//&nbsp;DrawMask&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;mp&nbsp;in&nbsp;mask&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the&nbsp;rectangle&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="4050732">//&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;Porter-Duff&nbsp;composition.&nbsp;A&nbsp;nil&nbsp;mask&nbsp;is&nbsp;treated&nbsp;as&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="4050821">func</span>&nbsp;<span class="ident" id="4050826">DrawMask</span><span class="op" id="4050834">(</span><span class="ident" id="4050835">dst</span>&nbsp;<span class="ident" id="4050839">Image</span><span class="op" id="4050844">,</span>&nbsp;<span class="ident" id="4050846">r</span>&nbsp;<span class="ident" id="4050848">image</span><span class="op" id="4050853">.</span><span class="ident" id="4050854">Rectangle</span><span class="op" id="4050863">,</span>&nbsp;<span class="ident" id="4050865">src</span>&nbsp;<span class="ident" id="4050869">image</span><span class="op" id="4050874">.</span><span class="ident" id="4050875">Image</span><span class="op" id="4050880">,</span>&nbsp;<span class="ident" id="4050882">sp</span>&nbsp;<span class="ident" id="4050885">image</span><span class="op" id="4050890">.</span><span class="ident" id="4050891">Point</span><span class="op" id="4050896">,</span>&nbsp;<span class="ident" id="4050898">mask</span>&nbsp;<span class="ident" id="4050903">image</span><span class="op" id="4050908">.</span><span class="ident" id="4050909">Image</span><span class="op" id="4050914">,</span>&nbsp;<span class="ident" id="4050916">mp</span>&nbsp;<span class="ident" id="4050919">image</span><span class="op" id="4050924">.</span><span class="ident" id="4050925">Point</span><span class="op" id="4050930">,</span>&nbsp;<span class="ident" id="4050932">op</span>&nbsp;<span class="ident" id="4050935">Op</span><span class="op" id="4050937">)</span>&nbsp;<span class="op" id="4050939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4050942">clip</span><span class="op" id="4050946">(</span><span class="ident" id="4050947">dst</span><span class="op" id="4050950">,</span>&nbsp;<span class="op" id="4050952">&amp;</span><span class="ident" id="4050953">r</span><span class="op" id="4050954">,</span>&nbsp;<span class="ident" id="4050956">src</span><span class="op" id="4050959">,</span>&nbsp;<span class="op" id="4050961">&amp;</span><span class="ident" id="4050962">sp</span><span class="op" id="4050964">,</span>&nbsp;<span class="ident" id="4050966">mask</span><span class="op" id="4050970">,</span>&nbsp;<span class="op" id="4050972">&amp;</span><span class="ident" id="4050973">mp</span><span class="op" id="4050975">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050978">if</span>&nbsp;<span class="ident" id="4050981">r</span><span class="op" id="4050982">.</span><span class="ident" id="4050983">Empty</span><span class="op" id="4050988">(</span><span class="op" id="4050989">)</span>&nbsp;<span class="op" id="4050991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4050995">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4051007">//&nbsp;Fast&nbsp;paths&nbsp;for&nbsp;special&nbsp;cases.&nbsp;If&nbsp;none&nbsp;of&nbsp;them&nbsp;apply,&nbsp;then&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;a&nbsp;general&nbsp;but&nbsp;slow&nbsp;implementation.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051120">switch</span>&nbsp;<span class="ident" id="4051127">dst0</span>&nbsp;<span class="op" id="4051132">:=</span>&nbsp;<span class="ident" id="4051135">dst</span><span class="op" id="4051138">.</span><span class="op" id="4051139">(</span><span class="keyword" id="4051140">type</span><span class="op" id="4051144">)</span>&nbsp;<span class="op" id="4051146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051149">case</span>&nbsp;<span class="op" id="4051154">*</span><span class="ident" id="4051155">image</span><span class="op" id="4051160">.</span><span class="ident" id="4051161">RGBA</span><span class="op" id="4051165">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051169">if</span>&nbsp;<span class="ident" id="4051172">op</span>&nbsp;<span class="op" id="4051175">==</span>&nbsp;<span class="ident" id="4051178">Over</span>&nbsp;<span class="op" id="4051183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051188">if</span>&nbsp;<span class="ident" id="4051191">mask</span>&nbsp;<span class="op" id="4051196">==</span>&nbsp;<span class="ident" id="4051199">nil</span>&nbsp;<span class="op" id="4051203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051209">switch</span>&nbsp;<span class="ident" id="4051216">src0</span>&nbsp;<span class="op" id="4051221">:=</span>&nbsp;<span class="ident" id="4051224">src</span><span class="op" id="4051227">.</span><span class="op" id="4051228">(</span><span class="keyword" id="4051229">type</span><span class="op" id="4051233">)</span>&nbsp;<span class="op" id="4051235">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051241">case</span>&nbsp;<span class="op" id="4051246">*</span><span class="ident" id="4051247">image</span><span class="op" id="4051252">.</span><span class="ident" id="4051253">Uniform</span><span class="op" id="4051260">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051267">drawFillOver</span><span class="op" id="4051279">(</span><span class="ident" id="4051280">dst0</span><span class="op" id="4051284">,</span>&nbsp;<span class="ident" id="4051286">r</span><span class="op" id="4051287">,</span>&nbsp;<span class="ident" id="4051289">src0</span><span class="op" id="4051293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051300">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051311">case</span>&nbsp;<span class="op" id="4051316">*</span><span class="ident" id="4051317">image</span><span class="op" id="4051322">.</span><span class="ident" id="4051323">RGBA</span><span class="op" id="4051327">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051334">drawCopyOver</span><span class="op" id="4051346">(</span><span class="ident" id="4051347">dst0</span><span class="op" id="4051351">,</span>&nbsp;<span class="ident" id="4051353">r</span><span class="op" id="4051354">,</span>&nbsp;<span class="ident" id="4051356">src0</span><span class="op" id="4051360">,</span>&nbsp;<span class="ident" id="4051362">sp</span><span class="op" id="4051364">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051371">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051382">case</span>&nbsp;<span class="op" id="4051387">*</span><span class="ident" id="4051388">image</span><span class="op" id="4051393">.</span><span class="ident" id="4051394">NRGBA</span><span class="op" id="4051399">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051406">drawNRGBAOver</span><span class="op" id="4051419">(</span><span class="ident" id="4051420">dst0</span><span class="op" id="4051424">,</span>&nbsp;<span class="ident" id="4051426">r</span><span class="op" id="4051427">,</span>&nbsp;<span class="ident" id="4051429">src0</span><span class="op" id="4051433">,</span>&nbsp;<span class="ident" id="4051435">sp</span><span class="op" id="4051437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051444">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051455">case</span>&nbsp;<span class="op" id="4051460">*</span><span class="ident" id="4051461">image</span><span class="op" id="4051466">.</span><span class="ident" id="4051467">YCbCr</span><span class="op" id="4051472">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051479">if</span>&nbsp;<span class="ident" id="4051482">drawYCbCr</span><span class="op" id="4051491">(</span><span class="ident" id="4051492">dst0</span><span class="op" id="4051496">,</span>&nbsp;<span class="ident" id="4051498">r</span><span class="op" id="4051499">,</span>&nbsp;<span class="ident" id="4051501">src0</span><span class="op" id="4051505">,</span>&nbsp;<span class="ident" id="4051507">sp</span><span class="op" id="4051509">)</span>&nbsp;<span class="op" id="4051511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051519">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051542">}</span>&nbsp;<span class="keyword" id="4051544">else</span>&nbsp;<span class="keyword" id="4051549">if</span>&nbsp;<span class="ident" id="4051552">mask0</span><span class="op" id="4051557">,</span>&nbsp;<span class="ident" id="4051559">ok</span>&nbsp;<span class="op" id="4051562">:=</span>&nbsp;<span class="ident" id="4051565">mask</span><span class="op" id="4051569">.</span><span class="op" id="4051570">(</span><span class="op" id="4051571">*</span><span class="ident" id="4051572">image</span><span class="op" id="4051577">.</span><span class="ident" id="4051578">Alpha</span><span class="op" id="4051583">)</span><span class="op" id="4051584">;</span>&nbsp;<span class="ident" id="4051586">ok</span>&nbsp;<span class="op" id="4051589">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051595">switch</span>&nbsp;<span class="ident" id="4051602">src0</span>&nbsp;<span class="op" id="4051607">:=</span>&nbsp;<span class="ident" id="4051610">src</span><span class="op" id="4051613">.</span><span class="op" id="4051614">(</span><span class="keyword" id="4051615">type</span><span class="op" id="4051619">)</span>&nbsp;<span class="op" id="4051621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051627">case</span>&nbsp;<span class="op" id="4051632">*</span><span class="ident" id="4051633">image</span><span class="op" id="4051638">.</span><span class="ident" id="4051639">Uniform</span><span class="op" id="4051646">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051653">drawGlyphOver</span><span class="op" id="4051666">(</span><span class="ident" id="4051667">dst0</span><span class="op" id="4051671">,</span>&nbsp;<span class="ident" id="4051673">r</span><span class="op" id="4051674">,</span>&nbsp;<span class="ident" id="4051676">src0</span><span class="op" id="4051680">,</span>&nbsp;<span class="ident" id="4051682">mask0</span><span class="op" id="4051687">,</span>&nbsp;<span class="ident" id="4051689">mp</span><span class="op" id="4051691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051698">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051709">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4051718">}</span>&nbsp;<span class="keyword" id="4051720">else</span>&nbsp;<span class="op" id="4051725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051730">if</span>&nbsp;<span class="ident" id="4051733">mask</span>&nbsp;<span class="op" id="4051738">==</span>&nbsp;<span class="ident" id="4051741">nil</span>&nbsp;<span class="op" id="4051745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051751">switch</span>&nbsp;<span class="ident" id="4051758">src0</span>&nbsp;<span class="op" id="4051763">:=</span>&nbsp;<span class="ident" id="4051766">src</span><span class="op" id="4051769">.</span><span class="op" id="4051770">(</span><span class="keyword" id="4051771">type</span><span class="op" id="4051775">)</span>&nbsp;<span class="op" id="4051777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051783">case</span>&nbsp;<span class="op" id="4051788">*</span><span class="ident" id="4051789">image</span><span class="op" id="4051794">.</span><span class="ident" id="4051795">Uniform</span><span class="op" id="4051802">:</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051809">drawFillSrc</span><span class="op" id="4051820">(</span><span class="ident" id="4051821">dst0</span><span class="op" id="4051825">,</span>&nbsp;<span class="ident" id="4051827">r</span><span class="op" id="4051828">,</span>&nbsp;<span class="ident" id="4051830">src0</span><span class="op" id="4051834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051841">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051852">case</span>&nbsp;<span class="op" id="4051857">*</span><span class="ident" id="4051858">image</span><span class="op" id="4051863">.</span><span class="ident" id="4051864">RGBA</span><span class="op" id="4051868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051875">drawCopySrc</span><span class="op" id="4051886">(</span><span class="ident" id="4051887">dst0</span><span class="op" id="4051891">,</span>&nbsp;<span class="ident" id="4051893">r</span><span class="op" id="4051894">,</span>&nbsp;<span class="ident" id="4051896">src0</span><span class="op" id="4051900">,</span>&nbsp;<span class="ident" id="4051902">sp</span><span class="op" id="4051904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051911">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051922">case</span>&nbsp;<span class="op" id="4051927">*</span><span class="ident" id="4051928">image</span><span class="op" id="4051933">.</span><span class="ident" id="4051934">NRGBA</span><span class="op" id="4051939">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4051946">drawNRGBASrc</span><span class="op" id="4051958">(</span><span class="ident" id="4051959">dst0</span><span class="op" id="4051963">,</span>&nbsp;<span class="ident" id="4051965">r</span><span class="op" id="4051966">,</span>&nbsp;<span class="ident" id="4051968">src0</span><span class="op" id="4051972">,</span>&nbsp;<span class="ident" id="4051974">sp</span><span class="op" id="4051976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051983">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4051994">case</span>&nbsp;<span class="op" id="4051999">*</span><span class="ident" id="4052000">image</span><span class="op" id="4052005">.</span><span class="ident" id="4052006">YCbCr</span><span class="op" id="4052011">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052018">if</span>&nbsp;<span class="ident" id="4052021">drawYCbCr</span><span class="op" id="4052030">(</span><span class="ident" id="4052031">dst0</span><span class="op" id="4052035">,</span>&nbsp;<span class="ident" id="4052037">r</span><span class="op" id="4052038">,</span>&nbsp;<span class="ident" id="4052040">src0</span><span class="op" id="4052044">,</span>&nbsp;<span class="ident" id="4052046">sp</span><span class="op" id="4052048">)</span>&nbsp;<span class="op" id="4052050">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052058">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052085">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052089">drawRGBA</span><span class="op" id="4052097">(</span><span class="ident" id="4052098">dst0</span><span class="op" id="4052102">,</span>&nbsp;<span class="ident" id="4052104">r</span><span class="op" id="4052105">,</span>&nbsp;<span class="ident" id="4052107">src</span><span class="op" id="4052110">,</span>&nbsp;<span class="ident" id="4052112">sp</span><span class="op" id="4052114">,</span>&nbsp;<span class="ident" id="4052116">mask</span><span class="op" id="4052120">,</span>&nbsp;<span class="ident" id="4052122">mp</span><span class="op" id="4052124">,</span>&nbsp;<span class="ident" id="4052126">op</span><span class="op" id="4052128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052132">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052140">case</span>&nbsp;<span class="op" id="4052145">*</span><span class="ident" id="4052146">image</span><span class="op" id="4052151">.</span><span class="ident" id="4052152">Paletted</span><span class="op" id="4052160">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052164">if</span>&nbsp;<span class="ident" id="4052167">op</span>&nbsp;<span class="op" id="4052170">==</span>&nbsp;<span class="ident" id="4052173">Src</span>&nbsp;<span class="op" id="4052177">&amp;&amp;</span>&nbsp;<span class="ident" id="4052180">mask</span>&nbsp;<span class="op" id="4052185">==</span>&nbsp;<span class="ident" id="4052188">nil</span>&nbsp;<span class="op" id="4052192">&amp;&amp;</span>&nbsp;<span class="op" id="4052195">!</span><span class="ident" id="4052196">processBackward</span><span class="op" id="4052211">(</span><span class="ident" id="4052212">dst</span><span class="op" id="4052215">,</span>&nbsp;<span class="ident" id="4052217">r</span><span class="op" id="4052218">,</span>&nbsp;<span class="ident" id="4052220">src</span><span class="op" id="4052223">,</span>&nbsp;<span class="ident" id="4052225">sp</span><span class="op" id="4052227">)</span>&nbsp;<span class="op" id="4052229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052234">drawPaletted</span><span class="op" id="4052246">(</span><span class="ident" id="4052247">dst0</span><span class="op" id="4052251">,</span>&nbsp;<span class="ident" id="4052253">r</span><span class="op" id="4052254">,</span>&nbsp;<span class="ident" id="4052256">src</span><span class="op" id="4052259">,</span>&nbsp;<span class="ident" id="4052261">sp</span><span class="op" id="4052263">,</span>&nbsp;<span class="builtintype" id="4052265">false</span><span class="op" id="4052270">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052281">x0</span><span class="op" id="4052283">,</span>&nbsp;<span class="ident" id="4052285">x1</span><span class="op" id="4052287">,</span>&nbsp;<span class="ident" id="4052289">dx</span>&nbsp;<span class="op" id="4052292">:=</span>&nbsp;<span class="ident" id="4052295">r</span><span class="op" id="4052296">.</span><span class="ident" id="4052297">Min</span><span class="op" id="4052300">.</span><span class="ident" id="4052301">X</span><span class="op" id="4052302">,</span>&nbsp;<span class="ident" id="4052304">r</span><span class="op" id="4052305">.</span><span class="ident" id="4052306">Max</span><span class="op" id="4052309">.</span><span class="ident" id="4052310">X</span><span class="op" id="4052311">,</span>&nbsp;<span class="num" id="4052313">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052316">y0</span><span class="op" id="4052318">,</span>&nbsp;<span class="ident" id="4052320">y1</span><span class="op" id="4052322">,</span>&nbsp;<span class="ident" id="4052324">dy</span>&nbsp;<span class="op" id="4052327">:=</span>&nbsp;<span class="ident" id="4052330">r</span><span class="op" id="4052331">.</span><span class="ident" id="4052332">Min</span><span class="op" id="4052335">.</span><span class="ident" id="4052336">Y</span><span class="op" id="4052337">,</span>&nbsp;<span class="ident" id="4052339">r</span><span class="op" id="4052340">.</span><span class="ident" id="4052341">Max</span><span class="op" id="4052344">.</span><span class="ident" id="4052345">Y</span><span class="op" id="4052346">,</span>&nbsp;<span class="num" id="4052348">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052351">if</span>&nbsp;<span class="ident" id="4052354">processBackward</span><span class="op" id="4052369">(</span><span class="ident" id="4052370">dst</span><span class="op" id="4052373">,</span>&nbsp;<span class="ident" id="4052375">r</span><span class="op" id="4052376">,</span>&nbsp;<span class="ident" id="4052378">src</span><span class="op" id="4052381">,</span>&nbsp;<span class="ident" id="4052383">sp</span><span class="op" id="4052385">)</span>&nbsp;<span class="op" id="4052387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052391">x0</span><span class="op" id="4052393">,</span>&nbsp;<span class="ident" id="4052395">x1</span><span class="op" id="4052397">,</span>&nbsp;<span class="ident" id="4052399">dx</span>&nbsp;<span class="op" id="4052402">=</span>&nbsp;<span class="ident" id="4052404">x1</span><span class="op" id="4052406">-</span><span class="num" id="4052407">1</span><span class="op" id="4052408">,</span>&nbsp;<span class="ident" id="4052410">x0</span><span class="op" id="4052412">-</span><span class="num" id="4052413">1</span><span class="op" id="4052414">,</span>&nbsp;<span class="op" id="4052416">-</span><span class="num" id="4052417">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052421">y0</span><span class="op" id="4052423">,</span>&nbsp;<span class="ident" id="4052425">y1</span><span class="op" id="4052427">,</span>&nbsp;<span class="ident" id="4052429">dy</span>&nbsp;<span class="op" id="4052432">=</span>&nbsp;<span class="ident" id="4052434">y1</span><span class="op" id="4052436">-</span><span class="num" id="4052437">1</span><span class="op" id="4052438">,</span>&nbsp;<span class="ident" id="4052440">y0</span><span class="op" id="4052442">-</span><span class="num" id="4052443">1</span><span class="op" id="4052444">,</span>&nbsp;<span class="op" id="4052446">-</span><span class="num" id="4052447">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052454">var</span>&nbsp;<span class="ident" id="4052458">out</span>&nbsp;<span class="ident" id="4052462">color</span><span class="op" id="4052467">.</span><span class="ident" id="4052468">RGBA64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052476">sy</span>&nbsp;<span class="op" id="4052479">:=</span>&nbsp;<span class="ident" id="4052482">sp</span><span class="op" id="4052484">.</span><span class="ident" id="4052485">Y</span>&nbsp;<span class="op" id="4052487">+</span>&nbsp;<span class="ident" id="4052489">y0</span>&nbsp;<span class="op" id="4052492">-</span>&nbsp;<span class="ident" id="4052494">r</span><span class="op" id="4052495">.</span><span class="ident" id="4052496">Min</span><span class="op" id="4052499">.</span><span class="ident" id="4052500">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052503">my</span>&nbsp;<span class="op" id="4052506">:=</span>&nbsp;<span class="ident" id="4052509">mp</span><span class="op" id="4052511">.</span><span class="ident" id="4052512">Y</span>&nbsp;<span class="op" id="4052514">+</span>&nbsp;<span class="ident" id="4052516">y0</span>&nbsp;<span class="op" id="4052519">-</span>&nbsp;<span class="ident" id="4052521">r</span><span class="op" id="4052522">.</span><span class="ident" id="4052523">Min</span><span class="op" id="4052526">.</span><span class="ident" id="4052527">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052530">for</span>&nbsp;<span class="ident" id="4052534">y</span>&nbsp;<span class="op" id="4052536">:=</span>&nbsp;<span class="ident" id="4052539">y0</span><span class="op" id="4052541">;</span>&nbsp;<span class="ident" id="4052543">y</span>&nbsp;<span class="op" id="4052545">!=</span>&nbsp;<span class="ident" id="4052548">y1</span><span class="op" id="4052550">;</span>&nbsp;<span class="ident" id="4052552">y</span><span class="op" id="4052553">,</span>&nbsp;<span class="ident" id="4052555">sy</span><span class="op" id="4052557">,</span>&nbsp;<span class="ident" id="4052559">my</span>&nbsp;<span class="op" id="4052562">=</span>&nbsp;<span class="ident" id="4052564">y</span><span class="op" id="4052565">+</span><span class="ident" id="4052566">dy</span><span class="op" id="4052568">,</span>&nbsp;<span class="ident" id="4052570">sy</span><span class="op" id="4052572">+</span><span class="ident" id="4052573">dy</span><span class="op" id="4052575">,</span>&nbsp;<span class="ident" id="4052577">my</span><span class="op" id="4052579">+</span><span class="ident" id="4052580">dy</span>&nbsp;<span class="op" id="4052583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052587">sx</span>&nbsp;<span class="op" id="4052590">:=</span>&nbsp;<span class="ident" id="4052593">sp</span><span class="op" id="4052595">.</span><span class="ident" id="4052596">X</span>&nbsp;<span class="op" id="4052598">+</span>&nbsp;<span class="ident" id="4052600">x0</span>&nbsp;<span class="op" id="4052603">-</span>&nbsp;<span class="ident" id="4052605">r</span><span class="op" id="4052606">.</span><span class="ident" id="4052607">Min</span><span class="op" id="4052610">.</span><span class="ident" id="4052611">X</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052615">mx</span>&nbsp;<span class="op" id="4052618">:=</span>&nbsp;<span class="ident" id="4052621">mp</span><span class="op" id="4052623">.</span><span class="ident" id="4052624">X</span>&nbsp;<span class="op" id="4052626">+</span>&nbsp;<span class="ident" id="4052628">x0</span>&nbsp;<span class="op" id="4052631">-</span>&nbsp;<span class="ident" id="4052633">r</span><span class="op" id="4052634">.</span><span class="ident" id="4052635">Min</span><span class="op" id="4052638">.</span><span class="ident" id="4052639">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052643">for</span>&nbsp;<span class="ident" id="4052647">x</span>&nbsp;<span class="op" id="4052649">:=</span>&nbsp;<span class="ident" id="4052652">x0</span><span class="op" id="4052654">;</span>&nbsp;<span class="ident" id="4052656">x</span>&nbsp;<span class="op" id="4052658">!=</span>&nbsp;<span class="ident" id="4052661">x1</span><span class="op" id="4052663">;</span>&nbsp;<span class="ident" id="4052665">x</span><span class="op" id="4052666">,</span>&nbsp;<span class="ident" id="4052668">sx</span><span class="op" id="4052670">,</span>&nbsp;<span class="ident" id="4052672">mx</span>&nbsp;<span class="op" id="4052675">=</span>&nbsp;<span class="ident" id="4052677">x</span><span class="op" id="4052678">+</span><span class="ident" id="4052679">dx</span><span class="op" id="4052681">,</span>&nbsp;<span class="ident" id="4052683">sx</span><span class="op" id="4052685">+</span><span class="ident" id="4052686">dx</span><span class="op" id="4052688">,</span>&nbsp;<span class="ident" id="4052690">mx</span><span class="op" id="4052692">+</span><span class="ident" id="4052693">dx</span>&nbsp;<span class="op" id="4052696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052701">ma</span>&nbsp;<span class="op" id="4052704">:=</span>&nbsp;<span class="builtintype" id="4052707">uint32</span><span class="op" id="4052713">(</span><span class="ident" id="4052714">m</span><span class="op" id="4052715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052720">if</span>&nbsp;<span class="ident" id="4052723">mask</span>&nbsp;<span class="op" id="4052728">!=</span>&nbsp;<span class="ident" id="4052731">nil</span>&nbsp;<span class="op" id="4052735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052741">_</span><span class="op" id="4052742">,</span>&nbsp;<span class="ident" id="4052744">_</span><span class="op" id="4052745">,</span>&nbsp;<span class="ident" id="4052747">_</span><span class="op" id="4052748">,</span>&nbsp;<span class="ident" id="4052750">ma</span>&nbsp;<span class="op" id="4052753">=</span>&nbsp;<span class="ident" id="4052755">mask</span><span class="op" id="4052759">.</span><span class="ident" id="4052760">At</span><span class="op" id="4052762">(</span><span class="ident" id="4052763">mx</span><span class="op" id="4052765">,</span>&nbsp;<span class="ident" id="4052767">my</span><span class="op" id="4052769">)</span><span class="op" id="4052770">.</span><span class="ident" id="4052771">RGBA</span><span class="op" id="4052775">(</span><span class="op" id="4052776">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052786">switch</span>&nbsp;<span class="op" id="4052793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052798">case</span>&nbsp;<span class="ident" id="4052803">ma</span>&nbsp;<span class="op" id="4052806">==</span>&nbsp;<span class="num" id="4052809">0</span><span class="op" id="4052810">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052816">if</span>&nbsp;<span class="ident" id="4052819">op</span>&nbsp;<span class="op" id="4052822">==</span>&nbsp;<span class="ident" id="4052825">Over</span>&nbsp;<span class="op" id="4052830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4052837">//&nbsp;No-op.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052851">}</span>&nbsp;<span class="keyword" id="4052853">else</span>&nbsp;<span class="op" id="4052858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052865">dst</span><span class="op" id="4052868">.</span><span class="ident" id="4052869">Set</span><span class="op" id="4052872">(</span><span class="ident" id="4052873">x</span><span class="op" id="4052874">,</span>&nbsp;<span class="ident" id="4052876">y</span><span class="op" id="4052877">,</span>&nbsp;<span class="ident" id="4052879">color</span><span class="op" id="4052884">.</span><span class="ident" id="4052885">Transparent</span><span class="op" id="4052896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4052902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052907">case</span>&nbsp;<span class="ident" id="4052912">ma</span>&nbsp;<span class="op" id="4052915">==</span>&nbsp;<span class="ident" id="4052918">m</span>&nbsp;<span class="op" id="4052920">&amp;&amp;</span>&nbsp;<span class="ident" id="4052923">op</span>&nbsp;<span class="op" id="4052926">==</span>&nbsp;<span class="ident" id="4052929">Src</span><span class="op" id="4052932">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052938">dst</span><span class="op" id="4052941">.</span><span class="ident" id="4052942">Set</span><span class="op" id="4052945">(</span><span class="ident" id="4052946">x</span><span class="op" id="4052947">,</span>&nbsp;<span class="ident" id="4052949">y</span><span class="op" id="4052950">,</span>&nbsp;<span class="ident" id="4052952">src</span><span class="op" id="4052955">.</span><span class="ident" id="4052956">At</span><span class="op" id="4052958">(</span><span class="ident" id="4052959">sx</span><span class="op" id="4052961">,</span>&nbsp;<span class="ident" id="4052963">sy</span><span class="op" id="4052965">)</span><span class="op" id="4052966">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4052971">default</span><span class="op" id="4052978">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052984">sr</span><span class="op" id="4052986">,</span>&nbsp;<span class="ident" id="4052988">sg</span><span class="op" id="4052990">,</span>&nbsp;<span class="ident" id="4052992">sb</span><span class="op" id="4052994">,</span>&nbsp;<span class="ident" id="4052996">sa</span>&nbsp;<span class="op" id="4052999">:=</span>&nbsp;<span class="ident" id="4053002">src</span><span class="op" id="4053005">.</span><span class="ident" id="4053006">At</span><span class="op" id="4053008">(</span><span class="ident" id="4053009">sx</span><span class="op" id="4053011">,</span>&nbsp;<span class="ident" id="4053013">sy</span><span class="op" id="4053015">)</span><span class="op" id="4053016">.</span><span class="ident" id="4053017">RGBA</span><span class="op" id="4053021">(</span><span class="op" id="4053022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053028">if</span>&nbsp;<span class="ident" id="4053031">op</span>&nbsp;<span class="op" id="4053034">==</span>&nbsp;<span class="ident" id="4053037">Over</span>&nbsp;<span class="op" id="4053042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053049">dr</span><span class="op" id="4053051">,</span>&nbsp;<span class="ident" id="4053053">dg</span><span class="op" id="4053055">,</span>&nbsp;<span class="ident" id="4053057">db</span><span class="op" id="4053059">,</span>&nbsp;<span class="ident" id="4053061">da</span>&nbsp;<span class="op" id="4053064">:=</span>&nbsp;<span class="ident" id="4053067">dst</span><span class="op" id="4053070">.</span><span class="ident" id="4053071">At</span><span class="op" id="4053073">(</span><span class="ident" id="4053074">x</span><span class="op" id="4053075">,</span>&nbsp;<span class="ident" id="4053077">y</span><span class="op" id="4053078">)</span><span class="op" id="4053079">.</span><span class="ident" id="4053080">RGBA</span><span class="op" id="4053084">(</span><span class="op" id="4053085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053092">a</span>&nbsp;<span class="op" id="4053094">:=</span>&nbsp;<span class="ident" id="4053097">m</span>&nbsp;<span class="op" id="4053099">-</span>&nbsp;<span class="op" id="4053101">(</span><span class="ident" id="4053102">sa</span>&nbsp;<span class="op" id="4053105">*</span>&nbsp;<span class="ident" id="4053107">ma</span>&nbsp;<span class="op" id="4053110">/</span>&nbsp;<span class="ident" id="4053112">m</span><span class="op" id="4053113">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053120">out</span><span class="op" id="4053123">.</span><span class="ident" id="4053124">R</span>&nbsp;<span class="op" id="4053126">=</span>&nbsp;<span class="builtintype" id="4053128">uint16</span><span class="op" id="4053134">(</span><span class="op" id="4053135">(</span><span class="ident" id="4053136">dr</span><span class="op" id="4053138">*</span><span class="ident" id="4053139">a</span>&nbsp;<span class="op" id="4053141">+</span>&nbsp;<span class="ident" id="4053143">sr</span><span class="op" id="4053145">*</span><span class="ident" id="4053146">ma</span><span class="op" id="4053148">)</span>&nbsp;<span class="op" id="4053150">/</span>&nbsp;<span class="ident" id="4053152">m</span><span class="op" id="4053153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053160">out</span><span class="op" id="4053163">.</span><span class="ident" id="4053164">G</span>&nbsp;<span class="op" id="4053166">=</span>&nbsp;<span class="builtintype" id="4053168">uint16</span><span class="op" id="4053174">(</span><span class="op" id="4053175">(</span><span class="ident" id="4053176">dg</span><span class="op" id="4053178">*</span><span class="ident" id="4053179">a</span>&nbsp;<span class="op" id="4053181">+</span>&nbsp;<span class="ident" id="4053183">sg</span><span class="op" id="4053185">*</span><span class="ident" id="4053186">ma</span><span class="op" id="4053188">)</span>&nbsp;<span class="op" id="4053190">/</span>&nbsp;<span class="ident" id="4053192">m</span><span class="op" id="4053193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053200">out</span><span class="op" id="4053203">.</span><span class="ident" id="4053204">B</span>&nbsp;<span class="op" id="4053206">=</span>&nbsp;<span class="builtintype" id="4053208">uint16</span><span class="op" id="4053214">(</span><span class="op" id="4053215">(</span><span class="ident" id="4053216">db</span><span class="op" id="4053218">*</span><span class="ident" id="4053219">a</span>&nbsp;<span class="op" id="4053221">+</span>&nbsp;<span class="ident" id="4053223">sb</span><span class="op" id="4053225">*</span><span class="ident" id="4053226">ma</span><span class="op" id="4053228">)</span>&nbsp;<span class="op" id="4053230">/</span>&nbsp;<span class="ident" id="4053232">m</span><span class="op" id="4053233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053240">out</span><span class="op" id="4053243">.</span><span class="ident" id="4053244">A</span>&nbsp;<span class="op" id="4053246">=</span>&nbsp;<span class="builtintype" id="4053248">uint16</span><span class="op" id="4053254">(</span><span class="op" id="4053255">(</span><span class="ident" id="4053256">da</span><span class="op" id="4053258">*</span><span class="ident" id="4053259">a</span>&nbsp;<span class="op" id="4053261">+</span>&nbsp;<span class="ident" id="4053263">sa</span><span class="op" id="4053265">*</span><span class="ident" id="4053266">ma</span><span class="op" id="4053268">)</span>&nbsp;<span class="op" id="4053270">/</span>&nbsp;<span class="ident" id="4053272">m</span><span class="op" id="4053273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053279">}</span>&nbsp;<span class="keyword" id="4053281">else</span>&nbsp;<span class="op" id="4053286">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053293">out</span><span class="op" id="4053296">.</span><span class="ident" id="4053297">R</span>&nbsp;<span class="op" id="4053299">=</span>&nbsp;<span class="builtintype" id="4053301">uint16</span><span class="op" id="4053307">(</span><span class="ident" id="4053308">sr</span>&nbsp;<span class="op" id="4053311">*</span>&nbsp;<span class="ident" id="4053313">ma</span>&nbsp;<span class="op" id="4053316">/</span>&nbsp;<span class="ident" id="4053318">m</span><span class="op" id="4053319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053326">out</span><span class="op" id="4053329">.</span><span class="ident" id="4053330">G</span>&nbsp;<span class="op" id="4053332">=</span>&nbsp;<span class="builtintype" id="4053334">uint16</span><span class="op" id="4053340">(</span><span class="ident" id="4053341">sg</span>&nbsp;<span class="op" id="4053344">*</span>&nbsp;<span class="ident" id="4053346">ma</span>&nbsp;<span class="op" id="4053349">/</span>&nbsp;<span class="ident" id="4053351">m</span><span class="op" id="4053352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053359">out</span><span class="op" id="4053362">.</span><span class="ident" id="4053363">B</span>&nbsp;<span class="op" id="4053365">=</span>&nbsp;<span class="builtintype" id="4053367">uint16</span><span class="op" id="4053373">(</span><span class="ident" id="4053374">sb</span>&nbsp;<span class="op" id="4053377">*</span>&nbsp;<span class="ident" id="4053379">ma</span>&nbsp;<span class="op" id="4053382">/</span>&nbsp;<span class="ident" id="4053384">m</span><span class="op" id="4053385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053392">out</span><span class="op" id="4053395">.</span><span class="ident" id="4053396">A</span>&nbsp;<span class="op" id="4053398">=</span>&nbsp;<span class="builtintype" id="4053400">uint16</span><span class="op" id="4053406">(</span><span class="ident" id="4053407">sa</span>&nbsp;<span class="op" id="4053410">*</span>&nbsp;<span class="ident" id="4053412">ma</span>&nbsp;<span class="op" id="4053415">/</span>&nbsp;<span class="ident" id="4053417">m</span><span class="op" id="4053418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053424">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4053430">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4053491">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4053556">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4053619">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053680">dst</span><span class="op" id="4053683">.</span><span class="ident" id="4053684">Set</span><span class="op" id="4053687">(</span><span class="ident" id="4053688">x</span><span class="op" id="4053689">,</span>&nbsp;<span class="ident" id="4053691">y</span><span class="op" id="4053692">,</span>&nbsp;<span class="op" id="4053694">&amp;</span><span class="ident" id="4053695">out</span><span class="op" id="4053698">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053710">}</span><br>
<span class="lineno"></span><span class="op" id="4053712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="4053715">func</span>&nbsp;<span class="ident" id="4053720">drawFillOver</span><span class="op" id="4053732">(</span><span class="ident" id="4053733">dst</span>&nbsp;<span class="op" id="4053737">*</span><span class="ident" id="4053738">image</span><span class="op" id="4053743">.</span><span class="ident" id="4053744">RGBA</span><span class="op" id="4053748">,</span>&nbsp;<span class="ident" id="4053750">r</span>&nbsp;<span class="ident" id="4053752">image</span><span class="op" id="4053757">.</span><span class="ident" id="4053758">Rectangle</span><span class="op" id="4053767">,</span>&nbsp;<span class="ident" id="4053769">src</span>&nbsp;<span class="op" id="4053773">*</span><span class="ident" id="4053774">image</span><span class="op" id="4053779">.</span><span class="ident" id="4053780">Uniform</span><span class="op" id="4053787">)</span>&nbsp;<span class="op" id="4053789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053792">sr</span><span class="op" id="4053794">,</span>&nbsp;<span class="ident" id="4053796">sg</span><span class="op" id="4053798">,</span>&nbsp;<span class="ident" id="4053800">sb</span><span class="op" id="4053802">,</span>&nbsp;<span class="ident" id="4053804">sa</span>&nbsp;<span class="op" id="4053807">:=</span>&nbsp;<span class="ident" id="4053810">src</span><span class="op" id="4053813">.</span><span class="ident" id="4053814">RGBA</span><span class="op" id="4053818">(</span><span class="op" id="4053819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4053822">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053880">a</span>&nbsp;<span class="op" id="4053882">:=</span>&nbsp;<span class="op" id="4053885">(</span><span class="ident" id="4053886">m</span>&nbsp;<span class="op" id="4053888">-</span>&nbsp;<span class="ident" id="4053890">sa</span><span class="op" id="4053892">)</span>&nbsp;<span class="op" id="4053894">*</span>&nbsp;<span class="num" id="4053896">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053903">i0</span>&nbsp;<span class="op" id="4053906">:=</span>&nbsp;<span class="ident" id="4053909">dst</span><span class="op" id="4053912">.</span><span class="ident" id="4053913">PixOffset</span><span class="op" id="4053922">(</span><span class="ident" id="4053923">r</span><span class="op" id="4053924">.</span><span class="ident" id="4053925">Min</span><span class="op" id="4053928">.</span><span class="ident" id="4053929">X</span><span class="op" id="4053930">,</span>&nbsp;<span class="ident" id="4053932">r</span><span class="op" id="4053933">.</span><span class="ident" id="4053934">Min</span><span class="op" id="4053937">.</span><span class="ident" id="4053938">Y</span><span class="op" id="4053939">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053942">i1</span>&nbsp;<span class="op" id="4053945">:=</span>&nbsp;<span class="ident" id="4053948">i0</span>&nbsp;<span class="op" id="4053951">+</span>&nbsp;<span class="ident" id="4053953">r</span><span class="op" id="4053954">.</span><span class="ident" id="4053955">Dx</span><span class="op" id="4053957">(</span><span class="op" id="4053958">)</span><span class="op" id="4053959">*</span><span class="num" id="4053960">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053963">for</span>&nbsp;<span class="ident" id="4053967">y</span>&nbsp;<span class="op" id="4053969">:=</span>&nbsp;<span class="ident" id="4053972">r</span><span class="op" id="4053973">.</span><span class="ident" id="4053974">Min</span><span class="op" id="4053977">.</span><span class="ident" id="4053978">Y</span><span class="op" id="4053979">;</span>&nbsp;<span class="ident" id="4053981">y</span>&nbsp;<span class="op" id="4053983">!=</span>&nbsp;<span class="ident" id="4053986">r</span><span class="op" id="4053987">.</span><span class="ident" id="4053988">Max</span><span class="op" id="4053991">.</span><span class="ident" id="4053992">Y</span><span class="op" id="4053993">;</span>&nbsp;<span class="ident" id="4053995">y</span><span class="op" id="4053996">++</span>&nbsp;<span class="op" id="4053999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054003">for</span>&nbsp;<span class="ident" id="4054007">i</span>&nbsp;<span class="op" id="4054009">:=</span>&nbsp;<span class="ident" id="4054012">i0</span><span class="op" id="4054014">;</span>&nbsp;<span class="ident" id="4054016">i</span>&nbsp;<span class="op" id="4054018">&lt;</span>&nbsp;<span class="ident" id="4054020">i1</span><span class="op" id="4054022">;</span>&nbsp;<span class="ident" id="4054024">i</span>&nbsp;<span class="op" id="4054026">+=</span>&nbsp;<span class="num" id="4054029">4</span>&nbsp;<span class="op" id="4054031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054036">dr</span>&nbsp;<span class="op" id="4054039">:=</span>&nbsp;<span class="builtintype" id="4054042">uint32</span><span class="op" id="4054048">(</span><span class="ident" id="4054049">dst</span><span class="op" id="4054052">.</span><span class="ident" id="4054053">Pix</span><span class="op" id="4054056">[</span><span class="ident" id="4054057">i</span><span class="op" id="4054058">+</span><span class="num" id="4054059">0</span><span class="op" id="4054060">]</span><span class="op" id="4054061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054066">dg</span>&nbsp;<span class="op" id="4054069">:=</span>&nbsp;<span class="builtintype" id="4054072">uint32</span><span class="op" id="4054078">(</span><span class="ident" id="4054079">dst</span><span class="op" id="4054082">.</span><span class="ident" id="4054083">Pix</span><span class="op" id="4054086">[</span><span class="ident" id="4054087">i</span><span class="op" id="4054088">+</span><span class="num" id="4054089">1</span><span class="op" id="4054090">]</span><span class="op" id="4054091">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054096">db</span>&nbsp;<span class="op" id="4054099">:=</span>&nbsp;<span class="builtintype" id="4054102">uint32</span><span class="op" id="4054108">(</span><span class="ident" id="4054109">dst</span><span class="op" id="4054112">.</span><span class="ident" id="4054113">Pix</span><span class="op" id="4054116">[</span><span class="ident" id="4054117">i</span><span class="op" id="4054118">+</span><span class="num" id="4054119">2</span><span class="op" id="4054120">]</span><span class="op" id="4054121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054126">da</span>&nbsp;<span class="op" id="4054129">:=</span>&nbsp;<span class="builtintype" id="4054132">uint32</span><span class="op" id="4054138">(</span><span class="ident" id="4054139">dst</span><span class="op" id="4054142">.</span><span class="ident" id="4054143">Pix</span><span class="op" id="4054146">[</span><span class="ident" id="4054147">i</span><span class="op" id="4054148">+</span><span class="num" id="4054149">3</span><span class="op" id="4054150">]</span><span class="op" id="4054151">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054157">dst</span><span class="op" id="4054160">.</span><span class="ident" id="4054161">Pix</span><span class="op" id="4054164">[</span><span class="ident" id="4054165">i</span><span class="op" id="4054166">+</span><span class="num" id="4054167">0</span><span class="op" id="4054168">]</span>&nbsp;<span class="op" id="4054170">=</span>&nbsp;<span class="builtintype" id="4054172">uint8</span><span class="op" id="4054177">(</span><span class="op" id="4054178">(</span><span class="ident" id="4054179">dr</span><span class="op" id="4054181">*</span><span class="ident" id="4054182">a</span><span class="op" id="4054183">/</span><span class="ident" id="4054184">m</span>&nbsp;<span class="op" id="4054186">+</span>&nbsp;<span class="ident" id="4054188">sr</span><span class="op" id="4054190">)</span>&nbsp;<span class="op" id="4054192">&gt;&gt;</span>&nbsp;<span class="num" id="4054195">8</span><span class="op" id="4054196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054201">dst</span><span class="op" id="4054204">.</span><span class="ident" id="4054205">Pix</span><span class="op" id="4054208">[</span><span class="ident" id="4054209">i</span><span class="op" id="4054210">+</span><span class="num" id="4054211">1</span><span class="op" id="4054212">]</span>&nbsp;<span class="op" id="4054214">=</span>&nbsp;<span class="builtintype" id="4054216">uint8</span><span class="op" id="4054221">(</span><span class="op" id="4054222">(</span><span class="ident" id="4054223">dg</span><span class="op" id="4054225">*</span><span class="ident" id="4054226">a</span><span class="op" id="4054227">/</span><span class="ident" id="4054228">m</span>&nbsp;<span class="op" id="4054230">+</span>&nbsp;<span class="ident" id="4054232">sg</span><span class="op" id="4054234">)</span>&nbsp;<span class="op" id="4054236">&gt;&gt;</span>&nbsp;<span class="num" id="4054239">8</span><span class="op" id="4054240">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054245">dst</span><span class="op" id="4054248">.</span><span class="ident" id="4054249">Pix</span><span class="op" id="4054252">[</span><span class="ident" id="4054253">i</span><span class="op" id="4054254">+</span><span class="num" id="4054255">2</span><span class="op" id="4054256">]</span>&nbsp;<span class="op" id="4054258">=</span>&nbsp;<span class="builtintype" id="4054260">uint8</span><span class="op" id="4054265">(</span><span class="op" id="4054266">(</span><span class="ident" id="4054267">db</span><span class="op" id="4054269">*</span><span class="ident" id="4054270">a</span><span class="op" id="4054271">/</span><span class="ident" id="4054272">m</span>&nbsp;<span class="op" id="4054274">+</span>&nbsp;<span class="ident" id="4054276">sb</span><span class="op" id="4054278">)</span>&nbsp;<span class="op" id="4054280">&gt;&gt;</span>&nbsp;<span class="num" id="4054283">8</span><span class="op" id="4054284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054289">dst</span><span class="op" id="4054292">.</span><span class="ident" id="4054293">Pix</span><span class="op" id="4054296">[</span><span class="ident" id="4054297">i</span><span class="op" id="4054298">+</span><span class="num" id="4054299">3</span><span class="op" id="4054300">]</span>&nbsp;<span class="op" id="4054302">=</span>&nbsp;<span class="builtintype" id="4054304">uint8</span><span class="op" id="4054309">(</span><span class="op" id="4054310">(</span><span class="ident" id="4054311">da</span><span class="op" id="4054313">*</span><span class="ident" id="4054314">a</span><span class="op" id="4054315">/</span><span class="ident" id="4054316">m</span>&nbsp;<span class="op" id="4054318">+</span>&nbsp;<span class="ident" id="4054320">sa</span><span class="op" id="4054322">)</span>&nbsp;<span class="op" id="4054324">&gt;&gt;</span>&nbsp;<span class="num" id="4054327">8</span><span class="op" id="4054328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054336">i0</span>&nbsp;<span class="op" id="4054339">+=</span>&nbsp;<span class="ident" id="4054342">dst</span><span class="op" id="4054345">.</span><span class="ident" id="4054346">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054355">i1</span>&nbsp;<span class="op" id="4054358">+=</span>&nbsp;<span class="ident" id="4054361">dst</span><span class="op" id="4054364">.</span><span class="ident" id="4054365">Stride</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054373">}</span><br>
<span class="lineno"></span><span class="op" id="4054375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4054378">func</span>&nbsp;<span class="ident" id="4054383">drawFillSrc</span><span class="op" id="4054394">(</span><span class="ident" id="4054395">dst</span>&nbsp;<span class="op" id="4054399">*</span><span class="ident" id="4054400">image</span><span class="op" id="4054405">.</span><span class="ident" id="4054406">RGBA</span><span class="op" id="4054410">,</span>&nbsp;<span class="ident" id="4054412">r</span>&nbsp;<span class="ident" id="4054414">image</span><span class="op" id="4054419">.</span><span class="ident" id="4054420">Rectangle</span><span class="op" id="4054429">,</span>&nbsp;<span class="ident" id="4054431">src</span>&nbsp;<span class="op" id="4054435">*</span><span class="ident" id="4054436">image</span><span class="op" id="4054441">.</span><span class="ident" id="4054442">Uniform</span><span class="op" id="4054449">)</span>&nbsp;<span class="op" id="4054451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054454">sr</span><span class="op" id="4054456">,</span>&nbsp;<span class="ident" id="4054458">sg</span><span class="op" id="4054460">,</span>&nbsp;<span class="ident" id="4054462">sb</span><span class="op" id="4054464">,</span>&nbsp;<span class="ident" id="4054466">sa</span>&nbsp;<span class="op" id="4054469">:=</span>&nbsp;<span class="ident" id="4054472">src</span><span class="op" id="4054475">.</span><span class="ident" id="4054476">RGBA</span><span class="op" id="4054480">(</span><span class="op" id="4054481">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4054484">//&nbsp;The&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;is&nbsp;faster&nbsp;than&nbsp;a&nbsp;straightforward&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;destination&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4054586">//&nbsp;the&nbsp;color,&nbsp;but&nbsp;copy&nbsp;requires&nbsp;a&nbsp;slice&nbsp;source.&nbsp;We&nbsp;therefore&nbsp;use&nbsp;a&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;first&nbsp;row,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4054690">//&nbsp;then&nbsp;use&nbsp;the&nbsp;first&nbsp;row&nbsp;as&nbsp;the&nbsp;slice&nbsp;source&nbsp;for&nbsp;the&nbsp;remaining&nbsp;rows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054761">i0</span>&nbsp;<span class="op" id="4054764">:=</span>&nbsp;<span class="ident" id="4054767">dst</span><span class="op" id="4054770">.</span><span class="ident" id="4054771">PixOffset</span><span class="op" id="4054780">(</span><span class="ident" id="4054781">r</span><span class="op" id="4054782">.</span><span class="ident" id="4054783">Min</span><span class="op" id="4054786">.</span><span class="ident" id="4054787">X</span><span class="op" id="4054788">,</span>&nbsp;<span class="ident" id="4054790">r</span><span class="op" id="4054791">.</span><span class="ident" id="4054792">Min</span><span class="op" id="4054795">.</span><span class="ident" id="4054796">Y</span><span class="op" id="4054797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054800">i1</span>&nbsp;<span class="op" id="4054803">:=</span>&nbsp;<span class="ident" id="4054806">i0</span>&nbsp;<span class="op" id="4054809">+</span>&nbsp;<span class="ident" id="4054811">r</span><span class="op" id="4054812">.</span><span class="ident" id="4054813">Dx</span><span class="op" id="4054815">(</span><span class="op" id="4054816">)</span><span class="op" id="4054817">*</span><span class="num" id="4054818">4</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054821">for</span>&nbsp;<span class="ident" id="4054825">i</span>&nbsp;<span class="op" id="4054827">:=</span>&nbsp;<span class="ident" id="4054830">i0</span><span class="op" id="4054832">;</span>&nbsp;<span class="ident" id="4054834">i</span>&nbsp;<span class="op" id="4054836">&lt;</span>&nbsp;<span class="ident" id="4054838">i1</span><span class="op" id="4054840">;</span>&nbsp;<span class="ident" id="4054842">i</span>&nbsp;<span class="op" id="4054844">+=</span>&nbsp;<span class="num" id="4054847">4</span>&nbsp;<span class="op" id="4054849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054853">dst</span><span class="op" id="4054856">.</span><span class="ident" id="4054857">Pix</span><span class="op" id="4054860">[</span><span class="ident" id="4054861">i</span><span class="op" id="4054862">+</span><span class="num" id="4054863">0</span><span class="op" id="4054864">]</span>&nbsp;<span class="op" id="4054866">=</span>&nbsp;<span class="builtintype" id="4054868">uint8</span><span class="op" id="4054873">(</span><span class="ident" id="4054874">sr</span>&nbsp;<span class="op" id="4054877">&gt;&gt;</span>&nbsp;<span class="num" id="4054880">8</span><span class="op" id="4054881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054885">dst</span><span class="op" id="4054888">.</span><span class="ident" id="4054889">Pix</span><span class="op" id="4054892">[</span><span class="ident" id="4054893">i</span><span class="op" id="4054894">+</span><span class="num" id="4054895">1</span><span class="op" id="4054896">]</span>&nbsp;<span class="op" id="4054898">=</span>&nbsp;<span class="builtintype" id="4054900">uint8</span><span class="op" id="4054905">(</span><span class="ident" id="4054906">sg</span>&nbsp;<span class="op" id="4054909">&gt;&gt;</span>&nbsp;<span class="num" id="4054912">8</span><span class="op" id="4054913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054917">dst</span><span class="op" id="4054920">.</span><span class="ident" id="4054921">Pix</span><span class="op" id="4054924">[</span><span class="ident" id="4054925">i</span><span class="op" id="4054926">+</span><span class="num" id="4054927">2</span><span class="op" id="4054928">]</span>&nbsp;<span class="op" id="4054930">=</span>&nbsp;<span class="builtintype" id="4054932">uint8</span><span class="op" id="4054937">(</span><span class="ident" id="4054938">sb</span>&nbsp;<span class="op" id="4054941">&gt;&gt;</span>&nbsp;<span class="num" id="4054944">8</span><span class="op" id="4054945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054949">dst</span><span class="op" id="4054952">.</span><span class="ident" id="4054953">Pix</span><span class="op" id="4054956">[</span><span class="ident" id="4054957">i</span><span class="op" id="4054958">+</span><span class="num" id="4054959">3</span><span class="op" id="4054960">]</span>&nbsp;<span class="op" id="4054962">=</span>&nbsp;<span class="builtintype" id="4054964">uint8</span><span class="op" id="4054969">(</span><span class="ident" id="4054970">sa</span>&nbsp;<span class="op" id="4054973">&gt;&gt;</span>&nbsp;<span class="num" id="4054976">8</span><span class="op" id="4054977">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054983">firstRow</span>&nbsp;<span class="op" id="4054992">:=</span>&nbsp;<span class="ident" id="4054995">dst</span><span class="op" id="4054998">.</span><span class="ident" id="4054999">Pix</span><span class="op" id="4055002">[</span><span class="ident" id="4055003">i0</span><span class="op" id="4055005">:</span><span class="ident" id="4055006">i1</span><span class="op" id="4055008">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055011">for</span>&nbsp;<span class="ident" id="4055015">y</span>&nbsp;<span class="op" id="4055017">:=</span>&nbsp;<span class="ident" id="4055020">r</span><span class="op" id="4055021">.</span><span class="ident" id="4055022">Min</span><span class="op" id="4055025">.</span><span class="ident" id="4055026">Y</span>&nbsp;<span class="op" id="4055028">+</span>&nbsp;<span class="num" id="4055030">1</span><span class="op" id="4055031">;</span>&nbsp;<span class="ident" id="4055033">y</span>&nbsp;<span class="op" id="4055035">&lt;</span>&nbsp;<span class="ident" id="4055037">r</span><span class="op" id="4055038">.</span><span class="ident" id="4055039">Max</span><span class="op" id="4055042">.</span><span class="ident" id="4055043">Y</span><span class="op" id="4055044">;</span>&nbsp;<span class="ident" id="4055046">y</span><span class="op" id="4055047">++</span>&nbsp;<span class="op" id="4055050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055054">i0</span>&nbsp;<span class="op" id="4055057">+=</span>&nbsp;<span class="ident" id="4055060">dst</span><span class="op" id="4055063">.</span><span class="ident" id="4055064">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055073">i1</span>&nbsp;<span class="op" id="4055076">+=</span>&nbsp;<span class="ident" id="4055079">dst</span><span class="op" id="4055082">.</span><span class="ident" id="4055083">Stride</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4055092">copy</span><span class="op" id="4055096">(</span><span class="ident" id="4055097">dst</span><span class="op" id="4055100">.</span><span class="ident" id="4055101">Pix</span><span class="op" id="4055104">[</span><span class="ident" id="4055105">i0</span><span class="op" id="4055107">:</span><span class="ident" id="4055108">i1</span><span class="op" id="4055110">]</span><span class="op" id="4055111">,</span>&nbsp;<span class="ident" id="4055113">firstRow</span><span class="op" id="4055121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055124">}</span><br>
<span class="lineno"></span><span class="op" id="4055126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4055129">func</span>&nbsp;<span class="ident" id="4055134">drawCopyOver</span><span class="op" id="4055146">(</span><span class="ident" id="4055147">dst</span>&nbsp;<span class="op" id="4055151">*</span><span class="ident" id="4055152">image</span><span class="op" id="4055157">.</span><span class="ident" id="4055158">RGBA</span><span class="op" id="4055162">,</span>&nbsp;<span class="ident" id="4055164">r</span>&nbsp;<span class="ident" id="4055166">image</span><span class="op" id="4055171">.</span><span class="ident" id="4055172">Rectangle</span><span class="op" id="4055181">,</span>&nbsp;<span class="ident" id="4055183">src</span>&nbsp;<span class="op" id="4055187">*</span><span class="ident" id="4055188">image</span><span class="op" id="4055193">.</span><span class="ident" id="4055194">RGBA</span><span class="op" id="4055198">,</span>&nbsp;<span class="ident" id="4055200">sp</span>&nbsp;<span class="ident" id="4055203">image</span><span class="op" id="4055208">.</span><span class="ident" id="4055209">Point</span><span class="op" id="4055214">)</span>&nbsp;<span class="op" id="4055216">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055219">dx</span><span class="op" id="4055221">,</span>&nbsp;<span class="ident" id="4055223">dy</span>&nbsp;<span class="op" id="4055226">:=</span>&nbsp;<span class="ident" id="4055229">r</span><span class="op" id="4055230">.</span><span class="ident" id="4055231">Dx</span><span class="op" id="4055233">(</span><span class="op" id="4055234">)</span><span class="op" id="4055235">,</span>&nbsp;<span class="ident" id="4055237">r</span><span class="op" id="4055238">.</span><span class="ident" id="4055239">Dy</span><span class="op" id="4055241">(</span><span class="op" id="4055242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055245">d0</span>&nbsp;<span class="op" id="4055248">:=</span>&nbsp;<span class="ident" id="4055251">dst</span><span class="op" id="4055254">.</span><span class="ident" id="4055255">PixOffset</span><span class="op" id="4055264">(</span><span class="ident" id="4055265">r</span><span class="op" id="4055266">.</span><span class="ident" id="4055267">Min</span><span class="op" id="4055270">.</span><span class="ident" id="4055271">X</span><span class="op" id="4055272">,</span>&nbsp;<span class="ident" id="4055274">r</span><span class="op" id="4055275">.</span><span class="ident" id="4055276">Min</span><span class="op" id="4055279">.</span><span class="ident" id="4055280">Y</span><span class="op" id="4055281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055284">s0</span>&nbsp;<span class="op" id="4055287">:=</span>&nbsp;<span class="ident" id="4055290">src</span><span class="op" id="4055293">.</span><span class="ident" id="4055294">PixOffset</span><span class="op" id="4055303">(</span><span class="ident" id="4055304">sp</span><span class="op" id="4055306">.</span><span class="ident" id="4055307">X</span><span class="op" id="4055308">,</span>&nbsp;<span class="ident" id="4055310">sp</span><span class="op" id="4055312">.</span><span class="ident" id="4055313">Y</span><span class="op" id="4055314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055317">var</span>&nbsp;<span class="op" id="4055321">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055325">ddelta</span><span class="op" id="4055331">,</span>&nbsp;<span class="ident" id="4055333">sdelta</span>&nbsp;<span class="builtintype" id="4055340">int</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055346">i0</span><span class="op" id="4055348">,</span>&nbsp;<span class="ident" id="4055350">i1</span><span class="op" id="4055352">,</span>&nbsp;<span class="ident" id="4055354">idelta</span>&nbsp;<span class="builtintype" id="4055361">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055369">if</span>&nbsp;<span class="ident" id="4055372">r</span><span class="op" id="4055373">.</span><span class="ident" id="4055374">Min</span><span class="op" id="4055377">.</span><span class="ident" id="4055378">Y</span>&nbsp;<span class="op" id="4055380">&lt;</span>&nbsp;<span class="ident" id="4055382">sp</span><span class="op" id="4055384">.</span><span class="ident" id="4055385">Y</span>&nbsp;<span class="op" id="4055387">||</span>&nbsp;<span class="ident" id="4055390">r</span><span class="op" id="4055391">.</span><span class="ident" id="4055392">Min</span><span class="op" id="4055395">.</span><span class="ident" id="4055396">Y</span>&nbsp;<span class="op" id="4055398">==</span>&nbsp;<span class="ident" id="4055401">sp</span><span class="op" id="4055403">.</span><span class="ident" id="4055404">Y</span>&nbsp;<span class="op" id="4055406">&amp;&amp;</span>&nbsp;<span class="ident" id="4055409">r</span><span class="op" id="4055410">.</span><span class="ident" id="4055411">Min</span><span class="op" id="4055414">.</span><span class="ident" id="4055415">X</span>&nbsp;<span class="op" id="4055417">&lt;=</span>&nbsp;<span class="ident" id="4055420">sp</span><span class="op" id="4055422">.</span><span class="ident" id="4055423">X</span>&nbsp;<span class="op" id="4055425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055429">ddelta</span>&nbsp;<span class="op" id="4055436">=</span>&nbsp;<span class="ident" id="4055438">dst</span><span class="op" id="4055441">.</span><span class="ident" id="4055442">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055451">sdelta</span>&nbsp;<span class="op" id="4055458">=</span>&nbsp;<span class="ident" id="4055460">src</span><span class="op" id="4055463">.</span><span class="ident" id="4055464">Stride</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055473">i0</span><span class="op" id="4055475">,</span>&nbsp;<span class="ident" id="4055477">i1</span><span class="op" id="4055479">,</span>&nbsp;<span class="ident" id="4055481">idelta</span>&nbsp;<span class="op" id="4055488">=</span>&nbsp;<span class="num" id="4055490">0</span><span class="op" id="4055491">,</span>&nbsp;<span class="ident" id="4055493">dx</span><span class="op" id="4055495">*</span><span class="num" id="4055496">4</span><span class="op" id="4055497">,</span>&nbsp;<span class="op" id="4055499">+</span><span class="num" id="4055500">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055503">}</span>&nbsp;<span class="keyword" id="4055505">else</span>&nbsp;<span class="op" id="4055510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4055514">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;or&nbsp;equal&nbsp;height&nbsp;but&nbsp;to&nbsp;the&nbsp;left,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4055622">//&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows&nbsp;in&nbsp;right-to-left,&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;left-to-right,&nbsp;top-down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055722">d0</span>&nbsp;<span class="op" id="4055725">+=</span>&nbsp;<span class="op" id="4055728">(</span><span class="ident" id="4055729">dy</span>&nbsp;<span class="op" id="4055732">-</span>&nbsp;<span class="num" id="4055734">1</span><span class="op" id="4055735">)</span>&nbsp;<span class="op" id="4055737">*</span>&nbsp;<span class="ident" id="4055739">dst</span><span class="op" id="4055742">.</span><span class="ident" id="4055743">Stride</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055752">s0</span>&nbsp;<span class="op" id="4055755">+=</span>&nbsp;<span class="op" id="4055758">(</span><span class="ident" id="4055759">dy</span>&nbsp;<span class="op" id="4055762">-</span>&nbsp;<span class="num" id="4055764">1</span><span class="op" id="4055765">)</span>&nbsp;<span class="op" id="4055767">*</span>&nbsp;<span class="ident" id="4055769">src</span><span class="op" id="4055772">.</span><span class="ident" id="4055773">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055782">ddelta</span>&nbsp;<span class="op" id="4055789">=</span>&nbsp;<span class="op" id="4055791">-</span><span class="ident" id="4055792">dst</span><span class="op" id="4055795">.</span><span class="ident" id="4055796">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055805">sdelta</span>&nbsp;<span class="op" id="4055812">=</span>&nbsp;<span class="op" id="4055814">-</span><span class="ident" id="4055815">src</span><span class="op" id="4055818">.</span><span class="ident" id="4055819">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055828">i0</span><span class="op" id="4055830">,</span>&nbsp;<span class="ident" id="4055832">i1</span><span class="op" id="4055834">,</span>&nbsp;<span class="ident" id="4055836">idelta</span>&nbsp;<span class="op" id="4055843">=</span>&nbsp;<span class="op" id="4055845">(</span><span class="ident" id="4055846">dx</span><span class="op" id="4055848">-</span><span class="num" id="4055849">1</span><span class="op" id="4055850">)</span><span class="op" id="4055851">*</span><span class="num" id="4055852">4</span><span class="op" id="4055853">,</span>&nbsp;<span class="op" id="4055855">-</span><span class="num" id="4055856">4</span><span class="op" id="4055857">,</span>&nbsp;<span class="op" id="4055859">-</span><span class="num" id="4055860">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055863">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055866">for</span>&nbsp;<span class="op" id="4055870">;</span>&nbsp;<span class="ident" id="4055872">dy</span>&nbsp;<span class="op" id="4055875">&gt;</span>&nbsp;<span class="num" id="4055877">0</span><span class="op" id="4055878">;</span>&nbsp;<span class="ident" id="4055880">dy</span><span class="op" id="4055882">--</span>&nbsp;<span class="op" id="4055885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055889">dpix</span>&nbsp;<span class="op" id="4055894">:=</span>&nbsp;<span class="ident" id="4055897">dst</span><span class="op" id="4055900">.</span><span class="ident" id="4055901">Pix</span><span class="op" id="4055904">[</span><span class="ident" id="4055905">d0</span><span class="op" id="4055907">:</span><span class="op" id="4055908">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055912">spix</span>&nbsp;<span class="op" id="4055917">:=</span>&nbsp;<span class="ident" id="4055920">src</span><span class="op" id="4055923">.</span><span class="ident" id="4055924">Pix</span><span class="op" id="4055927">[</span><span class="ident" id="4055928">s0</span><span class="op" id="4055930">:</span><span class="op" id="4055931">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055935">for</span>&nbsp;<span class="ident" id="4055939">i</span>&nbsp;<span class="op" id="4055941">:=</span>&nbsp;<span class="ident" id="4055944">i0</span><span class="op" id="4055946">;</span>&nbsp;<span class="ident" id="4055948">i</span>&nbsp;<span class="op" id="4055950">!=</span>&nbsp;<span class="ident" id="4055953">i1</span><span class="op" id="4055955">;</span>&nbsp;<span class="ident" id="4055957">i</span>&nbsp;<span class="op" id="4055959">+=</span>&nbsp;<span class="ident" id="4055962">idelta</span>&nbsp;<span class="op" id="4055969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055974">sr</span>&nbsp;<span class="op" id="4055977">:=</span>&nbsp;<span class="builtintype" id="4055980">uint32</span><span class="op" id="4055986">(</span><span class="ident" id="4055987">spix</span><span class="op" id="4055991">[</span><span class="ident" id="4055992">i</span><span class="op" id="4055993">+</span><span class="num" id="4055994">0</span><span class="op" id="4055995">]</span><span class="op" id="4055996">)</span>&nbsp;<span class="op" id="4055998">*</span>&nbsp;<span class="num" id="4056000">0x101</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056009">sg</span>&nbsp;<span class="op" id="4056012">:=</span>&nbsp;<span class="builtintype" id="4056015">uint32</span><span class="op" id="4056021">(</span><span class="ident" id="4056022">spix</span><span class="op" id="4056026">[</span><span class="ident" id="4056027">i</span><span class="op" id="4056028">+</span><span class="num" id="4056029">1</span><span class="op" id="4056030">]</span><span class="op" id="4056031">)</span>&nbsp;<span class="op" id="4056033">*</span>&nbsp;<span class="num" id="4056035">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056044">sb</span>&nbsp;<span class="op" id="4056047">:=</span>&nbsp;<span class="builtintype" id="4056050">uint32</span><span class="op" id="4056056">(</span><span class="ident" id="4056057">spix</span><span class="op" id="4056061">[</span><span class="ident" id="4056062">i</span><span class="op" id="4056063">+</span><span class="num" id="4056064">2</span><span class="op" id="4056065">]</span><span class="op" id="4056066">)</span>&nbsp;<span class="op" id="4056068">*</span>&nbsp;<span class="num" id="4056070">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056079">sa</span>&nbsp;<span class="op" id="4056082">:=</span>&nbsp;<span class="builtintype" id="4056085">uint32</span><span class="op" id="4056091">(</span><span class="ident" id="4056092">spix</span><span class="op" id="4056096">[</span><span class="ident" id="4056097">i</span><span class="op" id="4056098">+</span><span class="num" id="4056099">3</span><span class="op" id="4056100">]</span><span class="op" id="4056101">)</span>&nbsp;<span class="op" id="4056103">*</span>&nbsp;<span class="num" id="4056105">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056115">dr</span>&nbsp;<span class="op" id="4056118">:=</span>&nbsp;<span class="builtintype" id="4056121">uint32</span><span class="op" id="4056127">(</span><span class="ident" id="4056128">dpix</span><span class="op" id="4056132">[</span><span class="ident" id="4056133">i</span><span class="op" id="4056134">+</span><span class="num" id="4056135">0</span><span class="op" id="4056136">]</span><span class="op" id="4056137">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056142">dg</span>&nbsp;<span class="op" id="4056145">:=</span>&nbsp;<span class="builtintype" id="4056148">uint32</span><span class="op" id="4056154">(</span><span class="ident" id="4056155">dpix</span><span class="op" id="4056159">[</span><span class="ident" id="4056160">i</span><span class="op" id="4056161">+</span><span class="num" id="4056162">1</span><span class="op" id="4056163">]</span><span class="op" id="4056164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056169">db</span>&nbsp;<span class="op" id="4056172">:=</span>&nbsp;<span class="builtintype" id="4056175">uint32</span><span class="op" id="4056181">(</span><span class="ident" id="4056182">dpix</span><span class="op" id="4056186">[</span><span class="ident" id="4056187">i</span><span class="op" id="4056188">+</span><span class="num" id="4056189">2</span><span class="op" id="4056190">]</span><span class="op" id="4056191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056196">da</span>&nbsp;<span class="op" id="4056199">:=</span>&nbsp;<span class="builtintype" id="4056202">uint32</span><span class="op" id="4056208">(</span><span class="ident" id="4056209">dpix</span><span class="op" id="4056213">[</span><span class="ident" id="4056214">i</span><span class="op" id="4056215">+</span><span class="num" id="4056216">3</span><span class="op" id="4056217">]</span><span class="op" id="4056218">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4056224">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056284">a</span>&nbsp;<span class="op" id="4056286">:=</span>&nbsp;<span class="op" id="4056289">(</span><span class="ident" id="4056290">m</span>&nbsp;<span class="op" id="4056292">-</span>&nbsp;<span class="ident" id="4056294">sa</span><span class="op" id="4056296">)</span>&nbsp;<span class="op" id="4056298">*</span>&nbsp;<span class="num" id="4056300">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056310">dpix</span><span class="op" id="4056314">[</span><span class="ident" id="4056315">i</span><span class="op" id="4056316">+</span><span class="num" id="4056317">0</span><span class="op" id="4056318">]</span>&nbsp;<span class="op" id="4056320">=</span>&nbsp;<span class="builtintype" id="4056322">uint8</span><span class="op" id="4056327">(</span><span class="op" id="4056328">(</span><span class="ident" id="4056329">dr</span><span class="op" id="4056331">*</span><span class="ident" id="4056332">a</span><span class="op" id="4056333">/</span><span class="ident" id="4056334">m</span>&nbsp;<span class="op" id="4056336">+</span>&nbsp;<span class="ident" id="4056338">sr</span><span class="op" id="4056340">)</span>&nbsp;<span class="op" id="4056342">&gt;&gt;</span>&nbsp;<span class="num" id="4056345">8</span><span class="op" id="4056346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056351">dpix</span><span class="op" id="4056355">[</span><span class="ident" id="4056356">i</span><span class="op" id="4056357">+</span><span class="num" id="4056358">1</span><span class="op" id="4056359">]</span>&nbsp;<span class="op" id="4056361">=</span>&nbsp;<span class="builtintype" id="4056363">uint8</span><span class="op" id="4056368">(</span><span class="op" id="4056369">(</span><span class="ident" id="4056370">dg</span><span class="op" id="4056372">*</span><span class="ident" id="4056373">a</span><span class="op" id="4056374">/</span><span class="ident" id="4056375">m</span>&nbsp;<span class="op" id="4056377">+</span>&nbsp;<span class="ident" id="4056379">sg</span><span class="op" id="4056381">)</span>&nbsp;<span class="op" id="4056383">&gt;&gt;</span>&nbsp;<span class="num" id="4056386">8</span><span class="op" id="4056387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056392">dpix</span><span class="op" id="4056396">[</span><span class="ident" id="4056397">i</span><span class="op" id="4056398">+</span><span class="num" id="4056399">2</span><span class="op" id="4056400">]</span>&nbsp;<span class="op" id="4056402">=</span>&nbsp;<span class="builtintype" id="4056404">uint8</span><span class="op" id="4056409">(</span><span class="op" id="4056410">(</span><span class="ident" id="4056411">db</span><span class="op" id="4056413">*</span><span class="ident" id="4056414">a</span><span class="op" id="4056415">/</span><span class="ident" id="4056416">m</span>&nbsp;<span class="op" id="4056418">+</span>&nbsp;<span class="ident" id="4056420">sb</span><span class="op" id="4056422">)</span>&nbsp;<span class="op" id="4056424">&gt;&gt;</span>&nbsp;<span class="num" id="4056427">8</span><span class="op" id="4056428">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056433">dpix</span><span class="op" id="4056437">[</span><span class="ident" id="4056438">i</span><span class="op" id="4056439">+</span><span class="num" id="4056440">3</span><span class="op" id="4056441">]</span>&nbsp;<span class="op" id="4056443">=</span>&nbsp;<span class="builtintype" id="4056445">uint8</span><span class="op" id="4056450">(</span><span class="op" id="4056451">(</span><span class="ident" id="4056452">da</span><span class="op" id="4056454">*</span><span class="ident" id="4056455">a</span><span class="op" id="4056456">/</span><span class="ident" id="4056457">m</span>&nbsp;<span class="op" id="4056459">+</span>&nbsp;<span class="ident" id="4056461">sa</span><span class="op" id="4056463">)</span>&nbsp;<span class="op" id="4056465">&gt;&gt;</span>&nbsp;<span class="num" id="4056468">8</span><span class="op" id="4056469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056477">d0</span>&nbsp;<span class="op" id="4056480">+=</span>&nbsp;<span class="ident" id="4056483">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056492">s0</span>&nbsp;<span class="op" id="4056495">+=</span>&nbsp;<span class="ident" id="4056498">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056506">}</span><br>
<span class="lineno">305</span><span class="op" id="4056508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4056511">func</span>&nbsp;<span class="ident" id="4056516">drawCopySrc</span><span class="op" id="4056527">(</span><span class="ident" id="4056528">dst</span>&nbsp;<span class="op" id="4056532">*</span><span class="ident" id="4056533">image</span><span class="op" id="4056538">.</span><span class="ident" id="4056539">RGBA</span><span class="op" id="4056543">,</span>&nbsp;<span class="ident" id="4056545">r</span>&nbsp;<span class="ident" id="4056547">image</span><span class="op" id="4056552">.</span><span class="ident" id="4056553">Rectangle</span><span class="op" id="4056562">,</span>&nbsp;<span class="ident" id="4056564">src</span>&nbsp;<span class="op" id="4056568">*</span><span class="ident" id="4056569">image</span><span class="op" id="4056574">.</span><span class="ident" id="4056575">RGBA</span><span class="op" id="4056579">,</span>&nbsp;<span class="ident" id="4056581">sp</span>&nbsp;<span class="ident" id="4056584">image</span><span class="op" id="4056589">.</span><span class="ident" id="4056590">Point</span><span class="op" id="4056595">)</span>&nbsp;<span class="op" id="4056597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056600">n</span><span class="op" id="4056601">,</span>&nbsp;<span class="ident" id="4056603">dy</span>&nbsp;<span class="op" id="4056606">:=</span>&nbsp;<span class="num" id="4056609">4</span><span class="op" id="4056610">*</span><span class="ident" id="4056611">r</span><span class="op" id="4056612">.</span><span class="ident" id="4056613">Dx</span><span class="op" id="4056615">(</span><span class="op" id="4056616">)</span><span class="op" id="4056617">,</span>&nbsp;<span class="ident" id="4056619">r</span><span class="op" id="4056620">.</span><span class="ident" id="4056621">Dy</span><span class="op" id="4056623">(</span><span class="op" id="4056624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056627">d0</span>&nbsp;<span class="op" id="4056630">:=</span>&nbsp;<span class="ident" id="4056633">dst</span><span class="op" id="4056636">.</span><span class="ident" id="4056637">PixOffset</span><span class="op" id="4056646">(</span><span class="ident" id="4056647">r</span><span class="op" id="4056648">.</span><span class="ident" id="4056649">Min</span><span class="op" id="4056652">.</span><span class="ident" id="4056653">X</span><span class="op" id="4056654">,</span>&nbsp;<span class="ident" id="4056656">r</span><span class="op" id="4056657">.</span><span class="ident" id="4056658">Min</span><span class="op" id="4056661">.</span><span class="ident" id="4056662">Y</span><span class="op" id="4056663">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056666">s0</span>&nbsp;<span class="op" id="4056669">:=</span>&nbsp;<span class="ident" id="4056672">src</span><span class="op" id="4056675">.</span><span class="ident" id="4056676">PixOffset</span><span class="op" id="4056685">(</span><span class="ident" id="4056686">sp</span><span class="op" id="4056688">.</span><span class="ident" id="4056689">X</span><span class="op" id="4056690">,</span>&nbsp;<span class="ident" id="4056692">sp</span><span class="op" id="4056694">.</span><span class="ident" id="4056695">Y</span><span class="op" id="4056696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056699">var</span>&nbsp;<span class="ident" id="4056703">ddelta</span><span class="op" id="4056709">,</span>&nbsp;<span class="ident" id="4056711">sdelta</span>&nbsp;<span class="builtintype" id="4056718">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056723">if</span>&nbsp;<span class="ident" id="4056726">r</span><span class="op" id="4056727">.</span><span class="ident" id="4056728">Min</span><span class="op" id="4056731">.</span><span class="ident" id="4056732">Y</span>&nbsp;<span class="op" id="4056734">&lt;=</span>&nbsp;<span class="ident" id="4056737">sp</span><span class="op" id="4056739">.</span><span class="ident" id="4056740">Y</span>&nbsp;<span class="op" id="4056742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056746">ddelta</span>&nbsp;<span class="op" id="4056753">=</span>&nbsp;<span class="ident" id="4056755">dst</span><span class="op" id="4056758">.</span><span class="ident" id="4056759">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056768">sdelta</span>&nbsp;<span class="op" id="4056775">=</span>&nbsp;<span class="ident" id="4056777">src</span><span class="op" id="4056780">.</span><span class="ident" id="4056781">Stride</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056789">}</span>&nbsp;<span class="keyword" id="4056791">else</span>&nbsp;<span class="op" id="4056796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4056800">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4056900">//&nbsp;in&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;top-down.&nbsp;Unlike&nbsp;the&nbsp;drawCopyOver&nbsp;function,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4056996">//&nbsp;check&nbsp;the&nbsp;x&nbsp;co-ordinates&nbsp;because&nbsp;the&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;can&nbsp;handle&nbsp;overlapping&nbsp;slices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057092">d0</span>&nbsp;<span class="op" id="4057095">+=</span>&nbsp;<span class="op" id="4057098">(</span><span class="ident" id="4057099">dy</span>&nbsp;<span class="op" id="4057102">-</span>&nbsp;<span class="num" id="4057104">1</span><span class="op" id="4057105">)</span>&nbsp;<span class="op" id="4057107">*</span>&nbsp;<span class="ident" id="4057109">dst</span><span class="op" id="4057112">.</span><span class="ident" id="4057113">Stride</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057122">s0</span>&nbsp;<span class="op" id="4057125">+=</span>&nbsp;<span class="op" id="4057128">(</span><span class="ident" id="4057129">dy</span>&nbsp;<span class="op" id="4057132">-</span>&nbsp;<span class="num" id="4057134">1</span><span class="op" id="4057135">)</span>&nbsp;<span class="op" id="4057137">*</span>&nbsp;<span class="ident" id="4057139">src</span><span class="op" id="4057142">.</span><span class="ident" id="4057143">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057152">ddelta</span>&nbsp;<span class="op" id="4057159">=</span>&nbsp;<span class="op" id="4057161">-</span><span class="ident" id="4057162">dst</span><span class="op" id="4057165">.</span><span class="ident" id="4057166">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057175">sdelta</span>&nbsp;<span class="op" id="4057182">=</span>&nbsp;<span class="op" id="4057184">-</span><span class="ident" id="4057185">src</span><span class="op" id="4057188">.</span><span class="ident" id="4057189">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057200">for</span>&nbsp;<span class="op" id="4057204">;</span>&nbsp;<span class="ident" id="4057206">dy</span>&nbsp;<span class="op" id="4057209">&gt;</span>&nbsp;<span class="num" id="4057211">0</span><span class="op" id="4057212">;</span>&nbsp;<span class="ident" id="4057214">dy</span><span class="op" id="4057216">--</span>&nbsp;<span class="op" id="4057219">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4057223">copy</span><span class="op" id="4057227">(</span><span class="ident" id="4057228">dst</span><span class="op" id="4057231">.</span><span class="ident" id="4057232">Pix</span><span class="op" id="4057235">[</span><span class="ident" id="4057236">d0</span><span class="op" id="4057238">:</span><span class="ident" id="4057239">d0</span><span class="op" id="4057241">+</span><span class="ident" id="4057242">n</span><span class="op" id="4057243">]</span><span class="op" id="4057244">,</span>&nbsp;<span class="ident" id="4057246">src</span><span class="op" id="4057249">.</span><span class="ident" id="4057250">Pix</span><span class="op" id="4057253">[</span><span class="ident" id="4057254">s0</span><span class="op" id="4057256">:</span><span class="ident" id="4057257">s0</span><span class="op" id="4057259">+</span><span class="ident" id="4057260">n</span><span class="op" id="4057261">]</span><span class="op" id="4057262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057266">d0</span>&nbsp;<span class="op" id="4057269">+=</span>&nbsp;<span class="ident" id="4057272">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057281">s0</span>&nbsp;<span class="op" id="4057284">+=</span>&nbsp;<span class="ident" id="4057287">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4057295">}</span><br>
<span class="lineno"></span><span class="op" id="4057297">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="4057300">func</span>&nbsp;<span class="ident" id="4057305">drawNRGBAOver</span><span class="op" id="4057318">(</span><span class="ident" id="4057319">dst</span>&nbsp;<span class="op" id="4057323">*</span><span class="ident" id="4057324">image</span><span class="op" id="4057329">.</span><span class="ident" id="4057330">RGBA</span><span class="op" id="4057334">,</span>&nbsp;<span class="ident" id="4057336">r</span>&nbsp;<span class="ident" id="4057338">image</span><span class="op" id="4057343">.</span><span class="ident" id="4057344">Rectangle</span><span class="op" id="4057353">,</span>&nbsp;<span class="ident" id="4057355">src</span>&nbsp;<span class="op" id="4057359">*</span><span class="ident" id="4057360">image</span><span class="op" id="4057365">.</span><span class="ident" id="4057366">NRGBA</span><span class="op" id="4057371">,</span>&nbsp;<span class="ident" id="4057373">sp</span>&nbsp;<span class="ident" id="4057376">image</span><span class="op" id="4057381">.</span><span class="ident" id="4057382">Point</span><span class="op" id="4057387">)</span>&nbsp;<span class="op" id="4057389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057392">i0</span>&nbsp;<span class="op" id="4057395">:=</span>&nbsp;<span class="op" id="4057398">(</span><span class="ident" id="4057399">r</span><span class="op" id="4057400">.</span><span class="ident" id="4057401">Min</span><span class="op" id="4057404">.</span><span class="ident" id="4057405">X</span>&nbsp;<span class="op" id="4057407">-</span>&nbsp;<span class="ident" id="4057409">dst</span><span class="op" id="4057412">.</span><span class="ident" id="4057413">Rect</span><span class="op" id="4057417">.</span><span class="ident" id="4057418">Min</span><span class="op" id="4057421">.</span><span class="ident" id="4057422">X</span><span class="op" id="4057423">)</span>&nbsp;<span class="op" id="4057425">*</span>&nbsp;<span class="num" id="4057427">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057430">i1</span>&nbsp;<span class="op" id="4057433">:=</span>&nbsp;<span class="op" id="4057436">(</span><span class="ident" id="4057437">r</span><span class="op" id="4057438">.</span><span class="ident" id="4057439">Max</span><span class="op" id="4057442">.</span><span class="ident" id="4057443">X</span>&nbsp;<span class="op" id="4057445">-</span>&nbsp;<span class="ident" id="4057447">dst</span><span class="op" id="4057450">.</span><span class="ident" id="4057451">Rect</span><span class="op" id="4057455">.</span><span class="ident" id="4057456">Min</span><span class="op" id="4057459">.</span><span class="ident" id="4057460">X</span><span class="op" id="4057461">)</span>&nbsp;<span class="op" id="4057463">*</span>&nbsp;<span class="num" id="4057465">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057468">si0</span>&nbsp;<span class="op" id="4057472">:=</span>&nbsp;<span class="op" id="4057475">(</span><span class="ident" id="4057476">sp</span><span class="op" id="4057478">.</span><span class="ident" id="4057479">X</span>&nbsp;<span class="op" id="4057481">-</span>&nbsp;<span class="ident" id="4057483">src</span><span class="op" id="4057486">.</span><span class="ident" id="4057487">Rect</span><span class="op" id="4057491">.</span><span class="ident" id="4057492">Min</span><span class="op" id="4057495">.</span><span class="ident" id="4057496">X</span><span class="op" id="4057497">)</span>&nbsp;<span class="op" id="4057499">*</span>&nbsp;<span class="num" id="4057501">4</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057504">yMax</span>&nbsp;<span class="op" id="4057509">:=</span>&nbsp;<span class="ident" id="4057512">r</span><span class="op" id="4057513">.</span><span class="ident" id="4057514">Max</span><span class="op" id="4057517">.</span><span class="ident" id="4057518">Y</span>&nbsp;<span class="op" id="4057520">-</span>&nbsp;<span class="ident" id="4057522">dst</span><span class="op" id="4057525">.</span><span class="ident" id="4057526">Rect</span><span class="op" id="4057530">.</span><span class="ident" id="4057531">Min</span><span class="op" id="4057534">.</span><span class="ident" id="4057535">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057539">y</span>&nbsp;<span class="op" id="4057541">:=</span>&nbsp;<span class="ident" id="4057544">r</span><span class="op" id="4057545">.</span><span class="ident" id="4057546">Min</span><span class="op" id="4057549">.</span><span class="ident" id="4057550">Y</span>&nbsp;<span class="op" id="4057552">-</span>&nbsp;<span class="ident" id="4057554">dst</span><span class="op" id="4057557">.</span><span class="ident" id="4057558">Rect</span><span class="op" id="4057562">.</span><span class="ident" id="4057563">Min</span><span class="op" id="4057566">.</span><span class="ident" id="4057567">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057570">sy</span>&nbsp;<span class="op" id="4057573">:=</span>&nbsp;<span class="ident" id="4057576">sp</span><span class="op" id="4057578">.</span><span class="ident" id="4057579">Y</span>&nbsp;<span class="op" id="4057581">-</span>&nbsp;<span class="ident" id="4057583">src</span><span class="op" id="4057586">.</span><span class="ident" id="4057587">Rect</span><span class="op" id="4057591">.</span><span class="ident" id="4057592">Min</span><span class="op" id="4057595">.</span><span class="ident" id="4057596">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057599">for</span>&nbsp;<span class="op" id="4057603">;</span>&nbsp;<span class="ident" id="4057605">y</span>&nbsp;<span class="op" id="4057607">!=</span>&nbsp;<span class="ident" id="4057610">yMax</span><span class="op" id="4057614">;</span>&nbsp;<span class="ident" id="4057616">y</span><span class="op" id="4057617">,</span>&nbsp;<span class="ident" id="4057619">sy</span>&nbsp;<span class="op" id="4057622">=</span>&nbsp;<span class="ident" id="4057624">y</span><span class="op" id="4057625">+</span><span class="num" id="4057626">1</span><span class="op" id="4057627">,</span>&nbsp;<span class="ident" id="4057629">sy</span><span class="op" id="4057631">+</span><span class="num" id="4057632">1</span>&nbsp;<span class="op" id="4057634">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057638">dpix</span>&nbsp;<span class="op" id="4057643">:=</span>&nbsp;<span class="ident" id="4057646">dst</span><span class="op" id="4057649">.</span><span class="ident" id="4057650">Pix</span><span class="op" id="4057653">[</span><span class="ident" id="4057654">y</span><span class="op" id="4057655">*</span><span class="ident" id="4057656">dst</span><span class="op" id="4057659">.</span><span class="ident" id="4057660">Stride</span><span class="op" id="4057666">:</span><span class="op" id="4057667">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057671">spix</span>&nbsp;<span class="op" id="4057676">:=</span>&nbsp;<span class="ident" id="4057679">src</span><span class="op" id="4057682">.</span><span class="ident" id="4057683">Pix</span><span class="op" id="4057686">[</span><span class="ident" id="4057687">sy</span><span class="op" id="4057689">*</span><span class="ident" id="4057690">src</span><span class="op" id="4057693">.</span><span class="ident" id="4057694">Stride</span><span class="op" id="4057700">:</span><span class="op" id="4057701">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4057706">for</span>&nbsp;<span class="ident" id="4057710">i</span><span class="op" id="4057711">,</span>&nbsp;<span class="ident" id="4057713">si</span>&nbsp;<span class="op" id="4057716">:=</span>&nbsp;<span class="ident" id="4057719">i0</span><span class="op" id="4057721">,</span>&nbsp;<span class="ident" id="4057723">si0</span><span class="op" id="4057726">;</span>&nbsp;<span class="ident" id="4057728">i</span>&nbsp;<span class="op" id="4057730">&lt;</span>&nbsp;<span class="ident" id="4057732">i1</span><span class="op" id="4057734">;</span>&nbsp;<span class="ident" id="4057736">i</span><span class="op" id="4057737">,</span>&nbsp;<span class="ident" id="4057739">si</span>&nbsp;<span class="op" id="4057742">=</span>&nbsp;<span class="ident" id="4057744">i</span><span class="op" id="4057745">+</span><span class="num" id="4057746">4</span><span class="op" id="4057747">,</span>&nbsp;<span class="ident" id="4057749">si</span><span class="op" id="4057751">+</span><span class="num" id="4057752">4</span>&nbsp;<span class="op" id="4057754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4057759">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057827">sa</span>&nbsp;<span class="op" id="4057830">:=</span>&nbsp;<span class="builtintype" id="4057833">uint32</span><span class="op" id="4057839">(</span><span class="ident" id="4057840">spix</span><span class="op" id="4057844">[</span><span class="ident" id="4057845">si</span><span class="op" id="4057847">+</span><span class="num" id="4057848">3</span><span class="op" id="4057849">]</span><span class="op" id="4057850">)</span>&nbsp;<span class="op" id="4057852">*</span>&nbsp;<span class="num" id="4057854">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057863">sr</span>&nbsp;<span class="op" id="4057866">:=</span>&nbsp;<span class="builtintype" id="4057869">uint32</span><span class="op" id="4057875">(</span><span class="ident" id="4057876">spix</span><span class="op" id="4057880">[</span><span class="ident" id="4057881">si</span><span class="op" id="4057883">+</span><span class="num" id="4057884">0</span><span class="op" id="4057885">]</span><span class="op" id="4057886">)</span>&nbsp;<span class="op" id="4057888">*</span>&nbsp;<span class="ident" id="4057890">sa</span>&nbsp;<span class="op" id="4057893">/</span>&nbsp;<span class="num" id="4057895">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057903">sg</span>&nbsp;<span class="op" id="4057906">:=</span>&nbsp;<span class="builtintype" id="4057909">uint32</span><span class="op" id="4057915">(</span><span class="ident" id="4057916">spix</span><span class="op" id="4057920">[</span><span class="ident" id="4057921">si</span><span class="op" id="4057923">+</span><span class="num" id="4057924">1</span><span class="op" id="4057925">]</span><span class="op" id="4057926">)</span>&nbsp;<span class="op" id="4057928">*</span>&nbsp;<span class="ident" id="4057930">sa</span>&nbsp;<span class="op" id="4057933">/</span>&nbsp;<span class="num" id="4057935">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057943">sb</span>&nbsp;<span class="op" id="4057946">:=</span>&nbsp;<span class="builtintype" id="4057949">uint32</span><span class="op" id="4057955">(</span><span class="ident" id="4057956">spix</span><span class="op" id="4057960">[</span><span class="ident" id="4057961">si</span><span class="op" id="4057963">+</span><span class="num" id="4057964">2</span><span class="op" id="4057965">]</span><span class="op" id="4057966">)</span>&nbsp;<span class="op" id="4057968">*</span>&nbsp;<span class="ident" id="4057970">sa</span>&nbsp;<span class="op" id="4057973">/</span>&nbsp;<span class="num" id="4057975">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4057984">dr</span>&nbsp;<span class="op" id="4057987">:=</span>&nbsp;<span class="builtintype" id="4057990">uint32</span><span class="op" id="4057996">(</span><span class="ident" id="4057997">dpix</span><span class="op" id="4058001">[</span><span class="ident" id="4058002">i</span><span class="op" id="4058003">+</span><span class="num" id="4058004">0</span><span class="op" id="4058005">]</span><span class="op" id="4058006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058011">dg</span>&nbsp;<span class="op" id="4058014">:=</span>&nbsp;<span class="builtintype" id="4058017">uint32</span><span class="op" id="4058023">(</span><span class="ident" id="4058024">dpix</span><span class="op" id="4058028">[</span><span class="ident" id="4058029">i</span><span class="op" id="4058030">+</span><span class="num" id="4058031">1</span><span class="op" id="4058032">]</span><span class="op" id="4058033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058038">db</span>&nbsp;<span class="op" id="4058041">:=</span>&nbsp;<span class="builtintype" id="4058044">uint32</span><span class="op" id="4058050">(</span><span class="ident" id="4058051">dpix</span><span class="op" id="4058055">[</span><span class="ident" id="4058056">i</span><span class="op" id="4058057">+</span><span class="num" id="4058058">2</span><span class="op" id="4058059">]</span><span class="op" id="4058060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058065">da</span>&nbsp;<span class="op" id="4058068">:=</span>&nbsp;<span class="builtintype" id="4058071">uint32</span><span class="op" id="4058077">(</span><span class="ident" id="4058078">dpix</span><span class="op" id="4058082">[</span><span class="ident" id="4058083">i</span><span class="op" id="4058084">+</span><span class="num" id="4058085">3</span><span class="op" id="4058086">]</span><span class="op" id="4058087">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4058093">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058153">a</span>&nbsp;<span class="op" id="4058155">:=</span>&nbsp;<span class="op" id="4058158">(</span><span class="ident" id="4058159">m</span>&nbsp;<span class="op" id="4058161">-</span>&nbsp;<span class="ident" id="4058163">sa</span><span class="op" id="4058165">)</span>&nbsp;<span class="op" id="4058167">*</span>&nbsp;<span class="num" id="4058169">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058179">dpix</span><span class="op" id="4058183">[</span><span class="ident" id="4058184">i</span><span class="op" id="4058185">+</span><span class="num" id="4058186">0</span><span class="op" id="4058187">]</span>&nbsp;<span class="op" id="4058189">=</span>&nbsp;<span class="builtintype" id="4058191">uint8</span><span class="op" id="4058196">(</span><span class="op" id="4058197">(</span><span class="ident" id="4058198">dr</span><span class="op" id="4058200">*</span><span class="ident" id="4058201">a</span><span class="op" id="4058202">/</span><span class="ident" id="4058203">m</span>&nbsp;<span class="op" id="4058205">+</span>&nbsp;<span class="ident" id="4058207">sr</span><span class="op" id="4058209">)</span>&nbsp;<span class="op" id="4058211">&gt;&gt;</span>&nbsp;<span class="num" id="4058214">8</span><span class="op" id="4058215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058220">dpix</span><span class="op" id="4058224">[</span><span class="ident" id="4058225">i</span><span class="op" id="4058226">+</span><span class="num" id="4058227">1</span><span class="op" id="4058228">]</span>&nbsp;<span class="op" id="4058230">=</span>&nbsp;<span class="builtintype" id="4058232">uint8</span><span class="op" id="4058237">(</span><span class="op" id="4058238">(</span><span class="ident" id="4058239">dg</span><span class="op" id="4058241">*</span><span class="ident" id="4058242">a</span><span class="op" id="4058243">/</span><span class="ident" id="4058244">m</span>&nbsp;<span class="op" id="4058246">+</span>&nbsp;<span class="ident" id="4058248">sg</span><span class="op" id="4058250">)</span>&nbsp;<span class="op" id="4058252">&gt;&gt;</span>&nbsp;<span class="num" id="4058255">8</span><span class="op" id="4058256">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058261">dpix</span><span class="op" id="4058265">[</span><span class="ident" id="4058266">i</span><span class="op" id="4058267">+</span><span class="num" id="4058268">2</span><span class="op" id="4058269">]</span>&nbsp;<span class="op" id="4058271">=</span>&nbsp;<span class="builtintype" id="4058273">uint8</span><span class="op" id="4058278">(</span><span class="op" id="4058279">(</span><span class="ident" id="4058280">db</span><span class="op" id="4058282">*</span><span class="ident" id="4058283">a</span><span class="op" id="4058284">/</span><span class="ident" id="4058285">m</span>&nbsp;<span class="op" id="4058287">+</span>&nbsp;<span class="ident" id="4058289">sb</span><span class="op" id="4058291">)</span>&nbsp;<span class="op" id="4058293">&gt;&gt;</span>&nbsp;<span class="num" id="4058296">8</span><span class="op" id="4058297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058302">dpix</span><span class="op" id="4058306">[</span><span class="ident" id="4058307">i</span><span class="op" id="4058308">+</span><span class="num" id="4058309">3</span><span class="op" id="4058310">]</span>&nbsp;<span class="op" id="4058312">=</span>&nbsp;<span class="builtintype" id="4058314">uint8</span><span class="op" id="4058319">(</span><span class="op" id="4058320">(</span><span class="ident" id="4058321">da</span><span class="op" id="4058323">*</span><span class="ident" id="4058324">a</span><span class="op" id="4058325">/</span><span class="ident" id="4058326">m</span>&nbsp;<span class="op" id="4058328">+</span>&nbsp;<span class="ident" id="4058330">sa</span><span class="op" id="4058332">)</span>&nbsp;<span class="op" id="4058334">&gt;&gt;</span>&nbsp;<span class="num" id="4058337">8</span><span class="op" id="4058338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4058342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4058345">}</span><br>
<span class="lineno"></span><span class="op" id="4058347">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="4058350">func</span>&nbsp;<span class="ident" id="4058355">drawNRGBASrc</span><span class="op" id="4058367">(</span><span class="ident" id="4058368">dst</span>&nbsp;<span class="op" id="4058372">*</span><span class="ident" id="4058373">image</span><span class="op" id="4058378">.</span><span class="ident" id="4058379">RGBA</span><span class="op" id="4058383">,</span>&nbsp;<span class="ident" id="4058385">r</span>&nbsp;<span class="ident" id="4058387">image</span><span class="op" id="4058392">.</span><span class="ident" id="4058393">Rectangle</span><span class="op" id="4058402">,</span>&nbsp;<span class="ident" id="4058404">src</span>&nbsp;<span class="op" id="4058408">*</span><span class="ident" id="4058409">image</span><span class="op" id="4058414">.</span><span class="ident" id="4058415">NRGBA</span><span class="op" id="4058420">,</span>&nbsp;<span class="ident" id="4058422">sp</span>&nbsp;<span class="ident" id="4058425">image</span><span class="op" id="4058430">.</span><span class="ident" id="4058431">Point</span><span class="op" id="4058436">)</span>&nbsp;<span class="op" id="4058438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058441">i0</span>&nbsp;<span class="op" id="4058444">:=</span>&nbsp;<span class="op" id="4058447">(</span><span class="ident" id="4058448">r</span><span class="op" id="4058449">.</span><span class="ident" id="4058450">Min</span><span class="op" id="4058453">.</span><span class="ident" id="4058454">X</span>&nbsp;<span class="op" id="4058456">-</span>&nbsp;<span class="ident" id="4058458">dst</span><span class="op" id="4058461">.</span><span class="ident" id="4058462">Rect</span><span class="op" id="4058466">.</span><span class="ident" id="4058467">Min</span><span class="op" id="4058470">.</span><span class="ident" id="4058471">X</span><span class="op" id="4058472">)</span>&nbsp;<span class="op" id="4058474">*</span>&nbsp;<span class="num" id="4058476">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058479">i1</span>&nbsp;<span class="op" id="4058482">:=</span>&nbsp;<span class="op" id="4058485">(</span><span class="ident" id="4058486">r</span><span class="op" id="4058487">.</span><span class="ident" id="4058488">Max</span><span class="op" id="4058491">.</span><span class="ident" id="4058492">X</span>&nbsp;<span class="op" id="4058494">-</span>&nbsp;<span class="ident" id="4058496">dst</span><span class="op" id="4058499">.</span><span class="ident" id="4058500">Rect</span><span class="op" id="4058504">.</span><span class="ident" id="4058505">Min</span><span class="op" id="4058508">.</span><span class="ident" id="4058509">X</span><span class="op" id="4058510">)</span>&nbsp;<span class="op" id="4058512">*</span>&nbsp;<span class="num" id="4058514">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058517">si0</span>&nbsp;<span class="op" id="4058521">:=</span>&nbsp;<span class="op" id="4058524">(</span><span class="ident" id="4058525">sp</span><span class="op" id="4058527">.</span><span class="ident" id="4058528">X</span>&nbsp;<span class="op" id="4058530">-</span>&nbsp;<span class="ident" id="4058532">src</span><span class="op" id="4058535">.</span><span class="ident" id="4058536">Rect</span><span class="op" id="4058540">.</span><span class="ident" id="4058541">Min</span><span class="op" id="4058544">.</span><span class="ident" id="4058545">X</span><span class="op" id="4058546">)</span>&nbsp;<span class="op" id="4058548">*</span>&nbsp;<span class="num" id="4058550">4</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058553">yMax</span>&nbsp;<span class="op" id="4058558">:=</span>&nbsp;<span class="ident" id="4058561">r</span><span class="op" id="4058562">.</span><span class="ident" id="4058563">Max</span><span class="op" id="4058566">.</span><span class="ident" id="4058567">Y</span>&nbsp;<span class="op" id="4058569">-</span>&nbsp;<span class="ident" id="4058571">dst</span><span class="op" id="4058574">.</span><span class="ident" id="4058575">Rect</span><span class="op" id="4058579">.</span><span class="ident" id="4058580">Min</span><span class="op" id="4058583">.</span><span class="ident" id="4058584">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058588">y</span>&nbsp;<span class="op" id="4058590">:=</span>&nbsp;<span class="ident" id="4058593">r</span><span class="op" id="4058594">.</span><span class="ident" id="4058595">Min</span><span class="op" id="4058598">.</span><span class="ident" id="4058599">Y</span>&nbsp;<span class="op" id="4058601">-</span>&nbsp;<span class="ident" id="4058603">dst</span><span class="op" id="4058606">.</span><span class="ident" id="4058607">Rect</span><span class="op" id="4058611">.</span><span class="ident" id="4058612">Min</span><span class="op" id="4058615">.</span><span class="ident" id="4058616">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058619">sy</span>&nbsp;<span class="op" id="4058622">:=</span>&nbsp;<span class="ident" id="4058625">sp</span><span class="op" id="4058627">.</span><span class="ident" id="4058628">Y</span>&nbsp;<span class="op" id="4058630">-</span>&nbsp;<span class="ident" id="4058632">src</span><span class="op" id="4058635">.</span><span class="ident" id="4058636">Rect</span><span class="op" id="4058640">.</span><span class="ident" id="4058641">Min</span><span class="op" id="4058644">.</span><span class="ident" id="4058645">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058648">for</span>&nbsp;<span class="op" id="4058652">;</span>&nbsp;<span class="ident" id="4058654">y</span>&nbsp;<span class="op" id="4058656">!=</span>&nbsp;<span class="ident" id="4058659">yMax</span><span class="op" id="4058663">;</span>&nbsp;<span class="ident" id="4058665">y</span><span class="op" id="4058666">,</span>&nbsp;<span class="ident" id="4058668">sy</span>&nbsp;<span class="op" id="4058671">=</span>&nbsp;<span class="ident" id="4058673">y</span><span class="op" id="4058674">+</span><span class="num" id="4058675">1</span><span class="op" id="4058676">,</span>&nbsp;<span class="ident" id="4058678">sy</span><span class="op" id="4058680">+</span><span class="num" id="4058681">1</span>&nbsp;<span class="op" id="4058683">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058687">dpix</span>&nbsp;<span class="op" id="4058692">:=</span>&nbsp;<span class="ident" id="4058695">dst</span><span class="op" id="4058698">.</span><span class="ident" id="4058699">Pix</span><span class="op" id="4058702">[</span><span class="ident" id="4058703">y</span><span class="op" id="4058704">*</span><span class="ident" id="4058705">dst</span><span class="op" id="4058708">.</span><span class="ident" id="4058709">Stride</span><span class="op" id="4058715">:</span><span class="op" id="4058716">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058720">spix</span>&nbsp;<span class="op" id="4058725">:=</span>&nbsp;<span class="ident" id="4058728">src</span><span class="op" id="4058731">.</span><span class="ident" id="4058732">Pix</span><span class="op" id="4058735">[</span><span class="ident" id="4058736">sy</span><span class="op" id="4058738">*</span><span class="ident" id="4058739">src</span><span class="op" id="4058742">.</span><span class="ident" id="4058743">Stride</span><span class="op" id="4058749">:</span><span class="op" id="4058750">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4058755">for</span>&nbsp;<span class="ident" id="4058759">i</span><span class="op" id="4058760">,</span>&nbsp;<span class="ident" id="4058762">si</span>&nbsp;<span class="op" id="4058765">:=</span>&nbsp;<span class="ident" id="4058768">i0</span><span class="op" id="4058770">,</span>&nbsp;<span class="ident" id="4058772">si0</span><span class="op" id="4058775">;</span>&nbsp;<span class="ident" id="4058777">i</span>&nbsp;<span class="op" id="4058779">&lt;</span>&nbsp;<span class="ident" id="4058781">i1</span><span class="op" id="4058783">;</span>&nbsp;<span class="ident" id="4058785">i</span><span class="op" id="4058786">,</span>&nbsp;<span class="ident" id="4058788">si</span>&nbsp;<span class="op" id="4058791">=</span>&nbsp;<span class="ident" id="4058793">i</span><span class="op" id="4058794">+</span><span class="num" id="4058795">4</span><span class="op" id="4058796">,</span>&nbsp;<span class="ident" id="4058798">si</span><span class="op" id="4058800">+</span><span class="num" id="4058801">4</span>&nbsp;<span class="op" id="4058803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4058808">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058876">sa</span>&nbsp;<span class="op" id="4058879">:=</span>&nbsp;<span class="builtintype" id="4058882">uint32</span><span class="op" id="4058888">(</span><span class="ident" id="4058889">spix</span><span class="op" id="4058893">[</span><span class="ident" id="4058894">si</span><span class="op" id="4058896">+</span><span class="num" id="4058897">3</span><span class="op" id="4058898">]</span><span class="op" id="4058899">)</span>&nbsp;<span class="op" id="4058901">*</span>&nbsp;<span class="num" id="4058903">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058912">sr</span>&nbsp;<span class="op" id="4058915">:=</span>&nbsp;<span class="builtintype" id="4058918">uint32</span><span class="op" id="4058924">(</span><span class="ident" id="4058925">spix</span><span class="op" id="4058929">[</span><span class="ident" id="4058930">si</span><span class="op" id="4058932">+</span><span class="num" id="4058933">0</span><span class="op" id="4058934">]</span><span class="op" id="4058935">)</span>&nbsp;<span class="op" id="4058937">*</span>&nbsp;<span class="ident" id="4058939">sa</span>&nbsp;<span class="op" id="4058942">/</span>&nbsp;<span class="num" id="4058944">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058952">sg</span>&nbsp;<span class="op" id="4058955">:=</span>&nbsp;<span class="builtintype" id="4058958">uint32</span><span class="op" id="4058964">(</span><span class="ident" id="4058965">spix</span><span class="op" id="4058969">[</span><span class="ident" id="4058970">si</span><span class="op" id="4058972">+</span><span class="num" id="4058973">1</span><span class="op" id="4058974">]</span><span class="op" id="4058975">)</span>&nbsp;<span class="op" id="4058977">*</span>&nbsp;<span class="ident" id="4058979">sa</span>&nbsp;<span class="op" id="4058982">/</span>&nbsp;<span class="num" id="4058984">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4058992">sb</span>&nbsp;<span class="op" id="4058995">:=</span>&nbsp;<span class="builtintype" id="4058998">uint32</span><span class="op" id="4059004">(</span><span class="ident" id="4059005">spix</span><span class="op" id="4059009">[</span><span class="ident" id="4059010">si</span><span class="op" id="4059012">+</span><span class="num" id="4059013">2</span><span class="op" id="4059014">]</span><span class="op" id="4059015">)</span>&nbsp;<span class="op" id="4059017">*</span>&nbsp;<span class="ident" id="4059019">sa</span>&nbsp;<span class="op" id="4059022">/</span>&nbsp;<span class="num" id="4059024">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059033">dpix</span><span class="op" id="4059037">[</span><span class="ident" id="4059038">i</span><span class="op" id="4059039">+</span><span class="num" id="4059040">0</span><span class="op" id="4059041">]</span>&nbsp;<span class="op" id="4059043">=</span>&nbsp;<span class="builtintype" id="4059045">uint8</span><span class="op" id="4059050">(</span><span class="ident" id="4059051">sr</span>&nbsp;<span class="op" id="4059054">&gt;&gt;</span>&nbsp;<span class="num" id="4059057">8</span><span class="op" id="4059058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059063">dpix</span><span class="op" id="4059067">[</span><span class="ident" id="4059068">i</span><span class="op" id="4059069">+</span><span class="num" id="4059070">1</span><span class="op" id="4059071">]</span>&nbsp;<span class="op" id="4059073">=</span>&nbsp;<span class="builtintype" id="4059075">uint8</span><span class="op" id="4059080">(</span><span class="ident" id="4059081">sg</span>&nbsp;<span class="op" id="4059084">&gt;&gt;</span>&nbsp;<span class="num" id="4059087">8</span><span class="op" id="4059088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059093">dpix</span><span class="op" id="4059097">[</span><span class="ident" id="4059098">i</span><span class="op" id="4059099">+</span><span class="num" id="4059100">2</span><span class="op" id="4059101">]</span>&nbsp;<span class="op" id="4059103">=</span>&nbsp;<span class="builtintype" id="4059105">uint8</span><span class="op" id="4059110">(</span><span class="ident" id="4059111">sb</span>&nbsp;<span class="op" id="4059114">&gt;&gt;</span>&nbsp;<span class="num" id="4059117">8</span><span class="op" id="4059118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059123">dpix</span><span class="op" id="4059127">[</span><span class="ident" id="4059128">i</span><span class="op" id="4059129">+</span><span class="num" id="4059130">3</span><span class="op" id="4059131">]</span>&nbsp;<span class="op" id="4059133">=</span>&nbsp;<span class="builtintype" id="4059135">uint8</span><span class="op" id="4059140">(</span><span class="ident" id="4059141">sa</span>&nbsp;<span class="op" id="4059144">&gt;&gt;</span>&nbsp;<span class="num" id="4059147">8</span><span class="op" id="4059148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4059152">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4059155">}</span><br>
<span class="lineno"></span><span class="op" id="4059157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4059160">func</span>&nbsp;<span class="ident" id="4059165">drawYCbCr</span><span class="op" id="4059174">(</span><span class="ident" id="4059175">dst</span>&nbsp;<span class="op" id="4059179">*</span><span class="ident" id="4059180">image</span><span class="op" id="4059185">.</span><span class="ident" id="4059186">RGBA</span><span class="op" id="4059190">,</span>&nbsp;<span class="ident" id="4059192">r</span>&nbsp;<span class="ident" id="4059194">image</span><span class="op" id="4059199">.</span><span class="ident" id="4059200">Rectangle</span><span class="op" id="4059209">,</span>&nbsp;<span class="ident" id="4059211">src</span>&nbsp;<span class="op" id="4059215">*</span><span class="ident" id="4059216">image</span><span class="op" id="4059221">.</span><span class="ident" id="4059222">YCbCr</span><span class="op" id="4059227">,</span>&nbsp;<span class="ident" id="4059229">sp</span>&nbsp;<span class="ident" id="4059232">image</span><span class="op" id="4059237">.</span><span class="ident" id="4059238">Point</span><span class="op" id="4059243">)</span>&nbsp;<span class="op" id="4059245">(</span><span class="ident" id="4059246">ok</span>&nbsp;<span class="builtintype" id="4059249">bool</span><span class="op" id="4059253">)</span>&nbsp;<span class="op" id="4059255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059258">//&nbsp;An&nbsp;image.YCbCr&nbsp;is&nbsp;always&nbsp;fully&nbsp;opaque,&nbsp;and&nbsp;so&nbsp;if&nbsp;the&nbsp;mask&nbsp;is&nbsp;implicitly&nbsp;nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4059338">//&nbsp;(i.e.&nbsp;fully&nbsp;opaque)&nbsp;then&nbsp;the&nbsp;op&nbsp;is&nbsp;effectively&nbsp;always&nbsp;Src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059401">x0</span>&nbsp;<span class="op" id="4059404">:=</span>&nbsp;<span class="op" id="4059407">(</span><span class="ident" id="4059408">r</span><span class="op" id="4059409">.</span><span class="ident" id="4059410">Min</span><span class="op" id="4059413">.</span><span class="ident" id="4059414">X</span>&nbsp;<span class="op" id="4059416">-</span>&nbsp;<span class="ident" id="4059418">dst</span><span class="op" id="4059421">.</span><span class="ident" id="4059422">Rect</span><span class="op" id="4059426">.</span><span class="ident" id="4059427">Min</span><span class="op" id="4059430">.</span><span class="ident" id="4059431">X</span><span class="op" id="4059432">)</span>&nbsp;<span class="op" id="4059434">*</span>&nbsp;<span class="num" id="4059436">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059439">x1</span>&nbsp;<span class="op" id="4059442">:=</span>&nbsp;<span class="op" id="4059445">(</span><span class="ident" id="4059446">r</span><span class="op" id="4059447">.</span><span class="ident" id="4059448">Max</span><span class="op" id="4059451">.</span><span class="ident" id="4059452">X</span>&nbsp;<span class="op" id="4059454">-</span>&nbsp;<span class="ident" id="4059456">dst</span><span class="op" id="4059459">.</span><span class="ident" id="4059460">Rect</span><span class="op" id="4059464">.</span><span class="ident" id="4059465">Min</span><span class="op" id="4059468">.</span><span class="ident" id="4059469">X</span><span class="op" id="4059470">)</span>&nbsp;<span class="op" id="4059472">*</span>&nbsp;<span class="num" id="4059474">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059477">y0</span>&nbsp;<span class="op" id="4059480">:=</span>&nbsp;<span class="ident" id="4059483">r</span><span class="op" id="4059484">.</span><span class="ident" id="4059485">Min</span><span class="op" id="4059488">.</span><span class="ident" id="4059489">Y</span>&nbsp;<span class="op" id="4059491">-</span>&nbsp;<span class="ident" id="4059493">dst</span><span class="op" id="4059496">.</span><span class="ident" id="4059497">Rect</span><span class="op" id="4059501">.</span><span class="ident" id="4059502">Min</span><span class="op" id="4059505">.</span><span class="ident" id="4059506">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059509">y1</span>&nbsp;<span class="op" id="4059512">:=</span>&nbsp;<span class="ident" id="4059515">r</span><span class="op" id="4059516">.</span><span class="ident" id="4059517">Max</span><span class="op" id="4059520">.</span><span class="ident" id="4059521">Y</span>&nbsp;<span class="op" id="4059523">-</span>&nbsp;<span class="ident" id="4059525">dst</span><span class="op" id="4059528">.</span><span class="ident" id="4059529">Rect</span><span class="op" id="4059533">.</span><span class="ident" id="4059534">Min</span><span class="op" id="4059537">.</span><span class="ident" id="4059538">Y</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059541">switch</span>&nbsp;<span class="ident" id="4059548">src</span><span class="op" id="4059551">.</span><span class="ident" id="4059552">SubsampleRatio</span>&nbsp;<span class="op" id="4059567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059570">case</span>&nbsp;<span class="ident" id="4059575">image</span><span class="op" id="4059580">.</span><span class="ident" id="4059581">YCbCrSubsampleRatio444</span><span class="op" id="4059603">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059607">for</span>&nbsp;<span class="ident" id="4059611">y</span><span class="op" id="4059612">,</span>&nbsp;<span class="ident" id="4059614">sy</span>&nbsp;<span class="op" id="4059617">:=</span>&nbsp;<span class="ident" id="4059620">y0</span><span class="op" id="4059622">,</span>&nbsp;<span class="ident" id="4059624">sp</span><span class="op" id="4059626">.</span><span class="ident" id="4059627">Y</span><span class="op" id="4059628">;</span>&nbsp;<span class="ident" id="4059630">y</span>&nbsp;<span class="op" id="4059632">!=</span>&nbsp;<span class="ident" id="4059635">y1</span><span class="op" id="4059637">;</span>&nbsp;<span class="ident" id="4059639">y</span><span class="op" id="4059640">,</span>&nbsp;<span class="ident" id="4059642">sy</span>&nbsp;<span class="op" id="4059645">=</span>&nbsp;<span class="ident" id="4059647">y</span><span class="op" id="4059648">+</span><span class="num" id="4059649">1</span><span class="op" id="4059650">,</span>&nbsp;<span class="ident" id="4059652">sy</span><span class="op" id="4059654">+</span><span class="num" id="4059655">1</span>&nbsp;<span class="op" id="4059657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059662">dpix</span>&nbsp;<span class="op" id="4059667">:=</span>&nbsp;<span class="ident" id="4059670">dst</span><span class="op" id="4059673">.</span><span class="ident" id="4059674">Pix</span><span class="op" id="4059677">[</span><span class="ident" id="4059678">y</span><span class="op" id="4059679">*</span><span class="ident" id="4059680">dst</span><span class="op" id="4059683">.</span><span class="ident" id="4059684">Stride</span><span class="op" id="4059690">:</span><span class="op" id="4059691">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059696">yi</span>&nbsp;<span class="op" id="4059699">:=</span>&nbsp;<span class="op" id="4059702">(</span><span class="ident" id="4059703">sy</span><span class="op" id="4059705">-</span><span class="ident" id="4059706">src</span><span class="op" id="4059709">.</span><span class="ident" id="4059710">Rect</span><span class="op" id="4059714">.</span><span class="ident" id="4059715">Min</span><span class="op" id="4059718">.</span><span class="ident" id="4059719">Y</span><span class="op" id="4059720">)</span><span class="op" id="4059721">*</span><span class="ident" id="4059722">src</span><span class="op" id="4059725">.</span><span class="ident" id="4059726">YStride</span>&nbsp;<span class="op" id="4059734">+</span>&nbsp;<span class="op" id="4059736">(</span><span class="ident" id="4059737">sp</span><span class="op" id="4059739">.</span><span class="ident" id="4059740">X</span>&nbsp;<span class="op" id="4059742">-</span>&nbsp;<span class="ident" id="4059744">src</span><span class="op" id="4059747">.</span><span class="ident" id="4059748">Rect</span><span class="op" id="4059752">.</span><span class="ident" id="4059753">Min</span><span class="op" id="4059756">.</span><span class="ident" id="4059757">X</span><span class="op" id="4059758">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059763">ci</span>&nbsp;<span class="op" id="4059766">:=</span>&nbsp;<span class="op" id="4059769">(</span><span class="ident" id="4059770">sy</span><span class="op" id="4059772">-</span><span class="ident" id="4059773">src</span><span class="op" id="4059776">.</span><span class="ident" id="4059777">Rect</span><span class="op" id="4059781">.</span><span class="ident" id="4059782">Min</span><span class="op" id="4059785">.</span><span class="ident" id="4059786">Y</span><span class="op" id="4059787">)</span><span class="op" id="4059788">*</span><span class="ident" id="4059789">src</span><span class="op" id="4059792">.</span><span class="ident" id="4059793">CStride</span>&nbsp;<span class="op" id="4059801">+</span>&nbsp;<span class="op" id="4059803">(</span><span class="ident" id="4059804">sp</span><span class="op" id="4059806">.</span><span class="ident" id="4059807">X</span>&nbsp;<span class="op" id="4059809">-</span>&nbsp;<span class="ident" id="4059811">src</span><span class="op" id="4059814">.</span><span class="ident" id="4059815">Rect</span><span class="op" id="4059819">.</span><span class="ident" id="4059820">Min</span><span class="op" id="4059823">.</span><span class="ident" id="4059824">X</span><span class="op" id="4059825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4059830">for</span>&nbsp;<span class="ident" id="4059834">x</span>&nbsp;<span class="op" id="4059836">:=</span>&nbsp;<span class="ident" id="4059839">x0</span><span class="op" id="4059841">;</span>&nbsp;<span class="ident" id="4059843">x</span>&nbsp;<span class="op" id="4059845">!=</span>&nbsp;<span class="ident" id="4059848">x1</span><span class="op" id="4059850">;</span>&nbsp;<span class="ident" id="4059852">x</span><span class="op" id="4059853">,</span>&nbsp;<span class="ident" id="4059855">yi</span><span class="op" id="4059857">,</span>&nbsp;<span class="ident" id="4059859">ci</span>&nbsp;<span class="op" id="4059862">=</span>&nbsp;<span class="ident" id="4059864">x</span><span class="op" id="4059865">+</span><span class="num" id="4059866">4</span><span class="op" id="4059867">,</span>&nbsp;<span class="ident" id="4059869">yi</span><span class="op" id="4059871">+</span><span class="num" id="4059872">1</span><span class="op" id="4059873">,</span>&nbsp;<span class="ident" id="4059875">ci</span><span class="op" id="4059877">+</span><span class="num" id="4059878">1</span>&nbsp;<span class="op" id="4059880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059886">rr</span><span class="op" id="4059888">,</span>&nbsp;<span class="ident" id="4059890">gg</span><span class="op" id="4059892">,</span>&nbsp;<span class="ident" id="4059894">bb</span>&nbsp;<span class="op" id="4059897">:=</span>&nbsp;<span class="ident" id="4059900">color</span><span class="op" id="4059905">.</span><span class="ident" id="4059906">YCbCrToRGB</span><span class="op" id="4059916">(</span><span class="ident" id="4059917">src</span><span class="op" id="4059920">.</span><span class="ident" id="4059921">Y</span><span class="op" id="4059922">[</span><span class="ident" id="4059923">yi</span><span class="op" id="4059925">]</span><span class="op" id="4059926">,</span>&nbsp;<span class="ident" id="4059928">src</span><span class="op" id="4059931">.</span><span class="ident" id="4059932">Cb</span><span class="op" id="4059934">[</span><span class="ident" id="4059935">ci</span><span class="op" id="4059937">]</span><span class="op" id="4059938">,</span>&nbsp;<span class="ident" id="4059940">src</span><span class="op" id="4059943">.</span><span class="ident" id="4059944">Cr</span><span class="op" id="4059946">[</span><span class="ident" id="4059947">ci</span><span class="op" id="4059949">]</span><span class="op" id="4059950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059956">dpix</span><span class="op" id="4059960">[</span><span class="ident" id="4059961">x</span><span class="op" id="4059962">+</span><span class="num" id="4059963">0</span><span class="op" id="4059964">]</span>&nbsp;<span class="op" id="4059966">=</span>&nbsp;<span class="ident" id="4059968">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059975">dpix</span><span class="op" id="4059979">[</span><span class="ident" id="4059980">x</span><span class="op" id="4059981">+</span><span class="num" id="4059982">1</span><span class="op" id="4059983">]</span>&nbsp;<span class="op" id="4059985">=</span>&nbsp;<span class="ident" id="4059987">gg</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4059994">dpix</span><span class="op" id="4059998">[</span><span class="ident" id="4059999">x</span><span class="op" id="4060000">+</span><span class="num" id="4060001">2</span><span class="op" id="4060002">]</span>&nbsp;<span class="op" id="4060004">=</span>&nbsp;<span class="ident" id="4060006">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060013">dpix</span><span class="op" id="4060017">[</span><span class="ident" id="4060018">x</span><span class="op" id="4060019">+</span><span class="num" id="4060020">3</span><span class="op" id="4060021">]</span>&nbsp;<span class="op" id="4060023">=</span>&nbsp;<span class="num" id="4060025">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4060032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4060036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060039">case</span>&nbsp;<span class="ident" id="4060044">image</span><span class="op" id="4060049">.</span><span class="ident" id="4060050">YCbCrSubsampleRatio422</span><span class="op" id="4060072">:</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060076">for</span>&nbsp;<span class="ident" id="4060080">y</span><span class="op" id="4060081">,</span>&nbsp;<span class="ident" id="4060083">sy</span>&nbsp;<span class="op" id="4060086">:=</span>&nbsp;<span class="ident" id="4060089">y0</span><span class="op" id="4060091">,</span>&nbsp;<span class="ident" id="4060093">sp</span><span class="op" id="4060095">.</span><span class="ident" id="4060096">Y</span><span class="op" id="4060097">;</span>&nbsp;<span class="ident" id="4060099">y</span>&nbsp;<span class="op" id="4060101">!=</span>&nbsp;<span class="ident" id="4060104">y1</span><span class="op" id="4060106">;</span>&nbsp;<span class="ident" id="4060108">y</span><span class="op" id="4060109">,</span>&nbsp;<span class="ident" id="4060111">sy</span>&nbsp;<span class="op" id="4060114">=</span>&nbsp;<span class="ident" id="4060116">y</span><span class="op" id="4060117">+</span><span class="num" id="4060118">1</span><span class="op" id="4060119">,</span>&nbsp;<span class="ident" id="4060121">sy</span><span class="op" id="4060123">+</span><span class="num" id="4060124">1</span>&nbsp;<span class="op" id="4060126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060131">dpix</span>&nbsp;<span class="op" id="4060136">:=</span>&nbsp;<span class="ident" id="4060139">dst</span><span class="op" id="4060142">.</span><span class="ident" id="4060143">Pix</span><span class="op" id="4060146">[</span><span class="ident" id="4060147">y</span><span class="op" id="4060148">*</span><span class="ident" id="4060149">dst</span><span class="op" id="4060152">.</span><span class="ident" id="4060153">Stride</span><span class="op" id="4060159">:</span><span class="op" id="4060160">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060165">yi</span>&nbsp;<span class="op" id="4060168">:=</span>&nbsp;<span class="op" id="4060171">(</span><span class="ident" id="4060172">sy</span><span class="op" id="4060174">-</span><span class="ident" id="4060175">src</span><span class="op" id="4060178">.</span><span class="ident" id="4060179">Rect</span><span class="op" id="4060183">.</span><span class="ident" id="4060184">Min</span><span class="op" id="4060187">.</span><span class="ident" id="4060188">Y</span><span class="op" id="4060189">)</span><span class="op" id="4060190">*</span><span class="ident" id="4060191">src</span><span class="op" id="4060194">.</span><span class="ident" id="4060195">YStride</span>&nbsp;<span class="op" id="4060203">+</span>&nbsp;<span class="op" id="4060205">(</span><span class="ident" id="4060206">sp</span><span class="op" id="4060208">.</span><span class="ident" id="4060209">X</span>&nbsp;<span class="op" id="4060211">-</span>&nbsp;<span class="ident" id="4060213">src</span><span class="op" id="4060216">.</span><span class="ident" id="4060217">Rect</span><span class="op" id="4060221">.</span><span class="ident" id="4060222">Min</span><span class="op" id="4060225">.</span><span class="ident" id="4060226">X</span><span class="op" id="4060227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060232">ciBase</span>&nbsp;<span class="op" id="4060239">:=</span>&nbsp;<span class="op" id="4060242">(</span><span class="ident" id="4060243">sy</span><span class="op" id="4060245">-</span><span class="ident" id="4060246">src</span><span class="op" id="4060249">.</span><span class="ident" id="4060250">Rect</span><span class="op" id="4060254">.</span><span class="ident" id="4060255">Min</span><span class="op" id="4060258">.</span><span class="ident" id="4060259">Y</span><span class="op" id="4060260">)</span><span class="op" id="4060261">*</span><span class="ident" id="4060262">src</span><span class="op" id="4060265">.</span><span class="ident" id="4060266">CStride</span>&nbsp;<span class="op" id="4060274">-</span>&nbsp;<span class="ident" id="4060276">src</span><span class="op" id="4060279">.</span><span class="ident" id="4060280">Rect</span><span class="op" id="4060284">.</span><span class="ident" id="4060285">Min</span><span class="op" id="4060288">.</span><span class="ident" id="4060289">X</span><span class="op" id="4060290">/</span><span class="num" id="4060291">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060296">for</span>&nbsp;<span class="ident" id="4060300">x</span><span class="op" id="4060301">,</span>&nbsp;<span class="ident" id="4060303">sx</span>&nbsp;<span class="op" id="4060306">:=</span>&nbsp;<span class="ident" id="4060309">x0</span><span class="op" id="4060311">,</span>&nbsp;<span class="ident" id="4060313">sp</span><span class="op" id="4060315">.</span><span class="ident" id="4060316">X</span><span class="op" id="4060317">;</span>&nbsp;<span class="ident" id="4060319">x</span>&nbsp;<span class="op" id="4060321">!=</span>&nbsp;<span class="ident" id="4060324">x1</span><span class="op" id="4060326">;</span>&nbsp;<span class="ident" id="4060328">x</span><span class="op" id="4060329">,</span>&nbsp;<span class="ident" id="4060331">sx</span><span class="op" id="4060333">,</span>&nbsp;<span class="ident" id="4060335">yi</span>&nbsp;<span class="op" id="4060338">=</span>&nbsp;<span class="ident" id="4060340">x</span><span class="op" id="4060341">+</span><span class="num" id="4060342">4</span><span class="op" id="4060343">,</span>&nbsp;<span class="ident" id="4060345">sx</span><span class="op" id="4060347">+</span><span class="num" id="4060348">1</span><span class="op" id="4060349">,</span>&nbsp;<span class="ident" id="4060351">yi</span><span class="op" id="4060353">+</span><span class="num" id="4060354">1</span>&nbsp;<span class="op" id="4060356">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060362">ci</span>&nbsp;<span class="op" id="4060365">:=</span>&nbsp;<span class="ident" id="4060368">ciBase</span>&nbsp;<span class="op" id="4060375">+</span>&nbsp;<span class="ident" id="4060377">sx</span><span class="op" id="4060379">/</span><span class="num" id="4060380">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060386">rr</span><span class="op" id="4060388">,</span>&nbsp;<span class="ident" id="4060390">gg</span><span class="op" id="4060392">,</span>&nbsp;<span class="ident" id="4060394">bb</span>&nbsp;<span class="op" id="4060397">:=</span>&nbsp;<span class="ident" id="4060400">color</span><span class="op" id="4060405">.</span><span class="ident" id="4060406">YCbCrToRGB</span><span class="op" id="4060416">(</span><span class="ident" id="4060417">src</span><span class="op" id="4060420">.</span><span class="ident" id="4060421">Y</span><span class="op" id="4060422">[</span><span class="ident" id="4060423">yi</span><span class="op" id="4060425">]</span><span class="op" id="4060426">,</span>&nbsp;<span class="ident" id="4060428">src</span><span class="op" id="4060431">.</span><span class="ident" id="4060432">Cb</span><span class="op" id="4060434">[</span><span class="ident" id="4060435">ci</span><span class="op" id="4060437">]</span><span class="op" id="4060438">,</span>&nbsp;<span class="ident" id="4060440">src</span><span class="op" id="4060443">.</span><span class="ident" id="4060444">Cr</span><span class="op" id="4060446">[</span><span class="ident" id="4060447">ci</span><span class="op" id="4060449">]</span><span class="op" id="4060450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060456">dpix</span><span class="op" id="4060460">[</span><span class="ident" id="4060461">x</span><span class="op" id="4060462">+</span><span class="num" id="4060463">0</span><span class="op" id="4060464">]</span>&nbsp;<span class="op" id="4060466">=</span>&nbsp;<span class="ident" id="4060468">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060475">dpix</span><span class="op" id="4060479">[</span><span class="ident" id="4060480">x</span><span class="op" id="4060481">+</span><span class="num" id="4060482">1</span><span class="op" id="4060483">]</span>&nbsp;<span class="op" id="4060485">=</span>&nbsp;<span class="ident" id="4060487">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060494">dpix</span><span class="op" id="4060498">[</span><span class="ident" id="4060499">x</span><span class="op" id="4060500">+</span><span class="num" id="4060501">2</span><span class="op" id="4060502">]</span>&nbsp;<span class="op" id="4060504">=</span>&nbsp;<span class="ident" id="4060506">bb</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060513">dpix</span><span class="op" id="4060517">[</span><span class="ident" id="4060518">x</span><span class="op" id="4060519">+</span><span class="num" id="4060520">3</span><span class="op" id="4060521">]</span>&nbsp;<span class="op" id="4060523">=</span>&nbsp;<span class="num" id="4060525">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4060532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4060536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060539">case</span>&nbsp;<span class="ident" id="4060544">image</span><span class="op" id="4060549">.</span><span class="ident" id="4060550">YCbCrSubsampleRatio420</span><span class="op" id="4060572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060576">for</span>&nbsp;<span class="ident" id="4060580">y</span><span class="op" id="4060581">,</span>&nbsp;<span class="ident" id="4060583">sy</span>&nbsp;<span class="op" id="4060586">:=</span>&nbsp;<span class="ident" id="4060589">y0</span><span class="op" id="4060591">,</span>&nbsp;<span class="ident" id="4060593">sp</span><span class="op" id="4060595">.</span><span class="ident" id="4060596">Y</span><span class="op" id="4060597">;</span>&nbsp;<span class="ident" id="4060599">y</span>&nbsp;<span class="op" id="4060601">!=</span>&nbsp;<span class="ident" id="4060604">y1</span><span class="op" id="4060606">;</span>&nbsp;<span class="ident" id="4060608">y</span><span class="op" id="4060609">,</span>&nbsp;<span class="ident" id="4060611">sy</span>&nbsp;<span class="op" id="4060614">=</span>&nbsp;<span class="ident" id="4060616">y</span><span class="op" id="4060617">+</span><span class="num" id="4060618">1</span><span class="op" id="4060619">,</span>&nbsp;<span class="ident" id="4060621">sy</span><span class="op" id="4060623">+</span><span class="num" id="4060624">1</span>&nbsp;<span class="op" id="4060626">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060631">dpix</span>&nbsp;<span class="op" id="4060636">:=</span>&nbsp;<span class="ident" id="4060639">dst</span><span class="op" id="4060642">.</span><span class="ident" id="4060643">Pix</span><span class="op" id="4060646">[</span><span class="ident" id="4060647">y</span><span class="op" id="4060648">*</span><span class="ident" id="4060649">dst</span><span class="op" id="4060652">.</span><span class="ident" id="4060653">Stride</span><span class="op" id="4060659">:</span><span class="op" id="4060660">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060665">yi</span>&nbsp;<span class="op" id="4060668">:=</span>&nbsp;<span class="op" id="4060671">(</span><span class="ident" id="4060672">sy</span><span class="op" id="4060674">-</span><span class="ident" id="4060675">src</span><span class="op" id="4060678">.</span><span class="ident" id="4060679">Rect</span><span class="op" id="4060683">.</span><span class="ident" id="4060684">Min</span><span class="op" id="4060687">.</span><span class="ident" id="4060688">Y</span><span class="op" id="4060689">)</span><span class="op" id="4060690">*</span><span class="ident" id="4060691">src</span><span class="op" id="4060694">.</span><span class="ident" id="4060695">YStride</span>&nbsp;<span class="op" id="4060703">+</span>&nbsp;<span class="op" id="4060705">(</span><span class="ident" id="4060706">sp</span><span class="op" id="4060708">.</span><span class="ident" id="4060709">X</span>&nbsp;<span class="op" id="4060711">-</span>&nbsp;<span class="ident" id="4060713">src</span><span class="op" id="4060716">.</span><span class="ident" id="4060717">Rect</span><span class="op" id="4060721">.</span><span class="ident" id="4060722">Min</span><span class="op" id="4060725">.</span><span class="ident" id="4060726">X</span><span class="op" id="4060727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060732">ciBase</span>&nbsp;<span class="op" id="4060739">:=</span>&nbsp;<span class="op" id="4060742">(</span><span class="ident" id="4060743">sy</span><span class="op" id="4060745">/</span><span class="num" id="4060746">2</span><span class="op" id="4060747">-</span><span class="ident" id="4060748">src</span><span class="op" id="4060751">.</span><span class="ident" id="4060752">Rect</span><span class="op" id="4060756">.</span><span class="ident" id="4060757">Min</span><span class="op" id="4060760">.</span><span class="ident" id="4060761">Y</span><span class="op" id="4060762">/</span><span class="num" id="4060763">2</span><span class="op" id="4060764">)</span><span class="op" id="4060765">*</span><span class="ident" id="4060766">src</span><span class="op" id="4060769">.</span><span class="ident" id="4060770">CStride</span>&nbsp;<span class="op" id="4060778">-</span>&nbsp;<span class="ident" id="4060780">src</span><span class="op" id="4060783">.</span><span class="ident" id="4060784">Rect</span><span class="op" id="4060788">.</span><span class="ident" id="4060789">Min</span><span class="op" id="4060792">.</span><span class="ident" id="4060793">X</span><span class="op" id="4060794">/</span><span class="num" id="4060795">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4060800">for</span>&nbsp;<span class="ident" id="4060804">x</span><span class="op" id="4060805">,</span>&nbsp;<span class="ident" id="4060807">sx</span>&nbsp;<span class="op" id="4060810">:=</span>&nbsp;<span class="ident" id="4060813">x0</span><span class="op" id="4060815">,</span>&nbsp;<span class="ident" id="4060817">sp</span><span class="op" id="4060819">.</span><span class="ident" id="4060820">X</span><span class="op" id="4060821">;</span>&nbsp;<span class="ident" id="4060823">x</span>&nbsp;<span class="op" id="4060825">!=</span>&nbsp;<span class="ident" id="4060828">x1</span><span class="op" id="4060830">;</span>&nbsp;<span class="ident" id="4060832">x</span><span class="op" id="4060833">,</span>&nbsp;<span class="ident" id="4060835">sx</span><span class="op" id="4060837">,</span>&nbsp;<span class="ident" id="4060839">yi</span>&nbsp;<span class="op" id="4060842">=</span>&nbsp;<span class="ident" id="4060844">x</span><span class="op" id="4060845">+</span><span class="num" id="4060846">4</span><span class="op" id="4060847">,</span>&nbsp;<span class="ident" id="4060849">sx</span><span class="op" id="4060851">+</span><span class="num" id="4060852">1</span><span class="op" id="4060853">,</span>&nbsp;<span class="ident" id="4060855">yi</span><span class="op" id="4060857">+</span><span class="num" id="4060858">1</span>&nbsp;<span class="op" id="4060860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060866">ci</span>&nbsp;<span class="op" id="4060869">:=</span>&nbsp;<span class="ident" id="4060872">ciBase</span>&nbsp;<span class="op" id="4060879">+</span>&nbsp;<span class="ident" id="4060881">sx</span><span class="op" id="4060883">/</span><span class="num" id="4060884">2</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060890">rr</span><span class="op" id="4060892">,</span>&nbsp;<span class="ident" id="4060894">gg</span><span class="op" id="4060896">,</span>&nbsp;<span class="ident" id="4060898">bb</span>&nbsp;<span class="op" id="4060901">:=</span>&nbsp;<span class="ident" id="4060904">color</span><span class="op" id="4060909">.</span><span class="ident" id="4060910">YCbCrToRGB</span><span class="op" id="4060920">(</span><span class="ident" id="4060921">src</span><span class="op" id="4060924">.</span><span class="ident" id="4060925">Y</span><span class="op" id="4060926">[</span><span class="ident" id="4060927">yi</span><span class="op" id="4060929">]</span><span class="op" id="4060930">,</span>&nbsp;<span class="ident" id="4060932">src</span><span class="op" id="4060935">.</span><span class="ident" id="4060936">Cb</span><span class="op" id="4060938">[</span><span class="ident" id="4060939">ci</span><span class="op" id="4060941">]</span><span class="op" id="4060942">,</span>&nbsp;<span class="ident" id="4060944">src</span><span class="op" id="4060947">.</span><span class="ident" id="4060948">Cr</span><span class="op" id="4060950">[</span><span class="ident" id="4060951">ci</span><span class="op" id="4060953">]</span><span class="op" id="4060954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060960">dpix</span><span class="op" id="4060964">[</span><span class="ident" id="4060965">x</span><span class="op" id="4060966">+</span><span class="num" id="4060967">0</span><span class="op" id="4060968">]</span>&nbsp;<span class="op" id="4060970">=</span>&nbsp;<span class="ident" id="4060972">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060979">dpix</span><span class="op" id="4060983">[</span><span class="ident" id="4060984">x</span><span class="op" id="4060985">+</span><span class="num" id="4060986">1</span><span class="op" id="4060987">]</span>&nbsp;<span class="op" id="4060989">=</span>&nbsp;<span class="ident" id="4060991">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4060998">dpix</span><span class="op" id="4061002">[</span><span class="ident" id="4061003">x</span><span class="op" id="4061004">+</span><span class="num" id="4061005">2</span><span class="op" id="4061006">]</span>&nbsp;<span class="op" id="4061008">=</span>&nbsp;<span class="ident" id="4061010">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061017">dpix</span><span class="op" id="4061021">[</span><span class="ident" id="4061022">x</span><span class="op" id="4061023">+</span><span class="num" id="4061024">3</span><span class="op" id="4061025">]</span>&nbsp;<span class="op" id="4061027">=</span>&nbsp;<span class="num" id="4061029">255</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4061036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4061040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061043">case</span>&nbsp;<span class="ident" id="4061048">image</span><span class="op" id="4061053">.</span><span class="ident" id="4061054">YCbCrSubsampleRatio440</span><span class="op" id="4061076">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061080">for</span>&nbsp;<span class="ident" id="4061084">y</span><span class="op" id="4061085">,</span>&nbsp;<span class="ident" id="4061087">sy</span>&nbsp;<span class="op" id="4061090">:=</span>&nbsp;<span class="ident" id="4061093">y0</span><span class="op" id="4061095">,</span>&nbsp;<span class="ident" id="4061097">sp</span><span class="op" id="4061099">.</span><span class="ident" id="4061100">Y</span><span class="op" id="4061101">;</span>&nbsp;<span class="ident" id="4061103">y</span>&nbsp;<span class="op" id="4061105">!=</span>&nbsp;<span class="ident" id="4061108">y1</span><span class="op" id="4061110">;</span>&nbsp;<span class="ident" id="4061112">y</span><span class="op" id="4061113">,</span>&nbsp;<span class="ident" id="4061115">sy</span>&nbsp;<span class="op" id="4061118">=</span>&nbsp;<span class="ident" id="4061120">y</span><span class="op" id="4061121">+</span><span class="num" id="4061122">1</span><span class="op" id="4061123">,</span>&nbsp;<span class="ident" id="4061125">sy</span><span class="op" id="4061127">+</span><span class="num" id="4061128">1</span>&nbsp;<span class="op" id="4061130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061135">dpix</span>&nbsp;<span class="op" id="4061140">:=</span>&nbsp;<span class="ident" id="4061143">dst</span><span class="op" id="4061146">.</span><span class="ident" id="4061147">Pix</span><span class="op" id="4061150">[</span><span class="ident" id="4061151">y</span><span class="op" id="4061152">*</span><span class="ident" id="4061153">dst</span><span class="op" id="4061156">.</span><span class="ident" id="4061157">Stride</span><span class="op" id="4061163">:</span><span class="op" id="4061164">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061169">yi</span>&nbsp;<span class="op" id="4061172">:=</span>&nbsp;<span class="op" id="4061175">(</span><span class="ident" id="4061176">sy</span><span class="op" id="4061178">-</span><span class="ident" id="4061179">src</span><span class="op" id="4061182">.</span><span class="ident" id="4061183">Rect</span><span class="op" id="4061187">.</span><span class="ident" id="4061188">Min</span><span class="op" id="4061191">.</span><span class="ident" id="4061192">Y</span><span class="op" id="4061193">)</span><span class="op" id="4061194">*</span><span class="ident" id="4061195">src</span><span class="op" id="4061198">.</span><span class="ident" id="4061199">YStride</span>&nbsp;<span class="op" id="4061207">+</span>&nbsp;<span class="op" id="4061209">(</span><span class="ident" id="4061210">sp</span><span class="op" id="4061212">.</span><span class="ident" id="4061213">X</span>&nbsp;<span class="op" id="4061215">-</span>&nbsp;<span class="ident" id="4061217">src</span><span class="op" id="4061220">.</span><span class="ident" id="4061221">Rect</span><span class="op" id="4061225">.</span><span class="ident" id="4061226">Min</span><span class="op" id="4061229">.</span><span class="ident" id="4061230">X</span><span class="op" id="4061231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061236">ci</span>&nbsp;<span class="op" id="4061239">:=</span>&nbsp;<span class="op" id="4061242">(</span><span class="ident" id="4061243">sy</span><span class="op" id="4061245">/</span><span class="num" id="4061246">2</span><span class="op" id="4061247">-</span><span class="ident" id="4061248">src</span><span class="op" id="4061251">.</span><span class="ident" id="4061252">Rect</span><span class="op" id="4061256">.</span><span class="ident" id="4061257">Min</span><span class="op" id="4061260">.</span><span class="ident" id="4061261">Y</span><span class="op" id="4061262">/</span><span class="num" id="4061263">2</span><span class="op" id="4061264">)</span><span class="op" id="4061265">*</span><span class="ident" id="4061266">src</span><span class="op" id="4061269">.</span><span class="ident" id="4061270">CStride</span>&nbsp;<span class="op" id="4061278">+</span>&nbsp;<span class="op" id="4061280">(</span><span class="ident" id="4061281">sp</span><span class="op" id="4061283">.</span><span class="ident" id="4061284">X</span>&nbsp;<span class="op" id="4061286">-</span>&nbsp;<span class="ident" id="4061288">src</span><span class="op" id="4061291">.</span><span class="ident" id="4061292">Rect</span><span class="op" id="4061296">.</span><span class="ident" id="4061297">Min</span><span class="op" id="4061300">.</span><span class="ident" id="4061301">X</span><span class="op" id="4061302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061307">for</span>&nbsp;<span class="ident" id="4061311">x</span>&nbsp;<span class="op" id="4061313">:=</span>&nbsp;<span class="ident" id="4061316">x0</span><span class="op" id="4061318">;</span>&nbsp;<span class="ident" id="4061320">x</span>&nbsp;<span class="op" id="4061322">!=</span>&nbsp;<span class="ident" id="4061325">x1</span><span class="op" id="4061327">;</span>&nbsp;<span class="ident" id="4061329">x</span><span class="op" id="4061330">,</span>&nbsp;<span class="ident" id="4061332">yi</span><span class="op" id="4061334">,</span>&nbsp;<span class="ident" id="4061336">ci</span>&nbsp;<span class="op" id="4061339">=</span>&nbsp;<span class="ident" id="4061341">x</span><span class="op" id="4061342">+</span><span class="num" id="4061343">4</span><span class="op" id="4061344">,</span>&nbsp;<span class="ident" id="4061346">yi</span><span class="op" id="4061348">+</span><span class="num" id="4061349">1</span><span class="op" id="4061350">,</span>&nbsp;<span class="ident" id="4061352">ci</span><span class="op" id="4061354">+</span><span class="num" id="4061355">1</span>&nbsp;<span class="op" id="4061357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061363">rr</span><span class="op" id="4061365">,</span>&nbsp;<span class="ident" id="4061367">gg</span><span class="op" id="4061369">,</span>&nbsp;<span class="ident" id="4061371">bb</span>&nbsp;<span class="op" id="4061374">:=</span>&nbsp;<span class="ident" id="4061377">color</span><span class="op" id="4061382">.</span><span class="ident" id="4061383">YCbCrToRGB</span><span class="op" id="4061393">(</span><span class="ident" id="4061394">src</span><span class="op" id="4061397">.</span><span class="ident" id="4061398">Y</span><span class="op" id="4061399">[</span><span class="ident" id="4061400">yi</span><span class="op" id="4061402">]</span><span class="op" id="4061403">,</span>&nbsp;<span class="ident" id="4061405">src</span><span class="op" id="4061408">.</span><span class="ident" id="4061409">Cb</span><span class="op" id="4061411">[</span><span class="ident" id="4061412">ci</span><span class="op" id="4061414">]</span><span class="op" id="4061415">,</span>&nbsp;<span class="ident" id="4061417">src</span><span class="op" id="4061420">.</span><span class="ident" id="4061421">Cr</span><span class="op" id="4061423">[</span><span class="ident" id="4061424">ci</span><span class="op" id="4061426">]</span><span class="op" id="4061427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061433">dpix</span><span class="op" id="4061437">[</span><span class="ident" id="4061438">x</span><span class="op" id="4061439">+</span><span class="num" id="4061440">0</span><span class="op" id="4061441">]</span>&nbsp;<span class="op" id="4061443">=</span>&nbsp;<span class="ident" id="4061445">rr</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061452">dpix</span><span class="op" id="4061456">[</span><span class="ident" id="4061457">x</span><span class="op" id="4061458">+</span><span class="num" id="4061459">1</span><span class="op" id="4061460">]</span>&nbsp;<span class="op" id="4061462">=</span>&nbsp;<span class="ident" id="4061464">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061471">dpix</span><span class="op" id="4061475">[</span><span class="ident" id="4061476">x</span><span class="op" id="4061477">+</span><span class="num" id="4061478">2</span><span class="op" id="4061479">]</span>&nbsp;<span class="op" id="4061481">=</span>&nbsp;<span class="ident" id="4061483">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061490">dpix</span><span class="op" id="4061494">[</span><span class="ident" id="4061495">x</span><span class="op" id="4061496">+</span><span class="num" id="4061497">3</span><span class="op" id="4061498">]</span>&nbsp;<span class="op" id="4061500">=</span>&nbsp;<span class="num" id="4061502">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4061509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4061513">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061516">default</span><span class="op" id="4061523">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061527">return</span>&nbsp;<span class="builtintype" id="4061534">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4061541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061544">return</span>&nbsp;<span class="builtintype" id="4061551">true</span><br>
<span class="lineno"></span><span class="op" id="4061556">}</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="4061559">func</span>&nbsp;<span class="ident" id="4061564">drawGlyphOver</span><span class="op" id="4061577">(</span><span class="ident" id="4061578">dst</span>&nbsp;<span class="op" id="4061582">*</span><span class="ident" id="4061583">image</span><span class="op" id="4061588">.</span><span class="ident" id="4061589">RGBA</span><span class="op" id="4061593">,</span>&nbsp;<span class="ident" id="4061595">r</span>&nbsp;<span class="ident" id="4061597">image</span><span class="op" id="4061602">.</span><span class="ident" id="4061603">Rectangle</span><span class="op" id="4061612">,</span>&nbsp;<span class="ident" id="4061614">src</span>&nbsp;<span class="op" id="4061618">*</span><span class="ident" id="4061619">image</span><span class="op" id="4061624">.</span><span class="ident" id="4061625">Uniform</span><span class="op" id="4061632">,</span>&nbsp;<span class="ident" id="4061634">mask</span>&nbsp;<span class="op" id="4061639">*</span><span class="ident" id="4061640">image</span><span class="op" id="4061645">.</span><span class="ident" id="4061646">Alpha</span><span class="op" id="4061651">,</span>&nbsp;<span class="ident" id="4061653">mp</span>&nbsp;<span class="ident" id="4061656">image</span><span class="op" id="4061661">.</span><span class="ident" id="4061662">Point</span><span class="op" id="4061667">)</span>&nbsp;<span class="op" id="4061669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061672">i0</span>&nbsp;<span class="op" id="4061675">:=</span>&nbsp;<span class="ident" id="4061678">dst</span><span class="op" id="4061681">.</span><span class="ident" id="4061682">PixOffset</span><span class="op" id="4061691">(</span><span class="ident" id="4061692">r</span><span class="op" id="4061693">.</span><span class="ident" id="4061694">Min</span><span class="op" id="4061697">.</span><span class="ident" id="4061698">X</span><span class="op" id="4061699">,</span>&nbsp;<span class="ident" id="4061701">r</span><span class="op" id="4061702">.</span><span class="ident" id="4061703">Min</span><span class="op" id="4061706">.</span><span class="ident" id="4061707">Y</span><span class="op" id="4061708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061711">i1</span>&nbsp;<span class="op" id="4061714">:=</span>&nbsp;<span class="ident" id="4061717">i0</span>&nbsp;<span class="op" id="4061720">+</span>&nbsp;<span class="ident" id="4061722">r</span><span class="op" id="4061723">.</span><span class="ident" id="4061724">Dx</span><span class="op" id="4061726">(</span><span class="op" id="4061727">)</span><span class="op" id="4061728">*</span><span class="num" id="4061729">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061732">mi0</span>&nbsp;<span class="op" id="4061736">:=</span>&nbsp;<span class="ident" id="4061739">mask</span><span class="op" id="4061743">.</span><span class="ident" id="4061744">PixOffset</span><span class="op" id="4061753">(</span><span class="ident" id="4061754">mp</span><span class="op" id="4061756">.</span><span class="ident" id="4061757">X</span><span class="op" id="4061758">,</span>&nbsp;<span class="ident" id="4061760">mp</span><span class="op" id="4061762">.</span><span class="ident" id="4061763">Y</span><span class="op" id="4061764">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061767">sr</span><span class="op" id="4061769">,</span>&nbsp;<span class="ident" id="4061771">sg</span><span class="op" id="4061773">,</span>&nbsp;<span class="ident" id="4061775">sb</span><span class="op" id="4061777">,</span>&nbsp;<span class="ident" id="4061779">sa</span>&nbsp;<span class="op" id="4061782">:=</span>&nbsp;<span class="ident" id="4061785">src</span><span class="op" id="4061788">.</span><span class="ident" id="4061789">RGBA</span><span class="op" id="4061793">(</span><span class="op" id="4061794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061797">for</span>&nbsp;<span class="ident" id="4061801">y</span><span class="op" id="4061802">,</span>&nbsp;<span class="ident" id="4061804">my</span>&nbsp;<span class="op" id="4061807">:=</span>&nbsp;<span class="ident" id="4061810">r</span><span class="op" id="4061811">.</span><span class="ident" id="4061812">Min</span><span class="op" id="4061815">.</span><span class="ident" id="4061816">Y</span><span class="op" id="4061817">,</span>&nbsp;<span class="ident" id="4061819">mp</span><span class="op" id="4061821">.</span><span class="ident" id="4061822">Y</span><span class="op" id="4061823">;</span>&nbsp;<span class="ident" id="4061825">y</span>&nbsp;<span class="op" id="4061827">!=</span>&nbsp;<span class="ident" id="4061830">r</span><span class="op" id="4061831">.</span><span class="ident" id="4061832">Max</span><span class="op" id="4061835">.</span><span class="ident" id="4061836">Y</span><span class="op" id="4061837">;</span>&nbsp;<span class="ident" id="4061839">y</span><span class="op" id="4061840">,</span>&nbsp;<span class="ident" id="4061842">my</span>&nbsp;<span class="op" id="4061845">=</span>&nbsp;<span class="ident" id="4061847">y</span><span class="op" id="4061848">+</span><span class="num" id="4061849">1</span><span class="op" id="4061850">,</span>&nbsp;<span class="ident" id="4061852">my</span><span class="op" id="4061854">+</span><span class="num" id="4061855">1</span>&nbsp;<span class="op" id="4061857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061861">for</span>&nbsp;<span class="ident" id="4061865">i</span><span class="op" id="4061866">,</span>&nbsp;<span class="ident" id="4061868">mi</span>&nbsp;<span class="op" id="4061871">:=</span>&nbsp;<span class="ident" id="4061874">i0</span><span class="op" id="4061876">,</span>&nbsp;<span class="ident" id="4061878">mi0</span><span class="op" id="4061881">;</span>&nbsp;<span class="ident" id="4061883">i</span>&nbsp;<span class="op" id="4061885">&lt;</span>&nbsp;<span class="ident" id="4061887">i1</span><span class="op" id="4061889">;</span>&nbsp;<span class="ident" id="4061891">i</span><span class="op" id="4061892">,</span>&nbsp;<span class="ident" id="4061894">mi</span>&nbsp;<span class="op" id="4061897">=</span>&nbsp;<span class="ident" id="4061899">i</span><span class="op" id="4061900">+</span><span class="num" id="4061901">4</span><span class="op" id="4061902">,</span>&nbsp;<span class="ident" id="4061904">mi</span><span class="op" id="4061906">+</span><span class="num" id="4061907">1</span>&nbsp;<span class="op" id="4061909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061914">ma</span>&nbsp;<span class="op" id="4061917">:=</span>&nbsp;<span class="builtintype" id="4061920">uint32</span><span class="op" id="4061926">(</span><span class="ident" id="4061927">mask</span><span class="op" id="4061931">.</span><span class="ident" id="4061932">Pix</span><span class="op" id="4061935">[</span><span class="ident" id="4061936">mi</span><span class="op" id="4061938">]</span><span class="op" id="4061939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061944">if</span>&nbsp;<span class="ident" id="4061947">ma</span>&nbsp;<span class="op" id="4061950">==</span>&nbsp;<span class="num" id="4061953">0</span>&nbsp;<span class="op" id="4061955">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4061961">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4061973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061978">ma</span>&nbsp;<span class="op" id="4061981">|=</span>&nbsp;<span class="ident" id="4061984">ma</span>&nbsp;<span class="op" id="4061987">&lt;&lt;</span>&nbsp;<span class="num" id="4061990">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4061996">dr</span>&nbsp;<span class="op" id="4061999">:=</span>&nbsp;<span class="builtintype" id="4062002">uint32</span><span class="op" id="4062008">(</span><span class="ident" id="4062009">dst</span><span class="op" id="4062012">.</span><span class="ident" id="4062013">Pix</span><span class="op" id="4062016">[</span><span class="ident" id="4062017">i</span><span class="op" id="4062018">+</span><span class="num" id="4062019">0</span><span class="op" id="4062020">]</span><span class="op" id="4062021">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062026">dg</span>&nbsp;<span class="op" id="4062029">:=</span>&nbsp;<span class="builtintype" id="4062032">uint32</span><span class="op" id="4062038">(</span><span class="ident" id="4062039">dst</span><span class="op" id="4062042">.</span><span class="ident" id="4062043">Pix</span><span class="op" id="4062046">[</span><span class="ident" id="4062047">i</span><span class="op" id="4062048">+</span><span class="num" id="4062049">1</span><span class="op" id="4062050">]</span><span class="op" id="4062051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062056">db</span>&nbsp;<span class="op" id="4062059">:=</span>&nbsp;<span class="builtintype" id="4062062">uint32</span><span class="op" id="4062068">(</span><span class="ident" id="4062069">dst</span><span class="op" id="4062072">.</span><span class="ident" id="4062073">Pix</span><span class="op" id="4062076">[</span><span class="ident" id="4062077">i</span><span class="op" id="4062078">+</span><span class="num" id="4062079">2</span><span class="op" id="4062080">]</span><span class="op" id="4062081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062086">da</span>&nbsp;<span class="op" id="4062089">:=</span>&nbsp;<span class="builtintype" id="4062092">uint32</span><span class="op" id="4062098">(</span><span class="ident" id="4062099">dst</span><span class="op" id="4062102">.</span><span class="ident" id="4062103">Pix</span><span class="op" id="4062106">[</span><span class="ident" id="4062107">i</span><span class="op" id="4062108">+</span><span class="num" id="4062109">3</span><span class="op" id="4062110">]</span><span class="op" id="4062111">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4062117">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062177">a</span>&nbsp;<span class="op" id="4062179">:=</span>&nbsp;<span class="op" id="4062182">(</span><span class="ident" id="4062183">m</span>&nbsp;<span class="op" id="4062185">-</span>&nbsp;<span class="op" id="4062187">(</span><span class="ident" id="4062188">sa</span>&nbsp;<span class="op" id="4062191">*</span>&nbsp;<span class="ident" id="4062193">ma</span>&nbsp;<span class="op" id="4062196">/</span>&nbsp;<span class="ident" id="4062198">m</span><span class="op" id="4062199">)</span><span class="op" id="4062200">)</span>&nbsp;<span class="op" id="4062202">*</span>&nbsp;<span class="num" id="4062204">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062214">dst</span><span class="op" id="4062217">.</span><span class="ident" id="4062218">Pix</span><span class="op" id="4062221">[</span><span class="ident" id="4062222">i</span><span class="op" id="4062223">+</span><span class="num" id="4062224">0</span><span class="op" id="4062225">]</span>&nbsp;<span class="op" id="4062227">=</span>&nbsp;<span class="builtintype" id="4062229">uint8</span><span class="op" id="4062234">(</span><span class="op" id="4062235">(</span><span class="ident" id="4062236">dr</span><span class="op" id="4062238">*</span><span class="ident" id="4062239">a</span>&nbsp;<span class="op" id="4062241">+</span>&nbsp;<span class="ident" id="4062243">sr</span><span class="op" id="4062245">*</span><span class="ident" id="4062246">ma</span><span class="op" id="4062248">)</span>&nbsp;<span class="op" id="4062250">/</span>&nbsp;<span class="ident" id="4062252">m</span>&nbsp;<span class="op" id="4062254">&gt;&gt;</span>&nbsp;<span class="num" id="4062257">8</span><span class="op" id="4062258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062263">dst</span><span class="op" id="4062266">.</span><span class="ident" id="4062267">Pix</span><span class="op" id="4062270">[</span><span class="ident" id="4062271">i</span><span class="op" id="4062272">+</span><span class="num" id="4062273">1</span><span class="op" id="4062274">]</span>&nbsp;<span class="op" id="4062276">=</span>&nbsp;<span class="builtintype" id="4062278">uint8</span><span class="op" id="4062283">(</span><span class="op" id="4062284">(</span><span class="ident" id="4062285">dg</span><span class="op" id="4062287">*</span><span class="ident" id="4062288">a</span>&nbsp;<span class="op" id="4062290">+</span>&nbsp;<span class="ident" id="4062292">sg</span><span class="op" id="4062294">*</span><span class="ident" id="4062295">ma</span><span class="op" id="4062297">)</span>&nbsp;<span class="op" id="4062299">/</span>&nbsp;<span class="ident" id="4062301">m</span>&nbsp;<span class="op" id="4062303">&gt;&gt;</span>&nbsp;<span class="num" id="4062306">8</span><span class="op" id="4062307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062312">dst</span><span class="op" id="4062315">.</span><span class="ident" id="4062316">Pix</span><span class="op" id="4062319">[</span><span class="ident" id="4062320">i</span><span class="op" id="4062321">+</span><span class="num" id="4062322">2</span><span class="op" id="4062323">]</span>&nbsp;<span class="op" id="4062325">=</span>&nbsp;<span class="builtintype" id="4062327">uint8</span><span class="op" id="4062332">(</span><span class="op" id="4062333">(</span><span class="ident" id="4062334">db</span><span class="op" id="4062336">*</span><span class="ident" id="4062337">a</span>&nbsp;<span class="op" id="4062339">+</span>&nbsp;<span class="ident" id="4062341">sb</span><span class="op" id="4062343">*</span><span class="ident" id="4062344">ma</span><span class="op" id="4062346">)</span>&nbsp;<span class="op" id="4062348">/</span>&nbsp;<span class="ident" id="4062350">m</span>&nbsp;<span class="op" id="4062352">&gt;&gt;</span>&nbsp;<span class="num" id="4062355">8</span><span class="op" id="4062356">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062361">dst</span><span class="op" id="4062364">.</span><span class="ident" id="4062365">Pix</span><span class="op" id="4062368">[</span><span class="ident" id="4062369">i</span><span class="op" id="4062370">+</span><span class="num" id="4062371">3</span><span class="op" id="4062372">]</span>&nbsp;<span class="op" id="4062374">=</span>&nbsp;<span class="builtintype" id="4062376">uint8</span><span class="op" id="4062381">(</span><span class="op" id="4062382">(</span><span class="ident" id="4062383">da</span><span class="op" id="4062385">*</span><span class="ident" id="4062386">a</span>&nbsp;<span class="op" id="4062388">+</span>&nbsp;<span class="ident" id="4062390">sa</span><span class="op" id="4062392">*</span><span class="ident" id="4062393">ma</span><span class="op" id="4062395">)</span>&nbsp;<span class="op" id="4062397">/</span>&nbsp;<span class="ident" id="4062399">m</span>&nbsp;<span class="op" id="4062401">&gt;&gt;</span>&nbsp;<span class="num" id="4062404">8</span><span class="op" id="4062405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4062409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062413">i0</span>&nbsp;<span class="op" id="4062416">+=</span>&nbsp;<span class="ident" id="4062419">dst</span><span class="op" id="4062422">.</span><span class="ident" id="4062423">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062432">i1</span>&nbsp;<span class="op" id="4062435">+=</span>&nbsp;<span class="ident" id="4062438">dst</span><span class="op" id="4062441">.</span><span class="ident" id="4062442">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062451">mi0</span>&nbsp;<span class="op" id="4062455">+=</span>&nbsp;<span class="ident" id="4062458">mask</span><span class="op" id="4062462">.</span><span class="ident" id="4062463">Stride</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4062471">}</span><br>
<span class="lineno"></span><span class="op" id="4062473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4062476">func</span>&nbsp;<span class="ident" id="4062481">drawRGBA</span><span class="op" id="4062489">(</span><span class="ident" id="4062490">dst</span>&nbsp;<span class="op" id="4062494">*</span><span class="ident" id="4062495">image</span><span class="op" id="4062500">.</span><span class="ident" id="4062501">RGBA</span><span class="op" id="4062505">,</span>&nbsp;<span class="ident" id="4062507">r</span>&nbsp;<span class="ident" id="4062509">image</span><span class="op" id="4062514">.</span><span class="ident" id="4062515">Rectangle</span><span class="op" id="4062524">,</span>&nbsp;<span class="ident" id="4062526">src</span>&nbsp;<span class="ident" id="4062530">image</span><span class="op" id="4062535">.</span><span class="ident" id="4062536">Image</span><span class="op" id="4062541">,</span>&nbsp;<span class="ident" id="4062543">sp</span>&nbsp;<span class="ident" id="4062546">image</span><span class="op" id="4062551">.</span><span class="ident" id="4062552">Point</span><span class="op" id="4062557">,</span>&nbsp;<span class="ident" id="4062559">mask</span>&nbsp;<span class="ident" id="4062564">image</span><span class="op" id="4062569">.</span><span class="ident" id="4062570">Image</span><span class="op" id="4062575">,</span>&nbsp;<span class="ident" id="4062577">mp</span>&nbsp;<span class="ident" id="4062580">image</span><span class="op" id="4062585">.</span><span class="ident" id="4062586">Point</span><span class="op" id="4062591">,</span>&nbsp;<span class="ident" id="4062593">op</span>&nbsp;<span class="ident" id="4062596">Op</span><span class="op" id="4062598">)</span>&nbsp;<span class="op" id="4062600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062603">x0</span><span class="op" id="4062605">,</span>&nbsp;<span class="ident" id="4062607">x1</span><span class="op" id="4062609">,</span>&nbsp;<span class="ident" id="4062611">dx</span>&nbsp;<span class="op" id="4062614">:=</span>&nbsp;<span class="ident" id="4062617">r</span><span class="op" id="4062618">.</span><span class="ident" id="4062619">Min</span><span class="op" id="4062622">.</span><span class="ident" id="4062623">X</span><span class="op" id="4062624">,</span>&nbsp;<span class="ident" id="4062626">r</span><span class="op" id="4062627">.</span><span class="ident" id="4062628">Max</span><span class="op" id="4062631">.</span><span class="ident" id="4062632">X</span><span class="op" id="4062633">,</span>&nbsp;<span class="num" id="4062635">1</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062638">y0</span><span class="op" id="4062640">,</span>&nbsp;<span class="ident" id="4062642">y1</span><span class="op" id="4062644">,</span>&nbsp;<span class="ident" id="4062646">dy</span>&nbsp;<span class="op" id="4062649">:=</span>&nbsp;<span class="ident" id="4062652">r</span><span class="op" id="4062653">.</span><span class="ident" id="4062654">Min</span><span class="op" id="4062657">.</span><span class="ident" id="4062658">Y</span><span class="op" id="4062659">,</span>&nbsp;<span class="ident" id="4062661">r</span><span class="op" id="4062662">.</span><span class="ident" id="4062663">Max</span><span class="op" id="4062666">.</span><span class="ident" id="4062667">Y</span><span class="op" id="4062668">,</span>&nbsp;<span class="num" id="4062670">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062673">if</span>&nbsp;<span class="ident" id="4062676">image</span><span class="op" id="4062681">.</span><span class="ident" id="4062682">Image</span><span class="op" id="4062687">(</span><span class="ident" id="4062688">dst</span><span class="op" id="4062691">)</span>&nbsp;<span class="op" id="4062693">==</span>&nbsp;<span class="ident" id="4062696">src</span>&nbsp;<span class="op" id="4062700">&amp;&amp;</span>&nbsp;<span class="ident" id="4062703">r</span><span class="op" id="4062704">.</span><span class="ident" id="4062705">Overlaps</span><span class="op" id="4062713">(</span><span class="ident" id="4062714">r</span><span class="op" id="4062715">.</span><span class="ident" id="4062716">Add</span><span class="op" id="4062719">(</span><span class="ident" id="4062720">sp</span><span class="op" id="4062722">.</span><span class="ident" id="4062723">Sub</span><span class="op" id="4062726">(</span><span class="ident" id="4062727">r</span><span class="op" id="4062728">.</span><span class="ident" id="4062729">Min</span><span class="op" id="4062732">)</span><span class="op" id="4062733">)</span><span class="op" id="4062734">)</span>&nbsp;<span class="op" id="4062736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4062740">if</span>&nbsp;<span class="ident" id="4062743">sp</span><span class="op" id="4062745">.</span><span class="ident" id="4062746">Y</span>&nbsp;<span class="op" id="4062748">&lt;</span>&nbsp;<span class="ident" id="4062750">r</span><span class="op" id="4062751">.</span><span class="ident" id="4062752">Min</span><span class="op" id="4062755">.</span><span class="ident" id="4062756">Y</span>&nbsp;<span class="op" id="4062758">||</span>&nbsp;<span class="ident" id="4062761">sp</span><span class="op" id="4062763">.</span><span class="ident" id="4062764">Y</span>&nbsp;<span class="op" id="4062766">==</span>&nbsp;<span class="ident" id="4062769">r</span><span class="op" id="4062770">.</span><span class="ident" id="4062771">Min</span><span class="op" id="4062774">.</span><span class="ident" id="4062775">Y</span>&nbsp;<span class="op" id="4062777">&amp;&amp;</span>&nbsp;<span class="ident" id="4062780">sp</span><span class="op" id="4062782">.</span><span class="ident" id="4062783">X</span>&nbsp;<span class="op" id="4062785">&lt;</span>&nbsp;<span class="ident" id="4062787">r</span><span class="op" id="4062788">.</span><span class="ident" id="4062789">Min</span><span class="op" id="4062792">.</span><span class="ident" id="4062793">X</span>&nbsp;<span class="op" id="4062795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062800">x0</span><span class="op" id="4062802">,</span>&nbsp;<span class="ident" id="4062804">x1</span><span class="op" id="4062806">,</span>&nbsp;<span class="ident" id="4062808">dx</span>&nbsp;<span class="op" id="4062811">=</span>&nbsp;<span class="ident" id="4062813">x1</span><span class="op" id="4062815">-</span><span class="num" id="4062816">1</span><span class="op" id="4062817">,</span>&nbsp;<span class="ident" id="4062819">x0</span><span class="op" id="4062821">-</span><span class="num" id="4062822">1</span><span class="op" id="4062823">,</span>&nbsp;<span class="op" id="4062825">-</span><span class="num" id="4062826">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062831">y0</span><span class="op" id="4062833">,</span>&nbsp;<span class="ident" id="4062835">y1</span><span class="op" id="4062837">,</span>&nbsp;<span class="ident" id="4062839">dy</span>&nbsp;<span class="op" id="4062842">=</span>&nbsp;<span class="ident" id="4062844">y1</span><span class="op" id="4062846">-</span><span class="num" id="4062847">1</span><span class="op" id="4062848">,</span>&nbsp;<span class="ident" id="4062850">y0</span><span class="op" id="4062852">-</span><span class="num" id="4062853">1</span><span class="op" id="4062854">,</span>&nbsp;<span class="op" id="4062856">-</span><span class="num" id="4062857">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4062861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4062864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062868">sy</span>&nbsp;<span class="op" id="4062871">:=</span>&nbsp;<span class="ident" id="4062874">sp</span><span class="op" id="4062876">.</span><span class="ident" id="4062877">Y</span>&nbsp;<span class="op" id="4062879">+</span>&nbsp;<span class="ident" id="4062881">y0</span>&nbsp;<span class="op" id="4062884">-</span>&nbsp;<span class="ident" id="4062886">r</span><span class="op" id="4062887">.</span><span class="ident" id="4062888">Min</span><span class="op" id="4062891">.</span><span class="ident" id="4062892">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062895">my</span>&nbsp;<span class="op" id="4062898">:=</span>&nbsp;<span class="ident" id="4062901">mp</span><span class="op" id="4062903">.</span><span class="ident" id="4062904">Y</span>&nbsp;<span class="op" id="4062906">+</span>&nbsp;<span class="ident" id="4062908">y0</span>&nbsp;<span class="op" id="4062911">-</span>&nbsp;<span class="ident" id="4062913">r</span><span class="op" id="4062914">.</span><span class="ident" id="4062915">Min</span><span class="op" id="4062918">.</span><span class="ident" id="4062919">Y</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062922">sx0</span>&nbsp;<span class="op" id="4062926">:=</span>&nbsp;<span class="ident" id="4062929">sp</span><span class="op" id="4062931">.</span><span class="ident" id="4062932">X</span>&nbsp;<span class="op" id="4062934">+</span>&nbsp;<span class="ident" id="4062936">x0</span>&nbsp;<span class="op" id="4062939">-</span>&nbsp;<span class="ident" id="4062941">r</span><span class="op" id="4062942">.</span><span class="ident" id="4062943">Min</span><span class="op" id="4062946">.</span><span class="ident" id="4062947">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062950">mx0</span>&nbsp;<span class="op" id="4062954">:=</span>&nbsp;<span class="ident" id="4062957">mp</span><span class="op" id="4062959">.</span><span class="ident" id="4062960">X</span>&nbsp;<span class="op" id="4062962">+</span>&nbsp;<span class="ident" id="4062964">x0</span>&nbsp;<span class="op" id="4062967">-</span>&nbsp;<span class="ident" id="4062969">r</span><span class="op" id="4062970">.</span><span class="ident" id="4062971">Min</span><span class="op" id="4062974">.</span><span class="ident" id="4062975">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4062978">sx1</span>&nbsp;<span class="op" id="4062982">:=</span>&nbsp;<span class="ident" id="4062985">sx0</span>&nbsp;<span class="op" id="4062989">+</span>&nbsp;<span class="op" id="4062991">(</span><span class="ident" id="4062992">x1</span>&nbsp;<span class="op" id="4062995">-</span>&nbsp;<span class="ident" id="4062997">x0</span><span class="op" id="4062999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063002">i0</span>&nbsp;<span class="op" id="4063005">:=</span>&nbsp;<span class="ident" id="4063008">dst</span><span class="op" id="4063011">.</span><span class="ident" id="4063012">PixOffset</span><span class="op" id="4063021">(</span><span class="ident" id="4063022">x0</span><span class="op" id="4063024">,</span>&nbsp;<span class="ident" id="4063026">y0</span><span class="op" id="4063028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063031">di</span>&nbsp;<span class="op" id="4063034">:=</span>&nbsp;<span class="ident" id="4063037">dx</span>&nbsp;<span class="op" id="4063040">*</span>&nbsp;<span class="num" id="4063042">4</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063045">for</span>&nbsp;<span class="ident" id="4063049">y</span>&nbsp;<span class="op" id="4063051">:=</span>&nbsp;<span class="ident" id="4063054">y0</span><span class="op" id="4063056">;</span>&nbsp;<span class="ident" id="4063058">y</span>&nbsp;<span class="op" id="4063060">!=</span>&nbsp;<span class="ident" id="4063063">y1</span><span class="op" id="4063065">;</span>&nbsp;<span class="ident" id="4063067">y</span><span class="op" id="4063068">,</span>&nbsp;<span class="ident" id="4063070">sy</span><span class="op" id="4063072">,</span>&nbsp;<span class="ident" id="4063074">my</span>&nbsp;<span class="op" id="4063077">=</span>&nbsp;<span class="ident" id="4063079">y</span><span class="op" id="4063080">+</span><span class="ident" id="4063081">dy</span><span class="op" id="4063083">,</span>&nbsp;<span class="ident" id="4063085">sy</span><span class="op" id="4063087">+</span><span class="ident" id="4063088">dy</span><span class="op" id="4063090">,</span>&nbsp;<span class="ident" id="4063092">my</span><span class="op" id="4063094">+</span><span class="ident" id="4063095">dy</span>&nbsp;<span class="op" id="4063098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063102">for</span>&nbsp;<span class="ident" id="4063106">i</span><span class="op" id="4063107">,</span>&nbsp;<span class="ident" id="4063109">sx</span><span class="op" id="4063111">,</span>&nbsp;<span class="ident" id="4063113">mx</span>&nbsp;<span class="op" id="4063116">:=</span>&nbsp;<span class="ident" id="4063119">i0</span><span class="op" id="4063121">,</span>&nbsp;<span class="ident" id="4063123">sx0</span><span class="op" id="4063126">,</span>&nbsp;<span class="ident" id="4063128">mx0</span><span class="op" id="4063131">;</span>&nbsp;<span class="ident" id="4063133">sx</span>&nbsp;<span class="op" id="4063136">!=</span>&nbsp;<span class="ident" id="4063139">sx1</span><span class="op" id="4063142">;</span>&nbsp;<span class="ident" id="4063144">i</span><span class="op" id="4063145">,</span>&nbsp;<span class="ident" id="4063147">sx</span><span class="op" id="4063149">,</span>&nbsp;<span class="ident" id="4063151">mx</span>&nbsp;<span class="op" id="4063154">=</span>&nbsp;<span class="ident" id="4063156">i</span><span class="op" id="4063157">+</span><span class="ident" id="4063158">di</span><span class="op" id="4063160">,</span>&nbsp;<span class="ident" id="4063162">sx</span><span class="op" id="4063164">+</span><span class="ident" id="4063165">dx</span><span class="op" id="4063167">,</span>&nbsp;<span class="ident" id="4063169">mx</span><span class="op" id="4063171">+</span><span class="ident" id="4063172">dx</span>&nbsp;<span class="op" id="4063175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063180">ma</span>&nbsp;<span class="op" id="4063183">:=</span>&nbsp;<span class="builtintype" id="4063186">uint32</span><span class="op" id="4063192">(</span><span class="ident" id="4063193">m</span><span class="op" id="4063194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063199">if</span>&nbsp;<span class="ident" id="4063202">mask</span>&nbsp;<span class="op" id="4063207">!=</span>&nbsp;<span class="ident" id="4063210">nil</span>&nbsp;<span class="op" id="4063214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063220">_</span><span class="op" id="4063221">,</span>&nbsp;<span class="ident" id="4063223">_</span><span class="op" id="4063224">,</span>&nbsp;<span class="ident" id="4063226">_</span><span class="op" id="4063227">,</span>&nbsp;<span class="ident" id="4063229">ma</span>&nbsp;<span class="op" id="4063232">=</span>&nbsp;<span class="ident" id="4063234">mask</span><span class="op" id="4063238">.</span><span class="ident" id="4063239">At</span><span class="op" id="4063241">(</span><span class="ident" id="4063242">mx</span><span class="op" id="4063244">,</span>&nbsp;<span class="ident" id="4063246">my</span><span class="op" id="4063248">)</span><span class="op" id="4063249">.</span><span class="ident" id="4063250">RGBA</span><span class="op" id="4063254">(</span><span class="op" id="4063255">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4063260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063265">sr</span><span class="op" id="4063267">,</span>&nbsp;<span class="ident" id="4063269">sg</span><span class="op" id="4063271">,</span>&nbsp;<span class="ident" id="4063273">sb</span><span class="op" id="4063275">,</span>&nbsp;<span class="ident" id="4063277">sa</span>&nbsp;<span class="op" id="4063280">:=</span>&nbsp;<span class="ident" id="4063283">src</span><span class="op" id="4063286">.</span><span class="ident" id="4063287">At</span><span class="op" id="4063289">(</span><span class="ident" id="4063290">sx</span><span class="op" id="4063292">,</span>&nbsp;<span class="ident" id="4063294">sy</span><span class="op" id="4063296">)</span><span class="op" id="4063297">.</span><span class="ident" id="4063298">RGBA</span><span class="op" id="4063302">(</span><span class="op" id="4063303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4063308">if</span>&nbsp;<span class="ident" id="4063311">op</span>&nbsp;<span class="op" id="4063314">==</span>&nbsp;<span class="ident" id="4063317">Over</span>&nbsp;<span class="op" id="4063322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063328">dr</span>&nbsp;<span class="op" id="4063331">:=</span>&nbsp;<span class="builtintype" id="4063334">uint32</span><span class="op" id="4063340">(</span><span class="ident" id="4063341">dst</span><span class="op" id="4063344">.</span><span class="ident" id="4063345">Pix</span><span class="op" id="4063348">[</span><span class="ident" id="4063349">i</span><span class="op" id="4063350">+</span><span class="num" id="4063351">0</span><span class="op" id="4063352">]</span><span class="op" id="4063353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063359">dg</span>&nbsp;<span class="op" id="4063362">:=</span>&nbsp;<span class="builtintype" id="4063365">uint32</span><span class="op" id="4063371">(</span><span class="ident" id="4063372">dst</span><span class="op" id="4063375">.</span><span class="ident" id="4063376">Pix</span><span class="op" id="4063379">[</span><span class="ident" id="4063380">i</span><span class="op" id="4063381">+</span><span class="num" id="4063382">1</span><span class="op" id="4063383">]</span><span class="op" id="4063384">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063390">db</span>&nbsp;<span class="op" id="4063393">:=</span>&nbsp;<span class="builtintype" id="4063396">uint32</span><span class="op" id="4063402">(</span><span class="ident" id="4063403">dst</span><span class="op" id="4063406">.</span><span class="ident" id="4063407">Pix</span><span class="op" id="4063410">[</span><span class="ident" id="4063411">i</span><span class="op" id="4063412">+</span><span class="num" id="4063413">2</span><span class="op" id="4063414">]</span><span class="op" id="4063415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063421">da</span>&nbsp;<span class="op" id="4063424">:=</span>&nbsp;<span class="builtintype" id="4063427">uint32</span><span class="op" id="4063433">(</span><span class="ident" id="4063434">dst</span><span class="op" id="4063437">.</span><span class="ident" id="4063438">Pix</span><span class="op" id="4063441">[</span><span class="ident" id="4063442">i</span><span class="op" id="4063443">+</span><span class="num" id="4063444">3</span><span class="op" id="4063445">]</span><span class="op" id="4063446">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4063453">//&nbsp;dr,&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da&nbsp;are&nbsp;all&nbsp;8-bit&nbsp;color&nbsp;at&nbsp;the&nbsp;moment,&nbsp;ranging&nbsp;in&nbsp;[0,255].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4063533">//&nbsp;We&nbsp;work&nbsp;in&nbsp;16-bit&nbsp;color,&nbsp;and&nbsp;so&nbsp;would&nbsp;normally&nbsp;do:</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4063591">//&nbsp;dr&nbsp;|=&nbsp;dr&nbsp;&lt;&lt;&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4063612">//&nbsp;and&nbsp;similarly&nbsp;for&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da,&nbsp;but&nbsp;instead&nbsp;we&nbsp;multiply&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4063678">//&nbsp;(which&nbsp;is&nbsp;a&nbsp;16-bit&nbsp;color,&nbsp;ranging&nbsp;in&nbsp;[0,65535])&nbsp;by&nbsp;0x101.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4063743">//&nbsp;This&nbsp;yields&nbsp;the&nbsp;same&nbsp;result,&nbsp;but&nbsp;is&nbsp;fewer&nbsp;arithmetic&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063815">a</span>&nbsp;<span class="op" id="4063817">:=</span>&nbsp;<span class="op" id="4063820">(</span><span class="ident" id="4063821">m</span>&nbsp;<span class="op" id="4063823">-</span>&nbsp;<span class="op" id="4063825">(</span><span class="ident" id="4063826">sa</span>&nbsp;<span class="op" id="4063829">*</span>&nbsp;<span class="ident" id="4063831">ma</span>&nbsp;<span class="op" id="4063834">/</span>&nbsp;<span class="ident" id="4063836">m</span><span class="op" id="4063837">)</span><span class="op" id="4063838">)</span>&nbsp;<span class="op" id="4063840">*</span>&nbsp;<span class="num" id="4063842">0x101</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063853">dst</span><span class="op" id="4063856">.</span><span class="ident" id="4063857">Pix</span><span class="op" id="4063860">[</span><span class="ident" id="4063861">i</span><span class="op" id="4063862">+</span><span class="num" id="4063863">0</span><span class="op" id="4063864">]</span>&nbsp;<span class="op" id="4063866">=</span>&nbsp;<span class="builtintype" id="4063868">uint8</span><span class="op" id="4063873">(</span><span class="op" id="4063874">(</span><span class="ident" id="4063875">dr</span><span class="op" id="4063877">*</span><span class="ident" id="4063878">a</span>&nbsp;<span class="op" id="4063880">+</span>&nbsp;<span class="ident" id="4063882">sr</span><span class="op" id="4063884">*</span><span class="ident" id="4063885">ma</span><span class="op" id="4063887">)</span>&nbsp;<span class="op" id="4063889">/</span>&nbsp;<span class="ident" id="4063891">m</span>&nbsp;<span class="op" id="4063893">&gt;&gt;</span>&nbsp;<span class="num" id="4063896">8</span><span class="op" id="4063897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063903">dst</span><span class="op" id="4063906">.</span><span class="ident" id="4063907">Pix</span><span class="op" id="4063910">[</span><span class="ident" id="4063911">i</span><span class="op" id="4063912">+</span><span class="num" id="4063913">1</span><span class="op" id="4063914">]</span>&nbsp;<span class="op" id="4063916">=</span>&nbsp;<span class="builtintype" id="4063918">uint8</span><span class="op" id="4063923">(</span><span class="op" id="4063924">(</span><span class="ident" id="4063925">dg</span><span class="op" id="4063927">*</span><span class="ident" id="4063928">a</span>&nbsp;<span class="op" id="4063930">+</span>&nbsp;<span class="ident" id="4063932">sg</span><span class="op" id="4063934">*</span><span class="ident" id="4063935">ma</span><span class="op" id="4063937">)</span>&nbsp;<span class="op" id="4063939">/</span>&nbsp;<span class="ident" id="4063941">m</span>&nbsp;<span class="op" id="4063943">&gt;&gt;</span>&nbsp;<span class="num" id="4063946">8</span><span class="op" id="4063947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4063953">dst</span><span class="op" id="4063956">.</span><span class="ident" id="4063957">Pix</span><span class="op" id="4063960">[</span><span class="ident" id="4063961">i</span><span class="op" id="4063962">+</span><span class="num" id="4063963">2</span><span class="op" id="4063964">]</span>&nbsp;<span class="op" id="4063966">=</span>&nbsp;<span class="builtintype" id="4063968">uint8</span><span class="op" id="4063973">(</span><span class="op" id="4063974">(</span><span class="ident" id="4063975">db</span><span class="op" id="4063977">*</span><span class="ident" id="4063978">a</span>&nbsp;<span class="op" id="4063980">+</span>&nbsp;<span class="ident" id="4063982">sb</span><span class="op" id="4063984">*</span><span class="ident" id="4063985">ma</span><span class="op" id="4063987">)</span>&nbsp;<span class="op" id="4063989">/</span>&nbsp;<span class="ident" id="4063991">m</span>&nbsp;<span class="op" id="4063993">&gt;&gt;</span>&nbsp;<span class="num" id="4063996">8</span><span class="op" id="4063997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064003">dst</span><span class="op" id="4064006">.</span><span class="ident" id="4064007">Pix</span><span class="op" id="4064010">[</span><span class="ident" id="4064011">i</span><span class="op" id="4064012">+</span><span class="num" id="4064013">3</span><span class="op" id="4064014">]</span>&nbsp;<span class="op" id="4064016">=</span>&nbsp;<span class="builtintype" id="4064018">uint8</span><span class="op" id="4064023">(</span><span class="op" id="4064024">(</span><span class="ident" id="4064025">da</span><span class="op" id="4064027">*</span><span class="ident" id="4064028">a</span>&nbsp;<span class="op" id="4064030">+</span>&nbsp;<span class="ident" id="4064032">sa</span><span class="op" id="4064034">*</span><span class="ident" id="4064035">ma</span><span class="op" id="4064037">)</span>&nbsp;<span class="op" id="4064039">/</span>&nbsp;<span class="ident" id="4064041">m</span>&nbsp;<span class="op" id="4064043">&gt;&gt;</span>&nbsp;<span class="num" id="4064046">8</span><span class="op" id="4064047">)</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4064053">}</span>&nbsp;<span class="keyword" id="4064055">else</span>&nbsp;<span class="op" id="4064060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064066">dst</span><span class="op" id="4064069">.</span><span class="ident" id="4064070">Pix</span><span class="op" id="4064073">[</span><span class="ident" id="4064074">i</span><span class="op" id="4064075">+</span><span class="num" id="4064076">0</span><span class="op" id="4064077">]</span>&nbsp;<span class="op" id="4064079">=</span>&nbsp;<span class="builtintype" id="4064081">uint8</span><span class="op" id="4064086">(</span><span class="ident" id="4064087">sr</span>&nbsp;<span class="op" id="4064090">*</span>&nbsp;<span class="ident" id="4064092">ma</span>&nbsp;<span class="op" id="4064095">/</span>&nbsp;<span class="ident" id="4064097">m</span>&nbsp;<span class="op" id="4064099">&gt;&gt;</span>&nbsp;<span class="num" id="4064102">8</span><span class="op" id="4064103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064109">dst</span><span class="op" id="4064112">.</span><span class="ident" id="4064113">Pix</span><span class="op" id="4064116">[</span><span class="ident" id="4064117">i</span><span class="op" id="4064118">+</span><span class="num" id="4064119">1</span><span class="op" id="4064120">]</span>&nbsp;<span class="op" id="4064122">=</span>&nbsp;<span class="builtintype" id="4064124">uint8</span><span class="op" id="4064129">(</span><span class="ident" id="4064130">sg</span>&nbsp;<span class="op" id="4064133">*</span>&nbsp;<span class="ident" id="4064135">ma</span>&nbsp;<span class="op" id="4064138">/</span>&nbsp;<span class="ident" id="4064140">m</span>&nbsp;<span class="op" id="4064142">&gt;&gt;</span>&nbsp;<span class="num" id="4064145">8</span><span class="op" id="4064146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064152">dst</span><span class="op" id="4064155">.</span><span class="ident" id="4064156">Pix</span><span class="op" id="4064159">[</span><span class="ident" id="4064160">i</span><span class="op" id="4064161">+</span><span class="num" id="4064162">2</span><span class="op" id="4064163">]</span>&nbsp;<span class="op" id="4064165">=</span>&nbsp;<span class="builtintype" id="4064167">uint8</span><span class="op" id="4064172">(</span><span class="ident" id="4064173">sb</span>&nbsp;<span class="op" id="4064176">*</span>&nbsp;<span class="ident" id="4064178">ma</span>&nbsp;<span class="op" id="4064181">/</span>&nbsp;<span class="ident" id="4064183">m</span>&nbsp;<span class="op" id="4064185">&gt;&gt;</span>&nbsp;<span class="num" id="4064188">8</span><span class="op" id="4064189">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064195">dst</span><span class="op" id="4064198">.</span><span class="ident" id="4064199">Pix</span><span class="op" id="4064202">[</span><span class="ident" id="4064203">i</span><span class="op" id="4064204">+</span><span class="num" id="4064205">3</span><span class="op" id="4064206">]</span>&nbsp;<span class="op" id="4064208">=</span>&nbsp;<span class="builtintype" id="4064210">uint8</span><span class="op" id="4064215">(</span><span class="ident" id="4064216">sa</span>&nbsp;<span class="op" id="4064219">*</span>&nbsp;<span class="ident" id="4064221">ma</span>&nbsp;<span class="op" id="4064224">/</span>&nbsp;<span class="ident" id="4064226">m</span>&nbsp;<span class="op" id="4064228">&gt;&gt;</span>&nbsp;<span class="num" id="4064231">8</span><span class="op" id="4064232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4064237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4064241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064245">i0</span>&nbsp;<span class="op" id="4064248">+=</span>&nbsp;<span class="ident" id="4064251">dy</span>&nbsp;<span class="op" id="4064254">*</span>&nbsp;<span class="ident" id="4064256">dst</span><span class="op" id="4064259">.</span><span class="ident" id="4064260">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4064268">}</span><br>
<span class="lineno">545</span><span class="op" id="4064270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4064273">//&nbsp;clamp&nbsp;clamps&nbsp;i&nbsp;to&nbsp;the&nbsp;interval&nbsp;[0,&nbsp;0xffff].</span><br>
<span class="lineno"></span><span class="keyword" id="4064320">func</span>&nbsp;<span class="ident" id="4064325">clamp</span><span class="op" id="4064330">(</span><span class="ident" id="4064331">i</span>&nbsp;<span class="builtintype" id="4064333">int32</span><span class="op" id="4064338">)</span>&nbsp;<span class="builtintype" id="4064340">int32</span>&nbsp;<span class="op" id="4064346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4064349">if</span>&nbsp;<span class="ident" id="4064352">i</span>&nbsp;<span class="op" id="4064354">&lt;</span>&nbsp;<span class="num" id="4064356">0</span>&nbsp;<span class="op" id="4064358">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4064362">return</span>&nbsp;<span class="num" id="4064369">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4064372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4064375">if</span>&nbsp;<span class="ident" id="4064378">i</span>&nbsp;<span class="op" id="4064380">&gt;</span>&nbsp;<span class="num" id="4064382">0xffff</span>&nbsp;<span class="op" id="4064389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4064393">return</span>&nbsp;<span class="num" id="4064400">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4064408">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4064411">return</span>&nbsp;<span class="ident" id="4064418">i</span><br>
<span class="lineno"></span><span class="op" id="4064420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4064423">func</span>&nbsp;<span class="ident" id="4064428">drawPaletted</span><span class="op" id="4064440">(</span><span class="ident" id="4064441">dst</span>&nbsp;<span class="ident" id="4064445">Image</span><span class="op" id="4064450">,</span>&nbsp;<span class="ident" id="4064452">r</span>&nbsp;<span class="ident" id="4064454">image</span><span class="op" id="4064459">.</span><span class="ident" id="4064460">Rectangle</span><span class="op" id="4064469">,</span>&nbsp;<span class="ident" id="4064471">src</span>&nbsp;<span class="ident" id="4064475">image</span><span class="op" id="4064480">.</span><span class="ident" id="4064481">Image</span><span class="op" id="4064486">,</span>&nbsp;<span class="ident" id="4064488">sp</span>&nbsp;<span class="ident" id="4064491">image</span><span class="op" id="4064496">.</span><span class="ident" id="4064497">Point</span><span class="op" id="4064502">,</span>&nbsp;<span class="ident" id="4064504">floydSteinberg</span>&nbsp;<span class="builtintype" id="4064519">bool</span><span class="op" id="4064523">)</span>&nbsp;<span class="op" id="4064525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4064528">//&nbsp;TODO(nigeltao):&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;dst&nbsp;and&nbsp;src&nbsp;overlap.</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4064595">//&nbsp;Does&nbsp;it&nbsp;even&nbsp;make&nbsp;sense&nbsp;to&nbsp;try&nbsp;and&nbsp;do&nbsp;Floyd-Steinberg&nbsp;whilst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4064660">//&nbsp;walking&nbsp;the&nbsp;image&nbsp;backward&nbsp;(right-to-left&nbsp;bottom-to-top)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4064723">//&nbsp;If&nbsp;dst&nbsp;is&nbsp;an&nbsp;*image.Paletted,&nbsp;we&nbsp;have&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;dst.Set&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4064793">//&nbsp;dst.At.&nbsp;The&nbsp;dst.Set&nbsp;equivalent&nbsp;is&nbsp;a&nbsp;batch&nbsp;version&nbsp;of&nbsp;the&nbsp;algorithm</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4064864">//&nbsp;used&nbsp;by&nbsp;color.Palette&#39;s&nbsp;Index&nbsp;method&nbsp;in&nbsp;image/color/color.go,&nbsp;plus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4064935">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error&nbsp;diffusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4064981">palette</span><span class="op" id="4064988">,</span>&nbsp;<span class="ident" id="4064990">pix</span><span class="op" id="4064993">,</span>&nbsp;<span class="ident" id="4064995">stride</span>&nbsp;<span class="op" id="4065002">:=</span>&nbsp;<span class="op" id="4065005">[</span><span class="op" id="4065006">]</span><span class="op" id="4065007">[</span><span class="num" id="4065008">3</span><span class="op" id="4065009">]</span><span class="builtintype" id="4065010">int32</span><span class="op" id="4065015">(</span><span class="ident" id="4065016">nil</span><span class="op" id="4065019">)</span><span class="op" id="4065020">,</span>&nbsp;<span class="op" id="4065022">[</span><span class="op" id="4065023">]</span><span class="builtintype" id="4065024">byte</span><span class="op" id="4065028">(</span><span class="ident" id="4065029">nil</span><span class="op" id="4065032">)</span><span class="op" id="4065033">,</span>&nbsp;<span class="num" id="4065035">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065038">if</span>&nbsp;<span class="ident" id="4065041">p</span><span class="op" id="4065042">,</span>&nbsp;<span class="ident" id="4065044">ok</span>&nbsp;<span class="op" id="4065047">:=</span>&nbsp;<span class="ident" id="4065050">dst</span><span class="op" id="4065053">.</span><span class="op" id="4065054">(</span><span class="op" id="4065055">*</span><span class="ident" id="4065056">image</span><span class="op" id="4065061">.</span><span class="ident" id="4065062">Paletted</span><span class="op" id="4065070">)</span><span class="op" id="4065071">;</span>&nbsp;<span class="ident" id="4065073">ok</span>&nbsp;<span class="op" id="4065076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065080">palette</span>&nbsp;<span class="op" id="4065088">=</span>&nbsp;<span class="builtinfunc" id="4065090">make</span><span class="op" id="4065094">(</span><span class="op" id="4065095">[</span><span class="op" id="4065096">]</span><span class="op" id="4065097">[</span><span class="num" id="4065098">3</span><span class="op" id="4065099">]</span><span class="builtintype" id="4065100">int32</span><span class="op" id="4065105">,</span>&nbsp;<span class="builtinfunc" id="4065107">len</span><span class="op" id="4065110">(</span><span class="ident" id="4065111">p</span><span class="op" id="4065112">.</span><span class="ident" id="4065113">Palette</span><span class="op" id="4065120">)</span><span class="op" id="4065121">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065125">for</span>&nbsp;<span class="ident" id="4065129">i</span><span class="op" id="4065130">,</span>&nbsp;<span class="ident" id="4065132">col</span>&nbsp;<span class="op" id="4065136">:=</span>&nbsp;<span class="keyword" id="4065139">range</span>&nbsp;<span class="ident" id="4065145">p</span><span class="op" id="4065146">.</span><span class="ident" id="4065147">Palette</span>&nbsp;<span class="op" id="4065155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065160">r</span><span class="op" id="4065161">,</span>&nbsp;<span class="ident" id="4065163">g</span><span class="op" id="4065164">,</span>&nbsp;<span class="ident" id="4065166">b</span><span class="op" id="4065167">,</span>&nbsp;<span class="ident" id="4065169">_</span>&nbsp;<span class="op" id="4065171">:=</span>&nbsp;<span class="ident" id="4065174">col</span><span class="op" id="4065177">.</span><span class="ident" id="4065178">RGBA</span><span class="op" id="4065182">(</span><span class="op" id="4065183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065188">palette</span><span class="op" id="4065195">[</span><span class="ident" id="4065196">i</span><span class="op" id="4065197">]</span><span class="op" id="4065198">[</span><span class="num" id="4065199">0</span><span class="op" id="4065200">]</span>&nbsp;<span class="op" id="4065202">=</span>&nbsp;<span class="builtintype" id="4065204">int32</span><span class="op" id="4065209">(</span><span class="ident" id="4065210">r</span><span class="op" id="4065211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065216">palette</span><span class="op" id="4065223">[</span><span class="ident" id="4065224">i</span><span class="op" id="4065225">]</span><span class="op" id="4065226">[</span><span class="num" id="4065227">1</span><span class="op" id="4065228">]</span>&nbsp;<span class="op" id="4065230">=</span>&nbsp;<span class="builtintype" id="4065232">int32</span><span class="op" id="4065237">(</span><span class="ident" id="4065238">g</span><span class="op" id="4065239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065244">palette</span><span class="op" id="4065251">[</span><span class="ident" id="4065252">i</span><span class="op" id="4065253">]</span><span class="op" id="4065254">[</span><span class="num" id="4065255">2</span><span class="op" id="4065256">]</span>&nbsp;<span class="op" id="4065258">=</span>&nbsp;<span class="builtintype" id="4065260">int32</span><span class="op" id="4065265">(</span><span class="ident" id="4065266">b</span><span class="op" id="4065267">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4065271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065275">pix</span><span class="op" id="4065278">,</span>&nbsp;<span class="ident" id="4065280">stride</span>&nbsp;<span class="op" id="4065287">=</span>&nbsp;<span class="ident" id="4065289">p</span><span class="op" id="4065290">.</span><span class="ident" id="4065291">Pix</span><span class="op" id="4065294">[</span><span class="ident" id="4065295">p</span><span class="op" id="4065296">.</span><span class="ident" id="4065297">PixOffset</span><span class="op" id="4065306">(</span><span class="ident" id="4065307">r</span><span class="op" id="4065308">.</span><span class="ident" id="4065309">Min</span><span class="op" id="4065312">.</span><span class="ident" id="4065313">X</span><span class="op" id="4065314">,</span>&nbsp;<span class="ident" id="4065316">r</span><span class="op" id="4065317">.</span><span class="ident" id="4065318">Min</span><span class="op" id="4065321">.</span><span class="ident" id="4065322">Y</span><span class="op" id="4065323">)</span><span class="op" id="4065324">:</span><span class="op" id="4065325">]</span><span class="op" id="4065326">,</span>&nbsp;<span class="ident" id="4065328">p</span><span class="op" id="4065329">.</span><span class="ident" id="4065330">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4065338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4065342">//&nbsp;quantErrorCurr&nbsp;and&nbsp;quantErrorNext&nbsp;are&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4065417">//&nbsp;errors&nbsp;that&nbsp;have&nbsp;been&nbsp;propagated&nbsp;to&nbsp;the&nbsp;pixels&nbsp;in&nbsp;the&nbsp;current&nbsp;and&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4065492">//&nbsp;rows.&nbsp;The&nbsp;+2&nbsp;simplifies&nbsp;calculation&nbsp;near&nbsp;the&nbsp;edges.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065548">var</span>&nbsp;<span class="ident" id="4065552">quantErrorCurr</span><span class="op" id="4065566">,</span>&nbsp;<span class="ident" id="4065568">quantErrorNext</span>&nbsp;<span class="op" id="4065583">[</span><span class="op" id="4065584">]</span><span class="op" id="4065585">[</span><span class="num" id="4065586">3</span><span class="op" id="4065587">]</span><span class="builtintype" id="4065588">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065595">if</span>&nbsp;<span class="ident" id="4065598">floydSteinberg</span>&nbsp;<span class="op" id="4065613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065617">quantErrorCurr</span>&nbsp;<span class="op" id="4065632">=</span>&nbsp;<span class="builtinfunc" id="4065634">make</span><span class="op" id="4065638">(</span><span class="op" id="4065639">[</span><span class="op" id="4065640">]</span><span class="op" id="4065641">[</span><span class="num" id="4065642">3</span><span class="op" id="4065643">]</span><span class="builtintype" id="4065644">int32</span><span class="op" id="4065649">,</span>&nbsp;<span class="ident" id="4065651">r</span><span class="op" id="4065652">.</span><span class="ident" id="4065653">Dx</span><span class="op" id="4065655">(</span><span class="op" id="4065656">)</span><span class="op" id="4065657">+</span><span class="num" id="4065658">2</span><span class="op" id="4065659">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065663">quantErrorNext</span>&nbsp;<span class="op" id="4065678">=</span>&nbsp;<span class="builtinfunc" id="4065680">make</span><span class="op" id="4065684">(</span><span class="op" id="4065685">[</span><span class="op" id="4065686">]</span><span class="op" id="4065687">[</span><span class="num" id="4065688">3</span><span class="op" id="4065689">]</span><span class="builtintype" id="4065690">int32</span><span class="op" id="4065695">,</span>&nbsp;<span class="ident" id="4065697">r</span><span class="op" id="4065698">.</span><span class="ident" id="4065699">Dx</span><span class="op" id="4065701">(</span><span class="op" id="4065702">)</span><span class="op" id="4065703">+</span><span class="num" id="4065704">2</span><span class="op" id="4065705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4065708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4065712">//&nbsp;Loop&nbsp;over&nbsp;each&nbsp;source&nbsp;pixel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065745">out</span>&nbsp;<span class="op" id="4065749">:=</span>&nbsp;<span class="ident" id="4065752">color</span><span class="op" id="4065757">.</span><span class="ident" id="4065758">RGBA64</span><span class="op" id="4065764">{</span><span class="ident" id="4065765">A</span><span class="op" id="4065766">:</span>&nbsp;<span class="num" id="4065768">0xffff</span><span class="op" id="4065774">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065777">for</span>&nbsp;<span class="ident" id="4065781">y</span>&nbsp;<span class="op" id="4065783">:=</span>&nbsp;<span class="num" id="4065786">0</span><span class="op" id="4065787">;</span>&nbsp;<span class="ident" id="4065789">y</span>&nbsp;<span class="op" id="4065791">!=</span>&nbsp;<span class="ident" id="4065794">r</span><span class="op" id="4065795">.</span><span class="ident" id="4065796">Dy</span><span class="op" id="4065798">(</span><span class="op" id="4065799">)</span><span class="op" id="4065800">;</span>&nbsp;<span class="ident" id="4065802">y</span><span class="op" id="4065803">++</span>&nbsp;<span class="op" id="4065806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4065810">for</span>&nbsp;<span class="ident" id="4065814">x</span>&nbsp;<span class="op" id="4065816">:=</span>&nbsp;<span class="num" id="4065819">0</span><span class="op" id="4065820">;</span>&nbsp;<span class="ident" id="4065822">x</span>&nbsp;<span class="op" id="4065824">!=</span>&nbsp;<span class="ident" id="4065827">r</span><span class="op" id="4065828">.</span><span class="ident" id="4065829">Dx</span><span class="op" id="4065831">(</span><span class="op" id="4065832">)</span><span class="op" id="4065833">;</span>&nbsp;<span class="ident" id="4065835">x</span><span class="op" id="4065836">++</span>&nbsp;<span class="op" id="4065839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4065844">//&nbsp;er,&nbsp;eg&nbsp;and&nbsp;eb&nbsp;are&nbsp;the&nbsp;pixel&#39;s&nbsp;R,G,B&nbsp;values&nbsp;plus&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4065902">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065940">sr</span><span class="op" id="4065942">,</span>&nbsp;<span class="ident" id="4065944">sg</span><span class="op" id="4065946">,</span>&nbsp;<span class="ident" id="4065948">sb</span><span class="op" id="4065950">,</span>&nbsp;<span class="ident" id="4065952">_</span>&nbsp;<span class="op" id="4065954">:=</span>&nbsp;<span class="ident" id="4065957">src</span><span class="op" id="4065960">.</span><span class="ident" id="4065961">At</span><span class="op" id="4065963">(</span><span class="ident" id="4065964">sp</span><span class="op" id="4065966">.</span><span class="ident" id="4065967">X</span><span class="op" id="4065968">+</span><span class="ident" id="4065969">x</span><span class="op" id="4065970">,</span>&nbsp;<span class="ident" id="4065972">sp</span><span class="op" id="4065974">.</span><span class="ident" id="4065975">Y</span><span class="op" id="4065976">+</span><span class="ident" id="4065977">y</span><span class="op" id="4065978">)</span><span class="op" id="4065979">.</span><span class="ident" id="4065980">RGBA</span><span class="op" id="4065984">(</span><span class="op" id="4065985">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4065990">er</span><span class="op" id="4065992">,</span>&nbsp;<span class="ident" id="4065994">eg</span><span class="op" id="4065996">,</span>&nbsp;<span class="ident" id="4065998">eb</span>&nbsp;<span class="op" id="4066001">:=</span>&nbsp;<span class="builtintype" id="4066004">int32</span><span class="op" id="4066009">(</span><span class="ident" id="4066010">sr</span><span class="op" id="4066012">)</span><span class="op" id="4066013">,</span>&nbsp;<span class="builtintype" id="4066015">int32</span><span class="op" id="4066020">(</span><span class="ident" id="4066021">sg</span><span class="op" id="4066023">)</span><span class="op" id="4066024">,</span>&nbsp;<span class="builtintype" id="4066026">int32</span><span class="op" id="4066031">(</span><span class="ident" id="4066032">sb</span><span class="op" id="4066034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066039">if</span>&nbsp;<span class="ident" id="4066042">floydSteinberg</span>&nbsp;<span class="op" id="4066057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066063">er</span>&nbsp;<span class="op" id="4066066">=</span>&nbsp;<span class="ident" id="4066068">clamp</span><span class="op" id="4066073">(</span><span class="ident" id="4066074">er</span>&nbsp;<span class="op" id="4066077">+</span>&nbsp;<span class="ident" id="4066079">quantErrorCurr</span><span class="op" id="4066093">[</span><span class="ident" id="4066094">x</span><span class="op" id="4066095">+</span><span class="num" id="4066096">1</span><span class="op" id="4066097">]</span><span class="op" id="4066098">[</span><span class="num" id="4066099">0</span><span class="op" id="4066100">]</span><span class="op" id="4066101">/</span><span class="num" id="4066102">16</span><span class="op" id="4066104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066110">eg</span>&nbsp;<span class="op" id="4066113">=</span>&nbsp;<span class="ident" id="4066115">clamp</span><span class="op" id="4066120">(</span><span class="ident" id="4066121">eg</span>&nbsp;<span class="op" id="4066124">+</span>&nbsp;<span class="ident" id="4066126">quantErrorCurr</span><span class="op" id="4066140">[</span><span class="ident" id="4066141">x</span><span class="op" id="4066142">+</span><span class="num" id="4066143">1</span><span class="op" id="4066144">]</span><span class="op" id="4066145">[</span><span class="num" id="4066146">1</span><span class="op" id="4066147">]</span><span class="op" id="4066148">/</span><span class="num" id="4066149">16</span><span class="op" id="4066151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066157">eb</span>&nbsp;<span class="op" id="4066160">=</span>&nbsp;<span class="ident" id="4066162">clamp</span><span class="op" id="4066167">(</span><span class="ident" id="4066168">eb</span>&nbsp;<span class="op" id="4066171">+</span>&nbsp;<span class="ident" id="4066173">quantErrorCurr</span><span class="op" id="4066187">[</span><span class="ident" id="4066188">x</span><span class="op" id="4066189">+</span><span class="num" id="4066190">1</span><span class="op" id="4066191">]</span><span class="op" id="4066192">[</span><span class="num" id="4066193">2</span><span class="op" id="4066194">]</span><span class="op" id="4066195">/</span><span class="num" id="4066196">16</span><span class="op" id="4066198">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066209">if</span>&nbsp;<span class="ident" id="4066212">palette</span>&nbsp;<span class="op" id="4066220">!=</span>&nbsp;<span class="ident" id="4066223">nil</span>&nbsp;<span class="op" id="4066227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4066233">//&nbsp;Find&nbsp;the&nbsp;closest&nbsp;palette&nbsp;color&nbsp;in&nbsp;Euclidean&nbsp;R,G,B&nbsp;space:&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4066301">//&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;sum-squared-difference.&nbsp;We&nbsp;shift&nbsp;by&nbsp;1&nbsp;bit</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4066369">//&nbsp;to&nbsp;avoid&nbsp;potential&nbsp;uint32&nbsp;overflow&nbsp;in&nbsp;sum-squared-difference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4066438">//&nbsp;TODO(nigeltao):&nbsp;consider&nbsp;smarter&nbsp;algorithms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066490">bestIndex</span><span class="op" id="4066499">,</span>&nbsp;<span class="ident" id="4066501">bestSSD</span>&nbsp;<span class="op" id="4066509">:=</span>&nbsp;<span class="num" id="4066512">0</span><span class="op" id="4066513">,</span>&nbsp;<span class="builtintype" id="4066515">uint32</span><span class="op" id="4066521">(</span><span class="num" id="4066522">1</span><span class="op" id="4066523">&lt;&lt;</span><span class="num" id="4066525">32</span><span class="op" id="4066527">-</span><span class="num" id="4066528">1</span><span class="op" id="4066529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066535">for</span>&nbsp;<span class="ident" id="4066539">index</span><span class="op" id="4066544">,</span>&nbsp;<span class="ident" id="4066546">p</span>&nbsp;<span class="op" id="4066548">:=</span>&nbsp;<span class="keyword" id="4066551">range</span>&nbsp;<span class="ident" id="4066557">palette</span>&nbsp;<span class="op" id="4066565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066572">delta</span>&nbsp;<span class="op" id="4066578">:=</span>&nbsp;<span class="op" id="4066581">(</span><span class="ident" id="4066582">er</span>&nbsp;<span class="op" id="4066585">-</span>&nbsp;<span class="ident" id="4066587">p</span><span class="op" id="4066588">[</span><span class="num" id="4066589">0</span><span class="op" id="4066590">]</span><span class="op" id="4066591">)</span>&nbsp;<span class="op" id="4066593">&gt;&gt;</span>&nbsp;<span class="num" id="4066596">1</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066603">ssd</span>&nbsp;<span class="op" id="4066607">:=</span>&nbsp;<span class="builtintype" id="4066610">uint32</span><span class="op" id="4066616">(</span><span class="ident" id="4066617">delta</span>&nbsp;<span class="op" id="4066623">*</span>&nbsp;<span class="ident" id="4066625">delta</span><span class="op" id="4066630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066637">delta</span>&nbsp;<span class="op" id="4066643">=</span>&nbsp;<span class="op" id="4066645">(</span><span class="ident" id="4066646">eg</span>&nbsp;<span class="op" id="4066649">-</span>&nbsp;<span class="ident" id="4066651">p</span><span class="op" id="4066652">[</span><span class="num" id="4066653">1</span><span class="op" id="4066654">]</span><span class="op" id="4066655">)</span>&nbsp;<span class="op" id="4066657">&gt;&gt;</span>&nbsp;<span class="num" id="4066660">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066667">ssd</span>&nbsp;<span class="op" id="4066671">+=</span>&nbsp;<span class="builtintype" id="4066674">uint32</span><span class="op" id="4066680">(</span><span class="ident" id="4066681">delta</span>&nbsp;<span class="op" id="4066687">*</span>&nbsp;<span class="ident" id="4066689">delta</span><span class="op" id="4066694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066701">delta</span>&nbsp;<span class="op" id="4066707">=</span>&nbsp;<span class="op" id="4066709">(</span><span class="ident" id="4066710">eb</span>&nbsp;<span class="op" id="4066713">-</span>&nbsp;<span class="ident" id="4066715">p</span><span class="op" id="4066716">[</span><span class="num" id="4066717">2</span><span class="op" id="4066718">]</span><span class="op" id="4066719">)</span>&nbsp;<span class="op" id="4066721">&gt;&gt;</span>&nbsp;<span class="num" id="4066724">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066731">ssd</span>&nbsp;<span class="op" id="4066735">+=</span>&nbsp;<span class="builtintype" id="4066738">uint32</span><span class="op" id="4066744">(</span><span class="ident" id="4066745">delta</span>&nbsp;<span class="op" id="4066751">*</span>&nbsp;<span class="ident" id="4066753">delta</span><span class="op" id="4066758">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066765">if</span>&nbsp;<span class="ident" id="4066768">ssd</span>&nbsp;<span class="op" id="4066772">&lt;</span>&nbsp;<span class="ident" id="4066774">bestSSD</span>&nbsp;<span class="op" id="4066782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066790">bestIndex</span><span class="op" id="4066799">,</span>&nbsp;<span class="ident" id="4066801">bestSSD</span>&nbsp;<span class="op" id="4066809">=</span>&nbsp;<span class="ident" id="4066811">index</span><span class="op" id="4066816">,</span>&nbsp;<span class="ident" id="4066818">ssd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066828">if</span>&nbsp;<span class="ident" id="4066831">ssd</span>&nbsp;<span class="op" id="4066835">==</span>&nbsp;<span class="num" id="4066838">0</span>&nbsp;<span class="op" id="4066840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066849">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066861">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066880">pix</span><span class="op" id="4066883">[</span><span class="ident" id="4066884">y</span><span class="op" id="4066885">*</span><span class="ident" id="4066886">stride</span><span class="op" id="4066892">+</span><span class="ident" id="4066893">x</span><span class="op" id="4066894">]</span>&nbsp;<span class="op" id="4066896">=</span>&nbsp;<span class="builtintype" id="4066898">byte</span><span class="op" id="4066902">(</span><span class="ident" id="4066903">bestIndex</span><span class="op" id="4066912">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066919">if</span>&nbsp;<span class="op" id="4066922">!</span><span class="ident" id="4066923">floydSteinberg</span>&nbsp;<span class="op" id="4066938">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4066945">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4066958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4066964">er</span>&nbsp;<span class="op" id="4066967">-=</span>&nbsp;<span class="builtintype" id="4066970">int32</span><span class="op" id="4066975">(</span><span class="ident" id="4066976">palette</span><span class="op" id="4066983">[</span><span class="ident" id="4066984">bestIndex</span><span class="op" id="4066993">]</span><span class="op" id="4066994">[</span><span class="num" id="4066995">0</span><span class="op" id="4066996">]</span><span class="op" id="4066997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067003">eg</span>&nbsp;<span class="op" id="4067006">-=</span>&nbsp;<span class="builtintype" id="4067009">int32</span><span class="op" id="4067014">(</span><span class="ident" id="4067015">palette</span><span class="op" id="4067022">[</span><span class="ident" id="4067023">bestIndex</span><span class="op" id="4067032">]</span><span class="op" id="4067033">[</span><span class="num" id="4067034">1</span><span class="op" id="4067035">]</span><span class="op" id="4067036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067042">eb</span>&nbsp;<span class="op" id="4067045">-=</span>&nbsp;<span class="builtintype" id="4067048">int32</span><span class="op" id="4067053">(</span><span class="ident" id="4067054">palette</span><span class="op" id="4067061">[</span><span class="ident" id="4067062">bestIndex</span><span class="op" id="4067071">]</span><span class="op" id="4067072">[</span><span class="num" id="4067073">2</span><span class="op" id="4067074">]</span><span class="op" id="4067075">)</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067081">}</span>&nbsp;<span class="keyword" id="4067083">else</span>&nbsp;<span class="op" id="4067088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067094">out</span><span class="op" id="4067097">.</span><span class="ident" id="4067098">R</span>&nbsp;<span class="op" id="4067100">=</span>&nbsp;<span class="builtintype" id="4067102">uint16</span><span class="op" id="4067108">(</span><span class="ident" id="4067109">er</span><span class="op" id="4067111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067117">out</span><span class="op" id="4067120">.</span><span class="ident" id="4067121">G</span>&nbsp;<span class="op" id="4067123">=</span>&nbsp;<span class="builtintype" id="4067125">uint16</span><span class="op" id="4067131">(</span><span class="ident" id="4067132">eg</span><span class="op" id="4067134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067140">out</span><span class="op" id="4067143">.</span><span class="ident" id="4067144">B</span>&nbsp;<span class="op" id="4067146">=</span>&nbsp;<span class="builtintype" id="4067148">uint16</span><span class="op" id="4067154">(</span><span class="ident" id="4067155">eb</span><span class="op" id="4067157">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4067163">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4067224">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4067289">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4067352">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067413">dst</span><span class="op" id="4067416">.</span><span class="ident" id="4067417">Set</span><span class="op" id="4067420">(</span><span class="ident" id="4067421">r</span><span class="op" id="4067422">.</span><span class="ident" id="4067423">Min</span><span class="op" id="4067426">.</span><span class="ident" id="4067427">X</span><span class="op" id="4067428">+</span><span class="ident" id="4067429">x</span><span class="op" id="4067430">,</span>&nbsp;<span class="ident" id="4067432">r</span><span class="op" id="4067433">.</span><span class="ident" id="4067434">Min</span><span class="op" id="4067437">.</span><span class="ident" id="4067438">Y</span><span class="op" id="4067439">+</span><span class="ident" id="4067440">y</span><span class="op" id="4067441">,</span>&nbsp;<span class="op" id="4067443">&amp;</span><span class="ident" id="4067444">out</span><span class="op" id="4067447">)</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067454">if</span>&nbsp;<span class="op" id="4067457">!</span><span class="ident" id="4067458">floydSteinberg</span>&nbsp;<span class="op" id="4067473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4067480">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067499">sr</span><span class="op" id="4067501">,</span>&nbsp;<span class="ident" id="4067503">sg</span><span class="op" id="4067505">,</span>&nbsp;<span class="ident" id="4067507">sb</span><span class="op" id="4067509">,</span>&nbsp;<span class="ident" id="4067511">_</span>&nbsp;<span class="op" id="4067513">=</span>&nbsp;<span class="ident" id="4067515">dst</span><span class="op" id="4067518">.</span><span class="ident" id="4067519">At</span><span class="op" id="4067521">(</span><span class="ident" id="4067522">r</span><span class="op" id="4067523">.</span><span class="ident" id="4067524">Min</span><span class="op" id="4067527">.</span><span class="ident" id="4067528">X</span><span class="op" id="4067529">+</span><span class="ident" id="4067530">x</span><span class="op" id="4067531">,</span>&nbsp;<span class="ident" id="4067533">r</span><span class="op" id="4067534">.</span><span class="ident" id="4067535">Min</span><span class="op" id="4067538">.</span><span class="ident" id="4067539">Y</span><span class="op" id="4067540">+</span><span class="ident" id="4067541">y</span><span class="op" id="4067542">)</span><span class="op" id="4067543">.</span><span class="ident" id="4067544">RGBA</span><span class="op" id="4067548">(</span><span class="op" id="4067549">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067555">er</span>&nbsp;<span class="op" id="4067558">-=</span>&nbsp;<span class="builtintype" id="4067561">int32</span><span class="op" id="4067566">(</span><span class="ident" id="4067567">sr</span><span class="op" id="4067569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067575">eg</span>&nbsp;<span class="op" id="4067578">-=</span>&nbsp;<span class="builtintype" id="4067581">int32</span><span class="op" id="4067586">(</span><span class="ident" id="4067587">sg</span><span class="op" id="4067589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067595">eb</span>&nbsp;<span class="op" id="4067598">-=</span>&nbsp;<span class="builtintype" id="4067601">int32</span><span class="op" id="4067606">(</span><span class="ident" id="4067607">sb</span><span class="op" id="4067609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4067614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4067620">//&nbsp;Propagate&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067676">quantErrorNext</span><span class="op" id="4067690">[</span><span class="ident" id="4067691">x</span><span class="op" id="4067692">+</span><span class="num" id="4067693">0</span><span class="op" id="4067694">]</span><span class="op" id="4067695">[</span><span class="num" id="4067696">0</span><span class="op" id="4067697">]</span>&nbsp;<span class="op" id="4067699">+=</span>&nbsp;<span class="ident" id="4067702">er</span>&nbsp;<span class="op" id="4067705">*</span>&nbsp;<span class="num" id="4067707">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067712">quantErrorNext</span><span class="op" id="4067726">[</span><span class="ident" id="4067727">x</span><span class="op" id="4067728">+</span><span class="num" id="4067729">0</span><span class="op" id="4067730">]</span><span class="op" id="4067731">[</span><span class="num" id="4067732">1</span><span class="op" id="4067733">]</span>&nbsp;<span class="op" id="4067735">+=</span>&nbsp;<span class="ident" id="4067738">eg</span>&nbsp;<span class="op" id="4067741">*</span>&nbsp;<span class="num" id="4067743">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067748">quantErrorNext</span><span class="op" id="4067762">[</span><span class="ident" id="4067763">x</span><span class="op" id="4067764">+</span><span class="num" id="4067765">0</span><span class="op" id="4067766">]</span><span class="op" id="4067767">[</span><span class="num" id="4067768">2</span><span class="op" id="4067769">]</span>&nbsp;<span class="op" id="4067771">+=</span>&nbsp;<span class="ident" id="4067774">eb</span>&nbsp;<span class="op" id="4067777">*</span>&nbsp;<span class="num" id="4067779">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067784">quantErrorNext</span><span class="op" id="4067798">[</span><span class="ident" id="4067799">x</span><span class="op" id="4067800">+</span><span class="num" id="4067801">1</span><span class="op" id="4067802">]</span><span class="op" id="4067803">[</span><span class="num" id="4067804">0</span><span class="op" id="4067805">]</span>&nbsp;<span class="op" id="4067807">+=</span>&nbsp;<span class="ident" id="4067810">er</span>&nbsp;<span class="op" id="4067813">*</span>&nbsp;<span class="num" id="4067815">5</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067820">quantErrorNext</span><span class="op" id="4067834">[</span><span class="ident" id="4067835">x</span><span class="op" id="4067836">+</span><span class="num" id="4067837">1</span><span class="op" id="4067838">]</span><span class="op" id="4067839">[</span><span class="num" id="4067840">1</span><span class="op" id="4067841">]</span>&nbsp;<span class="op" id="4067843">+=</span>&nbsp;<span class="ident" id="4067846">eg</span>&nbsp;<span class="op" id="4067849">*</span>&nbsp;<span class="num" id="4067851">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067856">quantErrorNext</span><span class="op" id="4067870">[</span><span class="ident" id="4067871">x</span><span class="op" id="4067872">+</span><span class="num" id="4067873">1</span><span class="op" id="4067874">]</span><span class="op" id="4067875">[</span><span class="num" id="4067876">2</span><span class="op" id="4067877">]</span>&nbsp;<span class="op" id="4067879">+=</span>&nbsp;<span class="ident" id="4067882">eb</span>&nbsp;<span class="op" id="4067885">*</span>&nbsp;<span class="num" id="4067887">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067892">quantErrorNext</span><span class="op" id="4067906">[</span><span class="ident" id="4067907">x</span><span class="op" id="4067908">+</span><span class="num" id="4067909">2</span><span class="op" id="4067910">]</span><span class="op" id="4067911">[</span><span class="num" id="4067912">0</span><span class="op" id="4067913">]</span>&nbsp;<span class="op" id="4067915">+=</span>&nbsp;<span class="ident" id="4067918">er</span>&nbsp;<span class="op" id="4067921">*</span>&nbsp;<span class="num" id="4067923">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067928">quantErrorNext</span><span class="op" id="4067942">[</span><span class="ident" id="4067943">x</span><span class="op" id="4067944">+</span><span class="num" id="4067945">2</span><span class="op" id="4067946">]</span><span class="op" id="4067947">[</span><span class="num" id="4067948">1</span><span class="op" id="4067949">]</span>&nbsp;<span class="op" id="4067951">+=</span>&nbsp;<span class="ident" id="4067954">eg</span>&nbsp;<span class="op" id="4067957">*</span>&nbsp;<span class="num" id="4067959">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4067964">quantErrorNext</span><span class="op" id="4067978">[</span><span class="ident" id="4067979">x</span><span class="op" id="4067980">+</span><span class="num" id="4067981">2</span><span class="op" id="4067982">]</span><span class="op" id="4067983">[</span><span class="num" id="4067984">2</span><span class="op" id="4067985">]</span>&nbsp;<span class="op" id="4067987">+=</span>&nbsp;<span class="ident" id="4067990">eb</span>&nbsp;<span class="op" id="4067993">*</span>&nbsp;<span class="num" id="4067995">1</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4068000">quantErrorCurr</span><span class="op" id="4068014">[</span><span class="ident" id="4068015">x</span><span class="op" id="4068016">+</span><span class="num" id="4068017">2</span><span class="op" id="4068018">]</span><span class="op" id="4068019">[</span><span class="num" id="4068020">0</span><span class="op" id="4068021">]</span>&nbsp;<span class="op" id="4068023">+=</span>&nbsp;<span class="ident" id="4068026">er</span>&nbsp;<span class="op" id="4068029">*</span>&nbsp;<span class="num" id="4068031">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4068036">quantErrorCurr</span><span class="op" id="4068050">[</span><span class="ident" id="4068051">x</span><span class="op" id="4068052">+</span><span class="num" id="4068053">2</span><span class="op" id="4068054">]</span><span class="op" id="4068055">[</span><span class="num" id="4068056">1</span><span class="op" id="4068057">]</span>&nbsp;<span class="op" id="4068059">+=</span>&nbsp;<span class="ident" id="4068062">eg</span>&nbsp;<span class="op" id="4068065">*</span>&nbsp;<span class="num" id="4068067">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4068072">quantErrorCurr</span><span class="op" id="4068086">[</span><span class="ident" id="4068087">x</span><span class="op" id="4068088">+</span><span class="num" id="4068089">2</span><span class="op" id="4068090">]</span><span class="op" id="4068091">[</span><span class="num" id="4068092">2</span><span class="op" id="4068093">]</span>&nbsp;<span class="op" id="4068095">+=</span>&nbsp;<span class="ident" id="4068098">eb</span>&nbsp;<span class="op" id="4068101">*</span>&nbsp;<span class="num" id="4068103">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4068112">//&nbsp;Recycle&nbsp;the&nbsp;quantization&nbsp;error&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068157">if</span>&nbsp;<span class="ident" id="4068160">floydSteinberg</span>&nbsp;<span class="op" id="4068175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4068180">quantErrorCurr</span><span class="op" id="4068194">,</span>&nbsp;<span class="ident" id="4068196">quantErrorNext</span>&nbsp;<span class="op" id="4068211">=</span>&nbsp;<span class="ident" id="4068213">quantErrorNext</span><span class="op" id="4068227">,</span>&nbsp;<span class="ident" id="4068229">quantErrorCurr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4068247">for</span>&nbsp;<span class="ident" id="4068251">i</span>&nbsp;<span class="op" id="4068253">:=</span>&nbsp;<span class="keyword" id="4068256">range</span>&nbsp;<span class="ident" id="4068262">quantErrorNext</span>&nbsp;<span class="op" id="4068277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4068283">quantErrorNext</span><span class="op" id="4068297">[</span><span class="ident" id="4068298">i</span><span class="op" id="4068299">]</span>&nbsp;<span class="op" id="4068301">=</span>&nbsp;<span class="op" id="4068303">[</span><span class="num" id="4068304">3</span><span class="op" id="4068305">]</span><span class="builtintype" id="4068306">int32</span><span class="op" id="4068311">{</span><span class="op" id="4068312">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4068324">}</span><br>
<span class="lineno"></span><span class="op" id="4068326">}</span>
</div>
</body>
</html>
