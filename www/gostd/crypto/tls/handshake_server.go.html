<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4165838">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4165893">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4165947">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4165998">package</span>&nbsp;<span class="ident" id="4166006">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4166011">import</span>&nbsp;<span class="op" id="4166018">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4166021">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4166031">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4166047">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4166061">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4166078">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4166093">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4166110">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4166120">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4166127">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4166132">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4166135">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="4166211">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="4166263">type</span>&nbsp;<span class="ident" id="4166268">serverHandshakeState</span>&nbsp;<span class="keyword" id="4166289">struct</span>&nbsp;<span class="op" id="4166296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166299">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4166315">*</span><span class="ident" id="4166316">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166322">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4166338">*</span><span class="ident" id="4166339">clientHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166355">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4166371">*</span><span class="ident" id="4166372">serverHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166388">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4166404">*</span><span class="ident" id="4166405">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166418">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4166434">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166440">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4166456">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166462">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4166478">*</span><span class="ident" id="4166479">sessionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166493">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4166509">finishedHash</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166523">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4166539">[</span><span class="op" id="4166540">]</span><span class="builtintype" id="4166541">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166547">certsFromClient</span>&nbsp;<span class="op" id="4166563">[</span><span class="op" id="4166564">]</span><span class="op" id="4166565">[</span><span class="op" id="4166566">]</span><span class="builtintype" id="4166567">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166573">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4166589">*</span><span class="ident" id="4166590">Certificate</span><br>
<span class="lineno"></span><span class="op" id="4166602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="4166605">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="4166662">func</span>&nbsp;<span class="op" id="4166667">(</span><span class="ident" id="4166668">c</span>&nbsp;<span class="op" id="4166670">*</span><span class="ident" id="4166671">Conn</span><span class="op" id="4166675">)</span>&nbsp;<span class="ident" id="4166677">serverHandshake</span><span class="op" id="4166692">(</span><span class="op" id="4166693">)</span>&nbsp;<span class="builtintype" id="4166695">error</span>&nbsp;<span class="op" id="4166701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166704">config</span>&nbsp;<span class="op" id="4166711">:=</span>&nbsp;<span class="ident" id="4166714">c</span><span class="op" id="4166715">.</span><span class="ident" id="4166716">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4166725">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4166796">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166826">config</span><span class="op" id="4166832">.</span><span class="ident" id="4166833">serverInitOnce</span><span class="op" id="4166847">.</span><span class="ident" id="4166848">Do</span><span class="op" id="4166850">(</span><span class="ident" id="4166851">config</span><span class="op" id="4166857">.</span><span class="ident" id="4166858">serverInit</span><span class="op" id="4166868">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166872">hs</span>&nbsp;<span class="op" id="4166875">:=</span>&nbsp;<span class="ident" id="4166878">serverHandshakeState</span><span class="op" id="4166898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166902">c</span><span class="op" id="4166903">:</span>&nbsp;<span class="ident" id="4166905">c</span><span class="op" id="4166906">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4166909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4166912">isResume</span><span class="op" id="4166920">,</span>&nbsp;<span class="ident" id="4166922">err</span>&nbsp;<span class="op" id="4166926">:=</span>&nbsp;<span class="ident" id="4166929">hs</span><span class="op" id="4166931">.</span><span class="ident" id="4166932">readClientHello</span><span class="op" id="4166947">(</span><span class="op" id="4166948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166951">if</span>&nbsp;<span class="ident" id="4166954">err</span>&nbsp;<span class="op" id="4166958">!=</span>&nbsp;<span class="ident" id="4166961">nil</span>&nbsp;<span class="op" id="4166965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4166969">return</span>&nbsp;<span class="ident" id="4166976">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4166981">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4166985">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167077">if</span>&nbsp;<span class="ident" id="4167080">isResume</span>&nbsp;<span class="op" id="4167089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167093">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167178">if</span>&nbsp;<span class="ident" id="4167181">err</span>&nbsp;<span class="op" id="4167185">:=</span>&nbsp;<span class="ident" id="4167188">hs</span><span class="op" id="4167190">.</span><span class="ident" id="4167191">doResumeHandshake</span><span class="op" id="4167208">(</span><span class="op" id="4167209">)</span><span class="op" id="4167210">;</span>&nbsp;<span class="ident" id="4167212">err</span>&nbsp;<span class="op" id="4167216">!=</span>&nbsp;<span class="ident" id="4167219">nil</span>&nbsp;<span class="op" id="4167223">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167228">return</span>&nbsp;<span class="ident" id="4167235">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167245">if</span>&nbsp;<span class="ident" id="4167248">err</span>&nbsp;<span class="op" id="4167252">:=</span>&nbsp;<span class="ident" id="4167255">hs</span><span class="op" id="4167257">.</span><span class="ident" id="4167258">establishKeys</span><span class="op" id="4167271">(</span><span class="op" id="4167272">)</span><span class="op" id="4167273">;</span>&nbsp;<span class="ident" id="4167275">err</span>&nbsp;<span class="op" id="4167279">!=</span>&nbsp;<span class="ident" id="4167282">nil</span>&nbsp;<span class="op" id="4167286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167291">return</span>&nbsp;<span class="ident" id="4167298">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167304">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167308">if</span>&nbsp;<span class="ident" id="4167311">err</span>&nbsp;<span class="op" id="4167315">:=</span>&nbsp;<span class="ident" id="4167318">hs</span><span class="op" id="4167320">.</span><span class="ident" id="4167321">sendFinished</span><span class="op" id="4167333">(</span><span class="ident" id="4167334">c</span><span class="op" id="4167335">.</span><span class="ident" id="4167336">firstFinished</span><span class="op" id="4167349">[</span><span class="op" id="4167350">:</span><span class="op" id="4167351">]</span><span class="op" id="4167352">)</span><span class="op" id="4167353">;</span>&nbsp;<span class="ident" id="4167355">err</span>&nbsp;<span class="op" id="4167359">!=</span>&nbsp;<span class="ident" id="4167362">nil</span>&nbsp;<span class="op" id="4167366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167371">return</span>&nbsp;<span class="ident" id="4167378">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167388">if</span>&nbsp;<span class="ident" id="4167391">err</span>&nbsp;<span class="op" id="4167395">:=</span>&nbsp;<span class="ident" id="4167398">hs</span><span class="op" id="4167400">.</span><span class="ident" id="4167401">readFinished</span><span class="op" id="4167413">(</span><span class="ident" id="4167414">nil</span><span class="op" id="4167417">)</span><span class="op" id="4167418">;</span>&nbsp;<span class="ident" id="4167420">err</span>&nbsp;<span class="op" id="4167424">!=</span>&nbsp;<span class="ident" id="4167427">nil</span>&nbsp;<span class="op" id="4167431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167436">return</span>&nbsp;<span class="ident" id="4167443">err</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4167453">c</span><span class="op" id="4167454">.</span><span class="ident" id="4167455">didResume</span>&nbsp;<span class="op" id="4167465">=</span>&nbsp;<span class="builtintype" id="4167467">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167473">}</span>&nbsp;<span class="keyword" id="4167475">else</span>&nbsp;<span class="op" id="4167480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167484">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4167546">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167584">if</span>&nbsp;<span class="ident" id="4167587">err</span>&nbsp;<span class="op" id="4167591">:=</span>&nbsp;<span class="ident" id="4167594">hs</span><span class="op" id="4167596">.</span><span class="ident" id="4167597">doFullHandshake</span><span class="op" id="4167612">(</span><span class="op" id="4167613">)</span><span class="op" id="4167614">;</span>&nbsp;<span class="ident" id="4167616">err</span>&nbsp;<span class="op" id="4167620">!=</span>&nbsp;<span class="ident" id="4167623">nil</span>&nbsp;<span class="op" id="4167627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167632">return</span>&nbsp;<span class="ident" id="4167639">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167649">if</span>&nbsp;<span class="ident" id="4167652">err</span>&nbsp;<span class="op" id="4167656">:=</span>&nbsp;<span class="ident" id="4167659">hs</span><span class="op" id="4167661">.</span><span class="ident" id="4167662">establishKeys</span><span class="op" id="4167675">(</span><span class="op" id="4167676">)</span><span class="op" id="4167677">;</span>&nbsp;<span class="ident" id="4167679">err</span>&nbsp;<span class="op" id="4167683">!=</span>&nbsp;<span class="ident" id="4167686">nil</span>&nbsp;<span class="op" id="4167690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167695">return</span>&nbsp;<span class="ident" id="4167702">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167712">if</span>&nbsp;<span class="ident" id="4167715">err</span>&nbsp;<span class="op" id="4167719">:=</span>&nbsp;<span class="ident" id="4167722">hs</span><span class="op" id="4167724">.</span><span class="ident" id="4167725">readFinished</span><span class="op" id="4167737">(</span><span class="ident" id="4167738">c</span><span class="op" id="4167739">.</span><span class="ident" id="4167740">firstFinished</span><span class="op" id="4167753">[</span><span class="op" id="4167754">:</span><span class="op" id="4167755">]</span><span class="op" id="4167756">)</span><span class="op" id="4167757">;</span>&nbsp;<span class="ident" id="4167759">err</span>&nbsp;<span class="op" id="4167763">!=</span>&nbsp;<span class="ident" id="4167766">nil</span>&nbsp;<span class="op" id="4167770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167775">return</span>&nbsp;<span class="ident" id="4167782">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167792">if</span>&nbsp;<span class="ident" id="4167795">err</span>&nbsp;<span class="op" id="4167799">:=</span>&nbsp;<span class="ident" id="4167802">hs</span><span class="op" id="4167804">.</span><span class="ident" id="4167805">sendSessionTicket</span><span class="op" id="4167822">(</span><span class="op" id="4167823">)</span><span class="op" id="4167824">;</span>&nbsp;<span class="ident" id="4167826">err</span>&nbsp;<span class="op" id="4167830">!=</span>&nbsp;<span class="ident" id="4167833">nil</span>&nbsp;<span class="op" id="4167837">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167842">return</span>&nbsp;<span class="ident" id="4167849">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167859">if</span>&nbsp;<span class="ident" id="4167862">err</span>&nbsp;<span class="op" id="4167866">:=</span>&nbsp;<span class="ident" id="4167869">hs</span><span class="op" id="4167871">.</span><span class="ident" id="4167872">sendFinished</span><span class="op" id="4167884">(</span><span class="ident" id="4167885">nil</span><span class="op" id="4167888">)</span><span class="op" id="4167889">;</span>&nbsp;<span class="ident" id="4167891">err</span>&nbsp;<span class="op" id="4167895">!=</span>&nbsp;<span class="ident" id="4167898">nil</span>&nbsp;<span class="op" id="4167902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167907">return</span>&nbsp;<span class="ident" id="4167914">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167920">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4167923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4167926">c</span><span class="op" id="4167927">.</span><span class="ident" id="4167928">handshakeComplete</span>&nbsp;<span class="op" id="4167946">=</span>&nbsp;<span class="builtintype" id="4167948">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4167955">return</span>&nbsp;<span class="ident" id="4167962">nil</span><br>
<span class="lineno"></span><span class="op" id="4167966">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4167969">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="4168044">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="4168091">func</span>&nbsp;<span class="op" id="4168096">(</span><span class="ident" id="4168097">hs</span>&nbsp;<span class="op" id="4168100">*</span><span class="ident" id="4168101">serverHandshakeState</span><span class="op" id="4168121">)</span>&nbsp;<span class="ident" id="4168123">readClientHello</span><span class="op" id="4168138">(</span><span class="op" id="4168139">)</span>&nbsp;<span class="op" id="4168141">(</span><span class="ident" id="4168142">isResume</span>&nbsp;<span class="builtintype" id="4168151">bool</span><span class="op" id="4168155">,</span>&nbsp;<span class="ident" id="4168157">err</span>&nbsp;<span class="builtintype" id="4168161">error</span><span class="op" id="4168166">)</span>&nbsp;<span class="op" id="4168168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168171">config</span>&nbsp;<span class="op" id="4168178">:=</span>&nbsp;<span class="ident" id="4168181">hs</span><span class="op" id="4168183">.</span><span class="ident" id="4168184">c</span><span class="op" id="4168185">.</span><span class="ident" id="4168186">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168194">c</span>&nbsp;<span class="op" id="4168196">:=</span>&nbsp;<span class="ident" id="4168199">hs</span><span class="op" id="4168201">.</span><span class="ident" id="4168202">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168206">msg</span><span class="op" id="4168209">,</span>&nbsp;<span class="ident" id="4168211">err</span>&nbsp;<span class="op" id="4168215">:=</span>&nbsp;<span class="ident" id="4168218">c</span><span class="op" id="4168219">.</span><span class="ident" id="4168220">readHandshake</span><span class="op" id="4168233">(</span><span class="op" id="4168234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168237">if</span>&nbsp;<span class="ident" id="4168240">err</span>&nbsp;<span class="op" id="4168244">!=</span>&nbsp;<span class="ident" id="4168247">nil</span>&nbsp;<span class="op" id="4168251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168255">return</span>&nbsp;<span class="builtintype" id="4168262">false</span><span class="op" id="4168267">,</span>&nbsp;<span class="ident" id="4168269">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4168274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168277">var</span>&nbsp;<span class="ident" id="4168281">ok</span>&nbsp;<span class="builtintype" id="4168284">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168290">hs</span><span class="op" id="4168292">.</span><span class="ident" id="4168293">clientHello</span><span class="op" id="4168304">,</span>&nbsp;<span class="ident" id="4168306">ok</span>&nbsp;<span class="op" id="4168309">=</span>&nbsp;<span class="ident" id="4168311">msg</span><span class="op" id="4168314">.</span><span class="op" id="4168315">(</span><span class="op" id="4168316">*</span><span class="ident" id="4168317">clientHelloMsg</span><span class="op" id="4168331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168334">if</span>&nbsp;<span class="op" id="4168337">!</span><span class="ident" id="4168338">ok</span>&nbsp;<span class="op" id="4168341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168345">c</span><span class="op" id="4168346">.</span><span class="ident" id="4168347">sendAlert</span><span class="op" id="4168356">(</span><span class="ident" id="4168357">alertUnexpectedMessage</span><span class="op" id="4168379">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168383">return</span>&nbsp;<span class="builtintype" id="4168390">false</span><span class="op" id="4168395">,</span>&nbsp;<span class="ident" id="4168397">unexpectedMessageError</span><span class="op" id="4168419">(</span><span class="ident" id="4168420">hs</span><span class="op" id="4168422">.</span><span class="ident" id="4168423">clientHello</span><span class="op" id="4168434">,</span>&nbsp;<span class="ident" id="4168436">msg</span><span class="op" id="4168439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4168442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168445">c</span><span class="op" id="4168446">.</span><span class="ident" id="4168447">vers</span><span class="op" id="4168451">,</span>&nbsp;<span class="ident" id="4168453">ok</span>&nbsp;<span class="op" id="4168456">=</span>&nbsp;<span class="ident" id="4168458">config</span><span class="op" id="4168464">.</span><span class="ident" id="4168465">mutualVersion</span><span class="op" id="4168478">(</span><span class="ident" id="4168479">hs</span><span class="op" id="4168481">.</span><span class="ident" id="4168482">clientHello</span><span class="op" id="4168493">.</span><span class="ident" id="4168494">vers</span><span class="op" id="4168498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168501">if</span>&nbsp;<span class="op" id="4168504">!</span><span class="ident" id="4168505">ok</span>&nbsp;<span class="op" id="4168508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168512">c</span><span class="op" id="4168513">.</span><span class="ident" id="4168514">sendAlert</span><span class="op" id="4168523">(</span><span class="ident" id="4168524">alertProtocolVersion</span><span class="op" id="4168544">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168548">return</span>&nbsp;<span class="builtintype" id="4168555">false</span><span class="op" id="4168560">,</span>&nbsp;<span class="ident" id="4168562">fmt</span><span class="op" id="4168565">.</span><span class="ident" id="4168566">Errorf</span><span class="op" id="4168572">(</span><span class="string" id="4168573">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="4168641">,</span>&nbsp;<span class="ident" id="4168643">hs</span><span class="op" id="4168645">.</span><span class="ident" id="4168646">clientHello</span><span class="op" id="4168657">.</span><span class="ident" id="4168658">vers</span><span class="op" id="4168662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4168665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168668">c</span><span class="op" id="4168669">.</span><span class="ident" id="4168670">haveVers</span>&nbsp;<span class="op" id="4168679">=</span>&nbsp;<span class="builtintype" id="4168681">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168688">hs</span><span class="op" id="4168690">.</span><span class="ident" id="4168691">finishedHash</span>&nbsp;<span class="op" id="4168704">=</span>&nbsp;<span class="ident" id="4168706">newFinishedHash</span><span class="op" id="4168721">(</span><span class="ident" id="4168722">c</span><span class="op" id="4168723">.</span><span class="ident" id="4168724">vers</span><span class="op" id="4168728">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168731">hs</span><span class="op" id="4168733">.</span><span class="ident" id="4168734">finishedHash</span><span class="op" id="4168746">.</span><span class="ident" id="4168747">Write</span><span class="op" id="4168752">(</span><span class="ident" id="4168753">hs</span><span class="op" id="4168755">.</span><span class="ident" id="4168756">clientHello</span><span class="op" id="4168767">.</span><span class="ident" id="4168768">marshal</span><span class="op" id="4168775">(</span><span class="op" id="4168776">)</span><span class="op" id="4168777">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168781">hs</span><span class="op" id="4168783">.</span><span class="ident" id="4168784">hello</span>&nbsp;<span class="op" id="4168790">=</span>&nbsp;<span class="builtinfunc" id="4168792">new</span><span class="op" id="4168795">(</span><span class="ident" id="4168796">serverHelloMsg</span><span class="op" id="4168810">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168814">supportedCurve</span>&nbsp;<span class="op" id="4168829">:=</span>&nbsp;<span class="builtintype" id="4168832">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4168839">preferredCurves</span>&nbsp;<span class="op" id="4168855">:=</span>&nbsp;<span class="ident" id="4168858">config</span><span class="op" id="4168864">.</span><span class="ident" id="4168865">curvePreferences</span><span class="op" id="4168881">(</span><span class="op" id="4168882">)</span><br>
<span class="lineno"></span><span class="ident" id="4168884">Curves</span><span class="op" id="4168890">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168893">for</span>&nbsp;<span class="ident" id="4168897">_</span><span class="op" id="4168898">,</span>&nbsp;<span class="ident" id="4168900">curve</span>&nbsp;<span class="op" id="4168906">:=</span>&nbsp;<span class="keyword" id="4168909">range</span>&nbsp;<span class="ident" id="4168915">hs</span><span class="op" id="4168917">.</span><span class="ident" id="4168918">clientHello</span><span class="op" id="4168929">.</span><span class="ident" id="4168930">supportedCurves</span>&nbsp;<span class="op" id="4168946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168950">for</span>&nbsp;<span class="ident" id="4168954">_</span><span class="op" id="4168955">,</span>&nbsp;<span class="ident" id="4168957">supported</span>&nbsp;<span class="op" id="4168967">:=</span>&nbsp;<span class="keyword" id="4168970">range</span>&nbsp;<span class="ident" id="4168976">preferredCurves</span>&nbsp;<span class="op" id="4168992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4168997">if</span>&nbsp;<span class="ident" id="4169000">supported</span>&nbsp;<span class="op" id="4169010">==</span>&nbsp;<span class="ident" id="4169013">curve</span>&nbsp;<span class="op" id="4169019">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169025">supportedCurve</span>&nbsp;<span class="op" id="4169040">=</span>&nbsp;<span class="builtintype" id="4169042">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169051">break</span>&nbsp;<span class="ident" id="4169057">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169074">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169078">supportedPointFormat</span>&nbsp;<span class="op" id="4169099">:=</span>&nbsp;<span class="builtintype" id="4169102">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169109">for</span>&nbsp;<span class="ident" id="4169113">_</span><span class="op" id="4169114">,</span>&nbsp;<span class="ident" id="4169116">pointFormat</span>&nbsp;<span class="op" id="4169128">:=</span>&nbsp;<span class="keyword" id="4169131">range</span>&nbsp;<span class="ident" id="4169137">hs</span><span class="op" id="4169139">.</span><span class="ident" id="4169140">clientHello</span><span class="op" id="4169151">.</span><span class="ident" id="4169152">supportedPoints</span>&nbsp;<span class="op" id="4169168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169172">if</span>&nbsp;<span class="ident" id="4169175">pointFormat</span>&nbsp;<span class="op" id="4169187">==</span>&nbsp;<span class="ident" id="4169190">pointFormatUncompressed</span>&nbsp;<span class="op" id="4169214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169219">supportedPointFormat</span>&nbsp;<span class="op" id="4169240">=</span>&nbsp;<span class="builtintype" id="4169242">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169250">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169264">hs</span><span class="op" id="4169266">.</span><span class="ident" id="4169267">ellipticOk</span>&nbsp;<span class="op" id="4169278">=</span>&nbsp;<span class="ident" id="4169280">supportedCurve</span>&nbsp;<span class="op" id="4169295">&amp;&amp;</span>&nbsp;<span class="ident" id="4169298">supportedPointFormat</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169321">foundCompression</span>&nbsp;<span class="op" id="4169338">:=</span>&nbsp;<span class="builtintype" id="4169341">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4169348">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169423">for</span>&nbsp;<span class="ident" id="4169427">_</span><span class="op" id="4169428">,</span>&nbsp;<span class="ident" id="4169430">compression</span>&nbsp;<span class="op" id="4169442">:=</span>&nbsp;<span class="keyword" id="4169445">range</span>&nbsp;<span class="ident" id="4169451">hs</span><span class="op" id="4169453">.</span><span class="ident" id="4169454">clientHello</span><span class="op" id="4169465">.</span><span class="ident" id="4169466">compressionMethods</span>&nbsp;<span class="op" id="4169485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169489">if</span>&nbsp;<span class="ident" id="4169492">compression</span>&nbsp;<span class="op" id="4169504">==</span>&nbsp;<span class="ident" id="4169507">compressionNone</span>&nbsp;<span class="op" id="4169523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169528">foundCompression</span>&nbsp;<span class="op" id="4169545">=</span>&nbsp;<span class="builtintype" id="4169547">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169555">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169570">if</span>&nbsp;<span class="op" id="4169573">!</span><span class="ident" id="4169574">foundCompression</span>&nbsp;<span class="op" id="4169591">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169595">c</span><span class="op" id="4169596">.</span><span class="ident" id="4169597">sendAlert</span><span class="op" id="4169606">(</span><span class="ident" id="4169607">alertHandshakeFailure</span><span class="op" id="4169628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169632">return</span>&nbsp;<span class="builtintype" id="4169639">false</span><span class="op" id="4169644">,</span>&nbsp;<span class="ident" id="4169646">errors</span><span class="op" id="4169652">.</span><span class="ident" id="4169653">New</span><span class="op" id="4169656">(</span><span class="string" id="4169657">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="4169712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169719">hs</span><span class="op" id="4169721">.</span><span class="ident" id="4169722">hello</span><span class="op" id="4169727">.</span><span class="ident" id="4169728">vers</span>&nbsp;<span class="op" id="4169733">=</span>&nbsp;<span class="ident" id="4169735">c</span><span class="op" id="4169736">.</span><span class="ident" id="4169737">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169743">hs</span><span class="op" id="4169745">.</span><span class="ident" id="4169746">hello</span><span class="op" id="4169751">.</span><span class="ident" id="4169752">random</span>&nbsp;<span class="op" id="4169759">=</span>&nbsp;<span class="builtinfunc" id="4169761">make</span><span class="op" id="4169765">(</span><span class="op" id="4169766">[</span><span class="op" id="4169767">]</span><span class="builtintype" id="4169768">byte</span><span class="op" id="4169772">,</span>&nbsp;<span class="num" id="4169774">32</span><span class="op" id="4169776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169779">_</span><span class="op" id="4169780">,</span>&nbsp;<span class="ident" id="4169782">err</span>&nbsp;<span class="op" id="4169786">=</span>&nbsp;<span class="ident" id="4169788">io</span><span class="op" id="4169790">.</span><span class="ident" id="4169791">ReadFull</span><span class="op" id="4169799">(</span><span class="ident" id="4169800">config</span><span class="op" id="4169806">.</span><span class="ident" id="4169807">rand</span><span class="op" id="4169811">(</span><span class="op" id="4169812">)</span><span class="op" id="4169813">,</span>&nbsp;<span class="ident" id="4169815">hs</span><span class="op" id="4169817">.</span><span class="ident" id="4169818">hello</span><span class="op" id="4169823">.</span><span class="ident" id="4169824">random</span><span class="op" id="4169830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169833">if</span>&nbsp;<span class="ident" id="4169836">err</span>&nbsp;<span class="op" id="4169840">!=</span>&nbsp;<span class="ident" id="4169843">nil</span>&nbsp;<span class="op" id="4169847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169851">c</span><span class="op" id="4169852">.</span><span class="ident" id="4169853">sendAlert</span><span class="op" id="4169862">(</span><span class="ident" id="4169863">alertInternalError</span><span class="op" id="4169881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4169885">return</span>&nbsp;<span class="builtintype" id="4169892">false</span><span class="op" id="4169897">,</span>&nbsp;<span class="ident" id="4169899">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4169904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169907">hs</span><span class="op" id="4169909">.</span><span class="ident" id="4169910">hello</span><span class="op" id="4169915">.</span><span class="ident" id="4169916">secureRenegotiation</span>&nbsp;<span class="op" id="4169936">=</span>&nbsp;<span class="ident" id="4169938">hs</span><span class="op" id="4169940">.</span><span class="ident" id="4169941">clientHello</span><span class="op" id="4169952">.</span><span class="ident" id="4169953">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4169974">hs</span><span class="op" id="4169976">.</span><span class="ident" id="4169977">hello</span><span class="op" id="4169982">.</span><span class="ident" id="4169983">compressionMethod</span>&nbsp;<span class="op" id="4170001">=</span>&nbsp;<span class="ident" id="4170003">compressionNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170020">if</span>&nbsp;<span class="builtinfunc" id="4170023">len</span><span class="op" id="4170026">(</span><span class="ident" id="4170027">hs</span><span class="op" id="4170029">.</span><span class="ident" id="4170030">clientHello</span><span class="op" id="4170041">.</span><span class="ident" id="4170042">serverName</span><span class="op" id="4170052">)</span>&nbsp;<span class="op" id="4170054">&gt;</span>&nbsp;<span class="num" id="4170056">0</span>&nbsp;<span class="op" id="4170058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170062">c</span><span class="op" id="4170063">.</span><span class="ident" id="4170064">serverName</span>&nbsp;<span class="op" id="4170075">=</span>&nbsp;<span class="ident" id="4170077">hs</span><span class="op" id="4170079">.</span><span class="ident" id="4170080">clientHello</span><span class="op" id="4170091">.</span><span class="ident" id="4170092">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170108">if</span>&nbsp;<span class="builtinfunc" id="4170111">len</span><span class="op" id="4170114">(</span><span class="ident" id="4170115">hs</span><span class="op" id="4170117">.</span><span class="ident" id="4170118">clientHello</span><span class="op" id="4170129">.</span><span class="ident" id="4170130">alpnProtocols</span><span class="op" id="4170143">)</span>&nbsp;<span class="op" id="4170145">&gt;</span>&nbsp;<span class="num" id="4170147">0</span>&nbsp;<span class="op" id="4170149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170153">if</span>&nbsp;<span class="ident" id="4170156">selectedProto</span><span class="op" id="4170169">,</span>&nbsp;<span class="ident" id="4170171">fallback</span>&nbsp;<span class="op" id="4170180">:=</span>&nbsp;<span class="ident" id="4170183">mutualProtocol</span><span class="op" id="4170197">(</span><span class="ident" id="4170198">hs</span><span class="op" id="4170200">.</span><span class="ident" id="4170201">clientHello</span><span class="op" id="4170212">.</span><span class="ident" id="4170213">alpnProtocols</span><span class="op" id="4170226">,</span>&nbsp;<span class="ident" id="4170228">c</span><span class="op" id="4170229">.</span><span class="ident" id="4170230">config</span><span class="op" id="4170236">.</span><span class="ident" id="4170237">NextProtos</span><span class="op" id="4170247">)</span><span class="op" id="4170248">;</span>&nbsp;<span class="op" id="4170250">!</span><span class="ident" id="4170251">fallback</span>&nbsp;<span class="op" id="4170260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170265">hs</span><span class="op" id="4170267">.</span><span class="ident" id="4170268">hello</span><span class="op" id="4170273">.</span><span class="ident" id="4170274">alpnProtocol</span>&nbsp;<span class="op" id="4170287">=</span>&nbsp;<span class="ident" id="4170289">selectedProto</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170306">c</span><span class="op" id="4170307">.</span><span class="ident" id="4170308">clientProtocol</span>&nbsp;<span class="op" id="4170323">=</span>&nbsp;<span class="ident" id="4170325">selectedProto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170344">}</span>&nbsp;<span class="keyword" id="4170346">else</span>&nbsp;<span class="op" id="4170351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170355">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170427">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170486">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4170523">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170580">if</span>&nbsp;<span class="ident" id="4170583">hs</span><span class="op" id="4170585">.</span><span class="ident" id="4170586">clientHello</span><span class="op" id="4170597">.</span><span class="ident" id="4170598">nextProtoNeg</span>&nbsp;<span class="op" id="4170611">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4170614">len</span><span class="op" id="4170617">(</span><span class="ident" id="4170618">config</span><span class="op" id="4170624">.</span><span class="ident" id="4170625">NextProtos</span><span class="op" id="4170635">)</span>&nbsp;<span class="op" id="4170637">&gt;</span>&nbsp;<span class="num" id="4170639">0</span>&nbsp;<span class="op" id="4170641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170646">hs</span><span class="op" id="4170648">.</span><span class="ident" id="4170649">hello</span><span class="op" id="4170654">.</span><span class="ident" id="4170655">nextProtoNeg</span>&nbsp;<span class="op" id="4170668">=</span>&nbsp;<span class="builtintype" id="4170670">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170678">hs</span><span class="op" id="4170680">.</span><span class="ident" id="4170681">hello</span><span class="op" id="4170686">.</span><span class="ident" id="4170687">nextProtos</span>&nbsp;<span class="op" id="4170698">=</span>&nbsp;<span class="ident" id="4170700">config</span><span class="op" id="4170706">.</span><span class="ident" id="4170707">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170727">if</span>&nbsp;<span class="builtinfunc" id="4170730">len</span><span class="op" id="4170733">(</span><span class="ident" id="4170734">config</span><span class="op" id="4170740">.</span><span class="ident" id="4170741">Certificates</span><span class="op" id="4170753">)</span>&nbsp;<span class="op" id="4170755">==</span>&nbsp;<span class="num" id="4170758">0</span>&nbsp;<span class="op" id="4170760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170764">c</span><span class="op" id="4170765">.</span><span class="ident" id="4170766">sendAlert</span><span class="op" id="4170775">(</span><span class="ident" id="4170776">alertInternalError</span><span class="op" id="4170794">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170798">return</span>&nbsp;<span class="builtintype" id="4170805">false</span><span class="op" id="4170810">,</span>&nbsp;<span class="ident" id="4170812">errors</span><span class="op" id="4170818">.</span><span class="ident" id="4170819">New</span><span class="op" id="4170822">(</span><span class="string" id="4170823">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="4170856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4170859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170862">hs</span><span class="op" id="4170864">.</span><span class="ident" id="4170865">cert</span>&nbsp;<span class="op" id="4170870">=</span>&nbsp;<span class="op" id="4170872">&amp;</span><span class="ident" id="4170873">config</span><span class="op" id="4170879">.</span><span class="ident" id="4170880">Certificates</span><span class="op" id="4170892">[</span><span class="num" id="4170893">0</span><span class="op" id="4170894">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4170897">if</span>&nbsp;<span class="builtinfunc" id="4170900">len</span><span class="op" id="4170903">(</span><span class="ident" id="4170904">hs</span><span class="op" id="4170906">.</span><span class="ident" id="4170907">clientHello</span><span class="op" id="4170918">.</span><span class="ident" id="4170919">serverName</span><span class="op" id="4170929">)</span>&nbsp;<span class="op" id="4170931">&gt;</span>&nbsp;<span class="num" id="4170933">0</span>&nbsp;<span class="op" id="4170935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170939">chi</span>&nbsp;<span class="op" id="4170943">:=</span>&nbsp;<span class="op" id="4170946">&amp;</span><span class="ident" id="4170947">ClientHelloInfo</span><span class="op" id="4170962">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4170967">CipherSuites</span><span class="op" id="4170979">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4170984">hs</span><span class="op" id="4170986">.</span><span class="ident" id="4170987">clientHello</span><span class="op" id="4170998">.</span><span class="ident" id="4170999">cipherSuites</span><span class="op" id="4171011">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171016">ServerName</span><span class="op" id="4171026">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4171033">hs</span><span class="op" id="4171035">.</span><span class="ident" id="4171036">clientHello</span><span class="op" id="4171047">.</span><span class="ident" id="4171048">serverName</span><span class="op" id="4171058">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171063">SupportedCurves</span><span class="op" id="4171078">:</span>&nbsp;<span class="ident" id="4171080">hs</span><span class="op" id="4171082">.</span><span class="ident" id="4171083">clientHello</span><span class="op" id="4171094">.</span><span class="ident" id="4171095">supportedCurves</span><span class="op" id="4171110">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171115">SupportedPoints</span><span class="op" id="4171130">:</span>&nbsp;<span class="ident" id="4171132">hs</span><span class="op" id="4171134">.</span><span class="ident" id="4171135">clientHello</span><span class="op" id="4171146">.</span><span class="ident" id="4171147">supportedPoints</span><span class="op" id="4171162">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171166">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171170">if</span>&nbsp;<span class="ident" id="4171173">hs</span><span class="op" id="4171175">.</span><span class="ident" id="4171176">cert</span><span class="op" id="4171180">,</span>&nbsp;<span class="ident" id="4171182">err</span>&nbsp;<span class="op" id="4171186">=</span>&nbsp;<span class="ident" id="4171188">config</span><span class="op" id="4171194">.</span><span class="ident" id="4171195">getCertificate</span><span class="op" id="4171209">(</span><span class="ident" id="4171210">chi</span><span class="op" id="4171213">)</span><span class="op" id="4171214">;</span>&nbsp;<span class="ident" id="4171216">err</span>&nbsp;<span class="op" id="4171220">!=</span>&nbsp;<span class="ident" id="4171223">nil</span>&nbsp;<span class="op" id="4171227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171232">c</span><span class="op" id="4171233">.</span><span class="ident" id="4171234">sendAlert</span><span class="op" id="4171243">(</span><span class="ident" id="4171244">alertInternalError</span><span class="op" id="4171262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171267">return</span>&nbsp;<span class="builtintype" id="4171274">false</span><span class="op" id="4171279">,</span>&nbsp;<span class="ident" id="4171281">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171290">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171294">_</span><span class="op" id="4171295">,</span>&nbsp;<span class="ident" id="4171297">hs</span><span class="op" id="4171299">.</span><span class="ident" id="4171300">ecdsaOk</span>&nbsp;<span class="op" id="4171308">=</span>&nbsp;<span class="ident" id="4171310">hs</span><span class="op" id="4171312">.</span><span class="ident" id="4171313">cert</span><span class="op" id="4171317">.</span><span class="ident" id="4171318">PrivateKey</span><span class="op" id="4171328">.</span><span class="op" id="4171329">(</span><span class="op" id="4171330">*</span><span class="ident" id="4171331">ecdsa</span><span class="op" id="4171336">.</span><span class="ident" id="4171337">PrivateKey</span><span class="op" id="4171347">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171351">if</span>&nbsp;<span class="ident" id="4171354">hs</span><span class="op" id="4171356">.</span><span class="ident" id="4171357">checkForResumption</span><span class="op" id="4171375">(</span><span class="op" id="4171376">)</span>&nbsp;<span class="op" id="4171378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171382">return</span>&nbsp;<span class="builtintype" id="4171389">true</span><span class="op" id="4171393">,</span>&nbsp;<span class="ident" id="4171395">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171404">var</span>&nbsp;<span class="ident" id="4171408">preferenceList</span><span class="op" id="4171422">,</span>&nbsp;<span class="ident" id="4171424">supportedList</span>&nbsp;<span class="op" id="4171438">[</span><span class="op" id="4171439">]</span><span class="builtintype" id="4171440">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171448">if</span>&nbsp;<span class="ident" id="4171451">c</span><span class="op" id="4171452">.</span><span class="ident" id="4171453">config</span><span class="op" id="4171459">.</span><span class="ident" id="4171460">PreferServerCipherSuites</span>&nbsp;<span class="op" id="4171485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171489">preferenceList</span>&nbsp;<span class="op" id="4171504">=</span>&nbsp;<span class="ident" id="4171506">c</span><span class="op" id="4171507">.</span><span class="ident" id="4171508">config</span><span class="op" id="4171514">.</span><span class="ident" id="4171515">cipherSuites</span><span class="op" id="4171527">(</span><span class="op" id="4171528">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171532">supportedList</span>&nbsp;<span class="op" id="4171546">=</span>&nbsp;<span class="ident" id="4171548">hs</span><span class="op" id="4171550">.</span><span class="ident" id="4171551">clientHello</span><span class="op" id="4171562">.</span><span class="ident" id="4171563">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171577">}</span>&nbsp;<span class="keyword" id="4171579">else</span>&nbsp;<span class="op" id="4171584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171588">preferenceList</span>&nbsp;<span class="op" id="4171603">=</span>&nbsp;<span class="ident" id="4171605">hs</span><span class="op" id="4171607">.</span><span class="ident" id="4171608">clientHello</span><span class="op" id="4171619">.</span><span class="ident" id="4171620">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171635">supportedList</span>&nbsp;<span class="op" id="4171649">=</span>&nbsp;<span class="ident" id="4171651">c</span><span class="op" id="4171652">.</span><span class="ident" id="4171653">config</span><span class="op" id="4171659">.</span><span class="ident" id="4171660">cipherSuites</span><span class="op" id="4171672">(</span><span class="op" id="4171673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171676">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171680">for</span>&nbsp;<span class="ident" id="4171684">_</span><span class="op" id="4171685">,</span>&nbsp;<span class="ident" id="4171687">id</span>&nbsp;<span class="op" id="4171690">:=</span>&nbsp;<span class="keyword" id="4171693">range</span>&nbsp;<span class="ident" id="4171699">preferenceList</span>&nbsp;<span class="op" id="4171714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171718">if</span>&nbsp;<span class="ident" id="4171721">hs</span><span class="op" id="4171723">.</span><span class="ident" id="4171724">suite</span>&nbsp;<span class="op" id="4171730">=</span>&nbsp;<span class="ident" id="4171732">c</span><span class="op" id="4171733">.</span><span class="ident" id="4171734">tryCipherSuite</span><span class="op" id="4171748">(</span><span class="ident" id="4171749">id</span><span class="op" id="4171751">,</span>&nbsp;<span class="ident" id="4171753">supportedList</span><span class="op" id="4171766">,</span>&nbsp;<span class="ident" id="4171768">c</span><span class="op" id="4171769">.</span><span class="ident" id="4171770">vers</span><span class="op" id="4171774">,</span>&nbsp;<span class="ident" id="4171776">hs</span><span class="op" id="4171778">.</span><span class="ident" id="4171779">ellipticOk</span><span class="op" id="4171789">,</span>&nbsp;<span class="ident" id="4171791">hs</span><span class="op" id="4171793">.</span><span class="ident" id="4171794">ecdsaOk</span><span class="op" id="4171801">)</span><span class="op" id="4171802">;</span>&nbsp;<span class="ident" id="4171804">hs</span><span class="op" id="4171806">.</span><span class="ident" id="4171807">suite</span>&nbsp;<span class="op" id="4171813">!=</span>&nbsp;<span class="ident" id="4171816">nil</span>&nbsp;<span class="op" id="4171820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171825">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171833">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171840">if</span>&nbsp;<span class="ident" id="4171843">hs</span><span class="op" id="4171845">.</span><span class="ident" id="4171846">suite</span>&nbsp;<span class="op" id="4171852">==</span>&nbsp;<span class="ident" id="4171855">nil</span>&nbsp;<span class="op" id="4171859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4171863">c</span><span class="op" id="4171864">.</span><span class="ident" id="4171865">sendAlert</span><span class="op" id="4171874">(</span><span class="ident" id="4171875">alertHandshakeFailure</span><span class="op" id="4171896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4171900">return</span>&nbsp;<span class="builtintype" id="4171907">false</span><span class="op" id="4171912">,</span>&nbsp;<span class="ident" id="4171914">errors</span><span class="op" id="4171920">.</span><span class="ident" id="4171921">New</span><span class="op" id="4171924">(</span><span class="string" id="4171925">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="4171983">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4171986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4171990">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172060">for</span>&nbsp;<span class="ident" id="4172064">_</span><span class="op" id="4172065">,</span>&nbsp;<span class="ident" id="4172067">id</span>&nbsp;<span class="op" id="4172070">:=</span>&nbsp;<span class="keyword" id="4172073">range</span>&nbsp;<span class="ident" id="4172079">hs</span><span class="op" id="4172081">.</span><span class="ident" id="4172082">clientHello</span><span class="op" id="4172093">.</span><span class="ident" id="4172094">cipherSuites</span>&nbsp;<span class="op" id="4172107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172111">if</span>&nbsp;<span class="ident" id="4172114">id</span>&nbsp;<span class="op" id="4172117">==</span>&nbsp;<span class="ident" id="4172120">TLS_FALLBACK_SCSV</span>&nbsp;<span class="op" id="4172138">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172143">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172192">if</span>&nbsp;<span class="ident" id="4172195">hs</span><span class="op" id="4172197">.</span><span class="ident" id="4172198">clientHello</span><span class="op" id="4172209">.</span><span class="ident" id="4172210">vers</span>&nbsp;<span class="op" id="4172215">&lt;</span>&nbsp;<span class="ident" id="4172217">c</span><span class="op" id="4172218">.</span><span class="ident" id="4172219">config</span><span class="op" id="4172225">.</span><span class="ident" id="4172226">MaxVersion</span>&nbsp;<span class="op" id="4172237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172243">c</span><span class="op" id="4172244">.</span><span class="ident" id="4172245">sendAlert</span><span class="op" id="4172254">(</span><span class="ident" id="4172255">alertInappropriateFallback</span><span class="op" id="4172281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172287">return</span>&nbsp;<span class="builtintype" id="4172294">false</span><span class="op" id="4172299">,</span>&nbsp;<span class="ident" id="4172301">errors</span><span class="op" id="4172307">.</span><span class="ident" id="4172308">New</span><span class="op" id="4172311">(</span><span class="string" id="4172312">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="4172362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172367">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172372">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172387">return</span>&nbsp;<span class="builtintype" id="4172394">false</span><span class="op" id="4172399">,</span>&nbsp;<span class="ident" id="4172401">nil</span><br>
<span class="lineno">240</span><span class="op" id="4172405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4172408">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4172495">func</span>&nbsp;<span class="op" id="4172500">(</span><span class="ident" id="4172501">hs</span>&nbsp;<span class="op" id="4172504">*</span><span class="ident" id="4172505">serverHandshakeState</span><span class="op" id="4172525">)</span>&nbsp;<span class="ident" id="4172527">checkForResumption</span><span class="op" id="4172545">(</span><span class="op" id="4172546">)</span>&nbsp;<span class="builtintype" id="4172548">bool</span>&nbsp;<span class="op" id="4172553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172556">c</span>&nbsp;<span class="op" id="4172558">:=</span>&nbsp;<span class="ident" id="4172561">hs</span><span class="op" id="4172563">.</span><span class="ident" id="4172564">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172568">if</span>&nbsp;<span class="ident" id="4172571">c</span><span class="op" id="4172572">.</span><span class="ident" id="4172573">config</span><span class="op" id="4172579">.</span><span class="ident" id="4172580">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4172603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172607">return</span>&nbsp;<span class="builtintype" id="4172614">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172625">var</span>&nbsp;<span class="ident" id="4172629">ok</span>&nbsp;<span class="builtintype" id="4172632">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172638">if</span>&nbsp;<span class="ident" id="4172641">hs</span><span class="op" id="4172643">.</span><span class="ident" id="4172644">sessionState</span><span class="op" id="4172656">,</span>&nbsp;<span class="ident" id="4172658">ok</span>&nbsp;<span class="op" id="4172661">=</span>&nbsp;<span class="ident" id="4172663">c</span><span class="op" id="4172664">.</span><span class="ident" id="4172665">decryptTicket</span><span class="op" id="4172678">(</span><span class="ident" id="4172679">hs</span><span class="op" id="4172681">.</span><span class="ident" id="4172682">clientHello</span><span class="op" id="4172693">.</span><span class="ident" id="4172694">sessionTicket</span><span class="op" id="4172707">)</span><span class="op" id="4172708">;</span>&nbsp;<span class="op" id="4172710">!</span><span class="ident" id="4172711">ok</span>&nbsp;<span class="op" id="4172714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172718">return</span>&nbsp;<span class="builtintype" id="4172725">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172736">if</span>&nbsp;<span class="ident" id="4172739">hs</span><span class="op" id="4172741">.</span><span class="ident" id="4172742">sessionState</span><span class="op" id="4172754">.</span><span class="ident" id="4172755">vers</span>&nbsp;<span class="op" id="4172760">&gt;</span>&nbsp;<span class="ident" id="4172762">hs</span><span class="op" id="4172764">.</span><span class="ident" id="4172765">clientHello</span><span class="op" id="4172776">.</span><span class="ident" id="4172777">vers</span>&nbsp;<span class="op" id="4172782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172786">return</span>&nbsp;<span class="builtintype" id="4172793">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172803">if</span>&nbsp;<span class="ident" id="4172806">vers</span><span class="op" id="4172810">,</span>&nbsp;<span class="ident" id="4172812">ok</span>&nbsp;<span class="op" id="4172815">:=</span>&nbsp;<span class="ident" id="4172818">c</span><span class="op" id="4172819">.</span><span class="ident" id="4172820">config</span><span class="op" id="4172826">.</span><span class="ident" id="4172827">mutualVersion</span><span class="op" id="4172840">(</span><span class="ident" id="4172841">hs</span><span class="op" id="4172843">.</span><span class="ident" id="4172844">sessionState</span><span class="op" id="4172856">.</span><span class="ident" id="4172857">vers</span><span class="op" id="4172861">)</span><span class="op" id="4172862">;</span>&nbsp;<span class="op" id="4172864">!</span><span class="ident" id="4172865">ok</span>&nbsp;<span class="op" id="4172868">||</span>&nbsp;<span class="ident" id="4172871">vers</span>&nbsp;<span class="op" id="4172876">!=</span>&nbsp;<span class="ident" id="4172879">hs</span><span class="op" id="4172881">.</span><span class="ident" id="4172882">sessionState</span><span class="op" id="4172894">.</span><span class="ident" id="4172895">vers</span>&nbsp;<span class="op" id="4172900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4172904">return</span>&nbsp;<span class="builtintype" id="4172911">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4172918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4172922">cipherSuiteOk</span>&nbsp;<span class="op" id="4172936">:=</span>&nbsp;<span class="builtintype" id="4172939">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4172946">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173022">for</span>&nbsp;<span class="ident" id="4173026">_</span><span class="op" id="4173027">,</span>&nbsp;<span class="ident" id="4173029">id</span>&nbsp;<span class="op" id="4173032">:=</span>&nbsp;<span class="keyword" id="4173035">range</span>&nbsp;<span class="ident" id="4173041">hs</span><span class="op" id="4173043">.</span><span class="ident" id="4173044">clientHello</span><span class="op" id="4173055">.</span><span class="ident" id="4173056">cipherSuites</span>&nbsp;<span class="op" id="4173069">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173073">if</span>&nbsp;<span class="ident" id="4173076">id</span>&nbsp;<span class="op" id="4173079">==</span>&nbsp;<span class="ident" id="4173082">hs</span><span class="op" id="4173084">.</span><span class="ident" id="4173085">sessionState</span><span class="op" id="4173097">.</span><span class="ident" id="4173098">cipherSuite</span>&nbsp;<span class="op" id="4173110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173115">cipherSuiteOk</span>&nbsp;<span class="op" id="4173129">=</span>&nbsp;<span class="builtintype" id="4173131">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173139">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173150">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173153">if</span>&nbsp;<span class="op" id="4173156">!</span><span class="ident" id="4173157">cipherSuiteOk</span>&nbsp;<span class="op" id="4173171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173175">return</span>&nbsp;<span class="builtintype" id="4173182">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4173193">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173258">hs</span><span class="op" id="4173260">.</span><span class="ident" id="4173261">suite</span>&nbsp;<span class="op" id="4173267">=</span>&nbsp;<span class="ident" id="4173269">c</span><span class="op" id="4173270">.</span><span class="ident" id="4173271">tryCipherSuite</span><span class="op" id="4173285">(</span><span class="ident" id="4173286">hs</span><span class="op" id="4173288">.</span><span class="ident" id="4173289">sessionState</span><span class="op" id="4173301">.</span><span class="ident" id="4173302">cipherSuite</span><span class="op" id="4173313">,</span>&nbsp;<span class="ident" id="4173315">c</span><span class="op" id="4173316">.</span><span class="ident" id="4173317">config</span><span class="op" id="4173323">.</span><span class="ident" id="4173324">cipherSuites</span><span class="op" id="4173336">(</span><span class="op" id="4173337">)</span><span class="op" id="4173338">,</span>&nbsp;<span class="ident" id="4173340">hs</span><span class="op" id="4173342">.</span><span class="ident" id="4173343">sessionState</span><span class="op" id="4173355">.</span><span class="ident" id="4173356">vers</span><span class="op" id="4173360">,</span>&nbsp;<span class="ident" id="4173362">hs</span><span class="op" id="4173364">.</span><span class="ident" id="4173365">ellipticOk</span><span class="op" id="4173375">,</span>&nbsp;<span class="ident" id="4173377">hs</span><span class="op" id="4173379">.</span><span class="ident" id="4173380">ecdsaOk</span><span class="op" id="4173387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173390">if</span>&nbsp;<span class="ident" id="4173393">hs</span><span class="op" id="4173395">.</span><span class="ident" id="4173396">suite</span>&nbsp;<span class="op" id="4173402">==</span>&nbsp;<span class="ident" id="4173405">nil</span>&nbsp;<span class="op" id="4173409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173413">return</span>&nbsp;<span class="builtintype" id="4173420">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173431">sessionHasClientCerts</span>&nbsp;<span class="op" id="4173453">:=</span>&nbsp;<span class="builtinfunc" id="4173456">len</span><span class="op" id="4173459">(</span><span class="ident" id="4173460">hs</span><span class="op" id="4173462">.</span><span class="ident" id="4173463">sessionState</span><span class="op" id="4173475">.</span><span class="ident" id="4173476">certificates</span><span class="op" id="4173488">)</span>&nbsp;<span class="op" id="4173490">!=</span>&nbsp;<span class="num" id="4173493">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173496">needClientCerts</span>&nbsp;<span class="op" id="4173512">:=</span>&nbsp;<span class="ident" id="4173515">c</span><span class="op" id="4173516">.</span><span class="ident" id="4173517">config</span><span class="op" id="4173523">.</span><span class="ident" id="4173524">ClientAuth</span>&nbsp;<span class="op" id="4173535">==</span>&nbsp;<span class="ident" id="4173538">RequireAnyClientCert</span>&nbsp;<span class="op" id="4173559">||</span>&nbsp;<span class="ident" id="4173562">c</span><span class="op" id="4173563">.</span><span class="ident" id="4173564">config</span><span class="op" id="4173570">.</span><span class="ident" id="4173571">ClientAuth</span>&nbsp;<span class="op" id="4173582">==</span>&nbsp;<span class="ident" id="4173585">RequireAndVerifyClientCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173613">if</span>&nbsp;<span class="ident" id="4173616">needClientCerts</span>&nbsp;<span class="op" id="4173632">&amp;&amp;</span>&nbsp;<span class="op" id="4173635">!</span><span class="ident" id="4173636">sessionHasClientCerts</span>&nbsp;<span class="op" id="4173658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173662">return</span>&nbsp;<span class="builtintype" id="4173669">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173676">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173679">if</span>&nbsp;<span class="ident" id="4173682">sessionHasClientCerts</span>&nbsp;<span class="op" id="4173704">&amp;&amp;</span>&nbsp;<span class="ident" id="4173707">c</span><span class="op" id="4173708">.</span><span class="ident" id="4173709">config</span><span class="op" id="4173715">.</span><span class="ident" id="4173716">ClientAuth</span>&nbsp;<span class="op" id="4173727">==</span>&nbsp;<span class="ident" id="4173730">NoClientCert</span>&nbsp;<span class="op" id="4173743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173747">return</span>&nbsp;<span class="builtintype" id="4173754">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4173761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4173765">return</span>&nbsp;<span class="builtintype" id="4173772">true</span><br>
<span class="lineno">290</span><span class="op" id="4173777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4173780">func</span>&nbsp;<span class="op" id="4173785">(</span><span class="ident" id="4173786">hs</span>&nbsp;<span class="op" id="4173789">*</span><span class="ident" id="4173790">serverHandshakeState</span><span class="op" id="4173810">)</span>&nbsp;<span class="ident" id="4173812">doResumeHandshake</span><span class="op" id="4173829">(</span><span class="op" id="4173830">)</span>&nbsp;<span class="builtintype" id="4173832">error</span>&nbsp;<span class="op" id="4173838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173841">c</span>&nbsp;<span class="op" id="4173843">:=</span>&nbsp;<span class="ident" id="4173846">hs</span><span class="op" id="4173848">.</span><span class="ident" id="4173849">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173853">hs</span><span class="op" id="4173855">.</span><span class="ident" id="4173856">hello</span><span class="op" id="4173861">.</span><span class="ident" id="4173862">cipherSuite</span>&nbsp;<span class="op" id="4173874">=</span>&nbsp;<span class="ident" id="4173876">hs</span><span class="op" id="4173878">.</span><span class="ident" id="4173879">suite</span><span class="op" id="4173884">.</span><span class="ident" id="4173885">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4173889">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4173959">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4173994">hs</span><span class="op" id="4173996">.</span><span class="ident" id="4173997">hello</span><span class="op" id="4174002">.</span><span class="ident" id="4174003">sessionId</span>&nbsp;<span class="op" id="4174013">=</span>&nbsp;<span class="ident" id="4174015">hs</span><span class="op" id="4174017">.</span><span class="ident" id="4174018">clientHello</span><span class="op" id="4174029">.</span><span class="ident" id="4174030">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174041">hs</span><span class="op" id="4174043">.</span><span class="ident" id="4174044">finishedHash</span><span class="op" id="4174056">.</span><span class="ident" id="4174057">Write</span><span class="op" id="4174062">(</span><span class="ident" id="4174063">hs</span><span class="op" id="4174065">.</span><span class="ident" id="4174066">hello</span><span class="op" id="4174071">.</span><span class="ident" id="4174072">marshal</span><span class="op" id="4174079">(</span><span class="op" id="4174080">)</span><span class="op" id="4174081">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174084">c</span><span class="op" id="4174085">.</span><span class="ident" id="4174086">writeRecord</span><span class="op" id="4174097">(</span><span class="ident" id="4174098">recordTypeHandshake</span><span class="op" id="4174117">,</span>&nbsp;<span class="ident" id="4174119">hs</span><span class="op" id="4174121">.</span><span class="ident" id="4174122">hello</span><span class="op" id="4174127">.</span><span class="ident" id="4174128">marshal</span><span class="op" id="4174135">(</span><span class="op" id="4174136">)</span><span class="op" id="4174137">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174141">if</span>&nbsp;<span class="builtinfunc" id="4174144">len</span><span class="op" id="4174147">(</span><span class="ident" id="4174148">hs</span><span class="op" id="4174150">.</span><span class="ident" id="4174151">sessionState</span><span class="op" id="4174163">.</span><span class="ident" id="4174164">certificates</span><span class="op" id="4174176">)</span>&nbsp;<span class="op" id="4174178">&gt;</span>&nbsp;<span class="num" id="4174180">0</span>&nbsp;<span class="op" id="4174182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174186">if</span>&nbsp;<span class="ident" id="4174189">_</span><span class="op" id="4174190">,</span>&nbsp;<span class="ident" id="4174192">err</span>&nbsp;<span class="op" id="4174196">:=</span>&nbsp;<span class="ident" id="4174199">hs</span><span class="op" id="4174201">.</span><span class="ident" id="4174202">processCertsFromClient</span><span class="op" id="4174224">(</span><span class="ident" id="4174225">hs</span><span class="op" id="4174227">.</span><span class="ident" id="4174228">sessionState</span><span class="op" id="4174240">.</span><span class="ident" id="4174241">certificates</span><span class="op" id="4174253">)</span><span class="op" id="4174254">;</span>&nbsp;<span class="ident" id="4174256">err</span>&nbsp;<span class="op" id="4174260">!=</span>&nbsp;<span class="ident" id="4174263">nil</span>&nbsp;<span class="op" id="4174267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174272">return</span>&nbsp;<span class="ident" id="4174279">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174292">hs</span><span class="op" id="4174294">.</span><span class="ident" id="4174295">masterSecret</span>&nbsp;<span class="op" id="4174308">=</span>&nbsp;<span class="ident" id="4174310">hs</span><span class="op" id="4174312">.</span><span class="ident" id="4174313">sessionState</span><span class="op" id="4174325">.</span><span class="ident" id="4174326">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174341">return</span>&nbsp;<span class="ident" id="4174348">nil</span><br>
<span class="lineno"></span><span class="op" id="4174352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4174355">func</span>&nbsp;<span class="op" id="4174360">(</span><span class="ident" id="4174361">hs</span>&nbsp;<span class="op" id="4174364">*</span><span class="ident" id="4174365">serverHandshakeState</span><span class="op" id="4174385">)</span>&nbsp;<span class="ident" id="4174387">doFullHandshake</span><span class="op" id="4174402">(</span><span class="op" id="4174403">)</span>&nbsp;<span class="builtintype" id="4174405">error</span>&nbsp;<span class="op" id="4174411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174414">config</span>&nbsp;<span class="op" id="4174421">:=</span>&nbsp;<span class="ident" id="4174424">hs</span><span class="op" id="4174426">.</span><span class="ident" id="4174427">c</span><span class="op" id="4174428">.</span><span class="ident" id="4174429">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174437">c</span>&nbsp;<span class="op" id="4174439">:=</span>&nbsp;<span class="ident" id="4174442">hs</span><span class="op" id="4174444">.</span><span class="ident" id="4174445">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174449">if</span>&nbsp;<span class="ident" id="4174452">hs</span><span class="op" id="4174454">.</span><span class="ident" id="4174455">clientHello</span><span class="op" id="4174466">.</span><span class="ident" id="4174467">ocspStapling</span>&nbsp;<span class="op" id="4174480">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4174483">len</span><span class="op" id="4174486">(</span><span class="ident" id="4174487">hs</span><span class="op" id="4174489">.</span><span class="ident" id="4174490">cert</span><span class="op" id="4174494">.</span><span class="ident" id="4174495">OCSPStaple</span><span class="op" id="4174505">)</span>&nbsp;<span class="op" id="4174507">&gt;</span>&nbsp;<span class="num" id="4174509">0</span>&nbsp;<span class="op" id="4174511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174515">hs</span><span class="op" id="4174517">.</span><span class="ident" id="4174518">hello</span><span class="op" id="4174523">.</span><span class="ident" id="4174524">ocspStapling</span>&nbsp;<span class="op" id="4174537">=</span>&nbsp;<span class="builtintype" id="4174539">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4174545">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174549">hs</span><span class="op" id="4174551">.</span><span class="ident" id="4174552">hello</span><span class="op" id="4174557">.</span><span class="ident" id="4174558">ticketSupported</span>&nbsp;<span class="op" id="4174574">=</span>&nbsp;<span class="ident" id="4174576">hs</span><span class="op" id="4174578">.</span><span class="ident" id="4174579">clientHello</span><span class="op" id="4174590">.</span><span class="ident" id="4174591">ticketSupported</span>&nbsp;<span class="op" id="4174607">&amp;&amp;</span>&nbsp;<span class="op" id="4174610">!</span><span class="ident" id="4174611">config</span><span class="op" id="4174617">.</span><span class="ident" id="4174618">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174642">hs</span><span class="op" id="4174644">.</span><span class="ident" id="4174645">hello</span><span class="op" id="4174650">.</span><span class="ident" id="4174651">cipherSuite</span>&nbsp;<span class="op" id="4174663">=</span>&nbsp;<span class="ident" id="4174665">hs</span><span class="op" id="4174667">.</span><span class="ident" id="4174668">suite</span><span class="op" id="4174673">.</span><span class="ident" id="4174674">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174678">hs</span><span class="op" id="4174680">.</span><span class="ident" id="4174681">finishedHash</span><span class="op" id="4174693">.</span><span class="ident" id="4174694">Write</span><span class="op" id="4174699">(</span><span class="ident" id="4174700">hs</span><span class="op" id="4174702">.</span><span class="ident" id="4174703">hello</span><span class="op" id="4174708">.</span><span class="ident" id="4174709">marshal</span><span class="op" id="4174716">(</span><span class="op" id="4174717">)</span><span class="op" id="4174718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174721">c</span><span class="op" id="4174722">.</span><span class="ident" id="4174723">writeRecord</span><span class="op" id="4174734">(</span><span class="ident" id="4174735">recordTypeHandshake</span><span class="op" id="4174754">,</span>&nbsp;<span class="ident" id="4174756">hs</span><span class="op" id="4174758">.</span><span class="ident" id="4174759">hello</span><span class="op" id="4174764">.</span><span class="ident" id="4174765">marshal</span><span class="op" id="4174772">(</span><span class="op" id="4174773">)</span><span class="op" id="4174774">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174778">certMsg</span>&nbsp;<span class="op" id="4174786">:=</span>&nbsp;<span class="builtinfunc" id="4174789">new</span><span class="op" id="4174792">(</span><span class="ident" id="4174793">certificateMsg</span><span class="op" id="4174807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174810">certMsg</span><span class="op" id="4174817">.</span><span class="ident" id="4174818">certificates</span>&nbsp;<span class="op" id="4174831">=</span>&nbsp;<span class="ident" id="4174833">hs</span><span class="op" id="4174835">.</span><span class="ident" id="4174836">cert</span><span class="op" id="4174840">.</span><span class="ident" id="4174841">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174854">hs</span><span class="op" id="4174856">.</span><span class="ident" id="4174857">finishedHash</span><span class="op" id="4174869">.</span><span class="ident" id="4174870">Write</span><span class="op" id="4174875">(</span><span class="ident" id="4174876">certMsg</span><span class="op" id="4174883">.</span><span class="ident" id="4174884">marshal</span><span class="op" id="4174891">(</span><span class="op" id="4174892">)</span><span class="op" id="4174893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174896">c</span><span class="op" id="4174897">.</span><span class="ident" id="4174898">writeRecord</span><span class="op" id="4174909">(</span><span class="ident" id="4174910">recordTypeHandshake</span><span class="op" id="4174929">,</span>&nbsp;<span class="ident" id="4174931">certMsg</span><span class="op" id="4174938">.</span><span class="ident" id="4174939">marshal</span><span class="op" id="4174946">(</span><span class="op" id="4174947">)</span><span class="op" id="4174948">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4174952">if</span>&nbsp;<span class="ident" id="4174955">hs</span><span class="op" id="4174957">.</span><span class="ident" id="4174958">hello</span><span class="op" id="4174963">.</span><span class="ident" id="4174964">ocspStapling</span>&nbsp;<span class="op" id="4174977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4174981">certStatus</span>&nbsp;<span class="op" id="4174992">:=</span>&nbsp;<span class="builtinfunc" id="4174995">new</span><span class="op" id="4174998">(</span><span class="ident" id="4174999">certificateStatusMsg</span><span class="op" id="4175019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175023">certStatus</span><span class="op" id="4175033">.</span><span class="ident" id="4175034">statusType</span>&nbsp;<span class="op" id="4175045">=</span>&nbsp;<span class="ident" id="4175047">statusTypeOCSP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175064">certStatus</span><span class="op" id="4175074">.</span><span class="ident" id="4175075">response</span>&nbsp;<span class="op" id="4175084">=</span>&nbsp;<span class="ident" id="4175086">hs</span><span class="op" id="4175088">.</span><span class="ident" id="4175089">cert</span><span class="op" id="4175093">.</span><span class="ident" id="4175094">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175107">hs</span><span class="op" id="4175109">.</span><span class="ident" id="4175110">finishedHash</span><span class="op" id="4175122">.</span><span class="ident" id="4175123">Write</span><span class="op" id="4175128">(</span><span class="ident" id="4175129">certStatus</span><span class="op" id="4175139">.</span><span class="ident" id="4175140">marshal</span><span class="op" id="4175147">(</span><span class="op" id="4175148">)</span><span class="op" id="4175149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175153">c</span><span class="op" id="4175154">.</span><span class="ident" id="4175155">writeRecord</span><span class="op" id="4175166">(</span><span class="ident" id="4175167">recordTypeHandshake</span><span class="op" id="4175186">,</span>&nbsp;<span class="ident" id="4175188">certStatus</span><span class="op" id="4175198">.</span><span class="ident" id="4175199">marshal</span><span class="op" id="4175206">(</span><span class="op" id="4175207">)</span><span class="op" id="4175208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175215">keyAgreement</span>&nbsp;<span class="op" id="4175228">:=</span>&nbsp;<span class="ident" id="4175231">hs</span><span class="op" id="4175233">.</span><span class="ident" id="4175234">suite</span><span class="op" id="4175239">.</span><span class="ident" id="4175240">ka</span><span class="op" id="4175242">(</span><span class="ident" id="4175243">c</span><span class="op" id="4175244">.</span><span class="ident" id="4175245">vers</span><span class="op" id="4175249">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175252">skx</span><span class="op" id="4175255">,</span>&nbsp;<span class="ident" id="4175257">err</span>&nbsp;<span class="op" id="4175261">:=</span>&nbsp;<span class="ident" id="4175264">keyAgreement</span><span class="op" id="4175276">.</span><span class="ident" id="4175277">generateServerKeyExchange</span><span class="op" id="4175302">(</span><span class="ident" id="4175303">config</span><span class="op" id="4175309">,</span>&nbsp;<span class="ident" id="4175311">hs</span><span class="op" id="4175313">.</span><span class="ident" id="4175314">cert</span><span class="op" id="4175318">,</span>&nbsp;<span class="ident" id="4175320">hs</span><span class="op" id="4175322">.</span><span class="ident" id="4175323">clientHello</span><span class="op" id="4175334">,</span>&nbsp;<span class="ident" id="4175336">hs</span><span class="op" id="4175338">.</span><span class="ident" id="4175339">hello</span><span class="op" id="4175344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175347">if</span>&nbsp;<span class="ident" id="4175350">err</span>&nbsp;<span class="op" id="4175354">!=</span>&nbsp;<span class="ident" id="4175357">nil</span>&nbsp;<span class="op" id="4175361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175365">c</span><span class="op" id="4175366">.</span><span class="ident" id="4175367">sendAlert</span><span class="op" id="4175376">(</span><span class="ident" id="4175377">alertHandshakeFailure</span><span class="op" id="4175398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175402">return</span>&nbsp;<span class="ident" id="4175409">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175414">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175417">if</span>&nbsp;<span class="ident" id="4175420">skx</span>&nbsp;<span class="op" id="4175424">!=</span>&nbsp;<span class="ident" id="4175427">nil</span>&nbsp;<span class="op" id="4175431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175435">hs</span><span class="op" id="4175437">.</span><span class="ident" id="4175438">finishedHash</span><span class="op" id="4175450">.</span><span class="ident" id="4175451">Write</span><span class="op" id="4175456">(</span><span class="ident" id="4175457">skx</span><span class="op" id="4175460">.</span><span class="ident" id="4175461">marshal</span><span class="op" id="4175468">(</span><span class="op" id="4175469">)</span><span class="op" id="4175470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175474">c</span><span class="op" id="4175475">.</span><span class="ident" id="4175476">writeRecord</span><span class="op" id="4175487">(</span><span class="ident" id="4175488">recordTypeHandshake</span><span class="op" id="4175507">,</span>&nbsp;<span class="ident" id="4175509">skx</span><span class="op" id="4175512">.</span><span class="ident" id="4175513">marshal</span><span class="op" id="4175520">(</span><span class="op" id="4175521">)</span><span class="op" id="4175522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175529">if</span>&nbsp;<span class="ident" id="4175532">config</span><span class="op" id="4175538">.</span><span class="ident" id="4175539">ClientAuth</span>&nbsp;<span class="op" id="4175550">&gt;=</span>&nbsp;<span class="ident" id="4175553">RequestClientCert</span>&nbsp;<span class="op" id="4175571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4175575">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175609">certReq</span>&nbsp;<span class="op" id="4175617">:=</span>&nbsp;<span class="builtinfunc" id="4175620">new</span><span class="op" id="4175623">(</span><span class="ident" id="4175624">certificateRequestMsg</span><span class="op" id="4175645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175649">certReq</span><span class="op" id="4175656">.</span><span class="ident" id="4175657">certificateTypes</span>&nbsp;<span class="op" id="4175674">=</span>&nbsp;<span class="op" id="4175676">[</span><span class="op" id="4175677">]</span><span class="builtintype" id="4175678">byte</span><span class="op" id="4175682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4175687">byte</span><span class="op" id="4175691">(</span><span class="ident" id="4175692">certTypeRSASign</span><span class="op" id="4175707">)</span><span class="op" id="4175708">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4175713">byte</span><span class="op" id="4175717">(</span><span class="ident" id="4175718">certTypeECDSASign</span><span class="op" id="4175735">)</span><span class="op" id="4175736">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4175744">if</span>&nbsp;<span class="ident" id="4175747">c</span><span class="op" id="4175748">.</span><span class="ident" id="4175749">vers</span>&nbsp;<span class="op" id="4175754">&gt;=</span>&nbsp;<span class="ident" id="4175757">VersionTLS12</span>&nbsp;<span class="op" id="4175770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175775">certReq</span><span class="op" id="4175782">.</span><span class="ident" id="4175783">hasSignatureAndHash</span>&nbsp;<span class="op" id="4175803">=</span>&nbsp;<span class="builtintype" id="4175805">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4175813">certReq</span><span class="op" id="4175820">.</span><span class="ident" id="4175821">signatureAndHashes</span>&nbsp;<span class="op" id="4175840">=</span>&nbsp;<span class="ident" id="4175842">supportedClientCertSignatureAlgorithms</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4175883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4175888">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4175944">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4176005">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4176062">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4176120">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176167">if</span>&nbsp;<span class="ident" id="4176170">config</span><span class="op" id="4176176">.</span><span class="ident" id="4176177">ClientCAs</span>&nbsp;<span class="op" id="4176187">!=</span>&nbsp;<span class="ident" id="4176190">nil</span>&nbsp;<span class="op" id="4176194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176199">certReq</span><span class="op" id="4176206">.</span><span class="ident" id="4176207">certificateAuthorities</span>&nbsp;<span class="op" id="4176230">=</span>&nbsp;<span class="ident" id="4176232">config</span><span class="op" id="4176238">.</span><span class="ident" id="4176239">ClientCAs</span><span class="op" id="4176248">.</span><span class="ident" id="4176249">Subjects</span><span class="op" id="4176257">(</span><span class="op" id="4176258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4176262">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176266">hs</span><span class="op" id="4176268">.</span><span class="ident" id="4176269">finishedHash</span><span class="op" id="4176281">.</span><span class="ident" id="4176282">Write</span><span class="op" id="4176287">(</span><span class="ident" id="4176288">certReq</span><span class="op" id="4176295">.</span><span class="ident" id="4176296">marshal</span><span class="op" id="4176303">(</span><span class="op" id="4176304">)</span><span class="op" id="4176305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176309">c</span><span class="op" id="4176310">.</span><span class="ident" id="4176311">writeRecord</span><span class="op" id="4176322">(</span><span class="ident" id="4176323">recordTypeHandshake</span><span class="op" id="4176342">,</span>&nbsp;<span class="ident" id="4176344">certReq</span><span class="op" id="4176351">.</span><span class="ident" id="4176352">marshal</span><span class="op" id="4176359">(</span><span class="op" id="4176360">)</span><span class="op" id="4176361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4176364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176368">helloDone</span>&nbsp;<span class="op" id="4176378">:=</span>&nbsp;<span class="builtinfunc" id="4176381">new</span><span class="op" id="4176384">(</span><span class="ident" id="4176385">serverHelloDoneMsg</span><span class="op" id="4176403">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176406">hs</span><span class="op" id="4176408">.</span><span class="ident" id="4176409">finishedHash</span><span class="op" id="4176421">.</span><span class="ident" id="4176422">Write</span><span class="op" id="4176427">(</span><span class="ident" id="4176428">helloDone</span><span class="op" id="4176437">.</span><span class="ident" id="4176438">marshal</span><span class="op" id="4176445">(</span><span class="op" id="4176446">)</span><span class="op" id="4176447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176450">c</span><span class="op" id="4176451">.</span><span class="ident" id="4176452">writeRecord</span><span class="op" id="4176463">(</span><span class="ident" id="4176464">recordTypeHandshake</span><span class="op" id="4176483">,</span>&nbsp;<span class="ident" id="4176485">helloDone</span><span class="op" id="4176494">.</span><span class="ident" id="4176495">marshal</span><span class="op" id="4176502">(</span><span class="op" id="4176503">)</span><span class="op" id="4176504">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176508">var</span>&nbsp;<span class="ident" id="4176512">pub</span>&nbsp;<span class="ident" id="4176516">crypto</span><span class="op" id="4176522">.</span><span class="ident" id="4176523">PublicKey</span>&nbsp;<span class="comment" id="4176533">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176573">msg</span><span class="op" id="4176576">,</span>&nbsp;<span class="ident" id="4176578">err</span>&nbsp;<span class="op" id="4176582">:=</span>&nbsp;<span class="ident" id="4176585">c</span><span class="op" id="4176586">.</span><span class="ident" id="4176587">readHandshake</span><span class="op" id="4176600">(</span><span class="op" id="4176601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176604">if</span>&nbsp;<span class="ident" id="4176607">err</span>&nbsp;<span class="op" id="4176611">!=</span>&nbsp;<span class="ident" id="4176614">nil</span>&nbsp;<span class="op" id="4176618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176622">return</span>&nbsp;<span class="ident" id="4176629">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4176634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176638">var</span>&nbsp;<span class="ident" id="4176642">ok</span>&nbsp;<span class="builtintype" id="4176645">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4176651">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4176721">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176766">if</span>&nbsp;<span class="ident" id="4176769">config</span><span class="op" id="4176775">.</span><span class="ident" id="4176776">ClientAuth</span>&nbsp;<span class="op" id="4176787">&gt;=</span>&nbsp;<span class="ident" id="4176790">RequestClientCert</span>&nbsp;<span class="op" id="4176808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176812">if</span>&nbsp;<span class="ident" id="4176815">certMsg</span><span class="op" id="4176822">,</span>&nbsp;<span class="ident" id="4176824">ok</span>&nbsp;<span class="op" id="4176827">=</span>&nbsp;<span class="ident" id="4176829">msg</span><span class="op" id="4176832">.</span><span class="op" id="4176833">(</span><span class="op" id="4176834">*</span><span class="ident" id="4176835">certificateMsg</span><span class="op" id="4176849">)</span><span class="op" id="4176850">;</span>&nbsp;<span class="op" id="4176852">!</span><span class="ident" id="4176853">ok</span>&nbsp;<span class="op" id="4176856">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176861">c</span><span class="op" id="4176862">.</span><span class="ident" id="4176863">sendAlert</span><span class="op" id="4176872">(</span><span class="ident" id="4176873">alertUnexpectedMessage</span><span class="op" id="4176895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176900">return</span>&nbsp;<span class="ident" id="4176907">unexpectedMessageError</span><span class="op" id="4176929">(</span><span class="ident" id="4176930">certMsg</span><span class="op" id="4176937">,</span>&nbsp;<span class="ident" id="4176939">msg</span><span class="op" id="4176942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4176946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4176950">hs</span><span class="op" id="4176952">.</span><span class="ident" id="4176953">finishedHash</span><span class="op" id="4176965">.</span><span class="ident" id="4176966">Write</span><span class="op" id="4176971">(</span><span class="ident" id="4176972">certMsg</span><span class="op" id="4176979">.</span><span class="ident" id="4176980">marshal</span><span class="op" id="4176987">(</span><span class="op" id="4176988">)</span><span class="op" id="4176989">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4176994">if</span>&nbsp;<span class="builtinfunc" id="4176997">len</span><span class="op" id="4177000">(</span><span class="ident" id="4177001">certMsg</span><span class="op" id="4177008">.</span><span class="ident" id="4177009">certificates</span><span class="op" id="4177021">)</span>&nbsp;<span class="op" id="4177023">==</span>&nbsp;<span class="num" id="4177026">0</span>&nbsp;<span class="op" id="4177028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177033">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177085">switch</span>&nbsp;<span class="ident" id="4177092">config</span><span class="op" id="4177098">.</span><span class="ident" id="4177099">ClientAuth</span>&nbsp;<span class="op" id="4177110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177115">case</span>&nbsp;<span class="ident" id="4177120">RequireAnyClientCert</span><span class="op" id="4177140">,</span>&nbsp;<span class="ident" id="4177142">RequireAndVerifyClientCert</span><span class="op" id="4177168">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177174">c</span><span class="op" id="4177175">.</span><span class="ident" id="4177176">sendAlert</span><span class="op" id="4177185">(</span><span class="ident" id="4177186">alertBadCertificate</span><span class="op" id="4177205">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177211">return</span>&nbsp;<span class="ident" id="4177218">errors</span><span class="op" id="4177224">.</span><span class="ident" id="4177225">New</span><span class="op" id="4177228">(</span><span class="string" id="4177229">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="4177271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177285">pub</span><span class="op" id="4177288">,</span>&nbsp;<span class="ident" id="4177290">err</span>&nbsp;<span class="op" id="4177294">=</span>&nbsp;<span class="ident" id="4177296">hs</span><span class="op" id="4177298">.</span><span class="ident" id="4177299">processCertsFromClient</span><span class="op" id="4177321">(</span><span class="ident" id="4177322">certMsg</span><span class="op" id="4177329">.</span><span class="ident" id="4177330">certificates</span><span class="op" id="4177342">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177346">if</span>&nbsp;<span class="ident" id="4177349">err</span>&nbsp;<span class="op" id="4177353">!=</span>&nbsp;<span class="ident" id="4177356">nil</span>&nbsp;<span class="op" id="4177360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177365">return</span>&nbsp;<span class="ident" id="4177372">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177383">msg</span><span class="op" id="4177386">,</span>&nbsp;<span class="ident" id="4177388">err</span>&nbsp;<span class="op" id="4177392">=</span>&nbsp;<span class="ident" id="4177394">c</span><span class="op" id="4177395">.</span><span class="ident" id="4177396">readHandshake</span><span class="op" id="4177409">(</span><span class="op" id="4177410">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177414">if</span>&nbsp;<span class="ident" id="4177417">err</span>&nbsp;<span class="op" id="4177421">!=</span>&nbsp;<span class="ident" id="4177424">nil</span>&nbsp;<span class="op" id="4177428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177433">return</span>&nbsp;<span class="ident" id="4177440">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177453">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177481">ckx</span><span class="op" id="4177484">,</span>&nbsp;<span class="ident" id="4177486">ok</span>&nbsp;<span class="op" id="4177489">:=</span>&nbsp;<span class="ident" id="4177492">msg</span><span class="op" id="4177495">.</span><span class="op" id="4177496">(</span><span class="op" id="4177497">*</span><span class="ident" id="4177498">clientKeyExchangeMsg</span><span class="op" id="4177518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177521">if</span>&nbsp;<span class="op" id="4177524">!</span><span class="ident" id="4177525">ok</span>&nbsp;<span class="op" id="4177528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177532">c</span><span class="op" id="4177533">.</span><span class="ident" id="4177534">sendAlert</span><span class="op" id="4177543">(</span><span class="ident" id="4177544">alertUnexpectedMessage</span><span class="op" id="4177566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4177570">return</span>&nbsp;<span class="ident" id="4177577">unexpectedMessageError</span><span class="op" id="4177599">(</span><span class="ident" id="4177600">ckx</span><span class="op" id="4177603">,</span>&nbsp;<span class="ident" id="4177605">msg</span><span class="op" id="4177608">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4177611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4177614">hs</span><span class="op" id="4177616">.</span><span class="ident" id="4177617">finishedHash</span><span class="op" id="4177629">.</span><span class="ident" id="4177630">Write</span><span class="op" id="4177635">(</span><span class="ident" id="4177636">ckx</span><span class="op" id="4177639">.</span><span class="ident" id="4177640">marshal</span><span class="op" id="4177647">(</span><span class="op" id="4177648">)</span><span class="op" id="4177649">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177653">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177734">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177807">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177876">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4177956">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4178036">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178090">if</span>&nbsp;<span class="builtinfunc" id="4178093">len</span><span class="op" id="4178096">(</span><span class="ident" id="4178097">c</span><span class="op" id="4178098">.</span><span class="ident" id="4178099">peerCertificates</span><span class="op" id="4178115">)</span>&nbsp;<span class="op" id="4178117">&gt;</span>&nbsp;<span class="num" id="4178119">0</span>&nbsp;<span class="op" id="4178121">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178125">msg</span><span class="op" id="4178128">,</span>&nbsp;<span class="ident" id="4178130">err</span>&nbsp;<span class="op" id="4178134">=</span>&nbsp;<span class="ident" id="4178136">c</span><span class="op" id="4178137">.</span><span class="ident" id="4178138">readHandshake</span><span class="op" id="4178151">(</span><span class="op" id="4178152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178156">if</span>&nbsp;<span class="ident" id="4178159">err</span>&nbsp;<span class="op" id="4178163">!=</span>&nbsp;<span class="ident" id="4178166">nil</span>&nbsp;<span class="op" id="4178170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178175">return</span>&nbsp;<span class="ident" id="4178182">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4178188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178192">certVerify</span><span class="op" id="4178202">,</span>&nbsp;<span class="ident" id="4178204">ok</span>&nbsp;<span class="op" id="4178207">:=</span>&nbsp;<span class="ident" id="4178210">msg</span><span class="op" id="4178213">.</span><span class="op" id="4178214">(</span><span class="op" id="4178215">*</span><span class="ident" id="4178216">certificateVerifyMsg</span><span class="op" id="4178236">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178240">if</span>&nbsp;<span class="op" id="4178243">!</span><span class="ident" id="4178244">ok</span>&nbsp;<span class="op" id="4178247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178252">c</span><span class="op" id="4178253">.</span><span class="ident" id="4178254">sendAlert</span><span class="op" id="4178263">(</span><span class="ident" id="4178264">alertUnexpectedMessage</span><span class="op" id="4178286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178291">return</span>&nbsp;<span class="ident" id="4178298">unexpectedMessageError</span><span class="op" id="4178320">(</span><span class="ident" id="4178321">certVerify</span><span class="op" id="4178331">,</span>&nbsp;<span class="ident" id="4178333">msg</span><span class="op" id="4178336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4178340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178345">switch</span>&nbsp;<span class="ident" id="4178352">key</span>&nbsp;<span class="op" id="4178356">:=</span>&nbsp;<span class="ident" id="4178359">pub</span><span class="op" id="4178362">.</span><span class="op" id="4178363">(</span><span class="keyword" id="4178364">type</span><span class="op" id="4178368">)</span>&nbsp;<span class="op" id="4178370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178374">case</span>&nbsp;<span class="op" id="4178379">*</span><span class="ident" id="4178380">ecdsa</span><span class="op" id="4178385">.</span><span class="ident" id="4178386">PublicKey</span><span class="op" id="4178395">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178400">ecdsaSig</span>&nbsp;<span class="op" id="4178409">:=</span>&nbsp;<span class="builtinfunc" id="4178412">new</span><span class="op" id="4178415">(</span><span class="ident" id="4178416">ecdsaSignature</span><span class="op" id="4178430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178435">if</span>&nbsp;<span class="ident" id="4178438">_</span><span class="op" id="4178439">,</span>&nbsp;<span class="ident" id="4178441">err</span>&nbsp;<span class="op" id="4178445">=</span>&nbsp;<span class="ident" id="4178447">asn1</span><span class="op" id="4178451">.</span><span class="ident" id="4178452">Unmarshal</span><span class="op" id="4178461">(</span><span class="ident" id="4178462">certVerify</span><span class="op" id="4178472">.</span><span class="ident" id="4178473">signature</span><span class="op" id="4178482">,</span>&nbsp;<span class="ident" id="4178484">ecdsaSig</span><span class="op" id="4178492">)</span><span class="op" id="4178493">;</span>&nbsp;<span class="ident" id="4178495">err</span>&nbsp;<span class="op" id="4178499">!=</span>&nbsp;<span class="ident" id="4178502">nil</span>&nbsp;<span class="op" id="4178506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178512">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4178521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178526">if</span>&nbsp;<span class="ident" id="4178529">ecdsaSig</span><span class="op" id="4178537">.</span><span class="ident" id="4178538">R</span><span class="op" id="4178539">.</span><span class="ident" id="4178540">Sign</span><span class="op" id="4178544">(</span><span class="op" id="4178545">)</span>&nbsp;<span class="op" id="4178547">&lt;=</span>&nbsp;<span class="num" id="4178550">0</span>&nbsp;<span class="op" id="4178552">||</span>&nbsp;<span class="ident" id="4178555">ecdsaSig</span><span class="op" id="4178563">.</span><span class="ident" id="4178564">S</span><span class="op" id="4178565">.</span><span class="ident" id="4178566">Sign</span><span class="op" id="4178570">(</span><span class="op" id="4178571">)</span>&nbsp;<span class="op" id="4178573">&lt;=</span>&nbsp;<span class="num" id="4178576">0</span>&nbsp;<span class="op" id="4178578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178584">err</span>&nbsp;<span class="op" id="4178588">=</span>&nbsp;<span class="ident" id="4178590">errors</span><span class="op" id="4178596">.</span><span class="ident" id="4178597">New</span><span class="op" id="4178600">(</span><span class="string" id="4178601">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4178652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178658">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4178667">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178672">digest</span><span class="op" id="4178678">,</span>&nbsp;<span class="ident" id="4178680">_</span><span class="op" id="4178681">,</span>&nbsp;<span class="ident" id="4178683">_</span>&nbsp;<span class="op" id="4178685">:=</span>&nbsp;<span class="ident" id="4178688">hs</span><span class="op" id="4178690">.</span><span class="ident" id="4178691">finishedHash</span><span class="op" id="4178703">.</span><span class="ident" id="4178704">hashForClientCertificate</span><span class="op" id="4178728">(</span><span class="ident" id="4178729">signatureECDSA</span><span class="op" id="4178743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178748">if</span>&nbsp;<span class="op" id="4178751">!</span><span class="ident" id="4178752">ecdsa</span><span class="op" id="4178757">.</span><span class="ident" id="4178758">Verify</span><span class="op" id="4178764">(</span><span class="ident" id="4178765">key</span><span class="op" id="4178768">,</span>&nbsp;<span class="ident" id="4178770">digest</span><span class="op" id="4178776">,</span>&nbsp;<span class="ident" id="4178778">ecdsaSig</span><span class="op" id="4178786">.</span><span class="ident" id="4178787">R</span><span class="op" id="4178788">,</span>&nbsp;<span class="ident" id="4178790">ecdsaSig</span><span class="op" id="4178798">.</span><span class="ident" id="4178799">S</span><span class="op" id="4178800">)</span>&nbsp;<span class="op" id="4178802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178808">err</span>&nbsp;<span class="op" id="4178812">=</span>&nbsp;<span class="ident" id="4178814">errors</span><span class="op" id="4178820">.</span><span class="ident" id="4178821">New</span><span class="op" id="4178824">(</span><span class="string" id="4178825">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4178853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178859">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4178868">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4178872">case</span>&nbsp;<span class="op" id="4178877">*</span><span class="ident" id="4178878">rsa</span><span class="op" id="4178881">.</span><span class="ident" id="4178882">PublicKey</span><span class="op" id="4178891">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178896">digest</span><span class="op" id="4178902">,</span>&nbsp;<span class="ident" id="4178904">hashFunc</span><span class="op" id="4178912">,</span>&nbsp;<span class="ident" id="4178914">_</span>&nbsp;<span class="op" id="4178916">:=</span>&nbsp;<span class="ident" id="4178919">hs</span><span class="op" id="4178921">.</span><span class="ident" id="4178922">finishedHash</span><span class="op" id="4178934">.</span><span class="ident" id="4178935">hashForClientCertificate</span><span class="op" id="4178959">(</span><span class="ident" id="4178960">signatureRSA</span><span class="op" id="4178972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4178977">err</span>&nbsp;<span class="op" id="4178981">=</span>&nbsp;<span class="ident" id="4178983">rsa</span><span class="op" id="4178986">.</span><span class="ident" id="4178987">VerifyPKCS1v15</span><span class="op" id="4179001">(</span><span class="ident" id="4179002">key</span><span class="op" id="4179005">,</span>&nbsp;<span class="ident" id="4179007">hashFunc</span><span class="op" id="4179015">,</span>&nbsp;<span class="ident" id="4179017">digest</span><span class="op" id="4179023">,</span>&nbsp;<span class="ident" id="4179025">certVerify</span><span class="op" id="4179035">.</span><span class="ident" id="4179036">signature</span><span class="op" id="4179045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179053">if</span>&nbsp;<span class="ident" id="4179056">err</span>&nbsp;<span class="op" id="4179060">!=</span>&nbsp;<span class="ident" id="4179063">nil</span>&nbsp;<span class="op" id="4179067">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179072">c</span><span class="op" id="4179073">.</span><span class="ident" id="4179074">sendAlert</span><span class="op" id="4179083">(</span><span class="ident" id="4179084">alertBadCertificate</span><span class="op" id="4179103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179108">return</span>&nbsp;<span class="ident" id="4179115">errors</span><span class="op" id="4179121">.</span><span class="ident" id="4179122">New</span><span class="op" id="4179125">(</span><span class="string" id="4179126">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="4179180">+</span>&nbsp;<span class="ident" id="4179182">err</span><span class="op" id="4179185">.</span><span class="ident" id="4179186">Error</span><span class="op" id="4179191">(</span><span class="op" id="4179192">)</span><span class="op" id="4179193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179202">hs</span><span class="op" id="4179204">.</span><span class="ident" id="4179205">finishedHash</span><span class="op" id="4179217">.</span><span class="ident" id="4179218">Write</span><span class="op" id="4179223">(</span><span class="ident" id="4179224">certVerify</span><span class="op" id="4179234">.</span><span class="ident" id="4179235">marshal</span><span class="op" id="4179242">(</span><span class="op" id="4179243">)</span><span class="op" id="4179244">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179251">preMasterSecret</span><span class="op" id="4179266">,</span>&nbsp;<span class="ident" id="4179268">err</span>&nbsp;<span class="op" id="4179272">:=</span>&nbsp;<span class="ident" id="4179275">keyAgreement</span><span class="op" id="4179287">.</span><span class="ident" id="4179288">processClientKeyExchange</span><span class="op" id="4179312">(</span><span class="ident" id="4179313">config</span><span class="op" id="4179319">,</span>&nbsp;<span class="ident" id="4179321">hs</span><span class="op" id="4179323">.</span><span class="ident" id="4179324">cert</span><span class="op" id="4179328">,</span>&nbsp;<span class="ident" id="4179330">ckx</span><span class="op" id="4179333">,</span>&nbsp;<span class="ident" id="4179335">c</span><span class="op" id="4179336">.</span><span class="ident" id="4179337">vers</span><span class="op" id="4179341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179344">if</span>&nbsp;<span class="ident" id="4179347">err</span>&nbsp;<span class="op" id="4179351">!=</span>&nbsp;<span class="ident" id="4179354">nil</span>&nbsp;<span class="op" id="4179358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179362">c</span><span class="op" id="4179363">.</span><span class="ident" id="4179364">sendAlert</span><span class="op" id="4179373">(</span><span class="ident" id="4179374">alertHandshakeFailure</span><span class="op" id="4179395">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179399">return</span>&nbsp;<span class="ident" id="4179406">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4179411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179414">hs</span><span class="op" id="4179416">.</span><span class="ident" id="4179417">masterSecret</span>&nbsp;<span class="op" id="4179430">=</span>&nbsp;<span class="ident" id="4179432">masterFromPreMasterSecret</span><span class="op" id="4179457">(</span><span class="ident" id="4179458">c</span><span class="op" id="4179459">.</span><span class="ident" id="4179460">vers</span><span class="op" id="4179464">,</span>&nbsp;<span class="ident" id="4179466">preMasterSecret</span><span class="op" id="4179481">,</span>&nbsp;<span class="ident" id="4179483">hs</span><span class="op" id="4179485">.</span><span class="ident" id="4179486">clientHello</span><span class="op" id="4179497">.</span><span class="ident" id="4179498">random</span><span class="op" id="4179504">,</span>&nbsp;<span class="ident" id="4179506">hs</span><span class="op" id="4179508">.</span><span class="ident" id="4179509">hello</span><span class="op" id="4179514">.</span><span class="ident" id="4179515">random</span><span class="op" id="4179521">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179525">return</span>&nbsp;<span class="ident" id="4179532">nil</span><br>
<span class="lineno">475</span><span class="op" id="4179536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4179539">func</span>&nbsp;<span class="op" id="4179544">(</span><span class="ident" id="4179545">hs</span>&nbsp;<span class="op" id="4179548">*</span><span class="ident" id="4179549">serverHandshakeState</span><span class="op" id="4179569">)</span>&nbsp;<span class="ident" id="4179571">establishKeys</span><span class="op" id="4179584">(</span><span class="op" id="4179585">)</span>&nbsp;<span class="builtintype" id="4179587">error</span>&nbsp;<span class="op" id="4179593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179596">c</span>&nbsp;<span class="op" id="4179598">:=</span>&nbsp;<span class="ident" id="4179601">hs</span><span class="op" id="4179603">.</span><span class="ident" id="4179604">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179608">clientMAC</span><span class="op" id="4179617">,</span>&nbsp;<span class="ident" id="4179619">serverMAC</span><span class="op" id="4179628">,</span>&nbsp;<span class="ident" id="4179630">clientKey</span><span class="op" id="4179639">,</span>&nbsp;<span class="ident" id="4179641">serverKey</span><span class="op" id="4179650">,</span>&nbsp;<span class="ident" id="4179652">clientIV</span><span class="op" id="4179660">,</span>&nbsp;<span class="ident" id="4179662">serverIV</span>&nbsp;<span class="op" id="4179671">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179676">keysFromMasterSecret</span><span class="op" id="4179696">(</span><span class="ident" id="4179697">c</span><span class="op" id="4179698">.</span><span class="ident" id="4179699">vers</span><span class="op" id="4179703">,</span>&nbsp;<span class="ident" id="4179705">hs</span><span class="op" id="4179707">.</span><span class="ident" id="4179708">masterSecret</span><span class="op" id="4179720">,</span>&nbsp;<span class="ident" id="4179722">hs</span><span class="op" id="4179724">.</span><span class="ident" id="4179725">clientHello</span><span class="op" id="4179736">.</span><span class="ident" id="4179737">random</span><span class="op" id="4179743">,</span>&nbsp;<span class="ident" id="4179745">hs</span><span class="op" id="4179747">.</span><span class="ident" id="4179748">hello</span><span class="op" id="4179753">.</span><span class="ident" id="4179754">random</span><span class="op" id="4179760">,</span>&nbsp;<span class="ident" id="4179762">hs</span><span class="op" id="4179764">.</span><span class="ident" id="4179765">suite</span><span class="op" id="4179770">.</span><span class="ident" id="4179771">macLen</span><span class="op" id="4179777">,</span>&nbsp;<span class="ident" id="4179779">hs</span><span class="op" id="4179781">.</span><span class="ident" id="4179782">suite</span><span class="op" id="4179787">.</span><span class="ident" id="4179788">keyLen</span><span class="op" id="4179794">,</span>&nbsp;<span class="ident" id="4179796">hs</span><span class="op" id="4179798">.</span><span class="ident" id="4179799">suite</span><span class="op" id="4179804">.</span><span class="ident" id="4179805">ivLen</span><span class="op" id="4179810">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179814">var</span>&nbsp;<span class="ident" id="4179818">clientCipher</span><span class="op" id="4179830">,</span>&nbsp;<span class="ident" id="4179832">serverCipher</span>&nbsp;<span class="keyword" id="4179845">interface</span><span class="op" id="4179854">{</span><span class="op" id="4179855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179858">var</span>&nbsp;<span class="ident" id="4179862">clientHash</span><span class="op" id="4179872">,</span>&nbsp;<span class="ident" id="4179874">serverHash</span>&nbsp;<span class="ident" id="4179885">macFunction</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4179899">if</span>&nbsp;<span class="ident" id="4179902">hs</span><span class="op" id="4179904">.</span><span class="ident" id="4179905">suite</span><span class="op" id="4179910">.</span><span class="ident" id="4179911">aead</span>&nbsp;<span class="op" id="4179916">==</span>&nbsp;<span class="ident" id="4179919">nil</span>&nbsp;<span class="op" id="4179923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4179927">clientCipher</span>&nbsp;<span class="op" id="4179940">=</span>&nbsp;<span class="ident" id="4179942">hs</span><span class="op" id="4179944">.</span><span class="ident" id="4179945">suite</span><span class="op" id="4179950">.</span><span class="ident" id="4179951">cipher</span><span class="op" id="4179957">(</span><span class="ident" id="4179958">clientKey</span><span class="op" id="4179967">,</span>&nbsp;<span class="ident" id="4179969">clientIV</span><span class="op" id="4179977">,</span>&nbsp;<span class="builtintype" id="4179979">true</span>&nbsp;<span class="comment" id="4179984">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4180001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180005">clientHash</span>&nbsp;<span class="op" id="4180016">=</span>&nbsp;<span class="ident" id="4180018">hs</span><span class="op" id="4180020">.</span><span class="ident" id="4180021">suite</span><span class="op" id="4180026">.</span><span class="ident" id="4180027">mac</span><span class="op" id="4180030">(</span><span class="ident" id="4180031">c</span><span class="op" id="4180032">.</span><span class="ident" id="4180033">vers</span><span class="op" id="4180037">,</span>&nbsp;<span class="ident" id="4180039">clientMAC</span><span class="op" id="4180048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180052">serverCipher</span>&nbsp;<span class="op" id="4180065">=</span>&nbsp;<span class="ident" id="4180067">hs</span><span class="op" id="4180069">.</span><span class="ident" id="4180070">suite</span><span class="op" id="4180075">.</span><span class="ident" id="4180076">cipher</span><span class="op" id="4180082">(</span><span class="ident" id="4180083">serverKey</span><span class="op" id="4180092">,</span>&nbsp;<span class="ident" id="4180094">serverIV</span><span class="op" id="4180102">,</span>&nbsp;<span class="builtintype" id="4180104">false</span>&nbsp;<span class="comment" id="4180110">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4180131">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180135">serverHash</span>&nbsp;<span class="op" id="4180146">=</span>&nbsp;<span class="ident" id="4180148">hs</span><span class="op" id="4180150">.</span><span class="ident" id="4180151">suite</span><span class="op" id="4180156">.</span><span class="ident" id="4180157">mac</span><span class="op" id="4180160">(</span><span class="ident" id="4180161">c</span><span class="op" id="4180162">.</span><span class="ident" id="4180163">vers</span><span class="op" id="4180167">,</span>&nbsp;<span class="ident" id="4180169">serverMAC</span><span class="op" id="4180178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4180181">}</span>&nbsp;<span class="keyword" id="4180183">else</span>&nbsp;<span class="op" id="4180188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180192">clientCipher</span>&nbsp;<span class="op" id="4180205">=</span>&nbsp;<span class="ident" id="4180207">hs</span><span class="op" id="4180209">.</span><span class="ident" id="4180210">suite</span><span class="op" id="4180215">.</span><span class="ident" id="4180216">aead</span><span class="op" id="4180220">(</span><span class="ident" id="4180221">clientKey</span><span class="op" id="4180230">,</span>&nbsp;<span class="ident" id="4180232">clientIV</span><span class="op" id="4180240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180244">serverCipher</span>&nbsp;<span class="op" id="4180257">=</span>&nbsp;<span class="ident" id="4180259">hs</span><span class="op" id="4180261">.</span><span class="ident" id="4180262">suite</span><span class="op" id="4180267">.</span><span class="ident" id="4180268">aead</span><span class="op" id="4180272">(</span><span class="ident" id="4180273">serverKey</span><span class="op" id="4180282">,</span>&nbsp;<span class="ident" id="4180284">serverIV</span><span class="op" id="4180292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4180295">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180299">c</span><span class="op" id="4180300">.</span><span class="ident" id="4180301">in</span><span class="op" id="4180303">.</span><span class="ident" id="4180304">prepareCipherSpec</span><span class="op" id="4180321">(</span><span class="ident" id="4180322">c</span><span class="op" id="4180323">.</span><span class="ident" id="4180324">vers</span><span class="op" id="4180328">,</span>&nbsp;<span class="ident" id="4180330">clientCipher</span><span class="op" id="4180342">,</span>&nbsp;<span class="ident" id="4180344">clientHash</span><span class="op" id="4180354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180357">c</span><span class="op" id="4180358">.</span><span class="ident" id="4180359">out</span><span class="op" id="4180362">.</span><span class="ident" id="4180363">prepareCipherSpec</span><span class="op" id="4180380">(</span><span class="ident" id="4180381">c</span><span class="op" id="4180382">.</span><span class="ident" id="4180383">vers</span><span class="op" id="4180387">,</span>&nbsp;<span class="ident" id="4180389">serverCipher</span><span class="op" id="4180401">,</span>&nbsp;<span class="ident" id="4180403">serverHash</span><span class="op" id="4180413">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180417">return</span>&nbsp;<span class="ident" id="4180424">nil</span><br>
<span class="lineno">500</span><span class="op" id="4180428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4180431">func</span>&nbsp;<span class="op" id="4180436">(</span><span class="ident" id="4180437">hs</span>&nbsp;<span class="op" id="4180440">*</span><span class="ident" id="4180441">serverHandshakeState</span><span class="op" id="4180461">)</span>&nbsp;<span class="ident" id="4180463">readFinished</span><span class="op" id="4180475">(</span><span class="ident" id="4180476">out</span>&nbsp;<span class="op" id="4180480">[</span><span class="op" id="4180481">]</span><span class="builtintype" id="4180482">byte</span><span class="op" id="4180486">)</span>&nbsp;<span class="builtintype" id="4180488">error</span>&nbsp;<span class="op" id="4180494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180497">c</span>&nbsp;<span class="op" id="4180499">:=</span>&nbsp;<span class="ident" id="4180502">hs</span><span class="op" id="4180504">.</span><span class="ident" id="4180505">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180509">c</span><span class="op" id="4180510">.</span><span class="ident" id="4180511">readRecord</span><span class="op" id="4180521">(</span><span class="ident" id="4180522">recordTypeChangeCipherSpec</span><span class="op" id="4180548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180551">if</span>&nbsp;<span class="ident" id="4180554">err</span>&nbsp;<span class="op" id="4180558">:=</span>&nbsp;<span class="ident" id="4180561">c</span><span class="op" id="4180562">.</span><span class="ident" id="4180563">in</span><span class="op" id="4180565">.</span><span class="builtintype" id="4180566">error</span><span class="op" id="4180571">(</span><span class="op" id="4180572">)</span><span class="op" id="4180573">;</span>&nbsp;<span class="ident" id="4180575">err</span>&nbsp;<span class="op" id="4180579">!=</span>&nbsp;<span class="ident" id="4180582">nil</span>&nbsp;<span class="op" id="4180586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180590">return</span>&nbsp;<span class="ident" id="4180597">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4180602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180606">if</span>&nbsp;<span class="ident" id="4180609">hs</span><span class="op" id="4180611">.</span><span class="ident" id="4180612">hello</span><span class="op" id="4180617">.</span><span class="ident" id="4180618">nextProtoNeg</span>&nbsp;<span class="op" id="4180631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180635">msg</span><span class="op" id="4180638">,</span>&nbsp;<span class="ident" id="4180640">err</span>&nbsp;<span class="op" id="4180644">:=</span>&nbsp;<span class="ident" id="4180647">c</span><span class="op" id="4180648">.</span><span class="ident" id="4180649">readHandshake</span><span class="op" id="4180662">(</span><span class="op" id="4180663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180667">if</span>&nbsp;<span class="ident" id="4180670">err</span>&nbsp;<span class="op" id="4180674">!=</span>&nbsp;<span class="ident" id="4180677">nil</span>&nbsp;<span class="op" id="4180681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180686">return</span>&nbsp;<span class="ident" id="4180693">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4180699">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180703">nextProto</span><span class="op" id="4180712">,</span>&nbsp;<span class="ident" id="4180714">ok</span>&nbsp;<span class="op" id="4180717">:=</span>&nbsp;<span class="ident" id="4180720">msg</span><span class="op" id="4180723">.</span><span class="op" id="4180724">(</span><span class="op" id="4180725">*</span><span class="ident" id="4180726">nextProtoMsg</span><span class="op" id="4180738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180742">if</span>&nbsp;<span class="op" id="4180745">!</span><span class="ident" id="4180746">ok</span>&nbsp;<span class="op" id="4180749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180754">c</span><span class="op" id="4180755">.</span><span class="ident" id="4180756">sendAlert</span><span class="op" id="4180765">(</span><span class="ident" id="4180766">alertUnexpectedMessage</span><span class="op" id="4180788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180793">return</span>&nbsp;<span class="ident" id="4180800">unexpectedMessageError</span><span class="op" id="4180822">(</span><span class="ident" id="4180823">nextProto</span><span class="op" id="4180832">,</span>&nbsp;<span class="ident" id="4180834">msg</span><span class="op" id="4180837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4180841">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180845">hs</span><span class="op" id="4180847">.</span><span class="ident" id="4180848">finishedHash</span><span class="op" id="4180860">.</span><span class="ident" id="4180861">Write</span><span class="op" id="4180866">(</span><span class="ident" id="4180867">nextProto</span><span class="op" id="4180876">.</span><span class="ident" id="4180877">marshal</span><span class="op" id="4180884">(</span><span class="op" id="4180885">)</span><span class="op" id="4180886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180890">c</span><span class="op" id="4180891">.</span><span class="ident" id="4180892">clientProtocol</span>&nbsp;<span class="op" id="4180907">=</span>&nbsp;<span class="ident" id="4180909">nextProto</span><span class="op" id="4180918">.</span><span class="ident" id="4180919">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4180926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180930">msg</span><span class="op" id="4180933">,</span>&nbsp;<span class="ident" id="4180935">err</span>&nbsp;<span class="op" id="4180939">:=</span>&nbsp;<span class="ident" id="4180942">c</span><span class="op" id="4180943">.</span><span class="ident" id="4180944">readHandshake</span><span class="op" id="4180957">(</span><span class="op" id="4180958">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180961">if</span>&nbsp;<span class="ident" id="4180964">err</span>&nbsp;<span class="op" id="4180968">!=</span>&nbsp;<span class="ident" id="4180971">nil</span>&nbsp;<span class="op" id="4180975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4180979">return</span>&nbsp;<span class="ident" id="4180986">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4180991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4180994">clientFinished</span><span class="op" id="4181008">,</span>&nbsp;<span class="ident" id="4181010">ok</span>&nbsp;<span class="op" id="4181013">:=</span>&nbsp;<span class="ident" id="4181016">msg</span><span class="op" id="4181019">.</span><span class="op" id="4181020">(</span><span class="op" id="4181021">*</span><span class="ident" id="4181022">finishedMsg</span><span class="op" id="4181033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181036">if</span>&nbsp;<span class="op" id="4181039">!</span><span class="ident" id="4181040">ok</span>&nbsp;<span class="op" id="4181043">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181047">c</span><span class="op" id="4181048">.</span><span class="ident" id="4181049">sendAlert</span><span class="op" id="4181058">(</span><span class="ident" id="4181059">alertUnexpectedMessage</span><span class="op" id="4181081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181085">return</span>&nbsp;<span class="ident" id="4181092">unexpectedMessageError</span><span class="op" id="4181114">(</span><span class="ident" id="4181115">clientFinished</span><span class="op" id="4181129">,</span>&nbsp;<span class="ident" id="4181131">msg</span><span class="op" id="4181134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4181137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181141">verify</span>&nbsp;<span class="op" id="4181148">:=</span>&nbsp;<span class="ident" id="4181151">hs</span><span class="op" id="4181153">.</span><span class="ident" id="4181154">finishedHash</span><span class="op" id="4181166">.</span><span class="ident" id="4181167">clientSum</span><span class="op" id="4181176">(</span><span class="ident" id="4181177">hs</span><span class="op" id="4181179">.</span><span class="ident" id="4181180">masterSecret</span><span class="op" id="4181192">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181195">if</span>&nbsp;<span class="builtinfunc" id="4181198">len</span><span class="op" id="4181201">(</span><span class="ident" id="4181202">verify</span><span class="op" id="4181208">)</span>&nbsp;<span class="op" id="4181210">!=</span>&nbsp;<span class="builtinfunc" id="4181213">len</span><span class="op" id="4181216">(</span><span class="ident" id="4181217">clientFinished</span><span class="op" id="4181231">.</span><span class="ident" id="4181232">verifyData</span><span class="op" id="4181242">)</span>&nbsp;<span class="op" id="4181244">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181249">subtle</span><span class="op" id="4181255">.</span><span class="ident" id="4181256">ConstantTimeCompare</span><span class="op" id="4181275">(</span><span class="ident" id="4181276">verify</span><span class="op" id="4181282">,</span>&nbsp;<span class="ident" id="4181284">clientFinished</span><span class="op" id="4181298">.</span><span class="ident" id="4181299">verifyData</span><span class="op" id="4181309">)</span>&nbsp;<span class="op" id="4181311">!=</span>&nbsp;<span class="num" id="4181314">1</span>&nbsp;<span class="op" id="4181316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181320">c</span><span class="op" id="4181321">.</span><span class="ident" id="4181322">sendAlert</span><span class="op" id="4181331">(</span><span class="ident" id="4181332">alertHandshakeFailure</span><span class="op" id="4181353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181357">return</span>&nbsp;<span class="ident" id="4181364">errors</span><span class="op" id="4181370">.</span><span class="ident" id="4181371">New</span><span class="op" id="4181374">(</span><span class="string" id="4181375">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="4181420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4181423">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181427">hs</span><span class="op" id="4181429">.</span><span class="ident" id="4181430">finishedHash</span><span class="op" id="4181442">.</span><span class="ident" id="4181443">Write</span><span class="op" id="4181448">(</span><span class="ident" id="4181449">clientFinished</span><span class="op" id="4181463">.</span><span class="ident" id="4181464">marshal</span><span class="op" id="4181471">(</span><span class="op" id="4181472">)</span><span class="op" id="4181473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4181476">copy</span><span class="op" id="4181480">(</span><span class="ident" id="4181481">out</span><span class="op" id="4181484">,</span>&nbsp;<span class="ident" id="4181486">verify</span><span class="op" id="4181492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181495">return</span>&nbsp;<span class="ident" id="4181502">nil</span><br>
<span class="lineno"></span><span class="op" id="4181506">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="4181509">func</span>&nbsp;<span class="op" id="4181514">(</span><span class="ident" id="4181515">hs</span>&nbsp;<span class="op" id="4181518">*</span><span class="ident" id="4181519">serverHandshakeState</span><span class="op" id="4181539">)</span>&nbsp;<span class="ident" id="4181541">sendSessionTicket</span><span class="op" id="4181558">(</span><span class="op" id="4181559">)</span>&nbsp;<span class="builtintype" id="4181561">error</span>&nbsp;<span class="op" id="4181567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181570">if</span>&nbsp;<span class="op" id="4181573">!</span><span class="ident" id="4181574">hs</span><span class="op" id="4181576">.</span><span class="ident" id="4181577">hello</span><span class="op" id="4181582">.</span><span class="ident" id="4181583">ticketSupported</span>&nbsp;<span class="op" id="4181599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181603">return</span>&nbsp;<span class="ident" id="4181610">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4181615">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181619">c</span>&nbsp;<span class="op" id="4181621">:=</span>&nbsp;<span class="ident" id="4181624">hs</span><span class="op" id="4181626">.</span><span class="ident" id="4181627">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181630">m</span>&nbsp;<span class="op" id="4181632">:=</span>&nbsp;<span class="builtinfunc" id="4181635">new</span><span class="op" id="4181638">(</span><span class="ident" id="4181639">newSessionTicketMsg</span><span class="op" id="4181658">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181662">var</span>&nbsp;<span class="ident" id="4181666">err</span>&nbsp;<span class="builtintype" id="4181670">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181677">state</span>&nbsp;<span class="op" id="4181683">:=</span>&nbsp;<span class="ident" id="4181686">sessionState</span><span class="op" id="4181698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181702">vers</span><span class="op" id="4181706">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4181716">c</span><span class="op" id="4181717">.</span><span class="ident" id="4181718">vers</span><span class="op" id="4181722">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181726">cipherSuite</span><span class="op" id="4181737">:</span>&nbsp;&nbsp;<span class="ident" id="4181740">hs</span><span class="op" id="4181742">.</span><span class="ident" id="4181743">suite</span><span class="op" id="4181748">.</span><span class="ident" id="4181749">id</span><span class="op" id="4181751">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181755">masterSecret</span><span class="op" id="4181767">:</span>&nbsp;<span class="ident" id="4181769">hs</span><span class="op" id="4181771">.</span><span class="ident" id="4181772">masterSecret</span><span class="op" id="4181784">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181788">certificates</span><span class="op" id="4181800">:</span>&nbsp;<span class="ident" id="4181802">hs</span><span class="op" id="4181804">.</span><span class="ident" id="4181805">certsFromClient</span><span class="op" id="4181820">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4181823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181826">m</span><span class="op" id="4181827">.</span><span class="ident" id="4181828">ticket</span><span class="op" id="4181834">,</span>&nbsp;<span class="ident" id="4181836">err</span>&nbsp;<span class="op" id="4181840">=</span>&nbsp;<span class="ident" id="4181842">c</span><span class="op" id="4181843">.</span><span class="ident" id="4181844">encryptTicket</span><span class="op" id="4181857">(</span><span class="op" id="4181858">&amp;</span><span class="ident" id="4181859">state</span><span class="op" id="4181864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181867">if</span>&nbsp;<span class="ident" id="4181870">err</span>&nbsp;<span class="op" id="4181874">!=</span>&nbsp;<span class="ident" id="4181877">nil</span>&nbsp;<span class="op" id="4181881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181885">return</span>&nbsp;<span class="ident" id="4181892">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4181897">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181901">hs</span><span class="op" id="4181903">.</span><span class="ident" id="4181904">finishedHash</span><span class="op" id="4181916">.</span><span class="ident" id="4181917">Write</span><span class="op" id="4181922">(</span><span class="ident" id="4181923">m</span><span class="op" id="4181924">.</span><span class="ident" id="4181925">marshal</span><span class="op" id="4181932">(</span><span class="op" id="4181933">)</span><span class="op" id="4181934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4181937">c</span><span class="op" id="4181938">.</span><span class="ident" id="4181939">writeRecord</span><span class="op" id="4181950">(</span><span class="ident" id="4181951">recordTypeHandshake</span><span class="op" id="4181970">,</span>&nbsp;<span class="ident" id="4181972">m</span><span class="op" id="4181973">.</span><span class="ident" id="4181974">marshal</span><span class="op" id="4181981">(</span><span class="op" id="4181982">)</span><span class="op" id="4181983">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4181987">return</span>&nbsp;<span class="ident" id="4181994">nil</span><br>
<span class="lineno">570</span><span class="op" id="4181998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4182001">func</span>&nbsp;<span class="op" id="4182006">(</span><span class="ident" id="4182007">hs</span>&nbsp;<span class="op" id="4182010">*</span><span class="ident" id="4182011">serverHandshakeState</span><span class="op" id="4182031">)</span>&nbsp;<span class="ident" id="4182033">sendFinished</span><span class="op" id="4182045">(</span><span class="ident" id="4182046">out</span>&nbsp;<span class="op" id="4182050">[</span><span class="op" id="4182051">]</span><span class="builtintype" id="4182052">byte</span><span class="op" id="4182056">)</span>&nbsp;<span class="builtintype" id="4182058">error</span>&nbsp;<span class="op" id="4182064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182067">c</span>&nbsp;<span class="op" id="4182069">:=</span>&nbsp;<span class="ident" id="4182072">hs</span><span class="op" id="4182074">.</span><span class="ident" id="4182075">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182079">c</span><span class="op" id="4182080">.</span><span class="ident" id="4182081">writeRecord</span><span class="op" id="4182092">(</span><span class="ident" id="4182093">recordTypeChangeCipherSpec</span><span class="op" id="4182119">,</span>&nbsp;<span class="op" id="4182121">[</span><span class="op" id="4182122">]</span><span class="builtintype" id="4182123">byte</span><span class="op" id="4182127">{</span><span class="num" id="4182128">1</span><span class="op" id="4182129">}</span><span class="op" id="4182130">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182134">finished</span>&nbsp;<span class="op" id="4182143">:=</span>&nbsp;<span class="builtinfunc" id="4182146">new</span><span class="op" id="4182149">(</span><span class="ident" id="4182150">finishedMsg</span><span class="op" id="4182161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182164">finished</span><span class="op" id="4182172">.</span><span class="ident" id="4182173">verifyData</span>&nbsp;<span class="op" id="4182184">=</span>&nbsp;<span class="ident" id="4182186">hs</span><span class="op" id="4182188">.</span><span class="ident" id="4182189">finishedHash</span><span class="op" id="4182201">.</span><span class="ident" id="4182202">serverSum</span><span class="op" id="4182211">(</span><span class="ident" id="4182212">hs</span><span class="op" id="4182214">.</span><span class="ident" id="4182215">masterSecret</span><span class="op" id="4182227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182230">hs</span><span class="op" id="4182232">.</span><span class="ident" id="4182233">finishedHash</span><span class="op" id="4182245">.</span><span class="ident" id="4182246">Write</span><span class="op" id="4182251">(</span><span class="ident" id="4182252">finished</span><span class="op" id="4182260">.</span><span class="ident" id="4182261">marshal</span><span class="op" id="4182268">(</span><span class="op" id="4182269">)</span><span class="op" id="4182270">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182273">c</span><span class="op" id="4182274">.</span><span class="ident" id="4182275">writeRecord</span><span class="op" id="4182286">(</span><span class="ident" id="4182287">recordTypeHandshake</span><span class="op" id="4182306">,</span>&nbsp;<span class="ident" id="4182308">finished</span><span class="op" id="4182316">.</span><span class="ident" id="4182317">marshal</span><span class="op" id="4182324">(</span><span class="op" id="4182325">)</span><span class="op" id="4182326">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182330">c</span><span class="op" id="4182331">.</span><span class="ident" id="4182332">cipherSuite</span>&nbsp;<span class="op" id="4182344">=</span>&nbsp;<span class="ident" id="4182346">hs</span><span class="op" id="4182348">.</span><span class="ident" id="4182349">suite</span><span class="op" id="4182354">.</span><span class="ident" id="4182355">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4182359">copy</span><span class="op" id="4182363">(</span><span class="ident" id="4182364">out</span><span class="op" id="4182367">,</span>&nbsp;<span class="ident" id="4182369">finished</span><span class="op" id="4182377">.</span><span class="ident" id="4182378">verifyData</span><span class="op" id="4182388">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4182392">return</span>&nbsp;<span class="ident" id="4182399">nil</span><br>
<span class="lineno"></span><span class="op" id="4182403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4182406">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4182483">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="4182560">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4182603">func</span>&nbsp;<span class="op" id="4182608">(</span><span class="ident" id="4182609">hs</span>&nbsp;<span class="op" id="4182612">*</span><span class="ident" id="4182613">serverHandshakeState</span><span class="op" id="4182633">)</span>&nbsp;<span class="ident" id="4182635">processCertsFromClient</span><span class="op" id="4182657">(</span><span class="ident" id="4182658">certificates</span>&nbsp;<span class="op" id="4182671">[</span><span class="op" id="4182672">]</span><span class="op" id="4182673">[</span><span class="op" id="4182674">]</span><span class="builtintype" id="4182675">byte</span><span class="op" id="4182679">)</span>&nbsp;<span class="op" id="4182681">(</span><span class="ident" id="4182682">crypto</span><span class="op" id="4182688">.</span><span class="ident" id="4182689">PublicKey</span><span class="op" id="4182698">,</span>&nbsp;<span class="builtintype" id="4182700">error</span><span class="op" id="4182705">)</span>&nbsp;<span class="op" id="4182707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182710">c</span>&nbsp;<span class="op" id="4182712">:=</span>&nbsp;<span class="ident" id="4182715">hs</span><span class="op" id="4182717">.</span><span class="ident" id="4182718">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182722">hs</span><span class="op" id="4182724">.</span><span class="ident" id="4182725">certsFromClient</span>&nbsp;<span class="op" id="4182741">=</span>&nbsp;<span class="ident" id="4182743">certificates</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182757">certs</span>&nbsp;<span class="op" id="4182763">:=</span>&nbsp;<span class="builtinfunc" id="4182766">make</span><span class="op" id="4182770">(</span><span class="op" id="4182771">[</span><span class="op" id="4182772">]</span><span class="op" id="4182773">*</span><span class="ident" id="4182774">x509</span><span class="op" id="4182778">.</span><span class="ident" id="4182779">Certificate</span><span class="op" id="4182790">,</span>&nbsp;<span class="builtinfunc" id="4182792">len</span><span class="op" id="4182795">(</span><span class="ident" id="4182796">certificates</span><span class="op" id="4182808">)</span><span class="op" id="4182809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4182812">var</span>&nbsp;<span class="ident" id="4182816">err</span>&nbsp;<span class="builtintype" id="4182820">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4182827">for</span>&nbsp;<span class="ident" id="4182831">i</span><span class="op" id="4182832">,</span>&nbsp;<span class="ident" id="4182834">asn1Data</span>&nbsp;<span class="op" id="4182843">:=</span>&nbsp;<span class="keyword" id="4182846">range</span>&nbsp;<span class="ident" id="4182852">certificates</span>&nbsp;<span class="op" id="4182865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4182869">if</span>&nbsp;<span class="ident" id="4182872">certs</span><span class="op" id="4182877">[</span><span class="ident" id="4182878">i</span><span class="op" id="4182879">]</span><span class="op" id="4182880">,</span>&nbsp;<span class="ident" id="4182882">err</span>&nbsp;<span class="op" id="4182886">=</span>&nbsp;<span class="ident" id="4182888">x509</span><span class="op" id="4182892">.</span><span class="ident" id="4182893">ParseCertificate</span><span class="op" id="4182909">(</span><span class="ident" id="4182910">asn1Data</span><span class="op" id="4182918">)</span><span class="op" id="4182919">;</span>&nbsp;<span class="ident" id="4182921">err</span>&nbsp;<span class="op" id="4182925">!=</span>&nbsp;<span class="ident" id="4182928">nil</span>&nbsp;<span class="op" id="4182932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4182937">c</span><span class="op" id="4182938">.</span><span class="ident" id="4182939">sendAlert</span><span class="op" id="4182948">(</span><span class="ident" id="4182949">alertBadCertificate</span><span class="op" id="4182968">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4182973">return</span>&nbsp;<span class="ident" id="4182980">nil</span><span class="op" id="4182983">,</span>&nbsp;<span class="ident" id="4182985">errors</span><span class="op" id="4182991">.</span><span class="ident" id="4182992">New</span><span class="op" id="4182995">(</span><span class="string" id="4182996">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4183040">+</span>&nbsp;<span class="ident" id="4183042">err</span><span class="op" id="4183045">.</span><span class="ident" id="4183046">Error</span><span class="op" id="4183051">(</span><span class="op" id="4183052">)</span><span class="op" id="4183053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183064">if</span>&nbsp;<span class="ident" id="4183067">c</span><span class="op" id="4183068">.</span><span class="ident" id="4183069">config</span><span class="op" id="4183075">.</span><span class="ident" id="4183076">ClientAuth</span>&nbsp;<span class="op" id="4183087">&gt;=</span>&nbsp;<span class="ident" id="4183090">VerifyClientCertIfGiven</span>&nbsp;<span class="op" id="4183114">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4183117">len</span><span class="op" id="4183120">(</span><span class="ident" id="4183121">certs</span><span class="op" id="4183126">)</span>&nbsp;<span class="op" id="4183128">&gt;</span>&nbsp;<span class="num" id="4183130">0</span>&nbsp;<span class="op" id="4183132">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183136">opts</span>&nbsp;<span class="op" id="4183141">:=</span>&nbsp;<span class="ident" id="4183144">x509</span><span class="op" id="4183148">.</span><span class="ident" id="4183149">VerifyOptions</span><span class="op" id="4183162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183167">Roots</span><span class="op" id="4183172">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4183182">c</span><span class="op" id="4183183">.</span><span class="ident" id="4183184">config</span><span class="op" id="4183190">.</span><span class="ident" id="4183191">ClientCAs</span><span class="op" id="4183200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183205">CurrentTime</span><span class="op" id="4183216">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4183220">c</span><span class="op" id="4183221">.</span><span class="ident" id="4183222">config</span><span class="op" id="4183228">.</span><span class="ident" id="4183229">time</span><span class="op" id="4183233">(</span><span class="op" id="4183234">)</span><span class="op" id="4183235">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183240">Intermediates</span><span class="op" id="4183253">:</span>&nbsp;<span class="ident" id="4183255">x509</span><span class="op" id="4183259">.</span><span class="ident" id="4183260">NewCertPool</span><span class="op" id="4183271">(</span><span class="op" id="4183272">)</span><span class="op" id="4183273">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183278">KeyUsages</span><span class="op" id="4183287">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4183293">[</span><span class="op" id="4183294">]</span><span class="ident" id="4183295">x509</span><span class="op" id="4183299">.</span><span class="ident" id="4183300">ExtKeyUsage</span><span class="op" id="4183311">{</span><span class="ident" id="4183312">x509</span><span class="op" id="4183316">.</span><span class="ident" id="4183317">ExtKeyUsageClientAuth</span><span class="op" id="4183338">}</span><span class="op" id="4183339">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183348">for</span>&nbsp;<span class="ident" id="4183352">_</span><span class="op" id="4183353">,</span>&nbsp;<span class="ident" id="4183355">cert</span>&nbsp;<span class="op" id="4183360">:=</span>&nbsp;<span class="keyword" id="4183363">range</span>&nbsp;<span class="ident" id="4183369">certs</span><span class="op" id="4183374">[</span><span class="num" id="4183375">1</span><span class="op" id="4183376">:</span><span class="op" id="4183377">]</span>&nbsp;<span class="op" id="4183379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183384">opts</span><span class="op" id="4183388">.</span><span class="ident" id="4183389">Intermediates</span><span class="op" id="4183402">.</span><span class="ident" id="4183403">AddCert</span><span class="op" id="4183410">(</span><span class="ident" id="4183411">cert</span><span class="op" id="4183415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183419">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183424">chains</span><span class="op" id="4183430">,</span>&nbsp;<span class="ident" id="4183432">err</span>&nbsp;<span class="op" id="4183436">:=</span>&nbsp;<span class="ident" id="4183439">certs</span><span class="op" id="4183444">[</span><span class="num" id="4183445">0</span><span class="op" id="4183446">]</span><span class="op" id="4183447">.</span><span class="ident" id="4183448">Verify</span><span class="op" id="4183454">(</span><span class="ident" id="4183455">opts</span><span class="op" id="4183459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183463">if</span>&nbsp;<span class="ident" id="4183466">err</span>&nbsp;<span class="op" id="4183470">!=</span>&nbsp;<span class="ident" id="4183473">nil</span>&nbsp;<span class="op" id="4183477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183482">c</span><span class="op" id="4183483">.</span><span class="ident" id="4183484">sendAlert</span><span class="op" id="4183493">(</span><span class="ident" id="4183494">alertBadCertificate</span><span class="op" id="4183513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183518">return</span>&nbsp;<span class="ident" id="4183525">nil</span><span class="op" id="4183528">,</span>&nbsp;<span class="ident" id="4183530">errors</span><span class="op" id="4183536">.</span><span class="ident" id="4183537">New</span><span class="op" id="4183540">(</span><span class="string" id="4183541">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4183588">+</span>&nbsp;<span class="ident" id="4183590">err</span><span class="op" id="4183593">.</span><span class="ident" id="4183594">Error</span><span class="op" id="4183599">(</span><span class="op" id="4183600">)</span><span class="op" id="4183601">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183610">ok</span>&nbsp;<span class="op" id="4183613">:=</span>&nbsp;<span class="builtintype" id="4183616">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183624">for</span>&nbsp;<span class="ident" id="4183628">_</span><span class="op" id="4183629">,</span>&nbsp;<span class="ident" id="4183631">ku</span>&nbsp;<span class="op" id="4183634">:=</span>&nbsp;<span class="keyword" id="4183637">range</span>&nbsp;<span class="ident" id="4183643">certs</span><span class="op" id="4183648">[</span><span class="num" id="4183649">0</span><span class="op" id="4183650">]</span><span class="op" id="4183651">.</span><span class="ident" id="4183652">ExtKeyUsage</span>&nbsp;<span class="op" id="4183664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183669">if</span>&nbsp;<span class="ident" id="4183672">ku</span>&nbsp;<span class="op" id="4183675">==</span>&nbsp;<span class="ident" id="4183678">x509</span><span class="op" id="4183682">.</span><span class="ident" id="4183683">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="4183705">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183711">ok</span>&nbsp;<span class="op" id="4183714">=</span>&nbsp;<span class="builtintype" id="4183716">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183725">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183742">if</span>&nbsp;<span class="op" id="4183745">!</span><span class="ident" id="4183746">ok</span>&nbsp;<span class="op" id="4183749">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183754">c</span><span class="op" id="4183755">.</span><span class="ident" id="4183756">sendAlert</span><span class="op" id="4183765">(</span><span class="ident" id="4183766">alertHandshakeFailure</span><span class="op" id="4183787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183792">return</span>&nbsp;<span class="ident" id="4183799">nil</span><span class="op" id="4183802">,</span>&nbsp;<span class="ident" id="4183804">errors</span><span class="op" id="4183810">.</span><span class="ident" id="4183811">New</span><span class="op" id="4183814">(</span><span class="string" id="4183815">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="4183918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4183927">c</span><span class="op" id="4183928">.</span><span class="ident" id="4183929">verifiedChains</span>&nbsp;<span class="op" id="4183944">=</span>&nbsp;<span class="ident" id="4183946">chains</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4183954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183958">if</span>&nbsp;<span class="builtinfunc" id="4183961">len</span><span class="op" id="4183964">(</span><span class="ident" id="4183965">certs</span><span class="op" id="4183970">)</span>&nbsp;<span class="op" id="4183972">&gt;</span>&nbsp;<span class="num" id="4183974">0</span>&nbsp;<span class="op" id="4183976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4183980">var</span>&nbsp;<span class="ident" id="4183984">pub</span>&nbsp;<span class="ident" id="4183988">crypto</span><span class="op" id="4183994">.</span><span class="ident" id="4183995">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184007">switch</span>&nbsp;<span class="ident" id="4184014">key</span>&nbsp;<span class="op" id="4184018">:=</span>&nbsp;<span class="ident" id="4184021">certs</span><span class="op" id="4184026">[</span><span class="num" id="4184027">0</span><span class="op" id="4184028">]</span><span class="op" id="4184029">.</span><span class="ident" id="4184030">PublicKey</span><span class="op" id="4184039">.</span><span class="op" id="4184040">(</span><span class="keyword" id="4184041">type</span><span class="op" id="4184045">)</span>&nbsp;<span class="op" id="4184047">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184051">case</span>&nbsp;<span class="op" id="4184056">*</span><span class="ident" id="4184057">ecdsa</span><span class="op" id="4184062">.</span><span class="ident" id="4184063">PublicKey</span><span class="op" id="4184072">,</span>&nbsp;<span class="op" id="4184074">*</span><span class="ident" id="4184075">rsa</span><span class="op" id="4184078">.</span><span class="ident" id="4184079">PublicKey</span><span class="op" id="4184088">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184093">pub</span>&nbsp;<span class="op" id="4184097">=</span>&nbsp;<span class="ident" id="4184099">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184105">default</span><span class="op" id="4184112">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184117">c</span><span class="op" id="4184118">.</span><span class="ident" id="4184119">sendAlert</span><span class="op" id="4184128">(</span><span class="ident" id="4184129">alertUnsupportedCertificate</span><span class="op" id="4184156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184161">return</span>&nbsp;<span class="ident" id="4184168">nil</span><span class="op" id="4184171">,</span>&nbsp;<span class="ident" id="4184173">fmt</span><span class="op" id="4184176">.</span><span class="ident" id="4184177">Errorf</span><span class="op" id="4184183">(</span><span class="string" id="4184184">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="4184257">,</span>&nbsp;<span class="ident" id="4184259">certs</span><span class="op" id="4184264">[</span><span class="num" id="4184265">0</span><span class="op" id="4184266">]</span><span class="op" id="4184267">.</span><span class="ident" id="4184268">PublicKey</span><span class="op" id="4184277">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184285">c</span><span class="op" id="4184286">.</span><span class="ident" id="4184287">peerCertificates</span>&nbsp;<span class="op" id="4184304">=</span>&nbsp;<span class="ident" id="4184306">certs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184314">return</span>&nbsp;<span class="ident" id="4184321">pub</span><span class="op" id="4184324">,</span>&nbsp;<span class="ident" id="4184326">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184335">return</span>&nbsp;<span class="ident" id="4184342">nil</span><span class="op" id="4184345">,</span>&nbsp;<span class="ident" id="4184347">nil</span><br>
<span class="lineno"></span><span class="op" id="4184351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4184354">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="4184433">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="4184458">func</span>&nbsp;<span class="op" id="4184463">(</span><span class="ident" id="4184464">c</span>&nbsp;<span class="op" id="4184466">*</span><span class="ident" id="4184467">Conn</span><span class="op" id="4184471">)</span>&nbsp;<span class="ident" id="4184473">tryCipherSuite</span><span class="op" id="4184487">(</span><span class="ident" id="4184488">id</span>&nbsp;<span class="builtintype" id="4184491">uint16</span><span class="op" id="4184497">,</span>&nbsp;<span class="ident" id="4184499">supportedCipherSuites</span>&nbsp;<span class="op" id="4184521">[</span><span class="op" id="4184522">]</span><span class="builtintype" id="4184523">uint16</span><span class="op" id="4184529">,</span>&nbsp;<span class="ident" id="4184531">version</span>&nbsp;<span class="builtintype" id="4184539">uint16</span><span class="op" id="4184545">,</span>&nbsp;<span class="ident" id="4184547">ellipticOk</span><span class="op" id="4184557">,</span>&nbsp;<span class="ident" id="4184559">ecdsaOk</span>&nbsp;<span class="builtintype" id="4184567">bool</span><span class="op" id="4184571">)</span>&nbsp;<span class="op" id="4184573">*</span><span class="ident" id="4184574">cipherSuite</span>&nbsp;<span class="op" id="4184586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184589">for</span>&nbsp;<span class="ident" id="4184593">_</span><span class="op" id="4184594">,</span>&nbsp;<span class="ident" id="4184596">supported</span>&nbsp;<span class="op" id="4184606">:=</span>&nbsp;<span class="keyword" id="4184609">range</span>&nbsp;<span class="ident" id="4184615">supportedCipherSuites</span>&nbsp;<span class="op" id="4184637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184641">if</span>&nbsp;<span class="ident" id="4184644">id</span>&nbsp;<span class="op" id="4184647">==</span>&nbsp;<span class="ident" id="4184650">supported</span>&nbsp;<span class="op" id="4184660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184665">var</span>&nbsp;<span class="ident" id="4184669">candidate</span>&nbsp;<span class="op" id="4184679">*</span><span class="ident" id="4184680">cipherSuite</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184696">for</span>&nbsp;<span class="ident" id="4184700">_</span><span class="op" id="4184701">,</span>&nbsp;<span class="ident" id="4184703">s</span>&nbsp;<span class="op" id="4184705">:=</span>&nbsp;<span class="keyword" id="4184708">range</span>&nbsp;<span class="ident" id="4184714">cipherSuites</span>&nbsp;<span class="op" id="4184727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184733">if</span>&nbsp;<span class="ident" id="4184736">s</span><span class="op" id="4184737">.</span><span class="ident" id="4184738">id</span>&nbsp;<span class="op" id="4184741">==</span>&nbsp;<span class="ident" id="4184744">id</span>&nbsp;<span class="op" id="4184747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4184754">candidate</span>&nbsp;<span class="op" id="4184764">=</span>&nbsp;<span class="ident" id="4184766">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184773">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184783">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184793">if</span>&nbsp;<span class="ident" id="4184796">candidate</span>&nbsp;<span class="op" id="4184806">==</span>&nbsp;<span class="ident" id="4184809">nil</span>&nbsp;<span class="op" id="4184813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184819">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4184836">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4184884">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184915">if</span>&nbsp;<span class="op" id="4184918">(</span><span class="ident" id="4184919">candidate</span><span class="op" id="4184928">.</span><span class="ident" id="4184929">flags</span><span class="op" id="4184934">&amp;</span><span class="ident" id="4184935">suiteECDHE</span>&nbsp;<span class="op" id="4184946">!=</span>&nbsp;<span class="num" id="4184949">0</span><span class="op" id="4184950">)</span>&nbsp;<span class="op" id="4184952">&amp;&amp;</span>&nbsp;<span class="op" id="4184955">!</span><span class="ident" id="4184956">ellipticOk</span>&nbsp;<span class="op" id="4184967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184973">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4184985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4184990">if</span>&nbsp;<span class="op" id="4184993">(</span><span class="ident" id="4184994">candidate</span><span class="op" id="4185003">.</span><span class="ident" id="4185004">flags</span><span class="op" id="4185009">&amp;</span><span class="ident" id="4185010">suiteECDSA</span>&nbsp;<span class="op" id="4185021">!=</span>&nbsp;<span class="num" id="4185024">0</span><span class="op" id="4185025">)</span>&nbsp;<span class="op" id="4185027">!=</span>&nbsp;<span class="ident" id="4185030">ecdsaOk</span>&nbsp;<span class="op" id="4185038">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185044">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4185056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185061">if</span>&nbsp;<span class="ident" id="4185064">version</span>&nbsp;<span class="op" id="4185072">&lt;</span>&nbsp;<span class="ident" id="4185074">VersionTLS12</span>&nbsp;<span class="op" id="4185087">&amp;&amp;</span>&nbsp;<span class="ident" id="4185090">candidate</span><span class="op" id="4185099">.</span><span class="ident" id="4185100">flags</span><span class="op" id="4185105">&amp;</span><span class="ident" id="4185106">suiteTLS12</span>&nbsp;<span class="op" id="4185117">!=</span>&nbsp;<span class="num" id="4185120">0</span>&nbsp;<span class="op" id="4185122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185128">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4185140">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185145">return</span>&nbsp;<span class="ident" id="4185152">candidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4185164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4185167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4185171">return</span>&nbsp;<span class="ident" id="4185178">nil</span><br>
<span class="lineno">685</span><span class="op" id="4185182">}</span>
</div>
</body>
</html>
